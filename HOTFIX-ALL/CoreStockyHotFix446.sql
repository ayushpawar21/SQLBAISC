--[Stocky HotFix Version]=446
DELETE FROM Versioncontrol WHERE Hotfixid='446'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone)
VALUES('446','3.1.0.24','D','2021-08-07','2021-08-07','2021-08-07',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: TDS')
GO
DELETE FROM ManualConfiguration 
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','MANUALCONFIG9','Manual Configuration','Retailer Validation removed from Sales panel',1,'',0.00,9)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILL_EDIT1','BILLING','Block Editing of Billing Once Bill Print is Taken',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SAL_RETURN1','Sales Return','Tax Submission Month for Sales Return',1,'',9.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SAL_RETURN2','Sales Return','Block With Reference in MultiInvoice Option',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SAL_RETURN3','Sales Return','Enable Without Referenece ',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SAL_RETURN4','Sales Return','Without Refrence Tax applicable',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SAL_RETURN5','Sales Return','Selling Rate Edit',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','REPLACEMENT1','CreditNoteReplacement','Block Repalcement in CreditNoteReplacement',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','TAXALERT','TaxGroup','GST Tax Group Alert',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BlockRcvdQtyDownloadPO','Purchase Receipt','Block Received Qty for Downloaded Purchase after GST',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BlockRcvdQtyManualPO','Purchase Receipt','Block Received Qty for Manual Purchase after GST',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILL_TAX02','Billing','Allow Cess Tax in Billing based on Date',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILL_EDIT3','BillSeriesSetting','Bill Series curr value reset',1,'',0.00,2)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BATCH_MRPSTOCKTRANSFER','BATCH','MRP Wise Stock Transfer',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BATCH_LATESBATCHSTOCK','BATCH','Transfer old batch stock new batck',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BATCH_MRP','BATCH','MRP Wise Stock Transfer',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILLOFSUPPLY','BILLING','Enable bill of supply',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILLOFSUPPLY1','BILLING','Include Zero Tax Product',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILLOFSUPPLY2','BILLING','Enable bill of supply Counters',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ChkRefNoLen','ALL','Restrict to Save Bill/Return/ServiceInvoice, Refernce No length Greater than ',0,'',16.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','PUR_RETURN1','Purchase Return','Apply Tax for Without Reference Returns',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','ManualClm1','Manual Claim','Manual Claim Doc Attachment is Non mandatory',0,'',0.00,10)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','ClaimSyncPath','Manual Claim','Manual Claim Upload Sync Path',1,'http://sehyog.parle.biz/ParleClaimIntegration_Live/Pos2Console.asmx',0.00,11)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','BlockInActive','Product','Block In Active batch in Product Master',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','SALES_RETURN1','Sales Return','Block Scheme Discount Reversal for Unsaleable Return With Reference',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','SALES_RETURN2','Sales Return','Block Saleable Sales Return after config days or Month End',1,'',6.00,2)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','Report_withTax','Report with Tax','Enable Tax Applicable in Reports ',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','MonthEndServerDate','Month End with Server Date','Enable Month End Process using Server Date',1,'',0.00,2)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILL_TAX01','Billing','Allow Cess Tax in Billing',1,'2022-04-01',3.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','CSTimer3','CS Timer','Future Date allow days with server date',1,'',1.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','RETAILERBLOCK1','Retailer','Retailer mandatory columns block',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','AutoInsCRNoteAdj','Billing','Auto Institutional CR Note Adjumnet',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','AutoInsCRDateConfig','Billing','Auto Institutional CR Note Date Condiion',1,'2019-06-01',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ClaimDoc','Claim Document','Claim Ref Document',1,'1',2.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','BILL_SCHEME_APPLY','Billing_Scheme','Allow bill to save with out scheme when budget exceeds',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','CSTimer2','CS Timer','Enable Server Date Validation',1,'',2.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ClaimSheetHD','ClmCode','Distributor Code Added in Claim Sheet HD',1,'',0.00,4)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','CreditNoteRetailer','CrNoteNumber','Distributor Code Added in Credit Note Retailer',1,'',0.00,9)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','DebitNoteRetailer','DbNoteNumber','Distributor Code Added in Debit Note Retailer',1,'',0.00,10)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','FreeIssueHd','IssueRefNo','Distributor Code Added in Free issue',0,'PPL',0.00,12)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','PurchaseReturn','PurRetRefNo','Distributor Code Added in Purchase Return',0,'PPL',0.00,5)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ReturnGSTR1','ReturnCode','Distributor Code Added in Slaes Return',1,'',0.00,13)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ReturnHeader','ReturnCode','Distributor Code Added in Slaes Return',1,'',0.00,3)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','SamplePurchaseReceipt','PurRcptRefNo','Distributor Code Added in Sample Return',0,'',0.00,11)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ServiceInvoiceDistributor','ServiceInvRefNo','Distributor Code Added in ALL Service Invoice Distributor',1,'',0.00,8)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ServiceInvoicehd','ServiceInvRefNo','Distributor Code Added in Service Invoice',1,'',0.00,6)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','ServiceInvoiceHd_Unreg','ServiceInvRefNo','Distributor Code Added in ALL Service Invoice UnRegisterd Retailer',1,'',0.00,7)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','BILL_EDIT2','BillSeriesSetting','Distributor Code Added in Bill series Prefix',1,'',4.00,2)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','Sal_Return_Tax','Sales Return','Sales Return Tax Change Based On Bill Tax',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('GST','GSTR1HSNReturn','GSTR1HSNReturn','Consider Sales Return for GSTR1 HSN Summary Report',1,'0',0.00,18)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','RtrSalesTarget','Billing','If Rtr Sales Exceeds,Scheme & CP will not Apply',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','Route_Master','Route Master','Restrict Route Edit Expect ASM',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','Dateformat','Transaction','Validate date format in All transaction module',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','MDIDateformat','Transaction','Change date format in MDI timer event',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','DatabaseStatus','Database','Database Status check',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','DatabaseSize','DatabaseSize','Database Size check',1,'0',8.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','AutoBackupDriveSpace','AutoBackupDriveSpace','Validate Auto Backup Drive space check',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','AutoBackupDayCount','AutoBackup','Alert database backup not taken for no of days ',1,'0',3.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('MTR','AutoConfig1','Auto Deployment','DLL and OCR Register Without User Interfances',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('MTR','AutoConfig2','Auto Deployment','Running Exec Closed Automatically',0,'',0.00,2)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('MTR','AutoConfig3','Auto Deployment','Download Auto Deployment exe',0,'',0.00,3)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','DebitNoteTopSheet','DebitNoteTopSheet','Printer setup based on configuration',1,'1',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','DATATRANSFER48','DataTransfer','Upload Path_DistributorHelper',1,'http://sehyog.parle.biz/WdHelperTool/Service.asmx',0.00,48)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','DATATRANSFER49','DataTransfer','Response Message for DistributorHelper',1,'Message Sent to Parle Support',0.00,49)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','SalesReturnSave','Sales Return Save','Restrict Save in SalesReturn',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','AutoBackup_Upload2','AutoBackup_Upload2','Disable S3 Backup Configuration',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','AutoBackup_Upload','AutoBackup_Upload','Enable AuotBackup Upload',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','DataBaseHealthCheck1','DataBaseHealthCheck1','Enable Database Health check in Login and Database Backup Exe',1,'',1.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','S3BACKUP1','S3 BACKUP','DpUpload.exe mandatory check',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','S3BACKUP2','S3 BACKUP','Zip with Password Protection',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('ALL','S3BACKUP3','S3 BACKUP','AWS file maintain count to delete',1,'',2.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','SAL_RETURN6','Sales Return','Transfer Stock Automatically from old batch to new batch on new batch download',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','PURCHASE1','Purchase Receipt','Transfer Stock Automatically from old batch to new batch on new batch download',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','PURCHASERECEIPT01','PurchaseReceipt','Pending Purchase Confirmation on ...',1,'',5.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','AutoDebitNoteTopSheet','DebitNoteTopSheet','Auto Opening for DebitNoteTopSheet',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','PendingTransAlert','PendingTransAlert','PendingTransAlert For Billing,SalesReturn and Purchase',1,'0',3.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','BLOCKMSTCREATION','BlockMastersCreation','Block Retailer/Salesman/Route Creation',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','ETLBLOCKMSTCREATION','ETLBlockMastersCreation','ETL Block Retailer/Salesman/Route Creation',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','BLOCKMSTCREATION1','Salesman Route Modification','Salesman Route Modification',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('All','BLOCKMSTCREATION2','Route Status Modification','Route Status Modification',1,'0',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','E-Invoice','E-Invoice','Allow to generate E-invoice',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','E-Invoice-API','E-Invoice','Allow to generate E-invoice-API',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','E-Invoice-JSON','E-Invoice','Allow to generate E-invoice-JSON',1,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','E-Invoice-Sales-Print','Bill Print','Without IRN should not allow to print invoice',0,'',0.00,1)
INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo]) VALUES ('PARLE','E-Invoice-Return-Print','Bill Print','Without IRN should not allow to print invoice',0,'',0.00,1)
GO
---TDS Changes
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesInvoice' AND name='SalTDSAmount')
BEGIN
	ALTER TABLE SalesInvoice ADD SalTDSAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesInvoice' AND name='TDSTaxSeqId')
BEGIN
	ALTER TABLE SalesInvoice ADD TDSTaxSeqId INT 
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesInvoice' AND name='SalTDSPayAmount')
BEGIN
       ALTER TABLE SalesInvoice ADD SalTDSPayAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_DefaultUDCValueInsertForNewUDC' and Xtype='P')
DROP PROCEDURE Proc_DefaultUDCValueInsertForNewUDC
GO
CREATE PROCEDURE Proc_DefaultUDCValueInsertForNewUDC(
@MasterName	VARCHAR(200),
@ColumnName AS VARCHAR(200),
@ColumnValue VARCHAR(200)
)
AS 
/***********************************************************
* PROCEDURE	: Proc_DefaultUDCValueInsertForNewUDC
* PURPOSE	: To Insert the Default UDC for Existing Records
* SCREEN	: 
* CREATED BY: S.Moorthi
* MODIFIED	: 05/06/2021
*****************************************************************************************************************
' Version       Date        Person           User Story ID    CR/BZ     Remarks          Code Review By   Review Date
*****************************************************************************************************************

*************************************************************/
BEGIN

	DECLARE @MasterId AS INT
	SELECT @MasterId=MasterId FROM UdcHD WHERE MasterName=@MasterName

	IF EXISTS(SELECT  *FROM UDCMASTER WHERE MasterId=@MasterId and ColumnName=@ColumnName)
	BEGIN

		DECLARE @UDCMasterId as INT
		DECLARE @UniqueId AS BIGINT
		DECLARE @UDCDETAILSID AS BIGINT

		SET @UDCDETAILSID=0

		SELECT @UDCDETAILSID=MAX(UdcDetailsId) FROM UdcDetails (nolock)
		SET @UDCDETAILSID=ISNULL(@UDCDETAILSID,0)
		SELECT @UDCMasterId=UdcMasterId FROM UDCMASTER WHERE MasterId=@MasterId and ColumnName=@ColumnName

		IF EXISTS(SELECT * FROM UdcDefault WHERE UdcMasterId=@UDCMasterId and ColValue=@ColumnValue) ---1 Changed as @UDCMasterId
		BEGIN

			CREATE TABLE #CS_Prk_UDCDetails
			(
				MasterValueCode		VARCHAR(100),
				MasterRecordId		INT,
				UdcMasterId			INT,
				ColumnValue			VARCHAR(200)
			)

			IF @MasterName='Retailer Master'
			BEGIN
				INSERT INTO #CS_Prk_UDCDetails(MasterValueCode,MasterRecordId,UdcMasterId,ColumnValue)
				SELECT RtrCode,RtrId,@UDCMasterId as UDCMASTERiD,@ColumnValue AS ColumnValue  
				FROM RETAILER R WHERE R.RtrId NOT IN (
				SELECT MasterRecordId FROM UdcDetails WHERE UdcMasterId=@UDCMasterId)
			END

			IF @MasterName='Distributor Info Master'
			BEGIN
				INSERT INTO #CS_Prk_UDCDetails(MasterValueCode,MasterRecordId,UdcMasterId,ColumnValue)
				SELECT DistributorCode,DistributorId,@UDCMasterId as UDCMASTERiD,@ColumnValue AS ColumnValue  
				FROM DISTRIBUTOR R WHERE R.DISTRIBUTORID NOT IN (
				SELECT MasterRecordId FROM UdcDetails WHERE UdcMasterId=@UDCMasterId)
			END

			IF EXISTS(SELECT * FROM #CS_Prk_UDCDetails)
			BEGIN

				SELECT @UniqueId=UDCUniqueId FROM UdcDetails WHERE UdcMasterId=@UDCMasterId AND ColumnValue=@ColumnValue
				IF ISNULL(@UniqueId,0)=0
				BEGIN
					SELECT @UniqueId=MAX(UDCUniqueId) FROM UDCDetails (NOLOCK)
					SET @UniqueId=ISNULL(@UniqueId,0)
				END

				INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,
				UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
				SELECT ROW_NUMBER() OVER (ORDER BY MasterRecordId,A.ColumnValue)+@UDCDETAILSID,A.UdcMasterId,
				@MasterId MasterId,MasterRecordId,A.ColumnValue,@UniqueId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),99,
				CONVERT(VARCHAR(10),GETDATE(),121)  FROM #CS_Prk_UDCDetails A  

		
				SELECT @UDCDETAILSID=MAX(UdcDetailsId) FROM UdcDetails (nolock)
				SELECT @UniqueId=MAX(UDCUniqueId) FROM UDCDetails (NOLOCK)

				UPDATE A SET A.CURRVALUE=@UDCDETAILSID FROM COUNTERS A WHERE TABNAME='UDCDetails' AND FLDNAME='UdcDetailsId'
				UPDATE A SET A.CURRVALUE=@UniqueId  FROM COUNTERS A WHERE TABNAME='UDCDetails' AND FLDNAME='UDCUniqueId'
			END
		END
	END
RETURN
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='TDS Applicable' and MasterName='Distributor Info Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Distributor Info Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'TDS Applicable','Varchar',10,0,1,1,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
			INSERT INTO UdcDefault(SeqId,MasterId,UdcMasterId,ColValue)
			SELECT 1,@MasterId,@UdcMasterId+1,'YES'
			UNION ALL
			SELECT 2,@MasterId,@UdcMasterId+1,'NO'
			
			SELECT @DistCode =DistributorCode FROM Distributor
		
			---Default Value insert for Existing Records	
			EXEC Proc_DefaultUDCValueInsertForNewUDC 'DISTRIBUTOR INFO MASTER','TDS Applicable','NO'	

		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='TDS Applicable' and MasterName='Retailer Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'TDS Applicable','Varchar',100,0,1,1,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
			INSERT INTO UdcDefault(SeqId,MasterId,UdcMasterId,ColValue)
			SELECT 1,@MasterId,@UdcMasterId+1,'LessThan 50L'
			UNION ALL
			SELECT 2,@MasterId,@UdcMasterId+1,'WithOut Pan'
			UNION ALL
			SELECT 3,@MasterId,@UdcMasterId+1,'NA'

			---Default Value insert for Existing Records	
			EXEC Proc_DefaultUDCValueInsertForNewUDC 'Retailer Master','TDS Applicable','NA'
			
		END
	END
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TDS_TaxSetting_Master')
BEGIN
CREATE TABLE TDS_TaxSetting_Master
(
	TaxCode Varchar(20) NOT NULL,
	TaxName	Varchar(100) NOT NULL,
	CoaId	INT NOT NULL,
	InputCoaId	INT NOT NULL,
	Availability TinyInt,
	LastModBy	TinyInt,
	LastModDate	DateTime,
	AuthId		TinyInt,
	AuthDate	DateTime,
	CONSTRAINT PK_TDS_TaxSetting_Master_TaxCode  PRIMARY KEY CLUSTERED(TaxCode)
)
END
GO
UPDATE Counters SET CurrValue =(SELECT MAX(CoaId) FROM CoaMaster (NOLOCK)) WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TDS_TaxSetting_Details')
BEGIN
CREATE TABLE TDS_TaxSetting_Details(
	TaxSeqId		INT	 NOT NULL ,
	TaxCode			Varchar(20) NOT NULL,
	Effective_Date		DateTime,	
	LessThan50L			Numeric(12,6) NOT NULL,
	WithoutPan			Numeric(12,6) NOT NULL,
	TDSApplyOn			VARCHAR(100) NOT NULL,
	ActiveStatus		TinyInt,
	Availability		TinyInt,
	LastModBy			TinyInt,
	LastModDate			DateTime,
	AuthId				TinyInt,
	AuthDate			DateTime,
	CONSTRAINT PK_TDS_TaxSetting_Details_TaxSeqId_TaxCode  PRIMARY KEY CLUSTERED(TaxSeqId,TaxCode),
	CONSTRAINT FK_TDS_TaxSetting_Details__TaxCode FOREIGN KEY (TaxCode) REFERENCES TDS_TaxSetting_Master(TaxCode)
	
)	
END
GO
--IF NOT EXISTS(SELECT * FROM SYSCONSTRAINTS A INNER JOIN SYSOBJECTS B ON A.constid=B.ID WHERE B.xtype='F' AND B.NAME='FK_SalesInvoiceTDSTax_TaxCode')
--BEGIN
--	ALTER TABLE SalesInvoice ADD CONSTRAINT FK_SalesInvoiceTDSTax_TaxCode FOREIGN KEY (TDSTaxSeqId) REFERENCES TDS_TaxSetting_Master(TaxSeqId)
--END
--GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='Cn2Cs_Prk_TDS_Taxsetting')
DROP TABLE Cn2Cs_Prk_TDS_Taxsetting
GO
CREATE TABLE Cn2Cs_Prk_TDS_Taxsetting
(
	[DistCode]			[nvarchar](100) NULL,
	TaxCode				Varchar(20) NOT NULL,
	TaxName				Varchar(100) NOT NULL,
	Effective_Date		DateTime,	
	LessThan50L			Numeric(12,6) NOT NULL,
	WithoutPan			Numeric(12,6) NOT NULL,
	TDSApplyOn			VARCHAR(100) NOT NULL,
	ActiveStatus		Varchar(20) NOT NULL,
	[DownLoadFlag]		[nvarchar](100) NULL,
	[CreatedDate]		[datetime] NULL
)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_Cn2Cs_TDS_TaxSetting')
DROP PROCEDURE  Proc_Cn2Cs_TDS_TaxSetting
GO
CREATE PROCEDURE Proc_Cn2Cs_TDS_TaxSetting
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_TDS_TaxSetting
* PURPOSE		: To validate and insert TCS Tax details
* CREATED		: S.Moorthi
* CREATED DATE	: 05/06/2021
* MODIFIED
* DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  05/06/2021  S.Moorthi				SR								TDS Tax Download
**************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @AcCode			VARCHAR(20)	
	DECLARE @TaxCode		NVARCHAR(200)	
	DECLARE @TaxName		NVARCHAR(200)
	DECLARE @OutPutTaxId	INT
	DECLARE @InPutTaxId	INT
	DECLARE @TaxSeqId AS INT
		
		DELETE FROM Cn2Cs_Prk_TDS_Taxsetting WHERE DownLoadFlag='Y'
		
			
		CREATE TABLE #Cn2Cs_Prk_TDS_Taxsetting
		(
		TaxCode			Varchar(20) NOT NULL,
		TaxName			Varchar(100) NOT NULL,
		Effective_Date	DateTime,	
		LessThan50L		Numeric(12,6) NOT NULL,
		WithoutPan		Numeric(12,6) NOT NULL,
		TDSApplyOn		Varchar(50) NULL,
		ActiveStatus	TINYINT
		)
	
		SELECT TaxCode,MAX([CreatedDate]) as [CreatedDate] 
		INTO #TaxMax
		FROM Cn2Cs_Prk_TDS_Taxsetting WHERE DownLoadFlag='D'
		GROUP BY TaxCode
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Cn2Cs_Prk_TDS_Taxsetting','TaxCode','Tax Code:'+A.TaxCode+' : Mandatory Field validation failed' 
		FROM Cn2Cs_Prk_TDS_Taxsetting A (NOLOCK) INNER JOIN  #TaxMax B ON A.TaxCode=B.TaxCode
		AND A.CreatedDate=B.CreatedDate
		WHERE DownLoadFlag='D'
		AND (
		LEN(LTRIM(RTRIM(ISNULL(A.TaxCode,''))))=0 OR 
		LEN(LTRIM(RTRIM(ISNULL(ActiveStatus,'ACTIVE'))))=0 OR
		(ISNULL(LessThan50L,0)+ISNULL(WithoutPan,0))=0 OR
		LEN(LTRIM(RTRIM(ISNULL(A.TaxName,''))))=0		
		)
		
		INSERT INTO #Cn2Cs_Prk_TDS_Taxsetting(TaxCode,TaxName,Effective_Date,LessThan50L,WithoutPan,ActiveStatus,TDSApplyOn)
		SELECT DISTINCT ISNULL(A.TaxCode,'') as TaxCode,ISNULL(TaxName,'') as TaxName,
		ISNULL(Effective_Date,CONVERT(VARCHAR(10),GETDATE(),121)),
		ISNULL(LessThan50L,0) as TaxWithGSTIN,
		ISNULL(WithoutPan,0) as TaxWithoutGSTIN,
		CASE ISNULL(ActiveStatus,'ACTIVE') WHEN 'ACTIVE' THEN 1 ELSE 0 END as ActiveStatus,
		ISNULL(TDSApplyOn,'') AS TDSApplyOn	
		FROM Cn2Cs_Prk_TDS_Taxsetting A (NOLOCK) INNER JOIN  #TaxMax B ON A.TaxCode=B.TaxCode
		AND A.CreatedDate=B.CreatedDate
		WHERE DownLoadFlag='D'
		AND (
		LEN(LTRIM(RTRIM(ISNULL(A.TaxCode,''))))<>0 AND 
		LEN(LTRIM(RTRIM(ISNULL(ActiveStatus,'ACTIVE'))))<>0 AND
		(ISNULL(LessThan50L,0)+ISNULL(WithoutPan,0))<>0 AND
		LEN(LTRIM(RTRIM(ISNULL(A.TaxName,''))))<>0	AND 	LEN(LTRIM(RTRIM(ISNULL(A.TDSApplyOn,''))))<>0
		)

		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Cn2Cs_Prk_TDS_Taxsetting','TDSApplyOn','TDS ApplyOn should be Gross/Net/TaxableAmount' 
		FROM #Cn2Cs_Prk_TDS_Taxsetting A (NOLOCK) 
		WHERE TDSApplyOn NOT IN ('Gross','Taxable Amount','Net Amount')


		DELETE A FROM #Cn2Cs_Prk_TDS_Taxsetting A (NOLOCK) 
		WHERE TDSApplyOn NOT IN ('Gross','Taxable Amount','Net Amount')


	DECLARE Cur_TCStax CURSOR
	FOR SELECT DISTINCT TaxCode,TaxName FROM #Cn2Cs_Prk_TDS_Taxsetting 	
	OPEN Cur_TCStax
	FETCH NEXT FROM Cur_TCStax INTO @TaxCode,@TaxName
	WHILE @@FETCH_STATUS=0
	BEGIN		
			SET @AcCode=''
				
			IF NOT EXISTS(SELECT 'X' FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='1' and accode like '131%'
			AND AcName=@TaxName)
			BEGIN
						IF NOT EXISTS(SELECT * FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
						WHERE a.aclevel= '4' and a.maingroup='1' and a.accode like '131%'))
						BEGIN
							SET @AcCode = '1310001'
						END
						ELSE
						BEGIN
							SELECT @AcCode=AcCode FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
							WHERE a.aclevel= '4' and a.maingroup='1' and a.accode like '131%')
							SET @AcCode= CAST(@AcCode AS BIGINT) + 1
						END
						
						SELECT @OutPutTaxId=MAX(CoaId) FROM COAMaster (NOLOCK)
						SET @OutPutTaxId=ISNULL(@OutPutTaxId,0)+1
						
						INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
													LastModDate,AuthId,AuthDate) VALUES (@OutPutTaxId,CAST(@AcCode AS VARCHAR(50)),
													CAST(@TaxName AS VARCHAR(100)),4,1,0,1,1,GETDATE(),1,GETDATE())

						
						UPDATE Counters SET CurrValue = @OutPutTaxId WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
				END
				ELSE
				BEGIN
					SELECT @OutPutTaxId=CoaId FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='1' and accode like '131%'
					AND AcName=@TaxName
				END	
			--Input tax

			--SET @InPutTaxId=0
				
			SET @AcCode=''
				
			IF NOT EXISTS(SELECT 'X' FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='2' and accode like '217%'
			AND AcName=@TaxName)
			BEGIN
						IF NOT EXISTS(SELECT * FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
						WHERE a.aclevel= '4' and a.maingroup='2' and a.accode like '217%'))
						BEGIN
							SET @AcCode = '2170001'
						END
						ELSE
						BEGIN
							SELECT @AcCode=AcCode FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
							WHERE a.aclevel= '4' and a.maingroup='2' and a.accode like '217%')
							SET @AcCode= CAST(@AcCode AS BIGINT) + 1
						END
						
						SELECT @InPutTaxId=MAX(CoaId) FROM COAMaster (NOLOCK)
						SET @InPutTaxId=ISNULL(@InPutTaxId,0)+1
						
						INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
													LastModDate,AuthId,AuthDate) VALUES (@InPutTaxId,CAST(@AcCode AS VARCHAR(50)),
													CAST(@TaxName AS VARCHAR(100)),4,2,0,1,1,GETDATE(),1,GETDATE())

						
						UPDATE Counters SET CurrValue = @InPutTaxId WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
				END
				ELSE
				BEGIN
					SELECT @InPutTaxId=CoaId FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='2' and accode like '217%'
					AND AcName=@TaxName
				END	
				
				
					
				
				INSERT INTO TDS_TaxSetting_Master(TaxCode,TaxName,CoaId,InputCoaId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				SELECT DISTINCT @TaxCode,@TaxName,@OutPutTaxId,@InPutTaxId,1,1,GETDATE(),1,GETDATE()
				FROM #Cn2Cs_Prk_TDS_Taxsetting A 
				WHERE NOT EXISTS(SELECT TaxCode FROM TDS_TaxSetting_Master B (NOLOCK) WHERE A.TaxCode=B.TaxCode) 
				AND TaxCode=@TaxCode
				
				UPDATE TDS_TaxSetting_Master SET TaxName=@TaxName,CoaId=@OutPutTaxId,InputCoaId=@InPutTaxId
				WHERE TaxCode=@TaxCode
				
	FETCH NEXT FROM Cur_TCStax INTO @TaxCode,@TaxName
	END
	CLOSE Cur_TCStax
	DEALLOCATE Cur_TCStax
	
	
	SELECT @TaxSeqId=MAX(TaxSeqId) FROM TDS_TaxSetting_Details (NOLOCK)
	SET @TaxSeqId=ISNULL(@TaxSeqId,0)
	
	INSERT INTO TDS_TaxSetting_Details(TaxSeqId,TaxCode,Effective_Date,LessThan50L,WithoutPan,ActiveStatus,TDSApplyOn,
	Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT @TaxSeqId+ROW_NUMBER()OVER(ORDER BY TaxCode), TaxCode,CONVERT(DATETIME,CONVERT(VARCHAR(10),Effective_Date,121),121),
	LessThan50L,WithoutPan,ActiveStatus,TDSApplyOn,1,1,GETDATE(),1,GETDATE()
	FROM #Cn2Cs_Prk_TDS_Taxsetting A
	WHERE NOT EXISTS(SELECT * FROM TDS_TaxSetting_Details B (NOLOCK) WHERE A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Effective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Effective_Date,121),121)
	AND A.LessThan50L=B.LessThan50L
	AND A.WithoutPan=B.WithoutPan AND A.TDSApplyOn=B.TDSApplyOn)
	ORDER BY CONVERT(DATETIME,CONVERT(Varchar(10),A.Effective_Date,121),121)
	
	UPDATE A SET A.ActiveStatus=B.ActiveStatus FROM TDS_TaxSetting_Details  A
	INNER JOIN #Cn2Cs_Prk_TDS_Taxsetting B (NOLOCK) ON A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Effective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Effective_Date,121),121)
	AND A.LessThan50L=B.LessThan50L
	AND A.WithoutPan=B.WithoutPan AND A.TDSApplyOn=B.TDSApplyOn

	UPDATE A SET [DownLoadFlag]='Y' FROM Cn2Cs_Prk_TDS_Taxsetting A INNER JOIN TDS_TaxSetting_Details B 
	ON A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Effective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Effective_Date,121),121)
	AND A.LessThan50L=B.LessThan50L
	AND A.WithoutPan=B.WithoutPan AND A.TDSApplyOn=B.TDSApplyOn
	WHERE [DownLoadFlag]='D'

	RETURN
END
GO
/**
DELETE FROM Cn2Cs_Prk_TDS_Taxsetting
INSERT INTO Cn2Cs_Prk_TDS_Taxsetting(DistCode,
TaxCode,
TaxName,
Effective_Date,
LessThan50L,
WithoutPan,
TDSApplyOn,
ActiveStatus,
DownLoadFlag,
CreatedDate)
SELECT '','TDS','TDS',GETDATE(),0.1 as TaxWithGSTIN,5.00 as TaxWithoutGSTIN,'Gross','ACTIVE','D',Getdate()
BEGIN TRAN
EXEC Proc_Cn2Cs_TDS_TaxSetting 0
SELECT * FROM coaMaster (NOLOCK) Order by Coaid Desc
SELECT * FROM TDS_TaxSetting_Master
SELECT * FROM TDS_TaxSetting_Details
SELECT * FROM Cn2Cs_Prk_TDS_Taxsetting
--Update TCS_TaxSetting_Details SET TaxWithoutGSTIN=.1
ROLLBACK TRAN
**/
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName='TDS Tax Settings'
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
SELECT 123,'TDS Tax Settings','Cn2Cs_Prk_TDS_Taxsetting','',0,500,GETDATE()
GO
DELETE FROM CustomUpDownload WHERE UpDownload='Download' and Module='TDS Tax Settings'
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 312,1,'TDS Tax Settings','TDS Tax Settings','','Proc_Import_TDS_Taxsetting_Dt','Cn2Cs_Prk_TDS_Taxsetting',
'Proc_Cn2Cs_TDS_TaxSetting','Master','Download',1 
GO
DELETE FROM CustomCaptions where Transid=507
INSERT INTO Customcaptions(TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,
DefaultMsgBox,Visibility,Enabled)
SELECT 507,5,1,'CoreHeaderTool','TDS Tax Setting','','',1,1,1,GETDATE(),1,GETDATE(),'TDS Tax Setting','','',1,1 UNION ALL
SELECT 507,5,12,'CoreHeaderTool','Stocky','','',1,1,1,GETDATE(),1,GETDATE(),'Stocky','','',1,1 UNION ALL
SELECT 507,6,2,'DgCommon-507-6-2','TDS Code','','',1,1,1,GETDATE(),1,GETDATE(),'TDS Code','','',1,1 UNION ALL
SELECT 507,6,3,'DgCommon-507-6-3','TDS Name','','',1,1,1,GETDATE(),1,GETDATE(),'TDS Name','','',1,1 UNION ALL
SELECT 507,6,4,'DgCommon-507-6-4','Effecitive Date','','',1,1,1,GETDATE(),1,GETDATE(),'Effecitive Date','','',1,1 UNION ALL
SELECT 507,6,5,'DgCommon-507-6-5','LessThan 50 L %','','',1,1,1,GETDATE(),1,GETDATE(),'LessThan 50 L %','','',1,1 UNION ALL
SELECT 507,6,6,'DgCommon-507-6-6','Without Pan %','','',1,1,1,GETDATE(),1,GETDATE(),'Without Pan % ','','',1,1 UNION ALL
SELECT 507,6,7,'DgCommon-507-6-7','Apply On','','',1,1,1,GETDATE(),1,GETDATE(),'Apply On %','','',1,1  UNION ALL
SELECT 507,7,1,'LblApplyOn','Apply On..','','',1,1,1,GETDATE(),1,GETDATE(),'Apply On','','',1,1 UNION ALL
SELECT 507,7,2,'LblLessThan','Less Than 50 L %','','',1,1,1,GETDATE(),1,GETDATE(),'Less Than 50 L %','','',1,1  UNION ALL
SELECT 507,7,3,'LblWithOutPan','With Out Pan %','','',1,1,1,GETDATE(),1,GETDATE(),'With Out Pan %','','',1,1 
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='FN_ReturnTDS_TaxSetting_Master' and XTYPE IN ('TF','FN'))
DROP FUNCTION FN_ReturnTDS_TaxSetting_Master
GO
--SELECT * FROM FN_ReturnTCSTaxSetting() ORDER BY TCSTAXID DESC
CREATE FUNCTION FN_ReturnTDS_TaxSetting_Master()
RETURNS @ReturnTDS_TaxSetting_Master TABLE
(
		TaxId				INT,
		TaxCode				VARCHAR(20),
		TaxName				VARCHAR(100),
		EffectiveDate		DATETIME,
		LessThan50L			NUMERIC(18,6),
		WithOutPan			NUMERIC(18,6),
		TDSApplyOn			VARCHAR(100),
		Availability		INT,
		LastModBy			INT,
		LastModDate			DATETIME,
		AuthId				INT,
		AuthDate			DATETIME
)
AS
/*********************************  
* PROCEDURE  : FN_ReturnTDS_TaxSetting_Master  
* PURPOSE  : To Return TDS Tax setting details 
* CREATED BY : S.Moorthi   
* CREATED DATE : 05/06/2021 
* NOTE   :  
* MODIFIED  
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
  05/06/2021   S.Moorthi	   CR						   TDS Tax Download
************************************************************************************************************************************/  

BEGIN
	INSERT INTO @ReturnTDS_TaxSetting_Master(TaxId,TaxCode,TaxName,EffectiveDate,LessThan50L,WithOutPan,TDSApplyOn,
	Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT Taxseqid as TaxId,A.TaxCode,A.TaxName,Effective_Date AS EffectiveDate,LessThan50L,WithOutPan,TDSApplyOn,
	A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate FROM TDS_TaxSetting_Master A (NOLOCK)
	INNER JOIN TDS_TaxSetting_Details B	(NOLOCK) ON A.TaxCode=B.TaxCode 
	Order by TaxSeqId
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_TDSTaxApplicablePercentage' and xtype='FN')
DROP FUNCTION Fn_TDSTaxApplicablePercentage
GO
--SELECT DBO.Fn_TDSTaxApplicablePercentage(1,'2021-03-05')
CREATE FUNCTION [Fn_TDSTaxApplicablePercentage](@Pi_RtrId AS BIGINT,@Pi_ServerDate DateTime)
RETURNS TINYINT
AS
BEGIN
/*************************************************************************
* FUNCTION : Fn_TDSTaxApplicablePercentage
* PURPOSE  : Return TDS Tax percentage mode
* NOTES    : 
* CREATED  : S.Moorthi
* MODIFIED : 07/06/2021
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  07/06/2021  S.Moorthi				CR		DABCS202100016            TDS Tax Column added   
**************************************************************************/
	
	DECLARE @TaxMode AS TINYINT
	SET @TaxMode=0
	--Distributor TCS Applicable		
	IF NOT EXISTS(SELECT 'X' FROM  Distributor A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.DistributorId
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='TDS Applicable'
	WHERE E.MasterId=16 and UPPER(D.ColumnValue)='YES')
	BEGIN
		SET @TaxMode=0
		RETURN (@TaxMode)
	END

	DECLARE @RetailerTDSApplicable AS VARCHAR(100)
	SET @RetailerTDSApplicable=''

	---Retailer TCS Applicable
	SELECT @RetailerTDSApplicable=ISNULL(ColumnValue,'') FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='TDS Applicable' 
	WHERE E.MasterId=2 and  D.MasterRecordId=@Pi_RtrId

	SET @RetailerTDSApplicable=ISNULL(@RetailerTDSApplicable,'NA')

	SET @TaxMode=0
	IF UPPER(@RetailerTDSApplicable)='NA'
	BEGIN
		SET @TaxMode=0
	END
	ELSE IF UPPER(@RetailerTDSApplicable)=UPPER('LESSTHAN 50L')
	BEGIN
		SET @TaxMode=1
	END
	ELSE IF UPPER(@RetailerTDSApplicable)=UPPER('WITHOUT PAN')
	BEGIN
		SET @TaxMode=2
	END
	
	RETURN(@TaxMode)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_TDSApplyOn' and xtype='TF')
DROP FUNCTION Fn_TDSApplyOn
GO
--SELECT * FROM Fn_TDSApplyOn(0,'2021-06-14')
CREATE FUNCTION Fn_TDSApplyOn(@Pi_RtrId AS BIGINT,@Pi_ServerDate DateTime)
RETURNS @TDSApplicable TABLE
(
	TaxMode		VARCHAR(100),
	TDSApplyOn	VARCHAR(100)
)
AS
BEGIN
/*************************************************************************
* FUNCTION : Fn_TDSApplyOn
* PURPOSE  : Return TDS Tax percentage mode & Apply on
* NOTES    : 
* CREATED  : S.Moorthi
* MODIFIED : 07/06/2021
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  07/06/2021  S.Moorthi				CR		DABCS202100016            TDS Tax Column added   
**************************************************************************/
	--TDS Tax calculation

		DECLARE @TDSTaxSeqId AS INT
		DECLARE @TDSMode AS INT
		DECLARE @TDSTaxCode AS VARCHAR(20)
		DECLARE @TDSApplyOn AS VARCHAR(100)	
		SET @TDSApplyOn=''
		SET @TDSTaxCode='TDS'

		SELECT @TDSMode=DBO.Fn_TDSTaxApplicablePercentage(@Pi_RtrId,@Pi_ServerDate)

		IF @TDSMode=0
		BEGIN
			INSERT INTO @TDSApplicable(TaxMode,TDSApplyOn)
			SELECT @TDSMode,@TDSApplyOn
			RETURN
		END

		SELECT @TDSTaxSeqId=MAX(TaxSeqId) FROM TDS_TaxSetting_Master A (NOLOCK) INNER JOIN TDS_TaxSetting_Details B (NOLOCK) ON 
		A.TaxCode=B.TaxCode WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),Effective_Date,121),121) <=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_ServerDate,121),121)
		AND A.TaxCode=@TDSTaxCode AND ActiveStatus=1

		SET @TDSTaxSeqId=ISNULL(@TDSTaxSeqId,0)
		--SELECT @TDSTaxSeqId
		IF NOT EXISTS(SELECT 'X' FROM TDS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TDSTaxSeqId and Taxcode=@TDSTaxCode)
		BEGIN
			INSERT INTO @TDSApplicable(TaxMode,TDSApplyOn)
			SELECT @TDSMode,@TDSApplyOn
			RETURN
		END
				

		---PAN Applicable/Less than 50 L
		SELECT @TDSApplyOn=TDSApplyOn 
		FROM TDS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TDSTaxSeqId and Taxcode=@TDSTaxCode

		INSERT INTO @TDSApplicable(TaxMode,TDSApplyOn)
		SELECT @TDSMode,@TDSApplyOn

	RETURN 
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_ReturnTDSTaxForBilling' and xtype='TF')
DROP FUNCTION Fn_ReturnTDSTaxForBilling
GO
/*
BEGIN TRAN
SELECT DBO.Fn_ReturnTDSTaxForBilling(2,1,70277,1943,'2021-06-07',0)
SELECT * FROM SalesInvoice(nolock) where SalId=70277
ROLLBACK TRAN
*/
CREATE FUNCTION Fn_ReturnTDSTaxForBilling
(
	 @Pi_TransId			INT,     
	 @Pi_UserId				INT,
	 @Pi_SalId				BIGINT,
	 @Pi_RtrId				INT,
	 @Pi_gServerDate		DATETIME,
	 @Pi_gTDSTaxableAmount	NUMERIC(18,6),
	 @Pi_NetAmount			NUMERIC(18,6),
	 @Pi_GrossAmount		NUMERIC(18,6)--,
	 --@RefType				INT
)
RETURNS @ReturnTDSTaxAmount TABLE 
(
	TDSTaxAmount	NUMERIC(18,0),
	TDSTaxSeqId		INT
)
AS
/************************
* PROCEDURE		: Proc_CalculateTDSTaxinBilling
* PURPOSE		: Calculate TDS Tax in Billing
* CREATED BY	: S.Moorthi
* MODIFIED		: 05/06/2021
*****************************************************************************************************************
' Version       Date        Person           User Story ID    CR/BZ     Remarks          Code Review By   Review Date
*****************************************************************************************************************

***************************/
BEGIN

	DECLARE @TaxLessThan50L AS NUMERIC(12,6)
	DECLARE @WithoutPan AS NUMERIC(12,6)
	DECLARE @SalTaxableAmount AS NUMERIC(18,6)
	DECLARE @TDSTaxAmount AS NUMERIC(18,6)
	DECLARE @TDSTaxSeqId AS INT
	DECLARE @TDSTaxCode AS VARCHAR(20)
	DECLARE @TDSMode AS INT
	SET @SalTaxableAmount=0
	SET @TDSTaxAmount=0
	SET @TDSTaxCode='TDS'
	SET @TDSMode=0


		---TDS Mode
		SELECT @TDSMode=DBO.Fn_TDSTaxApplicablePercentage(@Pi_RtrId,@Pi_gServerDate)
		--SELECT @TDSMode
		IF @TDSMode=0
		BEGIN
			RETURN 
		END

		--TDS Tax calculation
		SELECT @TDSTaxSeqId=MAX(TaxSeqId) FROM TDS_TaxSetting_Master A (NOLOCK) INNER JOIN TDS_TaxSetting_Details B (NOLOCK) ON 
		A.TaxCode=B.TaxCode WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),Effective_Date,121),121) <=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121)
		AND A.TaxCode=@TDSTaxCode AND ActiveStatus=1

		SET @TDSTaxSeqId=ISNULL(@TDSTaxSeqId,0)
		--SELECT @TDSTaxSeqId
		IF NOT EXISTS(SELECT 'X' FROM TDS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TDSTaxSeqId and Taxcode=@TDSTaxCode)
		BEGIN
			RETURN 
		END
		
		DECLARE @TDSApplyOn AS VARCHAR(100)	
		SET @TDSApplyOn=''

		---PAN Applicable/Less than 50 L
		SELECT @TaxLessThan50L=LessThan50L,@WithoutPan=WithoutPan,@TDSApplyOn=TDSApplyOn 
		FROM TDS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TDSTaxSeqId and Taxcode=@TDSTaxCode

		--IF @TDSApplyOn='Net Amount' AND @RefType=1
		--BEGIN
		--	RETURN
		--END
		
		IF @TDSApplyOn='Gross'
		BEGIN
			SET @SalTaxableAmount=ISNULL(@Pi_GrossAmount,0)			
		END
		ELSE IF @TDSApplyOn='Net Amount'
		BEGIN
			SET @SalTaxableAmount=ISNULL(@Pi_NetAmount,0)
		END
		ELSE IF @TDSApplyOn='Taxable Amount'
		BEGIN
			SET @SalTaxableAmount=ISNULL(@Pi_gTDSTaxableAmount,0)
		END

		IF @TDSMode=1
		BEGIN
			SET @TDSTaxAmount=(@SalTaxableAmount*ISNULL(@TaxLessThan50L,0)/100.00)
		END
		ELSE IF @TDSMode=2
		BEGIN
			SET @TDSTaxAmount=(@SalTaxableAmount*ISNULL(@WithoutPan,0)/100.00)
		END

		INSERT INTO @ReturnTDSTaxAmount(TDSTaxAmount,TDSTaxSeqId)
		SELECT @TDSTaxAmount,@TDSTaxSeqId
			
	RETURN 
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='FN_ReturnRowTDSTaxableValue' and XTYPE IN ('TF','FN'))
DROP FUNCTION FN_ReturnRowTDSTaxableValue
GO
--SELECT dbo.FN_ReturnRowTDSTaxableValue(1,2,2) 
CREATE FUNCTION FN_ReturnRowTDSTaxableValue(@RowId AS INT,@UsrId AS INT,@TransId AS INT,@PrdId AS INT,@PrdBatId AS INT)
RETURNS NUMERIC(18,6)
AS
/*********************************  
* PROCEDURE  : FN_ReturnTDS_TaxSetting_Master  
* PURPOSE  : To Return TDS Tax setting details 
* CREATED BY : S.Moorthi   
* CREATED DATE : 05/06/2021 
* NOTE   :  
* MODIFIED  
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
  05/06/2021   S.Moorthi	   CR						   TDS Tax Download
************************************************************************************************************************************/  

BEGIN

	DECLARE  @TDSTaxableAmount AS NUMERIC(18,3)
	SET @TDSTaxableAmount=0
	
	IF EXISTS(SELECT * FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE UsrId =@UsrId 
	AND RowId =@RowId AND TransId = @TransId and PrdId=@PrdId and PrdBatId=@PrdBatId)
	BEGIN
		SELECT @TDSTaxableAmount=ISNULL(MAX(TaxableAmount),0) FROM 
		BilledPrdDtCalculatedTax (NOLOCK) WHERE UsrId =@UsrId AND RowId =@RowId 
		AND TransId = @TransId and PrdId=@PrdId and PrdBatId=@PrdBatId

		SET @TDSTaxableAmount=ISNULL(@TDSTaxableAmount,0)
	END

RETURN @TDSTaxableAmount
END
GO
----Collection------
DELETE FROM CustomCaptions WHERE TransId=9 AND CtrlName='DgCommon-9-31-45'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 9,31,45,'DgCommon-9-31-45','TDS Amt','','',1,1,1,GETDATE(),1,GETDATE(),'TDS Amt','','',1,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='ALLOWEDITTDS' AND ProjectName ='ALL'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'ALL','ALLOWEDITTDS','ALLOWEDITTDS','Allow TDS amount to Edit',1,'',1,1
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnBillDetailsAmt]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnBillDetailsAmt]
GO
--SELECT * FROM DBO.Fn_ReturnBillDetailsAmt(1)
CREATE FUNCTION [dbo].[Fn_ReturnBillDetailsAmt] (@SalId AS BIGINT)
RETURNS @ReturnBillDetailsAmt TABLE
(
	SalId BIGINT,	
	SalPayAmt NUMERIC(38,6),
	SalNetAmt NUMERIC(38,6),
	SalBalAmt NUMERIC(38,6),
	SalTdsAmt NUMERIC(38,6),
	EditMode INT
)
AS
/*********************************************************************************************************
* FUNCTION: Fn_ReturnBillDetailsAmt
* PURPOSE: Returns the Billing Amount
* NOTES: 
* CREATED:  MarySubashini.S	09/06/2021
* MODIFIED 
* DATE			AUTHOR					USERSTORYID		CR/SR		DESCRIPTION
-----------------------------------------------------------------------------------------------------
* 09/06/2021    MarySubashini.S							CR		    TDS Tax Amount 
**********************************************************************************************************/	
BEGIN
	DECLARE @EditMode AS INT 
	SELECT @EditMode=ISNULL(Status,0) FROM ManualConfiguration WHERE ModuleID='ALLOWEDITTDS'
	INSERT INTO @ReturnBillDetailsAmt(SalId,SalPayAmt,SalNetAmt,SalBalAmt,SalTdsAmt,EditMode)
	SELECT  SalId,SalNetAmt,SalPayAmt,SalNetAmt-(ISNULL(SalPayAmt,0)),(ISNULL(SalTDSAmount,0)-ISNULL(SalTDSPayAmount,0)) ,
	@EditMode
	 
	FROM SalesInvoice (NOLOCK) WHERE SalId=@SalId
	 
	RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnCollectionTDSAmt]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnCollectionTDSAmt]
GO
--SELECT * FROM DBO.Fn_ReturnBillDetailsAmt(1)
CREATE FUNCTION [dbo].[Fn_ReturnCollectionTDSAmt] (@SalId AS BIGINT,@InvSlNo AS BIGINT,@InvRcpNo AS VARCHAR(200))
RETURNS @ReturnCollectionTDSAmt TABLE
(
	CollTdsAmt NUMERIC(38,6) 
)
AS
/*********************************************************************************************************
* FUNCTION: Fn_ReturnCollectionTDSAmt
* PURPOSE: Returns the TDS Collection Amount 
* NOTES: 
* CREATED:  MarySubashini.S	05/06/2021
* MODIFIED 
* DATE			AUTHOR					USERSTORYID		CR/SR		DESCRIPTION
-----------------------------------------------------------------------------------------------------
* 05/06/2021    MarySubashini.S							CR		    TDS Tax Amount 
**********************************************************************************************************/	
BEGIN
 
	INSERT INTO @ReturnCollectionTDSAmt(CollTdsAmt)
	SELECT SalInvAmt FROM ReceiptInvoice (NOLOCK) WHERE SalId=@SalId AND InvRcpNo=@InvRcpNo AND InvRcpSno=@InvSlNo
	AND InvRcpMode =10
	RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_VoucherPostingCashReceipt' AND xtype='P')
DROP PROCEDURE Proc_VoucherPostingCashReceipt
GO
----  Exec Proc_VoucherPostingCashReceipt 254,1,'IDR1000005',2,0,2,'2010-04-28',0
CREATE PROCEDURE Proc_VoucherPostingCashReceipt
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/*************************************************************************************************
* PROCEDURE	: Proc_VoucherPostingCashReceipt
* PURPOSE	: General SP for posting CASH Collection
* CREATED	: Murugan
* CREATED DATE	: 26/12/2007
* MODIFIED 
* DATE			AUTHOR					USERSTORYID		CR/SR		DESCRIPTION
-----------------------------------------------------------------------------------------------------
* 05/06/2021    MarySubashini.S							CR		    TDS Tax Amount 
**********************************************************************************************************/	
SET NOCOUNT ON
BEGIN
	
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @RtrCoaId 	INT
DECLARE @DisCoaId 	INT
DECLARE @SalInvNo	Varchar(50)
DECLARE @InvRcpSno	INT
DECLARE @SalId		BIGINT
DECLARE @SalInvAmt 	NUMERIC(38,2)
DECLARE @InvRcpMode	INT	
DECLARE @DisBnkId	INT
DECLARE @DisBnkBrId	INT
DECLARE @InvRcpNo 	NVARCHAR(50)
DECLARE @PurRcptId	INT
DECLARE @PurRcptRefNo	Varchar(50)
DECLARE @PurRcptAmt NUMERIC(38,2)
DECLARE @sSql           VARCHAR(4000)
DECLARE @DbRefNo AS NVARCHAR(100)
DECLARE @IDTMngtNo	Varchar(50)
DECLARE @CashRcpMode AS INT --TDS2021
DECLARE @TCSPayment NUMERIC(38,2) --TDS2021
SET @Po_PurErrNo = 1
--Cash REceipt (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 1
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt,@CashRcpMode=InvRcpMode   FROM ReceiptInvoice WHERE --TDS2021
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId  )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END

	---TDS2021
	----IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	----BEGIN
	----	SET @Po_PurErrNo = -8
	----	Return
	----END
	IF @CashRcpMode=10
		BEGIN
	
			IF NOT EXISTS (SELECT CoaId FROM COAMaster (NOLOCK)  WHERE AcName='TDS' AND aclevel= '4' and maingroup='1' and accode like '131%')
			BEGIN
				SET @Po_PurErrNo = -15
				Return
			END
		
			SELECT @CoaId=CoaId FROM COAMaster (NOLOCK) WHERE AcName='TDS' AND aclevel= '4' and maingroup='1' and accode like '131%'
		
		END
		ELSE
		BEGIN
	
			IF NOT EXISTS (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
			BEGIN
				SET @Po_PurErrNo = -8
				Return
			END
		
			SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		END
		---TDS2021
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	----SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002' ---TDS2021
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
	---TDS2021
	IF @CashRcpMode=10
	BEGIN
			SELECT @TCSPayment=ISNULL(SUM(SalInvAmt),0) FROM RECEIPTINVOICE RI (NOLOCK) 
			INNER JOIN Receipt R(NOLOCK) ON R.InvRcpNo=RI.InvRcpNo
			INNER JOIN SalesInvoice SI(NOLOCK) ON RI.SALID=SI.SALID 
			WHERE SI.SalId=@SalId and RI.InvRcpMode=10 AND RI.CancelStatus=1	
		
			UPDATE A SET A.SalTDSPayAmount=@TCSPayment FROM SALESINVOICE A(NOLOCK) WHERE SalId=@SalId
	END
	---TDS2021		
END
--Cash Receipt (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 5
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@DbRefNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice WHERE 
		InvRcpSno=@Pi_ReferNo AND CanCelStatus=1  
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Debit Note No: '+ @DbRefNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' AND FldName ='ReceiptVoc'
	IF NOT EXISTS (SELECT DISTINCT R.Coaid FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		WHERE R.Availability=1 AND R.RtrId=Si.Rtrid AND R.CoaId=C.CoaId AND SI.DbNoteNumber=@DbRefNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT EXISTS (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	SELECT DISTINCT @RtrCoaId=R.CoaId FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		WHERE R.Availability=1 AND R.RtrId=SI.Rtrid AND R.CoaId=C.CoaId 
		AND SI.DbNoteNumber=@DbRefNo
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit 
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END		
IF @Pi_TransId = 5 AND @Pi_SubTransId = 8	----Add Income Receipt
BEGIN
	
	SELECT @PurRcptRefNo=PurRcptRefNo,@PurRcptId=PurRcptId,@PurRcptAmt=OtherCharges  FROM PurchaseReceipt WHERE
		PurRcptRefNo=@Pi_ReferNo
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	SELECT @PurRcptRefNo=PurRcptRefNo From PurchaseReceipt Where purrcptid=@PurRcptId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Debit Note: '+ @Pi_ReferNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	--For Posting Other Charges Add in Details Table For Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,B.CoaId,2,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',B.CoaId,1,ISNULL(SUM(B.Amount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = ''' + @Pi_ReferNo + ''' AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0'
	
----
	--For Posting Main Cash Account in Details Table To Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	SELECT @Amt = 0
	SELECT @Amt = ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
		INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
----
	
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
------
----Cash Account Receipt Cancel (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 0
BEGIN
		
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cancellation '
		+ @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Debit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
----Cash Account Receipt Cancel (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 6
BEGIN
		
	SELECT @InvRcpNo=InvRcpNo,@DbRefNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice 
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0  
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cancellation ' 
		+ @InvRcpNo + '(Debit Note No: '+ @DbRefNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI where 
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and DbNoteNumber=@DbRefNo )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId 
		and DbNoteNumber=@DbRefNo
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Debit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit 
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
IF @Pi_TransId = 29 AND @Pi_SubTransId = 6
BEGIN
	--TDS2021
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt,@CashRcpMode=InvRcpMode  FROM ReceiptInvoice WHERE
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId  )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	---TDS2021
	IF @CashRcpMode=10
		BEGIN
	
			IF NOT EXISTS (SELECT CoaId FROM COAMaster (NOLOCK)  WHERE AcName='TDS' AND aclevel= '4' and maingroup='1' and accode like '131%')
			BEGIN
				SET @Po_PurErrNo = -15
				Return
			END
		
			SELECT @CoaId=CoaId FROM COAMaster (NOLOCK) WHERE AcName='TDS' AND aclevel= '4' and maingroup='1' and accode like '131%'
		
		END
		ELSE
		BEGIN
	
			IF NOT EXISTS (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
			BEGIN
				SET @Po_PurErrNo = -8
				Return
			END
		
			SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		END
		---TDS2021
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	---SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002' ---TDS2021
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
	---TDS2021
	IF @CashRcpMode=10
	BEGIN
			SELECT @TCSPayment=ISNULL(SUM(SalInvAmt),0) FROM RECEIPTINVOICE RI (NOLOCK) 
			INNER JOIN Receipt R(NOLOCK) ON R.InvRcpNo=RI.InvRcpNo
			INNER JOIN SalesInvoice SI(NOLOCK) ON RI.SALID=SI.SALID 
			WHERE SI.SalId=@SalId and RI.InvRcpMode=10 AND RI.CancelStatus=1	
		
			UPDATE A SET A.SalTDSPayAmount=@TCSPayment FROM SALESINVOICE A(NOLOCK) WHERE SalId=@SalId
	END
	---TDS2021	
			
END
IF @Pi_TransId=34	--Retailer OnAccount
BEGIN
	IF @Pi_SubTransId=3		--Cash Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Retailer OnAccount Cash Receipt ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		--For Posting Cash Account in Details Table on Credit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=34	--Supplier OnAccount
BEGIN
	IF @Pi_SubTransId=7		--Cash Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Supplier OnAccount Cash Receipt ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		--For Posting Cash Account in Details Table on Credit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 1
BEGIN
	DECLARE VoucherReceiptModeCash_cursor CURSOR
	FOR  (
			SELECT IDTRcpNo,IDTMngRefNo,IDTCollectedAmt  FROM IDTReceiptInvoicedetails
			WHERE IDTRcpNo=@Pi_ReferNo  and CollTypeId = 1 and IDTCollectedAmt>0
		 )
	OPEN VoucherReceiptModeCash_cursor
	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpNo,@IDTMngtNo,@SalInvAmt
	WHILE @@FETCH_STATUS = 0
	BEGIN	 	
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END
			SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
						CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
			IF LTRIM(RTRIM(@VocRefNo)) = '' 
			BEGIN
				SET @Po_PurErrNo = -1
				Return
			END
			--For Posting Receipt Header Voucher
			INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
									 LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) 
			VALUES 
				(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt : ' + @InvRcpNo + '(IDT No: '+ @IDTMngtNo +')'+
				' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
				
				UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
			IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
							where R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngtNo  )
			BEGIN
				SET @Po_PurErrNo = -13
  				Return
			END
			IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
			BEGIN
				SET @Po_PurErrNo = -8
				Return
			END
			SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
				where R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngtNo
		 
	
			SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
	
		--For IDT Dist Account Credit	
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
				(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
			--For MainCash Account details On Debit
				
			INSERT INTO StdVocDetails(	VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
										LastModDate,AuthId,AuthDate) 
			VALUES (@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))
			
				SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
				IF @sSql='-4'
				BEGIN
					SET @Po_PurErrNo = -4
					Return
				END
				ELSE IF @sSql='-5'
				BEGIN
					SET @Po_PurErrNo = -5
					Return
				END
				ELSE IF @sSql<>'0'
				BEGIN
					EXEC(@sSql)
				END
		--Validate Credit amount is Equal to Debit 
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
					SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
									ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
					Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			RETURN
		END
	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO   @InvRcpNo,@IDTMngtNo,@SalInvAmt
	END		
	CLOSE VoucherReceiptModeCash_cursor
	DEALLOCATE VoucherReceiptModeCash_cursor
END
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_VoucherPosting' AND xtype='P')
DROP PROCEDURE Proc_VoucherPosting
GO
--EXEC Proc_VoucherPosting 250,1,'HQP0900023',1,1,1,'2009-07-31',0
CREATE PROCEDURE Proc_VoucherPosting
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_ErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPosting
* PURPOSE	: General SP for posting Voucher
* CREATED	: Thrinath
* CREATED DATE	: 25/08/2007
* MODIFIED
* DATE				AUTHOR				DESCRIPTION
* 29/07/2009		MarySubashini.S		Cheque Disbursal Cash Payment
* 30/07/2009		MarySubashini.S		HQ-Payment Posting
------------------------------------------------
* {date} {developer}  {brief modification description}
iTrans_OrderBooking = 1
iTrans_Billing = 2
iTrans_SalesReturn = 3
iTrans_LocationTransfer = 4
iTrans_Purchase = 5
iTrans_VanLoadUnload = 6
iTrans_PurchaseReturn = 7
iTrans_DebitMemo = 8
iTrans_Collection = 9
iTrans_CheuqeBounce = 10
iTrans_ChequePayment = 11
iTrans_CashBounce = 12
iTrans_StockManagement = 13
iTrans_BatchTransfer = 14
iTrans_PaymentReversal = 15
iTrans_ClaimSettlement = 16
iTrans_IRA = 17
iTrans_CreditNoteRetailer = 18
iTrans_DebitNoteRetailer = 19
iTrans_Replacement = 20
iTrans_Salvage = 21
iTrans_PaymentRegister = 22
iTrans_MarketReturn = 23
iTrans_ReturnandReplacement = 24
iTrans_SalesPanel = 25
iTrans_PurchaseOrder = 26
iTrans_SchemeMonitor = 27
iTrans_VehicleAllocation = 28
iTrans_DeliveryProcess = 29
iTrans_CreditNoteReplace = 30
iTrans_ResellDamage = 31
iTrans_CreditNoteSupplier = 32
iTrans_DebitNoteSupplier = 33
iTrans_RetailerOnAccount = 34
iTrans_CreditDebitAdjust = 35
iTrans_ChequeDisbursal = 36
iTrans_ReturnToCompany = 37
iTrans_StockJournal = 38
iTrans_StdVoucher = 39
iTrans_RouteCovPlan = 40
iTrans_RetailerShipAdd = 41
iTrans_ContPriceMaster = 42
iTrans_CollDiscMaster = 43
iTrans_ChqInvRetiler = 44
iTrans_SchemeMaster = 45
iTrans_TargetAnalysis = 46
iTrans_UOM = 47
iTrans_KitPrdMaster = 48
iTrans_PrdSalBundle = 49
iTrans_PurOrdNormMap = 50
iTrans_TargetNormMap = 51
iTrans_InventoryConsole = 52
iTrans_ChequeInventorySupp = 53
iTrans_PointRedemptionRule = 54
iTrans_PointRedemptionScreen = 55
iTrans_RspPunchingWindow = 56
iTrans_SubStockistEntry = 57
iTrans_LaunchProduct = 58
iTrans_CouponDefinition = 59
iTrans_CouponDenomination = 60
iTrans_CouponCollection = 61
iTrans_CouponRedemption = 62
iTrans_CouponMonitor = 63
iTrans_Attendance = 64
iTrans_FocusBrand = 65
iTrans_SalesmanIncCalc = 66
iTrans_ManualClaim = 104
iTrans_SplDiscountClaim = 143
iTrans_SalesmanSalaryAndDAClaim = 96
iTrans_DeliveryBoyClaim = 217
iTrans_TransporterClaim = 136
iTrans_RateDifferenceClaim = 97
iTrans_PurchaseShortageClaim = 99
iTrans_PurchaseExcessClaim = 105
iTrans_SpentReceived = 173
iTrans_VanSubsidyClaim = 178
iTrans_HQPaymentRegister = 250
*********************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @ErrStatus		INT
DECLARE	@InvRcpSno		INT
DECLARE @ReplaceNo		nVarChar(100)
DECLARE @PayMode 		INT
DECLARE @ChqNo 			NVARCHAR(500)
Declare @IDTRcpNo       nVarchar(50)
DECLARE @AcmId			INT
SET @ErrStatus = 1
	--Claim
	SELECT @AcmId=ACM.AcmId FROM AcMaster ACM,AcPeriod ACP
	WHERE ACM.AcmId=ACP.AcmId AND @Pi_VocDate BETWEEN AcmSdt AND AcmEdt
	IF EXISTS(SELECT * FROM YearEnd WHERE AcmId=@AcmId)
	BEGIN
		SET @ErrStatus=-29
	END
	ELSE
	BEGIN
		IF @Pi_TransId= 153 OR  @Pi_TransId=178 OR @Pi_TransId=173 OR @Pi_TransId=96 OR @Pi_TransId=217
			OR @Pi_TransId=104 OR @Pi_TransId= 16 OR  @Pi_TransId= 66	-- Sales
		BEGIN
			IF @Pi_TransId = 16
			BEGIN
				IF (SELECT ISNULL(SUM(A.RecommendedAmount),0) FROM ClaimSheetDetail A INNER JOIN ClaimSheetHD B
				ON A.ClmId=B.ClmId WHERE B.ClmCode = @Pi_ReferNo AND A.SelectMode=1 AND A.CrDbStatus=0)>0
				BEGIN
					EXEC Proc_VoucherPostingClaim @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			ELSE
			BEGIN
				EXEC Proc_VoucherPostingClaim @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=3		-- Sales
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
	
		END
		IF @Pi_TransId = 5
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				IF EXISTS (SELECT * FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo AND
					HandlingCharges > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 3
			BEGIN
				IF EXISTS (SELECT ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
					INNER JOIN PurchaseReceiptOtherCharges B ON A.PurRcptId = B.PurRcptId
						WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 1
					HAVING ISNULL(SUM(B.Amount),0) > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 4
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 5
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 6
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 8
				BEGIN
					IF EXISTS (SELECT ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
						INNER JOIN PurchaseReceiptOtherCharges B ON A.PurRcptId = B.PurRcptId
							WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
							HAVING ISNULL(SUM(B.Amount),0) > 0)
					BEGIN
						IF EXISTS(SELECT B.CoaID FROM COAMaster A
							INNER JOIN PurchaseReceiptOtherCharges B on A.CoaId=B.CoaId Where A.AcCode Like '4%')	--ExpenseAccount
						BEGIN	
							EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
								@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
						END
						IF EXISTS(SELECT B.CoaID FROM COAMaster A
							INNER JOIN PurchaseReceiptOtherCharges B on A.CoaId=B.CoaId Where A.AcCode Like '3%')	--IncomeAccount
						BEGIN
							EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,3,
								@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
						END
					END
				END
			
		END
		IF @Pi_TransId = 7		--Purchase Return
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 9		--Collection Register
		BEGIN
			IF @Pi_SubTransId = 1 -- (Bill Invoice)
			BEGIN
				---Cash Account Receipt	
				DECLARE VoucherReceiptModeCash_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
							AND InvRcpMode in (1,10) ---TDS2021
						--and InvRcpMode=1
				     )
				OPEN VoucherReceiptModeCash_cursor
				FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCash_cursor
				DEALLOCATE VoucherReceiptModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4,8) AND PostChequeVoucher=1
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
		
				---Cash Discount Account Receipt
				DECLARE VoucherReceiptModeCashDisc_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and
						CanCelStatus=1 and InvRcpMode=2
				     )
				OPEN VoucherReceiptModeCashDisc_cursor
				FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCashDisc_cursor
				DEALLOCATE VoucherReceiptModeCashDisc_cursor
			END
			IF @Pi_SubTransId = 5  -- (Debit Invoice)
			BEGIN
				---Cash Account Receipt	
				DECLARE VoucherReceiptModeCash_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode=1
				     )
				OPEN VoucherReceiptModeCash_cursor
				FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCash_cursor
				DEALLOCATE VoucherReceiptModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4,8) AND PostChequeVoucher=1
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
		
				---Cash Discount Account Receipt
				DECLARE VoucherReceiptModeCashDisc_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and
						CanCelStatus=1 and InvRcpMode=2
				     )
				OPEN VoucherReceiptModeCashDisc_cursor
				FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCashDisc_cursor
				DEALLOCATE VoucherReceiptModeCashDisc_cursor
			END
			IF @Pi_SubTransId = 0 --(Bill Invoice)
			BEGIN
				---Cash Account ReceiptCancel	
				If Exists(SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=1)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=1
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
				
				---Cash Discount Account Receipt
				If EXISTS(SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=2)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=2
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END	
			END
			IF @Pi_SubTransId = 6 --(Debit Invoice)
			BEGIN
				---Cash Account ReceiptCancel	
				If Exists(SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=1)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=1
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
				
				---Cash Discount Account Receipt
				If EXISTS(SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=2)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=2
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END	
			END
			IF @Pi_SubTransId = 2  --(Bill Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=2 
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,1,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			IF @Pi_SubTransId = 7  --(Debit Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=2
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,5,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			IF @Pi_SubTransId = 3  --(Bill Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=3
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,1,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END	
			IF @Pi_SubTransId = 8  --(Debit Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=3
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,5,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			
		END
		IF @Pi_TransId=10	--Cheque Bouncing
		BEGIN
			IF @Pi_SubTransId = 1 OR @Pi_SubTransId = 3		--Debit Note for Retailer
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,1,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2 OR @Pi_SubTransId = 4		--Bank Charges paid to the Bank
			BEGIN
				IF EXISTS (SELECT Penality FROM ChequePayment WHERE ChequePayId = @Pi_ReferNo
					AND Penality > 0 )
				BEGIN
					EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,1,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
		END
		
		IF @Pi_TransId = 13
		BEGIN
			IF @Pi_SubTransId = 1 OR @Pi_SubTransId=0
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,0,
				@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
	-- 		IF @Pi_SubTransId = 0
	-- 		BEGIN
	-- 			EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,0,
	-- 			@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
	-- 		END
		END
		IF @Pi_TransId = 18  OR @Pi_TransId = 32
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId = 19  OR @Pi_TransId = 33
		BEGIN
			EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
			@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		
		IF @Pi_TransId = 22	--Payment Register
		BEGIN
			IF @Pi_SubTransId = 1 	--Cash Payment
			BEGIN
				IF EXISTS(SELECT PayAdvNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo And PayMode = 1)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
		 	END
			IF @Pi_SubTransId = 2 	--Bank Payment
			BEGIN
				IF EXISTS(SELECT PayAdvNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo And PayMode IN (2,3,5))
				BEGIN
					DECLARE VoucherPaymentModeChqDD_cursor CURSOR
					FOR  (
					 	SELECT PayMode,PayInsNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo
						And PayMode in (2,3,5)
						
					     )
					OPEN VoucherPaymentModeChqDD_cursor
					FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO @PayMode,@ChqNo
					WHILE @@FETCH_STATUS = 0
					BEGIN	 		
						EXEC Proc_VoucherPostingBankPay @Pi_TransId,@PayMode,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@ChqNo,@Po_PurErrNo = @ErrStatus OUTPUT
	
						FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO  @PayMode,@ChqNo
					END
					CLOSE VoucherPaymentModeChqDD_cursor
					DEALLOCATE VoucherPaymentModeChqDD_cursor
				END
	
			END
		END
		IF @Pi_TransId = 24
		BEGIN
			EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId = 29 	--Billing
		BEGIN
			IF @Pi_SubTransId = 1	--  Billing Voucher
			BEGIN
				EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2	-- Other Charges Add Expeneses Billing
			BEGIN
				IF EXISTS (SELECT ISNULL(SUM(B.AdjAmt),0)FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
						A.SalId = B.SalId INNER JOIN PurSalAccConfig C
						ON C.AccDescId = B.AccDescId AND C.TransactionId=2
					WHERE A.SalInvno = @Pi_ReferNo AND C.Effect = 0
					HAVING ISNULL(SUM(B.AdjAmt),0) > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 3	--Market Return
			BEGIN
				IF EXISTS (SELECT MarketRetAmount FROM SalesInvoice Where MarketRetAmount >0
					AND SalInvno = @Pi_ReferNo)
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 4	--Replacement sales
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 5	--Repalcement Sales Return
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 6	--Cash Sales
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7	--Repalcement Debit Entry
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@ReplaceNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
		END
		
		IF @Pi_TransId = 34
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 3
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 4
			BEGIN
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 5
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 6
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 8
			BEGIN
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=36
		BEGIN
			IF @Pi_SubTransId=1
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=2
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=3
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=4
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 38
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 14
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=55 AND @Pi_SubTransId=1
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId=62 AND @Pi_SubTransId=1
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		
		IF @Pi_TransId = 250	--HQ Payment Register
		BEGIN
			IF @Pi_SubTransId = 1 
			BEGIN
				---Cash Account Payment	
				DECLARE VoucherPaymentModeCash_cursor CURSOR
				FOR  (
				 	SELECT PayRcpSno FROM HQPaymentDetails WHERE PayRcpNo=@Pi_ReferNo 
						AND PayMode=1
				     )
				OPEN VoucherPaymentModeCash_cursor
				FETCH NEXT FROM VoucherPaymentModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 	
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,
						1,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherPaymentModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherPaymentModeCash_cursor
				DEALLOCATE VoucherPaymentModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherPaymentModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT PayRcpSno,InvInsNo FROM HQPaymentDetails WHERE PayRcpNo=@Pi_ReferNo 
						AND PayMode IN(3,4,8) 
				     )
				OPEN VoucherPaymentModeChqDD_cursor
				FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO @InvRcpSno,@ChqNo
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankPay @Pi_TransId,1,@InvRcpSno,@Pi_VocType,
						2,@Pi_UserId,@Pi_VocDate,@ChqNo,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO  @InvRcpSno,@ChqNo 
				END
				CLOSE VoucherPaymentModeChqDD_cursor
				DEALLOCATE VoucherPaymentModeChqDD_cursor
			END
		END
		IF @Pi_TransId=270     ----   IDT Management
		BEGIN
			EXEC Proc_VoucherPostingIDTManagement @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId=271     ----   IDT Collection
		BEGIN
							/* Stock Out --  Receipt*/
			IF @Pi_SubTransId= 1		
			BEGIN
							/* Sub Voucher - 3 Cash */
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher -  4 Bank*/
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 6 Cash Discount*/
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT 
			END
							/* Stock IN --  Payment*/
			IF @Pi_SubTransId= 2		
			BEGIN
							/* Sub Voucher - 1 Cash */
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,
						1,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 2 Bank*/
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,
						2,@Pi_UserId,@Pi_VocDate,0,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 6 Cash Discount*/
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT 
			END
		END
	END
	SET @Po_ErrNo = @ErrStatus
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_ValidateTDSTaxInBilling' and xtype='FN')
DROP FUNCTION Fn_ValidateTDSTaxInBilling
GO
--SELECT DBO.Fn_ValidateTDSTaxInBilling(563,39282,'2021-06-14',689,29) as TDSValidate
CREATE FUNCTION Fn_ValidateTDSTaxInBilling(@Pi_RtrId AS BIGINT,@SalId AS INT,@Pi_ServerDate DateTime,
@NetAmount NUMERIC(18,6),@TDSAmount NUMERIC(18,6))
RETURNS VARCHAR(500)
AS
BEGIN
/*************************************************************************
* FUNCTION : Fn_ValidateTDSTaxInBilling
* PURPOSE  : Validate Return TDS Tax 
* NOTES    : 
* CREATED  : S.Moorthi
* MODIFIED : 07/06/2021
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  07/06/2021  S.Moorthi				CR		DABCS202100016            TDS Validation in Billing   
**************************************************************************/
	
	DECLARE @TCSApplicable AS VARCHAR(20)
	DECLARE @TDSApplicable AS VARCHAR(20)
	DECLARE @ValidateMsg AS VARCHAR(500)

	SET @ValidateMsg=''
	SET @TCSApplicable=''
	SET @TDSApplicable=''

	SELECT @TDSApplicable=ISNULL(D.ColumnValue,'NA') FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName IN ('TDS Applicable') 
	WHERE E.MasterId=2 and D.MasterRecordId=@Pi_RtrId

	SELECT @TCSApplicable=ISNULL(D.ColumnValue,'NO') FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName IN ('TCS Applicable') 
	WHERE E.MasterId=2 and D.MasterRecordId=@Pi_RtrId

	IF UPPER(@TDSApplicable) IN ('LessThan 50L','WithOut Pan') AND UPPER(@TCSApplicable)='YES'
	BEGIN
		SET @ValidateMsg='Both TCS & TDS should Not be Applicable for Retailer '
		RETURN @ValidateMsg
	END

	IF @NetAmount-@TDSAmount<1
	BEGIN
		SET @ValidateMsg='Net amount should be greater than TDS amount '
		RETURN @ValidateMsg
	END
	
	RETURN(@ValidateMsg)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ValidateSaveUDC_TCSTDS' AND TYPE='FN')
DROP FUNCTION Fn_ValidateSaveUDC_TCSTDS
GO
--SELECT dbo.Fn_ValidateSaveUDC_TCSTDS(79,1943,2,'TDS APPLICABLE','LessThan 5','LessThan 5','YES') as ValMsg
CREATE FUNCTION Fn_ValidateSaveUDC_TCSTDS(@TransId as INT,@RtrId as BIGINT,@MasterId AS INT,@ColumnName AS VARCHAR(200),
@ColumnValue AS VARCHAR(200),@VTDSApply as varchar(50),@VTCSApply as VARCHAR(50))
RETURNS VARCHAR(200)
AS
/*********************************
* PROCEDURE		: Fn_ValidateSaveUDC_TCSTDS
* PURPOSE		: To Validate UDC 
* CREATED		: S.MOhana
* CREATED DATE	: 08-06-2021
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
	DECLARE @ValMsg AS VARCHAR(200)
	SET @ValMsg=''
	     
	 If @VTCSApply = 'YES' 
	 BEGIN
		IF @VTDSApply IN ('LessThan 50L','WithOut Pan')
		BEGIN
			SET @ValMsg= 'Both TCS & TDS should Not be Applicable' 
		END
		ELSE IF @VTDSApply = 'NA'
		BEGIN
			SET @ValMsg= '' 
		END

	 END

RETURN @ValMsg
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_CN2CS_DistTCSUDCDetails' AND xtype='P')
DROP PROCEDURE Proc_CN2CS_DistTCSUDCDetails
GO
/*
BEGIN Transaction
 EXEC Proc_CN2CS_DistTCSUDCDetails 0
Rollback Transaction
*/
CREATE PROCEDURE Proc_CN2CS_DistTCSUDCDetails
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*********************************    
* PROCEDURE: Proc_Validate_CN2CS_UdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: S.Moorthi
*************************************************
* DATE       AUTHOR     CR/BZ  USER STORY ID           DESCRIPTION                         
*********************************************************************************************
02-09-2020   Kishore       CR      NIVCS202100015      TCS Tax Amount included
10-06-2020   S.Moorthi     CR						   TDS Tax Amount included
*********************************/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	SET @TabName = 'Cn2Cs_Prk_DistTCSUDCDetails'  
	SET @Po_ErrNo =0
	DELETE FROM Cn2Cs_Prk_DistTCSUDCDetails WHERE DownloadFlag='Y'
	select @ColCode=DistributorCode from Distributor
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT ISNULL([ColumnName],'') ColumnName,ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM Cn2Cs_Prk_DistTCSUDCDetails (NOLOCK) WHERE DownloadFlag='D' AND ColumnName in ('TCS Applicable','TDS Applicable','TurnOver')
		Order by CreatedDate
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @ColName,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 
		IF @Po_ErrNo = 0 
		BEGIN
			
		  SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
							  
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
	
	
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				
			END
	END
	
		FETCH NEXT FROM Cur_UdcDt INTO @ColName,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
	UPDATE Cn2Cs_Prk_DistTCSUDCDetails SET DownLoadFlag='Y' WHERE ColumnName in ('TCS Applicable','TDS Applicable','TurnOver')
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='ETL_Prk_RetailerTCSInfo')
DROP TABLE ETL_Prk_RetailerTCSInfo
GO
CREATE TABLE [dbo].[ETL_Prk_RetailerTCSInfo](
	[Retailer Code] [nvarchar](100) NULL,
	[Retailer Name] [nvarchar](100) NULL,
	[PanNumber] [nvarchar](100) NULL,
	[TCSApplicable] [nvarchar](100) NULL,
	[Aadhaar] [nvarchar](100) NULL,
	[TDSApplicable] [nvarchar](100) NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ExportRetailerTCSInfo]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ExportRetailerTCSInfo]
GO
--Select dbo.Fn_ExportRetailerTCSInfo()
CREATE FUNCTION Fn_ExportRetailerTCSInfo ()
RETURNS NVARCHAR(4000)
AS
/*********************************
* FUNCTION: Fn_ExportRetailerTCSInfo
* PURPOSE: Return Retailer Master TCS Information
* NOTES:
* CREATED: S.Moorthi
* MODIFIED : 30/09/2020
* DATE      AUTHOR     DESCRIPTION
----------------------------------------------------------------------------------------------------------------------------------
************************************************************************************************************************************/
BEGIN
DECLARE @sSql NVARCHAR(MAX)
SET @sSql  = 'SELECT DISTINCT A.RtrCode AS [Retailer Code],A.RtrName AS [Retailer Name],
			isnull(E.PANNumber,'''')  AS PanNumber,
			isnull(I.TCSApplicable,'''') AS TCSApplicable,isnull(j.Aadhaar,'''')  as Aadhaar,
			isnull(K.TDSApplicable,'''') AS TDSApplicable INTO #TEMP 
			From Retailer A WITH (NOLOCK) 
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as PANNumber FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'') E
			ON E.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as TCSApplicable FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''TCS Applicable'') I
			ON I.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as Aadhaar FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Aadhaar'') J
			ON J.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as TDSApplicable FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''TDS Applicable'') K
			ON K.RtrId=A.RtrId
			 Order by A.RtrCode
		  SELECT * FROM #TEMP'
RETURN (@sSql)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_ValidateRetailerTCSInfo' AND xtype='P')
DROP PROCEDURE Proc_ValidateRetailerTCSInfo
GO
/*
 BEGIN TRAN
 Delete  FROM ERRORLOG
 EXEC Proc_ValidateRetailerTCSInfo 0
 select * from ErrorLog
 ROLLBACK TRAN
 */
CREATE PROCEDURE Proc_ValidateRetailerTCSInfo
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateRetailerTCSInfo
* PURPOSE		: To validate the Retailer TCS details through ETL Process
* CREATED		: S.Moorthi
* CREATED DATE	: 30/09/2020
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
******************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
*******************************************************************************************************
*********************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @RtrId AS INT
	DECLARE @TCSAPP AS VARCHAR(100)  ---MARCS202100060
	DECLARE @Aadhaar AS VARCHAR(100)
	DECLARE @ColCode99 as varchar(100)
	DECLARE @TDSAPP AS VARCHAR(100)  ---TDS2021
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #ETL_Prk_RetailerTCSInfo
	(
		RtrCode			[Varchar](50),
		RtrName			[Varchar](150),
		PanNumber		[Varchar](15),
		TCSApplicable	[nvarchar](100),
		Aadhaar			[nvarchar](100),
		TDSApplicable	[nvarchar](100)---TDS2021
	)
	
	DELETE FROM ErrorLog WHERE TableName='Retailer TCS Info'
	
	INSERT INTO #ETL_Prk_RetailerTCSInfo
	SELECT ISNULL([Retailer Code],''),ISNULL([Retailer Name],''),ISNULL([PanNumber],''),
	isnull([TCSApplicable],''),ISNULL([Aadhaar],''),isnull([TDSApplicable],'') ---TDS2021
	from ETL_Prk_RetailerTCSInfo
	
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer TCS','Retailer Code','Retailer TCS Details Should not be empty' 
	FROM #ETL_Prk_RetailerTCSInfo
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(TCSApplicable,'')))=''
	OR RTRIM(LTRIM(ISNULL(TDSApplicable,'')))='')---TDS2021
	
	DELETE A FROM #ETL_Prk_RetailerTCSInfo A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(TCSApplicable,'')))=''
	OR RTRIM(LTRIM(ISNULL(TDSApplicable,'')))='') ---TDS2021
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #ETL_Prk_RetailerTCSInfo
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  1,'RetailerTCSInfo','Retailer','Retailer TCS Details Not allow more than 1-'+RtrCode FROM #ETL_Prk_RetailerTCSInfo
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) 
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 2,'RetailerTCSInfo','RetailerCode','Retailer Code not Available-'+RtrCode FROM #ETL_Prk_RetailerTCSInfo  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode)
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'Retailer TCS','TCSApplicable','TCSApplicable Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerTCSInfo CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')---MARCS202100060

	--TDS2021
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TDSApplicable,'')))) NOT IN ('LessThan 50L','WithOut Pan','NA')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'Retailer TCS','TDSApplicable','TDSApplicable Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerTCSInfo CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TDSApplicable,'')))) NOT IN ('LessThan 50L','WithOut Pan','NA') 

	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TDSApplicable,'')))) IN ('LessThan 50L','WithOut Pan') AND RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) ='YES'
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'Retailer TCS','TCS/TDS Applicable','Both TCS & TDS Applicable should not be YES '+RtrCode FROM #ETL_Prk_RetailerTCSInfo CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TDSApplicable,'')))) IN ('LessThan 50L','WithOut Pan') AND RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) ='YES'
	--TDS2021	

	DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1

	
	DECLARE Cur_RetailerTCSInfo CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([RtrCode])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([TCSApplicable])),''),ISNULL(LTRIM(RTRIM([Aadhaar])),''),
	ISNULL(LTRIM(RTRIM([TDSApplicable])),'')
	FROM #ETL_Prk_RetailerTCSInfo WHERE --[DownLoadFlag] ='D' AND
	RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerTCSInfo
	FETCH NEXT FROM Cur_RetailerTCSInfo INTO @RtrCode,@PanNumber,@TCSApp,@Aadhaar,@TDSApp ---TDS2021
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
		
			SET @Rtrid=''
			SELECT @Rtrid=Rtrid FROM Retailer(NOLOCK ) WHERE RtrCode =@RtrCode
			
		
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer TCS','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer TCS','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END	
			END
			
		    IF RTRIM(LTRIM(UPPER(ISNULL(@Aadhaar,''))))<>''
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@Aadhaar))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer TCS','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
									
			IF @Po_ErrNo=0
			BEGIN
					
				DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master' and ColumnName='PAN/Aadhaar Available'
					
			
				INSERT INTO ETL_Prk_UDCRetailerGST (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','TCS Applicable',@RtrCode,@TCSApp,0 UNION ALL---MARCS202100060
				SELECT DISTINCT 'Retailer Master','Aadhaar',@RtrCode,@Aadhaar,0 UNION ALL--MARCS202100060
				SELECT DISTINCT 'Retailer Master','TDS Applicable',@RtrCode,@TDSApp,0   ---TDS2021
				
				IF EXISTS(SELECT * FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master')
				BEGIN
					EXEC Proc_ETLValidate_UdcDetailsGST 0
				END
				
			END
							
		FETCH NEXT FROM Cur_RetailerTCSInfo INTO @RtrCode,@PanNumber,@TCSApp,@Aadhaar,@TDSApp ---TDS2021
	END
	CLOSE Cur_RetailerTCSInfo
	DEALLOCATE Cur_RetailerTCSInfo
	
		---Added by Gopi at 05-09-2020 to Capture PAN/Aadhar availability column Capture MARCS202100060
		DECLARE Cur_UdcDt1 CURSOR   
		FOR SELECT DISTINCT ISNULL(LTRIM(RTRIM([RtrCode])),'')
		FROM #ETL_Prk_RetailerTCSInfo WHERE 
		RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
		OPEN Cur_UdcDt1  
		FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
		WHILE @@FETCH_STATUS=0  
		BEGIN  
			EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0
		FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
		END  
		CLOSE Cur_UdcDt1  
		DEALLOCATE Cur_UdcDt1
		
	RETURN
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_Retailer' AND name='TDSApplicable')
BEGIN
       ALTER TABLE Cs2Cn_Prk_Retailer ADD TDSApplicable VARCHAR(100)
END
GO
UPDATE Customcaptions SET MsgBox='Adjustment amount should be less than the (Bill-TDS) amount',
DefaultMsgBox ='Adjustment amount should be less than the (Bill-TDS) amount' WHERE CtrlName ='Msgbox-188-1000-1'
AND TransId=188
GO
---COLLECTION REPORT
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_ReturnToValidateCreditNoteWithTDS' and xtype='FN')
DROP FUNCTION Fn_ReturnToValidateCreditNoteWithTDS
GO
/*
BEGIN TRAN
SELECT DBO.Fn_ReturnTDSTaxForBilling(2,1,70277,1943,'2021-06-07',0)
SELECT * FROM SalesInvoice(nolock) where SalId=70277
ROLLBACK TRAN
*/
CREATE FUNCTION Fn_ReturnToValidateCreditNoteWithTDS
(
	 @Pi_NetAmount			NUMERIC(18,6),
	 @Pi_SalTDSAmount		NUMERIC(18,6),
	 @Pi_CRAdjAmount		NUMERIC(18,6),
	 @Pi_TotalAmount			NUMERIC(18,6)
)
RETURNS VARCHAR(1000)
AS 
/************************
* PROCEDURE		: Proc_CalculateTDSTaxinBilling
* PURPOSE		: Calculate TDS Tax in Billing
* CREATED BY	: S.Moorthi
* MODIFIED		: 05/06/2021
*****************************************************************************************************************
' Version       Date        Person           User Story ID    CR/BZ     Remarks          Code Review By   Review Date
*****************************************************************************************************************

***************************/
BEGIN
	DECLARE @ValidateMsg AS VARCHAR(1000)
	SET @ValidateMsg=''
	DECLARE @ValAmount AS NUMERIC(18,3)
	SET @ValAmount=(@Pi_NetAmount-@Pi_SalTDSAmount)+@Pi_CRAdjAmount-@Pi_TotalAmount
	IF @ValAmount<1
	BEGIN
		SET @ValidateMsg='Adjustment amount should be less than the (Bill-TDS) amount'
	END
			
	RETURN @ValidateMsg
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TDSApplicable' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='CN2Cs_Prk_RetailerMasterDownload' AND XTYPE='U'))
BEGIN
	ALTER TABLE CN2Cs_Prk_RetailerMasterDownload ADD TDSApplicable Nvarchar(20) ---Values must be Yes/No
END
GO
IF  EXISTS (SELECT * FROM Sysobjects Where Name='Fn_CollectionTDSEditOption' and XTYPE IN ('TF','FN'))
DROP FUNCTION [dbo].[Fn_CollectionTDSEditOption]
GO
--SELECT * FROM DBO.Fn_CollectionTDSEditOption(1)
CREATE FUNCTION [dbo].[Fn_CollectionTDSEditOption] (@SalId AS BIGINT)
RETURNS INT 
AS
/*********************************************************************************************************
* FUNCTION: Fn_CollectionTDSEditOption
* PURPOSE: Returns TDS edit Option
* NOTES: 
* CREATED:  MarySubashini.S	09/06/2021
* MODIFIED 
* DATE			AUTHOR					USERSTORYID		CR/SR		DESCRIPTION
-----------------------------------------------------------------------------------------------------
* 09/06/2021    MarySubashini.S							CR		    TDS Tax Amount 
**********************************************************************************************************/	
BEGIN
	DECLARE @EditMode AS INT 
	SET @EditMode=0
	IF EXISTS (SELECT 'X' FROM  SalesInvoice (NOLOCK) WHERE SalId=@SalId AND SalTDSAmount>0 )
	BEGIN
		SET  @EditMode=1 
	END
	RETURN (@EditMode)
END
GO
DELETE FROM RptFormula where RptId=4 AND SlNo=38
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
SELECT 4,38,'TDSAmt','TDS Amount',1,0
GO
DELETE FROM RptExcelHeaders WHERE RptId=4
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) 
SELECT 4,1,'SalId','SalId',0,1 UNION ALL
SELECT 4,2,'SalInvNo','Bill Number',1,1 UNION ALL
SELECT 4,3,'SalInvDate','Bill Date',1,1 UNION ALL
SELECT 4,4,'SalInvRef','SalRef Number',0,1 UNION ALL
SELECT 4,5,'InvRcpNo','Receipt Number',0,1 UNION ALL
SELECT 4,6,'InvRcpDate','Collection Date',0,1 UNION ALL
SELECT 4,7,'RtrId','RtrId',0,1 UNION ALL
SELECT 4,8,'RtrName','Retailer Name',1,1 UNION ALL
SELECT 4,9,'Bill Amount','Bill Amount',1,1 UNION ALL
SELECT 4,10,'CurPayAmount','Current PayAmount',1,1 UNION ALL
SELECT 4,11,'CrAdjAmount','Cr.Adj.Amount',1,1 UNION ALL
SELECT 4,12,'DbAdjAmount','Db.Adj.Amount',1,1 UNION ALL
SELECT 4,13,'CashDiscount','Cash Discount',1,1 UNION ALL
SELECT 4,14,'CollCashAmt','Collect CashAmt',1,1 UNION ALL
SELECT 4,15,'CollChqAmt','Collect ChqAmt',1,1 UNION ALL
SELECT 4,16,'CollDDAmt','Collect DDAmt',1,1 UNION ALL
SELECT 4,17,'CollRTGSAmt','CollRTGSAmt',0,1 UNION ALL
SELECT 4,18,'CollTdsAmt','Collected TDS Amount',1,1 UNION ALL
SELECT 4,19,'BalanceAmount','Balance Amount',1,1 UNION ALL
SELECT 4,20,'CollectedAmount','Collected Amount',0,1 UNION ALL
SELECT 4,21,'PayAmount','Payment Amount',0,1 UNION ALL
SELECT 4,22,'TotalBillAmount','Total Bill Amount',0,1 UNION ALL
SELECT 4,23,'AmtStatus','Amount Status',0,1 
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='RptCollectionValue')
DROP TABLE RptCollectionValue
GO
CREATE TABLE RptCollectionValue(
	[SalId] [bigint] NULL,
	[SalInvDate] [datetime] NULL,
	[SalInvNo] [nvarchar](100) NULL,
	[SalInvRef] [nvarchar](500) NULL,
	[SMId] [int] NULL,
	[SMName] [nvarchar](100) NULL,
	[InvRcpDate] [datetime] NULL,
	[RtrId] [int] NULL,
	[RtrName] [nvarchar](100) NULL,
	[RMId] [int] NULL,
	[RMName] [nvarchar](100) NULL,
	[DlvRMId] [int] NULL,
	[DelRMName] [nvarchar](100) NULL,
	[BillAmount] [numeric](38, 6) NULL,
	[CrAdjAmount] [numeric](38, 6) NULL,
	[DbAdjAmount] [numeric](38, 6) NULL,
	[CashDiscount] [numeric](38, 6) NULL,
	[CollectedAmount] [numeric](38, 6) NULL,
	[PayAmount] [numeric](38, 6) NULL,
	[CurPayAmount] [numeric](38, 6) NULL,
	[CollCashAmt] [numeric](38, 6) NULL,
	[CollChqAmt] [numeric](38, 6) NULL,
	[CollDDAmt] [numeric](38, 6) NULL,
	[CollRTGSAmt] [numeric](38, 6) NULL,
	[InvRcpNo] [nvarchar](50) NULL,
	[CollTdsAmt] [numeric](38, 6) NULL
) ON [PRIMARY]
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_CollectionValues')
DROP PROCEDURE  Proc_CollectionValues
GO
--EXEC Proc_CollectionValues 1
CREATE PROCEDURE Proc_CollectionValues
(
	@Pi_TypeId INT
)
/**********************************************************************************
* PROCEDURE		: Proc_CollectionValues
* PURPOSE		: To Display the Collection details
* CREATED		: MarySubashini.S
* CREATED DATE	: 01/06/2007
* NOTE			: General SP for Returning the Collection details
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
-----------------------------------------------------------------------------------
* {date}		{developer}			{brief modification description}
* 01-09-2009	Thiruvengadam.L		CR changes
* 08-12-2009	Thiruvengadam.L		Cheque and DD are displayed in single column	
************************************************************************************/
AS
BEGIN	
SET NOCOUNT ON
	DECLARE @SalId AS BIGINT
	DECLARE @InvRcpDate AS DATETIME
	DECLARE @CrAdjAmount AS NUMERIC (38, 6)
	DECLARE @DbAdjAmount AS NUMERIC (38, 6)
	DECLARE @SalNetAmt AS NUMERIC (38, 6)
	DECLARE @CollectedAmount AS NUMERIC (38, 6)
	DECLARE @Count AS INT
	DECLARE @Prevamount AS NUMERIC (38, 6)
	DECLARE @CurPrevamount AS NUMERIC (38, 6)
	DECLARE @PrevSalId AS BIGINT
	DELETE FROM RptCollectionValue	
	
	INSERT INTO RptCollectionValue (SalId ,SalInvDate,SalInvNo,SalInvRef,
				SMId ,SMName,InvRcpDate,RtrId ,
				RtrName ,RMId ,RMName ,DlvRMId ,
				DelRMName ,BillAmount,CrAdjAmount,DbAdjAmount,CashDiscount,
				CollectedAmount,PayAmount,CurPayAmount,CollCashAmt,CollChqAmt,CollDDAmt,
				CollRTGSAmt,InvRcpNo,CollTdsAmt)---TDS2021
	SELECT SalId,SalInvDate,SalInvNo,SalInvRef,SMId,SMName,
	 InvRcpDate,RtrId,RtrName,RMId,RMName,DlvRMId,DelRMName,
	 SalNetAmt AS BillAmount,
	 SUM(CrAdjAmount) AS CrAdjAmount,SUM(DbAdjAmount) AS DbAdjAmount,
	 SUM(CashDiscount) AS CashDiscount,
	 SUM(CollectedAmount) AS CollectedAmount,
	 SUM(PayAmount) AS PayAmount, SUM(PayAmount) AS CurPayAmount,
	 SUM(CollCashAmt) AS CollCashAmt,SUM(CollChqAmt) AS CollChqAmt,SUM(CollDDAmt) AS CollDDAmt,
	 SUM(CollRTGSAmt) AS CollRTGSAmt,InvRcpNo,SUM(CollTdsAmt)---TDS2021
	FROM(
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName AS DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,SUM(RI.SalInvAmt)AS CollectedAmount,0 AS PayAmount,
		SUM(RI.SalInvAmt)  AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		    Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
			AND RI.InvRcpMode IN (1) --AND RI.InvInsSta NOT IN(4,@Pi_TypeId)
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				0 AS CrAdjAmount,
				0 AS DbAdjAmount,0 AS CashDiscount,
				SI.Amount,SUM(RI.DebitAmt)AS CollectedAmount,0 AS PayAmount,
				SUM(RI.DebitAmt)  AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (1) AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName AS DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,SUM(RI.SalInvAmt)AS CollectedAmount,0 AS PayAmount,0 AS CollCashAmt,
		    SUM(RI.SalInvAmt) AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		    Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
			AND RI.InvRcpMode IN (3) AND RI.InvInsSta NOT IN(4,@Pi_TypeId)
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				0 AS CrAdjAmount,
				0 AS DbAdjAmount,0 AS CashDiscount,
				SI.Amount,SUM(RI.DebitAmt)AS CollectedAmount,0 AS PayAmount,
				0 AS CollCashAmt,SUM(RI.DebitAmt) AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (3) AND RI.InvInsSta NOT IN(4,@Pi_TypeId)
					AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName AS DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,SUM(RI.SalInvAmt)AS CollectedAmount,0 AS PayAmount,
			0 AS CollCashAmt,0 AS CollChqAmt,
		    SUM(RI.SalInvAmt) AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		    Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
			AND RI.InvRcpMode IN (4)
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				0 AS CrAdjAmount,
				0 AS DbAdjAmount,0 AS CashDiscount,
				SI.Amount,SUM(RI.DebitAmt)AS CollectedAmount,0 AS PayAmount,
				0 AS CollCashAmt,0 AS CollChqAmt,SUM(RI.DebitAmt) AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (4) AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName AS DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,SUM(RI.SalInvAmt)AS CollectedAmount,0 AS PayAmount,
			0 AS CollCashAmt,0 AS CollChqAmt,
		    0 AS CollDDAmt,SUM(RI.SalInvAmt) AS  CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		    Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
			AND RI.InvRcpMode IN (8)
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				0 AS CrAdjAmount,
				0 AS DbAdjAmount,0 AS CashDiscount,
				SI.Amount,SUM(RI.DebitAmt)AS CollectedAmount,0 AS PayAmount,
				0 AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,SUM(RI.DebitAmt) AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (8) AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName as DelRMName,
			SUM(RI.SalInvAmt) AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,0 AS CollectedAmount,0 AS PayAmount,0 AS CollCashAmt,0 AS CollChqAmt,
			0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		        Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.InvRcpMode=5 AND RI.CancelStatus=1
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				SUM(RI.DebitAmt) AS CrAdjAmount,
				0 AS DbAdjAmount,0 AS CashDiscount,
				SI.Amount,0 AS CollectedAmount,0 AS PayAmount,
				0 AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (5) AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName as DelRMName,
			0 AS CrAdjAmount,
			SUM(RI.SalInvAmt) AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,0 AS CollectedAmount,0 AS PayAmount,0 AS CollCashAmt,0 AS CollChqAmt,
			0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		        Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.InvRcpMode=6 AND RI.CancelStatus=1
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,SI.SalPayAmt,RI.InvRcpMode,RI.InvRcpNo
	UNION
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName as DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,SUM(RI.SalInvAmt) AS CashDiscount,
			SI.SalNetAmt,0 AS CollectedAmount,0 AS PayAmount,0 AS CollCashAmt,0 AS CollChqAmt,
			0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		        Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.InvRcpMode=2 AND RI.CancelStatus=1
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,SI.SalPayAmt,RI.InvRcpNo
		UNION
		SELECT 0 AS SalId,SI.DbNoteDate,SI.DbNoteNumber,'' AS SalInvRef,0 AS SMId,'' AS SMName,
				RE.InvRcpDate,SI.RtrId,R.RtrName,0 AS RMId,'' AS RMName,0 AS DlvRMId,''  AS DelRMName,
				0 AS CrAdjAmount,
				0 AS DbAdjAmount,SUM(RI.DebitAmt) AS CashDiscount,
				SI.Amount,0 AS CollectedAmount,0 AS PayAmount,
				0 AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,0 AS CollTdsAmt ---TDS2021
	  		FROM	
					DebitInvoice RI WITH (NOLOCK),
					Receipt RE WITH (NOLOCK),
					Retailer R WITH (NOLOCK),
					DebitNoteRetailer SI WITH (NOLOCK)
	  		WHERE	
					SI.RtrId=R.RtrId AND RI.DbNoteNumber=SI.DbNoteNumber  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
					AND RI.InvRcpMode IN (2) AND RE.RcpType=1
			GROUP BY
				 SI.DbNoteDate,SI.DbNoteNumber,RE.InvRcpDate,SI.RtrId,R.RtrName,SI.AMount,RI.InvRcpNo
		UNION  ---TDS021
		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName AS DelRMName,
			0 AS CrAdjAmount,
			0 AS DbAdjAmount,0 AS CashDiscount,
			SI.SalNetAmt,SUM(RI.SalInvAmt)AS CollectedAmount,0 AS PayAmount,
		0  AS CollCashAmt,0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo,SUM(RI.SalInvAmt) AS CollTdsAmt ---TDS2021
	  	FROM ReceiptInvoice RI WITH (NOLOCK),
			Receipt RE WITH (NOLOCK),
			Retailer R WITH (NOLOCK),
		    Salesman SM WITH (NOLOCK),
			RouteMaster RM WITH (NOLOCK),
			RouteMaster RMD WITH (NOLOCK),
			SalesInvoice SI WITH (NOLOCK)
	  	WHERE SI.RtrId=R.RtrId AND SI.SMId=SM.SMId
		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo AND RI.CancelStatus=1
			AND RI.InvRcpMode IN (10) --AND RI.InvInsSta NOT IN(4,@Pi_TypeId)
		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
			 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
			 SI.SalNetAmt,RI.InvRcpNo
--->Commented By Nanda to Remove On Account(Need to check thoroughly on Exccess Collections)
--	UNION
--		SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
--			RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,
--			RMD.RMName as DelRMName,0 AS CrAdjAmount,0 AS DbAdjAmount,
--			0 AS CashDiscount,0 AS SalNetAmt,
--			ISNULL(ROA.Amount,0) AS CollectedAmount,0 AS PayAmount,0 AS CollCashAmt,
--			0 AS CollChqAmt,0 AS CollDDAmt,0 AS CollRTGSAmt,RI.InvRcpNo
--		FROM ReceiptInvoice RI WITH (NOLOCK),
--			Receipt RE WITH (NOLOCK),
--			Retailer R WITH (NOLOCK),
--		        Salesman SM WITH (NOLOCK),
--			RouteMaster RM WITH (NOLOCK),
--			RouteMaster RMD WITH (NOLOCK),
--			RetailerOnAccount ROA WITH (NOLOCK),
--			SalesInvoice SI WITH (NOLOCK)
--		WHERE ROA.RtrId=R.RtrId AND SI.SMId=SM.SMId
--		        AND RM.RMId=SI.RMId AND RMD.RMId=SI.DlvRMId
--			AND RI.SalId=SI.SalId  AND RE.InvRcpNo=RI.InvRcpNo
--			AND ROA.LastModDate=RE.InvRcpDate
--			AND ROA.TransactionType=0 AND ROA.OnAccType=0 AND ROA.RtrId=SI.RtrId
--		GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.SalInvRef,SI.SMId,SM.SMName,
--		 RE.InvRcpDate,SI.RtrId,R.RtrName,SI.RMId,RM.RMName,SI.DlvRMId,RMD.RMName,
--		 ROA.Amount,RI.InvRcpNo
--->Till Here
			) A
	GROUP BY SalId,SalInvDate,SalInvNo,SalInvRef,SMId,SMName,
	 	InvRcpDate,RtrId,RtrName,RMId,RMName,DlvRMId,DelRMName,SalNetAmt,InvRcpNo
	IF NOT EXISTS (SELECT SalId FROM RptCollectionValue WHERE SalId<>0)
	BEGIN
		UPDATE RptCollectionValue SET PayAmount=A.PayAmount
			FROM (
			SELECT A.SalId,A.InvRcpDate,ISNULL(SUM(B.CollectedAmount+B.CashDiscount+B.CrAdjAmount-B.DbAdjAmount),0) AS PayAmount
			FROM RptCollectionValue A
			LEFT OUTER JOIN RptCollectionValue B ON A.SalId=B.SalId AND B.InvRcpDate<=A.InvRcpDate
			AND  ISNULL(A.BillAmount,0)>0 AND ISNULL(B.BillAmount,0)>0
			GROUP BY A.SalId,A.InvRcpDate) A WHERE A.SalId=RptCollectionValue.SalId
			AND A.InvRcpDate=RptCollectionValue.InvRcpDate AND BillAmount>0
	END
	ELSE
	BEGIN
		UPDATE RptCollectionValue SET PayAmount=A.PayAmount
			FROM (
			SELECT A.SalInvNo,A.InvRcpDate,ISNULL(SUM(B.CollectedAmount+B.CashDiscount+B.CrAdjAmount-B.DbAdjAmount),0) AS PayAmount
			FROM RptCollectionValue A
			LEFT OUTER JOIN RptCollectionValue B ON A.SalInvNo=B.SalInvNo AND B.InvRcpDate<=A.InvRcpDate
			AND  ISNULL(A.BillAmount,0)>0 AND ISNULL(B.BillAmount,0)>0
			GROUP BY A.SalInvNo,A.InvRcpDate) A WHERE A.SalInvNo=RptCollectionValue.SalInvNo
			AND A.InvRcpDate=RptCollectionValue.InvRcpDate AND BillAmount>0
	END
	
--	UPDATE RptCollectionValue SET CurPayAmount=ABS(CollectedAmount+CashDiscount+CrAdjAmount-DbAdjAmount-PayAmount) WHERE BillAmount>0
	UPDATE RptCollectionValue SET CurPayAmount=ABS(CollCashAmt+CollChqAmt+CollDDAmt+CollRTGSAmt+CashDiscount+CrAdjAmount+CollTdsAmt-DbAdjAmount) WHERE BillAmount>0 --TDS2021
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_RptCollectionReport')
DROP PROCEDURE Proc_RptCollectionReport
GO
--EXEC Proc_RptCollectionReport 4,1,0,'ParleGSTBillEdit',0,0,1    
 CREATE PROCEDURE Proc_RptCollectionReport
(    
 @Pi_RptId  INT,    
 @Pi_UsrId  INT,    
 @Pi_SnapId  INT,    
 @Pi_DbName  nvarchar(50),    
 @Pi_SnapRequired INT,    
 @Pi_GetFromSnap  INT,    
 @Pi_CurrencyId  INT    
)    
AS    
BEGIN    
 SET NOCOUNT ON     
 DECLARE @NewSnapId  AS INT    
 DECLARE @DBNAME  AS  nvarchar(50)    
 DECLARE @TblName  AS nvarchar(500)    
 DECLARE @TblStruct  AS nVarchar(4000)    
 DECLARE @TblFields  AS nVarchar(4000)    
 DECLARE @sSql  AS  nVarChar(4000)    
 DECLARE @ErrNo   AS INT    
 DECLARE @PurDBName AS nVarChar(50)    
 DECLARE @FromDate AS DATETIME    
 DECLARE @ToDate   AS DATETIME    
 DECLARE @SMId   AS INT    
 DECLARE @RMId   AS INT    
 DECLARE @DlvRId  AS  INT    
 DECLARE @SColId  AS  INT    
 DECLARE @RtrId   AS INT    
 DECLARE @SalId   AS BIGINT    
 DECLARE @TypeId  AS INT    
 DECLARE @TotBillAmount AS NUMERIC(38,6)    
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)    
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)    
 SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))    
 SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))    
 SET @DlvRId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))    
 SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))    
 SET @SalId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))    
 SET @TypeId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,77,@Pi_UsrId))    
 SET @SColId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))     
 IF @SColId=1    
 BEGIN    
  UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE SlNo IN (2,3) AND RptId = @Pi_RptId   --- RptId = @Pi_UsrId  --MOORTHI    
  UPDATE RptExcelHeaders SET DisplayFlag=1 WHERE SlNo IN (5,6) AND RptId = @Pi_RptId    ---RptId = @Pi_UsrId  --MOORTHI    
 END    
 ELSE    
 BEGIN    
  UPDATE RptExcelHeaders SET DisplayFlag=1 WHERE SlNo IN (2,3) AND RptId = @Pi_RptId    --RptId = @Pi_UsrId --MOORTHI    
  UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE SlNo IN (5,6) AND RptId = @Pi_RptId     --RptId = @Pi_UsrId --MOORTHI    
 END    
 CREATE TABLE #RptCollectionDetail    
 (    
  SalId    BIGINT,    
  SalInvNo  NVARCHAR(50) collate database_default,    
  SalInvDate              DATETIME,    
  SalInvRef   NVARCHAR(50),    
  RtrId    INT,    
  RtrName                 NVARCHAR(50) collate database_default,    
  BillAmount              NUMERIC (38,6),    
  CrAdjAmount             NUMERIC (38,6),    
  DbAdjAmount             NUMERIC (38,6),    
  CashDiscount  NUMERIC (38,6),    
  CollectedAmount         NUMERIC (38,6),    
  BalanceAmount           NUMERIC (38,6),    
  PayAmount            NUMERIC (38,6),    
  TotalBillAmount  NUMERIC (38,6),    
  AmtStatus    NVARCHAR(10) collate database_default,    
  InvRcpDate   DATETIME,    
  CurPayAmount        NUMERIC (38,6),    
  CollCashAmt   NUMERIC (38,6),    
  CollChqAmt   NUMERIC (38,6),    
  CollDDAmt   NUMERIC (38,6),    
  CollRTGSAmt   NUMERIC (38,6),    
  [CashBill]   [numeric](38, 0) NULL,    
  [ChequeBill]  [numeric](38, 0) NULL,    
  [DDbill]   [numeric](38, 0) NULL,    
  [RTGSBill]   [numeric](38, 0) NULL,    
  [TotalBills]  [numeric](38, 0) NULL,      
  InvRcpNo   nvarchar(50),
  CollTDSAmt   NUMERIC (38,6)---TDS2021  
       
 )    
 SET @TblName = 'RptCollectionDetail'    
 SET @TblStruct = ' SalId    BIGINT,    
    SalInvNo  NVARCHAR(50),    
    SalInvDate              DATETIME,    
    SalInvRef   NVARCHAR(50),    
    RtrId    INT,    
    RtrName                 NVARCHAR(50),    
    BillAmount              NUMERIC (38,6),    
    CrAdjAmount             NUMERIC (38,6),    
    DbAdjAmount             NUMERIC (38,6),    
    CashDiscount  NUMERIC (38,6),    
    CollectedAmount         NUMERIC (38,6),    
    BalanceAmount           NUMERIC (38,6),    
    PayAmount            NUMERIC (38,6),    
TotalBillAmount  NUMERIC (38,6),    
    AmtStatus   NVARCHAR(10),    
    InvRcpDate  DATETIME,    
    CurPayAmount            NUMERIC (38,6),    
    CollCashAmt NUMERIC (38,6),    
    CollChqAmt NUMERIC (38,6),    
    CollDDAmt  NUMERIC (38,6),    
    CollRTGSAmt NUMERIC (38,6),    
    [CashBill] [numeric](38, 0) NULL,    
    [ChequeBill] [numeric](38, 0) NULL,    
    [DDbill] [numeric](38, 0) NULL,    
    [RTGSBill] [numeric](38, 0) NULL,    
    [TotalBills]  [numeric](38, 0) NULL,    
    InvRcpNo nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
	CollTDSAmt   NUMERIC (38,6)    
    '    
 SET @TblFields = 'SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
     BillAmount,CrAdjAmount,DbAdjAmount,CashDiscount,CollectedAmount,    
     BalanceAmount,PayAmount,TotalBillAmount,AmtStatus,InvRcpDate,CurPayAmount,CollCashAmt,    
    CollChqAmt,CollDDAmt,CollRTGSAmt,[CashBill],[ChequeBill],[DDbill],[RTGSBill],[TotalBills],InvRcpNo,CollTDSAmt'    
 IF @Pi_GetFromSnap = 1     
 BEGIN    
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId    
  SET @DBNAME =  @DBNAME    
 END    
 ELSE    
 BEGIN    
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3    
  SET @DBNAME = @PI_DBNAME + @DBNAME    
 END    
 IF @TypeId=1     
 BEGIN    
  EXEC Proc_CollectionValues 4    
 END    
 ELSE    
 BEGIN     
  EXEC Proc_CollectionValues 1    
 END    
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data    
 BEGIN     
  INSERT INTO #RptCollectionDetail (SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
  BillAmount,CrAdjAmount,DbAdjAmount,CashDiscount,CollectedAmount,    
  BalanceAmount,PayAmount,TotalBillAmount,AmtStatus,InvRcpDate,CurPayAmount,CollCashAmt,CollChqAmt,CollDDAmt,CollRTGSAmt    
  ,InvRcpNo,CollTDSAmt)    
  SELECT SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
  dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CashDiscount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId),    
  ABS(dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId))    
  --dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)    
  AS BalanceAmount,dbo.Fn_ConvertCurrency(PayAmount,@Pi_CurrencyId),0 AS TotalBillAmount,    
  ( --Commented and Added by Thiru on 20/11/2009    
--   CASE WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
--   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))>0     
--   THEN 'Db'     
--   WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
--   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))< 0     
--   THEN 'Cr'     
--   ELSE '' END    
   CASE WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))>0     
   THEN 'Db'     
   WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))< 0     
   THEN 'Cr'     
   ELSE '' END    
--Till Here    
  ) AS AmtStatus,    
  R.InvRcpDate,dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CollCashAmt,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CollChqAmt,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CollDDAmt,@Pi_CurrencyId)    
  ,dbo.Fn_ConvertCurrency(CollRTGSAmt,@Pi_CurrencyId),R.InvRcpNo
  ,dbo.Fn_ConvertCurrency(CollTdsAmt,@Pi_CurrencyId)    
  FROM RptCollectionValue R    
  WHERE (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR    
  SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))     
  AND     
  (RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR    
  RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))     
  AND    
  (DlvRMId=(CASE @DlvRId WHEN 0 THEN DlvRMId ELSE 0 END) OR    
  DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )    
  AND     
  (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR    
  RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))    
  AND    
  (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR    
  SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))     
  AND InvRcpDate BETWEEN @FromDate AND @ToDate     
  IF LEN(@PurDBName) > 0    
  BEGIN    
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT    
   SET @SSQL = 'INSERT INTO #RptCollectionDetail ' +     
    '(' + @TblFields + ')' +     
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName     
    +  ' WHERE (SMId = (CASE ' + CAST(@SMId AS nVarchar(10)) + ' WHEN 0 THEN SMId ELSE 0 END) OR '+    
    'SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RMId = (CASE ' + CAST(@RMId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR ' +    
    'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RMId = (CASE ' + CAST(@DlvRId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR ' +    
    'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',35,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RtrId = (CASE ' + CAST(@RtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrId ELSE 0 END) OR '+    
    'RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))    
    AND (SalId = (CASE ' + CAST(@SalId AS nVarchar(10)) + ' WHEN 0 THEN SalId ELSE 0 END) OR ' +    
    'SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',14,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND INvRcpDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''    
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Purged Table'    
  END    
  IF @Pi_SnapRequired = 1    
  BEGIN    
   SELECT @NewSnapId = @Pi_SnapId    
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
   IF @ErrNo = 0    
   BEGIN    
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +     
     '(SnapId,UserId,RptId,' + @TblFields + ')' +     
     ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +    
     ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
     ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptCollectionDetail'    
    EXEC (@SSQL)    
    PRINT 'Saved Data Into SnapShot Table'    
   END    
  END    
 END    
 ELSE    --To Retrieve Data From Snap Data    
 BEGIN    
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
  PRINT @ErrNo    
  IF @ErrNo = 0     
  BEGIN    
   SET @SSQL = 'INSERT INTO #RptCollectionDetail ' +     
    '(' + @TblFields + ')' +     
    ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +    
    ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +    
    ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
    ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))    
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Snap Shot Table'    
  END    
  ELSE    
  BEGIN    
   PRINT 'DataBase or Table not Found'    
  END    
 END    
 --Check for Report Data    
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId    
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)    
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptCollectionDetail    
 -- Till Here    
 CREATE TABLE #Tempbalance    
 (    
  Billamt numeric(18,4),    
  CurPayAmt numeric(18,4),    
  Balance numeric(18,4),    
  RtrId int,    
  Salesinvoice nvarchar(50),    
  Receiptinvoice nvarchar(50)    
 )    
 DECLARE @BillAmount NUMERIC (38,6)    
 DECLARE @CurPayAmount NUMERIC (38,6)    
 DECLARE @BalanceAmount NUMERIC (38,6)    
 DECLARE @InvRcpNo nvarchar(50)    
 DECLARE @SalinvNo nvarchar(50)    
 DECLARE @TempInvoiceRcpNo nvarchar(50)    
 DECLARE @CurPayAmountbal NUMERIC (38,6)    
 DECLARE @BalRtrId int    
 DECLARE Cur_BalanceAmt CURSOR FOR    
 SELECT BillAmount,CurPayAmount,BalanceAmount,InvRcpNo,SalInvNo,RtrId FROM #RptCollectionDetail ORDER BY SalInvNo,InvRcpNo    
 OPEN Cur_BalanceAmt    
 FETCH NEXT FROM Cur_BalanceAmt INTO @BillAmount,@CurPayAmount,@BalanceAmount,@InvRcpNo,@SalinvNo,@BalRtrId    
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT into #Tempbalance(BillAmt,CurPayAmt,RtrId,Salesinvoice,Receiptinvoice) VALUES (@BillAmount,@CurPayAmount,@BalRtrId,@SalinvNo,@InvRcpNo)    
        SELECT @CurPayAmountbal=sum(CurPayAmt) FROM #Tempbalance WHERE RtrId=@BalRtrId AND Salesinvoice=@SalinvNo --AND Receiptinvoice=@InvRcpNo    
        UPDATE #RptCollectionDetail SET BalanceAmount=BillAmount-@CurPayAmountbal WHERE CurPayAmount=@CurPayAmount    
  AND SalInvNo=@SalinvNo AND InvRcpNo=@InvRcpNo AND RtrId=@BalRtrId    
  FETCH NEXT FROM Cur_BalanceAmt INTO @BillAmount,@CurPayAmount,@BalanceAmount,@InvRcpNo,@SalinvNo,@BalRtrId    
 END    
 CLOSE Cur_BalanceAmt    
 DEALLOCATE Cur_BalanceAmt    
 UPDATE #RptCollectionDetail SET  [CashBill]=(CASE WHEN CollCashAmt<>0 THEN 1 ELSE 0 END)     
 UPDATE #RptCollectionDetail SET  [ChequeBill]=(CASE WHEN CollChqAmt<>0 THEN 1 ELSE 0 END)    
 UPDATE #RptCollectionDetail SET  [DDbill]=(CASE WHEN BalanceAmount<>0 THEN 1 ELSE 0 END) WHERE  AmtStatus='DB'    
 UPDATE #RptCollectionDetail SET  [RTGSBill]=(CASE WHEN  CollRTGSAmt<>0 THEN 1 ELSE 0 END)    
 UPDATE #RptCollectionDetail SET  [TotalBills]=(SELECT Count(Salid) FROM #RptCollectionDetail)    
 SELECT SalId,SalInvNo,SalInvDate,SalInvRef,A.InvRcpNo,InvRcpDate,RtrId,RtrName, ----------- Added by Lakshman M (A.InvRcpNo two column name same aliasname modified)   
 BillAmount,CurPayAmount,CrAdjAmount,DbAdjAmount,CashDiscount,    
 ISNULL(CollCashAmt,0) AS CollCashAmt,ISNULL(CollChqAmt,0) AS CollChqAmt,ISNULL(CollDDAmt,0) AS CollDDAmt,ISNULL(CollRTGSAmt,0) AS CollRTGSAmt,BalanceAmount,CollectedAmount,PayAmount,TotalBillAmount,AmtStatus,    
 CashBill,Chequebill,DDBill,RTGSBill,InvRcpNo,[TotalBills],ISNULL(CollTDSAmt,0) AS CollTDSAmt FROM #RptCollectionDetail A ORDER BY SalId,InvRcpDate,A.InvRcpNo   

 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptId=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)    
 BEGIN    
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptCollectionDetail_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)    
  DROP TABLE RptCollectionDetail_Excel    
  SELECT  SalId,SalInvNo,SalInvDate,SalInvRef,InvRcpNo,InvRcpDate,RtrId,RtrName,    
   BillAmount,CurPayAmount,CrAdjAmount,DbAdjAmount,CashDiscount,    
   ISNULL(CollCashAmt,0) AS CollCashAmt,ISNULL(CollChqAmt,0) AS CollChqAmt,ISNULL(CollDDAmt,0) AS CollDDAmt,    
   ISNULL(CollRTGSAmt,0) AS CollRTGSAmt,ISNULL(CollTDSAmt,0) AS CollTDSAmt,BalanceAmount,CollectedAmount,PayAmount,TotalBillAmount,AmtStatus INTO RptCollectionDetail_Excel FROM #RptCollectionDetail    
 END    
RETURN    
END
GO
--TILL COLLECTION REPORT
--TDS Changes Till Here
--Added by Mohana.S
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SchemeCategoryDetails' AND name='SAPSchType')
BEGIN
	ALTER TABLE SchemeCategoryDetails ADD SAPSchType NVARCHAR(100)  DEFAULT '' WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2Cs_Prk_SchemeCategorydetails' AND name='SAPSchType')
BEGIN
	ALTER TABLE Cn2Cs_Prk_SchemeCategorydetails ADD SAPSchType NVARCHAR(100)  DEFAULT '' WITH VALUES
END
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='SchemeForSFAOrder'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','SchemeForSFAOrder','SchemeForSFAOrder','Apply Scheme for SFA orders',1,0,0,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_SFASchemeApply' AND TYPE='FN')
DROP FUNCTION Fn_SFASchemeApply
GO
CREATE FUNCTION [dbo].[Fn_SFASchemeApply](@Type INT,@SchId INT,@OrderNO NVARCHAR(100))  
RETURNS INTEGER 
As  
/********************************************************************************************************
* PROCEDURE    : Fn_SFASchemeApply  
* Function     : To Get the Scheme Details
* CREATED      : Mohana S
* CREATED DATE : 08-07-2021 
* PMS NO		:	CRCRSTPAR0116  
***************************************************************************************************/
BEGIN  
DECLARE @Apply AS INTEGER
SET @Apply = 0
	
	IF EXISTS (SELECT * FROM OrderBooking WHERE OrderNo = RTRIM(LTRIM(@Orderno)) AND PDADownLoadFlag = 1)
	BEGIN
		RETURN @APPLY
	END

	IF EXISTS (SELECT * FROM  ManualConfiguration WHERE ModuleId ='SchemeForSFAOrder' AND Status=1)
	BEGIN 
			IF @Type = 1 
			BEGIN
				IF EXISTS (SELECT B.ColumnValue FROM Distributor A(NOLOCK) INNER JOIN UDCDetails B(NOLOCK) ON A.DistributorId =B.MasterRecordId 
				INNER JOIN UdcMaster C(NOLOCK) ON B.Masterid =C.Masterid AND B.UdcMasterid =C.UdcMasterid AND ColumnName ='State Name'
				INNER JOIN StateMaster S(NOLOCK) ON B.ColumnValue =S.StateName  WHERE C.Masterid =16 AND StateCode IN('24','25','26','22','23','27','29','30','31','32','33','34','35','36','37') )
				BEGIN
					SET @Apply = 1
				END
			END
			IF @Type = 2 
			BEGIN
				IF EXISTS(SELECT * FROM SchemeMaster A INNER JOIN SchemeCategoryDetails B ON A.CmpSchCode=B.CmpSchcode AND SAPSchType = 'SCH0100' AND A.Schid=@SchiD)
				BEGIN
					SET @Apply = 1
				END
			END
		
	END
RETURN @Apply
END
GO
 IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_SchemeCategoryDetails' AND TYPE='P')
 DROP PROCEDURE Proc_Cn2Cs_SchemeCategoryDetails
 GO
/*  
BEGIN TRAN  
delete from errorlog   
EXEC Proc_Cn2Cs_SchemeCategoryDetails 0  
SELECT * FROM SCHEMECATEGORYDETAILS WHERE CMPSCHCODE IN (  'SCH35148','SCH35204','SCH35207','SCH35214','SCH35214','SCH31459','SCH32424','SCH33883','SCH34827','SCH35095','SCH35099' )
ROLLBACK TRAN  
*/  
CREATE PROCEDURE Proc_Cn2Cs_SchemeCategoryDetails
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/************************************************************************************************  
* PROCEDURE  : Proc_Cn2Cs_SchemeCategoryDetails  
* PURPOSE  : To validate the downloaded Scheme Category details from Console  
* CREATED  : Lakshman M  
* CREATED DATE : 11-03-2019  
* MODIFIED  
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
 11-03-2019  Lakshman M  CR   CRCRSTPAR0037    scheme category type validation included from CS.  
 24-04-2015  lakshman M  BZ   ILCRSTPAR4149    Duplicate records validation missing for scheme category process in core stocky.   
 13-06-2019  Lakshman M  BZ   ILCRSTPAR4802    scheme category details duplicate data validaion included.		
 09-07-2021	  Mohana S	 CR	  CRCRSTPAR0116		SCHEME SHOULD APPLY FOR SFA ORDER(SCH0100)
***************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
 SET @Po_ErrNo=0  
 CREATE TABLE #AvoidScheme  
 (  
  CMpSchcode NVARCHAR(50)  
 )  
 SELECT distinct CmpSchcode,MAX(Createddate)  Mxdate into  #Duplicate  
 from Cn2Cs_Prk_SchemeCategorydetails  
 GROUP BY  CmpSchcode 
 ----------------------- added by lakshman M Dated ON 13-06-2019 PMS iD: ILCRSTPAR4802  ----------------
 SELECT distinct C.* into #Cn2Cs_Prk_SchemeCategorydetails  from Cn2Cs_Prk_SchemeCategorydetails  C 
 inner join #Duplicate D on C.CmpSchcode=D.CmpSchcode and D.Mxdate=C.CreatedDate  
 DELETE FROM  Cn2Cs_Prk_SchemeCategorydetails  
 INSERT INTO Cn2Cs_Prk_SchemeCategorydetails  
 SELECT distinct * FROM #Cn2Cs_Prk_SchemeCategorydetails  
 ---------------------------Till Here --------------------
 DELETE FROM Cn2Cs_Prk_SchemeCategorydetails WHERE DownLoadFlag='Y'  
 IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_SchemeCategorydetails (NOLOCK) WHERE DownLoadFlag='D')  
 BEGIN  
  RETURN  
 END  
 INSERT INTO #AvoidScheme  
 SELECT DISTINCT CMpSchcode FROM Cn2Cs_Prk_SchemeCategorydetails WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)
   
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT 1,'Cn2Cs_Prk_SchemeCategorydetails',CmpSchcode,'Scheme Not Available in SchemeMaster' FROM Cn2Cs_Prk_SchemeCircularDetails 
 WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)  

 INSERT INTO #AvoidScheme  
 SELECT DISTINCT CmpSchCode as CmpSchcode FROM Cn2Cs_Prk_SchemeCategorydetails  
 GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1  

 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT 1,'Cn2Cs_Prk_SchemeCategorydetails',CmpSchCode,'Duplicate Cmpschcode Available -'+CmpSchCode  FROM Cn2Cs_Prk_SchemeCategorydetails  
 GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1  

 DELETE A FROM SchemeCategorydetails A INNER join Cn2Cs_Prk_SchemeCategorydetails B ON A.cmpschcode =B.cmpschcode  

 INSERT INTO SchemeCategorydetails  
 SELECT DISTINCT CmpSchCode,Schcategory_type,GETDATE(),SAPSchType  FROM Cn2Cs_Prk_SchemeCategorydetails WHERE CMpSchcode NOT IN (SELECT CmpSchcode FROM #AvoidScheme)  
 UPDATE Cn2Cs_Prk_SchemeCategorydetails SET DownloadFlag ='Y' WHERE CmpSchcode IN (SELECT CmpSchCode FROM SchemeCategorydetails) 
   
 RETURN  
END
GO
DELETE FROM ScreenDefaultValues WHERE TransId = 45 AND CtrlId = 32 AND CtrlDesc = 'Line Level'
INSERT INTO ScreenDefaultValues 
SELECT 45,32,6,'Line Level',6,1,1,1,GETDATE(),1,GETDATE(),'Line Level'
GO
DELETE FROM CustomCaptions WHERE TransId = 45 AND CtrlId = 98 AND SubCtrlId IN (23)
INSERT INTO CustomCaptions
SELECT 45,98,23,'sprSlabDetails-45-98-23','No.Of Lines','','',1,1,1,GETDATE(),1,GETDATE(),'No.Of Lines','','',1,1  
GO
IF NOT EXISTS (SELECT A.Name FROM SysColumns A WITH(NOLOCK) INNER JOIN Sysobjects B WITH(NOLOCK) ON A.Id = B.Id 
AND B.Xtype = 'U' AND B.Name = 'SchemeSlabs' AND A.name = 'NoofLines')
BEGIN
    ALTER TABLE SchemeSlabs ADD NoofLines NUMERIC(18,0) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS (SELECT A.Name FROM SysColumns A WITH(NOLOCK) INNER JOIN Sysobjects B WITH(NOLOCK) ON A.Id = B.Id 
AND B.Xtype = 'U' AND B.Name = 'Etl_Prk_SchemeProducts_Combi' AND A.name = 'PurchaseValue')
BEGIN
    ALTER TABLE Etl_Prk_SchemeProducts_Combi ADD PurchaseValue NUMERIC(38,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS (SELECT A.Name FROM SysColumns A WITH(NOLOCK) INNER JOIN Sysobjects B WITH(NOLOCK) ON A.Id = B.Id 
AND B.Xtype = 'U' AND B.Name = 'SchemeProducts' AND A.name = 'PurchaseValue')
BEGIN
    ALTER TABLE SchemeProducts ADD PurchaseValue NUMERIC(38,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS (SELECT A.Name FROM SysColumns A WITH(NOLOCK) INNER JOIN Sysobjects B WITH(NOLOCK) ON A.Id = B.Id 
AND B.Xtype = 'U' AND B.Name = 'Etl_Prk_SchemeHD_Slabs_Rules' AND A.name = 'NoofLines')
BEGIN
    ALTER TABLE Etl_Prk_SchemeHD_Slabs_Rules ADD NoofLines NUMERIC(18,0) DEFAULT 0 WITH VALUES
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Xtype = 'P' AND name = 'Proc_Cn2Cs_BLSchemeMaster')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeMaster
GO
/*
BEGIN TRANSACTION
update schememaster set schstatus = 0 where cmpschcode = 'SCH00007'
EXEC Proc_Cn2Cs_BLSchemeMaster 0
select *from schememaster where cmpschcode = 'SCH00007'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************
* PROCEDURE	: Proc_Cn2Cs_BLSchemeMaster
* PURPOSE	: To Insert and Update records Of Scheme Master
* CREATED	: Boopathy.P on 31/12/2008
* DATE         AUTHOR       DESCRIPTION
***************************************************************************************************************************
* 25.08.2009   Panneer		Added BudgetAllocationNo in SchemeMaster Table
* 20.10.2009   Thiru		Added SchBasedOn in SchemeMaster Table		
* 22/04/2010   Nanda 		Added FBM
* 28/12/2010   Nanda 		Added Settlement Type
****************************************************************************************************************************   
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]  
* 03
03-01-2018  Lakshman. M      ICRSTPAR7277        BUG      Scheme description amp;  (special character)Script validation added from CS.  
18-06-2018	Karthick.KJ		 CRCRSTPAR0007		 CR		  Claim Apply with/Without Tax
11-04-2019	MARY			 CRCRSTPAR0039		 CR		  new Columns added  NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount		
26-11-2020	MarySubashini.S	 CRCRSTPAR0105		 CR		  Scheme based on product category contribution percentage 
17-11-2020	MOHANA S		 PARCS202100059      CR		  Fromdate included based on Serverdate	
20-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme	
********************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 		AS NVARCHAR(100)
	DECLARE @SchDesc 		AS NVARCHAR(200)
	DECLARE @CmpCode 		AS NVARCHAR(50)
	DECLARE @ClmAble 		AS NVARCHAR(50)
	DECLARE @ClmAmtOn 		AS NVARCHAR(50)
	DECLARE @ClmGrpCode		AS NVARCHAR(50)
	DECLARE @SelnOn			AS NVARCHAR(50)
	DECLARE @SelLvl			AS NVARCHAR(50)
	DECLARE @SchType		AS NVARCHAR(50)
	DECLARE @BatLvl			AS NVARCHAR(50)
	DECLARE @FlxSch			AS NVARCHAR(50)
	DECLARE @FlxCond		AS NVARCHAR(50)
	DECLARE @CombiSch		AS NVARCHAR(50)
	DECLARE @Range			AS NVARCHAR(50)
	DECLARE @ProRata		AS NVARCHAR(50)
	DECLARE @Qps			AS NVARCHAR(50)
	DECLARE @QpsReset		AS NVARCHAR(50)
	DECLARE @ApyQpsOn		AS NVARCHAR(50)
	DECLARE @ForEvery		AS NVARCHAR(50)
	DECLARE @SchStartDate	AS NVARCHAR(50)
	DECLARE @SchEndDate		AS NVARCHAR(50)
	DECLARE @SchBudget		AS NVARCHAR(50)
	DECLARE @EditSch		AS NVARCHAR(50)
	DECLARE @AdjDisSch		AS NVARCHAR(50)
	DECLARE @SetDisMode		AS NVARCHAR(50)
	DECLARE @SchStatus		AS NVARCHAR(50)
	DECLARE @SchBasedOn		AS NVARCHAR(50)
	DECLARE @StatusId		AS INT
	DECLARE @CmpId			AS INT
	DECLARE @ClmGrpId		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @ClmableId		AS INT
	DECLARE @ClmAmtOnId		AS INT
	DECLARE @SelMode		AS INT
	DECLARE @SchTypeId		AS INT
	DECLARE @BatId			AS INT
	DECLARE @FlexiId		AS INT
	DECLARE @FlexiConId		AS INT
	DECLARE @CombiId		AS INT
	DECLARE @RangeId		AS INT
	DECLARE @ProRateId		AS INT
	DECLARE @QPSId			AS INT
	DECLARE @QPSResetId		AS INT
	DECLARE @AdjustSchId	AS INT
	DECLARE @ApplySchId		AS INT
	DECLARE @ForEveryId		AS INT
	DECLARE @SettleSchId	AS INT
	DECLARE @EditSchId		AS INT
	DECLARE @ChkCount		AS INT		
	DECLARE @ConFig			AS INT
	DECLARE @CmpCnt			AS INT
	DECLARE @EtlCnt			AS INT
	DECLARE @SLevel			AS INT
	DECLARE @SchBasedOnId	AS INT
	DECLARE @ErrDesc		AS NVARCHAR(1000)
	DECLARE @TabName		AS NVARCHAR(50)
	DECLARE @GetKey			AS INT
	DECLARE @GetKeyStr		AS NVARCHAR(200)
	DECLARE @Taction		AS INT
	DECLARE @sSQL			AS VARCHAR(4000)
	DECLARE @iCnt			AS INT
	DECLARE @BudgetAllocationNo	AS NVARCHAR(100)
	DECLARE @FBM				AS NVARCHAR(10)
	DECLARE @FBMId				AS INT
	DECLARE @SettlementType		AS NVARCHAR(10)
	DECLARE @SettlementTypeId	AS INT
	DECLARE @FBMDate			AS DATETIME
	DECLARE @AllowUnCheck		AS NVARCHAR(10)
	DECLARE @AllowUnCheckId		AS INT
	DECLARE @CombiType			AS NVARCHAR(50)
	DECLARE @CombiTypeId		AS INT
	DECLARE @SchApplyOn			AS VARCHAR(100)
	DECLARE @SchApplyOnId		AS INT
	DECLARE @ApplyTaxForClaim   AS VARCHAR(50)
	DECLARE @ApplyTax			AS INT
	DECLARE @NoOfMonth AS TINYINT --CRCRSTPAR0039
	DECLARE @Growth_Factor AS NUMERIC(18,2)
	DECLARE @Add_Growth_Factor AS NUMERIC(18,2)
	DECLARE @Cap_Amount AS NUMERIC(18,2)
	DECLARE @Validate_Cap AS VARCHAR(10)
	DECLARE @Validate_Cap_Id AS TINYINT
	DECLARE @ContriPercentageScheme	AS NVARCHAR(50) --CRCRSTPAR0105
	DECLARE @ContriPercentageSchemeId	AS INT --CRCRSTPAR0105
	DECLARE @FromDate DATETIME 
	
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	SET @AdjustSchId=0
	SET @iCnt=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE @DistCode AS  NVARCHAR(50)
	SELECT @DistCode=ISNULL(DistributorCode,'') FROM Distributor
	---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
	Declare @Lvar Int  
	Declare @MaxId Int
	Declare @SqlStr Varchar(8000)  
	Declare @Process Varchar(100)  
	Declare @colcount Int  
	Declare @Col Varchar(5000)
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Etl_Prk_SchemeHD_Slabs_Rules'
	And A.system_type_id = C.system_type_id And C.name='nvarchar' and A.column_id= 3
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ---------------------------------- Till here -------------------
	
	--->Added By Nanda on 17/09/2009
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SchToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SchToAvoid	
	END
	
	CREATE TABLE SchToAvoid
	(
		CmpSchCode NVARCHAR(50)
	)
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
	WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product'))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','CmpSchCode','Product :'+PrdCode+' not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)		
		SELECT @DistCode,'Scheme',CmpSchCode,'Product',PrdCode,'','N'
		FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND 
		CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Attributes','Attributes not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Products','Scheme Products not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Header','Header not Available for Scheme:'+CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
	END
	
	--->Till Here
	DECLARE Cur_SchMaster CURSOR
	FOR SELECT DISTINCT
	ISNULL([CmpSchCode],'') AS [Company Scheme Code],
	ISNULL([SchDsc],'') AS [Scheme Description],
	ISNULL([CmpCode],'') AS [Company Code],
	ISNULL([Claimable],'') AS [Claimable],
	ISNULL([ClmAmton],'') AS [Claim Amount On],
	ISNULL([ClmGroupCode],'') AS [Claim Group Code],
	ISNULL([SchemeLevelMode],'') AS [Selection On],
	ISNULL([SchLevel],'') AS [Selection Level Value],
	ISNULL([SchType],'') AS [Scheme Type],
	ISNULL([BatchLevel],'') AS [Batch Level],
	ISNULL([FlexiSch],'') AS [Flexi Scheme],
	ISNULL([FlexiSchType],'') AS [Flexi Conditional],
	ISNULL([CombiSch],'') AS [Combi Scheme],
	ISNULL([Range],'') AS [Range],
	ISNULL([ProRata],'') AS [Pro - Rata],
	ISNULL([Qps],'NO') AS [Qps],
	ISNULL([QPSReset],'') AS [Qps Reset],
	ISNULL([ApyQPSSch],'') AS [Qps Based On],
	ISNULL([PurofEvery],'') AS [Allow For Every],
	ISNULL([SchValidFrom],'') AS [Scheme Start Date],
	ISNULL([SchValidTill],'') AS [Scheme End Date],
	ISNULL([Budget],'') AS [Scheme Budget],
	ISNULL([EditScheme],'') AS [Allow Editing Scheme],
	ISNULL([AdjWinDispOnlyOnce],'0') AS [Adjust Display Once],
	ISNULL([SetWindowDisp],'') AS [Settle Display Through],
	ISNULL(SchStatus,'') AS SchStatus,
	--ISNULL(BudgetAllocationNo,'') AS BudgetAllocationNo,
	ISNULL(CircularNo,'') AS BudgetAllocationNo,
	ISNULL(SchBasedOn,'') AS SchemeBasedOn,
	ISNULL(FBM,'No') AS FBM,
	ISNULL(SettlementType,'ALL') AS SettlementType,
	ISNULL([AllowUncheck],'NO') AS AllowUncheck,
	ISNULL([CombiType],'NORMAL') AS [CombiType],
	ISNULL(SchApplyOn,'SELLINGRATE') AS SchApplyOn,
	ISNULL(ApplyTaxForClaim,'YES') AS ApplyTaxForClaim,
	ISNULL(NoOfMonth,0) AS NoOfMonth, --CRCRSTPAR0039
	ISNULL(Growth_Factor,0) AS Growth_Factor,
	ISNULL(Add_Growth_Factor,0) AS Add_Growth_Factor,
	ISNULL(Validate_Cap,'NO') AS 	Validate_Cap,
	ISNULL(Cap_Amount,0) AS 	Cap_Amount,
	ISNULL(ContriPercentageScheme,'NO') ContriPercentageScheme --CRCRSTPAR0105
	FROM Etl_Prk_SchemeHD_Slabs_Rules (NOLOCK)
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'			 
	ORDER BY [Company Scheme Code]
	OPEN Cur_SchMaster
	FETCH NEXT FROM Cur_SchMaster INTO @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
	, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
	, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
	@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim,
	@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme --CRCRSTPAR0039/CRCRSTPAR0105
	WHILE @@FETCH_STATUS=0
	BEGIN
		SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer
		IF (DATEPART(MM,@SchStartDate) <> DATEPART (MM,@FromDate)) OR (YEar(@SchStartDate)<> YEar( @FromDate))
		BEGIN
			SET @FromDate = @SchStartDate
		END
		ELSE
		BEGIN
			SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer
		END
		SET @CombiTypeId=0	
		SET @SchBasedOn='RETAILER'
		SET @Po_ErrNo =0		
		SET @Taction = 2
		SET @iCnt=@iCnt+1
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchDesc))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Description should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (2,@TabName,'Scheme Description',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CmpCode))= ''
		BEGIN
			SET @ErrDesc = 'Company should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (3,@TabName,'Company',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAble))= ''
		BEGIN
			SET @ErrDesc = 'Claimable should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (4,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAmtOn))= ''
		BEGIN
			SET @ErrDesc = 'Claim Amount On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (5,@TabName,'Claim Amount On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (6,@TabName,'Scheme Level Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelLvl))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (7,@TabName,'Scheme Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchType))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (8,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@BatLvl))= ''
		BEGIN
			SET @ErrDesc = 'Batch Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (9,@TabName,'Batch Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxSch))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (10,@TabName,'Flexi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxCond))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (11,@TabName,'Flexi Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiSch))= ''
		BEGIN
			SET @ErrDesc = 'Combi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (12,@TabName,'Combi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Range))= ''
		BEGIN
			SET @ErrDesc = 'Range should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (13,@TabName,'Range Based Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ProRata))= ''
		BEGIN
			SET @ErrDesc = 'Pro-Rata should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (14,@TabName,'Pro-Rata',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Qps))= ''
		BEGIN
			SET @ErrDesc = 'QPS Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (15,@TabName,'QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@QpsReset))= ''
		BEGIN
			SET @ErrDesc = 'QPS Reset should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (16,@TabName,'QPS Reset',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ApyQpsOn))= ''
		BEGIN
			SET @ErrDesc = 'Apply QPS Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (17,@TabName,'Apply QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStartDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Start Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (19,@TabName,'Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchStartDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme Start Date is not Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (20,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchStartDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme Start Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (21,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchEndDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme End Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (23,@TabName,'End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchEndDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme End Date is not in Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (24,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchEndDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme End Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (25,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@EditSch))= ''
		BEGIN
			SET @ErrDesc = 'Allow Editing Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (28,@TabName,'Editing Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SetDisMode))= ''
		BEGIN
			SET @ErrDesc = 'Settle Window Display Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (30,@TabName,'Settle Window Display Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Selection On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (31,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStatus))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Status should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (32,@TabName,'Scheme Status',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchBasedOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiType))= ''
		BEGIN
			SET @ErrDesc = 'CombiType should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchApplyOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END 
		IF ((UPPER(LTRIM(RTRIM(@CombiType)))<> 'NORMAL') AND (UPPER(LTRIM(RTRIM(@CombiType)))<> 'FLUCTUATING'))
		BEGIN
			SET @ErrDesc = 'CombiType should be (NORMAL OR FLUCTUATING) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'SELLINGRATE') AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'MRP') 
		AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'PURCHASERATE'))
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should be (SELLINGRATE OR MRP OR PURCHASERATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'RETAILER') AND (UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'KEY GROUP'))
		BEGIN
			SET @ErrDesc = 'Scheme Based On should be (RETAILER OR KEY GROUP) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SelnOn)))<> 'UDC') AND (UPPER(LTRIM(RTRIM(@SelnOn)))<> 'PRODUCT'))
		BEGIN
			SET @ErrDesc = 'Selection On should be (UDC OR PRODUCT) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (33,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@ClmAble)))<> 'YES') AND (UPPER(LTRIM(RTRIM(@ClmAble)))<> 'NO'))
		BEGIN
			SET @ErrDesc = 'Claimable should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (34,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchStatus)))<> 'ACTIVE') AND (UPPER(LTRIM(RTRIM(@SchStatus)))<> 'INACTIVE'))
		BEGIN
			SET @ErrDesc = 'Scheme Stauts should be (ACTIVE OR INACTIVE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (35,@TabName,'Scheme Stauts',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES')
		BEGIN
			IF LTRIM(RTRIM(@ClmGrpCode))= ''
			BEGIN
				SET @ErrDesc = 'Claim Group Code should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (36,@TabName,'Claim Group Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'PURCHASE RATE' AND UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'SELLING RATE')
		BEGIN
			SET @ErrDesc = 'Claimable Amount should be (PURCHASE RATE OR SELLING RATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (37,@TabName,'Claimable Amount',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@SchType)))<>'WINDOW DISPLAY' AND UPPER(LTRIM(RTRIM(@SchType)))<>'AMOUNT'
		   AND UPPER(LTRIM(RTRIM(@SchType)))<>'WEIGHT' AND UPPER(LTRIM(RTRIM(@SchType)))<>'QUANTITY' AND UPPER(LTRIM(RTRIM(@SchType)))<>'LINE LEVEL')
		BEGIN
			SET @ErrDesc = 'Scheme Type should be (WINDOW DISPLAY OR AMOUNT OR WEIGHT OR QUANTITY OR LINE LEVEL) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (38,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		--CRCRSTPAR0007
		IF (UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'NO')
		BEGIN
			SET @ErrDesc = 'ApplyTaxForClaim) should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'ApplyTaxForClaim',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY')
		BEGIN
			IF (UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL')
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (39,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (40,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (41,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (42,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (43,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (44,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (NO) for WINDOW DISPLAY SCHEME for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (45,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (NO)for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (46,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LTRIM(RTRIM(@AdjDisSch))= ''
			BEGIN
				SET @ErrDesc = 'Adjust Window Display Scheme Only Once should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (47,@TabName,'Adjust Window Display Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH' AND UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CHEQUE')
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH OR CHEQUE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (48,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE')
			BEGIN
				SET @ErrDesc = 'Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (50,@TabName,'Apply QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT' AND UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
			AND UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY' AND UPPER(LTRIM(RTRIM(@SchType)))='LINE LEVEL')
		BEGIN
			IF UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL'
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (51,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL' AND UPPER(LTRIM(RTRIM(@FlxCond)))<> 'CONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL OR CONDITIONAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (53,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL')
				BEGIN
					SET @ErrDesc = 'Flexi Scheme Type should be UNCONDITIONAL When Flexi Scheme is YES for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (54,@TabName,'Flexi Scheme Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (55,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (56,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   OR UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (57,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then RANGE should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (58,@TabName,'Range',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then PRO-RATA should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (59,@TabName,'Pro-Rata',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (60,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'YES' AND UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (61,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO, Then QPS Reset should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (62,@TabName,'QPS Reset',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO,Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (63,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE' AND UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'QUANTITY'
				BEGIN
					SET @ErrDesc = 'Apply QPS Scheme Should be (DATE OR QUANTITY) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (64,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH'
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (65,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'YES' AND UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Allow uncheck claimable should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Allow Uncheck',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF NOT EXISTS(SELECT CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode)))
			BEGIN
				SET @ErrDesc = 'Company Not Found for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (66,@TabName,'Company',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @CmpId=CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode))
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			SET @GetKey=0
			SET @GetKeyStr=''
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster SM WHERE CMPID=@CmpId AND SM.CmpSchCode=LTRIM(RTRIM(@SchCode)))
			BEGIN
				SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('SchemeMaster','SchId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
				SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('SchemeMaster','SchCode',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))				
				SET @Taction = 2
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@GetKeyStr=SchCode FROM SchemeMaster WHERE CMPID=@CmpId AND CmpSchCode=LTRIM(RTRIM(@SchCode))
				SET @Taction = 1
			END
		END
		IF @GetKey=0	
		BEGIN
			SET @ErrDesc = 'Scheme Id should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Id',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LEN(LTRIM(RTRIM(@GetKeyStr )))=''
		BEGIN
			SET @ErrDesc = 'Scheme Code should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF @Taction = 2
		BEGIN 
			IF @GetKey<=(SELECT ISNULL(MAX(SchId),0) AS SchId FROM SchemeMaster)
			BEGIN
				SET @ErrDesc = 'Reset the counters/Check the system date'
				INSERT INTO Errorlog VALUES (67,@TabName,'SchId',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'RETAILER'
				SET @SchBasedOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'KEY GROUP'
				SET @SchBasedOnId=2
		END 
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ClmAble)))='YES'
			BEGIN
				IF NOT EXISTS(SELECT ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode)))
				BEGIN
					SET @ErrDesc = 'Claim Group Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (67,@TabName,'Claim Group',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @ClmGrpId=ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode))
				END
			END
			ELSE
			BEGIN
				SET @ClmGrpId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SelnOn)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@SelnOn)))='SKU' OR UPPER(LTRIM(RTRIM(@SelnOn)))='MATERIAL'
			BEGIN
				IF NOT EXISTS(SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=UPPER(LTRIM(RTRIM(@SelLvl))) AND LevelName <> 'Level1')
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (68,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=LTRIM(RTRIM(@SelLvl)) AND LevelName <> 'Level1'
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))='UDC'
			BEGIN
				IF NOT EXISTS(SELECT DISTINCT A.UdcMasterId FROM UdcMaster A
					INNER JOIN UdcHD B ON A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl)))
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (69,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=A.UdcMasterId FROM UdcMaster A INNER JOIN UdcHD B ON
					A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl))
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'ACTIVE'
				SET @StatusId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'INACTIVE'
				SET @StatusId=0
			IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES'
				SET @ClmableId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'NO'
				SET @ClmableId=0
			
			IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'PURCHASE RATE'
				SET @ClmAmtOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'SELLING RATE'
				SET @ClmAmtOnId=2
			
			IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'UDC'
				SET @SelMode=1
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'PRODUCT'
				SET @SelMode=0
			
			IF UPPER(LTRIM(RTRIM(@SchType)))='LINE LEVEL'
				SET @SchTypeId=6
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY'
				SET @SchTypeId=4
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT'
				SET @SchTypeId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
				SET @SchTypeId=3
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY'
				SET @SchTypeId=1
			
			IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'YES'
				SET @BatId=1
			ELSE IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))= 'ALL'
				SET @BatId=0
			
			
			IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'YES'
				SET @FlexiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO'
				SET @FlexiId=0
			
			IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'UNCONDITIONAL'
				SET @FlexiConId=2
			ELSE IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL'
				SET @FlexiConId=1
			ELSE
				SET @FlexiConId=2
			
			IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'YES'				
				SET @CombiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'NO'
				SET @CombiId=0
			IF UPPER(LTRIM(RTRIM(@CombiType)))= 'FLUCTUATING'
				SET @CombiTypeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NORMAL'
				SET @CombiTypeId=0
			
			IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'MRP'				
				SET @SchApplyOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'SELLINGRATE'
				SET @SchApplyOnId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'PURCHASERATE'
				SET @SchApplyOnId=3
				
			
			IF UPPER(LTRIM(RTRIM(@Range)))= 'YES'
				SET @RangeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NO'
				SET @RangeId=0
			
			IF UPPER(LTRIM(RTRIM(@ProRata)))= 'YES'
				SET @ProRateId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'NO'
				SET @ProRateId=0
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'ACTUAL'
				SET @ProRateId=2
			
			IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
				SET @QPSId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
				SET @QPSId=0
			
			IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'YES'
				SET @ForEveryId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'NO'
				SET @ForEveryId=0
			IF UPPER(LTRIM(RTRIM(@EditSch)))= 'YES'
				SET @EditSchId=0
			ELSE IF UPPER(LTRIM(RTRIM(@EditSch)))= 'NO'
				SET @EditSchId=0
			IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				SET @QPSResetId=1
			ELSE IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'NO'
				SET @QPSResetId=0
			IF LTRIM(RTRIM(@SchBudget))= ''
			BEGIN
				SET @SchBudget=0
			END
			
			IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'YES'
			BEGIN
				SET @ApplyTax=1
			END	
			ELSE IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'NO'
			BEGIN
				SET @ApplyTax=0		
			END
			  
			IF @SchTypeId=4
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
					SET @ApplySchId=1
				IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CASH'
					SET @SettleSchId=1
				ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CHEQUE'
					SET @SettleSchId=2
				IF LTRIM(RTRIM(@AdjDisSch))= 'NO'
					SET @AdjustSchId=0
				ELSE IF LTRIM(RTRIM(@AdjDisSch))= 'YES'
					SET @AdjustSchId=1
			END
			ELSE
			BEGIN
				IF @QPSId=1
				BEGIN
					IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
						SET @ApplySchId=1
					ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))='QUANTITY'
						SET @ApplySchId=2
					SET @SettleSchId=1
				END
				ELSE
				BEGIN
					SET @SettleSchId=1
					SET @ApplySchId=1
				END
			END
		END
		
		
		IF UPPER(LTRIM(RTRIM(ISNULL(@Validate_Cap,'NO'))))= 'YES'
		BEGIN
			SET @Validate_Cap_Id=1
		END	
		ELSE IF UPPER(LTRIM(RTRIM(ISNULL(@Validate_Cap,'NO'))))= 'NO'
		BEGIN
			SET @Validate_Cap_Id=0		
		END
		--CRCRSTPAR0105
		IF UPPER(LTRIM(RTRIM(ISNULL(@ContriPercentageScheme,'NO'))))= 'YES'
		BEGIN
			SET @ContriPercentageSchemeId=1
		END	
		ELSE IF UPPER(LTRIM(RTRIM(ISNULL(@ContriPercentageScheme,'NO'))))= 'NO'
		BEGIN
			SET @ContriPercentageSchemeId=0		
		END
		ELSE 
		BEGIN
			SET @ContriPercentageSchemeId=0		
		END
		--CRCRSTPAR0105
		 		
		IF @Po_ErrNo = 0
		BEGIN
			IF @FBM='Yes'
			BEGIN
				SET @FBMId=1
				SET @SchBudget=0
			END
			ELSE
			BEGIN
				SET @FBMId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @SettlementType='Value'
			BEGIN
				SET @SettlementTypeId=1				
			END
			ELSE IF @SettlementType='Product'
			BEGIN
				SET @SettlementTypeId=2
			END
			ELSE 
			BEGIN
				SET @SettlementTypeId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@AllowUnCheck)))= 'YES'
			BEGIN
				SET @AllowUnCheckId=1
			END
			ELSE
			BEGIN
				SET @AllowUnCheckId=0
			END
		END
		 
		
		IF @Po_ErrNo = 0
		BEGIN
			IF @Taction=1
			BEGIN
				EXEC Proc_DependencyCheck 'SchemeMaster',@GetKey
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					UPDATE SCHEMEMASTER SET SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					--Budget=@SchBudget,SchStatus=@StatusId WHERE SchId=@GetKey
					Budget=@SchBudget,/*,SchStatus=@StatusId*/ 
					Validate_Cap=@Validate_Cap_Id,Cap_Amount=@Cap_Amount
					WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
				END
				ELSE
				BEGIN
					DELETE FROM SchemeProducts WHERE SchId=@GetKey
					DELETE FROM SchemeRetAttr WHERE SchId=@GetKey
					DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabFrePrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabMultiFrePrds WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRtrLevelValidation WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRuleSettings WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdDt WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdHd WHERE SchId=@GetKey
					DELETE FROM SchemeSlabs WHERE SchId=@GetKey
					
					UPDATE SCHEMEMASTER SET SchDsc=LTRIM(RTRIM(@SchDesc)),CmpId=@CmpId,
					Claimable=@ClmableId,ClmAmton=@ClmAmtOnId,ClmRefId=@ClmGrpId,
					SchLevelId=@CmpPrdCtgId,SchType=@SchTypeId,BatchLevel=@BatId,
					FlexiSch=@FlexiId,FlexiSchType=@FlexiConId,CombiSch=@CombiId,
					Range=@RangeId,ProRata=@ProRateId,QPS=@QPSId,QPSReset=@QPSResetId,
					SchValidFrom=LTRIM(RTRIM(@FromDate)),SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					Budget=@SchBudget,ApyQPSSch=@ApplySchId,SetWindowDisp=@SettleSchId,
					--SchemeLvlMode=@SelMode,SchStatus=@StatusId WHERE SchId=@GetKey
					SchemeLvlMode=@SelMode,/*,SchStatus=@StatusId*/ 
					Validate_Cap=@Validate_Cap_Id,Cap_Amount=@Cap_Amount,OrgFromDate =LTRIM(RTRIM(@SchStartDate)) 
					WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
					
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					and SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
				END
			END
			ELSE IF @Taction=2
			BEGIN
				IF @ConFig=1
				BEGIN
					SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
					IF @CmpPrdCtgId<@SLevel
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
	
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
						A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
					END
					ELSE
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
						AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
					END
						IF @EtlCnt=@CmpCnt
						BEGIN
							SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
	
							SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
							IF @EtlCnt=@CmpCnt
							BEGIN	
								INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
								AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,
								BudgetAllocationNo,AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,
								SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim,
								NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate)--CRCRSTPAR0105
								VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
								LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,
								CONVERT(VARCHAR(10),GETDATE(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,
								@BudgetAllocationNo,0,0,@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax,
								@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap_Id,@Cap_Amount,@ContriPercentageSchemeId,LTRIM(RTRIM(@SchStartDate)))--CRCRSTPAR0105
				
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
								IF @FBMId=1
								BEGIN
									SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
									SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
									EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								
								INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download,
								NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate) VALUES
								(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1,
								@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme,@SchStartDate)--CRCRSTPAR0105
							END
						END
						ELSE
						BEGIN
							DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							
							INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
							CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
							ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
							PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download,
							NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate) --CRCRSTPAR0105 
							VALUES
							(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
							@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
							@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
							@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1,
							@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme,@SchStartDate)--CRCRSTPAR0105
						END							
				END
				ELSE
				BEGIN
					INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
					CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
					ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
					PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
					AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,BudgetAllocationNo,
					AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim,
					NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate)--CRCRSTPAR0105
					VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
					LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
					@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
					@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
					@ApplySchId,@SettleSchId,1,1,convert(varchar(10),getdate(),121),1,
					convert(varchar(10),getdate(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,@BudgetAllocationNo,0,0,
					@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax,
					@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap_Id,@Cap_Amount,@ContriPercentageSchemeId,@SchStartDate)--CRCRSTPAR0105
	
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					AND SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
					IF @FBMId=1
					BEGIN
						SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
						SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
						EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
					END
				END
			END
		END
		FETCH NEXT FROM Cur_SchMaster INTO  @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
		, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
		, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
		@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim,
		@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme --CRCRSTPAR0105
	END
	CLOSE Cur_SchMaster
	DEALLOCATE Cur_SchMaster
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Xtype = 'P' AND name = 'Proc_Cn2Cs_BLSchemeSlab')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeSlab
GO
 /*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_BLSchemeSlab 0
SELECT * FROM ErrorLog
SELECT DISTINCT SchId FROM dbo.SchemeSlabs
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeSlab
(
	@Po_ErrNo INT OUTPUT	
)
AS
/*********************************
* PROCEDURE: Proc_Cn2Cs_BLSchemeSlab 1
* PURPOSE: To Insert and Update Scheme Slab Details
* CREATED: Boopathy.P on 02/01/2009
*********************************
Modified By karthick CrNo-CRCRSTPAR0007 Retailer Cap Download on 18/06/2018	
20-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode AS VARCHAR(50)
	DECLARE @SlabCode AS INT
	DECLARE @FromUOM AS VARCHAR(200)
	DECLARE @FromQty AS NUMERIC(18,6)
	DECLARE @ToUOM  AS VARCHAR(200)
	DECLARE @ToQty  AS NUMERIC(18,6)
	DECLARE @ForEveryUOM AS VARCHAR(200)
	DECLARE @ForEveryQty AS NUMERIC(18,6)
	DECLARE @DiscPer AS NUMERIC(5,2)
	DECLARE @FlatAmt AS NUMERIC(18,6)
	DECLARE @Points  AS NUMERIC(18,6)
	DECLARE @FlexiFree AS NUMERIC(18,6)
	DECLARE @FlexiGift AS NUMERIC(18,6)
	DECLARE @FlexiDisc AS NUMERIC(18,6)
	DECLARE @FlexiFlat AS NUMERIC(18,6)
	DECLARE @FlexiPoints AS INT
	DECLARE @TempRange AS NUMERIC(18,6)
	DECLARE @CmpId  AS INT
	DECLARE @SchLevelId AS INT
	DECLARE @SchType AS INT
	DECLARE @FlexiId AS INT
	DECLARE @RangeId AS INT
	DECLARE @FlexiType AS INT
	DECLARE @CombiSch AS INT
	DECLARE @FlexiCnt AS INT
	DECLARE @FromUomId AS INT
	DECLARE @ToUomId AS INT
	DECLARE @ForEveryUomId AS INT
	DECLARE @ChkCount AS INT
	DECLARE @PurOfEvery	 AS INT
	DECLARE @ErrDesc  AS VARCHAR(1000)
	DECLARE @TabName  AS VARCHAR(50)
	DECLARE @GetKey  AS VARCHAR(50)
	DECLARE @Taction  AS INT
	DECLARE @MAXSLABID AS INT
	DECLARE @sSQL   AS VARCHAR(4000)
	DECLARE @MaxSchLevelId	AS INT
	DECLARE @CntVal	As	INT
	DECLARE @TempStr	AS Varchar(4000)
	DECLARE @TempStr1	AS Varchar(4000)
	DECLARE @SLevel		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @MaxDisc  AS NUMERIC(18,2)
	DECLARE @MinDisc  AS NUMERIC(18,2)
	DECLARE @MaxValue  AS NUMERIC(18,2)
	DECLARE @MinValue  AS NUMERIC(18,2)
	DECLARE @MaxPoints  AS INT
	DECLARE @MinPoints  AS INT
	DECLARE @ConFig		AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @SlabNotAppl AS INT
	DECLARE @NoofLines AS NUMERIC(18,0)
	DECLARE @RetailerCap AS NUMERIC(18,2)--CRCRSTPAR0007
	
	Create Table  #TempTbl
	(
		PrdUnitId	INT,
		PrdUnitGrpId	INT,
		PrdUnitCode	Varchar(50)
	)
	
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	
	DECLARE Cur_SchemeSlabDt CURSOR
	FOR SELECT DISTINCT ISNULL([CmpSchCode],'') AS [Company Scheme Code],
		ISNULL([SlabId],0) AS [SlabId],
		ISNULL([Uom],'0') AS [From Uom],
		CASE ISNULL([FromQty],'') WHEN '' THEN 0 ELSE CAST([FromQty] AS NUMERIC(18,2)) END AS [From Qty],
		ISNULL([ToUom],'0') AS [To Uom],
		CASE ISNULL([ToQty],'') WHEN '' THEN 0 ELSE CAST([ToQty] AS NUMERIC(18,2)) END AS [To Qty],
		ISNULL([ForEveryUom],'0') AS [For Every Uom],
		CASE ISNULL([ForEveryQty],'') WHEN '' THEN 0 ELSE CAST([ForEveryQty] AS NUMERIC(18,2)) END AS [For Every Qty],
		CASE ISNULL([DiscPer],'') WHEN '' THEN 0 ELSE CAST([DiscPer] AS NUMERIC(5,2)) END AS [Disc %],
		CASE ISNULL([FlatAmt],'') WHEN '' THEN 0 ELSE CAST([FlatAmt] AS NUMERIC(18,2)) END AS [Flat Amount],
		CASE ISNULL([Points],'') WHEN '' THEN 0 ELSE CAST([Points] AS NUMERIC(18,2)) END AS [Point],
		CASE ISNULL([FlxFreePrd],'') WHEN '' THEN 0 ELSE [FlxFreePrd] END AS [Flexi Free],
		CASE ISNULL([FlxGiftPrd],'') WHEN '' THEN 0 ELSE [FlxGiftPrd] END AS [Flexi Gift],
		CASE ISNULL([FlxDisc],'') WHEN '' THEN 0 ELSE [FlxDisc] END AS [Flexi Disc],
		CASE ISNULL([FlxValueDisc],'') WHEN '' THEN 0 ELSE [FlxValueDisc] END AS [Flexi Flat],
		CASE ISNULL([FlxPoints],'') WHEN '' THEN 0 ELSE [FlxPoints] END AS [Flexi Points],
		CASE ISNULL([MaxDiscount],'') WHEN '' THEN 0 ELSE CAST([MaxDiscount] AS NUMERIC(18,2)) END AS [Max Discount],
		CASE ISNULL([MinDiscount],'') WHEN '' THEN 0 ELSE CAST([MinDiscount] AS NUMERIC(18,2)) END AS [Min Discount],
		CASE ISNULL([MaxValue],'') WHEN '' THEN 0 ELSE CAST([MaxValue] AS NUMERIC(18,2)) END AS [Max Value],
		CASE ISNULL([MinValue],'') WHEN '' THEN 0 ELSE CAST([MinValue] AS NUMERIC(18,2)) END AS [Min Value],
		CASE ISNULL([MaxPoints],'') WHEN '' THEN 0 ELSE CAST([MaxPoints] AS NUMERIC(18,2)) END AS [Max Points],
		CASE ISNULL([MinPoints],'') WHEN '' THEN 0 ELSE CAST([MinPoints] AS NUMERIC(18,2)) END AS [Min Points],
		CASE ISNULL([RetailerCap],'') WHEN '' THEN 100 ELSE CAST([RetailerCap] AS NUMERIC(18,2)) END AS [RetailerCap],
		ISNULL(NoofLines,0) AS NoofLiners
	FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY [Company Scheme Code],[SlabId]
	OPEN Cur_SchemeSlabDt
	FETCH NEXT FROM Cur_SchemeSlabDt INTO @SchCode,@SlabCode,@FromUOM,@FromQty,@ToUOM,@ToQty,@ForEveryUOM,
	@ForEveryQty,@DiscPer,@FlatAmt,@Points,@FlexiFree,@FlexiGift,@FlexiDisc,@FlexiFlat,@FlexiPoints,
	@MaxDisc,@MinDisc,@MaxValue,@MinValue,@MaxPoints,@MinPoints,@RetailerCap,@NoofLines
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CntVal=1
		SET @FromUomId=0
		SET @ToUomId=0
		SET @ForEveryUomId=0
		SET @TempStr=''
		SET @TempStr1=''
		DELETE FROM #TempTbl
		SELECT @MAXSLABID=MAX([SlabId])  FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE  [CmpSchCode]=@SchCode
		SET @Taction = 2
		SET @Po_ErrNo =0
		---->Modified By Nanda on 16/09/2009
		SET @SlabNotAppl=0
		IF (LTRIM(RTRIM(@SlabCode))= '---' OR LTRIM(RTRIM(@SlabCode))= '0')
		BEGIN						
			SET @SlabNotAppl=1
		END
		---->Till Here
		IF @SlabNotAppl=0
		BEGIN
			IF LTRIM(RTRIM(@SchCode))= ''
			BEGIN
				SET @ErrDesc = 'Company Scheme Code should not be blank'
				INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LEN(LTRIM(RTRIM(@SlabCode)))= 0
			BEGIN
				SET @ErrDesc = 'Slab Details should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (1,@TabName,'Slab Details',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END

			IF EXISTS (SELECT * FROM SchemeMaster A INNER JOIN Etl_Prk_SchemeHD_Slabs_Rules B ON A.CmpSchCode =B.CmpSchCode 
				AND A.Schtype=6 AND   B.NoofLines =0
			 WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode)  ))
			BEGIN
				SET @ErrDesc = 'NoofLines Details should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (1,@TabName,'Slab Details',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END

			IF @Po_ErrNo=0
			BEGIN
				IF @ConFig<>1
				BEGIN
					IF NOT EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
					BEGIN
						SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,@SchType=SchType,
						@RangeId=Range,@CombiSch=CombiSch,@PurOfEvery=PurofEvery,@CmpPrdCtgId=SchLevelId  FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					END
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
					BEGIN
						SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,@SchType=SchType,
						@RangeId=Range,@CombiSch=CombiSch,@PurOfEvery=PurofEvery,@CmpPrdCtgId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					END
					ELSE
						IF NOT EXISTS(SELECT CmpSchCode FROM Etl_Prk_SchemeMaster_Temp WHERE
						CmpSchCode=LTRIM(RTRIM(@SchCode)) AND UpLoadFlag='N')
						BEGIN
							IF NOT EXISTS(SELECT [CmpSchCode] FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE
							[CmpSchCode]=LTRIM(RTRIM(@SchCode)))
							BEGIN
								SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode +' in table Etl_Prk_SchemeHD_Slabs_Rules '
								INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @CmpId=B.CmpId FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON
								B.CmpCode=A.[CmpCode] WHERE [CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @SchLevelId=C.CmpPrdCtgId,@FlexiId=A.FlexiSch,@CombiSch=A.CombiSch,
								@FlexiType=A.FlexiSchType,@SchType=A.SchType,@RangeId=A.Range
								FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON B.CmpCode=A.CmpCode
								INNER JOIN ProductCategoryLevel C ON A.SchLevel=C.CmpPrdCtgName
								AND B.CmpId=C.CmpId WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode))
							END
						END
					ELSE
					BEGIN
						SELECT @GetKey=CmpSchCode,@CmpId=CmpId FROM Etl_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,
						@SchType=SchType,@RangeId=Range,@CombiSch=CombiSch,@CmpPrdCtgId=SchLevelId FROM Etl_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SET @Po_ErrNo =0
					END
				END
			END
			IF @Po_ErrNo=0
			BEGIN
				IF @FlexiId=1
				BEGIN
					SET @FlexiCnt=0
					IF LTRIM(RTRIM(@FlexiFree))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiGift))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiDisc))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiFlat))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiPoints))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF @FlexiCnt=5
					BEGIN
						SET @ErrDesc = 'Select Only Flexi Items for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'FLEXI SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
				END
				IF @RangeId=1
				BEGIN
					IF (@SchType<>2 AND @SchType<>6)
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						IF LTRIM(RTRIM(@ToUOM))='0'
						BEGIN
							IF 	@MAXSLABID <> @SlabCode
							BEGIN
								SET @ErrDesc = 'To UOM Should Not Be Blank for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @MAXSLABID =@SlabCode
					BEGIN
						IF CONVERT(INT,@ToQty)>0
						BEGIN
							SET @ErrDesc = 'To Qty Should be ZERO for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
				IF @CombiSch=1
				BEGIN
					IF (@SchType<>2 AND @SchType<>6)
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							 SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
						END
						IF LTRIM(RTRIM(@ForEveryUOM))='0'
						BEGIN
							SET @ErrDesc = 'For Every UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							 SELECT @ForEveryUOMId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @PurOfEvery=1
					BEGIN
						IF LTRIM(RTRIM(@ForEveryQty))='0'
						BEGIN
							SET @ErrDesc = 'For Every Qty Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
				IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=0
				BEGIN
					IF (@SchType<>2 AND @SchType<>6)
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						IF LTRIM(RTRIM(@ForEveryUOM))='0'
						BEGIN
							SET @ErrDesc = 'For Every UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'NORMAL SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @PurOfEvery=1
					BEGIN
						IF LTRIM(RTRIM(@ForEveryQty))='0'
						BEGIN
							SET @ErrDesc = 'For Every Qty Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'NORMAL SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
			END
			IF @Po_ErrNo=0
			BEGIN
				SELECT @MaxSchLevelId=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
				IF (@SchType<>4 AND @SchType<>6)
				BEGIN
					IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=0
					BEGIN
						IF @SchType=1
						BEGIN
							IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
							END
							---->Modified By Nanda on 23/08/2009
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ForEveryUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
								END
							END
							ELSE
							BEGIN
								SET @ForEveryUomId=0
							END
							--->Till Here
						END
						ELSE IF @SchType=3
						BEGIN
							IF @MaxSchLevelId=@SchLevelId
							BEGIN
								IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (1) for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
									SET @FromUomId= ISNULL(@FromUomId,0)
								END
			
								---->Modified By Nanda on 23/08/2009
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
										SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN
								SET @sSQL=''
								IF @CntVal=(@MaxSchLevelId-@SchLevelId)
								BEGIN
									SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
								END
								ELSE
								BEGIN
									WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
									BEGIN
										IF @CntVal=1
										BEGIN
											SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
												  (SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
												   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
										END
			
											SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
											SET @TempStr1=@TempStr1+ ')'
										SET @CntVal=@CntVal+1	
										IF @CntVal=(@MaxSchLevelId-@SchLevelId)
										BEGIN
											IF ISNUMERIC(@GetKey)=1
											BEGIN									
												SET @sSQL=@sSQL + @TempStr +'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
											END
											ELSE
											BEGIN
												SET @sSQL=@sSQL + @TempStr +'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
											END																
										END
										
									END	
								END
								--Test		
								--SELECT @sSQL			
								EXEC(@sSQL)
								IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (2) for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
									SET @FromUomId= ISNULL(@FromUomId,0)
								END
					
								--->Modified By Nanda on 30/09/2010
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
										SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
								END
								--->Till Here	
							END
						END
					END
					ELSE IF @FlexiId=1
					BEGIN
						IF @CombiSch=1
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
								---->Modified By Nanda on 23/08/2009
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId=0
								END
								---->Till Here
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (3) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
				
									--->Modified By Nanda on 30/09/2010
									IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
									BEGIN
										IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
										BEGIN
											IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
											BEGIN
												SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
												INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
												SET @Taction = 0
												SET @Po_ErrNo =1
											END
											ELSE
											BEGIN
												SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
												SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
											END
										END
										ELSE	
										BEGIN
											SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
										END
									END
									ELSE	
									BEGIN
										SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
									END
									--->Till Here	
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
			-- 								IF @CntVal<>1
			-- 								BEGIN
												SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
												SET @TempStr1=@TempStr1+ ')'
			-- 								END
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN				
												SET @sSQL=@sSQL + @TempStr +
												'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
												'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1	
												END	
											END
										END		
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (4) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
									--->Modified By Nanda on 30/09/2010
									IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
									BEGIN
										IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
										BEGIN
											SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
											INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
											SET @Taction = 0
											SET @Po_ErrNo =1
										END
										ELSE
										BEGIN
											SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
											SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
										END
									END
									BEGIN
										SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
									END
									--->Till Here
								END
							END
						END
						ELSE IF @RangeId=1
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM)))
								BEGIN
									SET @ErrDesc = 'To Uom:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'To UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ToUomId=ISNULL(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM))
								END
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (5) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN															
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
				
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
									BEGIN
										SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
										SET @ToUomId=ISNULL(@ToUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
			-- 								IF @CntVal<>1
			-- 								BEGIN
												SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
												SET @TempStr1=@TempStr1+ ')'
			-- 								END
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN					
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												ELSE
												BEGIN					
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
												END		
											END
										END	
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (6) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
									BEGIN
										SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
										SET @ToUomId= ISNULL(@ToUomId,0)
									END
								END
							END
						END
						ELSE
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (7) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0)FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
											SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
											SET @TempStr1=@TempStr1+ ')'
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												ELSE
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
												END																						
											END
										END		
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (8) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
								END
							END
						END
					END
				ELSE IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=1
				BEGIN
					IF @SchType=3
					BEGIN
						
						IF @MaxSchLevelId=@SchLevelId
						BEGIN
							IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (9) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
								SET @FromUomId= ISNULL(@FromUomId,0)
							END
			
							IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
							BEGIN
								SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
								SET @ToUomId=ISNULL(@ToUomId,0)
							END
			
							--Test
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
									SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN
								SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
							END
						END
						ELSE
						BEGIN
							SET @sSQL=''
							IF @CntVal=(@MaxSchLevelId-@SchLevelId)
							BEGIN
								SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
							END
							ELSE
							BEGIN
								WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
								BEGIN
									IF @CntVal=1
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
												  (SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
											   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
									END
									
			-- 						IF @CntVal<>1
			-- 						BEGIN
										SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
										SET @TempStr1=@TempStr1+ ')'
			-- 						END
									SET @CntVal=@CntVal+1
									
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										IF ISNUMERIC(@GetKey)=1
										BEGIN				
										SET @sSQL=@sSQL + @TempStr +
										'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
											ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
										END
										ELSE
										BEGIN				
										SET @sSQL=@sSQL + @TempStr +
										'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
											ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
										END
									END
								END	
							END			
							EXEC(@sSQL)
							IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (10) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
								SET @FromUomId= ISNULL(@FromUomId,0)
							END
			
							IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@ToUOM+' not Found (11) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
								SET @ToUomId= ISNULL(@FromUomId,0)
							END
							--->Modified By Nanda on 30/09/2010
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									
									SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN						
									SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
									SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN						
								SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
							END
							--->Till Here
						END
					END
					ELSE IF @SchType=1
					BEGIN
						IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
						BEGIN
							SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
							SET @ToUomId= ISNULL(@ToUomId,0)
						END
						IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM)))
						BEGIN
							SET @ErrDesc = 'To Uom:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'To UOM',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @ToUomId=ISNUll(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM))
							SET @ToUomId= ISNULL(@ToUomId,0)
						END
						---->Modified By Nanda on 23/08/2009
						IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
						BEGIN
							IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
							BEGIN
								SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ForEveryUomId=ISNUll(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
								SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
							END
						END
						ELSE
						BEGIN
							SET @ForEveryUomId=0
						END
						--->Till Here	
					END
				END
			END
			IF @SchType<>4
			BEGIN
				IF NOT EXISTS(SELECT CmpSchCode FROM Etl_Prk_SchemeMaster_Temp WHERE
					CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					EXEC Proc_DependencyCheck 'SCHEMEMASTER',@GetKey
				END
				
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					SET @Taction=0
				END
				ELSE
				BEGIN
					IF @CombiSch=0 AND @FlexiId=0 AND @RangeId=0
					BEGIN
		  				IF   @SchType=2
						BEGIN
							SET @ForEveryUomId=0
							SET @ToUomId=0
							SET @FromUomId=0
						END
						SET @ToUomId=0
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								
								IF @EtlCnt=@CmpCnt
								BEGIN
									DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
									VALUES 
										(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
										0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
										convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
										convert(INT,@FlexiFree),convert(INT,@FlexiGift),convert(INT,@FlexiPoints),convert(NUMERIC(18,2),@Points),1,1,
										convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES 
									(@GetKey,@SlabCode,@FromQty,0,@FromUomId,
									0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--						SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--						INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
								0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
								@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
					
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(8)) + ',' + CAST(@FromQty AS VARCHAR(8)) + ',' + CAST(0 AS VARCHAR(8)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(8)) + ',' + CAST(0 AS VARCHAR(8)) + ',' + CAST(@ToUomId AS VARCHAR(8)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(8)) + ',' + CAST(@ForEveryUomId AS VARCHAR(8)) + ',' + CAST(@DiscPer AS VARCHAR(8)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(8)) + ',' + CAST(@FlexiDisc AS VARCHAR(8)) + ',' + CAST(@FlexiFlat AS VARCHAR(8)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(8)) + ',' + CAST(@FlexiGift AS VARCHAR(8)) + ',' + CAST(@FlexiPoints AS VARCHAR(8)) + ',' + CAST(@Points AS VARCHAR(8)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
							
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
								0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),convert(INT,@FlexiPoints),convert(NUMERIC(18,2),@Points),1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
						END
					END
					ELSE IF @FlexiId=1 AND @RangeId=0 AND @CombiSch=0
					BEGIN
						IF @FlexiType=1 OR @FlexiType=2
						BEGIN
							IF @ConFig=1
							BEGIN
								SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
								IF @CmpPrdCtgId<@SLevel
								BEGIN
									SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
									AND A.SlabId=0 AND A.SlabValue=0
				
									SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
									A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
									AND A.SlabId=0 AND A.SlabValue=0
								END
								ELSE
								BEGIN
									SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
									AND A.SlabId=0 AND A.SlabValue=0
			
									SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
									AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
									AND A.SlabId=0 AND A.SlabValue=0
								END
			
								IF @EtlCnt=@CmpCnt
								BEGIN	
									SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
			
									SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
									INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
			
									IF @EtlCnt=@CmpCnt
									BEGIN
										DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 								SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
						
										INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
											ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
											Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
											MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
										VALUES 
											(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
											0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
											convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
											convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
											1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),
											convert(INT,@MaxValue),convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap,@NoofLines)
						
		-- -- 								SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- -- 								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- -- 								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- -- 								MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- -- 								',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- -- 								CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- -- 								CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- -- 								INSERT INTO Translog(strSql1) Values (@sSQL)
									END
									ELSE
									BEGIN
										DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		-- 								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
										INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
										VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
										0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
										@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
		-- 					
		-- 								SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 								MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 								CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 								CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 								CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 								CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 								CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 								',0,0,0,0,0,0,''N'')'
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
										SET @Po_ErrNo =0
									END
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
									0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
									MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
								VALUES 
									(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
									0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
									convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
									convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
									1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),convert(INT,@MaxValue),
									convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap,@NoofLines)
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 						CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 						CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
							END
						END
					END
					ELSE IF @CombiSch=1 AND @FlexiId=0
					BEGIN
						
						IF NOT EXISTS(SELECT SchId FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode)
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
				
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
								0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
								convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					IF EXISTS(SELECT SchId FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode)
		-- 					BEGIN
		-- 						DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabCombiPrds WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 		
		-- 						INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT @GetKey AS SchId,@SlabCode AS SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,@FromQty AS SlabValue,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121)
		-- 						FROM SchemeProducts WHERE SchId=@GetKey
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT ' + CAST(@GetKey AS VARCHAR(10)) + 'AS SchId,'+ CAST(@SlabCode AS VARCHAR(10)) + 'AS SlabId,
		-- 						PrdCtgValMainId,PrdId,PrdBatId' + CAST(@FromQty AS VARCHAR(10)) + 'AS SlabValue,1,1,
		-- 						''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + '''
		-- 						FROM SchemeProducts WHERE SchId=' + CAST(@GetKey AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					END
						END
		-- 				ELSE
		-- 				BEGIN
		-- 					IF EXISTS(SELECT SchId FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode)
		-- 					BEGIN
		-- 						DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabCombiPrds WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 		
		-- 						INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT @GetKey AS SchId,@SlabCode AS SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,@FromQty AS SlabValue,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121)
		-- 						FROM SchemeProducts WHERE SchId=@GetKey
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT ' + CAST(@GetKey AS VARCHAR(10)) + 'AS SchId,'+ CAST(@SlabCode AS VARCHAR(10)) + 'AS SlabId,
		-- 						PrdCtgValMainId,PrdId,PrdBatId' + CAST(@FromQty AS VARCHAR(10)) + 'AS SlabValue,1,1,
		-- 						''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + '''
		-- 						FROM SchemeProducts WHERE SchId=' + CAST(@GetKey AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					END
		-- 				END
					END
					ELSE IF @RangeId=0
					BEGIN
						DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 				SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 				' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 				INSERT INTO Translog(strSql1) Values (@sSQL)
						SET @TempRange=0
			
						INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
							MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines)
						VALUES 
							(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),convert(NUMERIC(18,2),@TempRange),@FromUomId,
							0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
							convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
							1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
			
		-- 				SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 				ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 				Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 				MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 				CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' +
		-- 				CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 				CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 				CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 				CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 				',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 				INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF (@FlexiId=1 AND @CombiSch=1) OR (@FlexiId=1 AND @RangeId=1)
					BEGIN
						---->Modified By Nanda on 23/08/2009
						IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
						END
						---->Till Here
		--				SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		--				' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--				INSERT INTO Translog(strSql1) Values (@sSQL)
						IF @RangeId=1
						BEGIN
							SET @TempRange=0
						END
						ELSE
						BEGIN
							SET @TempRange=@FromQty
						END
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								IF @EtlCnt=@CmpCnt
								BEGIN
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
									VALUES 
										(@GetKey,@SlabCode,convert(NUMERIC(18,2),@TempRange),convert(NUMERIC(18,2),@FromQty),@FromUomId,
										convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,
										convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),
										convert(INT,@FlexiFlat),convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,
										convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),
										convert(INT,@MinDisc),convert(INT,@MaxValue),convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap,@NoofLines)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 							CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 							CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- 			
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
									@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
--								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
--								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
--								INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
								@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
								@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
					
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@TempRange),convert(NUMERIC(18,2),@FromQty),@FromUomId,
								convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,
								convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),convert(INT,@MaxValue),
								convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap,@NoofLines)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 					CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 					CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
			
							INSERT INTO Translog(strSql1) Values (@sSQL)
						END
					END
					ELSE IF @FlexiId=0 AND @RangeId=1 AND @CombiSch=0
					BEGIN
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								IF @EtlCnt=@CmpCnt
								BEGIN
									DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
									VALUES 
									(@GetKey,@SlabCode,0,convert(NUMERIC(18,2),@FromQty),@FromUomId,
									convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
									convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
									1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- -- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- -- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- -- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
									SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
									' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
									INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
									@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
								INSERT INTO Translog(strSql1) Values (@sSQL)
							
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,CAST(@SlabCode AS INT),0,CAST(@FromQty AS INT),CAST(@FromUomId AS INT),
								CAST(@ToQty AS INT),CAST(@ToUomId AS INT),CAST(@ForEveryQty As INT),CAST(@ForEveryUomId AS INT),CAST(@DiscPer AS NUMERIC(38,6)),CAST(@FlatAmt AS NUMERIC(38,6)),CAST(@FlexiDisc AS INT),CAST(@FlexiFlat AS INT),
								CAST(@FlexiFree AS INT),CAST(@FlexiGift AS INT),CAST(@FlexiPoints AS INT),CAST(@Points AS INT),0,0,0,0,0,0,'NO')
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
							
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap,NoofLines) 
							VALUES 
								(@GetKey,@SlabCode,0,convert(NUMERIC(18,2),@FromQty),@FromUomId,
								convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
								convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap,@NoofLines)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
						END					
					END
				END
			END
		END
	END
	
	FETCH NEXT FROM Cur_SchemeSlabDt INTO  @SchCode,@SlabCode,@FromUOM,@FromQty,@ToUOM,@ToQty,@ForEveryUOM,
		@ForEveryQty,@DiscPer,@FlatAmt,@Points,@FlexiFree,@FlexiGift,@FlexiDisc,@FlexiFlat,@FlexiPoints,
		@MaxDisc,@MinDisc,@MaxValue,@MinValue,@MaxPoints,@MinPoints,@RetailerCap,@NoofLines
	END
	CLOSE Cur_SchemeSlabDt
	DEALLOCATE Cur_SchemeSlabDt
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Xtype = 'P' AND name = 'Proc_Cn2Cs_BLSchemeProducts')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeProducts
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_BLSchemeProducts 0
SELECT * FROM ErrorLog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeProducts
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_Cn2Cs_BLSchemeProducts
* PURPOSE: To Insert and Update Scheme Products
* CREATED: Boopathy.P on 05/01/2009
*********************************************************************
20-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 	AS VARCHAR(50)
	DECLARE @Type  		AS VARCHAR(50)
	DECLARE @PrdCode 	AS VARCHAR(50)
	DECLARE @PrdBatCode 	AS VARCHAR(50)
	DECLARE @CmpId  	AS VARCHAR(50)
	DECLARE @TypeId  	AS VARCHAR(50)
	DECLARE @PrdId  	AS VARCHAR(50)
	DECLARE @PrdBatId 	AS VARCHAR(50)
	DECLARE @SchLevelId 	AS VARCHAR(50)
	DECLARE @BatchLvl 	AS VARCHAR(50)
	DECLARE @UDCId  	AS VARCHAR(50)
	DECLARE @CombiSch 	AS VARCHAR(50)
	DECLARE @ChkCount 	AS INT
	DECLARE @ErrDesc  	AS VARCHAR(1000)
	DECLARE @TabName  	AS VARCHAR(50)
	DECLARE @GetKey   	AS VARCHAR(50)
	DECLARE @Taction  	AS INT
	DECLARE @SelLvl   	AS VARCHAR(50)
	DECLARE @SelMode	AS VARCHAR(50)
	DECLARE @ConFig   	AS INT
	DECLARE @sSQL     	AS VARCHAR(4000)
	DECLARE @MaxSchLevelId 	AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @SLevel		AS INT
	--->Added By Nanda on 09/11/2010
	DECLARE @MaxSchId	AS INT
	DECLARE @FBMSchCode AS NVARCHAR(100)
	DECLARE @FBMSchId	AS INT
	DECLARE @FBMDate	AS DATETIME
	SELECT @MaxSchId=ISNULL(MAX(SchId),0) FROM SchemeProducts
	--->Till Here

	DECLARE @SchType VARCHAR(50)
	DECLARE @Amt NUMERIC(38,6)


	SET @TabName = 'Etl_Prk_SchemeProducts_Combi'
	SET @Po_ErrNo =0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE Cur_SchemePrds CURSOR
	FOR SELECT DISTINCT ISNULL([CmpSchCode],'') AS [Company Scheme Code],ISNULL(SchLevel,'') AS [Type],
	ISNULL([PrdCode],'') AS [Code],ISNULL([PrdBatCode],'') AS [Batch Code],ISNULL([PurchaseValue],0) AS Amt
	FROM Etl_Prk_SchemeProducts_Combi WHERE SlabValue = 0 AND SlabId=0
	AND CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY [Company Scheme Code]
	OPEN Cur_SchemePrds
	FETCH NEXT FROM Cur_SchemePrds INTO @SchCode,@Type,@PrdCode,@PrdBatCode,@Amt
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Po_ErrNo =0
		SET @Taction = 2
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank'
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Type))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@PrdCode))= ''
		BEGIN
			SET @ErrDesc = 'Product Code should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Product Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF NOT EXISTS(SELECT DISTINCT PRDID FROM PRODUCT)
		BEGIN
			SET @ErrDesc = 'No Product(s) found in Product Master'
			INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF NOT EXISTS(SELECT DISTINCT Prdbatid FROM PRODUCTBATCH)
		BEGIN
			SET @ErrDesc = 'No Batch found in Batch Master'
			INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
-- 		ELSE IF UPPER(LTRIM(RTRIM(@Type)))='PRODUCT' AND UPPER(LTRIM(RTRIM(@Type)))='UDC'
-- 		BEGIN
-- 			SET @ErrDesc = 'Type should be (PRODUCT OR UDC)'
-- 			INSERT INTO Errorlog VALUES (1,@TabName,'Type',@ErrDesc)
-- 			SET @Taction = 0
-- 			SET @Po_ErrNo =1
-- 		END
		SELECT @Type= SchemeLevelMode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))

		SELECT @SchType= SchType FROM Etl_Prk_SchemeHD_Slabs_Rules 
		WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))

		IF EXISTS(SELECT *  FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)) AND Schtype=6)
		BEGIN
			IF EXISTS(SELECT DISTINCT * FROM Etl_Prk_SchemeProducts_Combi WHERE PurchaseValue =0 AND CmpSchCode=LTRIM(RTRIM(@SchCode)))
			BEGIN
				SET @ErrDesc = 'PurchaseValue should not be Zero'
				INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END

		IF @Po_ErrNo=0
		BEGIN
			IF @ConFig<>1
			BEGIN
				IF NOT EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					SET @ErrDesc = 'Company Scheme Code not found'
					INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SchLevelId=SchLevelId,@BatchLvl=BatchLevel,@SelMode=SchemeLvlMode
					FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
				END
			END
			ELSE
			BEGIN
				IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SchLevelId=SchLevelId,@BatchLvl=BatchLevel,@SelMode=SchemeLvlMode
						FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @UDCId=A.PrdCtgValMainId FROM ProductCategoryValue A INNER JOIN ProductCategoryLevel B
						ON A.CmpPrdCtgId=B.CmpPrdCtgId WHERE CmpId=@CmpId
						AND PrdCtgValCode=LTRIM(RTRIM(@PrdCode)) AND A.CmpPrdCtgId=@SchLevelId
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT CmpSchCode FROM ETL_Prk_SchemeMaster_Temp WHERE
						CmpSchCode=LTRIM(RTRIM(@SchCode)) AND UpLoadFlag='N')
					BEGIN
						IF NOT EXISTS(SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi WHERE
						CmpSchCode=LTRIM(RTRIM(@SchCode)))
						BEGIN
							SET @ErrDesc = 'Company Scheme Code not found'
							INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @CmpId=B.CmpId FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON
							B.CmpCode=A.CmpCode WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode))
							SELECT @SchLevelId=CmpPrdCtgId FROM Etl_Prk_SchemeHD_Slabs_Rules A
							INNER JOIN COMPANY B ON B.CmpCode=A.CmpCode
							INNER JOIN ProductCategoryLevel C ON A.SchLevel=C.CmpPrdCtgName
							AND B.CmpId=C.CmpId WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode))
						END
					END
					ELSE
					BEGIN
						SELECT @CmpId=CmpId FROM ETL_Prk_SchemeMaster_Temp WHERE
						CmpSchCode=LTRIM(RTRIM(@SchCode))
	
						SELECT @SchLevelId=SchLevelId,@BatchLvl=BatchLevel,@SelMode=SchemeLvlMode
						FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
				END	END
			END
			IF UPPER(LTRIM(RTRIM(@Type)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@Type)))='SKU' OR UPPER(LTRIM(RTRIM(@Type)))='MATERIAL'
			BEGIN
				SELECT @MaxSchLevelId=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
				IF @MaxSchLevelId=@SchLevelId
				BEGIN
					IF NOT EXISTS(SELECT PrdId FROM Product WHERE CmpId=@CmpId
					AND PrdCCode=LTRIM(RTRIM(@PrdCode)))
					BEGIN
						IF @ConFig<>1
						BEGIN
							SET @ErrDesc = 'Product Code Not Found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (11,@TabName,'Product Code',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SET @PrdId= 0 --LTRIM(RTRIM(@PrdCode))
						END
					END
					ELSE
					BEGIN
						SELECT @PrdId=PrdId FROM Product WHERE CmpId=@CmpId
						AND PrdCCode=LTRIM(RTRIM(@PrdCode))
						SET @UDCId=0
						IF @BatchLvl=1
						BEGIN
							IF LTRIM(RTRIM(@PrdBatCode))= ''
							BEGIN
								SET @ErrDesc = 'Batch Code should not be blank for Product Code:'+ @PrdCode+' in Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'Batch Code',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1  					
							END
							IF NOT EXISTS(SELECT PrdBatId FROM ProductBatch WHERE PrdId=@PrdId AND
									PrdBatCode=LTRIM(RTRIM(@PrdBatCode)))
							BEGIN
								IF @ConFig<>1
								BEGIN
									SET @ErrDesc = 'Batch Code Not Found for Product Code:'+ @PrdCode+' in Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (11,@TabName,'Batch Code',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SET @PrdBatId=LTRIM(RTRIM(@PrdBatCode))
								END
							END
							ELSE
							BEGIN
								SELECT @PrdBatId=PrdBatId FROM ProductBatch WHERE PrdId=@PrdId AND
								PrdBatCode=LTRIM(RTRIM(@PrdBatCode))
							END
						END
						ELSE
						BEGIN
							SET @PrdBatId=0
						END
					END
				END
				ELSE  -- For Product Category Value
				BEGIN
					IF NOT EXISTS(SELECT A.PrdCtgValMainId FROM ProductCategoryValue A INNER JOIN ProductCategoryLevel B
					ON A.CmpPrdCtgId=B.CmpPrdCtgId WHERE CmpId=@CmpId
					AND PrdCtgValCode=LTRIM(RTRIM(@PrdCode)) AND A.CmpPrdCtgId=@SchLevelId)
					BEGIN
						IF @ConFig<>1
						BEGIN
							SET @ErrDesc = 'Product Category Level Not Found for Product Code:'+ @PrdCode+' in Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (11,@TabName,'Product Category',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @UDCId=A.PrdCtgValMainId FROM ProductCategoryValue A INNER JOIN ProductCategoryLevel B
								ON A.CmpPrdCtgId=B.CmpPrdCtgId WHERE CmpId=@CmpId
								AND PrdCtgValCode=LTRIM(RTRIM(@PrdCode)) AND A.CmpPrdCtgId=@SchLevelId
							SET @PrdId=0
							SET @PrdBatId=0
						END
					END
					ELSE
					BEGIN
						SELECT @UDCId=A.PrdCtgValMainId FROM ProductCategoryValue A INNER JOIN ProductCategoryLevel B
						ON A.CmpPrdCtgId=B.CmpPrdCtgId WHERE CmpId=@CmpId
						AND PrdCtgValCode=LTRIM(RTRIM(@PrdCode)) AND A.CmpPrdCtgId=@SchLevelId
						SET @PrdId=0
						SET @PrdBatId=0
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Type)))='UDC'
			BEGIN
				IF NOT EXISTS(SELECT DISTINCT A.UDCUniqueId FROM UdcDetails A INNER JOIN UdcMaster B
				ON A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C On A.MasterId=C.MasterId
				INNER JOIN Product P ON A.MasterRecordId=P.PrdId AND P.CmpId=@CmpId
				WHERE A.UdcMasterId=@SchLevelId)
				BEGIN
					IF @ConFig<>1
					BEGIN
						SET @ErrDesc = 'UDC Not Found for Product Code:'+ @PrdCode+' in Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (11,@TabName,'UDC',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SET @UDCId=0
						SET @PrdId=0
						SET @PrdBatId=0
					END
				END
				ELSE
				BEGIN
					SELECT DISTINCT @UDCId=A.UDCUniqueId FROM UdcDetails A INNER JOIN UdcMaster B
					ON A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C On A.MasterId=C.MasterId
					INNER JOIN Product P ON A.MasterRecordId=P.PrdId AND P.CmpId=@CmpId
					Where A.UdcMasterId=@SchLevelId
					SET @PrdId=0
					SET @PrdBatId=0
				END
			END
		END
		IF @Po_ErrNo=0
		BEGIN
			EXEC Proc_DependencyCheck 'SCHEMEMASTER',@GetKey
			SELECT @ChkCount=COUNT(*) FROM TempDepCheck
			IF @ChkCount > 0
			BEGIN
				SET @Taction = 0
			END
			ELSE
			BEGIN
				IF @ConFig=1
				BEGIN
					SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
					IF @SchLevelId<@SLevel
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
	
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
						A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
					END
					ELSE
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
						AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0					
					END
					IF @EtlCnt=@CmpCnt
					BEGIN
						
						SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
						SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
						INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
						
						IF @EtlCnt=@CmpCnt
						BEGIN
							IF @SLevel=@SchLevelId
							BEGIN
								DELETE FROM SCHEMEPRODUCTS WHERE PrdId=@PrdId AND PrdBatId= @PrdBatId AND
							     	SchId=@GetKey
							     	SET @sSQL ='DELETE FROM SCHEMEPRODUCTS WHERE PrdId=' + CAST(@PrdId AS VARCHAR(50)) +
							     	' AND PrdBatId=' + CAST(@PrdBatId AS VARCHAR(50)) + ' AND SchId=' + CAST(@GetKey AS VARCHAR(50))
							END
							ELSE
							BEGIN
								DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=@UDCId AND
								SchId=@GetKey
								SET @sSQL ='DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=' + CAST(@UDCId AS VARCHAR(50)) +
								' AND SchId=' + CAST(@GetKey AS VARCHAR(10))
							END
							
							INSERT INTO Translog(strSql1) Values (@sSQL)
							INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate,RowId) VALUES(@GetKey,ISNULL(@UDCId,0),
							@PrdId ,@PrdBatId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),1)
							
							SET @sSQL ='INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate,RowId) VALUES('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
							CAST(@UDCId AS VARCHAR(50)) + ',' + CAST(@PrdId AS VARCHAR(50)) + ',' + CAST(@PrdBatId AS VARCHAR(50)) +
							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',1)'
							INSERT INTO Translog(strSql1) Values (@sSQL)
						END
						ELSE
						BEGIN
							INSERT INTO Etl_Prk_SchemeProduct_Temp(CmpSchCode,PrdCtgValMainId,PrdId,PrdCode,PrdBatId,UpLoadFlag)
							VALUES(LTRIM(RTRIM(@SchCode)),@UDCId,@PrdId,LTRIM(RTRIM(@PrdCode)),@PrdBatId,'N')
							SET @sSQL ='INSERT INTO Etl_Prk_SchemeProduct_Temp(CmpSchCode,PrdCtgValMainId,PrdId,PrdCode,PrdBatId,UpLoadFlag)
							VALUES('+ CAST(@SchCode AS VARCHAR(50)) + ',' +
							CAST(@UDCId AS VARCHAR(50)) + ',' + CAST(@PrdId AS VARCHAR(50)) + ',' + CAST(@PrdCode AS VARCHAR(50)) + ',' + CAST(@PrdBatId AS VARCHAR(50)) +
							 ',''N'''')'
							INSERT INTO Translog(strSql1) Values (@sSQL)
							SET @Po_ErrNo=0
						END
					END
					ELSE
					BEGIN
						IF @SLevel=@SchLevelId
						BEGIN
							DELETE FROM Etl_Prk_SchemeProduct_Temp WHERE PrdId=CAST(@PrdId AS VARCHAR(50)) AND PrdBatId= CAST(@PrdBatId AS VARCHAR(50)) AND
						     	CmpSchCode=@GetKey AND UpLoadFlag='N'
						END
						ELSE
						BEGIN
							DELETE FROM Etl_Prk_SchemeProduct_Temp WHERE PrdCtgValMainId=CAST(@UDCId  AS VARCHAR(50)) AND
							CmpSchCode=@GetKey AND UpLoadFlag='N'
						END
						INSERT INTO Translog(strSql1) Values (@sSQL)
						INSERT INTO Etl_Prk_SchemeProduct_Temp(CmpSchCode,PrdCtgValMainId,PrdId,PrdCode,PrdBatId,UpLoadFlag)
						VALUES(LTRIM(RTRIM(@SchCode)),@UDCId,@PrdId,LTRIM(RTRIM(@PrdCode)),@PrdBatId,'N')
						SET @sSQL ='INSERT INTO Etl_Prk_SchemeProduct_Temp(CmpSchCode,PrdCtgValMainId,PrdId,PrdCode,PrdBatId,UpLoadFlag)
						VALUES('+ CAST(@SchCode AS VARCHAR(50)) + ',' +
						CAST(@UDCId AS VARCHAR(50)) + ',' + CAST(@PrdId AS VARCHAR(50)) + ',' + CAST(@PrdCode AS VARCHAR(50)) + ',' + CAST(@PrdBatId AS VARCHAR(50)) +
						 ',''N'''')'
						INSERT INTO Translog(strSql1) Values (@sSQL)
						SET @Po_ErrNo=0
						
					END		
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@Type)))='UDC'
					BEGIN
						DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=@UDCId AND
						SchId=@GetKey
-- 						SET @sSQL ='DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=' + CAST(@UDCId AS VARCHAR(10)) +
-- 						' AND SchId=' + CAST(@GetKey AS VARCHAR(10))
-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
						INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
						LastModBy,LastModDate,AuthId,AuthDate,RowId,PurchaseValue) VALUES(@GetKey,ISNULL(@UDCId,0),
						@PrdId,@PrdBatId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),1,@Amt)
-- 						SET @sSQL ='INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
-- 						LastModBy,LastModDate,AuthId,AuthDate) VALUES('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
-- 						CAST(@UDCId AS VARCHAR(50)) + ',' + CAST(@PrdId AS VARCHAR(50)) + ',' + CAST(@PrdBatId AS VARCHAR(50)) +
-- 						',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF UPPER(LTRIM(RTRIM(@Type)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@Type)))='SKU' OR UPPER(LTRIM(RTRIM(@Type)))='MATERIAL'
					BEGIN
						IF @MaxSchLevelId=@SchLevelId
						BEGIN
						     DELETE FROM SCHEMEPRODUCTS WHERE PrdId=@PrdId AND PrdBatId= @PrdBatId AND
						     SchId=@GetKey
-- 						     SET @sSQL ='DELETE FROM SCHEMEPRODUCTS WHERE PrdId=' + CAST(@PrdId AS VARCHAR(50)) +
-- 						     ' AND PrdBatId=' + CAST(@PrdBatId AS VARCHAR(50)) + ' AND SchId=' + CAST(@GetKey AS VARCHAR(50))
						END
						ELSE
						BEGIN
						     DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=@UDCId AND
						     SchId=@GetKey
-- 						     SET @sSQL ='DELETE FROM SCHEMEPRODUCTS WHERE PrdCtgValMainId=' + CAST(@UDCId AS VARCHAR(50)) +
-- 						     ' AND SchId=' + CAST(@GetKey AS VARCHAR(10))
						END
						INSERT INTO Translog(strSql1) Values (@sSQL)
						INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
						LastModBy,LastModDate,AuthId,AuthDate,RowId,PurchaseValue) VALUES(@GetKey,ISNULL(@UDCId,0),
						@PrdId,@PrdBatId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),1,@Amt)
-- 						SET @sSQL ='INSERT INTO SCHEMEPRODUCTS(SchId,PrdCtgValMainId,PrdId,PrdBatId,Availability,
-- 						LastModBy,LastModDate,AuthId,AuthDate) VALUES('+ CAST(ISNULL(@GetKey,0) AS VARCHAR(10)) + ',' +
-- 						CAST(@UDCId AS VARCHAR(50)) + ',' + CAST(@PrdId AS VARCHAR(50)) + ',' + CAST(@PrdBatId AS VARCHAR(50)) +
-- 						',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
	    				END
				END
			END
		END
		FETCH NEXT FROM Cur_SchemePrds INTO @SchCode,@Type,@PrdCode,@PrdBatCode,@Amt
	END
	CLOSE Cur_SchemePrds
	DEALLOCATE Cur_SchemePrds
	--->Added By Nanda on 09/11/2010
	IF EXISTS(SELECT SP.* FROM SchemeProducts SP,SchemeMaster SM WHERE SM.FBM=1 AND SP.SchId=SM.SchId AND SP.SchId>@MaxSchId)
	BEGIN
		DECLARE Cur_FBMSch CURSOR
		FOR SELECT DISTINCT SM.SchCode,SM.SchId FROM SchemeProducts SP,SchemeMaster SM WHERE SM.FBM=1 AND SP.SchId=SM.SchId AND SP.SchId>@MaxSchId		
		OPEN Cur_FBMSch
		FETCH NEXT FROM Cur_FBMSch INTO @FBMSchCode,@FBMSchId
		WHILE @@FETCH_STATUS=0
		BEGIN					
			SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
			--SELECT 'Nanda02',45,@FBMSchCode,@FBMSchId,@FBMDate,1,0
			EXEC Proc_FBMTrack 45,@FBMSchCode,@FBMSchId,@FBMDate,1,0		
			FETCH NEXT FROM Cur_FBMSch INTO @FBMSchCode,@FBMSchId
		END
		CLOSE Cur_FBMSch
		DEALLOCATE Cur_FBMSch
	END
	--->Till Here
	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_ApplySchemeInBill')
DROP PROCEDURE Proc_ApplySchemeInBill
GO
/*
BEGIN TRANSACTION
EXEC Proc_ApplySchemeInBill 8906,1,0,1,2
SELECT * FROM BillAppliedSchemeHd
-- SELECT * FROM BilledPrdHdForScheme(NOLOCK)
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ApplySchemeInBill
(
	@Pi_SchId  		INT,
	@Pi_RtrId		INT,
	@Pi_SalId  		INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT	
)
AS
/************************************************************************************************
* PROCEDURE		: Proc_ApplySchemeInBill
* PURPOSE		: To Apply the Scheme and Get the Scheme Details for the Selected Scheme
* CREATED		: Thrinath
* CREATED DATE	: 17/04/2007
* NOTE			: General SP for Returning the Scheme Details for the Selected Scheme
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------------------------------------------------------
* {date}       {developer}  {brief modification description}
* 08-08-2011	   Boopathy.P   Stock validation Removed
* 19-06-2018	   Karthick.KJ	CRCRSTPAR0007 Slab wise Retailer cap
* 30-08-2018	   S.MOORTHI	ILCRSTPAR1920 Slab wise Retailer cap
* 01-09-2018	   Amuthakumar P ILCRSTPAR1920 Slab wise Retailer cap
* 23-10-2018	   S.MOORTHI	ILCRSTPAR2412  Retailer CApping Logic to be changed (Calculate Eligible Retailers based on Slab Perc First)
* 18-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
		
	DECLARE @SchType		INT
	DECLARE @SchCode		nVarChar(40)
	DECLARE @BatchLevel		INT
	DECLARE @FlexiSch		INT
	DECLARE @FlexiSchType		INT
	DECLARE @CombiScheme		INT
	DECLARE @RangeScheme		INT
	DECLARE @ProRata		INT
	DECLARE @Qps			INT
	DECLARE @QpsReset		INT
	DECLARE @PurOfEveryReq		INT
	DECLARE @SchemeBudget		NUMERIC(38,6)
	DECLARE @SlabId			INT
	DECLARE @NoOfTimes		NUMERIC(38,6)
	DECLARE @GrossAmount		NUMERIC(38,6)
	DECLARE @BudgetUtilized		NUMERIC(38,6)
	DECLARE @BillDate 		DATETIME
	DECLARE @FrmValidDate		DateTime
	DECLARE @ToValidDate		DateTime
	DECLARE @RetailerCap	NUMERIC(18,2)--CRCRSTPAR0007
	DECLARE @SchValidFrom	DATETIME--CRCRSTPAR0007
	DECLARE @SchValidTill	DATETIME--CRCRSTPAR0007
	DECLARE @CtgLevelId INT--CRCRSTPAR0007
	DECLARE @CtgMainid INT--CRCRSTPAR0007
	DECLARE @RtrClassId INT--CRCRSTPAR0007
	DECLARE @Rtrid INT --CRCRSTPAR0007 
	DECLARE @TotRtrCnt	INT--CRCRSTPAR0007
	DECLARE @BilledRtrCnt INT--CRCRSTPAR0007
	DECLARE @AchPercentage	NUMERIC(18,2)--CRCRSTPAR0007
		
	DECLARE @TempBilled TABLE
	(
		PrdId				INT,
		PrdBatId			INT,
		SchemeOnQty 		NUMERIC(38,0),
		SchemeOnAmount		NUMERIC(38,6),
		SchemeOnKG			NUMERIC(38,6),
		SchemeOnLitre		NUMERIC(38,6),
		SchId 				INT,
		SchemeOnAmtWithTax NUMERIC(38,6)
	)
	
	DECLARE @TempBilledAch TABLE
	(
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		ToSchAch		NUMERIC(38,6),
		ToUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT,
		ToQty			NUMERIC(38,6),
		ToUomId			INT
	)
	
	DECLARE @TempSchSlabAmt TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		DiscPer			NUMERIC(38,6),
		FlatAmt			NUMERIC(38,6),
		Points			INT,
		FlxDisc			TINYINT,
		FlxValueDisc		TINYINT,
		FlxFreePrd		TINYINT,
		FlxGiftPrd		TINYINT,
		FlxPoints		TINYINT
	)
	
	DECLARE @TempSchSlabFree TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		FreePrdId		INT,
		FreeQty			INT
	)
	
	DECLARE @TempSchSlabGift TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		GiftPrdId		INT,
		GiftQty			INT
	)
	
	DECLARE @MoreBatch TABLE
	(
		SchId		INT,
		SlabId		INT,
		PrdId		INT,
		PrdCnt		INT,
		PrdBatCnt	INT
	)
	
	DECLARE @TempBillAppliedSchemeHd TABLE
	(
		SchId		int,
		SchCode		nvarchar(50),
		FlexiSch	tinyint,
		FlexiSchType	tinyint,
		SlabId		int,
		SchemeAmount	numeric(32,6),
		SchemeDiscount	numeric(32,6),
		Points		int,
		FlxDisc		tinyint,
		FlxValueDisc	tinyint,
		FlxFreePrd	tinyint,
		FlxGiftPrd	tinyint,
		FlxPoints	tinyint,
		FreePrdId	int,
		FreePrdBatId	int,
		FreeToBeGiven	int,
		GiftPrdId	int,
		GiftPrdBatId	int,
		GiftToBeGiven	int,
		NoOfTimes	numeric(32,6),
		IsSelected	tinyint,
		SchBudget	numeric(32,6),
		BudgetUtilized	numeric(32,6),
		TransId		tinyint,
		Usrid		int,
		PrdId		int,
		PrdBatId	int,
		SchType		int
	)
	
	SELECT @SchCode = SchCode,@SchType = SchType,@BatchLevel = BatchLevel,@FlexiSch = FlexiSch,
		@FlexiSchType = FlexiSchType,@CombiScheme = CombiSch,@RangeScheme = Range,@ProRata = ProRata,
		@Qps = QPS,@QpsReset = QPSReset,@SchemeBudget = Budget,
		@PurOfEveryReq = PurofEvery,@SchValidFrom=SchValidFrom,@SchValidTill=SchValidTill
	FROM SchemeMaster WHERE SchId = @Pi_SchId AND MasterType=1
	
	IF @SchType=2 
	BEGIN
		EXEC CALCULATE_RATEWITHTAX @Pi_UsrId,@Pi_TransId
	END
		
	IF @Pi_TransId=3 OR @Pi_TransId=25
	BEGIN
		INSERT INTO BilledPrdHdForScheme (RowId,RtrId,PrdId,PrdBatId,SelRate,BaseQty,GrossAmount,MRP,
		TransId,Usrid,ListPrice)
		SELECT A.Slno,@Pi_RtrId,A.Prdid,A.PrdBatId,0,A.BaseQty-A.ReturnedQty,0,0,@Pi_TransId,@Pi_UsrId,0
		FROM SalesInvoiceProduct A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		WHERE A.SalId=@Pi_SalId AND  A.PrdId NOT IN (
		SELECT PrdId FROM BilledPrdHdForScheme WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId)
	END
	
	--SELECT 'N3',* FROM BilledPrdHdForScheme
	-- To Get the Scheme Products - Billed Qty, Billed Value, Billed Weight in KG and Litre
	
	INSERT INTO @TempBilled(PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKG,SchemeOnLitre,SchId,SchemeOnAmtWithTax)		
	SELECT A.PrdId,A.PrdBatId,ISNULL(SUM(A.BaseQty),0) AS SchemeOnQty,ISNULL(SUM(A.BaseQty * A.SelRate),0) AS SchemeOnAmount,
		ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 3 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnKg,
		ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 5 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnLitre,@Pi_SchId,
		ISNULL(SUM(A.BaseQty * ISNULL(PT.SellRateWithTax,0)),0) AS SchemeOnAmtWithTax
		FROM BilledPrdHdForScheme A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		LEFT OUTER JOIN ProductSellingRateWithTax PT ON PT.PRDID=A.PRDID AND PT.PRDID=B.PRDID 
		/*Commented and Added by Raja.C for PMS No:ICRSTPAR2340 Begins Here*/
		--AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= B.PrdBatid
		AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		/*Commented and Added by Raja.C  for PMS No:ICRSTPAR2340 Ends Here*/
		WHERE A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId
		GROUP BY A.PrdId,A.PrdBatId,D.PrdUnitId
	
	--To Get the Sum of Quantity, Value or Weight Billed for the Scheme In From and To Uom Conversion - Slab Wise
	INSERT INTO @TempBilledAch(FrmSchAch,FrmUomAch,ToSchAch,ToUomAch,SlabId,FromQty,UomId,ToQty,ToUomId)
	SELECT ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.UomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS FrmSchAch,A.UomId AS FrmUomAch,
		ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.ToUomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS ToSchAch,A.ToUomId AS ToUomAch,
		A.Slabid,(A.PurQty + A.FromQty) as FromQty,A.UomId,A.ToQty,A.ToUomId
		FROM SchemeSlabs A
		INNER JOIN @TempBilled B ON A.SchId = B.SchId
		INNER JOIN Product C ON B.PrdId = C.PrdId
		LEFT OUTER JOIN UomGroup D ON D.UomGroupId = C.UomGroupId AND D.UomId = A.UomId
		LEFT OUTER JOIN UomGroup E ON E.UomGroupId = C.UomGroupId AND E.UomId = A.UomId
		GROUP BY A.UomId,A.Slabid,A.PurQty,A.FromQty,A.UomId,A.ToQty,A.ToUomId
	--
	IF @SchType<>6
	BEGIN 
		SELECT @SlabId = SlabId FROM (SELECT TOP 1 A.SlabId FROM @TempBilledAch A
		INNER JOIN @TempBilledAch B ON A.SlabId = B.SlabId
		WHERE
		A.FrmSchAch >= B.FromQty AND
		A.ToSchAch <= (CASE B.ToQty WHEN 0 THEN A.ToSchAch ELSE B.ToQty END)
		ORDER BY A.SlabId DESC) As SlabId
	END
	ELSE
	BEGIN
	
		DELETE FROM @TempBilled WHERE Prdid IN (
		SELECT DISTINCT B.Prdid  FROM SchemeMaster A (NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid 
		INNER JOIN Product P ON B.Prdid =P.Prdid
		INNER JOIN @TempBilled C ON A.Schid = C.Schid AND C.Prdid =P.Prdid AND B.Prdid=C.Prdid AND B.PurchaseValue>=C.SchemeOnAmount
		WHERE A.Schid = @Pi_Schid AND B.PrdId <> 0 And P.PrdStatus = 1  
		)
	 
		SELECT DISTINCT E.Prdid,B.PrdCtgValMainId,PurchaseValue INTO #PrdDet FROM SchemeMaster A (NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C (NOLOCK) ON
		B.PrdCtgValMainId = C.PrdCtgValMainId
		INNER JOIN ProductCategoryValue D (NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E (NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId
		INNER JOIN ProductBatch F (NOLOCK) On
		F.PrdId = E.Prdid
		WHERE A.Schid = @Pi_Schid AND ISNULL(B.PrdCtgValMainId,0) <> 0 AND E.PrdStatus = 1   

		DELETE FROM @TempBilled WHERE Prdid IN (
		SELECT DISTINCT B.Prdid  FROM  #PrdDet B (NOLOCK) 
		INNER JOIN @TempBilled C ON  B.Prdid=C.Prdid AND B.PurchaseValue>=C.SchemeOnAmount
		WHERE C.Schid = @Pi_Schid  )


			DECLARE @PrdCount AS INT
			
			SELECT @PrdCount = ISNULL(Count(Distinct Prdid),0) FROM @TempBilled
			
			IF EXISTS(SELECT Schid FROM SchemeSlabs (NOLOCK) WHERE SchId=@Pi_SchId AND NoofLines>0)
			BEGIN
				SELECT @SlabId=MIN(SlabId) FROM(
				SELECT Schid,Max(SlabId) as SlabId FROM  SchemeSlabs  (NOLOCK) 
				WHERE NoofLines<=@PrdCount and SchId= @Pi_SchId GROUP BY  Schid
				)X GROUP BY Schid
			END	
			ELSE
			BEGIN
				SELECT @SlabId=Max(SlabId)  FROM  SchemeSlabs  (NOLOCK) 
				WHERE NoofLines<=@PrdCount and SchId= @Pi_SchId GROUP BY  Schid
			END
	END


--Code To Check Slab Wise Retailer Cap	Added by karthick CRCRSTPAR0007
	DECLARE @ReverseSlab AS INT --ILCRSTPAR1920
	DECLARE @ActualRetToBilled AS INT  --ILCRSTPAR2412
	SET @ReverseSlab=0 --ILCRSTPAR1920
	SET @ActualRetToBilled=0
	---
	CREATE TABLE #TotalRetailerCount
		(	
			Rtrid INT 
		)
	
	NextPrd:
	
	IF @ReverseSlab=1 ---ILCRSTPAR1920
	BEGIN
		SELECT @SlabId=MAX(SlabId) FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId
		IF ISNULL(@SlabId,0)=0
		BEGIN
			RETURN
		END
		SET @ReverseSlab=0
	END --ILCRSTPAR1920
	
	SELECT @RetailerCap=RetailerCap FROM SchemeSlabs WHERE Schid=@Pi_SchId AND Slabid=@SlabId
	SET @ActualRetToBilled=0 --ILCRSTPAR2412
	IF @RetailerCap<100
	BEGIN
		SELECT  @CtgLevelId=ISNULL((SELECT TOP 1  Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=4),0)
		SELECT @CtgMainid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5),0)
		SELECT @RtrClassId=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6),0)
		SELECT @Rtrid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8),0)
		
		TRUNCATE TABLE #TotalRetailerCount
		
		INSERT INTO #TotalRetailerCount
		SELECT DISTINCT R.Rtrid 
		FROM  Retailercategory RC
		INNER JOIN RetailerCategory RC1 ON RC1.CtgLinkId=RC.CtgMainid
		INNER JOIN RetailerValueClass RVC ON RVC.CtgMainid=RC1.Ctgmainid
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.RtrValueClassId=RVC.RtrClassId
		INNER JOIN Retailer R ON R.RtrId=RVCM.RtrId
		WHERE RC.CtgLevelId=1 AND RC1.CtgLevelid=2  AND RtrStatus=1
		AND (
		RC.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC.CtgMainid ELSE @CtgMainid END)
		OR RC.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)
		OR RC1.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC1.CtgMainid ELSE @CtgMainid END)
		OR RC1.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)) 		
		AND (RVC.RtrClassId =( CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE @RtrClassId END)
		OR RVC.RtrClassId IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6)) 		
		AND (R.Rtrid =( CASE @Rtrid WHEN 0 THEN R.Rtrid ELSE @Rtrid END)
		OR R.Rtrid IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8))
		 SET @TotRtrCnt=(SELECT DISTINCT COUNT(Rtrid)  FROM #TotalRetailerCount)
		 
		 SET @ActualRetToBilled= CEILING((SELECT ((CAST(@TotRtrCnt AS NUMERIC(18,2))*CAST(@RetailerCap AS NUMERIC(18,2))/100))))
		SELECT @BilledRtrCnt=COUNT(Distinct SI.Rtrid) FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		
		--this logic will be commented ILCRSTPAR2412
		--IF @TotRtrCnt=0
		--BEGIN
		--	SET @AchPercentage=0
		--END 
		--ELSE
		--BEGIN
		----- Rounded by Amuthakumar on 01/09/2018 UAT ILCRSTPAR1920
		----SET @AchPercentage=ROUND((SELECT CAST((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100) AS DECIMAL(10,0))),0)
		----- Ceiling Value by Amuthakumar on 26/09/2018 UAT ILCRSTPAR1920	(ie. if Result 7.1 makes rounded 8.0 )
		--SET @AchPercentage= CEILING((SELECT ((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100))))
				
		--END
		
 		--SELECT @SlabId,@TotRtrCnt,@BilledRtrCnt,@AchPercentage,@RetailerCap
		IF (SELECT object_id('TempDB..#AchvdRetailers')) IS NOT NULL
		BEGIN
			DROP TABLE #AchvdRetailers
		END
				
		CREATE TABLE #AchvdRetailers
		(
		Rtrid Int
		)
		
		INSERT INTO #AchvdRetailers
		SELECT DISTINCT SI.Rtrid 
		FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		
		--SELECT @AchPercentage,@RetailerCap
		--IF @AchPercentage>=@RetailerCap 
		--ILCRSTPAR2412 Perc logic removed
		if ISNULL(@ActualRetToBilled,0)<=ISNULL(@BilledRtrCnt,0)
		BEGIN
			IF NOT EXISTS(SELECT 'X' FROM #AchvdRetailers WHERE RtrId=@Pi_RtrId)
		    BEGIN	
					IF EXISTS(SELECT * FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId)
					BEGIN
						SET @ReverseSlab=1
						GOTO NextPrd
					END
				RETURN
			END			
		END 
	END
--Till here 
	
	--Store the Slab Amount Details into a temp table
	INSERT INTO @TempSchSlabAmt (ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,
		FlxFreePrd,FlxGiftPrd,FlxPoints)
	SELECT ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints
		FROM SchemeSlabs WHERE Schid = @Pi_SchId And SlabId = @SlabId
	
	--Store the Slab Free Product Details into a temp table
	INSERT INTO @TempSchSlabFree(ForEveryQty,ForEveryUomId,FreePrdId,FreeQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType <> 4
	
	--Store the Slab Gift Product Details into a temp table
	INSERT INTO @TempSchSlabGift(ForEveryQty,ForEveryUomId,GiftPrdId,GiftQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType = 4
	
	--To Get the Number of Times the Scheme should apply
	IF @PurOfEveryReq = 0
	BEGIN
		SET @NoOfTimes = 1
	END
	ELSE
	BEGIN
		SELECT @NoOfTimes = A.FrmSchAch / (CASE B.ForEveryQty WHEN 0 THEN 1 ELSE B.ForEveryQty END) FROM
			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
--		SELECT A.FrmSchAch,B.ForEveryQty  FROM
--			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
		IF @ProRata = 0
		BEGIN
			SET @NoOfTimes = FLOOR(@NoOfTimes)	
		END
		IF @ProRata = 1
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,0)
		END
		IF @ProRata = 2
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,6) 
		END
	END
	
	
	
	--To Store the Gross amount for the Scheme billed Product
	SELECT @GrossAmount = ISNULL(SUM(SchemeOnAmount),0) FROM @TempBilled
	--SELECT 'N1',* FROM @TempBilled
	--SELECT 'N2',* FROM @TempSchSlabAmt
	--To Calculate the Scheme Flat Amount and Discount Percentage
	--Scheme Discount for Flat amount = ((FlatAmt * (LineLevel Gross / Total Gross) * 100)/100) * number of times
	--Scheme Discount for Disc Perc   = (LineLevel Gross * Disc Percentage) / 100
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SUM(SchemeAmount) AS SchemeAmount,
		SchemeDiscount AS SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,
		FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,
		IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,0
		FROM
		(
			SELECT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
			@SlabId as SlabId,PrdId,PrdBatId,
			(CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END) As Contri,
			((FlatAmt * (CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END))/100) * @NoOfTimes
			As SchemeAmount, DiscPer AS SchemeDiscount,(Points *@NoOfTimes) as Points,
			FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,0 as FreePrdId,0 as FreePrdBatId,
			0 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,
			0 as IsSelected,@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId As TransId,
			@Pi_UsrId as UsrId FROM @TempBilled , @TempSchSlabAmt
			WHERE (FlatAmt + DiscPer + FlxDisc + FlxValueDisc + FlxFreePrd + FlxGiftPrd + Points + FlxPoints) >=0
		) AS B
		GROUP BY SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,
		FlxGiftPrd,FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,
		NoOfTimes,IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId
	--SELECT * FROM @TempBilled
	--To Calculate the Free Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,FreePrdId,0 as FreePrdBatId,
		CASE @SchType 
			WHEN 1 THEN 
				(CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END )
			WHEN 2 THEN 
				(CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
			WHEN 3 THEN
				(CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
		END
		 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,
		0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,@SchemeBudget as SchBudget,
		0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabFree
		GROUP BY FreePrdId,FreeQty,ForEveryQty
		
	--To Calculate the Gift Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,0 As FreePrdId,0 as FreePrdBatId,
		0 as FreeToBeGiven,GiftPrdId as GiftPrdId,0 as GiftPrdBatId,
		CASE @SchType
			WHEN 1 THEN
				CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 2 THEN
				CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 3 THEN
				CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
		END
		as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,
		@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabGift
		GROUP BY GiftPrdId,GiftQty,ForEveryQty
		IF @Pi_TransId=3 OR @Pi_TransId=25
		BEGIN
			UPDATE A Set A.FreePrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.FreePrdId=B.PrdId
			AND A.FreeToBeGiven>0
			UPDATE A Set A.GiftPrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.GiftPrdId=B.PrdId
			AND A.GiftToBeGiven>0
		END
		
	IF EXISTS (SELECT * FROM SchemeRtrLevelValidation WHERE Schid = @Pi_SchId AND RtrId = @Pi_RtrId)
	BEGIN
		IF Exists (SELECT * FROM SalesInvoice WHERE SalId = @Pi_SalId)
			SELECT @BillDate = SalInvDate FROM SalesInvoice WHERE SalId = @Pi_SalId
		ELSE
			SET @BillDate = CONVERT(VARCHAR(10),GETDATE(),121)
		SELECT @FrmValidDate = FromDate,@ToValidDate = ToDate,@SchemeBudget = BudgetAllocated
			FROM SchemeRtrLevelValidation WHERE @BillDate Between FromDate and ToDate
			AND Schid = @Pi_SchId AND RtrId = @Pi_RtrId
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilizedForRtr(@Pi_SchId,@Pi_RtrId,@FrmValidDate,@ToValidDate)
	END
	ELSE
	BEGIN
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilized(@Pi_SchId)
	END
	
	EXEC Proc_ApplySchemeInBill_Temp @Pi_SchId,@SlabId,@Pi_UsrId,@Pi_TransId
	
	EXEC Proc_ApplyDiscountScheme @Pi_SchId,@Pi_UsrId,@Pi_TransId
	
	UPDATE BillAppliedSchemeHd SET BudgetUtilized = ISNULL(@BudgetUtilized,0),
		SchBudget = ISNULL(@SchemeBudget,0) WHERE SchId = @Pi_SchId AND
		TransId = @Pi_TransId AND Usrid = @Pi_UsrId 
	 --CRCRSTPAR0105
	 EXEC Proc_CheckPrdCategorycontribution  @Pi_SchId,@Pi_RtrId,@Pi_SalId,@Pi_UsrId,@Pi_TransId		
	 --CRCRSTPAR0105
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Xtype = 'TF' AND name = 'Fn_ReturnSlabSchemeDetails')
DROP FUNCTION Fn_ReturnSlabSchemeDetails
GO
/******************************************************************************************
* 18-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
*******************************************************************************************/
CREATE  FUNCTION Fn_ReturnSlabSchemeDetails(@Pi_SchType INT,@Pi_SchId INT)
RETURNS @ReturnSlabDetailes TABLE
(
SlabId INT,
PurQty NUMERIC(36,0),
FROMQty NUMERIC(36,0),
PurUomId INT,
PurUom NVARCHAR(50),
FrmConFact NUMERIC(36,0),
ToQty NUMERIC(36,0),
PurToUomId INT,
PurToUom NVARCHAR(50),
ToConFact NUMERIC(36,0),
ForEveryQty NUMERIC(36,0),
PurofUomId INT,
PurofUom NVARCHAR(50),
PurofConFact NUMERIC(36,0),
DiscPer NUMERIC(36,4),
FlatAmt NUMERIC(36,4),
FlxDisc TINYINT,
FlxValueDisc TINYINT,
FlxFreePrd TINYINT,
FlxGiftPrd TINYINT,
FlxPoints TINYINT,
Points NUMERIC(36,4),
RetailerCap NUMERIC(18,2),
NoOfLines INT
)
AS
BEGIN
/***********************************************************
Funcation Name   : Fn_ReturnSlabSchemeDetails
Added Date       : 2012/07/24
Added By         : Sathishkumar Veeramani
************************************************************
Modified By karthick CrNo-CRCRSTPAR0007 Retailer Cap Download on 18/06/2018	

* 22-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
************************************************************/
IF @Pi_SchType = 3 ---Weight based scheme type
BEGIN
        INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
        DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap,NoOfLines)
        SELECT DISTINCT SlabId,PurQty,FROMQty,SS.UomId AS PurUomId,Fp.PrdUnitCode AS PurUom,ToQty,ToUomId AS PurToUomId,Tp.PrdUnitCode AS PurToUom,
        ForEveryQty,ForEveryUomId AS PurofUomId,Ep.PrdUnitCode AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap,NoOfLines
        FROM SchemeSlabs SS WITH (NOLOCK),Productunit FP  WITH (NOLOCK),Productunit TP  WITH (NOLOCK),Productunit EP  WITH (NOLOCK)
        WHERE TP.Prdunitid = SS.Uomid AND EP.Prdunitid = SS.Uomid AND FP.prdunitid = SS.Uomid AND 
        SS.SchId = @Pi_SchId ORDER BY Slabid    
END
IF (@Pi_SchType = 1) --Quantity based scheme type
BEGIN
		INSERT INTO @ReturnSlabDetailes
		SELECT DISTINCT SlabId,PurQty,FROMQty,PurUomId,PurUom,FrmConFact,ToQty,
		ToUomId AS PurToUomId,PurToUom,ToConFact,ForEveryQty,ForEveryUomId AS PurofUomId,
		PurofUom,PurofConFact,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap,NoOfLines
		FROM SchemeSlabs Z WITH(Nolock)INNER JOIN
		(SELECT UOMId AS PurUomId,UomCode AS PurUom,MAX(ConversionFactor) AS FrmConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)A 
		ON Z.UomId = A.PurUomId INNER JOIN
		(SELECT UOMId,UomCode AS PurToUom,MAX(ConversionFactor) AS ToConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)B
		ON Z.UomId = B.UOMId INNER JOIN
		(SELECT UOMId,UomCode AS PurofUom,MAX(ConversionFactor) AS PurofConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)C
		ON Z.UomId = C.UOMId WHERE Z.SchId = @Pi_SchId ORDER BY SlabId
END      
ELSE IF @Pi_SchType <> 1 AND @Pi_SchType <> 3        
BEGIN
       INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
       DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap,NoOfLines)
       SELECT DISTINCT SlabId,PurQty,FROMQty,UomId AS PurUomId,'' AS PurUom,ToQty,ToUomId AS PurToUomId,'' AS PurToUom,
       ForEveryQty,forEveryUomId AS PurofUomId,'' AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd, 
       FlxPoints,Points,RetailerCap,NoOfLines FROM SchemeSlabs SS WITH (NOLOCK) WHERE SS.SchId = @Pi_SchId ORDER BY Slabid
END
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetLineTypeProducts' AND TYPE='TF')
DROP FUNCTION Fn_GetLineTypeProducts
GO
 --SELECT * FROM Fn_GetLineTypeProducts(2)
CREATE FUNCTION Fn_GetLineTypeProducts (@Pi_Schid INT)
RETURNS @Scheme TABLE
(
	PrdName NVARCHAR(100),
	Value		  NUMERIC(38,6)
)
AS
/*********************************
* PROCEDURE	: Fn_GetLineTypeProducts
* PURPOSE	: To Insert  
* CREATED	:  
* DATE		:  
* PMS NO	:  
************************************************************************************
* 22-02-2021	MOHANA S		 CRCRSTPAR0113       CR		  Included Line Type Scheme
**************************************************************************************/
BEGIN 

	INSERT INTO @Scheme
	SELECT B.PrdCtgValName,PurchaseValue  FROM SCHEMEPRODUCTS A INNER JOIN ProductCategoryValue B ON A.PrdCtgValMainId = B.PrdCtgValMainId 
	AND PRDID=0 AND A.Schid  = @Pi_Schid
	UNION 
	SELECT B.PrdName,PurchaseValue  FROM SCHEMEPRODUCTS A INNER JOIN Product B ON A.PrdCtgValMainId = B.PrdCtgValMainId 
	AND A.PrdCtgValMainId=0 AND A.Schid  = @Pi_Schid
  

RETURN
END
GO
--Till Here Mohana.S
---Added by Mary
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RtrLevelSchemeBudgetValidation' AND TYPE='P')
DROP PROCEDURE Proc_RtrLevelSchemeBudgetValidation
GO
--EXEC Proc_RtrLevelSchemeBudgetValidation 20162,160,2835,1,2
CREATE PROCEDURE Proc_RtrLevelSchemeBudgetValidation
(
	@Pi_SalId AS BIGINT,
	@Pi_RtrId BIGINT,
	@Pi_SchId BIGINT,
	@Pi_Usrid INT,
	@Pi_TransId INT
)
AS 
/******************************************************************************************************************************
* FUNCTION : Proc_RtrLevelSchemeBudgetValidation
* PURPOSE  : Validate the Retailer Level Budget Values
* NOTES    : 
* CREATED  : Mary Subashini.S FOR CR:CRCRSTPAR0067
* MODIFIED
* DATE				AUTHOR				USERSTORYID				CR/BZ		DESCRIPTION
---------------------------------------------------------------------------------------------------------------------------------
* 21-01-2020		MarySubashini.S		CRCRSTPAR0067           CR			Retailer Level Budget for Istitution Sales Scheme
**********************************************************************************************************************************/
SET NOCOUNT ON 
BEGIN

	DECLARE @CurrSchBud AS NUMERIc(38,6)
	DECLARE @PrevsSchBud AS NUMERIc(38,6)
	DECLARE @RtrLvlBud AS NUMERIc(38,6)
	DECLARE @AvailBudget AS NUMERIc(38,6)
	DECLARE @FromDate AS DATETIME
	DECLARE @ToDate AS DATETIME
	IF EXISTS (SELECT 'X' FROM ApportionSchemeDetails (NOLOCK) 
			WHERE TransID = @Pi_TransId AND UsrId = @Pi_Usrid AND SchId=@Pi_SchId)
	BEGIN
	
		IF EXISTS (SELECT 'X' FROM SchemeMaster (NOLOCK) WHERE SchId=@Pi_SchId AND ClmRefId=10004)
		BEGIN
		 
			SET @AvailBudget=0
			SET @CurrSchBud=0
			SET @PrevsSchBud=0
			SET @RtrLvlBud=0
			
			SELECT @RtrLvlBud=CAST(ISNULL(BudgetAllocated,0) AS NUMERIC(38,6)),@FromDate=CONVERT(VARCHAR(10),FromDate,121),
			@ToDate=CONVERT(VARCHAR(10),ToDate,121) 
			FROM SchemeRtrLevelValidation (NOLOCK) WHERE SchId=@Pi_SchId AND RtrId=@Pi_RtrId
			
			CREATE TABLE #SchemeProducts
			(SchId BIGINT,PrdId BIGINT)

			INSERT INTO #SchemeProducts(SchId,PrdId)
			SELECT DISTINCT @Pi_Schid,B.PrdId FROM SchemeMaster A (NOLOCK)
				INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid
				INNER JOIN Product C (NOLOCK) On B.Prdid = C.PrdId
				WHERE A.Schid = @Pi_Schid AND B.PrdId <> 0 And C.PrdStatus = 1   
			UNION
			SELECT DISTINCT @Pi_Schid,E.Prdid FROM SchemeMaster A (NOLOCK)
				INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid
				INNER JOIN ProductCategoryValue C (NOLOCK) ON
				B.PrdCtgValMainId = C.PrdCtgValMainId
				INNER JOIN ProductCategoryValue D (NOLOCK) ON
				D.PrdCtgValLinkCode LIKE CAST(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
				INNER JOIN Product E (NOLOCK) ON
				D.PrdCtgValMainId = E.PrdCtgValMainId
				INNER JOIN ProductBatch F (NOLOCK) ON
				F.PrdId = E.Prdid
				WHERE A.Schid = @Pi_Schid AND ISNULL(B.PrdCtgValMainId,0) <> 0 AND E.PrdStatus = 1
		
		
			SELECT DISTINCT A.SchId INTO #RtrLvlScheme FROM ApportionSchemeDetails A (NOLOCK)
			INNER JOIN SchemeSlabs C (NOLOCK) ON A.SchId=C.SchId AND A.SlabId=C.SlabId
			INNER JOIN SchemeRtrLevelValidation B (NOLOCK) ON A.SchId=B.SchId
			WHERE A.TransID = @Pi_TransId AND A.UsrId = @Pi_Usrid AND A.SchId=@Pi_SchId
			AND C.DiscPer>0
			
			CREATE TABLE #SchemeGross
			(SchId BIGINT,PrdId BIGINT,GrossAmt NUMERIC(38,6),TotalGrossAmt  NUMERIC(38,6),SchemeAmount NUMERIc(38,6),RowId INT,SlabId INT)
		
			SELECT @PrevsSchBud=dbo.Fn_RtrLevelSchBudForPrevUtlilized(@Pi_SchId,@Pi_RtrId,@FromDate,@ToDate,@Pi_SalId)--,2)
			SELECT @CurrSchBud=dbo.Fn_RtrLevelSchemeCurrentUtilized(@Pi_SchId,@Pi_SalId,@Pi_TransId,@Pi_UsrId)--,2)
			
			--EXEC Proc_RtrLevelSchemeBudgetValidation 0,11,2835,1,2
			
			IF EXISTS (SELECT 'X' FROM #RtrLvlScheme)
			BEGIN
					
				IF @RtrLvlBud<(@CurrSchBud+@PrevsSchBud)
				BEGIN
					 SET @AvailBudget=ABS(@RtrLvlBud-ABS(@PrevsSchBud))
					 
					 IF @AvailBudget<=0
					 BEGIN
						
						RETURN
					 END
						 
					 INSERT INTO #SchemeGross(SchId,PrdId,GrossAmt,TotalGrossAmt,RowId,SchemeAmount,SlabId)
					 SELECT DISTINCT B.SchId,B.PrdId,A.GrossAmount,0,A.RowId,0,C.SlabId FROM
					 BilledPrdHdForScheme A (NOLOCK)
					 INNER JOIN #SchemeProducts B ON A.PrdId=B.PrdId
					 INNER JOIN BillAppliedSchemeHd C (NOLOCK) ON C.SchId=B.SchId AND C.PrdId=B.PrdId
					 WHERE A.TransId = @Pi_TransId AND A.Usrid = @Pi_Usrid
					 AND B.SchId=@Pi_Schid
					 
					 UPDATE A SET A.TotalGrossAmt=(SELECT ISNULL(SUM(ISNULL(GrossAmt,0)),0) FROM #SchemeGross)
					 FROM #SchemeGross A 
					 
					 UPDATE A SET A.SchemeAmount=CAST ((GrossAmt/TotalGrossAmt)*@AvailBudget AS NUMERIC(38,6)) FROM #SchemeGross A 
					  
					 UPDATE A SET A.SchemeDiscount=B.SchemeAmount
					 FROM  ApportionSchemeDetails A (NOLOCK) 
					 INNER JOIN #SchemeGross B ON A.SchId=B.SchId
					 AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SlabId =B.SlabId
					 WHERE A.TransId = @Pi_TransId AND A.Usrid = @Pi_Usrid
				END
			END
		END
	END 
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_RtrLevelSchBudForPrevUtlilized' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_RtrLevelSchBudForPrevUtlilized
GO
--SELECT dbo.Fn_RetSchBudForPrevUtlilized()
CREATE  FUNCTION Fn_RtrLevelSchBudForPrevUtlilized
(
	@Pi_SchId	INT,
	@Pi_RtrId	INT,
	@FromDate	DATETIME,
	@ToDate		DATETIME,
	@Pi_SalId	BIGINT
)
RETURNS NUMERIC(38,6)
AS
/*********************************************************************************************************************************
* FUNCTION: Fn_RtrLevelSchBudForPrevUtlilized
* PURPOSE: Returns the Budget Utilized for the Selected Scheme Wise Retailer
* NOTES:
* CREATED:  MarySubashini.S	FOR CR:CRCRSTPAR0067 
* MODIFIED
* DATE			AUTHOR				USERSTORYID			CR/BZ		DESCRIPTION 
---------------------------------------------------------------------------------------------------------------------------------------------    
* 21-01-2020		MarySubashini.S		CRCRSTPAR0067           CR			Retailer Level Budget for Istitution Sales Scheme
*****************************************************************************************************************************************************/ 
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	
	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0))
		FROM SalesInvoiceSchemeLineWise A (NOLOCK)
		INNER JOIN SalesInvoice B(NOLOCK) ON A.SalId = B.SalId
		INNER JOIN SchemeMaster S (NOLOCK)ON A.SchId=S.SchId AND S.FBM=0
		WHERE A.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
		AND B.SalId<>@Pi_SalId
		
	SELECT @FreeValue = ISNULL(SUM((FreeQty - ReturnFreeQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND A.FreePrdBatId = C.PrdBatId
		INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
		WHERE A.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
		AND B.SalId<>@Pi_SalId
		
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)
		INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND A.GiftPrdBatId = C.PrdBatId
		INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
		WHERE S.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
		AND B.SalId<>@Pi_SalId
		
	SELECT @Points = ISNULL(SUM(Points - ReturnPoints),0)
		FROM SalesInvoiceSchemeDtPoints A(NOLOCK) 
		INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId
		INNER JOIN SchemeMaster S (NOLOCK) ON A.SchId=S.SchId AND S.FBM=0
		WHERE A.SchId = @Pi_SchId
		AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
		AND B.SalId<>@Pi_SalId

	SELECT @RetSchemeAmt = (ISNULL(SUM(ReturnFlatAmount),0) +
		ISNULL(SUM(ReturnDiscountPerAmount),0))
		FROM ReturnSchemeLineDt A (NOLOCK) INNER JOIN ReturnHeader B (NOLOCK) ON A.ReturnId = B.ReturnId
		WHERE SchId = @Pi_SchId AND Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate

	SELECT @RetFreeValue = ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)
		FROM ReturnSchemeFreePrdDt A(NOLOCK)  INNER JOIN ReturnHeader B(NOLOCK)  ON A.ReturnId = B.ReturnId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		WHERE SchId = @Pi_SchId AND B.Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate

	SELECT @RetGiftValue = ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)
		FROM ReturnSchemeFreePrdDt A (NOLOCK) INNER JOIN ReturnHeader B (NOLOCK) ON A.ReturnId = B.ReturnId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		WHERE SchId = @Pi_SchId AND B.Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate

	SELECT @RetPoints = ISNULL(SUM(ReturnPoints),0) FROM ReturnSchemePointsDt A(NOLOCK) 
		INNER JOIN ReturnHeader B (NOLOCK) ON A.ReturnId = B.ReturnId WHERE SchId = @Pi_SchId
		AND Status = 0 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate
		
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A
		INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.RtrId =@Pi_RtrId AND B.SalInvDate Between @FromDate and @ToDate
		AND B.SalId<>@Pi_SalId
		
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A
		INNER JOIN ChequeDisbursalDetails B ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 AND B.RtrId =@Pi_RtrId And A.ChqDisDate Between @FromDate and @ToDate
	
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster  (NOLOCK) WHERE FBM=1)
	
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ  (NOLOCK)
	INNER JOIN SalesInvoice SI  (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster WHERE FBM=0)
	AND SI.SalId<>@Pi_SalId
	
	SET @BudgetUtilized = (ISNULL(@SchemeAmt,0) + ISNULL(@FreeValue,0) + ISNULL(@GiftValue,0) + ISNULL(@Points,0) + ISNULL(@WindowAmt,0))
		- (ISNULL(@RetSchemeAmt,0) + ISNULL(@RetFreeValue,0) + ISNULL(@RetGiftValue,0) + ISNULL(@RetPoints,0))+ ISNULL(@FBMSchAmt,0)+ISNULL(@QPSSchAmt,0)

	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	RETURN(@BudgetUtilized)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_RtrLevelSchemeCurrentUtilized' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_RtrLevelSchemeCurrentUtilized
GO
CREATE   FUNCTION [dbo].[Fn_RtrLevelSchemeCurrentUtilized](@Pi_SchId INT,@Pi_SalId BIGINT,@Pi_TransId INT,@Pi_UsrId as INT)
RETURNS NUMERIC(38,6)
AS
BEGIN
/******************************************************************************************************************************
* FUNCTION : Fn_RtrLevelSchemeCurrentUtilized
* PURPOSE  : Validate the Retailer Level Budget Values
* NOTES    : 
* CREATED  : Mary Subashini.S FOR CR:CRCRSTPAR0067
* MODIFIED
* DATE				AUTHOR				USERSTORYID				CR/BZ		DESCRIPTION
---------------------------------------------------------------------------------------------------------------------------------
* 21-01-2020		MarySubashini.S		CRCRSTPAR0067           CR			Retailer Level Budget for Istitution Sales Scheme
**********************************************************************************************************************************/
	DECLARE @SchemeAmt 	NUMERIC(38,6)
	DECLARE @FreeValue	NUMERIC(38,6)
	DECLARE @GiftValue	NUMERIC(38,6)
	DECLARE @Points		INT
	DECLARE @PrvSchemeAmt 	NUMERIC(38,6)
	DECLARE @PrvFreeValue	NUMERIC(38,6)
	DECLARE @PrvGiftValue	NUMERIC(38,6)
	DECLARE @PrvPoints	INT
	DECLARE @WindowAmt	NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	 
	SELECT @SchemeAmt = ISNULL(SUM(SchemeAmount + SchemeDiscount),0) FROM ApportionSchemeDetails WHERE 
		TransId = @Pi_TransId and UsrId = @Pi_UsrId AND SchId = @Pi_SchId
		
	SELECT @FreeValue = ISNULL(SUM((FreeToBeGiven) * D.PrdBatDetailValue),0)
		FROM BillAppliedSchemeHd A INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND D.DefaultPrice = 1 INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId
		
	SELECT @GiftValue = ISNULL(SUM((GiftToBeGiven) * D.PrdBatDetailValue),0)
		FROM BillAppliedSchemeHd A INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND D.DefaultPrice = 1 INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId
		
	SELECT @Points = ISNULL(SUM(Points),0) FROM BillAppliedSchemeHd A
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId
		
	SET @BudgetUtilized = (ISNULL(@SchemeAmt,0) + ISNULL(@FreeValue,0) + ISNULL(@GiftValue,0) + ISNULL(@Points,0) + ISNULL(@WindowAmt,0))
		
	RETURN(@BudgetUtilized)
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetLintTypeSchemeAmt' AND TYPE='FN')
DROP FUNCTION Fn_GetLintTypeSchemeAmt
GO
CREATE FUNCTION Fn_GetLintTypeSchemeAmt(@Mode INT,@Salid INT,@UserId INT,@TransId INT)
RETURNS NUMERIC(38,2)
AS
/*
22-07-2021	MOHANA S	CR     CRCRSTPAR0113	  LINE TYPE SCHEME AMOUNT TAKEN 
*/
BEGIN
DECLARE @Amt AS Numeric(38,2)

	IF @Mode<> 2  
	BEGIN
		SELECT @Amt = ISNULL(SUM(SchemeDiscount),0) FROM ApportionSchemeDetails A INNER JOIN SchemeMaster B
		ON A.SchId = B.SchId AND B.SchType = 6 WHERE Usrid = @UserId AND TransId = @TransId
	END
	IF @Mode=2 
	BEGIN
		SELECT @Amt = ISNULL(SUM(DiscountPerAmount),0) FROM SalesinvoiceSchemelineWise A INNER JOIN SchemeMaster B
		ON A.SchId = B.SchId AND B.SchType = 6 WHERE  Salid = @Salid
	END
RETURN (@Amt)
END
GO
---Till Here
--Added by Mohana.S
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_FillRouteDetails' AND TYPE='TF')
DROP FUNCTION Fn_FillRouteDetails
GO
--SELECT * FROM Fn_FillRouteDetails()
CREATE FUNCTION Fn_FillRouteDetails(@LngId INT)
RETURNS @FillRouteDetails TABLE
(
RMId				INT,
RMCode				NVARCHAR(50),
RMName				NVARCHAR(50),
CmpId				INT,
CmpName				NVARCHAR(50),
NoOfRetailers		INT,
GeoLevelId			INT,
GeoLevelName		NVARCHAR(50),
GeoMainId			INT,
GeoName				NVARCHAR(50),
RMSRouteType		TINYINT,
RteTypeText			NVARCHAR(50),		
RMVanRoute			INT,
VanRteText			NVARCHAR(50),
RMLocalUpcountry	TINYINT,
LocUpText			NVARCHAR(50),
RMDistance			NUMERIC(18, 2),
RMPopulation		NUMERIC(18, 2),
RMMon				TINYINT ,
RMTue				TINYINT ,
RMWed				TINYINT ,
RMThu				TINYINT ,
RMFri				TINYINT ,
RMSat				TINYINT ,
RMSun				TINYINT ,
UpLoad				NVARCHAR(2) 
)
AS
/*********************************
* PROCEDURE		: Fn_FillRouteDetails
* PURPOSE		:   
* CREATED		:  
* CREATED DATE	:  
* MODIFIED
*************************************************************************************************** 
* DATE				AUTHOR      CR/BZ       USER STORY ID       DESCRIPTION                           
***************************************************************************************************  
 12-07-2021		 Mohana S		 CR			 PA-I9			Restricted Dummy salesman
**************************************************************************************************************************************/
BEGIN
	INSERT INTO @FillRouteDetails(RmId,RmCode,RmName,CmpId,CmpName,NoOfRetailers,GeoLevelId,GeoLevelName,GeoMainId,GeoName,RMSRouteType,RteTypeText,
	RMVanRoute,VanRteText,RMLocalUpCountry,LocUpText,RmDistance,RmPopulation,RMMon,RMTue,RmWed,RMThu,RmFri,RMSat,RMSun,Upload)
	SELECT DISTINCT A.RmId,A.RmCode,A.RmName,A.CmpId,(CASE A.CmpId WHEN 0 THEN SDC.CtrlDesc ELSE B.CmpName END) AS CmpName,
	(CASE A.RMSRouteType WHEN 2 THEN COUNT(R.RMID) ELSE COUNT(RM.RMId) END ) As NoOfRetailers,D.GeoLevelId,D.GeoLevelName ,C.GeoMainId,C.GeoName,
	A.RMSRouteType,SDRT.CtrlDesc AS RteTypeText,A.RMVanRoute,SDVR.CtrlDesc AS VanRteText,A.RMLocalUpCountry,SDLU.CtrlDesc AS LocUpText , A.RmDistance,
	A.RmPopulation, A.RMMon, A.RMTue, RmWed, A.RMThu, A.RmFri, A.RMSat, A.RMSun,A.Upload FROM GeographyLevel D,RouteMaster A 
	LEFT OUTER JOIN Company B ON A.CmpId=B.CmpId LEFT OUTER JOIN Geography C ON  a.GeoMainId = c.GeoMainId 
	LEFT OUTER JOIN RetailerMarket RM ON  RM.RMId = A.RMId LEFT OUTER JOIN Retailer R ON R.RMID = A.RMID 
	INNER JOIN ScreenDefaultValues SDRT ON A.RMSRouteType=SDRT.CtrlValue AND SDRT.TransId=78 AND SDRT.CtrlId=20 
	INNER JOIN ScreenDefaultValues SDVR ON A.RMVanRoute =SDVR.CtrlValue AND SDVR.TransId=78 AND SDVR.CtrlId=19 
	INNER JOIN ScreenDefaultValues SDLU ON A.RMLocalUpcountry=SDLU.CtrlValue AND SDLU.TransId=78 AND SDLU.CtrlId=21 
	LEFT OUTER JOIN ScreenDefaultValues SDC ON A.CmpId=SDC.CtrlValue AND SDC.TransId=78 AND SDC.CtrlId=14 
	WHERE C.GeoLevelId = D.GeoLevelId 
	AND RMCODE NOT IN ('SRDummy01','DRDummy01','S99999','D99999')
	GROUP BY A.RMId,A.RmCode,A.RmName,A.RMSRouteType,SDRT.CtrlDesc,A.RmDistance,A.RmPopulation,
	C.GeoName,A.RMVanRoute,SDVR.CtrlDesc,A.RMLocalUpCountry,SDLU.CtrlDesc,A.RMMon , A.RMTue, RmWed, A.RMThu,A.RmFri ,
	A.RMSat, A.RMSun, A.CmpId, B.CmpName,SDC.CtrlDesc, D.GeoLevelName, D.GeoLevelId, C.GeoMainId, RM.RMID, R.RMID,A.Upload ORDER BY A.RMId

RETURN
END
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='RouteAttach'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','RouteAttach','RetailerMaster','Attached Retailer Count not exceeds than',1,0,50,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetRouteCount' AND TYPE='FN')
DROP FUNCTION Fn_GetRouteCount
GO
--SELECT DBO.Fn_GetRouteCount(15,7 ) AS Validate
CREATE FUNCTION Fn_GetRouteCount(@RmId AS INT, @UsrId	INT)
RETURNS VARCHAR(100)
AS
/********************************************************************************************************************** 
* FUNCTION  :	 Fn_GetRouteCount  
* PURPOSE  :	 To Validate no of retailer attached for the Route
* CREATED BY :	 S.MOHANA 
* CREATED DATE : 28-07-2021 
* ZOHO ID	   : PA-I27  
* DATE        AUTHOR   CR/BZ	    USER STORY ID		DESCRIPTION           
-----------------------------------------------------------------------        

***********************************************************************************************************************/ 
BEGIN
DECLARE @ReturMsg AS VARCHAR(1000)
SET @ReturMsg=''

DECLARE @RtrCnt INT
DECLARE @Config INT

SET @RtrCnt	= 0

SET @Config = 0

	IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId ='RouteAttach' AND Status = 1)
	BEGIN
		SELECT @RtrCnt =Count(A.Rtrid)+1 FROM RetailerMarket A INNER JOIN RETAILER B ON A.RTRID = B.RTRID AND RTRSTATUS=1 WHERE A.RMId = @RmId 
		SELECT @Config=ConfigValue  FROM ManualConfiguration WHERE ModuleId ='RouteAttach' AND Status = 1

		IF (@RtrCnt >@Config)
		BEGIN
			SET @ReturMsg = 'Unable to attach, as 50 outlets are already attached for this route'
		END
	END
	 
RETURN @ReturMsg
END
GO
--Till Here
--Added by Mary
---PA-I29  
DELETE FROM CustomCaptions WHERE TransId=508
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 508,1,1,'CoreHeaderTool','Other File Upload','','',1,1,1,GETDATE(),1,GETDATE(),'Other File Upload','','',1,1 UNION ALL
SELECT 508,1,2,'CoreHeaderTool','Stocky','','',1,1,1,GETDATE(),1,GETDATE(),'SDS1','','',1,1 UNION ALL
SELECT 508,2,1,'lblRefNumber','Reference Number...','','',1,1,1,GETDATE(),1,GETDATE(),'Reference Number...','','',1,1 UNION ALL
SELECT 508,3,1,'lblDate','Date','','',1,1,1,GETDATE(),1,GETDATE(),'Date','','',1,1 UNION ALL
SELECT 508,4,1,'lblCompany','Company*...','','',1,1,1,GETDATE(),1,GETDATE(),'Company*...','','',1,1 UNION ALL
SELECT 508,5,1,'lblJCYear','JC Year*...','','',1,1,1,GETDATE(),1,GETDATE(),'JC Year*...','','',1,1 UNION ALL
SELECT 508,6,1,'lblFromJCMonth','From JC Month*...','','',1,1,1,GETDATE(),1,GETDATE(),'From JC Month*...','','',1,1 UNION ALL
SELECT 508,7,1,'lblToJCMonth','To JC Month*...','','',1,1,1,GETDATE(),1,GETDATE(),'To JC Month*...','','',1,1 UNION ALL
SELECT 508,8,1,'lblDescription','Claim Description*','','',1,1,1,GETDATE(),1,GETDATE(),'Claim Description*','','',1,1 UNION ALL
SELECT 508,9,1,'lblRemarks','Remarks','','',1,1,1,GETDATE(),1,GETDATE(),'Remarks','','',1,1 UNION ALL
SELECT 508,10,1,'fxtClaimRefNo','Reference No','Press F4/Double click to select Reference No','',1,1,1,GETDATE(),1,GETDATE(),'Reference No','Press F4/Double click to select Reference No','',1,1 UNION ALL
SELECT 508,11,1,'FxtCmpId','Company','Press F4/Double click to select Company','',1,1,1,GETDATE(),1,GETDATE(),'Company','Press F4/Double click to select Company','',1,1 UNION ALL
SELECT 508,12,1,'fxtJCYear','JC Year','Press F4/Double click to select JC Year','',1,1,1,GETDATE(),1,GETDATE(),'JC Year','Press F4/Double click to select JC Year','',1,1 UNION ALL
SELECT 508,13,1,'fxtFromJCMonth','From JC Month','Press F4/Double click to select From JC Month','',1,1,1,GETDATE(),1,GETDATE(),'From JC Month','Press F4/Double click to select From JC Month','',1,1 UNION ALL
SELECT 508,14,1,'fxtToJCMonth','To JC Month','Press F4/Double click to select To JC Month','',1,1,1,GETDATE(),1,GETDATE(),'To JC Month','Press F4/Double click to select To JC Month','',1,1 UNION ALL
SELECT 508,15,1,'fxtDescription','Claim Description','Enter Claim Description','',1,1,1,GETDATE(),1,GETDATE(),'Claim Description','Enter Claim Description','',1,1 UNION ALL
SELECT 508,16,1,'fxtRemarks','Remarks','Enter Remarks','',1,1,1,GETDATE(),1,GETDATE(),'Remarks','Enter Remarks','',1,1 UNION ALL
SELECT 508,17,2,'DgManualClaim-508-17-2','Ref No*','','',1,1,1,GETDATE(),1,GETDATE(),'Ref No*','','',1,1 UNION ALL
SELECT 508,17,3,'DgManualClaim-508-17-3','Description*','','',1,1,1,GETDATE(),1,GETDATE(),'Description*','','',1,1 UNION ALL
SELECT 508,17,4,'DgManualClaim-508-17-4','Amount*','','',1,1,1,GETDATE(),1,GETDATE(),'Amount*','','',1,1 UNION ALL
SELECT 508,17,5,'DgManualClaim-508-17-5','Remarks','','',1,1,1,GETDATE(),1,GETDATE(),'Remarks','','',1,1 UNION ALL
SELECT 508,17,6,'DgManualClaim-508-17-6','Attach File','','',1,1,1,GETDATE(),1,GETDATE(),'Attach File','','',1,1 UNION ALL
SELECT 508,18,0,'btnOperation','&New','','',1,1,1,GETDATE(),1,GETDATE(),'&New','','',1,1 UNION ALL
SELECT 508,18,1,'btnOperation','&Edit','','',1,1,1,GETDATE(),1,GETDATE(),'&Edit','','',1,1 UNION ALL
SELECT 508,18,2,'btnOperation','&Save','','',1,1,1,GETDATE(),1,GETDATE(),'&Save','','',1,1 UNION ALL
SELECT 508,18,3,'btnOperation','&Delete','','',1,1,1,GETDATE(),1,GETDATE(),'&Delete','','',1,1 UNION ALL
SELECT 508,18,4,'btnOperation','&Cancel','','',1,1,1,GETDATE(),1,GETDATE(),'&Cancel','','',1,1 UNION ALL
SELECT 508,18,5,'btnOperation','E&xit','','',1,1,1,GETDATE(),1,GETDATE(),'E&xit','','',1,1 UNION ALL
SELECT 508,18,6,'btnOperation','&Print','','',1,1,1,GETDATE(),1,GETDATE(),'&Print','','',1,1 UNION ALL
SELECT 508,18,7,'btnOperation','Save && C&onfirm','','',1,1,1,GETDATE(),1,GETDATE(),'Save && C&onfirm','','',1,1 UNION ALL
SELECT 508,19,1,'lblTotal','Total','','',1,1,1,GETDATE(),1,GETDATE(),'Total','','',1,1 UNION ALL
SELECT 508,1000,1,'MsgBox-508-1000-1','','','No record to save',1,1,1,GETDATE(),1,GETDATE(),'','','No record to save',1,1 UNION ALL
SELECT 508,1000,2,'MsgBox-508-1000-2','','','Failed to Lock Record',1,1,1,GETDATE(),1,GETDATE(),'','','Failed to Lock Record',1,1 UNION ALL
SELECT 508,1000,3,'MsgBox-508-1000-3','','','Duplicate Rows not Allowed',1,1,1,GETDATE(),1,GETDATE(),'','','Duplicate Rows not Allowed',1,1 UNION ALL
SELECT 508,1000,4,'MsgBox-508-1000-4','','','Do You Want to Delete Row?',1,1,1,GETDATE(),1,GETDATE(),'','','Do You Want to Delete Row?',1,1 UNION ALL
SELECT 508,1000,5,'MsgBox-508-1000-5','','','From JC Month Should not be greater than To JC Month',1,1,1,GETDATE(),1,GETDATE(),'','','From JC Month Should not be greater than To JC Month',1,1 UNION ALL
SELECT 508,1000,6,'MsgBox-508-1000-6','','',' does not exists',1,1,1,GETDATE(),1,GETDATE(),'','',' does not exists',1,1 UNION ALL
SELECT 508,1000,7,'MsgBox-508-1000-7','','','Status already confirmed',1,1,1,GETDATE(),1,GETDATE(),'','','Status already confirmed',1,1 UNION ALL
SELECT 508,1000,8,'MsgBox-508-1000-8','','','Company ',1,1,1,GETDATE(),1,GETDATE(),'','','Company ',1,1 UNION ALL
SELECT 508,1000,9,'MsgBox-508-1000-9','','','JC Year ',1,1,1,GETDATE(),1,GETDATE(),'','','JC Year ',1,1 UNION ALL
SELECT 508,1000,10,'MsgBox-508-1000-10','','','JC Month ',1,1,1,GETDATE(),1,GETDATE(),'','','JC Month ',1,1 UNION ALL
SELECT 508,1000,11,'MsgBox-508-1000-11','','','Description ',1,1,1,GETDATE(),1,GETDATE(),'','','Description ',1,1 UNION ALL
SELECT 508,1000,12,'MsgBox-508-1000-12','','',' already exists',1,1,1,GETDATE(),1,GETDATE(),'','',' already exists',1,1 UNION ALL
SELECT 508,1000,13,'PnlMsg-508-1000-13','','FromDate Should not be greater than ToDate','',1,1,1,GETDATE(),1,GETDATE(),'','FromDate Should not be greater than ToDate','',1,1 UNION ALL
SELECT 508,1000,14,'PnlMsg-508-1000-14','','Enter Reference Number','',1,1,1,GETDATE(),1,GETDATE(),'','Enter Reference Number','',1,1 UNION ALL
SELECT 508,1000,15,'PnlMsg-508-1000-15','','Enter Description','',1,1,1,GETDATE(),1,GETDATE(),'','Enter Description','',1,1 UNION ALL
SELECT 508,1000,16,'PnlMsg-508-1000-16','','Enter Amount','',1,1,1,GETDATE(),1,GETDATE(),'','Enter Amount','',1,1 UNION ALL
SELECT 508,1000,17,'PnlMsg-508-1000-17','','Enter Remarks','',1,1,1,GETDATE(),1,GETDATE(),'','Enter Remarks','',1,1 UNION ALL
SELECT 508,1000,20,'PnlMsg-508-1000-20','','Enter ','',1,1,1,GETDATE(),1,GETDATE(),'','Enter ','',1,1 UNION ALL
SELECT 508,1000,21,'PnlMsg-508-1000-21','','UDC Details','',1,1,1,GETDATE(),1,GETDATE(),'','UDC Details','',1,1 UNION ALL
SELECT 508,1000,22,'PnlMsg-508-1000-22','','Manual Claim Info','',1,1,1,GETDATE(),1,GETDATE(),'','Manual Claim Info','',1,1 UNION ALL
SELECT 508,1000,23,'MsgBox-508-1000-23','','','Back Dated Transaction Not Allowed',1,1,1,GETDATE(),1,GETDATE(),'','','Back Dated Transaction Not Allowed',1,1 UNION ALL
SELECT 508,1000,24,'MsgBox-508-1000-24','','','From AC Month Should not be greater than To AC Month',1,1,1,GETDATE(),1,GETDATE(),'','','From AC Month Should not be greater than To AC Month',1,1 UNION ALL
SELECT 508,1000,25,'MsgBox-508-1000-25','','','AC Year',1,1,1,GETDATE(),1,GETDATE(),'','','AC Year',1,1 UNION ALL
SELECT 508,1000,26,'MsgBox-508-1000-26','','','AC Month',1,1,1,GETDATE(),1,GETDATE(),'','','AC Month',1,1 UNION ALL
SELECT 508,2000,1,'HotSch-508-2000-1','Reference Number','','',1,1,1,GETDATE(),1,GETDATE(),'Reference Number','','',1,1 UNION ALL
SELECT 508,2000,2,'HotSch-508-2000-2','Reference Date','','',1,1,1,GETDATE(),1,GETDATE(),'Reference Date','','',1,1 UNION ALL
SELECT 508,2000,3,'HotSch-508-2000-3','Company Code','','',1,1,1,GETDATE(),1,GETDATE(),'Company Code','','',1,1 UNION ALL
SELECT 508,2000,4,'HotSch-508-2000-4','Company Name','','',1,1,1,GETDATE(),1,GETDATE(),'Company Name','','',1,1 UNION ALL
SELECT 508,100000,0,'fxtClaimRefNo','Select Claim Ref No.','','',1,1,1,GETDATE(),1,GETDATE(),'Select Claim Ref No.','','',1,1 UNION ALL
SELECT 508,100001,0,'FxtCmpId','Company','','',1,1,1,GETDATE(),1,GETDATE(),'Select Company','','',1,1 UNION ALL
SELECT 508,100002,0,'fxtJCYear','JC Year','','',1,1,1,GETDATE(),1,GETDATE(),'Select JC Year','','',1,1 UNION ALL
SELECT 508,100003,0,'fxtFromJCMonth','From JC Month','','',1,1,1,GETDATE(),1,GETDATE(),'Select From JC Month','','',1,1 UNION ALL
SELECT 508,100004,0,'fxtToJCMonth','To JC Month','','',1,1,1,GETDATE(),1,GETDATE(),'Select To JC Month','','',1,1 UNION ALL
SELECT 508,100005,0,'fxtDescription','Claim Description','','',1,1,1,GETDATE(),1,GETDATE(),'Enter Claim Description','','',1,1 UNION ALL
SELECT 508,100006,0,'fxtRemarks','Remarks','','',1,1,1,GETDATE(),1,GETDATE(),'Enter Remarks','','',1,1 UNION ALL
SELECT 508,100007,2,'DgManualClaim-508-2','Reference No','','',1,1,1,GETDATE(),1,GETDATE(),'Spread','','',1,1 UNION ALL
SELECT 508,100008,3,'DgManualClaim-508-3','Description','','',1,1,1,GETDATE(),1,GETDATE(),'Spread','','',1,1 UNION ALL
SELECT 508,100009,4,'DgManualClaim-508-4','Claim Amount','','',1,1,1,GETDATE(),1,GETDATE(),'Spread','','',1,1 UNION ALL
SELECT 508,100010,5,'DgManualClaim-508-5','Remarks','','',1,1,1,GETDATE(),1,GETDATE(),'Spread','','',1,1 UNION ALL
SELECT 508,100011,6,'sprUdc-508-6','UDC','','',1,1,1,GETDATE(),1,GETDATE(),'UDC','','',1,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='OTHERFILEDOC' AND ProjectName ='PARLE'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','OTHERFILEDOC','OTHERFILEDOC','Other file Doc Attachment is Non mandatory',0,0,0,1
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='OtherFileUploadMaster')
BEGIN
CREATE TABLE [dbo].[OtherFileUploadMaster](
	[OthFileRefId] [bigint] NOT NULL,
	[OthFileRefNo] [nvarchar](100) NOT NULL,
	[OthFileRefDate] [datetime] NOT NULL,
	[CmpId] [int]   NULL,
	[JcmId] [int]   NULL,
	[FromJcmJcId] [int]   NULL,
	[ToJcmJcId] [int]   NULL,
	[Description] [nvarchar](250)   NULL,
	[Remarks] [nvarchar](250) NULL,
	[TotalAmt] [numeric](38, 6)   NULL,
	[Status] [tinyint]   NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL,
 CONSTRAINT [PK_OtherFileUploadMaster_OthFileRefNo] PRIMARY KEY CLUSTERED 
(
	[OthFileRefNo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='OtherFileUploadDetails')
BEGIN
CREATE TABLE [dbo].[OtherFileUploadDetails](
	[OthFileRefId] [bigint] NOT NULL,
	[OthFileRefNo] [nvarchar](100) NOT NULL,
	[RefNo] [nvarchar](250)   NULL,
	[Description] [nvarchar](250)   NULL,
	[Amount] [numeric](38, 6)   NULL,
	[Remarks] [nvarchar](250) NULL,
	[SupportingFiles] [int] NULL ,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL
) ON [PRIMARY]
ALTER TABLE [dbo].[OtherFileUploadDetails]  WITH NOCHECK ADD  CONSTRAINT [FK_OtherFileUploadDetails_OthFileRefNo] FOREIGN KEY([OthFileRefNo])
REFERENCES [dbo].[OtherFileUploadMaster] ([OthFileRefNo])
ALTER TABLE [dbo].[OtherFileUploadDetails] CHECK CONSTRAINT [FK_OtherFileUploadDetails_OthFileRefNo]
END
GO
DELETE FROM HotSearchEditorHd WHERE FormId=10215
INSERT INTO HotSearchEditorHd(FormId,FormName,ControlName,SltString,RemainsltString)
SELECT 10215,'Other File Upload','ReferenceNo','SELECT','SELECT A.OthFileRefId,A.OthFileRefNo,CONVERT(VARCHAR(10),A.OthFileRefDate,121) AS OthFileRefDate,A.CmpId,ISNULL(B.CmpName,''ALL'')CmpName,A.Remarks,A.Status,A.TotalAmt,A.Description FROM 
OtherFileUploadMaster A (NOLOCK) LEFT OUTER JOIN Company B (NOLOCK) ON A.CmpId=B.CmpId'
GO
DELETE FROM HotSearchEditorDt WHERE FormId=10215
INSERT INTO HotSearchEditorDt(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
SELECT 1,10215,'Other File Upload','Reference Number','OthFileRefNo',3000,0,'HotSch-508-2000-1',508 UNION
SELECT 2,10215,'Other File Upload','Reference Date','OthFileRefDate',2000,0,'HotSch-508-2000-2',508
GO
DELETE FROM HotSearchEditorHd WHERE FormId=10216
INSERT INTO HotSearchEditorHd(FormId,FormName,ControlName,SltString,RemainsltString)
SELECT 10216,'Other File Upload','Company','SELECT','select CmpId,CmpCode,CmpName FROM Company with (NOLOCK) where CmpId<>0'
GO
DELETE FROM HotSearchEditorDt WHERE FormId=10216
INSERT INTO HotSearchEditorDt(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
SELECT 1,10216,'Other File Upload','Code','CmpCode',3000,0,'HotSch-508-2000-3',508 UNION
SELECT 2,10216,'Other File Upload','Name','CmpName',2000,0,'HotSch-508-2000-4',508
GO
IF NOT EXISTS (SELECT 'X' FROM Counters WHERE TabName='OtherFileUploadMaster')
BEGIN
INSERT INTO Counters(TabName,FldName,Prefix,Zpad,CmpId,CurrValue,ModuleName,DisplayFlag,CurYear,Availability,LastModBy,LastModDate,AuthId,AuthDate)
SELECT 'OtherFileUploadMaster','OthFileRefNo','OTF',5,1,0,'Other Files Upload',1,YEAR(GETDATE()),1,1,GETDATE(),1,GETDATE() UNION ALL
SELECT 'OtherFileUploadMaster','OthFileRefId','',0,1,0,'Other Files Upload',0,YEAR(GETDATE()),1,1,GETDATE(),1,GETDATE()  
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FN_ReturnOtherFileUploadDetails]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FN_ReturnOtherFileUploadDetails]
GO
CREATE FUNCTION [dbo].[FN_ReturnOtherFileUploadDetails] (@RefId AS BIGINT,@RefNo AS VARCHAR(100))
RETURNS @OtherFileUploadDetails TABLE
(
	OthFileRefId			BIGINT,
	OthFileRefNo	NVARCHAR(100),
	RefNo			NVARCHAR(100),
	Description		NVARCHAR(200),
	Amount			NUMERIC(38,6),		
	Remarks			NVARCHAR(200),
	SupportingFiles	VARCHAR(10),
	ChkDuplicate	NVARCHAR(100)	
)
AS
/*************************************************************************
* FUNCTION: FN_ReturnOtherFileUploadDetails
* PURPOSE: Returns the Other File PDF Details
* NOTES: 
* CREATED: MarySubashini.S 31/07/2021
* MODIFIED 
* DATE			AUTHOR					USERSTORYID		CR/SR		DESCRIPTION
-----------------------------------------------------------------------------------------------------
* 31/07/2021    MarySubashini.S			PA-I29          CR		    Other Files Upload New Screen
**************************************************************************/	
BEGIN
	INSERT INTO @OtherFileUploadDetails (OthFileRefId,OthFileRefNo,RefNo,Description,Amount,Remarks,SupportingFiles,ChkDuplicate)
	SELECT M.OthFileRefId,M.OthFileRefNo,M.RefNo,M.Description,M.Amount,M.Remarks,
	CASE M.SupportingFiles WHEN 1 THEN 'YES' ELSE 'NO' END,M.RefNo as ChkDuplicate
	FROM OtherFileUploadDetails  M (NOLOCK) 
	WHERE M.OthFileRefId=@RefId
RETURN
END
GO
--Mary Till Here
--DEEPAN TILL HERE
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2Cs_Prk_SalesManMaster' AND name='SMType')
BEGIN
       ALTER TABLE Cn2Cs_Prk_SalesManMaster ADD SMType varchar(50)
END
GO
--Upload Process : Salesman
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_Salesman' AND name='SMType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_Salesman ADD SMType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Salesman' AND name='SMType')
BEGIN
       ALTER TABLE Salesman ADD SMType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesmanMasterTrack' AND name='SMType')
BEGIN
       ALTER TABLE SalesmanMasterTrack ADD SMType varchar(50)
END
GO
UPDATE Salesman SET SMType='Common' WHERE SMType IS NULL
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='CN2Cs_Prk_RetailerMasterDownload' AND name='RtrType')
BEGIN
       ALTER TABLE CN2Cs_Prk_RetailerMasterDownload ADD RtrType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2Cs_Prk_RetailerReDownload' AND name='RetailerType')
BEGIN
       ALTER TABLE Cn2Cs_Prk_RetailerReDownload ADD RetailerType varchar(50)
END
GO
--Upload Process : Retailer
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_Retailer' AND name='RetType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_Retailer ADD RetType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Retailer' AND name='RetailerType')
BEGIN
       ALTER TABLE Retailer ADD RetailerType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='RetailerReDownloadTracking' AND name='RetailerType')
BEGIN
       ALTER TABLE RetailerReDownloadTracking ADD RetailerType varchar(50)
END
GO
UPDATE Retailer SET RetailerType='Local' WHERE RetailerType IS NULL
GO
-----PA-I37
Delete From ManualConfiguration Where ModuleId = 'SalesmanRouteLimit' and Description = 'To Set Route Limit Count'
GO
Insert Into  ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
Select 'GST','SalesmanRouteLimit','SalesmanRouteLimit','To Set Route Limit Count',1,'ALL',6,1
GO
DELETE  From CustomCaptions Where TransId = 68 and CtrlId = 1000  and SubCtrlId = 27
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,LastModDate,AuthId,
							AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
Select 68,1000,27,'Msgbox-68-1000-27','','','Route Only attached with Salesman',1,1,1,GETDATE(),1,GETDATE(),'','',' Route Only attached with Salesman ',1,1
GO
DELETE  From CustomCaptions Where TransId = 68 and CtrlId = 1000  and SubCtrlId = 28
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,LastModDate,AuthId,
							AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
Select 68,1000,28,'PnlMsg-68-1000-28','','Route only allowed to save with salesman','',1,1,1,GETDATE(),1,GETDATE(),'',' Route only allowed to save with salesman ','',1,1
GO
IF NOT  EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_SalesmanMaster_BK')
BEGIN
	CREATE TABLE  Cn2Cs_Prk_SalesmanMaster_BK 
	(
		[DistCode] [nvarchar](100) NULL,
		[SMCode] [nvarchar](100) NULL,
		[SMName] [nvarchar](100) NULL,
		[SMPhoneNo] [nvarchar](100) NULL,
		[SMEmail] [nvarchar](100) NULL,
		[SMOtherDetails] [nvarchar](500) NULL,
		[SMDailyAllowance] [numeric](38, 6) NULL,
		[SMMonthlySalary] [numeric](38, 6) NULL,
		[SMMktCredit] [numeric](38, 6) NULL,
		[SMCreditDays] [int] NULL,
		[Status] [nvarchar](20) NULL,
		[RMCode] [nvarchar](100) NULL,
		[RMName] [nvarchar](100) NULL,
		[DownLoadFlag] [nvarchar](10) NULL,
		[CreatedDate] [datetime] NULL,
		[HHTDeviceSerialNumber] [varchar](100) NULL,
		[OldSmCode] [varchar](100) NULL
)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_CN2CS_SalesManMaster]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_CN2CS_SalesManMaster]
GO
/*
BEGIN TRANSACTION
DELETE FROM ERRORLOG
EXEC Proc_CN2CS_SalesManMaster 0
SELECT * FROM SALESMAN
SELECT * FROM Cn2Cs_Prk_SalesManMaster
SELECT * FROM ERRORLOG
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_CN2CS_SalesManMaster]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_CN2CS_SalesManMaster
* PURPOSE		: To Download the SalesMan details from Console to Core Stocky
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 28/12/2020	 Venkat. M	 CR		CRCRSTPAR0107		OldSmcode column added
 11/02/2021	 Venkat. M	 SR		PARLECS/0221/121	Route map validation removed.
 04/08/2021	 Deepan		 CR		PA-I31				SM Type included		
  05.08.2021	 Panneer     CR		PA-I37				NEW CR (Route Limit)
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @ErrStatus			INT
	DECLARE @sSql				NVARCHAR(2000)
	DECLARE @ErrDesc  			NVARCHAR(1000)
	DECLARE @Tabname  			NVARCHAR(50)
	DECLARE @Exists				INT
	DECLARE @SMId				INT
	
	SET @ErrStatus=1
	SET @Po_ErrNo=0
	SET @Tabname = 'Cn2Cs_Prk_SalesManMaster'
	
	DECLARE @DistCode		[nvarchar](100)
	DECLARE @SMCode			[nvarchar](100)
	DECLARE @SMName			[nvarchar](100)
	DECLARE @SMPhoneNo		[nvarchar](100)
	DECLARE @SMEmail		[nvarchar](100)
	DECLARE @SMOtherDetails [nvarchar](500)
	DECLARE @SMDailyAllowance [numeric](38, 6)
	DECLARE @SMMonthlySalary [numeric](38, 6)
	DECLARE @SMMktCredit	[numeric](38, 6)
	DECLARE @SMCreditDays	[int]
	DECLARE @Status			INT
	DECLARE @RMCode			[nvarchar](100)
	DECLARE @RMName			[nvarchar](100)	
	DECLARE @OldSMCode		[nvarchar](100)
	
	DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_SalesManMaster'
	
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SalesManToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SalesManToAvoid	
	END
	CREATE TABLE SalesManToAvoid
	(		
		SMCode		NVARCHAR(200),
		RMCODE		VARCHAR(100)
	)
	
	IF EXISTS(SELECT * FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR ISNULL(SMName,'')='' OR ISNULL(OLDSMCODE,'')='')
	BEGIN
		INSERT INTO SalesManToAvoid(SMCode,RMCODE)
		SELECT SMCODE,RMCODE FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR  ISNULL(SMName,'')=''OR ISNULL(OLDSMCODE,'')=''
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT 1,'Cn2Cs_Prk_SalesManMaster','SM Code','Salesman code should not be empty'
		FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR  ISNULL(SMName,'')=''
	END
	--PARLECS/0221/121
	INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	SELECT SMCODE,RMCode FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster B (NOLOCK) WHERE  A.RMCode=B.RMCODE) AND Status ='ACTIVE'
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_SalesManMaster','RM Code','Route Code ' + RMCode + ' Not Available for '+ SMCode   
	FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster B (NOLOCK) WHERE A.RMCode=B.RMCODE) AND Status ='ACTIVE'
	 ---Till Here PARLECS/0221/121

	 	-----PA-I37
	IF Exists (Select 'x'  From  ManualConfiguration Where ModuleId = 'SalesmanRouteLimit'  and Status = 1 )
	BEGIN
		Declare @MaxCount INT
		DECLARE @CondRM   VARCHAR(25)

		SET @MaxCount = 0 
		Select @MaxCount = ConfigValue,@CondRM = Condition From  ManualConfiguration Where ModuleId = 'SalesmanRouteLimit'  and Status = 1 
		SET @MaxCount = ISNULL(@MaxCount,0)
		IF @MaxCount > 0
		BEGIN

			CREATE Table #TempRMCount (SMCode  Varchar(100), RMCNT INT)
			DELETE FROM #TempRMCount

			IF  @CondRM = 'ALL'
			BEGIN
				INSERT INTO #TempRMCount (SMCode,RMCNT)
				Select SMCode ,Count(RMCode) RMCNT    ---INTO #TempRMCount
				From (
					Select  Distinct SMCode,RMCode From Cn2Cs_Prk_SalesManMaster (Nolock) 	Where DownLoadFlag = 'D'
					) A
				GROUP BY SMCode  
			END
			ELSE
			BEGIN
				INSERT INTO #TempRMCount (SMCode,RMCNT)
				Select SMCode ,Count(RMCode) RMCNT    ---INTO #TempRMCount
				From (
						Select  Distinct SMCode,A.RMCode From Cn2Cs_Prk_SalesManMaster A (Nolock) , RouteMaster B (Nolock)
						Where DownLoadFlag = 'D' AND A.RMCode = B.RMCode AND B.RMstatus =  1
					) A
				GROUP BY SMCode 
			END
			
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
			Select  Distinct 2,'Cn2Cs_Prk_SalesManMaster','Route Count',A.SMCOde + ' ~ ' + Cast (@MaxCount as  Varchar(10))+ '~' + ' Route Only attached with Salesman'
			From Cn2Cs_Prk_SalesManMaster A  (Nolock), #TempRMCount  B 
			Where DownLoadFlag = 'D'  AND A.SMCode = B.SMCode  and B.RMCNT > @MaxCount

			----INSERT INTO SalesManToAvoid (SMCode,RMCODE)
			----Select Distinct A.SMCode,RMCode
			----From Cn2Cs_Prk_SalesManMaster A  (Nolock), #TempRMCount  B 
			----Where DownLoadFlag = 'D'  AND A.SMCode = B.SMCode  and B.RMCNT > @MaxCount

			Insert Into  Cn2Cs_Prk_SalesmanMaster_BK (DistCode,SMCode,SMName,SMPhoneNo,SMEmail,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,
													  SMMktCredit,SMCreditDays,Status,RMCode,RMName,DownLoadFlag,CreatedDate,
													  HHTDeviceSerialNumber,OldSmCode)
			Select Distinct DistCode,A.SMCode,SMName,SMPhoneNo,SMEmail,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,
													  SMMktCredit,SMCreditDays,Status,RMCode,RMName,DownLoadFlag,CreatedDate,
													  HHTDeviceSerialNumber,OldSmCode
			From Cn2Cs_Prk_SalesManMaster A  (Nolock), #TempRMCount  B 
			Where DownLoadFlag = 'D'  AND A.SMCode = B.SMCode  and B.RMCNT > @MaxCount

			Delete Cn2Cs_Prk_SalesManMaster  From  Cn2Cs_Prk_SalesManMaster A, #TempRMCount  B 
			Where DownLoadFlag = 'D'  AND A.SMCode = B.SMCode  and B.RMCNT > @MaxCount

		END 
	END 


	--INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	--SELECT SMCODE,RMCode FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE EXISTS(
	--SELECT SMCode FROM SalesMan B (NOLOCK) WHERE A.SMCode=B.SMCode)
	
	--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--SELECT DISTINCT 1,'Cn2Cs_Prk_SalesManMaster','SalesMan Code','SalesMan Code ' + SMCode + ' Already Available' 
	--FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE EXISTS(
	--SELECT SMCode FROM SalesMan B (NOLOCK) WHERE A.SMCode=B.SMCode)
	
	--INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	--SELECT A.SMCODE,A.RMCODE FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	--INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	--INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	--INNER JOIN SalesmanMarket D (NOLOCK) ON D.SMId=B.SMId AND D.RMId=C.RMId 
	
	--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--SELECT 1,'Cn2Cs_Prk_SalesManMaster','RM Code','SalesMan and SalesManMarket ' + A.SMCode + '+'+ A.RMCode +' Details Already Available' 
	--FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	--INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	--INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	--INNER JOIN SalesmanMarket D (NOLOCK) ON D.SMId=B.SMId AND D.RMId=C.RMId 
	
	SELECT @SMId = ISNULL(MAX(SMId),0) FROM SalesMan (NOLOCK)
	SET @SMId=ISNULL(@SMId,0)
	-- Added By Venkat. M PMS No :CRCRSTPAR0107
	SELECT A.*INTO #INSERT FROM Cn2Cs_Prk_SalesManMaster  A 
	WHERE NOT EXISTS (SELECT B.SMCode FROM Salesman B (NOLOCK) WHERE  A.SMCode <>B.SMCode AND A.OldSMCode =B.OldSmCode)
	AND SmCode NOT IN (SElECT SMCode FROM SalesManToAvoid)
	
	SELECT A.* INTO #UPDATE FROM Cn2Cs_Prk_SalesManMaster A 
	WHERE EXISTS (SELECT B.SMCode FROM Salesman B (NOLOCK) WHERE B.SMCode=B.OldSMCode AND A.OldSMCode=B.OldSMCode AND A.SMCode <>B.SMCode )
	AND SmCode NOT IN (SElECT SMCode FROM SalesManToAvoid) 
	
	IF EXISTS (SELECT * FROM #UPDATE)
	BEGIN
		UPDATE A SET A.SmCode =B .SMCode,A.Status =(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),WsUpload='N',A.HHTDeviceSerialNumber =B.HHTDeviceSerialNumber ,A.SMType=B.SMType
		FROM Salesman A(NOLOCK) INNER JOIN #UPDATE B ON A.OldSmCode=B.OldSmCode
		DELETE FROM SalesmanMarket WHERE SmId IN(SELECT SMID FROM Salesman S (NOLOCK) INNER JOIN #UPDATE B ON S.SmCode=B.SmCode)
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #UPDATE A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END
	IF EXISTS (SELECT * FROM #INSERT WHERE SMCode IN(SELECT SMCode FROM Salesman (NOLOCK)))
	BEGIN
		UPDATE A SET A.SMName  =B .SMName ,A.Status =(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),WsUpload='N',A.HHTDeviceSerialNumber =B.HHTDeviceSerialNumber ,A.SMType=B.SMType
		FROM Salesman A(NOLOCK) INNER JOIN #INSERT B ON A.OldSmCode=B.OldSmCode WHERE B.SMCode IN(SELECT SMCode FROM Salesman (NOLOCK))
		DELETE FROM SalesmanMarket WHERE SmId IN(SELECT SMID FROM Salesman S (NOLOCK) INNER JOIN #INSERT B ON S.SmCode=B.SmCode)
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #INSERT A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END
	
	DELETE FROM #INSERT WHERE SMCode IN(SELECT SMCode FROM Salesman (NOLOCK))
	
	IF EXISTS (SELECT * FROM #INSERT)
	BEGIN
		INSERT INTO SalesmanMasterTrack(SMCode,SMName,SMPhoneNo,SMEmail,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,
									SMMktCredit,SMCreditDays,Status,RMCode,RMName,CreateDate,HHTDeviceSerialNumber,OldSmCode,SMType)
		SELECT A.SMCode,A.SMName,A.SMPhoneNo,A.SMEmail,A.SMOtherDetails,A.SMDailyAllowance,A.SMMonthlySalary,
		A.SMMktCredit,A.SMCreditDays,A.Status,A.RMCode,A.RMName,GETDATE(),A.HHTDeviceSerialNumber,A.OldSmCode,A.SMType FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK)
		INNER JOIN #INSERT B ON A.SMCode =B.SMCode AND A.OldSmCode = B.OLdSmCode
		WHERE A.DownloadFlag='D' AND ISNULL(A.SMCODE,'')<>'' AND NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid B (NOLOCK) 
		WHERE A.SMCODE=B.SMCODE AND A.RMCODE=B.RMCODE) AND NOT EXISTS(SELECT SMCODE FROM Salesman D(NOLOCK) WHERE D.SMCode=A.SMCODE)
		
		INSERT INTO SalesMan(SMId,SMCode,SMName,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,
						SMCreditDays,CmpId,SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,UpLoad,
						Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,HHTDeviceSerialNumber,OldsmCode,SMType)
		SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY A.SMCODE,A.SMName)+@SMId) AS SMId,A.SMCode,A.SMName,ISNULL(A.SMPhoneNo,''),ISNULL(A.SMEmail,''),ISNULL(A.SMOtherDetails,''),ISNULL(A.SMDailyAllowance,0),
		ISNULL(A.SMMonthlySalary,0),isnull(A.SMMktCredit,0),ISNULL(A.SMCreditDays,0),0 AS CmpId,0 AS SalesForceMainId,(CASE UPPER(ISNULL(A.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),
		0,0,'N',1,1,GETDATE(),1,GETDATE(),0,ISNULL(A.HHTDeviceSerialNumber,''),A.OldSmcode,A.SMType
		FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK)  INNER JOIN #INSERT B ON A.SMCode =B.SMCode 
		AND A.OldSmCode = B.OLdSmCode WHERE A.DownloadFlag='D' AND ISNULL(A.SMCode ,'')<>'' AND  
		NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid B (NOLOCK) WHERE A.SMCODE=B.SMCODE AND A.RMCODE=B.RMCODE) AND 
		NOT EXISTS(SELECT SMCODE FROM Salesman D(NOLOCK) WHERE D.SMCode=A.SMCODE)
			
		SELECT @SMId = ISNULL(MAX(SMId),0) FROM SalesMan (NOLOCK)
		UPDATE Counters SET CurrValue = @SMId WHERE TabName = 'SalesMan' AND FldName = 'SMId'
			
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #INSERT A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END
	UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	LEFT OUTER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
	WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE) AND DownloadFlag='D' 
	
	RETURN
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_Salesman]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_Salesman]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_Salesman 0,'2021-01-30'
SELECT * FROM Cs2Cn_Prk_Salesman ORDER BY SlNo
SELECT * FROM Retailer
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cs2Cn_Salesman]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
SET NOCOUNT ON
BEGIN
/*********************************
* PROCEDURE		: Proc_Cs2Cn_Salesman
* PURPOSE		: To Extract Salesman Details from CoreStocky to upload to Console
* CREATED		: Nandakumar R.G
* CREATED DATE	: 22/06/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
***************************************************************************************************
* DATE       AUTHOR        CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
16-08-2018  Amuthakumar P   CR     CRCRSTPAR0016		  Returns Configuration for HHT Device Serial Number
25-06-2019  lakshman M      CR      CRCRSTPAR0066         In core stocky duplicate saleman for HHT Device Serial Number validated.
* 02-05-2020	MOHANA S	CR		PARCS202100009        All the route get upload to Console  
* 30-01-2021	Deepan  	CR		CRCRSTPAR0114        DayEnd Process Added
* 04/08/2021	Deepan		CR		PA-I31					Type included
***************************************************************************************************/ 
	DECLARE @DistCode	As nVarchar(50)
	DECLARE @Day AS VARCHAR(50)
      DECLARE @MaxCnt AS INT
      DECLARE @ChkDate AS DATETIME
      SET @ChkDate = ISNULL((SELECT ISNULL(NextUpDate,GETDATE()) FROM DayEndProcess WHERE ProcId = 24),GETDATE()-1)
	
		SET @Po_ErrNo=0
		DELETE FROM Cs2Cn_Prk_Salesman WHERE UploadFlag = 'Y'
		
		IF    CONVERT(VARCHAR(10),@ChkDate,121)<>CONVERT(VARCHAR(10),GETDATE(),121)
		BEGIN
			UPDATE Salesman SET UpLoad ='N'
			
			UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
			 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
			 Where ProcId = 24
			
		END
		IF EXISTS (SELECT * FROM Salesman WHERE UpLoad ='N')
		BEGIN
				UPDATE Salesman SET UpLoad ='N'
		END
	
		SELECT @DistCode = DistributorCode FROM Distributor
		INSERT INTO Cs2Cn_Prk_Salesman
		(
			DistCode,
			SMId,
			SMCode,
			SMName,
			SMPhoneNo,
			SMEmail,
			SMOtherDetails,
			SMDailyAllowance,
			SMMonthlySalary,
			SMMktCredit,
			SMCreditDays,
			Status,
			RMId,
			RMCode,
			RMName,
			UploadFlag,
			HHTDEVICESERIALNUMBER,
			SMType
		)
		SELECT
			@DistCode,
			SM.SMId,
			SM.SMCode,
			SM.SMName,
			SM.SMPhoneNumber,
			SM.SMEmailID,
			SM.SMOtherDetails,
			SM.SMDailyAllowance,
			SM.SMMonthlySalary,
			SM.SMMktCredit,
			SM.SMCreditDays,
			(CASE SM.Status WHEN 0 THEN 'InActive' ELSE 'Active' END) AS Status,
			ISNULL(SMR.RMId,0) AS RMId,
			ISNULL(RM.RMCode,'') AS RMCode,
			ISNULL(RM.RMName,'') AS RMName,
			'N'	As Uploadflag,
			SM.HHTDeviceSerialNumber,
			ISNULL(SM.SMType,'') AS SMType			
		FROM		
			Salesman SM LEFT OUTER JOIN  SalesmanMarket SMR
			ON SM.SMId=SMR.SMId
			LEFT OUTER JOIN  RouteMaster RM ON SMR.RMId=RM.RMId
		WHERE SM.Upload = 'N' 
	
		
		UPDATE Salesman SET Upload='Y' 	WHERE SMCode IN (SELECT SMCode FROM Cs2Cn_Prk_Salesman)
		UPDATE Cs2Cn_Prk_Salesman SET ServerDate=@ServerDate
	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Fn_FillRetailerDetailsinRetailerMaster]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [Fn_FillRetailerDetailsinRetailerMaster]
GO
CREATE FUNCTION [Fn_FillRetailerDetailsinRetailerMaster](@Pi_TransId INT,@Pi_LgnId INT)
RETURNS @FillRetailerDetails TABLE
(
RtrId	INT,
RtrCode	NVARCHAR(100),
RtrName	NVARCHAR(100),
RtrAdd1	NVARCHAR(100),
RtrAdd2	NVARCHAR(100),
RtrAdd3	NVARCHAR(100),
RtrPinNo	INT,
RtrPhoneNo	NVARCHAR(100),
RtrEmailId	NVARCHAR(100),
RtrContactPerson	NVARCHAR(100),
RtrKeyAcc	NVARCHAR(100),
RtrCovMode	NVARCHAR(100),
RtrRegDate	DATETIME,
RtrDepositAmt	NUMERIC(18,2),
RtrStatus	NVARCHAR(100),
RtrTaxable	NVARCHAR(100),
RtrTaxType	NVARCHAR(100),
TaxGroupName	NVARCHAR(100),
RtrTINNo	NVARCHAR(100),
RtrCSTNo	NVARCHAR(100),
RtrDayOff	NVARCHAR(100),
RtrCrBills	INT,
RtrCrLimit	NUMERIC(18,2),
RtrCrDays	INT,
RtrCashDiscPerc	NUMERIC(18,2),
RtrCashDiscCond	VARCHAR(50),
RtrCashDiscAmt	NUMERIC(18,2),
RtrLicNo	NVARCHAR(100),
RtrLicExpiryDate	DATETIME,
RtrDrugLicNo	NVARCHAR(100),
RtrDrugExpiryDate	DATETIME,
RtrPestLicNo	NVARCHAR(100),
RtrPestExpiryDate	DATETIME,
GeoMainId	INT,
GeoName	NVARCHAR(100),
GeoLevelName	NVARCHAR(100),
RmId	INT,
RMName	NVARCHAR(100),
VillageId	INT,
VillageName	NVARCHAR(100),
RtrShipId	INT,
RtrShipAdd1	NVARCHAR(100),
RtrShipAdd2	NVARCHAR(100),
RtrShipAdd3	NVARCHAR(100),
RtrShipPinNo	INT,
RtrResPhone1	NVARCHAR(100),
RtrResPhone2	NVARCHAR(100),
RtrOffPhone1	NVARCHAR(100),
RtrOffPhone2	NVARCHAR(100),
RtrDOB	DATETIME,
RtrAnniversary	DATETIME,
RtrRemark1	NVARCHAR(100),
RtrRemark2	NVARCHAR(100),
RtrRemark3	NVARCHAR(100),
COAId	INT,
OnAccount	NUMERIC(18,2),
TaxGroupId	INT,
RtrType	NVARCHAR(100),
RtrFrequency	TINYINT,
RtrCrBillsAlert	TINYINT,
RtrCrLimitAlert	TINYINT,
RtrCrDaysAlert	TINYINT,
RtrKeyId	TINYINT,
RtrCoverageId	TINYINT,
RtrStatusId	TINYINT,
RtrDayOffId	INT,
RtrTaxableId	TINYINT,
RtrTaxTypeId	TINYINT,
RtrTypeId	TINYINT,
RtrRlStatus	NVARCHAR(100),
RlStatus	TINYINT,
CmpRtrCode	NVARCHAR(100),
Upload	NVARCHAR(10),
RtrPayment NVARCHAR(100),
RtrPaymentId INT,
RtrApproval NVARCHAR(100),
RtrApprovalId INT,
RtrUniqueCode NVARCHAR(200), ---Gopi at 08/11/2016
RtrLandLine	NVARCHAR(100),
Reason	NVARCHAR(100),
RtrCodeUserInput NVARCHAR(100),
RetailerType	VARCHAR(50)	
)
AS
/*********************************
* PROCEDURE		: Fn_FillRetailerDetailsinRetailerMaster
* PURPOSE		:   
* CREATED		:  
* CREATED DATE	:  
* MODIFIED
*************************************************************************************************** 
* DATE				AUTHOR      CR/BZ       USER STORY ID       DESCRIPTION                           
***************************************************************************************************  
 17-07-2020	     Deepan			 CR          PARCS202100041      Retailer Details
 12-07-2021		 Mohana S		 CR			 PA-I9			Restricted Dummy Retailer
 04/08/2021		Deepan			 CR			 PA-I31			Retailer Type added	
**************************************************************************************************************************************/
BEGIN
	INSERT INTO @FillRetailerDetails (RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrContactPerson,RtrKeyAcc,
    RtrCovMode,RtrRegDate,RtrDepositAmt,RtrStatus,RtrTaxable,RtrTaxType,TaxGroupName,RtrTINNo,RtrCSTNo,RtrDayOff,RtrCrBills,RtrCrLimit,RtrCrDays,
    RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,RtrDrugLicNo,RtrDrugExpiryDate,RtrPestLicNo,RtrPestExpiryDate,GeoMainId,
    GeoName,GeoLevelName,RmId,RMName,VillageId,VillageName,RtrShipId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrResPhone1,RtrResPhone2,
    RtrOffPhone1,RtrOffPhone2,RtrDOB,RtrAnniversary,RtrRemark1,RtrRemark2,RtrRemark3,COAId,OnAccount,TaxGroupId,RtrType,RtrFrequency,RtrCrBillsAlert,
    RtrCrLimitAlert,RtrCrDaysAlert,RtrKeyId,RtrCoverageId,RtrStatusId,RtrDayOffId,RtrTaxableId,RtrTaxTypeId,RtrTypeId,RtrRlStatus,RlStatus,
    CmpRtrCode,Upload,RtrPayment,RtrPaymentId,RtrApproval,RtrApprovalId,RtrUniqueCode,RtrLandLine,Reason,RtrCodeUserInput,RetailerType)
    SELECT Rt.RtrId,Rt.RtrCode,Rt.RtrName,Rt.RtrAdd1,Rt.RtrAdd2,Rt.RtrAdd3,Rt.RtrPinNo,Rt.RtrPhoneNo,Rt.RtrEmailId,Rt.RtrContactPerson, 
	ISNULL(SD1.CtrlDesc,'') AS RtrKeyAcc, ISNULL(SD2.CtrlDesc,'') AS RtrCovMode,Rt.RtrRegDate,Rt.RtrDepositAmt,ISNULL(SD3.CtrlDesc,'') AS RtrStatus, 
	ISNULL(SD4.CtrlDesc,'') AS RtrTaxable, ISNULL(SD5.CtrlDesc,'') AS RtrTaxType,ISNULL(TG.TaxGroupName,'') AS  TaxGroupName,
	Rt.RtrTINNo,Rt.RtrCSTNo, ISNULL(SD6.CtrlDesc,'') AS RtrDayOff, Rt.RtrCrBills,Rt.RtrCrLimit,Rt.RtrCrDays, Rt.RtrCashDiscPerc,  
	(CASE Rt.RtrCashDiscCond WHEN 1 THEN '>=' WHEN 0 THEN '<=' End)As RtrCashDiscCond,Rt.RtrCashDiscAmt,
	Rt.RtrLicNo,Rt.RtrLicExpiryDate,Rt.RtrDrugLicNo,Rt.RtrDrugExpiryDate,Rt.RtrPestLicNo,Rt.RtrPestExpiryDate,
	GE.GeoMainId,GE.GeoName,Gl.GeoLevelName,Rm.RmId,Rm.RMName,Rv.VillageId,Rv.VillageName,Rs.RtrShipId,
	Rs.RtrShipAdd1,Rs.RtrShipAdd2,Rs.RtrShipAdd3,Rs.RtrShipPinNo,Rt.RtrResPhone1,Rt.RtrResPhone2,Rt.RtrOffPhone1,Rt.RtrOffPhone2,
	Rt.RtrDOB,Rt.RtrAnniversary,Rt.RtrRemark1,Rt.RtrRemark2,Rt.RtrRemark3
	,Rt.COAId ,Rt.RtrOnAcc as OnAccount,Rt.TaxGroupId,  ISNULL(SD7.CtrlDesc,'') AS RtrType, Rt.RtrFrequency , 
	Rt.RtrCrBillsAlert, Rt.RtrCrLimitAlert, Rt.RtrCrDaysAlert, Rt.RtrKeyAcc AS RtrKeyId,Rt.RtrCovMode AS RtrCoverageId,Rt.RtrStatus 
	AS RtrStatusId,Rt.RtrDayOff AS RtrDayOffId, Rt.RtrTaxable AS RtrTaxableId,Rt.RtrTaxType AS RtrTaxTypeId,Rt.RtrType AS RtrTypeId ,
	ISNULL(SD8.CtrlDesc,'') AS RtrRlStatus,ISNULL(Rt.RtrRlStatus,1) AS RlStatus,Rt.CmpRtrCode,Rt.Upload ,
	ISNULL(SD9.CtrlDesc,'') AS RtrPayment,Rt.RtrPayment AS RtrPayModeId,ISNULL(SD10.CtrlDesc,'') AS RtrApproval,
	Rt.Approved AS RtrApprovalId,ISNULL(Rt.RtrUniqueCode,'') AS RtrUniqueCode,ISNULL(Rt.RtrLandLine,'') AS RtrLandLine,
	ISNULL(Re.Description,'') AS Reason,ISNULL(Rt.RtrCodeUserInput,'') AS RtrCodeUserInput,ISNULL(Rt.RetailerType,'') AS RetailerType
	FROM GeographyLevel Gl,Retailer Rt  
	LEFT OUTER JOIN Geography Ge ON GE.GeoMainId=Rt.GeoMainId  
	LEFT OUTER JOIN RouteMaster Rm ON Rm.RMId=Rt.RMId  
	LEFT OUTER JOIN ReasonMaster Re ON Re.ReasonId=Rt.Reason
	LEFT OUTER JOIN RouteVillage Rv ON Rv.VillageId=Rt.VillageId  
	LEFT OUTER JOIN RetailerShipAdd Rs ON Rs.RtrShipId=Rt.RtrShipId  
	LEFT OUTER JOIN TaxGroupSetting TG ON TG.TaxGroupId=Rt.TaxGroupId  
	LEFT OUTER JOIN ScreenDefaultValues SD1 ON SD1.CtrlValue=Rt.RtrKeyAcc AND SD1.CtrlId=10 AND SD1.TransId=@Pi_TransId AND SD1.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD2 ON SD2.CtrlValue=Rt.RtrCovMode AND SD2.CtrlId=11 AND SD2.TransId=@Pi_TransId AND SD2.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD3 ON SD3.CtrlValue=Rt.RtrStatus AND SD3.CtrlId=14 AND SD3.TransId=@Pi_TransId AND SD3.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD4 ON SD4.CtrlValue=Rt.RtrTaxable AND SD4.CtrlId=18 AND SD4.TransId=@Pi_TransId AND SD4.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD5 ON SD5.CtrlValue=Rt.RtrTaxType AND SD5.CtrlId=19 AND SD5.TransId=@Pi_TransId AND SD5.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD6 ON SD6.CtrlValue=Rt.RtrDayOff AND SD6.CtrlId=13 AND SD6.TransId=@Pi_TransId AND SD6.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD7 ON SD7.CtrlValue=Rt.RtrType AND SD7.CtrlId=56 AND SD7.TransId=@Pi_TransId AND SD7.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD8 ON SD8.CtrlValue=Rt.RtrRlStatus AND SD8.CtrlId=135 AND SD8.TransId=@Pi_TransId AND SD8.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD9 ON SD9.CtrlValue=Rt.RtrPayment AND SD9.CtrlId=163 AND SD9.TransId=@Pi_TransId AND SD9.LngId=@Pi_LgnId 
	LEFT OUTER JOIN ScreenDefaultValues SD10 ON SD10.CtrlValue=Rt.Approved AND SD10.CtrlId=164 AND SD10.TransId=@Pi_TransId AND SD10.LngId=@Pi_LgnId 
	WHERE GE.GeoLevelId = Gl.GeoLevelId AND Rt.RtrCode NOT IN ('Dummy','SWR001','ZMR001')
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_CN2Cs_RetailerMasterDownload_New]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_CN2Cs_RetailerMasterDownload_New]
GO
/*
BEGIN TRAN
delete from errorlog
exec Proc_CN2Cs_RetailerMasterDownload_New 0
----select * from CN2Cs_Prk_RetailerMasterDownload
--select * from retailer -- where Rtrid >574
--select * from errorlog
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_CN2Cs_RetailerMasterDownload_New]
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : NG2Cs_Prk_RetailerMasterDownload  
* PURPOSE  : To Update RetailerMaster data.
* CREATED  : VENKAT. M PMS NO : ILCRSTCKL0147
* CREATED DATE : 25-01-2019  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* 23/09/2019  Kishore R			  ILCRSTPAR5992		 SR		   Retailer Download From Console		
* 13/11/2019  M Lakshman          ILCRSTPAR6671      SR        Due to Phone no & TIN no blank and max length validation has been removed in CS. 
* 18/07/2020  Murugan.R          PARCS202100043      CR        Retailer Code Auto Generate
* 28/01/2021  Venkat. M			 CRCRSTPAR0107		 CR			UDC NULL value validate change
* 04/08/2021	Deepan				PA-I31			 CR		   Type included

*********************************/  
SET NOCOUNT ON  
BEGIN  
 DECLARE @sSql   NVARCHAR(2000)  
 DECLARE @Taction    INT  
 DECLARE @ErrDesc    NVARCHAR(1000)  
 DECLARE @Tabname    NVARCHAR(50)  
 Declare @RtrCode  	varchar	(50) 
 Declare @RtrName  	varchar	(100) 
 Declare @RtrAddress1  	varchar	(100) 
 Declare @RtrAddress2  	varchar	(100)
 Declare @RtrAddress3  	varchar	(100) 
 Declare @CityName  	varchar	(100) 
 Declare @StateName  	varchar	(50)
 Declare @PostalCode  	varchar	(50) 
 Declare @RtrChannelCode  	varchar (50) 
 Declare @RtrGroupCode  	varchar (50) 
 Declare @RtrClassCode  	varchar	(50) 
 Declare @RtrKeyAcc  	varchar	(50) 
 Declare @RelationStatus 	nvarchar (100)
 Declare @ParentCode 	nvarchar (100)
 Declare @Status  	varchar	(50) 
 Declare @GeoLevel  	nvarchar	(100) 
 Declare @GeoLevelValue  	nvarchar	(200) 
 Declare @PhNumber  	varchar	(50) 
 Declare @ContactPerson  	varchar	(50)
 Declare @TinNumber  	varchar	(50) 
 Declare @TaxType  	varchar	(50) 
 Declare @RtrTaxGroup  	varchar	(50) 
 Declare @SalesRoute  	varchar	(50) 
 Declare @DeliveryRoute  	varchar	(50) 
 Declare @CashDisc  	numeric	(9, 2) 
 Declare @RtrCrLimit 	numeric	(18,2) 
 Declare @RtrCrDays  	int	 
 Declare @CSRtrType  	varchar	(50) 
 Declare @RegDate  	DateTime	 
 Declare @FrequencyMode  	varchar	(50) 
 Declare @Eligible  	int	       
 Declare @RetailerType  	varchar	(50) 
 Declare @Composition  	varchar	(50) 
 Declare @PANNumber  	varchar	(50) 
 Declare @GSTIN  	varchar	(50) 
 Declare @RelatedParty  	varchar	(50) 
 Declare @Latitude  	varchar	(50) 
	Declare @Longitude  	varchar	(50) 
	Declare @RtrUniqueCode  	varchar	(50)        
	Declare @Approved  	varchar	(50) 
	Declare @DownLoadFlag  	varchar	(10) 
	Declare @CreatedDate  	datetime	 
	Declare @RtrMobileNo  	varchar	(50) 
	DeClare @RtrCovMode as Int
	Declare @RtrDayOff as Int
	Declare @RtrTaxable as varchar(10)
	Declare @KeyAccId as Int
	   Declare @CtgClassMainId as Int
	   Declare @RtrClassId as Int
	   Declare @TaxGroupId as Int
	   Declare @RMID as Int
	   Declare @SRMID as Int	   
	   Declare @ApprovedId as Int
	   Declare @RTRFREQUENCYID as Int
	   Declare @CmpRtrCode as Varchar(50)
	   Declare @RtrId as Int
	   Declare @Pi_UserId as Int
	   Declare @DefultRMid as Int
	   Declare @DefultRMNAME as varchar(50)
	   DECLARE @GeoLevelId AS INT 
	   Declare @GeoMainId as Int	   
	   Declare @RelationStatusID as Int
	   Declare @RtrChildId as Int
	   Declare @RtrCashDiscPerc as numeric(18,2)
	   Declare @CoaId as Int
	   Declare @AcCode	as Nvarchar(100)
	   Declare @RtrType as varchar(50)
	   Declare @RtrTypeID as Int
	   Declare @RtrShipId as Int
	   	   
 DECLARE @Aadhaar		VARCHAR	(50) 
 DECLARE @TCSApplicable VARCHAR	(50) 
 DECLARE @TDSApplicable VARCHAR	(50) 
  DECLARE @RetType VARCHAR	(50) 


 SET @Taction=0 
 SET @Po_ErrNo=0  
 SET @Tabname = 'CN2Cs_Prk_RetailerMasterDownload'  
 SET @Pi_UserId=1  
 SET @GeoLevelId = 0
 SET @RtrChildId = 0
--RtrCode Auto Generate--PARCS202100043
DECLARE @AutoRtrCode AS NVARCHAR(200)
DECLARE @RtrCodeUserInput AS NVARCHAR(200)
DECLARE @AutoRtrCodeConfig AS TINYINT
SET @AutoRtrCodeConfig=0
IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
BEGIN
	SET @AutoRtrCodeConfig=1
END
truncate table ETL_Prk_UdcDetails
--Till Here--PARCS202100043
 DELETE FROM CN2Cs_Prk_RetailerMasterDownload WHERE DOWNLOADFLAG='Y'
 DECLARE Cur_RetailerMasterDownload_New CURSOR  
 FOR SELECT DISTINCT ISNULL(RtrCode,''),ISNULL(RtrName,''),ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),ISNULL(RtrAddress3,''),ISNULL(PostalCode,''),ISNULL(PhNumber,''),
 ISNULL(ContactPerson,''),ISNULL(RtrKeyAcc,''),1 AS RtrCovMode, ISNULL(RegDate,'1900-01-01'),0 AS RtrDayOff,ISNULL(Status,''),'Yes' as RtrTaxable,ISNULL(TaxType,''),
 ISNULL(TinNumber,''),ISNULL(GeoLevel,''),ISNULL(GeoLevelValue,''),ISNULL(DeliveryRoute,''),ISNULL(SalesRoute,''),
 ISNULL(CashDisc,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0)
 ,ISNULL(RtrTaxGroup,''),
 ISNULL(RtrMobileNo,''),ISNULL(FrequencyMode,''),ISNULL(RtrUniqueCode,''), ISNULL(Approved,''),ISNULL(RelationStatus,''),
 ISNULL(ParentCode,''),ISNULL(RtrGroupCode,''),ISNULL(RtrChannelCode,''),ISNULL(RtrClassCode,''),ISNULL(CSRtrType,''),
 ISNULL(Latitude,''),ISNULL(Longitude,''),ISNULL(StateName,''),ISNULL(RetailerType,''),ISNULL(Composition,''),
 ISNULL(PANNumber,''),ISNULL(GSTIN,''),ISNULL(RelatedParty,''),ISNULL(AaadharNo,''),ISNULL(TCSApplicable,'No'),ISNULL(TDSApplicable,'NA'),
 ISNULL(RtrType,'')		
 FROM CN2Cs_Prk_RetailerMasterDownload WHERE [DownLoadFlag] ='D' -- and CSRtrType='Sub Stockist' 
 OPEN Cur_RetailerMasterDownload_New  
 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable,@TDSApplicable,@RetType
 WHILE @@FETCH_STATUS=0  
 BEGIN  
		SET @Po_ErrNo=0  
		SET @Taction=0 
--		Delete from ETL_Prk_UdcDetails
		
		 --START--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RtrCode
		
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
						
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RtrCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END
				RETURN
			END	
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RtrCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		
		
		
					
		IF (LTRIM(RTRIM(@RtrCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'') 
		BEGIN  
			IF EXISTS (SELECT '*' FROM Retailer(NOLOCK) WHERE (RtrCode = @RtrCode 
			OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			)  
			BEGIN  
				SET @Taction=2  
			END  
			ELSE  
			BEGIN  
				SET @Taction=1  
			END  
		END  
		ELSE  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Code should not be empty '      
			INSERT INTO Errorlog VALUES (1,@Tabname,'RetailerCode',@ErrDesc)  
		END  
		IF LTRIM(RTRIM(@RtrName))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Name should not be empty'    
			INSERT INTO Errorlog VALUES (2,@Tabname,'RetailerName',@ErrDesc)  
		END
		IF LTRIM(RTRIM(@RtrAddress1))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Address  should not be empty'    
			INSERT INTO Errorlog VALUES (3,@Tabname,'Address',@ErrDesc)  
		END 		   
		--IF LTRIM(RTRIM(@PhNumber))=''
		--BEGIN
		--	SET @Po_ErrNo=1
		--	SET @Taction=0
		--	SET @ErrDesc = 'Ph Number should not be empty'		
		--	INSERT INTO Errorlog VALUES (4,@Tabname,'TINNumber',@ErrDesc)
		--END
		--ELSE
		--BEGIN
		--	IF LEN(@PhNumber)>12
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'Ph Number Maximum Length should be 12'		
		--		INSERT INTO Errorlog VALUES (5,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--END
		IF UPPER(LTRIM(RTRIM(@RtrKeyAcc)))=UPPER('Yes')  
		BEGIN  
			SET @KeyAccId=1   
		END 
		ELSE  
		BEGIN  
			SET	@KeyAccId=0
		END		
		IF UPPER(LTRIM(RTRIM(@Status)))=UPPER('ACTIVE')  
		--IF UPPER(LTRIM(RTRIM(@Status)))= 1  
		BEGIN  
			SET @Status=1   
		END  
		ELSE  
		BEGIN  
			SET @Status=0  
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (6,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT' OR LTRIM(RTRIM(@TaxType))='GST' 
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (7,@Tabname,'TaxType',@ErrDesc)
			END
		END
		--IF @TaxType='VAT'
		--BEGIN
		--	IF LTRIM(RTRIM(@TINNumber))=''
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'TIN Number should not be empty'		
		--		INSERT INTO Errorlog VALUES (8,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--	ELSE
		--	BEGIN
		--		IF LEN(@TINNumber)>11
		--		BEGIN
		--			SET @Po_ErrNo=1
		--			SET @Taction=0
		--			SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
		--			INSERT INTO Errorlog VALUES (9,@Tabname,'TINNumber',@ErrDesc)
		--		END
		--	END
		--END
		
		IF LTRIM(RTRIM(@RtrTaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM TaxGroupSetting(NOLOCK) WHERE RtrGroup = @RtrTaxGroup)
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @RtrTaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (10,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting(NOLOCK) WHERE RtrGroup = @RtrTaxGroup
			END
		END
		IF NOT EXISTS  (SELECT '*' FROM RouteMaster(NOLOCK) WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'      
			INSERT INTO Errorlog VALUES (11,@Tabname,'DeliveryRoute',@ErrDesc)  
		END  
		ELSE  
		BEGIN    
			SELECT @RMId =RMId FROM RouteMaster(NOLOCK) WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 
		END
		IF NOT EXISTS (SELECT '*' FROM SalesmanMarket A(NOLOCK) INNER JOIN Routemaster B(NOLOCK) ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute)  
		BEGIN  
		   SET @ErrDesc = 'Route Code:'+@SalesRoute+'does not Mapped Salesman'  
		   INSERT INTO Errorlog VALUES (12,@TabName,'Route Code',@ErrDesc)  
		   SET @Po_ErrNo=1  
		   
		END  
		ELSE  
		BEGIN  
			SELECT @SRMID =B.Rmid  FROM SalesmanMarket A(NOLOCK) INNER JOIN Routemaster B(NOLOCK) ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute    
		END 		
		IF LTRIM(RTRIM(@FrequencyMode))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency  should not be empty'		
			INSERT INTO Errorlog VALUES (13,@Tabname,'Retailer Frequency',@ErrDesc)
		END		
		IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Bi-Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Fort Nightly')  
		BEGIN  
			SET @RTRFREQUENCYID=2  
		END 
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Monthly')  
		BEGIN  
			SET @RTRFREQUENCYID=3  
		END
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Daily')  
		BEGIN  
			SET @RTRFREQUENCYID=4 
		END 
		IF ISNULL(@RtrUniqueCode,'')='' AND UPPER(ISNULL(@Approved,'PENDING'))='APPROVED'  
		BEGIN  
			SET @ErrDesc = 'Retailer Unique Code Mandatory for Approved retailers :'+@RtrCodeUserInput  
			INSERT INTO Errorlog VALUES (14,@TabName,'Retailer Unique Code',@ErrDesc)  
			SET @Po_ErrNo=1  
		END 
		
		IF @Approved = ''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Approved  should not be empty'		
			INSERT INTO Errorlog VALUES (24,@Tabname,'Approved',@ErrDesc)		
		END
		ELSE
		IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('PENDING')  
		BEGIN  
			SET @ApprovedId=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('APPROVED')  
		BEGIN  
			SET @ApprovedId=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('REJECTED')  
		BEGIN  
			SET @ApprovedId=2  
		END
		
		IF LTRIM(RTRIM(@RtrCrLimit))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrLimit)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Limit value Should be Number'    
				INSERT INTO Errorlog VALUES (15,@Tabname,'CreditLimit',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCrDays))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrDays)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Days value Should be Number'    
				INSERT INTO Errorlog VALUES (16,@Tabname,'CreditDays',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCashDiscPerc))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCashDiscPerc)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'    
				INSERT INTO Errorlog VALUES (17,@Tabname,'CashDiscountPercentage',@ErrDesc)  
			END  
		END  
		 
		IF NOT EXISTS  (SELECT '*' FROM GEOGRAPHYLEVEL(NOLOCK) WHERE GeoLevelName = @GeoLevel )  
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Geogrpahy Level: ' + @GeoLevel + ' is not available'      
			INSERT INTO Errorlog VALUES (18,@Tabname,'GEOGRAPHYLEVEL',@ErrDesc)				
		END
		ELSE
		BEGIN
			SELECT @GeoLevelId = GeoLevelId FROM GEOGRAPHYLEVEL(NOLOCK) WHERE GeoLevelName = @GeoLevel 
		END
		 
		IF @GeoLevelId <> 0 
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM Geography(NOLOCK) WHERE GeoName = @GeoLevelValue )  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Geogrpahy Code: ' + @GeoLevelValue + ' is not available'      
				INSERT INTO Errorlog VALUES (19,@Tabname,'GeographyHierarchyValue',@ErrDesc)  
			END  
			ELSE  
			BEGIN  
				SELECT @GeoMainId =GeoMainId FROM Geography(NOLOCK) WHERE GeoName = @GeoLevelValue  
			END	
		END
	
		IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Independent')
		BEGIN
			SET @RelationStatusID =1
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Parent')
		BEGIN
			SET @RelationStatusID =2
			IF UPPER(LTRIM(RTRIM(@ParentCode))) <> ''
			BEGIN			
				Select @RtrChildId = rtrid from Retailer (Nolock) where RtrCode = @ParentCode
			END
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Child')
		BEGIN
			SET @RelationStatusID =3 
		END
		
		IF UPPER(LTRIM(RTRIM(@RtrType)))=UPPER('Sub Stockist')
		BEGIN
			SET @RtrTypeID = 2
		END
		ELSE
		BEGIN
			SET @RtrTypeID = 1		
		END
	
		IF NOT EXISTS(SELECT '*' FROM RETAILERCATEGORY A (NOLOCK) 
		INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
		inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
		where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode)
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Category: ' + @RtrClassCode + ' is not available'      
			INSERT INTO Errorlog VALUES (20,@Tabname,'RETAILERCATEGORY',@ErrDesc)		 
		END
		ELSE
		BEGIN
			 SELECT @RtrClassId = RtrClassId FROM RETAILERCATEGORY A (NOLOCK)
			 INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
			 inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
			 where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode		 
		END
		SET @CmpRtrCode = ''			
		--IF @Po_ErrNo = 0 AND @Taction = 1
		--BEGIN
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger('Retailer','RtrId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @RtrShipId=dbo.Fn_GetPrimaryKeyInteger('retailershipadd','RtrShipId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster(NOLOCK) WHERE CoaId=(SELECT MAX(A.CoaId) 
			FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')  
			
			IF (SELECT Status FROM Configuration (NOLOCK) WHERE ModuleId='RET33' AND ModuleName='Retailer')=1  
			BEGIN     
				IF NOT EXISTS(SELECT '*' FROM Retailer(NOLOCK))  
				BEGIN  
					UPDATE A SET CurrValue = 0 from CompanyCounters A (NOLOCK) WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'   
				END  
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))     				
			END  
			ELSE  
			BEGIN  
				SET @CmpRtrCode=@RtrCode  
			END 	
			IF @CmpRtrCode=''  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Company Retailer Code should not be empty'    
				INSERT INTO Errorlog VALUES (21,@Tabname,'Counter Value',@ErrDesc)  
			END  
			IF @RtrId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (22,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @RtrShipId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (23,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @StateName = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Sate name Should not be Empty '    
				INSERT INTO Errorlog VALUES (25,@Tabname,'Sate name',@ErrDesc) 			
			
			END
			IF @RetailerType = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer Type Should not be Empty '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer Type',@ErrDesc) 			
			
			END
			ELSE
			BEGIN
				IF Upper(@RetailerType) = 'REGISTERED'
				BEGIN
					IF UPPER(@Composition) NOT IN('YES','NO','')
					BEGIN
						SET @Po_ErrNo=1    
						SET @Taction=0  
						SET @ErrDesc = 'REGISTERED Retailer Composition Should not be Empty OR either Yes / No'    
						INSERT INTO Errorlog VALUES (27,@Tabname,'Composition',@ErrDesc) 			
					
					END
				END
			END	
			IF UPPER(@RelatedParty) NOT IN('YES','NO')
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer PARTY Should not be yes / No '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer PARTY',@ErrDesc) 			
			
			END		
			
			IF UPPER(@TDSApplicable) NOT IN ('LESSTHAN 50L','WITHOUT PAN','NA')
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'TDS Should be  LESSTHAN 50L/WITHOUT PAN/NA'    
				INSERT INTO Errorlog VALUES (26,@Tabname,'TDS Applicable',@ErrDesc) 				
			END		
		

			IF ((UPPER(@TCSApplicable) = 'YES') AND (UPPER(@TDSApplicable)  IN ('LESSTHAN 50L','WITHOUT PAN')))
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Both TDS & TCS Should NOT YES'    
				INSERT INTO Errorlog VALUES (26,@Tabname,'TCS & TDS Applicable',@ErrDesc) 				
			END		
		
		IF @Po_ErrNo = 0 AND @Taction = 1
		BEGIN			
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrContactPerson,RtrKeyAcc,
			RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrDepositAmt,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrOffPhone2,RtrDOB,
			RtrAnniversary,RtrRemark1,CoaId,RtrOnAcc,RtrType,RtrFrequency,RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,
			RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,Approved,XMLUpload,RtrPayment,RtrUniqueCode,
			WSUpload,RtrCodeUserInput,RetailerType)
			
			SELECT @RtrId,@RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
			@ContactPerson,@KeyAccId,@RtrCovMode,@RegDate,@RtrDayOff,@Status,(CASE UPPER(@RtrTaxable) WHEN 'YES' THEN 1 ELSE 0 END) RtrTaxable,
			(CASE @TaxType WHEN 'VAT' THEN 0 WHEN 'GST' THEN 2 ELSE 1 END) TaxType
			,@TinNumber,0 RtrDepositAmt,0 RtrCrBills,@RtrCrLimit,@RtrCrDays,@RtrCashDiscPerc,1 RtrCashDiscCond,0 RtrCashDiscAmt,
			@GeoMainId,@RMId,0 VillageId,@RtrShipId,@TaxGroupId,@RtrMobileNo,@RegDate,@RegDate,'Downloaded Retailer',@CoaId,0 RtrOnAcc,
			@RtrTypeID,@RTRFREQUENCYID,0 RtrCrBillsAlert,0 RtrCrLimitAlert,0 RtrCrDaysAlert,'N' Upload,@RelationStatusID,
			1,@Pi_UserId,GETDATE(),@Pi_UserId,GETDATE(),@CmpRtrCode,@ApprovedId,0 XMLUpload,1 RtrPayment,@RtrUniqueCode,
			'N' WSUpload,@RtrCodeUserInput,@RetType
			
			IF EXISTS (SELECT '*' FROM Retailer(NOLOCK) WHERE RtrId=@RtrId)  
			BEGIN  
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RtrName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),
				GETDATE(),121))  
			 			
				INSERT INTO RETAILERMARKET(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
				SELECT @Rtrid,@SRMID,1,1,GETDATE(),1,GETDATE(),0
				
				INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121))
				
				IF ISNULL(@RtrChildId,0) <> 0
				BEGIN
					INSERT INTO Retailerrelation(RtrId,RtrChildId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					Select @RtrId,@RtrChildId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
					CONVERT(NVARCHAR(10),GETDATE(),121)
				END
								
				INSERT INTO Retailershipadd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,
				RtrShipDefaultAdd,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxGroupId,StateId,GSTTinNo,Upload)
				SELECT @RtrShipId,@RtrId,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,1,1,@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@TaxGroupId,0,'','N'
					
				INSERT INTO ETL_Prk_UdcDetails
				SELECT 'Retailer Master','Latitude', @RtrCode,(CASE @Latitude WHEN '' THEN '0' ELSE @Latitude END) UNION ALL								
				SELECT 'Retailer Master','Longitude', @RtrCode,(CASE @Longitude WHEN '' THEN '0' ELSE @Longitude END) UNION ALL
				SELECT 'Retailer Master','State Name', @RtrCode,@StateName  UNION ALL
				SELECT 'Retailer Master','Retailer Type', @RtrCode,@RetailerType UNION ALL				
				SELECT 'Retailer Master','Composition', @RtrCode,(CASE @Composition WHEN '' THEN 'NA' ELSE @Composition END) UNION ALL
				SELECT 'Retailer Master','PAN Number', @RtrCode,(CASE @PANNumber WHEN '' THEN '0' ELSE @PANNumber END) UNION ALL
				SELECT 'Retailer Master','GSTIN', @RtrCode,(CASE @GSTIN WHEN '' THEN '0' ELSE @GSTIN END) UNION ALL
				SELECT 'Retailer Master','Related Party', @RtrCode,(CASE @RelatedParty WHEN '' THEN 'NO' ELSE @RelatedParty END) UNION ALL
				SELECT 'Retailer Master','Aadhaar', @RtrCode,@Aadhaar UNION ALL
				SELECT 'Retailer Master','TCS Applicable', @RtrCode,(CASE WHEN @TCSApplicable='Yes' THEN 'Yes' ELSE 'No' END) UNION ALL
				SELECT 'Retailer Master','TDS Applicable', @RtrCode,(CASE WHEN @TDSApplicable='Yes' THEN 'Yes' ELSE 'No' END)
				
				
				
				UPDATE A  SET CurrValue = CurrValue+1 FROM Counters A (NOLOCK) WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'  
				UPDATE A  SET CurrValue = CurrValue+1 FROM Counters A (NOLOCK)  WHERE Tabname =  'retailershipadd' AND Fldname = 'RtrShipId'  
				UPDATE A SET CurrValue = CurrValue+1  FROM companycounters A (NOLOCK) WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'  
				UPDATE A SET CurrValue = CurrValue+1  FROM Counters A (NOLOCK) WHERE Tabname =  'Retailer' AND Fldname = 'RtrId'
				--RtrCode Auto Generate
				IF @AutoRtrCodeConfig=1
				BEGIN
					UPDATE A SET CurrValue = CurrValue+1 FROM Counters A (NOLOCK)  WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				END
				--Till Here
				
			END		  		  
		END
	 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
	 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
	 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
	 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
	 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
	 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable,@TDSApplicable,@RetType
 END  
 CLOSE Cur_RetailerMasterDownload_New  
 DEALLOCATE Cur_RetailerMasterDownload_New  
	IF EXISTS(SELECT * FROM ETL_Prk_UdcDetails(NOLOCK))
	BEGIN
		EXEC Proc_ValidateUdcDetails 0
	END
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCode=C.RtrCODE 
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCodeUserInput=C.RtrCODE
 RETURN  
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_RetailerReDownload]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_RetailerReDownload]
GO
/*
BEGIN TRAN
DELETE FROM ERRORLOG
--EXEC Proc_CN2CS_RouteMaster 0
--EXEC Proc_CN2CS_SalesManMaster 0
EXEC Proc_Cn2Cs_RetailerReDownload 0
SELECT * FROM Retailer 
select * from RetailerMarket where rtrid =1314
SELECT * FROM ERRORLOG
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_Cn2Cs_RetailerReDownload]
(
	@Po_ErrNo	INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMigration
* PURPOSE		: To validate and update records from parking table to main table
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 09-08-2019  M.Lakshman  SR     ILCRSTPAR5462       New route updated validation included.
 20-07-2020	  Deepan     CR     PARCS202100041      USER INPUT and Reason added
 30-10-2020  Deepak Philip  BZ  PARLECS/0221/375   RetailerMarket deletion validation added.
*********************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @MasterId INT
	DECLARE @UDCMasterId INT
	DECLARE @RtrId INT
	DECLARE @RtrShipAddId INT
	DECLARE @UdcCurrMasterId INT
	DECLARE @UdcCurrUniqueID INT	
	DECLARE @CoaID INT
	DECLARE @AccCode VARCHAR(200)
	DECLARE @AutoRtrCode AS NVARCHAR(200)
    DECLARE @RtrCode  	varchar	(50) 
	DECLARE @RtrCodeUserInput AS NVARCHAR(200)
	DECLARE @AutoRtrCodeConfig AS TINYINT
	SET @AutoRtrCodeConfig=0
	IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
		BEGIN
			SET @AutoRtrCodeConfig=1
		END	
	
	BEGIN TRY
			
		
		SET @Po_ErrNo = 0
		SELECT @RtrId = CurrValue From Counters WHERE TabName = 'Retailer' AND FldName = 'RtrId'
		SELECT @RtrShipAddId = CurrValue From Counters WHERE TabName = 'RetailerShipAdd'
		SELECT @UdcCurrMasterId = CurrValue From Counters WHERE TabName = 'UDCDetails' AND FldName = 'UdcDetailsId'
		SELECT @UdcCurrUniqueID = CurrValue From Counters WHERE TabName = 'UDCDetails' AND FldName = 'UDCUniqueId'		
		SELECT @CoaID = CurrValue From Counters WHERE TabName = 'CoaMaster'
		SELECT @AccCode = MAX(AcCode) From COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%'
		
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		
		
		--IF (@AutoRtrCodeConfig=1)
		--BEGIN		
		--	SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
		--	WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
		--	WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
		--	WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
		--	WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
		--	WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
		--	FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
						
		--	IF LEN(ISNULL(@AutoRtrCode,''))>0
		--	BEGIN
		--		SET @RtrCode=@AutoRtrCode				
		--	END
		--	ELSE
		--	BEGIN
		--		RETURN
		--	END	
		--END
		DELETE FROM Cn2Cs_Prk_RetailerReDownload WHERE DownloadFlag = 'Y'
		
		CREATE TABLE #TempMigrateRetailer
			(
				[RetailerCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[CmpRtrCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RetailerName] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress1] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress2] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress3] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrPinNo] [int] NULL,
				[RtrChannelCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrGroupCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrClassCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[KeyAccount] [nvarchar](20) COLLATE DATABASE_DEFAULT,
				[RelationStatus] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[ParentCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrRegDate] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrStatus] [int]NULL,
				[Approved] [varchar](10) NULL,
				[SalesRoute] [nvarchar](50) COLLATE DATABASE_DEFAULT,
				[DeliveryRoute] [nvarchar](50) COLLATE DATABASE_DEFAULT,
				[RtrType] [varchar](100) NULL,
				[RtrTINNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrCrBills] [int] NULL,
				[RtrCrLimit] [numeric](38, 6) NULL,
				[RtrCrDays] [int] NULL,
				[RtrDayOff] [int] NULL,
				[RtrCSTNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrPhoneNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrContactPerson] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrTaxGroup] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrTaxable] [varchar](1) NULL,
				[RtrUniqueCode]	[nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd1] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd2] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd3] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrLandLine] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[ReasonCode]  [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrCodeUserInput] [nvarchar](150) COLLATE DATABASE_DEFAULT,
				[DownloadFlag] [varchar](1) NULL,
				RetailerType [varchar](50) NULL
			)
	
			DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_RetailerReDownload'
			
			--Find Duplicate Retailers From Download
			SELECT PR.RetailerCode INTO #ParkingDuplicateRetailers 
			FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
			WHERE DownloadFlag = 'D' GROUP BY PR.RetailerCode
			HAVING COUNT(7)>1
			SELECT PR.RtrCodeUserInput INTO #ParkingDuplicateUserInput
			FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
			WHERE DownloadFlag = 'D' AND (PR.RtrCodeUserInput IN(SELECT RTRCODEUSERINPUT FROM RETAILER) OR PR.RtrCodeUserInput IN(SELECT RTRCODE FROM RETAILER))
		
			
			SELECT Row_Number() OVER(Order By RetailerCode,CmpRtrCode) RowNo,RetailerCode,CmpRtrCode 
			INTO #DuplicateRetailers
			FROM 
			(
				SELECT PR.RetailerCode,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateRetailers D ON PR.RetailerCode = D.RetailerCode
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RetailerCode,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RetailerCode = R.RtrCode
				WHERE DownloadFlag = 'D'
			) A
			
			--Find Duplicate Retailers From Download			
			SELECT Row_Number() OVER(Order By RetailerCode,RtrUniqueCode) RowNo,RetailerCode,RtrUniqueCode 
			INTO #DuplicateRetailers1
			FROM 
			(
				SELECT PR.RetailerCode,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateRetailers D ON PR.RetailerCode = D.RetailerCode
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RetailerCode,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RetailerCode = R.RtrCode
				WHERE DownloadFlag = 'D'
			) A
			SELECT Row_Number() OVER(Order By RtrCodeUserInput,CmpRtrCode) RowNo,RtrCodeUserInput,CmpRtrCode 
			INTO #DuplicateRetUserInput
			FROM 
			(
				SELECT PR.RtrCodeUserInput,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateUserInput D ON PR.RtrCodeUserInput = D.RtrCodeUserInput
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RtrCodeUserInput,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RtrCodeUserInput = R.RtrCodeUserInput
				WHERE DownloadFlag = 'D'
			) A
			
			--Find Duplicate Retailers From Download			
			SELECT Row_Number() OVER(Order By RtrCodeUserInput,RtrUniqueCode) RowNo,RtrCodeUserInput,RtrUniqueCode 
			INTO #DuplicateRetUserInput1
			FROM 
			(
				SELECT PR.RtrCodeUserInput,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateUserInput D ON PR.RtrCodeUserInput = D.RtrCodeUserInput
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RtrCodeUserInput,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RtrCodeUserInput = R.RtrCodeUserInput
				WHERE DownloadFlag = 'D'
			) A
						
			--Delete Duplicate Retailers in Temp Table WHILE RtrStatus=1
			--DELETE D FROM #DuplicateRetailers D  (NOLOCK) 
			--INNER JOIN Retailer R (NOLOCK) ON D.RetailerCode = R.RtrCode AND D.CmpRtrCode = R.CmpRtrCode
			--WHERE R.RtrStatus = 1  --Approved=1
			
			--IF EXISTS (SELECT 7 FROM #DuplicateRetailers)
			--BEGIN
			
			--	SELECT RtrCode INTO #ExistingRtrCode FROM
			--	(
			--		SELECT RetailerCode AS RtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) WHERE DownloadFlag = 'D'
			--		UNION
			--		SELECT RtrCode  FROM Retailer R (NOLOCK)
			--	)X
			--	DECLARE @CntOfDuplicate AS INTEGER
			--	DECLARE @CurrentNo AS NVARCHAR(3)
			--	DECLARE @Counter AS NVARCHAR(6)
			--	DECLARE @RtrFlag AS TINYINT
			--	DECLARE @RetailerCode AS NVARCHAR(200)
			--	DECLARE @FreshRtrCode AS NVARCHAR(200)
			--	SET @CntOfDuplicate = 0
			--	SET @CurrentNo = 1
				
			--	--Duplicate Retailer Count
			--	SELECT @CntOfDuplicate = COUNT(7) FROM #DuplicateRetailers (NOLOCK)
			--	WHILE (@CntOfDuplicate >= @CurrentNo)
			--	BEGIN
			--		SET @RtrFlag = 0
			--		SET @Counter = 1
					
			--		SELECT @RetailerCode = RetailerCode FROM #DuplicateRetailers (NOLOCK) WHERE RowNo = @CurrentNo
					
			--		WHILE (@RtrFlag = 0)
			--		BEGIN
										
			--			SET @FreshRtrCode = 'M'+@Counter+@RetailerCode
						
			--			IF NOT EXISTS(SELECT 7 FROM #ExistingRtrCode E (NOLOCK) WHERE RtrCode = @FreshRtrCode)
			--			BEGIN
						
			--				UPDATE D SET RetailerCode = @FreshRtrCode FROM #DuplicateRetailers D (NOLOCK) WHERE RowNo = @CurrentNo
							
			--				INSERT INTO #ExistingRtrCode
			--				SELECT @FreshRtrCode
							
			--				SET @RtrFlag = 1			
			--			END
			--			ELSE
			--			BEGIN
			--				SET @Counter = @Counter + 1
			--			END						
			--		 END
					 					 
			--		 SET @CurrentNo = @CurrentNo + 1	
			--	 END
			
			--	UPDATE P SET P.RetailerCode = D.RetailerCode
			--	FROM #DuplicateRetailers D (NOLOCK) INNER JOIN Cn2Cs_Prk_RetailerReDownload P (NOLOCK) 
			--	ON P.CmpRtrCode = D.CmpRtrCode WHERE DownloadFlag = 'D'	
			--END
			--Till Here
			
			
			INSERT INTO #TempMigrateRetailer (RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,RtrLandLine,ReasonCode,RtrCodeUserInput,RetailerType)
			SELECT DISTINCT RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,RtrLandLine,ReasonCode,RtrCodeUserInput,RetailerType
			FROM Cn2Cs_Prk_RetailerReDownload A WITH (NOLOCK)  WHERE DownLoadFlag = 'D'
			AND NOT EXISTS(SELECT RetailerCode,CmpRtrCode FROM #DuplicateRetailers B WHERE A.RetailerCode=B.RetailerCode and A.CmpRtrCode=B.CmpRtrCode)	
			AND NOT EXISTS(SELECT RetailerCode,RtrUniqueCode FROM #DuplicateRetailers1 C WHERE A.RetailerCode=C.RetailerCode and A.RtrUniqueCode=C.RtrUniqueCode)	
			AND NOT EXISTS(SELECT RtrCodeUserInput,CmpRtrCode FROM #DuplicateRetUserInput D WHERE A.RtrCodeUserInput=D.RtrCodeUserInput and A.CmpRtrCode=D.CmpRtrCode)	
			AND NOT EXISTS(SELECT RtrCodeUserInput,RtrUniqueCode FROM #DuplicateRetUserInput1 E WHERE A.RtrCodeUserInput=E.RtrCodeUserInput and A.RtrUniqueCode=E.RtrUniqueCode)
			SELECT DISTINCT RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,RtrLandLine,ReasonCode,RtrCodeUserInput,RetailerType
			INTO #TempMigrateRetailerExisting FROM Cn2Cs_Prk_RetailerReDownload A WITH (NOLOCK)  WHERE DownLoadFlag = 'D'
			AND  EXISTS(SELECT RetailerCode,CmpRtrCode FROM #DuplicateRetailers B WHERE A.RetailerCode=B.RetailerCode and A.CmpRtrCode=B.CmpRtrCode)	
			AND EXISTS(SELECT RetailerCode,RtrUniqueCode FROM #DuplicateRetailers1 C WHERE A.RetailerCode=C.RetailerCode and A.RtrUniqueCode=C.RtrUniqueCode)	
			AND  EXISTS(SELECT RtrCodeUserInput,CmpRtrCode FROM #DuplicateRetUserInput D WHERE A.RtrCodeUserInput=D.RtrCodeUserInput and A.CmpRtrCode=D.CmpRtrCode)	
			AND  EXISTS(SELECT RtrCodeUserInput,RtrUniqueCode FROM #DuplicateRetUserInput1 E WHERE A.RtrCodeUserInput=E.RtrCodeUserInput and A.RtrUniqueCode=E.RtrUniqueCode)
	
			--Check Cmp Retailer Code --> Join Check RtrCode?
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'RetailerMigration','CmpRtrCode','Retailer '+B.CmpRtrCode+' Already Exists' FROM Retailer A (NOLOCK)  
			INNER JOIN #TempMigrateRetailer B (NOLOCK) ON A.CmpRtrCode = B.CmpRtrCode AND A.RtrCode = B.RetailerCode 			
			
			DELETE B FROM Retailer A
			INNER JOIN #TempMigrateRetailer B ON A.CmpRtrCode = B.CmpRtrCode AND A.RtrCode = B.RetailerCode	
			
			--Retailer Code Length
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode','Retailer Code '+RetailerCode+' Maximum Length should be 25' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RetailerCode)))>25
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RetailerCode)))>25
			
			--Retailer Code Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode','Company Retailer Code for '+RetailerCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RetailerCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RetailerCode)))<=0
			
			--Company Retailer Code Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','Company RetailerCode','Company Retailer Code for '+CmpRtrCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(CmpRtrCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(CmpRtrCode)))<=0
			
			
			--RtrUniqueCode Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','Company RetailerCode','Retailer Unique Code for '+RtrUniqueCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RtrUniqueCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RtrUniqueCode)))<=0
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode',' Retailer Code for '+RtrCodeUserInput+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RtrCodeUserInput)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RtrCodeUserInput)))<=0
				INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode','Retailer Code '+RtrCodeUserInput+' Maximum Length should be 25' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RtrCodeUserInput)))>25
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RtrCodeUserInput)))>25
			
			--Retailer Category CHANNEL
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Category Code '+RtrChannelCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel  C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrChannelCode=B.CtgCode AND UPPER(C.CtgLevelName)='CHANNEL') 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel C  (NOLOCK)ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrChannelCode=B.CtgCode AND UPPER(C.CtgLevelName)='CHANNEL') 
			
			--Retailer Category GROUP
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Group Code '+RtrGroupCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrGroupCode=B.CtgCode AND UPPER(C.CtgLevelName)='GROUP') 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel  C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrGroupCode=B.CtgCode AND UPPER(C.CtgLevelName)='GROUP')
						
			--Retailer Value Class
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Value Class Code '+RtrClassCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT ValueClassCode FROM RetailerValueClass B (NOLOCK) 			
			WHERE A.RtrClassCode=B.ValueClassCode) 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT ValueClassCode FROM RetailerValueClass B (NOLOCK) 			
			WHERE A.RtrClassCode=B.ValueClassCode)  
			
			--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			--SELECT 9,'Retailer','MigrateDate','Migrate Date for '+CmpRtrCode+' is mandatory for Migrated/Restored retailers' 
			--FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(MigrateDate)))<=0 
			--DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(MigrateDate)))<=0 
			
			--Sales Route Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 10,'Retailer','RmCode','Sales Route for '+CmpRtrCode+' is mandatory for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(SalesRoute)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(SalesRoute)))<=0
			
			--Delivery Route Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 11,'Retailer','DRmCode','Delivery Route for '+CmpRtrCode+' is mandatory for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(DeliveryRoute)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(DeliveryRoute)))<=0
			
			--Sales Route --> Route Master
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 12,'Retailer','RmCode','Sales Route for '+CmpRtrCode+' does not exists for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE SalesRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1 AND RMSRouteType = 1) 
			
			DELETE FROM #TempMigrateRetailer WHERE SalesRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1 AND RMSRouteType = 1)
			
			--Delivery Route -->Route Master
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 13,'Retailer','DRmCode','Delivery Route for '+CmpRtrCode+' does not exists for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE DeliveryRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1) 
			
			DELETE FROM #TempMigrateRetailer WHERE DeliveryRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1)	
			--Take Geography Details
			CREATE TABLE #Geography
			(
				RtrCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				RmId			INT,
				RmCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
				GeoMainid		INT,
				GeoLevelId		INT,
				GeoName			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				GeoLevelName	NVARCHAR(200) COLLATE DATABASE_DEFAULT
			)
			
			INSERT INTO #Geography (RtrCode,RmId,RmCode,GeoMainid,GeoLevelId,GeoName,GeoLevelName)
			SELECT DISTINCT A.RetailerCode,R.RMId,R.RMCode,B.GeoMainId,C.GeoLevelId,B.GeoName,C.GeoLevelName 
			FROM #TempMigrateRetailer A (NOLOCK)
				INNER JOIN RouteMaster R (NOLOCK) ON A.SalesRoute=R.RMCode
				INNER JOIN Geography B (NOLOCK) ON R.GeoMainId=B.GeoMainId AND RMSRouteType=1
				INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId
			
			
			--Take Delivery Route
			CREATE TABLE #DeliveryRoute
			(
				RtrCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				RmId			INT,
				RmCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT
			)
			
			INSERT INTO #DeliveryRoute (RtrCode,RmId,RmCode)
			SELECT DISTINCT A.RetailerCode,R.RMId,R.RMCode
			FROM #TempMigrateRetailer A (NOLOCK)
				INNER JOIN RouteMaster R (NOLOCK) ON A.DeliveryRoute=R.RMCode AND RMSRouteType=2
				
			SET @RtrId=ISNULL(@RtrId,0)
			
			
						
			----(CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Hub' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END)
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrContactPerson,
			RtrKeyAcc,RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,RtrDepositAmt,
			RtrCrBills,RtrCrLimit,RtrCrDays,RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,
			RtrDrugLicNo,RtrDrugExpiryDate,RtrPestLicNo,RtrPestExpiryDate,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrResPhone1,
			RtrResPhone2,RtrOffPhone1,RtrOffPhone2,RtrDOB,RtrAnniversary,RtrRemark1,RtrRemark2,RtrRemark3,CoaId,RtrOnAcc,RtrType,RtrFrequency,
			RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,
			Approved,XMLUpload,RtrPayment,RtrUniqueCode,RtrLandLine,Reason,RtrCodeUserInput,RetailerType)
			SELECT @RtrId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),
			RetailerCode ,RetailerName,ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),
			ISNULL(RtrAddress3,''),ISNULL(RtrPinNo,''),ISNULL(RtrPhoneNo,''),'' AS RtrEmailId,ISNULL(RtrContactPerson,''),
			(CASE ISNULL(KeyAccount,'NO') WHEN 'NO' THEN 0 ELSE 1 END) AS KeyAccount,
			1,CONVERT(VARCHAR(10),CAST(RtrRegDate as datetime),121),ISNULL(RtrDayOff,0),ISNULL(RtrStatus,1),(CASE ISNULL(RtrTaxable,'Y') WHEN 'Y' THEN 1 ELSE 1 END) AS RtrTaxable,
			(CASE ISNULL(RtrTINNo,'') WHEN '' THEN 1 ELSE 0 END) AS RtrTaxType,ISNULL(RtrTINNo,'') AS RtrTINNo,ISNULL(RtrCSTNo,'') AS RtrCSTNo,0,ISNULL(RtrCrBills,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0),
			0,0,0,'','','','','','',ISNULL(#Geography.GeoMainid,0),ISNULL(#DeliveryRoute.RmId,0),0 VillageId,0 RtrShipId,0 TaxGroupId,'',
			'','','',GETDATE(),GETDATE(),'','','',0 AS CoaId,0,CASE RtrType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN  2 WHEN  'Hub' THEN 3 WHEN 'Spoke'  THEN  3 ELSE 0 END as RtrType,0, --ISNULL(RtrType,1),0,
			0,0,0,'N',CASE ISNULL(RelationStatus,'INDEPENDENT') WHEN 'PARENT' THEN 2 WHEN 'CHILD' THEN 3  ELSE 1 END AS RelationStatus,
						1,1,GETDATE(),1,GETDATE(),CmpRtrCode,CASE ISNULL(Approved,'APPROVED') WHEN 'APPROVED' THEN 1 WHEN 'PENDING' THEN 0  ELSE 2 END Approved,0,1,RtrUniqueCode,RtrLandLine,RE.ReasonId,RtrCodeUserInput,RetailerType
			 FROM #TempMigrateRetailer A (NOLOCK)
			 LEFT OUTER JOIN ReasonMaster RE(NOLOCK) ON RE.ReasonCode=A.ReasonCode
			LEFT OUTER JOIN #Geography ON A.RetailerCode =#Geography.RtrCode AND A.SalesRoute=#Geography.RmCode
			INNER JOIN #DeliveryRoute ON A.RetailerCode = #DeliveryRoute.RtrCode
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0
			
			
			DECLARE @TrackID as BIGINT			
			SELECT @TrackID=MAX(ISNULL(TrackID,0)) FROM RetailerReDownloadTracking
			
			INSERT INTO RetailerReDownloadTracking (TrackID,RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,CreatedDate,RtrLandLine,ReasonCode,RtrCodeUserInput,RetailerType)
			SELECT DISTINCT ISNULL(@TrackID,0)+1,RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,GETDATE(),RtrLandLine,ReasonCode,RtrCodeUserInput,RetailerType
			FROM #TempMigrateRetailer 
			
			--------------Added By lakshman M Dated ON 09082019 PMS ID: ILCRSTPAR5462  (Retailer Market Old Route Bakup and New route updating.) ---------------- 
			INSERT INTO RetailerMarketOldRouteTrack (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload,LastRouteRemoveddate)
			SELECT Distinct  A.*,GETDATE() FROM retailermarket A INNER JOIN Retailer B ON A.Rtrid =b.rtrid 
			--left outer JOin RouteMaster C ON A.Rmid =C.Rmid 
			INNER JOIN #TempMigrateRetailerExisting D ON B.rtrCode =D.RetailerCode 
			inner join RouteMaster C ON C.RmCode =D.SalesRoute AND  EXISTS (SELECT * FROM Retailermarket R WHERE R.Rmid = A.Rmid ANd R.Rtrid =A.Rtrid )
	
	
	---PARLECS/0221/375
			DELETE A FROM RetailerMarket A  inner join RetailerMarketOldRouteTrack B ON A.Rtrid =B.Rtrid --And A.Rmid=B.RMId
			inner join Retailer R on B.RtrId=R.RtrId  inner join #TempMigrateRetailerExisting T ON R.rtrCode =T.RetailerCode
			
			
			INSERT INTO RetailerMarket (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
			SELECT Distinct B.Rtrid,ISNULL(C.Rmid,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),0 
			FROM RetailerMarketOldRouteTrack A (NOLOCK) INNER JOIN Retailer B (NOLOCK) ON A.Rtrid =b.rtrid 
			--left outer JOin RouteMaster C ON A.Rmid =C.Rmid 
			INNER JOIN #TempMigrateRetailerExisting D ON B.rtrCode =D.RetailerCode 
			inner join RouteMaster C (NOLOCK) ON C.RmCode =D.SalesRoute AND EXISTS (SELECT * FROM RetailerMarketOldRouteTrack R WHERE  R.Rtrid =A.Rtrid )
			-------------------------- Till here  PMS ID: ILCRSTPAR5462 -----------------------------------------------------
			--Retailer Market
			INSERT INTO RetailerMarket(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
			SELECT R.RtrId,ISNULL(#Geography.RmId,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),0
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			LEFT OUTER JOIN #Geography ON R.RtrCode =#Geography.RtrCode 
			--Retailer Reinsert for for unavailable market
			IF  EXISTS(SELECT 'X' FROM RETAILER WHERE RTRID NOT IN (SELECT RTRID from RETAILERMARKET))
			BEGIN
				INSERT INTO RetailerMarket (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
				SELECT Distinct B.Rtrid,ISNULL(C.Rmid,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),0 
				FROM  Retailer B 
				INNER JOIN #TempMigrateRetailerExisting D ON B.rtrCode =D.RetailerCode 
				inner join RouteMaster C (NOLOCK) ON C.RmCode =D.SalesRoute 
				AND NOT EXISTS (SELECT * FROM RetailerMarket R WHERE  R.Rtrid =B.Rtrid )
			END
			
			--Retailer Value Class
			CREATE TABLE #RetailerDet
			(
				RetailerCode		NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				ChannelCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
				GroupCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,				
				ValueClassCode		NVARCHAR(100) COLLATE DATABASE_DEFAULT,				
				RtrClassId			INT,
				CtgMainId			INT,
				CtgLinkId			INT,
				CtgLevelId			INT,		
				CtgLinkCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				CtgLevelName		NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				CmpId				INT,		
				CmpName				NVARCHAR(200) COLLATE DATABASE_DEFAULT
			)
	
	
			INSERT INTO #RetailerDet (RetailerCode,ChannelCode,GroupCode,ValueClassCode,RtrClassId,CtgMainId,CtgLinkId,CtgLevelId,CtgLinkCode,
									  CtgLevelName,CmpId,CmpName)
			SELECT DISTINCT TR.RetailerCode,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode,RVC.ValueClassCode,
			RVC.RtrClassId,RC.CtgMainId,RC.CtgLinkId,RC.CtgLevelId,RC.CtgLinkCode,RCL.CtgLevelName,C.CmpId,C.CmpName
				FROM
				RetailerValueClass RVC,
				RetailerCategory RC,
				RetailerCategoryLevel RCL,
				RetailerCategory RC1,
				Cn2Cs_Prk_RetailerReDownload TR,
				Company C
			WHERE RVC.CtgMainId=RC.CtgMainId
				AND	RCL.CtgLevelId=RC.CtgLevelId
				AND	RC.CtgLinkId = RC1.CtgMainId				
				AND TR.RtrClassCode=RVC.ValueClassCode			
				AND RC.CtgCode=TR.RtrGroupCode
				AND C.CmpId=RCL.CmpId AND C.DefaultCompany=1
				
					
			INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT R.RtrId,ISNULL(#RetailerDet.RtrClassId,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			LEFT OUTER JOIN #RetailerDet ON R.RtrCode =#RetailerDet.RetailerCode
			--Till Here
			
			--RetailerShipAdd
			INSERT INTO RetailerShipAdd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,RtrShipDefaultAdd,
			Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT @RtrShipAddId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),@RtrId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),
			A.RtrShippAdd1,A.RtrShippAdd2,A.RtrShippAdd3,'','',
			1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			
			UPDATE A SET A.RtrShipId=B.RtrShipId FROM Retailer A(NOLOCK) 			
			INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId 
			
			--UPDATE R SET R.VillageId=B.VillageId FROM Retailer R(NOLOCK) 			
			--INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 		
			--INNER JOIN RouteVillage B (NOLOCK) ON B.VillageCode=A.VillageCode 
			
			UPDATE R SET R.TaxGroupId=B.TaxGroupId FROM Retailer R(NOLOCK) 			
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 		
			INNER JOIN TaxGroupSetting B (NOLOCK) ON B.RtrGroup=A.RtrTaxGroup 
			
			--CoaMaster
			CREATE TABLE #TempCoaMaster
				(
					CoaId		INT,
					AcCode		VARCHAR(100),
					RtrCode		VARCHAR(100),
					CmpRtrCode	VARCHAR(100),
					RetailerName VARCHAR(200)	
				)
			
			INSERT INTO #TempCoaMaster(CoaId,AcCode,RtrCode,CmpRtrCode,RetailerName)
			SELECT @CoaId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),@AccCode + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),RetailerCode,R.CmpRtrCode,RetailerName
			FROM #TempMigrateRetailer A
			INNER JOIN Retailer R WITH (NOLOCK) ON A.RetailerCode = R.RtrCode AND A.CmpRtrCode = R.CmpRtrCode
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0 
			
			--Coa Master
			INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT CoaId,AcCode,RetailerName,4,2,2,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM #TempCoaMaster
			
			UPDATE A SET A.CoaId=R.CoaId FROM Retailer A
			INNER JOIN #TempCoaMaster R WITH (NOLOCK) ON A.RtrCode = R.RtrCode AND A.CmpRtrCode = R.CmpRtrCode
			
			--UPDATE COUNTERS
			SELECT @CoaID = ISNULL(MAX(CoaID),0) FROM COAMaster 	
			UPDATE Counters SET CurrValue = @CoaID WHERE TabName = 'COAMaster'
			
			
			SELECT @RtrShipAddId = ISNULL(MAX(RtrShipId),0) FROM RetailerShipAdd
			UPDATE Counters SET CurrValue = @RtrShipAddId WHERE TabName = 'RetailerShipAdd'
			
			SELECT @RtrID = ISNULL(MAX(RtrId),0) FROM Retailer
			UPDATE Counters SET CurrValue = @RtrID WHERE TabName = 'Retailer' AND FldName = 'RtrId'
			
			--Update CompanyCounters 
			IF EXISTS(SELECT 7 FROM Cn2Cs_Prk_RetailerReDownload P (NOLOCK))
			BEGIN
				SELECT Prefix,CurYear,MAX(REPLACE(CmpRtrCode,(Prefix+RIGHT(CurYear,2)),0)) CurValue
				INTO #UpdatingCompanyCounters
				FROM CompanyCounters C (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON R.CmpRtrCode LIKE (C.Prefix+RIGHT(C.CurYear,2))+'%'
				WHERE TabName = 'Retailer' AND FldName = 'CmpRtrCode' --AND CurrValue = 0
				GROUP BY Prefix,CurYear
				
				UPDATE T SET T.CurrValue = F.CurValue
				FROM #UpdatingCompanyCounters F (NOLOCK)
				INNER JOIN CompanyCounters T (NOLOCK) ON F.Prefix = T.Prefix AND F.CurYear = T.CurYear
			END
			
			IF EXISTS(SELECT '*' FROM Cn2Cs_Prk_RetailerGST(NOLOCK) WHERE ISNULL(DownLoadFlag,'D')='D')
			BEGIN
				EXEC Proc_Cn2Cs_RetailerGST 0
			END
			
			UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_RetailerReDownload A (NOLOCK) 
			INNER JOIN Retailer B (NOLOCK) ON A.RetailerCode=B.RtrCode AND A.CmpRtrCode = B.CmpRtrCode 
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0 AND DownloadFlag = 'D' 
	
	END TRY
	BEGIN CATCH
		SET @Po_ErrNo=1
		SELECT ERROR_LINE(),ERROR_MESSAGE ()
	END CATCH
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_Retailer]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_Retailer]
GO
/*
BEGIN TRAN
delete FROM RETAILERvalueclassmap where rtrid in(1,2,3,5,6)
update A set upload ='N' FROM  RETAILER A 
EXEC Proc_Cs2Cn_Retailer 0,'2020-07-20'
SELECT RtrUniqueCode,* FROM CS2CN_PRK_RETAILER 
--SELECT * FROM RETAILER
--SELECT * FROM RETAILERvalueclassmap
--SELECT 'Approval Track After upload',* FROM RetailerApprovalStatus
ROLLBACK TRAN 
*/
CREATE PROCEDURE [Proc_Cs2Cn_Retailer]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
SET NOCOUNT ON
BEGIN
/*********************************
* PROCEDURE	: Proc_Cs2Cn_Retailer 0,'2016-11-11'
* PURPOSE	: Extract Retailer Details from CoreStocky to Console
* NOTES		:
* CREATED	: Nandakumar R.G 09-01-2009
* MODIFIED	:
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  10/05/2018   S.Moorthi     CR        CRCRSTPAR0001   Retailer Approval process - Manual
  05-04-2019   M. Lkashman   BZ        ILCRSTPAR3971   Retailer values class valiation included based on retailer wise upload process.
  21-05-2019   M.Lakshman    BZ        ILCRSTPAR4514   Retailer approval process trace validation included.
  07/05/2020	Murugan.R	CR		   PARCS202100016  Retailer Type Consumer added instead of HUB  
  20-07-2020    Deepan       CR        PARCS202100041   Reason and  USER INPUT added
  18-01-2021	Venkat. M	 CR		   CRCRSTPAR0107	RtrUnique code add
  01-10-2020    S.Moorthi    CR        DABCS202100016   TCS Tax amount and TCS Applicable columns added in Upload
  11-02-2021	Venkat. M	 SR		   PARLECS/0221/139  Retailer Approval change.
   * 04/08/2021	Deepan		CR			PA-I31					Type included

*********************************/
	DECLARE @CmpID 		AS INTEGER
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	----Commented by Moorthi CRCRSTPAR0001 --CHANGED BY MAHESH FOR ICRSTPAR1505
	--IF EXISTS (SELECT * FROM RETAILER WHERE APPROVED=0)
	--BEGIN
	--	UPDATE RETAILER SET Approved=1 WHERE Approved=0
	--END
	----Till Here
	DELETE FROM Cs2Cn_Prk_Retailer WHERE UploadFlag = 'Y'
	SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor
	-------------------- Added by lakshman M Dated ON 05-04-2019 PMS ID: ILCRSTPAR3971 ------------- 
	INSERT INTO Cs2Cn_Prk_Retailer
	(
		DistCode ,
		RtrId ,
		RtrCode ,
		CmpRtrCode,
		RtrName ,
		RtrAddress1,
		RtrAddress2,
		RtrAddress3,
		RtrPINCode,
		RtrChannelCode ,
		RtrGroupCode ,
		RtrClassCode ,
		Status,
		KeyAccount,
		RelationStatus,
		ParentCode,
		RtrRegDate,
		GeoLevel,
		GeoLevelValue,
		VillageId,
		VillageCode,
		VillageName,
		Mode,
		DrugLNo,
		RtrFrequency,
		RtrPhoneNo,
		RtrTINNumber,
		RtrTaxGroupCode,
		RtrCrLimit,
		RtrCrDays,
		Approved,
		RtrType,
		RtrLandLine,
		ReasonCode,
		ReasonName,
		RtrCodeUserInput,
		UploadFlag,
		RtrUniqueCode,
		RetType
		)
		
		SELECT @DistCode ,
		R.RtrId ,
		R.RtrCode ,
		R.CmpRtrCode ,
		R.RtrName ,
		R.RtrAdd1 ,
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		RC1.CtgCode ,
		RC.CtgCode,
		RVC.ValueClassCode,
		RtrStatus,	
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','New',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),ISNULL(TGS.RtrGroup,''),R.RtrCrLimit,
		R.RtrCrDays,(CASE ISNULL(R.Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
		(CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Consumer' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END) AS RtrType,
		R.RtrLandLine,ISNULL(RAM.ReasonCode,''),ISNULL(RAM.Description,''),R.RtrCodeUserInput,'N',R.RtrUniqueCode,R.RetailerType					
		FROM Retailer R (NOLOCK)
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE (NOLOCK)
		INNER JOIN Retailer K (NOLOCK)ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN ReasonMaster RAM(NOLOCK) ON RAM.REASONID=R.Reason
		LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.Rtrid =R.Rtrid
		inner join RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
		inner join RetailerCategory RC ON RVC.CtgMainId=RC.CtgMainId
		inner join RetailerCategoryLevel RCL ON RCL.CtgLevelId=RC.CtgLevelId
		inner join RetailerCategory RC1 ON RC.CtgLinkId = RC1.CtgMainId
		WHERE R.Upload = 'N' AND  NOT EXISTS (SELECT DISTINCT RAS.RtrId FROM RetailerApprovalStatus RAS (NOLOCK) WHERE R.RtrId = RAS.RtrId)		
	UNION
	SELECT
		@DistCode ,
		RCC.RtrId,
		R.RtrCode,
		R.CmpRtrCode,
		(CASE ISNULL(RCC.RtrName,'') WHEN '' THEN R.RtrName ELSE RCC.RtrName END) AS RtrName,
		--RCC.RtrName ,
		R.RtrAdd1 ,	
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		RC1.CtgCode ,
		RC.CtgCode,
		RVC.ValueClassCode ,
		--RtrStatus,
		(CASE ISNULL(RCC.RtrStatus,2) WHEN 2 THEN R.RtrStatus ELSE RCC.RtrStatus END) AS RtrStatus,
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','AP',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),ISNULL(TGS.RtrGroup,''),R.RtrCrLimit,
        R.RtrCrDays,(CASE ISNULL(R.Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
        (CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Consumer' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END) AS RtrType,
        	R.RtrLandLine,ISNULL(RAM.ReasonCode,''),ISNULL(RAM.Description,''),R.RtrCodeUserInput,'N',R.RtrUniqueCode,R.RetailerType	
	
	FROM 
		RetailerApprovalStatus RCC (NOLOCK)	--CRCRSTPAR0001		
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=RCC.RtrId
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE (NOLOCK)
		INNER JOIN Retailer K (NOLOCK) ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN ReasonMaster RAM(NOLOCK) ON RAM.REASONID=R.Reason
		LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.Rtrid =R.Rtrid
		inner join RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
		inner join RetailerCategory RC ON RVC.CtgMainId=RC.CtgMainId
		inner join RetailerCategoryLevel RCL ON RCL.CtgLevelId=RC.CtgLevelId
		inner join RetailerCategory RC1 ON RC.CtgLinkId = RC1.CtgMainId
		WHERE RCC.Upload=0 
		
	--	RetailerClassficationChange RCC			
	--	INNER JOIN Retailer R ON R.RtrId=RCC.RtrId
	--	LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE
	--	INNER JOIN Retailer K ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
	--	LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
	--WHERE 	
	--	UpLoadFlag=0
	
	------------ commented by lakshman M dated on 05-04-2019 PMS ID: ILCRSTPAR3971 -----------
	--UPDATE ETL SET ETL.RtrChannelCode=RVC.ChannelCode,ETL.RtrGroupCode=RVC.GroupCode,ETL.RtrClassCode=RVC.ValueClassCode
	--FROM Cs2Cn_Prk_Retailer ETL,
	--(
	--	SELECT R.RtrId,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode ,RVC.ValueClassCode
	--	FROM
	--	RetailerValueClassMap RVCM ,
	--	RetailerValueClass RVC	,
	--	RetailerCategory RC ,
	--	RetailerCategoryLevel RCL,
	--	RetailerCategory RC1,
	--	Retailer R  		
	--WHERE
	--	R.Rtrid = RVCM.RtrId
	--	AND	RVCM.RtrValueClassId = RVC.RtrClassId
	--	AND	RVC.CtgMainId=RC.CtgMainId
	--	AND	RCL.CtgLevelId=RC.CtgLevelId
	--	AND	RC.CtgLinkId = RC1.CtgMainId
	--) AS RVC
	--WHERE ETL.RtrId=RVC.RtrId
	--------------------- Till here  -------------
	
	UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoName,'') AS GeoName
		FROM			
		Retailer R  		
		LEFT OUTER JOIN Geography G (NOLOCK) ON R.GeoMainId=G.GeoMainId  
		LEFT OUTER JOIN GeographyLevel GL(NOLOCK) ON GL.GeoLevelId=G.GeoLevelId  
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId	
	
	UPDATE ETL SET ETL.VillageId=V.VillageId,ETL.VillageCode=V.VillageCode,ETL.VillageName=V.VillageName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,R.VillageId,V.VillageCode,V.VillageName
		FROM			
		Retailer R  		
		INNER JOIN RouteVillage V ON R.VillageId=V.VillageId
	) V
	WHERE ETL.RtrId=V.RtrId	
	
	--Added By MohanaKrishna A.B For GST
	Update Cs2Cn_Prk_Retailer SET StateName='' where StateName is Null
	Update Cs2Cn_Prk_Retailer SET GSTTIN ='' where GSTTIN is Null
	Update Cs2Cn_Prk_Retailer SET PanNumber ='' where PanNumber is Null
	Update Cs2Cn_Prk_Retailer SET RetailerType ='' where RetailerType is Null
	Update Cs2Cn_Prk_Retailer SET Composite ='' where Composite is Null
	Update Cs2Cn_Prk_Retailer SET RelatedParty ='' where RelatedParty is Null
	Update Cs2Cn_Prk_Retailer SET TDSApplicable ='' where TDSApplicable is Null ---TDS2021
	----
	
	--Added By Mohana For GST
	SELECT C.MasterRecordId,B.ColumnName,ISNULL(C.ColumnValue,'') ColumnValue INTO #RtrUDC FROM UdcHD A 
	INNER JOIN UdcMaster B ON A.MasterId=B.MasterId AND A.MasterName='Retailer Master'
	INNER JOIN UdcDetails C ON A.MasterId= C.MasterId AND B.UdcMasterId=C.UdcMasterId --AND masterrecordid =445
	INNER JOIN Retailer R ON R.RtrId =C.MasterRecordId AND B.ColumnName IN ('State name','GSTIN',
	'PAN Number','Retailer Type','Related Party','Composition','Aadhaar','TCS Applicable','TDS Applicable') --TDS2021

	UPDATE A SET StateName =ISNULL(C.ColumnValue,'') FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='State Name'
	UPDATE A SET GSTTIN = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='GSTIN'
	UPDATE A SET PanNumber = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='PAN Number'
	UPDATE A SET RetailerType = ISNULL(C.ColumnValue,'') FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Retailer Type'
	UPDATE A SET RelatedParty = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Related Party'
	UPDATE A SET Composite = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Composition'
	Update Cs2Cn_Prk_Retailer SET Aadhaar ='' where Aadhaar is Null
	Update Cs2Cn_Prk_Retailer SET TCSApplicable ='' where TCSApplicable is Null
	
	UPDATE A SET Aadhaar = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Aadhaar'
	
	UPDATE A SET TCSApplicable = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='TCS Applicable'

	--TDS2021
	UPDATE A SET TDSApplicable = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='TDS Applicable'

	--Till Here
	 --Added By lakshman M DAted ON 21-05-2019 PMS ID: ILCRSTPAR4514  
	 INSERT INTO RetailerApprovalStatus_Trace (RtrId,Rtrctgid,Rtrclassid,Rtrstatus,Rtrname,Geoid,Upload,Mode,ModDate,Uploadeddate)  
	 SELECT R.RtrId,R.Rtrctgid,R.Rtrclassid,R.Rtrstatus,R.Rtrname,R.Geoid,R.Upload,R.Mode,R.ModDate,GETDATE() AS Uploadeddate  
	 FROM RetailerApprovalStatus R (NOLOCK) WHERE R.Upload=0  
	 --------- Till here -------  
	--Added By S.Moorthi	
	SELECT R.RtrId,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode,RVC.ValueClassCode 
	INTO #TempCategory	
		   FROM
		   RetailerValueClass RVC (NOLOCK),  
		   RetailerCategory RC (NOLOCK) ,  
		   RetailerCategoryLevel RCL (NOLOCK),  
		   RetailerCategory RC1 (NOLOCK),    
		   RetailerApprovalStatus R (NOLOCK)  
		WHERE			
			R.RtrClassId = RVC.RtrClassId
			AND	RVC.CtgMainId=RC.CtgMainId
			AND	RCL.CtgLevelId=RC.CtgLevelId
			AND	RC.CtgLinkId = RC1.CtgMainId
			AND ISNULL(R.RtrClassId,0)<>0
			AND R.Upload=0
			
	UPDATE ETL SET ETL.RtrChannelCode=RVC.ChannelCode,ETL.RtrGroupCode=RVC.GroupCode,
	ETL.RtrClassCode=RVC.ValueClassCode
	FROM Cs2Cn_Prk_Retailer ETL (NOLOCK) 
	INNER JOIN RetailerApprovalStatus RAS (NOLOCK) ON ETL.RtrId=RAS.RtrId 
 	INNER JOIN #TempCategory RVC (NOLOCK) ON RVC.RtrId=ETL.RtrId and RVC.RtrId=RAS.RtrId  
	WHERE ETL.UploadFlag='N' AND RAS.Upload=0
	
	UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoName,'') AS GeoName
		FROM			
		Retailer R  	
		INNER JOIN RetailerApprovalStatus RAS (NOLOCK) ON R.RtrId=RAS.RtrId 	
		LEFT OUTER JOIN Geography G ON R.GeoMainId=G.GeoMainId
  		LEFT OUTER JOIN GeographyLevel GL (NOLOCK) ON GL.GeoLevelId=G.GeoLevelId  
		WHERE ISNULL(RAS.Geoid,0)<>0  AND RAS.Upload=0
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId
	--UPDATE Cs2Cn_Prk_Retailer SET Mode = 'CR' WHERE ISNULL(Approved,'PENDING') IN ('APPROVED','REJECTED') AND Mode = 'New' AND UploadFlag='N'
	--UPDATE Cs2Cn_Prk_Retailer SET Mode = 'New' WHERE ISNULL(Approved,'PENDING') NOT IN ('APPROVED','REJECTED') AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'CR' WHERE ISNULL(Approved,'PENDING') IN ('APPROVED') AND Mode = 'New' AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'New' WHERE ISNULL(Approved,'PENDING') IN ('PENDING','REJECTED') AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'SFA' WHERE ISNULL(RtrUniqueCode,'') ='' AND UploadFlag='N'
	--Till Here
	
	UPDATE Retailer SET Upload='Y' WHERE Upload='N'
	AND CmpRtrCode IN(SELECT CmpRtrCode FROM Cs2Cn_Prk_Retailer WHERE UploadFlag='N') --WHERE Mode='New')
	
	UPDATE Retailer SET Approved =1 WHERE Approved =0  -- PARLECS/0221/139
	UPDATE RetailerClassficationChange SET UpLoadFlag=1 WHERE UpLoadFlag=0
	AND RtrCode IN(SELECT RtrCode FROM Cs2Cn_Prk_Retailer WHERE Mode='AP' AND UploadFlag='N')
	
	UPDATE RetailerApprovalStatus SET Upload=1 WHERE Upload=0
	AND RtrId IN(SELECT RtrId FROM Cs2Cn_Prk_Retailer WHERE Mode='AP' AND UploadFlag='N')
	
	UPDATE Cs2Cn_Prk_Retailer SET ServerDate=@ServerDate
	 ----------- added by lakshman M Dated ON 21-05-2019 PMS ID: ILCRSTPAR4514  
	 INSERT INTO Cs2Cn_Prk_Retailer_trace (DistCode,RtrId,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPINCode,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,   
	 ParentCode,RtrRegDate,GeoLevel,GeoLevelValue,VillageId,VillageCode,VillageName,Status,Mode,DrugLNo,RtrFrequency,RtrPhoneNo,RtrTINNumber,RtrTaxGroupCode,RtrCrLimit,RtrCrDays,   
	 Approved,RtrType,UploadFlag,SyncId,ServerDate,StateName,GSTTIN,PanNumber,RetailerType,Composite,RelatedParty,Uploadeddate)  
	 SELECT DistCode,RtrId,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPINCode,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,   
	 ParentCode,RtrRegDate,GeoLevel,GeoLevelValue,VillageId,VillageCode,VillageName,Status,Mode,DrugLNo,RtrFrequency,RtrPhoneNo,RtrTINNumber,RtrTaxGroupCode,RtrCrLimit,RtrCrDays,   
	 Approved,RtrType,UploadFlag,SyncId,ServerDate,StateName,GSTTIN,PanNumber,RetailerType,Composite,RelatedParty,GETDATE() AS Uploadeddate FROM Cs2Cn_Prk_Retailer (NOLOCK) WHERE UploadFlag ='N'  
	 -------------- Till here -----------------------  
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_DailySales' AND name='SMType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_DailySales ADD SMType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_DailySales' AND name='RetailerType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_DailySales ADD RetailerType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_DailySales' AND name='VehicleType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_DailySales ADD VehicleType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_DailySales' AND name='VehSupplyType')
BEGIN
       ALTER TABLE Cs2Cn_Prk_DailySales ADD VehSupplyType varchar(50)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_DailySales]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_DailySales]
GO
/*
BEGIN Transaction
EXEC Proc_Cs2Cn_DailySales 0,'2021-08-05'
SELECT * FROM Cs2cn_prk_DailySales
SELECT * FROM Cs2cn_prk_DailySales_New
Rollback Transaction
*/
CREATE PROCEDURE [Proc_Cs2Cn_DailySales]
(    
 @Po_ErrNo INT OUTPUT,    
 @ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_DailySales    
* PURPOSE  : To Extract Daily Sales Details from CoreStocky to upload to Console    
* CREATED BY : Nandakumar R.G    
* CREATED DATE : 19/03/2010    
* NOTE   :    
* MODIFIED BY : LAKSHMAN M  
* MODIFIED DATE : 06/11/2017   
* PMS ID   : ICRSTPAR6569  
* PURPOSE  : Daily Sales Details from CoreStocky upload LCTR Calculation Validation changed.    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
21/10/2014 Jisha Mathew Included Undelivered bills New Column Added BillStatus,UploadedDate     
12/12/2015 PRAVEENRAJ BHASKARAN LCTRAmount ADDED FOR CCRSTPAR0118    
09/11/2016 Gopikrishnan RtrUniqueCode Added
* DATE       AUTHOR			CR/BZ		USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************************    
09-01-2018  lakshman M			BZ     ICRSTPAR7284          LCTR Formula velidation changed (special price not consider in LCTR Value).
06-02-2017	MOHANA				BZ     ICRSTPAR7955			 DELVIERED BILLS NOT UPLOADED PROPERLY
25-05-2019  lakshman M			BS     ILCRSTPAR4571         While uploading dat one product done in billing different uom that time LCTR amount same amount reflct in two line level
11-11-2019  Deepan				CR     CRCRSTPAR0089         Category and Value Class and channel Added
06-01-2020  Deepan				BZ 	   ILCRSTPAR7329		 Category and channel modified	
17-03-2020  MarySubashini.S     CR     ILCRSTPAR8294		 To display TCS tax details in Billing
* 04/08/2021	Deepan		CR		PA-I31					Type included

************************************************************************************************************************************/    
SET NOCOUNT ON    
BEGIN    
		 DECLARE @CmpId    AS INT    
		 DECLARE @DistCode As nVarchar(50)    
		 DECLARE @DefCmpAlone AS INT    
		 SET @Po_ErrNo=0    
	 
		DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'Y'    
		IF EXISTS (SELECT * FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2)    
		BEGIN    
			DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2    
		END    
		SELECT @DefCmpAlone=Status FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'    
		SELECT @DistCode = DistributorCode FROM Distributor     
		SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1     
	 --INSERT INTO Cs2Cn_Prk_DailySales    
	 --(    
	 -- DistCode  ,    
	 -- SalInvNo  ,    
	 -- SalInvDate  ,    
	 -- SalDlvDate  ,    
	 -- SalInvMode  ,    
	 -- SalInvType  ,    
	 -- SalGrossAmt  ,    
	 -- SalSplDiscAmt ,    
	 -- SalSchDiscAmt ,    
	 -- SalCashDiscAmt ,    
	 -- SalDBDiscAmt ,    
	 -- SalTaxAmt  ,    
	 -- SalWDSAmt  ,    
	 -- SalDbAdjAmt  ,    
	 -- SalCrAdjAmt  ,    
	 -- SalOnAccountAmt ,    
	 -- SalMktRetAmt ,    
	 -- SalReplaceAmt ,    
	 -- SalOtherChargesAmt,    
	 -- SalInvLevelDiscAmt,    
	 -- SalTotDedn  ,    
	 -- SalTotAddn  ,    
	 -- SalRoundOffAmt ,    
	 -- SalNetAmt  ,    
	 -- LcnId   ,    
	 -- LcnCode   ,    
	 -- SalesmanCode ,    
	 -- SalesmanName ,     
	 -- SalesRouteCode ,    
	 -- SalesRouteName ,    
	 -- RtrId   ,    
	 -- RtrCode   ,    
	 -- RtrName   ,    
	 -- VechName  ,    
	 -- DlvBoyName  ,    
	 -- DeliveryRouteCode ,     
	 -- DeliveryRouteName ,     
	 -- PrdCode    ,    
	 -- PrdBatCde   ,    
	 -- PrdQty    ,    
	 -- PrdSelRateBeforeTax ,    
	 -- PrdSelRateAfterTax ,    
	 -- PrdFreeQty  ,    
	 -- PrdGrossAmt  ,    
	 -- PrdSplDiscAmt ,    
	 -- PrdSchDiscAmt ,    
	 -- PrdCashDiscAmt ,    
	 -- PrdDBDiscAmt ,    
	 -- PrdTaxAmt  ,    
	 -- PrdNetAmt  ,    
	 -- UploadFlag  ,    
	 -- SalInvLineCount ,    
	 -- SalInvLvlDiscPer,    
	 -- BillStatus,    
	 -- UploadedDate,    
	 -- OrderRefNo,    
	 -- SFAOrderRefNo,    
	 -- RtrUniqueCode,
	 -- CtgCode,
	 -- CtgName,
	 -- ValueClassCode,
	 -- ValueClassName,
	 -- ChannelCode,
	 -- ChannelName      
	 --)    
	 --SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
	 --(CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
	 --(CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
	 --A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
	 --A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
	 --A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
	 --B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
	 --ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
	 --G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
	 --G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
	 --G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
	 --'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
	 --GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,''),RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
	 --RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName     
	 --FROM SalesInvoice A  (NOLOCK)    
	 --INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
	 --INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
	 --INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
	 --LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
	 --LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
	 --INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
	 --INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
	 --INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
	 --INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
	 --INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId  
	 ----Code Added by Deepan on 11/11/2019
	 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
	 --AND A.RTRValueClassId=RM.RtrValueClassId
	 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 --WHERE A.Upload=0 ORDER BY A.SalId   
	 INSERT INTO Cs2Cn_Prk_DailySales    
	 (    
		  DistCode  ,    
		  SalInvNo  ,    
		  SalInvDate  ,    
		  SalDlvDate  ,    
		  SalInvMode  ,    
		  SalInvType  ,    
		  SalGrossAmt  ,    
		  SalSplDiscAmt ,    
		  SalSchDiscAmt ,    
		  SalCashDiscAmt ,    
		  SalDBDiscAmt ,    
		  SalTaxAmt  ,    
		  SalWDSAmt  ,    
		  SalDbAdjAmt  ,    
		  SalCrAdjAmt  ,    
		  SalOnAccountAmt ,    
		  SalMktRetAmt ,    
		  SalReplaceAmt ,    
		  SalOtherChargesAmt,    
		  SalInvLevelDiscAmt,    
		  SalTotDedn  ,    
		  SalTotAddn  ,    
		  SalRoundOffAmt ,    
		  SalNetAmt  ,    
		  LcnId   ,    
		  LcnCode   ,    
		  SalesmanCode ,    
		  SalesmanName ,     
		  SalesRouteCode ,    
		  SalesRouteName ,    
		  RtrId   ,    
		  RtrCode   ,    
		  RtrName   ,    
		  VechName  ,    
		  DlvBoyName  ,    
		  DeliveryRouteCode ,     
		  DeliveryRouteName ,     
		  PrdCode    ,    
		  PrdBatCde   ,    
		  PrdQty    ,    
		  PrdSelRateBeforeTax ,    
		  PrdSelRateAfterTax ,    
		  PrdFreeQty  ,    
		  PrdGrossAmt  ,    
		  PrdSplDiscAmt ,    
		  PrdSchDiscAmt ,    
		  PrdCashDiscAmt ,    
		  PrdDBDiscAmt ,    
		  PrdTaxAmt  ,    
		  PrdNetAmt  ,    
		  UploadFlag  ,    
		  SalInvLineCount ,    
		  SalInvLvlDiscPer,    
		  BillStatus,    
		  UploadedDate,    
		  OrderRefNo,    
		  SFAOrderRefNo,    
		  RtrUniqueCode,
		  PrdTCSTaxAmount,  --ILCRSTPAR8294
		  SMType,
		  RetailerType,
		  VehicleType
	 )    
	 SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
	 (CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
	 (CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
	 A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
	 A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
	 A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
	 B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
	 ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
	 G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
	 G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
	 G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
	 'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
	 GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,'')
	 ,ISNULL(PrdTCSTaxAmount,0) AS PrdTCSTaxAmount,  --ILCRSTPAR8294
	 ISNULL(B.SMType,'') AS SMType, ISNULL(R.RetailerType,'') AS  RetailerType,VT.VMName AS VehicleType
	 FROM SalesInvoice A  (NOLOCK)    
	 INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
	 INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
	 INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
	 LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
	 LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId   
	 LEFT OUTER JOIN VehicleTypeMasterDL VT(NOLOCK) ON VT.VMTypeId = E.VVehTypeId and VT.VMType = 'Vehicle Type' 
	 --LEFT OUTER JOIN VehicleTypeMasterDL VTM(NOLOCK) ON VTM.VMTypeId = E.VSupTypeId and VT.VMType = 'Supply Type' 
	 INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
	 INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
	 INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
	 INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
	 INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId 
	 LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 WHERE A.Upload=0 ORDER BY A.SalId  
	 ----Code Added by Deepan on 11/11/2019
	 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
	 --AND A.RTRValueClassId=RM.RtrValueClassId
	 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 --WHERE A.Upload=0 ORDER BY A.SalId   
	  --ILCRSTPAR7329
	 
	 UPDATE  Cs2Cn_Prk_DailySales SET VehSupplyType=VTM.VMName
	  FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN SALESINVOICE S (NOLOCK) ON C.SALINVNO=S.SALINVNO
	  LEFT OUTER JOIN Vehicle V ON S.VehicleId=V.VehicleId
	   LEFT OUTER JOIN VehicleTypeMasterDL VTM(NOLOCK) ON VTM.VMTypeId = V.VSupTypeId and VTM.VMType = 'Supply Type'


	 UPDATE  Cs2Cn_Prk_DailySales SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName,
	 CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName
	 FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN SALESINVOICE S(NOLOCK) ON C.SALINVNO=S.SALINVNO
	AND C.RtrId =S.RtrId 
	 INNER JOIN RetailerValueClass RC(NOLOCK) ON S.RtrValueClassId =RC.RtrClassId
	 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 
	 
	 
	 --UPDATE  Cs2Cn_Prk_DailySales SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
	 --FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
	 --FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
	 --INNER JOIN (    
	 --SELECT SalId,SalInvNo,PrdCCode,CmpBatCode,ISNULL(GrossAmt,0) AS GrossAmt,ISNULL(TaxAmount,0) AS TaxAmount,  
	 --ISNULL(GrossAmt+TaxAmount,0) AS LCTRAmt     
	 --FROM(    
	 --SELECT S.SALID,S.SALINVNO,P.PRDID,P.PRDCCODE,PB.CmpBatCode,SP.BASEQTY,SP.PrdUom1EditedSelRate,  
	 --ISNULL((SP.BASEQTY*SP.PrdUom1EditedSelRate),0) AS GrossAmt,    
	 --ISNULL(Tax.TaxAmount,0) AS TaxAmount    
	 --FROM SalesInvoice S (NOLOCK)    
	 --INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId=SP.SALID    
	 --INNER JOIN (    
	 --SELECT SalId,PrdSlno,SUM(TaxAmount) TaxAmount FROM SalesInvoiceProductTax (NOLOCK)    
	 --GROUP BY SalId,PrdSlno    
	 --)Tax ON Tax.SalId=S.SalId AND SP.SalId=Tax.SalId AND SP.SlNo=Tax.PrdSlNo    
	 --INNER JOIN Product P (NOLOCK) ON P.PrdId=SP.PrdId    
	 --INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId AND PB.PrdBatId=SP.PrdBatId    
	 --) X    
	 --WHERE EXISTS (SELECT SalInvNo,PrdCode,PrdBatCde FROM Cs2Cn_Prk_DailySales Y WHERE     
	 --X.SalInvNo=Y.SalInvNo AND X.PrdCCode=Y.PrdCode AND X.CmpBatCode=Y.PrdBatCde)    
	 --) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
	 ---------- Modified by Lakshman M on 06/11/2017 PMS_ICRSTPAR6569 ------------  
	  UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
	 FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
	 INNER JOIN (    
		SELECT SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,SUM(TaxableAmount) as TaxableAmount,SUM(LCTRAmt)as LCTRAmt,BaseQty FROM (
		SELECT DISTINCT A.SalId SalID ,A.SalInvNo SalInvNo,B.PrdId PrdId,P.PrdCCode PrdCCode,PB.CmpBatCode CmpBatCode,(C.TaxPerc) As taxperc,  
	  (C.TaxableAmount) AS TaxableAmount,--PBD.PrdBatDetailValue,
	  ((B.BaseQty *(PBD.PrdBatDetailValue))+((B.BaseQty *(PBD.PrdBatDetailValue))*sum(c.TaxPerc/100)))  As LCTRAmt,
	  B.BaseQty As BaseQty
	  FROM SalesInvoice A (NOLOCK)  
	  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.SALID=B.SALID  
	  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON A.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo  
	  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId  
	  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId  
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1	
	  INNER JOIN Cs2Cn_Prk_DailySales PRK (NOLOCK)  
	  ON PRK.SalInvNo=A.SalInvNo AND PRK.PrdCode=P.PrdCCode AND PRK.PrdBatCde=PB.CmpBatCode and prk.PrdQty=B.BaseQty   ------------- ILCRSTPAR4571 add by lakshman M Dated ON 25-05-2019 
	  where C.TaxableAmount >0 and PBD.SLNo =3 -- AND A.salinvno ='P88071822390'-- AND b.prdid = 4777
	  GROUP BY A.SalId,A.SalInvNo,B.PrdId,B.PrdUom1EditedSelRate,C.TaxPerc,P.PrdCCode,PB.CmpBatCode,C.TaxableAmount,B.PrdGrossAmount,B.PrdTaxAmount,
	  B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue--,B.PrdUnitSelRate,
	  HAVING (SUM(C.TaxableAmount))>0 ) A 
	  Group by  SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,BaseQty
	 ) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde AND Z.BaseQty= A.PrdQty
	   ----------------- till here --------------------  
	 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
	 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
	 Where ProcId = 1    
	 UPDATE A SET SalInvLineCount=B.SalInvLineCount    
	 FROM Cs2Cn_Prk_DailySales A,(SELECT SI.SalInvNo,COUNT(SIP.PrdId) AS SalInvLineCount     
	 FROM SalesInvoice SI,SalesInvoiceProduct SIP WHERE     
	 SI.UPload=0 AND SI.SalId=SIP.SalId    
	 GROUP BY SI.SalInvNo) B    
	 WHERE A.SalInvNo=B.SalInvNo   
	  
	 --->Added By Nanda on 17/08/2010    
	 INSERT INTO Cs2Cn_Prk_SalesInvoiceOrders(DistCode,SalInvNo,OrderNo,OrderDate,UploadFlag)    
	 SELECT DISTINCT @DistCode,SI.SalInvNo,OB.OrderNo,OB.OrderDate,'N'    
	 FROM SalesInvoice SI,SalesinvoiceOrderBooking SIOB,OrderBooking OB    
	 WHERE SI.SalId=SIOB.SalId AND SIOB.OrderNo=OB.OrderNo AND SI.Upload=0 AND SI.DlvSts>3  
	 
	 --->Till Here    
	 --UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT    
	 --SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N') AND Dlvsts IN (3,4,5)   
  		--COMMENTED AND ADDED BY MOHANA  ICRSTPAR7955 
	UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT
	SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N' AND BillStatus in(3,4,5))
		--TILL HERE
		
		
	UPDATE Cs2Cn_Prk_DailySales SET ServerDate=@ServerDate   
END
GO
Delete From Tbl_DownloadIntegration Where  ProcessName = 'SalesManType'  and SequenceNo = 126
GO
Insert Into  Tbl_DownloadIntegration (SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
Select 126,'SalesManType','Cn2Cs_Prk_SalesManType','',0,500,GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 315 and  Module = 'SalesManType'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  315,1,'SalesManType','SalesManType','','Proc_Import_SalesManType','Cn2Cs_Prk_SalesManType','Proc_Cn2Cs_SalesManType','Master','Download',1
GO
IF   EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_SalesManType')
DROP TABLE Cn2Cs_Prk_SalesManType
GO
CREATE TABLE  Cn2Cs_Prk_SalesManType 
(
	[DistCode]			[varchar](50) NULL,
	[SMTypeCode]	[varchar](100) NULL,
	[SMTypeName]	[varchar](100) NULL,
	[DownloadFlag] [varchar](3) NULL,
	[CreatedDate] [datetime] NULL
)
GO
Delete From Tbl_DownloadIntegration Where  ProcessName = 'RetailerType'  and SequenceNo = 127
GO
Insert Into  Tbl_DownloadIntegration (SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
Select 127,'RetailerType','Cn2Cs_Prk_RetailerType','',0,500,GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 316 and  Module = 'SalesManType'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  316,1,'RetailerType','RetailerType','','Proc_Import_RetailerType','Cn2Cs_Prk_RetailerType','Proc_Cn2Cs_RetailerType','Master','Download',1
GO
IF   EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_RetailerType')
DROP TABLE Cn2Cs_Prk_RetailerType
GO
CREATE TABLE  Cn2Cs_Prk_RetailerType
(
	[DistCode]			[varchar](50) NULL,
	[RtrTypeCode]	[varchar](100) NULL,
	[RtrTypeName]	[varchar](100) NULL,
	[DownloadFlag] [varchar](3) NULL,
	[CreatedDate] [datetime] NULL
)
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='SalesManType' AND TYPE='U')
BEGIN
CREATE TABLE [dbo].[SalesManType](
	[SMTypeCode] [nvarchar](20) NOT NULL,
	[SMTypeName] [varchar](50) NOT NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL
) END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='RetailerType' AND TYPE='U')
BEGIN
CREATE TABLE [RetailerType](
	[RtrTypeCode] [nvarchar](20) NOT NULL,
	[RtrTypeName] [varchar](50) NOT NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL
) END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cn2Cs_SalesManType') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cn2Cs_SalesManType
GO
/*
BEGIN TRAN  
DELETE FROM ERRORLOG  
EXEC Proc_Cn2Cs_SalesManType 0  
SELECT * FROM Cn2Cs_Prk_SalesManType 
select * from SalesManType 
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_Cn2Cs_SalesManType 
(
       @Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_SalesManType
* PURPOSE		: To Download the SalesManType
* CREATED BY	: Deepan
* CREATED DATE	: 04.08.2021 
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
--------------------------------------------------------------------------------------------------------------------------- 
*04.08.2021     Deepan				PA-I31					 CR			New CR
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0

	DELETE FROM Cn2Cs_Prk_SalesManType WHERE DownloadFlag='Y'

	Update Cn2Cs_Prk_SalesManType SET SMTypeCode = '' where SMTypeCode IS Null
	Update Cn2Cs_Prk_SalesManType SET SMTypeName = '' where SMTypeName IS Null

	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_SalesManType (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END

	DECLARE @SMTypeCode  Varchar(100)
	DECLARE @SMTypeName  Varchar(100) 
	DECLARE @SMTypeDate  Varchar(100) 


	SELECT  SMTypeCode,SMTypeName,Max(CreatedDate) CRDATE  Into #MaxRecord
	From Cn2Cs_Prk_SalesManType (Nolock) WHERE DownLoadFlag='D' and SMTypeCode <> '' and  SMTypeName <> '' 
	GROUP  BY SMTypeCode,SMTypeName

	DECLARE Cur_SMType CURSOR
	FOR SELECT  A.SMTypeCode,A.SMTypeName,A.CreatedDate 	FROM Cn2Cs_Prk_SalesManType A  (Nolock), #MaxRecord B
		WHERE DownLoadFlag='D' and A.SMTypeCode <> '' and  A.SMTypeName <> ''  
		AND A.SMTypeCode = B.SMTypeCode and A.SMTypeName = B.SMTypeName and A.CreatedDate = B.CRDATE
		ORDER BY CreatedDate
	OPEN Cur_SMType
	FETCH NEXT FROM Cur_SMType INTO @SMTypeCode,@SMTypeName,@SMTypeDate
	WHILE @@FETCH_STATUS=0
	BEGIN
		 
		 IF LTRIM(RTRIM(@SMTypeCode)) <> '' and  LTRIM(RTRIM(@SMTypeName)) <> ''
		 BEGIN
			 IF Not exists (Select 'X' From SalesManType (Nolock)  WHere SMTypeCode = @SMTypeCode )
			 BEGIN
				 
					INSERT INTO SalesManType (SMTypeCode,SMTypeName,Availability,LastModBy,LastModDate,
													 AuthId,AuthDate)
					Values(@SMTypeCode,@SMTypeName,1,1,Convert(Varchar(10),GETDATE(),121),1,Convert(Varchar(10),GETDATE(),121))
					
					Update Cn2Cs_Prk_SalesManType SET  DownloadFlag = 'Y'  WHERE SMTypeCode = @SMTypeCode  and DownloadFlag = 'D'
				 
			 END
			 ELSE
			 BEGIN
				 Update SalesManType SET SMTypeName = @SMTypeName Where SMTypeCode = @SMTypeCode
				 Update Cn2Cs_Prk_SalesManType SET  DownloadFlag = 'Y'   WHERE SMTypeCode = @SMTypeCode   and DownloadFlag = 'D'
			 END 
		END

	FETCH NEXT FROM Cur_SMType INTO @SMTypeCode,@SMTypeName,@SMTypeDate
	END
	CLOSE Cur_SMType
	DEALLOCATE Cur_SMType
	 
RETURN
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cn2Cs_RetailerType') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cn2Cs_RetailerType
GO
/*
BEGIN TRAN  
DELETE FROM ERRORLOG  
EXEC Proc_Cn2Cs_RetailerType 0  
SELECT * FROM Cn2Cs_Prk_RetailerType 
select * from RetailerType 
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_Cn2Cs_RetailerType 
(
       @Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_VehicleCategory
* PURPOSE		: To Download the VehicleCategory
* CREATED BY	: Deepan
* CREATED DATE	: 04.08.2021 
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
--------------------------------------------------------------------------------------------------------------------------- 
*04.08.2021     Deepan				PA-I31					 CR			New CR
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0

	DELETE FROM Cn2Cs_Prk_RetailerType WHERE DownloadFlag='Y'

	Update Cn2Cs_Prk_RetailerType SET RtrTypeCode = '' where RtrTypeCode IS Null
	Update Cn2Cs_Prk_RetailerType SET RtrTypeName = '' where RtrTypeName IS Null

	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_RetailerType (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END

	DECLARE @RtrTypeCode  Varchar(100)
	DECLARE @RtrTypeName  Varchar(100) 
	DECLARE @RtrTypeDate  Varchar(100) 


	SELECT  RtrTypeCode,RtrTypeName,Max(CreatedDate) CRDATE  Into #MaxRecord
	From Cn2Cs_Prk_RetailerType (Nolock) WHERE DownLoadFlag='D' and RtrTypeCode <> '' and  RtrTypeName <> '' 
	GROUP  BY RtrTypeCode,RtrTypeName

	DECLARE Cur_RtrType CURSOR
	FOR SELECT  A.RtrTypeCode,A.RtrTypeName,A.CreatedDate 	FROM Cn2Cs_Prk_RetailerType A  (Nolock), #MaxRecord B
		WHERE DownLoadFlag='D' and A.RtrTypeCode <> '' and  A.RtrTypeName <> ''  
		AND A.RtrTypeCode = B.RtrTypeCode and A.RtrTypeName = B.RtrTypeName and A.CreatedDate = B.CRDATE
		ORDER BY CreatedDate
	OPEN Cur_RtrType
	FETCH NEXT FROM Cur_RtrType INTO @RtrTypeCode,@RtrTypeName,@RtrTypeDate
	WHILE @@FETCH_STATUS=0
	BEGIN
		 
		 IF LTRIM(RTRIM(@RtrTypeCode)) <> '' and  LTRIM(RTRIM(@RtrTypeName)) <> ''
		 BEGIN
			 IF Not exists (Select 'X' From RetailerType (Nolock)  WHere RtrTypeCode = @RtrTypeCode )
			 BEGIN
				 
					INSERT INTO RetailerType (RtrTypeCode,RtrTypeName,Availability,LastModBy,LastModDate,
													 AuthId,AuthDate)
					Values(@RtrTypeCode,@RtrTypeName,1,1,Convert(Varchar(10),GETDATE(),121),1,Convert(Varchar(10),GETDATE(),121))
					
					Update Cn2Cs_Prk_RetailerType SET  DownloadFlag = 'Y'  WHERE RtrTypeCode = @RtrTypeCode  and DownloadFlag = 'D'
				 
			 END
			 ELSE
			 BEGIN
				 Update RetailerType SET RtrTypeName = @RtrTypeName Where RtrTypeCode = @RtrTypeCode
				 Update Cn2Cs_Prk_RetailerType SET  DownloadFlag = 'Y'   WHERE RtrTypeCode = @RtrTypeCode   and DownloadFlag = 'D'
			 END 
		END

	FETCH NEXT FROM Cur_RtrType INTO @RtrTypeCode,@RtrTypeName,@RtrTypeDate
	END
	CLOSE Cur_RtrType
	DEALLOCATE Cur_RtrType
	 
RETURN
END
GO
--DEEPAN TILL HERE

--Added by Panneer
---PA-I31
Delete From Tbl_DownloadIntegration Where  ProcessName = 'VehicleCategory'  and SequenceNo = 124
GO
Insert Into  Tbl_DownloadIntegration (SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
Select 124,'VehicleCategory','Cn2Cs_Prk_VehicleCategory','',0,500,GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 313 and  Module = 'VehicleCategory'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  313,1,'VehicleCategory','VehicleCategory','','Proc_Import_VehicleCategory','Cn2Cs_Prk_VehicleCategory','Proc_Cn2Cs_VehicleCategory','Master','Download',1
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_VehicleCategory')
DROP TABLE Cn2Cs_Prk_VehicleCategory
GO
CREATE TABLE  Cn2Cs_Prk_VehicleCategory 
(
	[DistCode]			[varchar](50) NULL,
	[VehicleCatCode]	[varchar](100) NULL,
	[VehicleCatName]	[varchar](100) NULL,
	[DownloadFlag] [varchar](3) NULL,
	[CreatedDate] [datetime] NULL
)
GO
Delete From Tbl_DownloadIntegration Where  ProcessName = 'VehicleTypeMaster'  and SequenceNo = 125
GO
Insert Into  Tbl_DownloadIntegration (SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
Select 125,'VehicleTypeMaster','Cn2Cs_Prk_VehicleTypeMaster','',0,500,GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 314 and  Module = 'VehicleTypeMaster'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  314,1,'VehicleTypeMaster','VehicleTypeMaster','','Proc_Import_VehicleTypeMaster','Cn2Cs_Prk_VehicleTypeMaster','Proc_Cn2Cs_VehicleTypeMaster','Master','Download',1
GO
IF   EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_VehicleTypeMaster')
DROP TABLE Cn2Cs_Prk_VehicleTypeMaster
GO
CREATE TABLE  Cn2Cs_Prk_VehicleTypeMaster  
(
	[DistCode]			[varchar](50) NULL,
	[VMType]			[varchar](50) NULL, --- Vehicle Type/Supply Type 
	[VMName]			[varchar](100) NULL,
	[DownloadFlag] [varchar](3) NULL,
	[CreatedDate] [datetime] NULL
)
GO
Delete  From  Tbl_UploadIntegration Where SequenceNo = 91 and  ProcessName = 'Vehicle Category'
GO
Insert Into Tbl_UploadIntegration (SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
Select  91,'Vehicle Category','Vehicle Category','CS2CN_Prk_VehicleCategory',GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 192 and  Module = 'Vehicle Category'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  192,1,'Vehicle Category','Vehicle Category','Proc_Cs2Cn_VehicleCategory','','CS2CN_Prk_VehicleCategory','Proc_Cs2Cn_VehicleCategory','Master','Upload',1
GO
IF   EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='CS2CN_Prk_VehicleCategory')
DROP TABLE CS2CN_Prk_VehicleCategory
GO
CREATE TABLE  CS2CN_Prk_VehicleCategory 
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL, 
	[VehicleCatCode] [varchar](100) NULL,
	[VehicleCatName] [nvarchar](100) NULL,
	[UploadFlag] [nvarchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
)
GO
Delete  From  Tbl_UploadIntegration Where SequenceNo = 92 and  ProcessName = 'Vehicle Maintenance'
GO
Insert Into Tbl_UploadIntegration (SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
Select  92,'Vehicle Maintenance','Vehicle Maintenance','CS2CN_Prk_VehicleMaintenance',GETDATE()
GO
Delete From CustomUpDownload Where  SlNo = 193 and  Module = 'Vehicle Maintenance'
GO
Insert Into  CustomUpDownload (SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
Select  193,1,'Vehicle Maintenance','Vehicle Maintenance','Proc_Cs2Cn_VehicleMaintenance','','CS2CN_Prk_VehicleMaintenance','Proc_Cs2Cn_VehicleMaintenance','Master','Upload',1
GO
IF   EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='CS2CN_Prk_VehicleMaintenance')
DROP TABLE CS2CN_Prk_VehicleMaintenance
GO
CREATE TABLE  CS2CN_Prk_VehicleMaintenance 
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode]		[nvarchar](50) NULL, 
	[VehicleCode]	[varchar](100) NULL,
	[RegNumber]		[varchar](100) NULL,
	[VehicleCatCode] [varchar](100) NULL,
	[VehicleCatName] [varchar](100) NULL,
	[Capacity]		 Numeric (18,6)  ,
	[RatePerCase]	 Numeric (18,6)  ,
	[RatePerTonne]	 Numeric (18,6)  ,
	[RatePerKM]		 Numeric (18,6)  ,
	[VehicleStatus]  [varchar](100) NULL,
	[DefaultVehicle] [varchar](100) NULL,  ----YES/NO
	[VehicleType]	 [varchar](100) NULL, 
	[SupplyType]	 [varchar](100) NULL, 	
	[UploadFlag] [nvarchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
)
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='Upload' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='VehicleCategory' AND XTYPE='U'))
BEGIN
	ALTER TABLE VehicleCategory ADD Upload INT
END
GO
Update VehicleCategory SET Upload = 0 Where Upload IS NULL
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='XMLUpload' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='VehicleCategory' AND XTYPE='U'))
BEGIN
	ALTER TABLE VehicleCategory ADD XMLUpload INT
END
GO
Update VehicleCategory SET XMLUpload = 0 Where XMLUpload IS NULL
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cn2Cs_VehicleCategory') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cn2Cs_VehicleCategory
GO
/*
BEGIN TRAN  
DELETE FROM ERRORLOG  
EXEC Proc_Cn2Cs_VehicleCategory 0  
SELECT * FROM Cn2Cs_Prk_VehicleCategory
select * from VehicleCategory
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_Cn2Cs_VehicleCategory 
(
       @Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_VehicleCategory
* PURPOSE		: To Download the VehicleCategory
* CREATED BY	: Panneer
* CREATED DATE	: 04.08.2021 
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
--------------------------------------------------------------------------------------------------------------------------- 
*04.08.2021     Panneer				PA-I31					 CR			New CR
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0

	DELETE FROM Cn2Cs_Prk_VehicleCategory WHERE DownloadFlag='Y'

	Update Cn2Cs_Prk_VehicleCategory SET VehicleCatCode = '' where VehicleCatCode IS Null
	Update Cn2Cs_Prk_VehicleCategory SET VehicleCatName = '' where VehicleCatName IS Null

	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_VehicleCategory (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END

	DECLARE @VCCode  Varchar(100)
	DECLARE @VCName  Varchar(100) 
	DECLARE @VCDate  Varchar(100) 


	SELECT  VehicleCatCode,VehicleCatName,Max(CreatedDate) CRDATE  Into #MaxRecord
	From Cn2Cs_Prk_VehicleCategory (Nolock) WHERE DownLoadFlag='D' and VehicleCatCode <> '' and  VehicleCatName <> '' 
	GROUP  BY VehicleCatCode,VehicleCatName

	DECLARE Cur_VehCategory CURSOR
	FOR SELECT  A.VehicleCatCode,A.VehicleCatName,A.CreatedDate 	FROM Cn2Cs_Prk_VehicleCategory A  (Nolock), #MaxRecord B
		WHERE DownLoadFlag='D' and A.VehicleCatCode <> '' and  A.VehicleCatName <> ''  
		AND A.VehicleCatCode = B.VehicleCatCode and A.VehicleCatName = B.VehicleCatName and A.CreatedDate = B.CRDATE
		ORDER BY CreatedDate
	OPEN Cur_VehCategory
	FETCH NEXT FROM Cur_VehCategory INTO @VCCode,@VCName,@VCDate
	WHILE @@FETCH_STATUS=0
	BEGIN
		 
		 IF LTRIM(RTRIM(@VCCode)) <> '' and  LTRIM(RTRIM(@VCName)) <> ''
		 BEGIN
			 IF Not exists (Select 'X' From VehicleCategory (Nolock)  WHere VehicleCtgCode = @VCCode )
			 BEGIN
				 Declare @VehicleCtgId   INT
				 SET @VehicleCtgId=0
				 SET @VehicleCtgId = dbo.Fn_GetPrimaryKeyInteger('VehicleCategory','VehicleCtgId',CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
				 SET @VehicleCtgId = ISNULL(@VehicleCtgId,0)
				 IF @VehicleCtgId>0
				 BEGIN
					INSERT INTO VehicleCategory (VehicleCtgId,VehicleCtgCode,VehicleCtgName,Availability,LastModBy,LastModDate,
													 AuthId,AuthDate,Upload,XMLUpload)
					Values(@VehicleCtgId,@VCCode,@VCName,1,1,Convert(Varchar(10),GETDATE(),121),1,Convert(Varchar(10),GETDATE(),121),0,0)

					Update Counters SET CurrValue = @VehicleCtgId Where TabName = 'VehicleCategory'  and FldName = 'VehicleCtgId'
					Update Cn2Cs_Prk_VehicleCategory SET  DownloadFlag = 'Y'  WHERE VehicleCatCode = @VCCode  and DownloadFlag = 'D'
				 END
			 END
			 ELSE
			 BEGIN
				 Update VehicleCategory SET VehicleCtgName = @VCName Where VehicleCtgCode = @VCCode
				 Update Cn2Cs_Prk_VehicleCategory SET  DownloadFlag = 'Y'   WHERE VehicleCatCode = @VCCode   and DownloadFlag = 'D'
			 END 
		END

	FETCH NEXT FROM Cur_VehCategory INTO @VCCode,@VCName,@VCDate
	END
	CLOSE Cur_VehCategory
	DEALLOCATE Cur_VehCategory
	 
RETURN
END
GO
IF  NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='VehicleTypeMasterDL')
BEGIN
	CREATE TABLE  VehicleTypeMasterDL  
	( 
		[VMTypeId]			INT,
		[VMType]			[varchar](50) NULL, --- Vehicle Type/Supply Type 
		[VMName]			[varchar](100) NULL,
		Availability		INT,
		LastModBy			INT,
		LastModDate			DATETIME,	
		AuthId				INT,
		AuthDate			DATETIME
	)
END
GO
IF  NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='BKVehicleTypeMasterDL')
BEGIN
	CREATE TABLE  BKVehicleTypeMasterDL  
	( 
		[VMTypeId]			INT,
		[VMType]			[varchar](50) NULL, --- Vehicle Type/Supply Type 
		[VMName]			[varchar](100) NULL,
		Availability		INT,
		LastModBy			INT,
		LastModDate			DATETIME,	
		AuthId				INT,
		AuthDate			DATETIME
	)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='Upload' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Vehicle' AND XTYPE='U'))
BEGIN
	ALTER TABLE Vehicle ADD Upload INT
END
GO
Update Vehicle SET Upload = 0 Where Upload IS NULL
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='VVehTypeId' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Vehicle' AND XTYPE='U'))
BEGIN
	ALTER TABLE Vehicle ADD VVehTypeId INT
END
GO
Update Vehicle SET VVehTypeId = 0 Where VVehTypeId IS NULL
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='VSupTypeId' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Vehicle' AND XTYPE='U'))
BEGIN
	ALTER TABLE Vehicle ADD VSupTypeId INT
END
GO
Update Vehicle SET VSupTypeId = 0 Where VSupTypeId IS NULL
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Vehicle Type' and  VMName = 'LOCAL')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  0,'Vehicle Type','LOCAL',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Vehicle Type' and  VMName = 'UPCOUNTRY')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  1,'Vehicle Type','UPCOUNTRY',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Supply Type' and  VMName = 'Common')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  0,'Supply Type','Common',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Supply Type' and  VMName = 'GT')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  1,'Supply Type','GT',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Supply Type' and  VMName = 'SNAX')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  2,'Supply Type','SNAX',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Supply Type' and  VMName = 'PLATINA')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  3,'Supply Type','PLATINA',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists(Select 'X' From VehicleTypeMasterDL (Nolock) where VMType = 'Supply Type' and  VMName = 'MT')
BEGIN
		INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		Select  4,'Supply Type','MT',1,1,GETDATE(),1,GETDATE()
END
GO
IF Not Exists ( Select  'X' From BKVehicleTypeMasterDL (Nolock) ) 
BEGIN
	IF Exists (Select  'X' From VehicleTypeMasterDL (NOLOCK) ) 
	BEGIN
		INSERT  INTO BKVehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM VehicleTypeMasterDL
	END
END
GO
Delete From Customcaptions Where TransId  =  77  and CtrlId = 1000  and SubCtrlId in (17,18)
GO
Insert Into  Customcaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
Select 77,1000,17,'MsgBox-77-1000-17','','','Select Vehicle Type',1,1,1,GETDATE(),1,GETDATE(),'','','Select Vehicle Type',1,1   
UNION
Select 77,1000,18,'MsgBox-77-1000-18','','','Select Supply Type',1,1,1,GETDATE(),1,GETDATE(),'','','Select Supply Type',1,1   
GO
Delete From Customcaptions Where TransId  =  77  and CtrlId  in (21,22)
GO
Insert Into  Customcaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
Select 77,21,0,'lblVType','Vehicle Type*','','',1,1,1,GETDATE(),1,GETDATE(),'Vehicle Type*','','',1,1   
UNION
Select 77,22,0,'lblSType','Supply Type*','','',1,1,1,GETDATE(),1,GETDATE(),'Supply Type*','','',1,1   
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='FN_VehicleSupplyTypeSelc' AND xtype in ('FN','TF'))
DROP FUNCTION FN_VehicleSupplyTypeSelc
GO
---  Select  * from FN_VehicleSupplyTypeSelc (1) order By VTypeId
CREATE FUNCTION  FN_VehicleSupplyTypeSelc  (@iType INT)
Returns @VTTYPE Table
( 
	 VTypeId		INT,
	 VTypeName	Varchar(100)
)
AS
/***************************************************************************************************  
* FUNCTION :  FN_VehicleSupplyTypeSelc
* PURPOSE :   VehicleSupplyTypeSelc
* NOTES  :  
* CREATED :  Panner
* MODIFIED   
------------------------------------------------------------------------------------------------------------------------  
 ' Version      Date        Person          User Story ID    CR/BZ     Remarks               Code Review By   Review Date  
 '  446         04/08/2021	Panneer		    PA -I31			  CR		New CR
************************************************************************************************************************/
Begin
		Delete From @VTTYPE

		IF @iType =  1
		BEGIN
			INSERT INTO @VTTYPE (VTypeId,VTypeName)
			Select  Distinct VMTypeId,VMName From VehicleTypeMasterDL (Nolock) Where  VMType = 'Vehicle Type'
		END

		IF @iType =  2
		BEGIN
			INSERT INTO @VTTYPE (VTypeId,VTypeName)
			Select  Distinct VMTypeId,VMName From VehicleTypeMasterDL (Nolock) Where  VMType = 'Supply Type'
		END

Return
End
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='FN_VehicleSupplyTypeFillValue' AND xtype in ('FN','TF'))
DROP FUNCTION FN_VehicleSupplyTypeFillValue
GO
---  Select  * from FN_VehicleSupplyTypeFillValue (2, 4) order By VTypeId
CREATE FUNCTION  FN_VehicleSupplyTypeFillValue  (@iType INT,@VehicleId INT)
Returns @VTTYPE Table
( 
	 VTypeId		INT,
	 VTypeName	Varchar(100)
)
AS
/***************************************************************************************************  
* FUNCTION :  FN_VehicleSupplyTypeFillValue
* PURPOSE :   VehicleSupplyTypeSelc
* NOTES  :  
* CREATED :  Panner
* MODIFIED   
------------------------------------------------------------------------------------------------------------------------  
 ' Version      Date        Person          User Story ID    CR/BZ     Remarks               Code Review By   Review Date  
 '  446         04/08/2021	Panneer		    PA -I31			  CR		New CR
************************************************************************************************************************/
Begin
		Delete From @VTTYPE

		IF @iType =  1
		BEGIN
			INSERT INTO @VTTYPE (VTypeId,VTypeName)
			Select  Distinct VMTypeId,VMName From VehicleTypeMasterDL A (Nolock) ,Vehicle B (Nolock)
			Where  VMType = 'Vehicle Type'  and A.VMTypeId = B.VVehTypeId  and B.VehicleId = @VehicleId
		END

		IF @iType =  2
		BEGIN
			INSERT INTO @VTTYPE (VTypeId,VTypeName)
			Select  Distinct VMTypeId,VMName From VehicleTypeMasterDL A (Nolock) ,Vehicle B (Nolock)
			Where  VMType = 'Supply Type' and A.VMTypeId = B.VSupTypeId  and B.VehicleId = @VehicleId
		END

Return
End
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cs2Cn_VehicleCategory') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cs2Cn_VehicleCategory
GO
/*
	BEGIn TRAN
	Exec Proc_Cs2Cn_VehicleCategory 0,'2021-08-04'
	Select * from CS2CN_Prk_VehicleCategory
	Select  * from  VehicleCategory
	RollBack Tran
*/
CREATE PROCEDURE  Proc_Cs2Cn_VehicleCategory 
(
   @Po_ErrNo INT OUTPUT,
   @ServerDate DATETIME
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_VehicleCategory
* PURPOSE		: To Extract VehicleCategory from CoreStocky to  Console
* CREATED BY	: Panneer
* CREATED DATE	: 04/08/2021
* NOTE			:
* MODIFIED
* DATE			AUTHOR    CR/BZ		Stoty ID		DESCRIPTION
---------------------------------------------------------------------------------------------
* 04/08/2021    Panneer   CR          PA-I31	   New CR	
******************************************************************************************************/
SET NOCOUNT ON
BEGIN	

    SET @Po_ErrNo=0

	DECLARE @DistCode As nVarchar(50)
	DELETE FROM CS2CN_Prk_VehicleCategory WHERE UploadFlag = 'Y'	 
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)

    INSERT INTO CS2CN_Prk_VehicleCategory (DistCode,VehicleCatCode,VehicleCatName,UploadFlag,ServerDate)
    SELECT @DistCode, VehicleCtgCode,VehicleCtgName,'N',@ServerDate
    FROM VehicleCategory (Nolock)  Where Upload = 0 

	Update  VehicleCategory SET Upload = 1 
	where  VehicleCtgCode in (Select VehicleCatCode From  CS2CN_Prk_VehicleCategory where UploadFlag = 'N')

END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cs2Cn_VehicleMaintenance') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cs2Cn_VehicleMaintenance
GO
/*
	BEGIn TRAN
	Exec Proc_Cs2Cn_VehicleMaintenance 0,'2021-08-04'
	Select * from CS2CN_Prk_VehicleMaintenance
	Select  * from  Vehicle 
	RollBack Tran
*/
CREATE PROCEDURE  Proc_Cs2Cn_VehicleMaintenance 
(
   @Po_ErrNo INT OUTPUT,
   @ServerDate DATETIME
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_VehicleMaintenance
* PURPOSE		: To Extract VehicleCategory from CoreStocky to  Console
* CREATED BY	: Panneer
* CREATED DATE	: 04/08/2021
* NOTE			:
* MODIFIED
* DATE			AUTHOR    CR/BZ		Stoty ID		DESCRIPTION
---------------------------------------------------------------------------------------------
* 04/08/2021    Panneer   CR          PA-I31	   New CR	
******************************************************************************************************/
SET NOCOUNT ON
BEGIN	

    SET @Po_ErrNo=0

	DECLARE @DistCode As nVarchar(50)
	DELETE FROM CS2CN_Prk_VehicleMaintenance WHERE UploadFlag = 'Y'	 
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)

    INSERT INTO CS2CN_Prk_VehicleMaintenance (	DistCode,VehicleCode,RegNumber,VehicleCatCode,VehicleCatName,Capacity,RatePerCase,
												RatePerTonne,RatePerKM,VehicleStatus,DefaultVehicle,VehicleType,SupplyType,UploadFlag,ServerDate)
    SELECT @DistCode,B.VehicleCode,B.VehicleRegNo,A.VehicleCtgCode,A.VehicleCtgName,B.VehicleCapacity,B.RatePerCase,B.RatePerTonne,B.RatePerKM,
		   Case VehicleStatus When 1  then 'Active' ELSE 'InActive' END,
		   Case B.DefaultVehicle WHEN 1 then 'YES' ELSE 'NO' END, '','','N',@ServerDate
    FROM VehicleCategory A (Nolock),Vehicle b  
	Where B.Upload = 0 and A.VehicleCtgId = B.VehicleCtgId

	Update CS2CN_Prk_VehicleMaintenance SET VehicleType =  A.VMName 
	From VehicleTypeMasterDL A , Vehicle B , CS2CN_Prk_VehicleMaintenance C
	WHERE A.VMTypeId =  B.VVehTypeId and A.VMType = 'Vehicle Type'  and B.VehicleCode = C.VehicleCode

	Update CS2CN_Prk_VehicleMaintenance SET SupplyType =  A.VMName 
	From VehicleTypeMasterDL A , Vehicle B , CS2CN_Prk_VehicleMaintenance C
	WHERE A.VMTypeId =  B.VSupTypeId and A.VMType = 'Supply Type'  and B.VehicleCode = C.VehicleCode

	Update  Vehicle SET Upload = 1  where  VehicleCode in (Select VehicleCode From  CS2CN_Prk_VehicleMaintenance where UploadFlag = 'N')

END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_Cn2Cs_VehicleTypeMaster') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cn2Cs_VehicleTypeMaster
GO
/*
BEGIN TRAN  
DELETE FROM ERRORLOG  
EXEC Proc_Cn2Cs_VehicleTypeMaster 0  
SELECT * FROM Cn2Cs_Prk_VehicleTypeMaster
select * from VehicleTypeMasterDL
select * from BKVehicleTypeMasterDL
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_Cn2Cs_VehicleTypeMaster 
(
       @Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_VehicleMaintenance
* PURPOSE		: To Download the VehicleCategory
* CREATED BY	: Panneer
* CREATED DATE	: 04.08.2021 
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
--------------------------------------------------------------------------------------------------------------------------- 
*04.08.2021     Panneer				PA-I31					 CR			New CR
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0

	DELETE FROM Cn2Cs_Prk_VehicleTypeMaster WHERE DownloadFlag='Y'

	Update Cn2Cs_Prk_VehicleTypeMaster SET VMType = '' where VMType IS Null
	Update Cn2Cs_Prk_VehicleTypeMaster SET VMName = '' where VMName IS Null

	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_VehicleTypeMaster (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END

	DECLARE @VType  Varchar(100)
	DECLARE @VMName  Varchar(100) 
	DECLARE @VCDate  Varchar(100) 


	SELECT  VMType,VMName,Max(CreatedDate) CRDATE  Into #MaxRecord
	From Cn2Cs_Prk_VehicleTypeMaster (Nolock) 
	WHERE DownLoadFlag='D' and VMType <> '' and  VMName <> ''  and  VMType in ('Vehicle Type','Supply Type')
	GROUP  BY VMType,VMName

	DECLARE Cur_VehCategory CURSOR
	FOR SELECT  A.VMType,A.VMName,A.CreatedDate  FROM Cn2Cs_Prk_VehicleTypeMaster A  (Nolock), #MaxRecord B
		WHERE DownLoadFlag='D' and A.VMType <> '' and  A.VMName <> ''  and  A.VMType in ('Vehicle Type','Supply Type')
		AND A.VMType = B.VMType and A.VMName = B.VMName and A.CreatedDate = B.CRDATE
		ORDER BY CreatedDate
	OPEN Cur_VehCategory
	FETCH NEXT FROM Cur_VehCategory INTO @VType,@VMName,@VCDate
	WHILE @@FETCH_STATUS=0
	BEGIN
		 
		 IF LTRIM(RTRIM(@VType)) <> '' and  LTRIM(RTRIM(@VMName)) <> ''
		 BEGIN
			  IF @VType = 'Vehicle Type'
			  BEGIN
					IF NOT Exists( SELECT 'X' From VehicleTypeMasterDL (NOLOCK) WHERE VMType = 'Vehicle Type' and VMName =  @VMName)
					BEGIN	
						DECLARE @VTMaxId  INT
						SELECT @VTMaxId = Max(VMTypeId) From VehicleTypeMasterDL (NOLOCK) WHERE VMType = 'Vehicle Type'		
						SET @VTMaxId = ISNULL(@VTMaxId,0)
						SET @VTMaxId =  @VTMaxId + 1 
						IF @VTMaxId > 0 
						BEGIN
							INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
							VALUES ( @VTMaxId,'Vehicle Type',@VMName,1,1,GETDATE(),1,GETDATE())

							INSERT INTO bkVehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
							VALUES ( @VTMaxId,'Vehicle Type',@VMName,1,1,GETDATE(),1,GETDATE())
						END
					END
					Update Cn2Cs_Prk_VehicleTypeMaster SET DownloadFlag = 'Y' WHere VMType = 'Vehicle Type' and VMName =   @VMName AND DownloadFlag = 'D'
			  END 
			  
			  IF @VType = 'Supply Type'
			  BEGIN
					IF NOT Exists( SELECT 'X' From VehicleTypeMasterDL (NOLOCK) WHERE VMType = 'Supply Type' and VMName =  @VMName)
					BEGIN	
						DECLARE @VTSMaxId  INT
						SELECT @VTSMaxId = Max(VMTypeId) From VehicleTypeMasterDL (NOLOCK) WHERE VMType = 'Supply Type'		
						SET @VTSMaxId = ISNULL(@VTSMaxId,0)
						SET @VTSMaxId =  @VTSMaxId + 1 
						IF @VTSMaxId > 0 
						BEGIN
							INSERT INTO VehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
							VALUES ( @VTSMaxId,'Supply Type',@VMName,1,1,GETDATE(),1,GETDATE())

							INSERT INTO bkVehicleTypeMasterDL (VMTypeId,VMType,VMName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
							VALUES ( @VTSMaxId,'Supply Type',@VMName,1,1,GETDATE(),1,GETDATE())

						END
					END
					Update Cn2Cs_Prk_VehicleTypeMaster SET DownloadFlag = 'Y' WHere VMType = 'Supply Type' and VMName =  	@VMName AND DownloadFlag = 'D'
			  END
		 END

	FETCH NEXT FROM Cur_VehCategory INTO @VType,@VMName,@VCDate
	END
	CLOSE Cur_VehCategory
	DEALLOCATE Cur_VehCategory
	 
RETURN
END
GO
--Panneer Till Here
IF NOT EXISTS (SELECT * FROM SysObjects WHERE NAME='MonthEndApprovalTrack' AND TYPE='U')
BEGIN
	CREATE TABLE MonthEndApprovalTrack
	(
	StkYear			INT,
	StkMonth		VARCHAR(100),
	Status			VARCHAR(100),
	DownloadedDate	DATETIME,
	Createddate		DATETIME,
	MsgShow			INT
	)
END
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='MonthEndApproval'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','MonthEndApproval','MonthEndApproval','MonthEndApproval Menu',0,0,0,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetMonthEndApproval' AND TYPE='FN')
DROP FUNCTION Fn_GetMonthEndApproval
GO
--select dbo.Fn_GetMonthEndApproval('2021-07-30',2,2) AS Msg
CREATE FUNCTION Fn_GetMonthEndApproval(@Date DATETIME,@User INT,@Mode INT)
RETURNS VARCHAR(MAX)
AS
/*****************************************************
* PROCEDURE		: Fn_GetMonthEndApproval
* PURPOSE		:  
* CREATED BY	: Mohana S
* CREATED DATE	: 03-08-2021
* USER STORY ID : PA-I4
**********************************************************/
BEGIN
DECLARE @ReturnMsg VARCHAR(MAX)
DECLARE @PreMonth VARCHAR(100)
DECLARE @Year INT
SET @ReturnMsg =''

SELECT @PreMonth = DATENAME(MONTH, DATEADD(m,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()), 0)))

--IF (DATEADD(m,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()), 0)))<'2021-08-01'
--BEGIN
--	RETURN @ReturnMsg  
--END

SELECT @Year=YEAR(DATEADD(m,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()), 0)))

	IF NOT EXISTS (SELECT * FROM MonthendClosing WHERE  StkYear =@Year AND StkMonth =@PreMonth)
	BEGIN
		RETURN @ReturnMsg
	END

IF NOT EXISTS(SELECT * FROM ManualConfiguration WHERE ModuleId ='MonthEndApproval' AND Status=1)
BEGIN
RETURN @ReturnMsg
END

IF @Mode = 0
BEGIN
	IF EXISTS (SELECT * FROM MonthendApprovalTrack WHERE StkYear =@Year AND StkMonth =@PreMonth AND Status='Approved' AND MsgShow = 0)
	Begin

	SET @ReturnMsg ='MonthendAppproval has Uploaded from Console. Kindly Reopen to continue the Billing'

	END
END

IF @Mode = 1 
BEGIN
	SET @ReturnMsg = 'Kindly wait for month-end approval from the sales team before doing further billing.' + Char(13) +
		'Kindly sync later to check if approval is received. '
END

IF @Mode > 1 
BEGIN
	IF  EXISTS (SELECT * FROM MonthendClosing WHERE  StkYear =@Year AND StkMonth =@PreMonth AND UploadFlag='Y')
	BEGIN
		IF NOT EXISTS (SELECT * FROM MonthendApprovalTrack WHERE StkYear =@Year AND StkMonth =@PreMonth AND Status='Approved')
		BEGIN
			SET @ReturnMsg = 'Month-end approval is pending from the sales team.' + Char(13) + 'Kindly do sync to check approval status to enable billing transactions. '

		END
	END
END
RETURN (@ReturnMsg)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_DisableMenuForClaim' AND TYPE='TF')
DROP FUNCTION Fn_DisableMenuForClaim
GO
--Select MenuName From Fn_DisableMenuForClaim(2) 
CREATE FUNCTION Fn_DisableMenuForClaim(@PrfId INT)
RETURNS @MasterDetails TABLE
(
	MenuName			VARCHAR(80)
)
AS
/*********************************  
* PROCEDURE		: Fn_DisableMenuForClaim
* PURPOSE		: 
* CREATED BY	: Mohana.S
* CREATED DATE	: 14/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
********************************************************************************************
* 04-02-2021	MOHANA S		BZ		PARLESECS/0221/022		Enabled Pending Menus
* 04-08-2021	MOHANA S		CR		PA-I4					Monthend Approval
********************************************************************************************/ 
BEGIN

 
DECLARE @PreMonth VARCHAR(100)
DECLARE @Year INT
DECLARE @Pending INT
 

SELECT @PreMonth = DATENAME(MONTH, DATEADD(m,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()), 0)))

 
SELECT @Year=YEAR(DATEADD(m,-1,DATEADD(mm, DATEDIFF(m,0,GETDATE()), 0)))

 

IF NOT EXISTS (SELECT * FROM dbo.Fn_CheckPendingDebitNote(1))
BEGIN
	IF NOT EXISTS (SELECT * FROM MonthendApprovalTrack WHERE StkYear =@Year AND StkMonth =@PreMonth AND Status='Approved')
	BEGIN 
		RETURN
	END
END
	
		INSERT INTO @MasterDetails(MenuName)
		--SELECT DISTINCT  MenuName FROM MenuDef A  --INNER JOIN ProfileDt P ON A.MenuId = P.MenuId 
		----AND P.PrfId = @PrfId
		Select Distinct b.MenuName from profiledt a INNER JOIN MenuDef b ON  
		A.MenuId = B.MenuId AND a.PrfId =@PrfId  
		WHERE MenuName NOT IN ('mnuDebitNoteTopSheet','mnuClaimMgmt','mnuReports','MNUUSERPROFILEMAINTENANCE','MNUWEBSITE','MNUTARGETNORM','MNUDRILDOWN','MROUTEVILLAGEMAP')
		AND  MenuName NOT IN (SELECT MenuName FROM TmpValidatePendingData)
		Group by b.MenuName Having Sum(BtnStatus)>0
		
		IF @PrfId >= 1
		BEGIN
			DELETE D FROM @MasterDetails D
			INNER JOIN MenuDef M ON D.MenuName = M.MenuName
			INNER JOIN ProfileDt P ON M.MenuId = P.MenuId 
			AND P.BtnStatus = 1 
			AND P.PrfId = @PrfId
			WHERE M.MenuId IN ('mClm14','mRep2','mRep5','mRep1','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9','mRot2','mPln1','mPln2')
			--WHERE M.MenuId IN ('mClm14','mStk','mStk31','mRep2','mRep5','mRep1','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9')
		END 
	RETURN
END
GO
DELETE FROM CUSTOMUPDOWNLOAD WHERE UPDOWNLOAD='Download' AND Module = 'MonthEndApproval'
INSERT INTO CustomUpDownload
SELECT MAX(Slno)+1,1,'MonthEndApproval','MonthEndApproval','','','Cn2Cs_Prk_MonthEndApproval','Proc_Cn2Cs_MonthEndApproval','Transaction','Download',1
FROM CUSTOMUPDOWNLOAD WHERE UPDOWNLOAD='Download'
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='MonthEndApproval'
INSERT INTO Tbl_DownloadIntegration 
SELECT Max(Sequenceno)+1,'MonthEndApproval','Cn2Cs_Prk_MonthEndApproval','Proc_Cn2Cs_MonthEndApproval',0,500,GETDATE() FROM Tbl_DownloadIntegration WHERE SequenceNo<500
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_MonthEndApproval' AND TYPE='U')
DROP TABLE Cn2Cs_Prk_MonthEndApproval
GO
CREATE TABLE Cn2Cs_Prk_MonthEndApproval
(
	DistCode			NVARCHAR(50) NULL,
	StkYear				INT NULL,
	StkMonth			VARCHAR(100) NULL,
	Status				VARCHAR(100) NULL,
	DownloadFlag		VARCHAR(10) NULL,
	CreatedDate			DATETIME NULL	 
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_MonthEndApproval' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_MonthEndApproval
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_MonthEndApproval 0
SELECT * FROM CN2CS_PRK_MONTHENDAPPROVAL
SELECT * FROM MONTHENDAPPROVALTRACK
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_MonthEndApproval
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_MonthEndApproval
* PURPOSE		:  
* CREATED BY	: Mohana S
* CREATED DATE	: 03-08-2021
* USER STORY ID : PA-I4
**********************************************************/
SET NOCOUNT ON
BEGIN
SET @Po_ErrNo = 0

DELETE FROM Cn2Cs_Prk_MonthEndApproval WHERE DOWNLOADFLAG='Y'

SELECT StkMonth,Stkyear,Max(CreatedDate) MaxDate INTO #MAXDATE FROM Cn2Cs_Prk_MonthEndApproval WHERE DownloadFlag='D' 
GROUP BY STKMONTH,STKYEAR

SELECT A.* INTO #Cn2Cs_Prk_MonthEndApproval FROM Cn2Cs_Prk_MonthEndApproval A INNER JOIN #MAXDATE B ON B.STKMONTH=A.STKMONTH AND A.STKYEAR =B.STKYEAR AND A.CREATEDDATE =B.MaxDate 

INSERT INTO ERRORLOG
SELECT 1,'Cn2Cs_Prk_MonthEndApproval','StkMonth','Data already available' FROM  #Cn2Cs_Prk_MonthEndApproval A 
WHERE EXISTS (SELECT * FROM MonthendApprovalTrack B WHERE B.STKMONTH=A.STKMONTH AND A.STKYEAR =B.STKYEAR)

INSERT INTO MonthendApprovalTrack(StkYear,StkMonth,Status,DownloadedDate,Createddate,MsgShow)
SELECT StkYear,StkMonth,status,Createddate,GETDATE(),0 FROM #Cn2Cs_Prk_MonthEndApproval A 
WHERE NOT EXISTS (SELECT * FROM MonthendApprovalTrack B WHERE B.STKMONTH=A.STKMONTH AND A.STKYEAR =B.STKYEAR)
 
 UPDATE A SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_MonthEndApproval A INNER JOIN MonthendApprovalTrack B ON B.STKMONTH=A.STKMONTH AND A.STKYEAR =B.STKYEAR
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_FillSMDetails]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [Fn_FillSMDetails]
GO
--SELECT * FROM Fn_FillSMDetails()
CREATE FUNCTION [Fn_FillSMDetails]()
RETURNS @FillSMDetails TABLE
(
SMId				INT,
SMCode				NVARCHAR(50),
SMName				NVARCHAR(50),
CmpName				NVARCHAR(50),
Status				NVARCHAR(50),
NoOfRoutes			INT,
SMPhoneNumber		NVARCHAR(50),
SMEmailID			NVARCHAR(50),
SMOtherDetails		NVARCHAR(50),
SMDailyAllowance	NUMERIC(18,2),
SMMonthlySalary		NUMERIC(18,2),
SMMktCredit			NUMERIC(18,2),
SMCreditDays		INT,
CmpId				INT,
SalesForceName		NVARCHAR(50),
SalesForceMainId	INT,
SalesForceLevelName	NVARCHAR(50),
SalesForceLevelId	INT,
SMCreditAmountAlert	INT,
SMCreditDaysAlert	INT,
Upload				VARCHAR(10),
SMType				VARCHAR(50)
)
AS
/*********************************
* PROCEDURE		: Fn_FillSMDetails
* PURPOSE		:   
* CREATED		:  
* CREATED DATE	:  
* MODIFIED
*************************************************************************************************** 
* DATE				AUTHOR      CR/BZ       USER STORY ID       DESCRIPTION                           
***************************************************************************************************  
 12-07-2021		 Mohana S		 CR			 PA-I9			Restricted Dummy salesman
 03/08/2021		Deepan			 CR			 PA-I31			Salesman type included		
**************************************************************************************************************************************/
BEGIN

INSERT INTO @FillSMDetails (SMId,SMCode,SMName,CmpName,Status,NoOfRoutes,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,
SMCreditDays,CmpId,SalesForceName,SalesForceMainId,SalesForceLevelName,SalesForceLevelId,SMCreditAmountAlert,SMCreditDaysAlert,Upload,SMType)
SELECT A.SMId, A.SMCode, A.SMName,  ISNULL(C.CmpName,'ALL') AS CmpName,CASE WHEN A.Status =1 THEN 'Active' ELSE 'InActive' END AS Status,
COUNT(DISTINCT B.RMId) AS NoOfRoutes,  ISNULL(A.SMPhoneNumber,0) AS SMPhoneNumber,ISNULL(A.SMEmailID,0) As SMEmailID, 
ISNULL(A.SMOtherDetails,'') AS SMOtherDetails, ISNULL(A.SMDailyAllowance,0) AS SMDailyAllowance,ISNULL(A.SMMonthlySalary,0) As SMMonthlySalary, 
ISNULL(A.SMMktCredit,0) As SMMktCredit, ISNULL(A.SMCreditDays,0) AS SMCreditDays, A.CmpId,D.SalesForceName,D.SalesForceMainId, E.SalesForceLevelName ,
E.SalesForceLevelId, A.SMCreditAmountAlert , A.SMCreditDaysAlert,A.Upload,ISNULL(A.SMType,'') AS SMType  FROM Salesman A LEFT OUTER JOIN SalesmanMarket B ON A.SMId = B.SMId 
LEFT OUTER JOIN Company C ON A.CmpId=C.CmpId LEFT OUTER JOIN SalesForce D on  D.SalesForceMainId = A.SalesForceMainId 
LEFT OUTER JOIN SalesForceLevel E on E.SalesForceLevelId = D.SalesForceLevelId WHERE A.Availability = 1 AND SmCode NOT IN ('SMDummy01','99999')
GROUP BY A.SMId,A.SMCode,A.SMName,A.Status, A.SMPhoneNumber,A.SMEmailID,A.SMOtherDetails,
A.SMDailyAllowance, A.SMMonthlySalary,A.SMMktCredit,A.SMCreditDays, C.CmpName , A.CmpId , D.SalesForceName , D.SalesForceMainId,
E.SalesForceLevelName, E.SalesForceLevelId,SMCreditAmountAlert,SMCreditDaysAlert,A.Upload,A.SMType

RETURN
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2Cs_Prk_RetailerMigration' AND name='RtrType')
BEGIN
       ALTER TABLE Cn2Cs_Prk_RetailerMigration ADD RtrType varchar(50)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='RetailerMasterMigration' AND name='RtrType')
BEGIN
       ALTER TABLE RetailerMasterMigration ADD RtrType varchar(50)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_RetailerMigration]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_RetailerMigration]
GO
/*
Begin transaction
	delete from errorlog
	exec proc_Cn2cs_retailermigration 0
	Select * from RetailerMasterMigration
rollback transaction
*/  
CREATE PROCEDURE [Proc_Cn2Cs_RetailerMigration]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMigration 0
* PURPOSE		: Retailer to be Migrated from One DB to Other DB
* CREATED		: Sathishkumar Veeramani
* CREATED DATE	: 06/06/2014
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
17-01-2018  lakshman M   BZ     ICRSTPAR7316          Retailer Tin No & Retailer Phone Number null values validation removed in Core stocky.
03-02-2018  lakshman M   BZ     ICRSTPAR7619          RtrPhone Number & RtrTinNumber Null values allowed in RetailerMasterMigartion Table
28-12-2018  Lakshman M   SR     ILCRSTPAR2934         As per client request Retailer default taxgroup validation included in core stocky.
22-06-2020	MOHANA S	 BZ		PARCS202100035		  NEW COLUMN IS NOT DOWNLOADED FOR SALEMAN. HENCE NULL ERROR OCURRED WHILE LOADING IN SALESMAN SCREEN
20-07-2020  Deepan       CR     PARCS202100041         USER INPUT added
29-12-2020	Venkat. M	 CR		CRCRSTPAR0107		  OLD SMcode, RMCode column added in salesman,Route
09-03-2021	Venkat. M	 CR		PARLECS/0321/048	  Mob no validation removed
05-08-2021	Deepan		 CR		PA-I31					Type included	
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
SET @Po_ErrNo=0
DECLARE @CmpId AS NUMERIC(18,0)
DECLARE @SmId AS NUMERIC(18,0)
DECLARE @RmId AS NUMERIC(18,0)
DECLARE @DlvRmId AS NUMERIC(18,0)
DECLARE @UdcMasterId AS NUMERIC(18,0)
DECLARE @DistCode AS NVARCHAR(200)
DECLARE @Taxgroupid AS INT
DELETE FROM Cn2Cs_Prk_RetailerMigration WHERE DownLoadFlag = 'Y'
SELECT @DistCode = DistributorCode FROM Distributor WITH(NOLOCK)
SELECT @CmpId = CmpId FROM Company (NOLOCK) WHERE DefaultCompany = 1
	
	CREATE TABLE #ToAvoidRetailerMigration
	(
	  SalesmanCode   NVARCHAR(200),
	  SalRouteCode   NVARCHAR(200),
	  DlvRouteCode   NVARCHAR(200), 
	  RetailerCode   NVARCHAR(200),
	  GeoLevel       NVARCHAR(200),
	  GeoCode        NVARCHAR(200)
	)
	
	--Route Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoLevel)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Route Geography Level Not Available-'+RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	--Route Geography Value Validation
	
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoCode NOT IN 
	(SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Not Available-'+RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoCode NOT IN (SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Wrongly Mapped-'+RouteGeoLevel+'-'+RouteGeoCode	
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	
	--Salesman Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalesmanCode)
	SELECT DISTINCT SalesManCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManCode  IN 
	(SELECT SMCode  FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Salesman','Salesman Name','Salesman Name Already Availabe-'+SalesManName 
	--FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManName IN (SELECT SmName FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--Sales Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode)
	SELECT DISTINCT SalRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalRouteCode IN 
	(SELECT RMCode  FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Sales Route Name Already Availabe-'+SalRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE SalRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--Delivery Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(DlvRouteCode)
	SELECT DISTINCT DlvRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DlvRouteCode IN 
	(SELECT RMCode  FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Delivery Route Name Already Availabe-'+DlvRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE DlvRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--Retailer Details Validation
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
--	(RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Duplicate Retailer Unique Code Not Allow-'+RtrUniqueCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
	
	
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Retailer Unique Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
		
	----Duplicate Retailer Phone No & Tin No. Commented by Venkat. M PARLECS/0321/048
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	--And ISNULL(A.RTRPHONENO,'') <> ''
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Duplicate Phone Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	--AND ISNULL(A.RTRPHONENO,'') <> ''
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	AND ISNULL(A.RtrTinNumber,'') <> ''
	----------------- Retailer Tin No validation commented by lakshman M on 17/01/2018 PMS ID: ICRSTPAR7316 --------------------
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Duplicate Tin Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	--AND ISNULL(A.RtrTinNumber,'') <> ''
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Tin Number length Should be between 8 to 12-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Phone Number length Should be between 8 to 10-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
---------------------- Till Here ---------------------
	--Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	--Company Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Company Retailer Code Should Not be Empty-'+CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	--Retailer Name
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Name Should Not be Empty-'+RtrName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	--Retailer Address
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Address1 Should Not be Empty-'+RtrAddress1 FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	--Retailer Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Not Available-'+RetailerGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS RetailerGeoLevel 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	--Retailer Geography Value Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoCode NOT IN 
	(SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Not Available-'+RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoCode NOT IN (SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Wrongly Mapped-'+RetailerGeoLevel+'-'+RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	
	--Retailer Multiple Delivery Route
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Route','RMcode','Retailer Delivery Route Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry	
	
	--Retailer Category Value Class	Validation
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
    SELECT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'RetailerValueClass','ValueClassCode','Retailer Category and Value Class Not Available-'+
	RtrChannelCode+'-'+RtrGroupCode+'-'+RtrClassCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)


    -- Phone & Tin Number Dublicate Validation
	--IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
	--BEGIN
	--	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	--	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration (NOLOCK) WHERE isnull(RtrPhoneNo,'') = ''
		
	--	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Mandatory-'+ RtrCode 
	--	FROM Cn2Cs_Prk_RetailerMigration  (NOLOCK)	where isnull(RtrPhoneNo,'') = ''		
		
	--END
    	---- Commented By Venkat. M PARLECS/0321/048
	--SELECT DISTINCT RtrPhoneNo,COUNT(RtrPhoneNo) AS Counts INTO #RtrPhoneNo FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	--group BY RtrPhoneNo HAVING COUNT(RtrPhoneNo) >1	
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	--SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	--INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo
	--where isnull(A.RtrPhoneNo,'') <> ''
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Unique-'+ A.RtrCode 
	--FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo	
	--where isnull(A.RtrPhoneNo,'') <> ''
	----Tin Number Validation
	SELECT DISTINCT RtrTinNumber,COUNT(RtrTinNumber) AS Counts INTO #RtrTinNumber FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	group BY RtrTinNumber HAVING COUNT(RtrTinNumber) >1
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrTinNumber','Retailer Tin Number Should be Unique-'+ A.RtrCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
     	
	--To Insert the Salesman Details
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)
	
	INSERT INTO SalesmanMasterMigration (SMDCode,SMNCode,SMName,Upload,DownloadedDate)
	SELECT DISTINCT SalesmanCode,SalesmanCode AS SMCode,
	SalesManName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS 
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	INSERT INTO Salesman (SMId,SMCode,SMName,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,SMCreditDays,CmpId,
    SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,HHTDeviceSerialNumber,OldSmCode) -- UAT ISSUE
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalesmanCode)+@SmId) AS SmId,
	SalesmanCode AS SMCode,SalesManName,0 AS SMPhoneNumer,
	'' AS SMEmailID,'' AS SMOtherDetails,0.00 AS SMDailyAllowance,0.00 AS SMMonthlySalary,0.00 AS SMMktCredit,0 AS SMCreditDays,0 AS CmpId,
	0 AS SalesForceMainId,1 AS [Status],0 AS SMCreditAmountAlert,0 AS SMCreditDaysAlert,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
	CONVERT(NVARCHAR(10),GETDATE(),121),0,'' ,SalesmanCode AS OldSMCode--CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS -- UAT ISSUE
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)	
	UPDATE Counters SET CurrValue = @SmId WHERE TabName = 'Salesman' AND FldName = 'SMId'
	
	--To Insert the Sales Route Details 
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	SELECT @DlvRmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMasterMigration (RMSalDCode,RMSalNCode,RMSalName,RMDlvDCode,RMDlvNCode,RMDlvName,Upload,DownloadedDate)
	SELECT DISTINCT SalRouteCode,SalRouteCode AS RMCode,SalRouteName,DlvRouteCode,DlvRouteCode AS RMCode,
	DlvRouteName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C 
	WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,'') AND A.DlvRouteCode = ISNULL(C.DlvRouteCode,'')) 
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,OLDRmCode)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalRouteCode)+@RmId) AS RmId,
	SalRouteCode AS RMCode,SalRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,1 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0,
	SalRouteCode AS OldRMCode   --CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,''))
	
	--To Insert the Delivery Route Details
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,OldRmCode)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY DlvRouteCode)+@RmId) AS RmId,
	DlvRouteCode AS RMCode,DlvRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,2 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0 ,
	DlvRouteCode AS OldRMCode  ---CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(DlvRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.DlvRouteCode = ISNULL(C.DlvRouteCode,''))
	
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	UPDATE Counters SET CurrValue = @RmId WHERE TabName = 'RouteMaster' AND FldName = 'RMId'
	
	--Salesman Market Value Added
	INSERT INTO SalesmanMarket (SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT DISTINCT SMId,RmId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH(NOLOCK) ON A.SalRouteCode  = B.RMCode  
	INNER JOIN Salesman C WITH(NOLOCK) ON A.SalesManCode  = C.SMCode  WHERE B.RMSRouteType = 1 AND NOT EXISTS
	(SELECT SMId,RMId FROM SalesmanMarket D WITH(NOLOCK) WHERE C.SMId = D.SMId AND B.RMId = D.RMId)	
	
	
	--To Insert the Retailer Details
    SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,B.CtgMainId AS CtgLevelId,
    B.CtgCode AS CtgLevelCode,B.CtgName AS CtgLevelName,C.CtgMainId,C.CtgCode,C.CtgName,D.RtrClassId,D.ValueClassCode,D.ValueClassName,
    SalRouteName,DlvRouteName,[Status],RetailerGeoLevel,RetailerGeoCode,RtrPhoneNo,RtrTinNumber,RtrTaxGroupCode,ISNULL(E.RtrUniqueCode,'')  AS RtrUniqueCode,
    ISNULL(E.RtrCodeUserInput,'') AS RtrCodeUserInput,SalRouteCode,DlvRouteCode,ISNULL(E.RtrType,'') AS RtrType
    INTO #RetailerMigrationDetails FROM RetailerCategoryLevel A WITH(NOLOCK) 
    INNER JOIN RetailerCategory B WITH(NOLOCK) ON A.CtgLevelId = B.CtgLevelId
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgMainId = C.CtgLinkId  
    INNER JOIN RetailerValueClass D WITH(NOLOCK) ON C.CtgMainId = D.CtgMainId 
    INNER JOIN Cn2Cs_Prk_RetailerMigration E WITH(NOLOCK) ON B.CtgCode = E.RtrChannelCode AND C.CtgCode = E.RtrGroupCode AND DownLoadFlag = 'D'
    AND D.ValueClassCode = E.RtrClassCode WHERE CmpRtrCode NOT IN (SELECT ISNULL(RetailerCode,'') FROM #ToAvoidRetailerMigration)
	
	INSERT INTO RetailerMasterMigration (SMName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,RtrCtgLevelId,RtrChannelCode,
	RtrCtgMainId,RtrGroupCode,RtrValClassId,RtrClassCode,RtrGeoLevelId,RtrGeoLvelName,RtrGeoId,RtrGeoName,RtrSalRMId,RtrSalRoute,RtrDlvRMId,RtrDlvRoute,
	RtrStatus,Upload,DownloadedDate,RtrPhoneNo,RtrTinNumber,RtrTaxGroupId,RtrUniqueCode,RtrCodeUserInput,RtrType)
	SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,ISNULL(RtrAddress2,0) AS RtrAddress2,ISNULL(RtrAddress3,0) as RtrAddress3,RtrPincode,CtgLevelId,CtgLevelName,
	CtgMainId,CtgName,RtrClassId,ValueClassName,B.GeoLevelId,RetailerGeoLevel,C.GeoMainId,GeoName,D.RmId,SalRouteName,E.RmId,DlvRouteName,
	[Status],0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121),ISNULL(RtrPhoneNo,0) AS RtrPhoneNo,ISNULL(RtrTinNumber,0) AS RtrTinNumber,---------- Null Values validation added in CS Pms id: ICRSTPAR7619
	ISNULL(TaxGroupId,0)AS RtrTaxGroupId,A.RtrUniqueCode,A.RtrCodeUserInput,A.RtrType
	FROM #RetailerMigrationDetails A (NOLOCK) 
	INNER JOIN GeographyLevel B WITH(NOLOCK) ON A.RetailerGeoLevel = B.GeoLevelName
	INNER JOIN Geography C WITH(NOLOCK) ON A.RetailerGeoCode = C.Geoname AND B.GeoLevelId = C.GeoLevelId
	INNER JOIN RouteMaster D WITH(NOLOCK) ON A.SalRouteCode  = D.RMCode  AND D.RMSRouteType = 1
	INNER JOIN RouteMaster E WITH(NOLOCK) ON A.DlvRouteCode  = E.RMCode  AND E.RMSRouteType = 2
	LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON A.RtrTaxGroupCode = TGS.RtrGroup AND TGS.TaxGroup = 1
	WHERE CmpRtrCode NOT IN (SELECT DISTINCT CmpRtrCode FROM RetailerMasterMigration (NOLOCK))
			
	UPDATE A SET A.Upload = 1 FROM SalesmanMasterMigration A WITH(NOLOCK) INNER JOIN Salesman B WITH (NOLOCK) ON A.SMName = B.SMName 
	
	UPDATE A SET A.Upload = 1 FROM RouteMasterMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH (NOLOCK) ON A.RMSalDCode = B.RMCode  AND B.RMSRouteType = 1
	INNER JOIN RouteMaster C WITH (NOLOCK) ON A.RMDlvDCode = C.RMCode  AND C.RMSRouteType = 2
	UPDATE A SET DownloadFlag = 'Y' FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RetailerMasterMigration B WITH(NOLOCK) ON A.CmpRtrCode = B.CmpRtrCode
	--------------- Added  by Lakshman M Dated ON 28-12-2018 PMS ID:ILCRSTPAR2934 Default taxgroup validation added.
	SELECT  @Taxgroupid = Taxgroupid from TaxGroupSetting where RtrGroup ='RTRINTRA'
	UPDATE A set Rtrtaxgroupid =@Taxgroupid FROM RetailerMasterMigration A WHERE Rtrtaxgroupid = 0
	------------- Till here ------------
END
GO
DELETE FROM RptFilter WHERE RptId=60 and SelcId=69
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (60,69,1,'Summary')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (60,69,2,'Details')
GO
DELETE FROM RptDetails WHERE RptId=60 and SlNo=14
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (60,14,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Report Type*...',NULL,1,NULL,69,1,1,'Press F4/Double Click to select Report Type',0)
GO
DELETE FROM RptFormula WHERE RptId=60 and SlNo IN (32,33)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) 
SELECT 60,32,'Disp_OrderNo','Order No',1,0 UNION
SELECT 60,33,'Disp_SalInvno','Invoice No',1,0 
GO
UPDATE A SET FormulaValue='No.Of lines Ordered Received (Units)' FROM RptFormula A WHERE RptId=60 AND SLNO=26
UPDATE A SET FormulaValue='No.Of lines Ordered Serviced (Units)' FROM RptFormula A WHERE RptId=60 AND SLNO=27
GO
DELETE FROM RptExcelHeaders WHERE RptId=60
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) 
SELECT 60,1,'CmpId','CmpId',0,1 UNION
SELECT 60,2,'SMId','SMId',0,1 UNION
SELECT 60,3,'RMId','RMId',0,1 UNION
SELECT 60,4,'RtrId','RtrId',0,1 UNION
SELECT 60,5,'PrdId','PrdId',0,1 UNION
SELECT 60,6,'SMName','Salesman',1,1 UNION
SELECT 60,7,'RMName','Route',1,1 UNION
SELECT 60,8,'RtrCode','Retailer Code',1,1 UNION
SELECT 60,9,'RtrName','Retailer',1,1 UNION
SELECT 60,10,'SalInvNo','Invoice No',1,1 UNION
SELECT 60,11,'OrderNo','Order No',1,1 UNION
SELECT 60,12,'PrdName','Product ',1,1 UNION
SELECT 60,13,'Received','Order Received',1,1 UNION
SELECT 60,14,'Serviced','Order Serviced',1,1 UNION
SELECT 60,15,'Type','Type',0,1 UNION
SELECT 60,16,'QtyFillRatio','Fill Ratio',1,1 
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.ID 
WHERE A.NAME='TempOrderChange' AND B.name='SalInvno' AND A.xtype='U')
BEGIN
	ALTER TABLE TempOrderChange ADD SalInvno VARCHAR(100)
END
GO
update TempOrderChange set SalInvno='' where SalInvno is null
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_QuantityFillRatioDetails' AND xtype='P')
DROP PROCEDURE Proc_QuantityFillRatioDetails
GO
--exec Proc_QuantityFillRatioDetails 60,1,1
CREATE PROCEDURE Proc_QuantityFillRatioDetails
(  
	 @Pi_RptId  INT,  
	 @Pi_UserId  INT,  
	 @Pi_TypeId  INT  
)  
AS  
BEGIN  
/*********************************  
* PROCEDURE: Proc_QuantityFillRatioDetails  
* PURPOSE: DISPLAY THE QTYFILL IN Invoice,Order No Wise 
* NOTES:  
* CREATED: MAHALAKSHMI.A  
* ON DATE: 15-12-2007  
* MODIFIED  
* DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  05/08/2021    S.Moorthi			 CR		PA-I39					Fill Rate Report additional Filter (Summary & Details)
*********************************/  
SET NOCOUNT ON  
	DECLARE @FromDate AS DATETIME  
	DECLARE @ToDate   AS DATETIME  
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UserId)  
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UserId)  
	DELETE FROM TempOrderChange WHERE RptId=@Pi_RptId AND UserId=@Pi_UserId  
	
	IF @Pi_TypeId = 1 --LineFill  
	BEGIN  
		INSERT INTO TempOrderChange (SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,  
		PRDNAME,RECEIVED,SERVICED,Type,CTGLEVELID,CTGMAINID,RtrClassId,RptId,UserId)  
		--SELECT Distinct A.SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,
		--RTRCODE,PRDNAME,SUM(RECEIVED) AS RECEIVED,SUM(SERVICED) AS SERVICED,Type,CTGLEVELID,CTGMAINID,RtrClassId,RPTID,USERID FROM ( 
		SELECT  DISTINCT A.SalId AS SalId,C.ORDERDATE,C.ORDERNO,G.CMPID,C.SMID,C.RMID,C.RTRID,H.PRDID,F.SMNAME,D.RMNAME,E.RTRNAME,  
		E.RTRCODE,G.PRDNAME,0 AS RECEIVED,COUNT(DISTINCT H.PRDID) AS SERVICED,1 as Type,RG.CTGLEVELID,  
		RC.CTGMAINID,RV.RtrValueClassId AS RtrClassId,@Pi_RptId AS RptID,@Pi_UserId AS UserID 
		FROM SALESINVOICEPRODUCT A  
		INNER JOIN SALESINVOICEORDERBOOKING H ON A.SalID = H.SalId  
		LEFT OUTER JOIN  ORDERBOOKINGPRODUCTS B ON H.PRDID=B.PRDID  
		AND H.ORDERNO=B.ORDERNO   
		INNER JOIN ORDERBOOKING C ON H.ORDERNO=C.ORDERNO  
		INNER JOIN ROUTEMASTER  D ON C.RMID=D.RMID  
		INNER JOIN RETAILER E ON C.RTRID=E.RTRID  
		INNER JOIN SALESMAN F ON C.SMID=F.SMID  
		INNER JOIN RETAILERVALUECLASSMAP RV ON RV.RtrId=E.RtrId  
		INNER JOIN RETAILERVALUECLASS RC ON RC.RtrClassId=RV.RtrValueClassId  
		INNER JOIN RetailerCategory RG ON RG.CtgMainId=RC.CtgMainId  
		INNER JOIN PRODUCT G ON  H.PRDID=G.PRDID   
		--INNER JOIN PRODUCTBATCH I ON G.PRDID=I.PRDID AND A.PrdId=I.PrdId   
		--AND A.PrdBatId=I.PrdBatId --AND B.PrdID=I.PrdID AND B.PrdBatId=I.PrdBatId   
		--AND H.PrdID=I.PrdID --AND H.PrdBatId=I.PrdBatId  
		WHERE OrderDate BETWEEN @FromDate AND @ToDate    
		GROUP BY A.SalId,C.ORDERDATE,C.ORDERNO,G.CMPID,C.SMID,C.RMID,C.RTRID,H.PRDID,F.SMNAME,ISNULL(A.PrdId,0),  
		D.RMNAME,E.RTRNAME,E.RTRCODE,G.PRDNAME,RG.CTGLEVELID,RC.CTGMAINID,RV.RtrValueClassId  

		--UNION 

		SELECT DISTINCT 0 AS SalId,C.ORDERDATE,C.ORDERNO,G.CMPID,C.SMID,C.RMID,C.RTRID,B.PRDID,F.SMNAME,D.RMNAME,E.RTRNAME,  
		E.RTRCODE,G.PRDNAME,COUNT(DISTINCT B.PRDID) AS RECEIVED,0 AS SERVICED,1 as Type,RG.CTGLEVELID,  
		RC.CTGMAINID,RV.RtrValueClassId AS RtrClassId,@Pi_RptId as RptID,@Pi_UserId as UserID 
		INTO #TempLineCount
		FROM  ORDERBOOKINGPRODUCTS B
		INNER JOIN ORDERBOOKING C ON B.ORDERNO=C.ORDERNO  
		INNER JOIN ROUTEMASTER  D ON C.RMID=D.RMID  
		INNER JOIN RETAILER E ON C.RTRID=E.RTRID  
		INNER JOIN SALESMAN F ON C.SMID=F.SMID  
		INNER JOIN RETAILERVALUECLASSMAP RV ON RV.RtrId=E.RtrId  
		INNER JOIN RETAILERVALUECLASS RC ON RC.RtrClassId=RV.RtrValueClassId  
		INNER JOIN RetailerCategory RG ON RG.CtgMainId=RC.CtgMainId  
		INNER JOIN PRODUCT G ON  B.PRDID=G.PRDID 		
		--INNER JOIN PRODUCTBATCH I ON G.PRDID=I.PRDID 
		--AND B.PrdID=I.PrdID AND B.PrdBatId=I.PrdBatId   
		WHERE OrderDate  BETWEEN @FromDate AND @ToDate
		   GROUP BY C.ORDERDATE,C.ORDERNO,G.CMPID,C.SMID,C.RMID,C.RTRID,B.PRDID,F.SMNAME,ISNULL(b.PrdId,0), 
		D.RMNAME,E.RTRNAME,E.RTRCODE,G.PRDNAME,RG.CTGLEVELID,RC.CTGMAINID,RV.RtrValueClassId  
		--) A
		--GROUP BY SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,
		--RTRCODE,PRDNAME,Type,CTGLEVELID,CTGMAINID,RtrClassId,RPTID,USERID

		UPDATE B SET B.RECEIVED=A.RECEIVED FROM #TempLineCount A 
		INNER JOIN TempOrderChange B ON A.OrderNo=B.ORDERNO AND A.PrdId=B.PRDID and A.RtrId=B.RTRID 
		AND A.RptID=B.RptId AND A.UserID=B.UserId

		INSERT INTO TempOrderChange (SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,  
		PRDNAME,RECEIVED,SERVICED,Type,CTGLEVELID,CTGMAINID,RtrClassId,RptId,UserId) 
		SELECT SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,  
		PRDNAME,RECEIVED,SERVICED,Type,CTGLEVELID,CTGMAINID,RtrClassId,RptId,UserId FROM #TempLineCount A
		WHERE NOT EXISTS(SELECT * FROM TempOrderChange B WHERE A.OrderNo=B.ORDERNO AND A.PrdId=B.PRDID and A.RtrId=B.RTRID 
		AND A.RptID=B.RptId AND A.UserID=B.UserId)


	END  
	IF @Pi_TypeId = 2 --QtyFill  
	BEGIN  
		INSERT INTO TempOrderChange (SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,  
		PRDNAME,RECEIVED,SERVICED,[Type],CTGLEVELID,CTGMAINID,RtrClassId,RptId,UserId)  
		SELECT SalId AS SalId,C.OrderDate,C.OrderNo,P.CmpId,S.SMId,RM.RMId,R.RtrId,X.PrdId,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,
		Sum(TotalQty) RECEIVED,SUM(BilledQty) SERVICED, 2 AS [Type],CTGLEVELID,RG.CTGMAINID,RtrClassId,@Pi_RptId AS RptId,@Pi_UserId AS UserId
		FROM 
		(
		SELECT 0 AS SalId,A.OrderNo,Prdid,Prdbatid,BilledQty,TotalQty FROM  OrderBookingProducts A  
		WHERE NOT EXISTS(SELECT OrderNo,Prdid,Prdbatid FROM SALESINVOICEORDERBOOKING B
		WHERE A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid)-- AND A.Prdbatid=B.Prdbatid)
		UNION ALL
		SELECT A.salid AS SalId,OrderNo,Prdid,Prdbatid,BilledQty,0 AS TotalQty  
		FROM SALESINVOICEORDERBOOKING A WHERE NOT EXISTS(SELECT OrderNo,Prdid,Prdbatid FROM OrderBookingProducts B
		WHERE A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid)-- AND A.Prdbatid=B.Prdbatid)
		UNION ALL
		SELECT B.SALID AS SalId,A.OrderNo,A.Prdid,A.Prdbatid,B.BilledQty,A.TotalQty FROM  OrderBookingProducts A  
		INNER JOIN SALESINVOICEORDERBOOKING B ON 
		A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid --AND A.Prdbatid=B.Prdbatid
		) X 
		INNER JOIN OrderBooking C ON X.OrderNO=C.OrderNO
		INNER JOIN Salesman S ON S.SMId = C.SmId
		INNER JOIN RouteMaster RM ON RM.RMId=C.RmId
		INNER JOIN Retailer R ON R.RtrId=C.RtrId
		INNER JOIN Product P ON X.PrdId=P.PrdId
		--INNER JOIN ProductBatch PB ON X.PrdId=PB.PrdId AND X.PrdBatId=PB.PrdBatId
		INNER JOIN RETAILERVALUECLASSMAP RV ON RV.RtrId=R.RtrId  
		INNER JOIN RETAILERVALUECLASS RC ON RC.RtrClassId=RV.RtrValueClassId  
		INNER JOIN RetailerCategory RG ON RG.CtgMainId=RC.CtgMainId  
		WHERE C.OrderDate BETWEEN @FromDate AND @ToDate  
		GROUP BY SalId,C.OrderDate,C.OrderNo,P.CmpId,S.SMId,RM.RMId,R.RtrId,X.PrdId,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,
		CTGLEVELID,RG.CTGMAINID,RtrClassId
	END
	IF @Pi_TypeId=3 -- ADDED BY PRAVEENRAJ.B FOR Value Fill Ratio
	BEGIN
		INSERT INTO TempOrderChange (SalId,ORDERDATE,ORDERNO,CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,  
		PRDNAME,RECEIVED,SERVICED,Type,CTGLEVELID,CTGMAINID,RtrClassId,RptId,UserId)  
				SELECT X.SalId,C.OrderDate,C.OrderNo,P.CmpId,S.SMId,RM.RMId,R.RtrId,X.PrdId,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,
				IsNull(Sum(Received),0) RECEIVED,Isnull(Sum(SIP.PrdGrossAmount),0) SERVICED, 3 AS [Type],CTGLEVELID,RG.CTGMAINID,
				RtrClassId,@Pi_RptId AS RptId,@Pi_UserId AS UserId FROM 
				(
				SELECT A.OrderNo,Prdid,Prdbatid,A.GrossAmount AS Received,0 AS Serviced,0 AS SalId FROM  OrderBookingProducts A  
				WHERE NOT EXISTS(SELECT OrderNo,Prdid,Prdbatid FROM SALESINVOICEORDERBOOKING B
				WHERE A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid) --AND A.Prdbatid=B.Prdbatid)
				UNION ALL
				SELECT OrderNo,Prdid,Prdbatid,0 AS Received,0 AS Serviced,A.SalId 
				FROM SALESINVOICEORDERBOOKING A WHERE NOT EXISTS(SELECT OrderNo,Prdid,Prdbatid FROM OrderBookingProducts B
				WHERE A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid)-- AND A.Prdbatid=B.Prdbatid)
				UNION ALL
				SELECT A.OrderNo,A.Prdid,A.Prdbatid,A.GrossAmount AS Received,0 AS Serviced,B.SalId FROM  OrderBookingProducts A  
				INNER JOIN SALESINVOICEORDERBOOKING B ON 
				A.OrderNo=B.OrderNo AND A.Prdid=B.Prdid-- AND A.Prdbatid=B.Prdbatid
				) X 
				LEFT OUTER JOIN SalesInvoiceProduct SIP ON X.SalId=SIP.SalId AND SIp.PrdId=X.PrdId --AND SIp.PrdBatId=X.PrdBatId
				INNER JOIN OrderBooking C ON X.OrderNO=C.OrderNO
				INNER JOIN Salesman S ON S.SMId = C.SmId
				INNER JOIN RouteMaster RM ON RM.RMId=C.RmId
				INNER JOIN Retailer R ON R.RtrId=C.RtrId
				INNER JOIN Product P ON X.PrdId=P.PrdId
				--INNER JOIN ProductBatch PB ON X.PrdId=PB.PrdId AND X.PrdBatId=PB.PrdBatId
				INNER JOIN RETAILERVALUECLASSMAP RV ON RV.RtrId=R.RtrId  
				INNER JOIN RETAILERVALUECLASS RC ON RC.RtrClassId=RV.RtrValueClassId  
				INNER JOIN RetailerCategory RG ON RG.CtgMainId=RC.CtgMainId  
				WHERE C.OrderDate BETWEEN @FromDate AND @ToDate
				GROUP BY X.SalId,C.OrderDate,C.OrderNo,P.CmpId,S.SMId,RM.RMId,R.RtrId,X.PrdId,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,
				CTGLEVELID,RG.CTGMAINID,RtrClassId
	END  
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptQuantityRatioReport' AND xtype='P')
DROP PROCEDURE Proc_RptQuantityRatioReport
GO
--EXEC Proc_RptQuantityRatioReport 60,1,0,'ParleBug',0,0,1  
CREATE PROCEDURE Proc_RptQuantityRatioReport
(  
 @Pi_RptId  INT,  
 @Pi_UsrId  INT,  
 @Pi_SnapId  INT,  
 @Pi_DbName  nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
/************************************************************  
* VIEW : Proc_RptQuantityRatioReport  
* PURPOSE : To get the Order Quantity Details  
* CREATED BY : Mahalakshmi.A  
* CREATED DATE : 17/12/2007  
* NOTE  :  
* MODIFIED  
* DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  05/08/2021    S.Moorthi			 CR		PA-I39					Fill Rate Report additional Filter (Summary & Details)
*************************************************************/  
BEGIN  
SET NOCOUNT ON  
 DECLARE @NewSnapId  AS INT  
 DECLARE @DBNAME  AS  nvarchar(50)  
 DECLARE @TblName  AS nvarchar(500)  
 DECLARE @TblStruct  AS nVarchar(4000)  
 DECLARE @TblFields  AS nVarchar(4000)  
 DECLARE @sSql  AS  nVarChar(4000)  
 DECLARE @ErrNo   AS INT  
 DECLARE @PurDBName AS nVarChar(50)  
 --Filter Variables  
 DECLARE @FromDate AS DATETIME  
 DECLARE @ToDate   AS DATETIME  
 DECLARE @CmpId   AS INT  
 DECLARE @SMId   AS INT  
 DECLARE @RMId   AS INT  
 DECLARE @RtrId   AS INT  
 DECLARE @PrdCatId AS INT  
 DECLARE @PrdId  AS INT  
 DECLARE @CtgLevelId AS  INT  
 DECLARE @RtrClassId AS  INT  
 DECLARE @CtgMainId  AS  INT  
 DECLARE @TypeId  AS INT 
 DECLARE @SummaryDetails AS INT 
 ----Till Here  
 --Assgin Value for the Filter Variable  
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)  
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)  
 SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))  
 SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
 SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))  
 SET @RtrId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))  
 SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))  
 SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))  
 SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))  
 SET @TypeId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,73,@Pi_UsrId))  

 SET @SummaryDetails = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,69,@Pi_UsrId))  

 EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId  
 SET @PrdCatId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))  
 SET @PrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))  
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)  
 EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId  
 ---Till Here  
 Create TABLE #RptQuantityRatioReport  
 (  
    CMPID  INT,  
    SMID  INT,  
    RMID  INT,  
    RTRID  INT,  
    PRDID  INT,  
    SMNAME  NVARCHAR(100),  
    RMNAME  NVARCHAR(100),  
    RTRNAME  NVARCHAR(100),  
    RTRCODE  NVARCHAR(100),  
    PRDNAME  NVARCHAR(100), 
	ORDERNO  NVARCHAR(100), 
	SALINVNO  NVARCHAR(100), 
    RECEIVED Numeric(18,6),  
    SERVICED Numeric(18,6),  
    Type  INT  
 )  
 SET @TblName = 'RptQuantityRatioReport'  
 SET @TblStruct = ' CMPID  INT,  
    SMID  INT,  
    RMID  INT,  
    RTRID  INT,  
    PRDID  INT,  
    SMNAME  NVARCHAR(100),  
    RMNAME  NVARCHAR(100),  
    RTRNAME  NVARCHAR(100),  
    RTRCODE  NVARCHAR(100),  
    PRDNAME  NVARCHAR(100),  
    RECEIVED Numeric(18,6),  
    SERVICED Numeric(18,6),  
    Type  INT'  
 SET @TblFields = 'CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,RECEIVED,SERVICED,Type'  
 IF @Pi_GetFromSnap = 1  
 BEGIN  
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId  
  SET @DBNAME = @DBNAME  
 END  
 ELSE  
 BEGIN  
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3  
  SET @DBNAME = @PI_DBNAME + @DBNAME  
 END 
 UPDATE RptExcelHeaders SET DisplayFlag = 1 WHERE SlNo = 10
 IF @TypeID = 1
 BEGIN
   UPDATE RptExcelHeaders SET DisplayFlag = 0 WHERE SlNo = 10
 END
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data  
 BEGIN  
	

	IF @SummaryDetails=1
	BEGIN
		EXECUTE Proc_QuantityFillRatio @Pi_RptId,@Pi_UsrId,@TypeId

		UPDATE TempOrderChange SET ORDERNO='',SalInvno='' WHERE UserId=@Pi_UsrId
		UPDATE A SET A.DisplayFlag=0 FROM RptExcelHeaders A WHERE RptId=60 and SlNo IN (10,11)
	END
	ELSE
	BEGIN
		EXEC Proc_QuantityFillRatioDetails @Pi_RptId,@Pi_UsrId,@TypeId

		UPDATE  A SET SalInvno=B.SalInvNo FROM TempOrderChange A 
		INNER JOIN SalesInvoice B ON A.ORDERNO=B.OrderKeyNo AND A.SalId=B.SalId

		UPDATE A SET A.DisplayFlag=1 FROM RptExcelHeaders A WHERE RptId=60 and SlNo IN (10,11)
	END
  
 
	IF @TypeID=1  
	BEGIN  
		INSERT INTO #RptQuantityRatioReport (CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,Type )  
		SELECT DISTINCT CMPID,SMID,RMID,RTRID,'',SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,'',SUM(RECEIVED) AS RECEIVED,SUM(SERVICED)AS SERVICED,Type  
		FROM TempOrderChange   
		WHERE  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR  
			CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		AND  
		(SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
			SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
		AND  
		(RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
			RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
		AND  
		(CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR  
			CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
		AND  
		(RtrId=(CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR  
			RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))   
		AND  
		(RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR  
			RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
		AND  
		(CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR  
			CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
		AND   
		(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR  
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))  
		GROUP BY CMPID,SMID,RMID,RTRID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,Type  
	END  

	IF @TypeID=2  
	BEGIN  

		--INSERT INTO #RptQuantityRatioReport (CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,RECEIVED,SERVICED,Type )  
		--   SELECT DISTINCT CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,RECEIVED ,SERVICED,Type  
		--   FROM TempOrderChange   
		--   WHERE  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR  
		--	CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		--   AND  
		--   (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
		--	SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
		--   AND  
		--   (RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
		--	RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
		--   AND  
		--   (CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR  
		--	CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
		--   AND  
		--   (RtrId=(CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR  
		--	RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))   
		--   AND  
		--   (RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR  
		--	RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
		--   AND  
		--   (CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR  
		--	CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
		--   AND   
		--   (PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR  
		--   PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))  
		--   GROUP BY CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,PRDNAME,RECEIVED,SERVICED,Type  
  
		INSERT INTO #RptQuantityRatioReport (CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,Type )  
		SELECT DISTINCT CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,SUM(RECEIVED) ,SUM(SERVICED),Type  
		FROM TempOrderChange   
		WHERE  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR  
		CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		AND  
		(SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
		SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
		AND  
		(RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
		RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
		AND  
		(CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR  
		CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
		AND  
		(RtrId=(CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR  
		RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))   
		AND  
		(RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR  
		RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
		AND  
		(CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR  
		CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
		AND   
		(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR  
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))  
		GROUP BY CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,Type
		  
	END  
	IF @TypeID=3 --Value Fill
	BEGIN
		INSERT INTO #RptQuantityRatioReport (CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,Type )  
		SELECT DISTINCT CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,SUM(RECEIVED),SUM(SERVICED),Type  
		FROM TempOrderChange   
		WHERE  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR  
		CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
	   AND  
	   (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
		SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
	   AND  
	   (RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
		RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
	   AND  
	   (CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR  
		CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
	   AND  
	   (RtrId=(CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR  
		RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))   
	   AND  
	   (RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR  
		RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
	   AND  
	   (CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR  
		CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
	   AND   
	   (PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR  
	   PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))  
	   GROUP BY CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRNAME,RTRCODE,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,Type 
	END
  IF LEN(@PurDBName) > 0  
  BEGIN  
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT  
   SET @SSQL = 'INSERT INTO #RptQuantityRatioReport ' +  
    '(' + @TblFields + ')' +  
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName   
    + 'WHERE BillStatus=1  AND (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '  
    + 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '  
    + 'AND (SMId = (CASE ' + CAST(@SMId AS nVarchar(10)) + ' WHEN 0 THEN SMId ELSE 0 END) OR '  
    + 'SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'  
    + 'AND (RtrId = (CASE ' + CAST(@RtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrId ELSE 0 END) OR '  
    + 'RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'  
    + 'AND (RMId = (CASE ' + CAST(@RMId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR '  
    + 'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '  
    + 'AND(CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR'  
    + 'CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters('+  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',29,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'  
    + 'AND(RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR '  
    + 'RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters('+  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',31,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '  
    + 'AND(CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR '  
    + 'CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters('+  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',30,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '  
    + 'AND (PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR '  
    + 'PrdId in (SELECT iCountid from Fn_ReturnRptFilters('+  
    + CAST(@Pi_RptId AS nVarchar(10)) + ',5,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '  
    + 'AND OrderDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''  
   EXEC (@SSQL)  
   PRINT 'Retrived Data From Purged Table'  
  END  
  IF @Pi_SnapRequired = 1  
  BEGIN  
   SELECT @NewSnapId = @Pi_SnapId  
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
   IF @ErrNo = 0  
   BEGIN  
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +  
     '(SnapId,UserId,RptId,' + @TblFields + ')' +  
     ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +  
     ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
     ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptQuantityRatioReport'  
    EXEC (@SSQL)  
    PRINT 'Saved Data Into SnapShot Table'  
   END  
  END  
 END  
 ELSE    --To Retrieve Data From Snap Data  
 BEGIN  
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
    @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
  PRINT @ErrNo  
  IF @ErrNo = 0  
  BEGIN  
   SET @SSQL = 'INSERT INTO #RptQuantityRatioReport ' +  
    '(' + @TblFields + ')' +  
    ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +  
    ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +  
    ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
    ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))  
   EXEC (@SSQL)  
   PRINT 'Retrived Data From Snap Shot Table'  
  END  
  ELSE  
  BEGIN  
   PRINT 'DataBase or Table not Found'  
  END  
 END  
 --Check for Report Data  
 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId  
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
 SELECT @Pi_RptId,Count(*) AS RecCount,@ErrNo,@Pi_UsrId FROM #RptQuantityRatioReport  
 -- Till Here  
 --SELECT * FROM #RptQuantityRatioReport  
 --SELECT CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRCODE,RTRNAME,PRDNAME,RECEIVED,SERVICED,Type  
 --FROM #RptQuantityRatioReport  
 -- CHANGES MADE BY MOORTHI  FOR EXCEL COL FILL RATIO
 SELECT CMPID,SMID,RMID,RTRID,PRDID,SMNAME,RMNAME,RTRCODE,RTRNAME,SalInvno,ORDERNO,PRDNAME,RECEIVED,SERVICED,[Type],
 (CASE RECEIVED WHEN 0 THEN 0 ELSE ((SERVICED/RECEIVED)*100) END) AS FillRate  
 FROM #RptQuantityRatioReport 
 RETURN  
END
GO
/*
Create View - For collect dummy records of the sales hierarchy

SalesMan - Dummy salesman record in case of Salesman name like nummy
RouteMaster - Dummy route record in case of Router name like dummy Or Parent salesman name like dummy
Retailer - Dummy retailer record in case of Retailer name like dummy or Parent route name like dummy
*/
IF EXISTS(SELECT * FROM SysObjects WHERE XType='V' And Name='View_Sales_Hierarchy_Dummy')
DROP VIEW View_Sales_Hierarchy_Dummy
GO
CREATE VIEW View_Sales_Hierarchy_Dummy AS
SELECT DISTINCT 
		S.SMId,S.SMName,
		RM.RMID,RM.RMName,
		R.RtrId,R.RtrName 
FROM SalesManMarket SM
LEFT OUTER JOIN SalesMan S on S.SMId = SM.SMId AND (S.SMName LIKE '%Dummy%' OR S.SMCode LIKE '%Dummy%' OR S.SMName LIKE '%Online Agg%')
LEFT OUTER JOIN RouteMaster RM on RM.RMId = SM.RMId AND (RM.RMName LIKE '%Dummy%' OR RM.RMCode LIKE '%Dummy%' OR RM.RMName LIKE '%Online Agg%' OR S.SMId is not null)
LEFT OUTER JOIN RouteMaster RMA on RMA.RMId = SM.RMId
LEFT OUTER JOIN RetailerMarket RT on RT.RMId = RMA.RMId
LEFT OUTER JOIN Retailer R on R.RtrId = RT.RtrID AND (R.RtrName LIKE '%Dummy%' OR RM.RMId IS NOT NULL)
WHERE (S.SMId IS NOT NULL OR RM.RMID IS NOT NULL OR R.RtrId IS NOT NULL)
UNION ALL
SELECT NULL,NULL,RMId,RMName,NULL,NULL FROM RouteMaster
WHERE RMId not in (
	SELECT RMId FROM SalesManMarket
) AND (RMName LIKE '%Dummy%' OR RMCode LIKE '%Dummy%' OR RMName like '%Online Agg%')
GO
/*
Create View - Salesman records exclude dummy
*/
IF EXISTS(SELECT * FROM SysObjects WHERE XType='V' And Name='View_SalesMan_ED')
DROP VIEW View_SalesMan_ED
GO
CREATE VIEW View_SalesMan_ED AS
SELECT * FROM SalesMan
WHERE NOT EXISTS (
	SELECT * FROM View_Sales_Hierarchy_Dummy
	WHERE SMId = SalesMan.SMId
)
GO
/*
Create View - Route master records exclude dummy
*/
IF EXISTS(SELECT * FROM SysObjects WHERE XType='V' And Name='View_RouteMaster_ED')
DROP VIEW View_RouteMaster_ED
GO
CREATE VIEW View_RouteMaster_ED AS
SELECT * FROM RouteMaster
WHERE NOT EXISTS (
	SELECT * FROM View_Sales_Hierarchy_Dummy
	WHERE RMId = RouteMaster.RMId
)
GO
/*
Update tablename in report filter master records
*/
IF EXISTS(SELECT * FROM RptDetails WHERE RptId = 88 AND SLno = 2) 
UPDATE RptDetails SET TblName = 'View_RouteMaster_ED' WHERE RptId  = 88 AND SLno = 2
GO
IF EXISTS(SELECT * FROM RptDetails WHERE RptId = 155 AND SLno = 6) 
UPDATE RptDetails SET TblName = 'View_SalesMan_ED' WHERE RptId  = 155 AND SLno = 6
GO
/***
 * Route master Report:- Custom report-->Parle Report 
 */

IF EXISTS(SELECT * FROM SysObjects WHERE XType='P' AND Name='Proc_RptMastRoute') 
DROP PROCEDURE Proc_RptMastRoute
GO
CREATE PROCEDURE Proc_RptMastRoute (
	@Pi_RptId INT,
	@Pi_UsrId INT,
	@Pi_SnapId INT,
	@Pi_DbName NVARCHAR(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap INT,
	@Pi_CurrencyId INT	
)
AS

/************************************************************
* PROCEDURE:	Proc_RptMastRoute
* PURPOSE:		To get Top Outlet
* CREATED BY:	Jisha Mathew
* CREATED DATE: 25/02/2008
* NOTE:
* MODIFIED
------------------------------------------------
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
*******************************************************************************************************
* 27-07-2021   Boopathiraja M	  SR					   Hide dummy routes
*************************************************************/

SET NOCOUNT ON
BEGIN

	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nVARCHAR(50)
	DECLARE @TblName 	AS	nVARCHAR(500)
	DECLARE @TblStruct 	AS	nVARCHAR(4000)
	DECLARE @TblFields 	AS	nVARCHAR(4000)
	DECLARE @SSQL		AS 	VARCHAR(8000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVARCHAR(50)
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate		AS	DATETIME
	DECLARE @CmpId		AS	INT
	DECLARE @RMId		AS	INT
	DECLARE @Status 	AS 	TINYINT

	CREATE  TABLE #RptMastRoute (
			CmpId INT,
			CmpName NVARCHAR(100),
			RMId INT,
			RMCode NVARCHAR(100),
			RMName NVARCHAR(100),
			GeoLevelId INT,
			GeoLevelName NVARCHAR(100),
			GeoMainId INT,
			GeoName NVARCHAR(100),
			VanRouteType NVARCHAR(100),
			RouteType NVARCHAR(100),
			LocalUpcountry NVARCHAR(100),
			Status NVARCHAR(100),
			UsrId INT	
		)

	SET @CmpId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @RMId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @Status = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,104,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate) 
	PRint @FromDate
	DELETE FROM #RptMastRoute Where Usrid=@Pi_UsrId
	
	SET @TblName = 'RptMastRoute'
	SET @TblStruct ='CmpId INT,' + 
					'CmpName NVARCHAR(100),' + 
					'RMId INT,' + 
					'RMCode NVARCHAR(100),' + 
					'RMName NVARCHAR(100),' + 
					'GeoLevelId INT,' + 
					'GeoLevelName NVARCHAR(100),' + 
					'GeoMainId INT,' + 
					'GeoName NVARCHAR(100),' + 
					'VanRouteType NVARCHAR(100),' + 
					'RouteType NVARCHAR(100),' + 
					'LocalUpcountry NVARCHAR(100),' + 
					'Status NVARCHAR(100),'
	SET @TblFields = 'CmpId,CmpName,RMId,RMCode,' + 
					 'RMName,GeoLevelId,GeoLevelName,GeoMainId,GeoName,' + 
					 'VanRouteType,RouteType,LocalUpcountry,Status'
			 
	IF @Pi_GetFromSnap = 1 BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END

	IF @Pi_GetFromSnap = 0 BEGIN --To Generate For New Report Data
	   
		INSERT INTO #RptMastRoute (
				CmpId,CmpName,RMId,RMCode,RMName,
				GeoLevelId,GeoLevelName,GeoMainId,GeoName,
				VanRouteType,RouteType,LocalUpcountry,Status,UsrId)
		Select Distinct A.CmpId AS CmpId,CmpName,RMId,RMCode,RMName,
			   D.GeoLevelId AS GeoLevelId,GeoLevelName,C.GeoMainId AS GeoMainId,GeoName,
			  (CASE RMVanRoute WHEN 1 THEN 'YES' ELSE 'NO' END) AS VanRouteType,
			  (CASE RMSRouteType WHEN 1 THEN 'Sales Route' 
						WHEN 2 THEN 'Delivery Route'
						WHEN 3 THEN 'Merchandising Route'  END) AS RouteType,
			  (CASE RMLocalUpcountry WHEN 1 THEN 'Local' ELSE 'Country' END) AS LocalUpcountry,
			  (CASE RMStatus WHEN 1 THEN 'Active' ELSE 'Inactive' END) AS Status,@Pi_UsrId AS UsrId 
		From RouteMaster A
		INNER JOIN Company B On A.CmpId = B.CmpId
		INNER JOIN Geography C ON A.GeoMainId = C.GeoMainId
		INNER JOIN GeographyLevel D ON D.GeoLevelId = C.GeoLevelId
		WHERE (B.CmpId = (CASE @CmpId WHEN 0 THEN B.CmpId ELSE 0 END) OR
			   B.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	          (A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
			   A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			   A.RMId not in (SELECT isNull(RMId,0) FROM View_Sales_Hierarchy_Dummy) -- Added (Hide dummy route record)

   	   	IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptMastRoute ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName + ' ' +
				'WHERE RptId=' + CAST(@Pi_RptId AS nVARCHAR(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVARCHAR(10)) + '' + 
				'AND (CmpId = (CASE ' + CAST(@CmpId AS nVARCHAR(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +
				'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
				CAST(@Pi_RptId AS nVARCHAR(10)) + ',4,' + CAST(@Pi_UsrId AS nVARCHAR(10)) + ')))'+
				'AND (RMId = (CASE ' + CAST(@RMId AS nVARCHAR(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR '+
				'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
				CAST(@Pi_RptId AS nVARCHAR(10)) + ',2,' + CAST(@Pi_UsrId AS nVARCHAR(10)) + ')))'
			EXEC (@SSQL)
		END
		IF @Pi_SnapRequired = 1 BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,
									  @Pi_DbName,@TblName,@TblStruct,
									  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			   BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName + 
					'(SnapId,RptId,' + @TblFields + ',UserId)' + 
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptMastRoute'
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			   END
		   END
	   END
	ELSE BEGIN		--To Retrieve Data From Snap Data
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,
								  @Pi_DbName,@TblName,@TblStruct,
								  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0 BEGIN
			SET @SSQL = 'INSERT INTO #RptMastRoute ' + 
				'(' + @TblFields + ')' + 
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptMastRoute 
	SELECT * from #RptMastRoute
	RETURN
END
GO
/***
 * Salesman Analysis Report:-Custom report-->Sales Analysis Report
 */
IF EXISTS(SELECT * FROM SysObjects WHERE XType='P' AND Name='Proc_SalesmanAnanlysisReport') 
DROP PROCEDURE Proc_SalesmanAnanlysisReport
GO
CREATE PROCEDURE Proc_SalesmanAnanlysisReport
(	
	@Pi_FromDate DATETIME,
	@Pi_ToDate DATETIME,
	@Pi_SMId INT,
	@Pi_CmpID INT,
	@Pi_RptId INT,
	@Pi_UsrId INT,
	@Pi_CmpPrdCtgId	INT,
	@Pi_PrdId INT
)
AS
/*************************************************************
* PROCEDURE	: Proc_SalesmanAnanlysisReport
* PURPOSE	: To get the Salesman Sales Details
* CREATED BY	: Mahalakshmi.A
* CREATED DATE	: 18/09/2008
* NOTE		:
* MODIFIED
------------------------------------------------
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
*******************************************************************************************************
* 27-07-2021   Boopathiraja M	  SR					   Hide dummy retailers
*************************************************************/
BEGIN
	DELETE FROM TempSalesmanAnalysis WHERE UsrId in (@Pi_UsrId,0,NULL)
	
	Select * Into #TmpSalesmanAnalysis from (
		SELECT 
			SI.SalInvDate,RM.RmName,SI.RtrId,SI.RMId,
			SI.SalId,SP.PrdId,
			SI.SmId,P.CmpId,BD.SlNo,BD.FieldDesc,SL.LineBaseQtyAmount,
			PCL.CmpPrdCtgId,PCV.PrdCtgValMainId,0 AS ScheduleCalls,0 AS BillCuts,0 AS TLSD,
			(SELECT MAX(SLNO) + 1 
			 FROM BillSequenceDetail
			 WHERE BillSeqId = SI.BillSeqId) AS SlNo_1,
			'Gross Value' AS FieldDesc_1,
			SP.PrdGrossAmount AS LineBaseQtyAmount_1,
			PCL.CmpPrdCtgId CmpPrdCtgId_1,
			PCV.PrdCtgValMainId PrdCtgValMainId_1,
			0 AS ScheduleCalls_1,
			0 AS BillCuts_1,
			0 AS TLSD_1
		FROM 
			SALESMAN S,SalesInvoice SI,RouteMaster RM,
			SalesInvoiceProduct SP,SalesInvoiceLineAmount SL,
			BillSequenceMaster BM,
			BillSequenceDetail BD,Retailer R,
			Product P,ProductCategoryLevel PCL,
			ProductCategoryValue PCV
		WHERE 
			SI.DlvSts IN(4,5) AND s.SMID=SI.SMID AND 
			RM.RMID=SI.RMID AND 
			SP.SALID=SI.SALID AND 
			SL.SalId=SI.SalId AND
			SI.BillSeqId = BM.BillSeqId AND 
			BD.BillSeqId = SI.BillSeqId AND 
			BD.RefCode = SL.RefCode AND 
			SI.RtrId=R.RtrId AND 
			P.PrdId=Sp.PrdID AND 
			P.PrdCtgValMainId=PCV.PrdCtgValMainId AND 
			PCV.CmpPrdCtgId=PCL.CmpPrdCtgId AND 
			SP.SLNo=SL.PrdSlNo AND 
			(P.CmpId = (CASE @Pi_CmpId WHEN 0 THEN P.CmpId ELSE 0 END) OR
			P.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
			(SI.SmId = (CASE @Pi_SmId WHEN 0 THEN SI.SmId ELSE 0 END) OR
			SI.SmId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(SP.PrdId = (CASE @Pi_CmpPrdCtgId WHEN 0 THEN SP.PrdId Else 0 END) OR
			SP.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))) AND
			(SP.PrdId = (CASE @Pi_PrdId WHEN 0 THEN SP.PrdId Else 0 END) OR SP.PrdId in (0)) AND 
			SI.SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND
			SI.RtrId not in (SELECT isNull(RtrId,0) from View_Sales_Hierarchy_Dummy) -- Hide dummy retailers
	) A 

	INSERT INTO TempSalesmanAnalysis(
		SalInvDate,RmName,RtrId,RMId,SalId,
		PrdId,SmId,CmpId,SlNo,FieldDesc,
		LineBaseQtyAmount,CmpPrdCtgId,
		PrdCtgValMainId,ScheduleCalls,
		BillCuts,TLSD,UsrId
	)
	SELECT 
		SalInvDate,RmName,RtrId,RMId,
		SalId,PrdId,
		SmId,CmpId,SlNo,FieldDesc,LineBaseQtyAmount,
		CmpPrdCtgId,PrdCtgValMainId,
		0 AS ScheduleCalls,
		0 AS BillCuts,
		0 AS TLSD,
		@Pi_UsrId AS UsrId
	FROM
		(
			SELECT DISTINCT
					SalInvDate,RmName,RtrId,RMId,
					SalId,PrdId,
					SmId,CmpId,SlNo,
					FieldDesc,LineBaseQtyAmount,
					CmpPrdCtgId,PrdCtgValMainId,
					ScheduleCalls,BillCuts,TLSD
			FROM 
				#TmpSalesmanAnalysis

			UNION
				
			SELECT DISTINCT
					SalInvDate,RmName,RtrId,RMId,
					SalId,PrdId,
					SmId,CmpId,
					SlNo_1 AS SlNo,
					FieldDesc_1 AS FieldDesc,
					LineBaseQtyAmount_1 As LineBaseQtyAmount,
					CmpPrdCtgId_1 AS CmpPrdCtgId,
					PrdCtgValMainId_1 AS PrdCtgValMainId,
					ScheduleCalls_1 AS ScheduleCalls,
					BillCuts_1 AS BillCuts,
					TLSD_1 AS TLSD
			FROM 
				#TmpSalesmanAnalysis
		) A
		
		UPDATE TempSalesmanAnalysis SET ScheduleCalls=A.ScheduleCalls 
		FROM (
			SELECT SalInvDate,SMId,RMId,COUNT(DISTINCT RtrID) AS ScheduleCalls 
			FROM TempSalesmanAnalysis
			GROUP BY SalInvDate,SMId,RMId
		 ) A, TempSalesmanAnalysis B 
		WHERE 
			A.SalInvDate=B.SalInvDate AND 
			A.SMId=B.SMId AND A.RMId=B.RMId AND 
			UsrId=@Pi_UsrId
		
		UPDATE TempSalesmanAnalysis SET BillCuts=A.BillCuts 
		FROM (
			SELECT SalInvDate,SMId,RMId,COUNT(DISTINCT SalId) AS BillCuts 
			FROM TempSalesmanAnalysis
			GROUP BY SalInvDate,SMId,RMId
		) A , TempSalesmanAnalysis B 
		WHERE 
			A.SalInvDate=B.SalInvDate AND 
			A.SMId=B.SMId AND A.RMId=B.RMId AND 
			UsrId=@Pi_UsrId
		
		UPDATE TempSalesmanAnalysis SET TLSD=A.TLSD 
		FROM (
			SELECT SalInvDate,SMId,RMId,
				   COUNT(DISTINCT PrdId) AS TLSD 
			FROM TempSalesmanAnalysis
			GROUP BY SalInvDate,SMId,RMId
		) A, TempSalesmanAnalysis B 
		WHERE A.SalInvDate=B.SalInvDate AND 
			  A.SMId=B.SMId AND A.RMId=B.RMId AND 
			  UsrId=@Pi_UsrId
END
GO
/***
 * Outlet summary:- Dynamic report--> Outlet Summary
 */
IF EXISTS(SELECT * FROM SysObjects WHERE XType='P' AND Name='Proc_GR_ChannelCrossTabs') 
DROP PROCEDURE Proc_GR_ChannelCrossTabs
GO
CREATE PROCEDURE Proc_GR_ChannelCrossTabs (
	@Pi_RptName	NVARCHAR(100),
	@Pi_FromDate DATETIME,
	@Pi_ToDate DATETIME,
	@Pi_Filter1 NVARCHAR(100),
	@Pi_Filter2	NVARCHAR(100),
	@Pi_Filter3	NVARCHAR(100),
	@Pi_Filter4	NVARCHAR(100),
	@Pi_Filter5	NVARCHAR(100),
	@Pi_Filter6	NVARCHAR(100)
)
AS
BEGIN

	--EXEC [Proc_GR_ChannelCrossTabs] '2010-01-01','2010-01-01','','','','','','',''

	DECLARE @PHLEVEL VARCHAR(4000)
	DECLARE @SQL_sTR1 VARCHAR(4000)

	SELECT DISTINCT SMNAME,RMNAME,E.RTRID,HIERARCHY1CAP,HIERARCHY2CAP,HIERARCHY3CAP INTO #LEVEL1
	FROM SALESMANMARKET A,SALESMAN B,ROUTEMASTER C ,RETAILERMARKET D,Retailer E,TBL_GR_BUILD_RH RH
	WHERE A.RMID=C.RMID AND A.SMID=B.SMID AND D.RtrId=E.RtrId AND 
		  D.RMId=A.RMId AND RH.RTRID=E.RTRID AND E.RTRSTATUS=1 AND
		  NOT EXISTS (									-- Hide dummy retailers
			SELECT * FROM View_Sales_Hierarchy_Dummy
			WHERE RtrId = E.RtrId 
		 )

	SELECT SMNAME,RMNAME,COUNT(RTRID) [Total Outlet] 
	INTO #OUTPUT 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME

	SELECT SMNAME,RMNAME,COUNT(RTRID) [Total Outlet] 
	INTO #AOUTPUT 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME

	SELECT SMNAME,RMNAME,COUNT(RTRID) [Total Outlet] 
	INTO #BOUTPUT 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME

	SELECT SMNAME,RMNAME,HIERARCHY1CAP,COUNT(RTRID) [Total Outlet] 
	INTO #OUTPUT1 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME,HIERARCHY1CAP

	SELECT SMNAME,RMNAME,HIERARCHY2CAP,COUNT(RTRID) [Total Outlet] 
	INTO #OUTPUT2 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME,HIERARCHY2CAP

	SELECT SMNAME,RMNAME,HIERARCHY3CAP,COUNT(RTRID) [Total Outlet] 
	INTO #OUTPUT3 
	FROM #LEVEL1
	GROUP BY SMNAME,RMNAME,HIERARCHY3CAP

	-----CONSTRUCING THE TABLE

	CREATE TABLE #CROSSTAB (PKEY INT IDENTITY(1,1), PHLEVEL VARCHAR(100))
	CREATE TABLE #CROSSTAB1 (PKEY INT IDENTITY(1,1), PHLEVEL VARCHAR(100))
	CREATE TABLE #CROSSTAB2 (PKEY INT IDENTITY(1,1), PHLEVEL VARCHAR(100))

	INSERT INTO #CROSSTAB SELECT DISTINCT HIERARCHY1CAP PHLEVEL FROM TBL_GR_BUILD_RH

	IF EXISTS (SELECT * FROM #CROSSTAB) BEGIN
		SELECT	@PHLEVEL = COALESCE(@phlevel + ' INT , ', '') +'[' +PHLEVEL+']' FROM	#CROSSTAB
		SET @PHLEVEL = @PHLEVEL + ' INT'
		SET @SQL_STR1 = ''
		SET @SQL_STR1 = 'ALTER TABLE  #OUTPUT ADD ' + @PHLEVEL
		EXEC(@SQL_STR1)
	END

	DECLARE @PHLEVEL2 VARCHAR(4000)
	INSERT INTO #CROSSTAB1 SELECT DISTINCT HIERARCHY2CAP PHLEVEL FROM TBL_GR_BUILD_RH

	IF EXISTS (SELECT * FROM #CROSSTAB1)
	BEGIN
		SELECT	@PHLEVEL2 = COALESCE(@phlevel2 + ' INT , ', '') +'[' +PHLEVEL+']' FROM	#CROSSTAB1
		SET @PHLEVEL2 = @PHLEVEL2 + ' INT'
		SET @SQL_STR1 = ''
		SET @SQL_STR1 = 'ALTER TABLE  #AOUTPUT ADD ' + @PHLEVEL2
		EXEC(@SQL_STR1)
	END

	INSERT INTO #CROSSTAB2 SELECT DISTINCT HIERARCHY3CAP PHLEVEL FROM TBL_GR_BUILD_RH
	DECLARE @PHLEVEL3 VARCHAR(4000)

	IF EXISTS (SELECT * FROM #CROSSTAB2) BEGIN
		SELECT @PHLEVEL3 = COALESCE(@phlevel3 + ' INT , ', '') +'[' +PHLEVEL+']' FROM	#CROSSTAB2
		SET @PHLEVEL3 = @PHLEVEL3 + ' INT'
		SET @SQL_STR1 = ''
		SET @SQL_STR1 = 'ALTER TABLE  #BOUTPUT ADD ' + @PHLEVEL3
		EXEC(@SQL_STR1)
	END

	DECLARE @PH_COUNT AS INT
	DECLARE @I AS INT
	SELECT @PH_COUNT = COUNT(*) FROM #CROSSTAB
	IF EXISTS (SELECT * FROM #CROSSTAB) BEGIN
		SET @I = 1
		WHILE (@I <= @PH_COUNT)
		BEGIN
			SELECT @PHLEVEL = PHLEVEL FROM #CROSSTAB WHERE PKEY = @I
			SET @SQL_STR1 =  'UPDATE #OUTPUT SET [' + @PHLEVEL + '] = 0'
			EXEC(@SQL_STR1)
			SET @SQL_STR1 = ''
			SET @SQL_STR1 = @SQL_STR1 + 'UPDATE A SET A.[' + @PHLEVEL + '] = B.[Total Outlet]  FROM #OUTPUT A, #OUTPUT1 B '
			SET @SQL_STR1 = @SQL_STR1 + 'WHERE A.SMNAME=B.SMNAME AND A.RMNAME=B.RMNAME AND B.HIERARCHY1CAP = ''' + @PHLEVEL + ''''
			EXEC(@SQL_STR1)
			SET @I = @I + 1
		END
	END

	SELECT @PH_COUNT = COUNT(*) FROM #CROSSTAB1

	IF EXISTS (SELECT * FROM #CROSSTAB1) BEGIN
		SET @I = 1
		WHILE (@I <= @PH_COUNT)
		BEGIN
			SELECT @PHLEVEL = PHLEVEL FROM #CROSSTAB1 WHERE PKEY = @I
			SET @SQL_STR1 =  'UPDATE #AOUTPUT SET [' + @PHLEVEL + '] = 0'
			EXEC(@SQL_STR1)
			SET @SQL_STR1 = ''
			SET @SQL_STR1 = @SQL_STR1 + 'UPDATE A SET A.[' + @PHLEVEL + '] = B.[Total Outlet]  FROM #AOUTPUT A, #OUTPUT2 B '
			SET @SQL_STR1 = @SQL_STR1 + 'WHERE A.SMNAME=B.SMNAME AND A.RMNAME=B.RMNAME AND B.HIERARCHY2CAP = ''' + @PHLEVEL + ''''
			EXEC(@SQL_STR1)
			SET @I = @I + 1
		END
	END

	SELECT @PH_COUNT = COUNT(*) FROM #CROSSTAB2
	IF EXISTS (SELECT * FROM #CROSSTAB2)
	BEGIN
		SET @I = 1
		WHILE (@I <= @PH_COUNT)
		BEGIN
			SELECT @PHLEVEL = PHLEVEL FROM #CROSSTAB2 WHERE PKEY = @I
			SET @SQL_STR1 =  'UPDATE #BOUTPUT SET [' + @PHLEVEL + '] = 0'
			EXEC(@SQL_STR1)
			SET @SQL_STR1 = ''
			SET @SQL_STR1 = @SQL_STR1 + 'UPDATE A SET A.[' + @PHLEVEL + '] = B.[Total Outlet]  FROM #BOUTPUT A, #OUTPUT3 B '
			SET @SQL_STR1 = @SQL_STR1 + 'WHERE A.SMNAME=B.SMNAME AND A.RMNAME=B.RMNAME AND B.HIERARCHY3CAP = ''' + @PHLEVEL + ''''
			EXEC(@SQL_STR1)
			SET @I = @I + 1
		END
	END

	SELECT 'Channel Level 3',* FROM #OUTPUT
	SELECT 'Channel Level 2',* FROM #AOUTPUT
	SELECT 'Channel Level 1',* FROM #BOUTPUT
	SELECT 'Assigned Retailer Information',
			Salesman.SMCode AS [Salesman Code], 
			Salesman.SMName AS [Salesman Name], 
			RouteMaster.RMCode AS [Route Code], 
			RouteMaster.RMName AS [Route Name], 
			CASE Retailer.RtrStatus WHEN 1 THEN 'Active' WHEN 0 THEN 'Inactive' END AS [Retailer Status], 
			TBL_GR_BUILD_RH.HIERARCHY3CAP AS [Retailer Hierarchy 1], 
			TBL_GR_BUILD_RH.HIERARCHY2CAP AS [Retailer Hierarchy 2], 
			TBL_GR_BUILD_RH.HIERARCHY1CAP AS [Retailer Hierarchy 3], Retailer.RtrCode AS [Retailer Code], 
			Retailer.RtrName AS [Retailer Name], 
			Retailer.RtrAdd1 AS [Address 1], 
			Retailer.RtrAdd2 AS [Address 2], 
			Retailer.RtrAdd3 AS [Address 3], 
			Retailer.RtrPinNo AS [Pin Number], 
			Retailer.RtrPhoneNo AS [Phone Number], 
			Retailer.RtrContactPerson AS [Contact Person], 
			CONVERT(VARCHAR(10), 
			Retailer.RtrRegDate, 121) AS [Registration Date], 
			Retailer.RtrTINNo AS [Tin Number], 
			Retailer.RtrCSTNo AS [CST Number], 
			Retailer.RtrLicNo AS [License Number], 
			CONVERT(VARCHAR(10), 
			Retailer.RtrLicExpiryDate, 121) AS [Lic Expiry Date], 
			Retailer.RtrDrugLicNo AS [Drug Lic. Number], 
			CONVERT(VARCHAR(10), 
			Retailer.RtrDrugExpiryDate, 121) AS [Drug Lic Expiry Date]
	FROM SalesmanMarket 
	INNER JOIN Salesman ON SalesmanMarket.SMId = Salesman.SMId 
	INNER JOIN RouteMaster ON SalesmanMarket.RMId = RouteMaster.RMId 
	INNER JOIN RetailerMarket ON SalesmanMarket.RMId = RetailerMarket.RMId 
	INNER JOIN Retailer ON Retailer.RtrId = RetailerMarket.RtrId
	INNER JOIN TBL_GR_BUILD_RH ON Retailer.RtrId = TBL_GR_BUILD_RH.RTRID
	WHERE NOT EXISTS (								-- Hide dummy retailers
		SELECT * FROM View_Sales_Hierarchy_Dummy
		WHERE RtrId = Retailer.RtrId
	)

	SELECT 'Salesman-Route Unassigned Information', 
			CASE Retailer.RtrStatus WHEN 1 THEN 'Active' WHEN 0 THEN 'Inactive' end [Retailer Status],
			Retailer.RtrCode [Retailer Code], 
			Retailer.RtrName [Retailer Name],
			Retailer.RtrAdd1[Address 1], 
			Retailer.RtrAdd2 [Address 2], 
			Retailer.RtrAdd3 [Address 3], 
			Retailer.RtrPinNo [Pin Number],
			Retailer.RtrPhoneNo[Phone Number], 
			Retailer.RtrContactPerson [Contact Person], 
			CONVERT(VARCHAR(10),Retailer.RtrRegDate,121) [Registration Date],
			Retailer.RtrTINNo [Tin Number], 
			Retailer.RtrCSTNo [CST Number], 
			Retailer.RtrLicNo [License Number], 
			CONVERT(VARCHAR(10),Retailer.RtrLicExpiryDate,121)[Lic Expiry Date], 
			Retailer.RtrDrugLicNo [Drug Lic. Number], 
			CONVERT(VARCHAR(10),Retailer.RtrDrugExpiryDate,121) [Drug Lic Expiry Date]
	FROM Retailer 
	WHERE Rtrid  in (SELECT Rtrid FROM RetailerMarket WHERE Rmid not in (SELECT Rmid FROM SalesmanMarket)) AND
		  NOT EXISTS (								-- Hide dummy retailers
				SELECT * FROM View_Sales_Hierarchy_Dummy
				WHERE RtrId = Retailer.RtrId
		 )
END
GO
--Script Updater Starts
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'Proc_Cs2Cn_Route') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_Route]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_Route 0,'2021-01-30'
SELECT * FROM Cs2Cn_Prk_Route ORDER BY SlNo
SELECT * FROM RouteMaster
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cs2Cn_Route]
(
	@Po_ErrNo	INT OUTPUT,	
	@ServerDate DATETIME
)
AS
SET NOCOUNT ON
BEGIN
/*********************************
* PROCEDURE		: Proc_Cs2Cn_Route
* PURPOSE		: To Extract Route Details from CoreStocky to upload to Console
* CREATED		: Nandakumar R.G
* CREATED DATE	: 22/06/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 02-05-2020	MOHANA S	PARCS202100008 CR		All the route get upload to Console 
* 30-01-2021	Deepan  	CR		CRCRSTPAR0114        DayEnd Process Added
*********************************/
	DECLARE @DistCode	As nVarchar(50)
    DECLARE @ChkDate AS DATETIME
      SET @ChkDate = ISNULL((SELECT ISNULL(NextUpDate,GETDATE()) FROM DayEndProcess WHERE ProcId = 25),GETDATE()-1)

  
		SET @Po_ErrNo=0
		DELETE FROM Cs2Cn_Prk_Route WHERE UploadFlag = 'Y'
		
		IF    CONVERT(VARCHAR(10),@ChkDate,121)<>CONVERT(VARCHAR(10),GETDATE(),121)
		BEGIN
          
			UPDATE RouteMaster SET UpLoad ='N'
			
			UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
			 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
			 Where ProcId = 25
		ENd
	
		IF EXISTS (SELECT * FROM RouteMaster WHERE UpLoad ='N')
		BEGIN
				UPDATE RouteMaster SET UpLoad ='N'
		END
		SELECT @DistCode = DistributorCode FROM Distributor
		INSERT INTO Cs2Cn_Prk_Route
		(
			DistCode,
			RMId,
			RMCode,
			RMName,
			Distance,
			RMPopulation,
			VanRoute,
			RouteType,
			LocalUpCountry,
			GeoLevel,
			GeoValue,
			Status,
			MonDay,
			TuesDay,
			WednesDay,
			ThursDay,
			FriDay,
			SaturDay,
			SunDay,
			UploadFlag
		)
		SELECT
			@DistCode,
			RM.RMId,
			RM.RMCode,
			RM.RMName,
			RM.RMDistance,
			RM.RMPopulation,
			RM.RMVanRoute,
			RM.RMSRouteType,
			RM.RMLocalUpcountry,
			'' AS GeoLevel,
			'' AS GeoValue,
			(CASE RM.RMstatus WHEN 0 THEN 'InActive' ELSE 'Active' END) AS Status,
			(CASE RM.RMMon WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMTue WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMWed WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMThu WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMFri WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMSat WHEN 1 THEN 'Yes' ELSE 'No' END),
			(CASE RM.RMSun WHEN 1 THEN 'Yes' ELSE 'No' END),		
			'N'				
		FROM		
			RouteMaster RM
		WHERE			
			RM.Upload = 'N'

		

		UPDATE A SET A.GeoLevel=B.GeoLevelName,A.GeoValue=B.GeoCode
		FROM Cs2Cn_Prk_Route A,
		(SELECT RM.RMId,GL.GeoLevelName,G.GeoCode FROM RouteMaster RM,Geography G,GeographyLevel GL
		WHERE RM.GeoMainId=G.GeoMainId AND G.GeoLevelId=GL.GeoLevelId AND RM.Upload='N') B
		WHERE A.RMid=B.RMId
		UPDATE RouteMaster  SET Upload='Y' 	WHERE RMCode IN (SELECT RMCode FROM Cs2Cn_Prk_Route)
		UPDATE Cs2Cn_Prk_Route SET ServerDate=@ServerDate
	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'Proc_Cs2Cn_RetailerRoute') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_RetailerRoute]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_RetailerRoute 0,'2021-01-30'
SELECT * FROM Cs2Cn_Prk_RetailerRoute ORDER BY SlNo
SELECT * FROM RetailerMarket
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cs2Cn_RetailerRoute]
(
	@Po_ErrNo	INT OUTPUT,	
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_RetailerRoute
* PURPOSE		: To Extract Retailer Route Mapping Details from CoreStocky to upload to Console
* CREATED		: Nandakumar R.G
* CREATED DATE	: 09/07/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 30-01-2021	Deepan  	CR		CRCRSTPAR0114        DayEnd Process Added	
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @DistCode	As nVarchar(50)
	DECLARE @ChkDate AS DATETIME
      SET @ChkDate = ISNULL((SELECT ISNULL(NextUpDate,GETDATE()) FROM DayEndProcess WHERE ProcId = 26),GETDATE()-1)

  	
		

		SET @Po_ErrNo=0
		
		IF    CONVERT(VARCHAR(10),@ChkDate,121)<>CONVERT(VARCHAR(10),GETDATE(),121)
		BEGIN
		
		UPDATE RetailerMarket SET Upload=0
		
		UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
		 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
		 Where ProcId = 26
		 
		 ENd

		DELETE FROM Cs2Cn_Prk_RetailerRoute WHERE UploadFlag = 'Y'
	
		SELECT @DistCode = DistributorCode FROM Distributor
		INSERT INTO Cs2Cn_Prk_RetailerRoute
		(
			DistCode	,
			RtrId		,
			RtrCode		,
			RtrName		,
			RMId		,
			RMCode		,
			RMName		,
			RouteType	,
			UploadFlag	
		)
		SELECT @DistCode,RtrId,CmpRtrCode,RtrName,RMId,RMCode,RMName,RouteType,'N' 
		FROM 
		(
			SELECT RMK.RtrId,R.CmpRtrCode,R.RtrName,RMK.RMId,RM.RMCode,RM.RMName,'Sales Route' AS RouteType FROM RetailerMarket RMK,Retailer R,RouteMaster RM
			WHERE R.RtrId=RMK.RtrId AND RMK.RMId=RM.RMId AND RMK.Upload=0
			UNION ALL
			SELECT R.RtrId,R.CmpRtrCode,R.RtrName,R.RMId,RM.RMCode,RM.RMName,'Delivery Route' AS RouteType  FROM Retailer R,RouteMaster RM
			WHERE RM.RMId=R.RMId AND R.RtrId IN (SELECT RtrId FROM RetailerMarket WHERE Upload=0)
		)
		AS A
		ORDER BY RtrId,CmpRtrCode,RtrName,RMId,RMCode,RMName,RouteType 
	
		

		UPDATE RetailerMarket SET Upload=1
		WHERE RtrId IN (SELECT DISTINCT RtrId FROM Cs2Cn_Prk_RetailerRoute)
		UPDATE Cs2Cn_Prk_RetailerRoute SET ServerDate=@ServerDate
	
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_Export_CS2WS_SalesmanDetails' AND Type='P')
DROP PROC Proc_Export_CS2WS_SalesmanDetails
GO
/*
BEGIN TRAN
Exec Proc_Export_CS2WS_SalesmanDetails '1,2'
select * from Export_CS2WS_SalesmanDetails
SELECT * FROM WSMasterExportUploadTrack
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Export_CS2WS_SalesmanDetails
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_SalesmanDetails
* PURPOSE		: To Export SalesMan details to the PDA Intermediate Database
* CREATED		: Amuthakumar P            CR:  CRCRSTAPAR0016
* CREATED DATE	: 06/08/2018 
* MODIFIED		:
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 06/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export SalesMan details
* 25-01-2021   Deepak Philip        CRCRSTPAR0113         CR     To change the password field data.
*********************************************************************************************************************/
BEGIN
	DECLARE @Sql AS varchar(1000)
	DELETE FROM Export_CS2WS_SalesmanDetails WHERE UploadFlag='Y'
	
	SET @Sql=' INSERT INTO Export_CS2WS_SalesmanDetails(TenantCode,LocationCode,SalesmanCode,SalesmanName,Address,City,State,Zip,Phone,IsActive,Password,UploadFlag)
			   SELECT DistributorCode,DistributorCode,SMCode,SMName,'''','''','''','''',SMPhoneNumber,S.Status,''13579'',''N'' AS UploadFlag FROM SalesMan S
			   CROSS JOIN Distributor D WHERE 
			   NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = S.SMCode AND M.ProcessName=''Salesman Details'')
			   AND SMId IN ('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
	EXEC (@Sql)
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'Salesman Details',SalesmanCode,SalesmanName,GETDATE(),0,LocationCode,'','',0 FROM Export_CS2WS_SalesmanDetails WHERE UploadFlag='N'
	
	UPDATE RM SET RM.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN SalesMan RM (NOLOCK) ON A.MasterCode=RM.SMCode
		WHERE ISNULL(RM.WSUpload,'N')='N' AND ProcessName='Salesman Details'
	
	SELECT DISTINCT 
		TenantCode,	
		LocationCode,
		SalesmanCode,
		SalesmanName,
		[Address],
		City,	
		[State],
		Zip,
		Phone,
		IsActive,
		[Password] 
	FROM Export_CS2WS_SalesmanDetails WITH (NOLOCK)
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_Export_CS2WS_BeatMaster' and Type='P')
DROP PROC Proc_Export_CS2WS_BeatMaster
GO
/*
BEGIN TRAN
Exec Proc_Export_CS2WS_BeatMaster '1'
select * from WSMasterExportUploadTrack
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Export_CS2WS_BeatMaster
(
	@SalRpCode varchar(200)
)
AS
/*******************************************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_BeatMaster 
* PURPOSE		: To Export Beat details to the PDA Intermediate Database
* CREATED		: Amuthakumar P            CR:  CRCRSTAPAR0016
* CREATED DATE	: 06/08/2018 
* MODIFIED		:
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 06/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export Beat details
* 09-01-2021   Deepak Philip        PARLECS/1220/160      BZ     Increased the parameter datalength.
*********************************************************************************************************************/
BEGIN
	DECLARE @Smid AS int 
	DECLARE @Sql AS varchar(1000)
	
	DELETE FROM Export_CS2WS_BeatMaster WHERE UploadFlag='Y'
	
	 SET @Sql='INSERT INTO Export_CS2WS_BeatMaster(TenantCode,LocationCode,BeatCode,BeatName,UploadFlag)'
	 SET @Sql=@Sql+' SELECT dISTINCT DistributorCode,DistributorCode,RMCode,RMName,''N'' AS UploadFlag FROM RouteMaster S
			INNER JOIN SalesmanMarket SM ON SM.RMId = S.RMId 
			CROSS JOIN Distributor D
			WHERE RMStatus = 1 AND
			NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = S.RMCode AND M.MasterName=S.RMNAME AND M.ProcessName=''Beat Master'')
			AND SM.SMId  in('+ CAST(@SalRpCode AS VARCHAR(200)) +')'
--	PRINT (@Sql)
	EXEC (@Sql)
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'Beat Master',BeatCode,BeatName,GETDATE(),0,LocationCode,'','',0 FROM Export_CS2WS_BeatMaster WHERE UploadFlag='N'
	
	SELECT DISTINCT 
		 TenantCode,
		 LocationCode,
		 BeatCode,
		 BeatName 
	FROM Export_CS2WS_BeatMaster WITH (NOLOCK)
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CheckPendingTransaction' AND TYPE='P')
DROP PROCEDURE Proc_CheckPendingTransaction
GO
--EXEC Proc_CheckPendingTransaction 2,'2021-01-05',0
CREATE PROCEDURE Proc_CheckPendingTransaction
(
	@Po_Usrid INT,
	@Po_Serverdate DateTime,
	@Po_ErrNo INT OUTPUT
)
/*******************************************************
* PROCEDURE		: Proc_CheckPendingTransaction
* PURPOSE		: Check For Pending Transaction
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
********************************************************
* 02-02-2021	MOHANA S	 BZ		PARLECS/0221/018		Due to Manual Monthend, Old Data will not show
********************************************************/ 
AS
SET NOCOUNT ON
BEGIN 

	EXEC Proc_MenuAccess 2

	DECLARE @Config INT
	DECLARE @Fromdate DATETIME
	DECLARE @Todate DATETIME
	SELECT @Config = ISNULL(ConfigValue,0)  FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1
	
	
	SET @Todate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Po_Serverdate,121))

	SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Todate), 0) 

	DELETE FROM PendingTransDetails 

	IF EXISTS (SELECT * FROM MonthendClosing WHERE StkMonth = DATENAME(MONTH,@Fromdate) AND StkYear=Year(@Fromdate))
	BEGIN
		RETURN
	END
		
	SET @Po_ErrNo=0
	BEGIN TRY
		BEGIN TRANSACTION  
			
			IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1)
			BEGIN
				CREATE TABLE #PendingTransDetails
				(
					ModuleName NVARCHAR(100),
					PendingCount	INT
				)
				--Pending Bills
				IF EXISTS(SELECT 1 FROM SalesInvoice SI (NOLOCK) INNER JOIN SalesInvoiceProduct SIP(NOLOCK) ON SI.SalId=SIP.SalId WHERE DLVSTS IN (1,2)
				AND  SalinvDate BETWEEN @Fromdate AND @Todate)
				BEGIN
					
					INSERT INTO #PendingTransDetails
					SELECT 'Billing',COUNT(DISTINCT Salinvno) FROM(
					SELECT SALINVNO FROM SalesInvoice SI (NOLOCK) 
					INNER JOIN SalesInvoiceProduct SIP(NOLOCK) ON SI.SalId=SIP.SalId WHERE DLVSTS IN (1,2)
					AND  SalinvDate BETWEEN @Fromdate AND @Todate)A
				 
				END
				--Purchase Receipt
				--IF EXISTS(SELECT 1 AS A FROM PurchaseReceipt(NOLOCK) WHERE STATUS=0  AND  GoodsRcvdDate BETWEEN @Fromdate AND @Todate UNION 
				--	SELECT 1 AS A from ETLTempPurchaseReceipt WHERE DownLoadStatus = 0 AND  InvDate BETWEEN @Fromdate AND @Todate)
				IF EXISTS(SELECT 1 AS A from ETLTempPurchaseReceipt WHERE DownLoadStatus = 0 AND  InvDate BETWEEN @Fromdate AND @Todate)
				BEGIN
					INSERT INTO #PendingTransDetails
					SELECT  'Purchase Receipt',COUNT(DISTINCT CmpInvNo) FROM
					(
						--SELECT CmpInvNo,InvDate FROM PurchaseReceipt (NOLOCK) WHERE STATUS=0  AND  GoodsRcvdDate  BETWEEN @Fromdate AND @Todate
						--UNION
						SELECT ETL.CmpInvNo,ETL.InvDate
						FROM ETLTempPurchaseReceipt ETL(NOLOCK),Company Cmp(NOLOCK),Supplier Spm(NOLOCK),Location Lcn(NOLOCK)
						WHERE ETL.CmpId=Cmp.CmpId AND  ETL.SpmId=Spm.SpmId AND  ETL.LcnId= Lcn.LcnId AND  
						ETL.DownLoadStatus = 0  AND  InvDate BETWEEN @Fromdate AND @Todate
					)A
				END
				
			--Sales Return
			IF EXISTS(SELECT 1 FROM Returnheader(NOLOCK) WHERE STATUS=1 AND ReturnDate BETWEEN @Fromdate AND @Todate)
			BEGIN
				INSERT INTO #PendingTransDetails
				SELECT  'Sales Return',COUNT(ReturnID) FROM Returnheader (NOLOCK) WHERE STATUS=1 
				AND ReturnDate  BETWEEN @Fromdate AND @Todate
			
			END
			--
			IF EXISTS(SELECT 1 FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate BETWEEN @Fromdate AND @Todate)
			BEGIN
				INSERT INTO #PendingTransDetails
				SELECT  'Sampling',COUNT(IssueId) FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate  BETWEEN @Fromdate AND @Todate
			
			END
	
			INSERT INTO  PendingTransDetails
			SELECT ModuleName,SUM(PendingCOunt) FROM #PendingTransDetails GROUP BY ModuleName
	 
		END	
		COMMIT TRANSACTION  	
	END TRY
	
	BEGIN CATCH			
			SET @Po_ErrNo=1
			ROLLBACK TRANSACTION  
	END CATCH
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidatePendingTransactionForAutoPopup' AND TYPE='P')
DROP PROCEDURE Proc_ValidatePendingTransactionForAutoPopup
GO
CREATE PROCEDURE Proc_ValidatePendingTransactionForAutoPopup
(
	@Pi_date DATETIME,
	@Type int
)
AS
/*******************************************************
* PROCEDURE		: Proc_ValidatePendingTransactionForAutoPopup
* PURPOSE		: Check For Pending Transaction
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
*******************************************************************************************
* 02-02-2021	MOHANA S	 BZ		PARLECS/0221/018		Due to Manual Monthend, Old Data will not show
*********************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @Config INT
	DECLARE @Fromdate DATETIME
	DECLARE @Todate DATETIME

	SELECT @Config = ISNULL(ConfigValue,0)  FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1
	
	--SET @Fromdate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Pi_date,121))

	--SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Pi_date), 0) 

	SET @Todate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Pi_date,121))

	SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Todate), 0)

	DELETE FROM TmpValidatePendingData

	IF EXISTS (SELECT * FROM MonthendClosing WHERE StkMonth = DATENAME(MONTH,@Fromdate) AND StkYear=Year(@Fromdate))
	BEGIN
		RETURN
	END

	
	IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1)
	BEGIN 
	
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT 'X' FROM SalesInvoice (NOLOCK)  
			WHERE DlvSts=1 AND  SalInvDate BETWEEN @Fromdate AND @Todate		)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT 2,'Billing','mnuVehicleAllocation',1  
			END
			
			IF EXISTS (SELECT 'X' FROM SalesInvoice (NOLOCK)  
			WHERE DlvSts=2 AND  SalInvDate  BETWEEN @Fromdate AND @Todate
			)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT 2,'Billing','mnuDeliveryProcess',1  
			END
			IF EXISTS(SELECT * FROM TmpValidatePendingData WHERE MenuName='mnuVehicleAllocation')
			BEGIN
				IF NOT EXISTS(SELECT * FROM TmpValidatePendingData WHERE MenuName='mnuDeliveryProcess')
				BEGIN
					INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
					SELECT 2,'Billing','mnuDeliveryProcess',1 
				END
			END
		END
	
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT DISTINCT A.Returnid FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnProduct B (NOLOCK)
				ON A.Returnid=B.Returnid AND  A.Status=1 AND  ReturnDate  BETWEEN @Fromdate AND @Todate )
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate) 
				SELECT 2,'Sales Return','mnuSalesReturn',1
			END
		END
		IF @Type = 1
		BEGIN
			IF EXISTS(SELECT 1 AS A FROM PurchaseReceipt(NOLOCK) WHERE STATUS=0 UNION 
						SELECT 1 AS A from ETLTempPurchaseReceipt (NOLOCK) WHERE DownLoadStatus = 0)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT DISTINCT 2,'Purchase Receipt','mnuPurchaseReceipt',1 FROM
				(
				SELECT CmpInvNo,InvDate FROM PurchaseReceipt (NOLOCK) WHERE STATUS=0 AND GoodsRcvdDate BETWEEN @Fromdate AND @Todate
				UNION
				SELECT ETL.CmpInvNo,ETL.InvDate
				FROM ETLTempPurchaseReceipt ETL(NOLOCK),Company Cmp(NOLOCK),Supplier Spm(NOLOCK),Location Lcn(NOLOCK),Transporter Trans (NOLOCK)
				WHERE ETL.CmpId=Cmp.CmpId AND  ETL.SpmId=Spm.SpmId AND  ETL.LcnId= Lcn.LcnId AND  
				ETL.TransporterId = Trans.TransporterId AND  ETL.DownLoadStatus = 0  AND invdate BETWEEN @Fromdate AND @Todate
				)A
			END
		END
		
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT 'X' FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate BETWEEN @Fromdate AND @Todate )
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate) 
				SELECT 2,'Sample Invoice','mnuSampleMgmt',1
			END
		END
		 
	END
	IF NOT EXISTS (SELECT * FROM TmpValidatePendingData WHERE Validate IN (0,1))
	BEGIN
		INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
		SELECT 3,'Nothing','',0
	END
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_AutoBatchTransferSalesReturn' AND XTYPE='P')
DROP PROCEDURE Proc_AutoBatchTransferSalesReturn
GO
/*
BEGIN TRAN
EXEC Proc_AutoBatchTransferSalesReturn 4515,0
SELECT * FROM PRODUCTBATCHLOCATION(nolock) WHERE PRDID =11100
select * from StockLedger (NOLOCK) where PRDID =11100 ORDER BY TRANSDATE DESC
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_AutoBatchTransferSalesReturn
(
	@Pi_ReturnId	INT,
	@Po_ErrNo INT OUTPUT	
)
AS
/************************************************************************************************************************
* PROCEDURE		: Proc_AutoBatchTransferSalesReturn
* PURPOSE		: To do Batch Transfer automatically while Sales Return (Same Logic for AutoBatch Transfer in Download)
* CREATED		: Mohana S
* CREATED DATE	: 30-11-2020
* MODIFIED
************************************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************
30-11-2020  Mohana.S	 CR     CRCRSTPAR0106          a) When Sales Return is made for a product attached to old Batch, 
														 stocks should be posted to the latest  batch for that product.
03-02-2021	MOhana S	 BZ		PARLESECS/0221/017		Removed Sample batch
*************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 				AS 	INT
	DECLARE @Trans				AS 	INT
	DECLARE @Tabname 			AS  NVARCHAR(100)
	DECLARE @DestTabname 		AS 	NVARCHAR(100)
	DECLARE @Fldname 			AS  NVARCHAR(100)
	
	DECLARE @PrdDCode 	        AS 	NVARCHAR(100)
	DECLARE @BatchCode			AS 	NVARCHAR(100)
	DECLARE @CmpBatchCode		AS 	NVARCHAR(100)	
	DECLARE @PriceCode			AS 	NVARCHAR(4000)		
	DECLARE @MnfDate			AS 	NVARCHAR(100)
	DECLARE @ExpDate			AS 	NVARCHAR(100)
	DECLARE @TaxGroupCode		AS 	NVARCHAR(100)
	DECLARE @Status				AS 	NVARCHAR(100)
	DECLARE	@BatchSeqCode 		AS 	NVARCHAR(100)
	DECLARE @RefCode           	AS 	NVARCHAR(100)
	DECLARE @PriceValue         AS 	NVARCHAR(100)	
	DECLARE @DefaultPrice       AS 	NVARCHAR(100)	  	
	DECLARE @ExistPrdDCode		AS 	NVARCHAR(100)  	
	DECLARE @ExistBatchCode		AS 	NVARCHAR(100)
	DECLARE @ExistPriceCode		AS 	NVARCHAR(100)  	
	
	DECLARE @PrdId 				AS 	INT
	DECLARE @PrdBatId 			AS 	INT
	DECLARE @PriceId 			AS 	INT
	DECLARE @TaxGroupId 		AS 	INT
	DECLARE @BatchSeqId 		AS 	INT
	DECLARE @BatchStatus		AS 	INT
	DECLARE @SlNo	 			AS 	INT
	DECLARE @NoOfPrices 		AS 	INT
	DECLARE @ExistPrices 		AS 	INT
	DECLARE @DefaultPriceId 	AS 	INT
	DECLARE @ExistPriceId 		AS 	INT
	DECLARE @TransStr 			AS 	NVARCHAR(4000)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT
	DECLARE @ContPrdId 			AS 	INT
	DECLARE @ContPrdBatId 		AS 	INT
	DECLARE @ContExistPrdBatId 	AS 	INT
	DECLARE @ContPriceId 		AS 	INT
	DECLARE @ContractId 		AS 	INT
	DECLARE @ContPriceCode		AS NVARCHAR(100)
	DECLARE @ContPrdBatId1		AS INT
	DECLARE @ContPriceId1		AS INT
	DECLARE @BatchTransfer		AS INT
	DECLARE @SalStock			AS INT
	DECLARE @UnSalStock			AS INT
	DECLARE @OfferStock			AS INT
	DECLARE @FromPrdBatId		AS INT
	DECLARE @FromPrdBatCode		AS NVARCHAR(200)
	DECLARE @ToPrdBatId			AS INT
	DECLARE @LcnId				AS INT
	DECLARE @Po_StkPosting		AS INT
	DECLARE @TransDate			AS DATETIME
	DECLARE @ReturnNo AS VARCHAR(100)
	DECLARE @ToPriceID AS INT
	DECLARE @FromPriceID AS INT
	
	DECLARE @Pi_OldMaxPrdBatId AS INT
	DECLARE @Old_PrdId AS INT
	
	SET @BatchTransfer=0
	SELECT @TransDate=CONVERT(NVARCHAR(10),GETDATE(),121)

	SET @Po_ErrNo=0
	SET @Exist=0
	SET @ExistPrdDCode=''	
	SET @ExistBatchCode=''
	SET @ExistPriceCode=''


	SET @Exist=0
	
	DECLARE @KeyNumber AS VARCHAR(100)
	DECLARE @StockTypeId AS INT
	
	DECLARE @ReasonId AS INT
	SELECT @ReasonId=ReasonId FROM ReasonMaster WHERE Description='Free Stock Movement'
	
	CREATE TABLE #TempBatch
	(
		PrdId	INT,
		PrdBatId	INT
	)
	
	
	INSERT INTO #TempBatch(PrdId,PrdBatId)
	SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK)
	INNER JOIN ReturnProduct B (NOLOCK) ON A.PrdId=B.PrdId
	WHERE ReturnId = @Pi_ReturnId and A.[Status]=1 AND A.PrdbatCode <>'0.000000-0.000000'
	GROUP BY A.PrdId
	
	BEGIN TRY
	
	DECLARE Cur_ReturnBatch CURSOR
	FOR SELECT ReturnCode,B.PrdId,B.PrdBatId FROM ReturnHeader A (NOLOCK)
	INNER JOIN  ReturnProduct B (NOLOCK) ON A.ReturnId = B.ReturnId 
	INNER JOIN ProductBatch C (NOLOCK) ON C.PrdId=B.PrdId and C.PrdBatId=B.PrdBatId
	WHERE A.ReturnId = @Pi_ReturnId --AND C.Status=0

	OPEN Cur_ReturnBatch
	FETCH NEXT FROM Cur_ReturnBatch INTO @ReturnNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	WHILE @@FETCH_STATUS=0
	BEGIN
	
		DECLARE Cur_ProductBatch CURSOR
		FOR SELECT PB.PrdId,PB.PrdBatId,PrdBatCode
			FROM ProductBatch PB(NOLOCK) 
			INNER JOIN #TempBatch A(NOLOCK) ON PB.Prdid=A.prdid and A.prdbatid = Pb.Prdbatid  WHERE PB.PrdBatId>@Pi_OldMaxPrdBatId AND PB.PrdId=@Old_PrdId
			AND PB.[Status]=1 AND EXISTS(SELECT * FROM #TempBatch TB WHERE TB.PrdId=PB.PrdId and TB.PrdBatId=PB.PrdBatId)
			ORDER BY PB.PrdId,PB.PrdBatId,PrdBatCode
		OPEN Cur_ProductBatch
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
		WHILE @@FETCH_STATUS=0
		BEGIN 
			--SELECT 'M',@PrdId,@PrdBatId,@BatchCode
			DECLARE Cur_BatchTransfer CURSOR
			FOR SELECT PBL.LcnId,PBL.PrdBatId,(PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) AS SalStock,(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) AS UnSalStock,
			(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) AS OfferStock
			FROM ProductBatchLocation PBL(NOLOCK) WHERE PBL.PrdId=@PrdId AND PBL.PrdBatId=@Pi_OldMaxPrdBatId
			AND ((PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih)+(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih)+(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre))>0
		
			OPEN Cur_BatchTransfer
			FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			WHILE @@FETCH_STATUS=0
			BEGIN
				--SELECT 'D',@PrdId,@PrdBatId,@LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock

				SELECT @FromPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@FromPrdBatId
				SELECT @ToPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@PrdBatId

				SET @Po_ErrNo=0			
				IF @SalStock>0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 1,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN
						Exec Proc_UpdateProductBatchLocation 1,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN	
							Exec Proc_UpdateStockLedger 30,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting=0
							BEGIN
								Exec Proc_UpdateStockLedger 27,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
								IF @Po_StkPosting<>0
								BEGIN
									SET @Po_ErrNo=1
								END
								ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=1
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@SalStock,@ReasonId,@ReturnNo,'Batch Transfer From Sales Return',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END											
							END
							ELSE
							BEGIN
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				
				IF @UnSalStock>0
				BEGIN
				Exec Proc_UpdateProductBatchLocation 2,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				IF @Po_StkPosting=0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 2,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN	
						Exec Proc_UpdateStockLedger 31,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN
							Exec Proc_UpdateStockLedger 28,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting<>0
							BEGIN
								SET @Po_ErrNo=1
							END	
							ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=2
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@UnSalStock,@ReasonId,'','Batch Transfer From Sales Return',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END						
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					SET @Po_ErrNo=1
				END
			END
	
				
				IF @Po_ErrNo>0
				BEGIN
					SET @Po_ErrNo=1
					ROLLBACK TRAN
					CLOSE Cur_BatchTransfer
					DEALLOCATE Cur_BatchTransfer
					CLOSE Cur_ProductBatch
					DEALLOCATE Cur_ProductBatch					
					RETURN
				END
				
				FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			END
			CLOSE Cur_BatchTransfer
			DEALLOCATE Cur_BatchTransfer
			FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
			
		END
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
	
		FETCH NEXT FROM Cur_ReturnBatch INTO @ReturnNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	END
	CLOSE Cur_ReturnBatch
	DEALLOCATE Cur_ReturnBatch
	
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
		SET @Po_ErrNo=1
		CLOSE Cur_BatchTransfer
		DEALLOCATE Cur_BatchTransfer
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
		RETURN		
	END CATCH			
	
	RETURN	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_AutoBatchTransferPurchaseReceipt' AND xtype='P')
DROP PROCEDURE Proc_AutoBatchTransferPurchaseReceipt
GO
/*
BEGIN TRANSACTION
SELECT * FROM  PurchaseReceiptProduct A (NOLOCK) WHERE PurRcptId=1208
EXEC Proc_AutoBatchTransferPurchaseReceipt 1208,0
SELECT * FROM BatchTransfer(NOLOCK) where prdid =10547 order by  battrfdate desc
select * from productbatchlocation where prdid =10547
select * from  StockLedger where prdid = 10547 and  transdate ='2018-03-21'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_AutoBatchTransferPurchaseReceipt
(
	@Pi_PurRcptId	INT,
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_AutoBatchTransferPurchaseReceipt
* PURPOSE		: To do Batch Transfer automatically while Purchase Receipt (Same Logic for AutoBatch Transfer in Download)
* CREATED		: S.Mohana  --CRCRSTPAR0106
* CREATED DATE	: 05-12-2020
* MODIFIED
************************************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************
05-12-2020  Mohana.S	 CR     CRCRSTPAR0106          a) When Sales Return is made for a product attached to old Batch, 
														 stocks should be posted to the latest  batch for that product.
03-02-2021	MOhana S	 BZ		PARLESECS/0221/017		Removed Sample batch
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 				AS 	INT
	DECLARE @Trans				AS 	INT
	DECLARE @Tabname 			AS  NVARCHAR(100)
	DECLARE @DestTabname 		AS 	NVARCHAR(100)
	DECLARE @Fldname 			AS  NVARCHAR(100)
	
	DECLARE @PrdDCode 	        AS 	NVARCHAR(100)
	DECLARE @BatchCode			AS 	NVARCHAR(100)
	DECLARE @CmpBatchCode		AS 	NVARCHAR(100)	
	DECLARE @PriceCode			AS 	NVARCHAR(4000)		
	DECLARE @MnfDate			AS 	NVARCHAR(100)
	DECLARE @ExpDate			AS 	NVARCHAR(100)
	DECLARE @TaxGroupCode		AS 	NVARCHAR(100)
	DECLARE @Status				AS 	NVARCHAR(100)
	DECLARE	@BatchSeqCode 		AS 	NVARCHAR(100)
	DECLARE @RefCode           	AS 	NVARCHAR(100)
	DECLARE @PriceValue         AS 	NVARCHAR(100)	
	DECLARE @DefaultPrice       AS 	NVARCHAR(100)	  	
	DECLARE @ExistPrdDCode		AS 	NVARCHAR(100)  	
	DECLARE @ExistBatchCode		AS 	NVARCHAR(100)
	DECLARE @ExistPriceCode		AS 	NVARCHAR(100)  	
	
	DECLARE @PrdId 				AS 	INT
	DECLARE @PrdBatId 			AS 	INT
	DECLARE @PriceId 			AS 	INT
	DECLARE @TaxGroupId 		AS 	INT
	DECLARE @BatchSeqId 		AS 	INT
	DECLARE @BatchStatus		AS 	INT
	DECLARE @SlNo	 			AS 	INT
	DECLARE @NoOfPrices 		AS 	INT
	DECLARE @ExistPrices 		AS 	INT
	DECLARE @DefaultPriceId 	AS 	INT
	DECLARE @ExistPriceId 		AS 	INT
	DECLARE @TransStr 			AS 	NVARCHAR(4000)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT
	DECLARE @ContPrdId 			AS 	INT
	DECLARE @ContPrdBatId 		AS 	INT
	DECLARE @ContExistPrdBatId 	AS 	INT
	DECLARE @ContPriceId 		AS 	INT
	DECLARE @ContractId 		AS 	INT
	DECLARE @ContPriceCode		AS NVARCHAR(100)
	DECLARE @ContPrdBatId1		AS INT
	DECLARE @ContPriceId1		AS INT
	DECLARE @BatchTransfer		AS INT
	DECLARE @SalStock			AS INT
	DECLARE @UnSalStock			AS INT
	DECLARE @OfferStock			AS INT
	DECLARE @FromPrdBatId		AS INT
	DECLARE @FromPrdBatCode		AS NVARCHAR(200)
	DECLARE @ToPrdBatId			AS INT
	DECLARE @LcnId				AS INT
	DECLARE @Po_StkPosting		AS INT
	DECLARE @TransDate			AS DATETIME
	DECLARE @ReceiptNo AS VARCHAR(100)
	DECLARE @FromPriceId AS INT
	DECLARE @TOPriceId AS INT
	
	
	DECLARE @Pi_OldMaxPrdBatId AS INT
	DECLARE @Old_PrdId AS INT
	
	SET @BatchTransfer=0
	SELECT @TransDate=CONVERT(NVARCHAR(10),GETDATE(),121)
 
	SET @Po_ErrNo=0
	SET @Exist=0
	SET @ExistPrdDCode=''	
	SET @ExistBatchCode=''
	SET @ExistPriceCode=''

 
	
	SET @Exist=0
	
	DECLARE @KeyNumber AS VARCHAR(100)
	DECLARE @StockTypeId AS INT
	
	DECLARE @ReasonId AS INT
	SELECT @ReasonId=ReasonId FROM ReasonMaster WHERE Description='Free Stock Movement'
	
	CREATE TABLE #TempBatch
	(
		PrdId	INT,
		PrdBatId	INT
	)
	
	
	INSERT INTO #TempBatch(PrdId,PrdBatId)
	SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK)
	INNER JOIN PurchaseReceiptProduct B (NOLOCK) ON A.PrdId=B.PrdId
	WHERE PurRcptId = @Pi_PurRcptId AND A.PrdbatCode <>'0.000000-0.000000'
	GROUP BY A.PrdId
	
	DECLARE Cur_ReceiptBatch CURSOR
	FOR SELECT PurRcptRefNo,PrdId,PrdBatId FROM PurchaseReceiptProduct A (NOLOCK)
	INNER JOIN PurchaseReceipt B (NOLOCK) ON A.PurRcptId = B.PurRcptId WHERE A.PurRcptId = @Pi_PurRcptId
	 

	OPEN Cur_ReceiptBatch
	FETCH NEXT FROM Cur_ReceiptBatch INTO @ReceiptNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	WHILE @@FETCH_STATUS=0
	BEGIN
	
		DECLARE Cur_ProductBatch CURSOR
		FOR SELECT PB.PrdId,PB.PrdBatId,PrdBatCode
			FROM ProductBatch PB(NOLOCK) 
			INNER JOIN #TempBatch A(NOLOCK) ON PB.Prdid=A.prdid and A.prdbatid = Pb.Prdbatid  WHERE PB.PrdBatId>@Pi_OldMaxPrdBatId AND PB.PrdId=@Old_PrdId
			AND PB.[Status]=1 AND EXISTS(SELECT * FROM #TempBatch TB WHERE TB.PrdId=PB.PrdId and TB.PrdBatId=PB.PrdBatId)
			ORDER BY PB.PrdId,PB.PrdBatId,PrdBatCode
		OPEN Cur_ProductBatch
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
		WHILE @@FETCH_STATUS=0
		BEGIN
			DECLARE Cur_BatchTransfer CURSOR
			FOR SELECT PBL.LcnId,PBL.PrdBatId,(PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) AS SalStock,(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) AS UnSalStock,
			(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) AS OfferStock
			FROM ProductBatchLocation PBL WHERE PBL.PrdId=@PrdId AND PBL.PrdBatId<>@PrdBatId
			OPEN Cur_BatchTransfer
			FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			WHILE @@FETCH_STATUS=0
			BEGIN
				-- select @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
				SELECT @FromPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@FromPrdBatId
				SELECT @ToPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@PrdBatId

				SET @Po_ErrNo=0			
				IF @SalStock>0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 1,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN
						Exec Proc_UpdateProductBatchLocation 1,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN	
							Exec Proc_UpdateStockLedger 30,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting=0
							BEGIN
								Exec Proc_UpdateStockLedger 27,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
								IF @Po_StkPosting<>0
								BEGIN
									SET @Po_ErrNo=1
								END
								ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=1
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@SalStock,@ReasonId,@ReceiptNo,'Batch Transfer From Purchase Receipt',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END											
							END
							ELSE
							BEGIN
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				

				IF @Po_ErrNo>0
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					VALUES(@FromPrdBatId,'','Error','Error In ProdutBat Transfer')
					CLOSE Cur_BatchTransfer
					DEALLOCATE Cur_BatchTransfer
					CLOSE Cur_ProductBatch
					DEALLOCATE Cur_ProductBatch
					RETURN
				END
				
				FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			END
			CLOSE Cur_BatchTransfer
			DEALLOCATE Cur_BatchTransfer
			FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
			
		END
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
	
		FETCH NEXT FROM Cur_ReceiptBatch INTO @ReceiptNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	END
	CLOSE Cur_ReceiptBatch
	DEALLOCATE Cur_ReceiptBatch
	
	RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE name ='Proc_Validate_WS2CS_SalesOrderDetail' AND xtype ='P')
DROP PROCEDURE Proc_Validate_WS2CS_SalesOrderDetail
GO
/*  
BEGIN TRANSACTION   
DELETE FROM ERRORLOG  
exec Proc_Validate_WS2CS_SalesOrderDetail 0   
SELECT * FROM ERRORLOG  
ROLLBACK TRANSACTION
*/  
CREATE PROCEDURE Proc_Validate_WS2CS_SalesOrderDetail
(  
 @Po_ErrNo INT OUTPUT  
)  
AS        
/*******************************************************************************************  
* PROCEDURE  : Proc_Validate_WS2CS_SalesOrderDetail  
* PURPOSE  : To Validate the Order booking details From PDA Intermediate Database  
* CREATED  : S.Moorthi  
* CREATED DATE : 24/08/2018
* MODIFIED  :  
* DATE      AUTHOR     DESCRIPTION  
*****************************************************************************************************  
* DATE         AUTHOR       CR/BZ    USER STORY ID   DESCRIPTION                           
*****************************************************************************************************  
  24/08/2018   S.Moorthi    CR         CRCRSTPAR0020   Parle SFA integration to Vxceed server(Phase 2&3) 
  07-05-2019   Lakshman M   BZ         ILCRSTPAR4318   Request to allow the Billing if stock available in another batch automatic convert in billing screren. and Product default price validation included in CS.
  24-10-2020   Deepak Philip BZ		   PARLECS/1020/205  Sales route considered.
  05-01-2020   Deepak Philip BZ        PARLESECS/1220/135  Free batch validation checking added.
  04-02-2021   Venkat. M	 CR			CRCRSTPAR0107		Salesmancode update for Old code
********************************************************************************************/   
DECLARE @OrdKeyNo AS VARCHAR(50)        
DECLARE @CurrVal AS INT        
DECLARE @RtrId AS INT        
DECLARE @MktId AS INT  
DECLARE @Smid AS INT   
DECLARE @GetKeyStr AS Varchar(50)  
DECLARE @RtrShipId AS INT  
DECLARE @OrdPrdCnt AS INT  
DECLARE @ImpOrdPrdCnt AS INT  
DECLARE @OrderDate AS DateTime   
DECLARE @SalesmanCode NVarchar(100)  
DECLARE @RouteCode NVarchar(100)   
DECLARE @RetailerCode NVarchar(100)  
DECLARE @Remarks NVARCHAR(200)  
DECLARE @lError AS INT  
DECLARE @LAUdcMasterId AS VARCHAR(50)  
DECLARE @LOUdcMasterId AS VARCHAR(50)  
DECLARE @Longitude AS VARCHAR(50)  
DECLARE @Latitude AS VARCHAR(50)  
SET @Po_ErrNo=0  
BEGIN  
 BEGIN TRANSACTION T1  
 DELETE FROM Import_WS2CS_SalesOrderHeader_Track WHERE CONVERT(VARCHAR(10),CreatedDate,121)<=DATEADD(M,-3,CONVERT(VARCHAR(10),GETDATE(),121))  
 DELETE FROM Import_WS2CS_SalesOrderDetail_Track WHERE CONVERT(VARCHAR(10),CreatedDate,121)<=DATEADD(M,-3,CONVERT(VARCHAR(10),GETDATE(),121))  
 DELETE FROM Import_WS2CS_SalesOrderDetail WHERE DownloadFlag='Y'  
 DELETE FROM Import_WS2CS_SalesOrderHeader  WHERE DownloadFlag='Y'   
 SELECT DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) AS OrderNo into #tempORDER   
 from Import_WS2CS_SalesOrderHeader WHERE DocumentAmount>=0  
 INSERT INTO Import_WS2CS_SalesOrderHeader_Track(TenantCode,LocationCode,RouteCode,SalesmanCode,CustomerCode,  
 DocumentType,DocumentPrefix,DocumentNumber,DocumentDate,DeliveryDate,PostingDateTime,  
 DocumentAmount,DownloadFlag,CreatedDate)  
 SELECT TenantCode,LocationCode,RouteCode,SalesmanCode,CustomerCode,  
 DocumentType,DocumentPrefix,DocumentNumber,DocumentDate,DeliveryDate,PostingDateTime,  
 DocumentAmount,DownloadFlag,CreatedDate FROM Import_WS2CS_SalesOrderHeader WHERE DownloadFlag='N'  
 and DocumentAmount>0   
 AND DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) IN (SELECT OrderNo FROM #tempORDER)  
 INSERT INTO Import_WS2CS_SalesOrderDetail_Track(TenantCode,LocationCode,DocumentPrefix,DocumentNumber,  
 SequenceNumber,TransactionType,ItemCode,UnitsOfMeasure,ItemQuantity,ItemPrice,PromotionAmount,ItemExciseTax,  
 TotalLineAmount,IsFreeGood,DownloadFlag,CreatedDate)    
 SELECT TenantCode,LocationCode,DocumentPrefix,DocumentNumber,  
 SequenceNumber,TransactionType,ItemCode,UnitsOfMeasure,ItemQuantity,ItemPrice,PromotionAmount,ItemExciseTax,  
 TotalLineAmount,IsFreeGood,DownloadFlag,CreatedDate  FROM Import_WS2CS_SalesOrderDetail   
 WHERE DownloadFlag='N' AND DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) IN (SELECT OrderNo FROM #tempORDER)  
 UPDATE Import_WS2CS_SalesOrderHeader SET CustomerCode='' WHERE CustomerCode='Dummy'   
 UPDATE Import_WS2CS_SalesOrderHeader SET DownloadFlag='D' WHERE DownloadFlag='N'  
 UPDATE Import_WS2CS_SalesOrderDetail SET DownloadFlag='D' WHERE DownloadFlag='N' 
 -- Added By Venkat. M SalesmanCode Update
 UPDATE A SET SalesmanCode= SMCode from Import_WS2CS_SalesOrderHeader  A (NOLOCK)  
 INNER JOIN Salesman SM (NOLOCK) ON A.SalesmanCode=SM.OldSMCode
   
 UPDATE A SET A.RouteCode=RM.RMCODE FROM Import_WS2CS_SalesOrderHeader A (NOLOCK)  
 INNER JOIN Salesman SM (NOLOCK) ON A.SalesmanCode=SM.SMCode     
 INNER JOIN SalesmanMarket SMM (NOLOCK) ON SMM.SMId=SM.SMId   
 INNER JOIN RouteMaster RM(NOLOCK) ON RM.RMId=SMM.RMId   
 INNER JOIN RetailerMarket RM1(NOLOCK) ON RM1.RMId=RM.RMId  
 INNER JOIN Retailer R (nolock) ON R.CmpRtrCode=A.CustomerCode and RM1.RtrId=R.RtrId   
 WHERE DownLoadFlag='D' and DocumentAmount>=0  
 CREATE TABLE #ProductPrice  
 (  
  Prdid  INT,   
  PrdBatid INT,  
  PriceId  INT,  
  MRP   NUMERIC(18,6)  
 )  
 CREATE TABLE #TEMPCHECK  
 (  
  OrderNo NVARCHAR(100) COLLATE DATABASE_DEFAULT,  
  Cnt   INT  
 )  
 ---ORDER FOR NEW RETAILERS   
 INSERT INTO WS2CS_SalesOrderHeader_NewRetailer(OrderNo,RouteCode,SalesmanCode,CustomerCode,DocumentType,DocumentPrefix,DocumentNumber,  
 DocumentDate,DeliveryDate,PostingDateTime,DocumentAmount,DownLoadFlag)  
 SELECT DISTINCT DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)),RouteCode,SalesmanCode,CustomerCode,DocumentType,DocumentPrefix,DocumentNumber,  
 DocumentDate,DeliveryDate,PostingDateTime,DocumentAmount,DownloadFlag FROM Import_WS2CS_SalesOrderHeader   
   WHERE DownLoadFlag='D' AND ISNULL(CustomerCode,'')=''  
   AND DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) IN (SELECT OrderNo FROM #tempORDER)  
 INSERT INTO WS2CS_SalesOrderDetail_NewRetailer(OrderNo,DocumentPrefix,DocumentNumber,SequenceNumber,TransactionType,ItemCode,  
 UnitsOfMeasure,ItemQuantity,ItemPrice,PromotionAmount,ItemExciseTax,TotalLineAmount,IsFreeGood,DownLoadFlag)  
 SELECT DISTINCT DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) OrderNo,DocumentPrefix,DocumentNumber,SequenceNumber,TransactionType,ItemCode,  
 UnitsOfMeasure,ItemQuantity,ItemPrice,PromotionAmount,ItemExciseTax,TotalLineAmount,IsFreeGood,DownLoadFlag  
 FROM Import_WS2CS_SalesOrderDetail WHERE DownLoadFlag='D' AND DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) IN  
 (SELECT DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) FROM Import_WS2CS_SalesOrderHeader   
 WHERE DownLoadFlag='D' AND ISNULL(CustomerCode,'')='')    
 AND DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) IN (SELECT OrderNo FROM #tempORDER)  
 UPDATE B SET DownLoadFlag='Y' FROM WS2CS_SalesOrderHeader_NewRetailer A   
 INNER JOIN Import_WS2CS_SalesOrderHeader B ON A.OrderNo=B.DocumentPrefix+CAST(B.DocumentNumber AS VARCHAR(10))   
 WHERE B.DownLoadFlag='D'   
 UPDATE B SET DownLoadFlag='Y' FROM WS2CS_SalesOrderDetail_NewRetailer A   
 INNER JOIN Import_WS2CS_SalesOrderDetail B ON A.OrderNo=B.DocumentPrefix+CAST(B.DocumentNumber AS VARCHAR(10))   
 WHERE B.DownLoadFlag='D'   
 SELECT DISTINCT C.DocumentPrefix+CAST(C.DocumentNumber AS VARCHAR(10)) OrderNo,  
 C.SalesmanCode,C.RouteCode,C.CustomerCode,CONVERT(VARCHAR(10),C.PostingDateTime,121) OrderDt  INTO #ORDERDETAILS  
 FROM Import_WS2CS_SalesOrderHeader C   
 INNER JOIN Import_WS2CS_SalesOrderDetail CP ON C.DocumentPrefix+CAST(C.DocumentNumber AS VARCHAR(10)) =CP.DocumentPrefix+CAST(CP.DocumentNumber AS VARCHAR(10))  --AND C.SfaOrderNo=CP.SfaOrderNo   
 INNER JOIN Retailer R (NOLOCK) ON R.CmpRtrCode=C.CustomerCode   
 WHERE C.DownloadFlag='D'  --AND NewCustomerFlag='Y'  
 AND C.DocumentPrefix+CAST(C.DocumentNumber AS VARCHAR(10)) IN (SELECT OrderNo FROM #tempORDER)   
 SELECT DISTINCT C.DocumentPrefix+CAST(C.DocumentNumber AS VARCHAR(10)) OrderNo,  
 ItemCode AS ProdCode,CAST('' AS VARCHAR(100)) AS ProdBatchCode,UnitsOfMeasure AS UomCode,ItemQuantity AS OrderQty,TotalLineAmount AS OrderValue  
 INTO #Import_WS2CS_SalesOrderDetail  
 FROM Import_WS2CS_SalesOrderDetail C WHERE DownLoadFlag='D'   
 AND C.DocumentPrefix+CAST(C.DocumentNumber AS VARCHAR(10)) IN(SELECT OrderNo FROM #ORDERDETAILS)  
 --Commented by Deepak Philip
 --SELECT B.PrdId,PrdCCode,MAX(PrdBatId) AS PrdBatId INTO #TempBatDt FROM #Import_WS2CS_SalesOrderDetail A   
 --INNER JOIN Product B (NOLOCK) ON A.ProdCode=B.PrdCCode   
 --INNER JOIN ProductBatch C (NOLOCK) ON C.PrdId=B.PrdId   
 --GROUP BY B.PrdId,PrdCCode 
  --Added by Deepak Philip
 SELECT B.PrdId,PrdCCode,MAX(C.PrdBatId) AS PrdBatId INTO #TempBatDt FROM #Import_WS2CS_SalesOrderDetail A   
 INNER JOIN Product B (NOLOCK) ON A.ProdCode=B.PrdCCode   
 INNER JOIN ProductBatch C (NOLOCK) ON C.PrdId=B.PrdId   
 Inner join Productbatchdetails D (NOLOCK) on C.prdbatid=D.prdbatid AND prdbatdetailvalue>0 and slno=3
 GROUP BY B.PrdId,PrdCCode 
 UPDATE A SET A.ProdBatchCode=PB.PrdBatCode FROM #Import_WS2CS_SalesOrderDetail A   
 INNER JOIN #TempBatDt B ON A.ProdCode=B.PrdCCode   
 INNER JOIN ProductBatch PB ON PB.PrdBatId=B.PrdBatId AND PB.PrdId=PB.PrdId   
 SELECT OrderNo INTO #OrderNo FROM    
 #ORDERDETAILS GROUP BY OrderNo HAVING COUNT(OrderNo)>1  
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT  1,'SalesOrderHeader','Import_WS2CS_SalesOrderHeader','Duplicate Order details available for '+OrderNo FROM    
 #ORDERDETAILS GROUP BY OrderNo HAVING COUNT(OrderNo)>1  
 SELECT UomCode INTO #TempBaseUOM FROM UomGroup UG (NOLOCK)   
 INNER JOIN UomMaster UM (NOLOCK) ON UG.UomId=UM.UomId WHERE UG.BaseUom='Y'  
 DECLARE CUR_Import CURSOR FOR  
 SELECT DISTINCT OrderNo,SalesmanCode,RouteCode,CustomerCode,OrderDt From #ORDERDETAILS   
  ORDER BY OrderDt ASC  
 OPEN CUR_Import
 FETCH NEXT FROM CUR_Import INTO @OrdKeyNo,@SalesmanCode,@RouteCode,@RetailerCode,@OrderDate   
 While @@Fetch_Status = 0  
 BEGIN   
  SET @OrdPrdCnt=0  
  SET @ImpOrdPrdCnt=0  
  SET @lError = 0  
  SET @RtrId=0  
  SET @RtrShipId=0  
  SET @MktId=0   
   IF NOT EXISTS (SELECT DocRefNo FROM OrderBooking(NOLOCK) WHERE DocRefNo = @OrdKeyNo)  
  BEGIN   
   IF NOT EXISTS (SELECT RtrId FROM Retailer(NOLOCK) WHERE LTRIM(RTRIM(CmpRtrCode)) = @RetailerCode)-- AND RtrStatus = 1)  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 1,'Import_WS2CS_SalesOrderHeader','CustomerCode','Retailer Does Not Exists for the Order ' + @OrdKeyNo  
   END    
   ELSE  
   BEGIN  
     SELECT @Rtrid= RtrId FROM Retailer(NOLOCK) WHERE LTRIM(RTRIM(CmpRtrCode)) = @RetailerCode  
   END  
   SELECT @RtrShipId=(  
   SELECT top 1 RS.RtrShipId FROM RetailerShipAdd RS (NOLOCK) INNER JOIN Retailer R (NOLOCK) ON R.Rtrid= RS.Rtrid   
   WHERE  R.RtrId=@RtrId)  
   IF ISNULL(@RtrShipId,0)=0  
   BEGIN  
    SET @RtrShipId=0  
   END  
   IF ISNULL(@RtrShipId,0)=0  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT  2,'Import_WS2CS_SalesOrderHeader','CustomerCode','Retailer Shipping Address Does Not Exists for the Order ' + @OrdKeyNo   
   END   
   IF NOT EXISTS (SELECT RMID FROM RouteMaster(NOLOCK) WHERE LTRIM(RTRIM(RMCode)) = @RouteCode AND RMstatus = 1)  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 3,'Import_WS2CS_SalesOrderHeader','RouteCode','Market Does Not Exists for the Order ' + @OrdKeyNo   
   END  
   ELSE  
   BEGIN  
    SELECT @MktId=RMID FROM RouteMaster(NOLOCK) WHERE LTRIM(RTRIM(RMCode)) = @RouteCode  and rmsroutetype=1--PARLECS/1020/205
   END  
   IF NOT EXISTS (SELECT SMId FROM Salesman(NOLOCK) WHERE LTRIM(RTRIM(SMCode)) = @SalesmanCode AND Status = 1)  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 4,'Import_WS2CS_SalesOrderHeader','DistrSalesmanCode','Salesman Does Not Exists for the Order ' + @OrdKeyNo    
   END
   ELSE  
   BEGIN  
     SELECT @Smid=SMId FROM Salesman(NOLOCK) WHERE LTRIM(RTRIM(SMCode)) = @SalesmanCode  
   END     
   --SELECT @lError,'T1'  
   IF NOT EXISTS (SELECT * FROM SalesManMarket(NOLOCK) WHERE RMID = @MktId AND SMID = @Smid)  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 5,'Import_WS2CS_SalesOrderHeader','DistrSalesmanCode','Market Not Maped with the Salesman for the Order ' + @OrdKeyNo   
   END  
   IF EXISTS(SELECT ProdCode FROM #Import_WS2CS_SalesOrderDetail WHERE ProdCode NOT IN(SELECT PrdCCode FROM PRODUCT ) AND OrderNo=@OrdKeyNo )  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 6,'#Import_WS2CS_SalesOrderDetail','ProdCode',ProdCode+' Product Code does not Exists for the Order ' + @OrdKeyNo   
    FROM #Import_WS2CS_SalesOrderDetail WHERE ProdCode NOT IN(SELECT PrdCCode FROM PRODUCT) AND OrderNo=@OrdKeyNo      
   END   
   IF EXISTS(SELECT ProdCode FROM #Import_WS2CS_SalesOrderDetail WHERE ProdBatchCode NOT IN(SELECT CmpBatCode FROM ProductBatch(NOLOCK)) AND OrderNo=@OrdKeyNo )  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 6,'#Import_WS2CS_SalesOrderDetail','ProdBatchCode',ProdBatchCode+' ProductBatch Code does not Exists for the Order ' + @OrdKeyNo   
    FROM #Import_WS2CS_SalesOrderDetail WHERE ProdBatchCode NOT IN(SELECT CmpBatCode FROM ProductBatch(NOLOCK)) AND OrderNo=@OrdKeyNo      
   END      
   IF EXISTS(SELECT ProdCode FROM #Import_WS2CS_SalesOrderDetail WHERE OrderQty=0 AND OrderNo=@OrdKeyNo )  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT  8,'#Import_WS2CS_SalesOrderDetail','ProdCode',ProdCode+' Order Quantity is Zero for the Order ' + @OrdKeyNo   
    FROM #Import_WS2CS_SalesOrderDetail WHERE OrderQty=0 AND OrderNo=@OrdKeyNo    
   END    
   IF EXISTS(SELECT ProdCode FROM #Import_WS2CS_SalesOrderDetail WHERE ISNULL(UomCode,'')='' AND OrderNo=@OrdKeyNo )  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT  10,'#Import_WS2CS_SalesOrderDetail','UomCode',ProdCode+' Uom is Null for the Order ' + @OrdKeyNo   
    FROM #Import_WS2CS_SalesOrderDetail WHERE ISNULL(UomCode,'')='' AND OrderNo=@OrdKeyNo  
   END       
   IF EXISTS(SELECT ProdCode FROM #Import_WS2CS_SalesOrderDetail WHERE ISNULL(UPPER(LTRIM(RTRIM(UomCode))),'')   
   NOT IN (SELECT UomCode FROM #TempBaseUOM)  AND OrderNo=@OrdKeyNo )  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 9,'#Import_WS2CS_SalesOrderDetail','UomCode',ProdCode+' Uom does not Exists for the Order ' + @OrdKeyNo    
    FROM #Import_WS2CS_SalesOrderDetail WHERE ISNULL(UomCode,'')   
    NOT IN (SELECT UomCode FROM #TempBaseUOM) AND OrderNo=@OrdKeyNo   
   END  
   IF EXISTS(SELECT * from #Import_WS2CS_SalesOrderDetail WHERE NOT EXISTS(  
   SELECT Prdccode FROM Product P (NOLOCK)   
   INNER JOIN #Import_WS2CS_SalesOrderDetail I ON I.ProdCode=P.Prdccode  
   INNER JOIN UOMMaster UM ON UM.UomCode=I.UomCode  
   INNER JOIN UomGroup U ON U.UomGroupId=P.UomGroupId AND UM.Uomid=U.Uomid)  
   and OrderNo=@OrdKeyNo)  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
    SELECT 10,'#Import_WS2CS_SalesOrderDetail','UomCode',ProdCode+ ' UOM does not exists for the product ' + @OrdKeyNo   
    FROM #Import_WS2CS_SalesOrderDetail WHERE NOT EXISTS(  
    SELECT Prdccode FROM Product P (NOLOCK)   
    INNER JOIN #Import_WS2CS_SalesOrderDetail I ON I.ProdCode=P.Prdccode  
    INNER JOIN UOMMaster UM ON UM.UomCode=I.UomCode  
    INNER JOIN UomGroup U ON U.UomGroupId=P.UomGroupId AND UM.Uomid=U.Uomid)  
    and OrderNo=@OrdKeyNo  
   END   
   SET @GetKeyStr=''    
   SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('OrderBooking','OrderNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))         
    IF LEN(LTRIM(RTRIM(@GetKeyStr)))=0    
    BEGIN    
     SET @lError = 1  
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
     SELECT 11,'#Import_WS2CS_SalesOrderDetail','OrderNo','Ordered Key No not generated for ORder'+@OrdKeyNo    
     BREAK    
    END  
    IF @lError = 0    
    BEGIN  
     --SELECT @Remarks=ISNULL(Remarks,'') FROM Import_WS2CS_SalesOrderHeader WHERE OrderNo=@OrdKeyNo   
     SET @Remarks=''  
     INSERT INTO OrderBooking(    
     OrderNo,OrderDate,DeliveryDate,CmpId,DocRefNo,AllowBackOrder,SmId,RmId,RtrId,OrdType,    
     Priority,FillAllPrd,ShipTo,RtrShipId,Remarks,RoundOff,RndOffValue,TotalAmount,Status,    
     Availability,LastModBy,LastModDate,AuthId,AuthDate,PDADownLoadFlag,Upload)    
     SELECT @GetKeyStr,CONVERT(DATETIME,@OrderDate,121),    
     CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121),    
     0,@OrdKeyNo,0, @Smid AS Smid,    
     @MktId AS RmId,@RtrId AS RtrId,0 as OrdType,0 AS Priority,0 AS FillAllPrd,0 AS ShipTo,    
     @RtrShipId AS RtrShipId,@Remarks AS Remarks,0  AS RoundOff,0 AS RndOffValue,    
     0 AS TotalAmount,0 AS Status,1,1,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121),    
     1,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121),1,0  -- (PDADownloadflag as 1) Added By lakshman  M Dated ON 07-05-2019 PMS ID: ILCRSTPAR4318
    --DETAILS   
     DELETE FROM #ProductPrice  
     INSERT INTO #ProductPrice   
     SELECT P.Prdid,PB.PrdBatid,MAX(PriceId) AS PriceId ,PrdBatDetailValue AS MRP  
     FROM Product P (NOLOCK) INNER JOIN Productbatch PB (NOLOCK) ON P.Prdid=PB.PrdId    
     INNER JOIN #Import_WS2CS_SalesOrderDetail I ON I.ProdCode=P.Prdccode AND I.ProdBatchCode=PB.CmpBatCode  
     INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatid=Pb.PrdBatid  
       AND   PBD.SLNo=1     
     WHERE OrderNo=@OrdKeyNo and PBD.DefaultPrice=1  
     GROUP BY P.Prdid,PB.PrdBatid,PrdBatDetailValue  
     INSERT INTO ORDERBOOKINGPRODUCTS(OrderNo,PrdId,PrdBatId,UOMId1,Qty1,ConvFact1,UOMId2,Qty2,ConvFact2,TotalQty,BilledQty,Rate,  
               MRP,GrossAmount,PriceId,Availability,LastModBy,LastModDate,AuthId,AuthDate,SlNo)    
     SELECT @GetKeyStr,Prdid,Prdbatid,UomID,SUM(OrderQty),ConversionFactor,0,0,0,SUM(OrderQty*ConversionFactor),0,  
      Rate ,MRP,SUM(GrossAmount)GrossAmount,PriceId,  
     1,1,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121),    
     1,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121),LineId  
     FROM (   
     SELECT  P.Prdid,PB.Prdbatid,U.UomID,OrderQty,u.ConversionFactor,    
     PBD.PrdBatDetailValue Rate,PP.Mrp,(PBD.PrdBatDetailValue*(OrderQty*ConversionFactor)) as GrossAmount,PBD.PriceId,ROW_Number()OVER(ORder by P.Prdid)LineId  
     FROM Product P (NOLOCK) INNER JOIN Productbatch PB (NOLOCK) ON P.Prdid=PB.PrdId    
     INNER JOIN #Import_WS2CS_SalesOrderDetail I ON I.ProdCode=P.Prdccode  AND I.ProdBatchCode=PB.CmpBatCode  
     INNER JOIN UOMMaster UM ON UM.UomCode=I.UOMCode  
     INNER JOIN UomGroup U ON U.UomGroupId=P.UomGroupId AND UM.Uomid=U.Uomid  
     INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId=PB.BatchSeqId  
     INNER JOIN #ProductPrice PP ON PP.Prdid=P.Prdid  AND PP.Prdbatid=PB.Prdbatid  
     INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatid=Pb.PrdBatid AND PBD.Prdbatid=PP.Prdbatid  AND PP.Priceid=PBD.PriceId  
          AND BC.slno=PBD.SLNo AND BC.SelRte=1    
     WHERE OrderNo=@OrdKeyNo  
     )A  
     GROUP BY Prdid,Prdbatid,UomID,ConversionFactor,Rate,MRP,PriceId,LineId  
     ORDER BY LineId  
     UPDATE OB SET TotalAmount=X.TotAmt FROM OrderBooking OB INNER JOIN(SELECT ISNULL(SUM(GrossAmount),0)as TotAmt,OrderNo    
     FROM ORDERBOOKINGPRODUCTS WHERE OrderNo=@GetKeyStr GROUP BY OrderNo )X  ON X.OrderNo=OB.OrderNo     
       INSERT INTO #TEMPCHECK   
       SELECT OrderNo,Count(ProdCode)Cnt    
       FROM(     
       SELECT DISTINCT OrderNo,ProdCode,ProdBatchCode  
       FROM #Import_WS2CS_SalesOrderDetail WHERE OrderNo=@OrdKeyNo  
       )A GROUP BY OrderNo  
       SELECT @OrdPrdCnt=ISNULL(Count(PRDID),0) FROM ORDERBOOKINGPRODUCTS (NOLOCK) WHERE OrderNo=@GetKeyStr    
       SELECT @ImpOrdPrdCnt=ISNULL(Cnt,0) FROM #TEMPCHECK (NOLOCK) WHERE OrderNo=@OrdKeyNo  
      IF @OrdPrdCnt=@ImpOrdPrdCnt    
      BEGIN   
       UPDATE COUNTERS SET CurrValue=CurrValue+1 WHERE TabName='OrderBooking' and FldName='OrderNo'   
       UPDATE Import_WS2CS_SalesOrderDetail SET DownLoadFlag='Y' WHERE DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) = @OrdKeyNo   
       UPDATE Import_WS2CS_SalesOrderHeader SET DownLoadFlag='Y' WHERE DocumentPrefix+CAST(DocumentNumber AS VARCHAR(10)) = @OrdKeyNo   
      END  
      ELSE  
      BEGIN  
       SET @lError = 1  
       INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
       SELECT 12,'Import_WS2CS_SalesOrderDetail','OrderNo','Imported Ordered Product Number count does not match with Processed Order ' + @OrdKeyNo    
       DELETE FROM ORDERBOOKINGPRODUCTS WHERE OrderNo=@GetKeyStr    
       DELETE FROM ORDERBOOKING WHERE OrderNo=@GetKeyStr   
       DELETE FROM  ORDERBOOKING WHERE OrderNo NOT IN (SELECT OrderNo FROM ORDERBOOKINGPRODUCTS) AND OrderNo=@GetKeyStr  
      END     
    END  
   END  
   ELSE  
   BEGIN  
    SET @lError = 1  
    INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)   
    SELECT 1,'Import_WS2CS_SalesOrderHeader','OrderNo', @OrdKeyNo+' Order Already exists'   
   END  
  FETCH NEXT FROM CUR_Import INTO @OrdKeyNo,@SalesmanCode,@RouteCode,@RetailerCode,@OrderDate    
 END  
 CLOSE CUR_Import  
 DEALLOCATE CUR_Import  
 --------- Added By lakshman M Dated ON 07-05-2019 PMS ID: ILCRSTPAR4318 -----
	 SELECT OB.OrderNo,P.Prdid,PB.PrdBatid,MAX(PBD.PriceId) AS PriceId ,PrdBatDetailValue AS MRP INTO #PrdPrice 
     FROM Product P (NOLOCK) INNER JOIN Productbatch PB (NOLOCK) ON P.Prdid=PB.PrdId    
     INNER JOIN orderbookingproducts OP (NOLOCK) ON OP.PrdId =P.PrdId and OP.PrdBatId =PB.PrdBatId 
     INNER JOIN OrderBooking OB (NOLOCK)ON OB.OrderNo =OP.OrderNo 
     INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatid=Pb.PrdBatid AND  PBD.SLNo=1 and OP.PrdBatId = PBD.PrdBatId 
     WHERE PBD.DefaultPrice=1 AND OB.STATUS = 0 --and  OB.orderno ='ORD1901799' and p.PrdId = 147
     GROUP BY P.Prdid,PB.PrdBatid,PrdBatDetailValue,OB.OrderNo 
	 	
	UPDATE A SET A.PRICEID = B.PRICEID FROM ORDERBOOKINGPRODUCTS A (NOLOCK)  INNER JOIN #PRDPRICE B ON A.PRDID =B.PRDID AND A.PRDBATID =B.PRDBATID AND A.Orderno =B.Orderno
	INNER JOIN ORDERBOOKING OB (NOLOCK) ON OB.ORDERNO = A.ORDERNO AND OB.ORDERNO =B.ORDERNO
	WHERE OB.STATUS =0 
 ----------------------  Till here --------------------
 ---Sales Return   
 --EXEC Proc_Validate_WS2CS_SalesReturnProducts 0  
 IF @@ERROR = 0  
 BEGIN  
  COMMIT TRANSACTION T1  
 END  
 ELSE  
 BEGIN  
  ROLLBACK TRANSACTION T1  
 END 
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='CN2Cs_Prk_SalesManRouteAcknowledge' AND xtype ='U')
CREATE TABLE CN2Cs_Prk_SalesManRouteAcknowledge
(
       [Distcode] [varchar](20) NULL,
       [GeneratedFlag] [varchar](10) NULL,
	[DownloadFlag] [varchar](10) NULL,
       [CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_SalesManRouteAck_Download' AND XTYPE='P')
DROP PROCEDURE Proc_SalesManRouteAck_Download
GO
CREATE PROCEDURE Proc_SalesManRouteAck_Download
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_SalesManRouteAck_Download
* PURPOSE: To Insert and Update records
* CREATED: Venkat.M. on 03/02/2021  PMS No : CRCRSTPAR0107
*********************************/
SET NOCOUNT ON
BEGIN
	DELETE FROM CN2Cs_Prk_SalesManRouteAcknowledge WHERE DownloadFlag ='Y'
	IF EXISTS (SELECT * FROM CN2Cs_Prk_SalesManRouteAcknowledge (NOLOCK) WHERE GeneratedFlag ='YES' AND DownloadFlag ='D')
	BEGIN
		IF NOT EXISTS (SELECT * FROM Cn2Cs_Prk_SalesManMaster WHERE DownLoadFlag ='D' AND SMName NOT In('Online Aggregator','Dummy Salesman'))
		BEGIN

			IF EXISTS (SELECT * FROM Tbl_SFAConfiguration (NOLOCK) Where CName ='WebserviceURL' AND CValue ='')
			BEGIN
				TRUNCATE TABLE WSMasterExportUploadTrack 
				IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE name ='TBL_SalesManRouteAcknowledge' AND XTYPE='U')
				BEGIN
					SELECT * INTO TBL_SalesManRouteAcknowledge FROM CN2Cs_Prk_SalesManRouteAcknowledge WHERE DownloadFlag ='D'
				END

				UPDATE A  SET CValue ='https://xdintegration.vxceed.net/IntegrationService.svc?wsdl' FROM Tbl_SFAConfiguration A(NOLOCK) Where CName ='WebserviceURL'
			--select * from Tbl_SFAConfiguration Where CName ='WebserviceURL'--https://xdintegration.vxceed.net/IntegrationService.svc?wsdl
			END
			UPDATE A   SET DownloadFlag ='Y' FROM CN2Cs_Prk_SalesManRouteAcknowledge A(NOLOCK)
		END
		
	END
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_MenuAccess' AND TYPE='P')
DROP PROCEDURE Proc_MenuAccess
GO
CREATE PROCEDURE Proc_MenuAccess (@Type INT)
AS
/*******************************************************
* PROCEDURE		: Proc_MenuAccess
* PURPOSE		:  
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
********************************************************************************************
* 02-02-2021	MOHANA S		BZ		PARLECS/0221/014		BillingAuto enabled
* 04-02-2021	MOHANA S		BZ		PARLESECS/0221/022		Enabled Pending Menus
********************************************************************************************/ 
BEGIN
		IF NOT EXISTS (SELECT 'X' FROM ProfileDt_PendingTran)
		BEGIN
			INSERT INTO ProfileDt_PendingTran(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,Parentid)
			SELECT A.PrfId,A.MenuId,A.BtnIndex,A.BtnDescription,A.BtnStatus,
			A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate,B.Parentid
			FROM ProfileDt A INNER JOIN Menudef B ON A.MenuId=B.MenuId
		END

		IF @Type=1
		BEGIN 
			UPDATE A SET BtnStatus=B.BtnStatus FROM 
			ProfileDt A (NOLOCK) INNER JOIN ProfileDt_PendingTran B (NOLOCK) ON A.MenuId=B.MenuId
			AND A.BtnIndex=B.BtnIndex AND A.PrfId=B.PrfId
			
			UPDATE ProfileDt SET BtnStatus=0 WHERE 
			MenuId NOT IN(
			SELECT MenuId FROM Menudef WHERE MenuName IN (SELECT MenuName FROM TmpValidatePendingData WHERE Validate =1)
			UNION SELECT MenuId FROM Menudef WHERE MenuId IN ('mPln2','mPln1','mRep7','mRep2','mStk25','mRep5','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9','mRot2'))

			IF EXISTS (SELECT  * FROM TmpValidatePendingData WHERE Menuname='mnuDeliveryProcess')
			BEGIN			
				UPDATE ProfileDt SET BtnStatus=1 WHERE MenuId IN(SELECT MenuId FROM Menudef WHERE MenuName = 'mnuBilling')
			END

			IF EXISTS(SELECT *  FROM dbo.Fn_CheckPendingDebitNote(1) WHERE Pending = 1)
			BEGIN
				UPDATE ProfileDt SET BtnStatus=1 WHERE MenuId IN(SELECT MenuId FROM Menudef WHERE MenuName = 'mnuDebitNOteTopSheet')
			END

			UPDATE ProfileDt Set BtnStatus =1 where menuid ='mStk31'
		END
		IF @Type=2
		BEGIN 
			UPDATE A SET BtnStatus=B.BtnStatus FROM 
			ProfileDt A (NOLOCK) INNER JOIN ProfileDt_PendingTran B (NOLOCK) ON A.MenuId=B.MenuId
			AND A.BtnIndex=B.BtnIndex AND A.PrfId=B.PrfId			
		END

END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_YEGetOpenTrans' and Type='P')
DROP PROC Proc_YEGetOpenTrans
GO
CREATE PROCEDURE Proc_YEGetOpenTrans
(
	@Pi_FromDate 		DATETIME,
	@Pi_ToDate		    DATETIME,
	@Pi_UsrId           INT
)
AS
/*********************************
* PROCEDURE	: Proc_YEGetOpenTrans
* PURPOSE	: To get the Open transactions for Year End
* CREATED	: Nandakumar R.G
* CREATED DATE	: 09/03/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
15/10/2019  Lakshman   BZ		ILCRSTPAR6197			Year End skip Purchase Process
02-01-2020  Deepak Philip BZ    PARLECS/0121/008        To cancel the salesinvoiceproduct-Salesinvoice mismatch bills for month end.
*********************************/
SET NOCOUNT ON
BEGIN
	TRUNCATE TABLE YearEndOpenTrans
	TRUNCATE TABLE YearEndLog

	--PARLECS/0121/008
	IF EXISTS(SELECT * FROM Salesinvoice A(NOLOCK) WHERE Salid not in (SELECT Salid FROM Salesinvoiceproduct B (NOLOCK)))
	BEGIN
		UPDATE A SET Dlvsts=3 FROM Salesinvoice A(NOLOCK)  WHERE Salid not in (SELECT Salid FROM Salesinvoiceproduct B(NOLOCK))
	END

	---------- commented by lakshma M Dated ON 04/10/2019 PMS ID: ILCRSTPAR6197-----------
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 1,'mCmp9','Purchase','PurchaseReceipt',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM PurchaseReceipt
	--WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 1,'Purchase',PurRcptRefNo
	--FROM PurchaseReceipt
	--WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 2,'mCmp11','Purchase Return','PurchaseReturn',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 2,'Purchase Return',PurRetRefNo
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	-----------------Till here ----------------------
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 3,'mCmp12','Return To Company','ReturnToCompany',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 3,'Return To Company',RtnCmpRefNo
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 4,'mInv4','Stock Management','StockManagement',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 4,'Stock Management',StkMngRefNo
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 5,'mInv7','Salvage','Salvage',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 5,'Salvage',SalvageRefNo
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 6,'mCus18','Billing','SalesInvoice',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 6,'Billing',SalInvNo
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--->Added By Nanda on 15/03/2011
--	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
--	SELECT 7,'Sales Return','ReturnHeader',ISNULL(COUNT(*),0),0
--	FROM ReturnHeader
--	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
--	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
--	SELECT 7,'Sales Return',ReturnCode
--	FROM ReturnHeader
--	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 7,'mCus20','Sales Return','Sales Return',A.Counts+B.Counts,@Pi_UsrId
	FROM 
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader
		WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) A	,
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader RH,SalesInvoice SI
		WHERE RH.Status=1 AND RH.ReturnType=1 
		AND RH.SalId=SI.SalId AND SI.DlvSts<3
		AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) B
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader
	WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader RH,SalesInvoice SI
	WHERE RH.Status=1 AND RH.ReturnType=1 AND RH.SalId=SI.SalId AND SI.DlvSts<3
	AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--->Till Here
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 8,'mCus23','Resell Damage Goods','ResellDamageMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 8,'Resell Damage Goods',ReDamRefNo
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 9,'mClm6','Salesman Salary And DA Claim','SalesmanClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 9,'Salesman Salary And DA Claim',ScmRefNo
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 10,'mClm7','Delivery Boy Salary And DA Claim','DeliveryBoyClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 10,'Delivery Boy Salary And DA Claim',DbcRefNo
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 11,'mClm5','Salesman Incentive Calculator','SMIncentiveCalculatorMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 11,'Salesman Incentive Calculator',SicRefNo
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 12,'mClm13','Van Subsidy Claim','VanSubsidyHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 12,'Van Subsidy Claim',RefNo
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 13,'mClm11','Transporter Claim','TransporterClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 13,'Transporter Claim',TrcRefNo
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 14,'mClm4','Special Discount Claim','SpecialDiscountMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 14,'Special Discount Claim',SdcRefNo
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 15,'mClm8','Rate Difference Claim','RateDifferenceClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 15,'Rate Difference Claim',RefNo
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 16,'mClm9','Purchase Shortage Claim','PurShortageClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 16,'Purchase Shortage Claim',PurShortRefNo
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 17,'mClm10','Purchase Excess Claim','PurchaseExcessClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 17,'Purchase Excess Claim',RefNo
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 18,'mClm3','Manual Claim','ManualClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 18,'Manual Claim',MacRefNo
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 19,'mClm16','VAT Claim','VatTaxClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 19,'VAT Claim',SvatNo
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 20,'Claim Top Sheet','ClaimSheetHD',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 20,'Claim Top Sheet',ClmCode
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 21,'mClm15','Spent and Received','SpentReceivedHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 21,'Spent and Received',SRDRefNo
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 22,'mCus29','Point Redemption Product','PntRetSchemeHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 22,'Point Redemption Product',PntRedRefNo
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 23,'mCus34','Coupon Redemption','CouponRedHd',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 23,'Coupon Redemption',CpnRedCode
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate	
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 25,'mCmp18','IDT Management','IDTManagement',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM IDTManagement WITH(NOLOCK) WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate    
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 25,'IDT Management',IDTMngRefNo FROM IDTManagement WITH(NOLOCK) 
    WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 26,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SampleIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 26,'Sample Issue',IssueRefNo FROM SampleIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 27,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM FreeIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 27,'Sample Issue',IssueRefNo FROM FreeIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate 
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 28,'mCus36','Sample Receipt','SampleReceipt',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SamplePurchaseReceipt WITH(NOLOCK) WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 28,'Sample Receipt',PurRcptRefNo FROM SamplePurchaseReceipt WITH(NOLOCK) 
    WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 --   INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	--SELECT 29,'mInv6','Batch Transfer','BatchTransfer',ISNULL(COUNT(*),0),@Pi_UsrId
 --   FROM BatchTransferHD WITH(NOLOCK) WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 --   INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
 --   SELECT 29,'Batch Transfer',BatRefNo FROM BatchTransferHD WITH(NOLOCK) 
 --   WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate              
END
GO
IF EXISTS(SELECT * FROM SYS.Objects WHERE Name='Proc_ValidateRetailerMasterDummy' AND Type='P')
DROP PROC Proc_ValidateRetailerMasterDummy
GO
CREATE PROCEDURE Proc_ValidateRetailerMasterDummy
(
	@Po_ErrNo INT OUTPUT
)
AS
/***************************************************************************************************************************
* PROCEDURE		: Proc_ValidateRetailerMasterDummy
* PURPOSE		: To Insert and Update records  from xml file in the Table Retailer
* CREATED		: Deepak Philip.
* CREATED DATE	: 17-02-2021
**************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @RetailerCode AS NVARCHAR(100)
	DECLARE @RetailerName AS NVARCHAR(100)
	DECLARE	@Address1 AS NVARCHAR(100)
	DECLARE	@Address2 AS NVARCHAR(100)
	DECLARE	@Address3 AS NVARCHAR(100)
	DECLARE	@PinCode AS NVARCHAR(100)
	DECLARE	@PhoneNo AS NVARCHAR(100)
	DECLARE	@EmailId AS NVARCHAR(100)
	DECLARE	@KeyAccount AS NVARCHAR(100)
	DECLARE	@CoverageMode AS NVARCHAR(100)
	DECLARE	@RegistrationDate AS DATETIME
	DECLARE	@DayOff	AS NVARCHAR(100)
	DECLARE	@Status	AS NVARCHAR(100)
	DECLARE	@Taxable AS NVARCHAR(100)
	DECLARE	@TaxType AS NVARCHAR(100)
	DECLARE	@TINNumber AS NVARCHAR(100)
	DECLARE @CSTNumber AS NVARCHAR(100)
	DECLARE	@TaxGroup AS NVARCHAR(100)
	DECLARE	@CreditBills AS NVARCHAR(100)
	DECLARE	@CreditLimit AS NVARCHAR(100)
	DECLARE	@CreditDays AS NVARCHAR(100)
	DECLARE	@CashDiscountPercentage AS NVARCHAR(100)
	DECLARE	@CashDiscountCondition AS NVARCHAR(100)
	DECLARE	@CashDiscountLimitValue AS NVARCHAR(100)
	DECLARE	@LicenseNumber AS NVARCHAR(100)
	DECLARE	@LicNumberExDate AS NVARCHAR(10)
	DECLARE	@DrugLicNumber AS NVARCHAR(100)
	DECLARE	@DrugLicExDate AS NVARCHAR(10)
	DECLARE	@PestLicNumber	AS NVARCHAR(100)
	DECLARE	@PestLicExDate AS NVARCHAR(10)
	DECLARE	@GeographyHierarchyValue AS NVARCHAR(100)
	DECLARE	@DeliveryRoute	AS NVARCHAR(100)
	DECLARE	@ResidencePhoneNo AS NVARCHAR(100)
	DECLARE	@OfficePhoneNo 	AS NVARCHAR(100)
	DECLARE	@DepositAmount 	AS NVARCHAR(100)
	DECLARE	@VillageCode 	AS NVARCHAR(100)
	DECLARE	@PotentialClassCode AS NVARCHAR(100)
	DECLARE	@RetailerType AS NVARCHAR(100)
	DECLARE	@RetailerFrequency AS NVARCHAR(100)
	DECLARE	@RtrCrDaysAlert AS NVARCHAR(100)
	DECLARE	@RtrCrBillAlert AS NVARCHAR(100)
	DECLARE	@RtrCrLimitAlert AS NVARCHAR(100)
	DECLARE @GeoMainId AS INT
	DECLARE @RMId AS INT
	DECLARE @VillageId AS INT
	DECLARE @RtrId AS INT
	DECLARE @TaxGroupId AS INT
	DECLARE @RtrClassId AS INT
	DECLARE @Taction AS INT
	DECLARE @Tabname AS NVARCHAR(100)
	DECLARE @CntTabname AS NVARCHAR(100)
	DECLARE @Fldname AS NVARCHAR(100)
	DECLARE @ErrDesc AS NVARCHAR(1000)
	DECLARE @sSql AS NVARCHAR(4000)
	DECLARE @CoaId AS INT
	DECLARE @AcCode AS NVARCHAR(1000)
	DECLARE @CmpRtrCode AS NVARCHAR(200)	
	
	--RtrCode Auto Generate--PARCS202100043
	DECLARE @AutoRtrCode AS NVARCHAR(200)
	DECLARE @RtrCodeUserInput AS NVARCHAR(200)
	DECLARE @AutoRtrCodeConfig AS TINYINT
	SET @AutoRtrCodeConfig=0
	IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
	BEGIN
		SET @AutoRtrCodeConfig=1
	END
	--Till Here--PARCS202100043

	
	EXEC Proc_Validate_ETLRetailerDetails --added by Mohana 
	SET @CntTabname='Retailer'
	SET @Fldname='RtrId'
	SET @Tabname = 'ETL_Prk_Retailer'
	SET @Taction=0
	SET @Po_ErrNo=0
	SET @VillageId=0
	DECLARE Cur_Retailer CURSOR
	FOR SELECT dbo.Fn_Removejunk(ISNULL([Retailer Code],'')),dbo.Fn_Removejunk(ISNULL([Retailer Name],'')),dbo.Fn_Removejunk(ISNULL([Address1],'')),
		dbo.Fn_Removejunk(ISNULL([Address2],'')),dbo.Fn_Removejunk(ISNULL([Address3],'')),
		ISNULL([Pin Code],'0'),ISNULL([Phone No],'0'),dbo.Fn_Removejunk(ISNULL(EmailId,'')),ISNULL([Key Account],''),
		ISNULL([Coverage Mode],''),CAST([Registration Date] AS DATETIME) AS [Registration Date],ISNULL([Day Off],''),
		ISNULL([Status],''),ISNULL([Taxable],''),ISNULL([Tax Type],''),ISNULL([TIN Number],''),
		ISNULL([CST Number],''),ISNULL([Tax Group],''),ISNULL([Credit Bills],'0'),ISNULL([Credit Limit],'0'),
		ISNULL([Credit Days],'0'),ISNULL([Cash Discount Percentage],'0'),ISNULL([Cash Discount Condition],''),
		ISNULL([Cash Discount Limit Value],'0'),ISNULL([License Number],''),
		ISNULL([License Number Expiry Date],NULL),
		ISNULL([Drug License Number],''),ISNULL([Drug License Number Expiry Date],NULL),
		ISNULL([Pesticide License Number],''),ISNULL([Pesticide License Number Expiry Date],NULL),
		ISNULL([Geography Hierarchy Value],''),ISNULL([Delivery Route Code],''),ISNULL([Village Code],''),
		ISNULL([Residence Phone No],''),ISNULL([Office Phone No],''),ISNULL([Deposit Amount],'0'),
		ISNULL([Potential Class Code],''),
		ISNULL([Retailer Type],'') ,
		ISNULL([Retailer Frequency],''),ISNULL([Credit Days Alert],'') ,
		ISNULL([Credit Bills Alert],'') ,ISNULL([Credit Limit Alert],'')
	FROM ETL_Prk_Retailer WITH(NOLOCK) ORDER BY [Retailer Code]
	OPEN Cur_Retailer
	FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
	@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
	@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
	@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
	@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
	@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	WHILE @@FETCH_STATUS=0		
	BEGIN
		
		SET @RtrId=0
		
		---Start--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RetailerCode
		
	IF @RetailerCode <>'DUMMY'--PARLECS/0820/189
	BEGIN	
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
			
		
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RetailerCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END
				RETURN
			END
	 END		
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RetailerCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		IF NOT EXISTS  (SELECT * FROM Geography WHERE GeoCode = @GeographyHierarchyValue )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Geogrpahy Code: ' + @GeographyHierarchyValue + ' is not available'  		
			INSERT INTO Errorlog VALUES (1,@Tabname,'GeographyHierarchyValue',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoCode = @GeographyHierarchyValue
		END
		IF NOT EXISTS  (SELECT * FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'  		
			INSERT INTO Errorlog VALUES (2,@Tabname,'DeliveryRoute',@ErrDesc)
		END
		ELSE
		BEGIN		
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute
		END
		IF LTRIM(RTRIM(@PotentialClassCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode )
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Potential Class Code ' + @PotentialClassCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (3,@Tabname,'PotentialClassCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @RtrClassId =RtrClassId FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode
			END
		END
		SELECT @TaxGroupId = 0
		IF LTRIM(RTRIM(@TaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @TaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (4,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup
			END
		END
		IF LTRIM(RTRIM(@VillageCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RouteVillage WHERE VillageCode = @VillageCode)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Village Code ' + @VillageCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (5,@Tabname,'VillageCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @VillageId =VillageId FROM RouteVillage WHERE VillageCode = @VillageCode
			END
		END
		IF (LTRIM(RTRIM(@RetailerCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'')
		BEGIN
			IF EXISTS  (SELECT * FROM Retailer WHERE 
			(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput
				))
			BEGIN
				SET @Taction=2
				SELECT @RtrId=RtrId from Retailer WHERE 
				(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			END
			ELSE
			BEGIN
				SET @Taction=1
			END
		END
		ELSE
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Code should not be empty '  		
			INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
		END
		
			
		IF LTRIM(RTRIM(@RetailerName))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Name should not be empty'		
			INSERT INTO Errorlog VALUES (7,@Tabname,'RetailerName',@ErrDesc)
		END	
		IF LTRIM(RTRIM(@Address1))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Address  should not be empty'		
			INSERT INTO Errorlog VALUES (8,@Tabname,'Address',@ErrDesc)
		END
		IF LEN(@PinCode)<>0
		BEGIN
			IF ISNUMERIC(@PinCode)=0
			BEGIN
				SET @Po_ErrNo=1	
				SET @Taction=0
				SET @ErrDesc = 'PinCode is not in correct format'		
				INSERT INTO Errorlog VALUES (9,@Tabname,'PinCode',@ErrDesc)
			END	
		END					
				
		IF LTRIM(RTRIM(@KeyAccount))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'KeyAccount should not be empty'		
			INSERT INTO Errorlog VALUES (10,@Tabname,'KeyAccount',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@KeyAccount))='Yes' OR LTRIM(RTRIM(@KeyAccount))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Key Account Type '+@KeyAccount+ ' is not available'		
				INSERT INTO Errorlog VALUES (11,@Tabname,'KeyAccount',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CoverageMode))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Coverage Mode should not be empty'		
			INSERT INTO Errorlog VALUES (12,@Tabname,'CoverageMode',@ErrDesc)
		END
		ELSE
			BEGIN
			IF LTRIM(RTRIM(@CoverageMode))='Order Booking' OR LTRIM(RTRIM(@CoverageMode))='Van Sales' OR LTRIM(RTRIM(@CoverageMode))='Counter Sales'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Coverage Mode Type '+@CoverageMode+ ' does not exists'		
				INSERT INTO Errorlog VALUES (13,@Tabname,'CoverageMode',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RegistrationDate))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Registration Date should not be empty'		
			INSERT INTO Errorlog VALUES (14,@Tabname,'RegistrationDate',@ErrDesc)
		END
		ELSE
		BEGIN
			IF ISDATE(@RegistrationDate)=0
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Registration Date '+@RegistrationDate+ ' not in date format'		
				INSERT INTO Errorlog VALUES (15,@Tabname,'RegistrationDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF @RegistrationDate > (CONVERT(NVARCHAR(11),GETDATE(),121))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Invalid Registration Date'		
					INSERT INTO Errorlog VALUES (16,@Tabname,'RegistrationDate',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@DayOff))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Day Off should not be empty'		
			INSERT INTO Errorlog VALUES (17,@Tabname,'DayOff',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@DayOff))='Sunday' OR LTRIM(RTRIM(@DayOff))='Monday' OR LTRIM(RTRIM(@DayOff))='Tuesday' OR
			LTRIM(RTRIM(@DayOff))='Wednesday' OR LTRIM(RTRIM(@DayOff))='Thursday' OR LTRIM(RTRIM(@DayOff))='Friday' OR
			LTRIM(RTRIM(@DayOff))='Saturday'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Day Off Type '+@DayOff+ ' is not available'		
				INSERT INTO Errorlog VALUES (18,@Tabname,'DayOff',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Status))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Status should not be empty'		
			INSERT INTO Errorlog VALUES (19,@Tabname,'Status',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Status))='Active' OR LTRIM(RTRIM(@Status))='Inactive'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Status Type '+@Status+ ' is not available'		
				INSERT INTO Errorlog VALUES (20,@Tabname,'Status',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Taxable))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Taxable should not be empty'		
			INSERT INTO Errorlog VALUES (21,@Tabname,'Taxable',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Taxable))='Yes' OR LTRIM(RTRIM(@Taxable))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Taxable Type '+@Taxable+ ' is not available'		
				INSERT INTO Errorlog VALUES (22,@Tabname,'Taxable',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (23,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (24,@Tabname,'TaxType',@ErrDesc)
			END
		END
		IF @TaxType='VAT'
		BEGIN
			IF LTRIM(RTRIM(@TINNumber))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'TIN Number should not be empty'		
				INSERT INTO Errorlog VALUES (25,@Tabname,'TINNumber',@ErrDesc)
			END
			ELSE
			BEGIN
				IF LEN(@TINNumber)>11
				BEGIN
					SET @Po_ErrNo=1
					SET @Taction=0
					SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
					INSERT INTO Errorlog VALUES (26,@Tabname,'TINNumber',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@CreditBills))<>''
		BEGIN
			IF ISNUMERIC(@CreditBills)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Bills value Should be Number'		
				INSERT INTO Errorlog VALUES (27,@Tabname,'CreditBills',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditLimit))<>''
		BEGIN
			IF ISNUMERIC(@CreditLimit)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit value Should be Number'		
				INSERT INTO Errorlog VALUES (28,@Tabname,'CreditLimit',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditDays))<>''
		BEGIN
			IF ISNUMERIC(@CreditDays)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Days value Should be Number'		
				INSERT INTO Errorlog VALUES (29,@Tabname,'CreditDays',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (30,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (31,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountCondition))<>''
		BEGIN
			IF LTRIM(RTRIM(@CashDiscountCondition))='>=' OR LTRIM(RTRIM(@CashDiscountCondition))='<='
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Condition Type '+@CashDiscountCondition+ ' is not available'		
				INSERT INTO Errorlog VALUES (32,@Tabname,'CashDiscountCondition',@ErrDesc)
			END
		END
			
	
		IF LTRIM(RTRIM(@CashDiscountLimitValue))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountLimitValue)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Limit Value value Should be Number'		
				INSERT INTO Errorlog VALUES (33,@Tabname,'CashDiscountLimitValue',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@LicenseNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@LicNumberExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (34,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@LicNumberExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'License Number Expiry Date '+@LicNumberExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (35,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF  (CONVERT(NVARCHAR(10),@LicNumberExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (36,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@DrugLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@DrugLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Drug License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (37,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@DrugLicExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Drug License Number Expiry Date '+@DrugLicExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (38,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@DrugLicExDate,121))< CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Drug License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (39,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@PestLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@PestLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Pesticide License Number Expiry Date  was not given'		
				INSERT INTO Errorlog VALUES (40,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@PestLicExDate,121))=0
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Pesticide License Number Expiry Date '+@PestLicExDate+ 'not in date format'		
						INSERT INTO Errorlog VALUES (41,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@PestLicExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Pesticide License Number Expiry Date '		
						INSERT INTO Errorlog VALUES (42,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@RetailerType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Type should not be empty'		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Retailer Type',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerType))='Retailer' OR LTRIM(RTRIM(@RetailerType))='Sub Stockist'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Type '+@RetailerType+ ' is not available'		
				INSERT INTO Errorlog VALUES (44,@Tabname,'Retailer Type',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RetailerFrequency))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency should not be empty'		
			INSERT INTO Errorlog VALUES (45,@Tabname,'Retailer Frequency',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerFrequency))='Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Bi-Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Fort Nightly' OR LTRIM(RTRIM(@RetailerFrequency))='Monthly' OR LTRIM(RTRIM(@RetailerFrequency))='Daily'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Frequency '+@RetailerFrequency+ ' is not available'		
				INSERT INTO Errorlog VALUES (46,@Tabname,'Retailer Frequency',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrDaysAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Days Alert should not be empty'		
			INSERT INTO Errorlog VALUES (47,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrDaysAlert))='None' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrDaysAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (48,@Tabname,'Credit Days Alert',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RtrCrBillAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Bills Alert should not be empty'		
			INSERT INTO Errorlog VALUES (49,@Tabname,'Credit Bills Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrBillAlert))='None' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrBillAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (50,@Tabname,'Credit Bills Alert',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrLimitAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Limit Alert should not be empty'		
			INSERT INTO Errorlog VALUES (51,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrLimitAlert))='None' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit Alert '+@RtrCrLimitAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (52,@Tabname,'Credit Limit Alert',@ErrDesc)
			END
		END
		
		IF @Taction=1
		BEGIN
			SET @CmpRtrCode=''
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger(@CntTabname,@FldName,CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')	
			
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1
			BEGIN			
				IF NOT EXISTS(SELECT * FROM Retailer)
				BEGIN
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'	
				END
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))			
			END
			ELSE
			BEGIN
				SET @CmpRtrCode=@RetailerCode
			END
			
			SELECT @CmpRtrCode=@RetailerCode where @RetailerCode='DUMMY'--PARLECS/0820/189
			IF @CmpRtrCode=''
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Company Retailer Code should not be empty'		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
			END
		END
		
		
		
		IF @RtrId=0
		BEGIN
			SET @Po_ErrNo=1		
			SET @Taction=0
			SET @ErrDesc = 'Reset the Counter Year Value '		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
		END
		
		IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
		BEGIN
			IF LTRIM(RTRIM(@PhoneNo))=''
			BEGIN
				--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtdId NOT IN (@RetailerCode))
				IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
				(RtrCode NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
				OR RtrCode NOT IN (@RtrCodeUserInput)))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Retailer Phone Number not be Empty '		
					INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
				END				
			END			
		END
		
		IF LTRIM(RTRIM(@PhoneNo))<>''
		BEGIN
			--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtrId  NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
			(RtrCode  NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Phone Number should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
			END			
		END
		IF LTRIM(RTRIM(@TINNumber))<>''
		BEGIN
			--IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND RtrId NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND 
			(RtrCode NOT IN (@RetailerCode)OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tin Number Should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'TiN Number',@ErrDesc)
			END			
		END
		
		IF @Po_ErrNo=0
		BEGIN		
			DECLARE @MSG AS VARCHAR(100)
			SET @MSG=''
			SELECT @MSG=DBO.Fn_RetailerApprovalStatus(@RtrId)
			IF ISNULL(@MSG,'')<>''
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
				SELECT DISTINCT 5,'Retailer ApprovalStatus','ApprovalStatus',@MSG 
				SET @Po_ErrNo =1 
			END
		END
		
					
		IF  @Taction=1 AND @Po_ErrNo=0
		BEGIN	
			INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,RtrDrugLicNo,RtrDrugExpiryDate,
			RtrPestLicNo,RtrPestExpiryDate,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,Approved,XmlUpload,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrUniqueCode,RtrCodeUserInput)--Gopi at 08/11/2016
			VALUES(@RtrId,@RetailerCode,@CmpRtrCode,@RetailerName,@Address1,@Address2,@Address3,CAST(@PinCode AS INT),@PhoneNo,@EmailId,
			(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END),
			@RegistrationDate,
			(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),@TINNumber,@CSTNumber,@TaxGroupId,CAST(@CreditBills AS INT),CAST(@CreditLimit AS NUMERIC(18,2)),CAST(@CreditDays AS INT),
			(CAST(@CashDiscountPercentage AS NUMERIC(18,2))),(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),CAST(@CashDiscountLimitValue AS NUMERIC (18,2)),
			@LicenseNumber,CONVERT(NVARCHAR(10),@LicNumberExDate,121),@DrugLicNumber,CONVERT(NVARCHAR(10),@DrugLicExDate,121),
			@PestLicNumber,CONVERT(NVARCHAR(10),@PestLicExDate,121),@GeoMainId,@RMId,@VillageId,@ResidencePhoneNo,@OfficePhoneNo,
			CAST(@DepositAmount AS NUMERIC(18,2)),CONVERT(NVARCHAR(10),GETDATE(),121),CONVERT(NVARCHAR(10),GETDATE(),121),@CoaId,0,0,
			(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			'N',0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'',@RtrCodeUserInput)
			
			UPDATE CompanyCounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
			--RtrCode Auto Generate
			IF @AutoRtrCodeConfig=1
			BEGIN
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''RtrCode'''
				INSERT INTO Translog(strSql1) VALUES (@sSql) 
				
			END
			--Till Here
			
			
			SET @sSql='UPDATE CompanyCounters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''CmpRtrCode'''
			INSERT INTO Translog(strSql1) VALUES (@sSql) 		
			SET @sSql='INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,RtrCashDiscPerc,
			RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrDrugLicNo,RtrPestLicNo,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,XmlUpload,Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrLicExpiryDate,RtrDrugExpiryDate,RtrPestExpiryDate,Approved,RtrCodeUserInput)
			VALUES('+CAST(@RtrId AS VARCHAR(10))+','''+@RetailerCode+''','''+@CmpRtrCode+''','''+@RetailerName+''','''+@Address1+''','''+@Address2+''','''+@Address3+''','+CAST(CAST(@PinCode AS INT)AS VARCHAR(10))+','''+@PhoneNo+''','''+@EmailId+''',
			'+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+',
			'''+CAST(@RegistrationDate AS VARCHAR(12))+''',
			'+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			'+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+','''+@TINNumber+''','''+@CSTNumber+''','+CAST(@TaxGroupId AS VARCHAR(10))+','+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+','+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20))+','+CAST(CAST(@CreditDays AS INT) AS VARCHAR(10))+',
			'+CAST((CAST(@CashDiscountPercentage AS NUMERIC(18,2)))AS VARCHAR(20))+','+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+','+CAST(CAST(@CashDiscountLimitValue AS NUMERIC (18,2))AS VARCHAR(20))+',
			'''+@LicenseNumber+''','''+@DrugLicNumber+''',
			'''+@PestLicNumber+''','+CAST(@GeoMainId AS VARCHAR(10))+','+CAST(@RMId AS VARCHAR(10))+','+CAST(@VillageId AS VARCHAR(10))+','''+@ResidencePhoneNo+''','''+@OfficePhoneNo+''',
			'+CAST(CAST(@DepositAmount AS NUMERIC(18,2))AS VARCHAR(20))+','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','+CAST(@CoaId AS VARCHAR(10))+',0,0
			,'+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+'
			,''N'',0,0,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',0'
			
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			--RtrCode Auto Generate
			SET @sSql=@sSql + ','''+ISNULL(@RtrCodeUserInput,'')+''')'
			---Till Here
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  @CntTabname AND Fldname = @FldName
			SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname ='''+@CntTabname+''' AND Fldname ='''+@FldName+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			IF EXISTS (SELECT * FROM Retailer WHERE RtrId=@RtrId)
			BEGIN
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RetailerName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VeLUES ('+CAST(@CoaId AS VARCHAR(10))+','''+@AcCode+''','''+@RetailerName+''',4,2,2,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				IF @PotentialClassCode<>''
				BEGIN
					DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
					SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
					INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
					SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				END
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =  ''CoaMaster'' AND Fldname = ''CoaId'''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END			
		END		
		IF  @Taction=2 AND @Po_ErrNo=0
		BEGIN
			--CRCRSTPAR0070
			IF @Taction=2
			BEGIN
				
				----PARCS202100043 OR condition added RtrCodeUserInput
				DECLARE @ReturnMsg AS VARCHAR(100)
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrName',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
					BEGIN
					SET @RetailerName=(SELECT RtrName FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrStatus',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @Status=(SELECT CASE RTRSTATUS WHEN 1 THEN 'Active' ELSE 'InActive' END FROM Retailer 
					WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))					
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'Geography',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @GeoMainId=(SELECT GeoMainId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
			END
			
			--Added By S.Moorthi CRCRSTPAR0001
				IF EXISTS (SELECT '*' FROM Retailer (NOLOCK) WHERE RTRID = @RtrId and (RtrName<>@RetailerName
				or RtrStatus<>(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) or ISNULL(GeoMainId,0)<>ISNULL(@GeoMainId,0)))
				BEGIN
					IF NOT EXISTS (SELECT DISTINCT RtrId FROM RetailerApprovalStatus WHERE RtrId = @RtrId)
					BEGIN
						INSERT INTO RetailerApprovalStatus(RtrId,RtrCtgId,RtrClassId,RtrStatus,
						Rtrname,Geoid,Upload,Mode,ModDate)
						SELECT @RtrId,0,0,
						CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) END,
						CASE WHEN RtrName=@RetailerName THEN '' ELSE @RetailerName END,
						CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END,
						0,2,GETDATE() FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					END
								  
					UPDATE A SET RtrName = CASE WHEN RTRIM(LTRIM(B.RtrName))=RTRIM(LTRIM(@RetailerName)) THEN '' ELSE @RetailerName END,
					RtrStatus=CASE WHEN B.RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 ENd) END,
					GeoId=CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END FROM RetailerApprovalStatus A INNER JOIN Retailer B ON A.RtrId=B.RtrId
					WHERE A.RtrId = @RtrId 
					SELECT @RetailerName=CASE WHEN RtrName=@RetailerName THEN @RetailerName ELSE RtrName END,
					@GeoMainId=CASE WHEN GeoMainId=@GeoMainId THEN @GeoMainId ELSE GeoMainId END,	
					@Status= CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) ELSE RtrStatus END 
					FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					UPDATE R SET R.Upload='N' FROM RetailerApprovalStatus A(NOLOCK)     
					INNER JOIN  RETAILER R (NOLOCK) ON A.RTRID=R.RTRID    
					WHERE A.Upload=0 AND R.RtrId=@RtrId    
						
				END
			--Till Here
					
			UPDATE Retailer SET  RtrName=@RetailerName,RtrAdd1=@Address1,RtrAdd2=@Address2,RtrAdd3=@Address3,
			RtrPinNo=CAST (@PinCode AS INT),RtrPhoneNo=@PhoneNo,
			RtrEmailId=@EmailId,
			RtrKeyAcc=(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrCovMode=(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)
			,RtrRegDate=CONVERT(NVARCHAR(10),@RegistrationDate,121),
			RtrDayOff=(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			RtrTaxable=(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrTaxType=(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),
			RtrTINNo=@TINNumber,
			RtrCSTNo=@CSTNumber,TaxGroupId=@TaxGroupId,RtrCrBills=CAST(@CreditBills AS INT),RtrCrLimit=CAST(@CreditLimit AS NUMERIC(18,2)),RtrCrDays=CAST(@CreditDays AS INT),
			RtrCashDiscPerc=CAST(@CashDiscountPercentage AS NUMERIC(18,2)),
			RtrCashDiscCond=(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),RtrCashDiscAmt=CAST(@CashDiscountLimitValue AS NUMERIC(18,2)),
			RtrLicNo=@LicenseNumber,RtrLicExpiryDate=CONVERT(NVARCHAR(10),@LicNumberExDate,121),RtrDrugLicNo=@DrugLicNumber,
			RtrDrugExpiryDate=CONVERT(NVARCHAR(10),@DrugLicExDate,121),RtrPestLicNo=@PestLicNumber,
			RtrPestExpiryDate=CONVERT(NVARCHAR(10),@PestLicExDate,121),GeoMainId=@GeoMainId,
			RMId=@RMId,VillageId=@VillageId,RtrResPhone1=@ResidencePhoneNo,RtrOffPhone1=@OfficePhoneNo,RtrDepositAmt=CAST(@DepositAmount AS NUMERIC(18,2)), 
			RtrType=(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			RtrFrequency=(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			RtrCrDaysAlert=(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrBillsAlert=(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrLimitAlert=(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)
			WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput =@RtrCodeUserInput OR RtrCode=@RtrCodeUserInput)
				
			SET @sSql='UPDATE Retailer SET  RtrName='''+@RetailerName+''',RtrAdd1='''+@Address1+''',RtrAdd2='''+@Address2+''',RtrAdd3='''+@Address3+''',
			RtrPinNo='+CAST(CAST(@PinCode AS INT) AS VARCHAR(20))+',RtrPhoneNo='''+@PhoneNo+''',
			RtrEmailId='''+@EmailId+''',
			RtrKeyAcc='+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrCovMode='+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+'
			,RtrRegDate='''+CONVERT(NVARCHAR(10),@RegistrationDate,121)+''',
			RtrDayOff='+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			RtrStatus='+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxable='+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxType='+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+',
			RtrTINNo='''+@TINNumber+''',
			RtrCSTNo='''+@CSTNumber+''',TaxGroupId='+CAST(@TaxGroupId AS VARCHAR(10))+',RtrCrBills='+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+',RtrCrLimit='+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20))+',RtrCrDays='+CAST(CAST(@CreditDays AS INT) AS VARCHAR(10))+',
			RtrCashDiscPerc='+CAST(CAST(@CashDiscountPercentage AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrCashDiscCond='+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+',RtrCashDiscAmt='+CAST(CAST(@CashDiscountLimitValue AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrLicNo='''+@LicenseNumber+''',RtrDrugLicNo='''+@DrugLicNumber+''',RtrPestLicNo='''+@PestLicNumber+''',GeoMainId='+CAST(@GeoMainId AS VARCHAR(10))+',
			RMId='+CAST(@RMId AS VARCHAR(20))+',VillageId='+CAST(@VillageId AS VARCHAR(20))+',RtrResPhone1='''+@ResidencePhoneNo+''',RtrOffPhone1='''+@OfficePhoneNo+''',RtrDepositAmt='+CAST(CAST(@DepositAmount AS NUMERIC(18,2)) AS VARCHAR(20))+''
					
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate='''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate='''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate='''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			SET @sSql=@sSql + ',RtrType='+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,RtrFrequency='+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,RtrCrDaysAlert='+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrBillsAlert='+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrLimitAlert='+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+''
			SET @sSql=@sSql +' WHERE RtrCode='''+@RetailerCode+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @CoaId=CoaId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			UPDATE CoaMAster SET AcName=@RetailerName WHERE CoaId=@CoaId
			SET @sSql='UPDATE CoaMaster SET AcName='''+@RetailerName+''' WHERE CoaId='+CAST(@CoaId AS VARCHAR(10))+''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @RtrId=RtrId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			IF @PotentialClassCode<>''
			BEGIN
				DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
				SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END
		END
		FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
		@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
		@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
		@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
		@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
		@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	END
	CLOSE Cur_Retailer
	DEALLOCATE Cur_Retailer
	RETURN
END
GO
IF EXISTS(SELECT * FROM SYS.Objects WHERE Name='Proc_Export_CS2WS_Customer' AND Type='P')
DROP PROC Proc_Export_CS2WS_Customer
GO
CREATE PROCEDURE Proc_Export_CS2WS_Customer
(
   @SalRpCode varchar(100)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_Customer 
* PURPOSE		: To Export Customer details to the PDA Intermediate Database
* CREATED		: AMUTHA KUMAR P
* CREATED DATE	: 16-08-2018
* MODIFIED		: 
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 16/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export Customer details
* 29/11/2018   S.Moorthi		    ILCRSTPAR2692		  SR	 0 price moved to SFA Application from Sehyog .
* 14-08-2020   S.Mohana				PARLESECS/0820/085	  BZ	 Allowed GT Category for DUmmy retailer
* 20-11-2020   Deepak Philip        PARLECS/1120/097      BZ     Retailer Active Status validation has been removed and And script modified to Upload data on every sync.
* 17-02-2021   Deepak Philip        PARLECS/0221/214      BZ     Validation added for Dummy Retailer creation.
*********************************************************************************************************************/
BEGIN
	IF NOT EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
	BEGIN
		DELETE FROM ETL_Prk_Retailer
		DELETE FROM ETL_Prk_RetailerShippingAddress
		DELETE FROM ETL_Prk_RetailerRoute
		DELETE FROM ETL_Prk_RetailerValueClassMap
		INSERT INTO ETL_Prk_Retailer([Retailer Code],[Retailer Name],[Address1],[Address2],[Address3],[Pin Code],[Phone No],[EmailId],[Key Account],[Coverage Mode],[Registration Date],[Day Off],[Status],[Taxable],[Tax Type],[TIN Number],[CST Number],[Tax Group],[Credit Bills],[Credit Limit],[Credit Days],[Cash Discount Percentage],[Cash Discount Condition],[Cash Discount Limit Value],[License Number],[License Number Expiry Date],[Drug License Number],[Drug License Number Expiry Date],[Pesticide License Number],
		[Pesticide License Number Expiry Date],[Geography Hierarchy Value],[Delivery Route Code],[Village Code],[Residence Phone No],[Office Phone No],[Deposit Amount],[Potential Class Code],[Retailer Type],[Retailer Frequency],[Credit Days Alert],[Credit Bills Alert],[Credit Limit Alert]) 
		VALUES ('Dummy','Dummy','Dummy','','','0','1201301401','','NO','Order Booking',CONVERT(varchar(10),GETDATE(),121),'Sunday','Active','Yes','NON VAT','','','RTRINTRA','0','0.00','0','0.00','>=','0.00','',NULL,'',NULL,'',NULL,'','',NULL,'','','0.00',NULL,'Retailer','Weekly','None','None','None')
		UPDATE ETL_Prk_Retailer SET [Delivery Route Code]=(
		SELECT TOP 1 RMCode FROM RouteMaster WHERE RMSRouteType=2 Order by RMId DESC)
		UPDATE ETL_Prk_Retailer SET [Geography Hierarchy Value]=(
		SELECT TOP 1 GeoCode FROM Geography Order by GeoMainId DESC)
		INSERT INTO ETL_Prk_RetailerShippingAddress([Retailer Code],[Address1],[Address2],[Address3],[Retailer Shipping Pin Code],[Retailer Shipping Phone No],[Default Shipping Address])
		VALUES ('Dummy','Dummy','0','0','0','0','YES')
		
		INSERT INTO ETL_Prk_RetailerRoute([Retailer Code],[Route Code],[Selection Type])
		SELECT TOP 1 'Dummy',RMCode,'ADD' FROM RouteMaster WHERE RMSRouteType=1 
		AND RMId IN (SELECT MAX(RMID) AS RMID FROM SalesmanMarket GROUP BY SMId)
		
		INSERT INTO ETL_Prk_RetailerValueClassMap([Retailer Code],[Value Class Code],[Category Level Value],[Selection Type])
		SELECT TOP 1 'Dummy',A.ValueClassCode,B.CtgCode,'ADD' FROM RetailerValueClass A (NOLOCK)
		INNER JOIN RetailerCategory B (NOLOCK) ON A.CtgMainId=B.CtgMainId 
		INNER JOIN RetailerCategory C (NOLOCK) ON B.CtgLinkId = C.CtgMainId AND C.CtgCode ='GT' --PARLESECS/0820/085
		ORDER BY RtrClassId DESC
		EXEC Proc_ValidateRetailerMasterDummy 0--PARLECS/0221/214
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
		BEGIN
			EXEC Proc_ValidateRetailerValueClassMap 0
			EXEC Proc_ValidateRetailerRoute 0
			EXEC Proc_ValidateRetailerShippingAddress 0 
		END
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy' AND ISNULL(CmpRtrCode,'')<>'Dummy')
		BEGIN
			UPDATE Retailer SET CmpRtrCode='Dummy' WHERE RtrCode='Dummy'
			UPDATE CompanyCounters SET CurrValue = CurrValue-1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
		END  
	END
	DECLARE @Smid AS int
	DECLARE @Sql AS varchar(3000)
	DECLARE @Date AS datetime
	DECLARE @Week AS int
	DECLARE @WCal AS int
	DECLARE @StartDate AS datetime
	DECLARE @EndDate AS datetime
	SELECT @StartDate=JcmSdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @EndDate = JcmEdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @Week=jcwwk FROM JCWeek WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcwSdt AND JcwEdt
	
	SELECT @date=CONVERT(varchar(10),getdate(),121)
	DELETE FROM Export_CS2WS_Customer WHERE UploadFlag='Y'
	
	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailer' and xtype='U')
	BEGIN
		DROP TABLE TempRetailer
	END
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=6)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=6 END 
	IF @Week=2	BEGIN SET @WCal=5 END 
	IF @Week=3	BEGIN SET @WCal=4 END 
	IF @Week=4	BEGIN SET @WCal=3 END
	IF @Week=5	BEGIN SET @WCal=2 END
	IF @Week=6	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=5)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=5 END 
	IF @Week=2	BEGIN SET @WCal=4 END 
	IF @Week=3	BEGIN SET @WCal=3 END 
	IF @Week=4	BEGIN SET @WCal=2 END
	IF @Week=5	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=4)
BEGIN 
	IF @Week=1	BEGIN SET @WCal=4 END 
	IF @Week=2	BEGIN SET @WCal=3 END 
	IF @Week=3	BEGIN SET @WCal=2 END 
	IF @Week=4	BEGIN SET @WCal=1 END 
END 
SET @Sql ='SELECT distinct  DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
	RtrRemark1,RC1.CtgCode AS ChannelCode,RC.CtgCode as GroupCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,CAST('''' AS VARCHAR(100)) AS CustomerPricingKey,0 RmId,RtrCrLimit,0 AS TotalBalanceDue,
	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
	FROM Retailer R 
	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	CROSS JOIN Distributor D'
	EXEC (@Sql)
--SET @Sql ='SELECT DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
--	RtrRemark1,CtgCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,0 AS CustomerPricingKey,RM.RmId,RtrCrLimit,0 AS TotalBalanceDue,
--	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
--	FROM Retailer R 
--	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
--	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
--	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
--	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
--	INNER JOIN RetailerMarket RM ON RM.RtrId=R.RtrId
--	INNER JOIN SalesmanMarket SM ON sm.RMId=RM.RMId
--	CROSS JOIN Distributor D WHERE RtrStatus in(1) AND
--	sm.SMId in('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
--	EXEC (@Sql)
		
	SELECT DISTINCT B.ColumnName,A.ColumnValue,MasterRecordId INTO #TEMPUDCROUTE1
	FROM UdcDetails A,UdcMaster B, UdcHD C WHERE  A.UdcMasterId=B.UdcMasterId
	AND A.MasterId=B.MasterId AND ColumnName='State Name' AND MasterName='Retailer Master'
	
		
	UPDATE T SET [State]=R.ColumnValue FROM TempRetailer T INNER JOIN #TEMPUDCROUTE1 R ON T.rtrid=R.MasterRecordId 
	
	SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	
	
	CREATE TABLE #PricingKey
	(
		CustomerCode	VARCHAR(100),
		CtgCode			VARCHAR(100)
	)
	
		
	SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	GROUP BY PBL.PrdId,PBL.PrdBatId
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT R.CmpRtrCode,R.CmpRtrCode AS CmpRtrCode1 FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.RtrId<>0
	
	UPDATE A SET A.CustomerPricingKey=B.CustomerCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	
	delete from #PricingKey
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT T.CmpRtrCode,R.CtgCode
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.CtgMainId<>0
	
	UPDATE A SET A.CustomerPricingKey=B.CtgCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	WHERE ISNULL(CustomerPricingKey,'')=''
	
	INSERT INTO Export_CS2WS_Customer(TenantCode,LocationCode,CustomerCode,CustomerName,Address1,Address2,Address3,Address4,City,State,Zip,Phone,Fax,Email,ContactPerson,
	Notes,CategoryCode1,CategoryCode2,CategoryCode3,CustomerStatus,SalesMode,PaymentType,CustomerPricingKey,TotalCreditLimit,TotalBalanceDue,
	IsTaxable,TaxID,HierarchyCode,TerritoryHierarchy,SurveyKey,DateofBirth,IDNumber,TINNumber,UploadFlag)
	SELECT DISTINCT  DistributorCode,DistributorCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,'' as Address4,GeoName,State,RtrPinNo,RtrPhoneNo,'' as Fax,RtrEmailId,RtrContactPerson,
	RtrRemark1,ChannelCode,GroupCode,ValueClassCode,CustomerStatus,SalesMode,PaymentType,ISNULL(CustomerPricingKey,''),RtrCrLimit,TotalBalanceDue,IsTaxable,TaxID,GroupCode,'',SurveyKey,DateofBirth,'',RtrTinNo,
	'N' AS UploadFlag FROM TempRetailer R 
	--WHERE NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = R.CmpRtrCode AND R.CustomerPricingKey=M.Reference2 AND M.ProcessName='Customer') 
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'Customer',CustomerCode,CustomerName,GETDATE(),0,LocationCode,CustomerPricingKey,CategoryCode2,0 FROM Export_CS2WS_Customer WHERE UploadFlag='N'
	 
	
	UPDATE R SET R.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.MasterCode=R.CmpRtrCode
	WHERE ISNULL(R.WSUpload,'N')='N' AND ProcessName='Customer'
		
	SELECT	DISTINCT TenantCode,LocationCode,CustomerCode,CustomerName,Address1,Address2,Address3,Address4,City,State,	Zip,Phone,Fax,Email,ContactPerson,Notes,CategoryCode1,
	CategoryCode2,CategoryCode3,CustomerStatus,SalesMode,PaymentType,CustomerPricingKey,TotalCreditLimit,TotalBalanceDue,IsTaxable,TaxID,HierarchyCode,
	TerritoryHierarchy,SurveyKey,DateofBirth,IDNumber,TINNumber FROM Export_CS2WS_Customer WITH (NOLOCK)
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_RetailerGST' AND XTYPE ='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerGST
GO
/*
 BEGIN TRAN
 EXEC Proc_Cn2Cs_RetailerGST 0
 SELECT * FROM Cn2Cs_Prk_RetailerGST where downloadflag='D'
 Select * from UDCMASTER where Masterid=2
 SELECT  * FROM ERRORLOG
 ROLLBACK TRAN
 */
CREATE PROCEDURE Proc_Cn2Cs_RetailerGST
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerGST
* PURPOSE		: To validate the downloaded Retailer GST details from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 12/04/2017
* MODIFIED
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08-09-2020  Deepk Philip BZ    PARLECS/0920/089    To avoid Null values in UDC.
 12-02-2021	 Venkat. M	  CR	PARLECS/0221/145	Retailer UDC consider CmpRtrCode insteed of Rtrcode
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @StateCode VARCHAR(100)
	DECLARE @RtrTaxGroup VARCHAR(100)
	DECLARE @Composite VARCHAR(10)
	DECLARE @RelatedParty AS VARCHAR(10)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @GSTTIN AS VARCHAR(25)
	DECLARE @TaxGrpId AS INT
	DECLARE @StateName as VARCHAR(200)
	DECLARE @RetailerType as VARCHAR(100)
	DECLARE @GSTEnabled AS TINYINT
	DECLARE @Aadhaar AS VARCHAR(100)
	SET @GSTEnabled=0
	
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #Cn2Cs_Prk_RetailerGST
	(
		RtrCode			[Varchar](50),
		StateCode		[Varchar](20),
		RtrTaxGroup		[Varchar](75),
		Composite		[Varchar](5),
		RelatedParty	[Varchar](5),
		PanNumber		[Varchar](15),
		GSTTIN			[Varchar](25),
		RetailerType	[Varchar](25),
		DownLoadFlag	[nvarchar](100),
		Aadhaar[nvarchar](100)
	)
		
	DELETE FROM Cn2Cs_Prk_RetailerGST WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_RetailerGST (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)
	BEGIN
		SET @GSTEnabled=1
	END
	
	SELECT RtrCode,MAX(CreatedDate) as CreatedDate
	INTO #LatestMaster
	FROM Cn2Cs_Prk_RetailerGST WHERE DownLoadFlag='D'
	GROUP BY RtrCode
	--PARLECS/0920/089
	UPDATE A SET Relatedparty='NO'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE Relatedparty IS NULL OR Relatedparty=''
	UPDATE A SET Composite='NO'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE Composite IS NULL OR Composite='' AND retailertype='Registered'
	UPDATE A SET RetailerType='UNREGISTERED'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE RetailerType IS NULL OR RetailerType=''
	UPDATE A SET Composite=''  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE retailertype='Unregistered'
	
	INSERT INTO #Cn2Cs_Prk_RetailerGST(RtrCode,StateCode,RtrTaxGroup,
	Composite,RelatedParty,PanNumber,GSTTIN,RetailerType,DownLoadFlag,Aadhaar)
	SELECT DISTINCT A.RtrCode,StateCode,RtrTaxGroup,
	Composite,RelatedParty,PanNumber,GSTTIN,RetailerType,DownLoadFlag,AaadharNo
	FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) INNER JOIN #LatestMaster B ON A.RtrCode=B.RtrCode
	and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'	
			
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer GST','Retailer Code','Retailer GST Details Should not be empty' 
	FROM #Cn2Cs_Prk_RetailerGST
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	DELETE A FROM #Cn2Cs_Prk_RetailerGST A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #Cn2Cs_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  2,'RetailerGST','Retailer','Retailer GST Details Not allow more than 1-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT CmpRtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.CmpRtrCode) and DownLoadFlag='D'--PARLECS/0221/145
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'RetailerGST','RetailerCode','Retailer Code not Available-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT CmpRtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.CmpRtrCode) and DownLoadFlag='D'--PARLECS/0221/145
	IF EXISTS(SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
	WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	BEGIN
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 4,'RetailerGST','State Code','Retailer GST State Code Not available-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	END
	
	
	IF EXISTS(SELECT '*' FROM #Cn2Cs_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
				)
	BEGIN
	
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
		INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
		WHERE NOT EXISTS(
			SELECT UD.* FROM UdcHD A (NOLOCK)
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
			INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
			WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
			AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 5,'Retailer GST','StateName','Retailer State Code Not available '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	END
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','RetailerType','RetailerType Should be REGISTERED / UN REGISTERED / NOT ASSIGNED'+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composition Should be YES / No '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composition Not allow YES/NO, when Retailer Type is  Non Regesitered'+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 7,'Retailer GST','Related Party','Related Party Should be YES / No '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
		
	DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1
	
	DECLARE @RtrId AS INT
	SET @RtrId=0
	
	DECLARE Cur_RetailerGST CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM(R.RtrCode)),''),ISNULL(LTRIM(RTRIM([StateCode])),''),ISNULL(LTRIM(RTRIM([RtrTaxGroup])),''),
	ISNULL(LTRIM(RTRIM([Composite])),'NA'),ISNULL(LTRIM(RTRIM([RelatedParty])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([GSTTIN])),''),ISNULL(LTRIM(RTRIM([RetailerType])),''),R.RtrId,ISNULL(LTRIM(RTRIM([Aadhaar])),'')
	FROM #Cn2Cs_Prk_RetailerGST A
	INNER JOIN Retailer R (NOLOCK) ON A.RtrCode=R.CmpRtrCode WHERE [DownLoadFlag] ='D' AND--PARLECS/0221/145
	A.RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerGST
	FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@RtrTaxGroup,@Composite,
	@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrId,@Aadhaar
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
			SET @TaxGrpId=0			
			
			DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='RETAILER MASTER' AND [Column Code]=@RtrCode
			
			IF NOT EXISTS(SELECT * FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1)
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				SELECT DISTINCT 1,'Retailer GST','Tax Group Code','Tax Group Code Not Foud'
				SET @Po_ErrNo =1
				SET @TaxGrpId=0
			END
			ELSE
			BEGIN
				SELECT @TaxGrpId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN)					
					SET @Po_ErrNo =1
				END
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
				
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@RetailerType,''))))='REGISTERED' 
			BEGIN			
				IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
				
				IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END			
			
			SET @StateName=''
			SELECT @StateName=StateName FROM StateMaster WHERE StateCode=@StateCode
			
		

		  IF RTRIM(LTRIM(UPPER(ISNULL(@Aadhaar,''))))<>''
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@Aadhaar))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer GST','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
			 			
			IF @Po_ErrNo=0
			BEGIN		
				IF @GSTEnabled=1
				BEGIN
					IF ISNULL(@TaxGrpId,0)<>0
					BEGIN
						UPDATE A SET TaxGroupId=@TaxGrpId,LastModDate=CONVERT(VARCHAR(10),GETDATE(),121) FROM Retailer A 
						WHERE RtrCode=@RtrCode
					END
				END
				ELSE
				BEGIN
					DELETE FROM RetailerGSTTaxGroupUpdate WHERE RetailerCode=@RtrCode
					INSERT INTO RetailerGSTTaxGroupUpdate(RetailerCode,TaxGroup,UpdateDateTime,UpdateFlag)
					SELECT @RtrCode,@RtrTaxGroup,Getdate(),0
				END	
			
				INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','State Name',@RtrCode,@StateName,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','GSTIN',@RtrCode,@GSTTIN,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Composition',@RtrCode,@Composite,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Related Party',@RtrCode,@RelatedParty,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Retailer Type',@RtrCode,@RetailerType,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Aadhaar',@RtrCode,@Aadhaar,0
				
				IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Retailer Master')
				BEGIN
					EXEC Proc_Validate_CN2CS_UdcDetails 0
				END
				--Shipping Address
				EXEC Proc_UpdateRetailerShipping @RtrId,0
				
			END
			
		FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@RtrTaxGroup,@Composite,
		@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrId,@Aadhaar
	END
	CLOSE Cur_RetailerGST
	DEALLOCATE Cur_RetailerGST
	UPDATE E SET E.DownLoadFlag='Y' FROM Cn2Cs_Prk_RetailerGST E (NOLOCK) 
	WHERE EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails A  INNER JOIN Retailer B (NOLOCK) ON A.[Column Code] =B.RtrCode
	WHERE UPPER(A.MasterName)='RETAILER MASTER' AND B.CmpRtrCode =E.RtrCode)
	AND NOT EXISTS(SELECT RtrCode from #ToAvoidUDCRetailer C WHERE C.RtrCode=E.RtrCode)
		
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetTargetReach' AND TYPE='FN')
DROP FUNCTION Fn_GetTargetReach
GO
--SELECT Dbo.Fn_GetTargetReach(22,1,1,'2020-11-06',9338.47, 0 ,0)AS ValidMsg 
CREATE FUNCTION [dbo].[Fn_GetTargetReach](@Pi_Rtrid INT,@Pi_UsrId INT,@Mode INT,@Pi_BillDate DATETIME,@CurGross NUMERIC(38,6),@Pi_Salid INT,@ChkSchCP INT)
RETURNS VARCHAR(MAX)	
AS 
/**********************************************************************************  
* PROCEDURE		: Fn_GetTargetReach 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 23-10-2020
* PMS NO		: PARCS202100057		
***********************************************************************************
* 17-02-2021		MOHANA S		BZ		PARLECS/0221/217		Validation added for repeated entry
************************************************************************************/ 
BEGIN
DECLARE @Msg AS VARCHAR(MAX)	
SET @Msg = ''
DECLARE @TotGross AS NUMERIC(38,2)
DECLARE @TargetAmt AS NUMERIC(38,2)
DECLARE @CtgMainId AS INT
DECLARE @ColumnValue NVARCHAR(100)
DECLARE @GstTarget AS NUMERIC(38,2)
DECLARE @EffDate AS DATETIME
DECLARE @EffDateChk AS DATETIME
DECLARE @ChkGST	AS INT
SET @GstTarget = 0
SET @TargetAmt = 0
SET @ChkGST =1
SELECT  @EffDateChk = CONVERT(VARCHAR(10),Effectivedate,121) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
IF (@Pi_BillDate<@EffDateChk)
BEGIN
	RETURN @Msg	
END
SELECT @CtgMainId = ISNULL(D.CtgMainId,0) FROM Retailer A INNER JOIN RetailerValueClassMap B ON A.Rtrid =B.Rtrid  AND A.RtrId = @Pi_Rtrid
INNER JOIN RetailerValueClass C ON B.RtrValueClassId = C.RtrClassId
INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 
SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
AND MasterRecordid = @Pi_Rtrid  
If @Mode = 2
BEGIN
	IF EXISTS (SELECT * FROM UdcGstinUpdate_Track WHERE Rtrid = @Pi_Rtrid)
	BEGIN
		SELECT @EffDate = UpdatedDate,@ColumnValue = Gstin   FROM (	
		SELECT Min(UpdatedDate) UpdatedDate ,Gstin,Rtrid FROM UdcGstinUpdate_Track WHERE Rtrid = @Pi_Rtrid GROUP BY Gstin,Rtrid --PARLECS/0221/21
		)A
		If @Pi_BillDate >= @EffDate
		BEGIN
			SET @ChkGST = 0
		END  
		ELSE
		BEGIN
			SET @ColumnValue = ''
		END
	END
	ELSE
	BEGIN
		SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
		AND MasterRecordid = @Pi_Rtrid  
	END
END 
SELECT @TargetAmt = ISNULL(TargetAmt,0) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)
IF @ColumnValue='NULL'
BEGIN
	SET @ColumnValue ='' 
END
IF @ChkGST = 1
BEGIN
	IF EXISTS(SELECT * FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
		AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		IF (len(@ColumnValue))<>15
		BEGIN					
			SELECT @GstTarget = ISNULL(TargetAmt,0) FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)
			IF @TargetAmt<>0 AND @TargetAmt> @GstTarget
			BEGIN
				SET @TargetAmt = @GstTarget
			END
			IF @TargetAmt=0 
			BEGIN
				SET @TargetAmt = @GstTarget
			END
		
		END
	END
END
IF @Mode <> 2
BEGIN
	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate) 
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
	ELSE
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON A.CtgMainId  =@CtgMainId 
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate) 
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121)  
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON  A.CtgMainId  =@CtgMainId 
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
END
IF @Mode = 2  
BEGIN
	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
	ELSE
	BEGIN 
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON A.CtgMainId  =@CtgMainId 
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON A.CtgMainId  =@CtgMainId 
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121)
		)A 
	END
END
DECLARE @DisAmt Numeric (38,2)
	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @DisAmt= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
	ELSE
	BEGIN
		SELECT @DisAmt= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON  A.CtgMainId  =@CtgMainId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON A.CtgMainId  =@CtgMainId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
SET @DisAmt= @TargetAmt - @DisAmt 
 	SET @Msg = ''
	IF @TargetAmt =0 
	BEGIN
		SET @Msg = ''
		RETURN (@Msg)
	END
	IF @Mode =0
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)
		BEGIN 
			SET @Msg = 'Retailer sales target exceeded. Scheme/Discount Will not apply in current Bill' -- + CAST(@TargetAmt AS VARCHAR(100))
		END
	END	
	IF @Mode = 1
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)	
		BEGIN
			If @ChkSchCP = 0 
			BEGIN
			SET @Msg = 'Sales Capping exceeds in this bill. Kindly tick the checkbox to continue without schemes/discount price for this month. ' +
			CHAR(13) + 'Capping Amount : '  + CAST (@TargetAmt as varchar(100))
			+ CHAR(13) + 'Balance Amount : '  + CAST (@DisAmt as varchar(100))
			END
			If @ChkSchCP = 1 
			BEGIN
				SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
			END
		END
	END
	IF @Mode = 2
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)	
		BEGIN
			If @ChkSchCP = 0 
			BEGIN
				--SET @Msg = 'Retailer sales target exceeded. Kindly tick the checkbox to continue without schemes/discount price for this month.' +
				--CHAR(13) + 'All items in this bill need to be reentered' +CAST (@TargetAmt as varchar(100))
				SET @Msg = 'Sales Capping exceeds in this bill. Kindly tick the checkbox to continue without schemes/discount price for this month. ' +
					CHAR(13) + 'Capping Amount : '  + CAST (@TargetAmt as varchar(100))
					+ CHAR(13) + 'Balance Amount : '  + CAST (@DisAmt as varchar(100))
			END
			If @ChkSchCP = 1 
			BEGIN
				SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
			END
		END
	END
	--IF @Mode = 2
	--BEGIN
	--	IF @TargetAmt>(@TotGross+@CurGross)	
	--	BEGIN
	--		If @ChkSchCP = 1 
	--		BEGIN
	--			SET @Msg = ''
	--		END
	--		--If @ChkSchCP = 1 
	--		--BEGIN
	--		--	SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
	--		--END
	--	END
	--END
RETURN (@Msg)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_RetailerApprovalStatus' AND xtype IN('FN','TF'))
DROP FUNCTION Fn_RetailerApprovalStatus
GO
--SELECT Dbo.Fn_RetailerApprovalStatus(3)
CREATE FUNCTION Fn_RetailerApprovalStatus(@Pi_RtrId AS BIGINT)
RETURNS VARCHAR(500)
AS
BEGIN
/**********************************************************
* FUNCTION: Fn_RetailerApprovalStatus
* PURPOSE:  Return Approval Status for Retailer 
* NOTES: 
* CREATED: S.MOORTHI
* MODIFIED
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  10/05/2018   S.Moorthi     CR        CRCRSTPAR0001   Retailer Approval process - Manual
  11-02-2021	Venkat. M	 SR		   PARLECS/0221/139  Retailer Approval change.
************************************************************/
DECLARE @Approval AS VARCHAR(500)
SET @Approval = ''
 IF EXISTS (SELECT DISTINCT RtrId FROM Retailer (NOLOCK) WHERE Approved = 0 AND RtrId = @Pi_RtrId AND RtrCode <>'DUMMY')
 BEGIN
	-- SET @Approval = 'Retailer Approval is Pending,Cannot Edit this Retailer'
	 SET @Approval = 'Please do the Sync before Billing '--PARLECS/0221/139
 END
 IF EXISTS (SELECT DISTINCT A.RtrId FROM RetailerApprovalStatus A (NOLOCK) INNER JOIN Retailer B (NOLOCK) ON A.RtrId = B.RtrId
 WHERE B.Approved = 1 AND B.Upload = 'Y' AND A.RtrId = @Pi_RtrId AND B.RtrCode<>'DUMMY' )
 BEGIN
	 -- SET @Approval = 'Retailer Approval is Pending,Cannot Edit this Retailer'
	 SET @Approval = 'Please do the Sync before Billing '--PARLECS/0221/139
 END
RETURN(@Approval)
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='CN2Cs_Prk_SFAReuploadtrace' AND XTYPE='U')
CREATE TABLE CN2Cs_Prk_SFAReuploadtrace
(
	[Distcode] [varchar](20) NULL,
	[GeneratedFlag] [varchar](10) NULL,
	[DownloadFlag] [varchar](10) NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_SFAReuploadtrace_Download' AND XTYPE ='P')
DROP PROCEDURE Proc_SFAReuploadtrace_Download
GO
CREATE PROCEDURE Proc_SFAReuploadtrace_Download
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_SFAReuploadtrace_Download
* PURPOSE: To Insert and Update records
* CREATED: Venkat.M. on 18/02/2021  PMS No : CRCRSTPAR0107
*********************************/
SET NOCOUNT ON
BEGIN
	DELETE FROM CN2Cs_Prk_SFAReuploadtrace WHERE DownloadFlag ='Y'
	IF EXISTS (SELECT * FROM CN2Cs_Prk_SFAReuploadtrace (NOLOCK) WHERE GeneratedFlag ='YES' AND DownloadFlag ='D')
	BEGIN
			TRUNCATE TABLE WSMasterExportUploadTrack 
			UPDATE CN2Cs_Prk_SFAReuploadtrace SET  DownloadFlag ='Y'
	END
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ReturnTaxError' AND xtype IN('FN','TF'))
DROP FUNCTION Fn_ReturnTaxError
GO
--Select * from Fn_ReturnTaxError(272,69,1007,0,0,0,1)
CREATE FUNCTION Fn_ReturnTaxError(@TransId AS INT,@MasterId as INT, @RtrId AS INT,@Prdid AS INT,
@PrdbatId AS INT,@SpmId as INT,@RtrShipId AS INT)
RETURNS @ReturnTaxError TABLE
(
	ErrorMessage  Varchar(500)
)
AS
/*********************************
* PROCEDURE		: Fn_ReturnTaxError
* PURPOSE		: Validate the Tax in Billing
* CREATED		: 
* CREATED DATE	:
* MODIFIED
*************************************************
* DATE			 AUTHOR				 CR/BZ		USER STORY ID		DESCRIPTION					
*************************************************
  10/05/2018    S.Moorthi			 CR        CRCRSTPAR0001		Retailer Approval process - Manual
  11-02-2021	Venkat. M			 SR		   PARLECS/0221/139		Retailer Approval change msg.
*********************************/
BEGIN
	DECLARE @DistState AS Varchar(100)
	DECLARE @SupState AS Varchar(100)
	DECLARE @SupIntra AS Varchar(100)
	DECLARE @SupInter AS Varchar(100)
	DECLARE @RtrState AS Varchar(100)
	DECLARE @RtrIntra AS Varchar(100)
	DECLARE @RtrInter AS Varchar(100)
	DECLARE @Enabled AS TINYINT
	DECLARE @RtrType AS VARCHAR(50)
	SET @Enabled=0
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK)
	WHERE  ModuleId='GSTCONFIG' AND Description='GST Configuration' AND ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	--AND CONVERT(DATETIME,CONVERT(VARCHAR(10),@Date,121),121)>=ActivationDate
	)
	BEGIN
		SET @Enabled=1
	END	
	
	IF @MasterId=79 AND @TransId IN(2,25,3)--Retailer Master
	BEGIN
		---BOTH GST AND VAT TAX Validation
		IF EXISTS(Select 'X' FROM Retailer (NOLOCK) WHERE RtrId=@RtrId and TaxgroupId=0)
		BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Retailer tax group not attached for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
				RETURN
		END
		
		IF NOT EXISTS (Select 'X' FROM Retailer A (NOLOCK) INNER JOIN RetailerShipAdd B (Nolock) on A.RtrId=B.RtrId  WHERE A.RtrId=@RtrId)
		BEGIN
			INSERT INTO @ReturnTaxError(ErrorMessage)
			SELECT 'Retailer Shipping Address not available for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
			RETURN
		END 
		
		--CRCRSTPAR0001
		IF @TransId IN(2,25)
		BEGIN
			IF EXISTS(Select 'X' FROM Retailer (NOLOCK) WHERE RtrId=@RtrId and Approved=2)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Rejected Retailer, Cannot Continue Billing '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
					RETURN
			END
			
			IF Exists (SELECT * FROM Configuration where ModuleId ='RET32' AND Status=1)
			BEGIN
				DECLARE @Confic AS INT
				SELECT @Confic=ConfigValue FROM Configuration where ModuleId ='RET32' AND Status=1
				
				IF EXISTS (Select COUNT(*) from SalesInvoice (Nolock) Where RtrId =@RtrId  HAVING COUNT(*)>= @Confic)
				BEGIN 
					IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrId=@RtrId AND Approved=0)
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						--SELECT 'Get the Approval from the central system for the selected Retailer'+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
						SELECT 'Please Do the Sync for Approval Before Billing '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId --PARLECS/0221/139
						RETURN
					END
				END
			END	
			
		END
		
		IF @Enabled=1---GST Tax Validation
		BEGIN
		
			IF EXISTS(Select 'X' FROM Retailer  A(NOLOCK) 
			INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId  
			WHERE A.RtrId=@RtrId AND B.RtrShipId=@RtrShipId and B.TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Retailer Shipping Address tax group not attached for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
					RETURN
			END
			
			IF EXISTS(Select 'X' FROM Retailer  A(NOLOCK) 
			INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId  
			WHERE A.RtrId=@RtrId AND B.RtrShipId=@RtrShipId and B.RtrShipDefaultAdd=1 and A.TaxGroupId<>B.TaxGroupId)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Retailer Tax Group shuold be same for Default Shipping Address Tax Group for the retailer '+ RtrCode FROM Retailer (NOLOCK) 
					WHERE RtrId=@RtrId 
					RETURN
			END
			
			
			SELECT @RtrType=ColumnValue FROM UdcMaster U (NOLOCK) 
			INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
			INNER JOIN Retailer D (NOLOCK) ON D.RtrId=UD.MasterRecordId
			WHERE U.MasterId=2 and ColumnName='Retailer Type'   and D.RtrId=@RtrId
			IF LEN(LTRIM(RTRIM(ISNULL(@RtrType,''))))=0
			BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Please attach the Retailer Type in Retailer Master on UDC tab for the retailer code '+
				RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
				
				RETURN
	        END
		
				SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
				INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
				INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
				INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
				WHERE U.MasterId=16 and ColumnName='State Name' 
				
				IF LEN(LTRIM(RTRIM(ISNULL(@DistState,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the state in Distributor on UDC tab'
					RETURN
				END
				
				
				SELECT @RtrState=ColumnValue FROM UdcMaster U (NOLOCK) 
				INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
				INNER JOIN Retailer D (NOLOCK) ON D.RtrId=UD.MasterRecordId
				INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
				WHERE U.MasterId=2 and ColumnName='State Name'   and D.RtrId=@RtrId
				
				IF LEN(LTRIM(RTRIM(ISNULL(@RtrState,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the state in Retailer Master on UDC tab for the retailer code '+
					RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
					RETURN
				END
				
			IF @RtrShipId<>0
			BEGIN	
				----Added by Gopi at 10/07/2017
				SELECT @RtrState=StateName from StateMaster A INNER JOIN RetailerShipAdd B ON A.StateId=B.StateId
				AND B.RtrShipId=@RtrShipId and Rtrid=@Rtrid
				
				IF LEN(LTRIM(RTRIM(ISNULL(@RtrState,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the state in Retailer Shpping address for the retailer address '+
					RtrShipadd1 FROM RetailerShipAdd (NOLOCK) WHERE RtrId=@RtrId and RtrShipId=@RtrShipId
					RETURN
				END
			END	
			----Till Here ----
		
		IF @RtrShipId=0
		BEGIN
				---Distributor and Retailer in Same State
				IF UPPER(@DistState)=UPPER(@RtrState)
				BEGIN
					SELECT @RtrIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN Retailer B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE RtrId=@RtrId
					IF UPPER(@RtrIntra)<>'RTRINTRA'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach Retailer intra tax group (RTRINTRA) in Retailer Master on UDC tab'
						RETURN
					END
				END
				---Distributor and Retailer in different State
				IF UPPER(@DistState)<>UPPER(@RtrState)
				BEGIN
					SELECT @RtrInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN Retailer B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE RtrId=@RtrId
					IF UPPER(@RtrInter)<>'RTRINTER'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach Retailer Inter tax group (RTRINTER) in Retailer Master on UDC Tab'
						RETURN
					END
				END	
			END
				
				---Distributor and Retailer in Same State
				IF UPPER(@DistState)=UPPER(@RtrState)
				BEGIN
					SELECT @RtrIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN RetailerShipAdd B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE RtrId=@RtrId and B.RtrShipId=@RtrShipId
					IF UPPER(@RtrIntra)<>'RTRINTRA'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach Retailer intra tax group (RTRINTRA) in Retailer Shipping'
						RETURN
					END
				END
				---Distributor and Retailer in different State
				IF UPPER(@DistState)<>UPPER(@RtrState)
				BEGIN
					SELECT @RtrInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN RetailerShipAdd B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE RtrId=@RtrId and B.RtrShipId=@RtrShipId
					IF UPPER(@RtrInter)<>'RTRINTER'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach Retailer intra tax group (RTRINTER) in Retailer Shipping'
						RETURN
					END
				END	
				
		END			
	END	
	--Billing,Salespanel,SalesReturn,Purchase,Purchase Return
	IF @TransId IN(2,25,3,5,7,272)--Product
	BEGIN
		IF EXISTS(Select 'X' FROM Product (NOLOCK) WHERE Prdid=@Prdid and TaxgroupId=0)
		BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Product tax group not attached for the product '+ PrdCCode FROM Product (NOLOCK) WHERE Prdid=@Prdid 
				RETURN
		END
	END	
	--Billing,Salespanel,SalesReturn,Purchase,Purchase Return
	IF @TransId IN(2,25,3,5,7,272)
	BEGIN
			
		IF EXISTS(Select 'X' FROM Productbatch (NOLOCK) WHERE PrdbatId=@PrdbatId and TaxgroupId=0)
		BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Product tax group not attached for the product batch '+ PrdBatCode +Space(2)+' for the product ' +  PrdCCode
				FROM Productbatch A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdId=B.Prdid WHERE PrdbatId=@PrdbatId 
				RETURN
		END
		
		--IF @TransId IN(2,25)
		--BEGIN
		--	IF @Enabled=1
		--	BEGIN
		--		IF EXISTS(SELECT '*' FROM ProductBatch_Temp_GST(NOLOCK))
		--		BEGIN
		--			DECLARE @Count AS INT
		--			SET @Count=0
					
		--			SELECT @Count=Count(*) FROM ProductBatch_Temp_GST(NOLOCK)  WHERE DownLoadFlag='Y'
					
		--			IF ISNULL(@Count,0)=0
		--			BEGIN
		--				INSERT INTO @ReturnTaxError(ErrorMessage)
		--				SELECT 'GST Product batch downloaded pending for batch transfer,Please login and continue..'					
		--				RETURN
		--			END
		--		END
		--		ELSE
		--		BEGIN
		--			INSERT INTO @ReturnTaxError(ErrorMessage)
		--			SELECT 'GST Product batch not downloaded can not continue..'					
		--			RETURN
		--		END	
		--	END
		--END
		
	END	
	
	IF @MasterId=69 AND @TransId=272--Supplier	
	BEGIN
		IF EXISTS(Select 'X' FROM IDTMaster (NOLOCK) WHERE SpmId=@SpmId and TaxgroupId=0)
		BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'IDT Distributor tax group not attached for the Distributor Code '+SpmCode FROM IDTMaster (NOLOCK) WHERE SpmId=@SpmId
				RETURN
		END
	END
	
	IF @MasterId=69 AND @TransId IN(5,7)--Supplier		
	BEGIN
	
		IF EXISTS(Select 'X' FROM Supplier (NOLOCK) WHERE SpmId=@SpmId and TaxgroupId=0)
		BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Supplier tax group not attached for the Supplier Code '+SpmCode FROM Supplier (NOLOCK) WHERE SpmId=@SpmId
				RETURN
		END
		IF @Enabled=1---GST Tax Validation
		BEGIN
			SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
			INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
			INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
			INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
			WHERE U.MasterId=16 and ColumnName='State Name' 
			
			IF LEN(LTRIM(RTRIM(ISNULL(@DistState,''))))=0
			BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Please attach the state in Distributor on UDC tab'
				RETURN
			END
			SELECT @SupState=ColumnValue FROM UdcMaster U (NOLOCK) 
			INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
			INNER JOIN Supplier D (NOLOCK) ON D.SpmId=UD.MasterRecordId
			INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
			WHERE U.MasterId=8 and ColumnName='State Name' and SpmId=@SpmId
			
			IF LEN(LTRIM(RTRIM(ISNULL(@SupState,''))))=0
			BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Please attach the state in Supplier Master on UDC tab'
				RETURN
			END
			---Distributor and supplier in Same State
			IF UPPER(@DistState)=UPPER(@SupState)
			BEGIN
				SELECT @SupIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
				INNER JOIN Supplier B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
				WHERE SpmId=@SpmId
				IF UPPER(@SupIntra)<>'SUPINTRA'
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach supplier intra tax group (SUPINTRA) in Supplier Master'
					RETURN
				END
			END
			---Distributor and supplier in different State
			IF UPPER(@DistState)<>UPPER(@SupState)
			BEGIN
				SELECT @SupInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
				INNER JOIN Supplier B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
				WHERE SpmId=@SpmId
				IF UPPER(@SupInter)<>'SUPINTER'
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach supplier Inter tax group (SUPINTER) in Supplier Master'
					RETURN
				END
			END
		END
	END	
		
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetTargetForSalesPanel' AND TYPE='FN')
DROP FUNCTION Fn_GetTargetForSalesPanel
GO
--SELECT dbo.Fn_GetTargetForSalesPanel ('ORD2000019',2,0,3100,'2020-12-03')
CREATE FUNCTION Fn_GetTargetForSalesPanel(@Pi_Orderno NVARCHAR(100),@Pi_UsrId INT,@Mode INT,@CurGross NUMERIC(38,6),@Pi_BillDate DATETIME)
RETURNS VARCHAR(100)	
AS 
/**********************************************************************************  
* PROCEDURE		: Fn_GetTargetForSalesPanel 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 02-10-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN
DECLARE @Msg AS VARCHAR(MAX)	
SET @Msg = ''

DECLARE @TotGross AS NUMERIC(38,6)
DECLARE @TargetAmt AS NUMERIC(38,6)
DECLARE @CtgMainId AS INT
DECLARE @ColumnValue NVARCHAR(100)
DECLARE @GstTarget AS NUMERIC(38,6) 
DECLARE @EffDateChk AS DATETIME
DECLARE @RtrId AS INT

SET @GstTarget = 0

SET @TargetAmt = 0

SELECT @RtrId = RtrId FROM OrderBooking(NOLOCK) WHERE OrderNo= @Pi_Orderno

SELECT  @EffDateChk = CONVERT(VARCHAR(10),Effectivedate,121) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) 
AND ValidYear = Year(@Pi_BillDate)

IF (@Pi_BillDate<@EffDateChk)
BEGIN
	RETURN @Msg	
END

SELECT @CtgMainId = ISNULL(D.CtgMainId,0) FROM Retailer A INNER JOIN RetailerValueClassMap B ON A.Rtrid =B.Rtrid  AND A.RtrId = @RtrId
INNER JOIN RetailerValueClass C ON B.RtrValueClassId = C.RtrClassId
INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 

SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
AND MasterRecordid = @RtrId 

IF @ColumnValue='NULL'
BEGIN
	SET @ColumnValue =''
END

SELECT @TargetAmt = isnull(TargetAmt,0) FROM RetailerWiseTargetForBilling WHERE Rtrid = @RtrId AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND   Year(@Pi_BillDate)=validyear 
AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121) 

--IF Len(@ColumnValue)>0
--BEGIN
	IF (len(@ColumnValue))<>15
	BEGIN
		IF EXISTS(SELECT * FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
		BEGIN					
			SELECT @GstTarget = ISNULL(TargetAmt,0) FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)

			IF @TargetAmt<>0 AND @TargetAmt> @GstTarget
			BEGIN
				SET @TargetAmt = @GstTarget
			END

			IF @TargetAmt=0 
			BEGIN
				SET @TargetAmt = @GstTarget
			END
		END		
	END
--END

	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  )A
	END
	ELSE
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN  A INNER JOIN SalesInvoice B ON CtgMainId = @CtgMainId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@RtrId AND   ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader B ON CtgMainId = @CtgMainId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  )A
	END

	SET @Msg = ''

	IF @TargetAmt =0 
	BEGIN
		SET @Msg = ''
		RETURN @Msg
	END
  
  
	IF @TargetAmt<@TotGross+@CurGross
	BEGIN 
		SET @Msg = 'Retailer sales target exceeded. Order Not Processed  ' + @Pi_Orderno -- + CAST( @TargetAmt As varchar(100) )+ cast( @TotGross as varchar(100))
	END
  
RETURN (@Msg)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DebitNoteTopSheetClaimDt' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
GO
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_DebitNoteTopSheetClaimDt
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM DATA IN DETAIL
* DATE		:  14-11-2019
* CREATED	:  MOHANA S	
* PMS NO	:  CRCRSTPAR0079
******************************************************************************
16-01-2020	 MOHANA S		BZ	ILCRSTPAR7420		validation for Institutional
18-03-2021	 Mohana S		BZ	PARLECS/0321/221	Validation added for salesreturn
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt  WHERE UploadFlag ='Y'
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
		RETURN
	END
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @Month INT
	DECLARE @Year  INT
	DECLARE @SecSales NUMERIC(38,2)
	--SELECT TOP 1  @Month = MonthiD,@Year = ClmYear FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'
	--SELECT @FromDate= DATEADD(MONTH, (@Month)-1,DATEADD(YEAR, @Year - 1900, 0))
	--SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Month,DATEADD(YEAR, @Year - 1900, 0)))
	
	SELECT DISTINCT CirNo INTO #CirNO FROM (
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_SMInc		UNION    
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_DistInc	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Manual		UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_TOTDiff	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_InstTarget UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Sampling
	)A INNER JOIN   DebitNoteTopSheetClaimHd B ON A.DNRefId = B.DNRefId WHERE UPLOAD = 'N'
	
	SELECT DISTINCT CircularNo,ClaimType,AttrCode ,Max(CreatedDate) CreatedDate
	INTO #MaxDate
	FROM SchemeCLaimCircular WHERE CircularNo IN (SELECT CirNO FROM #CirNO)
	GROUP BY CircularNo,AttrCode,ClaimType
	
	SELECT DISTINCT ConRefNo,A.ClaimType,AttrType,A.AttrCode,A.CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular1
	FROM SchemeCLaimCircular A INNER JOIN #MaxDate B ON A.AttrCode =B.AttrCode AND A.CreatedDate =B.CreatedDate AND A.ClaimType=B.ClaimType
	AND A.CircularNo = B.CircularNo
	WHERE A.CircularNo IN (SELECT CirNO FROM #CirNO)
	
	SELECT DISTINCT ConRefNo,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular
	FROM #SchemeCLaimCircular1 
			 
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CirRefNO,CirNo,SancDate,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Sampling Claim',FromDate ,ToDate,ConRefNo,CirNo ,SancDate,SamAmt,'N',@ServerDate  from DebitNoteTopSheetClaim_Sampling A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Sampling Claim'
	-- AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,
	Wk4PriVal,SchPrimary,OrgClmAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Trade Scheme Claim',FrmDate,ToDate,SchDesc,S.CmpSchCode,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,Wk4PriVal,SchPrimary,OrgClmAmt,CalClmAmt,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN SchemeMaster S(NOLOCK) ON A.Schid =  S.Schid
	INNER JOIN SchemeCircularDetails C(NOLOCK) ON S.CmpSchCode=C.CmpSchCode  AND A.CirNo = C.CircularNo
	--AND ((SchValidFrom BETWEEN FrmDate AND ToDate) OR (SchValidTill BETWEEN FrmDate AND ToDate ))
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,Lst2MntSAl,MonTarget,CurMonth,OutletCnt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Institutional Claim',fromDate,ToDate,CtgCode,ConRefNo,CirNo,Lst2MntSAl,MonTarget ,CurMonth,OutletCnt,TotDiscount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Institutional Claim' AND AttrCode = R.CtgCode 
	--AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
	WHERE B.UPLOAD='N' AND A.SchType=0
			
	--INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,NrmlAmt,TOTAmt,ClmAmt,UploadFlag,ServerDate)
	--SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'TOT cLAIM',FromDate,TODate,CtgCode,ConRefNo,CirNo,NrmlAmt,TOTAmt,DiffAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_TOTDiff A 
	--INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)ON A.DNRefId = B.DNRefId
	--INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName 
	--INNER JOIN #SchemeCLaimCircular C (NOLOCK) ON A.CirNo=C.CircularNO AND R.CtgCode =C.AttrCode AND ClaimType ='TOT cLAIM'
	--AND ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	--WHERE B.UPLOAD='N'
			 
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,Lst2MntSAl,MonTarget,CurMonth,OutletCnt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Institutional Claim',fromDate,ToDate,CtgCode,S.CmpSchcode,CirNo,Lst2MntSAl,MonTarget ,CurMonth,OutletCnt,clmamt,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN (SELECT DISTINCT CtgMainId,DnrefId,Schid,Sum(ClmAmt) ClmAmt FROM DebitNoteTopSheetClaim_Inst_prdwise Group by  CtgMainId,DnrefId,Schid) CD ON A.DNRefId = CD.DNRefId AND CD.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName AND R.CtgMainId = CD.CtgMainId 
	INNER JOIN SchemeMaster S ON S.SchId = CD.Schid 
	INNER JOIN SchemeCircularDetails C(NOLOCK) ON A.CirNo=C.CircularNO AND S.CmpSchCode =C.CmpSchcode 
	WHERE B.UPLOAD='N' AND A.SchType=1 
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,NrmlAmt,TOTAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'TOT CLAIM',FromDate,TODate,CtgCode,ConRefNo,CirNo,NrmlAmt,TOTAmt,DiffAmt,'N',@ServerDate 
	FROM DebitNoteTopSheetClaim_TOTDiff A 	 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)ON A.DNRefId = B.DNRefId
	INNER JOIN (SELECT DISTINCT DNRefId FROM  DebitNoteTopSheetClaim_TOT_PrdWise) DD ON A.DNRefId = DD.DNRefId AND  B.DNRefId = DD.DNRefId
	--INNER JOIN RetailerValueClassMap RC ON DD.Rtrid = RC.RtrId 
	--INNER JOIN RetailerValueClass RV ON RC.RtrValueClassId = RV.RtrClassId 
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName --AND R.CtgMainId = RV.CtgMainId 
	INNER JOIN #SchemeCLaimCircular C (NOLOCK) ON A.CirNo=C.CircularNO AND R.CtgCode =C.AttrCode AND ClaimType ='TOT cLAIM'
	--AND ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	WHERE B.UPLOAD='N'
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,SecSales,LaibPer,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT  @DistCode,DNDocNo,ClmDate ,'Manual Claim',FromDate,Todate,SchDesc,''ConRefNo,CirNo,SchBudget ,SecSales ,LiabPerc,ClmAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_Manual A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,RefNo,CirRefNO,CirNo,SMCnt,TotAchSales,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Distributor Incentive Claim',IncfromDate,InctODate,RefNo,ConRefNo,CirNO,SMCnt,TotAchSales,IncAmt,'N',@ServerDate 
	FROM DebitNoteTopSheetClaim_DistInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Distributor Incentive Claim'
	INNER JOIN DistributorIncentiveMaster D(NOLOCK) ON A.RefNo = D.DistIRefno --AND IncMonth =  DateName(mm,DATEADD(mm,@Month,-1)) AND IncYear=@Year
	--AND ((IncfromDate BETWEEN @FromDate AND @ToDate) OR (IncToDate BETWEEN @FromDate AND @ToDate )) 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,RefNo,CirRefNO, CirNo,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'SalesMan Incentive Claim',RefNo,ConRefNo ,CirNO,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,A.IncAmount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_SMInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='SalesMan Incentive Claim'
	INNER JOIN SalesManincentiveDetail D(NOLOCK) ON A.RefNo = D.SMIRefno AND A.SMID =D. SMID 
	--AND INCMONTH =DateName(mm,DATEADD(mm,@Month,-1)) AND INCYEAr = @Year  
	WHERE B.UPLOAD='N'
	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET  SancDate='1900-01-01' WHERE SancDate IS NULL
	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET FromDate='1900-01-01',ToDate ='1900-01-01' WHERE FromDate IS NULL OR TODATE IS NULL
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidateStockTransfer_Download' AND XTYPE ='P')
DROP PROCEDURE Proc_ValidateStockTransfer_Download
GO
CREATE PROCEDURE Proc_ValidateStockTransfer_Download
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_ValidateStockTransfer_Download
* PURPOSE: To Insert and Update records
* CREATED: Venkat.M.P on 13/01/2021  PMS No : CRCRSTPAR0107
*********************************/
--EXCEL IMPORT STOCK MANAGEMENT TYPE ADDED BY PRAVEENRAJ B ON 31-01-2014
SET NOCOUNT ON
BEGIN
	DECLARE @ErrDesc AS VARCHAR(1000)
	DECLARE @rno AS INT
	DECLARE @TabName AS VARCHAR(50)
	DECLARE @DocRefNo As VARCHAR(100)
	DECLARE @TransType As VARCHAR(50)
	DECLARE @PrdCode As VARCHAR(50)
	DECLARE @PrdBat As VARCHAR(50)
	DECLARE @StkType AS VARCHAR(50)
	DECLARE @LocCode AS VARCHAR(50)
	DECLARE @UomCode AS VARCHAR(50)
	DECLARE @Qty AS INT
	DECLARE @Po_StkPosting INT
	DECLARE @PrdId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @PriceId AS INT
	DECLARE @LcnId AS INT
	DECLARE @UomId AS INT
	DECLARE @StkId AS INT
	DECLARE @StkTypeId AS INT
	DECLARE @StockLegdStkTypeId AS INT
	DECLARE @GetKey AS VARCHAR(20)
	DECLARE @Taction AS INT
	DECLARE @TransId AS INT
	DECLARE @SelRte AS NUMERIC(18,6)
	DECLARE @Amount AS NUMERIC(18,2)
	DECLARE @Pi_Date DATETIME
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @TypeDesc AS INT
	DECLARE @Type AS INT
	DECLARE @ChkDate AS DATETIME
	DECLARE @iCnt AS INT
	DECLARE @iOpnDebit AS NUMERIC(18,2)
	DECLARE @iOpnCredit AS NUMERIC(18,2)
	DECLARE @ErrStatus		INT
	DECLARE @iVocDate	NVARCHAR(10)
	
	DECLARE @StkMgmtTypeId INT
	
	SET @iVocDate=CONVERT(NVARCHAR(10),GETDATE(),121)
	SET @TabName = 'Cn2Cs_Prk_StockTransfer'
	UPDATE T SET QTY =(PRdBatLcnSih  - PrdBatLcnRessih ) FROM Cn2Cs_Prk_StockTransfer T INNER JOIN Product P on P.PrdCCode = T.ProductCode 
	INNER JOIN ProductBatch PB on P.PrdId = PB.PrdId AND T.BatchCode =PB.CmpBatCode 
	INNER JOIN ProductBatchLocation PBL on P.Prdid = PBL.PrdId and PB.PrdId = PBL.PrdId and PB.PrdBatId = PBL.PrdBatid
	WHERE TransType ='REDUCE' AND [TYPE] =0 and DownloadFlag ='D' AND SysStkType ='SALEABLE' AND (PRdBatLcnSih  - PrdBatLcnRessih)<Qty
	
	UPDATE T SET QTY =(PrdBatLcnUih  - PrdBatLcnResUih ) FROM Cn2Cs_Prk_StockTransfer T INNER JOIN Product P on P.PrdCCode = T.ProductCode 
	INNER JOIN ProductBatch PB on P.PrdId = PB.PrdId AND T.BatchCode =PB.CmpBatCode 
	INNER JOIN ProductBatchLocation PBL on P.Prdid = PBL.PrdId and PB.PrdId = PBL.PrdId and PB.PrdBatId = PBL.PrdBatid
	WHERE TransType ='REDUCE' AND [TYPE] =0 and DownloadFlag ='D' AND SysStkType ='UNSALEABLE' AND (PrdBatLcnUih  - PrdBatLcnResUih )<Qty
	
	UPDATE T SET QTY =(PRdBatLcnFre  - PrdBatLcnResFre ) FROM Cn2Cs_Prk_StockTransfer T INNER JOIN Product P on P.PrdCCode = T.ProductCode 
	INNER JOIN ProductBatch PB on P.PrdId = PB.PrdId AND T.BatchCode =PB.CmpBatCode 
	INNER JOIN ProductBatchLocation PBL on P.Prdid = PBL.PrdId and PB.PrdId = PBL.PrdId and PB.PrdBatId = PBL.PrdBatid
	WHERE TransType ='REDUCE' AND [TYPE] =0 and DownloadFlag ='D' AND SysStkType ='OFFER' AND (PRdBatLcnFre  - PrdBatLcnResFre )<Qty
	
	BEGIN TRY
	BEGIN TRANSACTION
	
	DECLARE Cur_StkTransHd CURSOR
	FOR SELECT DISTINCT ISNULL([Location],'') AS [Location],ISNULL([TransType],''),
		ISNULL([DocRefNo],'')AS [Reference Number],ISNULL([Type],'') AS [Type]
		FROM Cn2Cs_Prk_StockTransfer WHERE DownloadFlag='D' ORDER BY [Location]
	OPEN Cur_StkTransHd
	FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@TypeDesc
	SET @Rno = 0
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Taction = 2
		IF LTRIM(RTRIM(@LocCode))= ''
		BEGIN
			SET @ErrDesc = 'Location should not be blank'
			INSERT INTO Errorlog VALUES (1,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@TransType))= ''
		BEGIN
			SET @ErrDesc = 'Transaction Type should not be blank'
			INSERT INTO Errorlog VALUES (2,@TabName,'Transaction Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@Type))= ''
		BEGIN
			SET @ErrDesc = 'Type should not be blank'
			INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		IF @TypeDesc= '0'
			SET @Type=0
		ELSE IF @TypeDesc= '1'
			SET @Type=1
		IF LTRIM(RTRIM(@TransType)) = 'REDUCE'
			SET @TransId=1
		ELSE IF LTRIM(RTRIM(@TransType)) = 'ADD'
			SET @TransId=0
		IF NOT EXISTS(SELECT StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId)
		BEGIN
			SET @ErrDesc = 'Transaction Not Found'
			INSERT INTO Errorlog VALUES (4,@TabName,'Transaction',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @TransId=StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId
		END
		IF NOT EXISTS(SELECT LcnId FROM Location WHERE LcnCode=@LocCode)
		BEGIN
			SET @ErrDesc = 'Location Not Found'
			INSERT INTO Errorlog VALUES (5,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @LcnId=LcnId FROM Location WHERE LcnCode=@LocCode
		END
		SELECT @GetKey= dbo.Fn_GetPrimaryKeyString('StockManagement','StkMngRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
		IF @Taction = 2
		BEGIN
			INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal,Status)
			VALUES(@GetKey,convert(varchar(10),getdate(),121),@LcnId,@TransId,0,0,@DocRefNo,'',4,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),@Type,1)
			SET @sSQL ='INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal) VALUES(''' +
					CAST(@GetKey AS VARCHAR(50)) + ''',''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@LcnId AS VARCHAR(10)) + ',' +
					CAST(@TransId AS VARCHAR(10)) + ',0,0,''' + CAST(@DocRefNo AS VARCHAR(50)) + ''','''',4,1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@Type AS VARCHAR(10)) + ',1)'
			INSERT INTO Translog(strSql1) Values (@sSQL)
			UPDATE counters SET currvalue = currvalue+1  WHERE tabname = 'StockManagement' and fldname = 'StkMngRefNo'
			SET @sSQL ='UPDATE counters SET currvalue = currvalue+1  WHERE tabname = ''StockManagement'' and fldname = ''StkMngRefNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			IF @Po_ErrNo =1
				SET @Po_ErrNo =1
			ELSE
				SET @Po_ErrNo =0
		END
		DECLARE  Cur_StkTransDt CURSOR
		FOR SELECT [ProductCode],[BatchCode],[SysStkType],[Uom Code],[Qty]
		FROM Cn2Cs_Prk_StockTransfer WHERE DownloadFlag='D' AND [TransType] = @TransType AND [Location]=@LocCode AND DocRefNo =@DocRefNo 
		ORDER BY [ProductCode],[BatchCode],[Location]
		OPEN Cur_StkTransDt
		FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		WHILE @@FETCH_STATUS=0
		BEGIN
		
			IF LTRIM(RTRIM(@PrdCode))= ''
			BEGIN
				SET @ErrDesc = 'Product should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@PrdBat))= ''
			BEGIN
				SET @ErrDesc = 'Product Batch should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END			
			IF LTRIM(RTRIM(@StkType))= ''
			BEGIN
				SET @ErrDesc = 'System Stock Type should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'System Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@UomCode))= ''
			BEGIN
				SET @ErrDesc = 'Uom Code should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Uom Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))= ''
			BEGIN
				SET @ErrDesc = 'Quantity should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF ISNUMERIC(LTRIM(RTRIM(@Qty)))= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be numeric'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))<= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be greater than Zero'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @TransType='ADD'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment In'
			END
			ELSE IF @TransType='REDUCE'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment Out'
			END
			IF ISNULL(@StkMgmtTypeId,0)=0
			BEGIN
				SET @ErrDesc = 'Trans Type Should ADD/REDUCE'
				INSERT INTO Errorlog VALUES (7,@TabName,'Trans Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @StkType='Saleable'
			BEGIN
			
				SET @StkTypeId =1
				IF @TransType='ADD'
					BEGIN
						
						SET @StockLegdStkTypeId=10
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=13
					END
			END	
			ELSE IF @StkType='Unsaleable'
			BEGIN
				SET @StkTypeId =2
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=11
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=14
					END
			END
			ELSE IF @StkType='Offer'
			BEGIN
				SET @StkTypeId =3
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=12
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=15
					END
			END
			IF NOT EXISTS(SELECT PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode)))
			BEGIN
				SET @ErrDesc = 'Product:'+@PrdCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdId=PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode))
			END
			IF NOT EXISTS(SELECT PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)))
			BEGIN
				SET @ErrDesc = 'Product Batch:'+@PrdBat+' Not Found For Product:'+@PrdCode
				INSERT INTO Errorlog VALUES (8,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
				SET @PrdBatId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdBatId=PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)) AND PrdId=@PrdId
			END		
			
			SELECT @PriceId=PriceId FROM ProductBatchDetails WHERE DefaultPrice=1 AND PrdBatId=@PrdBatId AND SlNo=1
			
			
			IF NOT EXISTS(SELECT StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId)
			BEGIN
				SET @ErrDesc = 'Stock Type Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @StkId=StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId
			END	
			
			IF NOT EXISTS(SELECT UomId FROM UomMaster WHERE UomCode=@UomCode)
			BEGIN
				SET @ErrDesc = 'Uom:'+@UomCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Uom',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @UomId=UomId FROM UomMaster WHERE UomCode=@UomCode
			END
			IF @PrdId <> 0 AND @PrdBatId <> 0 AND @PriceId <> 0
			BEGIN
				SELECT @SelRte=CONVERT(NUMERIC(18,2),C.PrdBatDetailValue) FROM ProductBatch A (NOLOCK)
				INNER JOIN ProductBatchDetails C (NOLOCK)ON A.PrdBatId = C.PrdBatID AND C.PriceId=@PriceId
				INNER JOIN Product P ON A.PrdId = P.PrdId
				INNER JOIN BatchCreation D (NOLOCK)
				ON D.BatchSeqId = C.BatchSeqId AND D.SlNo = C.SlNo
				AND D.SelRte = 1 WHERE P.PrdId = @PrdId AND A.PrdBatId = @PrdBatId
				SET @Amount = (CONVERT(NUMERIC(18,2),@SelRte) * CONVERT(INT,REPLACE(@Qty,'	','')))
			END
			ELSE
			BEGIN
				SET @ErrDesc = 'Selling Rate Not Found for Product:'+@PrdCode+' for Batch:'+@PrdBat
				INSERT INTO Errorlog VALUES (8,@TabName,'Selling Rate',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			--Added By Maha on 15/06/2009
			SET @iOpnDebit=0
			SET @iOpnCredit=0
			SELECT @iCnt=Count(CoaId) FROM COAOpeningBalance Where CoaId=291
			SELECT @iOpnDebit=ISNULL(OpeningDebit,0),@iOpnCredit=ISNULL(OpeningCredit,0) FROM COAOpeningBalance Where CoaId=74
			SET @iOpnDebit=@iOpnDebit+@Amount
			SET @iOpnCredit=@iOpnCredit
			IF @Type = 1	--Opening Balance
			BEGIN
				SELECT @ChkDate=ISNULL(MIN(TransDate),GETDATE())  FROM StockLedger WITH (NOLOCK)
				IF CONVERT(NVARCHAR(10),GETDATE(),121)=CONVERT(NVARCHAR(10),@ChkDate,121)
				BEGIN			
					IF @iCnt=0
					BEGIN
						INSERT INTO CoaOpeningBalance(CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)
								VALUES(291,@iOpnDebit,@iOpnCredit,1,1,GETDATE(),1,GETDATE())
				
						SET @sSQL = 'INSERT INTO CoaOpeningBalance (CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)'
						SET @sSQL = @sSQL + ' VALUES(291,' + CAST(@iOpnDebit AS NVARCHAR(100))+ ',' + CAST(@iOpnCredit AS NVARCHAR(100))+ ',1,1,GETDATE(),1,GETDATE())'
						INSERT INTO Translog(strSql1) Values (@sSQL)		
					END
					ELSE
					BEGIN
						UPDATE CoaOpeningBalance SET OpeningDebit=@iOpnDebit WHERE CoaId=291
					
						SET @sSQL='UPDATE CoaOpeningBalance SET OpeningDebit=' + CAST(@iOpnDebit AS NVARCHAR(100)) + ' WHERE CoaId=291'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				ELSE
				BEGIN
					SET @ErrDesc = 'Transaction Exists'
					INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END	
			--Till Here
			IF @Taction =2
			BEGIN
				INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxAmt,StkMgmtTypeId)
				VALUES (@GetKey,@PrdId,@PrdBatId,@PriceId,@StkId,@UomId,@Qty,0,0,@Qty,CONVERT(NUMERIC(18,2),@SelRte),@Amount,0,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,@StkMgmtTypeId)
				
				SET @sSQL ='INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(''' +
					   CAST(@GetKey AS VARCHAR(50)) + ''',' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@PriceId AS VARCHAR(10)) + ','+
							   CAST(@StkId AS VARCHAR(10)) + ',' +CAST(@UomId AS VARCHAR(10)) + ',' + CAST(@Qty AS VARCHAR(10)) +
							   ',0,0,' + CAST(@Qty AS VARCHAR(10)) + ',' + CAST(@SelRte AS VARCHAR(24)) + ',' + CAST(@Amount AS VARCHAR(24)) + ',0,1,1,''' +
							   convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @Pi_Date = CONVERT(NVARCHAR(10),GETDATE(),121)
				Exec Proc_UpdateStockLedger @StockLegdStkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				SET @sSQL ='Exec Proc_UpdateStockLedger ' + CAST(@StockLegdStkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
						CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
				INSERT INTO Translog(strSql1) Values (@sSQL)
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Stock Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Stock Posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
					-- CLOSE Cur_StkTransDt
					--DEALLOCATE Cur_StkTransDt
					--CLOSE Cur_StkTransHd
					--DEALLOCATE Cur_StkTransHd
					ROLLBACK TRANSACTION
					
				END
				IF @TransType='ADD'
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,2,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',2,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				--Voucher Posting	Added By Maha on 15-03-2009
				IF @Type=0
				BEGIN
					IF @TransType='ADD'
					BEGIN
						EXEC Proc_VoucherPosting 13,1,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,1,'''+ CAST(@GetKey AS VARCHAR(10))+ ''' ,5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @TransType='REDUCE'
					BEGIN
						EXEC Proc_VoucherPosting 13,0,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,0,'''+ CAST(@GetKey AS VARCHAR(10)) + ',5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				IF @ErrStatus < 0
				BEGIN
					 SET @ErrDesc = 'Voucher Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Voucher posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
					-- CLOSE Cur_StkTransDt
					--DEALLOCATE Cur_StkTransDt
					--CLOSE Cur_StkTransHd
					--DEALLOCATE Cur_StkTransHd
					ROLLBACK TRANSACTION
					RETURN
				END
				IF @Po_ErrNo =1
				BEGIN
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SET @Po_ErrNo =0
				END
				--Till Here
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Product batch location posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Product batch location posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
					-- CLOSE Cur_StkTransDt
					--DEALLOCATE Cur_StkTransDt
					--CLOSE Cur_StkTransHd
					--DEALLOCATE Cur_StkTransHd
					ROLLBACK TRANSACTION
					RETURN
				END
				
				IF @Po_ErrNo =1
					SET @Po_ErrNo =1
				ELSE
					SET @Po_ErrNo =0
				END
				SET @PrdId = 0
				SET @PrdBatId = 0
			FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		END
		
		CLOSE Cur_StkTransDt
		DEALLOCATE Cur_StkTransDt
		SET @GetKey=''
		FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@Type
		
	END
	CLOSE Cur_StkTransHd
	DEALLOCATE Cur_StkTransHd
	COMMIT TRANSACTION
	RETURN
END TRY
BEGIN CATCH

		SET @Po_ErrNo=1	
		CLOSE Cur_StkTransDt
		DEALLOCATE Cur_StkTransDt
															
		CLOSE Cur_StkTransHd
		DEALLOCATE Cur_StkTransHd
		
		RETURN
END CATCH

	UPDATE A SET DownloadFlag='Y' FROM Cn2Cs_Prk_StockTransfer  A INNER JOIN StockManagement B WITH (NOLOCK)ON A.DocRefNo =B.DocRefNo WHERE A.DocRefNo =@DocRefNo
END
GO
IF EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_Export_CS2WS_RouteSetupV1' AND TYPE='P')
DROP PROC Proc_Export_CS2WS_RouteSetupV1
GO
CREATE PROCEDURE Proc_Export_CS2WS_RouteSetupV1
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_RouteSetupV1
* PURPOSE		: To Export RouteSetupV1 details to the PDA Intermediate Database
* CREATED		: S.Moorthi
* CREATED DATE	: 16/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  04/08/2018   S.Moorthi    CR         CRCRSTPAR0017   SFA-Upload-Download Integration --Product
  12/02/2018   Gayathri.S	BZ		   ILCRSTPAR3422   To consider Distcode+Salesmancode value if Deviceserialnumber is not available.	
  27-04-2021   Deepak Philip BZ      PARLECS/0421/313      BZ     To upload all salesman.	
********************************************************************************************/
BEGIN
	SELECT pListId Slno,pListValue Smid INTO #SMLIST1 from DBo.fn_getList(@SalRpCode)
	DECLARE @DistCode AS varchar(200)
	DELETE FROM Export_CS2WS_RouteSetupV1 WHERE UploadFlag='Y'
	SELECT @DistCode=DistributorCode FROM Distributor (NOLOCK)
	
	INSERT INTO Export_CS2WS_RouteSetupV1(TenantCode,LocationCode,RouteCode,RouteName,
	VehicleCode,HHTDeviceSerialNumber,SalesmanCode,IsActive,WarehouseCode,JourneyPlanCode,
	AuthorizedItemCode,RouteType,DefaultCashCustomer,UploadFlag)
	SELECT @DistCode,@DistCode,SMCode,SMName,SMCode VehicleCode,
	HHTDeviceSerialNumber HHTDeviceSerialNumber,SMCode,A.[Status],'MG',SMCode,@DistCode,4,'Dummy','N' 
	FROM SalesMan A (NOLOCK)
	--INNER JOIN #SMLIST1 B ON A.SMId=B.Smid  
	WHERE NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = A.SMCode AND Reference1=A.HHTDeviceSerialNumber
	AND A.Status=M.Status AND M.ProcessName='RouteDivisionsList') 
	--INNER JOIN SalesmanMarket B (NOLOCK) ON A.SMId=B.SMId 
	--INNER JOIN RouteMaster RM (NOLOCK) ON RM.RMId=B.RMId
	
	DELETE A FROM WSMasterExportUploadTrack A WHERE EXISTS(SELECT * FROM Export_CS2WS_RouteSetupV1 M 
	WHERE A.MasterCode = M.SalesmanCode and M.UploadFlag='N') AND A.ProcessName='RouteDivisionsList'
	EXEC Proc_Export_CS2WS_RouteDivisionsList @SalRpCode
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'RouteDivisionsList',RouteCode,LocationCode,GETDATE(),A.IsActive,HHTDeviceSerialNumber,'','',0 FROM Export_CS2WS_RouteSetupV1 A 
	WHERE UploadFlag='N'  
	
	/* Commented and Added for ILCRSTPAR3422 */
	--UPDATE Export_CS2WS_RouteSetupV1 SET HHTDeviceSerialNumber='12345' WHERE ISNULL(HHTDeviceSerialNumber,'')=''
	UPDATE Export_CS2WS_RouteSetupV1 SET HHTDeviceSerialNumber= REPLACE(TenantCode + SalesmanCode,'-','') WHERE ISNULL(HHTDeviceSerialNumber,'')=''
	/* Till Here for ILCRSTPAR3422 */
	SELECT DISTINCT TenantCode,
		LocationCode,
		RouteCode,
		RouteName,
		VehicleCode,
		HHTDeviceSerialNumber,
		SalesmanCode,
		IsActive,
		WarehouseCode,
		JourneyPlanCode,
		AuthorizedItemCode,
		RouteType,
		DefaultCashCustomer
		FROM Export_CS2WS_RouteSetupV1 (NOLOCK)
		
	SELECT DISTINCT TenantCode,
		LocationCode,
		RouteCode,
		Divisioncode
		FROM Export_CS2WS_RouteDivisionsList (NOLOCK)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DebitNoteTopSheetClaimHd' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimHd
GO
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimHd
(
	@Po_ErrNo   INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE   :  Proc_Cs2Cn_DebitNoteTopSheetClaimHd
* PURPOSE         :  TO UPLOAD SAVED CLAIM DETAILS IN HEADER WISE
* DATE                  :  18-11-2019
* CREATED          :  MOHANA S
* PMS NO           :  CRCRSTPAR0079
*****************************************************************************
16-01-2020	 MOHANA S		BZ	ILCRSTPAR7420		validation for uploaded data
05-05-2020	 MOHANA S		BZ	--				    Validation Removed to upload 
*******************************************************************************/
SET NOCOUNT ON
	BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode      AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd WHERE UploadFlag ='Y'
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt WHERE UploadFlag ='Y'
	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise WHERE UploadFlag ='Y'
	 
	EXEC Proc_Cs2Cn_CostCenterNotAvailable 0,@sERVERdATE
	 
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
	  RETURN
	END
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimHd(DistCode,DNDocRefNo,DNDate,ClmYear,ClmMonth,SampAmt,TradeSchAmt,InstTarAmt,
													TOTDiffAmt,ManualClmAmt,DistIncAmt,SMIncAmt,TotalAmt,UploadFlag,ServerDate )
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate,ClmYear ,ClmMonth,SampAmt,TradeSchAmt,InstTarAmt,TOTDiffAmt,ManualClmAmt,DistIncAmt,
	SMIncAmt,TotalAmt,'N',@ServerDate FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'     
	          
			
	EXEC Proc_Cs2Cn_DebitNoteTopSheetClaimDt  @Po_ErrNo,@ServerDate
			
	EXEC Proc_Cs2Cn_DNTSClaimBrandWise @Po_ErrNo,@ServerDate 
	UPDATE  DebitNoteTopSheetClaimHd SET UPload ='Y',DNStatus = 1 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
	AND UPload = 'N'
		   
	--SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt
	--INTO #Header
	--FROM (
	--SELECT DNDocRefNO,'Sampling Claim' ClmType,SampAmt ClmAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd  UNION
	--SELECT DNDocRefNO,'Trade Scheme Claim',TradeSchAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd UNION                
	--SELECT DNDocRefNO,'TOT CLAIM',TOTDiffAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd UNION
	--SELECT DNDocRefNO,'Manual Claim',ManualClmAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd     UNION
	--SELECT DNDocRefNO,'Distributor Incentive Claim',DistIncAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd    UNION
	--SELECT DNDocRefNO,'SalesMan Incentive Claim',SMIncAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd )A
	--GROUP BY DNDocRefNO
	--SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt INTO #SUMMARY   FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt
	--WHERE ClmType <> 'Institutional Claim'  GROUP BY  DNDocRefNO
		    
			 
	--SELECT A.DNDocRefNO,SUM(ISNULL(A.CLMAMT-C.clmamt,0)) CLMAMT INTO #CALCULATED  FROM #SUMMARY A             
	--INNER JOIN #Header C ON A.DNDocRefNO = C.DNDocRefNO                       
	--GROUP BY A.DNDocRefNO 
	--SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt INTO #CHECK FROM #CALCULATED GROUP BY DNDocRefNO   
			
	--IF NOT EXISTS (SELECT * FROM Cs2Cn_Prk_DNTSClaimBrandWise)
	--BEGIN
	--	INSERT INTO DebitNoteClaimMisMatch
	--	SELECT DNDocRefNO,0,0,GETDATE() FROM #CHECK
				 
	--	UPDATE DebitNoteTopSheetClaimHd SET UPload ='N',DNStatus = 0 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
	--	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd
	--	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt
	--	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise
	--END       
	--IF EXISTS (SELECT * FROM #CHECK WHERE CLMAMT  BETWEEN -5 AND 5)
	--BEGIN
	--	UPDATE  DebitNoteTopSheetClaimHd SET UPload ='Y',DNStatus = 1 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
	--	AND UPload = 'N'
	--END
	--ELSE
	--BEGIN
	--	INSERT INTO DebitNoteClaimMisMatch
	--	SELECT DNDocRefNO,CLMaMT,0,GETDATE() FROM #CHECK WHERE CLMAMT NOT BETWEEN -5 AND 5
					
	--	UPDATE DebitNoteTopSheetClaimHd SET UPload ='N',DNStatus = 0 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
						
	--	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd
	--	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt
	--	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise
	--END
			
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cn2Cs_Prk_TargetSettingsCorrection' AND XTYPE ='U')
BEGIN
Create Table Cn2Cs_Prk_TargetSettingsCorrection
(
       Distcode Varchar(50),
       ProgramCode Varchar(50),
       CmpRtrCode varchar(50),
       ChannelCode Varchar(50),
       RtrGroup Varchar(100),
       DownloadFlag Varchar(2),
       CreatedDate DateTime
)
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='InsTargetDetails_B4Correction' AND TYPE='U')
BEGIN
	SELECT * INTO InsTargetDetails_B4Correction FROM InsTargetDetails WHERE 1=2
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_TargetSettingsCorrection' AND TYPE='P')
DROP PROCEDURE  Proc_Cn2Cs_TargetSettingsCorrection
GO
/* 
BEGIN TRAN
DELETE FROM ERRORLOG  
select * from InsTargetDetails where InsId >= 15 and RtrCtgMainId <>19
select * from InsTargetDetails where InsId >= 15 and RtrCtgMainId =19
EXEC Proc_Cn2Cs_TargetSettingsCorrection 0  
select * from InsTargetDetails where InsId >= 15 and RtrCtgMainId <>19
select * from InsTargetDetails_B4Correction where InsId >= 15 
ROLLBACK TRAN
 */
CREATE  PROCEDURE  Proc_Cn2Cs_TargetSettingsCorrection 
(
	@Po_ErrNo INT OUTPUT
)
AS
/*******************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_TargetSettingsCorrection
* PURPOSE		: To validate the Provision Approval
* CREATED BY	: Mohana S 
* CREATED DATE	: 12-04-2021
* USER STORY ID : CRCRSTLOR0213
*******************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  

	DELETE FROM Cn2Cs_Prk_TargetSettingsCorrection WHERE DownloadFlag ='Y'

	INSERT INTO InsTargetDetails_B4Correction
	SELECT A.* FROM InsTargetDetails A INNER JOIN InsTargetHD B ON A.InsId = B.Insid
	AND INSREFNO in (SELECT DISTINCT ProgramCode from Cn2Cs_Prk_TargetSettingsCorrection WHERE DownloadFlag ='D')
 
	SELECT Distinct B.Insid,B.Rtrid,R.CtgMainId,B.RtrCtgMainId
	INTO #Retailer 
	FROM RETAILER A 
	INNER JOIN InsTargetDetails B ON A.RtrId = B.RtrId 
	INNER JOIN InsTargetHD I ON i.InsId = B.InsId 
	INNER JOIN Cn2Cs_Prk_TargetSettingsCorrection C ON C.CmpRtrCode = A.CmpRtrCode AND C.ProgramCode = I.InsRefNo 
	INNER JOIN RetailerCategory R ON R.CtgCode = C.RtrGroup  AND R.CtgMainId <> B.RtrCtgMainId
	INNER JOIN RetailerCategory R1 ON R1.CtgMainId = R.CtgLinkId AND R1.CtgCode = C.ChannelCode 
	AND DownloadFlag ='D'

	UPDATE A SET A.RtrCtgMainId = B.CtgMainId  FROM InsTargetDetails A INNER JOIN #Retailer B ON A.InsId = B.InsId AND A.rtrid = B.Rtrid 

	UPDATE C SET DownloadFlag ='Y' FROM RETAILER A 
	INNER JOIN InsTargetDetails B ON A.RtrId = B.RtrId 
	INNER JOIN InsTargetHD I ON i.InsId = B.InsId 
	INNER JOIN Cn2Cs_Prk_TargetSettingsCorrection C ON C.CmpRtrCode = A.CmpRtrCode AND C.ProgramCode = I.InsRefNo 
	INNER JOIN RetailerCategory R ON R.CtgCode = C.RtrGroup AND R.CtgMainId = B.RtrCtgMainId

	
RETURN
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='MasterInactiveDetails')
BEGIN
CREATE TABLE [dbo].[MasterInactiveDetails](
	[MasterType] [int] NULL,
	[MasterId] [int] NULL,
	[MasterCode] [varchar](100) NULL,
	[InactiveDate] [datetime] NULL
) ON [PRIMARY]
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_UserValidation')
DROP PROCEDURE Proc_UserValidation
GO
--EXEC Proc_UserValidation 2,'C','D',1,''
CREATE PROCEDURE Proc_UserValidation
(	
	@Pi_UserId AS INT,
	@Pi_HostName AS Varchar(100),
	@Pi_DatabaseName AS Varchar(100),
	@Pi_UserStatus AS TinyInt OUTPUT,
	@Pi_Msg AS Varchar(300) OUTPUT
)
AS
/************************************************************************************************************************************
* PROCEDURE	: Proc_UserValidation
* PURPOSE	: To Validate Users
* CREATED	: Murugan.R
* CREATED DATE	: 2013/01/23
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------------------------------------------------------------------------------------------
* {date}		{developer}	    USERSTORYID		{brief modification description}    
* 17-12-2019	Mohana S		CRCRSTPAR0079	Remove MultiUser Data If Improper ShutDown happened
*******************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @Pi_HostNameLocked as Varchar(100)
	DECLARE @Pi_UserName as Varchar(100)
	DECLARE @Pi_Error TINYINT
	DECLARE @Pi_ErrorMsg TINYINT
	SET @Pi_Error =0
	SET @Pi_UserStatus=0
	SET @Pi_ErrorMsg=0

		
		DECLARE @SMstDate AS DATETIME
		DECLARE @LedgMinDate AS DATETIME
		IF EXISTS (SELECT  TOP 1 * FROM StockLedger (NOLOCK))
		BEGIN
			SET @SMstDate=CONVERT(VARCHAR(10),GETDATE(),121)
			SELECT @LedgMinDate=CONVERT(VARCHAR(10),MIN(TransDate),121) FROM StockLedger (NOLOCK)

			IF DATEDIFF(D,@LedgMinDate,@SMstDate)>90
			BEGIN
				SET @SMstDate=CONVERT(VARCHAR(10),GETDATE(),121)
				EXEC Proc_UpdateStatusRteSalRetailer @SMstDate
			END
		END

		BEGIN TRAN
		
		UPDATE Users Set LoggedStatus=1 where UserId=@Pi_UserId
		IF NOT EXISTS(Select UserId FROM Users (NOLOCK) WHERE UserId=@Pi_UserId and HostName NOT IN(@Pi_HostName,'') and LoggedStatus=1)
		BEGIN
			Update Users Set HostName=@Pi_HostName where UserId=@Pi_UserId
			Update Users Set HostName='' where UserId NOT IN(@Pi_UserId) and HostName=@Pi_HostName
			DELETE FROM MultiUserTransValidation WHERE TransId = 504 --CRCRSTPAR0079
			SET @Pi_Error=0
		END
		ELSE
		BEGIN
			IF EXISTS(
					SELECT Distinct A.HostName FROM Master..Sysprocesses A 
					INNER JOIN sys.dm_Exec_Sessions B ON A.Spid=B.session_id
					INNER JOIN master..SysDatabases C ON A.dbid=C.dbid
					WHERE C.Name collate SQL_Latin1_General_CP1_CI_AS =@Pi_DatabaseName AND LTRIM(RTRIM(A.HostName)) collate SQL_Latin1_General_CP1_CI_AS
					IN(SELECT hostname FROM Users (NOLOCK) WHERE UserId=@Pi_UserId) and A.PROGRAM_NAME IN('Core Stocky','Visual Basic')
					and A.Spid>50 And B.Client_Interface_Name='OLEDB'
					)
			BEGIN
				SELECT @Pi_HostName=HostName,@Pi_UserName=UserName FROM Users (NOLOCK) WHERE UserId=@Pi_UserId
				SET @Pi_Error=1	
			END
			ELSE
			BEGIN
				Update Users Set HostName=@Pi_HostName where UserId=@Pi_UserId
				Update Users Set HostName='' where UserId NOT IN(@Pi_UserId) and HostName=@Pi_HostName
				DELETE FROM MultiUserTransValidation WHERE TransId = 504 --CRCRSTPAR0079
				SET @Pi_Error=0
			END
			
		END
		---Version Control Process
		IF @Pi_Error=0
		BEGIN
			IF NOT EXISTS(SELECT HostName FROM Tbl_ExeVersionControl (NOLOCK) WHERE HostName =@Pi_HostName
						  AND LTRIM(RTRIM(VersionId)) IN(SELECT LTRIM(RTRIM(VersionId)) FROM UtilityProcess (NOLOCK)
											WHERE ProcId=1))
			BEGIN
				SET @Pi_Error=1
				SET @Pi_ErrorMsg=1
			END											
											
		END	
		--Till Here
		IF @Pi_Error=1 
		BEGIN
			IF @Pi_ErrorMsg=0 
			BEGIN
				SET @Pi_Msg='The User '+ UPPER(@Pi_UserName) +' already locked in the machine '+ @Pi_HostName
			END
			ELSE
			BEGIN
				SET @Pi_Msg='Core Stocky application Version mismatch, Please contact Support center for assistance'
			END		
			ROLLBACK TRAN
			SET @Pi_UserStatus=1
		END
		ELSE
		BEGIN
			SELECT 'User logged In' 
			COMMIT TRAN
			SET @Pi_UserStatus=0
			SET @Pi_Msg=''
		END		
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Export_CS2WS_PricingPlan' AND TYPE='P')
DROP PROC Proc_Export_CS2WS_PricingPlan
GO
--EXEC Proc_Export_CS2WS_PricingPlan '1'
CREATE PROCEDURE Proc_Export_CS2WS_PricingPlan
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_PricingPlan
* PURPOSE		: To Export Product Price details to the PDA Intermediate Database
* CREATED		: S.Moorthi
* CREATED DATE	: 07/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
* 04/08/2018   S.Moorthi    CR         CRCRSTPAR0017   SFA-Upload-Download Integration --Product
* 29/11/2018   S.Moorthi    SR         ILCRSTPAR2692   0 price moved to SFA Application from Sehyog .
* 06-01-2020   S.Mohana		SR		   ILCRSTPAR7270   Date not considered in upload (As per Discussion With Awinash & Nilesh)
* 27-05-2021   Deepak Philip SR        PARLECS/0521/182   Pring plan functionality changed as per billing.
********************************************************************************************/
BEGIN
DECLARE @DistCode NVARCHAR(40)
DECLARE @Prdid AS int
DECLARE @Prdbatid AS int
	
	DELETE FROM Export_CS2WS_PricingPlan 
	
	SELECT @DistCode = DistributorCode FROM Distributor

	EXEC PROC_ReturnSplDiscountForSFA
	
	--CREATE TABLE #Export_CS2WS_PricingPlan
	--(
	--	PrdID				[Bigint],
	--	TenantCode   [nvarchar](25) COLLATE DATABASE_DEFAULT,  
	--	PricingCode   [nvarchar](25)COLLATE DATABASE_DEFAULT,  
	--	PricingDescription [nvarchar](25)COLLATE DATABASE_DEFAULT,  
	--	StartDate   [Datetime],  
	--	EndDate    [Datetime],  
	--	ItemCode   [nvarchar](100)COLLATE DATABASE_DEFAULT,  
	--	UnitsOfMeasure  [nvarchar](20)COLLATE DATABASE_DEFAULT,   
	--	DebitPrice   [Float],  
	--	CreditPrice			[Float],
	--	DamagePrice			[Float],
	--	PriceId				[BIGINT]
	--)
	
	--SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	--RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	--INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	--INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	--INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	--INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	--SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	--INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	--INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	--WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	--GROUP BY PBL.PrdId,PBL.PrdBatId
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,R.CmpRtrCode,R.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(B.PriceId) as PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId 
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.RtrId<>0
	--GROUP BY P.PrdId,R.CmpRtrCode,R.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	--SELECT DISTINCT PricingCode into #PricingCode from #Export_CS2WS_PricingPlan
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,T.CmpRtrCode,T.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(b.PriceId) as PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	--inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	--inner join #PricingCode E (NOLOCK) ON E.PricingCode=T.CmpRtrCode	
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.CtgMainId<>0 AND 
	--NOT EXISTS(SELECT * FROM #Export_CS2WS_PricingPlan EB INNER JOIN Product P (nolock) ON P.PrdCCode=EB.ItemCode 
	--WHERE EB.PricingCode=T.CmpRtrCode AND EB.Prdid=P.PrdId AND EB.Prdid=FP.PrdId AND EB.Prdid=B.PrdId 
	--AND EB.PricingCode=E.PricingCode)
	--GROUP BY P.PrdId,T.CmpRtrCode,T.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,R.CtgCode,R.CtgCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(PriceId) As PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId   AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.CtgMainId<>0 --and PrdCCode ='100301301041444012144PKT005N' and CtgCode  ='IRCTC WZ'
	--GROUP BY P.PrdId,R.CtgCode,R.CtgCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	
	
	----SELECT A.PrdID,Max(PB.PrdBatId) AS PrdBatId	INTO #TempProductBatch FROM #Export_CS2WS_PricingPlan A 
	----INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdID=PB.PRDID
	----WHERE  PrdBatCode <> 'Sample Batch' GROUP BY A.PrdID
	----SELECT DISTINCT P.PrdID,PB.PrdBatId,B1.PrdBatDetailValue as SellRate 
	----INTO #TempPriceDt
	----FROM Product P (NOLOCK)
	----INNER JOIN ProductBatch PB(NOLOCK) ON P.PrdID = PB.PrdID	
	----INNER JOIN #TempProductBatch PB1(NOLOCK) ON P.PrdID = PB1.PrdID AND PB.PrdBatId=PB1.PrdBatId AND PB.PrdID = PB1.PrdID
	----INNER JOIN ProductBatchDetails B1 (NOLOCK) ON PB.PrdBatId = B1.PrdBatID AND B1.DefaultPrice=1
	----INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = PB.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	----ORDER BY P.PrdId
	
	
	--UPDATE PP SET PP.DebitPrice=B1.PrdBatDetailValue,PP.CreditPrice=B1.PrdBatDetailValue,PP.DamagePrice=B1.PrdBatDetailValue
	--FROM Product P (NOLOCK)
	--INNER JOIN #Export_CS2WS_PricingPlan PP ON P.PrdId=PP.PrdID 
	--INNER JOIN ProductBatchDetails B1 (NOLOCK) ON B1.PriceId=PP.PriceId
	--INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = B1.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	
	----As discussed Mr. Awanish to remove duplicate based on Max start date
	--SELECT PricingCode,ItemCode INTO #TempDuplicate FROM #Export_CS2WS_PricingPlan 
	--GROUP BY PricingCode,ItemCode HAVING COUNT(ItemCode)>1
	--SELECT A.PricingCode,A.ItemCode,MAX(A.StartDate) AS StartDate INTO #TempMaxStartDate FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN #TempDuplicate B ON A.PricingCode=B.PricingCode AND A.ItemCode=B.ItemCode 
	--GROUP BY A.PricingCode,A.ItemCode
	
	--DELETE A FROM #Export_CS2WS_PricingPlan A (NOLOCK)
	--INNER JOIN #TempMaxStartDate B ON A.ItemCode=B.ItemCode AND A.PricingCode=B.PricingCode 
	--WHERE NOT EXISTS(SELECT * FROM #TempMaxStartDate M WHERE M.PricingCode=A.PricingCode AND M.ItemCode=A.ItemCode AND 
	--M.StartDate=A.StartDate)
		
	--UPDATE A SET A.DebitPrice=B.SellRate,A.CreditPrice=B.SellRate,A.DamagePrice=B.SellRate 
	--FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN #TempPriceDt B ON A.PrdID=B.PrdId and A.PricingCode=
	
	--INSERT INTO Export_CS2WS_PricingPlan(TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,UploadFlag)
	--SELECT DISTINCT TenantCode,PricingCode,PricingDescription,''StartDate,''EndDate,ItemCode,UnitsOfMeasure, --ILCRSTPAR7270
	--DebitPrice,CreditPrice,DamagePrice,'N' UploadFlag FROM #Export_CS2WS_PricingPlan ORDER BY ItemCode
	

	--SELECT  Distinct
	--		TenantCode,
	--		PricingCode,
	--		PricingDescription,
	--		--CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
	--		--CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
	--		ItemCode,
	--		UnitsOfMeasure,
	--		DebitPrice,
	--		CreditPrice,
	--		DamagePrice
	--	FROM Export_CS2WS_PricingPlan WITH (NOLOCK)
	
	
	INSERT INTO Export_CS2WS_PricingPlan(TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,UploadFlag)
	SELECT @DistCode,RTRCODE,RTRCODE,''StartDate,''EndDate,Prdccode,UomCode,MRP,MRP,Sellrate,'N' UploadFlag FROM SFACONTRACTDETAILSFINAL  ORDER BY Prdccode 
	
	--SELECT @DistCode,RTRCODE,RTRCODE,''StartDate,''EndDate,Prdccode,UomCode,MRP,MRP,Sellrate,'N' UploadFlag FROM SFACONTRACTDETAILSFINAL  ORDER BY Prdccode 

	SELECT  Distinct
			TenantCode,
			PricingCode,
			PricingDescription,
			--CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
			--CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
			ItemCode,
			UnitsOfMeasure,
			DebitPrice,
			CreditPrice,
			DamagePrice
		FROM Export_CS2WS_PricingPlan WITH (NOLOCK)
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_RetailerMasterUpdate' AND XTYPE ='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
GO
CREATE PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMasterUpdate
* PURPOSE		: To Validate Retailer Master data update from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 25/06/2019
* MODIFIED
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON	  | USER STORY ID  |  CR/BZ |   REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  441		 25/06/2019	    S.Moorthi		CRCRSTPAR0069	 CR		   Need to block the edit option in Sehyog and the group, channel and status should be allowed to edit in console end and this will download and update in 
																		Sehyog end. Excel upload facility require in Console    
  443		 12-09-2020     Deepak Philip   PARLECS/0920/138 BZ        To avaoid duplicate Retailer Master Download.
  445		 22-01-2021		Venkat. M		CRCRSTPAR0107	 CR			SalesRoute, DlvRoute column add	
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	CREATE TABLE #ToAvoidRetailer
	(
		RtrCode [nvarchar](50)
	)
	CREATE TABLE #Cn2CS_Prk_RetailerMasterUpdate(
	[RtrCode]			[nvarchar](50),
	[RetailerName]		[nvarchar](100),
	[RetailerChannal]	[nvarchar](50),
	[RetailerGroup]		[nvarchar](50),
	[RetailerClass]		[nvarchar](50),
	[RetailerStatus]	[nvarchar](50),
	[SalesRoute]		[nvarchar](50),
	[DeliveryRoute]		[nvarchar](50)
	)
	
	--PARLECS/0920/138
	SELECT DISTINCT * INTO #RetailerUpdate FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK)
	DELETE A FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK)
	INSERT INTO Cn2CS_Prk_RetailerMasterUpdate
	SELECT * FROM #RetailerUpdate
	
	DELETE FROM Cn2CS_Prk_RetailerMasterUpdate WHERE DownLoadFlag='Y'
	SELECT RtrCode,MAX(CreatedDate) as CreatedDate
	INTO #PrgMaxDate
	FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK) 
	WHERE DownLoadFlag='D' GROUP BY RtrCode
	
	INSERT INTO #Cn2CS_Prk_RetailerMasterUpdate
	([RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus],[SalesRoute] ,[DeliveryRoute] )
	SELECT DISTINCT A.[RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus],[SalesRoute] ,[DeliveryRoute] 
	FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK) 
	INNER JOIN #PrgMaxDate B ON A.RtrCode=B.RtrCode and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status shoud be Active/InActive '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
		
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Code Not Available '+ M.RtrCode 
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')='' OR ISNULL([SalesRoute] ,'')=''OR ISNULL([DeliveryRoute] ,'')='')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status/Name/Channel/Group/Class/Route can not be blank '+ RtrCode
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')=''OR ISNULL([SalesRoute] ,'')=''OR ISNULL([DeliveryRoute] ,'')='')
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Channel/Group/Value Class details not available '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode)
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster A(NOLOCK) WHERE A.RMCode=M.SalesRoute AND RMSRouteType =1 )
	UNION	
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster A(NOLOCK) WHERE A.RmCode=M.DeliveryRoute AND RMSRouteType =2 )
	
	INSERT INTO RetailerMasterUpdateTrack(RtrCode,RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,OldRetailerName,OldRetailerGroup,OldRetailerClass,OldRetailerStatus,CreatedDate)	
	SELECT B.RtrCode,B.RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,A.RtrName,RC.CtgCode,RVC.ValueClassCode,A.RtrStatus,GETDATE() 
	FROM Retailer A (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM(NOLOCK) ON A.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgMainId=RVC.CtgMainId 	
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)  
	
	UPDATE A SET A.RtrName=B.RetailerName,A.RtrStatus=(CASE WHEN B.RetailerStatus='Active' THEN 1 ELSE 0 END) FROM Retailer A 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)
	
	UPDATE A SET A.RtrValueClassId=RVC.RtrClassId FROM RetailerValueClassMap A 
	INNER JOIN Retailer B ON A.RtrId=B.RtrId
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=B.CmpRtrCode 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.ValueClassCode=M.RetailerClass
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgCode=M.RetailerGroup AND RC.CtgMainId=RVC.CtgMainId 
	INNER JOIN RetailerCategory RC1(NOLOCK) ON RC1.CtgCode=M.RetailerChannal AND RC1.CtgMainId=RC.CtgLinkId
	
	-- Added by Venkat.M PMS No : CRCRSTPAR0107
	UPDATE A SET A.RmId =R.Rmid FROM Retailer A (NOLOCK) INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	INNER JOIN RouteMaster R (NOLOCK) ON B.DeliveryRoute=R.RmCode AND RMSRouteType =2
	
	DELETE FROM RETAILERMarket WHERE RtrID In(SELECT A.RTRID FROM Retailer A (NOLOCK) INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	INNER JOIN RETAILERMarket RM (NOLOCK) ON Rm.Rtrid=A.Rtrid)
	
	INSERT INTO RETAILERMarket (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
	SELECT DISTINCT A.RtrId , R.RMId , 1,2,GETDATE(),2,GETDATE(),0  FROM Retailer A (NOLOCK)
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	INNER JOIN RouteMaster R (NOLOCK) ON B.SalesRoute=R.RmCode AND RMSRouteType =1
		
	UPDATE C SET DownloadFlag='Y' FROM  Cn2CS_Prk_RetailerMasterUpdate C 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=C.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE C.RtrCode=N.RtrCode) 
	
RETURN 
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ValidateUdcDetails' AND TYPE='P')
DROP PROCEDURE Proc_ValidateUdcDetails
GO
CREATE PROCEDURE Proc_ValidateUdcDetails
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*
Begin Tran
EXEC Proc_ValidateUdcDetails 0
--Select Count(*) from ETL_Prk_UdcDetails(NOLOCK)
RollBack Tran
************************************************************************************************
* PROCEDURE: Proc_ValidateUdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: Boopathy.P on 20/09/2007  
*************************************************************************************************
[DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
*************************************************************************************************
24-12-2018   Muthulakshmi.V     CRCRSTMTR0016        CR     UDC MTR should be default Yes
15-03-2021	 Mohana S			PARLECS/0321/181	 BZ		Validation inlcuded to check Aadhar
*************************************************************************************************/   
SET NOCOUNT ON    
BEGIN
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @RtrId AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	DECLARE @ColCode99 AS VARCHAR(100)   ---MARCS202100060
	SET @TabName = 'ETL_Prk_UdcDetails'  
	SET @Po_ErrNo =0
	
	SELECT * INTO #ETL_Prk_UdcDetails FROM ETL_Prk_UdcDetails
	CREATE TABLE #UdcToAvoid
	(
		[MasterName]	VARCHAR(100),
		[ColumnName]	VARCHAR(100)
	)
 ---MARCS202100060
   CREATE TABLE #ETL_Prk_CN2CS_UdcDetails999
	(
	ColCode Varchar(100)
	)
		
	INSERT INTO #UdcToAvoid([MasterName],[ColumnName])
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'PRODUCT MASTER' 
	and [ColumnName] IN ('HSN Code','HSN Description')
	UNION ALL	
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'SUPPLIER MASTER' 
	AND [ColumnName] in ('State Name','GSTIN','Status')
	UNION ALL
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'DISTRIBUTOR INFO MASTER' 
	AND [ColumnName] in ('State Name','GSTIN','Distributor Type','PAN Number')
	 ---MARCS202100060
	INSERT INTO #ETL_Prk_CN2CS_UdcDetails999
	SELECT Distinct ISNULL([Column Code],'') from ETL_Prk_CN2CS_UdcDetails(Nolock) WHERE MasterName='RETAILER MASTER'
	and ISNULL([Column Code],'')<>'' 
	DELETE FROM ETL_Prk_UdcDetails WHERE MasterName='RETAILER MASTER' and ColumnName='PAN/Aadhaar Available'
	--- ---MARCS202100060
	IF EXISTS(SELECT * FROM #UdcToAvoid)
	BEGIN
		INSERT INTO Errorlog 
		SELECT 1,@TabName,'MasterName,ColumnName','Udc Details should be download from Console : '
		+[MasterName]+' - '+ColumnName FROM #UdcToAvoid 
	END
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL([MasterName],'') AS [MasterName],ISNULL([ColumnName],'') AS [ColumnName],
    	ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM #ETL_Prk_UdcDetails A
    	WHERE NOT EXISTS(SELECT * FROM #UdcToAvoid B WHERE A.[MasterName]=B.[MasterName] AND A.ColumnName=B.ColumnName)
    	Order By [MasterName],[ColumnName],[Column Code]
	
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
	
		IF LTRIM(RTRIM(@MasterName))= ''
		BEGIN
			SET @ErrDesc = 'Master Name should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Master Name',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		ELSE IF LTRIM(RTRIM(@ColName))= ''
		BEGIN
			SET @ErrDesc = 'Column Name should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Column Name',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		ELSE IF LTRIM(RTRIM(@ColCode))= ''
		BEGIN
			SET @ErrDesc = 'Column Code should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Column Code',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		
		SELECT @TempUdcMasterId=B.UdcMasterId FROM UdcHD A (NOLOCK) INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId WHERE UPPER(B.ColumnName)=UPPER(LTRIM(RTRIM(@ColName)))
		IF EXISTS (SELECT UdcMasterId FROM UdcMaster (NOLOCK)WHERE UdcMasterId=@TempUdcMasterId)
		BEGIN
			SELECT @Mandatory=ColumnMandatory FROM UdcMaster (NOLOCK)WHERE UdcMasterId=@TempUdcMasterId
		END
		IF @Mandatory=1
		BEGIN
			IF LTRIM(RTRIM(@ColValue))= ''
			BEGIN
				SET @ErrDesc = 'Column Value should not be blank'  
				INSERT INTO Errorlog VALUES (1,@TabName,'Column Value',@ErrDesc)   
				SET @Taction = 0 
				SET @Po_ErrNo =1 
			END
		END
		--ELSE
		--BEGIN
			--SET @ColValue=NULL
		--END
		
		IF @ColName='GSTIN'
		BEGIN
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColValue,''))))<>''
			BEGIN
				IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
				BEGIN					
					SET @RtrId=0
					SELECT @RtrId=RtrId FROM Retailer(NOLOCK) where RtrCode=@ColCode
					IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@ColValue))<>''
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@ColValue)	
						SET @Po_ErrNo =1
					END				
					ELSE
					BEGIN
						IF (SELECT DBO.Fn_ISGSTINNumber(@ColValue))=1
						BEGIN
							INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
							SELECT DISTINCT 1,@TabName,'GSTIN','Invalid GST Tin Number'
							SET @Po_ErrNo =1
						END
					END
				END
			END
		END
		
		IF @ColName='PanNumber' or @ColName='PAN Number'
		BEGIN
			IF LEN(@ColValue)<10 --PARLECS/0321/181
			BEGIN
				SET @ColValue=''
			END
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColValue,''))))<>''
			BEGIN
				IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
				BEGIN
					SET @RtrId=0
					SELECT @RtrId=RtrId FROM Retailer(NOLOCK) where RtrCode=@ColCode
					IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@ColValue))<>''
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@ColValue)	
						SET @Po_ErrNo =1
					END				
				END			
				ELSE
				BEGIN
					IF (SELECT DBO.Fn_ISPanNumber(@ColValue))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
						SET @Po_ErrNo =1
					END
				END
			END
		END
		
		IF RTRIM(LTRIM(UPPER(ISNULL(@ColName,''))))='REGISTERED' 
		BEGIN
			IF @ColName='GSTIN'
			BEGIN		
				IF (SELECT DBO.Fn_ISGSTINNumber(@ColValue))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
			END
			
			IF @ColName='PanNumber' or @ColName='PAN Number'
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@ColValue))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END
		END		
		---------''' CRCRSTMTR0016
		IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ColName)))='MTR' AND UPPER(LTRIM(RTRIM(@ColValue)))<> 'YES'
			BEGIN				
				SET @ErrDesc = 'Column Value should be YES For MTR'  
				INSERT INTO Errorlog VALUES (1,@TabName,'Column Value',@ErrDesc)   
				SET @Taction = 0 
				SET @Po_ErrNo =1				
			END			
		END
		----- Till here CRCRSTMTR0016
				
				IF @ColName='Aadhaar'   ---MARCS202100060 
				BEGIN
					IF LEN(@ColValue)<12 --PARLECS/0321/181
					BEGIN
						SET @ColValue=''
					END
					IF ISNULL(@ColValue,'')<>'' --PARLECS/0321/181
					BEGIN
						IF (SELECT DBO.Fn_ISAadhaar(@ColValue))=1
						BEGIN
							INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
							SELECT DISTINCT 1,'UDCDetails','Aadhaar','Invalid Aadhaar Number'
							SET @Po_ErrNo =1
						END
					END
				END
		IF @Po_ErrNo = 0 
		BEGIN
			IF UPPER(LTRIM(RTRIM(@MasterName)))= 'PRODUCT MASTER' 
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('PRODUCT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCT','PrdCCode','PrdId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'ROUTE MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('ROUTE MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ROUTEMASTER','RMCode','RMId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SALESMAN MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SALESMAN MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SALESMAN','SMCode','SMId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BANK MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BANK MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('BANK','BnkCode','BnkId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BANK BRANCH MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BANK BRANCH MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('BANKBRANCH','BnkBrCode','BnkBrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'COMPANY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('COMPANY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('COMPANY','CmpCode','CmpId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SUPPLIER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SUPPLIER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SUPPLIER','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END  
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'ROUTE VILLAGE MAPPING'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('ROUTE VILLAGE MAPPING')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ROUTEVILLAGE','VillageCode','VillageId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TRANSPORTER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TRANSPORTER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TRANSPORTER','TransporterCode','TransporterId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER SHIPPING ADDRESS'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER SHIPPING ADDRESS')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILERSHIPADD','RtrCode','RtrShipId',LTRIM(RTRIM(@ColCode)),2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE CATEGORY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE CATEGORY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLECATEGORY','VehicleCtgCode','VehicleCtgId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLE','VehicleCode','VehicleId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TAXGROUPSETTING'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TAXGROUPSETTING')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TaxGroupSetting','RtrGroup','TaxGroupId',LTRIM(RTRIM(@ColCode)),3)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TAXCONFIGURATION'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TAXCONFIGURATION')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TAXCONFIGURATION','TaxCode','TaxId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DISTRIBUTOR INFO MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE SUBSIDY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE SUBSIDY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLESUBSIDY','VehicleSubCode','VehicleSubId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BATCH MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BATCH MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCTBATCH','PrdbatCode','PrdBatId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DELIVERYBOY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DELIVERYBOY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DELIVERYBOY','DlvBoyCode','DlvBoyId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'KIT PRODUCT REGISTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('KIT PRODUCT REGISTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('KITPRODUCT','PrdDCode','PrdId',LTRIM(RTRIM(@ColCode)),4)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'LOCATION MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('LOCATION MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('LOCATION','LcnCode','LcnId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER CATEGORY HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER CATEGORY HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILERCATEGORY','CtgCode','CtgMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SALESFORCE HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SALESFORCE HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SALESFORCE','SalesForceCode','SalesForceMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'GEOGRAPHY HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('GEOGRAPHY HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('GEOGRAPHY','GeoCode','GeoMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'REASON MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('REASON MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('REASONMASTER','ReasonCode','ReasonId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CREDIT NOTE RETAILER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CREDIT NOTE RETAILER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('CREDITNOTERETAILER','RtrCode','CrNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DEBIT NOTE RETAILER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DEBIT NOTE RETAILER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('DEBITNOTERETAILER','RtrCode','DbNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CREDIT NOTE SUPPLIER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CREDIT NOTE SUPPLIER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('CREDITNOTESUPPLIER','SpmCode','CrNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DEBIT NOTE SUPPLIER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DEBIT NOTE SUPPLIER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('DEBITNOTESUPPLIER','SpmCode','DbNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CLAIM GROUP MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CLAIM GROUP MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('CLAIMGROUPMASTER','ClmGrpCode','ClmGrpId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'STOCK MANAGEMENT'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('STOCK MANAGEMENT')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('STOCKMANAGEMENTTYPE','Description','StkMgmtTypeId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'MANUAL CLAIM'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('MANUAL CLAIM')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ManualClaimMaster','MacRefNo','MacRefId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			IF @RecId <> 0 			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE A  SET ColumnValue =LTRIM(RTRIM(@ColValue)) FROM UdcDetails A(NOLOCK) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
					SET @sSQL = 'UPDATE A SET ColumnValue = ' + CAST(@ColValue AS VARCHAR(50)) + ' FROM UdcDetails A(NOLOCK) WHERE MasterId =' + CAST(@UdcHdId AS VARCHAR(10)) + 
						    ' AND UdcMasterId =' + CAST(@UdcMasId AS VARCHAR(10)) + ' AND MasterRecordId=' + CAST(@RecId AS VARCHAR(10)) 
				DELETE FROM ETL_Prk_UdcDetails WHERE MasterName=@MasterName AND ColumnName=@ColName and [Column Code]=@ColCode and ColumnValue=@ColValue ---ABM
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
				DELETE FROM ETL_Prk_UdcDetails WHERE MasterName=@MasterName AND ColumnName=@ColName and [Column Code]=@ColCode and ColumnValue=@ColValue --ABM
					--SET @sSQL = 'INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(' +
					--	    CAST(@GetKey AS VARCHAR(50)) + ',' + CAST(@UdcMasId AS VARCHAR(10)) + ',' + CAST(@UdcHdId AS VARCHAR(10)) + ',' + CAST(@UdcHdId AS VARCHAR(50)) + ',' + 
					--	    CAST(@RecId AS VARCHAR(50)) + ',' + CAST(@ColValue AS VARCHAR(50)) + ','+ CAST(@UniqueId AS VARCHAR(50)) + ',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
					--INSERT INTO Translog(strSql1) Values (@sSQL)
					UPDATE A  SET currvalue = currvalue+1 FROM counters A (NOLOCK) where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					--SET @sSQL = 'UPDATE A SET currvalue = currvalue + 1 FROM counters A (NOLOCK) where tabname = ''UDCDetails'' and fldname = ''UdcDetailsId'''
					--INSERT INTO Translog(strSql1) Values (@sSQL)
					UPDATE A  SET currvalue = currvalue+1 from counters A (NOLOCK) where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
					--SET @sSQL = 'UPDATE A  SET currvalue = currvalue + 1 FROM counters A (NOLOCK) where tabname = ''UDCDetails'' and fldname = ''UDCUniqueId'''
					--INSERT INTO Translog(strSql1) Values (@sSQL)
				END
			END
		END	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt 
	-- ---MARCS202100060
	DECLARE Cur_UdcDt1 CURSOR   
	FOR SELECT DISTINCT Colcode from #ETL_Prk_CN2CS_UdcDetails999
	OPEN Cur_UdcDt1  
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	WHILE @@FETCH_STATUS=0  
	BEGIN  
	EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	END  
	CLOSE Cur_UdcDt1  
	DEALLOCATE Cur_UdcDt1  
	 ---MARCS202100060
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_ValidateTempPurchasereceiptMoved' AND Type='P')
DROP PROC Proc_ValidateTempPurchasereceiptMoved
GO
CREATE PROCEDURE Proc_ValidateTempPurchasereceiptMoved
AS
SET NOCOUNT ON
/*******************************************************************************************************************
* PROCEDURE		: Proc_ValidateTempPurchasereceiptMoved
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 03-02-2021   Deepak Philip        PARLESECS/0221/014    CR     script has been optimised.
*********************************************************************************************************************/
BEGIN
	SELECT CmpInvNo into #temp from (
	SELECT CmpInvNo from ETLTempPurchaseReceipt (NOLOCK)
	UNION ALL
	SELECT CmpInvNo FROM PurchaseReceipt (NOLOCK)
	UNION ALL 
	SELECT compinvno from cn2cs_prk_blpurchasereceipt (NOLOCK)) A
	IF EXISTS(SELECT *FROM Console2CS_Consolidated_Trace (NOLOCK)where processname like '%purchase%' AND column2 not in(
	select cmpinvno from #temp))
	BEGIN 
		
		SELECT DISTINCT * INTO #TempPur from Console2CS_Consolidated_Trace (NOLOCK) where processname like '%purchase%' and column2 not in(
		select cmpinvno from #temp)

		ALTER TABLE #TempPur DROP COLUMN [DOWNLOADED DATE]
		UPDATE #TempPur SET SYNCID = (SELECT SYNCID FROM SYNCSTATUS_DOWNLOAD (NOLOCK)),DOWNLOADFLAG='D'
		INSERT INTO CONSOLE2CS_CONSOLIDATED
		SELECT * FROM #TempPur
		EXEC PROC_CONSOLE2CS_CONSOLIDATEDDOWNLOAD
		EXEC PROC_CN2CS_PURCHASERECEIPT 0
	END
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_SamplingClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_SamplingClaimDetails
GO
CREATE PROCEDURE Proc_SamplingClaimDetails
(
@Pi_Year	INT,
@Pi_Month	INT,
@Pi_Usrid	INT,
@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_SamplingClaimDetails
* PURPOSE	:  TO LOAD THE FREE ISSUE DETAILS
* DATE		:  05-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
---------------------------------------------------------------------------------------------------------------------------
* 03-05-2021     Deepak Philip	    PARLECS/0521/008 		 BZ		     to delete the circular unavailable details.
* 04-06-2021	 MOhana S			PARLECS/0621/002		 SR			 To delete the Sample claim for West And East Zone
*******************************************************************************/
BEGIN
SET NOCOUNT ON
	DELETE FROM  TempSamplingClaimDetails   
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @CirNo	   NVARCHAR(100)
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
	DECLARE @slno AS INT      
	DECLARE @SamplingAmount AS NUMERIC(18,2)      
	SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'      
	SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0) FROM FreeIssueHd J (NOLOCK),      
	FreeIssueDt D (NOLOCK),      
	ProductBatchDetails P (NOLOCK)      
	WHERE J.IssueId = D.IssueId       
	AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
	AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate  
	
	SELECT DISTINCT TOP 1 CircularNo ,MAX(CreatedDate ) CREATEDDATE
	INTO #SchemeClaimCircular FROM SchemeClaimCircular WHERE ((@FromDate  BETWEEN SchValidFrom  AND SchValidTill ) 
	OR (  @ToDate  BETWEEN SchValidFrom  AND SchValidTill  )) AND ClaimType='Sampling Claim'
	GROUP BY CircularNo
	
	SELECT @CirNo = CircularNo  FROM #SchemeClaimCircular
	IF @SamplingAmount>0
	BEGIN
		INSERT INTO TempSamplingClaimDetails
		SELECT CONVERT (VARCHAR(10),GETDATE(),121),@FromDate,@ToDate,@CirNo,@SamplingAmount,@Pi_Usrid,@Pi_Transid	

		IF EXISTS(SELECT B.ColumnValue FROM Distributor A(NOLOCK) INNER JOIN UDCDetails B(NOLOCK) ON A.DistributorId =B.MasterRecordId 
			INNER JOIN UdcMaster C(NOLOCK) ON B.Masterid =C.Masterid AND B.UdcMasterid =C.UdcMasterid AND ColumnName ='State Name'
			INNER JOIN StateMaster S(NOLOCK) ON B.ColumnValue =S.StateName  WHERE C.Masterid =16 
			AND StateCode IN('24','25','26','22','23','27'))
		BEGIN
			DELETE A FROM TempSamplingClaimDetails A (NOLOCK) --WHERE ISNULL(CircularNo,'')=''--PARLECS/0521/008 'PARLECS/0621/002
		END
	END
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_StockCorrection' AND TYPE='U')
BEGIN
CREATE TABLE [dbo].Cn2Cs_Prk_StockCorrection
(
	[DistCode] [varchar](50) NULL,
	[ProductCode] [Nvarchar](200) NULL,
	[BatchCode] [Nvarchar](200) NULL,
	[Quantity] [numeric](36, 0) NULL,
	[DownloadFlag] [varchar](2) NULL,
	[CreatedDate] [datetime] NULL
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_StockCorrection' AND TYPE='P')
DROP PROCEDURE  Proc_Cn2Cs_StockCorrection
GO
/* 
BEGIN TRAN
DELETE FROM ERRORLOG  
EXEC Proc_Cn2Cs_StockCorrection 0  
SELECT * FROM StockManagement
select * from productbatchlocation where prdbatlcnsih>0 and prdid in (25,77,237)
ROLLBACK TRAN
 */
CREATE  PROCEDURE  Proc_Cn2Cs_StockCorrection 
(
	@Po_ErrNo INT OUTPUT
)
AS
/*******************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_StockCorrection
* PURPOSE		: To validate the Provision Approval
* CREATED BY	: Mohana S 
* CREATED DATE	: 12-05-2021
* USER STORY ID : CRCRSTLOR0214
*******************************************************************************************************************/
SET NOCOUNT ON
BEGIN 

	DECLARE @DistCode AS NVARCHAR(100)

	SELECT @DistCode = DistributorCode FROM Distributor

	SELECT ProductCode,BatchCode,Max(Createddate) Cdate INTO #Max FROM Cn2Cs_Prk_StockCorrection GROUP BY ProductCode,BatchCode

	SELECT B.* INTO #Cn2Cs_Prk_StockCorrection FROM #Max A INNER JOIN Cn2Cs_Prk_StockCorrection B ON A.ProductCode = B.ProductCode AND A.BatchCode = B.BatchCode AND A.Cdate =B.Createddate
 
	SELECT P.Prdid,PrdBatid,Quantity AS Qty INTO #StockDet FROM #Cn2Cs_Prk_StockCorrection A INNER JOIN Product P ON A.ProductCode = P.PrdCCode
	INNER JOIN ProductBatch B ON A.BatchCode = B.PrdBatCode AND P.PrdId = B.PrdId 

	SELECT A.Prdid,A.PrdBatId,SUM(Qty - (PrdBatLcnSih - PrdBatLcnRessih)) TotQty INTO #Final FROM #StockDet A 
	INNER JOIN ProductBatchLocation B ON B.PrdId = A.PrdId AND B.PrdBatID = A.PrdBatID 

	GROUP BY A.Prdid,A.PrdBatId

	DECLARE @LcnCode AS VARCHAR(100)
	SELECT @LcnCode = LcnCode  FROM Location WHERE LcnName ='Main Godown'

	INSERT INTO Cn2Cs_Prk_StockTransfer (DistCode,DocRefNo,TransType,ProductCode,BatchCode,SysStkType,Location,[Uom Code],Qty,Type,DownloadFlag,CreatedDate)
	SELECT @DistCode,'STKCRCT' + CAST( DENSE_RANK() OVER (ORDER BY  PrdCCode,PrdBatCode)AS VARCHAR(100)),CASE WHEN TOTQTY<0 THEN 'REDUCE' ELSE 'ADD' END AS TransType,PrdCCode,PrdBatCode,'Saleable',@LcnCode,UomCode,
	ABS(A.totQty),0,'D',GETDATE()  FROM #Final A INNER JOIN Product B ON A.PrdId = B.PrdId
	INNER JOIN ProductBatch C ON A.PrdBatId  =C.PrdBatId AND B.PrdId = C.PrdId AND A.PrdId = C.PrdId 
	INNER JOIN UomGroup D ON B.UomGroupId = D.UomGroupId 
	INNER JOIN UomMaster E ON D.UomId = E.UomId AND BaseUom ='Y'

	IF EXISTS (SELECT * FROM Cn2Cs_Prk_StockTransfer WHERE DownloadFlag ='D')
	BEGIN
		EXEC Proc_ValidateStockTransfer_Download 0
	END

	UPDATE A SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_StockTransfer A INNER JOIN Cn2Cs_Prk_StockCorrection B ON A.ProductCode = B.ProductCode AND A.BatchCode=B.BatchCode
	
	
RETURN
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2cn_Prk_PDASyncDetails_QS' AND XTYPE ='U')
CREATE TABLE Cs2cn_Prk_PDASyncDetails_QS
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[FixId] [int] NULL,
	[FixDate] [datetime] NULL,
	[UploadFlag] [nvarchar](1) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[PDASyncDate] [datetime] NULL,--- New Column
	[PDASyncStatus] [varchar](50) NULL,--- New Column
	[PDASyncId] [int] NULL,--- New Column
	[PDASyncVersion] [varchar](50) NULL,--- New Column
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2cn_PDASyncDetails_QS' AND XTYPE ='P')
DROP PROCEDURE Proc_Cs2cn_PDASyncDetails_QS
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2cn_PDASyncDetails_QS 0,'2013-05-22'
SELECT * FROM Cs2cn_Prk_PDASyncDetails_QS
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2cn_PDASyncDetails_QS
(
	@Po_ErrNo INT OUTPUT,
	@Sever_Date AS DATETIME
)
AS
/*********************************
* PROCEDURE		: PROC_Cs2cn_PDASyncDetails_QS
* PURPOSE		: To Extract Hot Fix Details
* CREATED		: Venkat. M
* CREATED DATE	: 29/04/2021
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}		{developer}			PMS				{brief modification description}
* 2021-04-29    Venkat. M		CRCRSTPAR0113		SFA Details Quick sync process
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @CmpId 		AS INTEGER
	DECLARE @DistCode	AS NVARCHAR(50)
	DECLARE @HostName   AS NVARCHAR(200)
	DECLARE @PdaSyncDate AS DATETIME
	DECLARE @PdaSyncid	AS INT	
	SET @Po_ErrNo=0
	
	IF EXISTS(SELECT 'X' FROM DistributorCodeSwaping (NOLOCK) WHERE UpdatedFlag='N')
	BEGIN
		UPDATE SyncStatus SET DistCode=(SELECT TOP 1 NewDistCode FROM DistributorCodeSwaping (NOLOCK) WHERE UpdatedFlag='N' ORDER BY ValidateDate DESC) , SyncStatus = 0, SyncFlag= 'N'
		DELETE FROM  SyncStatus_Download	
		UPDATE  DistributorCodeSwaping SET UpdatedFlag='Y' WHERE UpdatedFlag='N'
	END
	 
	
	SELECT @DistCode = DistributorCode FROM Distributor
	SELECT TOP 1 Ltrim(RTrim(HostName)) AS HostName INTO #HostName FROM Sys.sysprocesses WHERE Status='RUNNABLE' ORDER BY Login_time DESC
	SELECT @HostName = HostName FROM #HostName WITH (NOLOCK)
	SELECT @PdaSyncDate =CAST(CValue  AS DATETIME) FROM Tbl_SFAConfiguration(NOLOCK) WHERE CName ='LastExportDate'
	SELECT @PdaSyncid=CValue  FROM Tbl_SFAConfiguration (NOLOCK) WHERE CName ='PDASyncId'

	TRUNCATE TABLE Cs2cn_Prk_PDASyncDetails_QS
	INSERT INTO Cs2cn_Prk_PDASyncDetails_QS(DistCode,FixId,FixDate,UploadFlag,SyncId,PDASyncDate,PDASyncStatus,PDASyncId,PDASyncVersion)
	SELECT @DistCode,H.FixId,FixedOn AS FixDate,'N',
	(SELECT ISNULL(MAX(SyncId),0) AS SYNCID FROM sync_master (NOLOCK)),@PdaSyncDate, 'Completed',@PdaSyncid,'0'
	FROM AppTitle A ,HotFixLog H,UPdaterLog U WHERE H.FixID IN (SELECT ISNULL(MAX(FixId),0) FROM HotFixLog)
	AND U.FixId =(Select Max(fixid) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog))
	
	IF NOT EXISTS(SELECT * FROM Cs2cn_Prk_PDASyncDetails_QS)
	BEGIN
		INSERT INTO Cs2cn_Prk_PDASyncDetails_QS(DistCode,FixId,FixDate,UploadFlag,SyncId,PDASyncDate,
		PDASyncStatus,PDASyncId,PDASyncVersion)
		SELECT @DistCode,H.FixId,FixedOn AS FixDate,'N',
		(SELECT ISNULL(MAX(SyncId),0) AS SYNCID FROM sync_master (NOLOCK)),@PdaSyncDate, 'Completed',@PdaSyncid,'0'
		FROM AppTitle A ,HotFixLog H,UPdaterLog U WHERE H.FixID IN (SELECT ISNULL(MAX(FixId),0) FROM HotFixLog)
		and u.Fixid = (Select Max(fixid) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog))
	END
	
	--INSERT INTO Hotfixupdater_Bck(Fixid,FixType)
	--SELECT DISTINCT UpdatedHotfixId,'UpdaterLog' FROM Cs2cn_Prk_PDASyncDetails_QS A WHERE NOT EXISTS(SELECT * FROM Hotfixupdater_Bck B (NOLOCK) WHERE A.UpdatedHotfixid=B.Fixid AND B.FixType='UpdaterLog')
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ExportValues' AND XTYPE ='P')
DROP PROCEDURE Proc_ExportValues
GO
CREATE PROCEDURE Proc_ExportValues
(
	@TypeId INT,
	@PId INT = 0
)
AS
/*
Proc_ExportValues 1
------------------------------------------------
* {date}		{developer}			PMS				{brief modification description}
* 2021-04-29    Venkat. M		CRCRSTPAR0113		SFA Details Quick sync process
*********************************/
BEGIN
		---Added By Venkat. M CRCRSTPAR0113
	DECLARE @PDAId  AS INT
    SELECT @PDAId = ISNULL(CValue,0)+1 FROM Tbl_SFAConfiguration (NOLOCK) WHERE CName ='PDASyncID'
		-- Till Here
	IF (@TypeId  = 1) --SALESMAN
	BEGIN
	
		SELECT SMId,SMName FROM SalesMan WHERE Status = 1 --AND ISNULL(SMOtherDetails, '') LIKE '%~%'
		SELECT SMCode,SMName FROM SalesMan WHERE Status = 1 --AND ISNULL(SMOtherDetails, '') LIKE '%~%'
		----SELECT * FROM SalesMan
		SELECT CValue FROM Tbl_SFAConfiguration WHERE CName='LastExportDate'
		SELECT CValue FROM Tbl_SFAConfiguration WHERE CName='LastImportDate'
		SELECT CValue FROM Tbl_SFAConfiguration WHERE CName='LastModifiedDate'
	END
	ELSE IF (@TypeId = 2)
	BEGIN
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='WebserviceURL'
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='DeveloperKey'
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='UserName'
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='Password'
	END
	ELSE IF (@TypeId = 3)
	BEGIN
		SELECT ISNULL(LTRIM(RTRIM(DistributorCode)),'') FROM Distributor 
		SELECT '0' EnableFlag 
	END
	ELSE IF (@TypeId  = 4) --Location Details Flag
	BEGIN
		UPDATE Export_CS2WS_LocationDetails SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 5)--Customer Category Flag
	BEGIN
		UPDATE Export_CS2WS_CustomerCategory SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 6)--Customer Hierarchy Flag
	BEGIN
		UPDATE Export_CS2WS_CustomerHierarchyV1 SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 7)--Customer HierarchyV1 Flag
	BEGIN
		UPDATE Export_CS2WS_ProductCategory SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 8)--ProductCategory Hierarchy Flag
	BEGIN
		UPDATE Export_CS2WS_BeatMaster SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 9)--List Selection Flag
	BEGIN
		UPDATE Export_CS2WS_ListSelection SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 10)--Salesman Details Flag
	BEGIN
		UPDATE Export_CS2WS_SalesmanDetails SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 11)--Vehicle Details Flag
	BEGIN
		UPDATE Export_CS2WS_VehicleDetails SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 12)--HHTMaster Details Flag
	BEGIN
		UPDATE Export_CS2WS_HHTMasterDetails SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 13) --Product Master Flag
	BEGIN
		UPDATE Export_CS2WS_Product SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 14)--PricingPlan Flag
	BEGIN
		UPDATE Export_CS2WS_PricingPlan SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 15)--PricingPlan Flag
	BEGIN
		UPDATE Export_CS2WS_AuthorizedProduct SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 16)--WarehouseInventory  Flag
	BEGIN
		UPDATE Export_CS2WS_WarehouseInventory SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 17)--Customer Master  Flag
	BEGIN
		UPDATE Export_CS2WS_Customer SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 18)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_PromotionControl SET UploadFlag = 'Y'
		UPDATE Export_CS2WS_ProductGroup SET UploadFlag = 'Y'
		UPDATE Export_CS2WS_PromotionAssignment SET UploadFlag = 'Y'
		UPDATE Export_CS2WS_CustomerHierarchy SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 19)--Credit Details
	BEGIN
		UPDATE Export_CS2WS_CreditDetails SET UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 20)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_JourneyPlan SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 21)--Route Setup  Flag
	BEGIN
		UPDATE Export_CS2WS_RouteSetupV1 SET  UploadFlag = 'Y'
		UPDATE Export_CS2WS_RouteDivisionsList SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 22)--Route Setup  Flag
	BEGIN
	
		DELETE A FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN SalesMan RM (NOLOCK) ON A.MasterCode=RM.SMCode
		WHERE ISNULL(RM.WSUpload,'N')='N' AND ProcessName='Salesman Details'
		---Whenever salesman interface triggered, trigger vehicle details interface too.
		DELETE A FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN SalesMan RM (NOLOCK) ON A.MasterCode=RM.SMCode
		WHERE ISNULL(RM.WSUpload,'N')='N' AND ProcessName='Vehicle Details'
		UPDATE RM SET RM.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN SalesMan RM (NOLOCK) ON A.MasterCode=RM.SMCode
		WHERE ISNULL(RM.WSUpload,'N')='N' AND ProcessName='Salesman Details'
		---Retailer 
		DELETE A FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN Retailer R (NOLOCK) ON A.MasterCode=R.CmpRtrCode
		WHERE ISNULL(R.WSUpload,'N')='N' AND ProcessName='Customer'
		UPDATE R SET R.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
		INNER JOIN Retailer R (NOLOCK) ON A.MasterCode=R.CmpRtrCode
		WHERE ISNULL(R.WSUpload,'N')='N' AND ProcessName='Customer'	
	
		SELECT ProcessId,ProcessName,[Enable],Status FROM Tbl_WSUploadIntegration WHERE [Status]=1  AND Enable=1 
		ORDER BY ProcessId	
		SELECT ProcessId,ProcessName,[Enable],Status FROM Tbl_WSdownloadIntegration WHERE [Status]=1  AND Enable=1 
		ORDER BY ProcessId	
		
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='WebserviceURL'
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='AverageSales'
		SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_SFAConfiguration WHERE CName='PendingInvoices'
		
	END
	ELSE IF (@TypeId = 23)
	BEGIN
		SELECT [Status] FROM Tbl_WSUploadIntegration WHERE ProcessId = @PId
	END
	ELSE IF (@TypeId = 24)
	BEGIN
		UPDATE Tbl_SFAConfiguration SET CValue = GETDATE() WHERE CName='LastExportDate'
	END
	ELSE IF (@TypeId = 25)
	BEGIN
		UPDATE Tbl_SFAConfiguration SET CValue = GETDATE() WHERE CName='LastImportDate'
		UPDATE Tbl_SFAConfiguration SET CValue =@PdaId WHERE CName ='PDASyncID' ----CRCRSTPAR0113
	END
	ELSE IF (@TypeId  = 26)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_PendingInvoice SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 27)--Customer   Flag
	BEGIN
		UPDATE Export_CS2WS_CustomerTarget SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 28)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_RouteTarget SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 29)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_SalesInvoiceHeader SET  UploadFlag = 'Y'
		UPDATE Export_CS2WS_SalesInvoiceDetails SET  UploadFlag = 'Y'
	END
	ELSE IF (@TypeId  = 30)--Scheme Header  Flag
	BEGIN
		UPDATE Export_CS2WS_SchemeAchievement SET  UploadFlag = 'Y'
	END
	--ELSE IF (@TypeId  = 4) -- LOCATION DETAILS
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		LocationName,
	--		Address,
	--		City,
	--		State,
	--		Country,	
	--		Zip,
	--		Phone,
	--		Email,
	--		CurrencyCode
	--	FROM Export_CS2WS_LocationDetails WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 5)
	--BEGIN
	--	UPDATE Export_CS2WS_LocationDetails SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 6) -- CUSTOMER CATEGORY
	--BEGIN
	--	SELECT 
	--		TenantCode,
	--		CategoryType,
	--		CategoryCode,
	--		CategoryDescription
	--	FROM Export_CS2WS_CustomerCategory WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 7)
	--BEGIN
	--	UPDATE Export_CS2WS_CustomerCategory SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 8) -- CUSTOMER HIERARCHY V1
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		ParentCode,
	--		HierarchyLevel,
	--		HierarchyCode,
	--		HierarchyName,
	--		ParentHierarchy
	--	FROM Export_CS2WS_CustomerHierarchyV1 WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 9)
	--BEGIN
	--	UPDATE Export_CS2WS_CustomerHierarchyV1 SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 10) -- PRODUCT CATEGORY
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		ParentCode,
	--		HierarchyLevel,
	--		HierarchyCode,
	--		HierarchyName,
	--		ParentHierarchy
	--	FROM Export_CS2WS_ProductCategory WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 11)
	--BEGIN
	--	UPDATE Export_CS2WS_ProductCategory SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 12) -- BEAT MASTER
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		BeatCode,
	--		BeatName
	--	FROM Export_CS2WS_BeatMaster WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 13)
	--BEGIN
	--	UPDATE Export_CS2WS_BeatMaster SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 14) -- LIST SELECTION
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		ListTypeCode,
	--		Code,
	--		Description
	--	FROM Export_CS2WS_ListSelection WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 15)
	--BEGIN
	--	UPDATE Export_CS2WS_ListSelection SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 16) -- SALESMAN DETAILS
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		SalesmanCode,
	--		SalesmanName,
	--		[Address],
	--		City,
	--		[State],
	--		Zip,
	--		Phone,
	--		IsActive,
	--		[Password]
	--	FROM Export_CS2WS_SalesmanDetails WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 17)
	--BEGIN
	--	UPDATE Export_CS2WS_SalesmanDetails SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 18) -- VEHICLE DETAILS
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		VehicleCode,
	--		VehicleTitle
	--	FROM Export_CS2WS_VehicleDetails WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 19)
	--BEGIN
	--	UPDATE Export_CS2WS_VehicleDetails SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 20) -- HHT MASTER DETAILS
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		HHTName,
	--		HHTDeviceSerialNumber
	--	FROM Export_CS2WS_HHTMasterDetails WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId  = 21)
	--BEGIN
	--	UPDATE Export_CS2WS_HHTMasterDetails SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 22) --Product Master
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		ItemCode,
	--		UnitsOfMeasure,
	--		EANNumber,
	--		ItemTypeCode,
	--		ItemDescription,
	--		ShortDescription,
	--		DivisionCode,
	--		IsBUOM,
	--		Numerator,
	--		Denominator,
	--		[Weight],
	--		MRP,
	--		DefaultDebitPrice,
	--		DefaultCreditPrice,
	--		DefaultDamagePrice,
	--		ChangeLimit,
	--		CodeDateFormat,
	--		ItemShelfLife,
	--		IsActive,
	--		ContributionMargin,
	--		IsBatchManaged,
	--		HierarchyCode,
	--		HSNCode
	--	FROM Export_CS2WS_Product WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 23) --Product Master Flag
	--BEGIN
	--	UPDATE Export_CS2WS_Product SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 24) -- PricingPlan
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		PricingCode,
	--		PricingDescription,
	--		CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
	--		CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
	--		ItemCode,
	--		UnitsOfMeasure,
	--		DebitPrice,
	--		CreditPrice,
	--		DamagePrice
	--	FROM Export_CS2WS_PricingPlan WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 25)--PricingPlan Flag
	--BEGIN
	--	UPDATE Export_CS2WS_PricingPlan SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 26) -- PricingPlan
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		Code,
	--		[Description],
	--		ItemCode
	--	FROM Export_CS2WS_AuthorizedProduct WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 27)--PricingPlan Flag
	--BEGIN
	--	UPDATE Export_CS2WS_AuthorizedProduct SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 28) -- WarehouseInventory
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		WarehouseCode,
	--		ItemCode,
	--		Quantity
	--	FROM Export_CS2WS_WarehouseInventory WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 29)--WarehouseInventory  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_WarehouseInventory SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 30) -- Scheme Header
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		PromotionCode,
	--		PromotionDescription,
	--		PromotionRemarks,
	--		PromotionTypeCode,
	--		RangeBasis,
	--		AmountBasis,
	--		ExclusionOption,
	--		PromotionIndicator,
	--		PromotionProductLevel,
	--		PromotionQuotaCode,
	--		AllowQPS
	--	FROM Export_CS2WS_PromotionControl WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 31)--Scheme Header  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_PromotionControl SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 32) -- Scheme Products
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		PromotionCode,
	--		GroupType,
	--		ProductHierarchyCode,
	--		ItemCode,
	--		UnitsOfMeasure,
	--		Quantity
	--	FROM Export_CS2WS_ProductGroup WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 33)--Scheme Header  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_ProductGroup SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 34) -- Scheme Products
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		PromotionCode,
	--		RangeLow,
	--		RangeHigh,
	--		RepeatingRange,
	--		PromotionAmount
	--	FROM Export_CS2WS_PromotionAssignment WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 35)--Scheme Header  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_PromotionAssignment SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 36) -- Scheme Products
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		CustomerCode,
	--		CategoryCode1,
	--		CategoryCode2,
	--		CategoryCode3,
	--		CustomerHierarchyCode,
	--		SequenceNumber,
	--		PromotionCode,
	--		CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
	--		CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
	--		ActiveIndicator
	--	FROM Export_CS2WS_CustomerHierarchy WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 37)--Scheme Header  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_CustomerHierarchy SET UploadFlag = 'Y'
	--END
	--ELSE IF (@TypeId  = 38) -- Scheme Products
	--BEGIN
	--	SELECT
	--		TenantCode,
	--		LocationCode,
	--		DivisionCode,
	--		CustomerCode,
	--		CreditLimit,
	--		CustomerBalanceDue,
	--		TotalNumberofInvoices,
	--		TotalDaysofInvoices,
	--		Blocked
	--	FROM Export_CS2WS_CreditDetails WITH (NOLOCK) 
	
	--END
	--ELSE IF (@TypeId  = 39)--Scheme Header  Flag
	--BEGIN
	--	UPDATE Export_CS2WS_CreditDetails SET UploadFlag = 'Y'
	--END
	
	--ELSE IF (@TypeId = 34)
	--BEGIN
	--	SELECT ProcessId,ProcessName,[Enable],Status FROM Tbl_PDAProcess
	--	ORDER BY ProcessId	
		
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='WebserviceURL'
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='AverageSales'
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='PendingInvoices'
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='WebserviceURL_New'
	--END
	--ELSE IF (@TypeId = 35)
	--BEGIN
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='Password'
	--END
	--ELSE IF (@TypeId = 36)
	--BEGIN
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='WebserviceURL'
	--END
	--ELSE IF (@TypeId = 37)
	--BEGIN
	--	SELECT Status FROM Tbl_PDAProcess WHERE ProcessId = @PId
	--END
	--ELSE IF (@TypeId = 38)
	--BEGIN
	--	UPDATE Tbl_PDAConfiguration SET CValue = GETDATE() WHERE CName='LastExportDate'
	--END
	--ELSE IF (@TypeId = 39)
	--BEGIN
	--	UPDATE Tbl_PDAConfiguration SET CValue = GETDATE() WHERE CName='LastImportDate'
	--END
	--ELSE IF (@TypeId = 40)
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		SalesmanCode,
	--		DocumentNumber
	--	FROM
	--	Export_RtTransactionDataDetails WITH (NOLOCK) 
	--END
	--ELSE IF (@TypeId = 41) -- Special Item Details
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		CategoryCode1,
	--		CategoryCode2,
	--		SpecialItemGroup,
	--		Description,
	--		ItemCode
	--	FROM
	--	Export_RtSpecialItemsDetails (NOLOCK)
	--END
	--ELSE IF (@TypeId = 42)
	--BEGIN
	--	UPDATE Export_RtSpecialItemsDetails SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 43)
	--BEGIN
	--	SELECT
	--		LocationCode,
	--		PlanogramName,
	--		CategoryCode1,
	--		CategoryCode2
	--	FROM	
	--	Export_RtMerchandizeLocation (NOLOCK)
	--END
	--ELSE IF (@TypeId = 44)
	--BEGIN
	--	UPDATE Export_RtMerchandizeLocation SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 45)
	--BEGIN
	--	SELECT 
	--		PlanogramName,
	--		PlanogramImage
	--	FROM
	--	Export_RtMerchLocationImages (NOLOCK)
	--END
	--ELSE IF (@TypeId = 46)
	--BEGIN
	--	UPDATE Export_RtMerchLocationImages SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 47)
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		SurveyTitle,
	--		SurveyType,
	--		StartDate,
	--		EndDate,
	--		CategoryCode1,
	--		CategoryCode2
	--	FROM
	--	Export_RtSurveyControl (NOLOCK)				
	--END	
	--ELSE IF (@TypeId = 48)
	--BEGIN
	--	UPDATE Export_RtSurveyControl SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 49)
	--BEGIN
	--	SELECT 
	--		SurveyTitle,
	--		QuestionTitle,
	--		QuestionType,
	--		MinVal,
	--		MaxVal
	--	FROM
	--	Export_Rtsurveydefintiondetails (NOLOCK)
	--END
	--ELSE IF (@TypeId = 50)
	--BEGIN
	--	UPDATE Export_Rtsurveydefintiondetails SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 51)
	--BEGIN
	--	SELECT
	--		SurveyTitle,
	--		QuestionTitle,
	--		AnswerTitle,
	--		AnswerType
	--	FROM
	--		Export_RtSurveyAnswerdetails (NOLOCK)
	--END
	--ELSE IF (@TypeId = 52)
	--BEGIN
	--	UPDATE Export_RtSurveyAnswerdetails SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 53)
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		SalesmanCode,
	--		TargetMonth,
	--		TargetName,
	--		TargetValue,
	--		TargetAchieved
	--	FROM
	--		Export_RtSalesmanTargetDetails (NOLOCK)			
	--END
	--ELSE IF (@TypeId = 54)
	--BEGIN
	--	UPDATE Export_RtSalesmanTargetDetails SET UPLOADFLAG = 'Y'
	--END
	--ELSE IF (@TypeId = 55)
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		SalesmanCode,
	--		CustomerCode,
	--		ReferenceCode
	--	FROM
	--		Export_RtTransactionDataDetails_Others (NOLOCK)
			
	--END
	--ELSE IF (@TypeId = 56)
	--BEGIN
	--	SELECT 
	--		LocationCode,
	--		SalesmanCode,
	--		SurveyResponseDate
	--	FROM
	--		Export_RtTransactionDataDetails_SurveyResponse (NOLOCK)
	--END
	--ELSE IF (@TypeId = 57)
	--BEGIN
	--	SELECT ISNULL(LTRIM(RTRIM(CValue)),'') FROM Tbl_PDAConfiguration WHERE CName='WebserviceURL_New'
	--END
	--ELSE IF (@TypeId = 58)
	--BEGIN
	--	SELECT ISNULL(LTRIM(RTRIM(DistributorCode)),'') FROM Distributor 
	--END
END
GO
IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name='IND_ContractPricingAttributes_contractid')
BEGIN
	CREATE INDEX IND_ContractPricingAttributes_contractid ON ContractPricingAttributes (ContractId)
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='PROC_ReturnSplDiscountForSFA' AND TYPE='P')
DROP PROC PROC_ReturnSplDiscountForSFA
GO
CREATE PROC PROC_ReturnSplDiscountForSFA
AS
/*******************************************************************************************
* PROCEDURE		: PROC_ReturnSplDiscountForSFA
* PURPOSE		: To fetch Product Price details to the PDA Intermediate Database
* CREATED		: Deepak Philip
* CREATED DATE	: 27-05-2021
********************************************************************************************/
BEGIN
CREATE TABLE #CONTRACTPRODUCTS
	(
		ContractId		INT,
		Prdid			INT,
		DiscountType    INT,
		Discount		NUMERIC(18,2),
		FlatAmount		NUMERIC(18,6),
		SpecialPrice	NUMERIC(18,6),
		ApplyOn         INT,
		WithTax			INT,
		UomCode			VARCHAR(15),
		PRDCCODE		VARCHAR(100)
	)
	CREATE TABLE #CONTRACTDETAILS
	(
		ContractId		INT,
		RTRCODE			VARCHAR (50),
		Prdid			INT,
		DiscountType    INT,
		Discount		NUMERIC(18,2),
		FlatAmount		NUMERIC(18,6),
		SpecialPrice	NUMERIC(18,6),
		ApplyOn         INT,
		WithTax			INT,
		AllowDisc		INT,
		UomCode			VARCHAR(15),
		PRDCCODE		VARCHAR(100)
	)
	
	IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='SFACONTRACTDETAILSFINAL' AND TYPE='U')
	BEGIN
		CREATE TABLE SFACONTRACTDETAILSFINAL
	(
		ContractId		INT,
		RTRCODE			VARCHAR (50),
		Prdid			INT,
		prdbatid		INT,
		sellrate		NUMERIC(18,2),
		MRP				NUMERIC(18,6),
		UomCode			VARCHAR(15),
		PRDCCODE		VARCHAR(100)
	)
	END

	SELECT * INTO #RetailerCategory FROM RetailerCategory (nolock)
	SELECT * INTO #RetailerValueClass FROM RetailerValueClass (nolock)

	TRUNCATE TABLE SFACONTRACTDETAILSFINAL	
	SELECT DISTINCT P.PRDID,PB.prdbatid,PrdCtgValMainId into #TempPriceDt 
	 FROM Product P (NOLOCK) 
	INNER JOIN ProductBatch PB(NOLOCK)	ON P.PrdId=PB.PrdId  
	INNER JOIN Fn_SFAProductToSend() B ON P.PrdId=B.PrdId
	INNER JOIN ProductBatchLocation PBL (NOLOCK) ON P.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	AND P.PrdStatus=1 AND PB.Status=1 
	
	INSERT INTO #CONTRACTPRODUCTS
	SELECT DISTINCT A.contractid,E.Prdid,AllowDiscount,Discount,FlatAmtDisc,SpecialPrice,ApplyOn,WithTax,UM.UomCode,P.PRDCCODE
	FROM contractpricingmaster A(NOLOCK)
	INNER JOIN ContractPricingDetails B(NOLOCK) ON A.ContractId=b.ContractId
	INNER JOIN #TempPriceDt E On E.Prdid = B.Prdid
	INNER JOIN Product P (NOLOCK) ON P.PrdId=E.PrdId   AND P.PrdId=B.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	WHERE A.Status=1 AND CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN A.ValidFromDate AND A.ValidTillDate AND DisplayMode=1  
	
	INSERT INTO #CONTRACTPRODUCTS
	SELECT DISTINCT A.contractid,E.PrdId,AllowDiscount,Discount,FlatAmtDisc,SpecialPrice,ApplyOn,WithTax,UM.UomCode,P.PRDCCODE
	FROM contractpricingmaster A(NOLOCK)
	INNER JOIN ContractPricingDetails B(NOLOCK) ON A.ContractId=b.ContractId
	INNER JOIN ProductCategoryValue C(NOLOCK) ON  C.PrdCtgValMainId=B.PRDID
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE CAST(c.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN  #TempPriceDt  E On D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN Product P (NOLOCK) ON P.PrdId=E.PrdId   
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	WHERE DisplayMode=1  AND A.Status=1 AND CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN A.ValidFromDate AND A.ValidTillDate 
	
	--Return Contract Price Id if set at Retailer Level
	INSERT INTO #CONTRACTDETAILS
	SELECT  MAX(R.ContractId),RE.CmpRtrCode,Prdid,AllowDiscount,Discount,FLATAMOUNT,SpecialPrice,ApplyOn,WithTax,AllowDiscount,UomCode,PRDCCODE
	FROM Contractpricingmaster R  (nolock)
	INNER JOIN ContractPricingAttributes CA (nolock) ON CA.ContractId=R.ContractId
	INNER JOIN #CONTRACTPRODUCTS C ON R.ContractId=C.ContractId AND C.ContractId=CA.ContractId
	INNER JOIN Retailer RE (nolock) on RE.RtrId=CA.Attrid AND AttrType=2		
	WHERE  RtrLevel=1 AND Status=1 AND CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN ValidFromDate AND ValidTillDate
	GROUP BY Prdid,AllowDiscount,Discount,FLATAMOUNT,SpecialPrice,ApplyOn,WithTax,RE.CmpRtrCode,UomCode,PRDCCODE
	
	SELECT CP.contractid,RC.ctgcode,AllowDiscount into #Contractbak
	FROM ContractPricingMaster CP (nolock) INNER JOIN ContractPricingAttributes CA (nolock) ON CP.ContractId=CA.ContractId AND ATTRTYPE=1
		INNER JOIN #RetailerCategory RC ON RC.CtgMainId=CASE CA.Attrid WHEN 0 THEN RC.CtgMainId ELSE CA.Attrid END 
		INNER JOIN #RetailerCategory RC1 ON RC1.CtgLinkCode LIKE CAST(RC.CtgLinkCode AS NVARCHAR(1000)) + '%'
		INNER JOIN #RetailerValueClass RVC ON RVC.CtgMainId=RC1.CtgMainId 
		INNER JOIN RetailerValueClassMap RVCM (nolock) ON RVCM.RtrValueClassId=RVC.RtrClassId AND RVCM.RtrValueClassId=CASE CP.RtrClassId WHEN 0 THEN RVCM.RtrValueClassId ELSE CP.RtrClassId END
		INNER JOIN RETAILER R (nolock) ON R.RtrId=RVCM.RtrId
		WHERE  CP.Status=1 AND CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN CP.ValidFromDate AND CP.ValidTillDate
			  AND CP.RtrLevel = 0


		INSERT INTO #CONTRACTDETAILS
		SELECT  MAX(CP.ContractId),CP.CTGCODE,cpd.Prdid,AllowDiscount,Discount,FLATAMOUNT,SpecialPrice,ApplyOn,WithTax,AllowDiscount,UomCode,PRDCCODE
		FROM #Contractbak CP
		INNER JOIN #CONTRACTPRODUCTS CPD ON CP.ContractId= CPD.ContractId 
		GROUP BY cpd.Prdid,AllowDiscount,Discount,FLATAMOUNT,SpecialPrice,ApplyOn,WithTax,CP.CTGCODE,UomCode,PRDCCODE
		

		INSERT INTO SFACONTRACTDETAILSFINAL
		SELECT ContractId,rtrcode,prdid,prdbatid,DISCOUNT AS sellrate,MRP,UomCode,PRDCCODE
			FROM 
			(SELECT prdid,ContractId,prdbatid,RTRCODE,UomCode,PRDCCODE,
			CASE ApplyOn WHEN 1 THEN CAST(DISCOUNT*100/(100+TaxPercentage) AS NUMERIC(38,6))
						 WHEN 2 THEN CAST(DISCOUNT*100/(100+TaxPercentage) AS NUMERIC(38,6))
						 WHEN 3 THEN DISCOUNT 
						 WHEN 0 THEN DISCOUNT END DISCOUNT,
			0 SpecialPrice,MRP
			FROM 
			 (
			 SELECT P.prdid prdid,PB.prdbatid prdbatid,ContractId,RTRCODE,UomCode,PRDCCODE,(CASE AllowDisc WHEN 1 THEN 
												(CASE ApplyOn WHEN 1 THEN (PBD.PrdBatDetailValue*100/(100+Discount))
												WHEN 2 THEN PBD.PrdBatDetailValue-(PBD.PrdBatDetailValue*(Discount/100))	
												ELSE PBD.PrdBatDetailValue-(PBD.PrdBatDetailValue*(Discount/100))  END)			
								ELSE PBD.PrdBatDetailValue-(PBD.PrdBatDetailValue*(Discount/100)) END) AS Discount,
								TaxPercentage,PBD.PrdBatDetailValue Rate,ApplyOn,PBD1.PrdBatDetailValue MRP
			FROM #CONTRACTDETAILS P(NOLOCK) 
			INNER JOIN ProductBatch PB(NOLOCK) ON P.Prdid=PB.PrdId 
			INNER JOIN #TempPriceDt DT ON P.Prdid=DT.PrdId AND PB.PrdBatId=DT.Prdbatid
			INNER JOIN ProductBatchDetails PBD(NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.DefaultPrice =1
			INNER JOIN BatchCreation BC (NOLOCK) ON BC.SlNo=PBD.SLNo AND BC.SLNo=CASE P.AllowDisc	WHEN 0 THEN 3
																									WHEN 1 THEN 1
																									WHEN 2 THEN 2
																									WHEN 3 THEN 3 END
			INNER JOIN ProductBatchTaxPercent PT ON PT.PrdId=P.Prdid AND PT.PrdBatId=PB.PrdBatId 
			INNER JOIN ProductBatchDetails PBD1 (NOLOCK) ON PBD1.PrdBatId=PB.PrdBatId AND PBD1.DefaultPrice =1 AND PBD1.SLNo=1
			)A
			)B
			SELECT MAX(contractid) contractid,PRDID INTO #TEMP FROM SFACONTRACTDETAILSFINAL
			GROUP BY PRDID
			--SELECT * FROM SFACONTRACTDETAILSFINAL
			DELETE FROM SFACONTRACTDETAILSFINAL WHERE ContractId NOT IN (SELECT CONTRACTID FROM #TEMP)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='DwnClmDate' AND Object_id = Object_ID('TradeSchemeFactors'))
BEGIN
	ALTER TABLE TradeSchemeFactors ADD DwnClmDate DATETIME
END
GO
IF EXISTS (SELECT * FROM SYsOBJECTS WHERE NAME ='Proc_Cn2Cs_TradeSchemeFactors' AND XTYPE ='P')
DROP PROCEDURE Proc_Cn2Cs_TradeSchemeFactors
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_TradeSchemeFactors  0
select *from Cn2Cs_Prk_TradeSchemeFactors
SELECT * FROM TradeSchemeFactors
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_TradeSchemeFactors
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_TradeSchemeFactors
* PURPOSE		: 
* CREATED		: S.MOHANA
* CREATED DATE	: 12-11-2019
* PMS NO		: CRCRSTNES0028
*********************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  
	 
	DELETE FROM Cn2Cs_Prk_TradeSchemeFactors WHERE DownLoadFlag='Y'
	SELECT CmpSchCode ,Max(CreatedDate) MaxDate INTO #MaxDet FROM Cn2Cs_Prk_TradeSchemeFactors WHERE DownloadFlag='D' 
	GROUP BY CmpSchCode 
	SELECT A.* INTO #Cn2Cs_Prk_TradeSchemeFactors FROM Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN #MaxDet B ON A.CmpSchCode=B.CmpSchCode AND A.CreatedDate =B.MaxDate 
	WHERE DownloadFlag='D'
	
	IF NOT EXISTS(SELECT 'X' FROM #Cn2Cs_Prk_TradeSchemeFactors (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END  
	CREATE TABLE #ToAvoid
	(
		Cmpschcode NVARCHAR(50)
	)
	
	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchemeMaster )
	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_TradeSchemeFactors','SchemeCode',CmpSchCode + 'is Not available in Schememaster'
	FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchemeMaster )
	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE ((L2MPrimarySales IS NULL ) OR (L4WPrimarySales IS NULL) OR(CapAmount IS NULL))
	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_TradeSchemeFactors','SchemeCode',CmpSchCode + 'NULL Values Not Allowed'
	FROM #Cn2Cs_Prk_TradeSchemeFactors  WHERE ((L2MPrimarySales IS NULL ) OR (L4WPrimarySales IS NULL) OR(CapAmount IS NULL))
	
	DELETE A FROM TradeSchemeFactors A INNER JOIN #Cn2Cs_Prk_TradeSchemeFactors B ON A.CmpSchCode = B.CmpSchCode 
	WHERE DownloadFlag ='D' AND A.CmpSchCode NOT IN (SELECT CmpSchCode FROM #ToAvoid )
	
	INSERT INTO TradeSchemeFactors(Schid,CmpSchCode,L2MPrimarySales,L4WPrimarySales,CapAmount,ClaimDate,DownloadedDate,DwnClmDate)
	SELECT DISTINCT Schid,B.CmpSchCode,L2MPrimarySales,L4WPrimarySales,CapAmount,B.OrgFromDate,A.CreatedDate,A.ClaimDate--- OrgFromDate for Claimdate  PMS NO : PARLECS/0621/044
	FROM #Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode 
	WHERE DownloadFlag ='D' AND A.CmpSchCode NOT IN (SELECT CmpSchCode FROM #ToAvoid )
	 
	UPDATE A SET DownloadFlag ='Y' FROM Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN TradeSchemeFactors B ON A.CmpSchCode = B.CmpSchCode 
	AND DownloadFlag ='D'
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_TOTClaimDetails_NEW' AND TYPE='P')
DROP PROCEDURE Proc_TOTClaimDetails_NEW
GO
--EXEC [Proc_TOTClaimDetails_NEW] 2021,5,0,0
CREATE PROCEDURE Proc_TOTClaimDetails_NEW
(
	@Pi_Year	INT,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_TOTClaimDetails
* PURPOSE	:  TO LOAD TOT CLAIM DETAILS
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
**********************************************************************************************************************
* 24-03-2020	MOHANA S     CR   PARCS202100002	Contract Pricing Optimization
* 31-08-2020	MOHANA S	 SR	  PARLECS/0820/331	Removed GT & SUBWS
* 01-07-2021	MOHANA S	 BZ						DUPLICATE CIRCULAR DOWNLOAD FROM CONSOLE
**********************************************************************************************************************/
BEGIN
SET NOCOUNT ON
	CREATE Table #TotClaimFinal       
	(      
	CtgName		NVARCHAR(100),
	Rtrid		INT,
	Prdid		INT,      
	Fromdate	DATETIME,      
	Todate		DATETIME,      
	NrmlRate	NUMERIC (18,2),      
	SecSalesTot NUMERIC (18,2),      
	DiffClaims	NUMERIC (18,2)       
	)
	DELETE FROM  TempTOTClaimDetails  
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
			 
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate 
			     
	SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)    
			
	--SELECT PRDBATID INTO #PRDBATID FROM (
	--SELECT PrdBatid FROM SalesInvoice S (NOLOCK) INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	--UNION
	--SELECT PrdBatid FROM ReturnHeader S (NOLOCK) INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0
	--)A
	--SELECT * INTO #ProductBatchDetails FROM ProductBatchDetails WHERE PrdBatid in (SELECT * FROM #PrdBatid) and slno=3
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.SplRate END As  SalSplRate,         
	SP.OrgSelRate AS ActualSelRate,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate ,RtrValueClassId        
	INTO #BillingDetails1          
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3  
			
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SIP.SplRate END As  SalSplRate,         
	SIP.OrgSelRate AS ActualSelRate,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,RtrValueClassId         
	INTO #ReturnDetails1          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)  
	INNER JOIN SalesInvoiceProduct SIP ON S.SAlid = SIP.SalId AND SP.PrdId = SIP.PrdId AND SP.PrdBatId = SIP.PrdBatId AND SIP.SLno = SP.ActSalRowId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0  
			
	SELECT DISTINCT R.RtrId,RC.CtgMainId,CtgCode,RC.CtgName,RtrValueClassId       
	INTO #Retailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId 	     
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
			
	SELECT tranid,Refid,Rtrid,CtgName,RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate, ActualSelRate SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno      
	INTO #TotClaim FROM(      
	SELECT 1 tranid,Salid Refid,A.Rtrid,CtgName,Salinvdate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid  --and A.RtrValueClassId = B.RtrValueClassId 
	UNION       
	SELECT 2 Transid,ReturnID Refid,A.Rtrid,CtgName,ReturnDate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid    --and A.RtrValueClassId = B.RtrValueClassId     
	)A   
	--SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM      
	--(      
	--SELECT D.PriceId,D.PrdBatDetailValue       
	--FROM #TotClaim M (NOLOCK),      
	--#ProductBatchDetails D (NOLOCK)       
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	--AND PriceCode LIKE '%-Spl Rate-%'         
	--UNION       
	--SELECT D.PriceId,D.PrdBatDetailValue       
	--FROM #TotClaim M (NOLOCK),      
	--#ProductBatchDetails D (NOLOCK)       
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	--AND PriceCode LIKE '%SplRate%'        
	--)A 
	UPDATE A SET A.SplRate = (BaseQty*((A.SalSplRate)+(A.SalSplRate*(p.TaxPerc/100)))) FROM  #TotClaim A 
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate <>0  
	UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate =0
	UPDATE A SET A.NrmlRate = (BaseQty*(( ActualSelRate)+(ActualSelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid 
	UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim A    
			
	SELECT DISTINCT  B.CtgName,AttrCode ,MAX(CREATEDDATE) CREATEDDATE INTO #MAXDATE FROM SchemeClaimCircular A --WHERE  
	INNER JOIN RetailerCategory B ON A.AttrCode = B.CtgCode AND A.AttrType<>'Class'
	INNER JOIN #Retailer R ON B.CtgCode=R.CtgCode AND A.AttrCode = R.CtgCode
	AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
		WHERE ClaimType='TOT Claim' GROUP BY B.CtgName,AttrCode
	SELECT CtgName,CircularNo INTO #CIRCULAR FROM SchemeClaimCircular A INNER JOIN #MAXDATE B ON A.AttrCode = B.AttrCode AND A.CreatedDate =B.CREATEDDATE 
			  
	 
	SELECT B.CtgName INTO #Remove FROM RetailerCategory A INNER JOIN RetailerCategory B ON A.CtgMainId = B.CtgLinkID
	AND A.CtgCode IN ('GT','SUBWS') AND B.CtglevelId=2
	 
	DELETE FROM #TotClaim WHERE CtgName IN (SELECT CtgName FROM #Remove) 
	INSERT INTO #TotClaimFinal(CtgName,Rtrid,Prdid,NrmlRate,SecSalesTot,DiffClaims)      
	SELECT CtgName,Rtrid,Prdid,SUM(NrmlRate),SUM(SplRate),SUM(Diff) FROM #TotClaim      
	GROUP BY Ctgname,Rtrid,Prdid
			
	UPDATE A SET Fromdate = B.Frmdt ,Todate = B.todt FROM #TotClaimFinal A  
	INNER JOIN (SELECT Ctgname,MIn(RefDate) Frmdt,Max(RefDate) todt FROM #TotClaim GROUP BY CtgName) B ON A.CtgName = B.Ctgname    
			
	INSERT INTO TempTOTClaimDetails       
	SELECT CtgName,Rtrid,Prdid,Fromdate,Todate,'',SUM(NrmlRate),SUM(SecSalesTot),SUM(DiffClaims),@Pi_Usrid,@Pi_Transid
	FROM #TotClaimFinal
	WHERE DiffClaims > 0   -- SHOWING ONLY +VE VALUE AS PER AWINASH REQUEST ON 19-12-2019
	GROUP BY CtgName,Rtrid,Prdid,Fromdate,Todate

		
	--;WITH Duplicates AS 
	--(
	--SELECT CtgName,ROW_NUMBER() OVER( PARTITION BY CtgName ORDER BY CtgName DESC) AS OrderID
	--FROM #CIRCULAR
	--)
	--DELETE Duplicates
	--WHERE OrderID > 1


	--UPDATE A SET A.CirNO = ISNULL(CircularNo,'') FROM TempTOTClaimDetails A  
	--INNER JOIN #CIRCULAR B ON A.CtgName = B.CTGNAME

	SELECT Ctgname,Max(CircularNO) CirNO INTO #FinalCirNo FROM #CIRCULAR GROUP BY CtgName


	UPDATE A SET A.CirNO = ISNULL(B.CirNO,'') FROM TempTOTClaimDetails A  
	INNER JOIN #FinalCirNo B ON A.CtgName = B.CTGNAME
			
			
	DELETE FROM TempTOTClaimDetails WHERE ISNULL(CirNo,'')=''
	SELECT CtgName,Fromdate,Todate,SUM(NrmlAmt),SUM(TOTAmt),SUM(DiffAmt) FROM TempTOTClaimDetails
	GROUP BY CtgName,Fromdate,Todate
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_UpdateStatusRteSalRetailer')
DROP PROCEDURE Proc_UpdateStatusRteSalRetailer
GO
--EXEC Proc_UpdateStatusRteSalRetailer ''
CREATE PROCEDURE Proc_UpdateStatusRteSalRetailer
(
	@ServerDate DATETIME
)
AS
/*******************************************************************************************
* FUNCTION : Proc_UpdateStatusRteSalRetailer
* PURPOSE  : Create New Price 
* NOTES    : 
* CREATED  : MarySubashini.S PARLECS/0421/312 
* MODIFIED 
 * DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
 * 29/04/2021	MarySubashini.S		SR		PARLECS/0421/312        Route/Retailer/Salesman Acive/Inactive
 * 28/07/2021	MarySubashini.S		SR		PL-I302                 Inactive retailer baased on Regdate
********************************************************************************************/
SET NOCOUNT ON
BEGIN
	

		DECLARE @ChkDate AS DATETIME
		SET @ChkDate = ISNULL((SELECT ISNULL(NextUpDate,GETDATE()) FROM DayEndProcess WHERE ProcId = 27),GETDATE()-1)
		 
		IF  CONVERT(VARCHAR(10),GETDATE(),121) >= CONVERT(VARCHAR(10),@ChkDate,121) 
		BEGIN
			UPDATE DayEndProcess SET NextUpDate = CONVERT(VARCHAR(10),GetDate()+30,121),    
			ProcDate = CONVERT(VARCHAR(10),GetDate()+30,121)    
			WHERE ProcId = 27
		END
		ELSE
		BEGIN
			RETURN
		END

	DECLARE @FromDate AS DATETIME
	DECLARE @ToDate AS DATETIME
	DECLARE @ToDate1 AS DATETIME
	DECLARE @FromDate1 AS DATETIME

	DECLARE @JcSdt1 AS DATETIME
	DECLARE @JcSdt2 AS DATETIME

	SELECT @JcSdt1=CONVERT(VARCHAR(10),JcmSdt-1,121) FROM JCMonth WHERE DATEADD(D,-90,CONVERT(VARCHAR(10),GETDATE(),121))
	BETWEEN JcmSdt AND JcmEdt
	SELECT @JcSdt2=CONVERT(VARCHAR(10),JcmEdt,121) FROM JCMonth WHERE @JcSdt1  BETWEEN JcmSdt AND JcmEdt

	IF EXISTS (SELECT 'X' FROM JcMonthEnd WHERE  @JcSdt2  BETWEEN JcmSdt AND JcmEdt AND Status=1)
	BEGIN
		SELECT  @FromDate=CONVERT(VARCHAR(10),JcmMontEnddate,121) FROM JcMonthEnd WHERE  @JcSdt2  BETWEEN JcmSdt AND JcmEdt
		AND Status=1
	END
	ELSE
	BEGIN
		SELECT  @FromDate=CONVERT(VARCHAR(10),JcmMontEnddate,121) FROM JcMonthEnd WHERE 
		 CONVERT(VARCHAR(10),JcmMontEnddate,121)=(SELECT MAX(CONVERT(VARCHAR(10),JcmMontEnddate,121)) FROM  JcMonthEnd WHERE Status=1)
	END

	SET @ToDate= DATEADD(D,90,CONVERT(VARCHAR(10),@FromDate,121))

	IF @ToDate >=CONVERT(VARCHAR(10),GETDATE(),121)
	BEGIN
		SET @ToDate1=CONVERT(VARCHAR(10),@ToDate+1,121)
		SET @FromDate1= CONVERT(VARCHAR(10),@ToDate+1,121)
	END
	ELSE
	BEGIN
		SET @FromDate1=CONVERT(VARCHAR(10),@ToDate+1,121)
		SET @ToDate1= CONVERT(VARCHAR(10),GETDATE(),121)
	END
	 
	---select @FromDate1,@ToDate,@ToDate1,@FromDate
	--Route Inactive

	SELECT  RMId,RMCode INTO #RMIDS FROM RouteMaster WHERE RMStatus=1 AND RMId NOT IN (
	SELECT DISTINCT RMId FROM Retailer (NOLOCK) WHERE RtrStatus=1 
	UNION SELECT DISTINCT A.RMId FROM RetailerMarket A (NOLOCK) INNER JOIN Retailer B (NOLOCK) ON A.RtrId=B.RtrId WHERE B.RtrStatus=1)

	DELETE FROM #RMIDS WHERE RMId IN (SELECT RMID FROM RouteMaster (NOLOCK) WHERE RMCode LIKE '%Dummy%')

	INSERT INTO MasterInactiveDetails (MasterType,MasterId,MasterCode,InactiveDate)
	SELECT DISTINCT 1,RMId,RMCode,GETDATE() FROM #RMIDS

	UPDATE A SET RMStatus=0 FROM RouteMaster A INNER JOIN #RMIDS B ON A.RMId=B.RMID 
	WHERE A.RMStatus=1 
	--Route Inactive

	---Salesman Inactive

	SELECT  A.SMId,A.SMCode INTO #SMIDS  FROM Salesman A (NOLOCK) 
	WHERE Status=1 AND SMId NOT IN (SELECT SMId FROM SalesmanMarket (NOLOCK))

	DELETE FROM #SMIDS WHERE SMId IN (SELECT SMId FROM Salesman (NOLOCK) WHERE SMCode LIKE '%Dummy%')

	INSERT INTO MasterInactiveDetails (MasterType,MasterId,MasterCode,InactiveDate)
	SELECT DISTINCT 2,SMId,SMCode,GETDATE() FROM #SMIDS

	UPDATE A SET A.Status=0  FROM Salesman A (NOLOCK) INNER JOIN #SMIDS B ON A.SMId=B.SMId
	WHERE A.Status=1  

	SELECT SMId,SUM(ActRteCnt) ActRteCnt,SUM(InActRteCnt) InActRteCnt INTO #Salesman FROM (
	SELECT A.SMId,COUNT(B.RMId) AS ActRteCnt,0 AS InActRteCnt FROM Salesman A (NOLOCK)
	INNER JOIN SalesmanMarket B (NOLOCK) ON A.SMId=B.SMId
	INNER JOIN RouteMaster C (NOLOCK) ON C.RMId=B.RMId 
	WHERE C.RMstatus=1 AND A.Status=1  GROUP BY A.SMId UNION ALL
	SELECT A.SMId,0 AS ActRteCnt,COUNT(B.RMId) AS InActRteCnt FROM Salesman A (NOLOCK)
	INNER JOIN SalesmanMarket B (NOLOCK) ON A.SMId=B.SMId
	INNER JOIN RouteMaster C (NOLOCK) ON C.RMId=B.RMId 
	WHERE C.RMstatus=0 AND A.Status=1  GROUP BY A.SMId  ) A GROUP BY SMId

	DELETE FROM #Salesman WHERE SMId IN (SELECT SMId FROM Salesman WHERE SMCode LIKE '%Dummy%')

	INSERT INTO MasterInactiveDetails (MasterType,MasterId,MasterCode,InactiveDate)
	SELECT 2,A.SMId,A.SMCode,GETDATE()  FROM Salesman A (NOLOCK) 
	INNER JOIN #Salesman B ON A.SMId=B.SMId AND B.ActRteCnt=0 AND A.Status=1 

	UPDATE A SET A.Status=0  FROM  Salesman A (NOLOCK) 
	INNER JOIN #Salesman B ON A.SMId=B.SMId AND B.ActRteCnt=0 AND A.Status=1 
	---Salesman Inactive
	
	---Retailer Inactive
	SELECT A.RtrId INTO #RTRID FROM Retailer A (NOLOCK) 
	WHERE A.RtrStatus=1 AND NOT EXISTS (SELECT B.RtrId FROM 
	Salesinvoice B (NOLOCK) WHERE A.RtrId=B.RtrId 
	AND B.SalInvDate BETWEEN @FromDate AND @ToDate) 

	DELETE A FROM #RTRID A WHERE EXISTS (
	SELECT  B.RtrId FROM 
	Salesinvoice B (NOLOCK) WHERE A.RtrId=B.RtrId 
	AND B.SalInvDate BETWEEN @FromDate1 AND @ToDate1)

	DELETE FROM #RTRID WHERE RtrId IN (
	SELECT  AA.RtrId FROM RetailerValueClassMap AA INNER JOIN RetailerValueClass A ON AA.RtrValueClassId=A.RtrClassId
		INNER JOIN RetailerCateGory B (NOLOCK) ON A.CtgMainId=B.CtgMainId
		INNER JOIN RetailerCateGory C (NOLOCK) ON C.CtgMainId=B.CtgLinkId
		WHERE C.CtgName='ONLINE AGGREGATOR')

	DELETE FROM #RTRID WHERE RtrId IN (SELECT RtrId FROM Retailer WHERE RtrCode LIKE '%Dummy%')
	DELETE FROM #RTRID WHERE RtrId IN (SELECT RtrId FROM Retailer WHERE RtrRegDate>=@FromDate) ---PL-I302
 
	INSERT INTO MasterInactiveDetails (MasterType,MasterId,MasterCode,InactiveDate)
	SELECT 3,A.RtrId,A.RtrCode,GETDATE() FROM Retailer A (NOLOCK) 
	INNER JOIN #RTRID B ON A.RtrId=B.RtrId
	WHERE A.RtrStatus=1  

	UPDATE A SET A.RtrStatus=0,A.Upload='N' FROM Retailer A (NOLOCK) 
	INNER JOIN #RTRID B ON A.RtrId=B.RtrId
	WHERE A.RtrStatus=1 

	DELETE A FROM RetailerApprovalStatus A  INNER JOIN #RTRID B ON A.RtrId=B.RtrId
	---Retailer Inactive

	--EXEC Proc_UpdateStatusRteSalRetailer ''

	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Export_CS2WS_PricingPlan' AND TYPE='P')
DROP PROCEDURE Proc_Export_CS2WS_PricingPlan
GO
--EXEC Proc_Export_CS2WS_PricingPlan '1'
CREATE PROCEDURE Proc_Export_CS2WS_PricingPlan
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_PricingPlan
* PURPOSE		: To Export Product Price details to the PDA Intermediate Database
* CREATED		: S.Moorthi
* CREATED DATE	: 07/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
* 04/08/2018   S.Moorthi    CR         CRCRSTPAR0017      SFA-Upload-Download Integration --Product
* 29/11/2018   S.Moorthi    SR         ILCRSTPAR2692      0 price moved to SFA Application from Sehyog .
* 06-01-2020   S.Mohana		SR		   ILCRSTPAR7270      Date not considered in upload (As per Discussion With Awinash & Nilesh)
* 27-05-2021   Deepak Philip SR        PARLECS/0521/182   Pring plan functionality changed as per billing.
* 02-08-2021   Mohana S		 BZ		   PARLECS/0721/266   Corrected the Selling rate
********************************************************************************************/
BEGIN
DECLARE @DistCode NVARCHAR(40)
DECLARE @Prdid AS int
DECLARE @Prdbatid AS int
	
	DELETE FROM Export_CS2WS_PricingPlan 
	
	SELECT @DistCode = DistributorCode FROM Distributor

	EXEC PROC_ReturnSplDiscountForSFA
	
	--CREATE TABLE #Export_CS2WS_PricingPlan
	--(
	--	PrdID				[Bigint],
	--	TenantCode   [nvarchar](25) COLLATE DATABASE_DEFAULT,  
	--	PricingCode   [nvarchar](25)COLLATE DATABASE_DEFAULT,  
	--	PricingDescription [nvarchar](25)COLLATE DATABASE_DEFAULT,  
	--	StartDate   [Datetime],  
	--	EndDate    [Datetime],  
	--	ItemCode   [nvarchar](100)COLLATE DATABASE_DEFAULT,  
	--	UnitsOfMeasure  [nvarchar](20)COLLATE DATABASE_DEFAULT,   
	--	DebitPrice   [Float],  
	--	CreditPrice			[Float],
	--	DamagePrice			[Float],
	--	PriceId				[BIGINT]
	--)
	
	--SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	--RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	--INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	--INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	--INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	--INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	--SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	--INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	--INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	--WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	--GROUP BY PBL.PrdId,PBL.PrdBatId
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,R.CmpRtrCode,R.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(B.PriceId) as PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId 
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.RtrId<>0
	--GROUP BY P.PrdId,R.CmpRtrCode,R.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	--SELECT DISTINCT PricingCode into #PricingCode from #Export_CS2WS_PricingPlan
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,T.CmpRtrCode,T.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(b.PriceId) as PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	--inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	--inner join #PricingCode E (NOLOCK) ON E.PricingCode=T.CmpRtrCode	
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.CtgMainId<>0 AND 
	--NOT EXISTS(SELECT * FROM #Export_CS2WS_PricingPlan EB INNER JOIN Product P (nolock) ON P.PrdCCode=EB.ItemCode 
	--WHERE EB.PricingCode=T.CmpRtrCode AND EB.Prdid=P.PrdId AND EB.Prdid=FP.PrdId AND EB.Prdid=B.PrdId 
	--AND EB.PricingCode=E.PricingCode)
	--GROUP BY P.PrdId,T.CmpRtrCode,T.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	--INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	--SELECT P.PrdId,@DistCode,R.CtgCode,R.CtgCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	--P.PrdCCode,UM.UomCode,0,0,0,MAX(PriceId) As PriceId
	--FROM ContractPricingMaster A (NOLOCK)
	--INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	--INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	--INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	--INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId   AND TP.PrdId=P.PrdId 
	--INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	--INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	--INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	--INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	--WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	--AND A.[Status]=1 AND A.CtgMainId<>0 --and PrdCCode ='100301301041444012144PKT005N' and CtgCode  ='IRCTC WZ'
	--GROUP BY P.PrdId,R.CtgCode,R.CtgCode,--A.ValidFromDate,A.ValidTillDate,  
	--P.PrdCCode,UM.UomCode
	
	
	
	----SELECT A.PrdID,Max(PB.PrdBatId) AS PrdBatId	INTO #TempProductBatch FROM #Export_CS2WS_PricingPlan A 
	----INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdID=PB.PRDID
	----WHERE  PrdBatCode <> 'Sample Batch' GROUP BY A.PrdID
	----SELECT DISTINCT P.PrdID,PB.PrdBatId,B1.PrdBatDetailValue as SellRate 
	----INTO #TempPriceDt
	----FROM Product P (NOLOCK)
	----INNER JOIN ProductBatch PB(NOLOCK) ON P.PrdID = PB.PrdID	
	----INNER JOIN #TempProductBatch PB1(NOLOCK) ON P.PrdID = PB1.PrdID AND PB.PrdBatId=PB1.PrdBatId AND PB.PrdID = PB1.PrdID
	----INNER JOIN ProductBatchDetails B1 (NOLOCK) ON PB.PrdBatId = B1.PrdBatID AND B1.DefaultPrice=1
	----INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = PB.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	----ORDER BY P.PrdId
	
	
	--UPDATE PP SET PP.DebitPrice=B1.PrdBatDetailValue,PP.CreditPrice=B1.PrdBatDetailValue,PP.DamagePrice=B1.PrdBatDetailValue
	--FROM Product P (NOLOCK)
	--INNER JOIN #Export_CS2WS_PricingPlan PP ON P.PrdId=PP.PrdID 
	--INNER JOIN ProductBatchDetails B1 (NOLOCK) ON B1.PriceId=PP.PriceId
	--INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = B1.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	
	----As discussed Mr. Awanish to remove duplicate based on Max start date
	--SELECT PricingCode,ItemCode INTO #TempDuplicate FROM #Export_CS2WS_PricingPlan 
	--GROUP BY PricingCode,ItemCode HAVING COUNT(ItemCode)>1
	--SELECT A.PricingCode,A.ItemCode,MAX(A.StartDate) AS StartDate INTO #TempMaxStartDate FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN #TempDuplicate B ON A.PricingCode=B.PricingCode AND A.ItemCode=B.ItemCode 
	--GROUP BY A.PricingCode,A.ItemCode
	
	--DELETE A FROM #Export_CS2WS_PricingPlan A (NOLOCK)
	--INNER JOIN #TempMaxStartDate B ON A.ItemCode=B.ItemCode AND A.PricingCode=B.PricingCode 
	--WHERE NOT EXISTS(SELECT * FROM #TempMaxStartDate M WHERE M.PricingCode=A.PricingCode AND M.ItemCode=A.ItemCode AND 
	--M.StartDate=A.StartDate)
		
	--UPDATE A SET A.DebitPrice=B.SellRate,A.CreditPrice=B.SellRate,A.DamagePrice=B.SellRate 
	--FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN #TempPriceDt B ON A.PrdID=B.PrdId and A.PricingCode=
	
	--INSERT INTO Export_CS2WS_PricingPlan(TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	--ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,UploadFlag)
	--SELECT DISTINCT TenantCode,PricingCode,PricingDescription,''StartDate,''EndDate,ItemCode,UnitsOfMeasure, --ILCRSTPAR7270
	--DebitPrice,CreditPrice,DamagePrice,'N' UploadFlag FROM #Export_CS2WS_PricingPlan ORDER BY ItemCode
	

	--SELECT  Distinct
	--		TenantCode,
	--		PricingCode,
	--		PricingDescription,
	--		--CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
	--		--CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
	--		ItemCode,
	--		UnitsOfMeasure,
	--		DebitPrice,
	--		CreditPrice,
	--		DamagePrice
	--	FROM Export_CS2WS_PricingPlan WITH (NOLOCK)
	
	
	INSERT INTO Export_CS2WS_PricingPlan(TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,UploadFlag)
	SELECT @DistCode,RTRCODE,RTRCODE,''StartDate,''EndDate,Prdccode,UomCode,Sellrate,Sellrate,Sellrate,'N' UploadFlag FROM SFACONTRACTDETAILSFINAL  ORDER BY Prdccode 
	
	--SELECT @DistCode,RTRCODE,RTRCODE,''StartDate,''EndDate,Prdccode,UomCode,MRP,MRP,Sellrate,'N' UploadFlag FROM SFACONTRACTDETAILSFINAL  ORDER BY Prdccode 

	SELECT  Distinct
			TenantCode,
			PricingCode,
			PricingDescription,
			--CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
			--CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
			ItemCode,
			UnitsOfMeasure,
			DebitPrice,
			CreditPrice,
			DamagePrice
		FROM Export_CS2WS_PricingPlan WITH (NOLOCK)
	
END
GO
--Script Updater Till Here
UPDATE UtilityProcess SET VersionId = '3.1.0.24' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.24',446
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 446)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(446,'D','2021-08-07',GETDATE(),1,'Core Stocky Service Pack 446')
GO