--[Stocky HotFix Version]=437
DELETE FROM Versioncontrol WHERE Hotfixid='437'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone) 
VALUES('437','3.1.0.14','D','2018-12-01','2018-12-01','2018-12-01',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: Product June 2018')
GO
/*
	Live Updater Script : Fn_LoadConsolePurchaseInvoice,Proc_Cs2Cn_SchemeStockReconsolidation
*/
--As per client Request Configuration Disable While Live Release
UPDATE A SET A.Status=0  FROM Configuration A WHERE ModuleId = 'BILL6' AND ModuleName='Billing'
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='SupportingFiles' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD SupportingFiles INT DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='CircularNo' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD CircularNo NVARCHAR(200) DEFAULT ('') WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='CircularDate' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD CircularDate DATETIME
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='ProposedLibPercent' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD ProposedLibPercent NUMERIC(8,4) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='TotalSales' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD TotalSales NUMERIC(18,4) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDetails' AND B.NAME='ActualLibPercent' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDetails ADD ActualLibPercent NUMERIC(8,4) DEFAULT 0 WITH VALUES
END
GO
--Added By S.Moorthi
DELETE FROM Configuration WHERE ModuleName = 'Month End Process' AND ModuleId='DAYMONTHEND1'
INSERT INTO Configuration(ModuleId,ModuleName,[Description],[Status],Condition,ConfigValue,SeqNo) 
SELECT 'DAYMONTHEND1','Month End Process','Enable Day and Month End Process',1,1,5,1
GO
DECLARE @LastMonEndDate AS DATETIME
SELECT @LastMonEndDate=JcmSdt FROM JCMonth WHERE 
jcmedt=DATEADD(D,-1,(SELECT JcmSdt FROM JCMonth WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN JcmSdt AND JcmEdt))
IF ISNULL(@LastMonEndDate,'')<>''
BEGIN
	UPDATE DayEndDates SET Status=1 WHERE DayEndStartDate<=DATEADD(D,-1,@LastMonEndDate)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_ValidateClaimMonthEndDate' AND XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_ValidateClaimMonthEndDate
GO
--SELECT DBO.Fn_ValidateClaimMonthEndDate('2018-09-01','2018-08-01','2018-08-30',1,1)
CREATE FUNCTION Fn_ValidateClaimMonthEndDate(@ServerDate AS DATETIME,@FromDate AS DATETIME,@ToDate AS DATETIME,
@ClmGrpId	BIGINT,@iMode AS INT)
RETURNS VARCHAR(500)
AS
/************************************************
* FUNCTION  : Fn_ValidateClaimMonthEndDate
* PURPOSE    : Return To Validate the Claim Top sheet Generation 
* CREATED BY : S.Moorthi
* CREATED ON : 21/06/2018
* MODIFICATION 
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  21/06/2018   S.Moorthi    CR         CRCRSTPAR0010   enable Month End process and the same should be 
													   called automatically on 06th of every month.
*************************************************/    
BEGIN
	DECLARE @ValidateMsg AS VARCHAR(500)
	DECLARE @MonthEndDt AS DATETIME
	DECLARE @JCMONTHDT AS DATETIME
	DECLARE @JCMONTHDT1 AS DATETIME
	SET @ValidateMsg=''
	
	IF @iMode<>1
	BEGIN
		RETURN @ValidateMsg
	END
	
	
	IF EXISTS(SELECT * FROM JCMonthEnd)
	BEGIN
		SELECT @MonthEndDt=MAX(JcmEdt) FROM JCMonthEnd
		IF @ToDate>@MonthEndDt
		BEGIN
			SET @ValidateMsg='Month end not completed for selected claim period,Claim should be allowed to process till '+CONVERT(VARCHAR(10),@MonthEndDt,105)
		END
	end
	ELSE
	BEGIN
		SELECT @JCMONTHDT=Jcmsdt FROM JCMonth WHERE @ServerDate BETWEEN JcmSdt AND JcmEdt 
		--SELECT @JCMONTHDT1=Jcmsdt FROM JCMonth WHERE dateadd(d,-1,@JCMONTHDT) BETWEEN JcmSdt AND JcmEdt 
		SET @MonthEndDt=dateadd(d,-1,@JCMONTHDT)
		--IF @FromDate>=@JCMONTHDT1
		IF @ToDate>@MonthEndDt
		BEGIN
			SET @ValidateMsg='Month end not completed for selected claim period,Claim should be allowed to process till '+CONVERT(VARCHAR(10),dateadd(d,-1,@MonthEndDt),105)
		END
	END
	
	IF @ClmGrpId=-1
	BEGIN
		if @ValidateMsg<>''
		BEGIN
			SET @ValidateMsg='Month end not completed for selected claim period,Special Discount Claim should not be allow to Save,allowed to process till '+CONVERT(VARCHAR(10),dateadd(d,-1,@MonthEndDt),105)
		END	
	END
	
RETURN @ValidateMsg
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='ManualClaimDescription' and xtype='U')
BEGIN
CREATE TABLE ManualClaimDescription
(
	RefId				BIGINT NOT NULL,
	ManualClmDesc		VARCHAR(500),
	ValidFromDate		DATETIME,
	ValidToDate			DATETIME,
	CircularNo			NVARCHAR(200),
	CircularDate		DATETIME,
	ProposedLibPer		NUMERIC(8,4),
	EffectiveFromDate	DATETIME,
	ActiveStatus		INT,
	CreatedDate			DATETIME	
)
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDescription' AND B.NAME='CircularNo' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDescription ADD CircularNo NVARCHAR(200) DEFAULT ('') WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDescription' AND B.NAME='CircularDate' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDescription ADD CircularDate DATETIME
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDescription' AND B.NAME='ProposedLibPer' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDescription ADD ProposedLibPer NUMERIC(8,4) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDescription' AND B.NAME='EffectiveFromDate' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDescription ADD EffectiveFromDate DATETIME
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.id=B.id 
WHERE A.NAME='ManualClaimDescription' AND B.NAME='ActiveStatus' AND a.xtype='U')
BEGIN
	ALTER TABLE ManualClaimDescription ADD ActiveStatus INT
END
GO
DELETE FROM CustomUpDownload WHERE UpDownload='Download' and Module='ManualClaimDescription'
INSERT INTO CustomUpDownload([SlNo],[SeqNo],[Module],[Screen],[ExportFnName],[ImportProcName],[ParkTable],[ValidateProcName],[TranType],[UpDownload],[MandatoryFile]) 
VALUES (273,1,'ManualClaimDescription','Manual Claim Description','','Proc_Import_ManualClaimDescription','Cn2Cs_Prk_ManualClaimDescription','Proc_Cn2Cs_ManualClaimDescription','Master','Download',1)
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName='ManualClaimDescription'
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount,CreatedDate)
SELECT 81,'ManualClaimDescription','Cn2Cs_Prk_ManualClaimDescription','Proc_Import_ManualClaimDescription',0,500,GETDATE()
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_ManualClaimDescription' AND XTYPE='U')
DROP TABLE Cn2Cs_Prk_ManualClaimDescription
GO
CREATE TABLE Cn2Cs_Prk_ManualClaimDescription(
	[DistCode] [varchar](100) NULL,
	[CircularNo] [nvarchar](100) NULL,
    [CircularDate] [datetime] NULL,
	[ManualClmDesc] [varchar](150) NULL,
	[ValidFromDate] [datetime] NULL,
	[ValidToDate] [datetime] NULL,
	[ProposedLibPer] [numeric](8, 4) NULL,
	[EffectiveFromDate] [datetime] NULL,
    [ActiveStatus] [Integer] NULL,
	[DownloadFlag] [varchar](1) NULL,
	[CreatedDate] [datetime] NULL
)
GO
DELETE FROM HotSearchEditorHd WHERE FormId=10210
INSERT INTO HotSearchEditorHd(FormId,FormName,ControlName,SltString,RemainsltString)
SELECT 10210,'Manual Claim','Description','Select','SELECT * FROM Fn_ReturnManualClmDesc(''vFParam'',''vSParam'',''vTParam'')'
GO
DELETE FROM HotSearchEditorDt WHERE FormId=10210 
INSERT INTO HotSearchEditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (2,10210,'Description','Description','ManualClmDesc',4520,0,'HotSch-104-2000-8',104)
GO
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=2000 AND CtrlName='HotSch-104-2000-8'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,2000,8,'HotSch-104-2000-8','Description','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Description','','',1,1)
GO
DELETE FROM CustomCaptions WHERE TransId=104 and CtrlId=17 AND SubCtrlId=6
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) 
VALUES (104,17,6,'DgManualClaim-104-17-6','Attach File','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Attach File','','',1,1)
GO
DELETE FROM ManualConfiguration WHERE ProjectName ='PARLE' AND ModuleId ='ManualClm1' 
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','ManualClm1','Manual Claim','Manual Claim Doc Attachment is Non mandatory',1,'',0,10
GO
IF NOT EXISTS(SELECT * FROM ManualConfiguration WHERE ProjectName ='PARLE' AND ModuleId ='ClaimSyncPath')
BEGIN
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','ClaimSyncPath','Manual Claim','Manual Claim Upload Sync Path',1,'http://sehyog.parle.biz/ParleClaimIntegration_Live/Pos2Console.asmx',0,11
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Proc_ClaimDataUpload' AND XTYPE='P')
DROP PROCEDURE Proc_ClaimDataUpload
GO
CREATE PROCEDURE Proc_ClaimDataUpload
(
	@TypeID INT,
	@ClmRefCode Varchar(200) = '',
	@LineclmRefCode Varchar(200) = '',
	@ImageName Varchar(Max) = ''
)

 --'/*        
 --   '***************************************************************************************************************************************************        
 --   '* DATE       AUTHOR      CR/BZ USER      STORY ID           DESCRIPTION                                  
 --   '***************************************************************************************************************************************************        
 --   '02/07/2018  Ramesh K        CR          CRCONSPAR0013     Attachment upload from Core Stocky and display Claim approval
 --   '*/  
As 
Begin
	BEGIN TRY
	SET XACT_ABORT ON
	BEGIN TRANSACTION
	UPDATE Cs2Cn_Prk_ClaimRefernceFileUpload SET SyncId=0 WHERE ISNULL(SyncId,0)=0
	Declare @Code VARCHAR(100)
	
	IF @TypeID = 1
	Begin
		SELECT @Code =  HostName FROM Sys.sysprocesses WHERE  status='RUNNABLE'  
	End
	IF @TypeID = 2
	Begin
	 --SELECT * FROM Configuration WHERE ModuleId  = 'DATATRANSFER52' AND ModuleName='DataTransfer'
	 SELECT ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo FROM 
	 ManualConfiguration WHERE ProjectName ='PARLE' AND ModuleId ='ClaimSyncPath'
	End
	IF @TypeID = 3
	Begin
	 DELETE FROM Cs2Cn_Prk_ClaimRefernceFileUpload WHERE UPLOADFLAG = 'Y'
	 --select 1
	End
	IF @TypeID = 4
	Begin
	SELECT Distinct * FROM Cs2Cn_Prk_ClaimRefernceFileUpload(NOLOCK) WHERE UploadFlag='N'
	End
		IF @TypeID = 5
	Begin
	
	SELECT * FROM Cs2Cn_Prk_ClaimRefernceFileUpload(NOLOCK) 
	WHERE UploadFlag='N'  And 	ClmRefCode = @ClmRefCode	And LineClaimRefNo = @LineclmRefCode And ImageName = @ImageName -- FOR XML AUTO
	
	End
	IF @TypeID = 6
	Begin
	
	Update A Set UploadFlag='Y'  From  Cs2Cn_Prk_ClaimRefernceFileUpload A (NOLOCK) 
	WHERE UploadFlag='N'  And 	ClmRefCode = @ClmRefCode	And LineClaimRefNo = @LineclmRefCode And ImageName = @ImageName 
	
	End
	IF @TypeID = 7
	Begin
	
	SELECT DistributorCode FROM Distributor WHERE Distributorid=1
	
	End
	IF @TypeID = 8
	Begin
	
	Update A Set UploadFlag='D'  From  Cs2Cn_Prk_ClaimRefernceFileUpload A (NOLOCK)  WHERE UploadFlag='N'
	
	End
	IF @TypeID = 9
	Begin
	
	SELECT * FROM Cs2Cn_Prk_ClaimRefernceFileUpload(NOLOCK) WHERE UploadFlag='D' 
	
	End
	IF @TypeID = 10
	Begin	
	Update A Set UploadFlag='Y'  From  Cs2Cn_Prk_ClaimRefernceFileUpload A (NOLOCK) 
	WHERE UploadFlag='D' 	
	End
	
	
	
	
		COMMIT TRANSACTION
	END TRY
	BEGIN CATCH
	ROLLBACK TRANSACTION
	
	INSERT INTO ErrorLog VALUES (1,'Proc_ClaimDataUpload','Proc_ClaimDataUpload', ERROR_MESSAGE())
	
	END CATCH
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_ReturnManualClaimDetails' AND xtype IN ('TF','FN'))
DROP FUNCTION FN_ReturnManualClaimDetails
GO
--select * from dbo.FN_ReturnManualClaimDetails('MAC17000003')
CREATE FUNCTION [dbo].[FN_ReturnManualClaimDetails](@ReferenceNo AS NVARCHAR(100))
RETURNS @Details TABLE
(
	MacRefNo		NVARCHAR(100),
	RefNo			NVARCHAR(100),
	Description		NVARCHAR(200),
	ClaimAmt		NUMERIC(18,6),		
	Remarks			NVARCHAR(200),
	SupportingFiles	VARCHAR(10),
	ChkDuplicate	NVARCHAR(100)
)
AS
/**************************************************
* FUNCTION : FN_ReturnManualClaimDetails
* PURPOSE   : To Return the Manual claim Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 25/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description a
**************************************************/
BEGIN
	INSERT INTO @Details
	SELECT M.MacRefNo,RefNo,Description,ClaimAmt,Remarks,
	CASE SupportingFiles WHEN 1 THEN 'YES' ELSE 'NO' END,RefNo as ChkDuplicate 
	FROM ManualClaimDetails M (NOLOCK) 
	WHERE M.MacRefNo=@ReferenceNo
	
RETURN
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Cs2Cn_Prk_ClaimRefernceFileUpload' AND XTYPE='U')
BEGIN
CREATE TABLE Cs2Cn_Prk_ClaimRefernceFileUpload(
	[SlNo]			[numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode]		[nvarchar](100) NULL,
	[ClaimType]		[varchar](100) NULL,
	[ClmDesc]		[varchar](200) NULL,
	[ClmRefCode]	[varchar](100) NULL,
	[LineClaimRefNo] [varchar](200) NULL,
	[ClaimDate]		 [datetime] NULL,
	[ClaimYear]		[int] NULL,
	[ClaimMonth]	[varchar](50) NULL,
	[ClmStartDate]	[datetime] NULL,
	[ClmToDate]		[datetime] NULL,
	[ImageName]		[varchar](100) NULL,
	[Binaryfile]	[varchar](MAX) NULL,
	[FileType]		[varchar](20) NULL,
	[UploadFlag]	[varchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Proc_Cs2Cn_ClaimReferenceFileUpload' AND xtype='P')
DROP PROCEDURE Proc_Cs2Cn_ClaimReferenceFileUpload
GO
/*
BEGIN TRAN
EXEC Proc_Cs2Cn_ClaimReferenceFileUpload 0,'2018-06-27'
select * from Cs2Cn_Prk_ClaimRefernceFileUpload for xml auto
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cs2Cn_ClaimReferenceFileUpload
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/**************************************************
* PROCEDURE : Proc_Cs2Cn_ClaimReferenceFileUpload
* PURPOSE   : Claim Reference File Upload
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
**************************************************/
SET NOCOUNT ON
BEGIN
SET @Po_ErrNo = 0
DECLARE @DistCode NVARCHAR(50)

		DELETE A FROM Cs2Cn_Prk_ClaimRefernceFileUpload A (NOLOCK) WHERE UploadFlag = 'Y'
		SELECT @DistCode = DistributorCode FROM Distributor (NOLOCK)
		INSERT INTO Cs2Cn_Prk_ClaimRefernceFileUpload(DistCode,ClaimType,ClmDesc,ClmRefCode,LineClaimRefNo,ClaimDate,
		ClaimYear,ClaimMonth,ClmStartDate,ClmToDate,ImageName,Binaryfile,FileType,UploadFlag,ServerDate)
		SELECT DISTINCT @DistCode,ClaimType,ClmDesc,ClmRefCode,LineClaimRefNo,ClaimDate,ClaimYear,ClaimMonth,ClaimDate AS JCMSDT,
		ClaimDate AS JcmEdt,ImageName,Binaryfile,FileType,'N',GETDATE() FROM ClaimRefDocumentUpload WHERE Upload=0 AND ClaimType<>'Manual Claim'
		UNION
		SELECT DISTINCT @DistCode,ClaimType,ClmDesc,ClmRefCode,LineClaimRefNo,ClaimDate,ClaimYear,ClaimMonth,
		M.JCMSDT,N.JcmEdt,ImageName,Binaryfile,FileType,'N',GETDATE() FROM ClaimRefDocumentUpload A 
		INNER JOIN ManualClaimMaster B(NOLOCK) ON A.ClmRefCode=B.MacRefNo 
		INNER JOIN JCMonth M(NOLOCK) ON B.JcmId=M.JcmId AND B.FromJcmJcId=M.JcmJc 
		INNER JOIN JCMonth N(NOLOCK) ON B.JcmId=N.JcmId AND B.ToJcmJcId=N.JcmJc
		WHERE Upload=0 and ClaimType='Manual Claim'	  
				
		UPDATE ClaimRefDocumentUpload SET UPLOAD=1
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_Cs2Cn_Claim_Manual' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_Claim_Manual
GO
--SELECT * FROM Cs2Cn_Prk_ClaimAll
--EXEC Proc_Cs2Cn_Claim_Manual
CREATE PROCEDURE Proc_Cs2Cn_Claim_Manual
AS
SET NOCOUNT ON
/*********************************
* PROCEDURE: Proc_Cs2Cn_Claim_Manual
* PURPOSE: Extract ManualClaim sheet details from CoreStocky to Console
* NOTES:
* CREATED: Aarthi.R    05/08/2008
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
*********************************/
BEGIN
	DECLARE @CmpID 	AS NVARCHAR(50)
	DECLARE @DistCode	AS NVARCHAR(50)
	DECLARE @ChkDate	AS DATETIME
	DECLARE @TransDate	AS DATETIME
	DELETE FROM Cs2Cn_Prk_ClaimAll WHERE UploadFlag = 'Y' AND ClaimType='Manual Claim'
	SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor
	SELECT @ChkDate = NextUpDate FROM DayEndProcess	WHERE ProcId = 12
	SELECT @TransDate=DATEADD(D,-1,GETDATE())
	INSERT INTO Cs2Cn_Prk_ClaimAll
	(
		DistCode ,
		CmpName ,
		ClaimType ,
		ClaimMonth ,
		ClaimYear ,
		ClaimRefNo ,
		ClaimDate ,
		ClaimFromDate ,
		ClaimToDate ,
		DistributorClaim,
		DistributorRecommended,
		ClaimnormPerc,
		SuggestedClaim,
		TotalClaimAmt ,
		Remarks ,
		Description ,
		Amount1 ,
		ProductCode ,
		Batch ,
		Quantity1 ,
		Quantity2 ,
		Amount2 ,
		Amount3 ,
		TotalAmount ,
		Remark2			,
		Remark3			,--CRCRSTPAR0014
		UploadFlag
	)
	SELECT @DistCode  AS DistCode,
		CmpName,'Manual Claim' AS ClaimType,
		DATENAME(MM,ClmDate)AS ClaimMonth,
		DATEPART(YYYY,ClmDate) AS  ClaimYear,
		CM.MacRefNo AS ClaimRefNo,
		ClmDate AS ClaimDate,
		FromDate AS ClaimFromDate,
		ToDate AS ClaimToDate,
		TotalClaimAmt,
		TotalClaimAmt,
		ClmPercentage,
		ClmAmount,
		RecommendedAmount,	
		CD.Remarks,
		CD.Description,
		0 AS Amount1,
		ISNULL(UDC.ColumnValue,'')AS ProductCode,
		'' AS Batch,
		0 AS Quantity1,
		0 AS Quantity2,
		0 AS Amount2,
		0 AS Amount3,
		--ClaimAmt AS TotalAmount,
		ROUND((CD.ClaimAmt/CM.TotalClaimAmt)*CDD.RecommendedAmount,2) AS TotalAmount,
		CS.ClmCode,
		CD.RefNo,
		'N' AS UploadFlag
		FROM Company C WITH (NOLOCK)
		INNER JOIN ManualClaimMaster CM WITH (NOLOCK)  ON CM.CmpID=C.CmpID
		INNER JOIN ManualClaimDetails CD WITH (NOLOCK) ON CD.MacRefNo=CM.MacRefNo
		INNER JOIN ClaimSheetDetail CDD WITH (NOLOCK) ON CM.MacRefNo =CDD.RefCode
		INNER JOIN ClaimSheetHd CS WITH (NOLOCK) ON CS.ClmId=CDD.ClmId AND CS.ClmGrpId= 16
		LEFT OUTER JOIN UDCDetails UDC WITH (NOLOCK) ON UDC.MasterRecordId=CM.MacRefId
		AND UDC.MasterId= 35 AND UDCMasterId IN(SELECT MIN(UDCMasterId) FROM UDCMaster WHERE MasterId=36)
		WHERE CM.Status=1 AND CDD.Status=1 AND CS.Confirm=1 AND CS.Upload='N' AND CDD.SelectMode=1
END
GO
DELETE FROM HotSearchEditorHd WHERE FormId=120
INSERT INTO HotSearchEditorHd([FormId],[FormName],[ControlName],[SltString],[RemainsltString]) 
VALUES (120,'Return to Company','ReturnTo','select','select SpmId,SpmName,SpmCode from supplier WHERE SpmName=''PARLE BISCUITS PVT LTD''')
GO
UPDATE RptHeader SET RpCaption='Non Performance Outlet Report',RptCaption='Non Performance Outlet Report' WHERE RptId=50
GO
UPDATE RptGroup SET GrpName='Non Performance Outlet Report' WHERE RptId=50
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='AvoidToLoadProduct' AND xtype='U')
BEGIN
CREATE TABLE AvoidToLoadProduct
(
	PrdCtgValCode		VARCHAR(100),
	PrdCtgValLinkcode	VARCHAR(100),
	CmpPrdCtgId			INT,
	CreatedDate			DATETIME
)
END
GO
DELETE FROM MANUALCONFIGURATION WHERE ModuleId='BlockInActive' and ModuleName='Product'
INSERT INTO MANUALCONFIGURATION(ProjectName,ModuleId,ModuleName,[Description],[Status],Condition,ConfigValue,SeqNo)
SELECT 'PARLE','BlockInActive','Product','Block In Active batch in Product Master',1,'',0,1
GO
IF NOT EXISTS(SELECT * FROM AvoidToLoadProduct(NOLOCK))
BEGIN

	EXEC Proc_GR_Build_PH

	INSERT INTO AvoidToLoadProduct(PrdCtgValCode,PrdCtgValLinkcode,CmpPrdCtgId,CreatedDate)
	SELECT DISTINCT   PrdCtgValCode,PrdCtgValLinkcode,CmpPrdCtgId,GETDATE() from tbl_gr_build_ph a 
	INNER JOIN ProductCategoryValue C ON C.PrdCtgValCode=category_code
	inner join product b on a.prdid=b.prdid  where ISNULL(category_code,'') not in ('C12','C13','C14','C15','C16','C21','C22','c10','K')
	--SELECT DISTINCT PrdCtgValCode,PrdCtgValLinkcode,CmpPrdCtgId,GETDATE() FROM ProductCategoryValue WHERE PrdCtgValCode IN ('S','C','T','M','Z','B','R','F')
END
GO
IF NOT EXISTS(SELECT * FROM AvoidToLoadProduct(NOLOCK) where PrdCtgValCode  IN 
(SELECT PrdCtgValCode FROM ProductCategoryValue WHERE PrdCtgValName='Common Division'))
BEGIN
	INSERT INTO AvoidToLoadProduct(PrdCtgValCode,PrdCtgValLinkcode,CmpPrdCtgId,CreatedDate)
	SELECT DISTINCT PrdCtgValCode,PrdCtgValLinkcode,CmpPrdCtgId,GETDATE() FROM ProductCategoryValue WHERE PrdCtgValName='Common Division'
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnToLoadProductCategory]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION Fn_ReturnToLoadProductCategory
GO
--SELECT * FROM Fn_ReturnToLoadProductCategory()ORDER BY PrdCtgValLinkCode
CREATE FUNCTION Fn_ReturnToLoadProductCategory()
RETURNS @PrdCtgValue TABLE
(
	LevelName	varchar(100),
	PrdCtgValLinkCode	NVARCHAR(500),
	PrdCtgValName		NVARCHAR(500),
	CmpId				INT
)
AS
/****************************************************************************
* FUNCTION  : Fn_ReturnToLoadProductCategory
* PURPOSE   : To Load Product Category Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
------------------------------------------------------------------------------      
 02/07/2018  S.Moorthi			CR		CRCRSTPAR0011       Audit requirements
******************************************************************************/
BEGIN

	DECLARE @PrdDt TABLE
	(
		CmpPrdCtgId			INT,
		PrdCtgValCode		VARCHAR(100),
		PrdCtgValLinkCode	VARCHAR(200)
	)
		
	IF EXISTS(SELECT * FROM MANUALCONFIGURATION WHERE ModuleId='BlockInActive' and ModuleName='Product' AND [Status]=1)
	BEGIN
		INSERT INTO @PrdDt(CmpPrdCtgId,PrdCtgValCode,PrdCtgValLinkCode)
		SELECT M.CmpPrdCtgId,M.PrdCtgValCode,PrdCtgValLinkCode FROM AvoidToLoadProduct M 
		--WHERE NOT EXISTS(
		--SELECT * FROM TBL_GR_BUILD_PH A (NOLOCK)
		----INNER JOIN ProductBatchLocation B (NOLOCK) on A.PrdId=B.PrdId
		--WHERE --B.PrdBatLcnSih+B.PrdBatLcnUih+B.PrdBatLcnFre>0 AND 
		--M.PrdCtgValCode=A.Category_Code)
	END

	INSERT INTO @PrdCtgValue(LevelName,PrdCtgValLinkCode,PrdCtgValName,CmpId)
	SELECT A.LevelName,B.PrdCtgValLinkCode,B.PrdCtgValName, A.CmpId FROM ProductCategoryLevel A with (nolock) , 
	ProductCategoryValue B with (nolock) WHERE  B.Availability = 1 and A.CmpPrdCtgId = B.CmpPrdCtgId 
	AND NOT EXISTS(SELECT * FROM @PrdDt C WHERE C.CmpPrdCtgId=2 AND B.PrdCtgValLinkCode LIKE C.PrdCtgValLinkcode+'%')
	ORDER BY PrdCtgValLinkCode
	
	--SELECT A.LevelName,B.PrdCtgValLinkCode,B.PrdCtgValName, A.CmpId FROM ProductCategoryLevel A with (nolock) , 
	--ProductCategoryValue B with (nolock) WHERE  B.Availability = 1 and A.CmpPrdCtgId = B.CmpPrdCtgId 
	--ORDER BY PrdCtgValLinkCode
	
RETURN
END
GO
UPDATE HotSearchEditorHd SET RemainsltString='Select DISTINCT PrdId,PrdDCode,PrdCCode,PrdName,PrdShrtName,CAST(MRP AS NUMERIC(18,2))MRP FROM (SELECT P.PrdId,PrdDCode,
PrdCCode,PrdName,PrdShrtName,PBD.PrdBatDetailValue AS MRP      FROM Product P,ProductBatch PB WITH (NOLOCK),
ProductBatchDetails PBD WITH (NOLOCK),BatchCreation BC WITH (NOLOCK)        
WHERE P.PrdId in (SELECT DISTINCT prdid FROM ProductBatchLocation WITH (NOLOCK) WHERE LcnId = vFParam  and  
((PrdBatLcnUih) - (PrdBatLcnResUih)) >0)  and PrdStatus = 1     AND PrdType <> 3    
and PBD.PrdBatId In  (SELECT DISTINCT PrdBatId FROM ProductBatchLocation WITH (NOLOCK)  WHERE   
(PrdBatLcnUih) - (PrdBatLcnResUih) > 0)   AND PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1  
AND PBD.SlNo=BC.SlNo AND BC.MRP=1    AND PBD.BatchSeqId=BC.BatchSeqId AND P.Prdid = PB.PrdId ) a'
WHERE FormId=759
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT PrdId,PrdDCode,PrdCCode,PrdName,PrdShrtName FROM Product WHERE PrdId in (SELECT DISTINCT prdid    FROM ProductBatchLocation WITH (NOLOCK) WHERE LcnId = vFParam and  
((PrdBatLcnUih) - (PrdBatLcnResUih)) >0)  and PrdStatus = 1 AND PrdType <> 3'-- and SpmId=vSParam 
WHERE FormId=127
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT DISTINCT PrdBatId,PrdBatCode,SellingRate,MRP,PurchaseRate,DefaultPriceId FROM Fn_ReturnToProductbatchRetRep(vFParam,2,vSParam)' WHERE FormId= 808
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT PrdBatId,MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId FROM Fn_ReturnToProductbatchRetRep(vFParam,1,vSParam)' WHERE FormId= 809
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT PrdBatId,PrdBatCode,SellingRate,MRP,PurchaseRate,DefaultPriceId FROM Fn_ReturnToProductbatchRetRep(vFParam,2,vSParam)' WHERE FormId= 330
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT PrdBatId,MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId FROM Fn_ReturnToProductbatchRetRep(vFParam,1,vSParam)' WHERE FormId= 329
GO
UPDATE A SET SERVICEORGOODS=2 from ClaimGroupMaster A  where ClmGrpName='Manual Claim'
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Fn_ReturnToProductbatchRetRep' and xtype in ('TF','FN'))
DROP FUNCTION Fn_ReturnToProductbatchRetRep
GO
--select * from Fn_ReturnToProductbatchRetRep(4025,1)
CREATE FUNCTION Fn_ReturnToProductbatchRetRep(@PrdId	BIGINT,@RETTYPE AS INT,@MRP AS NUMERIC(18,3))
RETURNS @ReturnReplace TABLE
(
	PrdBatId		BIGINT,
	MRP				NUMERIC(18,6),
	PrdBatCode		VARCHAR(100),
	SellingRate		NUMERIC(18,6),
	PurchaseRate	NUMERIC(18,6),
	DefaultPriceId	BIGINT	
	
)
AS
/**************************************************
* FUNCTION : Fn_ReturnToLoadProductCategory
* PURPOSE   : To Load Product Category Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 02/07/2018  S.Moorthi			CR		CRCRSTPAR0011       Audit requirements
**************************************************/
BEGIN

	IF @RETTYPE=1
	BEGIN
	
		IF @MRP=0---formId=809
		BEGIN
			INSERT INTO @ReturnReplace(PrdBatId,MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId)
			SELECT PrdBatId,CAST(MRP AS NUMERIC(18,2))MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId  FROM     (
			SELECT PB.PrdBatId,PB.PrdBatCode,PBD1.PrdBatDetailValue AS MRP,    PBD2.PrdBatDetailValue AS PurchaseRate,    
			PBD3.PrdBatDetailValue AS SellingRate,PB.DefaultPriceId      FROM ProductBatch PB WITH (NOLOCK),    
			ProductBatchDetails PBD1 WITH (NOLOCK),      BatchCreation BC1 WITH (NOLOCK)   ,   ProductBatchDetails PBD2 WITH (NOLOCK),      
			BatchCreation BC2 WITH (NOLOCK)   ,   ProductBatchDetails PBD3 WITH (NOLOCK),      
			BatchCreation BC3 WITH (NOLOCK)    Where PB.PrdBatId = PBD1.PrdBatId    And BC1.BatchSeqId = PB.BatchSeqId  
			AND PBD1.SlNo=BC1.SlNo AND BC1.MRP=1  AND PBD1.DefaultPrice=1  AND  PB.PrdBatId = PBD2.PrdBatId And BC2.BatchSeqId = PB.BatchSeqId  
			AND PBD2.SlNo=BC2.SlNo  AND BC2.ListPrice=1 AND PBD2.DefaultPrice=1  AND  PB.PrdBatId = PBD3.PrdBatId And BC3.BatchSeqId = PB.BatchSeqId 
			AND PBD3.SlNo=BC3.SlNo AND BC3.SelRte=1 AND PBD3.DefaultPrice=1      AND PB.PrdId =@PrdId
			AND PB.PrdBatId in (SELECT MAX(PRDBATID) FROM ProductBatch WHERE PrdId=@PrdId and Status=1))MainQry
		END
		ELSE---formId=329
		BEGIN
			INSERT INTO @ReturnReplace(PrdBatId,MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId)
			SELECT PrdBatId,CAST(MRP AS NUMERIC(18,2))MRP,PrdBatCode,SellingRate,PurchaseRate,DefaultPriceId  FROM   (
			SELECT PB.PrdBatId,PB.PrdBatCode,PBD1.PrdBatDetailValue AS MRP,  PBD2.PrdBatDetailValue AS PurchaseRate,    
			PBD3.PrdBatDetailValue AS SellingRate,PB.DefaultPriceId    FROM ProductBatch PB WITH (NOLOCK),    
			ProductBatchDetails PBD1 WITH (NOLOCK),    BatchCreation BC1 WITH (NOLOCK)   ,   ProductBatchDetails PBD2 WITH (NOLOCK),   
			 BatchCreation BC2 WITH (NOLOCK)   ,   ProductBatchDetails PBD3 WITH (NOLOCK),    BatchCreation BC3 WITH (NOLOCK)    
			 Where PB.PrdBatId = PBD1.PrdBatId   And BC1.BatchSeqId = PB.BatchSeqId  AND PBD1.SlNo=BC1.SlNo AND BC1.MRP=1    
			 AND PBD1.DefaultPrice=1  AND  PB.PrdBatId = PBD2.PrdBatId And BC2.BatchSeqId = PB.BatchSeqId    AND PBD2.SlNo=BC2.SlNo  
			 AND BC2.ListPrice=1 AND PBD2.DefaultPrice=1    AND  PB.PrdBatId = PBD3.PrdBatId And BC3.BatchSeqId = PB.BatchSeqId    
			 AND PBD3.SlNo=BC3.SlNo AND BC3.SelRte=1 AND PBD3.DefaultPrice=1    AND PB.PrdId =@PrdId AND PBD1.PrdBatDetailValue=@MRP
 				AND PB.PrdBatId in (SELECT MAX(PRDBATID) FROM ProductBatch WHERE PrdId=@PrdId and Status=1)) MainQry
		END
	END
	else
	BEGIN
		IF @MRP=0---formId=808
		BEGIN
		
			INSERT INTO @ReturnReplace(PrdBatId,PrdBatCode,SellingRate,MRP,PurchaseRate,DefaultPriceId)
			SELECT DISTINCT PrdBatId,PrdBatCode,SellingRate,CAST(MRP AS NUMERIC(18,2))MRP,PurchaseRate,DefaultPriceId FROM(
			SELECT DISTINCT PB.PrdBatId,PB.PrdBatCode,PBD1.PrdBatDetailValue AS MRP,  PBD2.PrdBatDetailValue AS PurchaseRate,
			PBD3.PrdBatDetailValue AS SellingRate,PB.DefaultPriceId  FROM ProductBatch PB WITH (NOLOCK),  
			ProductBatchDetails PBD1 WITH (NOLOCK),BatchCreation BC1 WITH (NOLOCK),ProductBatchDetails PBD2 WITH (NOLOCK),
			BatchCreation BC2 WITH (NOLOCK),  ProductBatchDetails PBD3 WITH (NOLOCK),BatchCreation BC3 WITH (NOLOCK),
			ProductBatchLocation PBL WITH (NOLOCK)   WHERE PB.PrdBatId = PBD1.PrdBatId AND BC1.BatchSeqId = PB.BatchSeqId 
			AND PB.PrdBatId = PBL.PrdBatID AND (PrdBatLcnSih - PrdBatLcnRessih) > 0       AND PBD1.SlNo=BC1.SlNo AND BC1.MRP=1 
			AND PBD1.DefaultPrice=1 AND PB.PrdBatId = PBD2.PrdBatId  And BC2.BatchSeqId = PB.BatchSeqId AND PBD2.SlNo=BC2.SlNo   
			AND BC2.ListPrice=1 AND PBD2.DefaultPrice=1 AND PB.PrdBatId = PBD3.PrdBatId And BC3.BatchSeqId = PB.BatchSeqId 
			AND PBD3.SlNo=BC3.SlNo   AND BC3.SelRte=1 AND PBD3.DefaultPrice=1  AND PB.Status=1
			AND PB.PrdBatId in (SELECT MAX(PRDBATID) FROM ProductBatch WHERE PrdId=@PrdId and Status=1)) MainQry
		END
		ELSE
		BEGIN  ---formId=330
			INSERT INTO @ReturnReplace(PrdBatId,PrdBatCode,SellingRate,MRP,PurchaseRate,DefaultPriceId)
			SELECT PrdBatId,PrdBatCode,SellingRate,CAST(MRP AS NUMERIC(18,2))MRP,PurchaseRate,DefaultPriceId FROM(
			SELECT PB.PrdBatId,PB.PrdBatCode,PBD1.PrdBatDetailValue AS MRP,  PBD2.PrdBatDetailValue AS PurchaseRate,PBD3.PrdBatDetailValue AS SellingRate,
			PB.DefaultPriceId FROM ProductBatch PB WITH (NOLOCK),   ProductBatchDetails PBD1 WITH (NOLOCK),BatchCreation BC1 WITH (NOLOCK),
			ProductBatchDetails PBD2 WITH (NOLOCK),BatchCreation BC2 WITH (NOLOCK),   ProductBatchDetails PBD3 WITH (NOLOCK),
			BatchCreation BC3 WITH (NOLOCK),ProductBatchLocation PBL WITH(NOLOCK)  WHERE PB.PrdBatId = PBD1.PrdBatId And BC1.BatchSeqId = PB.BatchSeqId 
			AND PB.PrdBatID = PBL.PrdBatID AND PBD1.SlNo=BC1.SlNo AND BC1.MRP=1   AND PBD1.DefaultPrice=1 AND PB.PrdBatId = PBD2.PrdBatId 
			AND BC2.BatchSeqId = PB.BatchSeqId AND PBD2.SlNo=BC2.SlNo   AND BC2.ListPrice=1 AND PBD2.DefaultPrice=1 AND PB.PrdBatId = PBD3.PrdBatId 
			And BC3.BatchSeqId = PB.BatchSeqId AND PBD3.SlNo=BC3.SlNo   AND BC3.SelRte=1  AND PBD3.DefaultPrice=1 AND (PrdBatLcnSih - PrdBatLcnRessih) > 0 
			AND PB.PrdId = @PrdId   AND PB.Status=1 AND PBD1.PrdBatDetailValue= @MRP 
			AND PB.PrdBatId in (SELECT MAX(PRDBATID) FROM ProductBatch WHERE PrdId=@PrdId and Status=1)) MainQry
		END
	END
	
	
	
RETURN
END
GO
--S.Moorthi Till Here
--aDDED BY Karthik .K.J
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='RetailerCap' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Etl_Prk_SchemeHD_Slabs_Rules' AND XTYPE='U'))
BEGIN
	ALTER TABLE Etl_Prk_SchemeHD_Slabs_Rules Add RetailerCap NVARCHAR(20) DEFAULT 100 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='ApplyTaxForClaim' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Etl_Prk_SchemeHD_Slabs_Rules' AND XTYPE='U'))
BEGIN
	ALTER TABLE Etl_Prk_SchemeHD_Slabs_Rules Add ApplyTaxForClaim VARCHAR(10) DEFAULT 'YES' WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='RetailerCap' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='SchemeSlabs' AND XTYPE='U'))
BEGIN
	ALTER TABLE SchemeSlabs Add RetailerCap NUMERIC(18,2) DEFAULT 100 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='ApplyTaxForClaim' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='SchemeMaster' AND XTYPE='U'))
BEGIN
	ALTER TABLE SchemeMaster Add ApplyTaxForClaim INT DEFAULT 1 WITH VALUES
END
GO
DELETE FROM customcaptions WHERE transid=45 and ctrlid=98 AND SubCtrlid=22
INSERT INTO customcaptions
SELECT 45,98,22,'sprSlabDetails-45-98-22','Retailer Cap','','',1,1,1,GETDATE(),1,GETDATE(),'Retailer Cap','','',1,1
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_BLSchemeSlab' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeSlab
GO
 /*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_BLSchemeSlab 0
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeSlab
(
	@Po_ErrNo INT OUTPUT	
)
AS
/*********************************
* PROCEDURE: Proc_Cn2Cs_BLSchemeSlab 1
* PURPOSE: To Insert and Update Scheme Slab Details
* CREATED: Boopathy.P on 02/01/2009
*********************************
Modified By karthick CrNo-CRCRSTPAR0007 Retailer Cap Download on 18/06/2018	
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode AS VARCHAR(50)
	DECLARE @SlabCode AS INT
	DECLARE @FromUOM AS VARCHAR(200)
	DECLARE @FromQty AS NUMERIC(18,6)
	DECLARE @ToUOM  AS VARCHAR(200)
	DECLARE @ToQty  AS NUMERIC(18,6)
	DECLARE @ForEveryUOM AS VARCHAR(200)
	DECLARE @ForEveryQty AS NUMERIC(18,6)
	DECLARE @DiscPer AS NUMERIC(5,2)
	DECLARE @FlatAmt AS NUMERIC(18,6)
	DECLARE @Points  AS NUMERIC(18,6)
	DECLARE @FlexiFree AS NUMERIC(18,6)
	DECLARE @FlexiGift AS NUMERIC(18,6)
	DECLARE @FlexiDisc AS NUMERIC(18,6)
	DECLARE @FlexiFlat AS NUMERIC(18,6)
	DECLARE @FlexiPoints AS INT
	DECLARE @TempRange AS NUMERIC(18,6)
	DECLARE @CmpId  AS INT
	DECLARE @SchLevelId AS INT
	DECLARE @SchType AS INT
	DECLARE @FlexiId AS INT
	DECLARE @RangeId AS INT
	DECLARE @FlexiType AS INT
	DECLARE @CombiSch AS INT
	DECLARE @FlexiCnt AS INT
	DECLARE @FromUomId AS INT
	DECLARE @ToUomId AS INT
	DECLARE @ForEveryUomId AS INT
	DECLARE @ChkCount AS INT
	DECLARE @PurOfEvery	 AS INT
	DECLARE @ErrDesc  AS VARCHAR(1000)
	DECLARE @TabName  AS VARCHAR(50)
	DECLARE @GetKey  AS VARCHAR(50)
	DECLARE @Taction  AS INT
	DECLARE @MAXSLABID AS INT
	DECLARE @sSQL   AS VARCHAR(4000)
	DECLARE @MaxSchLevelId	AS INT
	DECLARE @CntVal	As	INT
	DECLARE @TempStr	AS Varchar(4000)
	DECLARE @TempStr1	AS Varchar(4000)
	DECLARE @SLevel		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @MaxDisc  AS NUMERIC(18,2)
	DECLARE @MinDisc  AS NUMERIC(18,2)
	DECLARE @MaxValue  AS NUMERIC(18,2)
	DECLARE @MinValue  AS NUMERIC(18,2)
	DECLARE @MaxPoints  AS INT
	DECLARE @MinPoints  AS INT
	DECLARE @ConFig		AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @SlabNotAppl AS INT
	DECLARE @RetailerCap AS NUMERIC(18,2)--CRCRSTPAR0007
	
	Create Table  #TempTbl
	(
		PrdUnitId	INT,
		PrdUnitGrpId	INT,
		PrdUnitCode	Varchar(50)
	)
	
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	
	DECLARE Cur_SchemeSlabDt CURSOR
	FOR SELECT DISTINCT ISNULL([CmpSchCode],'') AS [Company Scheme Code],
		ISNULL([SlabId],0) AS [SlabId],
		ISNULL([Uom],'0') AS [From Uom],
		CASE ISNULL([FromQty],'') WHEN '' THEN 0 ELSE CAST([FromQty] AS NUMERIC(18,2)) END AS [From Qty],
		ISNULL([ToUom],'0') AS [To Uom],
		CASE ISNULL([ToQty],'') WHEN '' THEN 0 ELSE CAST([ToQty] AS NUMERIC(18,2)) END AS [To Qty],
		ISNULL([ForEveryUom],'0') AS [For Every Uom],
		CASE ISNULL([ForEveryQty],'') WHEN '' THEN 0 ELSE CAST([ForEveryQty] AS NUMERIC(18,2)) END AS [For Every Qty],
		CASE ISNULL([DiscPer],'') WHEN '' THEN 0 ELSE CAST([DiscPer] AS NUMERIC(5,2)) END AS [Disc %],
		CASE ISNULL([FlatAmt],'') WHEN '' THEN 0 ELSE CAST([FlatAmt] AS NUMERIC(18,2)) END AS [Flat Amount],
		CASE ISNULL([Points],'') WHEN '' THEN 0 ELSE CAST([Points] AS NUMERIC(18,2)) END AS [Point],
		CASE ISNULL([FlxFreePrd],'') WHEN '' THEN 0 ELSE [FlxFreePrd] END AS [Flexi Free],
		CASE ISNULL([FlxGiftPrd],'') WHEN '' THEN 0 ELSE [FlxGiftPrd] END AS [Flexi Gift],
		CASE ISNULL([FlxDisc],'') WHEN '' THEN 0 ELSE [FlxDisc] END AS [Flexi Disc],
		CASE ISNULL([FlxValueDisc],'') WHEN '' THEN 0 ELSE [FlxValueDisc] END AS [Flexi Flat],
		CASE ISNULL([FlxPoints],'') WHEN '' THEN 0 ELSE [FlxPoints] END AS [Flexi Points],
		CASE ISNULL([MaxDiscount],'') WHEN '' THEN 0 ELSE CAST([MaxDiscount] AS NUMERIC(18,2)) END AS [Max Discount],
		CASE ISNULL([MinDiscount],'') WHEN '' THEN 0 ELSE CAST([MinDiscount] AS NUMERIC(18,2)) END AS [Min Discount],
		CASE ISNULL([MaxValue],'') WHEN '' THEN 0 ELSE CAST([MaxValue] AS NUMERIC(18,2)) END AS [Max Value],
		CASE ISNULL([MinValue],'') WHEN '' THEN 0 ELSE CAST([MinValue] AS NUMERIC(18,2)) END AS [Min Value],
		CASE ISNULL([MaxPoints],'') WHEN '' THEN 0 ELSE CAST([MaxPoints] AS NUMERIC(18,2)) END AS [Max Points],
		CASE ISNULL([MinPoints],'') WHEN '' THEN 0 ELSE CAST([MinPoints] AS NUMERIC(18,2)) END AS [Min Points],
		CASE ISNULL([RetailerCap],'') WHEN '' THEN 100 ELSE CAST([RetailerCap] AS NUMERIC(18,2)) END AS [RetailerCap]
	FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY [Company Scheme Code],[SlabId]
	OPEN Cur_SchemeSlabDt
	FETCH NEXT FROM Cur_SchemeSlabDt INTO @SchCode,@SlabCode,@FromUOM,@FromQty,@ToUOM,@ToQty,@ForEveryUOM,
	@ForEveryQty,@DiscPer,@FlatAmt,@Points,@FlexiFree,@FlexiGift,@FlexiDisc,@FlexiFlat,@FlexiPoints,
	@MaxDisc,@MinDisc,@MaxValue,@MinValue,@MaxPoints,@MinPoints,@RetailerCap
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CntVal=1
		SET @FromUomId=0
		SET @ToUomId=0
		SET @ForEveryUomId=0
		SET @TempStr=''
		SET @TempStr1=''
		DELETE FROM #TempTbl
		SELECT @MAXSLABID=MAX([SlabId])  FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE  [CmpSchCode]=@SchCode
		SET @Taction = 2
		SET @Po_ErrNo =0
		---->Modified By Nanda on 16/09/2009
		SET @SlabNotAppl=0
		IF (LTRIM(RTRIM(@SlabCode))= '---' OR LTRIM(RTRIM(@SlabCode))= '0')
		BEGIN						
			SET @SlabNotAppl=1
		END
		---->Till Here
		IF @SlabNotAppl=0
		BEGIN
			IF LTRIM(RTRIM(@SchCode))= ''
			BEGIN
				SET @ErrDesc = 'Company Scheme Code should not be blank'
				INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LEN(LTRIM(RTRIM(@SlabCode)))= 0
			BEGIN
				SET @ErrDesc = 'Slab Details should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (1,@TabName,'Slab Details',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @Po_ErrNo=0
			BEGIN
				IF @ConFig<>1
				BEGIN
					IF NOT EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
					BEGIN
						SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,@SchType=SchType,
						@RangeId=Range,@CombiSch=CombiSch,@PurOfEvery=PurofEvery,@CmpPrdCtgId=SchLevelId  FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					END
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
					BEGIN
						SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,@SchType=SchType,
						@RangeId=Range,@CombiSch=CombiSch,@PurOfEvery=PurofEvery,@CmpPrdCtgId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					END
					ELSE
						IF NOT EXISTS(SELECT CmpSchCode FROM Etl_Prk_SchemeMaster_Temp WHERE
						CmpSchCode=LTRIM(RTRIM(@SchCode)) AND UpLoadFlag='N')
						BEGIN
							IF NOT EXISTS(SELECT [CmpSchCode] FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE
							[CmpSchCode]=LTRIM(RTRIM(@SchCode)))
							BEGIN
								SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode +' in table Etl_Prk_SchemeHD_Slabs_Rules '
								INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @CmpId=B.CmpId FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON
								B.CmpCode=A.[CmpCode] WHERE [CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @SchLevelId=C.CmpPrdCtgId,@FlexiId=A.FlexiSch,@CombiSch=A.CombiSch,
								@FlexiType=A.FlexiSchType,@SchType=A.SchType,@RangeId=A.Range
								FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON B.CmpCode=A.CmpCode
								INNER JOIN ProductCategoryLevel C ON A.SchLevel=C.CmpPrdCtgName
								AND B.CmpId=C.CmpId WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode))
							END
						END
					ELSE
					BEGIN
						SELECT @GetKey=CmpSchCode,@CmpId=CmpId FROM Etl_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SELECT @SchLevelId=SchLevelId,@FlexiId=FlexiSch,@FlexiType=FlexiSchType,
						@SchType=SchType,@RangeId=Range,@CombiSch=CombiSch,@CmpPrdCtgId=SchLevelId FROM Etl_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
						SET @Po_ErrNo =0
					END
				END
			END
			IF @Po_ErrNo=0
			BEGIN
				IF @FlexiId=1
				BEGIN
					SET @FlexiCnt=0
					IF LTRIM(RTRIM(@FlexiFree))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiGift))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiDisc))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiFlat))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF LTRIM(RTRIM(@FlexiPoints))='0'
					BEGIN
						SET @FlexiCnt=@FlexiCnt + 1
					END
					IF @FlexiCnt=5
					BEGIN
						SET @ErrDesc = 'Select Only Flexi Items for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'FLEXI SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
				END
				IF @RangeId=1
				BEGIN
					IF @SchType<>2
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						IF LTRIM(RTRIM(@ToUOM))='0'
						BEGIN
							IF 	@MAXSLABID <> @SlabCode
							BEGIN
								SET @ErrDesc = 'To UOM Should Not Be Blank for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @MAXSLABID =@SlabCode
					BEGIN
						IF CONVERT(INT,@ToQty)>0
						BEGIN
							SET @ErrDesc = 'To Qty Should be ZERO for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'RANGE SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
				IF @CombiSch=1
				BEGIN
					IF @SchType<>2
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							 SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
						END
						IF LTRIM(RTRIM(@ForEveryUOM))='0'
						BEGIN
							SET @ErrDesc = 'For Every UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							 SELECT @ForEveryUOMId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @PurOfEvery=1
					BEGIN
						IF LTRIM(RTRIM(@ForEveryQty))='0'
						BEGIN
							SET @ErrDesc = 'For Every Qty Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
				IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=0
				BEGIN
					IF @SchType<>2
					BEGIN
						IF LTRIM(RTRIM(@FromUOM))='0'
						BEGIN
							SET @ErrDesc = 'From UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						IF LTRIM(RTRIM(@ForEveryUOM))='0'
						BEGIN
							SET @ErrDesc = 'For Every UOM Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'COMBI SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
					IF LTRIM(RTRIM(@FromQty))='0'
					BEGIN
						SET @ErrDesc = 'From Qty Should Not Be Blank for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'NORMAL SCHEME',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					IF @PurOfEvery=1
					BEGIN
						IF LTRIM(RTRIM(@ForEveryQty))='0'
						BEGIN
							SET @ErrDesc = 'For Every Qty Should Not Be Blank for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'NORMAL SCHEME',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
					END
				END
			END
			IF @Po_ErrNo=0
			BEGIN
				SELECT @MaxSchLevelId=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
				IF @SchType<>4
				BEGIN
					IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=0
					BEGIN
						IF @SchType=1
						BEGIN
							IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
							END
							---->Modified By Nanda on 23/08/2009
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ForEveryUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
								END
							END
							ELSE
							BEGIN
								SET @ForEveryUomId=0
							END
							--->Till Here
						END
						ELSE IF @SchType=3
						BEGIN
							IF @MaxSchLevelId=@SchLevelId
							BEGIN
								IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (1) for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
									SET @FromUomId= ISNULL(@FromUomId,0)
								END
			
								---->Modified By Nanda on 23/08/2009
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
										SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN
								SET @sSQL=''
								IF @CntVal=(@MaxSchLevelId-@SchLevelId)
								BEGIN
									SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
								END
								ELSE
								BEGIN
									WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
									BEGIN
										IF @CntVal=1
										BEGIN
											SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
												  (SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
												   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
										END
			
											SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
											SET @TempStr1=@TempStr1+ ')'
										SET @CntVal=@CntVal+1	
										IF @CntVal=(@MaxSchLevelId-@SchLevelId)
										BEGIN
											IF ISNUMERIC(@GetKey)=1
											BEGIN									
												SET @sSQL=@sSQL + @TempStr +'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
											END
											ELSE
											BEGIN
												SET @sSQL=@sSQL + @TempStr +'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
											END																
										END
										
									END	
								END
								--Test		
								--SELECT @sSQL			
								EXEC(@sSQL)
								IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (2) for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
									SET @FromUomId= ISNULL(@FromUomId,0)
								END
					
								--->Modified By Nanda on 30/09/2010
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
										SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
								END
								--->Till Here	
							END
						END
					END
					ELSE IF @FlexiId=1
					BEGIN
						IF @CombiSch=1
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
								---->Modified By Nanda on 23/08/2009
								IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
								BEGIN
									IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
									BEGIN
										SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ForEveryUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
									END
								END
								ELSE
								BEGIN
									SET @ForEveryUomId=0
								END
								---->Till Here
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (3) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
				
									--->Modified By Nanda on 30/09/2010
									IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
									BEGIN
										IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
										BEGIN
											IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
											BEGIN
												SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
												INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
												SET @Taction = 0
												SET @Po_ErrNo =1
											END
											ELSE
											BEGIN
												SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
												SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
											END
										END
										ELSE	
										BEGIN
											SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
										END
									END
									ELSE	
									BEGIN
										SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
									END
									--->Till Here	
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
			-- 								IF @CntVal<>1
			-- 								BEGIN
												SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
												SET @TempStr1=@TempStr1+ ')'
			-- 								END
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN				
												SET @sSQL=@sSQL + @TempStr +
												'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
												'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
												ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1	
												END	
											END
										END		
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (4) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
									--->Modified By Nanda on 30/09/2010
									IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
									BEGIN
										IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
										BEGIN
											SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
											INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
											SET @Taction = 0
											SET @Po_ErrNo =1
										END
										ELSE
										BEGIN
											SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
											SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
										END
									END
									BEGIN
										SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
									END
									--->Till Here
								END
							END
						END
						ELSE IF @RangeId=1
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM)))
								BEGIN
									SET @ErrDesc = 'To Uom:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'To UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ToUomId=ISNULL(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM))
								END
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (5) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN															
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
				
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
									BEGIN
										SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
										SET @ToUomId=ISNULL(@ToUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
			-- 								IF @CntVal<>1
			-- 								BEGIN
												SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
												SET @TempStr1=@TempStr1+ ')'
			-- 								END
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN					
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												ELSE
												BEGIN					
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
												END		
											END
										END	
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (6) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
									BEGIN
										SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
										SET @ToUomId= ISNULL(@ToUomId,0)
									END
								END
							END
						END
						ELSE
						BEGIN
							IF @SchType=1
							BEGIN
								IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
								BEGIN
									SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
								END
							END
							ELSE IF @SchType=3
							BEGIN
								IF @MaxSchLevelId=@SchLevelId
								BEGIN
									IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (7) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0)FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
								END
								ELSE
								BEGIN
									SET @sSQL=''
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
									END
									ELSE
									BEGIN
										WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
										BEGIN
											IF @CntVal=1
											BEGIN
												SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
										  				(SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
													   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
											END
											SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
											SET @TempStr1=@TempStr1+ ')'
											SET @CntVal=@CntVal+1
											IF @CntVal=(@MaxSchLevelId-@SchLevelId)
											BEGIN
												IF ISNUMERIC(@GetKey)=1
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
												END
												ELSE
												BEGIN
													SET @sSQL=@sSQL + @TempStr +
													'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
													ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
												END																						
											END
										END		
									END
									EXEC(@sSQL)
									IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
									BEGIN
										SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (8) for Scheme Code:'+@SchCode
										INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
										SET @Taction = 0
										SET @Po_ErrNo =1
									END
									ELSE
									BEGIN
										SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
										SET @FromUomId= ISNULL(@FromUomId,0)
									END
			
								END
							END
						END
					END
				ELSE IF @FlexiId=0 AND @CombiSch=0 AND @RangeId=1
				BEGIN
					IF @SchType=3
					BEGIN
						
						IF @MaxSchLevelId=@SchLevelId
						BEGIN
							IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (9) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
								SET @FromUomId= ISNULL(@FromUomId,0)
							END
			
							IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
							BEGIN
								SET @ErrDesc = 'To PrdUnitCode:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'To PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
								SET @ToUomId=ISNULL(@ToUomId,0)
							END
			
							--Test
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS (SELECT PrdUnitId FROM ProductUnit WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN
									SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM ProductUnit  WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
									SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN
								SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
							END
						END
						ELSE
						BEGIN
							SET @sSQL=''
							IF @CntVal=(@MaxSchLevelId-@SchLevelId)
							BEGIN
								SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit'
							END
							ELSE
							BEGIN
								WHILE @CntVal<>(@MaxSchLevelId-@SchLevelId)	
								BEGIN
									IF @CntVal=1
									BEGIN
										SET @sSQL='INSERT INTO #TempTbl SELECT PrdUnitId,PrdUnitGrpId,PrdUnitCode FROM ProductUnit WHERE PrdUnitGrpId IN
												  (SELECT PrdUnitGrpId FROM ProductUnit WHERE PrdUnitId IN(
											   SELECT DISTINCT PrdUnitId From Product WHERE PrdctgValMainId IN('
									END
									
			-- 						IF @CntVal<>1
			-- 						BEGIN
										SET @TempStr=@TempStr + 'SELECT PrdctgValMainId FROM ProductCategoryValue WHERE PrdCtgValLinkId IN('
										SET @TempStr1=@TempStr1+ ')'
			-- 						END
									SET @CntVal=@CntVal+1
									
									IF @CntVal=(@MaxSchLevelId-@SchLevelId)
									BEGIN
										IF ISNUMERIC(@GetKey)=1
										BEGIN				
										SET @sSQL=@sSQL + @TempStr +
										'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
											ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=' + CAST(@GetKey AS Varchar(10))+ ')))'+@TempStr1
										END
										ELSE
										BEGIN				
										SET @sSQL=@sSQL + @TempStr +
										'SELECT DISTINCT S.PrdCtgValMainId FROM SchemeProducts S INNER JOIN
											ProductCategoryValue P ON S.PrdCtgValMainId=P.PrdCtgValMainId Where SchId=0)))'+@TempStr1
										END
									END
								END	
							END			
							EXEC(@sSQL)
							IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@FromUOM+' not Found (10) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @FromUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@FromUOM))
								SET @FromUomId= ISNULL(@FromUomId,0)
							END
			
							IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM)))
							BEGIN
								SET @ErrDesc = 'From Prd Unit Code:'+@ToUOM+' not Found (11) for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'From PrdUnitCode',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ToUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ToUOM))
								SET @ToUomId= ISNULL(@FromUomId,0)
							END
							--->Modified By Nanda on 30/09/2010
							IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
							BEGIN
								IF NOT EXISTS(SELECT * FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM)))
								BEGIN
									
									SET @ErrDesc = 'For Every Prd Unit Code:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
									INSERT INTO Errorlog VALUES (1,@TabName,'For Every Prd Unit Code',@ErrDesc)
									SET @Taction = 0
									SET @Po_ErrNo =1
								END
								ELSE
								BEGIN						
									SELECT @ForEveryUomId=ISNUll(PrdUnitId,0) FROM #TempTbl WHERE PrdUnitCode=LTRIM(RTRIM(@ForEveryUOM))
									SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
								END
							END
							ELSE
							BEGIN						
								SET @ForEveryUomId= ISNULL(@ForEveryUomId,0)
							END
							--->Till Here
						END
					END
					ELSE IF @SchType=1
					BEGIN
						IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM)))
						BEGIN
							SET @ErrDesc = 'From Uom:'+@FromUOM+' not Found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'From UOM',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @FromUomId=UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@FromUOM))
							SET @ToUomId= ISNULL(@ToUomId,0)
						END
						IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM)))
						BEGIN
							SET @ErrDesc = 'To Uom:'+@ToUOM+' not Found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'To UOM',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @ToUomId=ISNUll(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ToUOM))
							SET @ToUomId= ISNULL(@ToUomId,0)
						END
						---->Modified By Nanda on 23/08/2009
						IF EXISTS(SELECT * FROM SchemeMaster WHERE CmpSchCode=@SchCode AND PurOfEvery=1)
						BEGIN
							IF NOT EXISTS (SELECT UomId FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM)))
							BEGIN
								SET @ErrDesc = 'For Every Uom:'+@ForEveryUOM+' not Found for Scheme Code:'+@SchCode
								INSERT INTO Errorlog VALUES (1,@TabName,'For Every UOM',@ErrDesc)
								SET @Taction = 0
								SET @Po_ErrNo =1
							END
							ELSE
							BEGIN
								SELECT @ForEveryUomId=ISNUll(UomId,0) FROm UomMaster WHERE UomCode=LTRIM(RTRIM(@ForEveryUOM))
								SET @ForEveryUomId=ISNULL(@ForEveryUomId,0)
							END
						END
						ELSE
						BEGIN
							SET @ForEveryUomId=0
						END
						--->Till Here	
					END
				END
			END
			IF @SchType<>4
			BEGIN
				IF NOT EXISTS(SELECT CmpSchCode FROM Etl_Prk_SchemeMaster_Temp WHERE
					CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					EXEC Proc_DependencyCheck 'SCHEMEMASTER',@GetKey
				END
				
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					SET @Taction=0
				END
				ELSE
				BEGIN
					IF @CombiSch=0 AND @FlexiId=0 AND @RangeId=0
					BEGIN
		  				IF   @SchType=2
						BEGIN
							SET @ForEveryUomId=0
							SET @ToUomId=0
							SET @FromUomId=0
						END
						SET @ToUomId=0
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								
								IF @EtlCnt=@CmpCnt
								BEGIN
									DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
									VALUES 
										(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
										0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
										convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
										convert(INT,@FlexiFree),convert(INT,@FlexiGift),convert(INT,@FlexiPoints),convert(NUMERIC(18,2),@Points),1,1,
										convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES 
									(@GetKey,@SlabCode,@FromQty,0,@FromUomId,
									0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--						SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--						INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
								0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
								@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
					
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(8)) + ',' + CAST(@FromQty AS VARCHAR(8)) + ',' + CAST(0 AS VARCHAR(8)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(8)) + ',' + CAST(0 AS VARCHAR(8)) + ',' + CAST(@ToUomId AS VARCHAR(8)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(8)) + ',' + CAST(@ForEveryUomId AS VARCHAR(8)) + ',' + CAST(@DiscPer AS VARCHAR(8)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(8)) + ',' + CAST(@FlexiDisc AS VARCHAR(8)) + ',' + CAST(@FlexiFlat AS VARCHAR(8)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(8)) + ',' + CAST(@FlexiGift AS VARCHAR(8)) + ',' + CAST(@FlexiPoints AS VARCHAR(8)) + ',' + CAST(@Points AS VARCHAR(8)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
							
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
								0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),convert(INT,@FlexiPoints),convert(NUMERIC(18,2),@Points),1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
						END
					END
					ELSE IF @FlexiId=1 AND @RangeId=0 AND @CombiSch=0
					BEGIN
						IF @FlexiType=1 OR @FlexiType=2
						BEGIN
							IF @ConFig=1
							BEGIN
								SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
								IF @CmpPrdCtgId<@SLevel
								BEGIN
									SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
									AND A.SlabId=0 AND A.SlabValue=0
				
									SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
									A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
									AND A.SlabId=0 AND A.SlabValue=0
								END
								ELSE
								BEGIN
									SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
									AND A.SlabId=0 AND A.SlabValue=0
			
									SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
									WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
									AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
									AND A.SlabId=0 AND A.SlabValue=0
								END
			
								IF @EtlCnt=@CmpCnt
								BEGIN	
									SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
			
									SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
									INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
									WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
			
									IF @EtlCnt=@CmpCnt
									BEGIN
										DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 								SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
						
										INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
											ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
											Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
											MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
										VALUES 
											(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
											0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
											convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
											convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
											1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),
											convert(INT,@MaxValue),convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap)
						
		-- -- 								SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- -- 								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- -- 								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- -- 								MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- -- 								CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- -- 								',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- -- 								CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- -- 								CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- -- 								INSERT INTO Translog(strSql1) Values (@sSQL)
									END
									ELSE
									BEGIN
										DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		-- 								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
										INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
										VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
										0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
										@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
		-- 					
		-- 								SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 								MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 								CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 								CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 								CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 								CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 								CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 								',0,0,0,0,0,0,''N'')'
		-- 								INSERT INTO Translog(strSql1) Values (@sSQL)
										SET @Po_ErrNo =0
									END
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		--							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		--							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,@FromQty,0,@FromUomId,
									0,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
									MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
								VALUES 
									(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
									0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
									convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
									convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
									1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),convert(INT,@MaxValue),
									convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap)
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 						CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 						CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
							END
						END
					END
					ELSE IF @CombiSch=1 AND @FlexiId=0
					BEGIN
						
						IF NOT EXISTS(SELECT SchId FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode)
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
				
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),0,@FromUomId,
								0,convert(INT,@ToUomId),convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
								convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					IF EXISTS(SELECT SchId FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode)
		-- 					BEGIN
		-- 						DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabCombiPrds WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 		
		-- 						INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT @GetKey AS SchId,@SlabCode AS SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,@FromQty AS SlabValue,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121)
		-- 						FROM SchemeProducts WHERE SchId=@GetKey
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT ' + CAST(@GetKey AS VARCHAR(10)) + 'AS SchId,'+ CAST(@SlabCode AS VARCHAR(10)) + 'AS SlabId,
		-- 						PrdCtgValMainId,PrdId,PrdBatId' + CAST(@FromQty AS VARCHAR(10)) + 'AS SlabValue,1,1,
		-- 						''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + '''
		-- 						FROM SchemeProducts WHERE SchId=' + CAST(@GetKey AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					END
						END
		-- 				ELSE
		-- 				BEGIN
		-- 					IF EXISTS(SELECT SchId FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode)
		-- 					BEGIN
		-- 						DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 						SET @sSQL='DELETE FROM SchemeSlabCombiPrds WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 						' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 		
		-- 						INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT @GetKey AS SchId,@SlabCode AS SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,@FromQty AS SlabValue,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121)
		-- 						FROM SchemeProducts WHERE SchId=@GetKey
				
		-- 						SET @sSQL ='INSERT INTO SchemeSlabCombiPrds(SchId,SlabId,PrdCtgValMainId,PrdId,
		-- 						PrdBatId,SlabValue,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		-- 						SELECT ' + CAST(@GetKey AS VARCHAR(10)) + 'AS SchId,'+ CAST(@SlabCode AS VARCHAR(10)) + 'AS SlabId,
		-- 						PrdCtgValMainId,PrdId,PrdBatId' + CAST(@FromQty AS VARCHAR(10)) + 'AS SlabValue,1,1,
		-- 						''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + '''
		-- 						FROM SchemeProducts WHERE SchId=' + CAST(@GetKey AS VARCHAR(10))
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
		-- 					END
		-- 				END
					END
					ELSE IF @RangeId=0
					BEGIN
						DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 				SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 				' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 				INSERT INTO Translog(strSql1) Values (@sSQL)
						SET @TempRange=0
			
						INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
							MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap)
						VALUES 
							(@GetKey,@SlabCode,convert(NUMERIC(18,2),@FromQty),convert(NUMERIC(18,2),@TempRange),@FromUomId,
							0,@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
							convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
							1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
			
		-- 				SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 				ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 				Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 				MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 				CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' +
		-- 				CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 				CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 				CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 				CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 				',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 				INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF (@FlexiId=1 AND @CombiSch=1) OR (@FlexiId=1 AND @RangeId=1)
					BEGIN
						---->Modified By Nanda on 23/08/2009
						IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
						END
						---->Till Here
		--				SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		--				' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		--				INSERT INTO Translog(strSql1) Values (@sSQL)
						IF @RangeId=1
						BEGIN
							SET @TempRange=0
						END
						ELSE
						BEGIN
							SET @TempRange=@FromQty
						END
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								IF @EtlCnt=@CmpCnt
								BEGIN
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
									VALUES 
										(@GetKey,@SlabCode,convert(NUMERIC(18,2),@TempRange),convert(NUMERIC(18,2),@FromQty),@FromUomId,
										convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,
										convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),
										convert(INT,@FlexiFlat),convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,
										convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),
										convert(INT,@MinDisc),convert(INT,@MaxValue),convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 							CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 							CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
		-- 			
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
									@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
--								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
--								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
--								INSERT INTO Translog(strSql1) Values (@sSQL)
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
								@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
								@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
					
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
							VALUES 
								(@GetKey,@SlabCode,convert(NUMERIC(18,2),@TempRange),convert(NUMERIC(18,2),@FromQty),@FromUomId,
								convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,
								convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),convert(INT,@MaxDisc),convert(INT,@MinDisc),convert(INT,@MaxValue),
								convert(INT,@MinValue),@MaxPoints,@MinPoints,@RetailerCap)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(@TempRange AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''','+
		-- 					CAST(@MaxDisc AS VARCHAR(10))+','+CAST(@MinDisc AS VARCHAR(10))+','+CAST(@MaxValue AS VARCHAR(10))+','+CAST(@MinValue AS VARCHAR(10))+','+
		-- 					CAST(@MaxPoints AS VARCHAR(10))+','+CAST(@MinPoints AS VARCHAR(10))+')'
			
							INSERT INTO Translog(strSql1) Values (@sSQL)
						END
					END
					ELSE IF @FlexiId=0 AND @RangeId=1 AND @CombiSch=0
					BEGIN
						IF @ConFig=1
						BEGIN
							SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
							IF @CmpPrdCtgId<@SLevel
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
			
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
								A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							ELSE
							BEGIN
								SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
								SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
								WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
								AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
								AND A.SlabId=0 AND A.SlabValue=0
							END
							IF @EtlCnt=@CmpCnt
							BEGIN	
								SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
								INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
								WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
								IF @EtlCnt=@CmpCnt
								BEGIN
									DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 							SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 							' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									
									INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
										ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
										Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
										MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
									VALUES 
									(@GetKey,@SlabCode,0,convert(NUMERIC(18,2),@FromQty),@FromUomId,
									convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
									convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
									1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
						
		-- 							SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- -- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- -- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- -- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
								END
								ELSE
								BEGIN
									DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
									SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
									' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
									INSERT INTO Translog(strSql1) Values (@sSQL)
									INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
									ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
									Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
									VALUES (@GetKey,@SlabCode,0,@FromQty,@FromUomId,
									@ToQty,@ToUomId,@ForEveryQty,@ForEveryUomId,@DiscPer,@FlatAmt,@FlexiDisc,@FlexiFlat,
									@FlexiFree,@FlexiGift,@FlexiPoints,@Points,0,0,0,0,0,0,'NO')
						
		-- 							SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 							ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 							Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 							MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 							CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 							CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 							CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 							CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 							',0,0,0,0,0,0,''N'')'
		-- 							INSERT INTO Translog(strSql1) Values (@sSQL)
									SET @Po_ErrNo =0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=@GetKey AND SlabId=@SlabCode
								SET @sSQL='DELETE FROM Etl_Prk_SchemeSlabs_Temp WHERE CmpSchCode=' + CAST(@GetKey AS VARCHAR(10)) +
								' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
								INSERT INTO Translog(strSql1) Values (@sSQL)
							
								INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,UpLoadFlag)
								VALUES (@GetKey,CAST(@SlabCode AS INT),0,CAST(@FromQty AS INT),CAST(@FromUomId AS INT),
								CAST(@ToQty AS INT),CAST(@ToUomId AS INT),CAST(@ForEveryQty As INT),CAST(@ForEveryUomId AS INT),CAST(@DiscPer AS NUMERIC(38,6)),CAST(@FlatAmt AS NUMERIC(38,6)),CAST(@FlexiDisc AS INT),CAST(@FlexiFlat AS INT),
								CAST(@FlexiFree AS INT),CAST(@FlexiGift AS INT),CAST(@FlexiPoints AS INT),CAST(@Points AS INT),0,0,0,0,0,0,'NO')
		-- 						SET @sSQL ='INSERT INTO Etl_Prk_SchemeSlabs_Temp(CmpSchCode,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 						ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 						Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 						MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 						CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 						CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 						CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 						CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 						',0,0,0,0,0,0,''N'')'
		-- 						INSERT INTO Translog(strSql1) Values (@sSQL)
								SET @Po_ErrNo =0
							END
						END
						ELSE
						BEGIN
							DELETE FROM SchemeSlabs WHERE SchId=@GetKey AND SlabId=@SlabCode
		-- 					SET @sSQL='DELETE FROM SchemeSlabs WHERE SchId=' + CAST(@GetKey AS VARCHAR(10)) +
		-- 					' AND SlabId=' + CAST(@SlabCode AS VARCHAR(10))
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
							
							INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
								ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
								Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
								MaxValue,MinValue,MaxPoints,MinPoints,RetailerCap) 
							VALUES 
								(@GetKey,@SlabCode,0,convert(NUMERIC(18,2),@FromQty),@FromUomId,
								convert(NUMERIC(18,2),@ToQty),@ToUomId,convert(NUMERIC(18,2),@ForEveryQty),@ForEveryUomId,convert(NUMERIC(5,2),@DiscPer),
								convert(NUMERIC(18,2),@FlatAmt),convert(INT,@FlexiDisc),convert(INT,@FlexiFlat),
								convert(INT,@FlexiFree),convert(INT,@FlexiGift),@FlexiPoints,@Points,1,1,convert(varchar(10),getdate(),121),
								1,convert(varchar(10),getdate(),121),0,0,0,0,0,0,@RetailerCap)
				
		-- 					SET @sSQL ='INSERT INTO SchemeSlabs(SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,
		-- 					ForEveryUomId,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
		-- 					Points,Availability,LastModBy,LastModDate,AuthId,AuthDate,MaxDiscount,MinDiscount,
		-- 					MaxValue,MinValue,MaxPoints,MinPoints) VALUES ('+ CAST(@GetKey AS VARCHAR(10)) + ',' +
		-- 					CAST(@SlabCode AS VARCHAR(10)) + ',' + CAST(0 AS VARCHAR(10)) + ',' + CAST(@FromQty AS VARCHAR(10)) + ',' +
		-- 					CAST(@FromUomId AS VARCHAR(10)) + ',' + CAST(@ToQty AS VARCHAR(10)) + ',' + CAST(@ToUomId AS VARCHAR(10)) + ',' +
		-- 					CAST(@ForEveryQty AS VARCHAR(10)) + ',' + CAST(@ForEveryUomId AS VARCHAR(10)) + ',' + CAST(@DiscPer AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlatAmt AS VARCHAR(10)) + ',' + CAST(@FlexiDisc AS VARCHAR(10)) + ',' + CAST(@FlexiFlat AS VARCHAR(10)) + ',' +
		-- 					CAST(@FlexiFree AS VARCHAR(10)) + ',' + CAST(@FlexiGift AS VARCHAR(10)) + ',' + CAST(@FlexiPoints AS VARCHAR(10)) + ',' + CAST(@Points AS VARCHAR(10)) +
		-- 					',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',0,0,0,0,0,0)'
		-- 					INSERT INTO Translog(strSql1) Values (@sSQL)
						END					
					END
				END
			END
		END
	END
	
	FETCH NEXT FROM Cur_SchemeSlabDt INTO  @SchCode,@SlabCode,@FromUOM,@FromQty,@ToUOM,@ToQty,@ForEveryUOM,
		@ForEveryQty,@DiscPer,@FlatAmt,@Points,@FlexiFree,@FlexiGift,@FlexiDisc,@FlexiFlat,@FlexiPoints,
		@MaxDisc,@MinDisc,@MaxValue,@MinValue,@MaxPoints,@MinPoints,@RetailerCap
	END
	CLOSE Cur_SchemeSlabDt
	DEALLOCATE Cur_SchemeSlabDt
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_BLSchemeMaster' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeMaster
GO
/*
BEGIN TRANSACTION
update schememaster set schstatus = 0 where cmpschcode = 'SCH00007'
EXEC Proc_Cn2Cs_BLSchemeMaster 0
select *from schememaster where cmpschcode = 'SCH00007'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************
* PROCEDURE	: Proc_Cn2Cs_BLSchemeMaster
* PURPOSE	: To Insert and Update records Of Scheme Master
* CREATED	: Boopathy.P on 31/12/2008
* DATE         AUTHOR       DESCRIPTION
****************************************************************************************************
* 25.08.2009   Panneer		Added BudgetAllocationNo in SchemeMaster Table
* 20.10.2009   Thiru		Added SchBasedOn in SchemeMaster Table		
* 22/04/2010   Nanda 		Added FBM
* 28/12/2010   Nanda 		Added Settlement Type
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*************************************************  
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]  
* 03
03-01-2018  Lakshman. M      ICRSTPAR7277        BUG      Scheme description amp;  (special character)Script validation added from CS.  
18-06-2018	Karthick.KJ		 CRCRSTPAR0007		 CR		  Claim Apply with/Without Tax
**************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 		AS NVARCHAR(100)
	DECLARE @SchDesc 		AS NVARCHAR(200)
	DECLARE @CmpCode 		AS NVARCHAR(50)
	DECLARE @ClmAble 		AS NVARCHAR(50)
	DECLARE @ClmAmtOn 		AS NVARCHAR(50)
	DECLARE @ClmGrpCode		AS NVARCHAR(50)
	DECLARE @SelnOn			AS NVARCHAR(50)
	DECLARE @SelLvl			AS NVARCHAR(50)
	DECLARE @SchType		AS NVARCHAR(50)
	DECLARE @BatLvl			AS NVARCHAR(50)
	DECLARE @FlxSch			AS NVARCHAR(50)
	DECLARE @FlxCond		AS NVARCHAR(50)
	DECLARE @CombiSch		AS NVARCHAR(50)
	DECLARE @Range			AS NVARCHAR(50)
	DECLARE @ProRata		AS NVARCHAR(50)
	DECLARE @Qps			AS NVARCHAR(50)
	DECLARE @QpsReset		AS NVARCHAR(50)
	DECLARE @ApyQpsOn		AS NVARCHAR(50)
	DECLARE @ForEvery		AS NVARCHAR(50)
	DECLARE @SchStartDate	AS NVARCHAR(50)
	DECLARE @SchEndDate		AS NVARCHAR(50)
	DECLARE @SchBudget		AS NVARCHAR(50)
	DECLARE @EditSch		AS NVARCHAR(50)
	DECLARE @AdjDisSch		AS NVARCHAR(50)
	DECLARE @SetDisMode		AS NVARCHAR(50)
	DECLARE @SchStatus		AS NVARCHAR(50)
	DECLARE @SchBasedOn		AS NVARCHAR(50)
	DECLARE @StatusId		AS INT
	DECLARE @CmpId			AS INT
	DECLARE @ClmGrpId		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @ClmableId		AS INT
	DECLARE @ClmAmtOnId		AS INT
	DECLARE @SelMode		AS INT
	DECLARE @SchTypeId		AS INT
	DECLARE @BatId			AS INT
	DECLARE @FlexiId		AS INT
	DECLARE @FlexiConId		AS INT
	DECLARE @CombiId		AS INT
	DECLARE @RangeId		AS INT
	DECLARE @ProRateId		AS INT
	DECLARE @QPSId			AS INT
	DECLARE @QPSResetId		AS INT
	DECLARE @AdjustSchId	AS INT
	DECLARE @ApplySchId		AS INT
	DECLARE @ForEveryId		AS INT
	DECLARE @SettleSchId	AS INT
	DECLARE @EditSchId		AS INT
	DECLARE @ChkCount		AS INT		
	DECLARE @ConFig			AS INT
	DECLARE @CmpCnt			AS INT
	DECLARE @EtlCnt			AS INT
	DECLARE @SLevel			AS INT
	DECLARE @SchBasedOnId	AS INT
	DECLARE @ErrDesc		AS NVARCHAR(1000)
	DECLARE @TabName		AS NVARCHAR(50)
	DECLARE @GetKey			AS INT
	DECLARE @GetKeyStr		AS NVARCHAR(200)
	DECLARE @Taction		AS INT
	DECLARE @sSQL			AS VARCHAR(4000)
	DECLARE @iCnt			AS INT
	DECLARE @BudgetAllocationNo	AS NVARCHAR(100)
	DECLARE @FBM				AS NVARCHAR(10)
	DECLARE @FBMId				AS INT
	DECLARE @SettlementType		AS NVARCHAR(10)
	DECLARE @SettlementTypeId	AS INT
	DECLARE @FBMDate			AS DATETIME
	DECLARE @AllowUnCheck		AS NVARCHAR(10)
	DECLARE @AllowUnCheckId		AS INT
	DECLARE @CombiType			AS NVARCHAR(50)
	DECLARE @CombiTypeId		AS INT
	DECLARE @SchApplyOn			AS VARCHAR(100)
	DECLARE @SchApplyOnId		AS INT
	DECLARE @ApplyTaxForClaim   AS VARCHAR(50)
	DECLARE @ApplyTax			AS INT
	
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	SET @AdjustSchId=0
	SET @iCnt=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE @DistCode AS  NVARCHAR(50)
	SELECT @DistCode=ISNULL(DistributorCode,'') FROM Distributor
	---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
	Declare @Lvar Int  
	Declare @MaxId Int
	Declare @SqlStr Varchar(8000)  
	Declare @Process Varchar(100)  
	Declare @colcount Int  
	Declare @Col Varchar(5000)
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Etl_Prk_SchemeHD_Slabs_Rules'
	And A.system_type_id = C.system_type_id And C.name='nvarchar' and A.column_id= 3
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ---------------------------------- Till here -------------------
	
	--->Added By Nanda on 17/09/2009
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SchToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SchToAvoid	
	END
	
	CREATE TABLE SchToAvoid
	(
		CmpSchCode NVARCHAR(50)
	)
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
	WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product'))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','CmpSchCode','Product :'+PrdCode+' not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)		
		SELECT @DistCode,'Scheme',CmpSchCode,'Product',PrdCode,'','N'
		FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND 
		CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Attributes','Attributes not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Products','Scheme Products not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Header','Header not Available for Scheme:'+CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
	END
	
	--->Till Here
	DECLARE Cur_SchMaster CURSOR
	FOR SELECT DISTINCT
	ISNULL([CmpSchCode],'') AS [Company Scheme Code],
	ISNULL([SchDsc],'') AS [Scheme Description],
	ISNULL([CmpCode],'') AS [Company Code],
	ISNULL([Claimable],'') AS [Claimable],
	ISNULL([ClmAmton],'') AS [Claim Amount On],
	ISNULL([ClmGroupCode],'') AS [Claim Group Code],
	ISNULL([SchemeLevelMode],'') AS [Selection On],
	ISNULL([SchLevel],'') AS [Selection Level Value],
	ISNULL([SchType],'') AS [Scheme Type],
	ISNULL([BatchLevel],'') AS [Batch Level],
	ISNULL([FlexiSch],'') AS [Flexi Scheme],
	ISNULL([FlexiSchType],'') AS [Flexi Conditional],
	ISNULL([CombiSch],'') AS [Combi Scheme],
	ISNULL([Range],'') AS [Range],
	ISNULL([ProRata],'') AS [Pro - Rata],
	ISNULL([Qps],'NO') AS [Qps],
	ISNULL([QPSReset],'') AS [Qps Reset],
	ISNULL([ApyQPSSch],'') AS [Qps Based On],
	ISNULL([PurofEvery],'') AS [Allow For Every],
	ISNULL([SchValidFrom],'') AS [Scheme Start Date],
	ISNULL([SchValidTill],'') AS [Scheme End Date],
	ISNULL([Budget],'') AS [Scheme Budget],
	ISNULL([EditScheme],'') AS [Allow Editing Scheme],
	ISNULL([AdjWinDispOnlyOnce],'0') AS [Adjust Display Once],
	ISNULL([SetWindowDisp],'') AS [Settle Display Through],
	ISNULL(SchStatus,'') AS SchStatus,
	--ISNULL(BudgetAllocationNo,'') AS BudgetAllocationNo,
	ISNULL(CircularNo,'') AS BudgetAllocationNo,
	ISNULL(SchBasedOn,'') AS SchemeBasedOn,
	ISNULL(FBM,'No') AS FBM,
	ISNULL(SettlementType,'ALL') AS SettlementType,
	ISNULL([AllowUncheck],'NO') AS AllowUncheck,
	ISNULL([CombiType],'NORMAL') AS [CombiType],
	ISNULL(SchApplyOn,'SELLINGRATE') AS SchApplyOn,
	ISNULL(ApplyTaxForClaim,'YES') AS ApplyTaxForClaim
	FROM Etl_Prk_SchemeHD_Slabs_Rules (NOLOCK)
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'			 
	ORDER BY [Company Scheme Code]
	OPEN Cur_SchMaster
	FETCH NEXT FROM Cur_SchMaster INTO @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
	, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
	, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
	@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CombiTypeId=0	
		SET @SchBasedOn='RETAILER'
		SET @Po_ErrNo =0		
		SET @Taction = 2
		SET @iCnt=@iCnt+1
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchDesc))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Description should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (2,@TabName,'Scheme Description',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CmpCode))= ''
		BEGIN
			SET @ErrDesc = 'Company should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (3,@TabName,'Company',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAble))= ''
		BEGIN
			SET @ErrDesc = 'Claimable should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (4,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAmtOn))= ''
		BEGIN
			SET @ErrDesc = 'Claim Amount On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (5,@TabName,'Claim Amount On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (6,@TabName,'Scheme Level Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelLvl))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (7,@TabName,'Scheme Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchType))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (8,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@BatLvl))= ''
		BEGIN
			SET @ErrDesc = 'Batch Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (9,@TabName,'Batch Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxSch))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (10,@TabName,'Flexi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxCond))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (11,@TabName,'Flexi Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiSch))= ''
		BEGIN
			SET @ErrDesc = 'Combi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (12,@TabName,'Combi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Range))= ''
		BEGIN
			SET @ErrDesc = 'Range should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (13,@TabName,'Range Based Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ProRata))= ''
		BEGIN
			SET @ErrDesc = 'Pro-Rata should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (14,@TabName,'Pro-Rata',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Qps))= ''
		BEGIN
			SET @ErrDesc = 'QPS Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (15,@TabName,'QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@QpsReset))= ''
		BEGIN
			SET @ErrDesc = 'QPS Reset should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (16,@TabName,'QPS Reset',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ApyQpsOn))= ''
		BEGIN
			SET @ErrDesc = 'Apply QPS Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (17,@TabName,'Apply QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStartDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Start Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (19,@TabName,'Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchStartDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme Start Date is not Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (20,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchStartDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme Start Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (21,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchEndDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme End Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (23,@TabName,'End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchEndDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme End Date is not in Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (24,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchEndDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme End Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (25,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@EditSch))= ''
		BEGIN
			SET @ErrDesc = 'Allow Editing Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (28,@TabName,'Editing Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SetDisMode))= ''
		BEGIN
			SET @ErrDesc = 'Settle Window Display Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (30,@TabName,'Settle Window Display Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Selection On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (31,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStatus))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Status should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (32,@TabName,'Scheme Status',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchBasedOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiType))= ''
		BEGIN
			SET @ErrDesc = 'CombiType should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchApplyOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END 
		IF ((UPPER(LTRIM(RTRIM(@CombiType)))<> 'NORMAL') AND (UPPER(LTRIM(RTRIM(@CombiType)))<> 'FLUCTUATING'))
		BEGIN
			SET @ErrDesc = 'CombiType should be (NORMAL OR FLUCTUATING) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'SELLINGRATE') AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'MRP') 
		AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'PURCHASERATE'))
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should be (SELLINGRATE OR MRP OR PURCHASERATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'RETAILER') AND (UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'KEY GROUP'))
		BEGIN
			SET @ErrDesc = 'Scheme Based On should be (RETAILER OR KEY GROUP) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SelnOn)))<> 'UDC') AND (UPPER(LTRIM(RTRIM(@SelnOn)))<> 'PRODUCT'))
		BEGIN
			SET @ErrDesc = 'Selection On should be (UDC OR PRODUCT) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (33,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@ClmAble)))<> 'YES') AND (UPPER(LTRIM(RTRIM(@ClmAble)))<> 'NO'))
		BEGIN
			SET @ErrDesc = 'Claimable should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (34,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchStatus)))<> 'ACTIVE') AND (UPPER(LTRIM(RTRIM(@SchStatus)))<> 'INACTIVE'))
		BEGIN
			SET @ErrDesc = 'Scheme Stauts should be (ACTIVE OR INACTIVE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (35,@TabName,'Scheme Stauts',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES')
		BEGIN
			IF LTRIM(RTRIM(@ClmGrpCode))= ''
			BEGIN
				SET @ErrDesc = 'Claim Group Code should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (36,@TabName,'Claim Group Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'PURCHASE RATE' AND UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'SELLING RATE')
		BEGIN
			SET @ErrDesc = 'Claimable Amount should be (PURCHASE RATE OR SELLING RATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (37,@TabName,'Claimable Amount',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@SchType)))<>'WINDOW DISPLAY' AND UPPER(LTRIM(RTRIM(@SchType)))<>'AMOUNT'
		   AND UPPER(LTRIM(RTRIM(@SchType)))<>'WEIGHT' AND UPPER(LTRIM(RTRIM(@SchType)))<>'QUANTITY')
		BEGIN
			SET @ErrDesc = 'Scheme Type should be (WINDOW DISPLAY OR AMOUNT OR WEIGHT OR QUANTITY) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (38,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		--CRCRSTPAR0007
		IF (UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'NO')
		BEGIN
			SET @ErrDesc = 'ApplyTaxForClaim) should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'ApplyTaxForClaim',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY')
		BEGIN
			IF (UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL')
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (39,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (40,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (41,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (42,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (43,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (44,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (NO) for WINDOW DISPLAY SCHEME for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (45,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (NO)for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (46,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LTRIM(RTRIM(@AdjDisSch))= ''
			BEGIN
				SET @ErrDesc = 'Adjust Window Display Scheme Only Once should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (47,@TabName,'Adjust Window Display Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH' AND UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CHEQUE')
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH OR CHEQUE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (48,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE')
			BEGIN
				SET @ErrDesc = 'Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (50,@TabName,'Apply QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT' AND UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
			AND UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY')
		BEGIN
			IF UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL'
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (51,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL' AND UPPER(LTRIM(RTRIM(@FlxCond)))<> 'CONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL OR CONDITIONAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (53,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL')
				BEGIN
					SET @ErrDesc = 'Flexi Scheme Type should be UNCONDITIONAL When Flexi Scheme is YES for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (54,@TabName,'Flexi Scheme Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (55,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (56,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   OR UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (57,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then RANGE should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (58,@TabName,'Range',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then PRO-RATA should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (59,@TabName,'Pro-Rata',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (60,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'YES' AND UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (61,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO, Then QPS Reset should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (62,@TabName,'QPS Reset',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO,Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (63,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE' AND UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'QUANTITY'
				BEGIN
					SET @ErrDesc = 'Apply QPS Scheme Should be (DATE OR QUANTITY) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (64,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH'
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (65,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'YES' AND UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Allow uncheck claimable should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Allow Uncheck',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF NOT EXISTS(SELECT CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode)))
			BEGIN
				SET @ErrDesc = 'Company Not Found for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (66,@TabName,'Company',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @CmpId=CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode))
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			SET @GetKey=0
			SET @GetKeyStr=''
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster SM WHERE CMPID=@CmpId AND SM.CmpSchCode=LTRIM(RTRIM(@SchCode)))
			BEGIN
				SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('SchemeMaster','SchId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
				SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('SchemeMaster','SchCode',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))				
				SET @Taction = 2
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@GetKeyStr=SchCode FROM SchemeMaster WHERE CMPID=@CmpId AND CmpSchCode=LTRIM(RTRIM(@SchCode))
				SET @Taction = 1
			END
		END
		IF @GetKey=0	
		BEGIN
			SET @ErrDesc = 'Scheme Id should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Id',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LEN(LTRIM(RTRIM(@GetKeyStr )))=''
		BEGIN
			SET @ErrDesc = 'Scheme Code should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF @Taction = 2
		BEGIN 
			IF @GetKey<=(SELECT ISNULL(MAX(SchId),0) AS SchId FROM SchemeMaster)
			BEGIN
				SET @ErrDesc = 'Reset the counters/Check the system date'
				INSERT INTO Errorlog VALUES (67,@TabName,'SchId',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'RETAILER'
				SET @SchBasedOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'KEY GROUP'
				SET @SchBasedOnId=2
		END 
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ClmAble)))='YES'
			BEGIN
				IF NOT EXISTS(SELECT ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode)))
				BEGIN
					SET @ErrDesc = 'Claim Group Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (67,@TabName,'Claim Group',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @ClmGrpId=ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode))
				END
			END
			ELSE
			BEGIN
				SET @ClmGrpId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SelnOn)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@SelnOn)))='SKU' OR UPPER(LTRIM(RTRIM(@SelnOn)))='MATERIAL'
			BEGIN
				IF NOT EXISTS(SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=UPPER(LTRIM(RTRIM(@SelLvl))) AND LevelName <> 'Level1')
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (68,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=LTRIM(RTRIM(@SelLvl)) AND LevelName <> 'Level1'
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))='UDC'
			BEGIN
				IF NOT EXISTS(SELECT DISTINCT A.UdcMasterId FROM UdcMaster A
					INNER JOIN UdcHD B ON A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl)))
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (69,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=A.UdcMasterId FROM UdcMaster A INNER JOIN UdcHD B ON
					A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl))
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'ACTIVE'
				SET @StatusId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'INACTIVE'
				SET @StatusId=0
			IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES'
				SET @ClmableId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'NO'
				SET @ClmableId=0
			
			IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'PURCHASE RATE'
				SET @ClmAmtOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'SELLING RATE'
				SET @ClmAmtOnId=2
			
			IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'UDC'
				SET @SelMode=1
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'PRODUCT'
				SET @SelMode=0
			
			IF UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY'
				SET @SchTypeId=4
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT'
				SET @SchTypeId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
				SET @SchTypeId=3
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY'
				SET @SchTypeId=1
			
			IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'YES'
				SET @BatId=1
			ELSE IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))= 'ALL'
				SET @BatId=0
			
			
			IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'YES'
				SET @FlexiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO'
				SET @FlexiId=0
			
			IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'UNCONDITIONAL'
				SET @FlexiConId=2
			ELSE IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL'
				SET @FlexiConId=1
			ELSE
				SET @FlexiConId=2
			
			IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'YES'				
				SET @CombiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'NO'
				SET @CombiId=0
			IF UPPER(LTRIM(RTRIM(@CombiType)))= 'FLUCTUATING'
				SET @CombiTypeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NORMAL'
				SET @CombiTypeId=0
			
			IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'MRP'				
				SET @SchApplyOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'SELLINGRATE'
				SET @SchApplyOnId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'PURCHASERATE'
				SET @SchApplyOnId=3
				
			
			IF UPPER(LTRIM(RTRIM(@Range)))= 'YES'
				SET @RangeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NO'
				SET @RangeId=0
			
			IF UPPER(LTRIM(RTRIM(@ProRata)))= 'YES'
				SET @ProRateId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'NO'
				SET @ProRateId=0
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'ACTUAL'
				SET @ProRateId=2
			
			IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
				SET @QPSId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
				SET @QPSId=0
			
			IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'YES'
				SET @ForEveryId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'NO'
				SET @ForEveryId=0
			IF UPPER(LTRIM(RTRIM(@EditSch)))= 'YES'
				SET @EditSchId=0
			ELSE IF UPPER(LTRIM(RTRIM(@EditSch)))= 'NO'
				SET @EditSchId=0
			IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				SET @QPSResetId=1
			ELSE IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'NO'
				SET @QPSResetId=0
			IF LTRIM(RTRIM(@SchBudget))= ''
			BEGIN
				SET @SchBudget=0
			END
			
			IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'YES'
			BEGIN
				SET @ApplyTax=1
			END	
			ELSE IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'NO'
			BEGIN
				SET @ApplyTax=0		
			END
			  
			IF @SchTypeId=4
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
					SET @ApplySchId=1
				IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CASH'
					SET @SettleSchId=1
				ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CHEQUE'
					SET @SettleSchId=2
				IF LTRIM(RTRIM(@AdjDisSch))= 'NO'
					SET @AdjustSchId=0
				ELSE IF LTRIM(RTRIM(@AdjDisSch))= 'YES'
					SET @AdjustSchId=1
			END
			ELSE
			BEGIN
				IF @QPSId=1
				BEGIN
					IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
						SET @ApplySchId=1
					ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))='QUANTITY'
						SET @ApplySchId=2
					SET @SettleSchId=1
				END
				ELSE
				BEGIN
					SET @SettleSchId=1
					SET @ApplySchId=1
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @FBM='Yes'
			BEGIN
				SET @FBMId=1
				SET @SchBudget=0
			END
			ELSE
			BEGIN
				SET @FBMId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @SettlementType='Value'
			BEGIN
				SET @SettlementTypeId=1				
			END
			ELSE IF @SettlementType='Product'
			BEGIN
				SET @SettlementTypeId=2
			END
			ELSE 
			BEGIN
				SET @SettlementTypeId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@AllowUnCheck)))= 'YES'
			BEGIN
				SET @AllowUnCheckId=1
			END
			ELSE
			BEGIN
				SET @AllowUnCheckId=0
			END
		END
		 
		
		IF @Po_ErrNo = 0
		BEGIN
			IF @Taction=1
			BEGIN
				EXEC Proc_DependencyCheck 'SchemeMaster',@GetKey
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					UPDATE SCHEMEMASTER SET SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					--Budget=@SchBudget,SchStatus=@StatusId WHERE SchId=@GetKey
					Budget=@SchBudget/*,SchStatus=@StatusId*/ WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
				END
				ELSE
				BEGIN
					DELETE FROM SchemeProducts WHERE SchId=@GetKey
					DELETE FROM SchemeRetAttr WHERE SchId=@GetKey
					DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabFrePrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabMultiFrePrds WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRtrLevelValidation WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRuleSettings WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdDt WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdHd WHERE SchId=@GetKey
					DELETE FROM SchemeSlabs WHERE SchId=@GetKey
					
					UPDATE SCHEMEMASTER SET SchDsc=LTRIM(RTRIM(@SchDesc)),CmpId=@CmpId,
					Claimable=@ClmableId,ClmAmton=@ClmAmtOnId,ClmRefId=@ClmGrpId,
					SchLevelId=@CmpPrdCtgId,SchType=@SchTypeId,BatchLevel=@BatId,
					FlexiSch=@FlexiId,FlexiSchType=@FlexiConId,CombiSch=@CombiId,
					Range=@RangeId,ProRata=@ProRateId,QPS=@QPSId,QPSReset=@QPSResetId,
					SchValidFrom=LTRIM(RTRIM(@SchStartDate)),SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					Budget=@SchBudget,ApyQPSSch=@ApplySchId,SetWindowDisp=@SettleSchId,
					--SchemeLvlMode=@SelMode,SchStatus=@StatusId WHERE SchId=@GetKey
					SchemeLvlMode=@SelMode/*,SchStatus=@StatusId*/ WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
					
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					and SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
				END
			END
			ELSE IF @Taction=2
			BEGIN
				IF @ConFig=1
				BEGIN
					SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
					IF @CmpPrdCtgId<@SLevel
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
	
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
						A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
					END
					ELSE
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
						AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
					END
						IF @EtlCnt=@CmpCnt
						BEGIN
							SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
	
							SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
							IF @EtlCnt=@CmpCnt
							BEGIN	
								INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
								AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,
								BudgetAllocationNo,AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,
								SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim)
								VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
								LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,
								CONVERT(VARCHAR(10),GETDATE(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,
								@BudgetAllocationNo,0,0,@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax)
				
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
								IF @FBMId=1
								BEGIN
									SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
									SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
									EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								
								INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download) VALUES
								(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1)
							END
						END
						ELSE
						BEGIN
							DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							
							INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
							CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
							ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
							PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download) VALUES
							(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
							@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
							@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
							@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1)
						END							
				END
				ELSE
				BEGIN
					INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
					CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
					ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
					PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
					AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,BudgetAllocationNo,
					AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim)
					VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
					LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
					@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
					@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
					@ApplySchId,@SettleSchId,1,1,convert(varchar(10),getdate(),121),1,
					convert(varchar(10),getdate(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,@BudgetAllocationNo,0,0,
					@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax)
	
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					AND SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
					IF @FBMId=1
					BEGIN
						SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
						SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
						EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
					END
				END
			END
		END
		FETCH NEXT FROM Cur_SchMaster INTO  @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
		, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
		, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
		@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim
	END
	CLOSE Cur_SchMaster
	DEALLOCATE Cur_SchMaster
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_ReturnSlabSchemeDetails' AND XTYPE='TF')
DROP FUNCTION Fn_ReturnSlabSchemeDetails
GO
CREATE FUNCTION Fn_ReturnSlabSchemeDetails(@Pi_SchType INT,@Pi_SchId INT)
RETURNS @ReturnSlabDetailes TABLE
(
SlabId INT,
PurQty NUMERIC(36,0),
FROMQty NUMERIC(36,0),
PurUomId INT,
PurUom NVARCHAR(50),
FrmConFact NUMERIC(36,0),
ToQty NUMERIC(36,0),
PurToUomId INT,
PurToUom NVARCHAR(50),
ToConFact NUMERIC(36,0),
ForEveryQty NUMERIC(36,0),
PurofUomId INT,
PurofUom NVARCHAR(50),
PurofConFact NUMERIC(36,0),
DiscPer NUMERIC(36,4),
FlatAmt NUMERIC(36,4),
FlxDisc TINYINT,
FlxValueDisc TINYINT,
FlxFreePrd TINYINT,
FlxGiftPrd TINYINT,
FlxPoints TINYINT,
Points NUMERIC(36,4),
RetailerCap NUMERIC(18,2)
)
AS
BEGIN
/***********************************************************
Funcation Name   : Fn_ReturnSlabSchemeDetails
Added Date       : 2012/07/24
Added By         : Sathishkumar Veeramani

************************************************************
Modified By karthick CrNo-CRCRSTPAR0007 Retailer Cap Download on 18/06/2018	
************************************************************/
IF @Pi_SchType = 3 ---Weight based scheme type
BEGIN
        INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
        DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap)
        SELECT DISTINCT SlabId,PurQty,FROMQty,SS.UomId AS PurUomId,Fp.PrdUnitCode AS PurUom,ToQty,ToUomId AS PurToUomId,Tp.PrdUnitCode AS PurToUom,
        ForEveryQty,ForEveryUomId AS PurofUomId,Ep.PrdUnitCode AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap
        FROM SchemeSlabs SS WITH (NOLOCK),Productunit FP  WITH (NOLOCK),Productunit TP  WITH (NOLOCK),Productunit EP  WITH (NOLOCK)
        WHERE TP.Prdunitid = SS.Uomid AND EP.Prdunitid = SS.Uomid AND FP.prdunitid = SS.Uomid AND 
        SS.SchId = @Pi_SchId ORDER BY Slabid    
END
IF (@Pi_SchType = 1 OR @Pi_SchType = 5) --Quantity based scheme type
BEGIN
		INSERT INTO @ReturnSlabDetailes
		SELECT DISTINCT SlabId,PurQty,FROMQty,PurUomId,PurUom,FrmConFact,ToQty,
		ToUomId AS PurToUomId,PurToUom,ToConFact,ForEveryQty,ForEveryUomId AS PurofUomId,
		PurofUom,PurofConFact,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap
		FROM SchemeSlabs Z WITH(Nolock)INNER JOIN
		(SELECT UOMId AS PurUomId,UomCode AS PurUom,MAX(ConversionFactor) AS FrmConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)A 
		ON Z.UomId = A.PurUomId INNER JOIN
		(SELECT UOMId,UomCode AS PurToUom,MAX(ConversionFactor) AS ToConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)B
		ON Z.UomId = B.UOMId INNER JOIN
		(SELECT UOMId,UomCode AS PurofUom,MAX(ConversionFactor) AS PurofConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)C
		ON Z.UomId = C.UOMId WHERE Z.SchId = @Pi_SchId ORDER BY SlabId
END      
ELSE IF @Pi_SchType <> 1 AND @Pi_SchType <> 3        
BEGIN
       INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
       DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points,RetailerCap)
       SELECT DISTINCT SlabId,PurQty,FROMQty,UomId AS PurUomId,'' AS PurUom,ToQty,ToUomId AS PurToUomId,'' AS PurToUom,
       ForEveryQty,forEveryUomId AS PurofUomId,'' AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd, 
       FlxPoints,Points,RetailerCap FROM SchemeSlabs SS WITH (NOLOCK) WHERE SS.SchId = @Pi_SchId ORDER BY Slabid
END
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ApplySchemeInBill' AND XTYPE='P')
DROP PROCEDURE Proc_ApplySchemeInBill
GO
/*
BEGIN TRANSACTION
EXEC Proc_ApplySchemeInBill 2561,1390,0,1,2
SELECT * FROM BillAppliedSchemeHd
-- SELECT * FROM BilledPrdHdForScheme(NOLOCK)
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [dbo].[Proc_ApplySchemeInBill]
(
	@Pi_SchId  		INT,
	@Pi_RtrId		INT,
	@Pi_SalId  		INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT	
)
AS
/************************************************************************************************
* PROCEDURE		: Proc_ApplySchemeInBill
* PURPOSE		: To Apply the Scheme and Get the Scheme Details for the Selected Scheme
* CREATED		: Thrinath
* CREATED DATE	: 17/04/2007
* NOTE			: General SP for Returning the Scheme Details for the Selected Scheme
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------------------------------------------------------
* {date}       {developer}  {brief modification description}
* 08-08-2011	   Boopathy.P   Stock validation Removed
* 19-06-2018	   Karthick.KJ	CRCRSTPAR0007 Slab wise Retailer cap
* 30-08-2018	   S.MOORTHI	ILCRSTPAR1920 Slab wise Retailer cap
* 01-09-2018	   Amuthakumar P ILCRSTPAR1920 Slab wise Retailer cap
* 23-10-2018	   S.MOORTHI	ILCRSTPAR2412  Retailer CApping Logic to be changed (Calculate Eligible Retailers based on Slab Perc First)
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
		
	DECLARE @SchType		INT
	DECLARE @SchCode		nVarChar(40)
	DECLARE @BatchLevel		INT
	DECLARE @FlexiSch		INT
	DECLARE @FlexiSchType		INT
	DECLARE @CombiScheme		INT
	DECLARE @RangeScheme		INT
	DECLARE @ProRata		INT
	DECLARE @Qps			INT
	DECLARE @QpsReset		INT
	DECLARE @PurOfEveryReq		INT
	DECLARE @SchemeBudget		NUMERIC(38,6)
	DECLARE @SlabId			INT
	DECLARE @NoOfTimes		NUMERIC(38,6)
	DECLARE @GrossAmount		NUMERIC(38,6)
	DECLARE @BudgetUtilized		NUMERIC(38,6)
	DECLARE @BillDate 		DATETIME
	DECLARE @FrmValidDate		DateTime
	DECLARE @ToValidDate		DateTime
	DECLARE @RetailerCap	NUMERIC(18,2)--CRCRSTPAR0007
	DECLARE @SchValidFrom	DATETIME--CRCRSTPAR0007
	DECLARE @SchValidTill	DATETIME--CRCRSTPAR0007
	DECLARE @CtgLevelId INT--CRCRSTPAR0007
	DECLARE @CtgMainid INT--CRCRSTPAR0007
	DECLARE @RtrClassId INT--CRCRSTPAR0007
	DECLARE @Rtrid INT --CRCRSTPAR0007 
	DECLARE @TotRtrCnt	INT--CRCRSTPAR0007
	DECLARE @BilledRtrCnt INT--CRCRSTPAR0007
	DECLARE @AchPercentage	NUMERIC(18,2)--CRCRSTPAR0007
		
	DECLARE @TempBilled TABLE
	(
		PrdId				INT,
		PrdBatId			INT,
		SchemeOnQty 		NUMERIC(38,0),
		SchemeOnAmount		NUMERIC(38,6),
		SchemeOnKG			NUMERIC(38,6),
		SchemeOnLitre		NUMERIC(38,6),
		SchId 				INT,
		SchemeOnAmtWithTax NUMERIC(38,6)
	)
	
	DECLARE @TempBilledAch TABLE
	(
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		ToSchAch		NUMERIC(38,6),
		ToUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT,
		ToQty			NUMERIC(38,6),
		ToUomId			INT
	)
	
	DECLARE @TempSchSlabAmt TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		DiscPer			NUMERIC(38,6),
		FlatAmt			NUMERIC(38,6),
		Points			INT,
		FlxDisc			TINYINT,
		FlxValueDisc		TINYINT,
		FlxFreePrd		TINYINT,
		FlxGiftPrd		TINYINT,
		FlxPoints		TINYINT
	)
	
	DECLARE @TempSchSlabFree TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		FreePrdId		INT,
		FreeQty			INT
	)
	
	DECLARE @TempSchSlabGift TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		GiftPrdId		INT,
		GiftQty			INT
	)
	
	DECLARE @MoreBatch TABLE
	(
		SchId		INT,
		SlabId		INT,
		PrdId		INT,
		PrdCnt		INT,
		PrdBatCnt	INT
	)
	
	DECLARE @TempBillAppliedSchemeHd TABLE
	(
		SchId		int,
		SchCode		nvarchar(50),
		FlexiSch	tinyint,
		FlexiSchType	tinyint,
		SlabId		int,
		SchemeAmount	numeric(32,6),
		SchemeDiscount	numeric(32,6),
		Points		int,
		FlxDisc		tinyint,
		FlxValueDisc	tinyint,
		FlxFreePrd	tinyint,
		FlxGiftPrd	tinyint,
		FlxPoints	tinyint,
		FreePrdId	int,
		FreePrdBatId	int,
		FreeToBeGiven	int,
		GiftPrdId	int,
		GiftPrdBatId	int,
		GiftToBeGiven	int,
		NoOfTimes	numeric(32,6),
		IsSelected	tinyint,
		SchBudget	numeric(32,6),
		BudgetUtilized	numeric(32,6),
		TransId		tinyint,
		Usrid		int,
		PrdId		int,
		PrdBatId	int,
		SchType		int
	)
	
	SELECT @SchCode = SchCode,@SchType = SchType,@BatchLevel = BatchLevel,@FlexiSch = FlexiSch,
		@FlexiSchType = FlexiSchType,@CombiScheme = CombiSch,@RangeScheme = Range,@ProRata = ProRata,
		@Qps = QPS,@QpsReset = QPSReset,@SchemeBudget = Budget,
		@PurOfEveryReq = PurofEvery,@SchValidFrom=SchValidFrom,@SchValidTill=SchValidTill
	FROM SchemeMaster WHERE SchId = @Pi_SchId AND MasterType=1
	
	IF @SchType=2 
	BEGIN
		EXEC CALCULATE_RATEWITHTAX @Pi_UsrId,@Pi_TransId
	END
		
	IF @Pi_TransId=3 OR @Pi_TransId=25
	BEGIN
		INSERT INTO BilledPrdHdForScheme (RowId,RtrId,PrdId,PrdBatId,SelRate,BaseQty,GrossAmount,MRP,
		TransId,Usrid,ListPrice)
		SELECT A.Slno,@Pi_RtrId,A.Prdid,A.PrdBatId,0,A.BaseQty-A.ReturnedQty,0,0,@Pi_TransId,@Pi_UsrId,0
		FROM SalesInvoiceProduct A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		WHERE A.SalId=@Pi_SalId AND  A.PrdId NOT IN (
		SELECT PrdId FROM BilledPrdHdForScheme WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId)
	END
	
	--SELECT 'N3',* FROM BilledPrdHdForScheme
	-- To Get the Scheme Products - Billed Qty, Billed Value, Billed Weight in KG and Litre
	
	INSERT INTO @TempBilled(PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKG,SchemeOnLitre,SchId,SchemeOnAmtWithTax)		
	SELECT A.PrdId,A.PrdBatId,ISNULL(SUM(A.BaseQty),0) AS SchemeOnQty,ISNULL(SUM(A.BaseQty * A.SelRate),0) AS SchemeOnAmount,
		ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 3 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnKg,
		ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 5 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnLitre,@Pi_SchId,
		ISNULL(SUM(A.BaseQty * ISNULL(PT.SellRateWithTax,0)),0) AS SchemeOnAmtWithTax
		FROM BilledPrdHdForScheme A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		LEFT OUTER JOIN ProductSellingRateWithTax PT ON PT.PRDID=A.PRDID AND PT.PRDID=B.PRDID 
		/*Commented and Added by Raja.C for PMS No:ICRSTPAR2340 Begins Here*/
		--AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= B.PrdBatid
		AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		/*Commented and Added by Raja.C  for PMS No:ICRSTPAR2340 Ends Here*/
		WHERE A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId
		GROUP BY A.PrdId,A.PrdBatId,D.PrdUnitId
	
	--To Get the Sum of Quantity, Value or Weight Billed for the Scheme In From and To Uom Conversion - Slab Wise
	INSERT INTO @TempBilledAch(FrmSchAch,FrmUomAch,ToSchAch,ToUomAch,SlabId,FromQty,UomId,ToQty,ToUomId)
	SELECT ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.UomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS FrmSchAch,A.UomId AS FrmUomAch,
		ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.ToUomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS ToSchAch,A.ToUomId AS ToUomAch,
		A.Slabid,(A.PurQty + A.FromQty) as FromQty,A.UomId,A.ToQty,A.ToUomId
		FROM SchemeSlabs A
		INNER JOIN @TempBilled B ON A.SchId = B.SchId
		INNER JOIN Product C ON B.PrdId = C.PrdId
		LEFT OUTER JOIN UomGroup D ON D.UomGroupId = C.UomGroupId AND D.UomId = A.UomId
		LEFT OUTER JOIN UomGroup E ON E.UomGroupId = C.UomGroupId AND E.UomId = A.UomId
		GROUP BY A.UomId,A.Slabid,A.PurQty,A.FromQty,A.UomId,A.ToQty,A.ToUomId
	--
	SELECT @SlabId = SlabId FROM (SELECT TOP 1 A.SlabId FROM @TempBilledAch A
	INNER JOIN @TempBilledAch B ON A.SlabId = B.SlabId
	WHERE
	A.FrmSchAch >= B.FromQty AND
	A.ToSchAch <= (CASE B.ToQty WHEN 0 THEN A.ToSchAch ELSE B.ToQty END)
	ORDER BY A.SlabId DESC) As SlabId
--Code To Check Slab Wise Retailer Cap	Added by karthick CRCRSTPAR0007
	DECLARE @ReverseSlab AS INT --ILCRSTPAR1920
	DECLARE @ActualRetToBilled AS INT  --ILCRSTPAR2412
	SET @ReverseSlab=0 --ILCRSTPAR1920
	SET @ActualRetToBilled=0
	---
	CREATE TABLE #TotalRetailerCount
		(	
			Rtrid INT 
		)
	
	NextPrd:
	
	IF @ReverseSlab=1 ---ILCRSTPAR1920
	BEGIN
		SELECT @SlabId=MAX(SlabId) FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId
		IF ISNULL(@SlabId,0)=0
		BEGIN
			RETURN
		END
		SET @ReverseSlab=0
	END --ILCRSTPAR1920
	
	SELECT @RetailerCap=RetailerCap FROM SchemeSlabs WHERE Schid=@Pi_SchId AND Slabid=@SlabId
	SET @ActualRetToBilled=0 --ILCRSTPAR2412

	IF @RetailerCap<100
	BEGIN

		SELECT  @CtgLevelId=ISNULL((SELECT TOP 1  Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=4),0)
		SELECT @CtgMainid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5),0)
		SELECT @RtrClassId=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6),0)
		SELECT @Rtrid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8),0)
		
		TRUNCATE TABLE #TotalRetailerCount
		
		INSERT INTO #TotalRetailerCount
		SELECT DISTINCT R.Rtrid 
		FROM  Retailercategory RC
		INNER JOIN RetailerCategory RC1 ON RC1.CtgLinkId=RC.CtgMainid
		INNER JOIN RetailerValueClass RVC ON RVC.CtgMainid=RC1.Ctgmainid
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.RtrValueClassId=RVC.RtrClassId
		INNER JOIN Retailer R ON R.RtrId=RVCM.RtrId
		WHERE RC.CtgLevelId=1 AND RC1.CtgLevelid=2  AND RtrStatus=1
		AND (
		RC.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC.CtgMainid ELSE @CtgMainid END)
		OR RC.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)
		OR RC1.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC1.CtgMainid ELSE @CtgMainid END)
		OR RC1.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)) 		
		AND (RVC.RtrClassId =( CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE @RtrClassId END)
		OR RVC.RtrClassId IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6)) 		
		AND (R.Rtrid =( CASE @Rtrid WHEN 0 THEN R.Rtrid ELSE @Rtrid END)
		OR R.Rtrid IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8))

		 SET @TotRtrCnt=(SELECT DISTINCT COUNT(Rtrid)  FROM #TotalRetailerCount)
		 
		 SET @ActualRetToBilled= CEILING((SELECT ((CAST(@TotRtrCnt AS NUMERIC(18,2))*CAST(@RetailerCap AS NUMERIC(18,2))/100))))

		SELECT @BilledRtrCnt=COUNT(Distinct SI.Rtrid) FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		


		--this logic will be commented ILCRSTPAR2412
		--IF @TotRtrCnt=0
		--BEGIN
		--	SET @AchPercentage=0
		--END 
		--ELSE
		--BEGIN
		----- Rounded by Amuthakumar on 01/09/2018 UAT ILCRSTPAR1920
		----SET @AchPercentage=ROUND((SELECT CAST((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100) AS DECIMAL(10,0))),0)
		----- Ceiling Value by Amuthakumar on 26/09/2018 UAT ILCRSTPAR1920	(ie. if Result 7.1 makes rounded 8.0 )
		--SET @AchPercentage= CEILING((SELECT ((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100))))
				
		--END
		
 		--SELECT @SlabId,@TotRtrCnt,@BilledRtrCnt,@AchPercentage,@RetailerCap
		IF (SELECT object_id('TempDB..#AchvdRetailers')) IS NOT NULL
		BEGIN
			DROP TABLE #AchvdRetailers
		END
				
		CREATE TABLE #AchvdRetailers
		(
		Rtrid Int
		)
		
		INSERT INTO #AchvdRetailers
		SELECT DISTINCT SI.Rtrid 
		FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		
		--SELECT @AchPercentage,@RetailerCap
		--IF @AchPercentage>=@RetailerCap 
		--ILCRSTPAR2412 Perc logic removed
		if ISNULL(@ActualRetToBilled,0)<=ISNULL(@BilledRtrCnt,0)
		BEGIN
			IF NOT EXISTS(SELECT 'X' FROM #AchvdRetailers WHERE RtrId=@Pi_RtrId)
		    BEGIN	
					IF EXISTS(SELECT * FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId)
					BEGIN
						SET @ReverseSlab=1
						GOTO NextPrd
					END
				RETURN
			END			
		END 
	END
--Till here 
	
	--Store the Slab Amount Details into a temp table
	INSERT INTO @TempSchSlabAmt (ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,
		FlxFreePrd,FlxGiftPrd,FlxPoints)
	SELECT ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints
		FROM SchemeSlabs WHERE Schid = @Pi_SchId And SlabId = @SlabId
	
	--Store the Slab Free Product Details into a temp table
	INSERT INTO @TempSchSlabFree(ForEveryQty,ForEveryUomId,FreePrdId,FreeQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType <> 4
	
	--Store the Slab Gift Product Details into a temp table
	INSERT INTO @TempSchSlabGift(ForEveryQty,ForEveryUomId,GiftPrdId,GiftQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType = 4
	
	--To Get the Number of Times the Scheme should apply
	IF @PurOfEveryReq = 0
	BEGIN
		SET @NoOfTimes = 1
	END
	ELSE
	BEGIN
		SELECT @NoOfTimes = A.FrmSchAch / (CASE B.ForEveryQty WHEN 0 THEN 1 ELSE B.ForEveryQty END) FROM
			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
--		SELECT A.FrmSchAch,B.ForEveryQty  FROM
--			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
		IF @ProRata = 0
		BEGIN
			SET @NoOfTimes = FLOOR(@NoOfTimes)	
		END
		IF @ProRata = 1
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,0)
		END
		IF @ProRata = 2
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,6) 
		END
	END
	
	
	
	--To Store the Gross amount for the Scheme billed Product
	SELECT @GrossAmount = ISNULL(SUM(SchemeOnAmount),0) FROM @TempBilled
	--SELECT 'N1',* FROM @TempBilled
	--SELECT 'N2',* FROM @TempSchSlabAmt
	--To Calculate the Scheme Flat Amount and Discount Percentage
	--Scheme Discount for Flat amount = ((FlatAmt * (LineLevel Gross / Total Gross) * 100)/100) * number of times
	--Scheme Discount for Disc Perc   = (LineLevel Gross * Disc Percentage) / 100
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SUM(SchemeAmount) AS SchemeAmount,
		SchemeDiscount AS SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,
		FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,
		IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,0
		FROM
		(
			SELECT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
			@SlabId as SlabId,PrdId,PrdBatId,
			(CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END) As Contri,
			((FlatAmt * (CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END))/100) * @NoOfTimes
			As SchemeAmount, DiscPer AS SchemeDiscount,(Points *@NoOfTimes) as Points,
			FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,0 as FreePrdId,0 as FreePrdBatId,
			0 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,
			0 as IsSelected,@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId As TransId,
			@Pi_UsrId as UsrId FROM @TempBilled , @TempSchSlabAmt
			WHERE (FlatAmt + DiscPer + FlxDisc + FlxValueDisc + FlxFreePrd + FlxGiftPrd + Points + FlxPoints) >=0
		) AS B
		GROUP BY SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,
		FlxGiftPrd,FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,
		NoOfTimes,IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId
	--SELECT * FROM @TempBilled
	--To Calculate the Free Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,FreePrdId,0 as FreePrdBatId,
		CASE @SchType 
			WHEN 1 THEN 
				(CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END )
			WHEN 2 THEN 
				(CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
			WHEN 3 THEN
				(CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
		END
		 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,
		0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,@SchemeBudget as SchBudget,
		0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabFree
		GROUP BY FreePrdId,FreeQty,ForEveryQty
		
	--To Calculate the Gift Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,0 As FreePrdId,0 as FreePrdBatId,
		0 as FreeToBeGiven,GiftPrdId as GiftPrdId,0 as GiftPrdBatId,
		CASE @SchType
			WHEN 1 THEN
				CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 2 THEN
				CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 3 THEN
				CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
		END
		as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,
		@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabGift
		GROUP BY GiftPrdId,GiftQty,ForEveryQty
		IF @Pi_TransId=3 OR @Pi_TransId=25
		BEGIN
			UPDATE A Set A.FreePrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.FreePrdId=B.PrdId
			AND A.FreeToBeGiven>0
			UPDATE A Set A.GiftPrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.GiftPrdId=B.PrdId
			AND A.GiftToBeGiven>0
		END
		
	IF EXISTS (SELECT * FROM SchemeRtrLevelValidation WHERE Schid = @Pi_SchId AND RtrId = @Pi_RtrId)
	BEGIN
		IF Exists (SELECT * FROM SalesInvoice WHERE SalId = @Pi_SalId)
			SELECT @BillDate = SalInvDate FROM SalesInvoice WHERE SalId = @Pi_SalId
		ELSE
			SET @BillDate = CONVERT(VARCHAR(10),GETDATE(),121)
		SELECT @FrmValidDate = FromDate,@ToValidDate = ToDate,@SchemeBudget = BudgetAllocated
			FROM SchemeRtrLevelValidation WHERE @BillDate Between FromDate and ToDate
			AND Schid = @Pi_SchId AND RtrId = @Pi_RtrId
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilizedForRtr(@Pi_SchId,@Pi_RtrId,@FrmValidDate,@ToValidDate)
	END
	ELSE
	BEGIN
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilized(@Pi_SchId)
	END
	
	EXEC Proc_ApplySchemeInBill_Temp @Pi_SchId,@SlabId,@Pi_UsrId,@Pi_TransId
	
	EXEC Proc_ApplyDiscountScheme @Pi_SchId,@Pi_UsrId,@Pi_TransId
	
	UPDATE BillAppliedSchemeHd SET BudgetUtilized = ISNULL(@BudgetUtilized,0),
		SchBudget = ISNULL(@SchemeBudget,0) WHERE SchId = @Pi_SchId AND
		TransId = @Pi_TransId AND Usrid = @Pi_UsrId 
		
END
GO
IF  NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ProductBatch]') AND name = N'Index_Prdbat')
BEGIN
	CREATE NONCLUSTERED INDEX [Index_Prdbat] ON [dbo].[ProductBatch] 
	(
		[PrdId] ASC,
		[PrdBatId] ASC
	)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[ProductBatchDetails]') AND name = N'IX_ProductBatchDetails_Special')
BEGIN
CREATE NONCLUSTERED INDEX [IX_ProductBatchDetails_Special] ON [dbo].[ProductBatchDetails] 
(
	[SLNo] ASC,
	[DefaultPrice] ASC,
	[PrdBatId] ASC,
	[PrdBatDetailValue] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[SalesInvoiceProduct]') AND name = N'Index_SalesPrd')
BEGIN
CREATE NONCLUSTERED INDEX [Index_SalesPrd] ON [dbo].[SalesInvoiceProduct] 
(
	[SalId] ASC,
	[PrdId] ASC,
	[PrdBatId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF  NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[SalesInvoiceProductTax]') AND name = N'SalesInvoiceProductTax_Ind1')
BEGIN
CREATE NONCLUSTERED INDEX [SalesInvoiceProductTax_Ind1] ON [dbo].[SalesInvoiceProductTax] 
(
	[SalId] ASC,
	[PrdSlNo] ASC,
	[TaxId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[productcategoryvalue]') AND name = N'productcategoryvalue_Ind1')
BEGIN
CREATE NONCLUSTERED INDEX [productcategoryvalue_Ind1] ON [dbo].[productcategoryvalue] 
(
	[Prdctgvalmainid] ASC,
	[Prdctgvallinkid] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[SchemeMaster]') AND name = N'SchemeMaster_Ind1')
BEGIN
CREATE NONCLUSTERED INDEX [SchemeMaster_Ind1] ON [dbo].[SchemeMaster] 
(
	[schid] ASC 
	
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[SchemeProducts]') AND name = N'SchemeProducts_Ind1')
BEGIN
CREATE NONCLUSTERED INDEX [SchemeProducts_Ind1] ON [dbo].[SchemeProducts] 
(
	[schid] ASC 
	
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Fn_ReturnSchemeProductBatch]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [Fn_ReturnSchemeProductBatch]
GO
CREATE FUNCTION [Fn_ReturnSchemeProductBatch](@Pi_Schid INT)
RETURNS @ApplicableProduct TABLE
	(
		PrdId 		INT,
		PrdBatId 	INT
	)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnSchemeProductBatch
* PURPOSE: Returns the Product and Batch Details for the Selected Scheme
* NOTES:
* CREATED: Thrinath Kola	12-04-2007
* MODIFIED
'---------------------------------------------------------------------------------------------------------------------------
' Version    Date                   Person        User Story ID     CR/BZ       Remarks                              Code Review By   Review Date
* 462		07-03-2018            bharaneedhar C    ICRSTGCP6188    PMS         G1 O2B billing working slow          
* 16-Feb-2017  Nagarajan	Query optimized
*********************************/
DECLARE @SchLvlMode AS INT
	SELECT @SchLvlMode=SchemeLvlMode FROM SCHEMEMASTER (NOLOCK) WHERE SchId=@Pi_Schid
	
	DECLARE @Scheme Table
	(
		Prdid INT,
		Prdbatid INT
	)
	
	IF @SchLvlMode =0
	BEGIN
		INSERT INTO @Scheme
		SELECT DISTINCT B.Prdid,B.PrdBatId FROM SchemeMaster A (NOLOCK)
			INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid
			INNER JOIN Product C (NOLOCK) On B.Prdid = C.PrdId
			WHERE A.Schid = @Pi_Schid AND B.PrdId <> 0 And C.PrdStatus = 1 --- --added for ICRSTGCP6188 -- By Nagarajan for optimization 
		UNION
		SELECT DISTINCT E.Prdid,F.PrdBatId FROM SchemeMaster A (NOLOCK)
			INNER JOIN SchemeProducts B (NOLOCK) ON A.Schid = B.Schid
			INNER JOIN ProductCategoryValue C (NOLOCK) ON
			B.PrdCtgValMainId = C.PrdCtgValMainId
			INNER JOIN ProductCategoryValue D (NOLOCK) ON
			D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
			INNER JOIN Product E (NOLOCK) On
			D.PrdCtgValMainId = E.PrdCtgValMainId
			INNER JOIN ProductBatch F (NOLOCK) On
			F.PrdId = E.Prdid
			WHERE A.Schid = @Pi_Schid AND ISNULL(B.PrdCtgValMainId,0) <> 0 AND E.PrdStatus = 1  --added for ICRSTGCP6188 --- By Nagarajan for optimization 

		--Added BY Mohana 
		INSERT INTO @ApplicableProduct(Prdid,PrdBatId)
		SELECT DISTINCT prdid,prdbatid from SchemeMaster A  (NOLOCK)
		INNER JOIN SalesInvoiceSchemeLineWise B (NOLOCK) on a.SchId=b.SchId
		WHERE A.Schid = @Pi_Schid and QPS=1	AND B.PrdId  NOT IN (SELECT PrdId FRoM @Scheme)
		UNION 
		SELECT DISTINCT Prdid ,Prdbatid FROM @Scheme
		
	END
	ELSE IF @SchLvlMode =1
	BEGIN
		Insert Into @ApplicableProduct(Prdid,PrdBatId)
		SELECT B.MasterRecordId,0 as PrdbatId FROM SchemeProducts A (NOLOCK)
			INNER JOIN UdcDetails B (NOLOCK) on B.UDCUniqueId =A.PrdCtgValMainId
			WHERE A.SchId=@Pi_Schid
	END
RETURN
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='Rowid' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD Rowid INT DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='PriceId' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD PriceId INT DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='LSP' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD LSP NUMERIC(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TaxableAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD TaxableAmt NUMERIC(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD TaxAmt NUMERIC(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TotalAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='FreeIssuedt' AND XTYPE='U'))
BEGIN
	ALTER TABLE FreeIssuedt ADD TotalAmt NUMERIC(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='FreeIssueTax' AND XTYPE='U')
CREATE TABLE FreeIssueTax
(
	[IssueId] [bigint] NOT NULL,
	[PrdSlNo] [int] NOT NULL,
	[TaxId] [int] NOT NULL,
	[TaxPerc] [numeric](10, 6) NOT NULL,
	[TaxableAmount] [numeric](18, 6) NOT NULL,
	[TaxAmount] [numeric](18, 6) NOT NULL,
	[Availability] [tinyint] NULL,
	[LastModBy] [tinyint] NULL,
	[LastModDate] [datetime] NULL,
	[AuthId] [tinyint] NULL,
	[AuthDate] [datetime] NULL
)
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='FK_FreeIssueTax_IssueId' AND XTYPE='F')
BEGIN
	ALTER TABLE [dbo].[FreeIssueTax]  WITH NOCHECK ADD  CONSTRAINT [FK_FreeIssueTax_IssueId] FOREIGN KEY([IssueId])
	REFERENCES [dbo].[FreeIssueHd] ([IssueId])
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='FK_FreeIssueTax_TaxId' AND XTYPE='F')
BEGIN
	ALTER TABLE [dbo].[FreeIssueTax]  WITH NOCHECK ADD  CONSTRAINT [FK_FreeIssueTax_TaxId] FOREIGN KEY([TaxId])
	REFERENCES [dbo].[TaxConfiguration] ([TaxId])
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='FK_FreeIssueTax_TaxId' AND XTYPE='F')
BEGIN
	ALTER TABLE [dbo].[FreeIssueTax] CHECK CONSTRAINT [FK_FreeIssueTax_TaxId]
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ComputeTax' AND XTYPE='P')
DROP PROCEDURE Proc_ComputeTax
GO
/*
BEGIN  TRANSACTION
EXEC Proc_ComputeTax 1,226,1,0,'2018-06-25',1
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ComputeTax
(      
 @Pi_RowId  INT,      
 @Pi_CalledFrom  INT,        
 @Pi_UserId  INT,
 @Pi_RtrShipId  INT=0,
 @Pi_gServerDate DateTime='1990-01-01',
 @Pi_ApplyTax INT=1
)      
AS      
/*********************************      
* PROCEDURE : Proc_ComputeTax      
* PURPOSE : To Calculate the Line Level Tax      
* CREATED : Thrinath      
* CREATED DATE : 22/03/2007      
* MODIFIED
* DATE      AUTHOR     DESCRIPTION 
24/05/2009	MURUGAN	   OID CalCulation For Nestle	
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
17-11-2017  Mohana.S		 After  Based On Configuration Sales return tax will change.
26-06-2018	Karthick	CRCRSTPAR0008 Tax Calculation for Sample Issue
------------------------------------------------      
* {date} {developer}  {brief modification description}            
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
Pi_CalledFrom   226 For SampleIssue 'CRCRSTPAR0008
*********************************/       
SET NOCOUNT ON      
BEGIN      
	DECLARE @PrdBatTaxGrp   INT      
	DECLARE @RtrTaxGrp   INT      
	DECLARE @TaxSlab  INT      
	DECLARE @MRP   NUMERIC(28,10)      
	DECLARE @SellingRate  NUMERIC(28,10)      
	DECLARE @PurchaseRate  NUMERIC(28,10)      
	DECLARE @TaxableAmount  NUMERIC(28,10)    
	DECLARE @TotalDedAmt  NUMERIC(28,10)  
	DECLARE @ParTaxableAmount NUMERIC(28,10)      
	DECLARE @TaxPer   NUMERIC(38,6)      
	DECLARE @TaxId   INT      
	DECLARE	@ApplyOn INT
	DECLARE @TaxSetting TABLE       
	(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,6)      
	)      
	IF ISNULL(@Pi_gServerDate,'1990-01-01')='1990-01-01'
	BEGIN
		SET @Pi_gServerDate=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
	END
	
	IF ISNULL(@Pi_RtrShipId,0)=0
	BEGIN
		SET @Pi_RtrShipId=0
	END
	
	--To Take the Batch TaxGroup Id      
	SELECT @PrdBatTaxGrp = TaxGroupId FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	
	--To Take the Batch MRP      
	SELECT @MRP = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	INNER JOIN ProductBatchDetails C (NOLOCK)      
	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
	INNER JOIN BatchCreation D (NOLOCK)      
	ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
	AND D.MRP = 1       
	
	--To Take the Batch Selling Rate      
	IF @Pi_CalledFrom = 2 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 23  
	BEGIN      
		SELECT @SellingRate = ColValue FROM BilledPrddtForTax WHERE TransId = @Pi_CalledFrom       
		AND UsrId = @Pi_UserId AND RowId = @Pi_RowId AND ColId = -2      
	END      
	ELSE      
	BEGIN      
		IF @Pi_CalledFrom = 20 
		BEGIN 
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT MAX(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
		ELSE      
		BEGIN      
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
	END 

	IF @Pi_CalledFrom = 226 --CRCRSTPAR0008
	BEGIN 
		SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT MAX(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
		INNER JOIN BatchCreation D (NOLOCK) ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1     
	END      
	
	--To Take the Batch List Price 
	--Added by Murugan For OID Calculation
	IF (@Pi_CalledFrom = 5 OR @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37 )
	BEGIN   
		IF  EXISTS(SELECT Status FROM Configuration WHERE ModuleId = 'PURCHASERECEIPT16' and Status=1)   
		BEGIN  
			SELECT  @PurchaseRate = Isnull(ColValue,0) FROM BilledPrdDtForTax B  
			WHERE  B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 
			and COLID=3	   
		END  
		ELSE  
		BEGIN 
			SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.ListPrice = 1     
		END  
		
		
		--->Added By Nanda on 2011/05/12
		IF @Pi_CalledFrom = 37
		BEGIN
			IF EXISTS(SELECT * FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			BEGIN
				SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
				BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
				AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
				INNER JOIN ProductBatchDetails C (NOLOCK)      
				ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
				INNER JOIN BatchCreation D (NOLOCK)      
				ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
				AND LTRIM(RTRIM(D.RefCode)) IN (SELECT LEFT(Condition,1) FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			END
		END
		--->Till Here
	END
	ELSE
	BEGIN
		SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
		INNER JOIN BatchCreation D (NOLOCK)      
		ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1  
	END
	
	IF (@Pi_CalledFrom = 2 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 20 OR @Pi_CalledFrom = 23 OR       
	@Pi_CalledFrom = 24 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom=226)      
	BEGIN      
		--To Take the Retailer TaxGroup Id      
		IF EXISTS(SELECT 'X' FROM RetailerShipAdd C (NOLOCK)
		INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
		INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
		WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
		AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0)
		BEGIN
			SELECT @RtrTaxGrp=C.TaxGroupId FROM RetailerShipAdd C (NOLOCK)
			INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
			INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
			WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0
		END
		ELSE
		BEGIN		 
			SELECT @RtrTaxGrp = TaxGroupId FROM Retailer A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom      
		END		 
	END      
	
	IF (@Pi_CalledFrom = 5 OR  @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)      
	BEGIN      
		--To Take the Supplier TaxGroup Id      
		SELECT @RtrTaxGrp = TaxGroupId FROM Supplier A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.SpmId = B.RtrId      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId      
		AND B.TransId = @Pi_CalledFrom      
	END      
 
	--Store the Tax Setting for the Corresponding Retailer and Batch      
	INSERT INTO @TaxSetting (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
	SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
	FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
	TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
	INNER JOIN BilledPrdHdForTax C (NOLOCK) ON C.BillSeqId = B.BillSeqId      
	WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp AND C.UsrId = @Pi_UserId      
	AND C.RowId = @Pi_RowId AND C.TransId = @Pi_CalledFrom      
	AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
	RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121) --GST
	)
 

	--Delete the OLD Details From the BilledPrdDtCalculatedTax For the Row and User      
	DELETE FROM BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId       
	AND TransId = @Pi_CalledFrom      
	
	--Cursor For Taking Each Slab and Calculate Tax      
	DECLARE  CurTax CURSOR FOR      
	SELECT DISTINCT TaxSlab FROM @TaxSetting      
	OPEN CurTax        
	FETCH NEXT FROM CurTax INTO @TaxSlab      
	WHILE @@FETCH_STATUS = 0        
	BEGIN      
		SET @TaxableAmount = 0      
		--To Filter the Records Which Has Tax Percentage (>=0)      
		IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0 and ColVal >= 0)      
		BEGIN
			
			--To Get the Tax Percentage for the selected slab      
			SELECT @TaxPer = ColVal FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId = 0      
			
			IF @Pi_ApplyTax=0 
			BEGIN
				SET @TaxPer=0
				--SET @CalSurCharge=0
				--SET @AddtionTax=0
			END			
			
			--To Get the TaxId for the selected slab      
			SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId > 0      
	         
			--To Get the Adjustable amount from Other Columns      
			SELECT @TaxableAmount = ISNULL(SUM(ColValue),0) FROM       
			(SELECT CASE B.ColVal WHEN 1 THEN A.ColValue WHEN 2 THEN -1 * A.ColValue END       
				AS ColValue FROM BilledPrdDtForTax A INNER JOIN @TaxSetting B      
				ON A.ColId = B.ColId AND A.RowId =  @Pi_RowId AND A.UsrId = @Pi_UserId       
				AND A.TransId = @Pi_CalledFrom      
			WHERE TaxSlab = @TaxSlab AND B.ColType = 2 and B.ColId>3      
				And B.ColVal >0) as C      
			
			SET @ApplyOn=0
			SET @TotalDedAmt=@TaxableAmount
			 
			
			--To add MRP to Taxable Amount if MRP Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP      
				SET @ApplyOn=1 
			END
			
			--To add Selling Rate to Taxable Amount if Selling Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 2 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @SellingRate      
	      
			--To add Purchase Rate to Taxable Amount if Purchase Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 3 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @PurchaseRate      
			
			--To Get the Parent Taxable Amount for the Tax Slab      
			SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM BilledPrdDtCalculatedTax A      
			INNER JOIN @TaxSetting B ON A.TaxId = B.ColVal AND A.RowId = @Pi_RowId      
			AND A.UsrId = @Pi_UserId AND B.ColType = 3 AND B.TaxSlab = @TaxSlab      
			AND A.TransId = @Pi_CalledFrom     
			Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount      
	      
			--Insert the New Tax Amounts        
			INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
			TaxableAmount,TaxAmount,Usrid,TransId)      
			SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@TaxId,@TaxSlab,@TaxPer,      
		    @TaxableAmount, CASE @ApplyOn 
			WHEN 0 THEN	cast(@TaxableAmount * (@TaxPer / 100 ) AS NUMERIC(38,6))
			WHEN 1 THEN cast(@TaxableAmount * (@TaxPer / (100 +@TaxPer)) AS NUMERIC(38,6)) END,      
			@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
			B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom     
			
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount =  @TotalDedAmt+ @SellingRate
				UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=@TaxableAmount
				WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId AND TransId = @Pi_CalledFrom 							
			END 
			
		END      
		FETCH NEXT FROM CurTax INTO @TaxSlab      
	END        
	CLOSE CurTax        
	DEALLOCATE CurTax           
	-----Only for SalesReturn
IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId='Sal_Return_Tax' AND Status = 1)--Added By Mohana
BEGIN
	CREATE TABLE #SalesReturnTax
	(
		Slno INT IDENTITY(1,1),
		RowId  INT,
		SalRowId INT,
		Taxperc Numeric(18,6),
		TaxId INT,
		Prdid INT,
		PrdbatId INT
	)
	DECLARE @MaxSlno AS INT
	DECLARE @MinSlno AS INT
	DECLARE @RtnPrdid AS INT
	DECLARE @RtnPrdbatId AS INT
	DECLARE @RtnTaxId AS INT
	DECLARE @RtnTaxPerc AS Numeric(18,6)
	DECLARE @RtnTaxableAmount AS Numeric(18,6)
	SET @MinSlno=1
	
	IF @Pi_CalledFrom = 3
	BEGIN
		IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1)
		BEGIN
				---Only With Reference
				INSERT INTO #SalesReturnTax(RowId,SalRowId,TaxPerc,TaxId,PrdId,PrdbatId)
				SELECT DISTINCT RowId,SalRowId,CASE @Pi_ApplyTax WHEN 0 THEN 0.00 ELSE  TaxPerc END,TaxId,PrdId,PrdbatId 	
				FROM BilledPrdHdForTax_GST A (NOLOCK) 
				INNER JOIN salesinvoiceproducttax B (NOLOCK) ON A.Salid=B.SalId and A.SalRowId=B.PrdSlNo				
				INNER JOIN SalesInvoice S (NOLOCK) ON S.Salid=A.Salid and S.Salid=B.Salid
				WHERE Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				and VatGst='GST' and TaxPerc <> 0
			
				IF EXISTS(SELECT 'X' FROM #SalesReturnTax)
				BEGIN
				
					DELETE A FROM BilledPrdDtCalculatedTax A WHERE NOT EXISTS(SELECT PrdId,PrdBatId,TaxId FROM 
					#SalesReturnTax B WHERE A.PrdId=B.Prdid and A.PrdbatId=B.PrdbatId and A.TaxId=B.TaxId and A.RowId=B.RowId)
					and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				
					SELECT @MaxSlno=MAX(Slno) FROM #SalesReturnTax
					
					WHILE @MinSlno<=@MaxSlno
					BEGIN
						SELECT @RtnPrdid=Prdid,@RtnPrdbatId=PrdbatId ,@RtnTaxId=Taxid,@RtnTaxPerc=TaxPerc FROM #SalesReturnTax
						WHERE Slno=@MinSlno
						
						IF EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
						BEGIN
						
								IF NOT EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId and Cast(TaxPercentage as Numeric(18,6))=@RtnTaxPerc
										and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
										BEGIN																																	
											UPDATE A SET A.TaxPercentage=@RtnTaxPerc,
											A.TaxAmount=cast(A.TaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6))
											FROM BilledPrdDtCalculatedTax A  
											WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
											and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
											and  TaxableAmount>0							
										END
						END	
						ELSE
						BEGIN
						
								SELECT @RtnTaxableAmount=TaxableAmount 
								FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
								and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
								and  TaxableAmount>0
						
								INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
								TaxableAmount,TaxAmount,Usrid,TransId)      
								SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@RtnTaxId,@RtnTaxId,@RtnTaxPerc,      
								@RtnTaxableAmount, cast(@RtnTaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6)),      
								@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
								B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 					  
							
						END			
						
						SET @MinSlno=@MinSlno+1
					END							
				END
		END
	END	
END
	-----Till here
		----Gopi at 02-06-2017 for GST
	UPDATE BilledPrdDtCalculatedTax SET TaxId=0 where TaxId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxSlabId=0 where TaxSlabId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=0 where TaxableAmount Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxPercentage=0 where TaxPercentage Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxAmount=0 where TaxAmount Is null
	 ---Till Here ----        
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='TempSampleIssue' AND XTYPE='U')
DROP TABLE TempSampleIssue
GO
CREATE TABLE TempSampleIssue
(
	[IssueId] [int] NULL,
	[IssueRefNo] [varchar](25) NULL,
	[CmpId] [int] NULL,
	[SMId] [int] NULL,
	[RMId] [int] NULL,
	[CtgLevelId] [int] NULL,
	[RtrClassId] [int] NULL,
	[CtgMainID] [int] NULL,
	[RtrId] [int] NULL,
	[RtrCode] [varchar](25) NULL,
	[RtrName] [varchar](200) NULL,
	[IssueDate] [datetime] NULL,
	[SalId] [int] NULL,
	[SalInvNo] [varchar](25) NULL,
	[SchId] [int] NULL,
	[SchCode] [varchar](25) NULL,
	[SKUPrdId] [int] NULL,
	[SKUName] [varchar](200) NULL,
	[UomId] [int] NULL,
	[UomCode] [varchar](25) NULL,
	[UomQty] [numeric](38, 0) NULL,
	[UomConvFact] [int] NULL,
	[UomBaseQty] [numeric](38, 0) NULL,
	[IssueStatus] [int] NULL,
	[DlvSts] [int] NULL,
	[DlvStsDesc] [varchar](25) NULL,
	[Returnable] [varchar](25) NULL,
	[DueDate]	 [datetime] NULL,
	[Lsp]		 [numeric](18, 6) NULL,
	[TaxableAmt] [numeric](18, 6) NULL,
	[TaxAmt]	 [numeric](18, 6) NULL,
	[TotalAmt]	 [numeric](18, 6) NULL,
	[RptID]		 [int] NULL,
	[UsrId]		 [int] NULL
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_SampleIssue' AND XTYPE='P')
DROP PROCEDURE Proc_SampleIssue
GO
-- EXEC Proc_SampleIssue 159,2,'2010/03/15','2011/12/22'
CREATE PROCEDURE Proc_SampleIssue
(
	@Pi_RptId		INT,
	@Pi_UserId		INT,
	@FromDate       DateTime,
	@ToDate			DateTime
)
AS
BEGIN
/****************************************************************************
* PROCEDURE: Proc_SampleIssue
* PURPOSE:Display the Sample Issue Products
* NOTES:
* CREATED: Mahalakshmi.A
* ON DATE: 02-12-2008
* MODIFIED
* DATE			AUTHOR				DESCRIPTION
-------------------------------------------------------------------------------
* 16.02.2010	Panneer				Added Date Filter
* 22.12.2011	VIjendra Kumar		Added for Sample Issue Rule setting
*****************************************************************************/
SET NOCOUNT ON
	DELETE FROM TempSampleIssue 
	INSERT INTO TempSampleIssue (IssueId,IssueRefNo,CmpId,SMId,RMId,CtgLevelId,CtgMainID,RtrClassId,
								RtrId,RtrCode,RtrName,IssueDate,SalId,SalInvNo,SchId,SchCode,SKUPrdId,SKUName,
								UomId,UomCode,UomQty,UomConvFact,UomBaseQty,
								IssueStatus,DlvSts,DlvStsDesc ,Returnable,DueDate,LSP,TaxableAmt,TaxAmt,TotalAmt,RptID,UsrId)
	SELECT DISTINCT 
		A.IssueId,A.IssueRefNo,F.CmpId,A.SMId,A.RMId,J.CTGLEVELID,
		I.CTGMAINID,H.RtrValueClassId AS RtrClassId,
		A.RtrId,D.RtrCode,D.RtrName,A.IssueDate,
		A.SalId,C.SalInvNo,0,'',B.PrdId,F.PrdName,
		B.IssueUomId,G.UomCode,B.IssueQty,B.IssueConFact,B.IssueBaseQty,A.Status,
		ISNULL(C.DlvSts,CASE (A.Status)WHEN 0 THEN A.Status+1 WHEN 1 THEN A.Status+3 END ),
		CASE ISNULL(C.DlvSts,CASE (A.Status)WHEN 0 THEN A.Status+1 WHEN 1 THEN A.Status+3 END)
		WHEN 4 THEN 'Confirmed'
		WHEN 5 THEN 'Confirmed'
		WHEN 3 THEN 'Deleted'
		WHEN 1 THEN 'Pending' END,
		CASE B.TobeReturned WHEN 0 THEN 'NO' ELSE 'YES' END AS TobeReturned,B.DueDate,
		B.LSP,B.TaxableAmt,B.TaxAmt,B.TotalAmt,@Pi_RptId,@Pi_UserId
		FROM FreeIssueHd A WITH (NOLOCK)
		INNER JOIN FreeIssueDt B WITH (NOLOCK) ON A.IssueId= B.IssueId
		LEFT OUTER JOIN SalesInvoice C WITH (NOLOCK) ON A.SalId=C.SalId
--		INNER JOIN SampleIssueHd SIH ON SIH.SalId=A.SalId
		INNER JOIN Retailer D WITH (NOLOCK) ON A.RtrId=D.RtrId
		INNER JOIN Product F WITH(NOLOCK) ON B.PrdID=F.PrdID
		INNER JOIN UomMaster G WITH(NOLOCk) ON B.IssueUomId=G.UomId
		INNER JOIN RETAILERVALUECLASSMAP H ON H.RtrId=D.RtrId
		INNER JOIN RETAILERVALUECLASS I ON I.RtrClassId=H.RtrValueClassId
		INNER JOIN RetailerCategory J ON J.CtgMainId=I.CtgMainId
		WHERE  IssueDate Between @FromDate and @ToDate
	UNION ALL
		SELECT DISTINCT 
		A.IssueId,A.IssueRefNo,F.CmpId,A.SMId,A.RMId,J.CTGLEVELID,
		I.CTGMAINID,H.RtrValueClassId AS RtrClassId,
		A.RtrId,D.RtrCode,D.RtrName,A.IssueDate,
		A.SalId,C.SalInvNo,0,'',B.PrdId,F.PrdName,
		B.IssueUomId,G.UomCode,B.IssueQty,B.IssueConFact,B.IssueBaseQty,A.Status,
		ISNULL(C.DlvSts,CASE (A.Status)WHEN 0 THEN A.Status+1 WHEN 1 THEN A.Status+3 END ),
		CASE ISNULL(C.DlvSts,CASE (A.Status)WHEN 0 THEN A.Status+1 WHEN 1 THEN A.Status+3 END)
		WHEN 4 THEN 'Confirmed'
		WHEN 5 THEN 'Confirmed'
		WHEN 3 THEN 'Deleted'
		WHEN 1 THEN 'Pending' END,
		CASE B.TobeReturned WHEN 0 THEN 'NO' ELSE 'YES' END AS TobeReturned,B.DueDate,
		0 AS LSP,0 AS TaxableAmt,0 AS TaxAmt,0 AS TotalAmt,@Pi_RptId,@Pi_UserId
		FROM SampleIssueHd A WITH (NOLOCK)
		INNER JOIN SampleIssueDt B WITH (NOLOCK) ON A.IssueId= B.IssueId
		LEFT OUTER JOIN SalesInvoice C WITH (NOLOCK) ON A.SalId=C.SalId
--		INNER JOIN SampleIssueHd SIH ON SIH.SalId=A.SalId
		INNER JOIN Retailer D WITH (NOLOCK) ON A.RtrId=D.RtrId
		INNER JOIN Product F WITH(NOLOCK) ON B.PrdID=F.PrdID
		INNER JOIN UomMaster G WITH(NOLOCk) ON B.IssueUomId=G.UomId
		INNER JOIN RETAILERVALUECLASSMAP H ON H.RtrId=D.RtrId
		INNER JOIN RETAILERVALUECLASS I ON I.RtrClassId=H.RtrValueClassId
		INNER JOIN RetailerCategory J ON J.CtgMainId=I.CtgMainId
		WHERE  IssueDate Between @FromDate and @ToDate
END
GO
UPDATE rptdetails SET TBLNAME='FreeissueHd',Selcid=218 WHERE selcid=216 AND Rptid=159
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='RptSampleIssue_Excel' AND XTYPE='U')
DROP TABLE RptSampleIssue_Excel
GO
CREATE TABLE RptSampleIssue_Excel
(
	[RtrCode]		[varchar](100) NULL,
	[RtrName]		[varchar](100) NULL,
	[RtrShipAddress] [varchar](400) NULL,
	[IssueRefNo]	[varchar](100) NULL,
	[IssueDate]		[datetime] NULL,
	[BillRefNo]		[varchar](100) NULL,
	[SchemeCode]	[varchar](100) NULL,
	[PrdDCode]		[varchar](100) NULL,
	[SKUName]		[varchar](100) NULL,
	[MRP]			[numeric](18, 6) NULL,
	[UOM]			[varchar](100) NULL,
	[Qty]			[int] NULL,
	[Status]		[varchar](100) NULL,
	[Returnable]	[varchar](100) NULL,
	[DueDate]		[datetime] NULL,
	[Lsp]			[numeric](18, 2) NULL,
	[TaxableAmt]	[numeric](18, 2) NULL,
	[TaxAmt]		[numeric](18, 2) NULL,
	[TotalAmt]		[numeric](18, 2) NULL,
	[PrdId]			[int] NULL,
	[UserId]		[int] NULL
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSampleIssue' AND XTYPE='P')
DROP PROCEDURE Proc_RptSampleIssue
GO
-- EXEC Proc_RptSampleIssue 159,1,1,'Parle',0,0,1
CREATE PROCEDURE Proc_RptSampleIssue
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*******************************************************************************************************
* VIEW		: Proc_RptSampleIssue
* PURPOSE	: To get the Sample Issue Products Details
* CREATED BY	: Mahalakshmi.A
* CREATED DATE	: 02/12/2008
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------------
* {date}		{developer}  {brief modification description}	
* 16.02.2010	Panneer		 Added Product Hierarchy Filter
* 18.03.2010      Panneer		 Added Comp.Code/Dist.Code Filter
* 07.09.2010      Panneer            Added Retailer Shipping Address in Excel
********************************************************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	--Filter Variables
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @CmpId 		AS	INT
	DECLARE @SMId 		AS	INT
	DECLARE @RMId 		AS	INT
	DECLARE @RtrId 		AS	INT
	DECLARE @PrdCatId	AS	INT
	DECLARE @PrdId		AS	INT
	DECLARE @CtgLevelId	AS 	INT
	DECLARE @RtrClassId	AS 	INT
	DECLARE @CtgMainId 	AS 	INT
	DECLARE @IssueRefId	AS	INT
	DECLARE @SalId		AS	INT
	DECLARE @Status		AS	INT
	DECLARE @ReasonId	AS	INT
	DECLARE @PrdTypeId	AS	INT
	----Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @RtrId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @IssueRefId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,216,@Pi_UsrId))
	SET @IssueRefId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,218,@Pi_UsrId))
	SET @SalId = (SElect TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,34,@Pi_UsrId))
	SET @Status = (SElect TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,275,@Pi_UsrId))
	--- 16.02.2010
	SET @ReasonId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,159,@Pi_UsrId))
	
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatId = (Select TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (Select TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @PrdTypeId = (Select TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,276,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	IF @IssueRefId=''
	SET @IssueRefId=0
	---Till Here
	
	Create TABLE #RptSampleIssue
	(
				RtrCode		NVARCHAR(100),
				RtrName		NVARCHAR(100),
				IssueRefNo	NVARCHAR(100),
				IssueDate	DATETIME,
				BillRefNo	NVARCHAR(100),
				SchemeCode	NVARCHAR(100),
				SKUName		NVARCHAR(100),
				UOM			NVARCHAR(100),
				Qty			NUMERIC(38,0),
				Status		NVARCHAR(100),
				Returnable	NVARCHAR(25),
				DueDate		DateTime,
				PrdId		INT,
				PrdDCode	NVARCHAR(100),
				Reason		NVARCHAR(100),
				MRP			NUMERIC(18,2),
				LSP			NUMERIC(18,2),
				TaxableAmt  NUMERIC(18,2),
				TaxAmt		NUMERIC(18,2),
				TotalAmt	NUMERIC(18,2)
	)
	
	SET @TblName = 'RptSampleIssue'
	SET @TblStruct = '	RtrCode		NVARCHAR(100),
				RtrName		NVARCHAR(100),
				IssueRefNo	NVARCHAR(100),
				IssueDate	DATETIME,
				BillRefNo	NVARCHAR(100),
				SchemeCode	NVARCHAR(100),
				SKUName		NVARCHAR(100),
				UOM		NVARCHAR(100),
				Qty		NUMERIC(38,0),
				Status		NVARCHAR(100),
				Returnable	NVARCHAR(25),
				DueDate		DateTime,
				PrdId	INT,
				PrdDCode NVARCHAR(100),
				Reason  NVARCHAR(100),
				MRP NUMERIC(18,2),
				LSP			NUMERIC(18,2),
				TaxableAmt  NUMERIC(18,2),
				TaxAmt		NUMERIC(18,2),
				TotalAmt	NUMERIC(18,2)'
	SET @TblFields = 'RtrCode,RtrName,IssueRefNo,IssueDate,BillRefNo,SchemeCode,SKUName,
					  UOM,Qty,Status,Returnable,DueDate,PrdId,PrdDCode,Reason,MRP,LSP,TaxableAmt,TaxAmt,TotalAmt'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
	EXECUTE PROC_SAMPLEISSUE @PI_RPTID,@PI_USRID,@FromDate,@ToDate
	
	INSERT INTO #RptSampleIssue (	RtrCode,RtrName,IssueRefNo,IssueDate,BillRefNo,
									SchemeCode,SKUName,UOM,Qty,Status,Returnable,DueDate,PrdId,PrdDCode,Reason,MRP,
									LSP,TaxableAmt,TaxAmt,TotalAmt)
	SELECT DISTINCT RtrCode,RtrName,A.IssueRefNo,A.IssueDate,SalInvNo,SchCode,SKUName,UomCode,UomBaseQty,
					DlvStsDesc,Returnable,DueDate,SKUPrdId,PrdDCode,'',0.0 MRP,LSP,TaxableAmt,TaxAmt,TotalAmt
	FROM 
			TempSampleIssue a,FreeIssueHD b,Product P
	WHERE 	
			P.PrdId = A.SkuPrdId
			AND (A.CmpId = (CASE @CmpId WHEN 0 THEN A.CmpId ELSE 0 END) OR
							A.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
			
			AND	(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE -1 END) OR
							A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
		
			AND	(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE -1 END) OR
							A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
		
			AND	(CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR
							CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
		
			AND	(A.RtrId=(CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
							A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
		
			AND	(RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR
							RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
		
			AND	(CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR
							CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
		
			AND	(A.SalId = (CASE @SalId WHEN 0 THEN A.SalId Else -1 END) OR
							A.SalId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,34,@Pi_UsrId)))
			AND (A.IssueId = (CASE @IssueRefId WHEN 0 THEN A.IssueId Else 0 END) OR
							A.IssueId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,218,@Pi_UsrId)))
		
--			AND	(DlvSts = (CASE @Status WHEN 0 THEN DlvSts Else 0 END) OR
--							DlvSts in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,217,@Pi_UsrId)))
			
			AND A.IssueDate Between @FromDate AND @ToDate
--			AND [Status] = 1
	--Commented By Jisha on 08/11/2013
			----AND	(A.SKUPrdId = (CASE @PrdCatId WHEN 0 THEN A.SKUPrdId Else 0 END) OR
			----				A.SKUPrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
			----AND (A.SKUPrdId = (CASE @PrdId WHEN 0 THEN A.SKUPrdId Else 0 END) OR
			----				A.SKUPrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
----SELECT * FROM #RptSampleIssue				
	SELECT DISTINCT 
		A.PrdId,PrdBatDetailValue INTO #TempMrp 
	FROM 
		#RptSampleIssue a,ProductBatch b (NoLock),ProductBatchDetails C (NoLock)
	WHERE 
		b.PrdId = A.PrdId  and C.PrdbatId = B.PrdbatId and DefaultPrice = 1
		AND SlNo in (SELECT SlNo FROM Batchcreation (NoLock) WHERE FieldDesc = 'MRP')
	UPDATE #RptSampleIssue SET MRP = PrdBatDetailValue 	FROM #RptSampleIssue a,#TempMrp b WHERE A.PrdId  = B.PrdId 
	IF @PrdTypeId = 2
	BEGIN
		Update #RptSampleIssue SET PrdDcode = PrdCcode
		From #RptSampleIssue  a,Product b
		WHere A.PrdId = B.PrdId
	END
	IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			
			SET @SSQL = 'INSERT INTO #RptSampleIssue ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ 'WHERE BillStatus=1  AND (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '
				+ 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND (SMId = (CASE ' + CAST(@SMId AS nVarchar(10)) + ' WHEN 0 THEN SMId ELSE 0 END) OR '
				+ 'SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND (RtrId = (CASE ' + CAST(@RtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrId ELSE 0 END) OR '
				+ 'RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND (RMId = (CASE ' + CAST(@RMId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR '
				+ 'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND(CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN CtgLevelId ELSE 0 END) OR'
				+ 'CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',29,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND(RtrClassId=(CASE @RtrClassId WHEN 0 THEN RtrClassId ELSE 0 END) OR '
				+ 'RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',31,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND(CtgMainID=(CASE @CtgMainId WHEN 0 THEN ctgMainID ELSE 0 END) OR '
				+ 'CtgMainID in (SELECT iCountid FROM Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',30,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND (SalId = (CASE @SalId WHEN 0 THEN SalId Else -1 END) OR '
				+ 'SalId in (SELECT iCountid from Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',34,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND (IssueId = (CASE @IssueRefId WHEN 0 THEN IssueId Else 0 END) OR '
				+ 'IssueId in (SELECT iCountid from Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',216,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND (DlvSts = (CASE @Status WHEN 0 THEN DlvSts Else 0 END) OR '
				+ 'DlvSts in (SELECT iCountid from Fn_ReturnRptFilters('+
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',217,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
				+ 'AND IssueDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
					'(SnapId,UserId,RptId,' + @TblFields + ')' +
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSampleIssue'
				
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptSampleIssue ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSampleIssue
	-- Till Here
	SELECT  RtrCode,RtrName,IssueRefNo,CONVERT(VARCHAR(10),IssueDate,121)IssueDate,BillRefNo,SchemeCode,
			PrdDCode,SKUName,MRP,UOM,Qty,LSP,TaxableAmt,TaxAmt,TotalAmt ,Status,Returnable,CONVERT(VARCHAR(10),DueDate,121)DueDate,Reason,PrdId
	FROM #RptSampleIssue
	
--SELECT * FROM TEMPSAMPLEISSUE
-- EXEC [Proc_RptSampleIssue] 233,1,1,'Loreal',0,0,1
	DELETE FROM RptSampleIssue_Excel 
	INSERT INTO RptSampleIssue_Excel 
	SELECT DISTINCT  C.RtrCode,C.RtrName,
			RtrShipAdd1 + ' --> ' + RtrShipAdd2 + ' --> ' + RtrShipAdd3 as RtrShipAddress,
			C.IssueRefNo,C.IssueDate,BillRefNo,SchemeCode,PrdDCode,C.SKUName,
			MRP,UOM,Qty,C.Status,C.Returnable,C.DueDate,C.LSP,C.TaxableAmt,C.TaxAmt,C.TotalAmt,PrdId,@Pi_UsrId
	FROM TEMPSAMPLEISSUE A 
			Left Outer JOIN FreeIssueHD B ON A.IssueId = B.IssueId
			INNER JOIN #RptSampleIssue C On A.IssueRefNo = C.IssueRefNo 
										    AND C.IssueRefNo = B.IssueRefNo
			INNER JOIN Retailer D ON C.RtrCode = D.RtrCode
			LEFT OUTER JOIN RetailerShipAdd E ON D.RtrId = E.RtrId --and B.RtrShipId = E.RtrShipId		
	RETURN 
END
GO
DELETE FROM Rptexcelheaders WHERE rptid=159 
INSERT INTO Rptexcelheaders
select 159,1,'RtrCode','Retailer Code',	0,1 UNION ALL 
select 159,2,'RtrName','Retailer Name',	1,1 UNION ALL 
select 159,3,'IssueRefNo','IssueRef.No',1,1 UNION ALL 
select 159,4,'IssueDate','Issue Date',1,1 UNION ALL 
select 159,5,'BillRefNo','Bill Ref.No',1,1 UNION ALL 
select 159,6,'SchemeCode','Sample Scheme Code',1,1 UNION ALL  
select 159,7,'PrdDCode','Sample SKU Code',1,1 UNION ALL 
select 159,8,'SKUName','Sample SKU',1,1 UNION ALL 
select 159,9,'MRP','MRP',0,1 UNION ALL 
select 159,10,'UOM','UOM',1,1 UNION ALL 
select 159,11,'Qty','Qty',1,1 UNION ALL  
select 159,12,'Lsp','Lsp',1,1 UNION ALL 
select 159,13,'TaxableAmt','TaxableAmt',1,1 UNION ALL 
select 159,14,'TaxAmt','TaxAmt',1,1 UNION ALL 
select 159,15,'TotalAmt','TotalAmt',1,1 UNION ALL 
select 159,16,'Status','Issue Status',	1,1 UNION ALL 
select 159,17,'Returnable','Returnable',1,1 UNION ALL 
select 159,18,'DueDate','Due Date',	1,1 UNION ALL 
select 159,19,'Reason','Reason',0,1 UNION ALL 
select 159,20,'PrdId','PrdId',0,1 
GO
DELETE FROM Manualconfiguration WHERE ProjectName='PARLE' AND ModuleId IN('SALES_RETURN1','SALES_RETURN2')
INSERT INTO Manualconfiguration
SELECT 'PARLE','SALES_RETURN1','Sales Return','Block Scheme Discount Reversal for Unsaleable Return With Reference',1,'',0,1 UNION
SELECT 'PARLE','SALES_RETURN2','Sales Return','Block Saleable Sales Return after config days or Month End',1,'',6,2
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='FN_ReturnBllingDays' AND XTYPE='TF')
DROP FUNCTION FN_ReturnBllingDays
GO
--SELECT * FROM FN_ReturnBllingDays('P30401800712','2018-07-02')
CREATE FUNCTION FN_ReturnBllingDays(@salinvno NVARCHAR(50),@Returndate DATETIME)
RETURNS @Table table
(
	Allow	INT,
	Msg	NVARCHAR(100)
)
AS
/*
	CREATED BY-		Karthick
	CRAETEDON-		02-07-2018
	PURPOSE-		To get Bill calender days
	CRNO-			CRCRSTPAR0009
*/
BEGIN
	DECLARE @SalinvDate AS DATETIME
	DECLARE @ConfigDays AS INT
	DECLARE @Allow AS INT
	DECLARE @DiffDay AS INT
	DECLARE @Msg AS NVARCHAR(100)
	
	SET @Allow=1
	SET @Msg=''
	
	INSERT INTO @Table
	SELECT 1,''
	
	IF EXISTS(SELECT ISNULL(ConfigValue,0) FROM Manualconfiguration WHERE ProjectName='PARLE' AND ModuleId IN( 'SALES_RETURN2') AND STATUS=1)
	BEGIN
	
		SELECT @ConfigDays=ISNULL(ConfigValue,0) FROM Manualconfiguration WHERE ProjectName='PARLE' AND ModuleId IN( 'SALES_RETURN2')
		
		SELECT @SalinvDate=SalinvDate FROM SALESINVOICE(NOLOCK) WHERE Salinvno=@salinvno
		
		SELECT @DiffDay=DATEDIFF(DAY,@SalinvDate,CONVERT(VARCHAR(10),GETDATE(),121))

		IF @DiffDay>=@ConfigDays
		BEGIN
			SET @Msg='Sales return of salable products from retailers is Allowd within '+ CAST(@ConfigDays AS VARCHAR(10)) +' Calender days Or within MonthEnd'
			
			DELETE FROM @Table
			INSERT INTO @Table
			SELECT 0,@Msg
		END
		
		IF EXISTS(SELECT '1' FROM JcMonthEnd WHERE @SalinvDate BETWEEN JcmSdt AND JcmEdt AND Status=1)
		BEGIN
			SET @Msg='Sales return of salable products from retailers is Allowd within '+ CAST(@ConfigDays AS VARCHAR(10)) +'Calender days Or Within MonthEnd'
			
			DELETE FROM @Table
			INSERT INTO @Table
			SELECT 0,@Msg
		END
	END 
RETURN	
END
GO
--Till Here
--UAT Enhancement
UPDATE HotSearchEditorHd SET RemainsltString='select JcmSdt,JcmJc from jcmonth WITH (NOLOCK) where JcmId=vFParam AND JcmEdt<=
(SELECT ISNULL((SELECT MAX(JcmEdt) FROM JCMonthEnd),(SELECT DATEADD(d,-1,JcmSdt) FROM JCMonth 
WHERE CONVERT(VARCHAR(10),GETDATE(),121)  BETWEEN JcmSdt AND JcmEdt)))' WHERE FORMID=270
GO
UPDATE HotSearchEditorHd SET RemainsltString='select JcmEdt,JcmJc from jcmonth WITH (NOLOCK) where JcmId=vFParam AND JcmEdt<=
(SELECT ISNULL((SELECT MAX(JcmEdt) FROM JCMonthEnd),(SELECT DATEADD(d,-1,JcmSdt) FROM JCMonth 
WHERE CONVERT(VARCHAR(10),GETDATE(),121)  BETWEEN JcmSdt AND JcmEdt)))' WHERE FORMID=271
GO
DELETE FROM CustomCaptions WHERE [TransId]=16 AND [CtrlId]=7 AND CtrlName='sprScheme-16-7-15'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(16,7,15,'sprScheme-16-7-15','Sales Value','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Sales Value','','',1,1)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptDebitNoteTopSheet' AND TYPE='P')
DROP PROCEDURE Proc_RptDebitNoteTopSheet
GO
/*
BEGIN TRAN
EXEC Proc_RptDebitNoteTopSheet 291,2,0,'PARLE',0,0,1
SELECT * FROM RptDebitNoteTopSheet_Excel1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptDebitNoteTopSheet
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************************************************
* PROCEDURE	: Proc_RptDebitNoteTopSheet
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Debit Note Top Sheet
* MODIFIED 
*************************************************************************************************************************************
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************************
10-10-2017  Mohana.S		CR		CCRSTPAR0172          Included Circular Date and scheme Budget 
04-12-2017	Mohana			BZ		ICRSTPAR6760		  Added New Function for calculating Scheme utilized for selected month
07-12-2017  Mary.S			BZ		ICRSTPAR6933		  Excel Sheet row Witdth change    
13-12-2017  Mohana.S		CR		ICRSTPAR6933		  Changed Sampling Amount as Zero (default)   
09-01-2018  Lakshman M		BZ      ICRSTPAR7284          LCTR Formula validation changed.(special price not consider in LCTR Value).
26-03-2018	Mohana S		CR		CCRSTPAR0187		  TOT Diff Claims Report Created. 
08-05-2018	Mohana S		SR      ILCRSTPAR0500	      included Removed Scheme Products. 
09-05-2018	Mohana S		BZ	    ILCRSTPAR0506         chaged the target data selection
10-05-2018  Mohana S		BZ      ILCRSTPAR0546		  Sales return issue fix in Trade schemes
08-06-2018  Muthulakshmi.V  BZ      ILCRSTPAR0909         Scheme valid date checking condition changed
25-07-2018  Lakshman M		BZ		ILCRSTPAR1496         Scheme code valdiation included from CS.
30-08-2018  Amuthakumar P	BZ		ILCRSTPAR1917		  Changed Sampling Amount from Sample Issue ( FreeIssueDt)
19-09-2018  Amuthakumar P	BZ		CRCRSTAPAR0023		  Debit note Top Sheet not Consider un-salable Sales return / Manual Claim Report Inserted
09-10-2018   Mohana P		BZ	    ILCRSTPAR2313	    TAX CALCULATION CHANGED AS PER CLIENT REQUEST
12-10-2018   Mohana P		BZ	    ILCRSTPAR2343	    TAX CALCULATION CHANGED AS PER CLIENT REQUEST
16-10-2018   Mohana P		BZ	    ILCRSTPAR2343	     Incorprated LIVE Changes in UAT (AS per Awanish discussion, LIVE REport is correct. So we have changed based on live)
************************************************************************************************************************************/     
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	 
	--Report 1
	DECLARE @CityName AS NVARCHAR(100)
	DECLARE @DistributorCode AS NVARCHAR(40)
	DECLARE @DistributorName AS NVARCHAR(100)
	DECLARE @DBMonth As INT
	
	EXEC Proc_SchUtilization_Report @FromDate,@ToDate
	
	SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,
	@CityName = G.GeoName
	FROM Distributor D (NOLOCK),
	Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId
	
	--Added By Mohana 
	
	--SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate
	SELECT @DBMonth = CASE MONTH (@ToDate) 
		WHEN 4 THEN 1
		WHEN 5 THEN 2
		WHEN 6 THEN 3
		WHEN 7 THEN 4
		WHEN 8 THEN 5
		WHEN 9 THEN 6
		WHEN 10 THEN 7
		WHEN 11 THEN 8
		WHEN 12 THEN 9
		WHEN 1 THEN 10
		WHEN 2 THEN 11
		WHEN 3 THEN 12
	END 
	--Report 1
		
	--Report 2
	DECLARE @SlNo AS INT
	
	DECLARE @SamplingAmount AS NUMERIC(18,2)
	SELECT @SlNo = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'
	
	---- Commented by Amuthakumar ILCRSTPAR1917
	
	--DECLARE @MGSaleable AS INT 
	--DECLARE @MGOffer AS INT
	
	--SELECT @MGSaleable = StockTypeId FROM StockType WHERE UserStockType = 'MGSaleable'
	--SELECT @MGOffer = StockTypeId FROM StockType WHERE UserStockType = 'MGOffer'
	--SELECT DISTINCT J.PrdId,J.PrdBatId,B.TaxGroupId,CAST(0 AS NUMERIC(18,2)) TaxPercentage
	--INTO #SamplingBatchTaxPercent
	--FROM StockJournal J,
	--StockJournalDt D (NOLOCK),
	--ProductBatch B (NOLOCK)
	--WHERE J.StkJournalRefNo = D.StkJournalRefNo
	--AND J.PrdBatId = B.PrdBatId	AND J.PrdId = B.PrdId
	--AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	
	--SELECT ROW_NUMBER() OVER (ORDER BY T.TaxGroupId) RowNo,
	--MAX(T.PrdBatId) PrdBatId,T.TaxGroupId 
	--INTO #BatchTaxPercent
	--FROM #SamplingBatchTaxPercent T
	--WHERE T.TaxGroupId <> 0
	--GROUP BY T.TaxGroupId
	
	--DECLARE @PrdId AS INT
	--DECLARE @PrdBatId AS INT
	--DECLARE @TaxGroupId AS INT
	--DECLARE @TaxPercentage AS NUMERIC(18,2)
	--DECLARE @RowNo AS INT
	--DECLARE @TotalRow AS INT
	
	--SET @RowNo = 1
	--SELECT @TotalRow = COUNT(TaxGroupId) FROM #BatchTaxPercent D (NOLOCK)	
		
	--TRUNCATE TABLE SamplingBatchTaxPercent
	--WHILE (@RowNo < = @TotalRow)
	--BEGIN	
	--	SELECT @PrdId = B.PrdId, @PrdBatId = S.PrdBatId, @TaxGroupId = B.TaxGroupId
	--	FROM #BatchTaxPercent S,
	--	#SamplingBatchTaxPercent B (NOLOCK)
	--	WHERE S.PrdBatId = B.PrdBatId AND S.TaxGroupId = B.TaxGroupId
	--	AND RowNo = @RowNo
	--	EXEC Proc_SamplingTaxCalCulation @PrdId,@PrdBatId
		
	--	SELECT @TaxPercentage = TaxPercentage FROM SamplingBatchTaxPercent S (NOLOCK)
	--	WHERE PrdBatId = @PrdBatId
		
	--	UPDATE B SET B.TaxPercentage = @TaxPercentage
	--	FROM #SamplingBatchTaxPercent B
	--	WHERE B.TaxGroupId = @TaxGroupId
		
	--	SET @RowNo = @RowNo + 1
		
	--END	
	
	--SELECT @SamplingAmount =  ISNULL(SUM( D.StkTransferQty * (P.PrdBatDetailValue + (P.PrdBatDetailValue * (T.TaxPercentage / 100)))),0)
	--FROM StockJournal J (NOLOCK),
	--StockJournalDt D (NOLOCK),
	--ProductBatchDetails P (NOLOCK),
	--#SamplingBatchTaxPercent T (NOLOCK)
	--WHERE J.StkJournalRefNo = D.StkJournalRefNo AND J.PriceId = P.PriceId
	--AND P.PrdBatId = T.PrdBatId
	--AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	--AND P.SLNo = @SlNo
	----Report 2
	---- Till Here ILCRSTPAR1917
	
	--- Change by Amuthakumar P ILCRSTPAR1917
	SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)
	FROM FreeIssueHd J (NOLOCK),
	FreeIssueDt D (NOLOCK),
	ProductBatchDetails P (NOLOCK)
	WHERE J.IssueId = D.IssueId 
	AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId 
	AND P.SLNo = @SlNo AND J.IssueDate BETWEEN @FromDate AND @ToDate
	--Report 2
	
	--- Till Here ILCRSTPAR1917
	
	--Report 3
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)	
	
	-------------------- Added by Lakshman M On 07/11/2017 PMS_ICRSTPAR6575-------------------
	 -------------- Scheme code validation added by LAkshman M Dated By On 25/07/2018 PMS ID:ILCRSTPAR1496 ------------
	 SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,    
	 B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue--,D.Schid    
	 INTO #BillingDetails    
	 FROM SalesInvoice S (NOLOCK)    
	 INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId    
	 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId 
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1	
	 --INNER JOIN Debitnote_Scheme D ON D.Salid = S.SalId AND SP.SalId = D.Salid AND D.Prdid =SP.PrdID AND D.linetype = 1
	 WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =@SlNo
	    
	 SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,    
	 B.DefaultPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue--,D.Schid    
	 INTO #ReturnDetails    
	 FROM ReturnHeader S (NOLOCK)    
	 INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID    
	 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId    
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1
	 and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1) 
	-- INNER JOIN Debitnote_Scheme D ON D.Salid = S.ReturnID AND SP.ReturnID = D.Salid  AND D.linetype = 2
	 WHERE S.ReturnDate BETWEEN  @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =@SlNo
	    
	 SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,
	 PrdBatDetailValue as PrdUnitSelRate,   
	 CAST (0 AS NUMERIC(18,6)) AS LCTR 
	 INTO #DebitSalesDetails    
	 FROM     
	 (    
	 SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue  FROM #BillingDetails   
	 UNION ALL    
	 SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId ,SlNo,prdtaxamount,PrdBatDetailValue  FROM #ReturnDetails    
	 ) Consolidated 
	------------------ Till Here ----------------------
	 UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)    
	 FROM #DebitSalesDetails M (NOLOCK),    
	 ProductBatchDetails D (NOLOCK)     
	 WHERE M.ActualPriceId = D.PriceId AND D.SLNo = @SlNo 
	
	---------------- commented by Lakshman M on 07/11/2017 ---------------  
	--UPDATE R SET R.LCTR = R.BaseQty * (R.ActualSellRate+(R.ActualSellRate*(T.TaxPerc/100)))
	--FROM #DebitSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType
  -----------------------
	 UPDATE R SET R.LCTR = ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2)      
	 FROM #DebitSalesDetails R (NOLOCK),    
	 #ParleOutputTaxPercentage T (NOLOCK)
	 WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType  
	
	CREATE TABLE #ApplicableProduct
	(
		SchId		INT,
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT DISTINCT A.SchId,B.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN Product C On B.Prdid = C.PrdId
		WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0
	UNION ALL
	SELECT DISTINCT A.SchId,E.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F On
		F.PrdId = E.Prdid
		WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0
	UNION ALL
	SELECT DISTINCT S.SchId,B.MasterRecordId
		FROM SchemeProducts A 
		INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId 
		INNER JOIN SchemeMaster S ON A.SchId = S.SchId
		WHERE S.SchemeLvlMode = 1
		
  --added by mohana ILCRSTPAR0500	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT Schid ,PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	WHERE ChangeType='Remove'   AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0 )
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)		
	SELECT DISTINCT A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'  
		
	CREATE TABLE #ApplicableScheme
	(
		SchId			INT,
		SchDsc			NVARCHAR(100),
		SchValidFrom	DATETIME,
		SchValidTill	DATETIME,	
		Budget			NUMERIC(18,2),
		BudgetAllocationNo VARCHAR(100),
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableScheme (SchId,SchDsc,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)			
	SELECT DISTINCT A.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId
	FROM #ApplicableProduct A (NOLOCK),
	SchemeMaster S (NOLOCK)
	WHERE A.SchId = S.SchId AND A.SchId  IN (SELECT SCHID FROM Debitnote_Scheme) 
	AND S.Claimable = 1
	
	--Added CircularNo and date By Mohana
	--SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,
	--SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	--CAST(0 AS NUMERIC(18,6)) Amount
	--INTO #SchemeDebit
	--FROM #ApplicableScheme S (NOLOCK),
	--#DebitSalesDetails B (NOLOCK) ,
	--SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode 
	--WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId AND S.SchId in (SELECT DISTINCT  SCHID FROM DEbitnote_Scheme) 
	--GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate
	--ORDER BY S.SchId
	--SchemeCirculardetails
		 
	SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	CAST(0 AS NUMERIC(18,6)) Amount
	INTO #SchemeDebit1
	FROM #ApplicableScheme S (NOLOCK),
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=1 AND
	--PMS NO:ILCRSTPAR0909
	--S.SchValidFrom BETWEEN @FromDate AND @ToDate
	--AND S.SchValidTill 	BETWEEN @FromDate AND @ToDate
	--(S.SchValidFrom BETWEEN @FromDate AND @ToDate
	--or S.SchValidTill 	BETWEEN @FromDate AND @ToDate)
	(B.Transdate BETWEEN @FromDate AND @ToDate
	OR B.TransDate	BETWEEN @FromDate AND @ToDate)----PMS NO:ILCRSTPAR1309 Till Here
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate
	ORDER BY S.SchId
	 
	INSERT INTO #SchemeDebit1
	SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	CAST(0 AS NUMERIC(18,6)) Amount
	FROM #ApplicableScheme S (NOLOCK),
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2 AND 
	--PMSNo:ILCRSTPAR0909
	--S.SchValidFrom BETWEEN @FromDate AND @ToDate
	--AND S.SchValidTill 	BETWEEN @FromDate AND @ToDate
	--(S.SchValidFrom BETWEEN @FromDate AND @ToDate
	--or S.SchValidTill 	BETWEEN @FromDate AND @ToDate)
	(B.Transdate BETWEEN @FromDate AND @ToDate
	OR  B.Transdate 	BETWEEN @FromDate AND @ToDate)
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate
	ORDER BY S.SchId

 
	DELETE FROM #SchemeDebit1 WHERE SchId NOT IN (SELECT Schid FROM Debitnote_Scheme WHERE Linetype=1)      

	INSERT INTO #SchemeDebit1
	SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	CAST(0 AS NUMERIC(18,6)) Amount
	FROM #ApplicableScheme S (NOLOCK),
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana
	,Debitnote_Scheme D   
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2  
	AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid 
	AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate
	ORDER BY S.SchId
	 
	select  SchId,SchDsc,SchValidFrom,SchValidTill,SchemeBudget,CircularNo, CircularDate,
	SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	CAST(0 AS NUMERIC(18,6)) Amount
	INTO #SchemeDebit from #SchemeDebit1  
	group by SchId,SchDsc,SchValidFrom,SchValidTill,SchemeBudget,CircularNo, CircularDate
 	 
	 

	--SELECT S.SchId,SUM(B.BaseQty) [SecSalesQtyInScheme]
	--INTO #SchemeForLiab
	--FROM #ApplicableScheme S (NOLOCK),
	--#BillingDetails B (NOLOCK)
	--WHERE S.PrdId = B.PrdId AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	--AND EXISTS (SELECT 'C' FROM SalesInvoiceSchemeDtBilled SB (NOLOCK) WHERE B.SalId = SB.SalId AND S.SchId = SB.SchId)
	--GROUP BY S.SchId
	
		SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt INTO #SchFinal FROM 
		(
		SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt 
			FROM (
		SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A 
		INNER JOIN SalesInvoiceProduct B ON A.Salid = b.SalId AND a.Prdid = b.PrdId  
		INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.SalId AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 1 AND Linetype = 1
		GROUP BY  A.PRDID,A.SchId,TaxPerc
		)A
		GROUP BY A.SchId,TaxPerc
		)B Group by  sCHID 

		insert into #SchFinal
		SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt FROM 
		(
		SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt 		 
		FROM (
		SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A INNER JOIN RETURNPRODUCT B ON A.Salid = b.ReturnID AND a.Prdid = b.PrdId 
		INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.ReturnID AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 2 AND a.Linetype =2
		and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)  
		GROUP BY  A.PRDID,A.SchId,TaxPerc
		)A
		GROUP BY A.SchId,TaxPerc
		)B Group by  sCHID 
		 

	UPDATE SD SET SD.Amount = CASE S.ApplyTaxForClaim WHEN 0 THEN schamt ELSE  (SchAmt+TaxAmt) END
	FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid,SUM(SchAmt) SchAmt ,Sum(Taxamt) TaxAmt FROM  #SchFinal GROUP BY Schid) D  ON SD.Schid = D.Schid --CHANGED FOR CLAIMAMT MISMATCH
	INNER JOIN SchemeMaster S ON S.SchId = D.SCHID AND S.SchId = SD.SCHID 

	UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))
	FROM #SchemeDebit SD (NOLOCK)
	WHERE SD.[SecSalesVal] <> 0
	

		 
	--Report 3
	
	--Report 4
	DECLARE @TargetNo	AS INT
	
	DECLARE @InsFromDate	AS	DATETIME	
	DECLARE @InsToDate		AS	DATETIME
	DECLARE @Year	AS INT	
	DECLARE @Month  AS INT
	DECLARE @MonthName as Nvarchar(100)
 --Changed by Mohana ILCRSTPAR0506	
	SELECT   TOP 1 @TargetNo = InsId,@Month=TargetMonth,@Year=TargetYear,
	@InsFromDate = CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01',
	@InsToDate = DATEADD(DD,-1,DATEADD(MM,1,CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01'))	
	
	FROM InsTargetHD H (NOLOCK) 
	INNER JOIN 	JCMonth A  ON H.TargetMonth = A.JcmJc
	INNER JOIN    JCMast b on a.JcmId = b.JcmId AND H.TargetYear =  B.JcmYr
	WHERE A.JcmEdt  BETWEEN @FromDate AND @ToDate AND H.[Status] = 1	
	ORDER BY InsId DESC
	
	SELECT @MonthName=MonthName FROM MonthDt (NOLOCK) WHERE MonthId=@Month
	UPDATE InsTargetHD SET TargetMonth=EffFromMonthId WHERE TargetMonth=0
	
	--EXEC Proc_LoadingInstitutionsTarget @TargetNo,@Pi_UsrId
	EXEC Proc_LoadingInstitutionsTarget @Year,@Month,@MonthName,@Pi_UsrId
	
	SELECT CtgMainId,CtgName,@InsFromDate FromDate,@InsToDate ToDate,SUM([Target]) [Target],SUM(ClmAmount) DiscAmount,
	CAST(0 AS NUMERIC(18,6)) L2MSales,CAST(0 AS NUMERIC(18,6)) CurMSales,CAST(0 AS NUMERIC(18,0)) Outlet
	INTO #Institutions
	FROM InsTargetDetailsTrans (NOLOCK) WHERE CtgName <>''
	--WHERE UserId = @Pi_UsrId AND SlNo <> 0 and SlNo<>9999
	GROUP BY CtgMainId,CtgName
	
	SELECT DISTINCT R.RtrId,RC.CtgMainId
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND EXISTS (SELECT '' FROM #Institutions I (NOLOCK) WHERE I.CtgMainId = RC.CtgMainId)
	
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales
	INTO #CurrentSales
	FROM 
	(
	SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId
	UNION ALL
	SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),
	#FilterRetailer F
	WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0
	AND F.RtrId = R.RtrId
	GROUP BY F.CtgMainId
	) AS S GROUP BY S.CtgMainId
	SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet
	INTO #NoOfOutlet
	FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId	
	
	--Last Two Month Sales
	SELECT @InsToDate = DATEADD (D,-1,@InsFromDate) 
	SELECT @InsFromDate = DATEADD (MONTH,-2,@InsFromDate) 
	
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales
	INTO #L2MSales
	FROM 
	(
	SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId
	UNION ALL
	SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),
	#FilterRetailer F
	WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0
	AND F.RtrId = R.RtrId
	GROUP BY F.CtgMainId
	) AS S GROUP BY S.CtgMainId
	
	UPDATE I SET I.CurMSales = C.Sales
	FROM #Institutions I (NOLOCK),
	#CurrentSales C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	UPDATE I SET I.L2MSales = C.Sales / 2
	FROM #Institutions I (NOLOCK),
	#L2MSales C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	UPDATE I SET I.Outlet = C.Outlet
	FROM #Institutions I (NOLOCK),
	#NoOfOutlet C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	--Report 4
	--Nagarajan on 28.Aug.2017
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel1')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel1	
	END	
	
	CREATE TABLE RptDebitNoteTopSheet_Excel1
	(
	[Scheme Description] VARCHAR(100),
	[From] VARCHAR(10),
	[To] VARCHAR(10),
	[Circular No] VARCHAR(100),
	[Date] NVARCHAR(10),
	[Scheme Budget] NUMERIC(18,6),
	[Sec Sales Qty] BIGINT,
	[Sec Sales Value] NUMERIC(18,6),
	[% Liability on Sec Sales] NUMERIC(18,6),
	[Claim Amount] NUMERIC(18,6)
	) 		

	UPDATE #SchemeDebit SET Liab = (Amount / SecSalesVal) * 100 WHERE Liab > 0

	

	SELECT S.SchDsc [Scheme Description],CONVERT(VARCHAR(10),S.SchValidFrom,103) [From],CONVERT(VARCHAR(10),S.SchValidTill,103) [To],ISNULL(S.CircularNo,'') [Circular No],
	 CONVERT(VARCHAR(10),S.CircularDate,103)  [Date],S.SchemeBudget [Scheme Budget],[SecSalesQty] [Sec Sales Qty],[SecSalesVal] [Sec Sales Value],CAST(Round(Liab,2) AS Numeric(18,2)) AS [% Liability on Sec Sales],
	 cast(round(Amount,2) as Numeric(18,2)) as  [Claim Amount],'A' As Dummy
	INTO #RptDebitNoteTopSheet_Excel1
	FROM #SchemeDebit S (NOLOCK) --WHERE Amount > 0	
	WHERE Amount <> 0 --- CRCRSTPAR0023  IF Difference of Claim Amt is Zero need not Shown --Changed as not equal to 
	
	
	IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel1) > 0
	BEGIN
		INSERT INTO #RptDebitNoteTopSheet_Excel1
		SELECT 'Total' [Scheme Description],'' [From],'' [To],'' [Circular No],'' [Date], 0 [Scheme Budget],
        0 [Sec Sales Qty], 0 [Sec Sales Value],0 [% Liability on Sec Sales],SUM([Claim Amount]) [Claim Amount],'B' Dummy
		FROM  #RptDebitNoteTopSheet_Excel1 
	END
	
	SELECT * INTO #Excel1 FROM #RptDebitNoteTopSheet_Excel1 ORDER BY Dummy
	
	DECLARE @RecCount AS BIGINT
	SELECT @RecCount = COUNT(7) FROM #RptDebitNoteTopSheet_Excel1
	
	INSERT INTO RptDebitNoteTopSheet_Excel1
	SELECT [Scheme Description],Cast([From] As Varchar(10)) [From],Cast([To] As Varchar(10)) [To],[Circular No],[Date],[Scheme Budget],
	[Sec Sales Qty],[Sec Sales Value],[% Liability on Sec Sales],[Claim Amount]
	FROM #Excel1 ORDER BY Dummy

	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel2')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel2	
	END		
	CREATE TABLE RptDebitNoteTopSheet_Excel2
	(
		[Name Of the Category] NVARCHAR(200),
		[From] VARCHAR(10),
		[TO] VARCHAR(10),
		[Circular No] VARCHAR(50),
		[Monthly Target] NUMERIC(38,6),
	    [Last 2 Months Avg Sales] NUMERIC(18,6),
	    [Current Month] NUMERIC(18,6),
	    [No of Incentive Outlets] NUMERIC(18,0),
	    [Total Discount Amount] NUMERIC(38,6)
	)
	
	SELECT CtgName [Name Of the Category],convert(varchar(10),FromDate,103) [From],convert(varchar(10),ToDate,103) [To],'' [Circular No],[Target] [Monthly Target],
	L2MSales [Last 2 Months Avg Sales],CurMSales [Current Month],Outlet [No of Incentive Outlets],DiscAmount [Total Discount Amount],'A' Dummy
	INTO #RptDebitNoteTopSheet_Excel2
	FROM #Institutions (NOLOCK)
	IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel2) > 0
	BEGIN
	----------------- modified by lakshman M on 04/10/2017----------------    
	 INSERT INTO #RptDebitNoteTopSheet_Excel2    
	 SELECT 0 As [Name Of the Category],0 As [From],0 As [To],0 As [Circular No],0 As [Monthly Target],    
	 0 As [Last 2 Months Avg Sales],0 As [Current Month],0 As [No of Incentive Outlets],sum([Total Discount Amount]) [Total Discount Amount],'B' Dummy    
	 FROM #RptDebitNoteTopSheet_Excel2 
	   
	 Update A set [Name Of the Category]= null ,[From]=null,[To]=null,[Monthly Target]=null,[Last 2 Months Avg Sales]=null  
	 ,[Current Month]=null,[No of Incentive Outlets]=null, [Total Discount Amount]=null,[Circular No]='' from #RptDebitNoteTopSheet_Excel2 A where Dummy ='B'  
    -------------------- Till here ----------------------------- 
	END
	
	SELECT * INTO #Excel2 FROM #RptDebitNoteTopSheet_Excel2 ORDER BY Dummy
	
	INSERT INTO RptDebitNoteTopSheet_Excel2
	SELECT [Name Of the Category],[From],[To],[Circular No],[Monthly Target],
	[Last 2 Months Avg Sales],[Current Month],[No of Incentive Outlets],[Total Discount Amount]
	FROM #Excel2
	----------------------------------------------------TOT CLAIM Added By Mohana-------------------------------------------------------------------
	DECLARE @RecCount1 INT
	SELECT @RecCount1  = COUNT(*) FROM RptDebitNoteTopSheet_Excel2
	
	CREATE Table #TotClaimFinal 
	(
	CtgName		NVARCHAR(100),
	Fromdate	DATETIME,
	Todate	DATETIME,
	NrmlRate NUMERIC (18,2),
	SecSalesTot NUMERIC (18,2),
	DiffClaims NUMERIC (18,2)	
	)
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,   
	B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue   
	INTO #BillingDetails1    
	FROM SalesInvoice S (NOLOCK)    
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId    
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId 
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1		 
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,  
	B.DefaultPriceId ActualPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue  
	INTO #ReturnDetails1    
	FROM ReturnHeader S (NOLOCK)    
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)   
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId    
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName
	INTO #Retailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId

	
	SELECT tranid,Refid,Rtrid,CtgName,RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno
	INTO #TotClaim FROM(
	SELECT 1 tranid,Salid Refid,A.Rtrid,CtgName,Salinvdate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid 
	UNION 
	SELECT 2 Transid,ReturnID Refid,A.Rtrid,CtgName,ReturnDate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid 
	)A


 

	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #TotClaim M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #TotClaim M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	 UPDATE A SET A.SplRate = (BaseQty*((B.SplselRate)+(B.SplselRate*(p.TaxPerc/100)))) FROM  #TotClaim A INNER JOIN #ExistingSpecialPrice B
	 ON A.Priceid = B.Priceid 
	 INNER JOIN  ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid
	 WHERE A.Priceid <>0
	
	
	 UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A 
	  INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid
	 WHERE A.Priceid =0
	
	 UPDATE A SET A.NrmlRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A 
	 INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid
	 
	 UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim A  
	 
	 INSERT INTO #TotClaimFinal(CtgName,NrmlRate,SecSalesTot,DiffClaims)
	 SELECT CtgName,SUM(NrmlRate),SUM(SplRate),SUM(Diff) FROM #TotClaim
	 GROUP BY Ctgname 
	 
	 UPDATE A SET Fromdate = B.Frmdt ,Todate = B.todt FROM #TotClaimFinal A  INNER JOIN (SELECT Ctgname,MIn(RefDate) Frmdt,Max(RefDate) todt FROM #TotClaim GROUP BY CtgName) B ON A.CtgName = B.Ctgname
	 
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel3')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel3	
	END		
	CREATE TABLE RptDebitNoteTopSheet_Excel3
	(
		[Name Of the Category] NVARCHAR(200),
		[From] DATETIME,
		[TO] DATETIME,
		[Total Normal amount] NUMERIC(18,2),
	    [Total  Normal  Sec Sales As Per TOT] NUMERIC(18,2),
	    [TOT Diff claims] NUMERIC(18,2) 
	)
	 
 	INSERT INTO RptDebitNoteTopSheet_Excel3
 	SELECT * FROM #TotClaimFinal
 	WHERE DiffClaims > 0 --- CRCRSTPAR0023  IF Difference of Claim Amt is Zero need not Shown
 	
	SET @RecCount = @RecCount + 1
	
	SET @RecCount1 = @RecCount1 +@RecCount + 1
	 
	-- Till here
	
	----------------------------------------MANUAL CLAIM Added By Amuthakumar CRCRSTAPAR0023 ---------------------------------------------
		
	SELECT MCD.DESCRIPTION,MCM.MacDate As [From], MCM.MacDate AS [To],MCM.MacRefNo,ProposedLibPercent,TotalSales,ActualLibPercent,ClaimAmt
	INTO #TotManualClaim
	FROM ManualClaimMaster MCM INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo
	WHERE MacDate BETWEEN @FromDate AND @ToDate
		
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel4')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel4	
	END		
	CREATE TABLE RptDebitNoteTopSheet_Excel4
	(
		[Scheme Description] NVARCHAR(200),
		[From] DATETIME,
		[TO] DATETIME,
		[Circular No] NVARCHAR(100),
		[Scheme Budget] NUMERIC(18,2),
	    [Sec Sales Value] NUMERIC(18,2),
	    [% Liability on Sec Sales] NUMERIC(18,2),
	    [Claim Amount] NUMERIC(18,2)
	)
		 
 	INSERT INTO RptDebitNoteTopSheet_Excel4
 	SELECT * FROM #TotManualClaim
 	
 	DECLARE @RecCount2 INT
	SELECT @RecCount2  = COUNT(*) FROM RptDebitNoteTopSheet_Excel3
		
	set @RecCount1 = @RecCount1+1

	SET @RecCount2 = @RecCount2 + @RecCount1 + 1
				
	-- Till Here CRCRSTAPAR0023
		
	TRUNCATE TABLE RptExcelDebitNote  
		 
	INSERT INTO RptExcelDebitNote(Row,Col,MergeCells,Value)
	SELECT 1,1,'A1:J1','PARLE - DEBIT NOTE / CREDIT NOTE'
	UNION ALL
	SELECT 2,1,'A2:J2',''   --ICRSTPAR6933 (Row Number Changed OlRowNo+1)
	UNION ALL
	SELECT 3,1,'A3:H3','Name of the Town : ' + ISNULL(@CityName,'')
	UNION ALL
	SELECT 3,9,'I3:J3','Passed by SO / SE :'
	UNION ALL
	SELECT 4,1,'A4:F4','Name of the Wholesaler : ' + ISNULL(@DistributorName,'')
	UNION ALL
	SELECT 4,7,'G4:H4','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)
	UNION ALL
	SELECT 4,9,'I4:J4','Verified by ASM :'
	UNION ALL
	SELECT 5,1,'A5:F5','Wholesaler Code : ' + ISNULL(@DistributorCode,'')
	UNION ALL
	SELECT 5,7,'G5:H5','Credit Note No :'
	UNION ALL
	SELECT 5,9,'I5:J5','Authorized by DSM :'
	UNION ALL
	SELECT 6,1,'A6:F6','Name of the Division :'
	UNION ALL
	SELECT 6,7,'G6:H6','Credit Note Date :'
	UNION ALL
	SELECT 6,9,'I6:J6','Value of Approved credit note :'
	UNION ALL
	SELECT 7,1,'A7:J7',''
	UNION ALL	
	SELECT 8,1,'A8:J8','1.SAMPLING'
	UNION ALL
	SELECT 9,1,'A9:E9','DSM Sanction Letter Date '
	UNION ALL
	SELECT 9,6,'F9:J9','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30))
	UNION ALL
	SELECT 10,1,'A10:D10','Product Sampled during the period  '
	UNION ALL
	SELECT 10,5,'E10:G10','From : ' + CONVERT(VARCHAR(11),@FromDate,105)
	UNION ALL
	SELECT 10,8,'H10:J10','To : ' + CONVERT(VARCHAR(11),@ToDate,105)
	UNION ALL
	SELECT 11,1,'A11:J11',''	
	UNION ALL
	SELECT 12,1,'A12:J12','2.TRADE SCHEME'	
	UNION ALL
	SELECT 13,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel1'
	UNION ALL
	SELECT 14,1,'A14','1R'	
	UNION ALL
	SELECT 14 + @RecCount + 1,1,'A' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) + ':J' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) ,'3.INSTITUTIONAL SALES'	
	UNION ALL
	SELECT 14 + @RecCount + 2,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel2'
	UNION ALL
	SELECT 14 + @RecCount + 3,1,'A' + CAST(14 + @RecCount + 3 AS VARCHAR(10)),'2R'
	UNION ALL
	SELECT 14 + @RecCount,1,'A' + CAST(14 + @RecCount AS VARCHAR(10)) + ':' + 'J' + CAST(14 + @RecCount AS VARCHAR(10)),''	
	UNION ALL--Added By Mohana
	SELECT 15,1,'A15','1R'
	UNION ALL
	SELECT 15 + @RecCount1 + 2,1,'A' + CAST(15 + @RecCount1 + 2 AS VARCHAR(10)) + ':J' + CAST(15 + @RecCount1 + 2 AS VARCHAR(10)) ,'4.TOT DIFF CLAIMS'	
	UNION ALL
 	SELECT 15 + @RecCount1 + 4,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel3'
 	UNION ALL
 	SELECT 15 + @RecCount1 + 6,1,'A' + CAST(15 + @RecCount1 + 6 AS VARCHAR(10)),'3R'
	UNION ALL
	SELECT 15 + @RecCount1+5,1,'A' + CAST(15 + @RecCount1+5 AS VARCHAR(10)) + ':' + 'J' + CAST(15 + @RecCount1+5 AS VARCHAR(10)),''	
	UNION ALL--Till Here
	--Added By Amuthakumar  CRCRSTAPAR0023
	SELECT 16,1,'A16','1R'
	UNION ALL
	SELECT 16 + @RecCount2 + 9,1,'A' + CAST(16 + @RecCount2 + 9 AS VARCHAR(10)) + ':J' + CAST(16 + @RecCount2 + 9 AS VARCHAR(10)) ,'5.MANUAL CLAIM'	
	UNION ALL
 	SELECT 16 + @RecCount2 + 11,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel4'
 	UNION ALL
 	SELECT 16 + @RecCount2 + 13,1,'A' + CAST(16 + @RecCount2 + 13 AS VARCHAR(10)),'4R'
	UNION ALL
	SELECT 16 + @RecCount2 + 12,1,'A' + CAST(16 + @RecCount2+12 AS VARCHAR(10)) + ':' + 'J' + CAST(16 + @RecCount2+12 AS VARCHAR(10)),''	
	UNION ALL--Till Here  CRCRSTAPAR0023
	SELECT 0,10,'B14','ColumnWidth'		
	UNION ALL
	SELECT 0,10,'C14','ColumnWidth'	
	UNION ALL
	SELECT 1,1,'-4108','HorizontalAlignment'
	UNION ALL
	SELECT 2,25,'2:6','RowHeight'	--ICRSTPAR6933
	RETURN	
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpecialRateAftDownLoad_Calc]') AND type in (N'U'))
BEGIN
	CREATE TABLE [dbo].[SpecialRateAftDownLoad_Calc](
		[RtrCtgCode] [nvarchar](100) NULL,
		[RtrCtgValueCode] [nvarchar](100) NULL,
		[RtrCode] [nvarchar](100) NULL,
		[PrdCCode] [nvarchar](100) NULL,
		[PrdBatCCode] [nvarchar](100) NULL,
		[SplSelRate] [numeric](38, 6) NULL,
		[FromDate] [datetime] NULL,
		[CreatedDate] [datetime] NULL,
		[DownloadedDate] [datetime] NULL,
		[ContractPriceIds] [nvarchar](1000) NULL,
		[ConSplSelRate] [numeric](18, 6) NULL,
		[DiscountPerc] [numeric](18, 6) NULL,
		[SplrateId] [int] NULL,
		[ApplyOn] [tinyint] NULL,
		[TYPE] [int] NULL
	)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_PopulateToBeUploaded]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_PopulateToBeUploaded]
GO
--Exec Proc_PopulateToBeUploaded 0
CREATE PROCEDURE [dbo].[Proc_PopulateToBeUploaded]
(
@Po_ErrNo INT OUTPUT
)
As
Begin
BEGIN TRY        
SET XACT_ABORT ON        
BEGIN TRANSACTION  
declare @SqlStr varchar(8000)
declare @Process varchar(100)
declare @colcount int
declare @Col varchar(5000)
declare @Tablename varchar(100)
declare @Sequenceno int
declare @Lvar int
declare @MaxId int
Declare @DistCode Varchar(100)
Declare @SyncId Int
SET @Po_ErrNo=0
-- *** upload integration table to be replaced....
Create table #Process(ProcessName varchar(100),PrkTableName varchar(100), id int identity(1,1) )
insert into #Process(ProcessName , PrkTableName) select ProcessName , PrkTableName from Tbl_UploadIntegration order by Sequenceno
Select @DistCode = DistributorCode From Distributor 
Select @SyncId = Max(SyncId) From Sync_Master
--Delete From CS2Console_Consolidated Where UploadFlag = 'Y'
--Delete A From CS2Console_Consolidated  A (Nolock) , SyncStatus B 
--Where A.DistCode = B.DistCode And A.UploadFlag = 'Y' And A.SyncId = B.SyncId And B.SyncStatus <> 0
	----- Added by Anand S on 10.09.2012 -- for handling the DB Restoration - SyncId Mismatch....
	--Declare @SyncSts int
	--Declare @ZCnt int
	--Select @SyncSts = ISNULL(SyncStatus,0) from SyncStatus (nolock)
	--select @ZCnt = Count(*) from CS2Console_Consolidated(nolock) where UploadFlag = 'N' and
	--SyncId = (select isnull(SyncId,0)  from SyncStatus (nolock) )
	--if (@SyncSts = 0 and @ZCnt = 0)
	--begin
	--Update CS2Console_Consolidated set UploadFlag = 'N' where 	SyncId = (select isnull(SyncId,0)  from SyncStatus (nolock) )
	--end
	--- Till Here
Delete A From CS2Console_Consolidated A (nolock) Where SyncId <> (Select ISNULL(MAX(SyncId),0) From SyncStatus)
--Delete A From CS2Console_Consolidated A (nolock) Where SyncId < (Select ISNULL(MAX(SyncId),0) From SyncStatus) AND UploadFlag='Y'
Delete A From CS2Console_Consolidated A (nolock) Where SyncId = (Select ISNULL(MAX(SyncId),0) From SyncStatus WHERE SyncStatus=1) AND UploadFlag='Y' 
IF ((Select Count(*) From CS2Console_Consolidated (nolock)) = 0)
Begin
	Truncate Table CS2Console_Consolidated
End
set @Lvar = 1
select @MaxId = Max(id) from #Process
while @Lvar <= @MaxId
begin
	select @Tablename = PrkTableName , @Process = ProcessName from #Process where id  = @Lvar
	select @colcount = Max(Column_ID) from sys.columns where object_id = (select object_id from sys.objects where name = @Tablename)
	set @SqlStr = ''
	set @SqlStr = @SqlStr + ' Insert into CS2Console_Consolidated '
	set @Col = ''
	select @Col = @Col + name + ',' from sys.columns 
	where object_id = ( select object_id from sys.objects where name = 'CS2Console_Consolidated')
	and column_id  between 2 and @colcount + 5 Order by column_id 
	set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ',UploadFlag)'
	
	set @Col = ''
	--select @Col = @Col + name + ',' from sys.columns 
	select @Col = @Col + (Case when (name = 'UploadedDate' Or name = 'ServerDate') Then  'CONVERT(VARCHAR(19),[' + name + '],121)' else 'REPLACE(['+name + '],'''''''','''')'  end)+ ',' from sys.columns 
	where Object_Id = ( select Object_Id from sys.objects where name = @Tablename)
	and column_id  <= @colcount Order by column_id 
	set @SqlStr = @SqlStr + 'Select '''+ CONVERT(Varchar(50),@DistCode) + ''','+ CONVERT(Varchar(50),@SyncId) + ',''' + @Process + ''' ,getdate(), '
    set @SqlStr = @SqlStr + ' ' + left(@Col,len(@Col)-1)  + ',''N'' from ' + @Tablename + '(nolock) where UploadFlag = ''N''  And SyncId Is Not Null  Order By SlNo '
	--Print(@SqlStr)
	exec (@SqlStr)
	set @SqlStr = ''
	set @SqlStr = @SqlStr + ' Update B Set B.UploadFlag = ''Y'' From CS2Console_Consolidated A (Nolock),  ' + @Tablename  + ' B (nolock) '
	set @SqlStr = @SqlStr + ' Where A.DistCode = B.DistCode and a.SyncId = b.SyncId and A.ProcessName = ''' + @Process + '''  And A.SyncId Is Not Null '
	exec (@SqlStr)
	--Print(@SqlStr)
	set @SqlStr = ''
	
set @Lvar = @Lvar + 1
end
	Update SyncStatus Set SyncFlag = 'Y' Where DistCode=@DistCode And SyncId = @SyncId
	Create Table #SPLTBL (Id INT Identity(1,1),CId INT,CName VARCHAR(200),CType VARCHAR(100))
	INSERT INTO #SPLTBL
	SELECT A.column_id AS CId,A.Name,C.name AS CType FROM Sys.columns A,Sys.objects B,Sys.types C 
	WHERE A.object_id = B.object_id and B.name = 'CS2Console_Consolidated'
	And A.system_type_id = C.system_type_id And C.name='VARCHAR'
	Order by A.column_id 
	DECLARE @CName VARCHAR(100)
	SET @Lvar = 1
	SET @CName = ''
	SELECT @MaxId = IsNull(Count(CId),0) FROM #SPLTBL
	While @Lvar <= @MaxId
	Begin
		SELECT @CName = CName FROM #SPLTBL WHERE Id = @Lvar
		SET @SqlStr = ''
		SET @SqlStr = @SqlStr + ' UPDATE CS2Console_Consolidated  SET '+ @CName + ' = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(' + @CName + ','''''''',''''),''"'',''''),''&'',''''),''<'',''''),''>'','''') '
		Print (@SqlStr)
		exec (@SqlStr)
		
		SET @SqlStr = ''
		SET @SqlStr = @SqlStr + ' UPDATE CS2Console_Consolidated  SET '+ @CName + ' = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(' + @CName + ',''\r'',''''),''\n'',''''),''\f'',''''),''\p'',''''),''\t'',''''),''\s'','''') '
		Print (@SqlStr)
		exec (@SqlStr)
				
		SET @Lvar = @Lvar + 1
	End
COMMIT TRANSACTION        
 END TRY        
 BEGIN CATCH        
  ROLLBACK TRANSACTION        
  INSERT INTO Sync_ErrorLog VALUES ('Proc_PopulateToBeUploaded', ERROR_MESSAGE(), GETDATE())        
 END CATCH        
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_RetailerMigration]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_RetailerMigration]
GO
/*
Begin transaction
delete from ErrorLog
exec Proc_Cn2Cs_RetailerMigration 0
select * from ErrorLog
rollback transaction
*/  
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_RetailerMigration]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMigration 0
* PURPOSE		: Retailer to be Migrated from One DB to Other DB
* CREATED		: Sathishkumar Veeramani
* CREATED DATE	: 06/06/2014
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
17-01-2018  lakshman M   BZ     ICRSTPAR7316          Retailer Tin No & Retailer Phone Number null values validation removed in Core stocky.
03-02-2018  lakshman M   BZ     ICRSTPAR7619          RtrPhone Number & RtrTinNumber Null values allowed in RetailerMasterMigartion Table
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
SET @Po_ErrNo=0
DECLARE @CmpId AS NUMERIC(18,0)
DECLARE @SmId AS NUMERIC(18,0)
DECLARE @RmId AS NUMERIC(18,0)
DECLARE @DlvRmId AS NUMERIC(18,0)
DECLARE @UdcMasterId AS NUMERIC(18,0)
DECLARE @DistCode AS NVARCHAR(200)
DELETE FROM Cn2Cs_Prk_RetailerMigration WHERE DownLoadFlag = 'Y'
SELECT @DistCode = DistributorCode FROM Distributor WITH(NOLOCK)
SELECT @CmpId = CmpId FROM Company (NOLOCK) WHERE DefaultCompany = 1
	
	CREATE TABLE #ToAvoidRetailerMigration
	(
	  SalesmanCode   NVARCHAR(200),
	  SalRouteCode   NVARCHAR(200),
	  DlvRouteCode   NVARCHAR(200), 
	  RetailerCode   NVARCHAR(200),
	  GeoLevel       NVARCHAR(200),
	  GeoCode        NVARCHAR(200)
	)
	
	--Route Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoLevel)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Route Geography Level Not Available-'+RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	--Route Geography Value Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoCode NOT IN 
	(SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Not Available-'+RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoCode NOT IN (SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Wrongly Mapped-'+RouteGeoLevel+'-'+RouteGeoCode	
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	
	--Salesman Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalesmanCode)
	SELECT DISTINCT SalesManCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManName IN 
	(SELECT SmName FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Salesman','Salesman Name','Salesman Name Already Availabe-'+SalesManName 
	--FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManName IN (SELECT SmName FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--Sales Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode)
	SELECT DISTINCT SalRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalRouteName IN 
	(SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Sales Route Name Already Availabe-'+SalRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE SalRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--Delivery Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(DlvRouteCode)
	SELECT DISTINCT DlvRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DlvRouteName IN 
	(SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Delivery Route Name Already Availabe-'+DlvRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE DlvRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--Retailer Details Validation
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
--	(RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Duplicate Retailer Unique Code Not Allow-'+RtrUniqueCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
	
	
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Retailer Unique Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
		
	----Duplicate Retailer Phone No & Tin No.
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	And ISNULL(A.RTRPHONENO,'') <> ''
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Duplicate Phone Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	AND ISNULL(A.RTRPHONENO,'') <> ''
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	AND ISNULL(A.RtrTinNumber,'') <> ''
	----------------- Retailer Tin No validation commented by lakshman M on 17/01/2018 PMS ID: ICRSTPAR7316 --------------------
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Duplicate Tin Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	--AND ISNULL(A.RtrTinNumber,'') <> ''
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Tin Number length Should be between 8 to 12-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Phone Number length Should be between 8 to 10-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
---------------------- Till Here ---------------------
	--Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	--Company Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Company Retailer Code Should Not be Empty-'+CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	--Retailer Name
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Name Should Not be Empty-'+RtrName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	--Retailer Address
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Address1 Should Not be Empty-'+RtrAddress1 FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	--Retailer Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Not Available-'+RetailerGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS RetailerGeoLevel 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	--Retailer Geography Value Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoCode NOT IN 
	(SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Not Available-'+RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoCode NOT IN (SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Wrongly Mapped-'+RetailerGeoLevel+'-'+RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	
	--Retailer Multiple Delivery Route
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Route','RMcode','Retailer Delivery Route Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry	
	
	--Retailer Category Value Class	Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
    SELECT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'RetailerValueClass','ValueClassCode','Retailer Category and Value Class Not Available-'+
	RtrChannelCode+'-'+RtrGroupCode+'-'+RtrClassCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)
    -- Phone & Tin Number Dublicate Validation
	--IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
	--BEGIN
	--	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	--	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration (NOLOCK) WHERE isnull(RtrPhoneNo,'') = ''
		
	--	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Mandatory-'+ RtrCode 
	--	FROM Cn2Cs_Prk_RetailerMigration  (NOLOCK)	where isnull(RtrPhoneNo,'') = ''		
		
	--END
    	
	SELECT DISTINCT RtrPhoneNo,COUNT(RtrPhoneNo) AS Counts INTO #RtrPhoneNo FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	group BY RtrPhoneNo HAVING COUNT(RtrPhoneNo) >1	
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo
	where isnull(A.RtrPhoneNo,'') <> ''
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Unique-'+ A.RtrCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo	
	where isnull(A.RtrPhoneNo,'') <> ''
	--Tin Number Validation
	SELECT DISTINCT RtrTinNumber,COUNT(RtrTinNumber) AS Counts INTO #RtrTinNumber FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	group BY RtrTinNumber HAVING COUNT(RtrTinNumber) >1
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrTinNumber','Retailer Tin Number Should be Unique-'+ A.RtrCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
     	
	--To Insert the Salesman Details
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)
	
	INSERT INTO SalesmanMasterMigration (SMDCode,SMNCode,SMName,Upload,DownloadedDate)
	SELECT DISTINCT SalesmanCode,'SM0'+CAST((DENSE_RANK ()OVER (ORDER BY SalesManName)+@SmId) AS NVARCHAR(200))+'-'+@DistCode AS SMCode,
	SalesManName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS 
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	INSERT INTO Salesman (SMId,SMCode,SMName,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,SMCreditDays,CmpId,
    SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalesManName)+@SmId) AS SmId,
	'SM0'+CAST((DENSE_RANK ()OVER (ORDER BY SalesManName)+@SmId) AS NVARCHAR(200))+'-'+@DistCode AS SMCode,SalesManName,0 AS SMPhoneNumer,
	'' AS SMEmailID,'' AS SMOtherDetails,0.00 AS SMDailyAllowance,0.00 AS SMMonthlySalary,0.00 AS SMMktCredit,0 AS SMCreditDays,0 AS CmpId,
	0 AS SalesForceMainId,1 AS [Status],0 AS SMCreditAmountAlert,0 AS SMCreditDaysAlert,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
	CONVERT(NVARCHAR(10),GETDATE(),121),0 FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS 
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)	
	UPDATE Counters SET CurrValue = @SmId WHERE TabName = 'Salesman' AND FldName = 'SMId'
	
	--To Insert the Sales Route Details 
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	SELECT @DlvRmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMasterMigration (RMSalDCode,RMSalNCode,RMSalName,RMDlvDCode,RMDlvNCode,RMDlvName,Upload,DownloadedDate)
	SELECT DISTINCT SalRouteCode,'SR0'+CAST((DENSE_RANK ()OVER (ORDER BY SalRouteName)+@RmId) AS NVARCHAR(200))+'-'+@DistCode AS RMCode,SalRouteName,
	DlvRouteCode,'DR0'+CAST((DENSE_RANK ()OVER (ORDER BY DlvRouteName)+@DlvRmId) AS NVARCHAR(200))+'-'+@DistCode AS RMCode,
	DlvRouteName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C 
	WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,'') AND A.DlvRouteCode = ISNULL(C.DlvRouteCode,'')) 
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalRouteName)+@RmId) AS RmId,
	'SR0'+CAST((DENSE_RANK ()OVER (ORDER BY SalRouteName)+@RmId) AS NVARCHAR(200))+'-'+@DistCode AS RMCode,SalRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,1 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0   
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,''))
	
	--To Insert the Delivery Route Details
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY DlvRouteName)+@RmId) AS RmId,
	'DR0'+CAST((DENSE_RANK ()OVER (ORDER BY DlvRouteName)+@DlvRmId) AS NVARCHAR(200))+'-'+@DistCode AS RMCode,DlvRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,2 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0   
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(DlvRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.DlvRouteCode = ISNULL(C.DlvRouteCode,''))
	
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	UPDATE Counters SET CurrValue = @RmId WHERE TabName = 'RouteMaster' AND FldName = 'RMId'
	
	--Salesman Market Value Added
	INSERT INTO SalesmanMarket (SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT DISTINCT SMId,RmId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH(NOLOCK) ON A.SalRouteName = B.RMName 
	INNER JOIN Salesman C WITH(NOLOCK) ON A.SalesmanName = C.SMName WHERE B.RMSRouteType = 1 AND NOT EXISTS
	(SELECT SMId,RMId FROM SalesmanMarket D WITH(NOLOCK) WHERE C.SMId = D.SMId AND B.RMId = D.RMId)	
	
	
	--To Insert the Retailer Details
    SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,B.CtgMainId AS CtgLevelId,
    B.CtgCode AS CtgLevelCode,B.CtgName AS CtgLevelName,C.CtgMainId,C.CtgCode,C.CtgName,D.RtrClassId,D.ValueClassCode,D.ValueClassName,
    SalRouteName,DlvRouteName,[Status],RetailerGeoLevel,RetailerGeoCode,RtrPhoneNo,RtrTinNumber,RtrTaxGroupCode,ISNULL(E.RtrUniqueCode,'')  AS RtrUniqueCode
    INTO #RetailerMigrationDetails FROM RetailerCategoryLevel A WITH(NOLOCK) 
    INNER JOIN RetailerCategory B WITH(NOLOCK) ON A.CtgLevelId = B.CtgLevelId
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgMainId = C.CtgLinkId  
    INNER JOIN RetailerValueClass D WITH(NOLOCK) ON C.CtgMainId = D.CtgMainId 
    INNER JOIN Cn2Cs_Prk_RetailerMigration E WITH(NOLOCK) ON B.CtgCode = E.RtrChannelCode AND C.CtgCode = E.RtrGroupCode AND DownLoadFlag = 'D'
    AND D.ValueClassCode = E.RtrClassCode WHERE CmpRtrCode NOT IN (SELECT ISNULL(RetailerCode,'') FROM #ToAvoidRetailerMigration)
	INSERT INTO RetailerMasterMigration (SMName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,RtrCtgLevelId,RtrChannelCode,
	RtrCtgMainId,RtrGroupCode,RtrValClassId,RtrClassCode,RtrGeoLevelId,RtrGeoLvelName,RtrGeoId,RtrGeoName,RtrSalRMId,RtrSalRoute,RtrDlvRMId,RtrDlvRoute,
	RtrStatus,Upload,DownloadedDate,RtrPhoneNo,RtrTinNumber,RtrTaxGroupId,RtrUniqueCode)
	SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,ISNULL(RtrAddress2,0) AS RtrAddress2,ISNULL(RtrAddress3,0) as RtrAddress3,RtrPincode,CtgLevelId,CtgLevelName,
	CtgMainId,CtgName,RtrClassId,ValueClassName,B.GeoLevelId,RetailerGeoLevel,C.GeoMainId,GeoName,D.RmId,SalRouteName,E.RmId,DlvRouteName,
	[Status],0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121),ISNULL(RtrPhoneNo,0) AS RtrPhoneNo,ISNULL(RtrTinNumber,0) AS RtrTinNumber,---------- Null Values validation added in CS Pms id: ICRSTPAR7619
	ISNULL(TaxGroupId,0)AS RtrTaxGroupId,A.RtrUniqueCode
	FROM #RetailerMigrationDetails A (NOLOCK) 
	INNER JOIN GeographyLevel B WITH(NOLOCK) ON A.RetailerGeoLevel = B.GeoLevelName
	INNER JOIN Geography C WITH(NOLOCK) ON A.RetailerGeoCode = C.Geoname AND B.GeoLevelId = C.GeoLevelId
	INNER JOIN RouteMaster D WITH(NOLOCK) ON A.SalRouteName = D.RMName AND D.RMSRouteType = 1
	INNER JOIN RouteMaster E WITH(NOLOCK) ON A.DlvRouteName = E.RMName AND E.RMSRouteType = 2
	LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON A.RtrTaxGroupCode = TGS.RtrGroup AND TGS.TaxGroup = 1
	WHERE CmpRtrCode NOT IN (SELECT DISTINCT CmpRtrCode FROM RetailerMasterMigration (NOLOCK))
			
	UPDATE A SET A.Upload = 1 FROM SalesmanMasterMigration A WITH(NOLOCK) INNER JOIN Salesman B WITH (NOLOCK) ON A.SMName = B.SMName 
	
	UPDATE A SET A.Upload = 1 FROM RouteMasterMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH (NOLOCK) ON A.RMSalName = B.RMName AND B.RMSRouteType = 1
	INNER JOIN RouteMaster C WITH (NOLOCK) ON A.RMDlvName = C.RMName AND C.RMSRouteType = 2
	UPDATE A SET DownloadFlag = 'Y' FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RetailerMasterMigration B WITH(NOLOCK) ON A.CmpRtrCode = B.CmpRtrCode
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_ReturnExcelReportDynamic')
DROP FUNCTION Fn_ReturnExcelReportDynamic
GO
--SELECT dbo.Fn_ReturnExcelReportDynamic(409)
CREATE FUNCTION [dbo].[Fn_ReturnExcelReportDynamic](@RptId	AS INT)
RETURNS INT
AS
/************************************************
* PROCEDURE  : Fn_ReturnExcelReportDynamic
* PURPOSE    : To Validate and Return Dynamic Reports
* CREATED BY : S.Moorthi
* CREATED ON : 09/08/2017
* MODIFICATION
************************************************************************************************
DATE			AUTHOR			CR/BZ		USER STORY ID				DESCRIPTION 
************************************************************************************************     
01/09/2017		Kishore			 CR			CCRSTAML0997				GStr1 Upload Fromat Id Included  
04/12/2017		Murugan.R		 CR			CCRSTMTR0086				New Report id Added 443  
22/01/2018	    Murugan.R	     CR		    CCRSTMTR0113		        New ReportId 432 E way billing  
************************************************************************************************/
BEGIN
DECLARE @ReturnVal AS INT
SET @ReturnVal=0
	
	IF @RptId  in (401 ,402 ,403 ,404 ,405 ,406,407 ,409 ,411,413,414,415,416,417,418,419,420,421,422,423,424,
	425,426,427,428,429,430,431,441,442,443,432)
	BEGIN
		SET @ReturnVal=1
	END
RETURN @ReturnVal
END
GO
DELETE FROM RptGroup WHERE RptId=432
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSTTaxReports 400',432,'GSTEwaybilling','E Way Bill Template',1
GO
DELETE FROM RptHeader WHERE RptId=432
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'GSTEwaybilling','E Way Bill Template',432,'E Way Bill Template','Proc_RptGSTEwayBillTemplate','RptGSTEwayBillTemplate','RptGSTEwayBillTemplate.rpt',0
GO
DELETE FROM RptDetails WHERE RptId=432
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (432,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (432,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (432,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,'',4,1,0,'Press F4/Double Click to select Company',0)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND name='RptGSTEwayBillTemplate')
DROP TABLE RptGSTEwayBillTemplate
GO
CREATE TABLE RptGSTEwayBillTemplate
(
[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
[Supply Type]   Varchar(50),
[Sub Type]   Varchar(50),
[Doc Type]   Varchar(50),
[Doc No]   Varchar(50),
[Doc Date]  DateTime,
[From_OtherPartyName]   Varchar(125),
[From_GSTIN]  Varchar(20),
[From_Address1]  Varchar(100),
[From_Address2]  Varchar(100),
[From_Place]  Varchar(100),
[From_Pin Code]  Varchar(20),
[From_State]  Varchar(100),
[Dispatch_State] [varchar](100) NULL,  ---Mohanakrishna A.B
[To_OtherPartyName]   Varchar(125),
[To_GSTIN]  Varchar(20),
[To_Address1]  Varchar(100),
[To_Address2]  Varchar(100),
[To_Place]  Varchar(100),
[To_Pin Code]  Varchar(20),
[To_State]  Varchar(100),
[ShipTo_State] [varchar](100) NULL,--Mohanakrishna A.B
[Product]  Varchar(50),
[Description]  Varchar(125),
[HSN]  Varchar(20),
[Unit]  Varchar(100),
[Qty]  Numeric(18,4),
[Assessable Value]  Numeric(18,6),
[Tax Rate]  Varchar(50),
[CGST Amount]  Numeric(18,6),
[SGST Amount]  Numeric(18,6),
[IGST Amount]  Numeric(18,6),
[CESS Amount]  Numeric(18,6),
[Trans Mode]  Varchar(50),
[Distance level (Km)]  Numeric(18,2),
[Trans Name]   Varchar(125),
[Trans ID]  Varchar(20),
[Trans DocNo]  Varchar(100),
[Trans Date]  DateTime,
[Vehicle No]  Varchar(50),
[Vehicle Type] [varchar](50) NULL,--Mohanakrishna A.B
[Errors List]  Int,
[UsrId]  Int,
[Group Name] varchar(50),
[GroupType] Tinyint,
[IOTaxType] Varchar(20),
StockType TinyInt
)
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=432
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,432,'E Way Bill Template',1,'Supply Type',20,1,0,1,1,'Supply Type','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',2,'Sub Type',20,1,0,1,1,'Sub Type','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',3,'Doc Type',20,1,0,1,1,'Doc Type','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',4,'Doc No',20,1,0,1,1,'Doc No','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',5,'Doc Date',20,1,0,1,4,'Doc Date','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',6,'From_OtherPartyName',20,1,0,1,1,'From_OtherPartyName','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',7,'From_GSTIN',20,1,0,1,1,'From_GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',8,'From_Address1',20,1,0,1,1,'From_Address1','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',9,'From_Address2',20,1,0,1,1,'From_Address2','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',10,'From_Place',20,1,0,1,1,'From_Place','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',11,'From_Pin Code',20,1,0,1,1,'From_Pin Code','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',12,'From_State',20,1,0,1,1,'From_State','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',13,'Dispatch_State',20,1,0,1,1,'Dispatch_State','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',14,'To_OtherPartyName',20,1,0,1,1,'To_OtherPartyName','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',15,'To_GSTIN',20,1,0,1,1,'To_GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',16,'To_Address1',20,1,0,1,1,'To_Address1','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',17,'To_Address2',20,1,0,1,1,'To_Address2','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',18,'To_Place',20,1,0,1,1,'To_Place','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',19,'To_Pin Code',20,1,0,1,1,'To_Pin Code','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',20,'To_State',20,1,0,1,1,'To_State','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',21,'ShipTo_State',20,1,0,1,1,'ShipTo_State','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',22,'Product',20,1,0,1,1,'Product','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',23,'Description',20,1,0,1,1,'Description','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',24,'HSN',20,1,0,1,1,'HSN','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',25,'Unit',20,1,0,1,1,'Unit','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',26,'Qty',20,1,0,2,3,'Qty','','',4,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',27,'Assessable Value',20,1,0,2,3,'Assessable Value','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',28,'Tax Rate',20,1,0,2,3,'Tax Rate (S+C+I+Cess)','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',29,'CGST Amount',20,1,0,2,3,'CGST Amount','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',30,'SGST Amount',20,1,0,2,3,'SGST Amount','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',31,'IGST Amount',20,1,0,2,3,'IGST Amount','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',32,'CESS Amount',20,1,0,2,3,'CESS Amount','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',33,'Trans Mode',20,1,0,1,1,'Trans Mode','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',34,'Distance level (Km)',20,1,0,2,3,'Distance level (Km)','','',2,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',35,'Trans Name',20,1,0,1,1,'Trans Name','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',36,'Trans ID',20,1,0,1,1,'Trans ID','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',37,'Trans DocNo',20,1,0,1,1,'Trans DocNo','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',38,'Trans Date',20,1,0,1,4,'Trans Date','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',39,'Vehicle No',20,1,0,1,1,'Vehicle No','','',0,GETDATE()
UNION ALL
SELECT 1,432,'E Way Bill Template',40,'Vehicle Type',20,1,0,1,1,'Vehicle Type','','',0,GETDATE()
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_RptGSTEwayBillTemplate')
DROP PROCEDURE Proc_RptGSTEwayBillTemplate
GO
---EXEC Proc_RptGSTEwayBillTemplate 432,1,0,'',0,0,1
--Select * from RptInputOutPutGSTTax where [Product Code]='40017593'
--Select * from Purchasereturn
--Select * from ReturnProductTax order by LastModDate Desc
CREATE PROCEDURE [Proc_RptGSTEwayBillTemplate]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptGSTEwayBillTemplate
* PURPOSE	: To get generate e way tax bill
* CREATED	: Murugan.R
* CREATED DATE	: 19/01/2018--CCRSTMTR0113
* MODIFIED
* DATE       AUTHOR				CR/BZ	USER STORY ID      DESCRIPTION                         
*************************************************
* 
22/01/2018	Murugan.R			CR		CCRSTMTR0113		New ReportId 432 E way billing
28-05-2018	Mohanakrishna A.B	SR		ILCONSPAR0748		Include the Columns in Dispatch State and Ship To State,Vehical Type 
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	--SET @FromDate='2017-08-14'
	--SET @ToDate='2017-08-14'
	--SET @CmpId=0
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptGSTEwayBillTemplate')
	BEGIN
		TRUNCATE TABLE RptGSTEwayBillTemplate
	END
		CREATE TABLE #RptGST_EwayBillTemplate
		(
		[Supply Type]   Varchar(50),
		[Sub Type]   Varchar(50),
		[Doc Type]   Varchar(50),
		[Doc No]   Varchar(50),
		[Doc Date]  DateTime,
		[From_OtherPartyName]   Varchar(125),
		[From_GSTIN]  Varchar(20),
		[From_Address1]  Varchar(100),
		[From_Address2]  Varchar(100),
		[From_Place]  Varchar(100),
		[From_Pin Code]   Numeric(18,0),
		[From_State]  Varchar(100),
		[Dispatch_State] [varchar](100) NULL,  ---Added By Mohanakrishna A.B
		[To_OtherPartyName]   Varchar(125),
		[To_GSTIN]  Varchar(20),
		[To_Address1]  Varchar(100),
		[To_Address2]  Varchar(100),
		[To_Place]  Varchar(100),
		[To_Pin Code]  Varchar(20),
		[To_State]  Varchar(100),
		[ShipTo_State] [varchar](100) NULL,--Added By Mohanakrishna A.B
		RefId	BIGINT,
		RtrId	INT,
		PrdId	INT,
		[Product]  Varchar(50),
		[Description]  Varchar(125),
		[HSN]  Varchar(20),
		[Unit]  Varchar(20),
		[Qty]  BIGINT,
		BaseQty Numeric(18,4),
		[TaxName] [varchar](50) NULL,
		[TaxableAmount] [numeric](38, 6) NULL,
		[IOTaxType] [varchar](100) NULL,
		[TaxFlag] TinyInt NULL,
		[TaxPercent] [numeric](32, 6) NULL,
		[TaxId] [int] NULL,	
		[Trans Mode]  Varchar(50),
		[Distance level (Km)]  Numeric(18,2),
		[Trans Name]   Varchar(125),
		[Trans ID]  Varchar(20),
		[Trans DocNo]  Varchar(100),
		[Trans Date]  DateTime,
		[Vehicle No]  Varchar(50),
		[Vehicle Type] [varchar](50) NULL,--Added By Mohanakrishna A.B
		[Errors List]  TinyInt,
		[UsrId]  Int,
		VehicleId   INT,
		ConversionFactor INT,
		StockType TinyInt
		)


		--SELECT DISTINCT Prdid,Max(ConversionFactor) as ConversionFactor 
		--INTO #ProductConversion
		--FROM UomGroup A INNER JOIN	Product B ON A.UomGroupId=B.UomGroupId
		--GROUP BY Prdid
		
		--SELECT DISTINCT Prdid,C.UomId as UomId,UomCode
		--INTO #ProductUom
		--FROM UomGroup A 
		--INNER JOIN	Product B ON A.UomGroupId=B.UomGroupId
		--INNER JOIN	UomMaster C ON C.UomId=A.UomId
		--WHERE BaseUom='Y' 
		
		
		
		
		---SALES
			---SALES
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType  )
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'' as [Doc Type],SI.SalInvNo as [Doc No], SI.SalInvDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		RtrName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
		ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
		RtrPinNo as [To_Pin Code],'' as [To_State],
		SI.SalId,R.RtrId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		0 as [Qty],		
		SUM(SIP.BaseQty) as BaseQty,
		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST Tax'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST Tax'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST Tax'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS Tax'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'ASales' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],ISNULL(LRNumber,'') as [Trans DocNo],ISNULL(AllotmentDate,Null) as [Trans Date],
		ISNULL(D.VehicleRegNo,'') as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,D.VehicleId as VehicleId,
		Max(Uom1ConvFact) as  ConversionFactor,1 as StockType   
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN VehicleAllocationDetails VHC (NOLOCK) ON VHC.SaleInvNo=SI.SalInvNo
		INNER JOIN VehicleAllocationMaster VHM (Nolock) ON VHM.AllotmentNumber=VHC.AllotmentNumber  
		INNER JOIN Vehicle D (NOLOCK) ON D.VehicleId=VHM.VehicleId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId
		--INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId 
		--INNER JOIN UomMaster U ON U.UomId=SIP.Uom1Id and UG.UomId=U.UomId
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		WHERE 
		--SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts <>3
		VHM.AllotmentDate Between @FromDate and @ToDate and SI.Dlvsts <>3
		AND TaxableAmount>0
		AND  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,PrdName,PrdCCode,TC.TaxCode,ISNULL(R.RtrAdd1,''),
		ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
		RtrPinNo,ISNULL(D.VehicleRegNo,''),ISNULL(LRNumber,''),ISNULL(AllotmentDate,Null),
		D.VehicleId
		
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType  )		
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'' as [Doc Type],SI.SalInvNo as [Doc No], SI.SalInvDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		RtrName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
		ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
		RtrPinNo as [To_Pin Code],'' as [To_State],
		SI.SalId,R.RtrId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],
		--UomCode as [Unit],SUM(SIP.Uom1Qty) as [Qty],		
		'NUMBERS/UNITS' as [Unit],0 as Qty ,SUM(SIP.BaseQty) as BaseQty,		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'ASales' as IOTaxType,1 as TaxFlag,Sum(SPT.TaxAmount) as TaxPercent,SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],ISNULL(LRNumber,'') as [Trans DocNo],ISNULL(AllotmentDate,Null) as [Trans Date],
		ISNULL(D.VehicleRegNo,'') as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId  ,D.VehicleId as VehicleId,
		Max(Uom1ConvFact) as  ConversionFactor,1 as StockType   
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN VehicleAllocationDetails VHC (NOLOCK) ON VHC.SaleInvNo=SI.SalInvNo
		INNER JOIN VehicleAllocationMaster VHM (Nolock) ON VHM.AllotmentNumber=VHC.AllotmentNumber 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN Vehicle D (NOLOCK) ON D.VehicleId=VHM.VehicleId
		--INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId 
		--INNER JOIN UomMaster U ON U.UomId=SIP.Uom1Id and UG.UomId=U.UomId
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId 		  
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		WHERE 
		--SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts <>3
		 VHM.AllotmentDate Between @FromDate and @ToDate and SI.Dlvsts <>3
		AND TaxableAmount>0
		AND  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,PrdName,PrdCCode,TC.TaxCode,ISNULL(R.RtrAdd1,''),
		ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
		RtrPinNo,ISNULL(D.VehicleRegNo,''),ISNULL(LRNumber,''),ISNULL(AllotmentDate,Null),
		D.VehicleId
		
		
		
		--SELECT Salid,SIP.PrdId,Uom1Qty,UomCode 
		--INTO #CsBill
		--FROM SalesInvoiceProduct SIP (NOLOCK)
		--INNER JOIN #RptGST_EwayBillTemplate B ON SIP.SalId=B.Refid 
		--INNER JOIN #ProductUom P ON P.Prdid=SIP.Prdid and SIP.PrdId=B.PrdId 
		--AND P.Prdid=B.Prdid and P.Uomid<>SIP.Uom1Id
		
		
		--UPDATE B SET Qty=A.Uom1Qty	
		--FROM #CsBill A INNER JOIN #RptGST_EwayBillTemplate B
		--ON A.Salid=B.RefId and A.Prdid=B.PrdId
		
				
		--UPDATE #RptGST_EwayBillTemplate SET BaseQty=BaseQty/ConversionFactor where Qty>0
		
				
		--UPDATE #RptGST_EwayBillTemplate SET Unit='Boxes' where Qty>0
		
		--UPDATE #RptGST_EwayBillTemplate SET Unit='NUMBERS/UNITS' where Qty=0
		
		
		---FREE PRODUCT
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType  )
		
		SELECT [Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],SUM(BaseQty) as BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
		FROM(
		
				SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
				'' as [Doc Type],[Doc No],[Doc Date],
				'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
				'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
				RtrName as [To_OtherPartyName],
				'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
				ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
				RtrPinNo as [To_Pin Code],'' as [To_State],
				SI.RefId ,R.RtrId,P.PrdId,
				PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
				0 as [Qty],		
				SUM(SIP.FreeQty) as BaseQty,
				'CGST Tax' as TaxName,
				0.01 as TaxableAmount,'ASales' as IOTaxType,0 as TaxFlag,0.00 as TaxPercent,0 as TaxId,
				'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
				'' as [Trans ID],[Trans DocNo],[Trans Date],
				[Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,VehicleId as VehicleId,
				0 as  ConversionFactor,2 as StockType   
				FROM SalesInvoiceSchemeDtFreePrd SIP		
				INNER JOIN (SELECT DISTINCT VehicleId,RtrId,RefId,[Doc No],[Doc Date],[Trans DocNo],[Trans Date],[Vehicle No]
				FROM #RptGST_EwayBillTemplate  WITH (NOLOCK) WHERE TaxFlag=0) as SI ON SI.RefId = SIP.SalId  
				INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.FreePrdId		
				INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId		
				LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
				WHERE (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
				C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				GROUP BY [Doc No],[Doc Date],P.PrdId,SI.RefId,R.RtrId ,
				RtrName,PrdName,PrdCCode,ISNULL(R.RtrAdd1,''),
				ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
				RtrPinNo,[Trans DocNo],[Trans Date],[Vehicle No],VehicleId
				---Manual Free
				UNION ALL
				SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
				'' as [Doc Type],[Doc No],[Doc Date],
				'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
				'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
				RtrName as [To_OtherPartyName],
				'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
				ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
				RtrPinNo as [To_Pin Code],'' as [To_State],
				SI.RefId ,R.RtrId,P.PrdId,
				PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
				0 as [Qty],		
				SUM(SIP.SalManFreeQty) as BaseQty,
				'CGST Tax' as TaxName,
				0.01 as TaxableAmount,'ASales' as IOTaxType,0 as TaxFlag,0.00 as TaxPercent,0 as TaxId,
				'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
				'' as [Trans ID],[Trans DocNo],[Trans Date],
				[Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,VehicleId as VehicleId,
				0 as  ConversionFactor,2 as StockType   
				FROM SalesInvoiceProduct SIP		
				INNER JOIN (SELECT DISTINCT VehicleId,RtrId,RefId,[Doc No],[Doc Date],[Trans DocNo],[Trans Date],[Vehicle No]
				FROM #RptGST_EwayBillTemplate  WITH (NOLOCK) WHERE TaxFlag=0) as SI ON SI.RefId = SIP.SalId  
				INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.Prdid		
				INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId		
				LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
				WHERE (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
				C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				and SalManFreeQty>0
				GROUP BY [Doc No],[Doc Date],P.PrdId,SI.RefId,R.RtrId ,
				RtrName,PrdName,PrdCCode,ISNULL(R.RtrAdd1,''),
				ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
				RtrPinNo,[Trans DocNo],[Trans Date],[Vehicle No],VehicleId
		) X
		GROUP BY 
		[Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
		
		
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType  )
		
		SELECT [Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],SUM(BaseQty) as BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
		FROM(
				SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
				'' as[Doc Type],[Doc No],[Doc Date],
				'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
				'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
				RtrName as [To_OtherPartyName],
				'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
				ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
				RtrPinNo as [To_Pin Code],'' as [To_State],
				SI.RefId ,R.RtrId,P.PrdId,
				PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
				0 as [Qty],		
				SUM(SIP.FreeQty) as BaseQty,
				'CGST Tax' as TaxName,
				0.01 as TaxableAmount,'ASales' as IOTaxType,1 as TaxFlag,0.00 as TaxPercent,0 as TaxId,
				'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
				'' as [Trans ID],[Trans DocNo],[Trans Date],
				[Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,VehicleId as VehicleId,
				0 as  ConversionFactor, 2 as StockType   
				FROM SalesInvoiceSchemeDtFreePrd SIP		
				INNER JOIN (SELECT DISTINCT VehicleId,RtrId,RefId,[Doc No],[Doc Date],[Trans DocNo],[Trans Date],[Vehicle No]
				FROM #RptGST_EwayBillTemplate  WITH (NOLOCK) WHERE TaxFlag=0) as SI ON SI.RefId = SIP.SalId  
				INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.FreePrdId		
				INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId		
				LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
				WHERE (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
				C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				GROUP BY [Doc No],[Doc Date],P.PrdId,SI.RefId,R.RtrId ,
				RtrName,PrdName,PrdCCode,ISNULL(R.RtrAdd1,''),
				ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
				RtrPinNo,[Trans DocNo],[Trans Date],[Vehicle No],VehicleId
				UNION ALL
				SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
				'' as[Doc Type],[Doc No],[Doc Date],
				'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
				'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
				RtrName as [To_OtherPartyName],
				'' as [To_GSTIN],ISNULL(R.RtrAdd1,'') as [To_Address1],
				ISNULL(RtrAdd2,'') as [To_Address2],ISNULL(RtrAdd3,'') as [To_Place],
				RtrPinNo as [To_Pin Code],'' as [To_State],
				SI.RefId ,R.RtrId,P.PrdId,
				PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
				0 as [Qty],		
				SUM(SIP.SalManFreeQty) as BaseQty,
				'CGST Tax' as TaxName,
				0.01 as TaxableAmount,'ASales' as IOTaxType,1 as TaxFlag,0.00 as TaxPercent,0 as TaxId,
				'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
				'' as [Trans ID],[Trans DocNo],[Trans Date],
				[Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,VehicleId as VehicleId,
				0 as  ConversionFactor, 2 as StockType   
				FROM SalesInvoiceProduct SIP		
				INNER JOIN (SELECT DISTINCT VehicleId,RtrId,RefId,[Doc No],[Doc Date],[Trans DocNo],[Trans Date],[Vehicle No]
				FROM #RptGST_EwayBillTemplate  WITH (NOLOCK) WHERE TaxFlag=0) as SI ON SI.RefId = SIP.SalId  
				INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId		
				INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId		
				LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
				WHERE (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
				C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				and SalManFreeQty>0
				GROUP BY [Doc No],[Doc Date],P.PrdId,SI.RefId,R.RtrId ,
				RtrName,PrdName,PrdCCode,ISNULL(R.RtrAdd1,''),
				ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),
				RtrPinNo,[Trans DocNo],[Trans Date],[Vehicle No],VehicleId
			)X
				GROUP BY
				[Supply Type],[Sub Type],[Doc Type],
				[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
				[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
				[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
				[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],
				[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
				[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
				[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
				
		---TILL HERE FREE PRODUCT
		
		
		
		
		
		--SALES TILL HERE
		
		----IDT OUT
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId ,ConversionFactor,StockType )
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.IDTMngRefNo as [Doc No], SI.IDTMngDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(R.SpmAdd1,'') as [To_Address1],
		ISNULL(SpmAdd2,'') as [To_Address2],ISNULL(SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		0 as SalId,R.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.Qty) as [Qty],		
		SUM(SIP.Qty) as BaseQty,
		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST Tax'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST Tax'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST Tax'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS Tax'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'BIDT' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,0 as VehicleId ,0 as ConversionFactor ,1 as StockType  
		FROM 
		IDTManagement SI WITH (NOLOCK)  
		INNER JOIN IDTManagementProduct SIP WITH (NOLOCK) ON SI.IDTMngRefNo = SIP.IDTMngRefNo  
		INNER JOIN IDTManagementProductTax SPT WITH (NOLOCK) ON SPT.IDTMngRefNo = SIP.IDTMngRefNo AND SPT.IDTMngRefNo = SI.IDTMngRefNo AND SIP.PrdSlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		--INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId and BaseUom='Y'
		--INNER JOIN UomMaster U ON U.UomId=UG.UomId
		INNER JOIN IDTMaster R WITH (NOLOCK) ON R.SpmId = SI.ToSpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		WHERE SI.IDTMngDate Between @FromDate and @ToDate 
		AND TaxableAmount>0 and StkMgmtTypeId=2 and SI.Status=1
		AND  TaxCode  IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess',
		'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','InputGSTCess','InPutCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.IDTMngDate,P.PrdId,SI.IDTMngRefNo,R.SpmId ,
		SPT.TaxId ,SpmName,PrdName,PrdCCode,TC.TaxCode,ISNULL(R.SpmAdd1,''),
		ISNULL(R.SpmAdd2,''),ISNULL(R.SpmAdd3,'')
		
		
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId ,ConversionFactor,StockType )	
		
			SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.IDTMngRefNo as [Doc No], SI.IDTMngDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(R.SpmAdd1,'') as [To_Address1],
		ISNULL(SpmAdd2,'') as [To_Address2],ISNULL(SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		0 as SalId,R.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.Qty) as [Qty],		
		SUM(SIP.Qty) as BaseQty,
		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'BIDT' as IOTaxType,1 as TaxFlag,Sum(SPT.TaxAmount),SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId ,0 as VehicleId ,0 as ConversionFactor ,1 as StockType 
		FROM 
		IDTManagement SI WITH (NOLOCK)  
		INNER JOIN IDTManagementProduct SIP WITH (NOLOCK) ON SI.IDTMngRefNo = SIP.IDTMngRefNo  
		INNER JOIN IDTManagementProductTax SPT WITH (NOLOCK) ON SPT.IDTMngRefNo = SIP.IDTMngRefNo AND SPT.IDTMngRefNo = SI.IDTMngRefNo AND SIP.PrdSlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		--INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId and BaseUom='Y'
		--INNER JOIN UomMaster U ON U.UomId=UG.UomId
		INNER JOIN IDTMaster R WITH (NOLOCK) ON R.SpmId = SI.ToSpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		WHERE SI.IDTMngDate Between @FromDate and @ToDate 
		AND TaxableAmount>0 and StkMgmtTypeId=2 and SI.Status=1
		AND  TaxCode  IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess',
		'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','InputGSTCess','InPutCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.IDTMngDate,P.PrdId,SI.IDTMngRefNo,R.SpmId ,
		SPT.TaxId ,SpmName,PrdName,PrdCCode,TC.TaxCode,ISNULL(R.SpmAdd1,''),
		ISNULL(R.SpmAdd2,''),ISNULL(R.SpmAdd3,'')--,
		--UomCode
	
		---Purchase Return
		--Tax Percentage
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId ,ConversionFactor,StockType )
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.CmpInvNo as [Doc No], SI.PurRetDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(S.SpmAdd1,'') as [To_Address1],
		ISNULL(SpmAdd2,'') as [To_Address2],ISNULL(SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		SI.PurRetId as SalId,S.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.RetSalBaseQty+SIP.RetUnSalBaseQty) as [Qty],		
		SUM(SIP.RetSalBaseQty+SIP.RetUnSalBaseQty) as BaseQty,
		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST Tax'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST Tax'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST Tax'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS Tax'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'CPR' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId  ,0 as VehicleId,0 as ConversionFactor,
		1 as StockType  
		FROM 
		PurchaseReturn SI WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct SIP WITH (NOLOCK) ON SI.PurRetId = SIP.PurRetId  
		INNER JOIN PurchaseReturnProductTax SPT WITH (NOLOCK) ON SPT.PurRetId = SIP.PurRetId AND SPT.PurRetId = SI.PurRetId AND SIP.PrdSlNo=SPT.PrdSlNo  
		--INNER JOIN PurchaseReceipt PR ON PR.PurRcptId=SI.PurRcptId  Mohanakrishna A.B
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId=SI.SpmId	
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  and SI.CmpId=C.CmpId
		WHERE SI.PurRetDate Between @FromDate and @ToDate 
		AND TaxableAmount>0 and Si.Status=1
		AND  TaxCode  IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess',
		'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','InputGSTCess','InPutCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.PurRetDate,P.PrdId,SI.CmpInvNo,S.SpmId ,
		SPT.TaxId ,SpmName,PrdName,PrdCCode,TC.TaxCode,ISNULL(S.SpmAdd1,''),
		ISNULL(S.SpmAdd2,''),ISNULL(S.SpmAdd3,''),SI.PurRetId
		---FREE
		UNION ALL
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.CmpInvNo as [Doc No], SI.PurRetDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(S.SpmAdd1,'') as [To_Address1],
		ISNULL(S.SpmAdd2,'') as [To_Address2],ISNULL(S.SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		SI.PurRetId as SalId,S.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.RetQty) as [Qty],		
		SUM(SIP.RetQty) as BaseQty,	
		'InPutCGST'as TaxName,
		0.01 as TaxableAmount,'CPR' as IOTaxType,0 as TaxFlag,0.00 as TaxPercent,0,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId  ,0 as VehicleId,0 as ConversionFactor,
		2 as StockType  
		FROM 
		PurchaseReturn SI WITH (NOLOCK)  
		INNER JOIN PurchaseReturnClaimScheme SIP WITH (NOLOCK) ON SI.PurRetId = SIP.PurRetId  		
		----INNER JOIN PurchaseReceipt PR ON PR.PurRcptId=SI.PurRcptId Mohanakrishna A.B
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId=SI.SpmId	
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 		 
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  and SI.CmpId=C.CmpId
		WHERE SI.PurRetDate Between @FromDate and @ToDate 
		AND Si.Status=1
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By SI.PurRetDate,P.PrdId,SI.CmpInvNo,S.SpmId ,
		SpmName,PrdName,PrdCCode,ISNULL(S.SpmAdd1,''),
		ISNULL(S.SpmAdd2,''),ISNULL(S.SpmAdd3,''),SI.PurRetId
		
		
	
		--Tax Amount	
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType)	
		
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.CmpInvNo as [Doc No], SI.PurRetDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(S.SpmAdd1,'') as [To_Address1],
		ISNULL(S.SpmAdd2,'') as [To_Address2],ISNULL(S.SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		SI.PurRetId as SalId,S.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.RetSalBaseQty+SIP.RetUnSalBaseQty) as [Qty],		
		SUM(SIP.RetSalBaseQty+SIP.RetUnSalBaseQty) as BaseQty,
		
		CASE WHEN TaxCode IN('InPutIGST','IGST','OutputIGST') THEN 'IGST'
		WHEN TaxCode IN('InPutCGST','CGST','OutputCGST') THEN 'CGST'
		WHEN TaxCode IN('InPutSGST','SGST','OutputSGST','InPutUTGST','UTGST','OutputUTGST') THEN 'SGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','InputGSTCess','InPutCess') THEN 'CESS'		
		END as TaxName,
		SUM(TaxableAmount) as TaxableAmount,'CPR' as IOTaxType,1 as TaxFlag,Sum(SPT.TaxAmount),SPT.TaxId,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,0 as VehicleId ,0 as ConversionFactor,
		1 as StockType 
		FROM 
		PurchaseReturn SI WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct SIP WITH (NOLOCK) ON SI.PurRetId = SIP.PurRetId  
		INNER JOIN PurchaseReturnProductTax SPT WITH (NOLOCK) ON SPT.PurRetId = SIP.PurRetId AND SPT.PurRetId = SI.PurRetId AND SIP.PrdSlNo=SPT.PrdSlNo  
		--INNER JOIN PurchaseReceipt PR ON PR.PurRcptId=SI.PurRcptId Mohanakrishna A.B
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId=SI.SpmId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  and SI.CmpId=C.CmpId
		WHERE SI.PurRetDate Between @FromDate and @ToDate 
		AND TaxableAmount>0  and Si.Status=1
		AND  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST','OutputSGST','SGST','OutputUTGST','UTGST','OutputCess','OutputGSTCess',
		'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','InputGSTCess','InPutCess')
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.PurRetDate,P.PrdId,SI.CmpInvNo,S.SpmId ,
		SPT.TaxId ,SpmName,PrdName,PrdCCode,TC.TaxCode,ISNULL(S.SpmAdd1,''),
		ISNULL(S.SpmAdd2,''),ISNULL(S.SpmAdd3,''),
		SI.PurRetId
		UNION ALL
		SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
		'Tax Invoice' as [Doc Type],SI.CmpInvNo as [Doc No], SI.PurRetDate as [Doc Date],
		'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
		SpmName as [To_OtherPartyName],
		'' as [To_GSTIN],ISNULL(S.SpmAdd1,'') as [To_Address1],
		ISNULL(S.SpmAdd2,'') as [To_Address2],ISNULL(S.SpmAdd3,'') as [To_Place],
		0 as [To_Pin Code],'' as [To_State],
		SI.PurRetId as SalId,S.SpmId,P.PrdId,
		PrdCCode as  [Product], PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
		SUM(SIP.RetQty) as [Qty],		
		SUM(SIP.RetQty) as BaseQty,	
		'InPutCGST'as TaxName,
		0.01 as TaxableAmount,'CPR' as IOTaxType,1 as TaxFlag,0.00 as TaxPercent,0,
		'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
		'' as [Trans ID],'' as [Trans DocNo],CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121) as [Trans Date],
		'' as [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId  ,0 as VehicleId,0 as ConversionFactor,
		2 as StockType  
		FROM 
		PurchaseReturn SI WITH (NOLOCK)  
		INNER JOIN PurchaseReturnClaimScheme SIP WITH (NOLOCK) ON SI.PurRetId = SIP.PurRetId  		
		--INNER JOIN PurchaseReceipt PR ON PR.PurRcptId=SI.PurRcptId Mohanakrishna A.B
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId=SI.SpmId		 
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  and SI.CmpId=C.CmpId
		WHERE SI.PurRetDate Between @FromDate and @ToDate 
		AND Si.Status=1
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By SI.PurRetDate,P.PrdId,SI.CmpInvNo,S.SpmId ,
		SpmName,PrdName,PrdCCode,ISNULL(S.SpmAdd1,''),
		ISNULL(S.SpmAdd2,''),ISNULL(S.SpmAdd3,''),SI.PurRetId
		
		--Salvage    Mohanakrishna A.B
		
		INSERT INTO #RptGST_EwayBillTemplate([Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],VehicleId,ConversionFactor,StockType  )
		
		SELECT [Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],SUM(BaseQty) as BaseQty,
		[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
		FROM(
		
				SELECT 'Outward' as [Supply Type],'Supply' as [Sub Type],
				'Tax Invoice' as[Doc Type],SIP.SalvageRefNo AS [Doc No], S.SalvageDate AS [Doc Date],
				'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
				'' as [From_Address2],'' as [From_Place],0 as [From_Pin Code],'' as [From_State],
				'' as [To_OtherPartyName],
				'' as [To_GSTIN],'' as [To_Address1],
				'' as [To_Address2],'' as [To_Place],
				'' as [To_Pin Code],'' as [To_State],
				'' AS RefId ,'' as RtrId,P.PrdId,
				P.PrdCCode as  [Product], P.PrdName as [Description],'' as [HSN],'NUMBERS/UNITS' as [Unit],
				0 as [Qty],		
				SUM(SIP.SalvageQty) as BaseQty,
				'CGST Tax' as TaxName,
				0.01 as TaxableAmount,'DSalv' as IOTaxType,1 as TaxFlag,0.00 as TaxPercent,0 as TaxId,
				'Road' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],
				'' as [Trans ID],'' AS [Trans DocNo],'' AS [Trans Date],
				'' AS [Vehicle No],0 as [Errors List],@Pi_UsrId AS UserId,'' as VehicleId,
				0 as  ConversionFactor, 2 as StockType   
				FROM SalvageProduct SIP	
				INNER JOIN Salvage S ON S.SalvageRefNo=SIP.SalvageRefNo	
				--INNER JOIN (SELECT DISTINCT VehicleId,RtrId,RefId,[Doc No],[Doc Date],[Trans DocNo],[Trans Date],[Vehicle No]
				--FROM #RptGST_EwayBillTemplate  WITH (NOLOCK) WHERE TaxFlag=0) as SI ON SI.RefId = SIP.SalId  
				INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId		
				--INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId		
				LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
				WHERE S.SalvageDate Between @FromDate and @ToDate  AND S.Status=1 and
				(C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
				C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				GROUP BY SIP.SalvageRefNo,S.SalvageDate,P.PrdId,
				--R.RtrId ,RtrName,
				P.PrdName,P.PrdCCode
				--,ISNULL(R.RtrAdd1,''),	ISNULL(R.RtrAdd2,''),ISNULL(R.RtrAdd3,''),RtrPinNo
			)X
				GROUP BY
				[Supply Type],[Sub Type],[Doc Type],
				[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
				[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
				[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
				[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],
				[TaxName],[TaxableAmount],[IOTaxType],[TaxFlag],[TaxPercent],[TaxId],
				[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
				[Trans Date],[Vehicle No],[Errors List],UserId,VehicleId,ConversionFactor,StockType
		

		---Till here  Salvage
		
		
		
		
		---------------UDC Column Update----
		
		
		SELECT DISTINCT ISNULL(ColumnValue,'') as GSTIN,VehicleId
		INTO #VehicleGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Vehicle R ON R.VehicleId=UT.MasterRecordId		
		WHERE U.MasterId=13 and ColumnName='GSTIN'
		
		SELECT DISTINCT ISNULL(ColumnValue,'') as Vehiclename,VehicleId
		INTO #VehicleName
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Vehicle R ON R.VehicleId=UT.MasterRecordId
		WHERE U.MasterId=13 and ColumnName='Vehicle Name'
		
	
		---DISTRIBUTOR State
		
		SELECT DISTINCT StateName as StateName
		INTO #DistState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		
		---DISTRIBUTOR GSTIN
		SELECT DISTINCT  UT.ColumnValue,DistributorCode,DistributorName,DistributorAdd1,DistributorAdd2,DistributorAdd3,PinCode
		INTO #DistGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		---Company State
		SELECT DISTINCT StateName as StateName,CmpId
		INTO #CmpState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Company R ON R.CmpId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=7 and ColumnName='State Name'
		
		SELECT DISTINCT  UT.ColumnValue,CmpId,R.CmpName,R.Address1,R.Address2,R.Address3 -- Mohanakrishna A.B
		INTO #CmpGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Company R ON R.CmpId=UT.MasterRecordId
		WHERE U.MasterId=7 and ColumnName='GSTIN'
		
		SELECT DISTINCT  UT.ColumnValue,CmpId
		INTO #CmpPincode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Company R ON R.CmpId=UT.MasterRecordId
		WHERE U.MasterId=7 and ColumnName='Pincode'

		
		
		---Supplier State
		SELECT DISTINCT  R.SpmId as RtrId,StateName as StateName
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		---IDT Distributor State
		SELECT DISTINCT  R.SpmId as RtrId,StateName as StateName
		INTO #IDTSupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		SELECT DISTINCT  R.SpmId as RtrId,ISNULL(UT.ColumnValue,0) as ColumnValue
		INTO #IDTKm
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId		
		WHERE U.MasterId=8 and ColumnName='Distance level Km'
		
			
		SELECT DISTINCT  R.SpmId as RtrId,UT.ColumnValue
		INTO #IDTSupplierPin
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId		
		WHERE U.MasterId=8 and ColumnName='Pincode'		
		
		---Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
				
		---IDT Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
		---Retailer GSTIN
		
		Select DISTINCT RP.RtrId INTO #URP FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN #RptGST_EwayBillTemplate RP ON RP.RtrId=R.RtrId and RP.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ISNULL(ColumnValue,'') in (
		'UNREGISTERED','UN REGISTERED','','NULL')
		
		
		UPDATE RP Set RP.[To_GSTIN]=ISNULL(ColumnValue,'')
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN #RptGST_EwayBillTemplate RP ON RP.RtrId=R.RtrId and RP.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN' and IOTaxType IN('ASales')
		
		UPDATE A SET A.To_GSTIN = 'URP' FROM  #RptGST_EwayBillTemplate A INNER JOIN #URP B ON A.RtrId = B.RtrId
		WHERE IOTaxType='ASales'
		
		---Retailer State
		UPDATE RP Set RP.[To_State]=ISNULL(S.StateName,'')		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN #RptGST_EwayBillTemplate RP ON RP.RtrId=R.RtrId and RP.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name' and IOTaxType IN('ASales')
		
		--Retailer Km
		UPDATE RP Set RP.[Distance level (Km)]=ISNULL(ColumnValue,0)	
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId	
		INNER JOIN #RptGST_EwayBillTemplate RP ON RP.RtrId=R.RtrId and RP.RtrId=UT.MasterRecordId	
		WHERE U.MasterId=2 and ColumnName='Distance level Km'  and IOTaxType IN('ASales')
	
	
	
		
		
		UPDATE TR SET  [HSN]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #RptGST_EwayBillTemplate TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		

		
		
		UPDATE B Set B.[To_State]=ISNULL(A.StateName,'') FROM #IDTSupplierState A INNER JOIN #RptGST_EwayBillTemplate B ON A.Rtrid=B.RtrId
		WHERE B.IOTaxType='BIDT'		

		
		UPDATE R Set R.[To_GSTIN]=ISNULL(ColumnValue,'') 
		FROM #RptGST_EwayBillTemplate R INNER JOIN #IDTSupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[To_GSTIN],''))=0 and  R.IOTaxType='BIDT'
		
		
			
		UPDATE R Set R.[To_Pin Code]=ISNULL(ColumnValue,'') 
		FROM #RptGST_EwayBillTemplate R INNER JOIN #IDTSupplierPin RS ON RS.RtrId=R.RtrId
		WHERE  R.IOTaxType='BIDT'
		
		
		SELECT DISTINCT  UT.ColumnValue,SpmId as RtrId
		INTO #SupplierPincode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='Pincode'


		UPDATE B Set B.[To_State]=ISNULL(A.StateName,'') FROM #SupplierState A INNER JOIN #RptGST_EwayBillTemplate B ON A.RtrId=B.RtrId
		WHERE B.IOTaxType='CPR'		


		UPDATE R Set R.[To_GSTIN]=ISNULL(ColumnValue,'') 
		FROM #RptGST_EwayBillTemplate R INNER JOIN #SupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[To_GSTIN],''))=0 and  R.IOTaxType='CPR'

		UPDATE R Set R.[To_Pin Code]=ISNULL(ColumnValue,'') 
		FROM #RptGST_EwayBillTemplate R INNER JOIN #SupplierPincode RS ON RS.RtrId=R.RtrId
		WHERE  R.IOTaxType='CPR'
		
		----  Mohanakrishna A.B
		
		UPDATE B Set B.[From_State]=ISNULL(A.StateName,'') FROM #DistState A , #RptGST_EwayBillTemplate B 	WHERE  B.IOTaxType='DSalv'		
		
		UPDATE R Set R.[From_GSTIN]=ISNULL(ColumnValue,''),		
		[From_OtherPartyName]=DistributorName,[From_Address1]=DistributorAdd1,[From_Address2]=DistributorAdd2 ,From_Place=DistributorAdd3,
		[From_Pin Code]=PinCode
		FROM #RptGST_EwayBillTemplate R , #DistGSTIN RS 
		WHERE  R.IOTaxType='DSalv'
		
		

		
		UPDATE B Set B.[TO_State]=ISNULL(A.StateName,'') FROM #CmpState A , #RptGST_EwayBillTemplate B 	WHERE  B.IOTaxType='DSalv'		
		
		UPDATE R Set R.[TO_GSTIN]=ISNULL(ColumnValue,''),		
		[TO_OtherPartyName]=CmpName,[TO_Address1]=Address1,[TO_Address2]=Address2 ,TO_Place=Address3		
		FROM #RptGST_EwayBillTemplate R , #CmpGSTIN RS 
		WHERE  R.IOTaxType='DSalv'
		
		
		UPDATE B Set B.[TO_Pin Code]=ISNULL(A.ColumnValue,'') FROM #CmpPincode A , #RptGST_EwayBillTemplate B 	WHERE  B.IOTaxType='DSalv'		
			----
		UPDATE B Set B.[From_State]=ISNULL(A.StateName,'') FROM #DistState A , #RptGST_EwayBillTemplate B 			

		
		UPDATE R Set R.[From_GSTIN]=ISNULL(ColumnValue,''),		
		[From_OtherPartyName]=DistributorName,[From_Address1]=DistributorAdd1,[From_Address2]=DistributorAdd2 ,From_Place=DistributorAdd3,
		[From_Pin Code]=PinCode
		FROM #RptGST_EwayBillTemplate R , #DistGSTIN RS 
		
		
		
		
		 --UPDATE C SET C.[Vehicle No]= ISNULL(D.VehicleRegNo,'') ,[Trans Date]=AllotmentDate,[Trans DocNo]=ISNULL(LRNumber,''),
		 --C.VehicleId=A.VehicleId
		 --FROM VehicleAllocationMaster A (NOLOCK)
		 --INNER JOIN VehicleAllocationDetails B (NOLOCK) ON A.AllotmentNumber=B.AllotmentNumber
		 --INNER JOIN #RptGST_EwayBillTemplate C (NOLOCK) ON C.[Doc No]=B.SaleInvNo
		 --LEFT OUTER JOIN Vehicle D(NOLOCK) ON D.VehicleId=A.VehicleId
		 --WHERE [IOTaxType] ='ASales'
		 
		 
		UPDATE B Set B.[Trans Name]=ISNULL(A.Vehiclename,'') FROM #VehicleName A 
		INNER JOIN #RptGST_EwayBillTemplate B ON A.VehicleId=B.VehicleId
		WHERE B.IOTaxType IN('ASales')


		UPDATE R Set R.[Trans Id]=ISNULL(GSTIN,'') FROM #RptGST_EwayBillTemplate R 
		INNER JOIN #VehicleGSTIN RS ON RS.VehicleId=R.VehicleId
		WHERE  R.IOTaxType IN('ASales')
		

		--IDT SUpplier KM
		UPDATE R Set  R.[Distance level (Km)]=ISNULL(RS.ColumnValue,0) FROM #RptGST_EwayBillTemplate R 
		INNER JOIN #IDTKm RS ON RS.RtrId=R.RtrId
		WHERE  R.IOTaxType='BIDT'	
		
		SELECT DISTINCT  R.SpmId as RtrId,ISNULL(UT.ColumnValue,0) as ColumnValue
		INTO #SupplierKm
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId		
		WHERE U.MasterId=8 and ColumnName='Distance level Km'
		
		--SUpplier KM
		UPDATE R Set  R.[Distance level (Km)]=ISNULL(RS.ColumnValue,0) FROM #RptGST_EwayBillTemplate R 
		INNER JOIN #SupplierKm RS ON RS.RtrId=R.RtrId
		WHERE  R.IOTaxType='CPR'
	
			
		IF NOT EXISTS(SELECT 'X' FROM #RptGST_EwayBillTemplate)
		BEGIN		
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptGST_EwayBillTemplate
			WHERE UsrId=@Pi_UsrId
			SELECT 'X' FROM RptGSTEwayBillTemplate WHERE UsrId=@Pi_UsrId			
			RETURN
		END
		
		
		INSERT INTO RptGSTEwayBillTemplate
		([Supply Type],[Sub Type],[Doc Type],[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],
		[From_Address1],[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],[To_GSTIN],
		[To_Address1],[To_Address2],[To_Place],[To_Pin Code],[To_State],[Product],[Description],[HSN],
		[Unit],[Qty],[Assessable Value],[Tax Rate],[CGST Amount],[SGST Amount],[IGST Amount],[CESS Amount],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],[Trans Date],[Vehicle No],[Errors List],
		[UsrId],[IOTaxType],[Group Name],[GroupType],StockType)
		 SELECT [Supply Type],[Sub Type],[Doc Type],
		[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
		[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
		[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
		[To_State],[Product],[Description],[HSN],[Unit],[BaseQty],[TaxableAmount],
		CAST(CAST(ISNULL([CGST Tax],0) as Numeric(18,2)) as Varchar(10))+'+'+
		CAST(CAST(ISNULL([SGST Tax],0) as Numeric(18,2)) as Varchar(10))+'+'+
		CAST(CAST(ISNULL([IGST Tax],0) as Numeric(18,2)) as Varchar(10))+'+'+
		CAST(CAST(ISNULL([CESS Tax],0) as Numeric(18,2)) AS VARCHAR(10))
		AS [Tax Rate],
		ISNULL([CGST],0) as CGST ,ISNULL([SGST],0) as SGST,ISNULL([IGST],0) as IGST,ISNULL([CESS],0) as [CESS],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
		[Trans Date],[Vehicle No],[Errors List],[UsrId],
		[IOTaxType],'' as [Group Name],2 as [GroupType],StockType
		FROM(
				 SELECT [Supply Type],[Sub Type],[Doc Type],
				[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],[From_Address1],
				[From_Address2],[From_Place],[From_Pin Code],[From_State],[To_OtherPartyName],
				[To_GSTIN],[To_Address1],[To_Address2],[To_Place],[To_Pin Code],
				[To_State],RefId,RtrId,Prdid,[Product],[Description],[HSN],[Unit],[Qty],BaseQty,
				[TaxName],[TaxableAmount],[IOTaxType],[TaxPercent],
				[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],
				[Trans Date],[Vehicle No],[Errors List],[UsrId],StockType
				 FROM #RptGST_EwayBillTemplate	
		 ) PS PIVOT( 
					 SUM(TaxPercent) 
					 FOR Taxname IN([IGST],[CGST],[SGST],[CESS],[IGST Tax],[CGST Tax],[SGST Tax],[CESS Tax]))PVTTax  
		 ORDER BY IOTaxType,[Doc Date],[Doc No],StockType,[To_OtherPartyName],[Description]
		 --Grand Total
		 INSERT INTO RptGSTEwayBillTemplate
		([Supply Type],[Sub Type],[Doc Type],[Doc No],[Doc Date],[From_OtherPartyName],[From_GSTIN],
		[From_Address1],[From_Address2],[From_Place],[From_Pin Code],[From_State],[Dispatch_State],[To_OtherPartyName],[To_GSTIN],
		[To_Address1],[To_Address2],[To_Place],[To_Pin Code],[To_State],[ShipTo_State],[Product],[Description],[HSN],
		[Unit],[Qty],[Assessable Value],[Tax Rate],[CGST Amount],[SGST Amount],[IGST Amount],[CESS Amount],
		[Trans Mode],[Distance level (Km)],[Trans Name],[Trans ID],[Trans DocNo],[Trans Date],[Vehicle No],[Vehicle Type],[Errors List],
		[UsrId],[IOTaxType],[Group Name],[GroupType],StockType)		
		 SELECT '' as [Supply Type],'' as [Sub Type],'' as [Doc Type],
		'' as [Doc No],Null as [Doc Date],'' as [From_OtherPartyName],'' as [From_GSTIN],'' as [From_Address1],
		'' as [From_Address2],'' as [From_Place],'' as [From_Pin Code],'' as [From_State],'' as [Dispatch_State],'' as [To_OtherPartyName],
		'' as [To_GSTIN],'' as [To_Address1],'' as [To_Address2],'' as [To_Place],'' as [To_Pin Code],
		'' as [To_State],'' as [ShipTo_State],'' as [Product],'' as [Description],'' as [HSN],'' as [Unit],ISNULL(SUM([Qty]),0) as [Qty],SUM([Assessable Value]),
		'' as  [Tax Rate],
		ISNULL(SUM([CGST Amount]),0) as CGST ,ISNULL(SUM([SGST Amount]),0) as SGST,ISNULL(SUM([IGST Amount]),0) as IGST,ISNULL(SUM([CESS Amount]),0) as [CESS],
		'' as [Trans Mode],0 as [Distance level (Km)],'' as [Trans Name],'' as [Trans ID],'' as [Trans DocNo],
		Null as [Trans Date],'' as [Vehicle No],'' As [Vehicle Type],0 as [Errors List],@Pi_UsrId as [UsrId],
		'' as [IOTaxType],'ZZZZZZ' as [Group Name],3 as [GroupType],0 as StockType
		FROM RptGSTEwayBillTemplate WHERE UsrId=@Pi_UsrId
		 
		 SELECT StockType,[Doc No],[IOTaxType],SUM([CGST Amount]+[SGST Amount]+[IGST Amount]+[CESS Amount]) as TaxAmount
		 INTO #SalesType
		 FROM RptGSTEwayBillTemplate (NOLOCK) WHERE UsrId=@Pi_UsrId
		 GROUP BY [Doc No],[IOTaxType],StockType
		 
		 UPDATE  A SET [Doc Type]= CASE WHEN TaxAmount<=0 THEN 'Bill of Supply' ELSE 'Tax Invoice' END 
		 FROM RptGSTEwayBillTemplate A INNER JOIN #SalesType B ON A.[Doc No]=B.[Doc No]
		 AND A.[IOTaxType]=B.[IOTaxType] AND A.StockType=B.StockType 
		 WHERE  A.[IOTaxType]='ASales' AND A.StockType<>2
		 
		 SELECT DISTINCT [Doc Type],[Doc No],UsrId INTO #Tdoc 
		 FROM RptGSTEwayBillTemplate WHERE [IOTaxType]='ASales' 
		 and StockType=1 and  UsrId=@Pi_UsrId
		 
		 UPDATE  B SET B.[Doc Type]= A.[Doc Type]
		 FROM #Tdoc  A INNER JOIN RptGSTEwayBillTemplate B ON A.[Doc No]=B.[Doc No] AND A.UsrId=B.UsrId
		 WHERE B.[IOTaxType]='ASales'  and StockType=2 AND A.UsrId=@Pi_UsrId
		  ---Mohanakrishna A.B
		 UPDATE A SET A.[Dispatch_State]=A.[From_State],A.[ShipTo_State]=A.[To_State],A.[Vehicle Type]='',HSN=Replace(HSN,' ','') FROM  RptGSTEwayBillTemplate A (Nolock) Where UsrId=@Pi_UsrId
		 --
		  
		  ---Remove Special Character
		UPDATE RptGSTEwayBillTemplate SET 
		[From_OtherPartyName]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_OtherPartyName]),
		[From_Address1]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_Address1]),
		[From_Address2]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_Address2]),
		[From_Place]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_Place]),
		[From_Pin Code]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_Pin Code]),
		[From_State]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([From_State]),
		[Dispatch_State]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([Dispatch_State]),---Added By Mohanakrishna A.B
		[To_OtherPartyName] =dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_OtherPartyName]),
		[To_Address1] =dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_Address1]),
		[To_Address2] =dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_Address2]),
		[To_Place]  =dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_Place]),
		[To_Pin Code]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_Pin Code]),
		[To_State]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([To_State]),
		[ShipTo_State]=dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([ShipTo_State]),--Added By Mohanakrishna A.B
		[Description] =dbo.[FN_REMOVE_SPECIAL_CHARACTEREwayBill] ([Description])
		WHERE  UsrId=@Pi_UsrId
		 
		DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptGSTEwayBillTemplate
		WHERE UsrId=@Pi_UsrId

		SELECT * FROM RptGSTEwayBillTemplate WHERE UsrId=@Pi_UsrId
		ORDER BY SLNO
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_TransactionWiseGrnTracking]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_TransactionWiseGrnTracking]
GO
--EXEC Proc_Cs2Cn_TransactionWiseGrnTracking 0,'2017-01-14'
CREATE PROCEDURE [dbo].[Proc_Cs2Cn_TransactionWiseGrnTracking]
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_TransactionWiseGrnTracking
* PURPOSE		: To Extract Bill Wise GRN refernce from CoreStocky to   Console
* CREATED BY	: Raja C
* CREATED DATE	: 05-06-2017
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}	
***************************************************************************************************
* DATE          AUTHOR      CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
* 21-09-2018   Lakshman M	 SR     ILCRSTPAR2151         GRN Tracking uplaod process enabled date On (21-09-2018) as per client request.
***************************************************************************************************/ 

SET NOCOUNT ON
BEGIN	
    SET @Po_ErrNo= 0
    -- RETURN -- > Commented By Lakshman M For GRN tracking  process enabled 
	DECLARE @DistCode	As nVarchar(50)
	SELECT @DistCode = DistributorCode FROM Distributor	(NOLOCK)	

	
	UPDATE A SET GSPUpload1 = 1 FROM TransactionWiseGrnTracking A WHERE Refdate  <'2018-09-21' ---> Add By Lakshman M PMS ID: ILCRSTPAR2151 Dated ON 21/09/2018 
	
	DELETE FROM Cs2Cn_Prk_TransactionWiseGrnTracking WHERE UploadFlag='Y'
	
	INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate)
	SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate
	FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' ---> Add By Lakshman M PMS ID: ILCRSTPAR2151 Dated ON 21/09/2018 
	
	UPDATE A SET A.CmpInvNo=B.CmpInvNo From Cs2Cn_Prk_TransactionWiseGrnTracking A (Nolock) Inner Join PurchaseReceipt B (Nolock)On A.PurRcptRefNo=B.PurRcptRefNo ---Added By Mohanakrishna A.B
	
	UPDATE  A  SET GSPUpload1 = 1 FROM TransactionWiseGrnTracking A WHERE EXISTS (SELECT * FROM Cs2Cn_Prk_TransactionWiseGrnTracking B(NOLOCK)
	WHERE A.RefId=B.RefId AND A.RefNo=B.RefNo )
		
END
GO
IF EXISTS(SELECT * FROM SYS.objects WHERE NAME='Proc_Cs2Cn_SalesTaxuploadGST' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_SalesTaxuploadGST
GO
--EXEC Proc_Cs2Cn_SalesTaxuploadGST 0,'2017-05-27'
CREATE PROCEDURE Proc_Cs2Cn_SalesTaxuploadGST
(
   @Po_ErrNo INT OUTPUT,
   @ServerDate DATETIME
)
AS
/*****************************************************************************
* PROCEDURE		: Proc_Cs2Cn_SalesTaxuploadGST
* PURPOSE		: To Extract GST Sales tax from CoreStocky to upload to Console
* CREATED BY	: Raja C
* CREATED DATE	: 19/05/2017
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
********************************************************************************/
SET NOCOUNT ON
BEGIN
	
	DECLARE @DistCode		As nVarchar(50)
	DELETE FROM Cs2Cn_SalesTaxuploadGST WHERE UploadFlag = 'Y'
	SET @Po_ErrNo=0
	RETURN
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)
	
	CREATE TABLE  #Cs2Cn_SalesTaxuploadGST
(    
     [InvoiceNumber]   NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     [Invoice Date]    DATETIME,
     OrderNumber       NVARCHAR(100)  COLLATE DATABASE_DEFAULT,
     Orderdate         DATETIME,
     DocRefNo          NVARCHAR(100)  COLLATE DATABASE_DEFAULT, 
     [Retailer Code]   VARCHAR(75), 
     [Retailer Company Code] NVARCHAR(50)  COLLATE DATABASE_DEFAULT,
     [Retailer GSTTIN]  NVARCHAR(100)  COLLATE DATABASE_DEFAULT,
     [Retailer State]  VARCHAR(150), 
     [RetailerStateCode] Varchar(20),
     [Retailer Type]   VARCHAR(150),
     [Retailer PanNo]  NVARCHAR(100)  COLLATE DATABASE_DEFAULT, 
     HSNCode           VARCHAR(75), 
     [Product Company Code]  NVARCHAR(100)  COLLATE DATABASE_DEFAULT,
     [Product Batch]   NVARCHAR(100)  COLLATE DATABASE_DEFAULT,
     Qty               INT NULL,
     MRP               NUMERIC(18,6),
     SellingRate       NUMERIC(18,6),
     TaxCode           NVARCHAR(40) COLLATE DATABASE_DEFAULT, 
     TaxName           NVARCHAR(100) COLLATE DATABASE_DEFAULT, 
     GrossAmount       NUMERIC(38,6)NULL, 
     TaxableAmount     NUMERIC(38,6) NULL,
     TaxPercentage     NUMERIC(18,6) NULL,
     TaxAmount         NUMERIC(38,6) NULL,
     NetAmount         NUMERIC(38,6) NULL ,
     RtrShipId INT   
)
	
	
	INSERT INTO #Cs2Cn_SalesTaxuploadGST
	(
	[InvoiceNumber],
	[Invoice Date],
	[OrderNumber],
	[Orderdate],
	[DocRefNo],
	[Retailer Code],
	[Retailer Company Code],
	[Retailer GSTTIN],
	[RetailerStateCode],
	[Retailer State],	
	[Retailer Type],
	[Retailer PanNo],
	HSNCode,
	[Product Company Code],
	[Product Batch],
	Qty,
	MRP,
	SellingRate,
	TaxCode,
	TaxName,
	GrossAmount,
	TaxableAmount,
	TaxPercentage,
	TaxAmount,
	NetAmount,
	RtrShipId
	)
	SELECT SI.SalInvNo,SI.SalInvDate,isnull(SI.OrderKeyNo,'') as OrderKeyNo,isnull(SI.OrderDate,'') as OrderDate,SalInvRef AS DocRefNo,R.RtrCode,R.CmpRtrCode,'' AS RetailerGSTTin,'' as [RetailerStateCode],'' AS RetailerState,
	'' AS RetailerType,'' AS RetailerPanno,'' AS HSNCode,P.PrdCCode,PB.PrdBatCode,SUM(SIP.BaseQty) AS Qty,SIP.PrdUnitMRP AS MRP,SIP.PrdUnitSelRate AS SellingRate ,
	TC.TaxCode,TC.TaxName,SUM(PrdGrossAmount)AS GrossAmount,SUM(TaxableAmount) AS TaxableAmount,TaxPerc,SUM(TaxAmount) AS TaxAmount,SUM(PrdNetAmount) AS NetAmount,SI.RtrShipId
	FROM SalesInvoice SI WITH (NOLOCK)  
	INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
	INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
	INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId    
	INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
	INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId
	INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
	LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
	WHERE  SI.VatGst='GST' AND GstUpload1 = 0 
	Group By SI.SalInvNo,SI.SalInvDate,SI.OrderKeyNo,SI.OrderDate,R.RtrCode,R.CmpRtrCode,P.PrdCCode,PB.PrdBatCode,SIP.PrdUnitMRP,SIP.PrdUnitSelRate,
	TC.TaxCode,TC.TaxName,TaxPerc,SI.RtrShipId,SalInvRef
	HAVING Sum(TaxableAmount) >0 
	
	SELECT DISTINCT ColumnValue as HSNCODE,E.PrdCCode
	INTO #HSNCode
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId
	INNER JOIN Product E (NOLOCK) ON E.Prdid=C.MasterRecordId
	WHERE MasterName='Product Master' and ColumnName='HSN Code'
	
	UPDATE A  SET A.[Retailer State]=C.StateName, 
	A.[Retailer GSTTIN]=B.GSTTinNo ,A.[RetailerStateCode]=StateCode
	FROM #Cs2Cn_SalesTaxuploadGST A 
	INNER JOIN Retailer R WITH (NOLOCK)  ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  RetailerShipAdd  B  WITH (NOLOCK)  ON R.RtrId=B.RtrID and A.RtrShipId=B.RtrShipId
	INNER JOIN  StateMaster C WITH (NOLOCK)  ON C.StateId=B.StateId
	SELECT MasterRecordId,ColumnValue  AS RetailerPANNo INTO #RetailerPANNo
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId	
	WHERE MasterName='Retailer Master' AND ColumnName='PAN Number'
	
	SELECT DISTINCT MasterRecordId,ColumnValue  AS RetailerType INTO #RetailerType
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId
	INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
	and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
	WHERE MasterName='Retailer Master' AND ColumnName='Retailer Type'
	
	UPDATE A  SET A.[Retailer PanNo]=B.RetailerPANNo FROM #Cs2Cn_SalesTaxuploadGST A INNER JOIN Retailer R ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  #RetailerPANNo  B  ON R.RtrId=B.MasterRecordId
	
    UPDATE A  SET A.[Retailer Type]=B.RetailerType FROM #Cs2Cn_SalesTaxuploadGST A INNER JOIN Retailer R ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  #RetailerType  B  ON R.RtrId=B.MasterRecordId
	
	 UPDATE A  SET A.HSNCode=R.HSNCode FROM #Cs2Cn_SalesTaxuploadGST A INNER JOIN #HSNCode R ON A.[Product Company Code]=R.PrdCCode
    INSERT INTO Cs2Cn_SalesTaxuploadGST
	(        
	        [DistCode],
			[InvoiceNumber],
			[InvoiceDate],
			[OrderNumber],
			[Orderdate],
			[DocRefNo],
			[RetailerCode],
			[RetailerCompanyCode],
			[RetailerGSTTIN],
			[RetailerStateCode],
			[RetailerState],
			[RetailerType],
			[RetailerPanNo],
			HSNCode,
			[ProductCompanyCode],
			[ProductBatch],
			Qty,
			MRP,
			SellingRate,
			TaxCode,
			TaxName,
			GrossAmount,
			TaxableAmount,
			TaxPercentage,
			TaxAmount,
			NetAmount,
			UploadFlag,
			ServerDate
	)
	SELECT  @DistCode,
	        [InvoiceNumber],
			[Invoice Date],
			[OrderNumber],
			[Orderdate],
			[DocRefNo],
			[Retailer Code],
			[Retailer Company Code],
			[Retailer GSTTIN],
			[RetailerStateCode],
			[Retailer State],
			[Retailer Type],
			[Retailer PanNo],
			HSNCode,
			[Product Company Code],
			[Product Batch],
			Qty,
			MRP,
			SellingRate,
			TaxCode,
			TaxName,
			GrossAmount,
			TaxableAmount,
			TaxPercentage,
			TaxAmount,
			NetAmount, 'N',@ServerDate
	FROM  #Cs2Cn_SalesTaxuploadGST
	
	UPDATE SalesInvoice SET GstUpload1=1 WHERE SalInvNo  IN (SELECT InvoiceNumber FROM Cs2Cn_SalesTaxuploadGST(NOLOCK) WHERE UploadFlag='N')
	AND Dlvsts>=3 AND VatGst='GST'
	
END
GO
IF EXISTS(SELECT * FROM SYS.objects WHERE NAME='Proc_Cs2Cn_ReturnTaxuploadGST' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_ReturnTaxuploadGST
GO
---EXEC Proc_Cs2Cn_ReturnTaxuploadGST 0,'2017-05-27'
CREATE PROCEDURE Proc_Cs2Cn_ReturnTaxuploadGST
(
   @Po_ErrNo INT OUTPUT,
   @ServerDate DATETIME
)
AS
/*****************************************************************************
* PROCEDURE		: Proc_Cs2Cn_SalesTaxuploadGST
* PURPOSE		: To Extract GST Sales Return tax from CoreStocky to upload to Console
* CREATED BY	: Raja C
* CREATED DATE	: 19/05/2017
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
********************************************************************************/
SET NOCOUNT ON
BEGIN
	
	DECLARE @DistCode		As nVarchar(50)
	DELETE FROM Cs2Cn_ReturnTaxuploadGST WHERE UploadFlag = 'Y'
	SET @Po_ErrNo=0
	RETURN
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)
	
	CREATE TABLE  #Cs2Cn_ReturnTaxuploadGST
(     
     [ReturnNumber]    NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     [ReturnDate]      DATETIME ,
     [InvoiceNumber]   NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     [Invoice Date]    DATETIME,
     OrderNumber       NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     Orderdate         DATETIME,
     DocRefNo          NVARCHAR(100) COLLATE DATABASE_DEFAULT, 
     [Retailer Code]   VARCHAR(75), 
     [Retailer Company Code] NVARCHAR(50) COLLATE DATABASE_DEFAULT,
     [Retailer GSTTIN]  NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     [RetailerStateCode]  VARCHAR(20), 
     [Retailer State]  VARCHAR(150), 
     [Retailer Type]   VARCHAR(150),
     [Retailer PanNo]  NVARCHAR(100) COLLATE DATABASE_DEFAULT, 
     HSNCode           VARCHAR(75), 
     [Product Company Code]  NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     [Product Batch]   NVARCHAR(100) COLLATE DATABASE_DEFAULT,
     Qty               INT NULL,
     MRP               NUMERIC(18,6),
     SellingRate       NUMERIC(18,6),
     TaxCode           NVARCHAR(40) COLLATE DATABASE_DEFAULT, 
     TaxName           NVARCHAR(100) COLLATE DATABASE_DEFAULT, 
     GrossAmount       NUMERIC(38,6)NULL, 
     TaxableAmount     NUMERIC(38,6) NULL,
     TaxPercentage     NUMERIC(18,6) NULL,
     TaxAmount         NUMERIC(38,6) NULL,
     NetAmount         NUMERIC(38,6) NULL ,
     RtrShipId			INT   
)
	
	
	INSERT INTO #Cs2Cn_ReturnTaxuploadGST
	(
	[ReturnNumber] ,
    [ReturnDate]   ,  
    [InvoiceNumber],
	[Invoice Date],
	[OrderNumber],
	[Orderdate],
	[DocRefNo],
	[Retailer Code],
	[Retailer Company Code],
	[Retailer GSTTIN],
	[RetailerStateCode], 
	[Retailer State],
	[Retailer Type],
	[Retailer PanNo],
	HSNCode,
	[Product Company Code],
	[Product Batch],
	Qty,
	MRP,
	SellingRate,
	TaxCode,
	TaxName,
	GrossAmount,
	TaxableAmount,
	TaxPercentage,
	TaxAmount,
	NetAmount,
	RtrShipId 
	)
	SELECT ReturnCode,ReturnDate,SalInvNo,SalInvDate,OrderKeyNo,OrderDate,DocRefNo,RtrCode,CmpRtrCode,RetailerGSTTin,[RetailerStateCode],RetailerState,RetailerType,RetailerPanno,
	HSNCode,PrdCCode,PrdBatCode,Qty,MRP,SellingRate,TaxCode,TaxName,GrossAmount,TaxableAmount,TaxPerc,TaxAmount, NetAmount,RtrShipId
	FROM(
	
	SELECT RH.ReturnCode,RH.ReturnDate,SI.SalInvNo,SI.SalInvDate,ISNULL(SI.OrderKeyNo,'') AS OrderKeyNo,ISNULL(SI.OrderDate,'') AS OrderDate,
	'' AS DocRefNo,R.RtrCode,R.CmpRtrCode,'' AS RetailerGSTTin,'' as [RetailerStateCode],'' AS RetailerState,
	'' AS RetailerType,'' AS RetailerPanno,'' AS HSNCode,P.PrdCCode,PB.PrdBatCode,SUM(RP.BaseQty) AS Qty,RP.PrdUnitMRP AS MRP,RP.PrdUnitSelRte AS SellingRate ,
	TC.TaxCode,TC.TaxName,SUM(PrdGrossAmt)AS GrossAmount,SUM(TaxableAmt) AS TaxableAmount,TaxPerc,SUM(TaxAmt) AS TaxAmount,SUM(PrdNetAmt) AS NetAmount,SI.RtrShipId
	FROM ReturnHeader RH WITH (NOLOCK)  
	INNER JOIN SalesInvoice  SI WITH(NOLOCK) ON SI.SalId=RH.SalId
	INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId 
	INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
	INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
	INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
	INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
	INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
	LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
	WHERE RH.Status = 0  AND RH.VatGst='GST' AND  RH.GstUpload1=0 AND InvoiceType = 1
	GROUP BY  RH.ReturnCode,RH.ReturnDate,SI.SalInvNo,SI.SalInvDate,SI.OrderKeyNo,SI.OrderDate,R.RtrCode,R.CmpRtrCode,P.PrdCCode,PB.PrdBatCode,
	RP.PrdUnitMRP,RP.PrdUnitSelRte,TC.TaxCode,TC.TaxName,TaxPerc,SI.RtrShipId
	HAVING SUM(TaxableAmt) > 0 
	UNION 
	SELECT  RH.ReturnCode,RH.ReturnDate,ISNULL(SI.SalInvNo,'')AS SalInvNo,ISNULL(SI.SalInvDate,'') AS SalInvDate,ISNULL(SI.OrderKeyNo,'') AS OrderKeyNo,ISNULL(SI.OrderDate,'') AS OrderDate,
	'' AS DocRefNo,R.RtrCode,R.CmpRtrCode,'' as [RetailerStateCode],'' AS RetailerGSTTin,'' AS RetailerState,
	'' AS RetailerType,'' AS RetailerPanno,'' AS HSNCode,P.PrdCCode,PB.PrdBatCode,SUM(RP.BaseQty) AS Qty,RP.PrdUnitMRP AS MRP,RP.PrdUnitSelRte AS SellingRate ,
	TC.TaxCode,TC.TaxName,SUM(PrdGrossAmt)AS GrossAmount,SUM(TaxableAmt) AS TaxableAmount,TaxPerc,SUM(TaxAmt) AS TaxAmount,SUM(PrdNetAmt) AS NetAmount,ISNULL(SI.RtrShipId,0)
	From ReturnHeader RH WITH (NOLOCK)	
	INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId 
	INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
	INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
	INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
	INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
	INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
	LEFT OUTER JOIN SalesInvoice  SI WITH(NOLOCK) ON SI.SalId=RP.SalId
	LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
	WHERE RH.Status = 0  AND RH.VatGst='GST' AND  RH.GstUpload1=0 AND InvoiceType = 2
	GROUP BY  RH.ReturnCode,RH.ReturnDate,SI.SalInvNo,SI.SalInvDate,SI.OrderKeyNo,SI.OrderDate,R.RtrCode,R.CmpRtrCode,P.PrdCCode,PB.PrdBatCode,
	RP.PrdUnitMRP,RP.PrdUnitSelRte,TC.TaxCode,TC.TaxName,TaxPerc,SI.RtrShipId
	HAVING SUM(TaxableAmt) > 0 )X
	
	
	SELECT DISTINCT ColumnValue as HSNCODE,E.PrdCCode
	INTO #HSNCode
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId
	INNER JOIN Product E (NOLOCK) ON E.Prdid=C.MasterRecordId
	WHERE MasterName='Product Master' and ColumnName='HSN Code'
	
	UPDATE A  SET A.[Retailer State]=C.StateName, 
	A.[Retailer GSTTIN]=B.GSTTinNo ,A.[RetailerStateCode]=StateCode
	FROM #Cs2Cn_ReturnTaxuploadGST A 
	INNER JOIN Retailer R WITH (NOLOCK)  ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  RetailerShipAdd  B  WITH (NOLOCK)  ON R.RtrId=B.RtrID and A.RtrShipId=B.RtrShipId
	INNER JOIN  StateMaster C WITH (NOLOCK)  ON C.StateId=B.StateId
	
		
	SELECT MasterRecordId,ColumnValue  AS RetailerPANNo INTO #RetailerPANNo
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId	
	WHERE MasterName='Retailer Master' AND ColumnName='PAN Number'
	
	SELECT DISTINCT MasterRecordId,ColumnValue  AS RetailerType INTO #RetailerType
	FROM UDCHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
	and B.UdcMasterId=C.UdcMasterId
	INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
	and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
	WHERE MasterName='Retailer Master' AND ColumnName='Retailer Type'
	
	
	UPDATE A  SET A.[Retailer PanNo]=B.RetailerPANNo FROM #Cs2Cn_ReturnTaxuploadGST A INNER JOIN Retailer R ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  #RetailerPANNo  B  ON R.RtrId=B.MasterRecordId
	
    UPDATE A  SET A.[Retailer Type]=B.RetailerType FROM #Cs2Cn_ReturnTaxuploadGST A INNER JOIN Retailer R ON A.[Retailer Company Code]=R.CmpRtrCode
	INNER JOIN  #RetailerType  B  ON R.RtrId=B.MasterRecordId
	
	UPDATE A  SET A.HSNCode=R.HSNCode FROM #Cs2Cn_ReturnTaxuploadGST A INNER JOIN #HSNCode R ON A.[Product Company Code]=R.PrdCCode
    INSERT INTO Cs2Cn_ReturnTaxuploadGST
	(        
	        [DistCode],
	        [ReturnNumber] ,
            [ReturnDate]   ,
			[InvoiceNumber],
			[InvoiceDate],
			[OrderNumber],
			[Orderdate],
			[DocRefNo],
			[RetailerCode],
			[RetailerCompanyCode],
			[RetailerGSTTIN],
			[RetailerStateCode],
			[RetailerState],
			[RetailerType],
			[RetailerPanNo],
			HSNCode,
			[ProductCompanyCode],
			[ProductBatch],
			Qty,
			MRP,
			SellingRate,
			TaxCode,
			TaxName,
			GrossAmount,
			TaxableAmount,
			TaxPercentage,
			TaxAmount,
			NetAmount,
			UploadFlag,
			ServerDate
	)
	SELECT  @DistCode,
	        [ReturnNumber] ,
            [ReturnDate]   , 
	        [InvoiceNumber],
			[Invoice Date],
			[OrderNumber],
			[Orderdate],
			[DocRefNo],
			[Retailer Code],
			[Retailer Company Code],			
			[Retailer GSTTIN],
			[RetailerStateCode],
			[Retailer State],
			[Retailer Type],
			[Retailer PanNo],
			HSNCode,
			[Product Company Code],
			[Product Batch],
			Qty,
			MRP,
			SellingRate,
			TaxCode,
			TaxName,
			GrossAmount,
			TaxableAmount,
			TaxPercentage,
			TaxAmount,
			NetAmount, 'N',@ServerDate
	FROM  #Cs2Cn_ReturnTaxuploadGST
	
	UPDATE ReturnHeader SET GstUpload1=1 WHERE ReturnCode  IN (SELECT ReturnNumber  FROM Cs2Cn_ReturnTaxuploadGST(NOLOCK) WHERE UploadFlag='N')
	AND Status=0 AND VatGst='GST'
	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptLoadSheetItemWiseParle]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptLoadSheetItemWiseParle]
GO
--EXEC Proc_RptLoadSheetItemWiseParle 251,1,0,'JNJ396',0,0,1  
CREATE PROCEDURE [dbo].[Proc_RptLoadSheetItemWiseParle]  
(      
 @Pi_RptId  INT,      
 @Pi_UsrId  INT,      
 @Pi_SnapId  INT,      
 @Pi_DbName  nvarchar(50),      
 @Pi_SnapRequired INT,      
 @Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT      
)      
AS      
/************************************************************      
* CREATED BY : Gunasekaran      
* CREATED DATE : 18/07/2007      
* NOTE  :      
* MODIFIED :      
* DATE      AUTHOR     DESCRIPTION      
------------------------------------------------      
* {date} {developer}  {brief modification description}      
Modified by Praveenraj B For Parle LoadingSheet CR On 27/01/2012      
* 02/07/2013 Jisha Mathew PARLECS/0613/008       
* 11/11/2013 Jisha Mathew Bug No:30616      
*01/09/2016 Rajesh Ranjan Added BOX UOM ICRSTPAR3196  
* 28/09/2016 Sowmya S.R Added CMB.  
*02/11/2016 Rajesh Ranjan Added UOM NUMBER,BAG,TIFFIN BOX,BAR,TBX
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
28-02-2018  lakshman M   BZ     ICRSTPAR7791            item wise laoding sheet Bill qty & free qty uom group wise conversion validation adedd in Core stocky.
*************************************************************/      
SET NOCOUNT ON      
BEGIN      
 DECLARE @NewSnapId  AS INT      
 DECLARE @DBNAME  AS  nvarchar(50)      
 DECLARE @TblName  AS nvarchar(500)      
 DECLARE @TblStruct  AS nVarchar(4000)      
 DECLARE @TblFields  AS nVarchar(4000)      
 DECLARE @sSql  AS  nVarChar(4000)      
 DECLARE @ErrNo   AS INT      
 DECLARE @PurDBName AS nVarChar(50)      
 --Added by Sathishkumar Veeramani 2013/04/25      
 DECLARE @Prdid AS INT      
 DECLARE @PrdCode AS Varchar(50)      
 DECLARE @PrdBatchCode AS Varchar(50)
 DECLARE @Freeqty as nvarchar(50)      
 DECLARE @UOMSalId AS INT      
 DECLARE @BaseQty AS INT      
 DECLARE @FUOMID AS INT      
 DECLARE @FCONVERSIONFACTOR AS INT      
 DECLARE @StockOnHand AS INT      
 DECLARE @Converted AS INT      
 DECLARE @Remainder AS INT      
 DECLARE @COLUOM AS VARCHAR(50)      
 DECLARE @Sql AS VARCHAR(5000)      
 DECLARE @SlNo AS INT      
 --Till Here      
 --Jisha      
 DECLARE @TotConverted AS INT      
 DECLARE @TotRemainder AS INT       
 DECLARE @TotalQty as INT       
 --      
 --Filter Variable      
 DECLARE @FromDate    AS DATETIME      
 DECLARE @ToDate      AS DATETIME      
 DECLARE @VehicleId     AS  INT      
 DECLARE @VehicleAllocId AS INT      
 DECLARE @SMId   AS INT      
 DECLARE @DlvRouteId AS INT      
 DECLARE @RtrId   AS INT      
 DECLARE @UOMId   AS INT      
 DECLARE @FromBillNo AS  BIGINT      
 DECLARE @ToBillNo   AS  BIGINT      
 DECLARE @SalId   AS     BIGINT      
    DECLARE @OtherCharges AS NUMERIC(18,2)         
 --DECLARE @BillNoDisp   AS INT      
 --DECLARE @DispOrderby AS INT      
 --Till Here      
 EXEC Proc_RptItemWise @Pi_RptId ,@Pi_UsrId      
 --Assgin Value for the Filter Variable      
 SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))      
 SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))      
 SET @VehicleId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId))      
 SET @VehicleAllocId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId))      
 SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))      
 SET @DlvRouteId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))      
 SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))      
 SET @UOMId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,129,@Pi_UsrId))      
 SET @FromBillNo =(SELECT  MIN(iCountid) FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))      
 SET @ToBillNo =(SELECT  MAX(iCountid) FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))      
 SET @SalId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))       
 --SET @DispOrderby=(SELECT TOP 1 iCountId FROM Fn_ReturnRptFilters(@Pi_RptId,275,@Pi_UsrId))      
 --Till Here      
 --DECLARE @RPTBasedON AS INT      
 --SET @RPTBasedON =0      
 --SELECT @RPTBasedON = iCountId FROM Fn_ReturnRptFilters(@Pi_RptId,257,@Pi_UsrId)       
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)       
 CREATE TABLE #RptLoadSheetItemWiseParle1      
 (      
   [SalId]      INT,      
   [BillNo]    NVARCHAR (100),    
   [PrdId]               INT,      
   [PrdBatId]     INT,      
   [Product Code]        NVARCHAR (100),      
   [Product Description] NVARCHAR(150),      
   [PrdCtgValMainId]   INT,       
   [CmpPrdCtgId]    INT,      
   [Batch Number]        NVARCHAR(50),      
   [MRP]      NUMERIC (38,6) ,      
   [Selling Rate]    NUMERIC (38,6) ,      
   [Billed Qty]          NUMERIC (38,0),      
   [Free Qty]            NUMERIC (38,0),      
   [Return Qty]          NUMERIC (38,0),      
   [Replacement Qty]     NUMERIC (38,0),      
   [Total Qty]           NUMERIC (38,0),      
   [PrdWeight]     NUMERIC (38,4),      
   [PrdSchemeDisc]    NUMERIC (38,2),      
   [GrossAmount]    NUMERIC (38,2),      
   [TaxAmount]     NUMERIC (38,2),      
   [NetAmount]     NUMERIC (38,2),      
   [TotalBills]    NUMERIC (38,0),      
   [TotalDiscount]    NUMERIC (38,2),      
   [OtherAmt]     NUMERIC (38,2),      
   [AddReduce]     NUMERIC (38,2),      
   [Damage]              NUMERIC (38,2),      
   [BX]                  NUMERIC (38,0),  
   [PB]                  NUMERIC (38,0),      
   [JAR]      NUMERIC (38,0),      
   [PKT]                 NUMERIC (38,0),      
   [CN]      NUMERIC (38,0),      
   [GB]                  NUMERIC (38,0),      
   [ROL]                 NUMERIC (38,0),      
   [TOR]                 NUMERIC (38,0),      
   [CTN]         NUMERIC (38,0),      
   [TN]         NUMERIC (38,0),      
   [CAR]         NUMERIC (38,0),      
   [PC]         NUMERIC (38,0),  
   [CMB]         NUMERIC (38,0),    
   [BOX]                  NUMERIC (38,0),   
   [PBG]                  NUMERIC (38,0),      
   [TIN]                  NUMERIC (38,0),       
   [TIF]  NUMERIC (38,0),   
   [TBX]  NUMERIC (38,0),  
   [BAR]  NUMERIC (38,0),  
   [NOS]  NUMERIC (38,0),  
   [BAG]  NUMERIC (38,0),  
   [TotalQtyBX]          NUMERIC (38,0),  
   [TotalQtyPB]          NUMERIC (38,0),      
   [TotalQtyPKT]         NUMERIC (38,0),      
   [TotalQtyJAR]         NUMERIC (38,0),      
   [TotalQtyCN]    NUMERIC (38,0),      
   [TotalQtyGB]          NUMERIC (38,0),      
   [TotalQtyROL]         NUMERIC (38,0),      
   [TotalQtyTOR]         NUMERIC (38,0),      
   [TotalQtyCTN]         NUMERIC (38,0),      
   [TotalQtyTN]         NUMERIC (38,0),      
   [TotalQtyCAR]         NUMERIC (38,0),      
   [TotalQtyPC]         NUMERIC (38,0),    
   [TotalQtyBOX]          NUMERIC (38,0),   
   [TotalQtyPBG]                  NUMERIC (38,0),   
   [TotalQtycmb]         NUMERIC (38,0),     
   [TotalQtyTIN]                  NUMERIC (38,0),  
   [TotalQtyTIF]  NUMERIC (38,0),   
   [TotalQtyTBX]  NUMERIC (38,0),  
   [TotalQtyBAR]  NUMERIC (38,0),  
   [TotalQtyNOS]  NUMERIC (38,0),  
   [TotalQtyBAG]  NUMERIC (38,0)            
 )      
 --IF @Pi_GetFromSnap = 0  --To Generate For New Report Data      
 --BEGIN      
  IF @FromBillNo <> 0 Or @ToBillNo <> 0      
  BEGIN      
   INSERT INTO #RptLoadSheetItemWiseParle1([SalId],[BillNo],[PrdId],[PrdBatId],[Product Code],[Product Description],[PrdCtgValMainId],[CmpPrdCtgId],[Batch Number],[MRP],      
    [Selling Rate],[Billed Qty],[Free Qty],[Return Qty],[Replacement Qty],[Total Qty],[PrdWeight],PrdSchemeDisc,[GrossAmount],      
    [TaxAmount],[NetAmount],[TotalDiscount],[OtherAmt],[AddReduce],[Damage],[BX],[BOX],[PBG],[TIN],[PB],[JAR],[PKT],[CN],[GB],[ROL],[TOR],[CTN],[TN],[CAR],[PC],CMB,   
 [TIF],[TBX],[BAR],[NOS],[BAG],         
    [TotalQtyBOX],[TotalQtyTIN],[TotalQtyPBG],[TotalQtyBX],[TotalQtyPB],[TotalQtyPKT],[TotalQtyJAR],[TotalQtyCN],[TotalQtyGB],[TotalQtyROL],[TotalQtyTOR],[TotalQtyCTN],      
    [TotalQtyTN],[TotalQtyCAR],[TotalQtyPC],[TotalQtycmb],[TotalQtyTIF],[TotalQtyTBX],[TotalQtyBAR],[TotalQtyNOS],[TotalQtyBAG])--select * from RtrLoadSheetItemWise      
   SELECT RI.[SalId],SalInvNo,RI.PrdId,RI.PrdBatId,PrdDCode,PrdNAme,PrdCtgValMainId,CmpPrdCtgId,PrdBatCode,[MRP],[SellingRate],BillQty,FreeQty,ReturnQty,RepalcementQty,TotalQty,      
   [PrdWeight],Isnull(SUM(PrdSchDiscAmount),0),[GrossAmount],[TaxAmount],      
   dbo.Fn_ConvertCurrency([NetAmount],@Pi_CurrencyId),Isnull((Sum(PrdSplDiscAmount)+Sum(PrdSchDiscAmount)+Sum(PrdDBDiscAmount)+Sum(PrdCDAmount)),0) AS [TotalDiscount],      
   Isnull((Sum([TaxAmount])+Sum(PrdSplDiscAmount)+Sum(PrdSchDiscAmount)+Sum(PrdDBDiscAmount)+ Sum(PrdCDAmount)),0) As [OtherAmt],0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,      
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 FROM RtrLoadSheetItemWise RI      
   LEFT OUTER JOIN SalesInvoiceProduct SP On SP.PrdId=RI.PrdId And SP.PrdBatId=RI.PrdBatId And RI.SalId=SP.SalId      
   WHERE      
 RptId = @Pi_RptId and UsrId = @Pi_UsrId and      
 (VehicleId = (CASE @VehicleId WHEN 0 THEN VehicleId ELSE 0 END) OR      
     VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )      
  AND (Allotmentnumber = (CASE @VehicleAllocId WHEN 0 THEN Allotmentnumber ELSE 0 END) OR      
     Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )      
  AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR      
     SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))      
  AND (DlvRMId=(CASE @DlvRouteId WHEN 0 THEN DlvRMId ELSE 0 END) OR      
   DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )      
  AND (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR      
     RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )      
  AND [SalInvDate] Between @FromDate and @ToDate      
    AND RI.SalId Between @FromBillNo and @ToBillNo      
----       
-- AND (@SalId = (CASE @SalId WHEN 0 THEN @SalId ELSE 0 END) OR       
--       RI.SalId in (Select Selvalue from ReportfilterDt Where Rptid = @Pi_RptId and Usrid =@Pi_UsrId))      
 GROUP BY RI.[SalId],SalInvNo,RI.PrdId,RI.PrdBatId,PrdDCode,PrdNAme,PrdBatCode,[MRP],[SellingRate],BillQty,FreeQty,ReturnQty,RepalcementQty,TotalQty,[PrdWeight],      
 NetAmount,[GrossAmount],[TaxAmount],PrdCtgValMainId,CmpPrdCtgId      
  END       
  ELSE      
  BEGIN      
   INSERT INTO #RptLoadSheetItemWiseParle1([SalId],BillNo,PrdId,PrdBatId,[Product Code],[Product Description],[PrdCtgValMainId],[CmpPrdCtgId],[Batch Number],[MRP],      
     [Selling Rate],[Billed Qty],[Free Qty],[Return Qty],[Replacement Qty],[Total Qty],[PrdWeight],PrdSchemeDisc,[GrossAmount],      
     [TaxAmount],[NetAmount],[TotalDiscount],[OtherAmt],[AddReduce],[Damage],[BX],[BOX],[PBG],[TIN],[PB],[JAR],[PKT],[CN],[GB],[ROL],[TOR],[CTN],[TN],[CAR],[PC],CMB,   
     [TIF],[TBX],[BAR],[NOS],[BAG],     
     [TotalQtyBoX],[TotalQtyTIN],[TotalQtyPBG],[TotalQtyBX],[TotalQtyPB],[TotalQtyPKT],[TotalQtyJAR],[TotalQtyCN],[TotalQtyGB],[TotalQtyROL],[TotalQtyTOR],      
     [TotalQtyCTN],[TotalQtyTN],[TotalQtyCAR],[TotalQtyPC],TotalQtycmb,[TotalQtyTIF],[TotalQtyTBX],[TotalQtyBAR],[TotalQtyNOS],[TotalQtyBAG])      
   SELECT RI.[SalId],SalInvNo,RI.PrdId,RI.PrdBatId,PrdDCode,PrdNAme,PrdCtgValMainId,CmpPrdCtgId,PrdBatCode,[MRP],CAST([SellingRate] AS NUMERIC(36,2)),      
   BillQty,FreeQty,ReturnQty,RepalcementQty,TotalQty,[PrdWeight],Isnull(SUM(PrdSchDiscAmount),0),GrossAmount,TaxAmount,      
   dbo.Fn_ConvertCurrency([NetAmount],@Pi_CurrencyId),Isnull((SUM(PrdSplDiscAmount)+SUM(PrdSchDiscAmount)+SUM(PrdDBDiscAmount)+SUM(PrdCDAmount)),0) As [TotalDiscount],      
   ISNULL((SUM([TaxAmount])+SUM(PrdSplDiscAmount)+SUM(PrdSchDiscAmount)+SUM(PrdDBDiscAmount)+SUM(PrdCDAmount)),0) As [OtherAmt],0,0,0,0,0,0,0,0,0,0,0,0,0,      
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 FROM RtrLoadSheetItemWise RI --select * from RtrLoadSheetItemWise      
   LEFT OUTER JOIN SalesInvoiceProduct SP On SP.PrdId=RI.PrdId And SP.PrdBatId=RI.PrdBatId And RI.SalId=SP.SalId      
   WHERE      
   RptId = @Pi_RptId and UsrId = @Pi_UsrId and      
   (VehicleId = (CASE @VehicleId WHEN 0 THEN VehicleId ELSE 0 END) OR      
       VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )      
    AND (Allotmentnumber = (CASE @VehicleAllocId WHEN 0 THEN Allotmentnumber ELSE 0 END) OR      
       Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )      
    AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR      
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))      
    AND (DlvRMId=(CASE @DlvRouteId WHEN 0 THEN DlvRMId ELSE 0 END) OR      
       DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )      
    AND (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR      
       RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )      
   AND (@SalId = (CASE @SalId WHEN 0 THEN @SalId ELSE 0 END) OR      
     RI.SalId in (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)) )      
   AND [SalInvDate] BETWEEN @FromDate AND @ToDate      
   GROUP BY RI.[SalId],SalInvNo,RI.PrdId,RI.PrdBatId,PrdDCode,PrdNAme,PrdBatCode,[MRP],[SellingRate],BillQty,FreeQty,ReturnQty,RepalcementQty,TotalQty,NetAmount,      
   GrossAmount,TaxAmount,[PrdWeight],PrdCtgValMainId,CmpPrdCtgId      
   ORDER BY PrdDCode      
  END        
  --Select '#RptLoadSheetItemWiseParle1',* From #RptLoadSheetItemWiseParle1 Where PrdId IN(6079,6093)  
  UPDATE #RptLoadSheetItemWiseParle1 SET TotalBills=(SELECT Count(DISTINCT SalId) FROM #RptLoadSheetItemWiseParle1)      
-----Added By Sathishkumar Veeramani OtherCharges      
      ---Changed By Jisha for Bug No:30616      
               --SELECT @OtherCharges = SUM(OtherCharges) From SalesInvoice WHERE  SalInvDate Between @FromDate and @ToDate AND DlvSts = 2      
               SELECT @OtherCharges = ISNULL((SUM(B.TaxAmount)+SUM(PrdSplDiscAmount)+SUM(PrdSchDiscAmount)+SUM(PrdDBDiscAmount)+SUM(PrdCDAmount)),0)       
               FROM SalesInvoice A WITH (NOLOCK),RtrLoadSheetItemWise B WITH (NOLOCK)      
               LEFt OUTER JOIN SalesInvoiceProduct C WITH (NOLOCK) ON B.SalId = C.SalId       
    AND B.PrdId=C.PrdId And B.PrdBatId=C.PrdBatId      
               WHERE A.SalId = B.SalId AND B.SalInvDate Between @FromDate and @ToDate AND DlvSts = 2 AND UsrID = @Pi_UsrId AND RptId = @Pi_RptId      
               AND                    
   (B.VehicleId = (CASE @VehicleId WHEN 0 THEN B.VehicleId ELSE 0 END) OR      
       B.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )      
    AND (Allotmentnumber = (CASE @VehicleAllocId WHEN 0 THEN Allotmentnumber ELSE 0 END) OR      
       Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )      
    AND (B.SMId=(CASE @SMId WHEN 0 THEN B.SMId ELSE 0 END) OR      
       B.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))      
    AND (B.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN B.DlvRMId ELSE 0 END) OR      
       B.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )      
    AND (B.RtrId = (CASE @RtrId WHEN 0 THEN B.RtrId ELSE 0 END) OR      
       B.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )      
   AND (@SalId = (CASE @SalId WHEN 0 THEN @SalId ELSE 0 END) OR      
     B.SalId in (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)) )      
               UPDATE #RptLoadSheetItemWiseParle1 SET AddReduce = @OtherCharges       
     --Select '#RptLoadSheetItemWiseParleUpdate',* From #RptLoadSheetItemWiseParle1 Where PrdId IN(6079,6093)  
-------Added By Sathishkumar Veeramani Damage Goods Amount---------       
   UPDATE R SET R.[Damage] = B.PrdNetAmt FROM #RptLoadSheetItemWiseParle1 R INNER JOIN      
  (SELECT RH.SalId,SUM(RP.PrdNetAmt) AS PrdNetAmt,RP.PrdId,RP.PrdBatId FROM ReturnHeader RH,ReturnProduct RP       
   WHERE RH.ReturnID  = RP.ReturnID AND RH.ReturnType = 1 GROUP BY RH.SalId,RP.PrdId,RP.PrdBatId)B      
   ON R.SalId = B.SalId AND R.PrdId = B.PrdId       
  AND R.PrdBatId = B.PrdBatId      
  Update #RptLoadSheetItemWiseParle1 Set [Batch Number] = '',PrdBatId = 0 --Code Added by Muthuvelsamy R for DCRSTPAR0510      
------Till Here--------------------        
----Added By Jisha On 02/07/2013 for PARLECS/0613/008       
SELECT 0 AS [SalId],'' AS BillNo,PrdId,PrdBatId,[Product Code],[Product Description],[PrdCtgValMainId],[CmpPrdCtgId],      
[Batch Number] AS [Batch Number],[MRP],MAX([Selling Rate]) AS [Selling Rate],SUM([Billed Qty]) as [Billed Qty],SUM([Free Qty]) as [Free Qty],SUM([Return Qty]) as [Return Qty],      
SUM([Replacement Qty]) AS [Replacement Qty],SUM([Total Qty]) AS [Total Qty],SUM(PrdWeight) AS PrdWeight,SUM(PrdSchemeDisc) AS PrdSchemeDisc,      
SUM(GrossAmount) AS GrossAmount,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NetAmount,TotalBills,SUM(TotalDiscount) AS TotalDiscount,      
SUM(OtherAmt) AS OtherAmt,SUM(DISTINCT AddReduce) AS Addreduce,SUM([Damage])AS [Damage],0 AS[BX],0 AS[BOX],0 [PBG],0 [TIN],0 AS [PB],0 AS [JAR],0 AS [PKT],0 AS [CN],      
0 AS [GB],0 AS [ROL],0 AS [TOR],0 AS [CTN],0 AS [TN],0 AS [CAR],0 AS [PC],0 as CMB, 0 as [TIF],0 as [TBX],0 as [BAR],0 as [NOS],0 as [BAG],     
0 AS TotalQtyBOX,0 AS [TotalQtyTIN],0 AS [TotalQtyPBG],0 AS TotalQtyBX,0 AS TotalQtyPB,0 AS TotalQtyPKT,0 AS TotalQtyJAR,0 AS [TotalQtyCN],0 AS [TotalQtyGB],0 AS [TotalQtyROL],0 AS [TotalQtyTOR],      
0 AS [TotalQtyCTN],0 AS [TotalQtyTN],0 AS [TotalQtyCAR],0 AS [TotalQtyPC],0 AS TotalQtycmb ,0 AS [TotalQtyTIF],0 AS [TotalQtyTBX],0 AS [TotalQtyBAR],0 AS [TotalQtyNOS],0 AS [TotalQtyBAG]     
INTO #RptLoadSheetItemWiseParle FROM #RptLoadSheetItemWiseParle1      
GROUP BY PrdId,PrdBatId,[Product Code],[Product Description],[PrdCtgValMainId],[CmpPrdCtgId],[Batch Number],[MRP],TotalBills      
 -------------- Added by lakshman M date 28-02-2018 PMS ID:ICRSTPAR7791 -----------   
--Added by Sathishkumar Veeramani 2013/04/25        
 DECLARE CUR_UOMQTY CURSOR       
 FOR      
  SELECT P.PrdId,Rpt.[Product Code],[Batch Number],SUM([Billed Qty]) AS [Billed Qty],SUM([Total Qty]) AS [Total Qty],SUM([Free Qty]) as [Free Qty] FROM #RptLoadSheetItemWiseParle Rpt WITH (NOLOCK)      
  INNER JOIN Product P WITH (NOLOCK) ON  Rpt.PrdId=P.PrdId WHERE [Free Qty] = 0
  GROUP BY P.PrdId,Rpt.[Product Code],[Batch Number]        
 OPEN CUR_UOMQTY      
 FETCH NEXT FROM CUR_UOMQTY INTO @PrdId,@PrdCode,@PrdBatchCode,@BaseQty,@TotalQty,@Freeqty      
 WHILE @@FETCH_STATUS=0      
 BEGIN       
   SET @Converted=0      
   SET @Remainder=0         
   SET @TotConverted=0      
   SET @TotRemainder=0          
   DECLARE CUR_UOMGROUP CURSOR      
   FOR       
   SELECT DISTINCT UOMID,CONVERSIONFACTOR FROM (      
   SELECT A.UOMID,CONVERSIONFACTOR FROM UOMMASTER A WITH (NOLOCK)       
   INNER JOIN UOMGROUP B WITH (NOLOCK) ON A.UomId = B.UomId INNER JOIN PRODUCT C WITH (NOLOCK)      
   ON C.UOMGROUPID=B.UOMGROUPID WHERE PRDID=@PrdId AND A.UOMCODE IN ('BOX','BX','GB','CN','PB','JAR','TOR','PKT','ROL','CTN','TN','PC','CAR','CMB','TIN','PBG'  
   ,'TIF','TBX','BAR','NOS','BAG')) UOM ORDER BY CONVERSIONFACTOR DESC       
   OPEN CUR_UOMGROUP      
   FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR      
   WHILE @@FETCH_STATUS=0      
   BEGIN       
     SELECT @COLUOM=UOMCODE FROM UomMaster WITH (NOLOCK) WHERE UOMID=@FUOMID      
     IF @BaseQty >= @FCONVERSIONFACTOR      
     BEGIN      
      SET @Converted=CAST(@BaseQty/@FCONVERSIONFACTOR as INT)      
      SET @Remainder=CAST(@BaseQty%@FCONVERSIONFACTOR AS INT)      
      SET @BaseQty=@Remainder             
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle  SET [' + @COLUOM +']='+ CAST(ISNULL(@Converted,0) AS VARCHAR(25)) +' WHERE [Product Code]='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END       
     ELSE        
     BEGIN      
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [' + @COLUOM +']='+ CAST(0 AS VARCHAR(10)) +' WHERE [Product Code] ='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END      
     ----Added By Jisha On 02/07/2013 for PARLECS/0613/008       
     IF @TotalQty >= @FCONVERSIONFACTOR      
     BEGIN            
      SET @TotConverted=CAST(@TotalQty/@FCONVERSIONFACTOR as INT)      
      SET @TotRemainder=CAST(@TotalQty%@FCONVERSIONFACTOR AS INT)      
      SET @TotalQty=@TotRemainder              
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [TotalQty' + @COLUOM + ']= '+ CAST(ISNULL(@TotConverted,0) AS VARCHAR(25)) +' WHERE [Product Code]='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END       
     ELSE        
     BEGIN      
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [TotalQty' + @COLUOM +']='+ Cast(0 AS VARCHAR(10)) +' WHERE [Product Code] ='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END           
     --           
   FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR      
   END       
   CLOSE CUR_UOMGROUP      
   DEALLOCATE CUR_UOMGROUP      
   SET @BaseQty=0      
   SET @TotalQty=0      
 FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty,@TotalQty,@Freeqty      
 END       
 CLOSE CUR_UOMQTY      
 DEALLOCATE CUR_UOMQTY  
 ----------- Till Here 28-02-2018  ----------  
  -------------- 28-02-2018-----------   
--Added by Sathishkumar Veeramani 2013/04/25        
 DECLARE CUR_UOMQTY CURSOR       
 FOR      
  SELECT P.PrdId,Rpt.[Product Code],[Batch Number],SUM([Billed Qty]) AS [Billed Qty],SUM([Total Qty]) AS [Total Qty],SUM([Free Qty]) as [Free Qty] FROM #RptLoadSheetItemWiseParle Rpt WITH (NOLOCK)      
  INNER JOIN Product P WITH (NOLOCK) ON  Rpt.PrdId=P.PrdId WHERE [Free Qty] > 0
  GROUP BY P.PrdId,Rpt.[Product Code],[Batch Number]        
 OPEN CUR_UOMQTY      
 FETCH NEXT FROM CUR_UOMQTY INTO @PrdId,@PrdCode,@PrdBatchCode,@BaseQty,@TotalQty,@Freeqty      
 WHILE @@FETCH_STATUS=0      
 BEGIN       
   SET @Converted=0      
   SET @Remainder=0         
   SET @TotConverted=0      
   SET @TotRemainder=0          
   DECLARE CUR_UOMGROUP CURSOR      
   FOR       
   SELECT DISTINCT UOMID,CONVERSIONFACTOR FROM (      
   SELECT A.UOMID,CONVERSIONFACTOR FROM UOMMASTER A WITH (NOLOCK)       
   INNER JOIN UOMGROUP B WITH (NOLOCK) ON A.UomId = B.UomId INNER JOIN PRODUCT C WITH (NOLOCK)      
   ON C.UOMGROUPID=B.UOMGROUPID WHERE PRDID=@PrdId AND A.UOMCODE IN ('BOX','BX','GB','CN','PB','JAR','TOR','PKT','ROL','CTN','TN','PC','CAR','CMB','TIN','PBG'  
   ,'TIF','TBX','BAR','NOS','BAG')) UOM ORDER BY CONVERSIONFACTOR DESC       
   OPEN CUR_UOMGROUP      
   FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR      
   WHILE @@FETCH_STATUS=0      
   BEGIN       
     SELECT @COLUOM=UOMCODE FROM UomMaster WITH (NOLOCK) WHERE UOMID=@FUOMID      
     IF @BaseQty >= @FCONVERSIONFACTOR      
     BEGIN      
      SET @Converted=CAST(@BaseQty/@FCONVERSIONFACTOR as INT)      
      SET @Remainder=CAST(@BaseQty%@FCONVERSIONFACTOR AS INT)      
      SET @BaseQty=@Remainder             
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle  SET [' + @COLUOM +']='+ CAST(ISNULL(@Converted,0) AS VARCHAR(25)) +' WHERE [Product Code]='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END       
     ELSE        
     BEGIN      
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [' + @COLUOM +']='+ CAST(0 AS VARCHAR(10)) +' WHERE [Product Code] ='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END      
     ----Added By Jisha On 02/07/2013 for PARLECS/0613/008       
     IF @TotalQty >= @FCONVERSIONFACTOR      
     BEGIN            
      SET @TotConverted=CAST(@TotalQty/@FCONVERSIONFACTOR as INT)      
      SET @TotRemainder=CAST(@TotalQty%@FCONVERSIONFACTOR AS INT)      
      SET @TotalQty=@TotRemainder              
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [TotalQty' + @COLUOM + ']= '+ CAST(ISNULL(@TotConverted,0) AS VARCHAR(25)) +' WHERE [Product Code]='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END       
     ELSE        
     BEGIN      
      SET @Sql='UPDATE #RptLoadSheetItemWiseParle SET [TotalQty' + @COLUOM +']='+ Cast(0 AS VARCHAR(10)) +' WHERE [Product Code] ='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+''''+' and [Free Qty]='+ ''''+@Freeqty+''''       
      EXEC(@Sql)      
     END           
     --           
   FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR      
   END       
   CLOSE CUR_UOMGROUP      
   DEALLOCATE CUR_UOMGROUP      
   SET @BaseQty=0      
   SET @TotalQty=0      
 FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty,@TotalQty,@Freeqty      
 END       
 CLOSE CUR_UOMQTY      
 DEALLOCATE CUR_UOMQTY  
 ----------- Till Here 28-02-2018  ----------  
------SELECT [PrdId],[PrdBatId],[Product Code],[Product Description],[Billed Qty],[Free Qty],[Return Qty],[Replacement Qty],[Total Qty],      
------[BX],[PB],[JAR],[PKT],[CN],[GB],[ROL],[TOR],[TotalQtyBX],[TotalQtyPB],[TotalQtyPKT],[TotalQtyJAR],[TotalQtyCN],[TotalQtyGB],[TotalQtyROL],[TotalQtyTOR]      
------FROM #RptLoadSheetItemWiseParle      
 ---Commented By Jisha on 02/07/2013 for PARLECS/0613/008      
 ----UPDATE A SET A.TotalQtyBX = Z.TotalBox,A.TotalQtyPB = Z.TotalPouch,A.TotalQtyPKT = Z.TotalPacks FROM #RptLoadSheetItemWiseParle A WITH (NOLOCK)      
 ----INNER JOIN (SELECT PrdID,PrdBatId,SUM(BX) AS TotalBox,SUM(PB)+SUM(JAR) AS TotalPouch,SUM(PKT) AS TotalPacks       
 ----FROM #RptLoadSheetItemWiseParle WITH (NOLOCK)GROUP BY PrdID,PrdBatId) Z      
 ----ON A.PrdId = Z.PrdId AND A.PrdBatId = Z.PrdBatId      
--Till Here      
 --Check for Report Data      
    SELECT 0 AS [SalId],'' AS BillNo,PrdId,0 AS PrdBatId,[Product Code],[Product Description],[PrdCtgValMainId],[CmpPrdCtgId],      
    0 AS [Batch Number],[MRP],MAX([Selling Rate]) AS [Selling Rate],([BX]+[GB]+[BOX]) AS BilledQtyBox,(([PB]+[PBG])+([JAR]+[CN]+[TOR]+[TN]+[TIN]+[CAR]+[BAG])) AS BilledQtyPouch,      
    ([PKT]+[ROL]+[CTN]+[PC]+[CMB]+[TIF]+[TBX]+[BAR]+[NOS]) AS BilledQtyPack,  
    SUM([Total Qty]) AS [Total Qty],  
    SUM(TotalQtyBoX+TotalQtyBX+TotalQtyGB) AS TotalQtyBOX,      
    SUM(TotalQtyPB+TotalQtyPBG+TotalQtyJAR+TotalQtyCN+TotalQtyTOR+TotalQtyTN+TotalQtyTIN+TotalQtyCAR+TotalQtyBag ) AS TotalQtyPouch,  
    SUM(TotalQtyPKT+TotalQtyROL+TotalQtyCTN+TotalQtyPC+TotalQtyCmb+TotalQtyTIF+TotalQtyTBX+TotalQtyBAR+TotalQtyNOS) AS TotalQtyPack,      
    SUM([Free Qty]) As [Free Qty],SUM([Return Qty])As [Return Qty],SUM([Replacement Qty]) AS [Replacement Qty],SUM([PrdWeight]) AS [PrdWeight],      
    SUM([Billed Qty]) AS [Billed Qty],SUM(GrossAmount) AS GrossAmount,SUM(PrdSchemeDisc) As PrdSchemeDisc,      
    SUM(TaxAmount) AS TaxAmount,SUM(NETAMOUNT) as NETAMOUNT,TotalBills,SUM([TotalDiscount]) AS [TotalDiscount],      
    SUM([OtherAmt]) AS [OtherAmt],SUM([AddReduce]) As [AddReduce],SUM([Damage])AS [Damage] INTO #Result      
 FROM #RptLoadSheetItemWiseParle GROUP BY PrdId,[Product Code],[Product Description],[MRP],TotalBills,[PrdCtgValMainId],[CmpPrdCtgId],      
 [BX],[BOX],[PBG],[TIN],[PB],[JAR],[PKT],[CN],[GB],[ROL],[TOR],[CTN],[TN],[CAR],[PC],CMB, [TIF],[TBX],[BAR],[NOS],[BAG]      
 ORDER BY [Product Description]     
 --Select '#Result',* From #Result Where PrdId IN(6079,6093)  
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId      
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #Result   
 SELECT [SalId],BillNo,PrdId,0 AS PrdBatId,[Product Code],[Product Description],0 AS PrdCtgValMainId,0 AS CmpPrdCtgId,0 AS [Batch Number],      
  MRP,MAX([Selling Rate]) AS [Selling Rate],      
  SUM(BilledQtyBox) AS BilledQtyBox,SUM(BilledQtyPouch) AS BilledQtyPouch,SUM(BilledQtyPack)As BilledQtyPack,SUM([Total Qty]) AS [Total Qty],      
  SUM(TotalQtyBox) AS TotalQtyBox,SUM(TotalQtyPouch) AS TotalQtyPouch,SUM(TotalQtyPack) AS TotalQtyPack,SUM([Free Qty]) AS [Free Qty],      
  SUM([Return Qty]) AS [Return Qty],SUM([Replacement Qty]) AS [Replacement Qty],SUM(PrdWeight) AS PrdWeight,SUM([Billed Qty]) AS [Billed Qty],      
  SUM(GrossAmount) AS GrossAmount,SUM(PrdSchemeDisc) AS PrdSchemeDisc,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NETAMOUNT,TotalBills,      
  SUM(TotalDiscount) AS TotalDiscount,SUM(OtherAmt) AS OtherAmt,SUM(AddReduce) AS AddReduce,SUM([Damage]) AS [Damage]       
  INTO #TempLoadingSheet FROM #Result GROUP BY [SalId],BillNo,PrdId,[Product Code],[PRoduct Description],MRP,TotalBills      
  ORDER BY [Product Code]      
 SELECT * FROM #TempLoadingSheet      
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)        
 BEGIN      
  IF EXISTS (Select [Name] From SysObjects Where [Name]='RptLoadSheetItemWiseParle_Excel' And XTYPE='U')      
  Drop Table RptLoadSheetItemWiseParle_Excel      
     SELECT * INTO RptLoadSheetItemWiseParle_Excel FROM #TempLoadingSheet ORDER BY [Product Code]      
     --select * from RptLoadSheetItemWiseParle_Excel    
 END       
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_DailySales]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_DailySales]
GO
/*    
begin tran   
delete from errorlog  
--select * from Cs2Cn_Prk_DailySales (nolock)
update SalesInvoice set upload = 0 where salinvno in('PPL02681702910') 
EXEC Proc_Cs2Cn_DailySales 0,'2017-11-06'    
SELECT LCTRAmount,* FROM Cs2Cn_Prk_DailySales (NOLOCK) where salinvno in('PPL02681702910')  
select * from errorlog  
rollback tran     
*/    
CREATE PROCEDURE [dbo].[Proc_Cs2Cn_DailySales]    
(    
 @Po_ErrNo INT OUTPUT,    
 @ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_DailySales    
* PURPOSE  : To Extract Daily Sales Details from CoreStocky to upload to Console    
* CREATED BY : Nandakumar R.G    
* CREATED DATE : 19/03/2010    
* NOTE   :    
* MODIFIED BY : LAKSHMAN M  
* MODIFIED DATE : 06/11/2017   
* PMS ID   : ICRSTPAR6569  
* PURPOSE  : Daily Sales Details from CoreStocky upload LCTR Calculation Validation changed.    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
21/10/2014 Jisha Mathew Included Undelivered bills New Column Added BillStatus,UploadedDate     
12/12/2015 PRAVEENRAJ BHASKARAN LCTRAmount ADDED FOR CCRSTPAR0118    
09/11/2016 Gopikrishnan RtrUniqueCode Added
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************    
09-01-2018  lakshman M   BZ     ICRSTPAR7284          LCTR Formula velidation changed (special price not consider in LCTR Value).
06-02-2017	MOHANA		 BZ     ICRSTPAR7955      DELVIERED BILLS NOT UPLOADED PROPERLY
*********************************/    
SET NOCOUNT ON    
BEGIN    
 DECLARE @CmpId    AS INT    
 DECLARE @DistCode As nVarchar(50)    
 DECLARE @DefCmpAlone AS INT    
 SET @Po_ErrNo=0    
 DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'Y'    
 IF EXISTS (SELECT * FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2)    
 BEGIN    
  DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2    
 END    
 SELECT @DefCmpAlone=Status FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'    
 SELECT @DistCode = DistributorCode FROM Distributor     
 SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1     
 INSERT INTO Cs2Cn_Prk_DailySales    
 (    
  DistCode  ,    
  SalInvNo  ,    
  SalInvDate  ,    
  SalDlvDate  ,    
  SalInvMode  ,    
  SalInvType  ,    
  SalGrossAmt  ,    
  SalSplDiscAmt ,    
  SalSchDiscAmt ,    
  SalCashDiscAmt ,    
  SalDBDiscAmt ,    
  SalTaxAmt  ,    
  SalWDSAmt  ,    
  SalDbAdjAmt  ,    
  SalCrAdjAmt  ,    
  SalOnAccountAmt ,    
  SalMktRetAmt ,    
  SalReplaceAmt ,    
  SalOtherChargesAmt,    
  SalInvLevelDiscAmt,    
  SalTotDedn  ,    
  SalTotAddn  ,    
  SalRoundOffAmt ,    
  SalNetAmt  ,    
  LcnId   ,    
  LcnCode   ,    
  SalesmanCode ,    
  SalesmanName ,     
  SalesRouteCode ,    
  SalesRouteName ,    
  RtrId   ,    
  RtrCode   ,    
  RtrName   ,    
  VechName  ,    
  DlvBoyName  ,    
  DeliveryRouteCode ,     
  DeliveryRouteName ,     
  PrdCode    ,    
  PrdBatCde   ,    
  PrdQty    ,    
  PrdSelRateBeforeTax ,    
  PrdSelRateAfterTax ,    
  PrdFreeQty  ,    
  PrdGrossAmt  ,    
  PrdSplDiscAmt ,    
  PrdSchDiscAmt ,    
  PrdCashDiscAmt ,    
  PrdDBDiscAmt ,    
  PrdTaxAmt  ,    
  PrdNetAmt  ,    
  UploadFlag  ,    
  SalInvLineCount ,    
  SalInvLvlDiscPer,    
  BillStatus,    
  UploadedDate,    
  OrderRefNo,    
  SFAOrderRefNo,    
  RtrUniqueCode    
 )    
 SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
 (CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
 (CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
 A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
 A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
 A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
 B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
 ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
 G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
 G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
 G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
 'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
 GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,'')     
 FROM SalesInvoice A  (NOLOCK)    
 INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
 INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
 INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
 LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
 LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
 INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
 INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
 INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
 INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
 INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId    
 LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
 WHERE A.Upload=0 ORDER BY A.SalId    
 --UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 --FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 --INNER JOIN (    
 --SELECT SalId,SalInvNo,PrdCCode,CmpBatCode,ISNULL(GrossAmt,0) AS GrossAmt,ISNULL(TaxAmount,0) AS TaxAmount,  
 --ISNULL(GrossAmt+TaxAmount,0) AS LCTRAmt     
 --FROM(    
 --SELECT S.SALID,S.SALINVNO,P.PRDID,P.PRDCCODE,PB.CmpBatCode,SP.BASEQTY,SP.PrdUom1EditedSelRate,  
 --ISNULL((SP.BASEQTY*SP.PrdUom1EditedSelRate),0) AS GrossAmt,    
 --ISNULL(Tax.TaxAmount,0) AS TaxAmount    
 --FROM SalesInvoice S (NOLOCK)    
 --INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId=SP.SALID    
 --INNER JOIN (    
 --SELECT SalId,PrdSlno,SUM(TaxAmount) TaxAmount FROM SalesInvoiceProductTax (NOLOCK)    
 --GROUP BY SalId,PrdSlno    
 --)Tax ON Tax.SalId=S.SalId AND SP.SalId=Tax.SalId AND SP.SlNo=Tax.PrdSlNo    
 --INNER JOIN Product P (NOLOCK) ON P.PrdId=SP.PrdId    
 --INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId AND PB.PrdBatId=SP.PrdBatId    
 --) X    
 --WHERE EXISTS (SELECT SalInvNo,PrdCode,PrdBatCde FROM Cs2Cn_Prk_DailySales Y WHERE     
 --X.SalInvNo=Y.SalInvNo AND X.PrdCCode=Y.PrdCode AND X.CmpBatCode=Y.PrdBatCde)    
 --) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
 ---------- Modified by Lakshman M on 06/11/2017 PMS_ICRSTPAR6569 ------------  
  UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 INNER JOIN (    
    SELECT SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,SUM(TaxableAmount) as TaxableAmount,SUM(LCTRAmt)as LCTRAmt FROM (
    SELECT DISTINCT A.SalId SalID ,A.SalInvNo SalInvNo,B.PrdId PrdId,P.PrdCCode PrdCCode,PB.CmpBatCode CmpBatCode,(C.TaxPerc) As taxperc,  
  (C.TaxableAmount) AS TaxableAmount,--PBD.PrdBatDetailValue,
  ((B.BaseQty *(PBD.PrdBatDetailValue))+((B.BaseQty *(PBD.PrdBatDetailValue))*sum(c.TaxPerc/100)))  As LCTRAmt
  --((B.BaseQty *(round(PBD.PrdBatDetailValue,2)))+((B.BaseQty *(round(PBD.PrdBatDetailValue,2)))*sum(c.TaxPerc/100)))  As LCTRAmt
  --((B.BaseQty *(round(B.PrdUnitSelRate,2)))+(B.PrdTaxAmount))  As LCTRAmt,
  --((B.BaseQty *(round(B.PrdUnitSelRate,2)))+((B.BaseQty *(round(B.PrdUnitSelRate,2)))*sum(c.TaxPerc/100)))  As LCTRAmt
  
  FROM SalesInvoice A (NOLOCK)  
  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.SALID=B.SALID  
  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON A.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo  
  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId  
  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId  
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1	
  INNER JOIN Cs2Cn_Prk_DailySales PRK (NOLOCK)  
  ON PRK.SalInvNo=A.SalInvNo AND PRK.PrdCode=P.PrdCCode AND PRK.PrdBatCde=PB.CmpBatCode  
  where C.TaxableAmount >0 and PBD.SLNo =3 -- AND A.SalInvNo in('PPL41011700683') and PB.PrdId =6802 
  GROUP BY A.SalId,A.SalInvNo,B.PrdId,B.PrdUom1EditedSelRate,C.TaxPerc,P.PrdCCode,PB.CmpBatCode,C.TaxableAmount,B.PrdGrossAmount,B.PrdTaxAmount,
  B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue--,B.PrdUnitSelRate,
  HAVING (SUM(C.TaxableAmount))>0 ) A 
  Group by  SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc    
 ) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
   ----------------- till here --------------------  
 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
 Where ProcId = 1    
 UPDATE A SET SalInvLineCount=B.SalInvLineCount    
 FROM Cs2Cn_Prk_DailySales A,(SELECT SI.SalInvNo,COUNT(SIP.PrdId) AS SalInvLineCount     
 FROM SalesInvoice SI,SalesInvoiceProduct SIP WHERE     
 SI.UPload=0 AND SI.SalId=SIP.SalId    
 GROUP BY SI.SalInvNo) B    
 WHERE A.SalInvNo=B.SalInvNo    
 --->Added By Nanda on 17/08/2010    
 INSERT INTO Cs2Cn_Prk_SalesInvoiceOrders(DistCode,SalInvNo,OrderNo,OrderDate,UploadFlag)    
 SELECT DISTINCT @DistCode,SI.SalInvNo,OB.OrderNo,OB.OrderDate,'N'    
 FROM SalesInvoice SI,SalesinvoiceOrderBooking SIOB,OrderBooking OB    
 WHERE SI.SalId=SIOB.SalId AND SIOB.OrderNo=OB.OrderNo AND SI.Upload=0 AND SI.DlvSts>3  
   
 --->Till Here    
 
 --UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT    
 --SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N') AND Dlvsts IN (3,4,5)   
 
  	--COMMENTED AND ADDED BY MOHANA  ICRSTPAR7955 
	UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT
	 SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N' AND BillStatus in(3,4,5))
	--TILL HERE
	
	UPDATE Cs2Cn_Prk_DailySales SET ServerDate=@ServerDate   

END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_ReturnSplDiscountClaim' AND XTYPE='P')
DROP PROCEDURE Proc_ReturnSplDiscountClaim
GO
/* 
 BEGIN TRAN 
 EXEC Proc_ReturnSplDiscountClaim 0,'2018-04-01','2018-10-05',1,1  
 SELECT * FROM ReturnSplDiscountClaimAmt  
 ROLLBACK TRAN
*/  
CREATE PROCEDURE Proc_ReturnSplDiscountClaim
(  
@Pi_ClmId INT,  
@Pi_FrmDate DateTime,  
@Pi_ToDate DateTime,  
@Pi_CmpId INT,  
@Pi_UsrID INT  
)  
AS  
BEGIN  
/*********************************  
* FUNCTION: Proc_ReturnSplDiscountClaim  
* PURPOSE: Returns the Special Discount Claim  
* NOTES:   
* CREATED: Thrinath Kola 12-12-2007  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------ 
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-03-2018  lakshman M   BZ     ICRSTPAR8158            sales Product id,batch id & base qty script validation added in CS .
09-04-2018	Mohana S	 BZ		ILCRSTPAR0085			Special Discount Claim Value mismatch
14-09-2018  Lakshman M   SR     ILCRSTPAR2050           Special Discount Claim Negative value consider in core stocky script has been changed.
25-09-2018  Vasantharaj  SR     ILCRSTPAR2190           Special Discount claim should load only With Negative and Positive Values (Zero value is not Loaded).
09-10-2018  Amuthakumar  BZ     CRCRSTPAR0031			Ignore Unsaleable Sales Return Products when claim
*********************************/  
 CREATE TABLE #SalesTax  
 (  
  Salid NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
 CREATE TABLE #ReturnSalesTax  
 (  
  ReturnId NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
 DELETE A FROM ReturnSplDiscountClaimAmt A (NOLOCK) WHERE UsrId=@Pi_UsrID  
 INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END ,TaxableAmount   
 FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid  
 WHERE  TaxableAmount>0 and DlvSts in (4,5)  
 AND SI.SalInvDate  Between @Pi_FrmDate and @Pi_ToDate 
 --and SI.SalInvDate Between '2017-02-03' AND '2017-06-03'   
 GROUP BY S.Salid,PrdSlno,TaxableAmount,VatGst ORDER BY Prdslno  
 SELECT Salid,PrdSlno Into #TaxCess   
 FROM #SalesTax   
 GROUP BY Salid,PrdSlno  
 HAVING Count(PrdSlno)>1  
 SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1   
 FROM #SalesTax TT  
 INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno  
 DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno  
 INSERT INTO #ReturnSalesTax(ReturnId,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END,TaxableAmt   
 FROM ReturnProductTax S (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnId=SI.ReturnId  
 WHERE  TaxableAmt>0 and SI.Status=0  
 AND SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate 
 GROUP BY S.ReturnId,PrdSlno,TaxableAmt,VatGst ORDER BY PrdSlno  
 SELECT ReturnId,PrdSlno Into #ReturnTaxCess FROM #ReturnSalesTax   
 GROUP BY ReturnId,PrdSlno  
 HAVING Count(PrdSlno)>1  
 SELECT TT.ReturnId,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1   
 FROM #ReturnSalesTax TT  
 INNER JOIN #ReturnTaxCess T ON T.ReturnId= TT.ReturnId and T.PrdSlNo=TT.PrdSlno  
 DELETE A FROM #ReturnSalesTax  A INNER JOIN #ReturnTaxCess B ON A.ReturnId=B.ReturnId and A.PrdSlno=B.PrdSlno  
  INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
  SELECT A.SalId,A.SalInvno,0 as Status,R.RtrName,  
  SUM(PrdSplDiscAmount) as SpentAmt,  
  ISNULL(SUM(PrdSplDiscAmount*TaxValue),0),   
  ISNULL(SUM(PrdSplDiscAmount)+SUM(PrdSplDiscAmount*TaxValue),0),  
  ISNULL(TaxPerc,0),0 as RecAmt,1,@Pi_UsrID  
  FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceProduct B  (NOLOCK) 
  ON A.SalId = B.SalId INNER JOIN Retailer R ON A.RtrId = R.RtrId   
  INNER JOIN Product P(NOLOCK) ON B.PrdId = P.PrdId  
  LEFT OUTER JOIN #SalesTax PT ON PT.SalId=B.SalId and PT.SalId=A.SalId and PT.PrdSlNo=B.SlNo    
  where B.SPLDiscClaimId IN (0,0) AND P.CmpId = 1 AND   
  A.SalInvDate Between @Pi_FrmDate and @Pi_ToDate    
  --A.SalInvDate Between '2017-02-03' AND '2017-06-03'  
  AND A.Dlvsts in (4,5)  
  GROUP BY A.SalId,A.SalInvno,R.RtrName,TaxPerc  
 --  Having SUM(PrdSplDiscAmount) > 0  ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
  Having SUM(PrdSplDiscAmount) <> 0   -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
  SELECT B.* INTO #ProductBatchDetails FROM  ProductBatch A (NOLOCK)    
  INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
  INNER JOIN BatchCreation C (NOLOCK) ON  
  C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1   
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT SI.SalId,SI.SalInvNo,0 as Status,RT.RtrName,  
	SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) as SpentAmt,  
	ISNULL(SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*TaxValue),0),  
	ISNULL(SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))+SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*TaxValue),0),  
	ISNULL(TaxPerc,0),  
	0.00 as RecAmt,1,@Pi_UsrID  
	from SalesInvoice SI INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN SalesInvoiceProduct SP ON SI.SalID = SP.SalID  
	LEFT OUTER JOIN #SalesTax PT ON PT.SalId=SI.SalId and PT.SalId=SP.SalId and PT.PrdSlNo=SP.SlNo   
	INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	INNER JOIN BatchCreation C (NOLOCK) ON  
	C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	AND B.PriceId=SP.SplPriceId    
	INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	AND D.PriceId=SP.PriceId 
	INNER JOIN BatchCreation E (NOLOCK) ON
	E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	--INNER JOIN Contractpricingmaster CM on CM.ContractId=Sp.splpriceid     
	WHERE   
	SI.SalInvDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.dlvsts in (4,5) AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	AND PR.CmpId= @Pi_CmpId		
	GROUP BY SI.SalId,SI.SalInvNo,RT.RtrName,TaxPerc,sp.prdid,sp.prdbatid,sp.baseqty
	-- Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0   ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) <> 0    -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
	---Sales Return  
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT A.ReturnId,A.ReturnCode,0 as Status,R.RtrName,-1 * SUM(PrdSplDisAmt) as SpentAmt,  
	-1 * ISNULL(SUM(PrdSplDisAmt*TaxValue),0),  ISNULL(-1*(SUM(PrdSplDisAmt)+SUM(PrdSplDisAmt*TaxValue)),0),ISNULL(TaxPerc,0),  
	0 as RecAmt,2,@Pi_UsrID  
	FROM ReturnHeader A   
	INNER JOIN ReturnProduct B  ON A.ReturnId = B.ReturnId  
	AND B.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) --- Added By Amuthakumar on 09/10/2018 CRCRSTPAR0031
	LEFT OUTER JOIN #ReturnSalesTax RS ON  A.ReturnId =RS.ReturnId and RS.ReturnId= B.ReturnId  and RS.PrdSlno=B.Slno  
	INNER JOIN Retailer R ON A.RtrId = R.RtrId    
	INNER JOIN Product P ON B.PrdId = P.PrdId   
	where B.SPLDiscClaimId IN (0,@Pi_ClmId) AND P.CmpId = @Pi_CmpId AND   
	A.ReturnDate Between @Pi_FrmDate AND @Pi_ToDate AND A.Status = 0  
	GROUP BY A.ReturnId,A.ReturnCode,R.RtrName,TaxPerc,B.prdid,B.prdbatid,B.baseqty ---------- Added By Lakshman M On 29-03-2018 Pms id:ICRSTPAR8158   
	-- Having SUM(PrdSplDisAmt) > 0  ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	 Having SUM(PrdSplDisAmt) <> 0   -- PMS ID: ILCRSTPAR2190 ON 25-09-2018  
	
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  --ADDED BY MOHANA ILCRSTPAR0085
	SELECT SI.ReturnId,SI.ReturnCode,0 as Status,RT.RtrName,  
	-1 * SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) as SpentAmt,  
	ISNULL(-1 * SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*Taxvalue) ,0),  
	-1*(ISNULL(SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)),0) +ISNULL(SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*Taxvalue) ,0)),  
	ISNULL(TaxPerc,0),0.00 as RecAmt,2,@Pi_UsrID  
	from ReturnHeader SI   
	INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN ReturnProduct SP ON SI.ReturnId = SP.ReturnId  
	AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) --- Added By Amuthakumar on 09/10/2018 CRCRSTPAR0031
	LEFT OUTER JOIN #ReturnSalesTax RS ON  SI.ReturnId =RS.ReturnId and RS.ReturnId= SP.ReturnId  and RS.PrdSlno=SP.Slno  
	INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	INNER JOIN BatchCreation C (NOLOCK) ON  
	C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	AND B.PriceId=SP.SplPriceId
	INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	AND D.PriceId=SP.PriceId 
	INNER JOIN BatchCreation E (NOLOCK) ON
	E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	where SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.Status = 0 AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	AND PR.CmpId= @Pi_CmpId 
	GROUP BY SI.ReturnId,SI.ReturnCode,RT.RtrName,RS.TaxPerc,sp.prdid,sp.prdbatid,sp.baseqty ---------- Added By Lakshman M On 29-03-2018 Pms id:ICRSTPAR8158
	-- Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0 ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	 Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) <> 0  -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
RETURN  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSchemeUtilization_Parle' AND TYPE='P')
DROP PROCEDURE Proc_RptSchemeUtilization_Parle
GO
/*
BEGIN TRAN
EXEC Proc_RptSchemeUtilization_Parle 246,2,0,'Parle',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptSchemeUtilization_Parle
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE: Proc_RptSchemeUtilization
* PURPOSE: Procedure To Return the Scheme Utilization for the Selected Filters
* NOTES:
* CREATED: Thrinath Kola	30-07-2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*Modified by Praveenraj B For Parle Scheme Utilization Report On 25/01/2012
***************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
12-10-2017  Mohana.S	 CR     CCRSTPAR0175          Showing Slab Details Instead of Slab id 
08-12-2017  Mary.S		 BZ     ICRSTPAR6933          Showing Slab wise Budget utilized Details   
12-12-2017  Mohana.S	 BZ     ICRSTPAR6933          Showing Slab wise Details (all columns)  
***************************************************************************************************/  
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	--Filter Variable
	DECLARE @FromDate	      AS 	DateTime
	DECLARE @ToDate		      AS	DateTime
	DECLARE @fSchId		      AS	Int
	DECLARE @fSMId		      AS	Int
	DECLARE @fRMId		      AS 	Int
	DECLARE @CtgLevelId           AS    	INT
	DECLARE @CtgMainId  	      AS    	INT
	DECLARE @RtrClassId           AS    	INT
	DECLARE @fRtrId		      AS	INT
	DECLARE @TempCtgLevelId       AS    	INT
	
	DECLARE @TempData	TABLE
	(	
		SchId	Int,
		Slabid INT,
		RtrCnt	Int,
		BillCnt	Int
	)
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @CtgLevelId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @CtgMainId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @RtrClassId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	--Till Here
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	
	SELECT DISTINCT Prdid,U.ConversionFactor 
	Into #PrdUomBox
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	--Where Um.UomCode='BX'--Commented and added by Rajesh ICRSTPAR3196
	Where Um.UomCode IN('BX','BOX')
		
	SELECT DISTINCT Prdid,U.ConversionFactor
	Into #PrdUomPack
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	Where  P.PrdId Not In (Select PrdId From #PrdUomBox) And U.BaseUom='Y'
	
	Create Table #PrdUomAll
	(
		PrdId Int,
		ConversionFactor Int
	)
	Insert Into #PrdUomAll
	Select Distinct PrdId,ConversionFactor From #PrdUomBox
	Union All
	Select Distinct PrdId,ConversionFactor From #PrdUomPack
	
CREATE TABLE #RptStoreSchemeDetails
(
	[SchId] [int] NULL,
	[SlabId] [int] NULL,
	[ReferNo] [nvarchar](100) COLLATE DATABASE_DEFAULT  NULL,
	[SMId] [int] NULL,
	[RMId] [int] NULL,
	[DlvRMId] [int] NULL,
	[RtrId] [int] NULL,
	[DlvSts] [int] NULL,
	[VehicleId] [int] NULL,
	[DlvBoyId] [int] NULL,
	[PrdID] [int] NULL,
	[PrdBatId] [int] NULL,
	[FlatAmount] [numeric](38, 6) NULL,
	[DiscountPer] [numeric](38, 6) NULL,
	[Points] [int] NULL,
	[FreePrdId] [int] NULL,
	[FreePrdBatId] [int] NULL,
	[FreeQty] [int] NULL,
	[FreeValue] [numeric](38, 6) NULL,
	[GiftPrdId] [int] NULL,
	[GiftPrdBatId] [int] NULL,
	[GiftQty] [int] NULL,
	[GiftValue] [numeric](38, 6) NULL,
	[SchemeBudget] [numeric](38, 6) NULL,
	[BudgetUtilized] [numeric](38, 6) NULL,
	[Selected] [tinyint] NULL,
	[UserId] [int] NULL,
	[SMName] [nvarchar](200)  COLLATE DATABASE_DEFAULT NULL,
	[RMName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[DlvRMName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[RtrName] [nvarchar](200)  COLLATE DATABASE_DEFAULT  NULL,
	[VehicleName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[DeliveryBoyName] [nvarchar](200)COLLATE DATABASE_DEFAULT   NULL,
	[PrdName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[BatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[FreePrdName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[FreeBatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[GiftPrdName] [nvarchar](200)COLLATE DATABASE_DEFAULT   NULL,
	[GiftBatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[LineType] [int] NULL,
	[ReferDate] [datetime] NULL,
	[CtgLevelId] [int] NULL,
	[CtgLevelName] [nvarchar](200)COLLATE DATABASE_DEFAULT  NULL,
	[CtgMainId] [int] NULL,
	[CtgName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[RtrClassId] [int] NULL,
	[ValueClassName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[BaseQty] [Int],
	[BaseQtyBox] [Int],
	[BaseQtyPack] [Int],
	TAX NUMERIC(38,6)
) ON [PRIMARY]
	
	Create TABLE #RptSchemeUtilizationDet_Parle
	(
		SchId		Int,
		SchCode		nVarChar(100),
		SchDesc		nVarChar(500),
		SlabId		nVarChar(50),
		SchemeBudget	Numeric(38,6),
		BudgetUtilized	Numeric(38,6),
		NoOfRetailer	Int,
		NoOfBills	Int,
		UnselectedCnt	Int,
		FlatAmount	Numeric(38,6),
		DiscountPer	Numeric(38,6),
		Points		Int,
		FreePrdName	nVarchar(200),
		FreeQty		Int,
		[BaseQty] [Int],
		BaseQtyBox	Int,
		BaseQtyPack Int,
		FreeValue	Numeric(38,6),
		GiftPrdName	nVarchar(200),
		GiftQty		Int,
		GiftValue	Numeric(38,6),
		[CircularNo] [Nvarchar](50),
		Tax NUMERIC(38,6)
	)
	SET @TblName = '#RptSchemeUtilizationDet_Parle'
	
	SET @TblStruct = '	SchId		Int,
				SchCode		nVarChar(100),
				SchDesc		nVarChar(500),
				SlabId		nVarChar(10),
				SchemeBudget	Numeric(38,6),
				BudgetUtilized	Numeric(38,6),
				NoOfRetailer	Int,
				NoOfBills	Int,
				UnselectedCnt	Int,
				FlatAmount	Numeric(38,6),
				DiscountPer	Numeric(38,6),
				Points		Int,
				FreePrdName	nVarchar(50),
				FreeQty		Int,
				[BaseQty] [Int],
				BaseQtyBox	Int,
				BaseQtyPack Int,
				FreeValue	Numeric(38,6),
				GiftPrdName	nVarchar(50),
				GiftQty		Int,
				GiftValue	Numeric(38,6)'
	SET @TblFields = 'SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
		NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,BaseQty,BaseQtyBox,BaseQtyPack,FreeValue,
		GiftPrdName,GiftQty,GiftValue'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		EXEC Proc_RptStoreSchemeDetailsSlab @Pi_RptId,@Pi_UsrId --ICRSTPAR6933
	
		--Added By Nanda on 13/02/2009
--		IF @CtgLevelId=0 
--		BEGIN			
--			SELECT @TempCtgLevelId=MAX(CtgLevelId) FROM RetailerCategoryLevel
--		END
--		ELSE
--		BEGIN
			SELECT @TempCtgLevelId=iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)
--		END
		--Till Here
		
			CREATE TABLE #SalesSchemeDetailsTax	
			(
			SalInvNo		nVarChar(100),
			SchId			INT,
			SlabId			INT, 
			PrdId			INT,
			PrdBatId		INT,
			SlNo            INT,
			GSTTax          Numeric(38,6)
			)

			CREATE TABLE #ReturnSchemeDetailsTax	
			(
			SalInvNo		nVarChar(100),
			SchId			INT,
			SlabId			INT, 
			PrdId			INT,
			PrdBatId		INT,
			SlNo            INT,
			GSTTax          Numeric(38,6)
			)

			INSERT INTO #SalesSchemeDetailsTax (SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo ,GSTTax  )
			SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
			SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
			FROM SalesInvoiceSchemeLineWise A(NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)ON A.SalId = B.SalId 
			INNER JOIN SalesInvoiceProductTax C(NOLOCK) ON C.SalId=A.SalId AND C.SalId=B.SalId
			AND C.PrdSlNo=A.RowId
			WHERE DlvSts in (4,5)  AND C.TaxPerc>0.00
			AND B.SalInvDate Between @FromDate AND @tODate
			GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId

	

			INSERT INTO #ReturnSchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
			SELECT B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId,
			Sum((ReturnFlatAmount + ReturnDiscountPerAmount)*(C.TaxPerc/100))*-1
			FROM ReturnSchemeLineDt A (NOLOCK) INNER JOIN ReturnHeader B(NOLOCK) ON A.ReturnId = B.ReturnId 
			INNER JOIN ReturnProductTax C(NOLOCK) ON C.ReturnId=A.ReturnID AND C.ReturnId=B.ReturnID
			AND C.PrdSlno=A.RowId
			WHERE B.Status = 0 AND C.TaxPerc>0.00
			AND B.ReturnDate Between   @FromDate AND @tODate
			GROUP BY B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId

		Insert Into #RptStoreSchemeDetails(SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,RtrId,DlvSts,VehicleId,DlvBoyId,PrdID,PrdBatId,FlatAmount,DiscountPer,
										   Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,GiftQty,GiftValue,SchemeBudget,BudgetUtilized,
										   Selected,UserId,SMName,RMName,DlvRMName,RtrName,VehicleName,DeliveryBoyName,PrdName,BatchName,FreePrdName,FreeBatchName
										   ,GiftPrdName,GiftBatchName,LineType,ReferDate,CtgLevelId,CtgLevelName,CtgMainId,CtgName,RtrClassId,ValueClassName,BaseQty,BaseQtyBox,BaseQtyPack) 
		Select SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,RtrId,DlvSts,VehicleId,DlvBoyId,PrdID,PrdBatId,FlatAmount,DiscountPer,
										   Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,GiftQty,GiftValue,SchemeBudget,BudgetUtilized,
										   Selected,UserId,SMName,RMName,DlvRMName,RtrName,VehicleName,DeliveryBoyName,PrdName,BatchName,FreePrdName,FreeBatchName
										   ,GiftPrdName,GiftBatchName,LineType,ReferDate,CtgLevelId,CtgLevelName,CtgMainId,CtgName,RtrClassId,ValueClassName,0,0,0
										  From RPTStoreSchemeDetails Where Userid = @Pi_UsrId AND BudgetUtilized>0
		
		
		UPDATE A SET Tax = B.GSTTax FROM #RptStoreSchemeDetails A INNER JOIN #SalesSchemeDetailsTax B ON A.SchId = B.SchId AND A.ReferNo = B.SalInvNo AND B.PrdId=A.Prdid 
		AND B.PrdBatId = A.PrdBatid AND A.LineType = 1

		UPDATE A SET Tax = B.GSTTax FROM #RptStoreSchemeDetails A INNER JOIN #returnSchemeDetailsTax B ON A.SchId = B.SchId AND A.ReferNo = B.SalInvNo AND B.PrdId=A.Prdid 
		AND B.PrdBatId = A.PrdBatid AND A.LineType = 2		
		
		--Select Distinct ReferNo,BaseQty,PrdId,PrdBatId Into #RptScheme From #RptStoreSchemeDetails Where LineType<>3 And Userid = @Pi_UsrId
		--Changed By Mohana
		Update X Set X.BaseQty=Sp.BaseQty --Case When FreeValue=0 Then Sp.BaseQty Else 0 End
			From SalesInvoice S
					Inner Join (SELECT A.SalId,slabid,a.PrdId,a.PrdBatId,SUM(BaseQty) AS BaseQty FROM SalesInvoiceProduct A INNER JOIN SalesInvoiceSchemeLineWise B ON 
					A.salid =b.salid and B.Prdid=A.Prdid AND A.prdbatid =B.prdbatid 
					GROUP BY A.SalId,slabid,a.PrdId,a.PrdBatId,slabid) SP On S.SalId=SP.SalId					 
					Inner Join  #RptStoreSchemeDetails X On X.ReferNo=S.SalInvNo And X.PrdID=SP.PrdId And X.PrdBatId=SP.PrdBatId and sp.slabid=x.slabid
					Inner join  #PrdUomAll PU On PU.PrdId=X.PrdID
				 Where X.LineType<>3 
		--SELECT 'lll', * FROM #RptStoreSchemeDetails
--EXEC Proc_RptSchemeUtilization_Parle 237,1,0,'Henkel',0,0,1
		
		--SELECT * FROM #RptStoreSchemeDetails Inner join  #PrdUomAll PU On PU.PrdId=#RptStoreSchemeDetails.PrdID
		--Changed By Mohana
		
		SELECT DISTINCT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.PrdID,SUM(Discountper) Discountper,ISNULL(Sum(BaseQty),0) as BaseQty,
		Case When Isnull(Sum(BaseQty),0)<MAX(ConversionFactor) Then 0 Else Isnull(Sum(BaseQty),0)/MAX(ConversionFactor) End As BaseQtyBox,
		Case When Isnull(Sum(BaseQty),0)<MAX(ConversionFactor) Then Isnull(Sum(BaseQty),0) Else Isnull(Sum(BaseQty),0)%MAX(ConversionFactor) End As BaseQtyPack
		INTO #ProductUOM
		FROM SchemeMaster A INNER JOIN #RPTStoreSchemeDetails B On A.SchId= B.SchId
		AND B.Userid = @Pi_UsrId
		Inner Join #PrdUomAll PU On PU.PrdId=B.PrdID
		WHERE ReferDate Between @FromDate AND @ToDate  AND
		B.LineType <> 3 AND BudgetUtilized>0
		GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.PrdID
		 
 
							   
		INSERT INTO #RptSchemeUtilizationDet_Parle(SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
			NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,BaseQty,BaseQtyBox,BaseQtyPack,FreeValue,
			GiftPrdName,GiftQty,GiftValue,CircularNo,Tax)
		SELECT DISTINCT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,Count(Distinct B.RtrId),
			Count(Distinct B.ReferNo),0 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,
			CASE FreePrdId WHEN 0 THEN dbo.Fn_ConvertCurrency(ISNULL(SUM(B.DiscountPer),0),@Pi_CurrencyId) ELSE '0.00' END as DiscountPer,
			ISNULL(SUM(Points),0) as Points,CASE ISNULL(SUM(FreeQty),0) WHEN 0 THEN '' ELSE FreePrdName END AS FreePrdName,
			CASE FreePrdName WHEN '' THEN 0 ELSE ISNULL(SUM(FreeQty),0)  END as FreeQty,0 as BaseQty,
			 0 as BaseQtyBox,
			0 as BaseQtyPack,
			ISNULL(SUM(FreeValue),0) as FreeValue,
			CASE ISNULL(SUM(GiftValue),0) WHEN 0 THEN '' ELSE GiftPrdName END AS GiftPrdName,ISNULL(SUM(GiftQty),0) as FreeQty,
			ISNULL(SUM(GiftValue),0) as GiftValue,isnull(BudgetAllocationNo,''),CASE A.ApplyTaxForClaim WHEN 1 THEN SUM(tax) ELSE 0 END AS Tax
		FROM SchemeMaster A INNER JOIN #RPTStoreSchemeDetails B On A.SchId= B.SchId
			AND B.Userid = @Pi_UsrId
		Inner Join #ProductUOM PU On PU.PrdId=B.PrdID
		WHERE ReferDate Between @FromDate AND @ToDate  AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @TempCtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (@TempCtgLevelId)) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR
			A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType <> 3 AND BudgetUtilized>0
		GROUP BY A.SchId,B.SlabId,A.SchCode,A.SchDsc,B.SchemeBudget,B.BudgetUtilized,FreePrdId,
			FreePrdName,GiftPrdName,BudgetAllocationNo,ApplyTaxForClaim--,B.PrdID 
		
		UPDATE A SET Discountper=b.Discountper, BaseQty=B.BaseQty,BaseQtyBox=B.BaseQtyBox,BaseQtyPack=B.BaseQtyPack FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		(SELECT SchId,SlabId,SUM(Discountper) Discountper,SUM(BaseQty) BaseQty,SUM(BaseQtyBox) BaseQtyBox,SUM(BaseQtyPack) BaseQtyPack FROM #ProductUOM
		GROUP BY SchId,Slabid
		) B ON A.SchId=B.SchId
		AND A.SlabId=B.SlabId
	 
				
			
		UPDATE A SET A.DiscountPer= (CASE FreePrdName WHEN '' THEN CAST(B.FlatAmt AS NUMERIC(18,2)) ELSE '0.00' END) FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		(SELECT SchId,SlabId,SUM(FlatAmount)+SUM(DiscountPer) AS FlatAmt FROM #RptSchemeUtilizationDet_Parle GROUP BY SchId,SlabId) B
		ON A.SchId=B.SchId AND A.SlabId=B.SlabId
		
		SELECT SchId,SlabId,ReferNo,RtrId INTO #TempBilledDt FROM RptStoreSchemeDetails WHERE LineType <> 3
		
		
		--UPDATE A SET NoOfBills = BillCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		--(SELECT SchId,SlabId,COUNT(DISTINCT ReferNo) AS BillCnt FROM
		--#TempBilledDt GROUP By SchId,SlabId) B ON A.SchId=B.SchId AND A.SlabId=B.SlabId
		
		--UPDATE A SET NoOfRetailer = RtrCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		--(SELECT SchId,SlabId,COUNT(DISTINCT RtrId) AS RtrCnt FROM
		--#TempBilledDt GROUP By SchId,SlabId) B ON A.SchId=B.SchId AND A.SlabId=B.SlabId
				
		DELETE FROM #RptSchemeUtilizationDet_Parle WHERE (BaseQtyBox+BaseQtyPack+FreeQty+GiftQty)<=0
		
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,Slabid,RtrCnt,BillCnt)
		SELECT SchId,B.Slabid, Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B 
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 1
		GROUP BY B.SchId,B.Slabid
		
		UPDATE #RptSchemeUtilizationDet_Parle SET NoOfRetailer = NoOfRetailer,
			NoOfBills = BillCnt FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet_Parle.SchId AND B.Slabid = #RptSchemeUtilizationDet_Parle.SlabId
	
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,Slabid,RtrCnt,BillCnt)
		SELECT SchId,B.Slabid,  Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 3
			AND CAST(B.SchId AS VARCHAR(10))+'~'+CAST(B.SlabId AS VARCHAR(10))+'~'+CAST(B.RtrId AS VARCHAR(10)) NOT IN 
			(Select DISTINCT CAST(SchId AS VARCHAR(10))+'~'+CAST(SlabId AS VARCHAR(10))+'~'+CAST(RtrId AS VARCHAR(10)) FROM #TempBilledDt)
			GROUP BY B.SchId,B.Slabid
			
		UPDATE #RptSchemeUtilizationDet_Parle SET UnselectedCnt = RtrCnt
			FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet_Parle.SchId AND B.Slabid = #RptSchemeUtilizationDet_Parle.SlabId
		
		IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet_Parle ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
				' WHERE ReferDate Between ''' + @FromDate + ''' AND ''' + @ToDate + '''AND '+
				' (SMId = (CASE ' + CAST(@fSMId AS nVarchar(10)) + ' WHEN 0 THEN SMId Else 0 END) OR '+
				' SMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RMId = (CASE ' + CAST(@fRMId AS nVarchar(10)) + ' WHEN 0 THEN RMId Else 0 END) OR '+
				' RMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgLevelId = (CASE ' + CAST(@CtgLevelId AS nVarchar(10)) + ' WHEN 0 THEN CtgLevelId Else 0 END) OR '+
				' CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgMainId = (CASE ' + CAST(@CtgMainId AS nVarchar(10)) + ' WHEN 0 THEN CtgMainId Else 0 END) OR '+
				' CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrClassId = (CASE ' + CAST(@RtrClassId AS nVarchar(10)) + ' WHEN 0 THEN RtrClassId Else 0 END) OR '+
				' RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrID = (CASE ' + CAST(@fRtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrID Else 0 END) OR ' +
				' RtrID in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (SchId = (CASE ' + CAST(@fSchId AS nVarchar(10)) + ' WHEN 0 THEN SchId Else 0 END) OR ' +
				' SchId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',8,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
	
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
					'(SnapId,UserId,RptId,' + @TblFields + ')' +
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSchemeUtilizationDet_Parle'
				
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet_Parle ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			
			
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSchemeUtilizationDet_Parle
	-- Till Here
	--UPDATE A SET BaseQty = B.BaseQty FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	--(SELECT C.SchId,(SUM(B.BaseQty)-SUM(ReturnedQty)) AS BaseQty FROM Salesinvoice A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
	--INNER JOIN 
	--(SELECT DISTINCT ReferNo,B.PrdId,A.SchId,SlabId FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	--A.SchId=B.SchId)C ON A.SalInvNo=C.ReferNo AND B.PrdId=C.PrdId GROUP BY C.SchId,slabid) B ON A.SchId=B.SchId 
	
	UPDATE A SET FreeQty = (CASE FreePrdName WHEN '' THEN 0 ELSE B.FreeQty END) FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	(SELECT C.SchId,(SUM(B.FreeQty)- SUM(ReturnFreeQty)) AS FreeQty FROM Salesinvoice A INNER JOIN SalesInvoiceSchemeDtFreePrd B ON A.SalId=B.SalId
	INNER JOIN 
	(SELECT DISTINCT ReferNo,A.FreePrdId,A.SchId FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	A.SchId=B.SchId AND A.FreePrdId > 0)C ON A.salInvNo=C.ReferNo GROUP BY C.SchId) B ON A.SchId=B.SchId
	
	--UPDATE A SET NoOfBills = B.BillCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	--(SELECT SchId,SUM(BillCnt) As BillCnt FROM 
	--(SELECT  CASE LineType WHEN 1 THEN COUNT(DISTINCT ReferNo) ELSE COUNT(DISTINCT ReferNo) *-1 END 
	--AS BillCnt,A.SchId,LineType FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	--A.SchId=B.SchId AND A.FreePrdId<>0 GROUP BY A.SchId,LineType) A GROUp By SchId) B ON A.SchId=B.SchId
	UPDATE RPT SET RPT.SchCode=S.CmpSchCode FROM #RptSchemeUtilizationDet_Parle RPT INNER JOIN SchemeMaster S ON RPT.SchId=S.SchId 
 
	UPDATE #RptSchemeUtilizationDet_Parle SET DiscountPer = DiscountPer+Tax 
 
	
	
--Added By Mohana	
	SELECT A.SchId ,B.SlabId, CASE B.PurQty WHEN 0 THEN CONVERT (NVARCHAR(20),B.FromQty) + '-' + CONVERT(NVARCHAR(20),B.ToQty)
	ELSE  CONVERT (NVARCHAR(20),B.PurQty) + '-' + CONVERT(NVARCHAR(20),B.ToQty)END Slabdet INTO #SlabDet FROM SchemeMaster A INNER JOIN SchemeSlabs B ON A.SchId = B.SchId
	INNER JOIN #RptSchemeUtilizationDet_Parle R on R.schid=a.schid  and R.schid=b.SchId and R.slabid=b.SlabId 
	UPDATE A SET SlabId = Slabdet FROM #RptSchemeUtilizationDet_Parle A INNER JOIN #SlabDet B ON A.SchId =B.Schid AND A.SlabId = B.slabid
--Till here
	SELECT DISTINCT SchId,SchCode,SchDesc,CircularNo,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,NoOfBills AS NoOfBills ,
	UnselectedCnt,(BaseQtyBox) AS BaseQtyBox,(BaseQtyPack) AS BaseQtyPack,
	DiscountPer,(CASE FreeQty WHEN 0 THEN '-' ELSE FreePrdName END) AS FreePrdName,FreeQty,
    (CASE FreeQty WHEN 0 THEN '0.00' ELSE FreeValue END) AS FreeValue,FlatAmount,Points,(BaseQty) AS BaseQty,
	GiftPrdName,GiftQty,GiftValue
	FROM #RptSchemeUtilizationDet_Parle 
	
	IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
	BEGIN
	IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'RptSchemeUtilizationDet_Parle_Excel') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE RptSchemeUtilizationDet_Parle_Excel
			SELECT DISTINCT SchId,SchCode,SchDesc,CircularNo,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,NoOfBills AS NoOfBills ,
			UnselectedCnt,(BaseQtyBox) AS BaseQtyBox,(BaseQtyPack) AS BaseQtyPack,
			DiscountPer,(CASE FreeQty WHEN 0 THEN '-' ELSE FreePrdName END) AS FreePrdName,FreeQty,
			(CASE FreeQty WHEN 0 THEN '0.00' ELSE FreeValue END) AS FreeValue,FlatAmount,Points,(BaseQty) AS BaseQty,
			GiftPrdName,GiftQty,GiftValue
			INTO RptSchemeUtilizationDet_Parle_Excel FROM #RptSchemeUtilizationDet_Parle Order By SchId
	END 
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSchemeUtilizationWithOutPrimary' AND TYPE='P')
DROP PROCEDURE Proc_RptSchemeUtilizationWithOutPrimary
GO
--EXEC Proc_RptSchemeUtilizationWithOutPrimary 152,2,0,'',0,0,1  
CREATE PROCEDURE Proc_RptSchemeUtilizationWithOutPrimary
(  
 @Pi_RptId  INT,  
 @Pi_UsrId  INT,  
 @Pi_SnapId  INT,  
 @Pi_DbName  nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
SET NOCOUNT ON  
/*********************************  
* PROCEDURE: Proc_RptSchemeUtilizationWithOutPrimary  
* PURPOSE: Procedure To Return the Scheme Utilization for the Selected Filters  
* NOTES:  
* CREATED: Boopathy 08-08-2008  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
*  
*********************************/  
BEGIN  
 DECLARE @NewSnapId  AS INT  
 DECLARE @DBNAME  AS  nvarchar(50)  
 DECLARE @TblName  AS nvarchar(500)  
 DECLARE @TblStruct  AS nVarchar(4000)  
 DECLARE @TblFields  AS nVarchar(4000)  
 DECLARE @sSql  AS  nVarChar(4000)  
 DECLARE @ErrNo   AS INT  
 DECLARE @PurDBName AS nVarChar(50)  
 --Filter Variable  
 DECLARE @FromDate       AS  DateTime  
 DECLARE @ToDate        AS DateTime  
 DECLARE @fSchId        AS Int  
 DECLARE @fSMId        AS Int  
 DECLARE @fRMId        AS  Int  
 DECLARE @CtgLevelId      AS    INT  
 DECLARE @CtgMainId  AS    INT  
 DECLARE @RtrClassId       AS    INT  
 DECLARE @fRtrId        AS INT  
 DECLARE @TempData TABLE  
 (   
  SchId Int,  
  RtrCnt Int,  
  BillCnt Int  
 )  
 --Till Here  
 --Assgin Value for the Filter Variable  
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)  
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)  
 SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))  
 SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))  
 SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))  
 SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))  
 --Till Here  
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)  
 
 CREATE TABLE #RptSchemeUtilization  
 (  
	  SchId  Int,  
	  SchCode  nVarChar(100),  
	  SchDesc  nVarChar(100),  
	  SlabId  nVarChar(10),  
	  BaseQty  INT,  
	  SchemeBudget Numeric(38,6),  
	  BudgetUtilized Numeric(38,6),  
	  NoOfRetailer Int,  
	  NoOfBills Int,  
	  UnselectedCnt Int,  
	  FlatAmount Numeric(38,6),  
	  DiscountPer Numeric(38,6),  
	  Points  Int,  
	  FreePrdName nVarchar(50),  
	  FreeQty  Int,  
	  FreeValue Numeric(38,6),  
	  Total  Numeric(38,6),  
	  Type  INT,
	  GSTTax  Numeric(38,6)
 )  
 
 SET @TblName = 'RptSchemeUtilization'  
 
 SET @TblStruct = ' SchId  Int,  
					SchCode  nVarChar(100),  
					SchDesc  nVarChar(100),  
					SlabId  nVarChar(10),  
					BaseQty  INT,  
					SchemeBudget Numeric(38,6),  
					BudgetUtilized Numeric(38,6),  
					NoOfRetailer Int,  
					NoOfBills Int,  
					UnselectedCnt Int,  
					FlatAmount Numeric(38,6),  
					DiscountPer Numeric(38,6),  
					Points  Int,  
					FreePrdName nVarchar(50),  
					FreeQty  Int,  
					FreeValue Numeric(38,6),  
					Total  Numeric(38,6),  
					Type  INT,
					GSTTax  Numeric(38,6)'  
					
 SET @TblFields = 'SchId,SchCode,SchDesc,SlabId,BaseQty,SchemeBudget,BudgetUtilized,NoOfRetailer,  
  NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,Total,Type,GSTTax'  

	IF @Pi_GetFromSnap = 1  
	BEGIN  
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId  
		SET @DBNAME = @DBNAME  
	END  
	ELSE  
	BEGIN  
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3  
		SET @DBNAME = @PI_DBNAME + @DBNAME  
	END  
 
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data  
 BEGIN  
 
  EXEC Proc_SchemeUtilization @Pi_RptId,@Pi_UsrId  
 
  DELETE FROM RtpSchemeWithOutPrimary WHERE PrdId=0 AND Type<>4  
  
  UPDATE RtpSchemeWithOutPrimary SET selected=0,SlabId=0  

	CREATE TABLE #SalesSchemeDetailsTax	
	(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	SlNo            INT,
	GSTTax          Numeric(38,6)
	)

	CREATE TABLE #ReturnSchemeDetailsTax	
	(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	SlNo            INT,
	GSTTax          Numeric(38,6)
	)

	INSERT INTO #SalesSchemeDetailsTax (SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo ,GSTTax  )
	SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
	SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
	FROM SalesInvoiceSchemeLineWise A(NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)ON A.SalId = B.SalId 
	INNER JOIN SalesInvoiceProductTax C(NOLOCK) ON C.SalId=A.SalId AND C.SalId=B.SalId
	AND C.PrdSlNo=A.RowId
	WHERE DlvSts in (4,5)  AND C.TaxPerc>0.00
	AND B.SalInvDate Between @FromDate AND @tODate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId



	INSERT INTO #ReturnSchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
	SELECT B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId,
	Sum((ReturnFlatAmount + ReturnDiscountPerAmount)*(C.TaxPerc/100))*-1
	FROM ReturnSchemeLineDt A (NOLOCK) INNER JOIN ReturnHeader B(NOLOCK) ON A.ReturnId = B.ReturnId 
	INNER JOIN ReturnProductTax C(NOLOCK) ON C.ReturnId=A.ReturnID AND C.ReturnId=B.ReturnID
	AND C.PrdSlno=A.RowId
	WHERE B.Status = 0 AND C.TaxPerc>0.00
	AND B.ReturnDate Between   @FromDate AND @tODate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId
	
	SELECT SAlinvno,Schid,SUM(GSTTax) Tax INTO #TaxDetails FROM 
	(	
	SELECT SAlinvno,SchId,GSTTax FROM #SalesSchemeDetailsTax
	UNION
	SELECT SAlinvno,SchId,GSTTax FROM #ReturnSchemeDetailsTax
	)A
	GROUP By SAlinvno,Schid
			
			
	  INSERT INTO #RptSchemeUtilization(SchId,SchCode,SchDesc,SlabId,BaseQty,SchemeBudget,BudgetUtilized,NoOfRetailer,  
	  NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,Total,Type,GSTTax)  
	 
	  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.BaseQty,B.SchemeBudget,ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
	  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),Count(Distinct B.RtrId),  
	  Count(Distinct B.ReferNo),1 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,  
	  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId) as DiscountPer,ISNULL(SUM(Points),0) as Points,'' AS FreePrdName,0 AS FreeQty,0 AS FreeValue,  
	  ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+ dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),B.Type,
	  Case A.ApplyTaxForClaim WHEN 1 THEN SUM(Tax) ELSE 0 END AS GSTTax
	  --,CS.GSTTax   
	  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
	  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
	  INNER JOIN #TaxDetails T ON A.Schid = T.Schid AND B.Schid = T.Schid
			AND T.SAlinvno = B.Referno
	  --INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode  
	  WHERE ReferDate Between @FromDate AND @ToDate  AND 
	  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
	  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
	  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=1  
	  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,B.BaseQty,B.Type,ApplyTaxForClaim--,CS.GSTTax 
	  UNION   
	  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,0,B.SchemeBudget,0,0,0,0 as UnSelectedCnt,0 as FlatAmount,0 as DiscountPer,  
	  ISNULL(SUM(Points),0) as Points,CASE ISNULL(SUM(FreeQty),0) WHEN 0 THEN '' ELSE FreePrdName END AS FreePrdName,  
	  ISNULL(SUM(FreeQty),0) as FreeQty,ISNULL(SUM(FreeValue),0) as FreeValue,ISNULL(SUM(FreeValue),0),B.Type,
	  Case A.ApplyTaxForClaim WHEN 1 THEN SUM(Tax) ELSE 0 END AS GSTTax --,CS.GSTTax
	  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId 
	  INNER JOIN #TaxDetails T ON A.Schid = T.Schid AND B.Schid = T.Schid
			AND T.SAlinvno = B.Referno
	  --INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode  
	  WHERE ReferDate Between @FromDate AND @ToDate  AND  
	  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
	  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
	  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=2  
	  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,FreePrdName,B.Type,
	  A.ApplyTaxForClaim --,CS.GSTTax
	  UNION  
	  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,0,B.SchemeBudget,0,0,0,0 as UnSelectedCnt,0 as FlatAmount,0 as DiscountPer,  
	  0 as Points,CASE ISNULL(SUM(GiftValue),0) WHEN 0 THEN '' ELSE GiftPrdName END AS FreePrdName,ISNULL(SUM(GiftQty),0) as FreeQty,ISNULL(SUM(GiftValue),0) 
	  as FreeValue,ISNULL(SUM(GiftValue),0),B.Type,
	  Case A.ApplyTaxForClaim WHEN 1 THEN SUM(Tax) ELSE 0 END AS GSTTax --,CS.GSTTax  
	  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
	  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
	  INNER JOIN #TaxDetails T ON A.Schid = T.Schid AND B.Schid = T.Schid
			AND T.SAlinvno = B.Referno
	  --INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode 
	  WHERE ReferDate Between @FromDate AND @ToDate  AND  
	  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
	  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
	  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=3  
	  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,GiftPrdName,B.Type,ApplyTaxForClaim--,CS.GSTTax  
	  --->Added By Nanda on 09/02/2011  
	  UNION   
	  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.BaseQty,B.SchemeBudget,ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
	  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),Count(Distinct B.RtrId),  
	  Count(Distinct B.ReferNo),1 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,  
	  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId) as DiscountPer,  
	  ISNULL(SUM(Points),0) as Points,'' AS FreePrdName,0 AS FreeQty,0 AS FreeValue,  
	  ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
	  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),B.Type,
	  Case A.ApplyTaxForClaim WHEN 1 THEN SUM(Tax) ELSE 0 END AS GSTTax --,CS.GSTTax  
	  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
	  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
	  --INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode 
	  INNER JOIN #TaxDetails T ON A.Schid = T.Schid AND B.Schid = T.Schid
			AND T.SAlinvno = B.Referno
	  WHERE ReferDate Between @FromDate AND @ToDate  AND  
	  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
	  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
	  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=4  
	  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,B.BaseQty,B.Type,A.ApplyTaxForClaim--,CS.GSTTax
	  --->Till Here 
	   
	  SELECT SchId, CASE LineType WHEN 1 THEN Count(Distinct B.RtrId)  
	  ELSE Count(Distinct B.RtrId)*-1 END AS RtrCnt , CASE LineType WHEN 1 THEN Count(Distinct ReferNo)  
	  ELSE Count(Distinct ReferNo)*-1 END AS BillCnt  
	  INTO #TmpCnt FROM RtpSchemeWithOutPrimary B  
	  WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId AND  
	  (B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR  
	  B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND --B.LineType = 2 AND  
	  B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
	  GROUP BY B.SchId,LineType  
	  
	  DELETE FROM @TempData  
	  
	  INSERT INTO @TempData(SchId,RtrCnt,BillCnt)  
	  SELECT SchId, SUM(RtrCnt),SUM(BillCnt) FROM #TmpCnt  
	  WHERE (SchId = (CASE @fSchId WHEN 0 THEN SchId Else 0 END) OR  
	  SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId)))   
	  GROUP BY SchId  
	  
	  UPDATE #RptSchemeUtilization SET NoOfRetailer = NoOfRetailer - CASE  WHEN RtrCnt <0 THEN RtrCnt ELSE 0 END,  
	  NoOfBills = BillCnt FROM @TempData B WHERE B.SchId = #RptSchemeUtilization.SchId  
	  
  --->Added By Nanda on 09/02/2011  
	  DECLARE @SchIId INT  
	  CREATE TABLE #SchemeProducts1  
	  (  
	   SchID INT,  
	   PrdID INT  
	  ) 
	   
	  DECLARE Cur_SchPrd CURSOR FOR  
	  SELECT SchId FROM #RptSchemeUtilization  
	  OPEN Cur_SchPrd    
	  FETCH NEXT FROM Cur_SchPrd INTO @SchIId  
		  WHILE @@FETCH_STATUS=0    
		  BEGIN    
			   INSERT INTO #SchemeProducts1    
			   SELECT @SchIId,PrdId FROM Fn_ReturnSchemeProductBatch(@SchIId)  
			   FETCH NEXT FROM Cur_SchPrd INTO @SchIId  
		  END    
	  CLOSE Cur_SchPrd    
	  DEALLOCATE Cur_SchPrd  
	    
	  SELECT DISTINCT * INTO #SchemeProducts FROM #SchemeProducts1  
	  --->Till Here  
	  
	  SELECT SchId,PrdId,SUM(BaseQty) AS BaseQty INTO #TmpFinal FROM  
	  (
	  SELECT C.SchId,A.PrdId, A.BaseQty-ReturnedQty AS BaseQty  FROM SalesInvoice D   
	  INNER JOIN SalesInvoiceProduct A ON A.SalId=D.SalId  
	  INNER JOIN SalesInvoiceSchemeHd C ON A.SalId=C.SalId  
	  INNER JOIN #SchemeProducts E ON E.SchId =C.SchId AND A.PrdId=E.PrdId  
	  WHERE D.Dlvsts >3 AND SalInvDate Between @FromDate AND @ToDate  AND  
	  (C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR  
	  C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId)))) tmp  
	  GROUP BY SchId,PrdId

	 SELECT SchId,SUM(BaseQty) As BaseQty INTO #TempFinal1 FROM #TmpFinal   
	 GROUP BY #TmpFinal.SchId  
	 UPDATE #RptSchemeUtilization SET BaseQty = A.BaseQty FROM #TempFinal1 A   
	 WHERE A.SchId = #RptSchemeUtilization.SchId AND #RptSchemeUtilization.Type in (1,2)  
	 UPDATE #RptSchemeUtilization SET NoOfRetailer=0 WHERE NoOfRetailer<0  
  
  
  IF LEN(@PurDBName) > 0  
  BEGIN  
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT  
   SET @SSQL = 'INSERT INTO #RptSchemeUtilization ' +  
    '(' + @TblFields + ')' +  
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +  
    ' WHERE ReferDate Between ''' + @FromDate + ''' AND ''' + @ToDate + '''AND '+  
    ' (SchId = (CASE ' + CAST(@fSchId AS nVarchar(10)) + ' WHEN 0 THEN SchId Else 0 END) OR ' +  
    ' SchId in (SELECT iCountid from Fn_ReturnRptFilters(' +  
    CAST(@Pi_RptId AS nVarchar(10)) + ',8,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'  
   EXEC (@SSQL)  
   PRINT 'Retrived Data From Purged Table'  
  END  
  IF @Pi_SnapRequired = 1  
  BEGIN  
   SELECT @NewSnapId = @Pi_SnapId  
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
   IF @ErrNo = 0  
   BEGIN  
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +  
    '(SnapId,UserId,RptId,' + @TblFields + ')' +  
    ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSchemeUtilization'  
    EXEC (@SSQL)  
    PRINT 'Saved Data Into SnapShot Table'  
   END  
  END  
 END  
 ELSE    --To Retrieve Data From Snap Data  
 BEGIN  
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
  IF @ErrNo = 0  
  BEGIN  
   SET @SSQL = 'INSERT INTO #RptSchemeUtilization ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +  
   ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +  
   ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
   ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))  
   EXEC (@SSQL)  
  PRINT 'Retrived Data From Snap Shot Table'  
  END  
  ELSE  
  BEGIN  
   PRINT 'DataBase or Table not Found'
  END  
 END  
 --Check for Report Data  
 
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId  
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSchemeUtilization
 
 
   
 --UPDATE RPT SET RPT.SchCode=S.CmpSchCode,SchemeBudget=TotalSpent,BudgetUtilized=CS.ClmAmount,DiscountPer=Discount,Total=TotalSpent
 -- FROM #RptSchemeUtilization RPT INNER JOIN SchemeMaster S ON RPT.SchId=S.SchId  
 --INNER JOIN ClaimSheetDetail CS ON S.SchCode=CS.RefCode 
 --update A set SchemeBudget=SchemeBudget+ GSTtax from #RptSchemeUtilization A 
 
 DELETE FROM #RptSchemeUtilization WHERE BaseQty=0 AND SchemeBudget=0 AND BudgetUtilized=0 AND FlatAmount=0 
 AND DiscountPer=0 AND Points=0 AND FreeQty=0 AND FreeValue=0 AND Total=0  
 
 SELECT SchId,SchCode,SchDesc,SlabId,SUM(BaseQty) AS BaseQty,SchemeBudget,CASE WHEN SUM(BudgetUtilized)>0 THEN SUM(BudgetUtilized)+GSTTax ELSE SUM(BudgetUtilized) END AS BudgetUtilized,NoOfRetailer,  
 NoOfBills,UnselectedCnt,CASE WHEN SUM(FlatAmount)>0 THEN SUM(FlatAmount)+GSTTax ELSE SUM(FlatAmount) END AS FlatAmount,CASE WHEN SUM(DiscountPer)>0 THEN SUM(DiscountPer)+GSTTax ELSE SUM(DiscountPer) END AS DiscountPer,Points,  
 FreePrdName,SUM(FreeQty) AS FreeQty,SUM(FreeValue) AS FreeValue,SUM(Total)+GSTTax  AS Total FROM #RptSchemeUtilization  
 GROUP BY SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,  
 NoOfBills,UnselectedCnt,Points,FreePrdName,GSTTax  

 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
 BEGIN  
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptSchemeUtilizationWithOutPrimary_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  
  DROP TABLE RptSchemeUtilizationWithOutPrimary_Excel  
  SELECT SchId,SchCode,SchDesc,SlabId,SUM(BaseQty) AS BaseQty,SchemeBudget,NoOfBills,NoOfRetailer,CASE WHEN SUM(BudgetUtilized)>0 THEN SUM(BudgetUtilized)+GSTTax ELSE SUM(BudgetUtilized) END AS BudgetUtilized,  
  UnselectedCnt,CASE WHEN SUM(FlatAmount)>0 THEN SUM(FlatAmount)+GSTTax ELSE SUM(FlatAmount) END AS FlatAmount,CASE WHEN SUM(DiscountPer)>0 THEN SUM(DiscountPer)+GSTTax ELSE SUM(DiscountPer) END AS DiscountPer,Points,  
  FreePrdName,SUM(FreeQty) AS FreeQty,SUM(FreeValue) AS FreeValue,SUM(Total)+GSTTax AS Total    
  INTO RptSchemeUtilizationWithOutPrimary_Excel FROM #RptSchemeUtilization   
  GROUP BY SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,  
  NoOfBills,UnselectedCnt,Points,FreePrdName ,GSTTax
 END   
 RETURN  
END 
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSchemeUtilization' AND TYPE='P')
DROP PROCEDURE Proc_RptSchemeUtilization
GO
 /*
BEGIN TRAN
EXEC PROC_RptSchemeUtilization 15,2,0,'Parle',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptSchemeUtilization
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE: Proc_RptSchemeUtilization
* PURPOSE: Procedure To Return the Scheme Utilization for the Selected Filters
* NOTES:
* CREATED: Thrinath Kola	30-07-2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	--Filter Variable
	DECLARE @FromDate	      AS 	DateTime
	DECLARE @ToDate		      AS	DateTime
	DECLARE @fSchId		      AS	Int
	DECLARE @fSMId		      AS	Int
	DECLARE @fRMId		      AS 	Int
	DECLARE @CtgLevelId           AS    	INT
	DECLARE @CtgMainId  	      AS    	INT
	DECLARE @RtrClassId           AS    	INT
	DECLARE @fRtrId		      AS	INT
	DECLARE @TempCtgLevelId       AS    	INT
	
	DECLARE @TempData	TABLE
	(	
		SchId	Int,
		RtrCnt	Int,
		BillCnt	Int
	)
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @CtgLevelId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @CtgMainId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @RtrClassId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	--Till Here
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	
	Create TABLE #RptSchemeUtilizationDet
	(
		SchId		Int,
		SchCode		nVarChar(100),
		SchDesc		nVarChar(500),
		SlabId		nVarChar(10),
		SchemeBudget	Numeric(38,6),
		BudgetUtilized	Numeric(38,6),
		NoOfRetailer	Int,
		NoOfBills	Int,
		UnselectedCnt	Int,
		FlatAmount	Numeric(38,6),
		DiscountPer	Numeric(38,6),
		Points		Int,
		FreePrdName	nVarchar(200),
		FreeQty		Int,
		FreeValue	Numeric(38,6),
		GiftPrdName	nVarchar(200),
		GiftQty		Int,
		GiftValue	Numeric(38,6),
		Tax NUMERIC(38,6)
	)
	SET @TblName = 'RptSchemeUtilizationDet'
	
	SET @TblStruct = '	SchId		Int,
				SchCode		nVarChar(100),
				SchDesc		nVarChar(500),
				SlabId		nVarChar(10),
				SchemeBudget	Numeric(38,6),
				BudgetUtilized	Numeric(38,6),
				NoOfRetailer	Int,
				NoOfBills	Int,
				UnselectedCnt	Int,
				FlatAmount	Numeric(38,6),
				DiscountPer	Numeric(38,6),
				Points		Int,
				FreePrdName	nVarchar(50),
				FreeQty		Int,
				FreeValue	Numeric(38,6),
				GiftPrdName	nVarchar(50),
				GiftQty		Int,
				GiftValue	Numeric(38,6)'
	SET @TblFields = 'SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
		NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,
		GiftPrdName,GiftQty,GiftValue'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		EXEC PROC_RPTStoreSchemeDetails @Pi_RptId,@Pi_UsrId
	
		--Added By Nanda on 13/02/2009
--		IF @CtgLevelId=0 
--		BEGIN			
--			SELECT @TempCtgLevelId=MAX(CtgLevelId) FROM RetailerCategoryLevel
--		END
--		ELSE
--		BEGIN
			SELECT @TempCtgLevelId=iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)
--		END
		--Till Here
		
		
		CREATE TABLE #SalesSchemeDetailsTax	
			(
			SalInvNo		nVarChar(100),
			SchId			INT,
			SlabId			INT, 
			PrdId			INT,
			PrdBatId		INT,
			SlNo            INT,
			GSTTax          Numeric(38,6)
			)

			CREATE TABLE #ReturnSchemeDetailsTax	
			(
			SalInvNo		nVarChar(100),
			SchId			INT,
			SlabId			INT, 
			PrdId			INT,
			PrdBatId		INT,
			SlNo            INT,
			GSTTax          Numeric(38,6)
			)

			INSERT INTO #SalesSchemeDetailsTax (SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo ,GSTTax  )
			SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
			SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
			FROM SalesInvoiceSchemeLineWise A(NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)ON A.SalId = B.SalId 
			INNER JOIN SalesInvoiceProductTax C(NOLOCK) ON C.SalId=A.SalId AND C.SalId=B.SalId
			AND C.PrdSlNo=A.RowId
			WHERE DlvSts in (4,5)  AND C.TaxPerc>0.00
			AND B.SalInvDate Between @FromDate AND @tODate
			GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId

	

			INSERT INTO #ReturnSchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
			SELECT B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId,
			Sum((ReturnFlatAmount + ReturnDiscountPerAmount)*(C.TaxPerc/100))*-1
			FROM ReturnSchemeLineDt A (NOLOCK) INNER JOIN ReturnHeader B(NOLOCK) ON A.ReturnId = B.ReturnId 
			INNER JOIN ReturnProductTax C(NOLOCK) ON C.ReturnId=A.ReturnID AND C.ReturnId=B.ReturnID
			AND C.PrdSlno=A.RowId
			WHERE B.Status = 0 AND C.TaxPerc>0.00
			AND B.ReturnDate Between   @FromDate AND @tODate
			GROUP BY B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId
			
			SELECT SAlinvno,Schid,SUM(GSTTax) GSTTax INTO #TaxDetails FROM 
			(	
			SELECT SAlinvno,SchId,GSTTax FROM #SalesSchemeDetailsTax
			UNION
			SELECT SAlinvno,SchId,GSTTax FROM #ReturnSchemeDetailsTax
			)A
			GROUP By SAlinvno,Schid
			
		
			
		INSERT INTO #RptSchemeUtilizationDet(SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
			NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,
			GiftPrdName,GiftQty,GiftValue,Tax)
		SELECT DISTINCT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,Count(Distinct B.RtrId),
			Count(Distinct B.ReferNo),0 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,
			dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId) as DiscountPer,
			ISNULL(SUM(Points),0) as Points,CASE ISNULL(SUM(FreeQty),0) WHEN 0 THEN '-' ELSE FreePrdName END AS FreePrdName,
			ISNULL(SUM(FreeQty),0) as FreeQty,ISNULL(SUM(FreeValue),0) as FreeValue,
			CASE ISNULL(SUM(GiftValue),0) WHEN 0 THEN '-' ELSE GiftPrdName END AS GiftPrdName,ISNULL(SUM(GiftQty),0) as FreeQty,
			ISNULL(SUM(GiftValue),0) as GiftValue,CASE A.ApplyTaxForClaim WHEN 1 THEN SUM(GSTTax) ELSE 0 END
		FROM SchemeMaster A INNER JOIN RPTStoreSchemeDetails B On A.SchId= B.SchId
		INNER JOIN #TaxDetails T ON A.Schid = T.Schid AND B.Schid = T.Schid
		AND T.SAlinvno = B.Referno
			AND B.Userid = @Pi_UsrId
		WHERE ReferDate Between @FromDate AND @ToDate  AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @TempCtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (@TempCtgLevelId)) AND
--			(B.CtgLevelId = (CASE @CtgMainId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
--			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR
			A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType <> 3
		GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,
			FreePrdName,GiftPrdName,ApplyTaxForClaim
		--SELECT * FROM #RptSchemeUtilizationDet	
		 
			
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,RtrCnt,BillCnt)
		SELECT SchId, Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 2
		GROUP BY B.SchId
		UPDATE #RptSchemeUtilizationDet SET NoOfRetailer = NoOfRetailer - RtrCnt,
			NoOfBills = BillCnt FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet.SchId
	
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,RtrCnt,BillCnt)
		SELECT SchId, Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 3
		GROUP BY B.SchId
		UPDATE #RptSchemeUtilizationDet SET UnselectedCnt = RtrCnt
			FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet.SchId
		
		IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
				' WHERE ReferDate Between ''' + @FromDate + ''' AND ''' + @ToDate + '''AND '+
				' (SMId = (CASE ' + CAST(@fSMId AS nVarchar(10)) + ' WHEN 0 THEN SMId Else 0 END) OR '+
				' SMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RMId = (CASE ' + CAST(@fRMId AS nVarchar(10)) + ' WHEN 0 THEN RMId Else 0 END) OR '+
				' RMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgLevelId = (CASE ' + CAST(@CtgLevelId AS nVarchar(10)) + ' WHEN 0 THEN CtgLevelId Else 0 END) OR '+
				' CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgMainId = (CASE ' + CAST(@CtgMainId AS nVarchar(10)) + ' WHEN 0 THEN CtgMainId Else 0 END) OR '+
				' CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrClassId = (CASE ' + CAST(@RtrClassId AS nVarchar(10)) + ' WHEN 0 THEN RtrClassId Else 0 END) OR '+
				' RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrID = (CASE ' + CAST(@fRtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrID Else 0 END) OR ' +
				' RtrID in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (SchId = (CASE ' + CAST(@fSchId AS nVarchar(10)) + ' WHEN 0 THEN SchId Else 0 END) OR ' +
				' SchId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',8,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
	
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
					'(SnapId,UserId,RptId,' + @TblFields + ')' +
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSchemeUtilizationDet'
				
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			
			
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSchemeUtilizationDet
	-- Till Here
	
	--SELECT * FROM #RptSchemeUtilizationDet
	UPDATE RPT SET RPT.SchCode=S.CmpSchCode FROM #RptSchemeUtilizationDet RPT INNER JOIN SchemeMaster S ON RPT.SchId=S.SchId 
	
	UPDATE #RptSchemeUtilizationDet SET  DiscountPer  = DiscountPer+Tax WHERE DiscountPer>0
	UPDATE #RptSchemeUtilizationDet SET  FlatAmount  = FlatAmount+Tax WHERE FlatAmount>0
	
	SELECT SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
	NoOfBills,UnselectedCnt,DiscountPer,FlatAmount,Points,FreePrdName,FreeQty,FreeValue,
	GiftPrdName,GiftQty,GiftValue
	FROM #RptSchemeUtilizationDet
	
 
	
	
	
	IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)
	BEGIN
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptSchemeUtilization_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE RptSchemeUtilization_Excel
		SELECT SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
			NoOfBills,UnselectedCnt,DiscountPer,FlatAmount,Points,FreePrdName,FreeQty,FreeValue,
			GiftPrdName,GiftQty,GiftValue INTO RptSchemeUtilization_Excel FROM #RptSchemeUtilizationDet 
	END 
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptRetailerwiseSchemeUtilization' AND TYPE='P')
DROP PROCEDURE Proc_RptRetailerwiseSchemeUtilization
GO
--EXEC [Proc_RptRetailerwiseSchemeUtilization] 215,2,0,'Nestle',0,0,1
CREATE PROCEDURE Proc_RptRetailerwiseSchemeUtilization
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(100),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
AS
/****************************************************************************************************************
* PROCEDURE  : Proc_RptRetailerwiseSchemeUtilization
* PURPOSE    : To Generate Retailerwise SchemeUtilization Report 
* CREATED BY : Panneerselvam.k
* CREATED ON : 12/11/2009  
* MODIFICATION 
*****************************************************************************************************************   
* DATE			AUTHOR				DESCRIPTION   
* 18.11.2009	Panneerselvam		ValueMismatch
* 26.11.2009    Panneerselvam.k		ValueMismatch
* 19-10-2015    Gopi                SchemeCode,NetAmt,Liability Columns added
*****************************************************************************************************************/ 
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
			/*	Filter Variables  */
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @SMId 		AS	INT
	DECLARE @RMId 		AS	INT
	DECLARE @RtrId 		AS	INT
	DECLARE @CtgLevelId	AS 	INT
	DECLARE @RtrClassId	AS 	INT
	DECLARE @CtgMainId 	AS 	INT
	DECLARE @FromBillNo	AS	INT
	DECLARE @ToBillNo	AS	INT
	DECLARE @Status		AS	INT
	DECLARE @CmpId		AS	INT
	DECLARE @PrdId		AS	INT
	DECLARE	@SchNo		AS	INT
			/*	Till Here	*/
			/*  Assgin Value for the Filter Variable  */
	SELECT	@FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT	@ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET	@SMId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @RMId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))	
	SET @RtrId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @CtgMainId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @FromBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))
	SET @TOBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))
	SET @CtgLevelId =0
	SET @RtrClassId =0
	SET @CtgMainId	=0
IF @FromBillNo = 0 
BEGIN
	SET @FromBillNo =(SELECT Min(SalId) FROM SalesInvoice WHERE SalInvDate Between @FromDate AND @ToDate)
	SET @TOBillNo	=(SELECT Max(SalId) FROM SalesInvoice WHERE SalInvDate Between @FromDate AND @ToDate )
END 
	SET @CmpId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @SchNo	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdId		= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))	
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
			/*  Table Structure  */
	Create TABLE #RptRtrWiseSchUtilization
	(
				SalId			BigInt,
				SalInvNo		NVARCHAR(100),
				SalInvDate		DATETIME,
				RtrId			INT,
				RtrCode			NVARCHAR(200),
				RtrName			NVARCHAR(200),
				SchId			INT,
				SchDsc			NVARCHAR(200),
				PrdId			INT,
				PrdDCode		NVARCHAR(200),
				PrdName			NVARCHAR(200),
				BilledQty		INT,
				PrdUnitSelRate	NUMERIC(38,2),
				PrdUnitMRP		NUMERIC(38,2),		
				GrossValue      NUMERIC(38,2),
				FreeQty			NUMERIC(38,2),
				SchemeValue		NUMERIC(38,6),
				FlatAmount		NUMERIC(38,6),
				DiscountPerAmount	 NUMERIC(38,6),
				PrimarySchemeAmt	  NUMERIC(38,6),
				NetAmt	  NUMERIC(38,6),  ---Gopi at 19-10-2015
				Liability	  NUMERIC(38,2)
	)
	SET @TblName = 'RptRtrWiseSchUtilization'
	SET @TblStruct = '	
				SalId			BigInt,
				SalInvNo		NVARCHAR(100),
				SalInvDate		DATETIME,
				RtrId			INT,
				RtrCode			NVARCHAR(200),
				RtrName			NVARCHAR(200),
				SchId			INT,
				SchDsc			NVARCHAR(200),
				PrdId			INT,
				PrdDCode		NVARCHAR(200),
				PrdName			NVARCHAR(200),
				BilledQty		INT,
				PrdUnitSelRate	NUMERIC(38,2),
				PrdUnitMRP		NUMERIC(38,2),		
				GrossValue      NUMERIC(38,2),
				FreeQty			NUMERIC(38,2),
				SchemeValue		NUMERIC(38,6),
				FlatAmount		NUMERIC(38,6),
				DiscountPerAmount	 NUMERIC(38,6),
				PrimarySchemeAmt	  NUMERIC(38,6),
				NetAmt	  NUMERIC(38,6),
				Liability	  NUMERIC(38,2)'
	SET @TblFields =   'SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchDsc,PrdId,PrdDCode,PrdName,
						BilledQty,PrdUnitSelRate,PrdUnitMRP,GrossValue,FreeQty,SchemeValue,FlatAmount,
						DiscountPerAmount,PrimarySchemeAmt,NetAmt,Liability'
			/* Snap Shot Required  */
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
			/* Till Here  */
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
					
						/*	Calculate Free Quantity  */
					INSERT INTO #RptRtrWiseSchUtilization
					SELECT    
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							A.PrdId,PrdCCode,PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							(FreeQty) FreeQty,
							0 AS SchemeValue,
							0 AS FlatAmount,
							0 AS DiscountPerAmount,
							0 AS PrimarySchemeAmt,
							0 as NetAmt, ---Gopi at 19-10-2015
							0 as Liability 
							
					FROM 
							SalesInvoice SI WITH (NOLOCK),SchemeMaster SM WITH (NOLOCK),
							Retailer R WITH (NOLOCK),Product P WITH (NOLOCK),ProductBatch PB WITH (NOLOCK),
							SalesInvoiceSchemeDtFreePrd SISDF WITH (NOLOCK),SalesInvoiceSchemeDtBilled A WITH (NOLOCK),
							RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK), 
							RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL WITH (NOLOCK)
					WHERE 
							SI.SalId = SISDF.SalId 		AND SI.SalId  = A.SalId AND A.SchId = SISDF.SchId
							AND P.PrdId = Pb.PrdId		AND PB.PrdId = A.PrdId	AND PB.PrdBatId = A.PrdbatId
							AND SI.RtrId = R.RtrId		AND a.SalId = SI.SalId  AND SISDF.SchId  = SM.SchId
							AND A.PrdId = P.PrdId		AND  R.Rtrid = RVCM.RtrId	
							AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND A.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
														a.SalId = B1.SalId AND a.SchId = B1.SchID AND a.SlabId = B1.SlabId)
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
											RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
											RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
											RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND(SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
											SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
											SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND	(SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
											SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND	(SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
											SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
							AND	(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId ELSE 0 END) OR
											A.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							AND(SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
											SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))
							AND	 SI.SalInvDate Between @FromDate AND @ToDate 		
							AND SI.Dlvsts in(4,5)
							
								/*	Calculate Window Display Scheme Amount  */
					INSERT INTO #RptRtrWiseSchUtilization
					SELECT  Distinct
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							0 PrdId, '' PrdDCode,
							'' PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							0 FreeQty,			 
							WD.AdjAmt AS SchemeValue,
							0	FlatAmount,
							0  DiscountPerAmount,
							0  PrimarySchemeAmt,
							0 as NetAmt, ---Gopi at 19-10-2015
							0 as Liability 
					FROM 
							SalesInvoice SI WITH (NOLOCK),SalesInvoiceProduct SIP WITH (NOLOCK),
							SalesInvoiceWindowDisplay WD WITH (NOLOCK),
							Product P WITH (NOLOCK),ProductBatch PB WITH (NOLOCK),Retailer R WITH (NOLOCK),
							SchemeMaster SM WITH (NOLOCK),
							RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK), 
							RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL WITH (NOLOCK)
					WHERE 
							SI.SalId = WD.SalId	AND SI.SalId = WD.SalId		AND WD.SchId	= SM.SchId		
							AND SI.RtrId	= R.RtrId		AND SI.RtrId	= WD.RtrId													
							AND R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
											RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
											RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
										RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND (SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
										SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND (SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
										SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND (SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
										SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND	(SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
										SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
--							AND	(SIP.PrdId = (CASE @PrdId WHEN 0 THEN SIP.PrdId ELSE 0 END) OR
--										SIP.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))							
							AND(SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
										SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))
							AND SI.SalInvDate Between @FromDate AND @ToDate 		
							AND SI.Dlvsts in(4,5)
								/*	Calculate Free Amount  */
				INSERT INTO #RptRtrWiseSchUtilization
				SELECT  
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							SISLW.PrdId,PrdCCode,
							PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							0 FreeQty,				
							Sum(SISLW.FlatAmount+SISLW.DiscountPerAmount) AS SchemeValue,
							Sum(SISLW.FlatAmount)	FlatAmount,
							Sum(DiscountPerAmount)  DiscountPerAmount,
							SUM(SISLW.PrimarySchemeAmt)   PrimarySchemeAmt,
							0 as NetAmt, ---Gopi at 19-10-2015
							0 as Liability 
					FROM 
							SalesInvoice SI,SchemeMaster SM,
							Retailer R,Product P,ProductBatch PB,SalesInvoiceSchemeLineWise SISLW,
							RetailerValueClassMap RVCM ,RetailerValueClass RVC, 
							RetailerCategory RC,RetailerCategoryLevel RCL
					WHERE 
							SISLW.SalId = SI.SalId				AND SISLW.SchId = SM.SchId
							AND P.PrdId = SISLW.PrdId			AND PB.PrdId    = SISLW.PrdId		
							AND PB.PrdBatId = SISLW.PrdBatId	AND Si.RtrId = R.RtrId							
							AND  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
												RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
												RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
												RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND(SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
												SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
												SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND	(SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
												SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND (SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
										SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
							AND	(SISLW.PrdId = (CASE @PrdId WHEN 0 THEN SISLW.PrdId ELSE 0 END) OR
										SISLW.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							AND (SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
										SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))		
							AND	SI.SalInvDate Between @FromDate AND @ToDate 	
							AND SI.Dlvsts in(4,5)
					GROUP BY 
							SI.SalId,SI.SalInvNo,SI.SalInvDate,	SI.RtrId,R.RtrCode,R.RtrName,SM.SchId,SM.SchDsc,
							SISLW.PrdId,PrdCCode,PrdName
							
							
					CREATE TABLE #SalesSchemeDetailsTax	
					(
						SalInvNo		nVarChar(100),
						SchId			INT,
						SlabId			INT, 
						PrdId			INT,
						PrdBatId		INT,
						SlNo            INT,
						GSTTax          Numeric(38,6)
					)

					CREATE TABLE #ReturnSchemeDetailsTax	
					(
						SalInvNo		nVarChar(100),
						SchId			INT,
						SlabId			INT, 
						PrdId			INT,
						PrdBatId		INT,
						SlNo            INT,
						GSTTax          Numeric(38,6)
					)

				INSERT INTO #SalesSchemeDetailsTax (SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo ,GSTTax  )
				SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
				SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
				FROM SalesInvoiceSchemeLineWise A(NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)ON A.SalId = B.SalId 
				INNER JOIN SalesInvoiceProductTax C(NOLOCK) ON C.SalId=A.SalId AND C.SalId=B.SalId
				AND C.PrdSlNo=A.RowId
				WHERE DlvSts in (4,5)  AND C.TaxPerc>0.00
				AND B.SalInvDate Between @FromDate AND @tODate
				GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId

		
 
				
				SELECT SAlinvno,Schid,PrdId,SUM(GSTTax) Tax INTO #TaxDetails FROM 
				(	
				SELECT SAlinvno,SchId,PrdId,GSTTax FROM #SalesSchemeDetailsTax
				)A
				GROUP By SAlinvno,Schid,PrdId
			
			
				UPDATE  A SET SchemeValue = A.SchemeValue+TAX FROM #RptRtrWiseSchUtilization A INNER JOIN #TAXDETAILS B ON A.SchId = B.SCHID
				AND A.SalInvNo = B.SALINVNO AND A.PrdId = B.PRDID AND A.SchemeValue>0
			
			
			
			
		IF LEN(@PurDBName) > 0
			BEGIN
				EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
				
				SET @SSQL = 'INSERT INTO #RptRtrWiseSchUtilization ' +
					'(' + @TblFields + ')' +
					' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
					'WHERE (RCL.CtgLevelId = (CASE ' +  CAST(@CtgLevelId AS INTEGER) + ' WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
							RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',29,' + CAST(@Pi_UsrId as INTEGER) +')))
					
						AND (RC.CtgMainId = (CASE ' +  CAST(@CtgMainId AS INTEGER) + ' WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
							RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',30,' + CAST(@Pi_UsrId as INTEGER) +')))
						
						AND (RVC.RtrClassId = (CASE ' +  CAST(@RtrClassId AS INTEGER) + ' WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
							RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',31,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.RtrId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',3,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.SMId = (CASE ' +  CAST(@SMId AS INTEGER) + ' WHEN 0 THEN SI.SMId ELSE 0 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',1,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.RMId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN SI.RMId ELSE 0 END) OR
							SI.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',8,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.CmpId = (CASE ' +  CAST(@CmpId AS INTEGER) + ' WHEN 0 THEN SI.CmpId ELSE 0 END) OR
							SI.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',4,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SIP.PrdId = (CASE ' +  CAST(@PrdId AS INTEGER) + ' WHEN 0 THEN SIP.PrdId ELSE 0 END) OR
							SIP.PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',5,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SM.SchId = (CASE ' +  CAST(@SchNo AS INTEGER) + ' WHEN 0 THEN SM.SchId ELSE 0 END) OR
							SM.SchId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',258,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.SalInvDate Between ' + @FromDate +' and ' + @ToDate + ')
						AND (SI.SalId Between ' + @FromBillNo +' and ' + @TOBillNo +')'
				EXEC (@SSQL)
				PRINT 'Retrived Data From Purged Table'
			END
			IF @Pi_SnapRequired = 1
			   BEGIN
				SELECT @NewSnapId = @Pi_SnapId
				EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
					@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
				IF @ErrNo = 0
				   BEGIN
					SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
						'(SnapId,UserId,RptId,' + @TblFields + ')' +
						' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
						' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
						' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptRtrWiseSchUtilization'
			
					EXEC (@SSQL)
					PRINT 'Saved Data Into SnapShot Table'
				   END
			   END
		end
		ELSE				--To Retrieve Data From Snap Data
		BEGIN
			EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
					@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			PRINT @ErrNo
			IF @ErrNo = 0
			   BEGIN
				SET @SSQL = 'INSERT INTO #RptRtrWiseSchUtilization ' +
					'(' + @TblFields + ')' +
					' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
					' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
					' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
				EXEC (@SSQL)
				PRINT 'Retrived Data From Snap Shot Table'
			   END
			ELSE
			   BEGIN
				PRINT 'DataBase or Table not Found'
			   END
		END
			--Check for Report Data
			Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptRtrWiseSchUtilization
			-- Till Here
	
				UPDATE #RptRtrWiseSchUtilization SET BilledQty = B.BaseQty,PrdUnitMRP = B.PrdUnitMRP,PrdUnitSelRate = B.PrdUnitSelRate
				FROM #RptRtrWiseSchUtilization a,SalesInvoiceProduct B
				WHERE B.SalId = A.SalId AND B.PrdId = A.PrdId
				
				SELECT SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,R.SchId,SchCode,
				R.SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,
				BilledQty*PrdUnitSelRate AS Grossvalue,
				Sum(FreeQty) FreeQty,Sum(SchemeValue) SchemeValue,
				Sum(FlatAmount) AS FlatAmount,
				Sum(DiscountPerAmount) AS DiscountPerAmount,
				Sum(PrimarySchemeAmt) AS PrimarySchemeAmt,CmpSchCode AS CompSchCode,
				NetAmt,Liability,0 as Tax  ---Gopi at 19-10-2015
			    INTO #TmpFinOpShemem
				FROM #RptRtrWiseSchUtilization R INNER JOIN SchemeMaster S ON  R.SchId=S.SchId
				GROUP BY SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,R.SchId,SchCode,R.SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,CmpSchCode,NetAmt,Liability
				ORDER BY SalId
				
				SELECT DISTINCT D.SalId,D.SchId,D.PrdId,PrdBatDetailValue,
						E.FreePrdId,
						E.FreeQty FreeQty,
						E.FreeQty * PrdBatDetailValue FreeQtyValue INTO #TmpFre1111
						FROM  BatchCreation  A WITH (NOLOCK),ProductBatchDetails B WITH (NOLOCK),
							  ProductBatch C WITH (NOLOCK),
							  #TmpFinOpShemem D,SalesInvoiceSchemeDtFreePrd E WITH (NOLOCK)
						WHERE A.BatchSeqId = B.BatchSeqId AND A.SlNo = B.SLNo
						AND A.SlNo =4  AND A.ClmRte = 1 AND B.PrdBatId = C.PrdBatId AND D.FreeQty > 0
						AND D.SalId = E.SalId AND D.SchId = E.SchId	AND E.FreePrdId = C.PrdId
						AND E.FreePrdBatId = C.PrdBatId
						
				SELECT SalId,SchId,PrdId,Sum(FreeQty) FreeQty,
						Sum(FreeQtyValue) FreeQtyValue INTO #TmpFinFreeVal
						FROM #TmpFre1111
				GROUP BY SalId,SchId,PrdId
				
				UPDATE #TmpFinOpShemem SET Tax=B.PrdTaxAmount  ---Gopi at 19-10-2015
				FROM #TmpFinOpShemem a,SalesInvoiceProduct B
				WHERE B.SalId = A.SalId AND B.PrdId = A.PrdId
				
				UPDATE #TmpFinOpShemem  SET SchemeValue = SchemeValue + FreeQtyValue
								FROM #TmpFinOpShemem A,#TmpFinFreeVal  B
								WHERE A.SalId = B.SalId AND A.SchId = B.SchId 
								AND A.PrdId = B.PrdId   
								
				Update #TmpFinOpShemem set NetAmt=Grossvalue+Tax  ---Gopi at 19-10-2015
				Update #TmpFinOpShemem set Liability=(DiscountPerAmount/NetAmt)  ---Gopi at 19-10-2015
			
				SELECT SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchCode,SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,
				BilledQty*PrdUnitSelRate AS Grossvalue,
				Sum(FreeQty) FreeQty,Sum(SchemeValue) SchemeValue,
				Sum(FlatAmount) AS FlatAmount,
				Sum(DiscountPerAmount) AS DiscountPerAmount,
				Sum(PrimarySchemeAmt) AS PrimarySchemeAmt,CompSchCode,
				SUM(NetAmt) AS NetAmt,Liability ---Gopi at 19-10-2015
				FROM #TmpFinOpShemem 
				GROUP BY SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchCode,SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,CompSchCode,Liability
				ORDER BY SalId,SalInvNo
RETURN
END
GO
--Added by Amuthan
----Updates in HF 437 ---- Amuthakumar 
DELETE FROM ManualConfiguration WHERE ProjectName ='PARLE' AND ModuleId ='Report_withTax'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','Report_withTax','Report with Tax','Enable Tax Applicable in Reports ',1,'',0,1
GO
DELETE FROM HotSearchEditorDt WHERE FormId=448 
INSERT INTO HotSearchEditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
SELECT 1,448,'Return Product','Name','PrdName',1500,0,'HotSch-24-2000-36',24 UNION 
SELECT 2,448,'Return Product','Short Name','PrdShrtName',1000,0,'HotSch-24-2000-37',24 UNION
SELECT 3,448,'Return Product','Dist Code','PrdDCode',800,0,'HotSch-24-2000-1',24  UNION 
SELECT 4,448,'Return Product','Comp Code','PrdCCode',800,0,'HotSch-24-2000-2',24 
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT DISTINCT P.PrdId,PrdName,PrdShrtName,PrdDcode,PrdCCode FROM Product P (NOLOCK) 
INNER JOIN Productbatch PB ON P.PrdId = PB.PrdId 
WHERE PrdType<>3 AND PrdStatus = 1 AND PrdCtgValMainId IN ( SELECT A.PrdCtgValMainId FROM ProductCategoryValue A (NOLOCK) 
INNER JOIN Fn_ReturnToLoadProductCategory() B ON A.PrdCtgValLinkCode=B.PrdCtgValLinkCode)' WHERE FormId=448 and ControlName='Return Product'
GO
DELETE FROM HotSearchEditorDt WHERE FormId=452 
INSERT INTO HotSearchEditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
SELECT 1,452,'Replacement Product','Name','PrdName',1500,0,'HotSch-24-2000-32',24 UNION 
SELECT 2,452,'Replacement Product','Short Name','PrdShrtName',1000,0,'HotSch-24-2000-33',24 UNION
SELECT 3,452,'Replacement Product','Dist Code','PrdDCode',800,0,'HotSch-24-2000-16',24  UNION 
SELECT 4,452,'Replacement Product','Comp Code','PrdCCode',800,0,'HotSch-24-2000-17',24 
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT DISTINCT P.PrdId,PrdName,PrdShrtName,PrdDcode,PrdCCode FROM Product P (NOLOCK) 
INNER JOIN Productbatch PB (NOLOCK) ON P.PrdId = PB.PrdId 
INNER JOIN ProductBatchLocation PBL (NOLOCK) ON PB.PrdBatId = PBL.PrdBatID AND PB.PrdId = PBL.PrdId
WHERE PrdType<>3 AND PrdStatus = 1 AND  (PrdBatLcnSih - PrdBatLcnRessih) > 0  
AND PrdCtgValMainId IN (SELECT A.PrdCtgValMainId FROM ProductCategoryValue A (NOLOCK) 
INNER JOIN Fn_ReturnToLoadProductCategory() B ON A.PrdCtgValLinkCode=B.PrdCtgValLinkCode)' WHERE FormId=452 and ControlName='Replacement Product'
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptRailwayDiscountReconsolidation_withTax' AND TYPE ='P')
DROP PROCEDURE Proc_RptRailwayDiscountReconsolidation_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptRailwayDiscountReconsolidation_withTax 288,2,0,'Parle',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_RptRailwayDiscountReconsolidation_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*****************************************************************************************************************************
* PROCEDURE	: Proc_RptRailwayDiscountReconsolidation_withTax
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
******************************************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. IRCTC rate should display the net rate in billing screen   
 14-12-2017   S.Mohana    CR			ICRSTPAR7049	    Corrected Excel Column values.
 26-12-2017	  S.MOHANA	  SR			ICRSTPAR7809		1.Changed Column Name (IRCTC --> Chain And LCTR --> Normal rate)
															2.REMOVED TAX CALCULATION
															3.ADDED RATE-SCHEMEDISCOUNT 
 11-07-2018   Lakshman M  BZ            ILCRSTPAR1325       Negative values division validation added from core stocky.
 17-09-2018   Amuthakumar CR            CRCRSTPAR0021       Promotion claim should be calculating with tax
******************************************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	 
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,RC.CtgName
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT')
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
 
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	--- Till Here
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,CAST(CAST(SP.PrdUom1NetRate AS NUMERIC(18,4))/Uom1ConvFact AS NUMERIC(18,4)) PrdUnitNetRate,CAST((SP.PrdSchDiscAmount/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN  @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,CAST(SIP.PrdUom1NetRate AS NUMERIC(18,4))/SIP.Uom1ConvFact PrdUnitNetRate,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	INSERT INTO #ReturnDetails
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
	CAST((PrdGrossAmt-(PrdSplDisAmt+PrdSchDisamt+PrdCDDisAmt)+PrdTaxAmt)/CAST(BaseQty AS NUMERIC(18,6)) AS NUMERIC(18,4))  AS PrdUnitNetRate,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc 
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
	AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	--SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	--SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	--INTO #ReturnDetails
	--FROM ReturnHeader S (NOLOCK)
	--INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	--WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc,CAST(0 AS NUMERIC(18,6))[SellRate],
	CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) ChainRate
	INTO #RailwaySalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc FROM #ReturnDetails
	
	) Consolidated
	
	DECLARE @SlNo AS INT
	
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  + (D.PrdBatDetailValue *(T.TaxPerc/100)),
	R.SchDisc =  R.SchDisc  + (R.SchDisc *(T.TaxPerc/100))   
	FROM #RailwaySalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK),
	 #ParleOutputTaxPercentage T 
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	AND R.TransType = T.TRANSID AND R.SALID =T.SALID AND R.SLNO=T.PRDSLNO
	
	
	
	--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
	--INTO #ExistingSpecialPrice
	--FROM #RailwaySalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #FilterProduct N (NOLOCK) WHERE P.PrdId = N.Prdid)	
	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice  WHERE Prdid in (SELECT PrdId FROM #FilterProduct)
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	
	UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]
	FROM #RailwaySalesDetails R (NOLOCK),
	#LatesSpecialPrice S (NOLOCK)
	WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid
	
	--- Added by Amuthakumar on 17-09-2018  CRCRSTPAR0021
--	UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
--	FROM #RailwaySalesDetails R (NOLOCK),
--	#ParleOutputTaxPercentage T (NOLOCK)
--	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	--UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
	--- Till Here CRCRSTPAR0021
	
	UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
		
	--UPDATE R SET R.ChainRate = SplSelRate-SchDisc 	FROM #RailwaySalesDetails R (NOLOCK) INNER JOIN #LatesSpecialPrice S (NOLOCK)
	--ON R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid
	
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #RailwaySalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #RailwaySalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	UPDATE M SET M.ChainRate = D.PrdBatDetailValue + (D.PrdBatDetailValue*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#SpecialPrice_New D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno	AND M.PriceId = D.PriceId  
	
	
	--UPDATE M SET M.ChainRate = D.PrdBatDetailValue-SchDisc 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--#SpecialPrice_New D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId  
	  
	 
	UPDATE R SET R.ChainRate = (R.[SellRate]-SchDisc) --ROUND((R.[SellRate]-SchDisc),2,1) 
	FROM #RailwaySalesDetails R (NOLOCK)  WHERE ChainRate=0
	 	

	--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,
	
	--SELECT Ctgname,P.PrdId,P.PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	--LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	--ChainRate,
	--CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	--CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	--INTO #RailwayDiscount
	--FROM #RailwaySalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid
	--GROUP BY Ctgname,P.PrdId,P.PrdName,MRP,LCTR,IRCTCMargin,S.[Type],PrdUnitNetRate,ChainRate
		
	---------------

	SELECT Ctgname,P.PrdId,P.PrdName,(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	ChainRate,
	CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	INTO #RailwayDiscount1
	FROM #RailwaySalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid
	-----
	--UPDATE R SET R.IRCTCRate = MRP - (MRP * IRCTCMargin / 100.00), 
	--UPDATE R SET R.IRCTCRate = PrdUnitNetRate, 
	UPDATE R SET TotalMRP  = TotalPCS * MRP, 
	TotalLCTR = TotalPCS * NormalRate
	FROM #RailwayDiscount1 R (NOLOCK)
	--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
	
	UPDATE R SET R.IRCTCTotal = TotalPCS * ChainRate
	FROM #RailwayDiscount1 R (NOLOCK)
	 
	
	UPDATE R SET R.ClmAmount = ROUND((TotalLCTR - IRCTCTotal),2)
	FROM #RailwayDiscount1 R (NOLOCK)
	
	UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalMRP <> 0
	
	UPDATE R SET LibOnMRP = -1* LibOnMRP
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	
	UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalLCTR <> 0	
	
	UPDATE R SET LibOnLCTR = -1* LibOnLCTR
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	 
------------ Till Here ---------------

	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptRailwayDiscountReconsolidation_Excel')
	DROP TABLE RptRailwayDiscountReconsolidation_Excel	
	
	SELECT Ctgname,PrdId,PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,CAST(NormalRate  AS NUMERIC(18,2)) NormalRate,IRCTCMargin As ChainMargin,MarkUpDown,
	CAST(ChainRate  AS NUMERIC(18,2)) ChainRate,--- Sum off validation removed after changing in with tax report By lakshman M : Amuthakumar PMS : CRCRSTPAR0021
	SUM(TotalMRP) TotalMRP,CAST (SUM(TotalLCTR)  AS NUMERIC(18,2)) TotalLCTR,CAST((ROUND(SUM(IRCTCTotal),2)) AS NUMERIC(18,2)) IRCTCTotal 
	,CAST(SUM(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(SUM(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (SUM(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR
	INTO RptRailwayDiscountReconsolidation_Excel
	FROM #RailwayDiscount1 (NOLOCK) 
	GROUP BY Ctgname,PrdId,PrdName,PrdUnitNetRate,MRP,NormalRate,IRCTCMargin,ChainRate,MarkUpDown 
	ORDER BY PrdName
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptRailwayDiscountReconsolidation_Excel
	
	SELECT * FROM RptRailwayDiscountReconsolidation_Excel ORDER BY PrdName,MarkUpDown
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'TotalPCS','Total PCS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'PrdUnitNetrate','PrdUnitNetrate',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'Normal Rate','Normal Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'IRCTCMargin','Chain Margin',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'MarkUpDown','MarkUp /Mark Down',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'Chain Rate','Chain Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalMRP','Parle Total MRP Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalLCTR','Parle Total Normal Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'IRCTCTotal','Chain Total Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'ClmAmount','Claim Amount',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'LibOnMRP','% Lib On MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'LibOnLCTR','% Lib On Total NormalRate',1,1)
	RETURN	
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='PROC_RPTRAILWAYDISCOUNTRECONSOLIDATION' AND XTYPE ='P')
DROP PROCEDURE PROC_RPTRAILWAYDISCOUNTRECONSOLIDATION
GO
/*
BEGIN TRAN
EXEC Proc_RptRailwayDiscountReconsolidation 288,2,0,'Parle',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptRailwayDiscountReconsolidation
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/**************************************************************************************************
* PROCEDURE	: Proc_RptTradePromotionReport
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. IRCTC rate should display the net rate in billing screen   
 14-12-2017   S.Mohana    CR			ICRSTPAR7049	    Corrected Excel Column values.
 26-12-2017	  S.MOHANA	  SR			ICRSTPAR7809		1.Changed Column Name (IRCTC --> Chain And LCTR --> Normal rate)
															2.REMOVED TAX CALCULATION
															3.ADDED RATE-SCHEMEDISCOUNT 
 11-07-2018   Lakshman M  BZ            ILCRSTPAR1325       negative values division validation added from core stocky.	
 27-09-2018   Amuthakumar CR            CRCRSTPAR0031       Enable Configuration with Tax in Reports
 24-10-2018   Lakshman M  BZ            ILCRSTPAR2414       category wise Sum off values chain rate amount validation removed in Report.														
***************************************************************************************************/  
BEGIN
	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_RptRailwayDiscountReconsolidation_withTax @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	SET NOCOUNT ON
	
	DECLARE  @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT  @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	 
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,RC.CtgName
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT')
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
--	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
--	SELECT * INTO #ParleOutputTaxPercentage
--	FROM ParleOutputTaxPercentage (NOLOCK)	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,CAST(CAST(SP.PrdUom1NetRate AS NUMERIC(18,4))/Uom1ConvFact AS NUMERIC(18,4)) PrdUnitNetRate,CAST((SP.PrdSchDiscAmount/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc

	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN  @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,CAST(SIP.PrdUom1NetRate AS NUMERIC(18,4))/SIP.Uom1ConvFact PrdUnitNetRate,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	INSERT INTO #ReturnDetails
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
	CAST((PrdGrossAmt-(PrdSplDisAmt+PrdSchDisamt+PrdCDDisAmt)+PrdTaxAmt)/CAST(BaseQty AS NUMERIC(18,6)) AS NUMERIC(18,4))  AS PrdUnitNetRate,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc 
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
	AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	
	
	--SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	--SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	--INTO #ReturnDetails
	--FROM ReturnHeader S (NOLOCK)
	--INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	--WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc,CAST(0 AS NUMERIC(18,6))[SellRate],
	CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) ChainRate
	INTO #RailwaySalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc FROM #ReturnDetails
	
	) Consolidated
	
	DECLARE @SlNo AS INT
	
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE R SET R.[SellRate] = D.PrdBatDetailValue
	FROM #RailwaySalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
	--INTO #ExistingSpecialPrice
	--FROM #RailwaySalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #FilterProduct N (NOLOCK) WHERE P.PrdId = N.Prdid)	
	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice  WHERE Prdid in (SELECT PrdId FROM #FilterProduct)
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	
	UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]
	FROM #RailwaySalesDetails R (NOLOCK),
	#LatesSpecialPrice S (NOLOCK)
	WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid
	--UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
	--FROM #RailwaySalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	
	UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
		
	--UPDATE R SET R.ChainRate = SplSelRate-SchDisc 	FROM #RailwaySalesDetails R (NOLOCK) INNER JOIN #LatesSpecialPrice S (NOLOCK)
	--ON R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid
	
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #RailwaySalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #RailwaySalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	UPDATE M SET M.ChainRate = D.PrdBatDetailValue-SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#SpecialPrice_New D (NOLOCK) 
	WHERE M.PriceId = D.PriceId  
	 
	 
	 
	UPDATE R SET R.ChainRate = (R.[SellRate]-SchDisc) --ROUND((R.[SellRate]-SchDisc),2,1) 
	FROM #RailwaySalesDetails R (NOLOCK)  WHERE ChainRate=0
	 	
	--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,
	
	--SELECT Ctgname,P.PrdId,P.PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	--LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	--ChainRate,
	--CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	--CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	--INTO #RailwayDiscount
	--FROM #RailwaySalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid
	--GROUP BY Ctgname,P.PrdId,P.PrdName,MRP,LCTR,IRCTCMargin,S.[Type],PrdUnitNetRate,ChainRate
		
	-----
	SELECT Ctgname,P.PrdId,P.PrdName,(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	ChainRate,
	CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	INTO #RailwayDiscount1
	FROM #RailwaySalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid
	-----
	--UPDATE R SET R.IRCTCRate = MRP - (MRP * IRCTCMargin / 100.00), 
	--UPDATE R SET R.IRCTCRate = PrdUnitNetRate, 
	UPDATE R SET TotalMRP  = TotalPCS * MRP, 
	TotalLCTR = TotalPCS * NormalRate
	FROM #RailwayDiscount1 R (NOLOCK)
	--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
	
	UPDATE R SET R.IRCTCTotal = TotalPCS * ChainRate
	FROM #RailwayDiscount1 R (NOLOCK)
	 
	
	UPDATE R SET R.ClmAmount = ROUND((TotalLCTR - IRCTCTotal),2)
	FROM #RailwayDiscount1 R (NOLOCK)
	
	UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalMRP <> 0
	
	UPDATE R SET LibOnMRP = -1* LibOnMRP
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	
	UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalLCTR <> 0	
	
	UPDATE R SET LibOnLCTR = -1* LibOnLCTR
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	 
------------ Till Here ---------------
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptRailwayDiscountReconsolidation_Excel')
	DROP TABLE RptRailwayDiscountReconsolidation_Excel	
	
	SELECT Ctgname,PrdId,PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,CAST(NormalRate  AS NUMERIC(18,2)) NormalRate,IRCTCMargin As ChainMargin,MarkUpDown,
	CAST(ChainRate  AS NUMERIC(18,2)) ChainRate, --- Sum off validation removed By lakshman M Dated ON:24-10-2018 PMS ID: ILCRSTPAR2414
	SUM(TotalMRP) TotalMRP,CAST (SUM(TotalLCTR)  AS NUMERIC(18,2)) TotalLCTR,CAST ((ROUND(SUM(IRCTCTotal),2)) AS NUMERIC(18,2)) IRCTCTotal 
	,CAST(SUM(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(SUM(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (SUM(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR
	INTO RptRailwayDiscountReconsolidation_Excel
	FROM #RailwayDiscount1 (NOLOCK) 
	GROUP BY Ctgname,PrdId,PrdName,PrdUnitNetRate,MRP,NormalRate,IRCTCMargin,ChainRate,MarkUpDown 
	ORDER BY PrdName
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptRailwayDiscountReconsolidation_Excel
	
	SELECT * FROM RptRailwayDiscountReconsolidation_Excel ORDER BY PrdName,MarkUpDown
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'TotalPCS','Total PCS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'PrdUnitNetrate','PrdUnitNetrate',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'Normal Rate','Normal Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'IRCTCMargin','Chain Margin',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'MarkUpDown','MarkUp /Mark Down',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'Chain Rate','Chain Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalMRP','Parle Total MRP Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalLCTR','Parle Total Normal Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'IRCTCTotal','Chain Total Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'ClmAmount','Claim Amount',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'LibOnMRP','% Lib On MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'LibOnLCTR','% Lib On Total NormalRate',1,1)
	RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax' AND TYPE ='P')
DROP PROCEDURE Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax
GO
/*  
Begin transaction
truncate table Cs2Cn_Prk_RailwayDiscountReconsolidation  
update A set upload =0,rptupload =0 from salesinvoice A  where SalInvDate between '2018-03-01' and '2018-03-31'
update a set upload =0,RptUpload=0 from ReturnHeader a where returndate between '2018-03-01' and '2018-03-31'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax 0,'2018-07-11'  
--select * from UploadingReportTransaction
select * from Cs2Cn_Prk_RailwayDiscountReconsolidation  for xml AUTO --where PrdCCode ='100301301079070190PKT10010N'  
Rollback Transaction  
*/  
CREATE PROCEDURE Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax
(  
@Po_ErrNo INT OUTPUT,  
@ServerDate DATETIME  
)  
AS  
/***********************************************************************************************************************
* PROCEDURE  : Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax   
* PURPOSE  :   
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :  
* MODIFIED  
************************************************************************************************************************
* DATE        AUTHOR		CR/BZ			USER STORY ID       DESCRIPTION   
27-03-2018   S.MOhana		CR				CCRSTPAR0188		Included reports changes in upload
11-07-2018   Lakshman M		BZ				ILCRSTPAR1325       negative values division validation added from core stocky.
17-09-2018   Amuthakumar	CR				CRCRSTPAR0021       Promotion claim should be calculating with tax
************************************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
SET @Po_ErrNo=0  
DECLARE @DistCode   As NVARCHAR(50)  
DELETE FROM Cs2Cn_Prk_RailwayDiscountReconsolidation WHERE UploadFlag = 'Y'  

TRUNCATE TABLE UploadingReportTransaction  

INSERT INTO UploadingReportTransaction (TransType,TransId,TransNo,TransDate)  
SELECT 1,SalId,SalInvNo,SalInvDate FROM SalesInvoice (NOLOCK) WHERE DlvSts > 3 AND RptUpload = 0  
UNION ALL  
SELECT 2,ReturnID,ReturnCode,ReturnDate FROM ReturnHeader (NOLOCK) WHERE Status = 0 AND RptUpload = 0  

IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))  
BEGIN  
RETURN  
END  

DECLARE @FromDate DATETIME  
DECLARE @ToDate DATETIME  

SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction (NOLOCK)  


SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)   
--To Filter Retailers  
SELECT DISTINCT R.RtrId,RC.CtgCode  
INTO #FilterRetailer  
FROM Retailer R (NOLOCK),  
RetailerValueClassMap RVCM (NOLOCK),  
RetailerValueClass RVC (NOLOCK),  
RetailerCategory RC (NOLOCK),  
RetailerCategoryLevel RCL (NOLOCK)  
WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  AND
RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT') 

-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
SELECT * INTO #ParleOutputTaxPercentage
FROM ParleOutputTaxPercentage (NOLOCK)	
--- Till Here


SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,(SP.PrdSchDiscAmount/SP.BaseQty) SchDisc  
INTO #BillingDetails  
FROM SalesInvoice S (NOLOCK)
INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
WHERE SalInvDate between @FromDate AND @ToDate 
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
AND S.DlvSts > 3  

-- SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
--CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,(SP.PrdSchDisAmt/SP.BaseQty) SchDisc  
-- INTO #ReturnDetails  
-- FROM ReturnHeader S (NOLOCK)  
-- INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) 
-- WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)  
-- AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
-- AND S.[Status] = 0  


SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc
INTO #ReturnDetails
FROM ReturnHeader S (NOLOCK)
INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
WHERE 
ReturnDate    between @FromDate AND @ToDate 
AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)

INSERT INTO #ReturnDetails
SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc 
FROM ReturnHeader S (NOLOCK)
INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
WHERE  ReturnDate  between  @FromDate AND @ToDate  AND   S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)

SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,CAST(0 AS NUMERIC(18,6))[SellRate],  
CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) IRCTCRate,SchDisc
INTO #RailwaySalesDetails  
FROM   
(  
SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #BillingDetails  
UNION ALL  
SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #ReturnDetails  
) Consolidated  

DECLARE @SlNo AS INT  
SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  
FROM #RailwaySalesDetails R (NOLOCK),  
ProductBatch B (NOLOCK),  
ProductBatchDetails D (NOLOCK)  
WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo   

--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
--INTO #ExistingSpecialPrice
--FROM #RailwaySalesDetails R (NOLOCK),
--SpecialRateAftDownLoad_Calc C (NOLOCK)
--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)

SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
INTO #SpecialPrice
FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
#FilterRetailer R,
Product P (NOLOCK), ProductBatch B (NOLOCK)
WHERE S.RtrCtgValueCode = R.CtgCode AND
S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId


SELECT S.* 
INTO #LatesSpecialPrice
FROM #SpecialPrice S,
(
SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
FROM #SpecialPrice  
GROUP BY RtrId,PrdId,PrdBatId
) L
WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate

UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]
FROM #RailwaySalesDetails R (NOLOCK),
#LatesSpecialPrice S (NOLOCK)
WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid

--- Added by Amuthakumar on 17-09-2018  CRCRSTPAR0021
UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
FROM #RailwaySalesDetails R (NOLOCK),
#ParleOutputTaxPercentage T (NOLOCK)
WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
--UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
--- Till Here CRCRSTPAR0021
	
SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
(
SELECT D.PriceId,D.PrdBatDetailValue 
FROM #RailwaySalesDetails M (NOLOCK),
ProductBatchDetails D (NOLOCK) 
WHERE M.PriceId = D.PriceId AND D.SLNo = 3
AND PriceCode LIKE '%-Spl Rate-%'   
UNION 
SELECT D.PriceId,D.PrdBatDetailValue 
FROM #RailwaySalesDetails M (NOLOCK),
ProductBatchDetails D (NOLOCK) 
WHERE M.PriceId = D.PriceId AND D.SLNo = 3
AND PriceCode LIKE '%SplRate%'  
)A

--UPDATE M SET M.IRCTCRATE = D.PrdBatDetailValue-SchDisc 
--FROM #RailwaySalesDetails M (NOLOCK),
--#SpecialPrice_New D (NOLOCK) 
--WHERE M.PriceId = D.PriceId 


	UPDATE M SET M.IRCTCRATE = D.PrdBatDetailValue + (D.PrdBatDetailValue*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#SpecialPrice_New D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno	AND M.PriceId = D.PriceId   
 
UPDATE R SET R.IRCTCRATE = R.[SellRate] - Schdisc 	FROM #RailwaySalesDetails R (NOLOCK)  WHERE IRCTCRATE=0

--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,  
--LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
--IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
--CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
--INTO #RailwayDiscount  
--FROM #RailwaySalesDetails S (NOLOCK)  
--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
--GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate

SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,(TotalPCS) AS TotalPCS,MRP,  
LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
INTO #RailwayDiscount1  
FROM #RailwaySalesDetails S (NOLOCK)  
INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
-- GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate,TotalPCS 

--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
UPDATE R SET TotalMRP  = TotalPCS * MRP, 
TotalLCTR = TotalPCS * LCTR
FROM #RailwayDiscount1 R (NOLOCK)


UPDATE R SET R.IRCTCTotal = TotalPCS * IRCTCRate  
FROM #RailwayDiscount1 R (NOLOCK)  

UPDATE R SET R.ClmAmount = TotalLCTR - IRCTCTotal  
FROM #RailwayDiscount1 R (NOLOCK)  

UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
FROM #RailwayDiscount1 R (NOLOCK)
WHERE R.TotalMRP <> 0

UPDATE R SET LibOnMRP = -1* LibOnMRP
FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0


UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
FROM #RailwayDiscount1 R (NOLOCK)
WHERE R.TotalLCTR <> 0	

UPDATE R SET LibOnLCTR = -1* LibOnLCTR
FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
------------ Till Here ---------------

INSERT INTO Cs2Cn_Prk_RailwayDiscountReconsolidation (DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,  
LibOnLCTR,UploadFlag,SyncId,ServerDate)  
SELECT @DistCode,TransDate,R.CmpRtrCode,PrdCCode,sum(TotalPCS) AS TotalPCS ,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,sum(TotalMRP) AS TotalMRP,CAST ((sum(TotalLCTR))  AS NUMERIC(18,2)) TotalLCTR,CAST (ROUND(sum(IRCTCTotal),2) AS NUMERIC(18,2)) IRCTCTotal 
,CAST(sum(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(sum(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (sum(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR,'N' UploadFlag,NULL,@ServerDate 
FROM #RailwayDiscount1 RD,  
Retailer R (NOLOCK)  
WHERE RD.RtrId = R.RtrId  GROUP BY TransDate,R.CmpRtrCode,PrdCCode,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate
RETURN     
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_RailwayDiscountReconsolidation]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cs2Cn_RailwayDiscountReconsolidation
GO
/*  
Begin transaction
truncate table Cs2Cn_Prk_RailwayDiscountReconsolidation  
update A set upload =0,rptupload =0 from salesinvoice A  where SalInvDate between '2018-03-01' and '2018-03-31'
update a set upload =0,RptUpload=0 from ReturnHeader a where returndate between '2018-03-01' and '2018-03-31'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,'2018-07-11'  
--select * from UploadingReportTransaction
select * from Cs2Cn_Prk_RailwayDiscountReconsolidation  for xml AUTO --where PrdCCode ='100301301079070190PKT10010N'  
Rollback Transaction  
*/  
CREATE PROCEDURE Proc_Cs2Cn_RailwayDiscountReconsolidation
(  
@Po_ErrNo INT OUTPUT,  
@ServerDate DATETIME  
)  
AS  
/***********************************************************************************************************************
* PROCEDURE  : Proc_Cs2Cn_RailwayDiscountReconsolidation   
* PURPOSE  :   
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :  
* MODIFIED  
************************************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
27-03-2018   S.MOhana     CR			CCRSTPAR0188		Included reports changes in upload
11-07-2018   Lakshman M   BZ            ILCRSTPAR1325       negative values division validation added from core stocky.
27-09-2018   Amuthakumar  CR            CRCRSTPAR0031       Enable Configuration with Tax in Reports
************************************************************************************************************************/ 
SET NOCOUNT ON  
BEGIN
	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax @Po_ErrNo,@ServerDate
		RETURN
	END
	-- Till Here CRCRSTPAR0031
  
SET @Po_ErrNo=0  
DECLARE @DistCode   As NVARCHAR(50)  
DELETE FROM Cs2Cn_Prk_RailwayDiscountReconsolidation WHERE UploadFlag = 'Y'  

TRUNCATE TABLE UploadingReportTransaction  

INSERT INTO UploadingReportTransaction (TransType,TransId,TransNo,TransDate)  
SELECT 1,SalId,SalInvNo,SalInvDate FROM SalesInvoice (NOLOCK) WHERE DlvSts > 3 AND RptUpload = 0  
UNION ALL  
SELECT 2,ReturnID,ReturnCode,ReturnDate FROM ReturnHeader (NOLOCK) WHERE Status = 0 AND RptUpload = 0  

IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))  
BEGIN  
RETURN  
END  


DECLARE @FromDate DATETIME  
DECLARE @ToDate DATETIME  

SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction (NOLOCK)  


SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)   
--To Filter Retailers  
SELECT DISTINCT R.RtrId,RC.CtgCode  
INTO #FilterRetailer  
FROM Retailer R (NOLOCK),  
RetailerValueClassMap RVCM (NOLOCK),  
RetailerValueClass RVC (NOLOCK),  
RetailerCategory RC (NOLOCK),  
RetailerCategoryLevel RCL (NOLOCK)  
WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  AND
RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT') 



SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,(SP.PrdSchDiscAmount/SP.BaseQty) SchDisc  
INTO #BillingDetails  
FROM SalesInvoice S (NOLOCK)
INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
WHERE SalInvDate between @FromDate AND @ToDate 
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
AND S.DlvSts > 3  

-- SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
--CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,(SP.PrdSchDisAmt/SP.BaseQty) SchDisc  
-- INTO #ReturnDetails  
-- FROM ReturnHeader S (NOLOCK)  
-- INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) 
-- WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)  
-- AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
-- AND S.[Status] = 0  


SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc
INTO #ReturnDetails
FROM ReturnHeader S (NOLOCK)
INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
WHERE 
ReturnDate    between @FromDate AND @ToDate 
AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)

INSERT INTO #ReturnDetails
SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc 
FROM ReturnHeader S (NOLOCK)
INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
WHERE  ReturnDate  between  @FromDate AND @ToDate  AND   S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)

SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,CAST(0 AS NUMERIC(18,6))[SellRate],  
CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) IRCTCRate,SchDisc
INTO #RailwaySalesDetails  
FROM   
(  
SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #BillingDetails  
UNION ALL  
SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #ReturnDetails  
) Consolidated  

DECLARE @SlNo AS INT  
SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  
FROM #RailwaySalesDetails R (NOLOCK),  
ProductBatch B (NOLOCK),  
ProductBatchDetails D (NOLOCK)  
WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo   

--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
--INTO #ExistingSpecialPrice
--FROM #RailwaySalesDetails R (NOLOCK),
--SpecialRateAftDownLoad_Calc C (NOLOCK)
--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)

SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
INTO #SpecialPrice
FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
#FilterRetailer R,
Product P (NOLOCK), ProductBatch B (NOLOCK)
WHERE S.RtrCtgValueCode = R.CtgCode AND
S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId


SELECT S.* 
INTO #LatesSpecialPrice
FROM #SpecialPrice S,
(
SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
FROM #SpecialPrice  
GROUP BY RtrId,PrdId,PrdBatId
) L
WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate

UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]
FROM #RailwaySalesDetails R (NOLOCK),
#LatesSpecialPrice S (NOLOCK)
WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid

--UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
--FROM #RailwaySalesDetails R (NOLOCK),
--#ParleOutputTaxPercentage T (NOLOCK)
--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	

UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  

SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
(
SELECT D.PriceId,D.PrdBatDetailValue 
FROM #RailwaySalesDetails M (NOLOCK),
ProductBatchDetails D (NOLOCK) 
WHERE M.PriceId = D.PriceId AND D.SLNo = 3
AND PriceCode LIKE '%-Spl Rate-%'   
UNION 
SELECT D.PriceId,D.PrdBatDetailValue 
FROM #RailwaySalesDetails M (NOLOCK),
ProductBatchDetails D (NOLOCK) 
WHERE M.PriceId = D.PriceId AND D.SLNo = 3
AND PriceCode LIKE '%SplRate%'  
)A


UPDATE M SET M.IRCTCRATE = D.PrdBatDetailValue-SchDisc 
FROM #RailwaySalesDetails M (NOLOCK),
#SpecialPrice_New D (NOLOCK) 
WHERE M.PriceId = D.PriceId  
 
UPDATE R SET R.IRCTCRATE = R.[SellRate] - Schdisc 	FROM #RailwaySalesDetails R (NOLOCK)  WHERE IRCTCRATE=0

 
--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,  
--LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
--IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
--CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
--INTO #RailwayDiscount  
--FROM #RailwaySalesDetails S (NOLOCK)  
--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
--GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate

SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,(TotalPCS) AS TotalPCS,MRP,  
LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
INTO #RailwayDiscount1  
FROM #RailwaySalesDetails S (NOLOCK)  
INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
-- GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate,TotalPCS 

--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
UPDATE R SET TotalMRP  = TotalPCS * MRP, 
TotalLCTR = TotalPCS * LCTR
FROM #RailwayDiscount1 R (NOLOCK)


UPDATE R SET R.IRCTCTotal = TotalPCS * IRCTCRate  
FROM #RailwayDiscount1 R (NOLOCK)  

UPDATE R SET R.ClmAmount = TotalLCTR - IRCTCTotal  
FROM #RailwayDiscount1 R (NOLOCK)  

UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
FROM #RailwayDiscount1 R (NOLOCK)
WHERE R.TotalMRP <> 0

UPDATE R SET LibOnMRP = -1* LibOnMRP
FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0


UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
FROM #RailwayDiscount1 R (NOLOCK)
WHERE R.TotalLCTR <> 0	

UPDATE R SET LibOnLCTR = -1* LibOnLCTR
FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
------------ Till Here ---------------

INSERT INTO Cs2Cn_Prk_RailwayDiscountReconsolidation (DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,  
LibOnLCTR,UploadFlag,SyncId,ServerDate)  
SELECT @DistCode,TransDate,R.CmpRtrCode,PrdCCode,sum(TotalPCS) AS TotalPCS ,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,sum(TotalMRP) AS TotalMRP,CAST ((sum(TotalLCTR))  AS NUMERIC(18,2)) TotalLCTR,CAST (ROUND(sum(IRCTCTotal),2) AS NUMERIC(18,2)) IRCTCTotal 
,CAST(sum(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(sum(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (sum(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR,'N' UploadFlag,NULL,@ServerDate 
FROM #RailwayDiscount1 RD,  
Retailer R (NOLOCK)  
WHERE RD.RtrId = R.RtrId  GROUP BY TransDate,R.CmpRtrCode,PrdCCode,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate
RETURN     
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptChainWiseBillDetails_withTax' AND TYPE ='P')
DROP PROCEDURE Proc_RptChainWiseBillDetails_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptChainWiseBillDetails_withTax 288,1,0,'PARLE_CR',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptChainWiseBillDetails_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/***********************************************************************************************************************************
* PROCEDURE	: Proc_RptChainWiseBillDetails_withTax
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE : 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
************************************************************************************************************************************
* DATE        AUTHOR			CR/BZ		USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi			CR			ICRSTPAR7049		1. Chain lending rate should display the net rate in billing screen
																2. Bill number column should be after the party name column 
************************************************************************************************************************************												  
 19-12-2017   S.Mohana			CR			ICRSTPAR7049		3. Added SubTotal in Excel 
************************************************************************************************************************************
 23-12-2017	  S.MOHANA			SR			ICRSTPAR7809		1.INCLUDED SALES RETURN
																2.REMOVED TAX CALCULATION
																3.ADDED RATE-SCHEMEDISCOUNT , GRANDTOTAL
************************************************************************************************************************************
 26-03-2018	  S.MOHANA			 CR			CCRSTPAR0186		Retailer Wise Sub Total Included. 
 12-07-2018   Lakshman M		 BZ         ILCRSTPAR1325       negative values validataion added from core stocky.
 17-09-2018   Amuthakumar P		 CR			CRCRSTPAR0021		Promotion claim should be calculating with tax
 09-10-2018  Mohana P		     BZ		    ILCRSTPAR2313	    TAX CALCULATION CHANGED AS PER CLIENT REQUEST
************************************************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @ReportType	AS INT	
	--Added By Mohana
	CREATE TABLE #Chain
	(
		[SalId] [bigint] NOT NULL,
		[BillNo] [nvarchar](50) NOT NULL,
		[BillDate] NVARCHAR(100),
		[RtrId] [int] NOT NULL,
		RtrName NVARCHAR(100),
		Ctgname NVARCHAR(100) NOT NULL,
		[PrdId] [int] NOT NULL,
		PrdName NVARCHAR(100),
		PktWgt [numeric](18, 6),
		[MRP] [numeric](18, 6) NOT NULL,
		QtyInPkt [numeric](38, 0) NULL,		
		[ChainLandRate] [numeric](18, 6) NULL,
		Amount [numeric](38, 6) NULL,
		[GrpName] NVARCHAR(100),
		[Grpid] INT
	)  
	--CHANGED BY MOHANA ILCRSTPAR2313
	CREATE TABLE #ChainSalesDetails
	(
		[TransType] INT NOT NULL,
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL,
		[PRDSLNO] INT NOT NULL
	)


	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @ReportType = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,315,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,Ctgname
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId 
	and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	INSERT INTO #ChainSalesDetails
	SELECT 1 AS TRANSID,S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc,SP.SlNo --ADDED BY MOHANA ILCRSTPAR2313
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid,SP.SlNo
	UNION ALL
	SELECT 2 AS TRANSID,S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc,SP.SlNo  --ADDED BY MOHANA ILCRSTPAR2313
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE S.ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid,SP.SlNo
	
	------------- commented By lakshman M ON 12/07/2018 PMS ID : ILCRSTPAR1325
	--UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	 --ADDED BY MOHANA ILCRSTPAR2313
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	

	 
	UPDATE #ChainSalesDetails SET SchemeDiscount =abs (SchemeDiscount/TotalPCS)
	UPDATE A SET SchemeDiscount =  SchemeDiscount + (SchemeDiscount *(B.TaxPerc/100)) FROM #ChainSalesDetails a 
	INNER JOIN #ParleOutputTaxPercentage B ON A.TransType=B.TRANSID
	AND A.SalId = B.SALID AND A.PRDSLNO = B.PRDSLNO

	--TILL HERE  ILCRSTPAR2313
	-------------------- Till here ----------------------------
	--ICRSTPAR7049 Till Here
	--SELECT R.PriceId,C.SplSelRate 
	--INTO #ExistingSpecialPrice
	--FROM #ChainSalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	 --ADDED BY MOHANA ILCRSTPAR2313
	
	UPDATE R SET R.ChainLandRate = (S.SplSelRate + (S.SplSelRate *(P.TaxPerc/100))-R.SchemeDiscount) 
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK),
	 #ParleOutputTaxPercentage P 
	WHERE R.PriceId = S.PriceId	and	  R.TransType=P.TRANSID
	AND R.SalId = P.SALID AND R.PRDSLNO = P.PRDSLNO
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = ((B.PrdbatDetailValue + (B.PrdbatDetailValue *(P.TaxPerc/100))) -A.SchemeDiscount) 
	FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID
	INNER JOIN #ParleOutputTaxPercentage P ON  A.TransType=P.TRANSID
	AND A.SalId = P.SALID AND A.PRDSLNO = P.PRDSLNO
	WHERE A.ChainLandRate=0  
	--TILL HERE
	
	INSERT INTO #Chain(SalId,BillNo,BillDate,RtrId,RtrName,Ctgname,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ChainLandRate,Amount)
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,CtgName,P.PrdId,P.PrdName,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) Amount
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	--- Added by Amuthakumar on 17-09-2018 CRCRSTPAR0021
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--Nagarajan on 29.08.2017 as per PMS : ICRSTPAR5917
	SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	INTO #SalesInvoiceProductTax
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	-- ICRSTPAR7049 Bill No Column Change
	--Till here CRCRSTPAR0021
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptChainWiseBillDetails_Excel')
	DROP TABLE RptChainWiseBillDetails_Excel
		 
	
	SELECT SalId,Ctgname,RtrName,BillNo,BillDate,RtrId,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ROUND(ChainLandRate,2,1) ChainLandRate,Amount,Grpid,GrpName
	INTO RptChainWiseBillDetails_Excel
	FROM #Chain (NOLOCK) Order by  Ctgname,RtrName
	
	UPDATE RptChainWiseBillDetails_Excel SET Grpname='Retailer'
	
 	SELECT  Row_numbeR() Over(Order by  Ctgname,Rtrid Asc) as Row ,Rtrid,Rtrname,Ctgname INTO #Excel  from RptChainWiseBillDetails_Excel  GROUP BY Rtrid ,Rtrname,Ctgname
 	UPDATE A SET A.Grpid = B.row from RptChainWiseBillDetails_Excel A INNER JOIN #Excel B ON A.Rtrid = B.Rtrid 
	 	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptChainWiseBillDetails_Excel
	
	SELECT * FROM RptChainWiseBillDetails_Excel Order By Ctgname,BillNo
	
	--INSERT INTO RptChainWiseBillDetails_Excel
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,1000,CtgName  FROM RptChainWiseBillDetails_Excel	
	--group by CtgName
	--UNION  
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,10000,'zzzzzz' FROM RptChainWiseBillDetails_Excel	
 
	INSERT INTO RptChainWiseBillDetails_Excel
	SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'SubTotal' FROM RptChainWiseBillDetails_Excel 
	group by RtrId
	UNION   
	SELECT 0 SalId,Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'ZSubStotal'  FROM RptChainWiseBillDetails_Excel 
	group by   Ctgname
	UNION  
	SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,1000000,'zzzzzzzzz' FROM RptChainWiseBillDetails_Excel	

	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'SalId','SalId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'RtrName','Party Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'BillNo','BillNo',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'BillDate','BillDate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'RtrId','RtrId',0,1)
 	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'PktWgt','Pkt Wgt',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'ChainLandRate','Chain Landing Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'Amount','Amount',1,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'Grpid','Grpid',0,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'GrpName','GrpName',0,1)	
	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptChainWiseBillDetails' AND XTYPE='P')
DROP PROCEDURE Proc_RptChainWiseBillDetails
GO
/*
BEGIN TRAN
EXEC Proc_RptChainWiseBillDetails 288,2,0,'PARLE_CR',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptChainWiseBillDetails
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/***********************************************************************************************************************************
* PROCEDURE	: Proc_RptChainWiseBillDetsils
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
************************************************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. Chain lending rate should display the net rate in billing screen
															2. Bill number column should be after the party name column 
************************************************************************************************************************************												  
 19-12-2017   S.Mohana    CR			ICRSTPAR7049		3. Added SubTotal in Excel 
************************************************************************************************************************************
 23-12-2017	  S.MOHANA	  SR			ICRSTPAR7809		1.INCLUDED SALES RETURN
															2.REMOVED TAX CALCULATION
															3.ADDED RATE-SCHEMEDISCOUNT , GRANDTOTAL
************************************************************************************************************************************
 26-03-2018	  S.MOHANA	  CR			CCRSTPAR0186		Retailer Wise Sub Total Included. 
 12-07-2018   Lakshman M  BZ            ILCRSTPAR1325       negative values validataion added from core stocky.
 27-09-2018   Amuthakumar CR            CRCRSTPAR0031       Enable Configuration with Tax in Reports														
************************************************************************************************************************************/  
BEGIN

	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_RptChainWiseBillDetails_withTax @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
		RETURN
	END
	-- Till Here CRCRSTPAR0031

	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @ReportType	AS INT	
	--Added By Mohana
	CREATE TABLE #Chain
	(
		[SalId] [bigint] NOT NULL,
		[BillNo] [nvarchar](50) NOT NULL,
		[BillDate] NVARCHAR(100),
		[RtrId] [int] NOT NULL,
		RtrName NVARCHAR(100),
		Ctgname NVARCHAR(100) NOT NULL,
		[PrdId] [int] NOT NULL,
		PrdName NVARCHAR(100),
		PktWgt [numeric](18, 6),
		[MRP] [numeric](18, 6) NOT NULL,
		QtyInPkt [numeric](38, 0) NULL,		
		[ChainLandRate] [numeric](18, 6) NULL,
		Amount [numeric](38, 2) NULL,
		[GrpName] NVARCHAR(100),
		[Grpid] INT
	)  
	
	
	CREATE TABLE #ChainSalesDetails
	(
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL
	)


	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @ReportType = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,315,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,Ctgname
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId 
	and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	INSERT INTO #ChainSalesDetails
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid
	UNION ALL
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE S.ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid
	
	------------- commented By lakshman M ON 12/07/2018 PMS ID : ILCRSTPAR1325
	--UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	UPDATE #ChainSalesDetails SET SchemeDiscount =abs (SchemeDiscount/TotalPCS)
	-------------------- Till here ----------------------------
	--ICRSTPAR7049 Till Here
	--SELECT R.PriceId,C.SplSelRate 
	--INTO #ExistingSpecialPrice
	--FROM #ChainSalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	

	
	UPDATE R SET R.ChainLandRate = (S.SplSelRate-R.SchemeDiscount)
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId		
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = (B.PrdbatDetailValue-A.SchemeDiscount) FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID WHERE A.ChainLandRate=0  

	
	INSERT INTO #Chain(SalId,BillNo,BillDate,RtrId,RtrName,Ctgname,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ChainLandRate,Amount)
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,CtgName,P.PrdId,P.PrdName,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,2)) Amount
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--Nagarajan on 29.08.2017 as per PMS : ICRSTPAR5917
	--SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	--INTO #SalesInvoiceProductTax
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	--Till here
	-- ICRSTPAR7049 Bill No Column Change
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptChainWiseBillDetails_Excel')
	DROP TABLE RptChainWiseBillDetails_Excel
		 
	
	SELECT SalId,Ctgname,RtrName,BillNo,BillDate,RtrId,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ROUND(ChainLandRate,2,1) ChainLandRate,ROUND(Amount,2,1) Amount,Grpid,GrpName
	INTO RptChainWiseBillDetails_Excel
	FROM #Chain (NOLOCK) Order by  Ctgname,RtrName
	
	UPDATE RptChainWiseBillDetails_Excel SET Grpname='Retailer'
	
 	SELECT  Row_numbeR() Over(Order by  Ctgname,Rtrid Asc) as Row ,Rtrid,Rtrname,Ctgname INTO #Excel  from RptChainWiseBillDetails_Excel  GROUP BY Rtrid ,Rtrname,Ctgname
 	UPDATE A SET A.Grpid = B.row from RptChainWiseBillDetails_Excel A INNER JOIN #Excel B ON A.Rtrid = B.Rtrid 
	 	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptChainWiseBillDetails_Excel
	
	SELECT * FROM RptChainWiseBillDetails_Excel Order By Ctgname,BillNo
	
	--INSERT INTO RptChainWiseBillDetails_Excel
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,1000,CtgName  FROM RptChainWiseBillDetails_Excel	
	--group by CtgName
	--UNION  
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,10000,'zzzzzz' FROM RptChainWiseBillDetails_Excel	
 
	INSERT INTO RptChainWiseBillDetails_Excel
	SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'SubTotal' FROM RptChainWiseBillDetails_Excel 
	group by RtrId
	UNION   
	SELECT 0 SalId,Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'ZSubStotal'  FROM RptChainWiseBillDetails_Excel 
	group by   Ctgname
	UNION  
	SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,1000000,'zzzzzzzzz' FROM RptChainWiseBillDetails_Excel	

	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'SalId','SalId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'RtrName','Party Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'BillNo','BillNo',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'BillDate','BillDate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'RtrId','RtrId',0,1)
 	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'PktWgt','Pkt Wgt',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'ChainLandRate','Chain Landing Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'Amount','Amount',1,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'Grpid','Grpid',0,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'GrpName','GrpName',0,1)	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_ChainWiseBillDetails_withTax' AND TYPE ='P')
DROP PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails_withTax
GO
/*
Begin transaction 
EXEC Proc_Cs2Cn_ChainWiseBillDetails_withTax 0,'2018-10-18'
select   * from Cs2Cn_Prk_ChainWiseBillDetails order by Billno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails_withTax
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_ChainWiseBillDetails 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
---------------------------------------------------------------------------------------------------
* DATE        AUTHOR		  CR/BZ		USER STORY ID        DESCRIPTION   
 27-03-2018   S.MOhana			CR		CCRSTPAR0188	  Included reports changes in upload	
 18-09-2018  Amuthakumar P		CR		CRCRSTPAR0021	  Promotion claim should be calculating with tax
 09-10-2018  Mohana P		    BZ		ILCRSTPAR2313	  TAX CALCULATION CHANGED AS PER CLIENT REQUEST
**************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	CREATE TABLE #ChainSalesDetails
	(
		[TransType] INT NOT NULL,
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL,
		[PRDSLNO] INT NOT NULL
	)
	
	DECLARE @DistCode As NVARCHAR(50)

	DELETE FROM Cs2Cn_Prk_ChainWiseBillDetails WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
			
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	--To Filter Retailers
	
	--COMMENTED BY MOHANA ILCRSTPAR2313
	---- Added by Amuthakumar CRCRSTPAR0021
	--To Filter Products
	--SELECT DISTINCT P.PrdId
	--INTO #FilterProduct
	--FROM Product P (NOLOCK) 
	--WHERE P.PrdType = 3
	--To Filter Products
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)
	--- Till Here 	CRCRSTPAR0021
	
	INSERT INTO #ChainSalesDetails
	SELECT 1 AS TRANSID,S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc,SP.SlNo
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FPR (NOLOCK) WHERE SP.PrdId = FPR.PrdId)--- Add by Amuthakumar --COMMENTED BY MOHANA ILCRSTPAR2313
	AND S.DlvSts > 3  
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid,SP.SlNo
	UNION ALL
	SELECT 2 AS TRANSID,S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc,SP.Slno
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE  EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	 AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FPR (NOLOCK) WHERE SP.PrdId = FPR.PrdId)--- Add by Amuthakumar --COMMENTED BY MOHANA ILCRSTPAR2313
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid,SP.SlNo
		
	
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)
	
		
	UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE A SET SchemeDiscount =  SchemeDiscount + (SchemeDiscount *(B.TaxPerc/100)) FROM #ChainSalesDetails a 
	INNER JOIN #ParleOutputTaxPercentage B ON A.TransType=B.TRANSID
	AND A.SalId = B.SALID AND A.PRDSLNO = B.PRDSLNO
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A 
	INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	--CAHNGED BY MOHANA ILCRSTPAR2313
	UPDATE R SET R.ChainLandRate = (S.SplSelRate + (S.SplSelRate *(P.TaxPerc/100))-R.SchemeDiscount) 
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK),
	 #ParleOutputTaxPercentage P 
	WHERE R.PriceId = S.PriceId	and	  R.TransType=P.TRANSID
	AND R.SalId = P.SALID AND R.PRDSLNO = P.PRDSLNO
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = ((B.PrdbatDetailValue + (B.PrdbatDetailValue *(P.TaxPerc/100))) -A.SchemeDiscount) 
	FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID
	INNER JOIN #ParleOutputTaxPercentage P ON  A.TransType=P.TRANSID
	AND A.SalId = P.SALID AND A.PRDSLNO = P.PRDSLNO
	WHERE A.ChainLandRate=0  
	----TILL HERE ILCRSTPAR2313

	--SELECT S.SalId,S.SalInvNo BillNo,S.SalInvDate BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	--PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,PriceId,ChainLandRate,
	--CAST(0 AS NUMERIC(18,6)) Amount
	--INTO #Chain
	--FROM #ChainSalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	
	 
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) Amount
	INTO #Chain
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	--- Added by Amuthakumar on 18-09-2018 CRCRSTPAR0021
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	--COMMENTED BY MOHANA ILCRSTPAR2313
	--SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	--INTO #SalesInvoiceProductTax
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	----AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	
	--Till here CRCRSTPAR0021
	--select BillNo,PrdId,QtyInPkt,ROUND(ChainLandRate,2,1),ROUND(Amount,2,1)  from #Chain order by  billno,prdid 
	--TILL HERE ILCRSTPAR2313

	INSERT INTO Cs2Cn_Prk_ChainWiseBillDetails (DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,PktMRP,QtyInPkt,
	ChainLandRate,Amount,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP,sum(QtyInPkt),sum(ChainLandRate),sum(Amount),
	'N' UploadFlag,NULL,@ServerDate
	FROM #Chain (NOLOCK) 
	GROUP BY  BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP
	
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--SalesInvoice S (NOLOCK) WHERE U.TransType = 1 AND U.TransId = S.SalId
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--ReturnHeader S (NOLOCK) WHERE U.TransType = 2 AND U.TransId = S.ReturnID
	
	RETURN			
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_ChainWiseBillDetails' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_ChainWiseBillDetails 0,'2018-09-27'
select   * from Cs2Cn_Prk_ChainWiseBillDetails order by Billno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_ChainWiseBillDetails 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
--------------------------------------------------------------------------------------------------
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 27-03-2018   S.MOhana     CR			CCRSTPAR0188		Included reports changes in upload
 27-09-2018   Amuthakumar  CR           CRCRSTPAR0031       Enable Configuration with Tax in Reports															
***************************************************************************************************/
SET NOCOUNT ON
BEGIN

	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_Cs2Cn_ChainWiseBillDetails_withTax @Po_ErrNo,@ServerDate
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	
	SET @Po_ErrNo=0
	
	CREATE TABLE #ChainSalesDetails
	(
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL
	)
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_ChainWiseBillDetails WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
			
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	
	--To Filter Retailers
	INSERT INTO #ChainSalesDetails
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND S.DlvSts > 3  
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid
	UNION ALL
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE  EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	 AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid
	
	UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	
	UPDATE R SET R.ChainLandRate = S.SplSelRate-R.SchemeDiscount
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId
	
	UPDATE A SET A.ChainLandRate = (B.PrdbatDetailValue-A.SchemeDiscount) FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID WHERE A.ChainLandRate=0  
	
	--SELECT S.SalId,S.SalInvNo BillNo,S.SalInvDate BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	--PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,PriceId,ChainLandRate,
	--CAST(0 AS NUMERIC(18,6)) Amount
	--INTO #Chain
	--FROM #ChainSalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	
	 
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,2)) Amount
	INTO #Chain
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--select BillNo,PrdId,QtyInPkt,ROUND(ChainLandRate,2,1),ROUND(Amount,2,1)  from #Chain order by  billno,prdid 
	
	INSERT INTO Cs2Cn_Prk_ChainWiseBillDetails (DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,PktMRP,QtyInPkt,
	ChainLandRate,Amount,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP,sum(QtyInPkt),sum(ROUND(ChainLandRate,2,1)),sum(ROUND(Amount,2,1)),
	'N' UploadFlag,NULL,@ServerDate
	FROM #Chain (NOLOCK) 
	GROUP BY  BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP
	
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--SalesInvoice S (NOLOCK) WHERE U.TransType = 1 AND U.TransId = S.SalId
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--ReturnHeader S (NOLOCK) WHERE U.TransType = 2 AND U.TransId = S.ReturnID
	
	RETURN			
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptMTChainSKUWiseOffer_withTax' AND XTYPE='P')
DROP PROCEDURE Proc_RptMTChainSKUWiseOffer_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptMTChainSKUWiseOffer_withTax 288,1,0,'',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptMTChainSKUWiseOffer_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************
* PROCEDURE	: Proc_RptMTChainSKUWiseOffer_withTax
* PURPOSE	: To Return the Trade Promotion Report
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------
* DATE       AUTHOR				CR/BZ    USER STORY ID    DESCRIPTION                         
**************************************************************************************************
06/10/2017  Mohana S			BZ       ICRSTPAR6321     Issue Fix in ChainRate and LCTR Calculations. 
17-09-2018  Amuthakumar P		CR		 CRCRSTPAR0021	  Promotion claim should be calculating with tax
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	
	AND E.PrdType = 3
	--To Filter Products
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
		
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],
	CAST(0 AS NUMERIC(18,2)) ChainRate,CAST(0 AS NUMERIC(18,2)) AS ParleLCTR,CAST(0 AS NUMERIC(18,2)) ChainOffRate
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate] FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte FROM #ReturnDetails
	
	) Consolidated	
	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	--Added By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.PrdId,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
		SELECT DISTINCT M.Salid,M.Rtrid,KP.KitPrdid,KP.PrdId,K.BaseQty Qty
	INTO	#KitItemsQty 
	FROM KitProduct KP (NOLOCK),
	#MTSalesDetails M (NOLOCK),
	SalesInvoiceKitItemDt K(NOLOCK)
	WHERE M.PrdId= KP.KitPrdId AND M.SalId = K.SalId AND M.PrdId = K.KitPrdId --AND M.SlNo = K.SlNo
	AND KP.PrdId=K.PrdId AND KP.KitPrdid=K.KitPrdId AND M.rtrid = K.RtrId
	
	--
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	 
	
	UPDATE M SET M.SellRate = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,Sum(NormalSellRate*qty) NormalSellRate  FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid AND A.rtrid =B.rtrid AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,Fromdate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)
	
	SELECT S.* 
	INTO #LatesSpecialPrice1
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(Fromdate) Fromdate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.Fromdate = S.Fromdate
	
	
	SELECT DISTINCT RtrId,PrdId,MAX(PrdBatId)PrdBatId, Fromdate,SplSelRate INTO #LatesSpecialPrice FROM #LatesSpecialPrice1 
	GROUP BY RtrId,PrdId, Fromdate,SplSelRate
	
	
	
	
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	
	UPDATE M SET M.ChainRate = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,SUM(NormalSpecialRate*Qty) NormalSpecialRate FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid   AND A.rtrid =B.rtrid  AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo	
	
	
	--Nagarajan on 29.Aug.2017
	
	UPDATE M SET M.ChainRate = (M.ChainRate +(M.ChainRate *(T.TaxPerc/100)))
	FROM #MTSalesDetails M (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno
	
	 
	
	-- Till here
	
	UPDATE R SET R.ParleLCTR = (R.[SellRate]+(R.[SellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	
	--- Added by Amuthakumar on 17-09-2018 CRCRSTPAR0021
	
	--UPDATE R SET R.ChainOffRate = D.PrdBatDetailValue
	--FROM #MTSalesDetails R (NOLOCK),
	--ProductBatch B (NOLOCK),
	--ProductBatchDetails D (NOLOCK)
	--WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo AND R.PriceId=D.PriceId
	--AND R.PrdBatId=D.PrdBatId	
	
	-- Nagarajan on 29.08.2017
		
	UPDATE R SET R.ChainOffRate = (R.[ChainOffRate]+(R.[ChainOffRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	-- Till Here CRCRSTPAR0021
	
	--Commented By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
	--UPDATE SD SET SD.ParleLCTR = SD.ParleLCTR * KIQ.Qty 
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId 
	--UPDATE SD SET SD.ChainRate = SD.ChainRate * KIQ.Qty
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId	
	
	--
	
	SELECT S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,SUM(TotalPCS) QtyInPkt,
	SUM(ParleLCTR) ParleLCTR,SUM(ChainRate) ChainRate,ChainOffRate ,
	CAST(0 AS NUMERIC(18,2)) TotalOffLCTR,CAST(0 AS NUMERIC(18,2)) TotalOffPerTOT,
	CAST(0 AS NUMERIC(18,2)) TotalOffPerChain,CAST(0 AS NUMERIC(18,2)) OffClmDiff,
	CAST(0 AS NUMERIC(18,2)) OffLiabVal,CAST(0 AS NUMERIC(18,2)) ClmLiabWOTOT,
	CAST(0 AS NUMERIC(18,2)) ClmLiabTotSal
	INTO #MTChain
	FROM #MTSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	GROUP BY S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,ChainOffRate
	
	
		--Added By Mohana	
	UPDATE R SET R.ParleLCTR = ParleLCTR / QtyInPkt ,   ChainRate = ChainRate/QtyInPkt
	FROM #MTChain R (NOLOCK)
	 
	
	UPDATE R SET R.TotalOffLCTR = QtyInPkt * ParleLCTR,
	R.TotalOffPerTOT = QtyInPkt * ChainRate,
	R.TotalOffPerChain = QtyInPkt * ChainOffRate
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.OffClmDiff = TotalOffLCTR - TotalOffPerChain,
	R.OffLiabVal = TotalOffPerTOT - TotalOffPerChain
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.ClmLiabWOTOT = (OffLiabVal / TotalOffLCTR)*100 , ClmLiabTotSal = (OffClmDiff / TotalOffLCTR)*100
	FROM #MTChain R (NOLOCK)
	WHERE TotalOffLCTR <> 0
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTChainSKUWiseOffer_Excel')
	DROP TABLE RptMTChainSKUWiseOffer_Excel
	
	SELECT RtrId,RtrName,PrdId,PrdName,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,TotalOffPerTOT,TotalOffPerChain,
	ABS(OffClmDiff) OffClmDiff,ABS(OffLiabVal) OffLiabVal,ABS(ClmLiabWOTOT) ClmLiabWOTOT,ABS(ClmLiabTotSal) ClmLiabTotSal
	INTO RptMTChainSKUWiseOffer_Excel
	FROM #MTChain (NOLOCK)
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTChainSKUWiseOffer_Excel
	
	SELECT * FROM RptMTChainSKUWiseOffer_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'RtrId','RtrId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'RtrName','Retailer Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'ParleLCTR','Parle LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'ChainRate','Chain Rate as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'ChainOffRate','Chain Offer Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'TotalOffLCTR','Total Offer LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalOffPerTOT','Total Offer Sec Sales as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalOffPerChain','Total Offer Sec Sales as Per offer rate to Chain',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'OffClmDiff','Offer Claim Difference',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'OffLiabVal','Offer Liability Value',1,1)		
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'ClmLiabWOTOT','% Liab Of claims on Total Sales without TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'ClmLiabTotSal','% Liab Of claims on Total Sales',1,1)
	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptMTChainSKUWiseOffer' AND XTYPE='P')
DROP PROCEDURE Proc_RptMTChainSKUWiseOffer
GO
/*
BEGIN TRAN
EXEC Proc_RptMTChainSKUWiseOffer 288,1,0,'',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptMTChainSKUWiseOffer
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************
* PROCEDURE	: Proc_RptMTChainSKUWiseOffer
* PURPOSE	: To Return the Trade Promotion Report
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------
* DATE       AUTHOR     CR/BZ    USER STORY ID    DESCRIPTION                         
**************************************************************************************************
06/10/2017   Mohana S    BZ       ICRSTPAR6321        Issue Fix in ChainRate and LCTR Calculations. 
27-09-2018   Amuthakumar CR       CRCRSTPAR0031       Enable Configuration with Tax in Reports														
************************************************************************************************************************************/  
BEGIN

	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_RptMTChainSKUWiseOffer_withTax @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
		RETURN
	END
	-- Till Here CRCRSTPAR0031

	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	
	AND E.PrdType = 3
	--To Filter Products
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
		
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],
	CAST(0 AS NUMERIC(18,2)) ChainRate,CAST(0 AS NUMERIC(18,2)) AS ParleLCTR,CAST(0 AS NUMERIC(18,2)) ChainOffRate
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate] FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte FROM #ReturnDetails
	
	) Consolidated	
	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	--Added By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.PrdId,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
		SELECT DISTINCT M.Salid,M.Rtrid,KP.KitPrdid,KP.PrdId,K.BaseQty Qty
	INTO	#KitItemsQty 
	FROM KitProduct KP (NOLOCK),
	#MTSalesDetails M (NOLOCK),
	SalesInvoiceKitItemDt K(NOLOCK)
	WHERE M.PrdId= KP.KitPrdId AND M.SalId = K.SalId AND M.PrdId = K.KitPrdId --AND M.SlNo = K.SlNo
	AND KP.PrdId=K.PrdId AND KP.KitPrdid=K.KitPrdId AND M.rtrid = K.RtrId
	
	--
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	 
	
	UPDATE M SET M.SellRate = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,Sum(NormalSellRate*qty) NormalSellRate  FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid AND A.rtrid =B.rtrid AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,Fromdate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)
	
	SELECT S.* 
	INTO #LatesSpecialPrice1
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(Fromdate) Fromdate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.Fromdate = S.Fromdate
	
	
	SELECT DISTINCT RtrId,PrdId,MAX(PrdBatId)PrdBatId, Fromdate,SplSelRate INTO #LatesSpecialPrice FROM #LatesSpecialPrice1 
	GROUP BY RtrId,PrdId, Fromdate,SplSelRate
	
	
	
	
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	
	UPDATE M SET M.ChainRate = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,SUM(NormalSpecialRate*Qty) NormalSpecialRate FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid   AND A.rtrid =B.rtrid  AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo	
	
	
	--Nagarajan on 29.Aug.2017
	
	UPDATE M SET M.ChainRate = (M.ChainRate +(M.ChainRate *(T.TaxPerc/100)))
	FROM #MTSalesDetails M (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno
	
	 
	
	-- Till here
	
	UPDATE R SET R.ParleLCTR = (R.[SellRate]+(R.[SellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	
	
	UPDATE R SET R.ChainOffRate = D.PrdBatDetailValue
	FROM #MTSalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo AND R.PriceId=D.PriceId
	AND R.PrdBatId=D.PrdBatId	
	
	-- Nagarajan on 29.08.2017
	
	--UPDATE R SET R.ChainOffRate = (R.[ChainOffRate]+(R.[ChainOffRate]*(T.TaxPerc/100)))
	--FROM #MTSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	--Commented By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
	--UPDATE SD SET SD.ParleLCTR = SD.ParleLCTR * KIQ.Qty 
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId 
	--UPDATE SD SET SD.ChainRate = SD.ChainRate * KIQ.Qty
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId	
	
	--
	
	SELECT S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,SUM(TotalPCS) QtyInPkt,
	SUM(ParleLCTR) ParleLCTR,SUM(ChainRate) ChainRate,ChainOffRate ,
	CAST(0 AS NUMERIC(18,2)) TotalOffLCTR,CAST(0 AS NUMERIC(18,2)) TotalOffPerTOT,
	CAST(0 AS NUMERIC(18,2)) TotalOffPerChain,CAST(0 AS NUMERIC(18,2)) OffClmDiff,
	CAST(0 AS NUMERIC(18,2)) OffLiabVal,CAST(0 AS NUMERIC(18,2)) ClmLiabWOTOT,
	CAST(0 AS NUMERIC(18,2)) ClmLiabTotSal
	INTO #MTChain
	FROM #MTSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	GROUP BY S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,ChainOffRate
	
	
		--Added By Mohana	
	UPDATE R SET R.ParleLCTR = ParleLCTR / QtyInPkt ,   ChainRate = ChainRate/QtyInPkt
	FROM #MTChain R (NOLOCK)
	 
	
	UPDATE R SET R.TotalOffLCTR = QtyInPkt * ParleLCTR,
	R.TotalOffPerTOT = QtyInPkt * ChainRate,
	R.TotalOffPerChain = QtyInPkt * ChainOffRate
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.OffClmDiff = TotalOffLCTR - TotalOffPerChain,
	R.OffLiabVal = TotalOffPerTOT - TotalOffPerChain
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.ClmLiabWOTOT = (OffLiabVal / TotalOffLCTR)*100 , ClmLiabTotSal = (OffClmDiff / TotalOffLCTR)*100
	FROM #MTChain R (NOLOCK)
	WHERE TotalOffLCTR <> 0
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTChainSKUWiseOffer_Excel')
	DROP TABLE RptMTChainSKUWiseOffer_Excel
	
	SELECT RtrId,RtrName,PrdId,PrdName,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,TotalOffPerTOT,TotalOffPerChain,
	ABS(OffClmDiff) OffClmDiff,ABS(OffLiabVal) OffLiabVal,ABS(ClmLiabWOTOT) ClmLiabWOTOT,ABS(ClmLiabTotSal) ClmLiabTotSal
	INTO RptMTChainSKUWiseOffer_Excel
	FROM #MTChain (NOLOCK)
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTChainSKUWiseOffer_Excel
	
	SELECT * FROM RptMTChainSKUWiseOffer_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'RtrId','RtrId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'RtrName','Retailer Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'ParleLCTR','Parle LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'ChainRate','Chain Rate as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'ChainOffRate','Chain Offer Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'TotalOffLCTR','Total Offer LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalOffPerTOT','Total Offer Sec Sales as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalOffPerChain','Total Offer Sec Sales as Per offer rate to Chain',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'OffClmDiff','Offer Claim Difference',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'OffLiabVal','Offer Liability Value',1,1)		
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'ClmLiabWOTOT','% Liab Of claims on Total Sales without TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'ClmLiabTotSal','% Liab Of claims on Total Sales',1,1)
	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_MTChainSKUWise_withTax' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_MTChainSKUWise_withTax
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_MTChainSKUWise_withTax 0,'2018-09-17'
select * from Cs2Cn_Prk_MTChainSKUWise order by slno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_MTChainSKUWise_withTax
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_MTChainSKUWise_withTax 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
--------------------------------------------------------------------------------------------------
* DATE       AUTHOR				CR/BZ    USER STORY ID    DESCRIPTION                         
**************************************************************************************************
17-09-2018  Amuthakumar P		CR		 CRCRSTPAR0021	  Promotion claim should be calculating with tax
***************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_MTChainSKUWise WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	--To Filter Retailers	
			
	--To Filter Products
	SELECT DISTINCT P.PrdId
	INTO #FilterProduct
	FROM Product P (NOLOCK) 
	WHERE P.PrdType = 3
	--To Filter Products
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)	
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FR (NOLOCK) WHERE SP.PrdId = FR.PrdId)
	AND S.DlvSts > 3
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE S.Status = 0
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FR (NOLOCK) WHERE SP.PrdId = FR.PrdId)
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],
	CAST(0 AS NUMERIC(18,2)) ChainRate,CAST(0 AS NUMERIC(18,2)) AS ParleLCTR,CAST(0 AS NUMERIC(18,2)) ChainOffRate
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate] FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte FROM #ReturnDetails
	
	) Consolidated	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	UPDATE M SET M.SellRate = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSellRate) NormalSellRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)
	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	UPDATE M SET M.ChainRate = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSpecialRate) NormalSpecialRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo		
		
	UPDATE R SET R.ParleLCTR = (R.[SellRate]+(R.[SellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
		
	--- Added by Amuthakumar on 17-09-2018 CRCRSTPAR0021
	--UPDATE R SET R.ChainOffRate = D.PrdBatDetailValue
	--FROM #MTSalesDetails R (NOLOCK),
	--ProductBatch B (NOLOCK),
	--ProductBatchDetails D (NOLOCK)
	--WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo	
		
	UPDATE R SET R.ChainOffRate = (R.[ChainOffRate]+(R.[ChainOffRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	-- Till Here CRCRSTPAR0021
			
	
	SELECT S.RtrId,R.CmpRtrCode,S.TransDate,P.PrdId,P.PrdCCode,MRP,SUM(TotalPCS) QtyInPkt,
	ParleLCTR,ChainRate,ChainOffRate,
	CAST(0 AS NUMERIC(18,6)) TotalOffLCTR,CAST(0 AS NUMERIC(18,6)) TotalOffPerTOT,
	CAST(0 AS NUMERIC(18,6)) TotalOffPerChain,CAST(0 AS NUMERIC(18,6)) OffClmDiff,
	CAST(0 AS NUMERIC(18,2)) OffLiabVal,CAST(0 AS NUMERIC(18,2)) ClmLiabWOTOT,
	CAST(0 AS NUMERIC(18,2)) ClmLiabTotSal
	INTO #MTChain
	FROM #MTSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	GROUP BY S.RtrId,R.CmpRtrCode,S.TransDate,P.PrdId,P.PrdCCode,MRP,ParleLCTR,ChainRate,ChainOffRate
	UPDATE R SET R.TotalOffLCTR = QtyInPkt * ParleLCTR,
	R.TotalOffPerTOT = QtyInPkt * ChainRate,
	R.TotalOffPerChain = QtyInPkt * ChainOffRate
	FROM #MTChain R (NOLOCK)
	UPDATE R SET R.OffClmDiff = TotalOffLCTR - TotalOffPerChain,
	R.OffLiabVal = TotalOffPerTOT - TotalOffPerChain
	FROM #MTChain R (NOLOCK)
	UPDATE R SET R.ClmLiabWOTOT = OffLiabVal / TotalOffLCTR, ClmLiabTotSal = OffClmDiff / TotalOffLCTR
	FROM #MTChain R (NOLOCK)
	WHERE TotalOffLCTR <> 0
	INSERT INTO Cs2Cn_Prk_MTChainSKUWise (DistCode,TransDate,CmpRtrCode,PrdCCode,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,
	TotalOffPerTOT,TotalOffPerChain,OffClmDiff,OffLiabVal,ClmLiabWOTOT,ClmLiabTotSal,UploadFlag,SyncId,ServerDate)
	
	SELECT @DistCode,TransDate,CmpRtrCode,PrdCCode,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,
	TotalOffPerTOT,TotalOffPerChain,OffClmDiff,OffLiabVal,ClmLiabWOTOT,ClmLiabTotSal,'N' UploadFlag,NULL,@ServerDate
	FROM #MTChain RD
	
	RETURN			
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_MTChainSKUWise' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_MTChainSKUWise
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_MTChainSKUWise 0,'2018-09-27'
select * from Cs2Cn_Prk_MTChainSKUWise order by slno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_MTChainSKUWise
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_MTChainSKUWise 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
--------------------------------------------------------------------------------------------------
* DATE       AUTHOR				CR/BZ    USER STORY ID       DESCRIPTION                         
**************************************************************************************************
27-09-2018  Amuthakumar P		CR		 CRCRSTPAR0031       Enable Configuration with Tax in Reports
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_Cs2Cn_MTChainSKUWise_withTax @Po_ErrNo,@ServerDate
		RETURN
	END
	-- Till Here CRCRSTPAR0031

	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_MTChainSKUWise WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	--To Filter Retailers	
			
	--To Filter Products
	SELECT DISTINCT P.PrdId
	INTO #FilterProduct
	FROM Product P (NOLOCK) 
	WHERE P.PrdType = 3
	--To Filter Products
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)	
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FR (NOLOCK) WHERE SP.PrdId = FR.PrdId)
	AND S.DlvSts > 3
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE S.Status = 0
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FR (NOLOCK) WHERE SP.PrdId = FR.PrdId)
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],
	CAST(0 AS NUMERIC(18,2)) ChainRate,CAST(0 AS NUMERIC(18,2)) AS ParleLCTR,CAST(0 AS NUMERIC(18,2)) ChainOffRate
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate] FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte FROM #ReturnDetails
	
	) Consolidated	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	UPDATE M SET M.SellRate = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSellRate) NormalSellRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)
	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	UPDATE M SET M.ChainRate = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSpecialRate) NormalSpecialRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo		
		
	UPDATE R SET R.ParleLCTR = (R.[SellRate]+(R.[SellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	UPDATE R SET R.ChainOffRate = D.PrdBatDetailValue
	FROM #MTSalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo			
	
	SELECT S.RtrId,R.CmpRtrCode,S.TransDate,P.PrdId,P.PrdCCode,MRP,SUM(TotalPCS) QtyInPkt,
	ParleLCTR,ChainRate,ChainOffRate,
	CAST(0 AS NUMERIC(18,6)) TotalOffLCTR,CAST(0 AS NUMERIC(18,6)) TotalOffPerTOT,
	CAST(0 AS NUMERIC(18,6)) TotalOffPerChain,CAST(0 AS NUMERIC(18,6)) OffClmDiff,
	CAST(0 AS NUMERIC(18,2)) OffLiabVal,CAST(0 AS NUMERIC(18,2)) ClmLiabWOTOT,
	CAST(0 AS NUMERIC(18,2)) ClmLiabTotSal
	INTO #MTChain
	FROM #MTSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	GROUP BY S.RtrId,R.CmpRtrCode,S.TransDate,P.PrdId,P.PrdCCode,MRP,ParleLCTR,ChainRate,ChainOffRate
	UPDATE R SET R.TotalOffLCTR = QtyInPkt * ParleLCTR,
	R.TotalOffPerTOT = QtyInPkt * ChainRate,
	R.TotalOffPerChain = QtyInPkt * ChainOffRate
	FROM #MTChain R (NOLOCK)
	UPDATE R SET R.OffClmDiff = TotalOffLCTR - TotalOffPerChain,
	R.OffLiabVal = TotalOffPerTOT - TotalOffPerChain
	FROM #MTChain R (NOLOCK)
	UPDATE R SET R.ClmLiabWOTOT = OffLiabVal / TotalOffLCTR, ClmLiabTotSal = OffClmDiff / TotalOffLCTR
	FROM #MTChain R (NOLOCK)
	WHERE TotalOffLCTR <> 0
	INSERT INTO Cs2Cn_Prk_MTChainSKUWise (DistCode,TransDate,CmpRtrCode,PrdCCode,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,
	TotalOffPerTOT,TotalOffPerChain,OffClmDiff,OffLiabVal,ClmLiabWOTOT,ClmLiabTotSal,UploadFlag,SyncId,ServerDate)
	
	SELECT @DistCode,TransDate,CmpRtrCode,PrdCCode,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,
	TotalOffPerTOT,TotalOffPerChain,OffClmDiff,OffLiabVal,ClmLiabWOTOT,ClmLiabTotSal,'N' UploadFlag,NULL,@ServerDate
	FROM #MTChain RD
	
	RETURN			
END
GO
IF EXists (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptMTDebitSummary_withTax' AND Xtype ='P')
DROP PROCEDURE Proc_RptMTDebitSummary_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptMTDebitSummary_withTax 288,2,0,'',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptMTDebitSummary_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/**************************************************************************************************
* PROCEDURE	: Proc_RptMTDebitSummary_withTax
* PURPOSE	: To Return the Trade Promotion Report 
* CREATED	: Mohana -- ICRSTPAR7809
* CREATED DATE	: 28-02-2018 
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
* DATE       AUTHOR		   CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
21-06-2018  Lakshman M		BZ     ILCRSTPAR1100         Return stock type validation added in core stocky 
22-06-2018  Lakshman M		BZ     ILCRSTPAR1100         scheme master control history change type remove validation added In CS.
26-06-2018  Lakshman M		BZ     ILCRSTPAR1151         scheme products taken form sales details
17-09-2018  Amuthakumar P	CR     CRCRSTPAR0021         Promotion claim should be calculating with tax	
09-10-2018  Mohana P		BZ     ILCRSTPAR2313	     TAX CALCULATION CHANGED AS PER CLIENT REQUEST
29-10-2018  Lakshman M      BZ     ILCRSTPAR2427         As per client request scheme and nonscheme product & category wise scheme discount validation added in CS.
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE 
	R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId AND
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT')))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	
	--To Filter Products
	SELECT DISTINCT E.PrdId,E.PrdType
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	WHERE 	
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	--- Till Here
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid ,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId,Cast((SP.PrdSchDiscAmount/SP.BaseQty)AS NUMERIC(18,6)) Schdisc
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId,Cast((SP.PrdSchDisAmt/Sp.BaseQty) AS NUMERIC(18,6)) RtnSchdisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND  SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--------------- Added by LAkshman M On 26/06/2018 PMS ID: ILCRSTPAR1151 ----------------------
	SELECT Salid,RTRid,Schid,PrdId INTO #SalScheme FROM (
	Select Distinct SI.Salid,RTRid,Schid,PrdId from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise SH(NOLOCK) ON SI.Salid=SH.Salid
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	UNION 
	Select Distinct SI.Salid,RTRid,SH.Schid,SIB.prdid from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeDtFreePrd SH(NOLOCK) ON SI.Salid=SH.Salid
	INNER JOIN SalesInvoiceSchemeDtBilled SIB (NOLOCK) ON SIB.SalId =Si.SalId
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	)A
	
	
	SELECT ReturnId,RTRid,Schid,PrdId INTO #RtnScheme FROM (
	Select Distinct A.Returnid,RTRid,Schid,PrdId FROM ReturnSchemeLineDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	UNION
	Select Distinct A.Returnid,RTRid,Schid,0 As Prdid FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	)A
	--------------- Till Here --------------
 	SELECT Salid,RTRid, Schid,A.Prdid INTO #SalSchemeProducts FROM
	 (
		SELECT DISTINCT Salid,RTRid,A.Schid,B.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =C.PrdId  --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT Salid,RTRid,A.Schid, E.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK)ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C (NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	 	SELECT DISTINCT ReturnId,RTRid,Schid,A.Prdid INTO #RtnSchemeProducts FROM
		(
		SELECT DISTINCT ReturnId,RTRid,A.Schid, B.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT ReturnId,RTRid,A.Schid, E.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C(NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId--- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	------------- Added By Lakshman M On 22/06/2018 PMS ID: ILCRSTPAR1100
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)
	SELECT ReturnId,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)
	SELECT salid,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
	----
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)		
	SELECT DISTINCT RS.ReturnID,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	----------------- Added By Lakshman M ON Dated29/10/2018 PMS ID: ILCRSTPAR2458 ---------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)	
	SELECT DISTINCT RS.SalId,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	----------- till here -------------
	------------ Till Here ----------------------
	
	SELECT DISTINCT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,SchDisc,Type,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) NrmlLCTR, CAST(0 AS NUMERIC(18,6)) NrmlSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TOTDifClms
	, CAST(0 AS NUMERIC(18,6)) OfferLCTR, CAST(0 AS NUMERIC(18,6)) OffSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TotOffSalesChain,
	 CAST(0 AS NUMERIC(18,6)) OffClmDiff
	INTO #MTSalesDetails
	FROM 
	(
	SELECT DISTINCT 1 TransType,A.RtrId,A.SalId,SalInvDate TransDate,A.PrdId,A.PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId,
	SchDisc,CASE ISNULL(B.Salid,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #BillingDetails A(NOLOCK)
	LEFT OUTER JOIN #SalSchemeProducts B(NOLOCK) ON A.Salid = B.salid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	UNION ALL
	SELECT  DISTINCT 2 TransType,A.RtrId,A.ReturnID,ReturnDate TransDate,A.PrdId,A.PrdBatId, BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId,
	RtnSchDisc,CASE ISNULL(B.ReturnID,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #ReturnDetails A(NOLOCK)
	LEFT OUTER JOIN #RtnSchemeProducts B(NOLOCK) ON A.Returnid = B.Returnid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	) A
	
	
	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	
	--UPDATE R SET ActualSellRate = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
	--FROM #MTSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	-- Commented by Amuthakumar CRCRSTPAR0021
	--UPDATE A SET ActualSellRate = C.PrdBatDetailValue FROM #MTSalesDetails A INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	--INNER JOIN 	ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = 3
	
	--- Till Here 
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE A SET ActualSellRate = C.PrdBatDetailValue  + (C.PrdBatDetailValue *(T.TaxPerc/100)),
	A.SchDisc =  A.SchDisc  + (A.SchDisc *(T.TaxPerc/100))  FROM #MTSalesDetails A 
	INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	INNER JOIN 	ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = 3
	INNER JOIN #ParleOutputTaxPercentage T ON A.TransType = T.TRANSID AND A.SALID =T.SALID AND A.SLNO=T.PRDSLNO
	
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	--UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	--FROM #MTSalesDetails M (NOLOCK),
	--#SpecialPrice D (NOLOCK)
	--WHERE M.PriceId = D.PriceId 
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue+ (D.PrdBatDetailValue*(T.TaxPerc/100))
	FROM #MTSalesDetails M (NOLOCK),
	#SpecialPrice D (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno	AND M.PriceId = D.PriceId  
		
	 
	--Non Scheme
	UPDATE A SET NrmlLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
		
	UPDATE A SET NrmlSecSalesTot = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
	UPDATE A SET TotDifClms  = NrmlLCTR-NrmlSecSalesTot FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
			
	--Scheme
	
	UPDATE A SET OfferLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
		
	UPDATE A SET OffSecSalesTOT = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
		
	UPDATE A SET TotOffSalesChain =  ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*(ActualSellrate-SchDisc)) ELSE (TotalPcs*(SpecialSellRate-SchDisc)) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	UPDATE A SET OffClmDiff = OfferLCTR-TotOffSalesChain FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	SELECT CtgName,SUM(NrmlLCTR) NrmlLCTR,SUM(NrmlSecSalesTOT) NrmlSecSalesTOT,SUM(TOTDifClms) TOTDifClms,SUM(OfferLCTR) OfferLCTR,
	SUM(OffSecSalesTOT) OffSecSalesTOT,	SUM(OffClmDiff) OffClmDiff,SUM(TotOffSalesChain) TotOffSalesChain,	CAST(0 AS NUMERIC(18,6)) LIABNormalSale,
	CAST(0 AS NUMERIC(18,6)) OffLIABValue,CAST(0 AS NUMERIC(18,6)) TotalSales,CAST(0 AS NUMERIC(18,6)) LIABOffClmWITHOUTTOT,
	CAST(0 AS NUMERIC(18,6)) LIABOffClmTotalSale,CAST(0 AS NUMERIC(18,6)) GrandTotClm,
	CAST(0 AS NUMERIC(18,6)) TOTALLIAB ,CAST(0 AS NUMERIC(18,6)) TotSalTOChain,CAST(0 AS NUMERIC(18,6)) OffLIABTtotalSales,CAST(0 AS NUMERIC(18,6)) TOTLiabTotal
	INTO #MTFinal
	FROM #MTSalesDetails D (NOLOCK) INNER JOIN #FilterRetailer B ON D.Rtrid = B.Rtrid 
	GROUP BY  CtgName
	UPDATE A SET LIABNormalSale = (TotDifClms/NrmlLCTR)*100  FROM #MTFinal A(NOLOCK)  WHERE NrmlLCTR>0
	UPDATE A SET OffLiabvalue = OffSecSalesTOT-TotOffSalesChain  FROM #MTFinal A(NOLOCK) 
	 
	UPDATE A SET TotalSales = OfferLCTR+NrmlLCTR FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET LIABOffClmWITHOUTTOT = (OffLiabvalue/OfferLCTR)*100 FROM #MTFinal A(NOLOCK) WHERE OfferLCTR>0
	
	UPDATE A SET LIABOffClmTotalSale  = (OffClmDiff/OfferLCTR)*100  FROM #MTFinal A(NOLOCK)     WHERE OfferLCTR>0
		
	UPDATE A SET GrandTotClm  = 	(OffClmDiff+TotDifClms)   FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET TOTALLIAB  = 	(GrandTotClm/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0	
	
	UPDATE A SET TotsaltoChain  = NrmlSecsalesTOT+ TotOffSalesChain    FROM #MTFinal A(NOLOCK) 	
	
	UPDATE A SET OffLIABTtotalSales  = 	(OffLIABValue/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0
	
	UPDATE A SET TOTLiabTotal  = 	((GrandTotClm-OffLIABValue)/TotalSales)*100   FROM #MTFinal A(NOLOCK)  WHERE [TotalSales] > 0
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTDebitSummary_Excel')
	DROP TABLE RptMTDebitSummary_Excel
	
	SELECT CtgName,ROUND(NrmlLCTR,2,1) NrmlLCTR,ROUND(NrmlSecSalesTOT,2,1) NrmlSecSalesTOT,ROUND(TOTDifClms,2,1) TOTDifClms,ROUND(LIABNormalSale,2,1) LIABNormalSale,
	ROUND(OfferLCTR,2,1) OfferLCTR,ROUND(OffSecSalesTOT,2,1) OffSecSalesTOT,ROUND(TotOffSalesChain,2,1) TotOffSalesChain,ROUND(OffClmDiff,2,1) OffClmDiff,
	ROUND(OffLIABValue,2,1) OffLIABValue,ROUND(TotalSales,2,1) TotalSales,ROUND(TotSalTOChain,2,1) TotSalTOChain,ROUND(GrandTotClm,2,1) GrandTotClm,
	ROUND(LIABOffClmWITHOUTTOT,2,1) LIABOffClmWITHOUTTOT,ROUND(LIABOffClmTotalSale,2,1) LIABOffClmTotalSale,ROUND(OffLIABTtotalSales,2,1) OffLIABTtotalSales,
	ROUND(TOTLiabTotal,2,1) TOTLiabTotal,ROUND(TOTALLIAB,2,1) TOTALLIAB,1 AS Grpid
	INTO RptMTDebitSummary_Excel
	FROM #MTFinal
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTDebitSummary_Excel	
	
	SELECT * FROM RptMTDebitSummary_Excel(NOLOCK) 
	
	INSERT INTO RptMTDebitSummary_Excel
	SELECT 'Grand TOTAL : ' ,SUM(NrmlLCTR),SUM(NrmlSecSalesTOT),SUM(TOTDifClms),SUM(LIABNormalSale),SUM(OfferLCTR),SUM(OffSecSalesTOT),SUM(TotOffSalesChain),SUM(OffClmDiff),
	SUM(OffLIABValue),SUM(TotalSales),SUM(TotSalTOChain),SUM(GrandTotClm),SUM(LIABOffClmWITHOUTTOT),SUM(LIABOffClmTotalSale),SUM(OffLIABTtotalSales),SUM(TOTLiabTotal),
	SUM(TOTALLIAB),9999999 FROM RptMTDebitSummary_Excel where CtgName not in ('Grand TOTAL : ')
	
	UPDATE  A SET	LIABNormalSale = ROUND((TOTDifClms/NrmlLCTR)*100,2,1) FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND NrmlLCTR>0
	
	UPDATE  A SET LIABOffClmWITHOUTTOT =ROUND((OffLIABValue/OfferLCTR)*100,2,1), LIABOffClmTotalSale = ROUND((OffClmDiff/OfferLCTR)*100,2,1)
	FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND OfferLctr>0
	
	UPDATE  A SET OffLIABTtotalSales = ROUND((OffLIABValue/TotalSales)*100,2,1),
	TOTLiabTotal =ROUND(((GrandTotClm-OffLIABValue)/TotalSales)*100,2,1),
	TOTALLIAB = ROUND((GrandTotClm/TotalSales)*100,2,1)  FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND TotalSales>0
	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,1,'CHAIN NAME','CHAIN NAME',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,2,'TOTAL NORMAL AMOUNT','TOTAL NORMAL AMOUNT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,3,'TOTAL  NORMAL  SEC SALES AS PER TOT','TOTAL  NORMAL  SEC SALES AS PER TOT',1, 1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,4,'TOT DIFF CLAIMS','TOT DIFF CLAIMS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,5,'% LIAB ON NORMAL SALE','% LIAB ON NORMAL SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,6,'TOTAL OFFER NORMAL AMOUNT','TOTAL OFFER NORMAL AMOUNT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,7,'TOTAL OFFER SEC SALES AS PER TOT','TOTAL OFFER SEC SALES AS PER TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,8,'TOTAL OFFER SEC SALE','TOTAL OFFER SEC SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,9,'OFFERS CLAIMS DIFF (TOT+OFFER)','OFFERS CLAIMS DIFF (TOT+OFFER)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,10,'OFFER LIABILITY VALUE','OFFER LIABILITY VALUE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,11,'TOTAL SALE(OFFER + NON OFFER)','TOTAL SALE(OFFER + NON OFFER)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,12,'TOTAL SALE TO CHAIN','TOTAL SALE TO CHAIN',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,13,'GRAND TOTAL CLAIMS','GRAND TOTAL CLAIMS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,14,'% LIAB OF OFFER CLAIMS ON SALE WITHOUT TOT','% LIAB OF OFFER CLAIMS ON SALE WITHOUT TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,15,'% LIAB OF OFFER CLAIMS ON TOTAL SALE','% LIAB OF OFFER CLAIMS ON TOTAL SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,16,'% OFFER LIABILITY ON TOTAL SALES','% OFFER LIABILITY ON TOTAL SALES',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,17,'% TOT LIABILITY ON TOTAL SALES','% TOT LIABILITY ON TOTAL SALES',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,18,'TOTAL % LIAB','TOTAL % LIAB',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,19,'Grpid','Grpid',0,1)
	
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptMTDebitSummary' AND XTYPE ='P')
DROP PROCEDURE Proc_RptMTDebitSummary
GO
/*
BEGIN TRAN
EXEC Proc_RptMTDebitSummary 288,2,0,'',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptMTDebitSummary
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/***********************************************************************************************************************************
* PROCEDURE	: Proc_RptTradePromotionReport
* PURPOSE	: To Return the Trade Promotion Report 
* CREATED	: Mohana -- ICRSTPAR7809
* CREATED DATE	: 28-02-2018 
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
************************************************************************************************************************************
21-06-2018  Lakshman M   BZ     ILCRSTPAR1100         Return stock type validation added in core stocky 
22-06-2018  Lakshman M   BZ     ILCRSTPAR1100         scheme master control history change type remove validation added In CS.
26-06-2018  Lakshman M   BZ     ILCRSTPAR1151         scheme products taken form sales details
27-09-2018  Amuthakumar  CR     CRCRSTPAR0021         Enable Configuration with Tax in Reports
29-10-2018  Lakshman M   BZ     ILCRSTPAR2427         scheme and nonscheme product wise scheme discount validation added in CS.													
************************************************************************************************************************************/  
BEGIN

	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_RptMTDebitSummary_withTax @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE 
	R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId AND
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT')))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	
	--To Filter Products
	SELECT DISTINCT E.PrdId,E.PrdType
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	WHERE 	
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	

	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid ,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId,Cast((SP.PrdSchDiscAmount/SP.BaseQty)AS NUMERIC(18,6)) Schdisc
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId,Cast((SP.PrdSchDisAmt/Sp.BaseQty) AS NUMERIC(18,6)) RtnSchdisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND  SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
 
 
	--------------- Added by LAkshman M On 26/06/2018 PMS ID: ILCRSTPAR1151 ----------------------
	SELECT Salid,RTRid,Schid,PrdId INTO #SalScheme FROM (
	Select Distinct SI.Salid,RTRid,Schid,PrdId from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise SH(NOLOCK) ON SI.Salid=SH.Salid
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	UNION 
	Select Distinct SI.Salid,RTRid,SH.Schid,SIB.prdid from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeDtFreePrd SH(NOLOCK) ON SI.Salid=SH.Salid
	INNER JOIN SalesInvoiceSchemeDtBilled SIB (NOLOCK) ON SIB.SalId =Si.SalId
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	)A
	
	
	SELECT ReturnId,RTRid,Schid,PrdId INTO #RtnScheme FROM (
	Select Distinct A.Returnid,RTRid,Schid,PrdId FROM ReturnSchemeLineDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	UNION
	Select Distinct A.Returnid,RTRid,Schid,0 As Prdid FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	)A
	--------------- Till Here --------------
 	SELECT Salid,RTRid, Schid,A.Prdid INTO #SalSchemeProducts FROM
	 (
		SELECT DISTINCT Salid,RTRid,A.Schid,B.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =C.PrdId  --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT Salid,RTRid,A.Schid, E.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK)ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C (NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
 
	 	SELECT DISTINCT ReturnId,RTRid,Schid,A.Prdid INTO #RtnSchemeProducts FROM
		(
		SELECT DISTINCT ReturnId,RTRid,A.Schid, B.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT ReturnId,RTRid,A.Schid, E.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C(NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId--- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	------------- Added By Lakshman M On 22/06/2018 PMS ID: ILCRSTPAR1100
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)
	SELECT ReturnId,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)

	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)
	SELECT salid,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
	----
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)		
	SELECT DISTINCT RS.ReturnID,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'

	----------------- Added By Lakshman M ON Dated:30/10/2018 PMS ID: ILCRSTPAR2427 ---------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)	
	SELECT DISTINCT RS.SalId,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	--------------- Till here ---------------
	------------ Till Here ----------------------
	
	SELECT DISTINCT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,SchDisc,Type,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) NrmlLCTR, CAST(0 AS NUMERIC(18,6)) NrmlSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TOTDifClms
	, CAST(0 AS NUMERIC(18,6)) OfferLCTR, CAST(0 AS NUMERIC(18,6)) OffSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TotOffSalesChain,
	 CAST(0 AS NUMERIC(18,6)) OffClmDiff
	INTO #MTSalesDetails
	FROM 
	(
	SELECT DISTINCT 1 TransType,A.RtrId,A.SalId,SalInvDate TransDate,A.PrdId,A.PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId,
	SchDisc,CASE ISNULL(B.Salid,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #BillingDetails A(NOLOCK)
	LEFT OUTER JOIN #SalSchemeProducts B(NOLOCK) ON A.Salid = B.salid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	UNION ALL
	SELECT  DISTINCT 2 TransType,A.RtrId,A.ReturnID,ReturnDate TransDate,A.PrdId,A.PrdBatId, BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId,
	RtnSchDisc,CASE ISNULL(B.ReturnID,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #ReturnDetails A(NOLOCK)
	LEFT OUTER JOIN #RtnSchemeProducts B(NOLOCK) ON A.Returnid = B.Returnid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	) A
	
	
	UPDATE A SET ActualSellRate = C.PrdBatDetailValue FROM #MTSalesDetails A INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	INNER JOIN 	ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = 3
	 
	
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	#SpecialPrice D (NOLOCK) 
	WHERE M.PriceId = D.PriceId  
	
	 
	--Non Scheme
	UPDATE A SET NrmlLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
		
	UPDATE A SET NrmlSecSalesTot = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
	UPDATE A SET TotDifClms  = NrmlLCTR-NrmlSecSalesTot FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
			
	--Scheme
	
	UPDATE A SET OfferLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
		
	UPDATE A SET OffSecSalesTOT = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
		
	UPDATE A SET TotOffSalesChain =  ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*(ActualSellrate-SchDisc)) ELSE (TotalPcs*(SpecialSellRate-SchDisc)) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	UPDATE A SET OffClmDiff = OfferLCTR-TotOffSalesChain FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	SELECT CtgName,SUM(NrmlLCTR) NrmlLCTR,SUM(NrmlSecSalesTOT) NrmlSecSalesTOT,SUM(TOTDifClms) TOTDifClms,SUM(OfferLCTR) OfferLCTR,
	SUM(OffSecSalesTOT) OffSecSalesTOT,	SUM(OffClmDiff) OffClmDiff,SUM(TotOffSalesChain) TotOffSalesChain,	CAST(0 AS NUMERIC(18,6)) LIABNormalSale,
	CAST(0 AS NUMERIC(18,6)) OffLIABValue,CAST(0 AS NUMERIC(18,6)) TotalSales,CAST(0 AS NUMERIC(18,6)) LIABOffClmWITHOUTTOT,
	CAST(0 AS NUMERIC(18,6)) LIABOffClmTotalSale,CAST(0 AS NUMERIC(18,6)) GrandTotClm,
	CAST(0 AS NUMERIC(18,6)) TOTALLIAB ,CAST(0 AS NUMERIC(18,6)) TotSalTOChain,CAST(0 AS NUMERIC(18,6)) OffLIABTtotalSales,CAST(0 AS NUMERIC(18,6)) TOTLiabTotal
	INTO #MTFinal
	FROM #MTSalesDetails D (NOLOCK) INNER JOIN #FilterRetailer B ON D.Rtrid = B.Rtrid 
	GROUP BY  CtgName

	UPDATE A SET LIABNormalSale = (TotDifClms/NrmlLCTR)*100  FROM #MTFinal A(NOLOCK)  WHERE NrmlLCTR>0

	UPDATE A SET OffLiabvalue = OffSecSalesTOT-TotOffSalesChain  FROM #MTFinal A(NOLOCK) 
	 
	UPDATE A SET TotalSales = OfferLCTR+NrmlLCTR FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET LIABOffClmWITHOUTTOT = (OffLiabvalue/OfferLCTR)*100 FROM #MTFinal A(NOLOCK) WHERE OfferLCTR>0
	
	UPDATE A SET LIABOffClmTotalSale  = (OffClmDiff/OfferLCTR)*100  FROM #MTFinal A(NOLOCK)     WHERE OfferLCTR>0
		
	UPDATE A SET GrandTotClm  = 	(OffClmDiff+TotDifClms)   FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET TOTALLIAB  = 	(GrandTotClm/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0	
	
	UPDATE A SET TotsaltoChain  = NrmlSecsalesTOT+ TotOffSalesChain    FROM #MTFinal A(NOLOCK) 	
	
	UPDATE A SET OffLIABTtotalSales  = 	(OffLIABValue/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0
	
	UPDATE A SET TOTLiabTotal  = 	((GrandTotClm-OffLIABValue)/TotalSales)*100   FROM #MTFinal A(NOLOCK)  WHERE [TotalSales] > 0
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTDebitSummary_Excel')
	DROP TABLE RptMTDebitSummary_Excel
	
	SELECT CtgName,ROUND(NrmlLCTR,2,1) NrmlLCTR,ROUND(NrmlSecSalesTOT,2,1) NrmlSecSalesTOT,ROUND(TOTDifClms,2,1) TOTDifClms,ROUND(LIABNormalSale,2,1) LIABNormalSale,
	ROUND(OfferLCTR,2,1) OfferLCTR,ROUND(OffSecSalesTOT,2,1) OffSecSalesTOT,ROUND(TotOffSalesChain,2,1) TotOffSalesChain,ROUND(OffClmDiff,2,1) OffClmDiff,
	ROUND(OffLIABValue,2,1) OffLIABValue,ROUND(TotalSales,2,1) TotalSales,ROUND(TotSalTOChain,2,1) TotSalTOChain,ROUND(GrandTotClm,2,1) GrandTotClm,
	ROUND(LIABOffClmWITHOUTTOT,2,1) LIABOffClmWITHOUTTOT,ROUND(LIABOffClmTotalSale,2,1) LIABOffClmTotalSale,ROUND(OffLIABTtotalSales,2,1) OffLIABTtotalSales,
	ROUND(TOTLiabTotal,2,1) TOTLiabTotal,ROUND(TOTALLIAB,2,1) TOTALLIAB,1 AS Grpid
	INTO RptMTDebitSummary_Excel
	FROM #MTFinal
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTDebitSummary_Excel	
	
	SELECT * FROM RptMTDebitSummary_Excel(NOLOCK) 
	
	INSERT INTO RptMTDebitSummary_Excel
	SELECT 'Grand TOTAL : ' ,SUM(NrmlLCTR),SUM(NrmlSecSalesTOT),SUM(TOTDifClms),SUM(LIABNormalSale),SUM(OfferLCTR),SUM(OffSecSalesTOT),SUM(TotOffSalesChain),SUM(OffClmDiff),
	SUM(OffLIABValue),SUM(TotalSales),SUM(TotSalTOChain),SUM(GrandTotClm),SUM(LIABOffClmWITHOUTTOT),SUM(LIABOffClmTotalSale),SUM(OffLIABTtotalSales),SUM(TOTLiabTotal),
	SUM(TOTALLIAB),9999999 FROM RptMTDebitSummary_Excel where CtgName not in ('Grand TOTAL : ')
	
 
	UPDATE  A SET	LIABNormalSale = ROUND((TOTDifClms/NrmlLCTR)*100,2,1) FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND NrmlLCTR>0
	
	UPDATE  A SET LIABOffClmWITHOUTTOT =ROUND((OffLIABValue/OfferLCTR)*100,2,1), LIABOffClmTotalSale = ROUND((OffClmDiff/OfferLCTR)*100,2,1)
	FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND OfferLctr>0
	
	UPDATE  A SET OffLIABTtotalSales = ROUND((OffLIABValue/TotalSales)*100,2,1),
	TOTLiabTotal =ROUND(((GrandTotClm-OffLIABValue)/TotalSales)*100,2,1),
	TOTALLIAB = ROUND((GrandTotClm/TotalSales)*100,2,1)  FROM RptMTDebitSummary_Excel  A where CtgName in ('Grand TOTAL : ') AND TotalSales>0
	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,1,'CHAIN NAME','CHAIN NAME',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,2,'TOTAL NORMAL AMOUNT','TOTAL NORMAL AMOUNT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,3,'TOTAL  NORMAL  SEC SALES AS PER TOT','TOTAL  NORMAL  SEC SALES AS PER TOT',1, 1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,4,'TOT DIFF CLAIMS','TOT DIFF CLAIMS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,5,'% LIAB ON NORMAL SALE','% LIAB ON NORMAL SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,6,'TOTAL OFFER NORMAL AMOUNT','TOTAL OFFER NORMAL AMOUNT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,7,'TOTAL OFFER SEC SALES AS PER TOT','TOTAL OFFER SEC SALES AS PER TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,8,'TOTAL OFFER SEC SALE','TOTAL OFFER SEC SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,9,'OFFERS CLAIMS DIFF (TOT+OFFER)','OFFERS CLAIMS DIFF (TOT+OFFER)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,10,'OFFER LIABILITY VALUE','OFFER LIABILITY VALUE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,11,'TOTAL SALE(OFFER + NON OFFER)','TOTAL SALE(OFFER + NON OFFER)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,12,'TOTAL SALE TO CHAIN','TOTAL SALE TO CHAIN',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,13,'GRAND TOTAL CLAIMS','GRAND TOTAL CLAIMS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,14,'% LIAB OF OFFER CLAIMS ON SALE WITHOUT TOT','% LIAB OF OFFER CLAIMS ON SALE WITHOUT TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,15,'% LIAB OF OFFER CLAIMS ON TOTAL SALE','% LIAB OF OFFER CLAIMS ON TOTAL SALE',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,16,'% OFFER LIABILITY ON TOTAL SALES','% OFFER LIABILITY ON TOTAL SALES',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,17,'% TOT LIABILITY ON TOTAL SALES','% TOT LIABILITY ON TOTAL SALES',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,18,'TOTAL % LIAB','TOTAL % LIAB',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES(288,19,'Grpid','Grpid',0,1)
	
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_MTDebitSummary_New_withTax' AND XTYPE ='P')
DROP PROCEDURE Proc_Cs2Cn_MTDebitSummary_New_withTax
GO
/*
BEGIN TRAN  
EXEC Proc_Cs2Cn_MTDebitSummary_New_withTax 0,'2018-09-17' 
select * from Cs2Cn_Prk_MTDebitSummary
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cs2Cn_MTDebitSummary_New_withTax
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/********************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_MTDebitSummary 
* PURPOSE		: Proc_Cs2Cn_MTDebitSummary (Create for report changes
* CREATED BY	: MOHANA --CCRSTPAR0188
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
---------------------------------------------------------------------------------------------------------
* DATE        AUTHOR		CR/BZ		USER STORY ID       DESCRIPTION   
 02-07-2018   M Lakshman	BZ			ILCRSTPAR1233		Upload flag include in MTDebit summary process.
 10-07-2018   M Lakshman	BZ          ILCRSTPAR1325       sales return logice included from core stocky.
 17-09-2018	  Amuthakumar P	CR			CRCRSTPAR0021       Promotion claim should be calculating with tax	
 09-10-2018   Mohana P		BZ	        ILCRSTPAR2313	    TAX CALCULATION CHANGED AS PER CLIENT REQUEST
 30-10-2018   Lakshman M   BZ           ILCRSTPAR2458       As per client request scheme and nonscheme product and category wise validation added in CS.
*********************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_MTDebitSummary WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT * FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE 
	R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId AND
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT')))
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid ,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId,
	Cast((SP.PrdSchDiscAmount/SP.BaseQty)AS NUMERIC(18,6)) Schdisc
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.DlvSts > 3 AND S.SalInvDate BETWEEN @FromDate AND @ToDate
	--AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId,
	Cast((SP.PrdSchDisAmt/Sp.BaseQty) AS NUMERIC(18,6)) RtnSchdisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND  SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.Status = 0 AND S.ReturnDate BETWEEN @FromDate AND @ToDate
	--AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)

	SELECT Salid,RTRid,Schid,PrdId INTO #SalScheme FROM (
	Select Distinct SI.Salid,RTRid,Schid,PrdId from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise SH(NOLOCK) ON SI.Salid=SH.Salid
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	UNION 
	Select Distinct SI.Salid,RTRid,SH.Schid,SIB.prdid from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeDtFreePrd SH(NOLOCK) ON SI.Salid=SH.Salid
	INNER JOIN SalesInvoiceSchemeDtBilled SIB (NOLOCK) ON SIB.SalId =Si.SalId
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	)A
	
	SELECT ReturnId,RTRid,Schid,PrdId INTO #RtnScheme FROM (
	Select Distinct A.Returnid,RTRid,Schid,PrdId FROM ReturnSchemeLineDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	UNION
	Select Distinct A.Returnid,RTRid,Schid,0 As Prdid FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	)A
	--------------- Till Here --------------
 	SELECT Salid,RTRid, Schid,A.Prdid INTO #SalSchemeProducts FROM
	 (
		SELECT DISTINCT Salid,RTRid,A.Schid,B.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =C.PrdId  --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT Salid,RTRid,A.Schid, E.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK)ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C (NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A --INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	 	SELECT DISTINCT ReturnId,RTRid,Schid,A.Prdid INTO #RtnSchemeProducts FROM
		(
		SELECT DISTINCT ReturnId,RTRid,A.Schid, B.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT ReturnId,RTRid,A.Schid, E.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C(NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId--- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A --INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	
	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	--- Till Here
	
	------------- Added By Lakshman M On 22/06/2018 PMS ID: ILCRSTPAR1100
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)
	SELECT ReturnId,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
	------------- PMS ID: ILCRSTPAR1325 ------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)
	SELECT salid,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
    ---------------- Till Here --------------
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)		
	SELECT DISTINCT RS.ReturnID,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'

	----------------- Added By Lakshman M ON Dated: 30/10/2018 PMS ID: ILCRSTPAR2458 ---------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)	
	SELECT DISTINCT RS.SalId,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	----------- till here -------------
	------------ Till Here ----------------------
	
	SELECT DISTINCT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,SchDisc,Type,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) NrmlLCTR, CAST(0 AS NUMERIC(18,6)) NrmlSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TOTDifClms
	, CAST(0 AS NUMERIC(18,6)) OfferLCTR, CAST(0 AS NUMERIC(18,6)) OffSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TotOffSalesChain,
	 CAST(0 AS NUMERIC(18,6)) OffClmDiff
	INTO #MTSalesDetails
	FROM 
	(
	SELECT DISTINCT 1 TransType,A.RtrId,A.SalId,SalInvDate TransDate,A.PrdId,A.PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId,
	SchDisc,CASE ISNULL(B.Salid,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #BillingDetails A(NOLOCK)
	LEFT OUTER JOIN #SalSchemeProducts B(NOLOCK) ON A.Salid = B.salid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	UNION ALL
	SELECT  DISTINCT 2 TransType,A.RtrId,A.ReturnID,ReturnDate TransDate,A.PrdId,A.PrdBatId, BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId,
	RtnSchDisc,CASE ISNULL(B.ReturnID,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #ReturnDetails A(NOLOCK)
	LEFT OUTER JOIN #RtnSchemeProducts B(NOLOCK) ON A.Returnid = B.Returnid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	) A
		
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'

	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	
	--UPDATE R SET ActualSellRate = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
	--FROM #MTSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	-- Commented by Amuthakumar CRCRSTPAR0021
	--UPDATE A SET ActualSellRate = C.PrdBatDetailValue FROM #MTSalesDetails A INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	--INNER JOIN ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = @SlNo
	--- Till Here 
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE A SET ActualSellRate = C.PrdBatDetailValue  + (C.PrdBatDetailValue *(T.TaxPerc/100)),
	A.SchDisc =  A.SchDisc  + (A.SchDisc *(T.TaxPerc/100))  FROM #MTSalesDetails A 
	INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	INNER JOIN 	ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = 3
	INNER JOIN #ParleOutputTaxPercentage T ON A.TransType = T.TRANSID AND A.SALID =T.SALID AND A.SLNO=T.PRDSLNO
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	--UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	--FROM #MTSalesDetails M (NOLOCK),
	--#SpecialPrice D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId  
	
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue+ (D.PrdBatDetailValue*(T.TaxPerc/100))
	FROM #MTSalesDetails M (NOLOCK),
	#SpecialPrice D (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno	AND M.PriceId = D.PriceId  
	
	
	--Non Scheme
	UPDATE A SET NrmlLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
		
	UPDATE A SET NrmlSecSalesTot = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
	UPDATE A SET TotDifClms  = NrmlLCTR-NrmlSecSalesTot FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'

	--Scheme
	
	UPDATE A SET OfferLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
		
	UPDATE A SET OffSecSalesTOT = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	
	UPDATE A SET TotOffSalesChain =  ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*(ActualSellrate-SchDisc)) ELSE (TotalPcs*(SpecialSellRate-SchDisc)) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	UPDATE A SET OffClmDiff = OfferLCTR-TotOffSalesChain FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'

	SELECT D.RtrId,TransDate,SUM(NrmlLCTR) NrmlLCTR,SUM(NrmlSecSalesTOT) NrmlSecSalesTOT,SUM(TOTDifClms) TOTDifClms,SUM(OfferLCTR) OfferLCTR,
	SUM(OffSecSalesTOT) OffSecSalesTOT,	SUM(OffClmDiff) OffClmDiff,SUM(TotOffSalesChain) TotOffSalesChain,	CAST(0 AS NUMERIC(18,6)) LIABNormalSale,
	CAST(0 AS NUMERIC(18,6)) OffLIABValue,CAST(0 AS NUMERIC(18,6)) TotalSales,CAST(0 AS NUMERIC(18,6)) LIABOffClmWITHOUTTOT,
	CAST(0 AS NUMERIC(18,6)) LIABOffClmTotalSale,CAST(0 AS NUMERIC(18,6)) GrandTotClm,
	CAST(0 AS NUMERIC(18,6)) TOTALLIAB ,CAST(0 AS NUMERIC(18,6)) TotSalTOChain,CAST(0 AS NUMERIC(18,6)) OffLIABTtotalSales,CAST(0 AS NUMERIC(18,6)) TOTLiabTotal
	INTO #MTFinal
	FROM #MTSalesDetails D (NOLOCK) INNER JOIN #FilterRetailer B ON D.Rtrid = B.Rtrid 
	GROUP BY  D.RtrId,TransDate
	
	UPDATE A SET LIABNormalSale = (TotDifClms/NrmlLCTR)*100  FROM #MTFinal A(NOLOCK)  WHERE NrmlLCTR>0

	UPDATE A SET OffLiabvalue = OffSecSalesTOT-TotOffSalesChain  FROM #MTFinal A(NOLOCK) 
	 
	UPDATE A SET TotalSales = OfferLCTR+NrmlLCTR FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET LIABOffClmWITHOUTTOT = (OffLiabvalue/OfferLCTR)*100 FROM #MTFinal A(NOLOCK) WHERE OfferLCTR>0
	
	UPDATE A SET LIABOffClmTotalSale  = (OffClmDiff/OfferLCTR)*100  FROM #MTFinal A(NOLOCK)     WHERE OfferLCTR>0
		
	UPDATE A SET GrandTotClm  = 	(OffClmDiff+TotDifClms)   FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET TOTALLIAB  = 	(GrandTotClm/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0	
	
	UPDATE A SET TotsaltoChain  = NrmlSecsalesTOT+ TotOffSalesChain    FROM #MTFinal A(NOLOCK) 	
	
	UPDATE A SET OffLIABTtotalSales  = 	(OffLIABValue/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0
	
	UPDATE A SET TOTLiabTotal  = 	((GrandTotClm-OffLIABValue)/TotalSales)*100   FROM #MTFinal A(NOLOCK)  WHERE [TotalSales] > 0
	

	INSERT INTO Cs2Cn_Prk_MTDebitSummary(dISTcODE,TransDate,CmpRtrCode,TotalLCTR,SalesTOT,ClaimDiff,LiabSales,TotalOffLCTR,OffTOT,
	TotalOff,OffClaimDiff,LiabOff,TotalSales,TotSalTOChain,GrandTotClm,LiabWOTOT,LiabTOT,OffLIABTtotalSales,TOTLiabTotal,TotalLiab,UploadFlag ---- Added By Lakshman M PMS ID: ILCRSTPAR1233
	)
	SELECT @DistCode,TransDate,B.CmpRtrCode,NrmlLCTR AS NrmlLCTR,NrmlSecSalesTOT AS NrmlSecSalesTOT,ROUND(TOTDifClms,2,1) TOTDifClms,
	ROUND(LIABNormalSale,2,1) LIABNormalSale,	ROUND(OfferLCTR,2,1) OfferLCTR,ROUND(OffSecSalesTOT,2,1) OffSecSalesTOT,
	ROUND(TotOffSalesChain,2,1) TotOffSalesChain,ROUND(OffClmDiff,2,1) OffClmDiff,
	ROUND(OffLIABValue,2,1) OffLIABValue,ROUND(TotalSales,2,1) TotalSales,ROUND(TotSalTOChain,2,1) TotSalTOChain,ROUND(GrandTotClm,2,1) GrandTotClm,
	ROUND(LIABOffClmWITHOUTTOT,2,1) LIABOffClmWITHOUTTOT,ROUND(LIABOffClmTotalSale,2,1) LIABOffClmTotalSale,ROUND(OffLIABTtotalSales,2,1) OffLIABTtotalSales,
	ROUND(TOTLiabTotal,2,1) TOTLiabTotal,ROUND(TOTALLIAB,2,1) TOTALLIAB,'N'
	FROM #MTFinal A
	INNER JOIN Retailer B ON A.Rtrid  = B.RtrId
	--INNER JOIN Product C ON A.Prdid = C.Prdid 
	
	UPDATE Cs2Cn_Prk_MTDebitSummary SET ServerDate=@ServerDate  --- Added By Lakshman M PMS ID: ILCRSTPAR1233	
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_MTDebitSummary_New' AND XTYPE ='P')
DROP PROCEDURE Proc_Cs2Cn_MTDebitSummary_New
GO
/*
BEGIN TRAN
Update A SET  upload = 0,rptupload = 0 from salesinvoice A where salinvdate between '2018-07-01' and '2018-10-31'
Update A SET  upload = 0,rptupload = 0 from returnheader A where returndate between '2018-07-01' and '2018-10-31'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,'2018-10-30'
EXEC Proc_Cs2Cn_MTDebitSummary_New 0,'2018-10-30'
SELECT * FROM Cs2Cn_Prk_MTDebitSummary --where cmprtrcode in(210331400020,210331700162)
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cs2Cn_MTDebitSummary_New
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/********************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_MTDebitSummary 
* PURPOSE		: Proc_Cs2Cn_MTDebitSummary (Create for report changes
* CREATED BY	: MOHANA --CCRSTPAR0188
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
---------------------------------------------------------------------------------------------------------
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 02-07-2018   M Lakshman   BZ			ILCRSTPAR1233		Upload flag include in MTDebit summary process.
 10-07-2018   M Lakshman   BZ           ILCRSTPAR1325       sales return logice included from core stocky.
 27-09-2018   Amuthakumar  CR           CRCRSTPAR0031       Enable Configuration with Tax in Reports	
 30-10-2018   Lakshman M   BZ           ILCRSTPAR2458       As per client request scheme and nonscheme product & category wise scheme discount validation added in CS.
********************************************************************************************************/
SET NOCOUNT ON
BEGIN

	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_Cs2Cn_MTDebitSummary_New_withTax @Po_ErrNo,@ServerDate
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_MTDebitSummary WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT * FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE 
	R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId AND
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT')))
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid ,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId,
	Cast((SP.PrdSchDiscAmount/SP.BaseQty)AS NUMERIC(18,6)) Schdisc
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.DlvSts > 3 AND S.SalInvDate BETWEEN @FromDate AND @ToDate
	--AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId,
	Cast((SP.PrdSchDisAmt/Sp.BaseQty) AS NUMERIC(18,6)) RtnSchdisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND  SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.Status = 0 AND S.ReturnDate BETWEEN @FromDate AND @ToDate
	--AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)

	SELECT Salid,RTRid,Schid,PrdId INTO #SalScheme FROM (
	Select Distinct SI.Salid,RTRid,Schid,PrdId from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise SH(NOLOCK) ON SI.Salid=SH.Salid
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	UNION 
	Select Distinct SI.Salid,RTRid,SH.Schid,SIB.prdid from Salesinvoice SI(NOLOCK) INNER JOIN SalesInvoiceSchemeDtFreePrd SH(NOLOCK) ON SI.Salid=SH.Salid
	INNER JOIN SalesInvoiceSchemeDtBilled SIB (NOLOCK) ON SIB.SalId =Si.SalId
	WHERE Salinvdate between @FromDate AND @ToDate and Dlvsts in (4,5)
	)A
	
	SELECT ReturnId,RTRid,Schid,PrdId INTO #RtnScheme FROM (
	Select Distinct A.Returnid,RTRid,Schid,PrdId FROM ReturnSchemeLineDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	UNION
	Select Distinct A.Returnid,RTRid,Schid,0 As Prdid FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	WHERE ReturnDate between @FromDate AND @ToDate and B.Status = 0  
	)A
	--------------- Till Here --------------
 	SELECT Salid,RTRid, Schid,A.Prdid INTO #SalSchemeProducts FROM
	 (
		SELECT DISTINCT Salid,RTRid,A.Schid,B.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =C.PrdId  --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT Salid,RTRid,A.Schid, E.Prdid FROM #SalScheme A(NOLOCK)
		INNER JOIN SchemeProducts B (NOLOCK)ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C (NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A --INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	 	SELECT DISTINCT ReturnId,RTRid,Schid,A.Prdid INTO #RtnSchemeProducts FROM
		(
		SELECT DISTINCT ReturnId,RTRid,A.Schid, B.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 --- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
		UNION
		SELECT DISTINCT ReturnId,RTRid,A.Schid, E.Prdid FROM #RtnScheme A
		INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C(NOLOCK) ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D(NOLOCK) ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E(NOLOCK) On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F(NOLOCK) On
		F.PrdId = E.Prdid
		INNER JOIN Schememaster SM (Nolock) ON SM.schid =B.schid WHERE SM.Claimable =1 AND A.PrdId =E.PrdId--- Added By Lakshman  M on 21/06/2018 PMS ID:ILCRSTPAR1100
	)A --INNER JOIN #FilterProduct B ON A.PrdId = B.Prdid 
	
	------------- Added By Lakshman M On 22/06/2018 PMS ID: ILCRSTPAR1100
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)
	SELECT ReturnId,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
	------------- PMS ID: ILCRSTPAR1325 ------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)
	SELECT salid,RTRid,B.Schid,C.PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN Product C ON c.PrdCCode = A.FromValue
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =B.SchId 
	WHERE ChangeType='Remove' AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)
    ---------------- Till Here --------------
	INSERT INTO #RtnSchemeProducts(ReturnId,RTRid,SchId,PrdId)		
	SELECT DISTINCT RS.ReturnID,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #RtnScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	----------------- Added By Lakshman M ON Dated:30/10/2018 PMS ID: ILCRSTPAR2458 ---------------
	INSERT INTO #SalSchemeProducts(SalId ,RTRid,SchId,PrdId)	
	SELECT DISTINCT RS.SalId,RS.RtrId ,A.SchId,E.Prdid
	FROM SchemeMaster A
	INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode
	INNER JOIN ProductCategoryValue C ON 
	B.FromValue = C.PrdCtgValCode
	INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
	INNER JOIN Product E On
	D.PrdCtgValMainId = E.PrdCtgValMainId 
	INNER JOIN ProductBatch F On
	F.PrdId = E.Prdid
	INNER JOIN #SalScheme RS (NOLOCK) ON RS.SchId =A.SchId 
	WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )
	AND ChangeType='Remove'
	--------------- Till here ---------------
	------------ Till Here ----------------------
	
	SELECT DISTINCT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,SchDisc,Type,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) NrmlLCTR, CAST(0 AS NUMERIC(18,6)) NrmlSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TOTDifClms
	, CAST(0 AS NUMERIC(18,6)) OfferLCTR, CAST(0 AS NUMERIC(18,6)) OffSecSalesTOT, CAST(0 AS NUMERIC(18,6)) TotOffSalesChain,
	 CAST(0 AS NUMERIC(18,6)) OffClmDiff
	INTO #MTSalesDetails
	FROM 
	(
	SELECT DISTINCT 1 TransType,A.RtrId,A.SalId,SalInvDate TransDate,A.PrdId,A.PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId,
	SchDisc,CASE ISNULL(B.Salid,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #BillingDetails A(NOLOCK)
	LEFT OUTER JOIN #SalSchemeProducts B(NOLOCK) ON A.Salid = B.salid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	UNION ALL
	SELECT  DISTINCT 2 TransType,A.RtrId,A.ReturnID,ReturnDate TransDate,A.PrdId,A.PrdBatId, BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId,
	RtnSchDisc,CASE ISNULL(B.ReturnID,0) WHEN 0 THEN 'NS' ELSE 'S' END AS Type
	FROM #ReturnDetails A(NOLOCK)
	LEFT OUTER JOIN #RtnSchemeProducts B(NOLOCK) ON A.Returnid = B.Returnid AND A.Prdid=B.Prdid AND A.Rtrid =B.Rtrid
	) A
		
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'

	UPDATE A SET ActualSellRate = C.PrdBatDetailValue FROM #MTSalesDetails A INNER JOIN ProductBatch B ON A.Prdid = B.PrdId AND A.Prdbatid = B.PrdBatId
	INNER JOIN 	ProductBatchDetails C ON B.DefaultPriceid = C.PriceId  AND C.SLNo = @SlNo
	
	SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	#SpecialPrice D (NOLOCK) 
	WHERE M.PriceId = D.PriceId  
	
	
	--Non Scheme
	UPDATE A SET NrmlLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
		
	UPDATE A SET NrmlSecSalesTot = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'
	
	UPDATE A SET TotDifClms  = NrmlLCTR-NrmlSecSalesTot FROM #MTSalesDetails A(NOLOCK) WHERE Type='NS'

	--Scheme
	
	UPDATE A SET OfferLCTR = TotalPcs*ActualSellrate FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
		
	UPDATE A SET OffSecSalesTOT = ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*ActualSellrate) ELSE (TotalPcs*SpecialSellRate) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	
	UPDATE A SET TotOffSalesChain =  ( CASE SpecialSellRate WHEN 0 THEN (TotalPcs*(ActualSellrate-SchDisc)) ELSE (TotalPcs*(SpecialSellRate-SchDisc)) END )
	FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'
	
	UPDATE A SET OffClmDiff = OfferLCTR-TotOffSalesChain FROM #MTSalesDetails A(NOLOCK) WHERE Type='S'

	SELECT D.RtrId,TransDate,SUM(NrmlLCTR) NrmlLCTR,SUM(NrmlSecSalesTOT) NrmlSecSalesTOT,SUM(TOTDifClms) TOTDifClms,SUM(OfferLCTR) OfferLCTR,
	SUM(OffSecSalesTOT) OffSecSalesTOT,	SUM(OffClmDiff) OffClmDiff,SUM(TotOffSalesChain) TotOffSalesChain,	CAST(0 AS NUMERIC(18,6)) LIABNormalSale,
	CAST(0 AS NUMERIC(18,6)) OffLIABValue,CAST(0 AS NUMERIC(18,6)) TotalSales,CAST(0 AS NUMERIC(18,6)) LIABOffClmWITHOUTTOT,
	CAST(0 AS NUMERIC(18,6)) LIABOffClmTotalSale,CAST(0 AS NUMERIC(18,6)) GrandTotClm,
	CAST(0 AS NUMERIC(18,6)) TOTALLIAB ,CAST(0 AS NUMERIC(18,6)) TotSalTOChain,CAST(0 AS NUMERIC(18,6)) OffLIABTtotalSales,CAST(0 AS NUMERIC(18,6)) TOTLiabTotal
	INTO #MTFinal
	FROM #MTSalesDetails D (NOLOCK) INNER JOIN #FilterRetailer B ON D.Rtrid = B.Rtrid 
	GROUP BY  D.RtrId,TransDate
	
	UPDATE A SET LIABNormalSale = (TotDifClms/NrmlLCTR)*100  FROM #MTFinal A(NOLOCK)  WHERE NrmlLCTR>0

	UPDATE A SET OffLiabvalue = OffSecSalesTOT-TotOffSalesChain  FROM #MTFinal A(NOLOCK) 
	 
	UPDATE A SET TotalSales = OfferLCTR+NrmlLCTR FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET LIABOffClmWITHOUTTOT = (OffLiabvalue/OfferLCTR)*100 FROM #MTFinal A(NOLOCK) WHERE OfferLCTR>0
	
	UPDATE A SET LIABOffClmTotalSale  = (OffClmDiff/OfferLCTR)*100  FROM #MTFinal A(NOLOCK)     WHERE OfferLCTR>0
		
	UPDATE A SET GrandTotClm  = 	(OffClmDiff+TotDifClms)   FROM #MTFinal A(NOLOCK) 
		
	UPDATE A SET TOTALLIAB  = 	(GrandTotClm/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0	
	
	UPDATE A SET TotsaltoChain  = NrmlSecsalesTOT+ TotOffSalesChain    FROM #MTFinal A(NOLOCK) 	
	
	UPDATE A SET OffLIABTtotalSales  = 	(OffLIABValue/TotalSales)*100   FROM #MTFinal A(NOLOCK) WHERE [TotalSales] > 0
	
	UPDATE A SET TOTLiabTotal  = 	((GrandTotClm-OffLIABValue)/TotalSales)*100   FROM #MTFinal A(NOLOCK)  WHERE [TotalSales] > 0
	

	INSERT INTO Cs2Cn_Prk_MTDebitSummary(dISTcODE,TransDate,CmpRtrCode,TotalLCTR,SalesTOT,ClaimDiff,LiabSales,TotalOffLCTR,OffTOT,
	TotalOff,OffClaimDiff,LiabOff,TotalSales,TotSalTOChain,GrandTotClm,LiabWOTOT,LiabTOT,OffLIABTtotalSales,TOTLiabTotal,TotalLiab,UploadFlag ---- Added By Lakshman M PMS ID: ILCRSTPAR1233
	)
	SELECT @DistCode,TransDate,B.CmpRtrCode,NrmlLCTR AS NrmlLCTR,NrmlSecSalesTOT AS NrmlSecSalesTOT,ROUND(TOTDifClms,2,1) TOTDifClms,
	ROUND(LIABNormalSale,2,1) LIABNormalSale,	ROUND(OfferLCTR,2,1) OfferLCTR,ROUND(OffSecSalesTOT,2,1) OffSecSalesTOT,
	ROUND(TotOffSalesChain,2,1) TotOffSalesChain,ROUND(OffClmDiff,2,1) OffClmDiff,
	ROUND(OffLIABValue,2,1) OffLIABValue,ROUND(TotalSales,2,1) TotalSales,ROUND(TotSalTOChain,2,1) TotSalTOChain,ROUND(GrandTotClm,2,1) GrandTotClm,
	ROUND(LIABOffClmWITHOUTTOT,2,1) LIABOffClmWITHOUTTOT,ROUND(LIABOffClmTotalSale,2,1) LIABOffClmTotalSale,ROUND(OffLIABTtotalSales,2,1) OffLIABTtotalSales,
	ROUND(TOTLiabTotal,2,1) TOTLiabTotal,ROUND(TOTALLIAB,2,1) TOTALLIAB,'N'
	FROM #MTFinal A
	INNER JOIN Retailer B ON A.Rtrid  = B.RtrId
	--INNER JOIN Product C ON A.Prdid = C.Prdid 
	
	UPDATE Cs2Cn_Prk_MTDebitSummary SET ServerDate=@ServerDate  --- Added By Lakshman M PMS ID: ILCRSTPAR1233	
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DebitNoteTopSheet1' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet1
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_DebitNoteTopSheet1 0,'2014-02-04'
select * from Cs2Cn_Prk_DebitNoteTopSheet1 order by slno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet1
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/**************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_DebitNoteTopSheet1 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
***************************************************************************************************
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
06-09-2018  Amuthakumar P	BZ		ILCRSTPAR1917		  Changed Sampling Amount from Sample Issue ( FreeIssueDt)
***************************************************************************************************/     
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheet1 WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	--- Add FromDate, ToDate by Amuthakumar ILCRSTPAR1917
	DECLARE @FromDate DATETIME  
	DECLARE @ToDate DATETIME  
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK) 
	--- Till Here
	
	DECLARE @SamplingAmount AS NUMERIC(18,6)
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'
	
	--- Change by Amuthakumar P ILCRSTPAR1917
	
	--DECLARE @MGSaleable AS INT 
	--DECLARE @MGOffer AS INT
		
	--SELECT @MGSaleable = StockTypeId FROM StockType WHERE UserStockType = 'MGSaleable'
	--SELECT @MGOffer = StockTypeId FROM StockType WHERE UserStockType = 'MGOffer'
	
	--SELECT DISTINCT J.PrdId,J.PrdBatId,B.TaxGroupId,CAST(0 AS NUMERIC(18,2)) TaxPercentage
	--INTO #SamplingBatchTaxPercent
	--FROM StockJournal J,
	--StockJournalDt D (NOLOCK),
	--ProductBatch B (NOLOCK)
	--WHERE J.StkJournalRefNo = D.StkJournalRefNo
	--AND J.PrdBatId = B.PrdBatId	AND J.PrdId = B.PrdId
	--AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	--AND NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = J.StkJournalRefNo)
		
	--SELECT ROW_NUMBER() OVER (ORDER BY T.TaxGroupId) RowNo,
	--MAX(T.PrdBatId) PrdBatId,T.TaxGroupId 
	--INTO #BatchTaxPercent
	--FROM #SamplingBatchTaxPercent T
	--WHERE T.TaxGroupId <> 0
	--GROUP BY T.TaxGroupId
	
	--DECLARE @PrdId AS INT
	--DECLARE @PrdBatId AS INT
	--DECLARE @TaxGroupId AS INT
	--DECLARE @TaxPercentage AS NUMERIC(18,2)
	--DECLARE @RowNo AS INT
	--DECLARE @TotalRow AS INT
	
	--SET @RowNo = 1
	--SELECT @TotalRow = COUNT(TaxGroupId) FROM #BatchTaxPercent D (NOLOCK)	
		
	--TRUNCATE TABLE SamplingBatchTaxPercent
	--WHILE (@RowNo < = @TotalRow)
	--BEGIN	
	--	SELECT @PrdId = B.PrdId, @PrdBatId = S.PrdBatId, @TaxGroupId = B.TaxGroupId
	--	FROM #BatchTaxPercent S,
	--	#SamplingBatchTaxPercent B (NOLOCK)
	--	WHERE S.PrdBatId = B.PrdBatId AND S.TaxGroupId = B.TaxGroupId
	--	AND RowNo = @RowNo
	--	EXEC Proc_SamplingTaxCalCulation @PrdId,@PrdBatId
		
	--	SELECT @TaxPercentage = TaxPercentage FROM SamplingBatchTaxPercent S (NOLOCK)
	--	WHERE PrdBatId = @PrdBatId
		
	--	UPDATE B SET B.TaxPercentage = @TaxPercentage
	--	FROM #SamplingBatchTaxPercent B
	--	WHERE B.TaxGroupId = @TaxGroupId
		
	--	SET @RowNo = @RowNo + 1
	
	--END
		
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheet1 (DistCode,SamplingRefNo,SamplingDate,SamplingAmount,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,J.IssueRefNo,J.IssueDate,
	ISNULL(SUM(D.TotalAmt),0) Amount,
	'N' UploadFlag,NULL,@ServerDate
	FROM FreeIssueHd J (NOLOCK),
	FreeIssueDt D (NOLOCK),
	ProductBatchDetails P (NOLOCK)
	WHERE J.IssueId = D.IssueId 
	AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId 
	AND P.SLNo = @SlNo AND J.IssueDate > '2018-09-30'
	AND J.IssueDate BETWEEN @FromDate AND @ToDate
	AND NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = J.IssueRefNo)
	GROUP BY J.IssueRefNo,J.IssueDate
	--- Till Here ILCRSTPAR1917
	
	--SELECT @DistCode,J.StkJournalRefNo,J.StkJournalDate,
	--SUM( D.StkTransferQty * (P.PrdBatDetailValue + (P.PrdBatDetailValue * (T.TaxPercentage / 100)))) Amount,
	--'N' UploadFlag,NULL,@ServerDate
	--FROM StockJournal J,
	--StockJournalDt D (NOLOCK),
	--ProductBatchDetails P (NOLOCK),
	--#SamplingBatchTaxPercent T (NOLOCK)
	--WHERE J.StkJournalRefNo = D.StkJournalRefNo AND J.PriceId = P.PriceId
	--AND P.PrdBatId = T.PrdBatId
	--AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	--AND P.SLNo = @SlNo
	--AND NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = J.StkJournalRefNo)
	--GROUP BY J.StkJournalRefNo,J.StkJournalDate
	
	INSERT INTO UploadedSampling (SamplingRefNo,UploadDate)
	SELECT SamplingRefNo,GETDATE() FROM Cs2Cn_Prk_DebitNoteTopSheet1 P (NOLOCK)
	WHERE NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = P.SamplingRefNo)
	
	RETURN			
END
GO
-------- Phase II on 24/09/2018
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=17 AND CtrlName='DgManualClaim-104-17-7'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,17,7,'DgManualClaim-104-17-7','Proposed Lib%','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Proposed Lib%','','',1,1)
GO
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=17 AND CtrlName='DgManualClaim-104-17-8'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,17,8,'DgManualClaim-104-17-8','Total Sales','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Total Sales','','',1,1)
GO
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=17 AND CtrlName='DgManualClaim-104-17-9'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,17,9,'DgManualClaim-104-17-9','Actual Lib%','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Actual Lib%','','',1,1)
GO
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=17 AND CtrlName='DgManualClaim-104-17-10'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,17,10,'DgManualClaim-104-17-10','Circular No','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Circular No','','',1,1)
GO
DELETE FROM CustomCaptions WHERE [TransId]=104 AND [CtrlId]=17 AND CtrlName='DgManualClaim-104-17-11'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) VALUES 
(104,17,11,'DgManualClaim-104-17-11','Circular Date','','',1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),'Circular Date','','',1,1)
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Import_ManualClaimDescription' AND XTYPE='P')
DROP PROCEDURE Proc_Import_ManualClaimDescription
GO
CREATE PROCEDURE Proc_Import_ManualClaimDescription
(
	@Pi_Records AS NTEXT
)
AS
/****************************************************************************************************************************************
* PROCEDURE		: Proc_Import_ManualClaimDescription
* PURPOSE		: To insert records to parking table 
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 22/06/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
----------------------------------------------------------------------------------------------------------------------------------------      
 22/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
 01/10/2018  Amuthakumar P		CR		CRCRSTPAR0029		Add New Columns to import CircularNo, CircularDate, ProposedLibPer From Console
****************************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
		DECLARE @hDoc AS INTEGER
		EXEC SP_Xml_PrepareDocument @hDoc OUTPUT,@Pi_Records
		--- Updated by Amuthakumar CRCRSTPAR0029 on 01/10/2018
		INSERT INTO Cn2Cs_Prk_ManualClaimDescription (DistCode,CircularNo,CircularDate,ManualClmDesc,
		ValidFromDate,ValidToDate,ProposedLibPer,EffectiveFromDate,ActiveStatus,DownloadFlag,CreatedDate)
		SELECT DistCode,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,
		ProposedLibPer,EffectiveFromDate,ActiveStatus,ISNULL(DownloadFlag,'D'),ISNULL(CreatedDate,GETDATE())
		FROM OPENXML (@hDoc,'/Root/Console2CS_ManualClaimDescription',1)
		WITH	(
						 DistCode				[Varchar](50),
						 [CircularNo]			[nvarchar](100),
						 [CircularDate]			[datetime],
						 [ManualClmDesc]		[Varchar](150),
						 [ValidFromDate]		[DATETIME],
						 [ValidToDate]			[DATETIME],
						 [ProposedLibPer]		[numeric](18, 2),
						 [EffectiveFromDate]	[datetime],
						 [ActiveStatus]			[Integer],
						 [DownloadFlag]			[Varchar](1),
						 [CreatedDate]			[DATETIME]
						
				) XmlObj
		EXECUTE SP_Xml_RemoveDocument @hDoc
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_ManualClaimDescription' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_ManualClaimDescription
GO
CREATE PROCEDURE  Proc_Cn2Cs_ManualClaimDescription
(
	@Po_ErrNo	INT OUTPUT
)
AS
/***************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_ManualClaimDescription
* PURPOSE		: To insert records to parking table To main table DebitNote retailer
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 22/06/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
----------------------------------------------------------------------------------------------------------------------------------------      
 22/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
 01/10/2018  Amuthakumar P		CR		CRCRSTPAR0029		Add New Columns to import CircularNo, CircularDate, ProposedLibPer From Console
***************************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @RefId	AS INT
	SET @RefId=0
	SET @Po_ErrNo=0
	DELETE FROM Cn2Cs_Prk_ManualClaimDescription WHERE DownloadFlag='Y'

	IF NOT EXISTS(SELECT '*' FROM Cn2Cs_Prk_ManualClaimDescription (NOLOCK) WHERE DownloadFlag='D')
	BEGIN
		RETURN
	END
	
	SELECT @RefId=ISNULL(MAX(RefId),0) FROM ManualClaimDescription(NOLOCK)
	
	UPDATE M SET M.EffectiveFromDate=CONVERT(VARCHAR(10),N.EffectiveFromDate,121),M.ActiveStatus=N.ActiveStatus FROM 
	Cn2Cs_Prk_ManualClaimDescription N(NOLOCK)
	INNER JOIN ManualClaimDescription M (NOLOCK) ON M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121)
	
	---- UPDATED New Columns CircularNo, CircularDate, ProposedLibPer by Amuthakumar  CRCRSTPAR0029 on 01/10/2018
	INSERT INTO ManualClaimDescription(RefId,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,EffectiveFromDate,ActiveStatus,CreatedDate)
	SELECT ROW_NUMBER() OVER(ORDER BY ManualClmDesc,CONVERT(VARCHAR(10),ValidFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121)),CircularNo,CONVERT(VARCHAR(10),CircularDate,121),ManualClmDesc,
	CONVERT(VARCHAR(10),ValidFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121),ProposedLibPer,ISNULL(CONVERT(VARCHAR(10),EffectiveFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121)),ActiveStatus,GETDATE() FROM Cn2Cs_Prk_ManualClaimDescription N(NOLOCK)
	WHERE DownloadFlag='D' AND ISNULL(ManualClmDesc,'')<>'' 
	and NOT EXISTS(SELECT * FROM ManualClaimDescription M (NOLOCK) WHERE M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121))
	
	UPDATE N SET DownloadFlag='Y'  FROM Cn2Cs_Prk_ManualClaimDescription N (NOLOCK)
	WHERE EXISTS(SELECT * FROM ManualClaimDescription M (NOLOCK) WHERE M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121))
END
GO
DELETE FROM HotSearchEditorDt WHERE FormId=10210 
INSERT INTO HotSearchEditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
SELECT 2,10210,'Description','Description','ManualClmDesc',4520,0,'HotSch-104-2000-8',104 
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnManualClmDesc]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION Fn_ReturnManualClmDesc
GO
-- select * from manualclaimdescription
--SELECT * FROM Fn_ReturnManualClmDesc('2018-09-01','2018-09-30','2018-09-03')
CREATE FUNCTION Fn_ReturnManualClmDesc(@FromDate AS DATETIME,@ToDate AS DATETIME,@ClmDate AS DATETIME)
RETURNS @ReturnManualDesc TABLE
(
	RefId		INT,
	ManualClmDesc VARCHAR(200)
	
)	
AS
/************************************************************************************************************************************
* PROCEDURE		: Fn_ReturnManualClmDesc
* PURPOSE		: To Validate the description in Manual Claim 
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 22/06/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------------------------------------------------------------------------      
 22/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
 03/10/2018  Amuthakumar P		CR		CRCRSTPAR0029       Manual claim description with the status of activation 
 ***************************************************************************************************************************************/ 
BEGIN

DECLARE @TempData AS TABLE
(
	RefID				INT,
	ManualClmDesc		VARCHAR(500),
	EffectiveFromDate	DATETIME
)
	INSERT INTO @TempData (RefID,ManualClmDesc,EffectiveFromDate)
	SELECT RefID,ManualClmDesc, EffectiveFromDate fROM ManualClaimDescription WHERE EffectiveFromDate<=@ClmDate AND ActiveStatus=0
	
	
	INSERT INTO @ReturnManualDesc(RefId,ManualClmDesc)
	SELECT DISTINCT RefId,ManualClmDesc FROM ManualClaimDescription N(NOLOCK) 
	WHERE (@FromDate BETWEEN ValidFromDate and ValidToDate OR @ToDate BETWEEN ValidFromDate and ValidToDate
	or ValidFromDate BETWEEN @FromDate and @ToDate or ValidToDate BETWEEN @FromDate and @ToDate)
	AND NOT EXISTS(SELECT * FROM @TempData M WHERE M.RefID=N.RefID)
		
	--SELECT DISTINCT RefId,ManualClmDesc FROM ManualClaimDescription(NOLOCK) 
	--WHERE (@FromDate BETWEEN ValidFromDate and EffectiveFromDate OR @ToDate BETWEEN ValidFromDate and EffectiveFromDate
	--OR ValidFromDate BETWEEN @FromDate and @ToDate or EffectiveFromDate BETWEEN @FromDate and @ToDate)
	-- added by Amuthakumar CRCRSTPAR0029

RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FN_ReturnManualClaimDetails]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FN_ReturnManualClaimDetails]
GO
--select * from dbo.FN_ReturnManualClaimDetails('MAC1800002')
CREATE FUNCTION [dbo].[FN_ReturnManualClaimDetails](@ReferenceNo AS NVARCHAR(100))
RETURNS @Details TABLE
(
	MacRefNo		NVARCHAR(100),
	RefNo			NVARCHAR(100),
	CircularNo		NVARCHAR(100),
	CircularDate	DATETIME,
	Description		NVARCHAR(200),
	ClaimAmt		NUMERIC(18,6),		
	Remarks			NVARCHAR(200),
	SupportingFiles	VARCHAR(10),
	ChkDuplicate	NVARCHAR(100),
	ProposedLibPercent NUMERIC(8,4),
	TotalSales		NUMERIC(18,6),
	ActualLibPercent NUMERIC(8,4)
)
AS
/**********************************************************************************************************
* FUNCTION : FN_ReturnManualClaimDetails
* PURPOSE   : To Return the Manual claim Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------------------------------------------      
 25/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description a
 25/09/2018  Amuthakumar P      CR      CRCRSTPAR0024       Load description master with New Column Values
***********************************************************************************************************/
BEGIN
	INSERT INTO @Details
	SELECT M.MacRefNo,RefNo,ISNULL(CircularNo,''),CONVERT(VARCHAR(10),CircularDate,121),Description,ClaimAmt,Remarks,
	CASE SupportingFiles WHEN 1 THEN 'YES' ELSE 'NO' END,RefNo as ChkDuplicate,
	ProposedLibPercent, TotalSales, ActualLibPercent 
	FROM ManualClaimDetails M (NOLOCK) 
	WHERE M.MacRefNo=@ReferenceNo
	
RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptManualClaim' AND XTYPE='P')
DROP PROCEDURE Proc_RptManualClaim
GO
/*
BEGIN TRAN
select * from ReportfilterDt where rptid = 105
EXEC Proc_RptManualClaim 105,1,0,'PARLE437',0,0,1
ROLLBACK TRAN
*/
CREATE   PROCEDURE Proc_RptManualClaim
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/****************************************************************************************************
* PROCEDURE  : Proc_RptManualClaim
* PURPOSE    : To Generate Manual Claim Report 
* CREATED BY : Thrinath.K
* CREATED ON : 19/03/2008  
* MODIFICATION 
* DATE         AUTHOR			CR/BZ	   USER STORY ID				DESCRIPTION                         
*****************************************************************************************************
  25/09/2018   Amuthakumar P     CR        CRCRSTPAR0024		Manual claim report new column addition
															   (Proposed Lib%,Total sales,Actual Lib %)
*****************************************************************************************************/        
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 			AS	INT
	DECLARE @DBNAME				AS 	nvarchar(50)
	DECLARE @TblName 			AS	nvarchar(500)
	DECLARE @TblStruct 			AS	nVarchar(4000)
	DECLARE @TblFields 			AS	nVarchar(4000)
	DECLARE @sSql				AS 	nVarChar(4000)
	DECLARE @ErrNo	 			AS	INT
	DECLARE @PurDBName			AS	nVarChar(50)
	--Filter Variable
	DECLARE @CmpId				AS	INT
	DECLARE @FromDate			AS 	DATETIME
	DECLARE @ToDate				AS 	DATETIME
	DECLARE @ClmConfSts			AS	INT
	DECLARE @ClmCode			AS	nVarchar(50)
	--Till Here

--Assgin Value for the Filter Variable

	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @FromDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @ClmConfSts = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,114,@Pi_UsrId))
	SET @ClmCode = (SELECT TOP 1 SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,126,@Pi_UsrId))

	Create TABLE #RptManualClaim
	(
			ClmReference		NVARCHAR(400),
			ClmRefNo	 		NVARCHAR(50),
			ClmDesc				NVARCHAR(50),
			FromDate			VARCHAR(10),
			ToDate				VARCHAR(10),
			ProposedLibPercent	NUMERIC(38,6),
			TotalSales			NUMERIC(38,6),
			ClmAmount			NUMERIC(38,6),
			ActualLibPercent	NUMERIC(38,6),
			CircularDate		VARCHAR(10),
			ClmDate				VARCHAR(10),
			Remarks				NVARCHAR(400),
			DetailsRefNo		NVARCHAR(50),
			DeailsDescription	NVARCHAR(50),
			ClaimableAmt		NUMERIC(38,6),
			Status				NVARCHAR(50)
	)

	SET @TblName = 'RptManualClaim'
	SET @TblStruct ='ClmReference		NVARCHAR(400),
			ClmRefNo	 		NVARCHAR(50),
			ClmDesc				NVARCHAR(50),
			FromDate			VARCHAR(10),
			ToDate				VARCHAR(10),
			ProposedLibPercent	NUMERIC(38,6),
			TotalSales			NUMERIC(38,6),
			ClmAmount			NUMERIC(38,6),
			ActualLibPercent	NUMERIC(38,6),
			CircularDate		VARCHAR(10),
			ClmDate				VARCHAR(10),
			Remarks				NVARCHAR(400),
			DetailsRefNo		NVARCHAR(50),
			DeailsDescription	NVARCHAR(50),
			ClaimableAmt		NUMERIC(38,6),
			Status				NVARCHAR(50),'

	SET @TblFields = 'ClmReference,ClmRefNo,ClmDesc,FromDate,ToDate,ProposedLibPercent,TotalSales,ClmAmount,ActualLibPercent,
					CircularDate,ClmDate,Remarks,DetailsRefNo,DeailsDescription,ClaimableAmt,Status'

	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
			
		INSERT INTO #RptManualClaim (ClmReference,ClmRefNo,ClmDesc,FromDate,ToDate,ProposedLibPercent,TotalSales,ClmAmount,ActualLibPercent,
			CircularDate,ClmDate,Remarks,DetailsRefNo,DeailsDescription,ClaimableAmt,Status)
		SELECT A.MacRefNo,B.CircularNo ,A.Description, CONVERT(VARCHAR(10),D.validfromDate,103), CONVERT(VARCHAR(10),D.validToDate,103),ProposedLibPer,totalsales,
		B.ClaimAmt,ActualLibPercent,CONVERT(VARCHAR(10),B.CircularDate,103),CONVERT(VARCHAR(10),A.MacDate,103),'', B.RefNo, B.Description, B.ClaimAmt ,
		CASE A.Status WHEN 1 THEN 'Confirmed' ELSE 'Not Confirmed' END
		FROM ManualClaimMaster A 
		INNER JOIN ManualClaimdetails B	ON A.MacRefNo = B.MacRefNo
		INNER JOIN ManualClaimDescription D ON B.CircularNo = D.CircularNo	
		INNER JOIN Company C ON A.CmpId = C.CmpId	
		WHERE
		(C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
					C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND  (A.Status = (CASE @ClmConfSts WHEN 0 THEN A.Status ELSE 3 END) OR
					A.Status in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,114,@Pi_UsrId)))
		AND  (A.MacRefNo = (CASE @ClmCode WHEN '0' THEN A.MacRefNo ELSE '' END) OR 
				A.MacRefNo in (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,126,@Pi_UsrId)))
		AND MacDate BETWEEN @FromDate AND @ToDate
		
	   	IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptManualClaim ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ ' WHERE RptId=' + CAST(@Pi_RptId AS nVarchar(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + '' 
				+ 'AND (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '
				+ 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND (Status = (CASE ' + CAST(@ClmConfSts AS nVarchar(10)) + ' WHEN 0 THEN Status ELSE 3 END) OR '
				+ 'Status in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(' + 
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',114,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND 	(MacRefNo = (CASE ' + CAST(@ClmCode AS nVarchar(50)) + ' WHEN ''0'' THEN MacRefNo ELSE '''' END) OR '
				+ 'MacRefNo in (SELECT SCountid FROM Fn_ReturnRptFilterString(' + 
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',126,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
			EXEC (@SSQL)
		END
		IF @Pi_SnapRequired = 1
		   BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptManualClaim'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		    END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		   BEGIN
			SET @SSQL = 'INSERT INTO #RptManualClaim ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		   END
		ELSE
		   BEGIN
			PRINT 'DataBase or Table not Found'
			RETURN
		   END
	END
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId

	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)

	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptManualClaim
	PRINT 'Data Executed'
	SELECT * FROM #RptManualClaim
RETURN
END
GO
DELETE FROM Rptexcelheaders WHERE rptid=105 
INSERT INTO Rptexcelheaders
SELECT 105,1,'ClmReference','Claim Reference',1,1 UNION ALL			
SELECT 105,2,'ClmRefNo','Claim RefNo',1,1 UNION ALL
SELECT 105,3,'ClmDesc','Claim Description',1,1 UNION ALL
SELECT 105,4,'FromDate','From Date',1,1 UNION ALL
SELECT 105,5,'ToDate','To Date',1,1 UNION ALL
SELECT 105,6,'ProposedLibPercent','Proposed Lib %',1,1 UNION ALL
SELECT 105,7,'TotalSales','Total Sales',1,1 UNION ALL
SELECT 105,8,'ClmAmount','Claim Amount',1,1 UNION ALL
SELECT 105,9,'ActualLibPercent','Actual Lib %',1,1 UNION ALL
SELECT 105,10,'CircularDate','Circular Date',1,1 UNION ALL
SELECT 105,11,'ClmDate','Claim Date',1,1 UNION ALL
SELECT 105,12,'Remarks','Remarks',1,1 UNION ALL
SELECT 105,13,'DetailsRefNo','Details Reference No.',1,1 UNION ALL
SELECT 105,14,'DeailsDescription','Detail Description',1,1 UNION ALL
SELECT 105,15,'ClmableAmt','Claimable Amount',1,1 UNION ALL
SELECT 105,16,'Status','Confirmation Status',1,1
GO
--Amuthan Till Here
---Added by Gowsalya.S
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MandatoryDeployment]') AND type in (N'U'))
DROP TABLE [dbo].[MandatoryDeployment]
GO
CREATE TABLE [dbo].[MandatoryDeployment](
	[HFixID] [int] NULL,
	[ManualStatus] [int] NULL,
	[MantatoryStatus] [int] NULL,
	[FileDownloaded] [int] NULL,
	[DeploymentSatus] [int] NULL,
	[createdate] [datetime] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Tbl_UploadRecCountWise_QS]') AND type in (N'U'))
DROP TABLE Tbl_UploadRecCountWise_QS
GO
CREATE TABLE [dbo].[Tbl_UploadRecCountWise_QS](
	[SequenceNo] [int] NULL,
	[ProcessName] [varchar](100) NULL,
	[PrkTableName] [varchar](200) NULL,
	[TRowCount] [int] NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SyncErrorDetails]') AND type in (N'U'))
DROP TABLE [dbo].[SyncErrorDetails]
GO
CREATE TABLE [dbo].[SyncErrorDetails](
	[Slno] [int] IDENTITY(1,1) NOT NULL,
	[Module] [varchar](200) NULL,
	[ProcessName] [varchar](100) NULL,
	[ErrorMsg] [varchar](max) NULL,
	[CreatedDate] [datetime] NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_SyncValidation_QS]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_SyncValidation_QS]
GO
CREATE PROCEDURE [dbo].[Proc_SyncValidation_QS]    
(    
@TypeId INT,    
@Code VARCHAR(100) = '', -- IP Address in Sync Attempt, DistCode in SyncStatus,    
@Val1 Numeric(18)=0, -- SubTypeId in SyncStatus,    
@Val2 Numeric(18)=0, -- SyncId in SyncStatus,    
@Val3 Numeric(18)=0, -- RecCnt in SyncStatus,    
@Val4 VARCHAR(100)='',    
@Val5 VARCHAR(100)='',    
@Val6 VARCHAR(100)=''
)    
As 
/*
***********************************************'**************************************************
* DATE			AUTHOR			CR/BZ		USER STORY ID           DESCRIPTION                         
**************************************************************************************************
* 21/09/2018   Gowsalya S		CR          CRCONSAML0073           Upload RecordcountWise in QS  
***************************************************************************************************
*/    
Begin  
DECLARE @Sql VARCHAR(Max)  
IF @TypeId = 1
BEGIN
	Select Count(1) From SyncErrorStatus(Nolock)
	Select GETDATE()	
END
IF @TypeId = 2
BEGIN
	Update SyncErrorStatus  Set ErrorStatus = '0',ServerDate = Convert(DateTime,@Val4,121),SyncStartDate = CONVERT(DateTime, CONVERT(varchar(25),@Val4,120),120)  
	Where DistCode = @Code 
END
IF @TypeId = 3
BEGIN
	Insert into SyncErrorStatus
	(
		DistCode,
		ErrorStatus,
		SyncStartDate,
		SyncEndDate,
		ServerDate
	)
	Select Distinct @Code,'0',GETDATE(),GETDATE(),CONVERT(DateTime, CONVERT(varchar(25),@Val4,120),120)  
END
IF @TypeId = 4
BEGIN
		SELECT DISTINCT A.SlNo,A.SlNo AS SeqNo,A.Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count 
	    FROM CustomUpDownload A,Tbl_UploadIntegration_QS B Where A.Module = B.ProcessName 
	    UNION 
	    SELECT DISTINCT A.SlNo,A.SlNo AS SeqNo,A.Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count 
	    FROM CustomUpDownload A,Tbl_DownloadIntegration_QS B Where(A.Module = B.ProcessName) 
	    ORDER BY A.SlNo
 END
IF @TypeId = 5
 BEGIN
		Select Distinct SequenceNo,ProcessName,FolderName,PrkTableName  from Tbl_UploadIntegration_QS order by SequenceNo
 END 
 IF @TypeId = 6
 BEGIN
		
		set @Sql = ''
		set @Sql = @Sql + 'Select * from ' + Convert(VARCHAR(100),@Code) + ' Where Uploadflag = ''N'''
		Exec (@Sql)
 END 
IF @TypeId = 7
 BEGIN	
   SET @Sql = ''    
   SET @Sql = @Sql + ' UPDATE ' + Convert(VARCHAR(100),@Code) + ' SET Uploadflag = ''Y''  WHERE DistCode = ' + Convert(VARCHAR(100),@Val4) + ' And Uploadflag = ''N'''    
   Exec (@Sql)
 END 
 IF @TypeId = 8
 BEGIN	
   Update SyncErrorStatus  Set ErrorStatus = '1',SyncEndDate = Convert(DateTime,@Val4,121) Where DistCode = @Code 
 END 
  IF @TypeId = 9
 BEGIN
 IF Exists(SELECT * FROM SyncStatus_QS WHERE DistCode = @Code and SyncId = @Val2)
 BEGIN
	IF @Val1 = 1        
		Begin        
		 UPDATE SyncStatus_QS SET DPStartTime = Getdate(),DPEndTime = Getdate(),UpStartTime = GETDATE(),UpEndTime = GETDATE(),DwnStartTime = GETDATE(),DwnEndTime=GETDATE(),
		 SyncStatus = 0,SyncFlag='N' WHERE DistCode = @Code and SyncId = @Val2       
       End  
	   ELSE IF @Val1 = 2        
		Begin        
		 UPDATE SyncStatus_QS SET DPEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       ELSE IF @Val1 = 3        
		Begin        
		 UPDATE SyncStatus_QS SET UpStartTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End  
       ELSE IF @Val1 = 4        
		Begin        
		 UPDATE SyncStatus_QS SET UpEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End  
       ELSE IF @Val1 = 5        
		Begin        
		 UPDATE SyncStatus_QS SET DwnStartTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       ELSE IF @Val1 = 6        
		 Begin        
		 UPDATE SyncStatus_QS SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       Else IF @Val1 = 7    
		Begin        
      IF @Val3 = 1    
       Begin    
        UPDATE SyncStatus_QS SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2       
       End    
     End   
       Else        
   Begin 
	   INSERT INTO SyncStatus_QS_Archieve  SELECT * FROM SyncStatus_QS (NOLOCK) WHERE DistCode = @Code  
	   DELETE FROM SyncStatus_QS WHERE DistCode = @Code and SyncStatus = 1    
    IF NOT EXISTS( Select * From SyncStatus_QS (Nolock))
	Begin
		INSERT INTO SyncStatus_QS SELECT @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'   
	End    
		INSERT INTO SyncStatus_QS_Archieve SELECT @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'  
       IF @Val1 = 1        
		Begin        
		 UPDATE SyncStatus_QS SET DPStartTime = Getdate(),DPEndTime = Getdate(),UpStartTime = GETDATE(),UpEndTime = GETDATE(),DwnStartTime = GETDATE(),DwnEndTime=GETDATE(),
		 SyncStatus = 0,SyncFlag='N' WHERE DistCode = @Code and SyncId = @Val2       
       End  
	   ELSE IF @Val1 = 2        
		Begin        
		 UPDATE SyncStatus_QS SET DPEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       ELSE IF @Val1 = 3        
		 Begin        
		 UPDATE SyncStatus_QS SET UpStartTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End  
       ELSE IF @Val1 = 4        
		Begin        
		 UPDATE SyncStatus_QS SET UpEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End  
       ELSE IF @Val1 = 5        
		Begin        
		 UPDATE SyncStatus_QS SET DwnStartTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       ELSE IF @Val1 = 6        
		Begin        
		 UPDATE SyncStatus_QS SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2       
       End 
       Else IF @Val1 = 7    
     Begin        
      IF @Val3 = 1    
       Begin    
        UPDATE SyncStatus_QS SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2       
       End    
     End   
   END
 END
 END
  IF @TypeId = 10
 BEGIN	
   Update SyncErrorStatus  Set SyncEndDate = Convert(DateTime,@Val4,121) Where DistCode = @Code 
 END 
   IF @TypeId = 11
 BEGIN	
	Select Distinct SyncStatus from SyncStatus_QS WHERE DistCode = @Code and SyncId = @Val2     
 END 
   IF @TypeId = 12
 BEGIN 
	SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER47') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId   
	SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45','DATATRANSFER48') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId        
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER50') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId   
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER51') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId     
 END
  IF @TypeId = 13 -- Download INTegration Details  ,  Proc_SyncValidation   @TypeId    
 Begin     
  SELECT SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,SelectCount FROM Tbl_DownloadIntegration_QS (Nolock) 
  ORDER BY SequenceNo    
 End
  IF @TypeId = 14 -- Download Notification Details  ,  Proc_SyncValidation   @TypeId    
 Begin     
   SET @Sql = ''    
   SET @Sql = @Sql + 'SELECT A.* FROM ' + Convert(VARCHAR(100),@Code) + 'Count A,Tbl_DownloadIntegration_QS B  WHERE  A.Module = B.ProcessName And A.UpDownload=''Download'' ORDER BY SlNo '    
   Exec (@Sql)
 End  


IF @TypeId = 15         
Begin              
	If @Val1 = 1
	Begin 
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'UploadRecCountWise_QS'          
	End
	Else If @Val1 = 2
	Begin
		Select Count(1) from Tbl_UploadRecCountWise_QS (NOLOCK) WHERE ProcessName = @Code	
	End
	Else If @Val1 = 3
	Begin
		Select ProcessName, TRowCount As RecCnt from Tbl_UploadRecCountWise_QS (NOLOCK) WHERE ProcessName = @Code
	End
	Else IF @Val1 = 4                 
	Begin                
		Set @Sql = ''                
		Set @Sql = @Sql + ' SELECT ISNULL(MAX(SlNo),0) AS MaxSlno,ISNULL(MIN(SlNo),0) AS MinSlno, COUNT(*) AS Cnt FROM ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'' ' 
		Exec (@Sql)                
	 End  
	IF @Val1 = 5            
	Begin            
		Set @Sql = ''            
		Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '            
		Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '            
		Select @Sql            
	End 
	IF @Val1 = 6            
	Begin            
		Set @Sql = ''            
		Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''X'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '            
		Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '            
		Exec (@Sql)            
	End

	IF @Val1 = 7            
	Begin            
		Set @Sql = ''            
		Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''Y'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '            
		Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '            
		Exec (@Sql)            
	End
	

	IF @Val1 = 8            
	Begin            
		SELECT DistributorCode FROM Distributor WHERE Distributorid=1                             
	End			
	  	
End 
End
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_SyncValidation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_SyncValidation]
GO
CREATE PROCEDURE [dbo].[Proc_SyncValidation]      
(          
@TypeId Int,          
@Code Varchar(100) = '', -- IP Address in Sync Attempt, DistCode in SyncStatus,          
@Val1 Numeric(18)=0, -- SubTypeId in SyncStatus,          
@Val2 Numeric(18)=0, -- SyncId in SyncStatus,          
@Val3 Numeric(18)=0, -- RecCnt in SyncStatus,          
@Val4 Varchar(100)='',          
@Val5 Varchar(100)='',          
@Val6 Varchar(100)='' ,
@Val7 Varchar(100)=''          
)          
As 
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
04/10/2017  Gowsalya S   CR          CCONSAML1012            Added HotFixMsg Validation 
07/12/2017  Gowsalya S   CR          CCONSPAR0178            Checking ScriptUpdaterfixid between CS and Console 
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
14/12/2017  Gowsalya S   CR          ISTOCWIP1835            For displaying Syncversion number on Sync exe UI
09/01/2018  Gowsalya S   BZ          ICONSWIP1878            Validation added to check distinct Slno Count  
09/11/2018	Gowsalya S	CR			 CRCONSPAR0035			CSTimer Settings added
*/           
Begin          
--Added By Lakshman M dated on 12-02-2018
BEGIN TRY        
BEGIN TRANSACTION
--Till Here  

 Delete A From SyncErrorDetails A (Nolock) Where (Convert(Varchar(10),CreatedDate,121)) <= (Convert(Varchar(10),GETDATE()- 30,121))
	
 Declare @Sql Varchar(Max)        
 Declare @IntRetVal Int      
 IF @TypeId = 1 -- Distributor Code, Proc_SyncValidation  piTypeId          
 Begin          
  SELECT DistributorCode FROM Distributor WHERE Distributorid=1           
 End          
 IF @TypeId = 2 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 Begin          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER45') AND ModuleName='DataTransfer' Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId     
 End           
 IF @TypeId = 3 -- Sync Attempt Validation  Proc_SyncValidation  @TypeId,@Code          
 Begin          
  Declare @RetTemp Int      
  SET @RetTemp = 1      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
 --SET @RetTemp = 0      
 IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
 Begin      
  SET @RetTemp = 0      
 End       
  End      
  IF (@RetTemp = 0)      
  Begin      
 Select 0      
 RETURN      
  End      
  IF Not Exists (Select * From CSyncStatus Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 1)      
 Begin      
  Truncate table CSyncStatus      
  Insert into CSyncStatus Select GETDATE(),0      
 End      
  Set @Code = (Select Top 1 HostName From Sys.sysprocesses where  status='RUNNABLE' Order By login_time desc)          
  IF ((SELECT Count(*) From SyncAttempt) < 1)          
   BEGIN          
    INSERT INTO SyncAttempt          
    SELECT @Code,1,Getdate()          
    SELECT 1          
   END           
  ELSE          
   BEGIN          
    IF (SELECT Status From SyncAttempt) = 0          
     BEGIN          
      UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
      SELECT 1          
     END          
    ELSE          
     BEGIN          
      IF ((SELECT DatedIFf(hh,StartTime,Getdate()) From SyncAttempt) > 1)          
       BEGIN          
          UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
          SELECT 1          
       END          
      ELSE          
        IF ((SELECT Count(*) From SyncAttempt WHERE IPAddress = @Code) = 1 )          
         BEGIN          
          UPDATE SyncAttempt SET Status = 1,StartTime = Getdate()           
          SELECT 1          
         END          
        ELSE          
         BEGIN          
          SELECT 0                   
         END          
     END          
   END            
 End          
 IF @TypeId = 4 -- Remove from Redownloadrequest,  Proc_SyncValidation   @TypeId          
 Begin          
  TRUNCATE TABLE ReDownLoadRequest          
 End          
 IF @TypeId = 5 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
   IF @Val1 = 1           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess='SyncProcess0' ORDER BY SyncProcess          
   End          
   IF @Val1 = 2           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess<>'SyncProcess0' ORDER BY SyncProcess          
   End          
 End          
 IF @TypeId = 6 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1           
   Begin          
    SELECT DISTINCT SlNo,SlNo AS SeqNo,Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count           
    FROM Customupdownload  ORDER BY  UpDownload Desc ,SlNo        
   End          
  IF @Val1 = 2           
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Upload'          
End          
  IF @Val1 = 3          
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Download'          
   End          
 End          
 IF @TypeId = 7 -- Sync Status Validation,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3          
 Begin          
  IF Exists(Select * from SyncStatus Where DistCode = @Code and SyncId = @Val2)              
   Begin          
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin       
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End          
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End       
     End             
   End              
  Else              
   Begin              
    Delete From SyncStatus Where DistCode = @Code and SyncStatus = 1        
    IF Not Exists (Select * From  SyncStatus (Nolock))      
    Begin        
  Insert into SyncStatus Select @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'      
    End              
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin              
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End       
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End         
     End             
   End            
 End          
 IF @TypeId = 8 -- Select Current SyncId,  Proc_SyncValidation   @TypeId          
 Begin          
  Select IsNull(MAX(SyncId),0) From Sync_Master-- SyncStatus          
 End           
 IF @TypeId = 9 -- Select Syncstatus for this SyncId,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin          
  Select IsNull(Max(SyncStatus),0) From SyncStatus where DistCode = @Code And syncid = @Val1 And SyncStatus = 1          
 End            
 IF @TypeId = 10 -- DB Restoration Concept,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
   Begin          
    Select Count(*) From DefendRestore          
   End           
  IF @Val1 = 2          
   Begin          
    update DefendRestore Set DbStatus = 1,ReqId = 1,CCLockStatus = 1          
   End             
  IF @Val1 = 3          
   Begin          
    Insert into DefendRestore (AccessCode,LastModDate,DbStatus,ReqId,CCLockStatus)      
    Values('',GETDATE(),1,1,1)          
   End           
 End             
 IF @TypeId = 11 -- AAD & Configuration Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId='BotreeSyncCheck'          
  End           
  IF @Val1 = 2          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId LIKE 'BotreeSyncErrLog'          
  End             
  IF @Val1 = 3          
  Begin          
   Select IsNull(Max(FixID),0) from Hotfixlog (NOLOCK)          
  End             
 End             
 IF @TypeId = 12 -- System Date is less than the Last Transaction Date Validation,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT ISNULL(MAX(TransDate),GETDATE()-1) AS TransDate FROM StockLedger          
 End           
 IF @TypeId = 13 -- DayEnd Process Updation,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  UPDATE DayEndProcess SET NextUpDate=@Code WHERE ProcId=13          
 End           
 IF @TypeId = 14 -- Update Sync Attempt Status ,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  Select @Code =  HostName From Sys.sysprocesses where  status='RUNNABLE'          
  Update SyncAttempt Set Status=0 where IPAddress = @Code          
 End            
 IF @TypeId = 15 -- Latest SyncId from Sync_Master ,  Proc_SyncValidation   @TypeId          
 Begin          
  --Select ISNull(Max(SyncId),0) From Sync_Master           
  IF Exists(Select * From SyncStatus (Nolock) Where SyncStatus = 1)      
  Begin      
   Select ISNull(Max(SyncId),0) From Sync_Master (Nolock)      
  End      
  Else      
  Begin      
   Select ISNull(Max(SyncId),0) From SyncStatus (Nolock)      
  End              
 End           
 IF @TypeId = 16 -- Update the Flag as Y for all lesser than the latest Serial No ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF ((Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N') > 0)              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo >=         
    (Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N')               
   End              
   Else              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val1 And SlNo <= @Val2       
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo > @Val2          
   End       
 End            
 IF @TypeId = 17 -- Record Count ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF @Val1 = 1           
  Begin          
   Select Count(*) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2 and UploadFlag = 'N'          
  End          
  IF @Val1 = 2           
  Begin          
   Select Count(Distinct Slno) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
  End             
  IF @Val1 = 3           
  Begin          
   --Select IsNull(Count(*),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
   Select IsNull(Count(Distinct Syncid),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
  End          
 End            
 IF @TypeId = 18 -- Datapreperation Process and Split each 1000 rows for xml file ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin        IF @Val1 = 1           
  Begin          
   SELECT * FROM  CustomUpDownload  WHERE SlNo=@Val2  AND UpDownload='Upload' ORDER BY UpDownLoad,SlNo,SeqNo          
  End          
  IF @Val1 = 2           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 3          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM  ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End              
  IF @Val1 = 4          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT * FROM  ' + Convert(Varchar(100),@Code) + ' WHERE  SlNo= ' + Convert(Varchar(100),@Val2) + '  ORDER BY UpDownLoad,SlNo,SeqNo '          
   Exec (@Sql)          
  End             
  IF @Val1 = 5          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + '  '          
   Exec (@Sql)          
  End           
  IF @Val1 = 6          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' DELETE  FROM   ' + Convert(Varchar(100),@Code) + ' WHERE Downloadflag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 7          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) FROM   ' + Convert(Varchar(100),@Code) + ' WHERE DownloadFlag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 8          
  Begin          
   Set @Sql = ''          
  Set @Sql = @Sql + ' SELECT TRowCount FROM Tbl_DownloadIntegration_Process WHERE PrkTableName =''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 9          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = 0  WHERE ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 10          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = ' + Convert(Varchar(100),@Val2) + ' where ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 11           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MAX(SlNo),0) AS Cnt FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 12           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End            
  IF @Val1 = 13           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 14           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Upload'' '          
   Exec (@Sql)          
  End               
  IF @Val1 = 15           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS DownloadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Download'' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 16           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''' And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 17           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus_Download (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''''-- And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 18      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
  Select @Sql      
 End       
  IF @Val1 = 19      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''X'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 20      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''Y'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 21      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''N'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End         
  IF @Val1 = 22      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE UploadFlag=''Y'' And  SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    --Exec (@Sql)        
    --SET @Sql = ''          
    SET @Sql = @Sql + 'UNION ALL SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    Exec (@Sql)           
 End         
  IF @Val1 = 23      
 Begin      
    SET @Sql = ''    
    --Added on 2018-01-09        
    --SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' ' 
    SET @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '         
    Exec (@Sql)           
 End        
 IF @Val1 = 24      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(DistCode) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' '      
    Exec (@Sql)           
 End       
 End            
 IF @TypeId = 19 -- View Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT * FROM ErrorLog WITH (NOLOCK)          
 End          
 IF @TypeId = 20 -- Remove Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  DELETE FROM ErrorLog           
 End           
 IF @TypeId = 21 -- Download Notification Details Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM  CustomUpDownloadCount WHERE UpDownload='Download' ORDER BY SlNo          
 End           
 IF @TypeId = 22 -- Download Details to xml file ,  Proc_SyncValidation   @TypeId          
Begin           
  SELECT * FROM Cs2Cn_Prk_DownloadedDetails WHERE UploadFlag='N'          
 End           
 IF @TypeId = 23 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_DownloadIntegration_Process ORDER BY SequenceNo          
 End           
 IF @TypeId = 24 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_DownloadIntegration_Process SET TRowCount=0          
 End            
 IF @TypeId = 25 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_DownloadIntegration_Process WHERE ProcessName = @Code          
 End            
 IF @TypeId = 26 -- Upload Consolidated Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_UploadIntegration_Process ORDER BY SequenceNo          
 End            
 IF @TypeId = 27 -- Download Details   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT DISTINCT Module,DownloadedCount FROM CustomUpDownloadCount WHERE UpDownload='Download' AND DownloadedCount>0          
 End            
 IF @TypeId = 28 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeReDownload'          
 End           
 IF @TypeId = 29 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM ReDownLoadRequest         
 End           
 IF @TypeId = 30 -- Showboard    ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeBBOardOnSync' AND Status=1          
 End           
 IF @TypeId = 31 -- Update sync status if disconnect    ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin           
  IF Not Exists (Select * From CS2Console_Consolidated (nolock) Where DistCode = @Code And Syncid = @Val1 And UploadFlag='N')          
  Begin          
   Update Syncstatus Set Syncstatus = 1 Where DistCode = @Code And Syncid = @Val1          
   Select IsNull(Max(SyncStatus),0) From SyncStatus (nolock) Where DistCode = @Code And Syncid = @Val1          
  End          
 End           
 IF @TypeId = 32 -- Update sync status if disconnect,Proc_SyncValidation @TypeId,@Code,@Val1          
 Begin           
  Declare @RETVAL Varchar(Max)          
  Set @RETVAL = ''          
  IF EXISTS (Select * From Chk_MainSalesIMEIUploadCnt (NOLOCK))          
  Begin            
  Select @RETVAL = Cast(COALESCE(@RETVAL + ', ', '') + Convert(Varchar(40),MainTblBillNo) as ntext) From Chk_MainSalesIMEIUploadCnt             
  Select @RETVAL          
  End          
 End          
 IF @TypeId = 33 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select 'Request given for approval so please approve from Central Help Desk.'            
 End            
 IF @TypeId = 34 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select IsNull(LTrim(RTrim(CmpCode)),'') From Company (Nolock) Where DefaultCompany = 1            
 End            
 IF @TypeId = 35 -- Select Download Sync status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin             
  Select IsNull(SyncStatus,0) from Syncstatus_Download (nolock) Where Distcode = @Code and Syncid = @Val1          
 End            
 IF @TypeId = 36 -- Select Max(Syncid) in Download Sync Status  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SyncId),0) From SyncStatus_Download (Nolock)          
 End            
 IF @TypeId = 37 -- Select Max(SlNo) in Console2CS_Consolidated  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SlNo),0) From Console2CS_Consolidated (Nolock) Where Distcode = @Code and Syncid = @Val1          
 End             
 IF @TypeId = 38 -- Syncstatus  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
 Declare @RetState Int          
 Update CSyncStatus Set SyncStatus = 1 Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 0      
 IF Exists (Select * From SyncStatus (Nolock) where DistCode = @Code And syncid = @Val1 And SyncStatus = 1)          
  Begin          
 If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
  IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 1 -- Upload and Download Completed Successfully              
   End          
  Else          
   Begin          
    Set @RetState = 2 -- Upload Completed, Download Incomplete           
   End          
  End      
 Else      
  Begin      
  Set @RetState = 1 -- Upload and Download Completed Successfully       
  End      
  End          
  Else          
  Begin          
   If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
    IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully                
   End          
  Else          
   Begin          
    Set @RetState = 4 -- Upload and Download Incomplete!!!                 
   End          
  End      
 Else      
  Begin      
  Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully       
  End      
  End          
  Select @RetState          
 End             
 IF @TypeId = 39 -- Update Download Sync Status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3            
 Begin             
 -------          
  IF Exists(SELECT * FROM SyncStatus_Download WHERE DistCode = @Code and SyncId = @Val2)                      
   Begin          
    IF @Val1 = 1                      
    Begin                    
    If Exists (Select * from SyncStatus_Download(Nolock)  Where DistCode = @Code and SyncId = @Val2 And SyncStatus =1 And SyncFlag =0) --Added on 2016-10-04             
    Begin    
     IF Exists(SELECT * FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag Not in ('N','D'))  --Added on 2016-07-25             
     Begin              
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag ='Y'              
     End     
   End            
   else     
   Begin    
  DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2        
   End       
     --Update SyncStatus_Download Set SyncStatus=0,SyncFlag=0 Where DistCode = @Code and SyncId = @Val2   -- Added to Parameter S             
     UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
     --IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)                
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin                
        If @Val3 > 0 -- Added on 2016-07-25      
  Begin            
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2         
  End                 
      End              
     End                   
   End                      
  Else                      
   Begin                      
    INSERT INTO SyncStatus_Download_Archieve  SELECT *,Getdate() FROM SyncStatus_Download WHERE DistCode = @Code                 
    DELETE FROM SyncStatus_Download WHERE DistCode = @Code        
  --  INSERT INTO SyncStatus_Download SELECT @Code,@Val2,Getdate(),Getdate(),0,0      
    -----------Added on 2016-07-25-------------      
 if  @Val3 = 0      
 Begin      
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),1,1                      
 End      
 Else      
 Begin                  
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),0,0                      
 End        
 -----------Added on 2016-07-25-------------        
    INSERT INTO SyncStatus_Download_Archieve SELECT @Code,@Val2,Getdate(),Getdate(),0,0,GETDATE()                       
    IF @Val1 = 1                      
    Begin                      
    UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
--     IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)      
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin       
       IF @Val3 > 0 -- Added on 2016-07-25      
  BEGIN                
   DELETE A FROM Console2CS_Consolidated A (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2                   
  END       
      End               
     End                   
   End            
 ------          
 END      
  IF @TypeId = 40 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_Customdownloadintegration ORDER BY SequenceNo          
 End           
 IF @TypeId = 41 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_Customdownloadintegration SET TRowCount=0          
 End       
 IF @TypeId = 42 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_Downloadintegration WHERE ProcessName = @Code          
 End       
 IF @TypeId = 43 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT TRowCount FROM Tbl_Customdownloadintegration WHERE PrkTableName = @Code          
 End       
 IF @TypeId = 44 -- Download Process   ,  Proc_SyncValidation   @TypeId   
 Begin           
  Update Tbl_Customdownloadintegration Set TRowCount = @Val1 WHERE ProcessName = @Code          
 End       
 IF @TypeId = 45 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId        
 Begin         
 Set @IntRetVal = 0        
 IF @Val1 = 1      
 Begin      
  If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')        
   Begin        
    IF Exists (Select * from UtilityProcess where ProcId = 3)        
    Begin        
     IF ((Select Convert(Varchar(100),VersionId) from UtilityProcess where ProcId = 3) <> @Code)        
     Begin        
   Set @IntRetVal = 1            
     End           
    End        
   End        
 End         
 IF @Val1 = 2      
 Begin      
  If Not Exists (Select * From AppTitle (Nolock) Where  SynVersion = @Code)        
   Begin        
   Set @IntRetVal = 1      
   End      
 End      
 Select @IntRetVal       
 End         
 IF @TypeId = 46 -- Data Purge  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 IF Exists (Select * From Sys.objects Where name = 'DataPurgeDetails' and TYPE='U')      
 Begin      
  IF EXISTS (Select * From DataPurgeDetails)      
  Begin      
   Set @IntRetVal = 0      
  End      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 47 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 --IF Exists (Select * From Sys.objects Where name = 'Distributor' and TYPE='U')      
 --Begin      
 -- Update Distributor Set DistStatus = 0 Where DistributorCode = @Code      
 --End      
 End      
 IF @TypeId = 48 -- Unregistered Database  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0      
 IF Not Exists (Select * From SyncStatus (Nolock))      
 Begin      
  Set @IntRetVal = 1 -- Unregistered Database      
 End      
 Else      
 Begin      
  IF Exists (Select * From SyncStatus (Nolock) Where DistCode Is Null or DistCode = '')      
  Begin      
   Set @IntRetVal = 2 -- Distributor Code is not found      
  End      
 End      
 IF (@IntRetVal > 0)      
 Begin      
  Select @IntRetVal      
  RETURN      
 End      
 IF Not Exists (Select * from SyncStatus (Nolock) where SyncId = 0)      
 Begin      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
   IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
   Begin      
    SET @IntRetVal = 3        
   End      
  End      
 End      
 Else      
 Begin      
  SET @IntRetVal = 4      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 49 -- DB Restoration  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0       
 --If Exists (Select * From Cs2Cn_Prk_DBUnlockDetails (Nolock) Where DistCode = @Code And DBUnlockStatus > 0)      
 --Begin      
 -- Set @IntRetVal = 1      
 --End      
 If Exists (Select * From DefendRestore (Nolock) Where ReqId > 0)      
 Begin      
  Set @IntRetVal = 1      
 End       
 Select @IntRetVal      
 End       
 IF @TypeId = 50 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 BEGIN          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER47') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId         
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45','DATATRANSFER48') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer'  And Description ='Upload Path' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  And Description ='Download Path' 
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId 
 END       
 IF @TypeId = 51 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_UploadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End      
 IF @TypeId = 52 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @Sql = ''      
 Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
 Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
 Print (@Sql)      
 Exec (@Sql)      
 End       
 IF @TypeId = 53 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_DownloadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End       
 IF @TypeId = 54   -- Added on 2016-07-23 for Partial data upload         
 Begin                
 IF @Val1 = 1                   
 Begin                  
  Select Count(1) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
 End                  
 IF @Val1 = 2          
 Begin                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End     
  IF @Val1 = 3          
 Begin            
 Update SyncStatus Set SyncStatus = 0, SyncFlag ='N' where DistCode = @Code and SyncId = @Val2                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End           
 End        
 IF @TypeId = 55   -- Added on 2016-08-31 for Auto Quick Sync       
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'AutoQuickSync'      
 End      
 IF @TypeId = 56   -- Added on 2016-08-31 for SyncExe Minimized Mode        
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncExeMinimized'      
 End      
 IF @TypeId = 57   -- Added on 2016-08-31 for SuccessMsgShow      
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SuccessMsgShow'      
 End      
  IF @TypeId = 58    
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PartialUploadDataDelete'      
 End      
 IF @TypeId = 59     
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterAfterDeploy'      
 End  
 IF @TypeId = 60         
 Begin              
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'HotFixMsg'          
 End  
  IF @TypeId = 61          
 Begin              
	Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterHotfixId'          
 End
	IF @TypeId = 62            
	Begin              
		Select Isnull(Max(fixid),0) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog)      
	End
	IF @TypeId = 63          
	Begin   
		IF @Val1 = 1 
		Begin            
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncVersionInUI'     
		End
		IF @Val1 = 2
		Begin          
			If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')            
			Begin 
				IF Exists (Select * from UtilityProcess where ProcId = 3)            
				Begin            
					Select ISNULL(Versionid,'') from UtilityProcess where ProcId = 3
				End
			End
		End           
	End
 --Added By Lakshman M dated on 12-02-2018

 
IF @TypeId = 64  
Begin  
 Insert into SyncErrorDetails    
 (  
  Module, 	
  ProcessName,  
  ErrorMsg,  
  CreatedDate,  
  ServerDate  
 )   
 Values   
 (  
  @Val4,  
  @Val5, 
  @Val6, 
  GetDate(),  
  CONVERT(DateTime, @Val7, 121)  
 )  
     
End  

IF @TypeId = 65             
Begin              

	IF @Val1 = 1               
	Begin              
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'WriteAutoDeploymentStatus'         
	End    

	IF @Val1 = 2
	Begin  

		Insert into MandatoryDeployment    
		(  
			HFixID,
			ManualStatus,
			MantatoryStatus,           
			FileDownloaded,
			DeploymentSatus,
			CreateDate     
		)   
		Values   
		(  
			@Val2,  
			0, 
			1, 
			0,  
			0,
			getdate() 
		)  
     
	End 
              
End 

IF @TypeId = 66         
Begin              
	Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'LoginOCXReg'          
End  

IF @TypeId = 67              
Begin       
	IF @Val1 = 1     
	Begin                
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSAutoNClose'         
	End    
	IF @Val1 = 2    
	Begin              
		Select Substring(ProcessName,0,CHARINDEX('.Exe',ProcessName))  from UtilityProcess (Nolock) Where ProcId = 1
	End                  
End  

IF @TypeId = 68              
Begin       
	IF @Val1 = 1     
	Begin                
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSTimer Enable'         
	End  
	IF @Val1 = 2     
	Begin                
		Select isNull(syncID,0) From syncStatus (Nolock) Where DistCode = @Code        
	End    
	IF @Val1 = 3     
	Begin                
		Select convert(varchar(25),GETDATE(),121)     
	End    

End  
COMMIT TRANSACTION          
END TRY          
BEGIN CATCH          
ROLLBACK TRANSACTION       
INSERT INTO Sync_ErrorLog VALUES ('Proc_SyncValidation', ERROR_MESSAGE(), GETDATE())             
END CATCH          
--till Here  
----------Additional Validation----------              
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_SchemeClaimDetails' AND XTYPE='P')
DROP PROCEDURE Proc_SchemeClaimDetails
GO
/* 
 BEGIN TRAN 
 EXEC Proc_SchemeClaimDetails '2018-04-01','2018-10-05',1,1,0  
 SELECT * FROM SchemeClaimDetails  
 ROLLBACK TRAN
*/ 
CREATE PROCEDURE Proc_SchemeClaimDetails
	(
		@Pi_FromDate DATETIME,
		@Pi_ToDate  DATETIME,
		@Pi_CmpId  INT,
		@Pi_UsrId   INT,
		@Pi_ClmType INT
	)
AS BEGIN
/********************************************************************************************************************************
* FUNCTION: Proc_SchemeClaimDetails  
* PURPOSE: 
* NOTES:   
* CREATED: 
* MODIFIED  
------------------------------------------------------------------------------------------------------------------------------- 
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
********************************************************************************************************************************
09-10-2018  Amuthakumar  BZ     CRCRSTPAR0031			Ignore Unsaleable Sales Return Products when claim
********************************************************************************************************************************/  	
DECLARE @SchMst Table
(
	SchId  INT,
	SchCode nVarchar(100),
	SchDesc nVarChar(100)  ,
	ClaimGroup nVarChar(200),
	BudgetAmount Numeric(18,2),
	BudgetAllocationNo Varchar(100),
	ClmRefId INT
)
CREATE TABLE #SchemeClaimDetails
(
	
	RefId INT,
	RefNo Varchar(50),
	ClmRefId INT,
	ClmGroup Varchar(100),
	Schid INT,
	SlabId INT,
	SchCode Varchar(50),
	SchDesc Varchar(200),
	BudgetAmount Numeric(18,2),
	BudgetAllocationNo Varchar(100),
	DiscountAmt Numeric(36,4),
	FreeAmt Numeric(36,4),
	GiftAmt Numeric(36,4)	
)
	
DECLARE @OIDGiven AS Numeric(36,4)	
DELETE FROM SchemeClaimDetails WHERE UsrId=@Pi_UsrId
INSERT INTO 	@SchMst(SchId,SchCode,SchDesc,ClaimGroup,BudgetAmount,BudgetAllocationNo,ClmRefId)
SELECT A.SchId,A.SchCode,A.SchDsc,B.ClmGrpName,A.Budget,IsNull(A.BudgetAllocationNo,'') as BudgetAllocationNo,ClmRefId FROM
SchemeMaster A WITH (NOLOCK) INNER JOIN ClaimGroupMaster B WITH (NOLOCK) ON A.ClmRefId=B.ClmGrpId
INNER JOIN UdcDetails C WITH (NOLOCK) ON A.ClmRefId=C.MasterRecordId
WHERE A.SchValidFrom >= CONVERT(VARCHAR(10),@Pi_FromDate,121) AND A.SchValidTill<=CONVERT(VARCHAR(10),@Pi_ToDate,121)
AND A.Claimable=1 AND UPPER(C.ColumnValue)=UPPER('Scheme Claim') AND A.CmpId IN(0,@Pi_CmpId)
	INSERT INTO #SchemeClaimDetails(RefId,RefNo,ClmRefId,ClmGroup,Schid,SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,DiscountAmt,FreeAmt,GiftAmt)
	SELECT B.SalId,B.SalInvno,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,
			BudgetAmount,S.BudgetAllocationNo,ISNULL(SUM(FlatAmount),0) +  ISNULL(SUM(DiscountPerAmount),0),0 as FreeAmt,0 as GiftAmt
	FROM SalesInvoiceSchemeLineWise A WITH (NOLOCK) INNER JOIN SalesInvoice B WITH (NOLOCK) ON A.SalId = B.SalId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	WHERE DlvSts in (4,5) AND A.SchClmId =0
	AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,B.SalId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	UNION ALL
	SELECT B.Salid,B.SalInvno,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,BudgetAmount,S.BudgetAllocationNo,
	0 as DiscountAmt,ISNULL(SUM(FreeQty * D.PrdBatDetailValue),0),0 as GiftAmt
	FROM SalesInvoiceSchemeDtFreePrd A WITH (NOLOCK) INNER JOIN SalesInvoice B WITH (NOLOCK) ON A.SalId = B.SalId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
	A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
	C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	WHERE DlvSts in (4,5) AND A.SchClmId =0
	AND B.SalInvDate Between  @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,B.SalId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	UNION ALL
	SELECT B.Salid,B.SalInvno,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,
	0 as DiscountAmt,0 as FreeAmt,ISNULL(SUM(GiftQty * D.PrdBatDetailValue),0)
	FROM SalesInvoiceSchemeDtFreePrd A WITH (NOLOCK) INNER JOIN SalesInvoice B WITH (NOLOCK) ON A.SalId = B.SalId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
	A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
	C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	WHERE DlvSts in (4,5) AND A.SchClmId=0
	AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,B.SalId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	UNION ALL
	SELECT B.ReturnId,B.ReturnCode,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,
	((ISNULL(SUM(ReturnFlatAmount),0) +  ISNULL(SUM(ReturnDiscountPerAmount),0)))*(-1),0 as FreeAmt,0 as GiftAmt
	FROM ReturnSchemeLineDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	WHERE B.Status = 0 AND A.SchClmId =0
	AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,B.ReturnId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	UNION ALL
	SELECT B.ReturnId,B.ReturnCode,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,
	0 as DiscountAmt,ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)*(-1),0 as GiftAmt
	FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
	A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
	C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
		 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	WHERE B.Status = 0 AND A.SchClmId =0
	AND B.ReturnDate Between  @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,B.ReturnId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	UNION ALL
	SELECT B.ReturnId,B.ReturnCode,ClmRefId,ClaimGroup,A.SchId,A.SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,
		0 as DiscountAmt,0 as FreeAmt,ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)*(-1)
	FROM ReturnSchemeFreePrdDt A WITH (NOLOCK) INNER JOIN ReturnHeader B WITH (NOLOCK) ON A.ReturnId = B.ReturnId
	INNER JOIN @SchMst S ON A.SchId = S.SchId
	INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
	A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
	C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	WHERE B.Status = 0 AND A.SchClmId =0
	AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate	
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,B.ReturnId,ClmRefId,ClaimGroup,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	INSERT INTO SchemeClaimDetails(RefId,RefNo,ClmRefId,ClmGroup,Schid,SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,DiscountAmt,FreeAmt,GiftAmt,TotalSpent,UsrId)
	SELECT RefId,RefNo,ClmRefId,ClmGroup,Schid,SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo,
	Convert(Numeric(38,2),Sum(DiscountAmt)) ,
	Convert(Numeric(38,2),sum(FreeAmt)) ,
	Convert(Numeric(38,2),Sum(GiftAmt)),
	Convert(Numeric(38,2),Sum((DiscountAmt + FreeAmt + GiftAmt))),@Pi_UsrId
	FROM #SchemeClaimDetails Group by  RefId,RefNo,ClmRefId,ClmGroup,Schid,SlabId,SchCode,SchDesc,BudgetAmount,BudgetAllocationNo
	DECLARE @SchId AS INT
	DECLARE SchemeCur CURSOR FOR
	SELECT DISTINCT schid FROM SchemeClaimDetails WHERE Usrid=@Pi_UsrId
	OPEN SchemeCur
	FETCH next FROM SchemeCur INTO @SchId
	WHILE @@fetch_status= 0
	BEGIN
	
		SELECT ClmRefId,Schid,SUM(TotalSalesInKg) as TotalSalesInKg,SUM(TotalSalesInValue) as TotalSalesInValue
			,SUM(TotalSalesInKg) as SchemeSalesKG,SUM(TotalSalesInValue) as SchemeSalesValue
		INTO #TotalSales FROM(
		SELECT
		  A.ClmRefId,A.Schid,
		  Case PU.PrdUnitId When  1 THEN Isnull(Sum(PrdUpSKU * Cast(SIP.BaseQty as Float)),0)
		  WHEN 2 THEN Isnull(Sum(P.PrdWgt * Cast(SIP.BaseQty as Float))/1000,0)
		  WHEN 3 THEN Isnull(Sum(P.PrdWgt * Cast(SIP.BaseQty as Float)),0) END AS TotalSalesInKg,
		  ISNULL(SUM(distinct SIP.PrdGrossAmountAftEdit) ,0) AS TotalSalesInValue
		FROM
		 Salesinvoice Si WITH (NOLOCK)
		 Inner Join SalesInvoiceProduct SIp WITH (NOLOCK) On SI.Salid=Sip.Salid
		 Inner join Product P WITH (NOLOCK) On Sip.Prdid=P.Prdid
		 Inner join ProductUnit PU On P.PrdUnitId=Pu.PrdUnitId
		 Inner Join SalesInvoiceSchemeHd SH WITH (NOLOCK)  On SH.salId=Si.SalId
		 Inner join SchemeClaimDetails SD WITH (NOLOCK)  On Sd.Refid=Si.SalId and Sd.RefNo=Si.SalInvno	
		 Inner Join (SELECT Distinct Prdid FROM Fn_ReturnSchemeProductBatch(@SchId)) S ON P.PrdId=S.PrdId,
		 SchemeMaster A WITH (NOLOCK),ClaimGroupMaster F WITH (NOLOCK),
		 UdcDetails G WITH (NOLOCK)
		WHERE
		 SI.SalInvDate BETWEEN  CONVERT(VARCHAR(10),@Pi_FromDate,121) AND CONVERT(VARCHAR(10),@Pi_ToDate,121) AND SI.DlvSts > 3
		 AND A.ClmRefId=F.ClmGrpId AND A.ClmRefId=G.MasterRecordId AND
		 A.SchValidFrom >=CONVERT(VARCHAR(10),@Pi_FromDate,121) AND A.SchValidTill<=CONVERT(VARCHAR(10),@Pi_ToDate,121)
		 AND A.Claimable=1 AND UPPER(G.ColumnValue)=UPPER('Scheme Claim')
		 AND  SH.Schid=A.Schid
		 AND A.SchId=@SchId and P.CmpId=@Pi_CmpId  and Usrid=@Pi_UsrId
		GROUP BY A.ClmRefId,A.Schid,PU.PrdUnitId
		UNION ALL
		SELECT
		  A.ClmRefId,A.Schid,-(1)*
		  Case PU.PrdUnitId When  1 THEN Isnull(Sum(PrdUpSKU * Cast(SIP.BaseQty as Float)),0)
		  WHEN 2 THEN Isnull(Sum(P.PrdWgt * Cast(SIP.BaseQty as Float))/1000,0)
		  WHEN 3 THEN Isnull(Sum(P.PrdWgt * Cast(SIP.BaseQty as Float)),0) END AS TotalSalesInKg,
		  -(1)*ISNULL(SUM(distinct SIP.PrdActualGross) ,0) AS TotalSalesInValue
		FROM
		 Returnheader Si WITH (NOLOCK)
		 Inner Join ReturnProduct SIp WITH (NOLOCK) On SI.ReturnId=Sip.ReturnId
		 AND SIP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) --- Added By Amuthakumar on 09/10/2018 CRCRSTPAR0031
		 Inner join Product P WITH (NOLOCK) On Sip.Prdid=P.Prdid
		 Inner join ProductUnit PU On P.PrdUnitId=Pu.PrdUnitId
		 Inner Join SalesInvoiceSchemeHd SH WITH (NOLOCK) On SH.salId=Si.SalId
		 Inner join SchemeClaimDetails SD WITH (NOLOCK)  On Sd.Refid=Si.ReturnId and Sd.RefNo=Si.ReturnCode	
		 Inner Join (SELECT Distinct Prdid FROM Fn_ReturnSchemeProductBatch(@SchId)) S ON P.PrdId=S.PrdId,
		 SchemeMaster A WITH (NOLOCK),ClaimGroupMaster F WITH (NOLOCK),
		 UdcDetails G WITH (NOLOCK)
		WHERE
		 Si.ReturnDate BETWEEN  CONVERT(VARCHAR(10),@Pi_FromDate,121) AND CONVERT(VARCHAR(10),@Pi_ToDate,121) --AND SI.DlvSts > 3
		 AND A.ClmRefId=F.ClmGrpId AND A.ClmRefId=G.MasterRecordId AND
		 A.SchValidFrom >=CONVERT(VARCHAR(10),@Pi_FromDate,121) AND A.SchValidTill<=CONVERT(VARCHAR(10),@Pi_ToDate,121)
		 AND A.Claimable=1 AND UPPER(G.ColumnValue)=UPPER('Scheme Claim')
		 AND  SH.Schid=A.Schid
		 AND A.SchId=@SchId and P.CmpId=@Pi_CmpId and Usrid= @Pi_UsrId
		GROUP BY A.ClmRefId,A.Schid,PU.PrdUnitId
		 )X Group by ClmRefId,Schid
		
		SELECT @OIDGiven=ISNULL(SUM(B.OIDCalVal),0)
		FROM PurchaseReceipt A
		INNER JOIN PurchaseReceiptProduct B ON  A.PurRcptId=B.PurRcptId
		INNER JOIN (SELECT DISTINCT Prdid FROM Fn_ReturnSchemeProductWithDateRange(@Pi_FromDate,@Pi_ToDate)) S ON B.PrdId=S.PrdId
		WHERE A.InvDate BETWEEN CONVERT(VARCHAR(10),@Pi_FromDate,121) AND CONVERT(VARCHAR(10),@Pi_ToDate,121) AND A.Status=1
		AND B.OIDCalVal > 0 and A.CmpId=@Pi_CmpId
		SET @OIDGiven=ISNULL(@OIDGiven,0)
		INSERT INTO ClaimGroupSchemeDiscount
		SELECT DISTINCT
		A.SchCode,A.SchDesc,A.SchId,0 as SchSelect,A.ClmGroup as ClmGrpName,
		A.ClmRefId as ClmTypeId,A.BudgetAllocationNo as VisaNo,A.BudgetAmount AS Budget,
		TotalSalesInKg,SchemeSalesKG, 		
		TotalSalesInValue,SchemeSalesValue,
		Isnull(@OIDGiven,0)  AS OID,
		A.TotalSpent AS Spent,
		A.TotalSpent AS AmountClaimed,
		0 AS AmountPassed,'' AS Remarks,'Cancelled' as Status,@Pi_UsrId
		FROM
		#TotalSales T INNER JOIN
		(SELECT Schid,ClmRefId,SchCode,SchDesc,ClmGroup,BudgetAllocationNo,Isnull(BudgetAmount,0) as BudgetAmount ,
			SUM(TotalSpent) as TotalSpent FROM SchemeClaimDetails WITH (NOLOCK)
			WHERE Usrid=@Pi_UsrId and Schid=@SchId Group BY Schid,ClmRefId,SchCode,ClmGroup,BudgetAllocationNo,BudgetAmount,SchDesc)A  ON A.Schid=T.SchId and A.ClmRefId=T.ClmRefId		
		
		DROP TABLE  #TotalSales
		INSERT INTO TempClaimMaster (SalId,SalInvNo,Schid,ClaimId,SlabId,ClaimType,Usrid,ClaimRefId)
		SELECT DISTINCT
		  RefId,RefNo,SchId,ClmRefId,Slabid,@Pi_ClmType,@Pi_UsrId,0
		FROM SchemeClaimDetails WITH (NOLOCK)  where Schid=@SchId and Usrid=@Pi_UsrId
	


	FETCH next FROM SchemeCur INTO @SchId
	END
	CLOSE SchemeCur
	DEALLOCATE SchemeCur
END
GO
DELETE FROM HotSearchEditorHd WHERE FormId IN (818,782,679,331)
INSERT INTO HotSearchEditorHd([FormId],[FormName],[ControlName],[SltString],[RemainsltString]) 
VALUES (818,'SampleMaintenance','BatchWorSaleable','Select','SELECT DISTINCT PrdBatID,PrdBatCode,CAST(MRP AS NUMERIC(18,2))MRP,PurchaseRate,SellingRate,PriceId FROM (SELECT A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue AS MRP,  D.PrdBatDetailValue AS PurchaseRate,F.PrdBatDetailValue AS SellingRate,B.PriceId FROM  ProductBatch A (NOLOCK) INNER JOIN ProductBatchDetails B (NOLOCK)      ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1 INNER JOIN BatchCreation C (NOLOCK)ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1    INNER JOIN ProductBatchDetails D (NOLOCK)ON A.PrdBatId = D.PrdBatID AND D.DefaultPrice=1 INNER JOIN BatchCreation E (NOLOCK)  ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1 INNER JOIN ProductBatchDetails F (NOLOCK) ON A.PrdBatId = F.PrdBatID   AND F.DefaultPrice=1 INNER JOIN BatchCreation G (NOLOCK) ON G.BatchSeqId = A.BatchSeqId AND F.SlNo = G.SlNo AND G.SelRte = 1   INNER JOIN ProductBatchLocation PBL ON PBL.PrdBatID=A.PrdBatId WHERE  A.PrdId=vFParam AND A.Status = 1   AND ((PrdBatLcnSih-PrdBatLcnRessih)+(PrdBatLcnUih-PrdBatLcnResUih)+(PrdBatLcnFre-PrdBatLcnResFre))> 0)MainQry order by PrdBatId ASC')
INSERT INTO HotSearchEditorHd([FormId],[FormName],[ControlName],[SltString],[RemainsltString]) 
VALUES (782,'SampleMaintenance','BatchWor','select','SELECT DISTINCT PrdBatID,PrdBatCode,CAST(MRP AS NUMERIC(18,2))MRP,PurchaseRate,SellingRate,PriceId FROM(SELECT A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue AS MRP,  D.PrdBatDetailValue AS PurchaseRate,F.PrdBatDetailValue AS SellingRate,B.PriceId FROM ProductBatch A (NOLOCK)   INNER JOIN ProductBatchDetails B (NOLOCK)ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1 INNER JOIN BatchCreation C (NOLOCK)  ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1 INNER JOIN ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID   AND D.DefaultPrice=1 INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1   INNER JOIN ProductBatchDetails F(NOLOCK) ON A.PrdBatId = F.PrdBatID AND F.DefaultPrice=1 INNER JOIN BatchCreation G (NOLOCK)   ON G.BatchSeqId = A.BatchSeqId AND F.SlNo = G.SlNo AND G.SelRte = 1   INNER JOIN ProductBatchLocation PBL ON A.PrdBatId = PBL.PrdBatId WHERE A.PrdId=vFParam AND A.Status = 1 AND  ((PrdBatLcnSih-PrdBatLcnRessih)+(PrdBatLcnUih-PrdBatLcnResUih)+(PrdBatLcnFre-PrdBatLcnResFre))> 0)MainQry order by PrdBatId ASC')
INSERT INTO HotSearchEditorHd([FormId],[FormName],[ControlName],[SltString],[RemainsltString]) 
VALUES (679,'SampleMaintenance','SampleReceiptBatchCode','select','SELECT DISTINCT PrdBatID,PrdBatCode,  CAST(MRP AS NUMERIC(18,2))MRP,SellingRate,PriceId FROM (SELECT A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue as MRP,  D.PrdBatDetailValue as SellingRate,B.PriceId FROM ProductBatch A (NOLOCK) INNER JOIN   ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1 INNER JOIN   BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1   INNER JOIN ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID AND D.DefaultPrice=1   INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo   AND E.ListPrice = 1 WHERE A.PrdId=vFParam AND A.Status = 1) MainSql ORDER BY PrdBatId ASC')
INSERT INTO HotSearchEditorHd([FormId],[FormName],[ControlName],[SltString],[RemainsltString]) 
VALUES (331,'Sample Receipt','Batch','SELECT','SELECT DISTINCT  PrdBatID,PrdBatCode,CAST(MRP AS NUMERIC(18,2))MRP,PurchaseRate,  SellingRate,PriceId FROM (SELECT A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue AS MRP,D.PrdBatDetailValue AS PurchaseRate,  F.PrdBatDetailValue AS SellingRate,B.PriceId FROM  ProductBatch A (NOLOCK) INNER JOIN ProductBatchDetails B (NOLOCK)  ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1   INNER JOIN BatchCreation C (NOLOCK)ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1  INNER JOIN ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID AND D.DefaultPrice=1   INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1  INNER JOIN ProductBatchDetails F (NOLOCK) ON A.PrdBatId = F.PrdBatID AND F.DefaultPrice=1   INNER JOIN BatchCreation G (NOLOCK) ON G.BatchSeqId = A.BatchSeqId AND F.SlNo = G.SlNo AND G.SelRte = 1  WHERE  A.PrdId=vFParam  AND A.Status = 1 ) MainQry order by PrdBatId ASC')
GO
--Added by Lakshman Live issue
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnRptFilterDtWise]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnRptFilterDtWise]
GO
CREATE FUNCTION [dbo].[Fn_ReturnRptFilterDtWise](@iRptid INT,@iUsrId INT)  
RETURNS @ReportFilter TABLE  
 (  
  FilterDate  DateTime  
 )  
AS  
BEGIN  
/*********************************  
* FUNCTION: Fn_ReturnRptFilterDate  
* PURPOSE: Returns the Filters Date For the Selected Report  
* NOTES:   
* CREATED: Thrinath Kola 28-07-2007  
* MODIFIED   
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
**********************************/  
  
INSERT INTO @ReportFilter(FilterDate)  

 Select FilterDate from ReportFilterDt Where Rptid= @iRptid   
 AND Selid IN (10,11) AND usrid=@iusrid   
  
RETURN  
END   
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_SchUtilization_Report' AND TYPE='P')
DROP PROCEDURE Proc_SchUtilization_Report
GO
/*
--EXEC Proc_SchUtilization_Report '2018-05-01','2018-05-31'  
*/  
CREATE PROCEDURE Proc_SchUtilization_Report
(   
 @Pi_FromDate DATETIME,  
 @Pi_Todate  DATETIME  
)  
AS  
/*********************************  
* PROCEDURE     : Proc_SchUtilization_Report  
* PURPOSE     : General Procedure To Get the Scheme Details into Scheme Temp Table  
* CREATED     : MOhana S  
* PMS      : ILCRSTPAR0546   
*********************************/  
/************************************************************************************************************************************************************
* VERSION |  DATE      |     PERSON      | USER STORY ID  |  CR/BZ |           REMARKS		                          | CODE REVIEW BY     | REVIEW DATE
***********************************************************************************************************************************************************
		| 2018-07-02 |  Deepak K		| (ILCRSTPAR1236) |  BZ   |  Optimization Done to generate the Report quickly  |
		  16-10-2018   Mohana P		BZ	    ILCRSTPAR2343	     Incorprated LIVE Changes in UAT (AS per Awanish discussion, LIVE REport is correct. So we have changed based on live)
************************************************************************************************************************************************************/
SET NOCOUNT ON  
BEGIN  
 DELETE FROM Debitnote_Scheme    
 --Commented By Deepak K 
  --INSERT INTO Debitnote_Scheme (SchId,SlabId,SALid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 --SELECT C.SchId,B.Slabid,A.SALid,ISNULL(SUM(B.FlatAmount),0) As FlatAmount,  
 -- ISNULL(SUM(B.DisCountPerAmount),0) as DiscountPer,  
 -- 0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(C.SchId),1 as Selected,  
 -- 1 as LineType,SalInvDate,B.PrdId  
 --FROM SalesInvoice A(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SalId = B.SalId  
 -- INNER JOIN SchemeMaster C(NOLOCK) ON B.SchId = C.SchId   
 -- WHERE  SalInvDate Between  @Pi_FromDate AND @Pi_Todate AND  
 -- A.Dlvsts >3  
 --GROUP BY C.SchId,B.SlabId,A.Salid,SalInvDate,Budget,B.PrdId  
 /*Added By Deepak K for Report Optimization PMS No : ILCRSTPAR1236 */
  SELECT Distinct C.SchId into #SchemeID
 FROM SalesInvoice A(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SalId = B.SalId  
  INNER JOIN SchemeMaster C(NOLOCK) ON B.SchId = C.SchId   
  WHERE  SalInvDate Between  @Pi_FromDate AND @Pi_Todate AND  
  A.Dlvsts >3  
 GROUP BY C.SchId,B.SlabId,A.Salid,SalInvDate,Budget,B.PrdId 
 SELECT Schid,dbo.Fn_ReturnBudgetUtilized(SchId) as SchemeUtilized INTO #SchemeUtilized from  #SchemeID
 INSERT INTO Debitnote_Scheme (SchId,SlabId,SALid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT C.SchId,B.Slabid,A.SALid,ISNULL(SUM(B.FlatAmount),0) As FlatAmount,  
  ISNULL(SUM(B.DisCountPerAmount),0) as DiscountPer,  
  0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,UT.SchemeUtilized,1 as Selected,  
  1 as LineType,SalInvDate,B.PrdId  
 FROM SalesInvoice A(NOLOCK) INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SalId = B.SalId  
  INNER JOIN SchemeMaster C(NOLOCK) ON B.SchId = C.SchId   
  inner join #SchemeUtilized UT on UT.SchId =C.SchId
  WHERE  SalInvDate Between  @Pi_FromDate AND @Pi_Todate AND  
  A.Dlvsts >3  
 GROUP BY C.SchId,B.SlabId,A.Salid,SalInvDate,Budget,B.PrdId,UT.SchemeUtilized 
 -- Till here PMS No : ILCRSTPAR1236
 INSERT INTO Debitnote_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT DISTINCT L.SchId,L.SlabId,A.Salid ,0 As FlatAmount,0 as DiscountPer,  
  (L.FreeQty * O.PrdBatDetailValue) as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(L.SchId),1 as Selected,  
  1 as LineType,SalInvDate,B.PrdId  
 FROM SalesInvoice A INNER JOIN SalesInvoiceSchemeDtBilled B ON A.SalId = B.SalId  
  AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE  
   B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)  
  INNER JOIN SchemeMaster C ON B.SchId = C.SchId INNER JOIN Product I ON B.PrdID = I.PrdId  
  INNER JOIN ProductBatch J ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId  
  INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L ON A.SalId = L.SalId AND C.SchId = L.SchId  
  AND L.SlabId= B.SlabId INNER JOIN Product M ON L.FreePrdId = M.PrdId  
  INNER JOIN ProductBatch N ON L.FreePrdBatId = N.PrdBatId  
  INNER JOIN ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.FreePriceId  
 INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo  
 AND P.ClmRte = 1  
 WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND A.Dlvsts >3  
 INSERT INTO Debitnote_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT B.SchId,B.SlabId,A.Salid,0 As FlatAmount,0 as DiscountPer,  
 0 as FreeValue,(L.GiftQty * O.PrdBatDetailValue) as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),  
  1 as Selected,1 as LineType,SalInvDate,B.PrdId  
 FROM SalesInvoice A INNER JOIN SalesInvoiceSchemeDtBilled B ON A.SalId = B.SalId  
  AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE  
   B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)  
  INNER JOIN SchemeMaster C ON B.SchId = C.SchId INNER JOIN Product I ON B.PrdID = I.PrdId  
  INNER JOIN ProductBatch J ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId  
  INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L ON A.SalId = L.SalId AND C.SchId = L.SchId  
  AND L.SlabId= B.SlabId INNER JOIN Product M ON L.GiftPrdId = M.PrdId  
  INNER JOIN ProductBatch N ON L.GiftPrdBatId = N.PrdBatId  
  INNER JOIN ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.GiftPriceId  
 INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo  
 AND P.ClmRte = 1  
 WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND A.Dlvsts >3  

 INSERT INTO Debitnote_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT B.SchId,B.SlabId,A.Returnid,-1 * ISNULL(SUM(B.ReturnFlatAmount),0) As FlatAmount,  
  -1 * ISNULL(SUM(B.ReturnDiscountPerAmount),0) as DiscountPer,  
  0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),1 as Selected,  
  2 as LineType,ReturnDate,B.PrdId  
 FROM ReturnHeader A INNER JOIN ReturnSchemeLineDt B ON A.ReturnId = B.ReturnId  
 INNER JOIN REturnProduct P ON P.ReturnID = A.REturnid And B.ReturnID = P.ReturnID AND B.rowid = P.Slno
 AND Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1)
  INNER JOIN SchemeMaster C ON B.SchId = C.SchId   
 WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND A.Status =0   
 GROUP BY B.SchId,B.SlabId,A.Returnid,ReturnDate,Budget,B.PrdId 
  
 INSERT INTO Debitnote_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT RSF.SchId,RSF.SlabId,RH.Returnid,0 AS FlatAmount,0 AS DiscountPer,  
  (-1 * (ISNULL(SUM(RSF.ReturnFreeQty),0) * PBD.PrdBatDetailValue)) AS FreeValue,0 AS GiftValue,SM.Budget AS SchemeBudget,dbo.Fn_ReturnBudgetUtilized(RSF.SchId),  
  1 AS Selected,2 AS LineType,ReturnDate,P.PrdId  
 FROM ReturnHeader RH   
  INNER JOIN ReturnSchemeFreePrdDt RSF ON  RH.ReturnId = RSF.ReturnId   
  INNER JOIN SchemeMaster SM ON  SM.SchId = RSF.SchId   
  INNER JOIN Product P ON RSF.FreePrdId = P.PrdId  
  INNER JOIN ProductBatch PB ON RSF.FreePrdBatId = PB.PrdBatId    
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.FreePriceId  
  INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1  
 WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0  and RH.RETURNID IN (SELECT ReturnID FROM RETURNPRODUCT WHERE Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1))
 GROUP BY RSF.SchId,RSF.SlabId,RH.Returnid,ReturnDate, PBD.PrdBatDetailValue,SM.Budget,P.PrdId  

 INSERT INTO Debitnote_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT RSF.SchId,RSF.SlabId,RH.Returnid,0 AS FlatAmount,0 AS DiscountPer,  
  0 as FreeValue, (-1 * ISNULL(SUM(RSF.ReturnGiftQty),0) * PBD.PrdBatDetailValue) as GiftValue,SM.Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(RSF.SchId),  
  1 as Selected,2 AS LineType,ReturnDate,P.PrdId  
 FROM ReturnHeader RH   
  INNER JOIN ReturnSchemeFreePrdDt RSF ON  RH.ReturnId = RSF.ReturnId   
  INNER JOIN SchemeMaster SM ON  SM.SchId = RSF.SchId   
  INNER JOIN Product P ON RSF.GiftPrdId = P.PrdId  
  INNER JOIN ProductBatch PB ON RSF.GiftPrdBatId = PB.PrdBatId    
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.GiftPriceId  
  INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1  
 WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0  and RH.RETURNID IN (SELECT ReturnID FROM RETURNPRODUCT WHERE Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1))
 GROUP BY RSF.SchId,RSF.SlabId,RH.Returnid,ReturnDate, PBD.PrdBatDetailValue,SM.Budget,P.PrdId  


 INSERT INTO Debitnote_Scheme (SchId,SlabId,salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId)  
 SELECT B.SchId,B.SlabId,A.salid,0 As FlatAmount,0 as DiscountPer,  
  0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),2 as Selected,  
  3 as LineType,SalInvDate,0  
 FROM SalesInvoice A INNER JOIN SalesInvoiceUnSelectedScheme B ON A.SalId = B.SalId  
  INNER JOIN SchemeMaster C ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId  
  INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId  
  INNER JOIN Retailer F ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId  
  LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId  
  INNER JOIN RetailerValueClassMap RVCM on RVCM.Rtrid=F.RtrId  
  INNER JOIN RetailerValueClass RVC on RVCM.RtrValueClassId =RVC.RtrClassId  
  INNER JOIN RetailerCategory RC on RC.CtgMainId=RVC.CtgMainId  
  INNER JOIN RetailerCategoryLevel RCL on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId  
 WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND  
  A.dlvsts >3  
 GROUP BY B.SchId,B.SlabId,A.SAlid,SalInvDate,Budget   
END
GO
---- CR CRCRSTPAR0033 by amuthakumar on 22/10/2018
DELETE FROM ManualConfiguration WHERE ModuleId='MonthEndServerDate' AND ModuleName='Month End with Server Date'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','MonthEndServerDate','Month End with Server Date','Enable Month End Process using Server Date',1,'',0.00,2
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_RetrunClaimDetails' AND XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_RetrunClaimDetails
GO
--SELECT DISTINCT * FROM Fn_RetrunClaimDetails (9,1,'2018-10-01','2018-10-31',0,1,16)
CREATE FUNCTION [dbo].[Fn_RetrunClaimDetails](@Pi_ClaimGrpId AS INT,@Pi_CmpId AS INT,@Pi_FromDate AS DATETIME,@Pi_ToDate AS DATETIME,
@Pi_ClaimCode AS INT,@Pi_UsrId AS INT,@Pi_TransId AS INT) RETURNS
@RetrunClaimDetails TABLE
(
[Reference] NVARCHAR(200),
[Select] INT,
[SpentGrossAmt] NUMERIC(18,2),
[SpentTaxAmt] NUMERIC(18,2),
[Total Spent Amount] NUMERIC(36,6),
[% Claimable] NUMERIC(36,6),
[Claimable Amount] NUMERIC(36,6),
[Recommended Amount] NUMERIC(36,6),
[Received Amount] NUMERIC(36,6),
[Db/Cr Note Selection] INT,
[Status] NVARCHAR(100),
[Remarks] NVARCHAR(500)
)
/************************************************************************************************************************************	
* FUNCTION: Fn_RetrunClaimDetails
* PURPOSE: Returns Claim Details
* NOTES:
* CREATED: Sathishkumar Veeramani on 08-04-2013
* MODIFIED
* DATE         AUTHOR       CR/BZ	   USER STORY ID		 DESCRIPTION                         
************************************************************************************************************************************
  23/10/2018  Amuthakumar P  CR        CRCRSTPAR0033      Load Sample Issue Data in Claim Top Sheet  
************************************************************************************************************************************/
AS
BEGIN
  IF @Pi_ClaimGrpId = 1 --Salesman Salary / DA Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT SC.ScmRefNo as 'Reference' , 0 as 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',SC.Amount as 'Total Spent Amount',ISNULL(CND.Claimable,0) as '% Claimable',
		0.00 as 'Claimable Amount',0 'Recommended Amount', 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' as 'Status','' AS Remarks  
		FROM (SELECT SCM.ScmRefNo , SCM.ScmDate , SCM.CmpId, TotalApprovedAmt Amount FROM  SalesmanClaimMaster SCM WITH (NOLOCK) WHERE SCM.Status = 1) SC  
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON SC.CmpId = CND.CmpId and  CND.ClmGrpId = @Pi_ClaimGrpId WHERE SC.CmpId = @Pi_CmpId 
		AND SC.ScmDate  BETWEEN @Pi_ToDate AND @Pi_ToDate AND SC.ScmRefNo  NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId)AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 2 --DeliveryBoy Salary / DA Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT DC.DbcRefNo AS 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',DC.TotApproveAmt AS 'Total Spent Amount',  isNull(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount',  0 'Recommended Amount' , 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks  
		FROM (SELECT DbcDate,DbcRefNo,CmpId,TotApproveAmt FROM  DeliveryBoyClaimMaster  WITH (NOLOCK) WHERE Status = 1 ) DC  
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON DC.CmpId = CND.CmpId AND  CND.ClmGrpId = @Pi_ClaimGrpId WHERE DC.CmpId = @Pi_CmpId  
		AND DC.DbcDate BETWEEN @Pi_ToDate AND @Pi_ToDate AND DC.DbcRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END  
  ELSE IF @Pi_ClaimGrpId = 3 --Salesman Incentive Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT SIC.SicRefNo as 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',SIC.TotAppInc AS 'Total Spent Amount', ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount',  0 'Recommended Amount' , 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks 
		FROM  (SELECT SicDate,SicRefNo,CmpId,TotAppInc FROM  SMIncentiveCalculatorMaster WITH (NOLOCK) WHERE Status = 1 ) SIC  
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON SIC.CmpId = CND.CmpId and  CND.ClmGrpId = @Pi_ClaimGrpId WHERE SIC.CmpId = @Pi_CmpId  
		AND SIC.SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND SIC.SicRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 4 --Van Subsidy Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT VS.RefNo as 'Reference' , 0 as 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',VS.Amount as 'Total Spent Amount' ,ISNULL(CND.Claimable,0) as '% Claimable',
		0.00 as 'Claimable Amount',0 'Recommended Amount' , 0 'Received Amount' , 0 AS 'Db/Cr Note Selection', 'Cancelled' as 'Status','' AS Remarks 
		FROM (SELECT SCM.RefNo , SCM.SubsidyDt , SCM.CmpId, SCM.ApprovedClaimAmt Amount FROM VanSubsidyHD SCM WHERE SCM.Confirm = 1) VS  
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON VS.CmpId = CND.CmpId AND  CND.ClmGrpId = @Pi_ClaimGrpId WHERE VS.CmpId = @Pi_CmpId 
		AND VS.SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate AND VS.RefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END  
  ELSE IF @Pi_ClaimGrpId = 5 --Transporter Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT TC.TrcRefNo as 'Reference' , 0 as 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',TC.TotalRecAmt as 'Total Spent Amount' ,ISNULL(CND.Claimable,0) as '% Claimable',
		0.00 as 'Claimable Amount' ,0 'Recommended Amount', 0 'Received Amount' , 0 AS 'Db/Cr Note Selection','Cancelled' as 'Status','' AS Remarks 
		FROM (SELECT TrcRefNo,TotalRecAmt,CmpId,TrcDate FROM TransporterClaimMaster WITH (NOLOCK) WHERE Status = 1 ) TC  
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON TC.CmpId = CND.CmpId and  CND.ClmGrpId = @Pi_ClaimGrpId WHERE TC.CmpId = @Pi_CmpId  
		AND TC.TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND TC.TrcRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId ) AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 6 --Return To Company
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT RTC.RtnCmpRefNo AS 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',RTC.Amount AS 'Total Spent Amount',ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount',  0 'Recommended Amount' , 0 'Received Amount' , 0 AS 'Db/Cr Note Selection','Cancelled' AS 'Status','' AS Remarks 
		FROM (SELECT RTCM.RtnCmpRefNo,RTCM.RtncmpDate,S.CmpId,SUM(RTCD.AmtForClaim) Amount FROM ReturnToCompany RTCM WITH (NOLOCK),
		ReturnToCompanyDt RTCD WITH (NOLOCK),Supplier S  WITH (NOLOCK) WHERE RTCM.RtnCmpRefNo = RTCD.RtnCmpRefNo AND S.SpmId = RTCM.SpmId 
		AND RTCM.Status=1  GROUP BY RTCM.RtnCmpRefNo,RTCM.RtncmpDate,S.CmpId)RTC  LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON RTC.CmpId = CND.CmpId 
		AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE RTC.Amount <> 0 AND RTC.CmpId = 1 and RTC.RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate 
		AND RTC.RtnCmpRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) 
		WHERE ClmGrpId  = @Pi_ClaimGrpId AND ClmId <>0 ) AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 7 --Batch Transfer Value difference Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT BTC.BatRefNo AS 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',BTC.Amount AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount',  0 'Recommended Amount' , 0 'Received Amount' , 0 AS 'Db/Cr Note Selection','Cancelled'  AS 'Status','' AS Remarks 
		FROM(SELECT BatRefNo,BatTrfDate,P.CmpId,ClmAmt Amount FROM BatchTransferClaim BT WITH (NOLOCK), Product P WITH (NOLOCK) WHERE BT.PrdId = P.PrdId) BTC 
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON BTC.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE BTC.CmpId = @Pi_CmpId 
		AND BTC.BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate  AND BTC.BatRefNo NOT IN (SELECT RefCode FROM  ClaimSheetDetail 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WHERE ClmGrpId  = @Pi_ClaimGrpId AND ClmId <>0) AND SelectMode=1) 
  END
  ELSE IF @Pi_ClaimGrpId = 8 --Salvage Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
        SELECT SC.SalvageRefNo as 'Reference' , 0 as 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',SC.Amount as 'Total Spent Amount',ISNULL(CND.Claimable,0) AS '% Claimable',
        0.00 as 'Claimable Amount',0 'Recommended Amount' , 0 'Received Amount' ,0 AS 'Db/Cr Note Selection','Cancelled' AS 'Status','' AS Remarks 
        FROM(SELECT S.SalvageRefNo,S.SalvageDate,P.CmpId,SUM(AmtForClaim) Amount FROM SalvageProduct SP WITH (NOLOCK),Salvage S WITH (NOLOCK),
        Product P WITH (NOLOCK) WHERE S.SalvageRefNo = SP.SalvageRefNo and SP.PrdId = P.PrdId AND S.Status=1 GROUP BY S.SalvageRefNo,S.SalvageDate,P.CmpId) SC 
        LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON SC.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE SC.CmpId = @Pi_CmpId
        AND SC.SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND SC.SalvageRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH(NOLOCK)
        WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WHERE ClmGrpId = @Pi_ClaimGrpId AND ClmId <> @Pi_CmpId) AND SelectMode=1)
  END  
  ELSE IF @Pi_ClaimGrpId = 9 --Sample Issued
  BEGIN
		--- Changed by amuthakumar on 23/10/2018 CRCRSTPAR0033 
		INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
        SELECT IssueRefNo AS 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',TotalAmt AS 'Total Spent Amount',
		ISNULL(CND.Claimable,0) AS '% Claimable',0.00 AS 'Claimable Amount' ,  0 'Recommended Amount' ,0 'Received Amount' ,0 AS 'Db/Cr Note Selection',
		'Cancelled' AS 'Status','' AS Remarks FROM TempSampleIssue TSI 
		LEFT OUTER JOIN ClaimNormDefinition CND ON TSI.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId 
		WHERE TSI.CmpId = @Pi_CmpId AND TSI.IssueDate  BETWEEN @Pi_FromDate AND @Pi_ToDate AND 
		TSI.IssueRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WHERE ClmGrpId  = @Pi_ClaimGrpId AND ClmId <>0) AND SelectMode=1) 
        --SELECT IssueRefNo AS 'Reference',0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',TotalAmt AS 'Total Spent Amount',
        --ISNULL(CND.Claimable,0) AS '% Claimable',0.00 AS 'Claimable Amount' ,  0 'Recommended Amount' ,0 'Received Amount' ,0 AS 'Db/Cr Note Selection',
        --'Cancelled' AS 'Status','' AS Remarks FROM TempSampleIssue TSI 
        --LEFT OUTER JOIN ClaimNormDefinition CND ON TSI.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE TSI.CmpId = @Pi_CmpId AND SelectMode=1
		
		--- CRCRSTPAR0033 
		--SELECT SC.StkJournalRefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',SC.Amount AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
		--0.00 AS 'Claimable Amount' ,  0 'Recommended Amount' ,0 'Received Amount' ,0 AS 'Db/Cr Note Selection',  'Cancelled' AS 'Status','' AS Remarks 
		--FROM (SELECT StkJournalRefNo,StkJournalDate,P.CmpId,ClmAmt Amount FROM StkJournalClaim SJC  WITH (NOLOCK),Product P WITH (NOLOCK)WHERE SJC.PrdId = P.PrdId) SC  
		--LEFT OUTER JOIN ClaimNormDefinition CND ON SC.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE SC.CmpId = @Pi_CmpId 
		--AND SC.StkJournalDate  BETWEEN @Pi_FromDate AND @Pi_ToDate AND SC.StkJournalRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail 
		--WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WHERE ClmGrpId  = @Pi_ClaimGrpId AND ClmId <>0) AND SelectMode=1) 
  END
  ELSE IF @Pi_ClaimGrpId = 10 --Resell Damage Goods Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT RSC.ClaimRefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',RSC.ClaimAmt AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount' ,0 'Recommended Amount', 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks 
		FROM (SELECT ClaimRefNo,ClaimAmt,CmpId,ResellDate FROM ReSellDamageMaster WITH (NOLOCK) WHERE Status = 1) RSC 
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON  RSC.CmpId = CND.CmpId and CND.ClmGrpId = @Pi_ClaimGrpId WHERE RSC.CmpId = @Pi_CmpId 
		AND RSC.ResellDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND RSC.ClaimRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId AND ClmId <>0) AND SelectMode=1)  
  END
  ELSE IF @Pi_ClaimGrpId = 11 --Special Discount Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],
        [Claimable Amount],[Recommended Amount],[Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT DC.SdcRefNo as 'Reference',0 as 'Select',DC.SpentGrossAmt as 'Spent Gross Amt',DC.SpentTaxAmt as 'Spent Tax Amt',
		DC.TotalRecAmt as 'Total Spent Amount',ISNULL(CND.Claimable,0) as '% Claimable',
		0.00 as 'Claimable Amount',0 'Recommended Amount',0 'Received Amount' ,0 AS 'Db/Cr Note Selection','Cancelled' as 'Status','' AS Remarks 
		FROM (SELECT SdcDate,A.SdcRefNo,CmpId,TotalRecAmt,sum(B.SpentGrossAmt)SpentGrossAmt,sum(B.SpentTaxAmt)SpentTaxAmt FROM SpecialDiscountMaster A WITH (NOLOCK) 
		INNER JOIN SpecialDiscountDetails B WITH (NOLOCK) ON A.SdcRefNo = B.SdcRefNo
		WHERE A.Status = 1 GROUP BY A.SdcDate,A.SdcRefNo,CmpId,TotalRecAmt) DC 
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON DC.CmpId = CND.CmpId and CND.ClmGrpId =  @Pi_ClaimGrpId WHERE DC.CmpId = @Pi_CmpId 
		AND DC.SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND DC.SdcRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH(NOLOCK)
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WHERE ClmGrpId  =  @Pi_ClaimGrpId) AND SelectMode=1)
  END            
  ELSE IF @Pi_ClaimGrpId = 12 --Rate Difference Claim
  BEGIN  
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT RDC.RefNo AS 'Reference' , 0 AS 'Select',RDC.SpentAmtGross AS 'Spent Gross Amt', RDC.SpentTaxAmt as 'Spent Tax Amt',
		RDC.Amount AS 'Total Spent Amount',ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount' ,  0 'Recommended Amount' , 0 'Received Amount' , 0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks 
		FROM (SELECT RefNo,Date,CmpId,A.RecClaimAmt Amount,TotSpentAmtGross - TotNegSpentAmtGross as SpentAmtGross,
		TotSpentTaxAmt - TotNegSpentTaxAmt as SpentTaxAmt 
		FROM RateDifferenceClaim A WITH (NOLOCK) WHERE Status = 1 ) RDC   
		LEFT OUTER JOIN ClaimNormDefinition CND ON RDC.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE RDC.CmpId = @Pi_CmpId  
		AND RDC.Date BETWEEN @Pi_FromDate AND @Pi_ToDate AND RDC.RefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 13 --VAT Claim
  BEGIN  
         INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT VC.RefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',VC.RecVatTax AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount' ,  0 'Recommended Amount' , 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks 
		FROM (SELECT RefNo,RecVatTax,CmpId,VatDate FROM VatTaxClaim WITH (NOLOCK) WHERE Status = 1) VC  
		LEFT OUTER JOIN ClaimNormDefinition CND ON VC.CmpId = CND.CmpId and CND.ClmGrpId = @Pi_ClaimGrpId WHERE VC.CmpId = @Pi_CmpId  
		AND VC.VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND VC.RefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END  
  ELSE IF @Pi_ClaimGrpId = 14 --Purchase Shortage Claim
  BEGIN  
         INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT PSC.PurShortRefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',PSC.Amount AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount' , 0 'Recommended Amount' , 0 'Received Amount' ,0 AS 'Db/Cr Note Selection', 'Cancelled' AS 'Status','' AS Remarks 
		FROM  (SELECT PurShortRefNo,ClaimDate,CmpId,RecClaimAmt Amount FROM PurShortageClaim WITH  (NOLOCK) WHERE Status = 1) PSC  
		LEFT OUTER JOIN ClaimNormDefinition CND ON PSC.CmpId = CND.CmpId AND CND.ClmGrpId = @Pi_ClaimGrpId WHERE PSC.CmpId = @Pi_CmpId  
		AND PSC.ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate and PSC.PurShortRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END
  ELSE IF @Pi_ClaimGrpId = 15 --Purchase Excess Quantity Refusal Claim
  BEGIN  
         INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
		SELECT PEC.RefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',PEC.Amount AS 'Total Spent Amount' ,  ISNULL(CND.Claimable,0) AS '% Claimable',
		0.00 AS 'Claimable Amount' , 0 'Recommended Amount',0 'Received Amount' ,0 AS 'Db/Cr Note Selection','Cancelled' AS 'Status','' AS Remarks 
		FROM (SELECT RefNo,Date,CmpId,TotRecAmt Amount FROM PurchaseExcessClaimMaster WITH (NOLOCK) WHERE Status = 1) PEC  
		LEFT OUTER JOIN ClaimNormDefinition CND ON PEC.CmpId = CND.CmpId and CND.ClmGrpId = @Pi_ClaimGrpId WHERE PEC.CmpId = @Pi_CmpId  
		AND PEC.Date BETWEEN @Pi_FromDate AND @Pi_ToDate AND PEC.RefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId) AND SelectMode=1)
  END    				
  ELSE IF @Pi_ClaimGrpId = 16 --Manual Claim
  BEGIN
        INSERT INTO @RetrunClaimDetails ([Reference],[Select],[SpentGrossAmt],[SpentTaxAmt],[Total Spent Amount],[% Claimable],[Claimable Amount],[Recommended Amount],
        [Received Amount],[Db/Cr Note Selection],[Status],[Remarks])
        SELECT DISTINCT MC.MacRefNo AS 'Reference' , 0 AS 'Select',0 as 'Spent Gross Amt',0 as 'Spent Tax Amt',SUM(MCD.ClaimAmt) AS 'Total Spent Amount' ,ISNULL(CND.Claimable,0) AS '% Claimable',
        0.00 AS 'Claimable Amount' ,0 'Recommended Amount', 0 'Received Amount' , 0 AS 'Db/Cr Note Selection','Cancelled' AS 'Status',MCD.Description -- MC.Remarks Was Changed For CR- CCRSTCK0015
        FROM  (SELECT MacRefNo,0 AS ClaimAmt,CmpId,MacDate,Remarks FROM ManualClaimMaster WITH (NOLOCK)  WHERE Status = 1) MC  
        INNER JOIN ManualClaimDetails MCD WITH (NOLOCK) ON MCD.MacRefNo =MC.MacRefNo 
		LEFT OUTER JOIN ClaimNormDefinition CND WITH (NOLOCK) ON MC.CmpId = CND.CmpId AND  CND.ClmGrpId = @Pi_ClaimGrpId WHERE MC.CmpId = @Pi_CmpId  
		AND MC.MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate and MC.MacRefNo NOT IN (SELECT RefCode FROM ClaimSheetDetail WITH (NOLOCK) 
		WHERE ClmId IN (SELECT ClmId FROM ClaimSheethd WITH (NOLOCK) WHERE ClmGrpId  = @Pi_ClaimGrpId)AND SelectMode=1)
		GROUP BY MC.MacRefNo,CND.Claimable,MCD.Description
  END
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_CheckMonthEndValidation' AND XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_CheckMonthEndValidation
GO
--SELECT DBO.Fn_CheckMonthEndValidation('2018-11-01')
CREATE FUNCTION Fn_CheckMonthEndValidation(@Date as DATETIME)
RETURNS INT
AS
/***************************************************************************************************
* FUNCTION     : Fn_CheckMonthEndValidation
* PURPOSE      : Return To Check the Date is MonthEndDates
* CREATED BY   : Amuthakumar P  CR : CRCRSTPAR0032
* CREATED ON   : 23/10/2018
* MODIFICATION 
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************


*****************************************************************************************************/  
BEGIN
DECLARE @IsMonthEndDate AS INT
DECLARE @ActMonthEndDt AS DATETIME
DECLARE @JCMONTHDT AS DATETIME
DECLARE @MonthEndDt AS DATETIME
DECLARE @PrevMonthEndDt AS DATETIME
DECLARE @MonthEndConfigDays AS INT
SET @IsMonthEndDate=0

IF EXISTS(SELECT Status FROM MANUALCONFIGURATION WHERE ModuleId='MonthEndServerDate' and ModuleName='Month End with Server Date' and Status=1)
BEGIN
	
	SET @IsMonthEndDate=1
	SELECT @JCMONTHDT=Jcmsdt FROM JCMonth WHERE @Date BETWEEN JcmSdt AND JcmEdt 
	
	IF EXISTS(SELECT * FROM JCMonthEnd WHERE JcmEdt=dateadd(d,-1,@JCMONTHDT))
	BEGIN
		SET @IsMonthEndDate=0
	END
END

--SELECT @MonthEndConfigDays= ConfigValue FROM CONFIGURATION WHERE MODULENAME='Month End Process' AND MODULEID='DAYMONTHEND1'
--SET @ActMonthEndDt = dateadd(d,@MonthEndConfigDays,@Date)

--SET @IsMonthEndDate=0

--	BEGIN
--		SELECT @JCMONTHDT=Jcmsdt FROM JCMonth WHERE @Date BETWEEN JcmSdt AND JcmEdt 
--		SET @PrevMonthEndDt=dateadd(d,-2,@JCMONTHDT)
--		SET @MonthEndDt=dateadd(d,@MonthEndConfigDays,@JCMONTHDT)
		
--		IF @Date BETWEEN @PrevMonthEndDt AND @MonthEndDt
--		BEGIN
--			SET @IsMonthEndDate=1
--		END
--	END
 
RETURN(@IsMonthEndDate)	
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_IsMonthEndDate' AND XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_IsMonthEndDate
GO
--SELECT DBO.Fn_IsMonthEndDate('2018-11-06','2018-11-04') AS ValidateMsg
CREATE FUNCTION Fn_IsMonthEndDate(@ServerDate AS DATETIME,@LocalDate AS DATETIME)
RETURNS VARCHAR(200)
AS
/***************************************************************************************************
* FUNCTION     : Fn_IsMonthEndDate
* PURPOSE      : Return To Validate the Month End Process
* CREATED BY   : Amuthakumar P  CR : CRCRSTPAR0032
* CREATED ON   : 23/10/2018
* MODIFICATION 
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************


*****************************************************************************************************/    
BEGIN
	DECLARE @ValidateMsg AS VARCHAR(200)
	DECLARE @MonthEndDt AS DATETIME
	DECLARE @JCMONTHDT AS DATETIME
	DECLARE @ActMonthEndDt AS DATETIME
	DECLARE @MonthEndConfigDays AS INT
	DECLARE @JCMONTHDT1 AS DATETIME
	
	SELECT @MonthEndConfigDays= ConfigValue FROM CONFIGURATION WHERE MODULENAME='Month End Process' AND MODULEID='DAYMONTHEND1'
	SET @ActMonthEndDt = dateadd(d,@MonthEndConfigDays,@ServerDate)
	
	SET @ValidateMsg=''
	
	SELECT @JCMONTHDT=Jcmsdt FROM JCMonth WHERE @ServerDate BETWEEN JcmSdt AND JcmEdt 
	
	IF EXISTS(SELECT * FROM JCMonthEnd WHERE JcmEdt=dateadd(d,-1,@JCMONTHDT))
	BEGIN
		RETURN @ValidateMsg
	END

	SET @MonthEndDt=dateadd(d,@MonthEndConfigDays,@JCMONTHDT)
	IF @ServerDate >= @MonthEndDt
	BEGIN
		IF @ServerDate <> @LocalDate
		BEGIN
			SET @ValidateMsg='System Date does not match with Server Date. Please correct the system date and restart Sehyog to proceed.'
		END
		ELSE
		BEGIN
			SET @ValidateMsg=''
		END
	END

RETURN @ValidateMsg
END
GO
DELETE FROM CustomUpDownload WHERE Module='DebitNoteTopSheet5' AND ParkTable ='Cs2Cn_Prk_DebitNoteTopSheet5' AND UPDOWNLOAD='UPLOAD'
GO
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 159,1,'DebitNoteTopSheet5','DebitNoteTopSheet5','Proc_Cs2Cn_DebitNoteTopSheet5','','Cs2Cn_Prk_DebitNoteTopSheet5','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='DebitNoteTopSheet5' AND PrkTableName ='Cs2Cn_Prk_DebitNoteTopSheet5'
GO
INSERT INTO Tbl_UploadIntegration(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT 57,'DebitNoteTopSheet5','DebitNoteTopSheet5','Cs2Cn_Prk_DebitNoteTopSheet5',GETDATE() 
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Cs2Cn_Prk_DebitNoteTopSheet5' AND XTYPE='U')
DROP TABLE Cs2Cn_Prk_DebitNoteTopSheet5
GO
CREATE TABLE Cs2Cn_Prk_DebitNoteTopSheet5
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[SchemeDescription] NVARCHAR(200) NULL,
	[From] [DATETIME] NULL,
	[TO] [DATETIME] NULL,
	[CircularNo] [NVARCHAR](100) NULL,
	[SchemeBudget] [NUMERIC](18,2) NULL,
	[SecSalesValue] [NUMERIC](18,2) NULL,
	[%LiabilityonSecSales] [NUMERIC](18,2) NULL,
	[ClaimAmount] [NUMERIC](18,2) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) 
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DebitNoteTopSheet5' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet5
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_DebitNoteTopSheet5 0,'2018-10-25'
select * from Cs2Cn_Prk_DebitNoteTopSheet5 order by slno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet5
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/**************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_DebitNoteTopSheet5 
* PURPOSE		: To Extract and Upload Manual Claim Details
* CREATED BY	: Amuthakumar P  CR : CRCRSTAPAR0023
* CREATED DATE	: 25/10/2018
* NOTE			:
* MODIFIED
***************************************************************************************************
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************

***************************************************************************************************/     
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheet5 WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	DECLARE @FromDate DATETIME  
	DECLARE @ToDate DATETIME  
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK) 
		
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheet5 (DistCode,[SchemeDescription],
	[From],[TO],[CircularNo],[SchemeBudget],
	[SecSalesValue],[%LiabilityonSecSales],
	[ClaimAmount],[UploadFlag],SyncId,ServerDate)
	SELECT @DistCode, MCD.DESCRIPTION,
	MCM.MacDate As [From], MCM.MacDate AS [To],MCM.MacRefNo,ProposedLibPercent,
	TotalSales,ActualLibPercent,
	ClaimAmt,'N' UploadFlag,NULL,@ServerDate 
	FROM ManualClaimMaster MCM INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo
	WHERE MacDate BETWEEN @FromDate AND @ToDate
	AND NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = MCM.MacRefNo)
	
	INSERT INTO UploadedSampling (SamplingRefNo,UploadDate)
	SELECT [CircularNo],GETDATE() FROM Cs2Cn_Prk_DebitNoteTopSheet5 P (NOLOCK)
	WHERE NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = P.[CircularNo])
	
	RETURN			
END
GO
---Month End Process
--Added by S.Moorthi
DELETE FROM ManualConfiguration WHERE ModuleId='CSTimer2'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','CSTimer2','CS Timer','Enable Server Date Validation',1,'',3.00,1
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='CSTimer' AND xtype='U')
BEGIN
CREATE TABLE CSTimer
(
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL,
	[CSDate] [datetime] NULL,
	[LocalDate] [datetime] NULL,
	[Upload] [tinyint] NULL
)
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='CSTimerHistory' AND xtype='U')
BEGIN
CREATE TABLE CSTimerHistory(
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL,
	[CSDate] [datetime] NULL,
	[LocalDate] [datetime] NULL,
	[Upload] [tinyint] NULL
) ON [PRIMARY]
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Proc_Cn2Cs_Timer' AND xtype='P')
DROP PROCEDURE Proc_Cn2Cs_Timer
GO
CREATE PROCEDURE Proc_Cn2Cs_Timer
(  
 @SyncId NUMERIC(38,0),  
 @ServerDate DATETIME  
)  
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_Timer
* PURPOSE		: To Validate the Server Date Details
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 06/11/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 06/11/2018  S.Moorthi			CR		CRCRSTPAR0034       currently month end is happening on 6th day of month, this is happening based on system date. Is internet connection not available. 
															Need to get console server date through sync and validate user to perform month end process
*********************************/ 
BEGIN  
SET NOCOUNT ON  
 IF NOT EXISTS (SELECT SyncId FROM CSTimer T (NOLOCK))  
 BEGIN  
  INSERT INTO CSTimer(SyncId,ServerDate,CSDate,LocalDate,Upload)  
  SELECT @SyncId,@ServerDate,@ServerDate,GETDATE(),0  
 END  
 ELSE  
 BEGIN  
  INSERT INTO CSTimerHistory(SyncId,ServerDate,CSDate,LocalDate,Upload)  
  SELECT SyncId,ServerDate,CSDate,LocalDate,Upload FROM CSTimer T (NOLOCK)  
    
  UPDATE T SET T.SyncId = @SyncId, T.ServerDate = @ServerDate, T.CSDate = @ServerDate,LocalDate = GETDATE(),Upload = 0  
  FROM CSTimer T (NOLOCK)  
 END  
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Proc_ValidateCSTimer' AND xtype='P')
DROP PROCEDURE Proc_ValidateCSTimer
GO
--exec Proc_ValidateCSTimer '2018-11-08',0,206
CREATE PROCEDURE Proc_ValidateCSTimer
(
@gServerDate DATETIME,
@iMode INT,
@TransId	INT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateCSTimer
* PURPOSE		: To Validate the Server Date Details
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 06/11/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 06/11/2018  S.Moorthi			CR		CRCRSTPAR0034       currently month end is happening on 6th day of month, this is happening based on system date. Is internet connection not available. 
															Need to get console server date through sync and validate user to perform month end process
 06/11/2018  S.Moorthi			CR		CRCRSTPAR0036       Back Date transaction should be allowed																
*********************************/ 
BEGIN
SET NOCOUNT ON
	DECLARE @CSDate AS DATETIME
	DECLARE @LocalDate AS DATETIME
	
	DECLARE @BackDateAllow AS DATETIME
	declare @TimInterval  AS NUMERIC(8,0)
	DECLARE @CSDateDD INT
	DECLARE @BackDateDays AS INT
	DECLARE @MonthEndDate AS DATETIME
	DECLARE @MaxTransDate AS DATETIME
	DECLARE @ValidateMsg AS VARCHAR(200)
	DECLARE @MonthEndDt AS DATETIME
	DECLARE @JCMONTHDT AS DATETIME
	DECLARE @ActMonthEndDt AS DATETIME
	DECLARE @MonthEndConfigDays AS INT
	
	IF NOT EXISTS(SELECT * FROM CSTimer (NOLOCK))
	BEGIN
		SELECT '' ValidMsg
		RETURN 
	END

	SELECT @CSDate = CONVERT(VARCHAR(10),CSDate,121),@LocalDate = GETDATE() FROM CSTimer (NOLOCK)
	
	SELECT @MaxTransDate=ISNULL(MAX(TransDate),GETDATE()) FROM StockLedger (NOLOCK)
	--SELECT @CSDate,@MaxTransDate
	IF @MaxTransDate>@CSDate
	BEGIN
		SET @CSDate=@MaxTransDate		
		UPDATE CSTimer SET CSDate=@MaxTransDate
	END
	
	IF @iMode=1000 AND @TransId=206
	BEGIN
		IF @gServerDate>@CSDate
		BEGIN
			SET @CSDate=@gServerDate
			
			INSERT INTO CSTimerHistory(SyncId,ServerDate,CSDate,LocalDate,Upload)  
			SELECT SyncId,@gServerDate,@gServerDate,GETDATE(),Upload FROM CSTimer T (NOLOCK) 
			
			UPDATE CSTimer SET CSDate=@CSDate,ServerDate=@gServerDate,LocalDate=GETDATE()
		END
	END
	
	--select @BackDateDays,@CSDate
	IF EXISTS(SELECT * FROM CONFIGURATION WHERE MODULENAME='Month End Process' AND MODULEID='DAYMONTHEND1' AND CONFIGVALUE>0)
	BEGIN

		IF @iMode=0 AND @TransId=206
		BEGIN
			IF EXISTS(SELECT * fROM MANUALCONFIGURATION WHERE Moduleid='MonthEndServerDate' and status=1)
			BEGIN 
				goto xy
			END
		END
		
		SELECT @MonthEndConfigDays= ConfigValue FROM CONFIGURATION WHERE MODULENAME='Month End Process' AND MODULEID='DAYMONTHEND1'
		SET @ActMonthEndDt = dateadd(d,@MonthEndConfigDays,@gServerDate)
	
		SELECT @JCMONTHDT=Jcmsdt FROM JCMonth(NOLOCK) WHERE @CSDate BETWEEN JcmSdt AND JcmEdt 
		SET @MonthEndDt=dateadd(d,@MonthEndConfigDays,@JCMONTHDT)
	
		IF NOT EXISTS(SELECT * FROM JCMonthEnd (NOLOCK)	WHERE JcmEdt=DATEADD(D,-1,@JCMONTHDT) AND Status = 1)
		BEGIN
			IF @CSDate >= @MonthEndDt
			BEGIN
				IF @CSDate <> @gServerDate
					BEGIN
						SELECT 'Please change the System date with '+ CONVERT(NVARCHAR(20),@CSDate,103)+' and do Month End for '+DATENAME(M,DATEADD(D,-1,@JCMONTHDT))+' - '+CAST(YEAR(DATEADD(D,-1,@JCMONTHDT)) AS NVARCHAR(10)) as ValidMsg
						RETURN
						--SET @ValidateMsg='System Date does not match with Server Date. Please correct the system date and restart Sehyog to proceed.'
					END
			END
		END
	END

	xy:
	
	--select @BackDateAllow,@gServerDate
	IF EXISTS(SELECT * FROM ManualConfiguration(NOLOCK) WHERE ModuleId='CSTimer2' AND STATUS=1)
	BEGIN
		SELECT @BackDateDays = ISNULL(ConfigValue,0) FROM ManualConfiguration(NOLOCK) WHERE ModuleId='CSTimer2'
		SET @BackDateAllow=CONVERT(VARCHAR(10),DATEADD(D,-@BackDateDays+1,@CSDate),121)

		IF @BackDateAllow>@gServerDate
		BEGIN
			SELECT 'Back Date should be allow till '+ CONVERT(NVARCHAR(20),@BackDateAllow,103)+', Please Change the System Date and re-open Sehyog to continue ' ValidMsg
			--SELECT 'Back Date should be allow till '+ CONVERT(NVARCHAR(20),@BackDateAllow,103)+', Please Change System Date to '+ CONVERT(NVARCHAR(20),@CSDate,103)+' and re-open Sehyog to continue ' ValidMsg
			RETURN
		END
	END
	
	
	--Back Date Transaction Not Allowed, Please Change System Date to 
	--IF @CSDate>@gServerDate
	--BEGIN
	--	SELECT 	'Please change System date to '+ CONVERT(NVARCHAR(20),@CSDate,103)+' and re-open Sehyog to continue ' ValidMsg
	--	RETURN
	--END
	
	SELECT '' ValidMsg
	
RETURN 
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Proc_ValidServerDateConfig' AND xtype='P')
DROP PROCEDURE Proc_ValidServerDateConfig
GO
--exec Proc_ValidServerDateConfig '2018-11-08','2018-11-04'
CREATE PROCEDURE Proc_ValidServerDateConfig
(
 @ServerDate DATETIME,  
 @CSDate DATETIME  
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateCSTimer
* PURPOSE		: To Validate the Server Date Details
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 06/11/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 06/11/2018  S.Moorthi			CR		CRCRSTPAR0034       currently month end is happening on 6th day of month, this is happening based on system date. Is internet connection not available. 
															Need to get console server date through sync and validate user to perform month end process
 06/11/2018  S.Moorthi			CR		CRCRSTPAR0036       Back Date transaction should be allowed																
*********************************/ 
BEGIN
SET NOCOUNT ON 

	--DECLARE @LocalDate AS DATETIME
	
	--DECLARE @BackDateAllow AS DATETIME
	--declare @TimInterval  AS NUMERIC(8,0)
	--DECLARE @CSDateDD INT
	--DECLARE @BackDateDays AS INT
	--DECLARE @MonthEndDate AS DATETIME
	--DECLARE @MaxTransDate AS DATETIME
	--DECLARE @ValidateMsg AS VARCHAR(200)
	--DECLARE @MonthEndDt AS DATETIME
	--DECLARE @JCMONTHDT AS DATETIME
	--DECLARE @ActMonthEndDt AS DATETIME
	--DECLARE @MonthEndConfigDays AS INT
	
	----SELECT @CSDate = CSDate,@LocalDate = GETDATE() FROM CSTimer (NOLOCK)
	
	----SELECT @CSDate,@MaxTransDate

	--SELECT @BackDateDays = ISNULL(ConfigValue,0) FROM ManualConfiguration(NOLOCK) WHERE ModuleId='CSTimer2'
	--SET @BackDateAllow=CONVERT(VARCHAR(10),DATEADD(D,-@BackDateDays,@ServerDate),121)
	

	
	--IF EXISTS(SELECT * FROM Configuration WHERE ModuleName = 'Month End Process' AND ModuleId='DAYMONTHEND1' AND Status=1)
	--BEGIN
	--	SELECT @MonthEndConfigDays= ConfigValue FROM CONFIGURATION WHERE MODULENAME='Month End Process' AND MODULEID='DAYMONTHEND1'
	--	SET @ActMonthEndDt = dateadd(d,@MonthEndConfigDays,@ServerDate)
	
	--	SELECT @JCMONTHDT=Jcmsdt FROM JCMonth(NOLOCK) WHERE @ServerDate BETWEEN JcmSdt AND JcmEdt 
	--	SET @MonthEndDt=dateadd(d,@MonthEndConfigDays,@JCMONTHDT)
	
	--	IF NOT EXISTS(SELECT * FROM JCMonthEnd (NOLOCK)	WHERE JcmEdt=DATEADD(D,-1,@JCMONTHDT) AND Status = 1)
	--	BEGIN
	--		IF @CSDate >= @MonthEndDt
	--		BEGIN
	--			IF @CSDate <> @ServerDate
	--				BEGIN
	--					SELECT 'Please change the System date with '+ CONVERT(NVARCHAR(20),@MonthEndDt,103)+' and do Month End for '+DATENAME(M,DATEADD(D,-1,@JCMONTHDT))+' - '+CAST(YEAR(DATEADD(D,-1,@JCMONTHDT)) AS NVARCHAR(10)) as ValidMsg
	--					RETURN
	--					--SET @ValidateMsg='System Date does not match with Server Date. Please correct the system date and restart Sehyog to proceed.'
	--				END
	--		END
	--	END
	--END
	----select @ServerDate,@BackDateAllow
	--IF @BackDateAllow>@CSDate
	--BEGIN
	--	--select 'System Date should be Sync with the date range Configure between 7 and 14. Please change the System date to minimum configuration date'
	--	SELECT 'Back Date should be allow to Sync till '+ CONVERT(NVARCHAR(20),@BackDateAllow,103)+', Please Change the System Date to minimum configuration date ' ValidMsg
	--	--SELECT 'Back Date should be allow till '+ CONVERT(NVARCHAR(20),@BackDateAllow,103)+', Please Change System Date to '+ CONVERT(NVARCHAR(20),@CSDate,103)+' and re-open Sehyog to continue ' ValidMsg
	--	RETURN
	--END
	
	
	
	SELECT '' ValidMsg
	
RETURN 
END
GO
--Till Here
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_Console2CS_ConsolidatedDownload' AND xtype='P')
DROP PROCEDURE Proc_Console2CS_ConsolidatedDownload
GO
CREATE PROCEDURE Proc_Console2CS_ConsolidatedDownload
As  
/*
**************************************************************************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
**************************************************************************************************
23/01/2018  Gowsalya S   Issue          ICONSWIP1888            SyncStatus has been updated as 1 for incomplete sync
*/
Begin  
BEGIN TRY    
SET XACT_ABORT ON    
BEGIN TRANSACTION
Declare @Lvar Int  
Declare @MaxId Int  
Declare @SqlStr Varchar(8000)  
Declare @Process Varchar(100)  
Declare @colcount Int  
Declare @Col Varchar(5000)  
Declare @Tablename Varchar(100)  
Declare @Sequenceno Int  
 Create Table #Col (ColId int)  
 CREATE TABLE #Console2CS_Consolidated  
 (  
  [SlNo] [numeric](38, 0) NULL, [DistCode] [VARCHAR](200) COLLATE Database_Default NULL, [SyncId] [numeric](38, 0) NULL,  
  [ProcessName] [VARCHAR](200) COLLATE Database_Default NULL, [ProcessDate] [datetime] NULL, 
  [Column1] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column2] [VARCHAR](200) COLLATE Database_Default NULL, [Column3] [VARCHAR](200) COLLATE Database_Default NULL, [Column4] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column5] [VARCHAR](200) COLLATE Database_Default NULL, [Column6] [VARCHAR](200) COLLATE Database_Default NULL, [Column7] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column8] [VARCHAR](200) COLLATE Database_Default NULL, [Column9] [VARCHAR](200) COLLATE Database_Default NULL, [Column10] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column11] [VARCHAR](200) COLLATE Database_Default NULL, [Column12] [VARCHAR](200) COLLATE Database_Default NULL, [Column13] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column14] [VARCHAR](200) COLLATE Database_Default NULL, [Column15] [VARCHAR](200) COLLATE Database_Default NULL, [Column16] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column17] [VARCHAR](200) COLLATE Database_Default NULL, [Column18] [VARCHAR](200) COLLATE Database_Default NULL, [Column19] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column20] [VARCHAR](200) COLLATE Database_Default NULL, [Column21] [VARCHAR](200) COLLATE Database_Default NULL, [Column22] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column23] [VARCHAR](200) COLLATE Database_Default NULL, [Column24] [VARCHAR](200) COLLATE Database_Default NULL, [Column25] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column26] [VARCHAR](200) COLLATE Database_Default NULL, [Column27] [VARCHAR](200) COLLATE Database_Default NULL, [Column28] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column29] [VARCHAR](200) COLLATE Database_Default NULL, [Column30] [VARCHAR](200) COLLATE Database_Default NULL, [Column31] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column32] [VARCHAR](200) COLLATE Database_Default NULL, [Column33] [VARCHAR](200) COLLATE Database_Default NULL, [Column34] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column35] [VARCHAR](200) COLLATE Database_Default NULL, [Column36] [VARCHAR](200) COLLATE Database_Default NULL, [Column37] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column38] [VARCHAR](200) COLLATE Database_Default NULL, [Column39] [VARCHAR](200) COLLATE Database_Default NULL, [Column40] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column41] [VARCHAR](200) COLLATE Database_Default NULL, [Column42] [VARCHAR](200) COLLATE Database_Default NULL, [Column43] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column44] [VARCHAR](200) COLLATE Database_Default NULL, [Column45] [VARCHAR](200) COLLATE Database_Default NULL, [Column46] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column47] [VARCHAR](200) COLLATE Database_Default NULL, [Column48] [VARCHAR](200) COLLATE Database_Default NULL, [Column49] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column50] [VARCHAR](200) COLLATE Database_Default NULL, [Column51] [VARCHAR](200) COLLATE Database_Default NULL, [Column52] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column53] [VARCHAR](200) COLLATE Database_Default NULL, [Column54] [VARCHAR](200) COLLATE Database_Default NULL, [Column55] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column56] [VARCHAR](200) COLLATE Database_Default NULL, [Column57] [VARCHAR](200) COLLATE Database_Default NULL, [Column58] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column59] [VARCHAR](200) COLLATE Database_Default NULL, [Column60] [VARCHAR](200) COLLATE Database_Default NULL, [Column61] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column62] [VARCHAR](200) COLLATE Database_Default NULL, [Column63] [VARCHAR](200) COLLATE Database_Default NULL, [Column64] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column65] [VARCHAR](200) COLLATE Database_Default NULL, [Column66] [VARCHAR](200) COLLATE Database_Default NULL, [Column67] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column68] [VARCHAR](200) COLLATE Database_Default NULL, [Column69] [VARCHAR](200) COLLATE Database_Default NULL, [Column70] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column71] [VARCHAR](200) COLLATE Database_Default NULL, [Column72] [VARCHAR](200) COLLATE Database_Default NULL, [Column73] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column74] [VARCHAR](200) COLLATE Database_Default NULL, [Column75] [VARCHAR](200) COLLATE Database_Default NULL, [Column76] [VARCHAR](200) COLLATE Database_Default NULL,   
  [Column77] [VARCHAR](200) COLLATE Database_Default NULL, [Column78] [VARCHAR](200) COLLATE Database_Default NULL, [Column79] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column80] [VARCHAR](200) COLLATE Database_Default NULL, [Column81] [VARCHAR](200) COLLATE Database_Default NULL, [Column82] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column83] [VARCHAR](200) COLLATE Database_Default NULL, [Column84] [VARCHAR](200) COLLATE Database_Default NULL, [Column85] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column86] [VARCHAR](200) COLLATE Database_Default NULL, [Column87] [VARCHAR](200) COLLATE Database_Default NULL, [Column88] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column89] [VARCHAR](200) COLLATE Database_Default NULL, [Column90] [VARCHAR](200) COLLATE Database_Default NULL, [Column91] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column92] [VARCHAR](200) COLLATE Database_Default NULL, [Column93] [VARCHAR](200) COLLATE Database_Default NULL, [Column94] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column95] [VARCHAR](200) COLLATE Database_Default NULL, [Column96] [VARCHAR](200) COLLATE Database_Default NULL, [Column97] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column98] [VARCHAR](200) COLLATE Database_Default NULL, [Column99] [VARCHAR](200) COLLATE Database_Default NULL, [Column100] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Remarks1] [VARCHAR](200) COLLATE Database_Default NULL, [Remarks2] [VARCHAR](200) COLLATE Database_Default NULL, [DownloadFlag] [VARCHAR](1) COLLATE Database_Default NULL,  
  DWNStatus INT
 )   
 INSERT INTO Console2CS_Consolidated_Trace 
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y'
 DELETE FROM Console2CS_Consolidated_Trace where CONVERT (DATETIME,[Downloaded Date],121)<=Convert(DATETIME,GETDATE()-15,121)
 Delete A From Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y' 
 ---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Console2CS_Consolidated'
	And A.system_type_id = C.system_type_id And C.name='varchar'
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ----------------------------------
	
	SELECT Distinct DistCode, SyncId Into #IncompleteSync  FROM Console2CS_Consolidated (NOLOCK) WHERE DownloadFlag='N'  
	
	
	Select A.DistCode , A.SyncId , MAX(CreatedDate) CreatedDate Into #MaxDate
	 from SyncStatus_Download_Archieve A(Nolock), #IncompleteSync B
	Where A.DistCode = B.DistCode And A.SyncId = B.SyncId 
	Group by  A.DistCode , A.SyncId
	
	Update A Set SyncStatus =1 From
	SyncStatus_Download_Archieve A (Nolock) , 
	#MaxDate B
	Where A.DistCode = B.DistCode And A.Syncid = B.Syncid And A.CreatedDate = B.CreatedDate 
 ------------------------------------
	
 Insert Into #Console2CS_Consolidated  
 Select *,0 as DWNStatus from Console2CS_Consolidated (Nolock) Where DownloadFlag In ('D','N')
   Update A Set A.DWNStatus = 1  
   From  
    #Console2CS_Consolidated A (NOLOCK),  
    (  
     SELECT   
     DistCode,SyncId   
     FROM   
     SyncStatus_Download (NOLOCK)  
     WHERE       
     SyncStatus = 1 AND SyncId > 0  
     UNION  
     SELECT   
     DistCode,SyncId  
     FROM   
     SyncStatus_Download_Archieve (NOLOCK)  
     WHERE  
     SyncStatus = 1 AND SyncId > 0  
    ) B  
   Where   
    A.DistCode = B.DistCode AND   
    A.SyncId = B.SyncId   
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
 -- Purchase Trace Ends here
 Delete A From #Console2CS_Consolidated A (Nolock) Where DWNStatus = 0 
 Create Table #Process(ProcessName Varchar(100),PrkTableName Varchar(100), id Int Identity(1,1) )  
 Insert Into #Process(ProcessName , PrkTableName)   
 Select Distinct A.ProcessName , A.PrkTableName From Tbl_DownloadIntegration A,#Console2CS_Consolidated B   
 Where A.ProcessName = B.ProcessName And A.SequenceNo not in(100000) --Order By Sequenceno  
  Set @Lvar = 1  
  Select @MaxId = Max(id) From #Process  
  While @Lvar <= @MaxId  
   Begin  
    Select @Tablename = PrkTableName , @Process = ProcessName From #Process Where id  = @Lvar  
    Select @colcount = Count(Column_ID) From sys.columns Where object_id = (select object_id From sys.objects Where name = @Tablename)  
    Set @SqlStr = ''  
    Set @SqlStr = @SqlStr + ' Insert Into ' + @Tablename + ' '  
    Set @Col = ''  
    select @Col = @Col + '[' +name + '],' From sys.columns   
    where object_id = ( select object_id From sys.objects Where name = @Tablename) Order by Column_Id  
    Truncate Table #Col      
    Insert Into #Col     
    Select  a.column_id + 5 As ColId  
    From sys.columns a,sys.types b where a.user_type_id = b.user_type_id  
    and a.object_id = ( Select object_id From sys.objects Where name = @Tablename)  
    and b.name = 'datetime' --and a.name <> 'CreatedDate'  
    Set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ') '  
    Set @Col = ''  
    Select @Col = @Col + (Case when column_id In (Select ColId From #Col) then 'Convert(Datetime,'+name + ',121)' else name end) + ','   
    From sys.columns Where object_id = ( Select object_id From sys.objects Where name = 'Console2CS_Consolidated ')  
    and column_id  between 6 and 5 + @colcount 
    Order by column_id
    Set @SqlStr = @SqlStr + ' Select '+ left(@Col,len(@Col)-1)  + ' From #Console2CS_Consolidated (nolock) '  
    Set @SqlStr = @SqlStr + ' Where ProcessName = '''+ @Process +''' And DWNStatus = 1 '      
--    Print (@SqlStr) 
    Exec (@SqlStr)  
    Set @Lvar = @Lvar + 1  
   End  
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
  -- Purchase Trace Ends here
  Update A Set A.DownloadFlag = 'Y'   
   From   
    Console2CS_Consolidated A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
   Update A Set A.SyncFlag = 1  
   From   
    Syncstatus_Download A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
COMMIT TRANSACTION    
 END TRY    
 BEGIN CATCH    
  ROLLBACK TRANSACTION    
  INSERT INTO XML2CSPT_ErrorLog VALUES ('Proc_Console2CS_ConsolidatedDownload', ERROR_MESSAGE(), GETDATE())    
 END CATCH    
END
GO
Update A Set VersionId ='PV.2.10.0' from UtilityProcess A Where ProcessName ='Sync.Exe'
Update A Set  Setting = 1 from Tbl_syncConfiguration A Where Processname = 'ScriptUpdaterAfterDeploy' 
GO
DELETE FROM Tbl_SyncConfiguration WHERE ProcessName in ('CSTimer Enable','WriteAutoDeploymentStatus',
'LoginOCXReg','CSAutoNClose','UploadRecCountWise_QS')
INSERT INTO Tbl_SyncConfiguration(ProcessName,Setting,CreatedDate) 
Select 'WriteAutoDeploymentStatus',0,GetDate() UNION
Select 'LoginOCXReg',0,GetDate() UNION
Select 'CSAutoNClose',0,GetDate() UNION
Select 'UploadRecCountWise_QS',0,GetDate() UNION
Select 'CSTimer Enable',1,GetDate() 
GO
IF EXISTS (select *from sysobjects where name ='Proc_RptClaimTopSheet' and xtype ='P')
DROP PROCEDURE Proc_RptClaimTopSheet
GO
--EXEC Proc_RptClaimTopSheet 107,2,0,'',0,0,1,''
CREATE PROCEDURE Proc_RptClaimTopSheet
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/************************************************
* PROCEDURE  : Proc_RptClaimTopSheet
* PURPOSE    : To Generate  Claim Top Sheet Report 
* CREATED BY : Boopathy.P
* CREATED ON : 19/03/2008  
* MODIFICATION 
*************************************************   
* DATE       AUTHOR      DESCRIPTION    
--------------------------------------------------------------------------------------------------------------------
* Date			  Author	   CR/BZ	 UserStoryId		    Description 
* 03-05-2018	 lakshman M      BZ	     ILCRSTPAR0448	        Claim wise Rpt name & Date range filter validation added in Core stocky
* 07-05-2018	 lakshman M      BZ	     ILCRSTPAR0478	        Claim wise scheme code,schem valid Date and tax amount validation added in Core stocky
* 27-06-2018     Deepak K		 BZ      ILCRSTPAR1185			Special Discount Claim RefCode validation added 
* 20-11-2018     lakshman M      BZ      ILCRSTPAR2606          Claim top sheet report tax amount validation missing in CS.      
**********************************************************************************************************************/      
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 			AS	INT
	DECLARE @DBNAME				AS 	nvarchar(50)
	DECLARE @TblName 			AS	nvarchar(500)
	DECLARE @TblStruct 			AS	nVarchar(4000)
	DECLARE @TblFields 			AS	nVarchar(4000)
	DECLARE @sSql				AS 	nVarChar(4000)
	DECLARE @ErrNo	 			AS	INT
	DECLARE @PurDBName			AS	nVarChar(50)
	--Filter Variable
	DECLARE @CmpId				AS	INT
	DECLARE @FromDate			AS 	DATETIME
	DECLARE @ToDate				AS 	DATETIME
	DECLARE @ClmGrpId			AS	INT
	DECLARE @ClmSts				AS	INT
	DECLARE @ClmConfSts			AS	INT
	DECLARE @ClmCode			AS	INT
--Till Here
--Assgin Value for the Filter Variable
	SET @CmpId = 		(SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @FromDate =		(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate =		(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @ClmGrpId = 	(SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,42,@Pi_UsrId))
	SET @ClmSts = 		(SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,124,@Pi_UsrId))
	SET @ClmConfSts = 	(SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,125,@Pi_UsrId))
	SET @ClmCode = 		(SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,41,@Pi_UsrId))
	
	PRINT @CmpId
	PRINT @FromDate
	PRINT @ToDate
	PRINT @ClmGrpId
	PRINT @ClmSts
	PRINT @ClmConfSts
	PRINT @ClmCode
	---------- Added by lakshman M on 07/05/2018 PMS ID: ILCRSTPAR0478  new columns added in CS (Schcode,SchFrmDate,SchToDate,TaxAmount)----------------
	Create TABLE #RptClaimTopSheet
	(
			ClmCode			 NVARCHAR(50),
			ClmDesc		 	 NVARCHAR(50),
			ClmDate			 DATETIME,
			Schcode			 NVARCHAR(50),
			SchDesc			 NVARCHAR(100),
			SchFrmDate		 NVARCHAR(50),
			SchToDate		 NVARCHAR(50),	
			DiscountVal		 NUMERIC(38,6),
			FreePrdVal		 NUMERIC(38,6),
			GiftPrdVal		 NUMERIC(38,6),
			TotalSpend		 NUMERIC(38,6),
			TaxAmount		 NUMERIC(38,6),
			ClmPercentage	 NUMERIC(38,2),
			ClmAmount		 NUMERIC(38,6),
			RecommendedAmt	 NUMERIC(38,6),
			ReceivedAmt		 NUMERIC(38,6),
			CrDbNote		 NVARCHAR(50),
			Status			 NVARCHAR(50),
			ConfirmSts		 NVARCHAR(50),
			ClmType			 INT,
			ClmGrpId		 INT
	)
	SET @TblName = 'RptClaimTopSheet'
	SET @TblStruct ='ClmCode		 NVARCHAR(50),
			ClmDesc		 	 NVARCHAR(50),
			ClmDate			 DATETIME,
			Schcode			 NVARCHAR(50),
			SchDesc			 NVARCHAR(100),
			SchFrmDate		 NVARCHAR(50),
			SchToDate		 NVARCHAR(50),
			DiscountVal		 NUMERIC(38,6),
			FreePrdVal		 NUMERIC(38,6),
			GiftPrdVal		 NUMERIC(38,6),
			TotalSpend		 NUMERIC(38,6),
			TaxAmount		 NUMERIC(38,6),
			ClmPercentage	 NUMERIC(38,2),
			ClmAmount		 NUMERIC(38,6),
			RecommendedAmt	 NUMERIC(38,6),
			ReceivedAmt		 NUMERIC(38,6),
			CrDbNote		 NVARCHAR(50),
			Status			 NVARCHAR(50),
			ConfirmSts		 NVARCHAR(50),
			ClmType			 INT,
			ClmGrpId		 INT'
	
	SET @TblFields = 'ClmCode,ClmDesc,ClmDate,Schcode,SchDesc,SchFrmDate,SchToDate,DiscountVal,FreePrdVal,GiftPrdVal,TotalSpend,TaxAmount,
			ClmPercentage,ClmAmount,RecommendedAmt,ReceivedAmt,CrDbNote,Status,ConfirmSts,ClmType,ClmGrpId'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	SET @Po_Errno = 0
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
	
		INSERT INTO #RptClaimTopSheet (ClmCode,ClmDesc,ClmDate,Schcode,SchDesc,SchFrmDate,SchToDate,DiscountVal,FreePrdVal,GiftPrdVal,TotalSpend,TaxAmount,
		ClmPercentage,ClmAmount,RecommendedAmt,ReceivedAmt,CrDbNote,Status,ConfirmSts,ClmType,ClmGrpId)
		SELECT A.ClmCode,A.ClmDesc,CONVERT(NVARCHAR(10),A.ClmDate,121) AS ClmDate,Schcode,C.SchDsc,CONVERT(NVARCHAR(10),SchValidFrom,121) AS SchValidFrom,CONVERT(NVARCHAR(10),SchValidTill,121)AS SchValidTill,B.Discount,B.FreePrdVal,GiftPrdVal,B.TotalSpent,
		ISNULL(B.GSTTax,0) AS [GSTTax], 
		--CASE WHEN SalesValue > 0 Then SalesValue WHEN GSTTax  > 0 Then GSTTax WHEN GSTTax  < 0 Then GSTTax END AS [GSTTax],  -- commented By Lakshman M Dated ON 2018-11-20 PMS ID:ILCRSTPAR2606
		B.ClmPercentage,B.ClmAmount,B.RecommendedAmount,B.ReceivedAmount,
		CASE B.CrDbMode WHEN 1 THEN 'Debit Note' WHEN 2 THEN 'Credit Note' ELSE 'Claim' END AS CrDbNote,
		CASE B.Status WHEN 1 THEN 'Pending' WHEN 2 THEN 'Settled' WHEN 3 THEN 'Cancelled' END AS Status,
		CASE A.Confirm WHEN 1 THEN 'Confirmed' WHEN 2 THEN 'Not confirmed' END AS ConfirmSts,A.ClmType,A.ClmGrpId 
		FROM ClaimSheetHD A INNER JOIN ClaimSheetDetail B ON A.ClmId=B.ClmId
		--INNER JOIN schememaster C ON C.SchCode =B.RefCode /*Commented By Deepak */
		LEFT OUTER JOIN schememaster C ON C.SchCode =B.RefCode /*Added by Deepak K ILCRSTPAR1185*/
		WHERE (A.CmpId=(CASE @CmpId WHEN 0 THEN A.CmpId ELSE @CmpId END)OR
			A.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
	        AND (A.ClmGrpId=(CASE @ClmGrpId WHEN 0 THEN A.ClmGrpId ELSE @ClmGrpId END) OR
			A.ClmGrpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,42,@Pi_UsrId))) 
	        AND (B.Status = (CASE @ClmSts WHEN 0 THEN B.Status ELSE @ClmSts END) OR
			B.Status in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,124,@Pi_UsrId))) 
			AND (A.Confirm = (CASE @ClmConfSts WHEN 0 THEN A.Confirm ELSE 0 END) OR
			A.Confirm in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,125,@Pi_UsrId))) 
			AND (A.ClmId = (CASE @ClmCode WHEN 0 THEN A.ClmId ELSE @ClmCode END)OR
			A.ClmId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,41,@Pi_UsrId))) 
	        AND A.ClmDate BETWEEN @FromDate AND @ToDate
	---------- Till Here ----------------
	   	IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptClaimTopSheet ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ 'WHERE
				        (A.CmpId=(CASE @CmpId WHEN 0 THEN A.CmpId ELSE @CmpId END) 
				        AND A.ClmGrpId=(CASE @ClmGrpId WHEN 0 THEN A.ClmGrpId ELSE @ClmGrpId END) 
				        AND B.Status = (CASE @ClmSts WHEN 0 THEN B.Status ELSE @ClmSts END) 
					AND A.Confirm = (CASE @ClmConfSts WHEN 0 THEN A.Confirm ELSE @ClmConfSts END)
					AND A.ClmId = (CASE @ClmCode WHEN 0 THEN A.ClmId ELSE @ClmCode END) 			
				        AND A.ClmDate BETWEEN @FromDate AND @ToDate)'
			EXEC (@SSQL)
		END
		IF @Pi_SnapRequired = 1
		   BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptClaimTopSheet'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		    END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		   BEGIN
			SET @SSQL = 'INSERT INTO #RptClaimTopSheet ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		   END
		ELSE
		   BEGIN
			SET @Po_Errno = 1
			PRINT 'DataBase or Table not Found'
			RETURN
		   END
	END
	
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptClaimTopSheet
	-------------- Added by lakshman M On 03-05-2018 PMS ID: ILCRSTPAR0448---------------
	DECLARE @Rptname	AS	Varchar(100)
	DECLARE @ClmGroupname	AS	Varchar(100)
	Declare @frmDate As datetime
	Declare @TillDate As datetime 
	
	SET @Rptname ='' 
	SET @ClmGroupname =''
	SET @frmDate = ''
	SET @TillDate =''
	UPDATE RptHeader SET RpCaption='Claim Top Sheet Details Report' WHERE RPTID = @Pi_RptId
	
	SELECT @Rptname=RpCaption  FROM RptHeader WHERE RptId=@Pi_RptId
	SELECT @ClmGroupname=ClmGrpName,@frmDate=B.FromDate,@TillDate =B.todate FROM ClaimGroupMaster A inner join ClaimSheetHd B ON A.ClmGrpId =B.ClmGrpId
	INNER JOIN #RptClaimTopSheet C ON C.ClmGrpId =B.ClmGrpId WHERE C.ClmCode in(select ClmCode from #RptClaimTopSheet)
	SET @frmDate = ''
	SET @TillDate =''
	SELECT @frmDate=A.FromDate,@TillDate =A.ToDate from ClaimSheetHd A where A.ClmCode in(select ClmCode from #RptClaimTopSheet)
	
	SELECT @ClmGroupname=ClmGrpName FROM #RptClaimTopSheet A  
	INNER JOIN ClaimGroupMaster B ON A.ClmGrpId =B.ClmGrpId
	
	UPDATE RptHeader SET RpCaption=@ClmGroupname + ' - ' +  @Rptname +' For ' + CONVERT(varchar(10),@frmDate,105) +' - ' + CONVERT(varchar(10),@TillDate,105) WHERE RPTID = @Pi_RptId
	--UPDATE RptHeader SET RpCaption=@ClmGroupname + ' - ' +  @Rptname  WHERE RPTID = @Pi_RptId
	--select @ClmGroupname + ' - ' +  @Rptname + 'For' + CONVERT(varchar(10),@frmDate,121) +' - ' + CONVERT(varchar(10),@TillDate,121) from RptHeader WHERE RPTID = @Pi_RptId
	ALTER TABLE #RptClaimTopSheet drop column ClmGrpId
	------------ Till here -----------
	SELECT * FROM #RptClaimTopSheet
RETURN
END
GO
---UAT CHANGES-
----Manually execute the script
----IF EXISTS(SELECT * FROM SchemeMaster A WHERE len(CmpSchCode)>=8 
---- and CAST(RIGHT(CmpSchCode,5) AS NUMERIC(18,0))<CAST(RIGHT('SCH17428',5) AS NUMERIC(18,0)) AND ApplyTaxForClaim=1)
----BEGIN
----	UPDATE A SET A.ApplyTaxForClaim=0 FROM SchemeMaster A WHERE len(CmpSchCode)>=8 
----	 and CAST(RIGHT(CmpSchCode,5) AS NUMERIC(18,0))<CAST(RIGHT('SCH17428',5) AS NUMERIC(18,0))
----END
----GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Product_StatusBk' and xtype='U')
BEGIN
	SELECT * into Product_StatusBk FROM PRODUCT
END
GO
EXEC Proc_GR_Build_PH
GO
UPDATE B SET B.prdstatus=0 from tbl_gr_build_ph a 
inner join product b on a.prdid=b.prdid  where category_code not in ('C12','C13','C14','C15','C16','C21','C22','c10','K')
and B.PRDSTATUS=1
GO
UPDATE A SET A.Caption='Sample Invoice',A.DefaultCaption='Sample Invoice' FROM MENUDEF A WHERE MenuName='mnuSampleMgmt' AND MenuId='mCus36'
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_ReturnToValidateNewRetailerBilling' AND xtype='FN')
DROP FUNCTION Fn_ReturnToValidateNewRetailerBilling
GO
--SELECT DBO.Fn_ReturnToValidateNewRetailerBilling('2018-10-01','2018-10-31')  
CREATE FUNCTION Fn_ReturnToValidateNewRetailerBilling(
@SalInvDate DATETIME,
@SalId BIGINT,
@RtrId	BIGINT)  
RETURNS NVARCHAR(1000)  
AS  
/**************************************************
* Function : Fn_ReturnToValidateNewRetailerBilling
* PURPOSE   : To Block New Retailer Billing
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/11/2018  S.Moorthi			CR		ILCRSTPAR2672       8) Current console date is 31-10-2018 and distributor's System date is 28-10-2018. if user is creating a retailer according to system  date on '2018-10-28' and  ZSo has approved that retailer on same day  as per console date( 2018-10-31) then from which date user can start billing to new retailer.
 **************************************************/ 
BEGIN

---As discuss with saravanakumar. This will be created for Future purpose only
DECLARE @RetMsg AS NVARCHAR(1000)
   SET @RetMsg=''
   
 RETURN  @RetMsg
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_ReturnToSampleInvoiceCompanyName' AND xtype='FN')
DROP FUNCTION Fn_ReturnToSampleInvoiceCompanyName
GO
--Select DBO.Fn_ReturnToSampleInvoiceCompanyName(0)) 
CREATE FUNCTION Fn_ReturnToSampleInvoiceCompanyName(@RefId AS INT)  
RETURNS NVARCHAR(1000)  
AS  
/**************************************************
* Function : Fn_ReturnToSampleInvoiceCompanyName
* PURPOSE   : To Display by default the Company Name as PARLE BISCUITS PVT LTD
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/11/2018  S.Moorthi			CR		ILCRSTPAR2672       Comapny name will be fixed to "PARLE BISCUITS PVT  LTD"
 **************************************************/ 
BEGIN

---As per Awanish/Client request it should be display purpose.

   DECLARE @RetMsg AS NVARCHAR(1000)
   SET @RetMsg='PARLE BISCUITS PVT LTD'
      
 RETURN  @RetMsg
END
GO
UPDATE A SET A.RemainsltString='SELECT CmpId,CmpCode,''PARLE BISCUITS PVT LTD'' AS CmpName FROM Company (NOLOCK) WHERE CmpHier>0 And Availability=1' 
FROM HotSearchEditorHd A WHERE FormId=783
GO
UPDATE HotSearchEditorHd SET RemainsltString='SELECT DISTINCT PrdId,PrdName,PrdShrtName,PrdDCode,PrdCCode FROM 
(SELECT P.PrdId,P.PrdDCode,P.PrdCCode,P.PrdName,P.PrdShrtName FROM Product P
INNER JOIN ProductBatch PB ON P.PrdId = PB.PrdId INNER JOIN ProductBatchLocation PBL ON P.Prdid=PBL.PrdId 
WHERE PBL.LcnId=vFParam AND P.Cmpid=vSParam  AND ((PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) > 0   OR (PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) > 0  
OR (PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) > 0)) MainSql'
WHERE FORMID=817 and ControlName='ProductCodeWorSaleable'
GO
DELETE FROM HotSearchEditorDt WHERE FormId=817 AND FieldName='ProductCodeWorSaleable'
INSERT INTO HotSearchEditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
SELECT 1,817,'ProductCodeWorSaleable','Name','PrdName',3000,0,'HotSch-226-2000-175',226 UNION --HotSch-226-2000-177
SELECT 2,817,'ProductCodeWorSaleable','Short Name','PrdShrtName',2000,0,'HotSch-226-2000-176',226 UNION --HotSch-226-2000-178
SELECT 3,817,'ProductCodeWorSaleable','Dist Code','PrdDCode',1500,0,'HotSch-226-2000-177',226 UNION --HotSch-226-2000-175
SELECT 4,817,'ProductCodeWorSaleable','Comp Code','PrdCCode',1500,0,'HotSch-226-2000-178',226
GO
DELETE FROM CustomCaptions WHERE TransId=226 AND CtrlId=2000 AND SubCtrlId IN (175,176,177,178)
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 226,2000,175,'HotSch-226-2000-175','Name','','',1,1,1,'2010-10-18',1,'2010-10-18','Name','','',1,1 UNION
SELECT 226,2000,176,'HotSch-226-2000-176','Short Name','','',1,1,1,'2010-10-18',1,'2010-10-18','Short Name','','',1,1 UNION
SELECT 226,2000,177,'HotSch-226-2000-177','Dist Code','','',1,1,1,'2010-10-18',1,'2010-10-18','Dist Code','','',1,1 UNION
SELECT 226,2000,178,'HotSch-226-2000-178','Comp Code','','',1,1,1,'2010-10-18',1,'2010-10-18','Comp Code','','',1,1 
GO
IF NOT EXISTS(SELECT 'X' FROM Tbl_Generic_Reports WHERE RptName='Manual Claim Description')
BEGIN
	DECLARE @RptGSTMaxId as INT
	SELECT @RptGSTMaxId=Max(RptId)+1 FROM Tbl_Generic_Reports
	DELETE FROM Tbl_Generic_Reports WHERE RptName='Manual Claim Description'
	INSERT INTO Tbl_Generic_Reports(RptId,RptName,SPName,Instructions,DrillDown)	
	SELECT @RptGSTMaxId, 'Manual Claim Description','Proc_GR_ManualClaimDescription','Manual Claim Description','Not Available'
	
	Delete FROM Tbl_Generic_Reports_Filters WHERE rptname='Manual Claim Description'
	insert into Tbl_Generic_Reports_Filters(RptId,FilterId,FilterCaption,ParamName,rptname)
	select  @RptGSTMaxId,1,'Description','Proc_GR_ManualClaimDescription_Values','Manual Claim Description'union
	select  @RptGSTMaxId,2,'Not Applicable','Proc_GR_ManualClaimDescription_Values','Manual Claim Description' union
	select  @RptGSTMaxId,3,'Not Applicable','Proc_GR_ManualClaimDescription_Values','Manual Claim Description' union
	select  @RptGSTMaxId,4,'Not Applicable','Proc_GR_ManualClaimDescription_Values','Manual Claim Description'  union
	select  @RptGSTMaxId,5,'Not Applicable','Proc_GR_ManualClaimDescription_Values','Manual Claim Description' union
	select  @RptGSTMaxId,6,'Not Applicable','Proc_GR_ManualClaimDescription_Values','Manual Claim Description'
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_GR_ManualClaimDescription_Values' AND XTYPE='P')
DROP PROCEDURE Proc_GR_ManualClaimDescription_Values
GO
CREATE PROCEDURE Proc_GR_ManualClaimDescription_Values
(
		@FILTERCAPTION  NVARCHAR(100),
		@TEXTLIKE  NVARCHAR(100)
)
AS
/**************************************************
* PROCEDURE : Proc_GR_ManualClaimDescription_Values
* PURPOSE   : To Return the Manual Claim Descrption Master Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/11/2018  S.Moorthi			CR		ILCRSTPAR2672       UAT Changes HF:437
 **************************************************/
BEGIN
		SET @TEXTLIKE='%'+ISNULL(@TEXTLIKE,'')+'%'
		
		--print @filtercaption

		IF @FILTERCAPTION='Description' 
		BEGIN
			SELECT DISTINCT ManualClmDesc as FilterValues FROM ManualClaimDescription WHERE ManualClmDesc LIKE @textlike
		END
		
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_GR_ManualClaimDescription' AND XTYPE='P')
DROP PROCEDURE Proc_GR_ManualClaimDescription
GO
----Exec Proc_GR_ManualClaimDescription 'Manual Claim Description','2018-06-30','2018-12-10','','','','','',''  
CREATE PROCEDURE Proc_GR_ManualClaimDescription
(
	@Pi_RptName		NVARCHAR(100),
	@Pi_FromDate	DATETIME,
	@Pi_ToDate		DATETIME,
	@Pi_Filter1		NVARCHAR(100),
	@Pi_Filter2		NVARCHAR(100),
	@Pi_Filter3		NVARCHAR(100),
	@Pi_Filter4		NVARCHAR(100),
	@Pi_Filter5		NVARCHAR(100),
	@Pi_Filter6		NVARCHAR(100)
)
AS 
/**************************************************
* PROCEDURE : Proc_GR_ManualClaimDescription
* PURPOSE   : To Return the Manual Claim Descrption Master Details
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/11/2018  S.Moorthi			CR		ILCRSTPAR2672       UAT Changes HF:437
 **************************************************/
BEGIN

		SET @Pi_FILTER1='%'+ISNULL(@Pi_FILTER1,'')+'%'        
		SET @Pi_FILTER2='%'+ISNULL(@Pi_FILTER2,'')+'%'        
		SET @Pi_FILTER3='%'+ISNULL(@Pi_FILTER3,'')+'%'        
		SET @Pi_FILTER4='%'+ISNULL(@Pi_FILTER4,'')+'%'        
		SET @Pi_FILTER5='%'+ISNULL(@Pi_FILTER5,'')+'%'  
		SET @Pi_FILTER6='%'+ISNULL(@Pi_FILTER6,'')+'%'    
	
	--SELECT @Pi_FromDate,@Pi_ToDate
	
	SELECT DISTINCT 'Manual Claim Description',ManualClmDesc as [Manual Claim Description],CONVERT(VARCHAR(10),ValidFromDate,105) AS [Valid From Date],
	CONVERT(VARCHAR(10),ValidToDate,105) [Valid To Date],CircularNo,CONVERT(VARCHAR(10),CircularDate,105) as [Circular Date],
	ProposedLibPer,CONVERT(VARCHAR(10),EffectiveFromDate,105) as [Effective From Date],CONVERT(VARCHAR(10),CreatedDate,105)+right(convert(varchar(25),CreatedDate,121),13) as [Downloaded Date] FROM 
	ManualClaimDescription WHERE ManualClmDesc LIKE @PI_FILTER2 AND 
	(@Pi_FromDate BETWEEN ValidFromDate and ValidToDate OR 
	@Pi_ToDate BETWEEN ValidFromDate and ValidToDate
	or ValidFromDate BETWEEN @Pi_FromDate and @Pi_ToDate or 
	ValidToDate BETWEEN @Pi_FromDate and @Pi_ToDate)	  

END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE name='Fn_ToAuditChangesParle' AND xtype in ('FN','TF'))
DROP FUNCTION Fn_ToAuditChangesParle
GO
--select * from Fn_ToAuditChangesParle(2)
CREATE FUNCTION Fn_ToAuditChangesParle(@TransId	INT)
RETURNS @ReturnAudit table
(
	PrdCodeLen	INT,
	PrdNameLen	INT,
	PrdBatchLen	INT,
	AuditStatus	INT,
	ReturnMsg	VARCHAR(500)
)
AS
/**************************************************
* FUNCTION : Fn_ToAuditChangesParle
* PURPOSE   : To Return the Product Code,Name length to grid visibility
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 02/07/2018  S.Moorthi			CR		CRCRSTPAR0011       Audit requirements
 31/08/2018  Amuthakumar P		BZ		ILCRSTPAR1918       Audit requirements
 **************************************************/
BEGIN

DECLARE @AuditValue AS INT

SET @AuditValue=0

	---Billing -2 ,Purchase Receipt -5
	IF @TransId in (2,5)
	BEGIN
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-5,46,13,1,''
	END
	ELSE IF @TransId=3 --Sales Return to Block Multi Invoice
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-5,45,15,1,''
	END
	ELSE IF @TransId in (13) --Stock Management -13,Complemenetary invoice - 226,
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue,45,22,1,''
	END
	ELSE IF @TransId in (226) --Stock Management -13,Complemenetary invoice - 226,
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-5,45,20,1,''
	END
	ELSE IF @TransId in (7) --Purchase Return -7
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-5,38,18,1,''
	END
	ELSE IF @TransId in (1) --Order booking -1
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-5,36,12,1,''
	END
	--- Added by Amuthakumar ILCRSTPAR1918 on 31/08/2018
	ELSE IF @TransId in (26) --Purchase Order -26
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-6,37,20,1,''
	END
	ELSE IF @TransId in (37) --Return To Company-37
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-6,37,20,1,''
	END
	ELSE IF @TransId in (48) --Kit Product Master-48
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-7,37,20,1,''
	END
	ELSE IF @TransId in (4) --Location Transfer-4
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-7,37,20,1,''
	END
	ELSE IF @TransId in (13) --Inventory Record Accuracy-13
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-7,38,20,1,''
	END
	ELSE IF @TransId in (27) --Scheme Monitor-27
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-7,34,12,1,''
	END
	-- Till Here ILCRSTPAR1918
	ELSE IF @TransId in (91) --Product
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-3,45,@AuditValue-3,1,''
	END
	ELSE IF @TransId in (24) --ReturnAndReplacement-24
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-3,30,20,1,''
	END
	ELSE IF @TransId in (252) --SpecialRates-252
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-3,30,20,1,''
	END
	ELSE IF @TransId in (42) --ContractPricing-42
	BEGIN
	
		SET @AuditValue=(SELECT ISNULL(MAX(LEN(PrdDCode)),0) FROM Product(NOLOCK) WHERE PrdStatus=1 and PrdDCode not like '%FREE%')
		
		INSERT INTO @ReturnAudit(PrdCodeLen,PrdNameLen,PrdBatchLen,AuditStatus,ReturnMsg)
		SELECT @AuditValue-3,45,20,1,''
	END
	-- Till Here ILCRSTPAR1918 
	
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_ReturnClaimSchemeSalesValueNew' AND xtype='TF')
DROP FUNCTION Fn_ReturnClaimSchemeSalesValueNew
GO
--SELECT * FROM Fn_ReturnClaimSchemeSalesValue('2018-10-01','2018-10-31')  
CREATE FUNCTION Fn_ReturnClaimSchemeSalesValueNew(@FROMDATE DATETIME,@TODATE DATETIME)  
RETURNS @SALESDETAILSSCHEMEWISE TABLE  
(  
 REFERNO  VARCHAR(200),  
 SCHID  INT,  
 SALESVALUE NUMERIC(38,6)  
)  
AS  
/***************************************************************************************************  
* PROCEDURE : Fn_ReturnClaimSchemeSalesValue  
* PURPOSE : To Return Sales And Sales Return Amount For Scheme Product  
* DATE  : 10/07/2015  
* CREATED : PRAVEENRAJ BHASKARAN  
* MODIFIED  
* DATE       AUTHOR     DESCRIPTION  
----------------------------------------------------------------------------------------------------  
****************************************************************************************************/  
BEGIN  
  SET @FROMDATE=CONVERT(VARCHAR(10),@FROMDATE,121)  
  SET @TODATE=CONVERT(VARCHAR(10),@TODATE,121)  
  
  INSERT INTO @SALESDETAILSSCHEMEWISE(REFERNO,SCHID,SALESVALUE)  
  SELECT ReferNo,SchId,SUM(LCTRAmt) FROM   
  (  
	  SELECT S.SALINVNO AS ReferNo,T.SchId,B.PrdId,CmpBatCode,taxperc,((B.BaseQty *(PBD.PrdBatDetailValue))+((B.BaseQty *(PBD.PrdBatDetailValue))*(SUM(c.TaxPerc)/100)))  As LCTRAmt  
	  from SalesInvoice S (NOLOCK)    
	  INNER JOIN TempSchemeClaimDetails T (NOLOCK) ON T.SalInvNo=S.SalInvNo  
	  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON S.SALID=B.SALID    
	  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON S.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo    
	  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId    
	  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId    
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1 
	  INNER JOIN Fn_ReturnSchemeProductWithScheme() FN ON FN.SchId=T.SchId AND FN.Prdid=B.PrdId AND B.PrdId=FN.Prdid 
	  WHERE S.SalInvDate BETWEEN @FROMDATE AND @TODATE  and PBD.SLNo =3
	   AND C.TaxableAmount >0 GROUP BY S.SALINVNO,T.SchId,B.PrdId,CmpBatCode,taxperc,B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue,B.Uom1Id
	  UNION ALL  
	  SELECT R.ReturnCode AS ReferNo,T.SchId,RP.PrdId,CmpBatCode,taxperc,((RP.BaseQty *(PBD.PrdBatDetailValue))+((RP.BaseQty *(PBD.PrdBatDetailValue))*(SUM(c.TaxPerc)/100)))  As LCTRAmt  
	  from ReturnHeader R (NOLOCK)    
	  INNER JOIN TempSchemeClaimDetails T (NOLOCK) ON T.SalInvNo=R.ReturnCode  
	  INNER JOIN ReturnProduct RP (NOLOCK) ON R.ReturnId=RP.ReturnId     
	  INNER JOIN ReturnProductTax C (NOLOCK) ON R.ReturnID=C.ReturnId AND RP.ReturnId=C.ReturnId AND RP.SlNo=C.PrdSlNo    
	  INNER JOIN PRODUCT P (NOLOCK) ON RP.PrdId=P.PrdId    
	  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=RP.PrdId AND PB.PrdBatId=RP.PrdBatId    
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1 
	  INNER JOIN Fn_ReturnSchemeProductWithScheme() FN ON FN.SchId=T.SchId AND FN.Prdid=RP.PrdId AND RP.PrdId=FN.Prdid 
	  WHERE R.RETURNDATE BETWEEN @FROMDATE AND @TODATE  and PBD.SLNo =3
	  AND C.TaxableAmt >0 GROUP BY R.ReturnCode,T.SchId,RP.PrdId,CmpBatCode,taxperc,RP.BaseQty,RP.prdtaxamt,PBD.PrdBatDetailValue,RP.StockTypeId
   )X GROUP BY ReferNo,SchId
   
 RETURN  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ReturnSchemeClaims' AND TYPE ='P')
DROP PROCEDURE Proc_ReturnSchemeClaims
GO
CREATE PROCEDURE Proc_ReturnSchemeClaims
(
	@Pi_ClmGroupId 	INT,
	@Pi_ClmId		INT,
	@Pi_CmpId		INT,
	@Pi_FromDate	DATETIME,
	@Pi_ToDate		DATETIME,
	@Pi_SettleType	INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT
)
AS
/***************************************************************************************************
* PROCEDURE	: Proc_ReturnSchemeClaims
* PURPOSE	: To Return Scheme Claims
* CREATED	: Thrinath
* CREATED DATE	: 04/12/2007
* MODIFIED
* DATE       AUTHOR         CR/BZ	USER STORY ID           DESCRIPTION        
***************************************************************************************************
27-06-2018	Karthick				CRCRSTPAR0007		Calculate Tax for Claim Based on claimApply tax column in scheme master
30-08-2018  Amuthakumar P	BZ		ILCRSTPAR1917		Update Scheme wise Sales value
11-10-2018  Mohana		    BZ      CRCRSTPAR0031		Ignore Unsaleable Sales Return Products when claim
***************************************************************************************************/     
SET NOCOUNT ON
Begin
DECLARE @SchMst Table
(
	SchId 	INT,
	SchCode	nVarchar(100),
	SchDesc	nVarChar(100),
	SchType INT
)
DECLARE @SchemeDetails TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SchCode			nVarchar(100),
	SchDesc			nVarChar(100),
	SlabId			INT,
	DiscountAmt		Numeric(38,6),
	FreeAmt			Numeric(38,6),
	GiftAmt			Numeric(38,6),
	Type			INT,
	GstTax          Numeric(38,6)
)
DECLARE @SchemePrd 	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	Combi			nVarChar(100)
)
DECLARE @PriScheme	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	PriAmt			Numeric(38,6),
	GSTTax          Numeric(38,6)
)
DECLARE @SchemeDetailsTaxFinal TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT,
	GstTax          Numeric(38,6)
)
DECLARE @SchemeDetailsTax	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	SlNo            INT,
	GSTTax          Numeric(38,6)
)
DECLARE @PriSchemeTax	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	SlNo            INT,
	GSTTax          Numeric(38,6)
)
DECLARE @PriSchemeTaxFinal	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	GSTTax          Numeric(38,6)
)
-- Add by Amuthakumar ILCRSTPAR1917
DECLARE @SchSalVal TABLE
(
	ReferNo varchar(100),
	SchId INT,
	SalesValue Numeric(38,6)
)
-- Till Here		
DECLARE @Claimable	Numeric(38,6)
DECLARE @RefCode	nVarChar(100)
DECLARE @Masterid INT
DECLARE @UdcMasterid INT
DECLARE @TaxValidate as INT
SET @TaxValidate=0
IF EXISTS (SELECT 'X' FROM ClaimGroupMaster(Nolock) where ClmGrpId=@Pi_ClmGroupId and GSTTax=1)
 BEGIN
  SET @TaxValidate=1
 END
	SELECT @Claimable = Claimable FROM ClaimNormDefinition 
		WHERE CmpID=@Pi_CmpId AND ClmGrpId=@Pi_ClmGroupId
	SET @Claimable = ISNULL(@Claimable,0)
	INSERT INTO @SchMst(SchId,SchCode,SchDesc,SchType) 
	SELECT SchId,SchCode,SchDsc,SchType FROM SchemeMaster WITH (NOLOCK)
	WHERE CmpId = @Pi_CmpId AND	Claimable = 1 AND ClmRefId = @Pi_ClmGroupId 
	AND SettlementType = (CASE @Pi_SettleType WHEN 0 THEN SettlementType ELSE @Pi_SettleType END)
	IF EXISTS (SELECT Status FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 )
	BEGIN
		SELECT @RefCode = Condition FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 
		INSERT INTO @SchemePrd (SalInvNo,SchId,SlabId,PrdId,PrdBatId,Combi)
		SELECT B.SalInvno,MIN(A.SchId),E.SlabId,A.PrdId,A.PrdBatId,
			CAST(MIN(A.SchId) as nVarChar(15)) + ' - ' + CAST(E.SlabId as nVarChar(15))
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN (SELECT Y.SalInvno,X.SchId,X.PrdId,X.PrdBatId,MIN(SlabId) as SlabId 
				FROM SalesInvoiceSchemeLineWise X 
				INNER JOIN SalesInvoice Y ON X.SalId = Y.SalId 
				INNER JOIN @SchMst Z ON X.SchId = Z.SchId
				WHERE Y.DlvSts in (4,5) AND X.SchClmId in (0,@Pi_ClmId) AND Z.SchType <> 5
				AND Y.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
				GROUP BY Y.SalInvno,X.SchId,X.PrdId,X.PrdBatId) AS E ON
			E.SalInvNo = B.SalInvNo AND E.PrdId = A.PrdId AND E.PrdBatId = A.PrdBatId
			AND E.SchId = A.SchId
			WHERE B.DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,E.SlabId,A.PrdId,A.PrdBatId		
		
		INSERT INTO  @PriScheme	(SalInvNo,SchId,SlabId,PrdId,PrdBatId,PriAmt,GSTTax)
		SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,
			C.PrdGrossAmount - (C.PrdGrossAmount /(1 +(D.PrdBatDetailValue)/100)),0.00 		
		FROM @SchemePrd B INNER JOIN SalesInvoice A ON A.SalInvNo collate database_default= B.SalInvno collate database_default
			INNER JOIN SalesInvoiceProduct C ON A.SalId = C.SalId
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
	   	----Added by Gopi at 31/05/2017----	
	 IF @TaxValidate=1
	  BEGIN
	   	DELETE FROM @PriSchemeTaxFinal
	   	DELETE FROM @PriSchemeTax
	   	
	   	INSERT INTO @PriSchemeTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
		SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,C.SlNo,
		(C.PrdGrossAmount - (C.PrdGrossAmount /(1 +(D.PrdBatDetailValue)/100))*(F.Taxperc/100))	---Gopi at 27/06/2017	
		FROM @SchemePrd B INNER JOIN SalesInvoice A ON A.SalInvNo collate database_default= B.SalInvno collate database_default
			INNER JOIN SalesInvoiceProduct C ON A.SalId = C.SalId
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN SalesinvoiceProductTax F ON A.SalId=F.SalId and C.SalId=F.SalId
			and C.SlNo=F.PrdSlNo and F.TaxPerc>0.00 
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
	   
	   		INSERT INTO @PriSchemeTaxFinal(SalInvNo,SchId,SlabId,PrdId,PrdBatId,GSTTax)
	   		SELECT SalInvNo,SchId,SlabId,PrdId,PrdBatId,SUM(GSTTax) AS GSTTax
	   		FROM @PriSchemeTax GROUP BY SalInvNo,SchId,SlabId,PrdId,PrdBatId
	   	END
	   	-----Till Here --------	
	   		
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
		SELECT B.SalInvno,A.SchId,A.SlabId,ISNULL(SUM(FlatAmount),0) +  ISNULL(SUM(DiscountPerAmount),0),
			0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1,0
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	IF @TaxValidate=1
	  BEGIN
		----Added by Gopi at 31/05/2017----
		DELETE FROM @SchemeDetailsTax
		DELETE FROM @SchemeDetailsTaxFinal
		
		INSERT INTO @SchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
		SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
		SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
		FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN SalesInvoiceProductTax C ON C.SalId=A.SalId AND C.SalId=B.SalId
			AND C.PrdSlNo=A.RowId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5 AND C.TaxPerc>0.00
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId
		
		INSERT INTO @SchemeDetailsTaxFinal(Salinvno,Schid,SlabId,GstTax)
		SELECT Salinvno,Schid,SlabId,SUM(GstTax) as GstTax FROM @SchemeDetailsTax
		GROUP BY Salinvno,Schid,SlabId
		
		UPDATE B SET GstTax=A.GstTax from @SchemeDetailsTaxFinal A INNER JOIN @SchemeDetails B
		ON A.SchId=B.SchId AND A.SalInvNo=B.SalInvNo AND A.SlabId=B.Slabid 
	END
		----Till Here -------
		-- Credit Note Adjustement ---
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
		SELECT B.SalInvno,A.SchId,0 AS SlabId,ISNULL(SUM(CrNoteAmount),0) ,
			0 as FreeAmt,0 as GiftAmt,S.SchCode,S.SchDesc,1,0
			FROM SalesInvoiceQPSSchemeAdj A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) 
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate AND S.SchType <> 5
		GROUP BY B.SalInvno,A.SchId,S.SchCode,S.SchDesc
        -- End here 
		UPDATE @SchemeDetails SET DiscountAmt = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(PriAmt) as PriAmt
				FROM @PriScheme GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
	IF @TaxValidate=1
	  BEGIN
		----Added by Gopi at 31/05/2017---	
		UPDATE @SchemeDetails SET GstTax = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(GSTTax) as PriAmt
				FROM @PriSchemeTaxFinal GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
		END
		----Till Here ----
	END
	ELSE
	BEGIN
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
		SELECT B.SalInvno,A.SchId,A.SlabId,ISNULL(SUM(FlatAmount),0) +  ISNULL(SUM(DiscountPerAmount),0),
			0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1,0
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	IF @TaxValidate=1
	  BEGIN	
		----Added by Gopi at 31/05/2017----
		DELETE FROM @SchemeDetailsTaxFinal
		DELETE FROM @SchemeDetailsTax
		INSERT INTO @SchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
		SELECT B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.Rowid,
		SUM((FlatAmount + DiscountPerAmount)*(C.TaxPerc/100)) ---Gopi at 27/06/2017
		FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN SalesInvoiceProductTax C ON C.SalId=A.SalId AND C.SalId=B.SalId
			AND C.PrdSlNo=A.RowId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5 AND C.TaxPerc>0.00
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,A.PrdId,A.PrdBatId,A.RowId
		
		INSERT INTO @SchemeDetailsTaxFinal(Salinvno,Schid,SlabId,GstTax)
		SELECT Salinvno,Schid,SlabId,SUM(GstTax) as GstTax FROM @SchemeDetailsTax
		GROUP BY Salinvno,Schid,SlabId
		
		UPDATE B SET GstTax=A.GstTax from @SchemeDetailsTaxFinal A INNER JOIN @SchemeDetails B
		ON A.SchId=B.SchId AND A.SalInvNo=B.SalInvNo AND A.SlabId=B.Slabid
	END 
		----Till Here -------
		-- Credit note adjustment ---
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GSTTax)
		SELECT B.SalInvno,A.SchId,0 AS SlabId,ISNULL(SUM(CrNoteAmount),0),
			0 as FreeAmt,0 as GiftAmt,S.SchCode,S.SchDesc,1,0
			FROM SalesInvoiceQPSSchemeAdj A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,S.SchCode,S.SchDesc
       -- End here --
	END
	
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GSTTax)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(FreeQty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,1,0
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	
	--Added by Sathishkumar Veeramani 2013/09/06
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(PrdAmount),0),0 AS GiftAmt,SchCode,SchDesc,1,0
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
        INNER JOIN PercentageWiseSchemeFreeProducts C WITH (NOLOCK) ON B.SalId = C.SalId
        AND A.FreePrdId = C.PrdId 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType = 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate 
		AND C.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE Status = 0 AND InvoiceType = 1 AND ReturnMode = 1)
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	--Till Here
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(GiftQty * D.PrdBatDetailValue),0),SchCode,SchDesc,1,0
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	IF EXISTS (SELECT Status FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 )
	BEGIN
		SELECT @RefCode = Condition FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 
		DELETE FROM @SchemePrd
		DELETE FROM @PriScheme
		INSERT INTO @SchemePrd (SalInvNo,SchId,SlabId,PrdId,PrdBatId,Combi)
		SELECT B.ReturnCode,MIN(A.SchId),E.SlabId,A.PrdId,A.PrdBatId,
			CAST(MIN(A.SchId) as nVarChar(15)) + ' - ' + CAST(E.SlabId as nVarChar(15))
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId  
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN (SELECT Y.ReturnCode,X.SchId,X.PrdId,X.PrdBatId,MIN(SlabId) as SlabId 
				FROM ReturnSchemeLineDt X 
				INNER JOIN ReturnHeader Y ON X.ReturnId = Y.ReturnId 
				INNER JOIN @SchMst Z ON X.SchId = Z.SchId
				WHERE Y.Status = 0 AND X.SchClmId in (0,@Pi_ClmId) AND Z.SchType <> 5
				AND Y.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
				GROUP BY Y.ReturnCode,X.SchId,X.PrdId,X.PrdBatId) AS E ON
			E.ReturnCode = B.ReturnCode AND E.PrdId = A.PrdId AND E.PrdBatId = A.PrdBatId
			AND E.SchId = A.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,E.SlabId,A.PrdId,A.PrdBatId		
		INSERT INTO  @PriScheme	(SalInvNo,SchId,SlabId,PrdId,PrdBatId,PriAmt)
		SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,
			C.PrdActualGross - (C.PrdActualGross /(1 +(D.PrdBatDetailValue)/100)) 		
		FROM @SchemePrd B INNER JOIN ReturnHeader A ON A.ReturnCode collate database_default= B.SalInvno collate database_default
			INNER JOIN ReturnProduct C ON A.ReturnId = C.ReturnId 
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
	 IF @TaxValidate=1
	  BEGIN  		
	   	----Added by Gopi at 31/05/2017----	
	   	DELETE FROM @PriSchemeTaxFinal
	   	DELETE FROM @PriSchemeTax
	   	
	   	INSERT INTO @PriSchemeTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)	
	   	SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,C.SlNO,
			(C.PrdActualGross - (C.PrdActualGross /(1 +(D.PrdBatDetailValue)/100))*(F.TaxPerc/100)) ---Gopi at 27/06/2017			
		FROM @SchemePrd B INNER JOIN ReturnHeader A ON A.ReturnCode collate database_default= B.SalInvno collate database_default
			INNER JOIN ReturnProduct C ON A.ReturnId = C.ReturnId 
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN ReturnProductTax F ON F.ReturnId=A.ReturnID AND F.ReturnId=C.ReturnID
			AND F.PrdSlno=C.Slno  AND F.TaxPerc>0.00
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
	   	
	   		INSERT INTO @PriSchemeTaxFinal(SalInvNo,SchId,SlabId,PrdId,PrdBatId,GSTTax)
	   		SELECT SalInvNo,SchId,SlabId,PrdId,PrdBatId,SUM(GSTTax) AS GSTTax
	   		FROM @PriSchemeTax GROUP BY SalInvNo,SchId,SlabId,PrdId,PrdBatId
	   	END
	   	-----Till Here --------	
	   		
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
		SELECT B.ReturnCode,A.SchId,A.SlabId,((ISNULL(SUM(ReturnFlatAmount),0) + 
			ISNULL(SUM(ReturnDiscountPerAmount),0)))*(-1),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1,0
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
			----Added by Gopi at 31/05/2017----
	IF @TaxValidate=1
	  BEGIN
		DELETE FROM @SchemeDetailsTaxFinal
		DELETE FROM @SchemeDetailsTax
		
		INSERT INTO @SchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
		SELECT B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId,
		Sum((ReturnFlatAmount + ReturnDiscountPerAmount)*(C.TaxPerc/100))
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN ReturnProductTax C ON C.ReturnId=A.ReturnID AND C.ReturnId=B.ReturnID
			AND C.PrdSlno=A.RowId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND C.TaxPerc>0.00
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId
		
		INSERT INTO @SchemeDetailsTaxFinal(Salinvno,Schid,SlabId,GstTax)
		SELECT Salinvno,Schid,SlabId,-1*SUM(GstTax) as GstTax FROM @SchemeDetailsTax
		GROUP BY Salinvno,Schid,SlabId
		
		UPDATE B SET GstTax=A.GstTax from @SchemeDetailsTaxFinal A INNER JOIN @SchemeDetails B
		ON A.SchId=B.SchId AND A.SalInvNo=B.SalInvNo AND A.SlabId=B.Slabid 
	END
		------Till Here ------
		
		UPDATE @SchemeDetails SET DiscountAmt = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(PriAmt) as PriAmt
				FROM @PriScheme GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
	--Added by Gopi at 31/05/2017---
  IF @TaxValidate=1
	  BEGIN
		UPDATE @SchemeDetails SET DiscountAmt = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(Gsttax) as PriAmt
				FROM @PriSchemeTax GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
	  END
	---Till Here ----
	END
	ELSE
	BEGIN
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
		SELECT B.ReturnCode,A.SchId,A.SlabId,((ISNULL(SUM(ReturnFlatAmount),0) + 
			ISNULL(SUM(ReturnDiscountPerAmount),0)))*(-1),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1,0.00
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN ReturnProduct P ON P.ReturnID = B.ReturnID AND A.PrdId = P.PrdId AND A.prdbatid = p.PrdBatId
			AND P.StockTypeId IN(SELECT Stocktypeid FROM StockType WHERE SystemStockType = 1)  --- Added by Mohana 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	----Added by Gopi at 31/05/2017----
	IF @TaxValidate=1
	  BEGIN	
		DELETE FROM @SchemeDetailsTaxFinal
		DELETE FROM @SchemeDetailsTax
		
		INSERT INTO @SchemeDetailsTax(SalInvNo,SchId,SlabId,PrdId,PrdBatId,SlNo,GSTTax)
		SELECT B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId,
		Sum((ReturnFlatAmount + ReturnDiscountPerAmount)*(C.TaxPerc/100))---Gopi at 27/06/2017	
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN ReturnProduct P ON P.ReturnID = B.ReturnID AND A.PrdId = P.PrdId AND A.prdbatid = p.PrdBatId
			AND P.StockTypeId IN(SELECT Stocktypeid FROM StockType WHERE SystemStockType = 1)  --- Added by Mohana 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN ReturnProductTax C ON C.ReturnId=A.ReturnID AND C.ReturnId=B.ReturnID
			AND C.PrdSlno=A.RowId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND C.TaxPerc>0.00
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,A.Prdid,A.Prdbatid,A.RowId
		
		INSERT INTO @SchemeDetailsTaxFinal(Salinvno,Schid,SlabId,GstTax)
		SELECT Salinvno,Schid,SlabId,-1*SUM(GstTax) as GstTax FROM @SchemeDetailsTax
		GROUP BY Salinvno,Schid,SlabId
		
		UPDATE B SET GstTax=A.GstTax from @SchemeDetailsTaxFinal A INNER JOIN @SchemeDetails B
		ON A.SchId=B.SchId AND A.SalInvNo=B.SalInvNo AND A.SlabId=B.Slabid 
	END
		------Till Here ------
	END
			--select DiscountAmt from @SchemeDetails	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.ReturnCode,A.SchId,A.SlabId,0 as DiscountAmt,
		ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)*(-1),0 as GiftAmt,SchCode,SchDesc,1,0
		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.ReturnCode,A.SchId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)*(-1),SchCode,SchDesc,1,0
		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	
	--INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	--SELECT B.SalInvno,A.SchId,1 as SlabId,ISNULL(SUM(AdjAmt),0),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,2
	--	FROM SalesInvoiceWindowDisplay A 
	--	INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
	--	INNER JOIN @SchMst S ON A.SchId = S.SchId
	--	WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
	--	AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	--GROUP BY B.SalInvno,A.SchId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.ChqDisRefNo,A.TransId,1 as SlaId,ISNULL(SUM(Amount),0),
		0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,3,0 
		FROM ChequeDisbursalMaster A 
		INNER JOIN ChequeDisbursalDetails B ON A.ChqDisRefNo = B.ChqDisRefNo 
		INNER JOIN @SchMst S ON A.TransId = S.SchId
		WHERE TransType = 1 AND S.SchType <> 5 AND A.ChqDisDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.ChqDisRefNo,A.TransId,SchCode,SchDesc
-- FOR Point Based Schemes
	DELETE FROM @SchMst
	INSERT INTO @SchMst(SchId,SchCode,SchDesc) 
	SELECT PntRedSchId,PntRedSchCode,[Description]
 		FROM PointRedemptionMaster WHERE CmpId = @Pi_CmpId AND
		Claimable = 1 AND ClmRefId = @Pi_ClmGroupId
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,ISNULL(SUM(CrAmt),0),0 as FreeAmt,0 As GiftAmt,
		SchCode,SchDesc,4,0
		FROM PntRetSchemeHD A INNER JOIN PntRetSchemeDt B
		ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN @SchMst S ON A.PntRedSchId = S.SchId
		WHERE A.Status = 1 AND A.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt>0 AND B.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,0 as DiscountAmt,ISNULL(SUM(Qty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,4,0
		FROM PntRetSchemeDt A INNER JOIN PntRetSchemeHD B ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.PntRedSchId = S.SchId
		WHERE B.Status = 1 AND B.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt=0 AND A.Type=1 AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(Qty * D.PrdBatDetailValue),0) as GiftAmt,SchCode,SchDesc,4,0
		FROM PntRetSchemeDt A INNER JOIN PntRetSchemeHD B ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.PntRedSchId = S.SchId
		WHERE B.Status = 1 AND B.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt=0 AND A.Type=2 AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
--For Coupon Scheme
	
	DELETE FROM @SchMst
	INSERT INTO @SchMst(SchId,SchCode,SchDesc) 
	SELECT B.CouponDenomId,B.CouponDenomRefNo,A.CouponDefDescription
 		FROM CouponDefinitionHd A INNER JOIN CouponDenomHd B ON
		A.CouponDefId = B.CouponDefId WHERE A.CmpId = @Pi_CmpId AND 
		A.CouponDefClaimable = 1 AND A.CouponDefClaimGroupID = @Pi_ClmGroupId
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT A.CpnRedCode,A.CouponDenomId,B.SlabId,ISNULL(SUM(CrAmt),0),0 as FreeAmt,0 As GiftAmt,
		SchCode,SchDesc,5,0
		FROM CouponRedHd A INNER JOIN CouponRedOtherDt B
		ON A.CpnRefId = B.CpnRefId
		INNER JOIN @SchMst S ON A.CouponDenomId = S.SchId
		WHERE A.Status = 1 AND A.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt>0 AND B.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.CpnRedCode,A.CouponDenomId,B.SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GSTTax)
	SELECT B.CpnRedCode,B.CouponDenomId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(Qty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,5,0
		FROM CouponRedProducts A INNER JOIN CouponRedHd B ON A.CpnRefId = B.CpnRefId
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.CouponDenomId = S.SchId
		INNER JOIN Product P ON P.PrdId = A.PrdId AND P.PrdId = C.PrdId AND PrdType <> 4
		WHERE B.Status = 1 AND B.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.CpnRedCode,B.CouponDenomId,A.SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type,GstTax)
	SELECT B.CpnRedCode,B.CouponDenomId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(Qty * D.PrdBatDetailValue),0) as GiftAmt,SchCode,SchDesc,5,0
		FROM CouponRedProducts A INNER JOIN CouponRedHd B ON A.CpnRefId = B.CpnRefId
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.CouponDenomId = S.SchId
		INNER JOIN Product P ON P.PrdId = A.PrdId AND P.PrdId = C.PrdId AND PrdType =4
		WHERE B.Status = 1 AND B.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.CpnRedCode,B.CouponDenomId,A.SlabId,SchCode,SchDesc
	
	DELETE FROM TempSchemeClaimDetails WHERE Usrid = @Pi_UsrId AND TransID = @Pi_TransId
--	INSERT INTO TempSchemeClaimDetails (SalInvNo,SchId,SchCode,SchDesc,SlabId,Selected,DiscountAmt,
--		FreeAmt,GiftAmt,TotSpent,Claimable,ClaimableAmt,RecomAmount,RecAmount,DBCRSelection,
--		StatusDesc,Type,Usrid,TransID)
--	SELECT SalInvNo,SchId,SchCode,SchDesc,SlabId,0 as Selected,
--		Convert(Numeric(38,2),Sum(DiscountAmt)) ,
--		Convert(Numeric(38,2),sum(FreeAmt)) ,
--		Convert(Numeric(38,2),Sum(GiftAmt)), 
--		Convert(Numeric(38,2),Sum((DiscountAmt + FreeAmt + GiftAmt))) ,
--		ISNULL(@Claimable,0) , 0.00 , 0 , 0  , 0 ,'Cancelled', Type, @Pi_UsrId,@Pi_TransId
--		FROM @SchemeDetails
--	GROUP BY SalInvNo,SchId,SchCode,SchDesc,SlabId,Type
    UPDATE @SchemeDetails SET GstTax=0.00 where GstTax Is Null
	
	INSERT INTO TempSchemeClaimDetails (SalInvNo,SchId,SchCode,CmpSchCode,SchDesc,SlabId,Selected,DiscountAmt,
		FreeAmt,GiftAmt,TotSpent,Claimable,ClaimableAmt,RecomAmount,RecAmount,DBCRSelection,
		StatusDesc,Type,Usrid,TransID,GSTTax)
	SELECT SD.SalInvNo,SD.SchId,SD.SchCode,SM.CmpSchCode,SD.SchDesc,SD.SlabId,0 as Selected,
		Convert(Numeric(38,2),Sum(DiscountAmt)) ,
		Convert(Numeric(38,2),sum(FreeAmt)) ,
		Convert(Numeric(38,2),Sum(GiftAmt)), 
		Convert(Numeric(38,2),Sum((DiscountAmt + FreeAmt + GiftAmt))) ,
		ISNULL(@Claimable,0) , 0.00 , 0 , 0  , 0 ,'Cancelled', Type, @Pi_UsrId,@Pi_TransId,CASE ApplyTaxForClaim WHEN 1 THEN SUM(GstTax) ELSE 0 END
		FROM @SchemeDetails SD,SchemeMaster SM
	WHERE SD.SchId=SM.SchId 
	GROUP BY SD.SalInvNo,SD.SchId,SD.SchCode,SM.CmpSchCode,SD.SchDesc,SD.SlabId,Type,ApplyTaxForClaim	
	
	-- Add by Amuthakumar ILCRSTPAR1917
	INSERT INTO @SchSalVal(ReferNo,SchId,SalesValue)
	SELECT  REFERNO,SCHID,SALESVALUE FROM Fn_ReturnClaimSchemeSalesValueNew(@Pi_FromDate,@Pi_ToDate)

	UPDATE A SET SalesValue=B.SalesValue from TempSchemeClaimDetails A INNER JOIN @SchSalVal B
	ON A.SchId=B.SchId AND A.SalInvNo=B.ReferNo 
	-- Till Here
			
END
GO
--UAT CHANGES Till Here
--Live Release Updater
--SELECT 2197,'2018-04-06',GETDATE()
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_LoadConsolePurchaseInvoice]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION Fn_LoadConsolePurchaseInvoice
GO
--SELECT * FROM Fn_LoadConsolePurchaseInvoice('1516304516-1',1)  
CREATE FUNCTION dbo.Fn_LoadConsolePurchaseInvoice(@InvoiceNo VARCHAR(100),@lDisplay AS INT)  
RETURNS @PurchaseInvoice TABLE  
(  
 CmpInvNo  VARCHAR(100),  
 RowId   INT,  
 PrdId   BIGINT,  
 PrdDCode  VARCHAR(100),  
 PrdName   VARCHAR(200),  
 PrdBatId  BIGINT,  
 PrdBatCode  VARCHAR(100),  
 DefaultPriceId BIGINT,  
 POUOMId   INT,  
 POUOMCode  VARCHAR(100),  
 POQty   INT,  
 InvUOMId  INT,  
 InvUOMCode  VARCHAR(100),  
 InvQty   NUMERIC(18,0),  
 GrossAmt  NUMERIC(18,6),  
 DiscAmt   NUMERIC(18,6),  
 TaxAmt   NUMERIC(18,6),  
 FreightCharges  NUMERIC(18,6),  
 NetAmt   NUMERIC(18,6),  
 NewPrd   INT,  
 PrdBEDAmount NUMERIC(18,6),  
 QtyInKg   NUMERIC(18,6),  
 AddDiscAmt  NUMERIC(18,6)  
)  
AS  
BEGIN  
DECLARE @TaxType AS VARCHAR(20)  
DECLARE @GstEnabled AS INT  
SET @GstEnabled=0  
SET @TaxType=''  
   
   
 SELECT @TaxType=ISNULL(TaxType,'VAT') FROM ETLTempPurchaseReceipt(NOLOCK) WHERE CmpInvNo=@InvoiceNo  
 IF EXISTS(SELECT * FROM GSTCONFIGURATION (NOLOCK) WHERE ActivationStatus=1 AND AcknowledgeStatus=1 AND ConsoleAckStatus=1)  
 BEGIN  
  SET @GstEnabled=1   
 END  
   
  IF @GstEnabled=1 AND RTRIM(LTRIM(UPPER(ISNULL(@TaxType,'VAT'))))='VAT'  
  BEGIN  
   --ProductBatchVATTaxB4GST  
     
   INSERT INTO @PurchaseInvoice(CmpInvNo,RowId,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,DefaultPriceId,POUOMId,  
   POUOMCode,POQty,InvUOMId,InvUOMCode,InvQty,GrossAmt,DiscAmt,TaxAmt,FreightCharges,NetAmt,NewPrd,PrdBEDAmount,QtyInKg,AddDiscAmt)  
   SELECT DISTINCT ETL.CmpInvNo,ETL.RowId,ETL.PrdId,CASE @lDisplay WHEN 1 THEN  P.PrdCCode WHEN 2 THEN P.PrdDCode END AS PrdDCode,  
   P.PrdName,ETL.PrdBatId,PB.PrdBatCode,PBV.DefaultPriceId,ETL.POUOMId,'' AS POUOMCode,ETL.POQty,ETL.InvUOMId,UI.UOMCode AS InvUOMCode,  
   ETL.InvQty,ETL.GrossAmt,ETL.DiscAmt,ETL.TaxAmt,ISNULL(ETL.FreightCharges,0) AS FreightCharges,ETL.NetAmt,ETL.NewPrd,  
   ISNULL(ETL.PrdBEDAmount,0) AS PrdBEDAmount,ISNULL(ETL.QtyInKg,0) AS QtyInKg,ETL.AddDiscAmt FROM ETLTempPurchaseReceiptProduct ETL,Product P,ProductBatch PB,ProductBatchVATTaxB4GST PBV,  
   UOMMaster UI WHERE ETL.PrdId=P.PrdId AND ETL.PrdBatId=PB.PrdBatId AND ETL.InvUOMId= UI.UOMId AND P.PrdId=PBV.PrdId   
   AND PB.PrdBatId=PBV.PrdBatId AND ETL.PrdId=PBV.PrdId AND ETL.PrdBatId=PBV.PrdBatId  
   and cmpinvno=@InvoiceNo  
       
  END  
  ELSE  
  BEGIN  
    
   INSERT INTO @PurchaseInvoice(CmpInvNo,RowId,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,DefaultPriceId,POUOMId,  
   POUOMCode,POQty,InvUOMId,InvUOMCode,InvQty,GrossAmt,DiscAmt,TaxAmt,FreightCharges,NetAmt,NewPrd,PrdBEDAmount,QtyInKg,AddDiscAmt)  
   SELECT DISTINCT ETL.CmpInvNo,ETL.RowId,ETL.PrdId,CASE @lDisplay WHEN 1 THEN  P.PrdCCode WHEN 2 THEN P.PrdDCode END AS PrdDCode,  
   P.PrdName,ETL.PrdBatId,PB.PrdBatCode,PB.DefaultPriceId,ETL.POUOMId,'' AS POUOMCode,ETL.POQty,ETL.InvUOMId,UI.UOMCode AS InvUOMCode,  
   ETL.InvQty,ETL.GrossAmt,ETL.DiscAmt,ETL.TaxAmt,ISNULL(ETL.FreightCharges,0) AS FreightCharges,ETL.NetAmt,ETL.NewPrd,  
   ISNULL(ETL.PrdBEDAmount,0) AS PrdBEDAmount,ISNULL(ETL.QtyInKg,0) AS QtyInKg,ETL.AddDiscAmt FROM ETLTempPurchaseReceiptProduct ETL,  
   Product P,ProductBatch PB,UOMMaster UI WHERE ETL.PrdId=P.PrdId AND ETL.PrdBatId=PB.PrdBatId AND   
   ETL.InvUOMId= UI.UOMId and cmpinvno=@InvoiceNo   
     
  END  
   
RETURN  
END
GO
IF EXISTS(SELECT * FROM Sys.objects WHERE Name = 'Proc_Cs2Cn_SchemeStockReconsolidation' and TYPE = 'P')
DROP PROCEDURE Proc_Cs2Cn_SchemeStockReconsolidation
GO
/*
Begin transaction
delete from Cs2Cn_Prk_SchemeStockReconsolidation --where billno ='P79851800200'
EXEC Proc_Cs2Cn_SchemeStockReconsolidation 0,'2018-10-31'
--select * from Cs2Cn_Prk_SchemeStockReconsolidation order by slno
select * from Cs2Cn_Prk_SchemeStockReconsolidation where billno ='P79851800200'
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_SchemeStockReconsolidation
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_SchemeStockReconsolidation 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* DATE       AUTHOR     CR/BZ		USER STORY ID           DESCRIPTION                         
*************************************************
06/04/2017  Lakshman M   BZ          ILCRSTPAR0071           Upload process sales data bill wsie status valiation added in CS.
27/08/2018  Sheik Dawood BZ			 ILCRSTPAR1861			 Bill No & Billed Qty showing multiple times	
*********************************/
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_SchemeStockReconsolidation WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT * FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
				
	SELECT @FromDate = MIN(SchValidFrom),@ToDate = MAX(SchValidTill) FROM SchemeMaster S (NOLOCK)
	WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate BETWEEN S.SchValidFrom AND S.SchValidTill AND TransType = 1)

	SELECT S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId,SUM(SP.BaseQty) BaseQty
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 
	AND S.SalInvNo  IN (select SalInvNo from Cs2Cn_Prk_DailySales (nolock)) ------------ Added By LAkshman M PMSid: ILCRSTPAR0071
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId
	
	CREATE TABLE #ApplicableProduct
	(
		SchId		INT,
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT DISTINCT A.SchId,B.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN Product C On B.Prdid = C.PrdId
		WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0
	UNION ALL
	SELECT DISTINCT A.SchId,E.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F On
		F.PrdId = E.Prdid
		WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0
	UNION ALL
	SELECT DISTINCT S.SchId,B.MasterRecordId
		FROM SchemeProducts A 
		INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId 
		INNER JOIN SchemeMaster S ON A.SchId = S.SchId
		WHERE S.SchemeLvlMode = 1
	CREATE TABLE #ApplicableScheme
	(
		SchId			INT,
		SchValidFrom	DATETIME,
		SchValidTill	DATETIME,	
		PrdId 		INT,
		salinvno    Varchar(50)
	)	
	INSERT INTO #ApplicableScheme (SchId,SchValidFrom,SchValidTill,PrdId,salinvno)			
	SELECT DISTINCT A.SchId,S.SchValidFrom,S.SchValidTill,A.PrdId,B.salinvno FROM #ApplicableProduct A (NOLOCK),
	SchemeMaster S (NOLOCK),#BillingDetails B (NOLOCK)
	,SalesInvoiceSchemeHd SH(Nolock)  ---ILCRSTPAR1861
	WHERE A.SchId = S.SchId AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	and A.Schid = SH.SchId   --ILCRSTPAR1861
	and B.Salid = SH.Salid   --ILCRSTPAR1861
	And A.Prdid = B.Prdid    --ILCRSTPAR1861

	SELECT S.SchId,S.SchValidFrom,S.SchValidTill,
	B.PrdId,CAST(0 AS INT) CB,CAST(0 AS NUMERIC(18,0)) OpenStock,CAST(0 AS NUMERIC(18,0)) CloseStock,
	B.SalId,B.SalInvNo,B.SalInvDate,B.BaseQty
	INTO #SchemeStock
	FROM #ApplicableScheme S (NOLOCK),
	#BillingDetails B (NOLOCK) 
	WHERE S.PrdId = B.PrdId AND S.salinvno =B.SalInvNo  AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill

	UPDATE S SET S.CB = ConversionFactor
	FROM #SchemeStock S (NOLOCK),
	(
	SELECT P.PrdId,MAX(U.ConversionFactor) ConversionFactor
	FROM Product P (NOLOCK),UomGroup U (NOLOCK)
	WHERE P.UomGroupId = U.UomGroupId 
	GROUP BY P.PrdId
	) C WHERE C.PrdId = S.PrdId
	
	SELECT * INTO #StockLedger 
	FROM StockLedger S (NOLOCK)
	WHERE EXISTS (SELECT '' FROM #ApplicableScheme A (NOLOCK) WHERE S.PrdId = A.PrdId)
	AND S.LcnId = 1
	
	--OpenStock	
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Open
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate < S.SchValidFrom
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	
	SELECT SchId,PrdId,SUM(SalClsStock) OpenStock
	INTO #OpenStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock SalClsStock
	FROM #Open O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) O
	GROUP BY SchId,PrdId
	--OpenStock
	--CloseStock
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Close
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate <= S.SchValidTill
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	SELECT SchId,PrdId,SUM(SalClsStock) CloseStock
	INTO #CloseStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock
	FROM #Close O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) C
	GROUP BY SchId,PrdId
	--CloseStock
	UPDATE S SET S.OpenStock = O.OpenStock
	FROM #SchemeStock S (NOLOCK),
	#OpenStock O (NOLOCK)
	WHERE S.SchId = O.SchId AND S.PrdId = O.PrdId	
	
	UPDATE S SET S.CloseStock = C.CloseStock
	FROM #SchemeStock S (NOLOCK),
	#CloseStock C (NOLOCK)
	WHERE S.SchId = C.SchId AND S.PrdId = C.PrdId
	
	SELECT SM.CmpSchCode,P.PrdCCode,S.CB NoOfPkt,S.SalInvNo BillNo,SalInvDate BillDate,S.BaseQty BillQty,S.OpenStock,S.CloseStock
	INTO #SchemeStockReconciliation
	FROM #SchemeStock S,
	SchemeMaster SM (NOLOCK),
	Product P (NOLOCK)
	WHERE S.SchId = SM.SchId AND S.PrdId = P.PrdId
	
	INSERT INTO Cs2Cn_Prk_SchemeStockReconsolidation (DistCode,CmpSchCode,PrdCCode,NoOfPkt,BillNo,BillDate,BillQty,
	OpenStock,CloseStock,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,CmpSchCode,PrdCCode,NoOfPkt,BillNo,BillDate,BillQty,OpenStock,CloseStock,
	'N' UploadFlag,NULL,@ServerDate
	FROM #SchemeStockReconciliation (NOLOCK)
	
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--SalesInvoice S (NOLOCK) WHERE U.TransType = 1 AND U.TransId = S.SalId
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--ReturnHeader S (NOLOCK) WHERE U.TransType = 2 AND U.TransId = S.ReturnID
	
	RETURN			
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='FN_REMOVE_SPECIAL_CHARACTEREwayBill' and XTYPE IN ('TF','FN'))
DROP FUNCTION FN_REMOVE_SPECIAL_CHARACTEREwayBill
GO
CREATE FUNCTION FN_REMOVE_SPECIAL_CHARACTEREwayBill
 ( 
 @INPUT_STRING varchar(300))
 RETURNS VARCHAR(300)
 AS
/*********************************
* FUNCTION	: FN_REMOVE_SPECIAL_CHARACTEREwayBill
* PURPOSE	: To Remove Special Characters in EwayBill
* CREATED	: Gopi
* CREATED DATE	: 29/01/2018
* MODIFIED
******************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
*******************************************************************************************************
* 29/01/2018   Gopikrishnan.R    CR     CCRSTMRC0415      To Remove Special Characters in EwayBill
  28-05-2018   Mohanakrishna A.B SR		ILCONSPAR0748     To Remove Some others Special Characters in EwayBill
*********************************************************************************************************/
 BEGIN

 --declare @testString varchar(100),
 DECLARE @NEWSTRING VARCHAR(100) 
 -- set @teststring = '@san?poojari(darsh)'
 SET @NEWSTRING = @INPUT_STRING ; 
 With SPECIAL_CHARACTER as
 (
 
  SELECT '~' as item
  UNION ALL
  SELECT '`' as item
  UNION ALL 
  SELECT '!' as item
  UNION ALL 
  SELECT '@' as item
  UNION ALL 
  SELECT '#' as item  --Mohanakrishna A.B
  UNION ALL 
  SELECT '%' as item
  UNION ALL 
  SELECT '^' as item
  UNION ALL 
  SELECT '&' as item  --Mohanakrishna A.B
  UNION ALL 
  SELECT '*' as item
  UNION ALL 
  SELECT '(' as item  --Mohanakrishna A.B
  UNION ALL 
  SELECT ')' as item  --Mohanakrishna A.B
  UNION ALL 
  SELECT '-' as item
  UNION ALL 
  SELECT '_' as item
  UNION ALL 
  SELECT '=' as item
  UNION ALL 
  SELECT '+' as item
  UNION ALL 
  SELECT '{' as item
  UNION ALL 
  SELECT '}' as item
  UNION ALL 
  SELECT '[' as item
  UNION ALL 
  SELECT ']' as item
  UNION ALL 
  SELECT '|' as item
  UNION ALL 
  SELECT '\' as item
  UNION ALL
  SELECT ':' as item
  UNION ALL
  SELECT ';' as item
  UNION ALL
  SELECT '"' as item
  UNION ALL
  SELECT '>' as item
  UNION ALL 
  SELECT '<' as item
  UNION ALL 
  SELECT ',' as item
  UNION ALL 
  SELECT '.' as item
 UNION ALL 
 SELECT '?' as item
 UNION ALL 
 SELECT '/' as item
 UNION ALL 
 SELECT '''' as item
 
 )
 SELECT @NEWSTRING = Replace(@NEWSTRING,ITEM,' ') FROM SPECIAL_CHARACTER 
 return @NEWSTRING 
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME='Debitnote_Scheme' AND TYPE ='U')
BEGIN
	CREATE TABLE Debitnote_Scheme
	(
		[SchId] [int] NULL,
		[SlabId] [int] NULL,
		[Salid] [int] NULL,
		[FlatAmount] [numeric](38, 6) NULL,
		[DiscountPer] [numeric](38, 6) NULL,
		[FreeValue] [numeric](38, 6) NULL,
		[GiftValue] [numeric](38, 6) NULL,
		[SchemeBudget] [numeric](38, 6) NULL,
		[BudgetUtilized] [numeric](38, 6) NULL,
		[Selected] [int] NULL,
		[Linetype] [int] NULL,
		[Salinvdate] [datetime] NULL,
		[Prdid] [int] NULL
	)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptSchemeStockReconciliationReport]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptSchemeStockReconciliationReport]
GO
/*
begin tran
EXEC Proc_RptSchemeStockReconciliationReport 290,2,0,'',0,0,1
rollback tran
*/
CREATE PROCEDURE [dbo].[Proc_RptSchemeStockReconciliationReport]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*************************************************************************************************
* PROCEDURE	: Proc_RptSchemeStockReconciliationRepo
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
12-10-2017  Mohana.S	 CR     CCRSTPAR0174          Changed the Stock details based on Purchase 
07-12-2017  Mohana.S	 BZ     ICRSTPAR6933          RcvdGoodDate changed to InvDate
19-06-2018  Lakshman M   BZ     ILCRSTPAR1041         changed the company scheme code in core stocky 
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
		
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @SchId	AS INT		
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @SchId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	
	--Commented by Mohana
	--To Filter Products
	--SELECT S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId,SUM(SP.BaseQty) BaseQty
	--INTO #BillingDetails
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId
	
	--Added By Mohana ICRSTPAR6933
		
	SELECT A.PurRcptId,A.CmpInvNo,A.GoodsRcvdDate InvDate,B.PrdId,SUM(B.RcvdGoodBaseQty) BaseQty
	INTO #PurchaseDetails FROM PurchaseReceipt  A 
	INNER JOIN PurchaseReceiptProduct B ON A.PurRcptId= B.PurRcptId
	AND A.GoodsRcvdDate BETWEEN @FromDate AND @ToDate AND A.Status = 1
	AND EXISTS   (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE B.PrdId = FP.PrdId)
	GROUP BY  A.PurRcptId,A.CmpInvNo,B.PrdId,A.GoodsRcvdDate
		
	CREATE TABLE #ApplicableProduct
	(
		SchId		INT,
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT DISTINCT A.SchId,B.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN Product C On B.Prdid = C.PrdId
		WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0
	UNION ALL
	SELECT DISTINCT A.SchId,E.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F On
		F.PrdId = E.Prdid
		WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0
	UNION ALL
	SELECT DISTINCT S.SchId,B.MasterRecordId
		FROM SchemeProducts A 
		INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId 
		INNER JOIN SchemeMaster S ON A.SchId = S.SchId
		WHERE S.SchemeLvlMode = 1
	CREATE TABLE #ApplicableScheme
	(
		SchId			INT,
		SchValidFrom	DATETIME,
		SchValidTill	DATETIME,	
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableScheme (SchId,SchValidFrom,SchValidTill,PrdId)			
	SELECT DISTINCT A.SchId,S.SchValidFrom,S.SchValidTill,A.PrdId FROM #ApplicableProduct A (NOLOCK),
	SchemeMaster S (NOLOCK) , #PurchaseDetails B
	WHERE A.SchId = S.SchId AND B.InvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	AND (S.SchId = (CASE @SchId  WHEN 0 THEN S.SchId ELSE 0 END) OR 
	S.SchId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,8, @Pi_UsrId)))	
	
	SELECT S.SchId,S.SchValidFrom,S.SchValidTill,
	B.PrdId,CAST(0 AS INT) CB,CAST(0 AS NUMERIC(18,0)) OpenStock,CAST(0 AS NUMERIC(18,0)) CloseStock,
	B.PurRcptId,B.CmpInvNo,B.InvDate,B.BaseQty
	INTO #SchemeStock
	FROM #ApplicableScheme S (NOLOCK),
	#PurchaseDetails B (NOLOCK) 
	WHERE S.PrdId = B.PrdId AND B.InvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	
	UPDATE S SET S.CB = ConversionFactor
	FROM #SchemeStock S (NOLOCK),
	(
	SELECT P.PrdId,MAX(U.ConversionFactor) ConversionFactor
	FROM Product P (NOLOCK),UomGroup U (NOLOCK)
	WHERE P.UomGroupId = U.UomGroupId 
	GROUP BY P.PrdId
	) C WHERE C.PrdId = S.PrdId
	
	SELECT * INTO #StockLedger 
	FROM StockLedger S (NOLOCK)
	WHERE EXISTS (SELECT '' FROM #ApplicableScheme A (NOLOCK) WHERE S.PrdId = A.PrdId)
	AND S.LcnId = 1
	
	--OpenStock	
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Open
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate < S.SchValidFrom
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	
	SELECT SchId,PrdId,SUM(SalClsStock) OpenStock
	INTO #OpenStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock SalClsStock
	FROM #Open O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) O
	GROUP BY SchId,PrdId
	--OpenStock
	--CloseStock
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Close
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate <= S.SchValidTill
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	SELECT SchId,PrdId,SUM(SalClsStock) CloseStock
	INTO #CloseStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock
	FROM #Close O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) C
	GROUP BY SchId,PrdId
	--CloseStock
	UPDATE S SET S.OpenStock = O.OpenStock
	FROM #SchemeStock S (NOLOCK),
	#OpenStock O (NOLOCK)
	WHERE S.SchId = O.SchId AND S.PrdId = O.PrdId	
	
	UPDATE S SET S.CloseStock = C.CloseStock
	FROM #SchemeStock S (NOLOCK),
	#CloseStock C (NOLOCK)
	WHERE S.SchId = C.SchId AND S.PrdId = C.PrdId
	
	--SELECT SM.SchId SchId,SM.SchCode,CAST(P.PrdId AS NUMERIC(18,2)) PrdId,P.PrdName,S.CB,S.OpenStock,  <--- Commented By Lakshman M on 19/06/2018
	SELECT SM.SchId SchId,SM.CmpSchCode AS SchCode,CAST(P.PrdId AS NUMERIC(18,2)) PrdId,P.PrdName,S.CB,S.OpenStock, --- company scheme code added by Lakshman M on 19/06/2018 PMS ID:ILCRSTPAR1041
	PurRcptId,CmpInvNo,CONVERT(NVARCHAR(11),S.InvDate,105) GoodsRcvdDate,S.BaseQty,S.CloseStock
	INTO #SchemeStockReconciliation
	FROM #SchemeStock S,
	SchemeMaster SM (NOLOCK),
	Product P (NOLOCK)
	WHERE S.SchId = SM.SchId AND S.PrdId = P.PrdId
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptSchemeStockReconciliationReport_Excel')
	DROP TABLE RptSchemeStockReconciliationReport_Excel
	
	SELECT *
	INTO RptSchemeStockReconciliationReport_Excel
	FROM #SchemeStockReconciliation (NOLOCK) 
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptSchemeStockReconciliationReport_Excel
	
	IF EXISTS (SELECT 'C' FROM RptSchemeStockReconciliationReport_Excel (NOLOCK))
	BEGIN
		INSERT INTO RptSchemeStockReconciliationReport_Excel (SchId,SchCode,PrdId,PrdName,CB,OpenStock,Purrcptid,CmpInvNo,GoodsRcvdDate,
		BaseQty,CloseStock)
		
		SELECT SchId,'' SchCode,PrdId + 0.5 ,'Total' PrdName,MAX(CB) CB,MAX(OpenStock) OpenStock,
		MIN(Purrcptid),'' Cmpinvno,'' GoodsRcvdDate,SUM(BaseQty),MAX(CloseStock)
		FROM RptSchemeStockReconciliationReport_Excel
		GROUP BY SchId,PrdId
		
		UPDATE R SET R.OpenStock = NULL,R.PrdName = '',R.SchCode = ''
		FROM RptSchemeStockReconciliationReport_Excel R (NOLOCK)
		WHERE NOT EXISTS (SELECT 'C' FROM RptSchemeStockReconciliationReport_Excel T 
		WHERE T.PrdName = 'Total' AND R.SchId = T.SchId AND R.PrdId + 0.5 = T.PrdId AND R.Purrcptid = T.Purrcptid)
		AND R.PrdName <> 'Total'
		
		UPDATE R SET R.CloseStock = NULL
		FROM RptSchemeStockReconciliationReport_Excel R (NOLOCK)
		WHERE R.PrdName <> 'Total'
	END
	SELECT * FROM RptSchemeStockReconciliationReport_Excel ORDER BY SchId,PrdId,Purrcptid
	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE name ='Proc_RptTaxGroupMaster' AND XTYPE='P')
DROP PROC Proc_RptTaxGroupMaster
GO
--EXEC Proc_RptTaxGroupMaster 79,,0,'',0,0,1
CREATE PROCEDURE [dbo].[Proc_RptTaxGroupMaster]

/************************************************************
* PROCEDURE	: Proc_RptTaxGroupMaster
* PURPOSE	: To Generate Tax Group Master report
* CREATED BY	: Jisha Mathew
* CREATED DATE	: 15/02/2008
* NOTE		:
* MODIFIED
-------------------------------------------------------------------------------------------------------
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* Date            Name              PMS NO            CR/BUG      Remarks
-------------------------------------------------------------------------------------------------------
01-08-2018    Deepak Philip        ILCRSTPAR1595      BUG      column datatype length has been increased
*************************************************************/
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT	
)
AS
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @SSQL		AS 	VarChar(8000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
--added by deepak philip for ILCRSTPAR1595
	CREATE  TABLE #RPTTAXGROUPMASTER
		(
			TaxGroupId INT,
			TaxGroupCode NVARCHAR(400),
			TaxGroupName NVARCHAR(400),
			TaxGroup NVARCHAR(100),
			UsrId INT	
		)
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate		AS	DATETIME
	DECLARE @TaxGroupId	AS	INT
	DECLARE @TaxGroup 	AS	NVARCHAR(100)

	SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @TaxGroupId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,98,@Pi_UsrId))
	SET @TaxGroup = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,97,@Pi_UsrId))

	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate) 
	PRint @FromDate
	
	DELETE FROM #RPTTAXGROUPMASTER Where Usrid=@Pi_UsrId
	
	SET @TblName = 'RptTaxGroupMaster'
--added by deepak philip for ILCRSTPAR1595	
	SET @TblStruct ='		
			TaxGroupId INT,
			TaxGroupCode NVARCHAR(400),
			TaxGroupName NVARCHAR(400),
			TaxGroup NVARCHAR(100)
		'					
	SET @TblFields = 'TaxGroupId,TaxGroupCode,TaxGroupName,TaxGroup'
			 
	IF @Pi_GetFromSnap = 1 
	   BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	   END
	ELSE
	   BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
		   END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	   BEGIN

		INSERT INTO #RPTTAXGROUPMASTER (TaxGroupId,TaxGroupCode,TaxGroupName,TaxGroup,UsrId)
		Select Distinct TaxGroupId,(CASE TaxGroup When 1 Then RtrGroup
							 When 2 Then PrdGroup
							 When 3 Then RtrGroup 
					   END) AS TaxGroupCode,TaxGroupName,
					  (Case TaxGroup When 1 Then 'Retailer'
					  When 2 Then 'Product'
					  When 3 Then 'Supplier' END) AS TaxGroup,@Pi_UsrId AS UsrId 
		From TaxGroupSetting
		Where (TaxGroupId = (CASE @TaxGroupId WHEN 0 THEN TaxGroupId ELSE 0 END) OR 
				TaxGroupId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,98,@Pi_UsrId))) 
		AND (TaxGroup = (CASE @TaxGroup WHEN 0 THEN TaxGroup ELSE 0 END) OR 
				TaxGroup in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,97,@Pi_UsrId))) 

   	   	IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RPTTAXGROUPMASTER ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ ' WHERE RptId=' + CAST(@Pi_RptId AS nVarchar(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + '' 
				+ 'AND (TaxGroupId = (CASE ' + CAST(@TaxGroupId AS nVarchar(10)) + ' WHEN 0 THEN TaxGroupId ELSE 0 END) OR '
				+ 'TaxGroupId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
				+ 'AND (TaxGroup = (CASE ' + CAST(@TaxGroup AS nVarchar(10)) + ' WHEN 0 THEN TaxGroup ELSE 0 END) OR '
				+ 'TaxGroup in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
				+ CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'

			EXEC (@SSQL)
		END
	
		IF @Pi_SnapRequired = 1
		   BEGIN
			SELECT @NewSnapId = @Pi_SnapId
	
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			   BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName + 
					'(SnapId,RptId,' + @TblFields + ',UserId)' + 
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RPTTAXGROUPMASTER'
	
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			   END
		   END
	   END
	ELSE				--To Retrieve Data From Snap Data
	   BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0 
		   BEGIN
			SET @SSQL = 'INSERT INTO #RPTTAXGROUPMASTER ' + 
				'(' + @TblFields + ')' + 
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
	
	
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		   END
		ELSE
		   BEGIN
			PRINT 'DataBase or Table not Found'
		   END
	   END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RPTTAXGROUPMASTER 

SELECT * FROM #RPTTAXGROUPMASTER
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptKitProduct]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptKitProduct]
GO
--Exec Proc_RptKitProduct 138,2,0,seeba,0,0,1,0
CREATE   PROCEDURE [dbo].[Proc_RptKitProduct]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/************************************************
* PROCEDURE  : Proc_RptKitProduct
* PURPOSE    : To Generate  Kit Product Master Report
* CREATED BY : Mahalakshmi.A
* CREATED ON : 11/06/2008
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION
/*
***********************************************'**************************************************
* DATE			AUTHOR		CR/BZ		USER STORY ID           DESCRIPTION                         
**************************************************************************************************
* 02/08/2018   Lakshman M   BZ          ILCRSTPAR1616           Temp Table dat type size increased IN CS.    
***************************************************************************************************
*/
*************************************************/
BEGIN
SET NOCOUNT ON
DECLARE @NewSnapId 			AS	INT
DECLARE @DBNAME				AS 	nvarchar(50)
DECLARE @TblName 			AS	nvarchar(500)
DECLARE @TblStruct 			AS	nVarchar(4000)
DECLARE @TblFields 			AS	nVarchar(4000)
DECLARE @sSql				AS 	nVarChar(4000)
DECLARE @ErrNo	 			AS	INT
DECLARE @PurDBName			AS	nVarChar(50)
--Filter Variable
DECLARE @PrdId			As INT
DECLARE @Status			As INT
--Till Here
--Assgin Value for the Filter Variable
SET @PrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
SET @Status = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,182,@Pi_UsrId))
--Till Here
Print @PrdId
Print @Status
------ added By Lakshman M dated On 02/08/2018 PMS ID: ILCRSTPAR1616 ---------------
Create TABLE #RptKitProduct
(
		KitPrdId 		 INT,
		KitPrdName		 NVARCHAR(150),
		PrdComponentCode 	 NVARCHAR(150),
		ProductComponentName	 NVARCHAR(150),
		Batch			 NVARCHAR(100), 
		Qty			 INT,
                Status			 INT
		
)
SET @TblName = 'RptKitProduct'

SET @TblStruct ='KitPrdId 		 INT,
				KitPrdName		 NVARCHAR(200),
				PrdComponentCode 	 NVARCHAR(200),
				ProductComponentName	 NVARCHAR(200),
				Batch			 NVARCHAR(100), 
				Qty			 INT,
                Status			 INT'
----------------------- TTill Here -------------
SET @TblFields = 'KitPrdId,KitPrdName,PrdComponentCode,ProductComponentName,Batch,Qty,Status'

IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
	INSERT INTO #RptKitProduct(KitPrdId,KitPrdName,PrdComponentCode,ProductComponentName,Batch,Qty,Status)
	SELECT DISTINCT * from View_KitProduct
	WHERE 	(KitPrdId = (CASE @PrdId WHEN 0 THEN KitPrdId ELSE 0 END) OR
 		             KitPrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		AND 
		(Status = (CASE @Status WHEN 0 THEN Status ELSE 4 END) OR
 		             Status in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,182,@Pi_UsrId)))



	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptKitProduct ' +
			'(' + @TblFields + ')' +

			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE RptId=' + CAST(@Pi_RptId AS nVarchar(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + '' 
			+ 'AND (KitPrdId = (CASE ' + CAST(@PrdId AS nVarchar(10)) + ' WHEN 0 THEN KitPrdId ELSE 0 END) OR '
			+ 'PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',5,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (Status = (CASE ' + CAST(@Status AS nVarchar(10)) + ' WHEN 0 THEN Status ELSE 4 END) OR '
			+ 'Status in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',182,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			 

		EXEC (@SSQL)
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptKitProduct'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	    END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
PRINT @Pi_DbName
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	PRINT @ErrNo
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptKitProduct ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
PRINT @SSQL
		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	   END
END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptKitProduct
PRINT 'Data Executed'
SELECT * FROM #RptKitProduct
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_GR_StockLedger]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_GR_StockLedger]
GO
--EXEC Proc_GR_StockLedger 8,'2018-08-01','2018-08-07','','','','','',''
CREATE PROCEDURE [dbo].[Proc_GR_StockLedger]
(
	@Pi_RptName		NVARCHAR(100),
	@Pi_FromDate	DATETIME,
	@Pi_ToDate		DATETIME,
	@Pi_Filter1		NVARCHAR(100),
	@Pi_Filter2		NVARCHAR(100),
	@Pi_Filter3		NVARCHAR(100),
	@Pi_Filter4		NVARCHAR(100),
	@Pi_Filter5		NVARCHAR(100),
	@Pi_Filter6		NVARCHAR(100)
)
AS 
/************************************************  
* PROCEDURE  : Proc_Cs2Cn_DebitNoteTopSheet2   
* PURPOSE  : To Extract LMISDetails  
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :   
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*************************************************  
* [DATE]		[DEVELOPER]        [USER_STORY_ID]   [CR/BUG]       [DESCRIPTION]  
* 07-08-2018	Lakshman M         ILCRSTPAR1669       BZ          for this report group by class Transdate & location id validation included from Core stocky
*************************************************/  
BEGIN
		SET @Pi_FILTER1='%'+ISNULL(@Pi_FILTER1,'')+'%'        
		SET @Pi_FILTER2='%'+ISNULL(@Pi_FILTER2,'')+'%'        
		SET @Pi_FILTER3='%'+ISNULL(@Pi_FILTER3,'')+'%'        
		SET @Pi_FILTER4='%'+ISNULL(@Pi_FILTER4,'')+'%'        
		SET @Pi_FILTER5='%'+ISNULL(@Pi_FILTER5,'')+'%'  
		SET @Pi_FILTER6='%'+ISNULL(@Pi_FILTER6,'')+'%'   
	CREATE TABLE #OpenClose 
		(
			TransDate DATETIME,
			PrdId INT,
			PrdBatId INT,
			LcnId INT,
			SalOpenStock NUMERIC(38,0),
			UnSalOpenStock NUMERIC(38,0),
			OfferOpenStock NUMERIC(38,0),
			SalClsStock NUMERIC(38,0),
			UnSalClsStock NUMERIC(38,0),
			OfferClsStock NUMERIC(38,0)
		)
	CREATE TABLE #TempRptStockNSales
	(
		TransDate datetime,
		LcnId int,
		LcnName nvarchar(100),
		PrdId INT,
		PrdDCode nvarchar(100),
		PrdName nvarchar(200),
		PrdBatId INT,
		PrdBatCode nvarchar(100),
		Opening NUMERIC(18,2),
		Purchase NUMERIC(18,2),
		Sales NUMERIC(18,2),
		AdjustmentIn NUMERIC(18,2),
		AdjustmentOut NUMERIC(18,2),
		PurchaseReturn NUMERIC(18,2),
		SalesReturn NUMERIC(18,2),
		Closing NUMERIC(18,2),
		PurchaseRate NUMERIC(18,2),
		OpnPurRte NUMERIC(18,2),
		PurPurRte NUMERIC(18,2),
		SalPurRte NUMERIC(18,2),
		AdjInPurRte NUMERIC(18,2),
		AdjOutPurRte NUMERIC(18,2),
		PurRetPurRte NUMERIC(18,2),
		SalRetPurRte NUMERIC(18,2),
		CloPurRte NUMERIC(18,2),
		SellingRate NUMERIC(18,2),
		OpnSelRte NUMERIC(18,2),
		PurSelRte NUMERIC(18,2),
		SalSelRte NUMERIC(18,2),
		AdjInSelRte NUMERIC(18,2),
		AdjOutSelRte NUMERIC(18,2),
		PurRetSelRte NUMERIC(18,2),
		SalRetSelRte NUMERIC(18,2),
		CloSelRte NUMERIC(18,2),
		MRP NUMERIC(18,2),
		OpnMRPRte NUMERIC(18,2),
		PurMRPRte NUMERIC(18,2),
		SalMRPRte NUMERIC(18,2),
		AdjInMRPRte NUMERIC(18,2),
		AdjOutMRPRte NUMERIC(18,2),
		PurRetMRPRte NUMERIC(18,2),
		SalRetMRPRte NUMERIC(18,2),
		CloMRPRte NUMERIC(18,2),
		BatchSeqId NUMERIC(18,2),
		PrdCtgValLinkCode nvarchar(1000),
		CmpId INT,
		PrdStatus INT,
		BatStatus INT,
		UserId INT,
		TotalStock NUMERIC(18,2)

	)
/*
Botreetesting '2010-01-01','2010-01-31'
*/
	CREATE TABLE #TEMPDATE(TransDate DATETIME,PrdId INT,PrdBatId INT,LcnId INT)
	
	INSERT INTO #TEMPDATE
	(
		TransDate,
		PrdId,
		PrdBatId,
		LcnId
	)
	SELECT MAX(Sl.TransDate),Sl.PrdId,Sl.PrdBatId,Sl.LcnId
	FROM Stockledger Sl (Nolock) 
	WHERE	TransDate<=@Pi_ToDate 
	GROUP BY PrdId,PrdBatid,LcnId
	
	INSERT INTO #OpenClose
		(
			TransDate ,
			PrdId ,
			PrdBatId ,
			LcnId ,
			SalOpenStock ,
			UnSalOpenStock ,
			OfferOpenStock ,
			SalClsStock ,
			UnSalClsStock,
			OfferClsStock
		)
	SELECT  Stk.TransDate,Stk.LcnId,Stk.PrdId,Stk.PrdBatId,
			Stk.SalOpenStock,Stk.UnSalOpenStock,Stk.OfferOpenStock,
			Stk.SalClsStock,Stk.UnSalClsStock,Stk.OfferClsStock
	From 
		  StockLedger Stk (Nolock) ,#TempDate Dte
	WHERE 
		  Stk.TransDate=Dte.TransDate AND Stk.PrdId=Dte.PrdId 
		  AND Stk.PrdBatId=Dte.PrdBatId AND Stk.LcnId=Dte.LcnId

		  
-------Up to this to take max transdate with Closing Date--------
	CREATE TABLE  #ProdDetail 
		(
		LcnId INT,
		PrdBatId INT,
		TransDate DATETIME
		)
	INSERT INTO #ProdDetail
		(
			LcnId,PrdBatId,TransDate
		)
	
	SELECT Stk.LcnId,Stk.PrdBatId,MAX(Stk.TransDate) FROM StockLedger Stk (nolock)
	WHERE Stk.TransDate NOT BETWEEN @Pi_FromDate AND @Pi_ToDate
	 
	AND	Stk.PrdBatId NOT IN (SELECT Stk.PrdBatId FROM StockLedger Stk (nolock)
				WHERE Stk.TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate)
		
	GROUP BY Stk.LcnId,Stk.PrdId,Stk.PrdBatId HAVING MAX(Stk.TransDate)<@Pi_FromDate
	UNION
	SELECT Stk.LcnId,Stk.PrdBatId,MAX(Stk.TransDate)  FROM StockLedger Stk (nolock)
--	SELECT Stk.LcnId,Stk.PrdBatId,MAX(Stk.TransDate) FROM StockLedger Stk (nolock),
--	(
--		SELECT STK.LcnId,Stk.PrdBatId,
--		CAST(Stk.LcnId AS NVARCHAR(1000))+'-'+ CAST(Stk.PrdBatId AS NVARCHAR(10)) AS Col
--		FROM StockLedger Stk (nolock)
--		WHERE Stk.TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
--		GROUP BY Stk.PrdBatId,STK.LcnId
--	) AS A
	WHERE Stk.TransDate NOT BETWEEN @Pi_FromDate AND @Pi_ToDate
	--AND A.Col <>CAST(Stk.LcnId AS NVARCHAR(10))+'-'+CAST(Stk.PrdBatId AS NVARCHAR(10))

	GROUP BY Stk.LcnId,Stk.PrdId,Stk.PrdBatId HAVING MAX(Stk.TransDate)>=@Pi_FromDate
			
	------- Stocks for the given Date  ---------
TRUNCATE TABLE #TempRptStockNSales
INSERT INTO #TempRptStockNSales
	(
		TransDate,LcnId,LcnName,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,
		Opening,Purchase,Sales,AdjustmentIn,AdjustmentOut,PurchaseReturn,SalesReturn,Closing,
		PurchaseRate,OpnPurRte,PurPurRte,SalPurRte,AdjInPurRte,AdjOutPurRte,PurRetPurRte,SalRetPurRte,
		CloPurRte,SellingRate,OpnSelRte,PurSelRte,SalSelRte,AdjInSelRte,AdjOutSelRte,
		PurRetSelRte,SalRetSelRte,CloSelRte,MRP,
		OpnMRPRte,PurMRPRte,SalMRPRte,AdjInMRPRte,AdjOutMRPRte,
		PurRetMRPRte,SalRetMRPRte,CloMRPRte,
		BatchSeqId,PrdCtgValLinkCode,CmpId,PrdStatus,BatStatus,UserId,TotalStock
	)	
	
	SELECT 
		'' AS TransDate,Sl.LcnId AS LcnId,
		Lcn.LcnName,Sl.PrdId,Prd.PrdDCode,Prd.PrdName,Sl.PrdBatId,PrdBat.PrdBatCode,
		0 AS Opening,
		(SUM(Sl.SalPurchase)+SUM(Sl.UnsalPurchase))AS Purchase ,
		(SUM(Sl.SalSales)+SUM(Sl.UnSalSales))AS Sales,
		(SUM(Sl.SalStockIn)+SUM(Sl.UnSalStockIn)+SUM(Sl.DamageIn)+SUM(Sl.SalStkJurIn)
		+SUM(Sl.UnSalStkJurIn)+SUM(Sl.SalBatTfrIn)+SUM(Sl.UnSalBatTfrIn)+
		SUM(Sl.SalLcnTfrIn)+SUM(Sl.UnSalLcnTfrIn)) AS AdjustmentIn,
		(SUM(Sl.SalStockOut)+SUM(Sl.UnSalStockOut)+SUM(Sl.DamageOut)+SUM(Sl.SalStkJurOut)
		+SUM(Sl.UnSalStkJurOut)+SUM(Sl.SalBatTfrOut)+SUM(Sl.UnSalBatTfrOut)
		+SUM(Sl.SalLcnTfrOut)+SUM(Sl.UnSalLcnTfrOut)
		+SUM(Sl.SalReplacement)) AS AdjustmentOut,
		(SUM(Sl.SalPurReturn)+SUM(Sl.UnSalPurReturn)) as PurchaseReturn,
		(SUM(Sl.SalSalesReturn)+SUM(Sl.UnSalSalesReturn)) as SalesReturn,	
		(SUM(Sl.SalClsStock)+SUM(Sl.UnSalClsStock)) AS Closing,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		PrdBat.BatchSeqId,PCV.PrdCtgValLinkCode,Prd.CmpId,
		Prd.PrdStatus,PrdBat.Status,0,0
	FROM
		Product Prd (NOLOCK),ProductCategoryValue PCV (NOLOCK),
		ProductBatch PrdBat (NOLOCK),StockLedger Sl (NOLOCK),Location Lcn (NOLOCK)
	WHERE 
		Sl.PrdId = Prd.PrdId AND
		Sl.TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate AND
		PrdBat.PrdBatId = Sl.PrdBatId AND
		Lcn.LcnId = Sl.LcnId AND	
		Prd.PrdCtgValMainId=PCV.PrdCtgValMainId
	GROUP BY Sl.LcnId,Lcn.LcnName,Sl.PrdId,Prd.PrdDCode,Prd.PrdName,
			 Sl.PrdBatId,PrdBat.PrdBatCode,PCV.PrdCtgValLinkCode,Prd.CmpId,
			 Prd.PrdStatus,PrdBat.Status,PrdBat.BatchSeqId,Sl.TransDate,Lcn.LcnId ----- Add by lakshman M dated On 07/08/2018 PMS ID: ILCRSTPAR1669 
	ORDER BY Sl.TransDate,Sl.PrdId,Sl.PrdBatId,Lcn.LcnId
	
	UPDATE #TempRptStockNSales  SET Closing=(OpCl.SalClsStock+OpCl.UnSalClsStock+OpCl.OfferClsStock)
	FROM #OpenClose OpCl
	WHERE #TempRptStockNSales.PrdId=OpCl.PrdId AND #TempRptStockNSales.PrdBatId=OpCl.PrdBatId 
		  AND #TempRptStockNSales.LcnId=OpCl.LcnId
		  
--- To get Opening Stock---------
	truncate table #TempDate
	truncate table #OpenClose
	INSERT INTO #TempDate
	(
		TransDate,
		PrdId,
		PrdBatId,
		LcnId
	)
	SELECT MAX(Sl.TransDate),Sl.PrdId,Sl.PrdBatId,Sl.LcnId
	FROM Stockledger Sl 
	WHERE	TransDate<=@Pi_FromDate
	GROUP BY PrdId,PrdBatid,LcnId
	Declare @count int			

	SET	@Count=0	
	SELECT @Count=COUNT(*) FROM #TempDate
	IF @Count=0
	BEGIN
		INSERT INTO #TempDate
		(
			TransDate,
			PrdId,
			PrdBatId,
			LcnId
		)
		SELECT MIN(Sl.TransDate),Sl.PrdId,Sl.PrdBatId,Sl.LcnId
		FROM Stockledger Sl 
		WHERE TransDate<=@Pi_ToDate
			
		GROUP BY PrdId,PrdBatid,LcnId
	END
	INSERT INTO #OpenClose
		(
			TransDate ,
			PrdId ,
			PrdBatId ,
			LcnId ,
			SalOpenStock ,
			UnSalOpenStock ,
			OfferOpenStock ,
			SalClsStock ,
			UnSalClsStock,
			OfferClsStock
		)
	SELECT 
		Stk.TransDate,Stk.PrdId,Stk.PrdBatId,Stk.LcnId,
		Stk.SalOpenStock,Stk.UnSalOpenStock,Stk.OfferOpenStock,
		Stk.SalClsStock,Stk.UnSalClsStock,Stk.OfferClsStock
	FROM 
		StockLedger Stk,#TempDate Dte
	WHERE 
		Stk.TransDate=Dte.TransDate AND Stk.PrdId=Dte.PrdId 
		AND Stk.PrdBatId=Dte.PrdBatId AND Stk.LcnId=Dte.LcnId
		
	UPDATE #TempRptStockNSales  SET Opening=(OpCl.SalOpenStock+OpCl.UnSalOpenStock+OpCl.OfferOpenStock)
	FROM #OpenClose OpCl
	WHERE #TempRptStockNSales.PrdId=OpCl.PrdId AND #TempRptStockNSales.PrdBatId=OpCl.PrdBatId 
		  AND #TempRptStockNSales.LcnId=OpCl.LcnId
INSERT INTO #TempRptStockNSales
	(
		TransDate,LcnId,LcnName,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,Opening,
		Purchase,Sales,AdjustmentIn,AdjustmentOut,SalesReturn,PurchaseReturn,Closing,
		PurchaseRate,OpnPurRte,PurPurRte,SalPurRte,AdjInPurRte,AdjOutPurRte,SalRetPurRte,PurRetPurRte,CloPurRte,
		SellingRate,OpnSelRte,PurSelRte,SalSelRte,AdjInSelRte,AdjOutSelRte,SalRetSelRte,PurRetSelRte,CloSelRte,
		MRP,OpnMRPRte,PurMRPRte,SalMRPRte,AdjInMRPRte,AdjOutMRPRte,SalRetMRPRte,PurRetMRPRte,CloMRPRte,
		BatchSeqId,PrdCtgValLinkCode,CmpId,PrdStatus,BatStatus,UserId,TotalStock
	)			
	SELECT 
		PrdDet.TransDate AS TransDate,ISNULL(Sl.LcnId,0) AS LcnId,
		IsNull(Lcn.LcnName,'')AS LcnName,ISNULL(Sl.PrdId,Prd.PrdId)AS PrdId,
		ISNULL(Prd.PrdDCode,'') AS PrdDCode,
		ISNULL(Prd.PrdName,'') AS PrdName,ISNULL(Sl.PrdBatId,0) AS PrdBatId,
		ISNULL(PrdBat.PrdBatCode,'') AS PrdBatCode,
		(ISNULL(Sl.SalClsStock,0)+ISNULL(Sl.UnSalClsStock,0)) AS Opening,
		0 AS Purchase,0 AS Sales,0 AS AdjustmentIn,0 as AdjustmentOut,
		0 as SalesReturn,0 as PurchaseReturn,
		(ISNULL(Sl.SalClsStock,0)+ISNULL(Sl.UnSalClsStock,0)) AS Closing,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		PrdBat.BatchSeqId,PCV.PrdCtgValLinkCode,Prd.CmpId,Prd.PrdStatus,PrdBat.Status,0,0
	FROM
			Product Prd (NOLOCK),ProductCategoryValue PCV (NOLOCK),
			ProductBatch PrdBat (NOLOCK),#ProdDetail PrdDet,StockLedger Sl (NOLOCK)
			---LEFT OUTER JOIN Location Lcn (NOLOCK) ON Sl.LcnId=Lcn.LcnId	
			INNER JOIN Location Lcn (NOLOCK) ON Sl.LcnId=Lcn.LcnId	
	WHERE
			Sl.PrdBatId=PrdDet.PrdBatId AND Sl.TransDate=PrdDet.TransDate	
			AND Sl.TransDate< @Pi_FromDate
			AND Sl.PrdId=Prd.PrdId And Sl.PrdBatId=PrdBat.PrdBatId AND Prd.PrdId=PrdBat.PrdId
			AND Prd.PrdCtgValMainId=PCV.PrdCtgValMainId AND PrdDet.LcnId=Sl.LcnId
			
		INSERT INTO #TempRptStockNSales
	(
		TransDate,LcnId,LcnName,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,Opening,
		Purchase,Sales,Adjustmentin,AdjustmentOut,SalesReturn,PurchaseReturn,Closing,
		PurchaseRate,OpnPurRte,PurPurRte,SalPurRte,AdjInPurRte,AdjOutPurRte,SalRetPurRte,PurRetPurRte,CloPurRte,
		SellingRate,OpnSelRte,PurSelRte,SalSelRte,AdjInSelRte,AdjOutSelRte,SalRetSelRte,PurRetSelRte,CloSelRte,
		MRP,OpnMRPRte,PurMRPRte,SalMRPRte,AdjInMRPRte,AdjOutMRPRte,SalRetMRPRte,PurRetMRPRte,CloMRPRte,
		BatchSeqId,PrdCtgValLinkCode,CmpId,PrdStatus,BatStatus,UserId,TotalStock
	)			
	SELECT 
		@Pi_FromDate AS TransDate,Lcn.LcnId,
		Lcn.LcnName,Prd.PrdId,Prd.PrdDCode,Prd.PrdName,PrdBat.PrdBatId,
		PrdBat.PrdBatCode,0 AS Opening,0 AS Purchase,0 AS Sales,0 AS AdjustmentIn,0 as AdjustmentOut,
		0 AS PurchaseReturn,0 AS SalesReturn,0 AS Closing,
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		PrdBat.BatchSeqId,PCV.PrdCtgValLinkCode,Prd.CmpId,Prd.PrdStatus,PrdBat.Status,0,0
	FROM
	ProductBatch PrdBat (NOLOCK),ProductCategoryValue PCV (NOLOCK),Product Prd (NOLOCK)
	CROSS JOIN Location Lcn (NOLOCK)
	WHERE
		PrdBat.PrdBatId IN
		(
			SELECT PrdBatId FROM (
			SELECT DISTINCT A.PrdBatId,B.PrdBatId AS NewPrdBatId FROM
			ProductBatch A (NOLOCK) LEFT OUTER JOIN StockLedger B (NOLOCK)
			ON A.PrdId =B.PrdId ) a
			WHERE ISNULL(NewPrdBatId,0) = 0
		)
	AND PrdBat.PrdId=Prd.PrdId
	AND Prd.PrdCtgValMainId=PCV.PrdCtgValMainId
	GROUP BY Prd.PrdId,PrdBat.PrdBatId,Lcn.LcnId,Lcn.LcnName,Prd.PrdId,Prd.PrdDCode,
			 Prd.PrdName,PrdBat.PrdBatId,PrdBat.PrdBatCode,PCV.PrdCtgValLinkCode,Prd.CmpId,
			 Prd.PrdStatus,PrdBat.Status,PrdBat.BatchSeqId
	ORDER BY TransDate,Prd.PrdId,PrdBat.PrdBatId,Lcn.LcnId
	
	UPDATE #TempRptStockNSales SET Closing=(Opening+Purchase-Sales+AdjustmentIn-AdjustmentOut+SalesReturn-PurchaseReturn)

	UPDATE #TempRptStockNSales SET TotalStock=Closing

	UPDATE #TempRptStockNSales SET #TempRptStockNSales.SellingRate=PrdBatDet.PrdBatDetailValue
		FROM #TempRptStockNSales,ProductBatchDetails PrdBatDet,ProductBatch PrdBat,
		BatchCreation BatCr,Product Prd
		WHERE #TempRptStockNSales.PrdBatId=PrdBatDet.PrdBatId AND PrdBatDet.SlNo=BatCr.SlNo
		AND PrdBat.DefaultPriceId=PrdBatDet.PriceId
		AND BatCr.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND #TempRptStockNSales.PrdId=PrdBat.PrdId
		AND PrdBat.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND PrdBat.PrdId=#TempRptStockNSales.PrdID
		AND PrdBat.PrdId=Prd.PrdID
		AND BatCr.SelRte=1

	UPDATE #TempRptStockNSales SET #TempRptStockNSales.PurchaseRate=PrdBatDet.PrdBatDetailValue
		FROM #TempRptStockNSales,ProductBatchDetails PrdBatDet,ProductBatch PrdBat,
		BatchCreation BatCr,Product Prd
		WHERE #TempRptStockNSales.PrdBatId=PrdBatDet.PrdBatId AND PrdBatDet.SlNo=BatCr.SlNo
		AND PrdBat.DefaultPriceId=PrdBatDet.PriceId
		AND BatCr.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND #TempRptStockNSales.PrdId=PrdBat.PrdId
		AND PrdBat.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND PrdBat.PrdId=#TempRptStockNSales.PrdID
		AND PrdBat.PrdId=Prd.PrdID
		AND BatCr.ListPrice=1

		UPDATE #TempRptStockNSales SET #TempRptStockNSales.MRP=PrdBatDet.PrdBatDetailValue
		FROM #TempRptStockNSales,ProductBatchDetails PrdBatDet,ProductBatch PrdBat,
		BatchCreation BatCr,Product Prd
		WHERE #TempRptStockNSales.PrdBatId=PrdBatDet.PrdBatId AND PrdBatDet.SlNo=BatCr.SlNo
		AND PrdBat.DefaultPriceId=PrdBatDet.PriceId
		AND BatCr.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND #TempRptStockNSales.PrdId=PrdBat.PrdId
		AND PrdBat.BatchSeqId=#TempRptStockNSales.BatchSeqId
		AND PrdBat.PrdId=#TempRptStockNSales.PrdID
		AND PrdBat.PrdId=Prd.PrdID
		AND BatCr.MRP=1

	UPDATE #TempRptStockNSales SET OpnPurRte=Opening * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)) ,
		PurPurRte=Purchase * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		SalPurRte=Sales * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		AdjInPurRte=AdjustmentIn * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		AdjOutPurRte=AdjustmentOut * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		SalRetPurRte=SalesReturn * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		PurRetPurRte=PurchaseReturn * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		CloPurRte=Closing * (PurchaseRate+ISNULL(PurchaseTaxAmount,0)),
		OpnSelRte=Opening * (SellingRate+ISNULL(SellingTaxAmount,0)),
		PurSelRte=Purchase * (SellingRate+ISNULL(SellingTaxAmount,0)),
		SalSelRte=Sales * (SellingRate+ISNULL(SellingTaxAmount,0)),
		AdjInSelRte=AdjustmentIn * (SellingRate+ISNULL(SellingTaxAmount,0)),
		AdjOutSelRte=AdjustmentOut * (SellingRate+ISNULL(SellingTaxAmount,0)),
		SalRetSelRte=SalesReturn * (SellingRate+ISNULL(SellingTaxAmount,0)),
		PurRetSelRte=PurchaseReturn * (SellingRate+ISNULL(SellingTaxAmount,0)),
		CloSelRte=Closing * (SellingRate+ISNULL(SellingTaxAmount,0)),
		OpnMRPRte=Opening * MRP,PurMRPRte=Purchase * MRP,SalMRPRte=Sales * MRP,
		AdjInMRPRte=AdjustmentIn * MRP,AdjOutMRPRte=AdjustmentOut * MRP,
		SalRetMRPRte=SalesReturn * MRP,PurRetMRPRte=PurchaseReturn * MRP,
		CloMRPRte=Closing * MRP
	From  #TempRptStockNSales LEFT OUTER JOIN 
		  TaxForReport Tax ( NOLOCK) ON  
		  #TempRptStockNSales.PrdId = Tax.PrdId and #TempRptStockNSales.PrdBatid = Tax.PrdBatid
		
   SELECT A.* INTO #TEMPRPTSTOCKNSALESREPORT FROM #TempRptStockNSales A, TBL_GR_BUILD_PH B WHERE 
	PRDDCODE+':'+PrdName LIKE @PI_FILTER1 
	AND LCNNAME LIKE @PI_fILTER2 
	AND A.PRDID = B.PRDID 
	AND HASHPRODUCTS LIKE @PI_FILTER3 and (Opening+Purchase+Sales+AdjustmentIn+AdjustmentOut+SalesReturn+PurchaseReturn)>0
	SELECT ' Stock and Sales Volume',LCNNAME [Location Name],Prddcode [Dist. Product Code],PrdName [Product Name],PrdBatCode [Batch Code],cast(Opening as int)Opening,
			Cast(Purchase as Int) Purchase,Cast(Sales as Int) Sales,Cast(AdjustmentIn as int)AdjustmentIn,Cast(AdjustmentOut as int) AdjustmentOut,
			Cast(PurchaseReturn as int)PurchaseReturn,cast(SalesREturn as int)SalesReturn,Cast(Closing as int)Closing from #TEMPRPTSTOCKNSALESREPORT  
   UNION
	SELECT ' Stock and Sales Volume',' Totals','','','',cast(sum(Opening) as int)Opening,
			Cast(sum(Purchase) as Int) Purchase,Cast(sum(Sales) as Int) Sales,Cast(sum(AdjustmentIn) as int)AdjustmentIn,Cast(sum(AdjustmentOut) as int) AdjustmentOut,
			Cast(sum(PurchaseReturn) as int)PurchaseReturn,cast(sum(SalesREturn) as int)SalesReturn,Cast(sum(Closing) as int)Closing from #TEMPRPTSTOCKNSALESREPORT  order by LcnName,PRddcode

	SELECT 'Stock and Sales Purchase Rate',LCNNAME [Location Name],Prddcode [Dist. Product Code],PrdName [Product Name],PrdBatCode [Batch Code],OpnPurRte Opening,
			PurPurRte Purchase,
			SalPurRte Sales,
			AdjInPurRte [Adjustment In],
			AdjOutPurRte [Adjustment Out],
			PurRetPurRte [Purchase Return],
			SalRetPurRte [Sales Return],
			CloPurRte Closing
			from #TEMPRPTSTOCKNSALESREPORT  
UNION
	Select ' Stock and Sales Purchase Rate',' Totals','','','',cast(sum(OpnPurRte) as int)Opening,
			Cast(sum(PurPurRte) as Int) Purchase,Cast(sum(SalPurRte) as Int) Sales,Cast(sum(AdjInPurRte) as int)AdjustmentIn,Cast(sum(AdjOutPurRte) as int) AdjustmentOut,
			Cast(sum(PurRetPurRte) as int)PurchaseReturn,cast(sum(SalRetPurRte) as int)SalesReturn,Cast(sum(CloPurRte) as int)Closing from #TEMPRPTSTOCKNSALESREPORT  order by LcnName,PRddcode

	Select 'Stock and Sales Selling Rate ',LCNNAME [Location Name],Prddcode [Dist. Product Code],PrdName [Product Name],PrdBatCode [Batch Code],OpnSelRte Opening,
			PurSelRte Purchase,
			SalSelRte Sales,
			AdjInSelRte [Adjustment In],
			AdjOutSelRte [Adjustment Out],
			PurRetSelRte [Purchase Return],
			SalRetSelRte [Sales Return],
			CloSelRte Closing
			from #TEMPRPTSTOCKNSALESREPORT  
union
	Select ' Stock and Sales Selling Rate',' Totals','','','',cast(sum(OpnSelRte) as int)Opening,
			Cast(sum(PurSelRte) as Int) Purchase,Cast(sum(SalSelRte) as Int) Sales,Cast(sum(AdjInSelRte) as int)AdjustmentIn,Cast(sum(AdjOutSelRte) as int) AdjustmentOut,
			Cast(sum(PurRetSelRte) as int)PurchaseReturn,cast(sum(SalRetSelRte) as int)SalesReturn,Cast(sum(CloSelRte) as int)Closing from #TEMPRPTSTOCKNSALESREPORT  order by LcnName,PRddcode

	Select 'Stock and Sales MRP ',LCNNAME [Location Name],Prddcode [Dist. Product Code],PrdName [Product Name],PrdBatCode [Batch Code],OpnMRPRte Opening,
			PurMRPRte Purchase,
			SalMRPRte Sales,
			AdjInMRPRte [Adjustment In],
			AdjOutMRPRte [Adjustment Out],
			PurRetMRPRte [Purchase Return],
			SalRetMRPRte [Sales Return],
			CloMRPRte Closing
			from #TEMPRPTSTOCKNSALESREPORT  	
union
Select ' Stock and Sales MRP',' Totals','','','',cast(sum(OpnMRPRte) as int)Opening,
			Cast(sum(PurMRPRte) as Int) Purchase,Cast(sum(SalMRPRte) as Int) Sales,Cast(sum(AdjInMRPRte) as int)AdjustmentIn,Cast(sum(AdjOutMRPRte) as int) AdjustmentOut,
			Cast(sum(PurRetMRPRte) as int)PurchaseReturn,cast(sum(SalRetMRPRte) as int)SalesReturn,Cast(sum(CloMRPRte) as int)Closing from #TEMPRPTSTOCKNSALESREPORT  order by LcnName,PRddcode
/*
Botreetesting '2010-01-01','2010-01-31'
*/
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptBillWisePrdWiseOutPut]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptBillWisePrdWiseOutPut]
GO
-- EXEC [Proc_RptBillWisePrdWiseOutPut] 183,2,0,'',0,0,1
CREATE PROCEDURE [dbo].[Proc_RptBillWisePrdWiseOutPut]
	(
		@Pi_RptId  INT,
		@Pi_UsrId  INT,
		@Pi_SnapId  INT,
		@Pi_DbName  nvarchar(50),
		@Pi_SnapRequired INT,
		@Pi_GetFromSnap  INT,
		@Pi_CurrencyId  INT
	)
	AS
/************************************************************
* PROCEDURE : [Proc_RptBillWisePrdWiseOutPut]
* PURPOSE : To get the Product details
* CREATED BY : Murugan.R
* CREATED DATE : 30/09/2009
* NOTE  :
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*************************************************  
* [DATE]		[DEVELOPER]        [USER_STORY_ID]   [CR/BUG]       [DESCRIPTION]  
* 09-08-2018	Lakshman M         ILCRSTPAR1674       BZ          Excel reprot header tax perc & tax amount column hide tax amount validation added in report. 
*************************************************************/
BEGIN
	SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  NVARCHAR(50)
	DECLARE @TblName  AS NVARCHAR(500)
	DECLARE @TblStruct  AS NVARCHAR(4000)
	DECLARE @TblFields  AS NVARCHAR(4000)
	DECLARE @sSql  AS  NVARCHAR(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS NVARCHAR(50)
	DECLARE @FromDate AS DATETIME
	DECLARE @ToDate   AS DATETIME
	DECLARE @CmpId   AS INT
	DECLARE @LcnId   AS INT
	DECLARE @SMId   AS INT
	DECLARE @RMId   AS INT
	DECLARE @RtrId   AS INT
	DECLARE @PrdCatId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @PrdId  AS INT
	DECLARE @SalId   AS BIGINT
	DECLARE @CancelValue AS INT
	DECLARE @BillStatus AS INT
	DECLARE @TaxBreakup AS INT	
	DECLARE @DiscBreakup AS INT
	DECLARE @QtyBreakup AS INT	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	SET @PrdBatId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	SET @TaxBreakup = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,241,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	CREATE TABLE #RptWithOutTaxBreakup
		(
			SalInvDate datetime,
			SalinvNo Varchar(50),
			RouteName Varchar(75),		
			RtrCode Varchar(50),
			RtrName VarChar(200),			
			Prdccode Varchar(50),
			PrdName Varchar(200),
			PrdBatCode Varchar(75),
			Rate Numeric(36,4),
			SalesQty Int,
			FreeQty Int,
			TotQty Int,
			GrossAmt Numeric(36,4),
			SchemeAmt Numeric(36,4),
			SplDiscount Numeric(36,4),
			CashDiscount Numeric(36,4),
			TotalDiscount Numeric(36,4),
			TaxPerc NVARCHAR(200),		
			TaxAmount Numeric(36,4),				
			TotalTax Numeric(36,4),
			NetAmount Numeric(36,4),		
			DiscBreakup Int,
			QtyBreakup  Int,
			TaxBreakup Int
			
		)
		IF @TaxBreakup=2
		BEGIN
			SET @TblName = 'RptBillWisePrdWiseTaxBreakup'
			SET @TblStruct = 'SalInvDate datetime,
			SalinvNo Varchar(50),	
			RouteName Varchar(75),	
			RtrCode Varchar(50),
			RtrName VarChar(200),			
			Prdccode Varchar(50),
			PrdName Varchar(200),
			PrdBatCode Varchar(75),
			Rate Numeric(36,4),
			SalesQty Int,
			FreeQty Int,
			TotQty Int,
			GrossAmt Numeric(36,4),
			SchemeAmt Numeric(36,4),
			SplDiscount Numeric(36,4),
			CashDiscount Numeric(36,4),
			TotalDiscount Numeric(36,4),
			TotalTax Numeric(36,4),
			NetAmount Numeric(36,4),		
			DiscBreakup Int,
			QtyBreakup  Int,
			TaxBreakup Int'
			SET @TblFields = 'SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
			 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
			 SplDiscount,CashDiscount,TotalDiscount,TotalTax,NetAmount,DiscBreakup,QtyBreakup,TaxBreakup'
		END
		IF @Pi_GetFromSnap = 1
		BEGIN
			Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
			SET @DBNAME = @DBNAME
		END
		ELSE
		BEGIN
			Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
			SET @DBNAME = @PI_DBNAME + @DBNAME
		END
		
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
		EXEC Proc_RptBillWisePrdWise 183,2
		--SET @TaxBreakup=2	
		SELECT DISTINCT @DiscBreakup=DiscBreakup FROM RptBillWisePrdWise WHERE UsrId=@Pi_UsrId
		SELECT DISTINCT @QtyBreakup=QtyBreakup FROM RptBillWisePrdWise WHERE UsrId=@Pi_UsrId
		INSERT INTO #RptWithOutTaxBreakup (SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
				 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
				 SplDiscount,CashDiscount,TotalDiscount,TaxPerc,TaxAmount,TotalTax,NetAmount,DiscBreakup,QtyBreakup,TaxBreakup)
			SELECT DISTINCT SalInvDate,SalinvNo,RmName,RtrCode,RtrName,Prdccode,
				PrdName,PrdBatCode, dbo.Fn_ConvertCurrency(Rate,@Pi_CurrencyId),SalesQty,FreeQty,TotQty,
				dbo.Fn_ConvertCurrency(GrossAmt,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(SchemeAmt,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(SplDiscount,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CashDiscount,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(TotalDiscount,@Pi_CurrencyId),
				TaxPerc,
				dbo.Fn_ConvertCurrency(TaxAmount,@Pi_CurrencyId),			
				dbo.Fn_ConvertCurrency(TotalTax,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(NetAmount,@Pi_CurrencyId),DiscBreakup,QtyBreakup,TaxBreakup
		FROM RptBillWisePrdWise
		WHERE  UsrId=@Pi_UsrId
		AND  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR
		CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND
		(LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
		LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
		AND
		(PrdId = (CASE @PrdCatId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
		AND
		(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		AND
		(PrdBatId = (CASE @PrdBatId WHEN 0 THEN PrdBatId Else 0 END) OR
		PrdBatId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId)))
		IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			SET @SSQL = 'INSERT INTO #RptWithOutTaxBreakup ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + ''
			+ 'AND  (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '
			+ 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
			+ 'AND (LcnId = (CASE ' + CAST(@LcnId AS nVarchar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR '
			+ 'LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
			+ 'AND (PrdId = (CASE ' + CAST(@PrdCatId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR '
			+ 'PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (PrdId = (CASE ' + CAST(@PrdId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR '
			+ 'PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',5,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (PrdBatId = (CASE ' + CAST(@PrdBatId AS nVarchar(10)) + ' WHEN 0 THEN PrdBatId Else 0 END) OR '
			+ 'PrdBatId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',7,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptWithOutTaxBreakup'
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptWithOutTaxBreakup ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	IF @TaxBreakup=1
	BEGIN	
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptWithOutTaxBreakup
	END
	IF @TaxBreakup=2
	BEGIN	
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptWithOutTaxBreakup 	
	END
	DELETE FROM RptWithOutTaxBreakup_Excel
	DELETE FROM RptColValues WHERE RptId=@Pi_RptId AND Usrid=@Pi_UsrId	
		
	IF EXISTS (SELECT *	FROM RptDataCount WHERE RptId=183 and RecCount>0)
	BEGIN
	--Excel Report
		DELETE FROM RptExcelHeaders Where RptId=@Pi_RptId
		INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)	
		SELECT @Pi_RptId,ColId ,Name,Name,1,1 FROM SYSCOLUMNS S WHERE Id In (Select Id From SysObjects where Xtype='U' and Name='RptWithOutTaxBreakup_Excel')	
		IF (@DiscBreakup=2 AND @QtyBreakup=2)
		BEGIN	
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(9,10,13,14,15)	and RptId=@Pi_RptId			
		END	
		IF (@DiscBreakup=1  AND @QtyBreakup=2)
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(9,10) and RptId=@Pi_RptId				
		END	
		IF (@DiscBreakup=2  AND @QtyBreakup=1)
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno  In(13,14,15) and RptId=@Pi_RptId
		END
		IF @TaxBreakup = 1
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(18,19) and RptId=@Pi_RptId ------------ Added By Lakshman M Dated On 09/08/2018 PMS ID:ILCRSTPAR1674 Excel header hide the columns in report
		END	
		IF @TaxBreakup = 2
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(18,19) and RptId=@Pi_RptId				
		END
		
		INSERT INTO RptWithOutTaxBreakup_Excel([Bill Date],[Bill No],[Route Name],[Retailer Code],[Retailer Name],[Product Code],[Product Name],
					[Batch Code],[Selling Rate],[Sales Qty],[Offer Qty],[Total Qty],[Gross Amt],[Scheme Amt],[SplDiscount],
					[Cash Discount],[Total Discount],TaxPerc,TaxAmount,[Total Tax Amount],[NetAmount ])
		SELECT SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
			 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
			 SplDiscount,CashDiscount,TotalDiscount,TaxPerc,TaxAmount,TotalTax,NetAmount from #RptWithOutTaxBreakup
		
		SELECT * FROM RptWithOutTaxBreakup_Excel
	--End
		--Grid Report
		
		DELETE FROM SpreadDisplayColumns WHERE MasterId=@Pi_RptId
		INSERT INTO SpreadDisplayColumns
		select @Pi_RptId,
		(select count(*) from RptExcelHeaders where slno <= t.slno and DisplayFlag=1 and RptId=@Pi_RptId),
		FieldName,1,1,1,GetDate(),1,Getdate() from RptExcelHeaders t where RptId=@Pi_RptId and DisplayFlag=1
		order by slno
		
		DECLARE @ColName as Varchar(4000)
		DECLARE @ColName1 as Varchar(4000)
		DECLARE @Gsql as Varchar(8000)
		DECLARE @Colcnt as INT
		SET @ColName=''
		SET @ColName1=''
		SELECT @ColName=@ColName+'['+ColumnName +'],'  FROM SpreadDisplayColumns WHERe MasterId=@Pi_RptId
		SELECT @Colcnt=Count(*) FROM SpreadDisplayColumns S WHERE MasterId=@Pi_RptId
		SET @ColName=SUBSTRING(@ColName,1,Len(@ColName)-1)
		SELECT @ColName1=@ColName1+'['+Name +'],' FROM SYSCOLUMNS S WHERE Id In (Select Id From SysObjects where Xtype='U' and Name='RptColvalues') and ColId<=@Colcnt
		SET @ColName1=SUBSTRING(@ColName1,1,Len(@ColName1)-1)
		SET @Gsql= 'INSERT INTO RptColvalues ( '+@ColName1+',Rptid,Usrid)
		SELECT '+@ColName+ ','+
		CAST(@Pi_RptId AS nVarchar(10))+','+ CAST(@Pi_UsrId AS nVarchar(10)) +'FROM RptWithOutTaxBreakup_Excel Order By [Bill Date],[Bill No]'
		EXEC (@Gsql)
	--END Grid Report
	END
	RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_CalculateSpecialDiscountAftRate]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_CalculateSpecialDiscountAftRate]
GO
--EXEC Proc_CalculateSpecialDiscountAftRate
CREATE PROCEDURE [dbo].[Proc_CalculateSpecialDiscountAftRate]
AS  
/*
--------------------------------------------------------------------------------------------------------------------------------------------------  
* [DATE]      [DEVELOPER]		[USER_STORY_ID]			[CR/BUG]    [DESCRIPTION]
* 22-09-2018   VASANTHARAJ		PMS NO : ILCRSTPAR2104	 BUG		System is considering random  special rate and applying same to Billing Screen
--------------------------------------------------------------------------------------------------------------------------------------------------
*/ 
SET NOCOUNT ON  
BEGIN
     --Added by SAthishkumar Veeramani 2015/04/01
	 DECLARE @SplDiscountToAvoid TABLE
	 (
	   RetCategoryLevel       NVARCHAR(100),
	   RetCatLevelValue       NVARCHAR(100),
	   PrdCategoryLevel       NVARCHAR(100),
	   PrdCategoryLevelValue  NVARCHAR(100)
	 )    
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE (ApplyOn = '' OR ApplyOn IS NULL)
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Apply On','Apply On Should Not be Empty or Null-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE (ApplyOn = '' OR ApplyOn IS NULL)
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) NOT IN ('MRP','SELLINGRATE','PURCHASERATE')
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Apply On','Apply On Should Not be in MRP Or SELLINGRATE Or PURCHASERATE-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) NOT IN ('MRP','SELLINGRATE','PURCHASERATE')
     --Till Here
	 INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND ISNULL([Type],'')=''
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Type','Type Should Not be Empty For Appy On MRP-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND ISNULL([Type],'')=''
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND 
     UPPER(LTRIM(RTRIM(ISNULL([Type],'')))) NOT IN ('MARK DOWN','MARK UP')
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Type','Type Should be Mark Up/Mark Down For Appy On MRP-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND 
     UPPER(LTRIM(RTRIM(ISNULL([Type],'')))) NOT IN ('MARK DOWN','MARK UP')
	 EXEC Proc_GR_Build_PH  
	 TRUNCATE TABLE TempSpecialRateDiscountProduct
	 DELETE FROM Cn2Cs_Prk_SpecialDiscount where DownLoadFlag='Y'
	  -- Added by Vasantharaj on 22/09/2018 , PMS NO : ILCRSTPAR2104
	  SELECT RetCategoryLevel ,RetCatLevelValue,PrdCategoryLevel ,PrdCategoryLevelValue,DiscPer,MAX(CreatedDate) Createddate INTO #Cn2Cs_Prk_SpecialDiscount FROM Cn2Cs_Prk_SpecialDiscount
	  GROUP BY RetCategoryLevel ,RetCatLevelValue,PrdCategoryLevel ,PrdCategoryLevelValue,DiscPer
	  
	  DELETE A FROM  Cn2Cs_Prk_SpecialDiscount A INNER JOIN #Cn2Cs_Prk_SpecialDiscount C ON A.RetCategoryLevel=C.RetCategoryLevel
	  AND A.PrdCategoryLevel=C.PrdCategoryLevel AND A.RetCatLevelValue=C.RetCatLevelValue AND A.PrdCategoryLevelValue=C.PrdCategoryLevelValue
	  AND A.DiscPer=C.DiscPer AND A.CreatedDate<>C.Createddate
	  --Till Here	  
	 INSERT INTO TempSpecialRateDiscountProduct (CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,DiscPer,SpecialSellingRate,EffectiveFromDate,
     	 EffectiveToDate,CreatedDate,ApplyOn,[Type])
	 SELECT DISTINCT A.RetCategoryLevel,A.RetCatLevelValue,'ALL',ProductCode,PrdBatCode,DiscPer,
	 --PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) SplRate,
	 (CASE ApplyOn WHEN 1 THEN 
		 (CASE [Type] WHEN 1 THEN (PrdBatDetailValue*100/(100+DiscPer)) WHEN 2 THEN PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))
			ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))  END)	 
	 ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) END) AS SplRate,	 
	 EffFromDate,EffToDate,CreatedDate,ApplyOn,[Type]	 
	 FROM (  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.COMPANY_Code  
	 WHERE CP.PrdCategoryLevel='COMPANY' and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION   
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type] 
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Category_Code  
	 WHERE CP.PrdCategoryLevel='Category'and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Brand_Code  
	 WHERE CP.PrdCategoryLevel='Brand'and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type] 
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.PriceSlot_Code  
	 WHERE CP.PrdCategoryLevel='PriceSlot'and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)  
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn ,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Flavor_Code  
	 WHERE CP.PrdCategoryLevel='Flavor'and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	 WHERE CP.PrdCategoryLevel='Product'and CP.DownloadFlag='D' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	 WHERE CP.DownloadFlag='D' AND NOT EXISTS (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
	 FROM @SplDiscountToAvoid SA WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue 
	 AND CP.PrdCategoryLevel = SA.PrdCategoryLevel AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue))A  
	 INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId and A.ProductCode=P.PrdCCode  
	 INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId  
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId  
	 INNER JOIN BatchCreation BC (NOLOCK) ON BC.SlNo=PBD.SLNo AND BC.SlNo = A.ApplyOn
	 --INNER JOIN Configuration C (NOLOCK) ON BC.SlNo = ISNULL(CAST(C.ConfigValue AS INT),0)
	 WHERE PBD.DefaultPrice=1 --AND C.ModuleId = 'SPLDISC'
	 
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_PurchaseReceipt]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_PurchaseReceipt]
GO
/*    
BEGIN TRANSACTION    
EXEC Proc_Cn2Cs_PurchaseReceipt 0 
select *from ETLTempPurchaseReceipt --WHERE DownLoadStatus=0
select *from etltemppurchasereceiptproduct where cmpinvno in(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=0)
ROLLBACK TRANSACTION    
*/    
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_PurchaseReceipt]  
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/***********************************************************    
* PROCEDURE : Proc_Cn2Cs_PurchaseReceipt    
* PURPOSE : To Insert the records FROM Console into Temp Tables    
* SCREEN : Console Integration-PurchaseReceipt    
* CREATED BY: Nandakumar R.G On 03-05-2010    
* MODIFIED :    
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-09-2018  Lakshman M	 SR     ILCRSTPAR2251         Purchase backup date validation included from CS As per request 5 days configuration .
04-10-2018  lakshman M   BZ     ILCRSTPAR2285         purchase downloaded status validation added from CS.
***************************************************************************************************/  
SET NOCOUNT ON    
BEGIN    
 -- For Clearing the Prking/Temp Table -----     
 ---------------->  Added by Lakshman M on 29/09/2018  <-------------------
 DECLARE @FROMDATE AS Datetime
 DECLARE @TodayDt AS datetime
 SELECT @FROMDATE = cast(DATEADD(DAY, -5, GETDATE()) AS DATETIME)
 SELECT @FROMDATE=CONVERT(VARCHAR(11), @FROMDATE, 121)
 SELECT @TodayDt= CAST(convert(varchar,getdate()) AS DATETIME)
 SELECT @TodayDt= CONVERT(VARCHAR(11), @TodayDt, 121)
 SELECT * INTO #ETLTempPurchaseReceipt_temp FROM ETLTempPurchaseReceipt WHERE InvDate between CONVERT(VARCHAR(11), @FROMDATE, 121) and CONVERT(VARCHAR(11), @TodayDt, 121)
 UPDATE A SET A.downloadstatus = 0 FROM ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp B ON A.CmpInvNo =B.CmpInvNo
  
 UPDATE A SET A.downloadstatus = 1 from ETLTempPurchaseReceipt A where CmpInvNo in(select CmpInvNo from PurchaseReceipt)   ---> added By Lakshman M PMS ID: ILCRSTPAR2285 

 SELECT * INTO #ETLTempPurchaseReceipt_temp1 FROM ETLTempPurchaseReceipt WHERE InvDate < CONVERT(VARCHAR(11),@FROMDATE, 121)
 Delete A from ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo  
 Delete A from ETLTempPurchaseReceiptproduct A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo 
---------------->  Till Here  <----------------------
 DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in     
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN     
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1    
 DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments WHERE CmpInvNo     
 IN (SELECT CmpInvNo FROM PurchaseReceipt WHERE Status = 1) AND DownloadStatus = 1    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim    
 TRUNCATE TABLE ETL_Prk_PurchaseReceipt    
 TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptCrDbAdjustments    
 --------------------------------------    
 DECLARE @ErrStatus INT    
 DECLARE @BatchNo   NVARCHAR(200)    
 DECLARE @ProductCode  NVARCHAR(100)    
 DECLARE @ListPrice   NUMERIC(38,6)    
 DECLARE @FreeSchemeFlag  NVARCHAR(5)    
 DECLARE @CompInvNo   NVARCHAR(25)    
 DECLARE @UOMCode   NVARCHAR(25)    
 DECLARE @Qty    INT    
 DECLARE @PurchaseDiscount NUMERIC(38,6)    
 DECLARE @VATTaxValue  NUMERIC(38,6)    
 DECLARE @SchemeRefrNo  NVARCHAR(25)    
 DECLARE @SupplierCode  NVARCHAR(30)    
 DECLARE @TransporterCode NVARCHAR(30)    
 DECLARE @POUOM    INT    
 DECLARE @RowId    INT    
 DECLARE @LineLvlAmt   NUMERIC(38,6)    
 DECLARE @QtyInKg   NUMERIC(38,6)    
 DECLARE @ExistCompInvNo  NVARCHAR(25)    
 DECLARE @FreightCharges  NUMERIC(38,6)    
 SET @RowId=1    
 --->Added By Nanda on 17/09/2009    
 IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')    
 AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)    
 BEGIN    
  DROP TABLE InvToAvoid     
 END    
 CREATE TABLE InvToAvoid    
 (    
  CmpInvNo NVARCHAR(50)    
 )    
 IF EXISTS (SELECT DISTINCT CompInvNo,SupplierCode FROM Cn2Cs_Prk_BLPurchaseReceipt  
 WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST'))  
 BEGIN  
  INSERT INTO InvToAvoid (CmpInvNo)  
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
  INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Purchase Receipt','Tax Type','Purchase Tax Type should be VAT or GST '+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
 END  
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Till Here        
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode+'~'+BatchNo    
 NOT IN    
 (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN    
  (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Till Here    
 END    
 --Supplier Credit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
        SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'CreditNoteSupplier','PostedRefNo','Supplier Credit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'      
 END    
 --Supplier Debit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
        SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'DebitNoteSupplier','PostedRefNo','Supplier Debit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'      
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvDate>GETDATE())     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvDate>GETDATE()    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo     
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE CompInvDate>GETDATE()    
 END    
 --Commented and Added By Mohana.S PMS NO: DCRSTKAL0012    
 --IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 --WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))     
 --BEGIN    
 -- INSERT INTO InvToAvoid(CmpInvNo)    
 -- SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 -- INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
 -- SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 --END    
 IF EXISTS (SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
 FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId))    
 BEGIN    
   INSERT INTO InvToAvoid(CmpInvNo)    
   SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
   INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
   SELECT DISTINCT 1,'Purchase Receipt',PRODUCTCODE+'Product UOM','UOMCode:'+UOMCode+' is not available for Invoice:'+CompInvNo     
   FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode  NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
 END     
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK)))     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Supplier','Supplier:'+SupplierCode+' is not available for Invoice:'+CompInvNo    
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
 END     
 --->Till Here    
 -- Eliminated Duplicate records insertion on 02/03/2015  
 SET @ExistCompInvNo=0    
 DECLARE Cur_Purchase CURSOR    
 FOR    
 SELECT DISTINCT ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,    
 ISNULL(FreightCharges,0) AS FreightCharges    
 FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)    
 ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges    
 OPEN Cur_Purchase    
 FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
 @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
 @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges     
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
--  IF @ExistCompInvNo<>@CompInvNo    
--  BEGIN    
--   SET @ExistCompInvNo=@CompInvNo    
--   SET @RowId=2    
--  END    
  --To insert into ETL_Prk_PurchaseReceiptPrdDt    
  IF(@FreeSchemeFlag='0')    
  BEGIN    
   INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],    
   [PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges)    
   VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,    
   @PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)    
--   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
--   VALUES(@CompInvNo,@RowId,'E',@QtyInKg)    
  END    
  --To insert into ETL_Prk_PurchaseReceiptClaim    
  IF(@FreeSchemeFlag='1')    
  BEGIN    
   INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],    
   [Batch Code],[Qty],[Stock Type],[Amount],FreightAmt)    
   VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0,@FreightCharges)    
  END    
--  SET @RowId=@RowId+1    
  FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
  @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
  @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges    
 END    
 CLOSE Cur_Purchase    
 DEALLOCATE Cur_Purchase    
 --To insert into ETL_Prk_PurchaseReceipt    
 SELECT @TransporterCode=TransporterCode FROM Transporter    
 WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter WITH(NOLOCK))    
 IF @TransporterCode=''    
 BEGIN    
  INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter','Transporter not available')    
 END    
 INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],  
 [Invoice Date],[Transporter Code],[NetPayable Amount],[TaxType])  
 SELECT DISTINCT C.CmpCode,SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue,  
 P.TaxType  
 FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P  
 WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)  
 UPDATE A SET [TaxType]='VAT' FROM ETL_Prk_PurchaseReceipt A (NOLOCK)   
 INNER JOIN Cn2Cs_Prk_BLPurchaseReceipt B (NOLOCK) ON B.CompInvNo=A.[Company Invoice No]   
 AND A.[Supplier Code]=B.SupplierCode WHERE ISNULL(A.TaxType,'')=''  
 --Added By Sathishkumar Veeramani 2013/08/13    
 --INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)    
 --SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)    
 --WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 --Added by Sathishkumar Veeramani 2013/11/22    
 INSERT INTO ETL_Prk_PurchaseReceiptCrDbAdjustments([Company Invoice No],[Adjustment Type],[Ref No],[Amount])    
 SELECT DISTINCT CompInvNo,AdjType,RefNo,Amount FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WITH (NOLOCK)    
 WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT    
 IF @ErrStatus =0    
 BEGIN    
  EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT    
  IF @ErrStatus =0    
  BEGIN    
   EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT    
   IF @ErrStatus =0    
   BEGIN    
    EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT    
    IF @ErrStatus =0    
    BEGIN    
       EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT    
       IF @ErrStatus =0    
       BEGIN    
           EXEC Proc_Validate_PurchaseReceiptCrDbAdjustments @Po_ErrNo= @ErrStatus OUTPUT    
           IF @ErrStatus =0    
           BEGIN    
            SET @ErrStatus=@ErrStatus    
        END        
       END        
    END    
   END    
  END    
 END    
 --Proc_Validate_PurchaseReceiptCrDbAdjustments    
 --->Added By Nanda on 17/09/2009    
 DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN    
 (SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)    
 UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'    
 WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)    
 --->Till Here    
 SET @Po_ErrNo= @ErrStatus    
 RETURN    
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptProductWiseSalesTaxGST' AND XTYPE='P')
DROP PROC Proc_RptProductWiseSalesTaxGST
GO
---EXEC Proc_RptProductWiseSalesTaxGST 401,2,0,'',0,0,1
--Select * from RptProductWiseSalesTaxGST
CREATE PROCEDURE [Proc_RptProductWiseSalesTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptProductWiseSalesTaxGST
* PURPOSE	: To get the Tax details
* CREATED	: Murugan.R
* CREATED DATE	: 12/05/2017
* MODIFIED
-------------------------------------------------------------------------------------------------------
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* Date            Name              PMS NO            CR/BUG      Remarks
-------------------------------------------------------------------------------------------------------
*06/10/2018    Deepak Philip      ILCRSTPAR2305        BUG      To show retailer GSTIN no in report.
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptProductWiseSalesTaxGST')
	BEGIN
		DELETE FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[InvDate] DateTime,
			[InvId] [bigint] NULL,
			[RefNo] [varchar](100) NULL,
			[RetailerName] Varchar(150),
			[RetailerCode] Varchar(75),
			[RtrGSTIN] Varchar(20),
			RtrStateCode Varchar(20),
			RtrStateName Varchar(150) ,
			RtrShipAdd Varchar(150),
			RtrShipAdd1 Varchar(150),
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[RtrId] [int] NULL,
			[Prdid] [int] NULL,
			[InvQty] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[LineNetAmount] Numeric(36,6),
			[ReverseCharge] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId])
		SELECT SI.SalInvDate,SI.SalId AS InvId,SI.SalInvNo AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		ISNULL(RS.RtrShipAdd1,'') as RtrShipAdd,ISNULL(RS.RtrShipAdd2,'') as RtrShipAdd1,
		PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,SUM(SIP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,'Sales' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],0 as [ReverseCharge],[UPC] as [UPC],
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId  
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=SIP.PrdId  
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		LEFT OUTER JOIN RetailerShipAdd RS ON RS.RtrId=SI.RtrId and RS.RtrShipId=SI.RtrShipId  
		WHERE SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts >3
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,RtrCode,PrdName,PrdCCode,TC.TaxCode,ISNULL(RS.RtrShipAdd1,''),ISNULL(RS.RtrShipAdd2,''),
		[UPC]
		HAVING Sum(TaxableAmount) >0  
			
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT SI.SalInvDate,SI.SalId AS InvId,SI.SalInvNo AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		ISNULL(RS.RtrShipAdd1,'') as RtrShipAdd,ISNULL(RS.RtrShipAdd2,'') as RtrShipAdd1,		
		PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,SUM(SIP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,SUM(TaxableAmount) as TaxableAmount,  
		'Sales' as IOTaxType,1 as TaxFlag,Sum(SPT.TaxAmount) as TaxPercent,
		SPT.TaxId,SUM(PrdNetAmount) as [LineNetAmount],0 as [ReverseCharge],[UPC] as [UPC],	
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=SIP.PrdId   
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId 
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId
		LEFT OUTER JOIN RetailerShipAdd RS ON RS.RtrId=SI.RtrId and RS.RtrShipId=SI.RtrShipId   
		WHERE SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts >3
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,RtrCode,PrdName,PrdCCode,TC.TaxCode,ISNULL(RS.RtrShipAdd1,''),ISNULL(RS.RtrShipAdd2,''),[UPC]
		HAVING Sum(SPT.TaxAmount+SPT.TaxableAmount) > 0 
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		Select
		Rh.ReturnDate,RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,-1*SUM(RP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,-1 *SUM(TaxableAmt) as TaxableAmount,  
		'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,
		RPT.TaxId,-1 *SUM(PrdNetAmt) as [LineNetAmount],ReverseCharges as [ReverseCharge],[UPC] as [UPC],		
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=RP.PrdId      
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		GROUP BY TaxPerc,RH.ReturnDate,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(TaxableAmt) > 0  
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		Select
		Rh.ReturnDate,RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,-1*SUM(RP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,-1 *SUM(TaxableAmt) as TaxableAmount,  
		'SalesReturn' as IOTaxType,1 as TaxFlag,-1*SUM(RPT.TaxAmt) as TaxPercent,
		RPT.TaxId,-1 *SUM(PrdNetAmt) as [LineNetAmount],ReverseCharges as [ReverseCharge],[UPC] as [UPC],
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=RP.PrdId      
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		GROUP BY RH.ReturnDate,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(RPT.TaxAmt+TaxableAmt) > 0 
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT  Null, 0 as [InvId],'' as [RefNo],'' as [RetailerName] ,'' as [RetailerCode],'' as [HSN Code],'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,'' as [Product Name] ,'' as [Product Code],0 as [RtrId],0 as Prdid,0 as [InvQty],0 as[CmpId],  [TaxPerc] ,0 as [TaxableAmount],'' as [IOTaxType] ,
		100 as [TaxFlag],SUM([TaxPercent]) as [TaxPercent],0 as [TaxId],0 as  LineNetAmount,
		0 as [ReverseCharge],0 as [UPC],
		'ZZZZZZ' as [Group Name],3 as [GroupType],[UsrId]
		FROM #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
			
		
	
		
		UPDATE A SET A.RtrStateCode=SM.StateCode ,A.RtrStateName=SM.StateName ,A.[RtrGSTIN]=RS.GSTTinNo 
		FROM #TmpRptIOTaxSummary A 		
		INNER JOIN SalesInvoice S ON S.SalId=A.[InvId]
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		INNER JOIN StateMaster SM ON SM.StateId=RS.StateId
		WHERE IOTaxType='Sales'
		
			
		
		UPDATE A  SET A.RtrShipAdd=RS.RtrShipAdd1 ,A.RtrShipAdd1=RS.RtrShipAdd2 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  ReturnHeader B ON A.InvId=B.ReturnID
		INNER JOIN SalesInvoice S ON S.SalId=B.Salid
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		WHERE IOTaxType='SalesReturn'
		
		
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		
		--Added by Deepak Philip ILCRSTPAR2305
		UPDATE A SET  A.[RtrGSTIN]=R.[ColumnValue] FROM #TmpRptIOTaxSummary A 
		INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u 
		INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
		INNER JOIN retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   and ColumnName='GSTIN' ) 
		R ON A.[RetailerCode]=R.[rtrcode] WHERE IOTaxType in('SalesReturn','Sales')
		--till here
	
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
		SELECT DISTINCT
		[InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],
		[TaxableAmount],[IOTaxType],[TaxFlag],LineNetAmount,[UsrId],[ReverseCharge]
		INTO #LineLevelGross
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
	
		
		
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)
		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId
	
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxperc)+',0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT RtrStateCode,RtrStateName,[RtrGSTIN],[RetailerCode],[RetailerName],RtrShipAdd,RtrShipAdd1,[IOTaxType],[InvDate],[RefNo],'+
		'[HSN Code],[Product Code],[Product Name],[UPC],[InvQty],[TaxableAmount],'+@ColSelect+'LineNetAmount,[ReverseCharge],[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),RtrStateCode Varchar(20),RtrStateName Varchar(150),[RtrGSTIN] varchar(20),[RetailerCode] Varchar(75),[RetailerName] Varchar(150),'+
		'RtrShipAdd Varchar(150),RtrShipAdd1 Varchar(150),[IOTaxType] [varchar](100) NULL,[InvDate] DateTime,'+
		'[RefNo] [varchar](100) NULL,	[HSN Code] varchar(50),[Product Code] Varchar(75),	[Product Name] Varchar(150),UPC INT,'+		
		'[InvQty] [int] NULL,[TaxableAmount] [numeric](38, 6) NULL,'
	
		SET @Columns1='SELECT RtrStateCode,RtrStateName,[RtrGSTIN],[RetailerCode],[RetailerName],RtrShipAdd,RtrShipAdd1,[IOTaxType],[InvDate],[RefNo],'+
		'[HSN Code],[Product Code],[Product Name] ,UPC,[InvQty],[TaxableAmount],LineNetAmount,ReverseCharge,TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,InvDate,RetailerName,[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptProductWiseSalesTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptProductWiseSalesTaxGST'+
		' CREATE TABLE RptProductWiseSalesTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),ReverseCharge  Numeric(36,2),[Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptProductWiseSalesTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		--PRINT @SQL
		EXEC(@SQL)
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,SUM(TaxableAmount) as TaxableAmount,SUM([ReverseCharge]) as [ReverseCharge]
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount,
		Y.[ReverseCharge]=X.[ReverseCharge]
		FROM RptProductWiseSalesTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,401,'Product Wise Output Tax',1,'RtrStateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',2,'RtrStateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',3,'RtrGSTIN',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',4,'RetailerCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',5,'RetailerName',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',6,'RtrShipAdd',75,1,0,1,1,'Retailer','Shipping','Address',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',7,'RtrShipAdd1',75,1,0,1,1,'Retailer','Shipping','Address2',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',8,'IOTaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',9,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',10,'InvDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',11,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',12,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',13,'HSN Code',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',14,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',15,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',16,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+2,'ReverseCharge',
			18,1,0,2,3,'Reverse','Charge','',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_ReturnExcelReportFilter')
DROP FUNCTION Fn_ReturnExcelReportFilter
GO
--SELECT dbo.Fn_ReturnExcelReportFilter(411) as status
CREATE FUNCTION [Fn_ReturnExcelReportFilter](@RptId AS INT,@RefType AS INT)
RETURNS INT
/************************************************
* FUNCTION  : Fn_ReturnExcelReportFilter
* PURPOSE    : To Return Report id
* CREATED BY : R.Murugan
* CREATED ON : 09/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
09/09/2017	Murugan.R	CR		CCRSTAN0150			Modified New ReportId added 425,426,427,428,429,430
04/12/2017	Murugan.R	CR		CCRSTMTR0086		New Report id Added 443  
22/01/2018	Murugan.R	CR		CCRSTMTR0113		New ReportId 432 E way billing 
*/
AS
BEGIN

DECLARE @ReturnVal AS INT
SET @ReturnVal=0
	
	IF @RefType=0
	BEGIN
		IF @RptId in (268 ,291 ,292,411,413,414,415,416,417,418,419,420,421,422,423,425,426,427,428,429,430,433,432)
		BEGIN
			SET @ReturnVal=1
		END
	END
	ELSE IF @RefType=1
	BEGIN
		IF @RptId in (411,413)
		BEGIN
			SET @ReturnVal=1
		END
		IF @RptId in (424,431)
		BEGIN
			SET @ReturnVal=2
		END				
	END	
RETURN @ReturnVal
END
GO
--Updater Till HEre
UPDATE UtilityProcess SET VersionId = '3.1.0.14' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.14',437
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 437)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(437,'D','2018-12-01',GETDATE(),1,'Core Stocky Service Pack 437')
GO