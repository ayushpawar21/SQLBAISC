--[Stocky HotFix Version]=445
DELETE FROM Versioncontrol WHERE Hotfixid='445'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone)
VALUES('445','3.1.0.22','D','2021-01-28','2021-01-28','2021-01-28',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: 445')
GO
/*
	PARCS202100070	CR	Update the current retailer class when the bill is edited
	PARCS202100071	CR	Current Stock Upload Process
	PARCS202100064	CR	IDT UPLOAD
	PARCS202100057	CR  After target value is achieved no scheme discount should apply. Billing will happen as per normal rate after target value is achieved
	PARCS202100105	CR  Scheme based on product category contribution percentage in the bill amount.
	PARCS202100105	CR  Scheme based on product category contribution percentage in the bill amount.
	CRCRSTPAR0107
	PARCS202100059
	PARCS202100057

*/
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName IN ('ProductCategoryContributionPercentage')
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,selectCount,CreatedDate)
SELECT 112,'ProductCategoryContributionPercentage' ,'Cn2Cs_Prk_SchProductCategoryContriPerc','Proc_Import_SchProductCategoryContriPerc',0,500,Getdate()
GO
DELETE FROM CustomUpDownload WHERE Module IN ('ProductCategoryContributionPercentage') and UpDownload='Download' 
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 301,1,'ProductCategoryContributionPercentage','ProductCategoryContributionPercentage','','Proc_Import_SchProductCategoryContriPerc','Cn2Cs_Prk_SchProductCategoryContriPerc',
'Proc_Cn2Cs_SchProductCategoryContriPerc','Master','Download',1 
GO
DELETE FROM CustomUpDownloadCount WHERE Module IN ('ProductCategoryContributionPercentage') and UpDownload='Download'
INSERT INTO CustomUpDownloadCount(SlNo,SeqNo,Module,Screen,ParkTable,MainTable,KeyField1,KeyField2,KeyField3,
UpDownload,OldMax,OldCount,NewMax,NewCount,DownloadedCount,SelectQuery)
SELECT 247,1,'ProductCategoryContributionPercentage','ProductCategoryContributionPercentage','Cn2Cs_Prk_SchProductCategoryContriPerc','Cn2Cs_Prk_SchProductCategoryContriPerc',
'DownLoadFlag','','','Download',0,0,0,0,0,''
GO
DELETE FROM CustomUpdownload WHERE Module='CurrentStockSnapshot' AND UpDownload ='Upload'
INSERT INTO CustomUpDownload 
SELECT Max(slno)+1,1,'CurrentStockSnapshot','CurrentStockSnapshot','Proc_CS2CN_CurrentStockSnapShot','','CS2CN_Prk_CurrentStockSnapshot','','Transaction','Upload',1
FROM CustomUpdownload Where UPDownload='UPload'
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName = 'CurrentStockSnapshot'
INSERT INTO Tbl_UploadIntegration
SELECT  Max(SequenceNo)+1,'CurrentStockSnapshot','CurrentStockSnapshot','CS2CN_Prk_CurrentStockSnapshot',GETDATE()
FROM Tbl_UploadIntegration WHERE SequenceNo NOT IN (1001,1002)
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CS2CN_Prk_CurrentStockSnapshot]') AND type in (N'U'))
DROP TABLE CS2CN_Prk_CurrentStockSnapshot
GO
CREATE TABLE CS2CN_Prk_CurrentStockSnapshot
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[TransDate] [datetime] NULL,
	[PrdDCode] [nvarchar](200) NULL,
	[PrdCode] [nvarchar](200) NULL,
	[PrdName] [nvarchar](500) NULL,
	[BatchCode] [nvarchar](200) NULL,
	[BatchStatus] [nvarchar](50) NULL,
	[LcnName] [nvarchar](200) NULL,
	[MRP] [numeric](18, 2) NULL,
	[ListPrice] [numeric](18, 2) NULL,
	[SalClsStock] [numeric](18, 0) NULL,
	[UnSalClsStock] [numeric](18, 0) NULL,
	[OfferClsStock] [numeric](18, 0) NULL,
	[SalableStockValue] [numeric](18, 2) NULL,
	[UnSalableStockValue] [numeric](18, 2) NULL,
	[TotalStockValue] [numeric](18, 2) NULL,
	[UploadFlag] [nvarchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
)
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_CS2CN_CurrentStockSnapShot]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_CS2CN_CurrentStockSnapShot
GO
CREATE PROCEDURE Proc_CS2CN_CurrentStockSnapShot
(  
 @Po_ErrNo INT OUTPUT, 
 @ServerDate DATETIME 
)  
AS  
SET NOCOUNT ON  
BEGIN  
/********************************************************************* 
* PROCEDURE : Proc_CS2CN_CurrentStockSnapShot  
* PURPOSE   : Extract Current Stock Details from CoreStocky to Console  
* NOTES     :  
* CREATED   : Mohana S
* PMS NO    : PARCS202100071
* Date		: 17-10-2020
**********************************************************************/
 SET @Po_ErrNo = 0  
 DECLARE @CmpID   AS INTEGER  
 DECLARE @DistCode AS NVARCHAR(50) 
 DECLARE @MaxTransDate AS DATETIME 
 TRUNCATE TABLE CS2CN_Prk_CurrentStockSnapshot  
 SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1   
 SELECT @DistCode = DistributorCode FROM Distributor 
	 	 
		 SELECT P.Prdid,PrdDCode,PrdCCode,PrdName,Prdbatid,PrdBatCode as BatChCode,PriceId,SUM(ListPrice) as ListPrice,SUM(Mrp) as Mrp,
		 BatchStatus
		 INTO  #ProductBatchDetails 
		 FROM (
		 SELECT Prdid,PB.Prdbatid,PrdBatCode,PriceId,PrdBatDetailValue as ListPrice,0 as Mrp,
		 (CASE PB.Status WHEN 1 THEN 'Active' ELSE 'InActive' END) AS BatchStatus
		 FROM Productbatch PB INNER JOIN Batchcreation B ON PB.BatchSeqId=B.BatchSeqId  
		 INNER JOIN ProductBatchDetails PBD ON PB.PrdBatId=PBD.PrdBatId and B.SlNo=PBD.SLNo
		 and PBD.PriceId=Pb.DefaultPriceId
		 WHERE ListPrice=1  
		 UNION ALL
		 SELECT Prdid,PB.Prdbatid,PrdBatCode,PriceId,0 as ListPrice,PrdBatDetailValue as Mrp,
		 (CASE PB.Status WHEN 1 THEN 'Active' ELSE 'InActive' END) AS BatchStatus
		 FROM Productbatch PB INNER JOIN Batchcreation B ON PB.BatchSeqId=B.BatchSeqId  
		 INNER JOIN ProductBatchDetails PBD ON PB.PrdBatId=PBD.PrdBatId and B.SlNo=PBD.SLNo
		 and PBD.PriceId=Pb.DefaultPriceId
		 WHERE MRP=1  
		 )X INNER JOIN Product P ON X.Prdid=P.Prdid
		 GROUP BY P.Prdid,PrdDCode,PrdCCode,PrdName,Prdbatid,PrdBatCode,PriceId,BatchStatus
		 
		 INSERT INTO CS2CN_Prk_CurrentStockSnapshot  
		  (  
			DistCode,
			TransDate,
			PrdDCode,
			PrdCode,
			PrdName,
			BatchCode,
			BatchStatus,
			LcnName,
			MRP,
			ListPrice,
			SalClsStock,
			UnSalClsStock,
			OfferClsStock,
			SalableStockValue,
			UnSalableStockValue,
			TotalStockValue,
			UploadFlag
		  )  
		  SELECT DISTINCT @DistCode,CONVERT(NVARCHAR(10),GETDATE(),121) AS TransDate,PrdDCode,PrdCCode,PrdName,BatChCode,BatchStatus,
		  LcnName,MRP,ListPrice,(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih)) AS SalableStock,(SUM(PrdBatLcnUih)-SUM(PrdBatLcnResUih)) AS  UnSalableStock,
		  (SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre)) AS OfferStock,(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))* ISNULL(ListPrice,0),
		  (SUM(PrdBatLcnUih)-SUM(PrdBatLcnResUih)) * ISNULL(ListPrice,0),0 AS TotalStockValue,'N' AS UploadFlag 
		  FROM ProductBatchLocation P WITH (NOLOCK) 
		  INNER JOIN #ProductBatchDetails PBD ON P.PrdId=PBD.PrdId and P.PrdBatID=PBD.PrdBatId
		  INNER JOIN Location L  WITH (NOLOCK) ON L.LcnId = P.LcnId 
		  GROUP BY PrdDCode,PrdCCode,PrdName,BatChCode,BatchStatus,LcnName,MRP,ListPrice
		  HAVING (SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))+(SUM(PrdBatLcnUih)-SUM(PrdBatLcnResUih))+(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre))> 0
		  
		  UPDATE CS2CN_Prk_CurrentStockSnapshot SET TotalStockValue = SalableStockValue+UnSalableStockValue
		  		  
END
GO
---added by Venkatachalam
----- IDT Managament process added by Venkat. M PMS no :PARCS202100064
DELETE FROM Menudeftoavoid WHERE Menuid ='mCmp18'
UPDATE ProfileDt SET BtnStatus =1 WHERE MenuId ='mCmp18'
GO
DELETE FROM HotsearchEditorHd WHERE FormName ='Supplier master' AND ControlName ='IDTTaxGroup'
INSERT INTO HotsearchEditorHd (FormId,FormName,ControlName,SltString,RemainsltString)
SELECT '10062','Supplier Master','IDTTaxGroup','select','Select TaxGroupId,  TaxGroupName,RtrGroup From TaxGroupSetting WITH (Nolock) WHERE Taxgroup = 4 and Availability=1' UNION ALL
SELECT '10081','Supplier Master','IDTTaxGroup','select','Select * from Fn_ReturnSupplierTaxGroupGST()'
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName in ('IDTManagementUpload')
INSERT INTO Tbl_UploadIntegration(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT Max(SequenceNo)+1,'IDTManagementUpload','IDTManagementUpload' ,'CS2CN_Prk_IDTManagementUpload',Getdate() FROM Tbl_UploadIntegration  WHERE SequenceNo<500 
GO
DELETE FROM CustomUpDownload WHERE Screen in ('IDTManagementUpload') and UpDownload='Upload'
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT MAX(Slno)+1 ,1,'IDTManagementUpload','IDTManagementUpload','Proc_Cs2Cn_IDTManagementUpload','Proc_Cn2Cs_Dummy','CS2CN_Prk_IDTManagementUpload',
'Proc_Cs2Cn_IDTManagementUpload','Transaction','Upload',1 FROM CustomUpDownload WHERE UpDownload='Upload' 
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName in ('IDTMaster','IDTManagementDownload','IDTManagementApproval')
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,selectCount,CreatedDate)
SELECT Max(SequenceNo)+1,'IDTMaster' ,'CN2CS_Prk_IDTMaster','',0,500,Getdate() FROM Tbl_DownloadIntegration WHERE SequenceNo<500 UNION ALL
SELECT Max(SequenceNo)+2,'IDTManagementDownload' ,'CN2CS_Prk_IDTManagementDownload','',0,500,Getdate() FROM Tbl_DownloadIntegration WHERE SequenceNo<500 UNION ALL
SELECT Max(SequenceNo)+3,'IDTManagementApproval' ,'Cn2Cs_Prk_IDTManagementApproval','',0,500,Getdate() FROM Tbl_DownloadIntegration WHERE SequenceNo<500 
GO
DELETE FROM CustomUpDownload WHERE Screen in ('IDTMaster','IDTManagementDownload','IDTManagementApproval') and UpDownload='Download'
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT MAX(Slno)+1 ,1,'IDTMaster','IDTMaster','Proc_Cn2Cs_IDTMaster','Proc_Import_IDTMaster','CN2CS_Prk_IDTMaster',
'Proc_Cn2Cs_IDTMaster','Master','Download',1 FROM CustomUpDownload WHERE UpDownload='Download' UNION ALL
SELECT MAX(Slno)+2 ,1,'IDTManagementDownload','IDTManagementDownload','Proc_Cn2Cs_IDTManagementDownload','Proc_Import_IDTManagementDownload','CN2CS_Prk_IDTManagementDownload',
'Proc_Cn2Cs_IDTManagementDownload','Transaction','Download',1 FROM CustomUpDownload WHERE UpDownload='Download' UNION ALL
SELECT MAX(Slno)+3 ,1,'IDTManagementApproval','IDTManagementApproval','','','Cn2Cs_Prk_IDTManagementApproval',
'Proc_Cn2Cs_Prk_IDTManagementApproval','Transaction','Download',1 FROM CustomUpDownload WHERE UpDownload='Download'
GO
IF NOT EXISTS (SELECT * FROM UDCHD WHERE MasterName ='IDT Master')
BEGIN
	INSERT INTO UdcHd 
	SELECT 37,'IDT Master',0,0,0
END
GO
IF NOT EXISTS (SELECT * FROM UdcMaster WHERE MASTERID =37)
BEGIN
	DECLARE @UdcMasterid INT
	SELECT @UdcMasterid= dbo.Fn_GetPrimaryKeyInteger('UdcMaster','UdcMasterid',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
	INSERT INTO UdcMaster([UdcMasterId],[MasterId],[ColumnName],[ColumnDataType],[ColumnSize],[ColumnPrecision],[ColumnMandatory],[PickFromDefault],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[Editable])
	VALUES (@UdcMasterid,37,'GSTIN','Varchar',25,0,1,0,1,1,GETDATE(),1,GETDATE(),1)
	INSERT INTO UdcMaster([UdcMasterId],[MasterId],[ColumnName],[ColumnDataType],[ColumnSize],[ColumnPrecision],[ColumnMandatory],[PickFromDefault],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[Editable])
	VALUES (@UdcMasterid+1,37,'State Name','Varchar',100,0,1,1,1,1,GETDATE(),1,GETDATE(),1)
	INSERT INTO UdcMaster([UdcMasterId],[MasterId],[ColumnName],[ColumnDataType],[ColumnSize],[ColumnPrecision],[ColumnMandatory],[PickFromDefault],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[Editable]) 
	VALUES (@UdcMasterid+2,37,'Status','Varchar',50,0,1,1,1,1,GETDATE(),1,GETDATE(),1)
	INSERT INTO UdcMaster([UdcMasterId],[MasterId],[ColumnName],[ColumnDataType],[ColumnSize],[ColumnPrecision],[ColumnMandatory],[PickFromDefault],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[Editable])
	VALUES (@UdcMasterid+3,37,'Pincode','Varchar',20,0,0,0,1,1,GETDATE(),1,GETDATE(),1)
	INSERT INTO UdcMaster([UdcMasterId],[MasterId],[ColumnName],[ColumnDataType],[ColumnSize],[ColumnPrecision],[ColumnMandatory],[PickFromDefault],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[Editable])
	VALUES (@UdcMasterid+4,37,'Distance level Km','Numeric',10,2,0,0,1,1,GETDATE(),1,GETDATE(),1)
	
	UPDATE Counters SET CurrValue = (SELECT MAX(UdcMasterID) FROM UdcMaster) WHERE TabName = 'UdcMaster'

END
GO
DECLARE @UdcMaster INT
SELECT @UdcMaster= UdcMasterid FROM UdcMaster  WHERE MasterId  =37 AND ColumnName ='State Name'
DELETE FROM  UDCDefault WHERE MASTERID =37 AND UdcMasterId =@UdcMaster
INSERT INTO UDCDefault
SELECT StateId, 37,@UdcMaster , StateName FROM StateMaster
GO
DECLARE @UdcMaster INT
SELECT @UdcMaster= UdcMasterid FROM UdcMaster  WHERE MasterId  =37 AND ColumnName ='Status'
DELETE FROM  UDCDefault WHERE MASTERID =37 AND UdcMasterId =@UdcMaster
INSERT INTO UDCDefault
SELECT 1, 37,@UdcMaster , 'Active' UNION ALL
SELECT 2, 37,@UdcMaster , 'InActive'
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='CS2CN_Prk_IDTManagementUpload' AND XTYPE='U')
DROP TABLE CS2CN_Prk_IDTManagementUpload
GO
CREATE TABLE CS2CN_Prk_IDTManagementUpload
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[IDTMngRefNo] [nvarchar](500) NULL,
	[IDTMngDate] [datetime] NULL,
	[IDTDistCode] [nvarchar](100) NULL,
	[IDTDistName] [nvarchar](100) NULL,
	[LcnCode] [nvarchar](100) NULL,
	[LcnName] [nvarchar](200) NULL,
	[StkMgmtType] [nvarchar](300) NULL,
	[DocRefNo] [nvarchar](100) NULL,
	[LRNumber] [nvarchar](100) NULL,
	[LRDate] [datetime] NULL,
	[Remarks] [nvarchar](200) NULL,
	[Status] [nvarchar](100) NULL,
	[IDTGrossAmt] [numeric](36, 2) NULL,
	[IDTTaxAmt] [numeric](36, 2) NULL,
	[IDTNetAmt] [numeric](36, 2) NULL,
	[IDTPaidAmt] [numeric](36, 2) NULL,
	[ProductCode] [nvarchar](100) NULL,
	[ProductName] [nvarchar](100) NULL,
	[BatchCode] [nvarchar](100) NULL,
	[SystemStockType] [int] NULL,
	[StockType] [nvarchar](50) NULL,
	[BaseQty] [numeric](18, 0) NULL,
	[MRP] [numeric](18, 2) NULL,
	[ListPrice] [numeric](18, 2) NULL,
	[ProductGrossAmt] [numeric](36, 2) NULL,
	[IDTCharge] [numeric](36, 2) NULL,
	[DiscountAmt] [numeric](36, 2) NULL,
	[ProductTaxAmt] [numeric](36, 2) NULL,
	[ProductNetAmt] [numeric](36, 2) NULL,
	[UploadFlag] [nvarchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL,
	[TaxPerc] [numeric](18, 2) NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[CS2CN_Prk_IDTManagementUpload] ADD  DEFAULT ((0)) FOR [TaxPerc]
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='CN2CS_Prk_IDTManagementDownload' AND XTYPE='U')
DROP TABLE CN2CS_Prk_IDTManagementDownload
GO
CREATE TABLE CN2CS_Prk_IDTManagementDownload(
	[DistCode] [nvarchar](50) NULL,
	[IDTCmpInvNo] [nvarchar](200) NULL,
	[SpmCode] [nvarchar](100) NULL,
	[LcnCode] [nvarchar](100) NULL,
	[LRNo] [nvarchar](100) NULL,
	[LRDate] [datetime] NULL,
	[Remarks] [nvarchar](500) NULL,
	[IDTGrossAmt] [numeric](38, 6) NULL,
	[IDTTaxAmt] [numeric](38, 6) NULL,
	[IDTNetAmt] [numeric](38, 6) NULL,
	[PrdCCode] [nvarchar](200) NULL,
	[PrdName] [nvarchar](500) NULL,
	[PrdBatCode] [nvarchar](200) NULL,
	[SystemStockType] [int] NULL,
	[BaseQty] [numeric](18, 0) NULL,
	[PrdMRPRate] [numeric](18, 2) NULL,
	[PrdUnitRate] [numeric](18, 3) NULL,
	[PrdGrossAmt] [numeric](38, 6) NULL,
	[IDTCharge] [numeric](38, 6) NULL,
	[DiscountAmt] [numeric](38, 6) NULL,
	[PrdTaxAmount] [numeric](38, 6) NULL,
	[PrdNetAmount] [numeric](38, 6) NULL,
	[DownloadFlag] [nvarchar](2) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE Name ='CN2CS_Prk_IDTMaster' AND Xtype ='U')
DROP TABLE CN2CS_Prk_IDTMaster
GO
CREATE TABLE CN2CS_Prk_IDTMaster(
	[DistCode] [nvarchar](50) NULL,
	[SpmCode] [nvarchar](100) NULL,
	[SpmName] [nvarchar](200) NULL,
	[CmpCode] [nvarchar](100) NULL,
	[SpmAdd1] [nvarchar](300) NULL,
	[SpmAdd2] [nvarchar](200) NULL,
	[SpmAdd3] [nvarchar](200) NULL,
	[SpmPhone] [nvarchar](50) NULL,
	[SpmFax] [nvarchar](200) NULL,
	[SpmEmail] [nvarchar](200) NULL,
	[SpmContact] [nvarchar](200) NULL,
	[SpmOnAcc] [numeric](18, 6) NULL,
	[DownloadFlag] [nvarchar](4) NULL,
	[TaxGroupCode] [nvarchar](100) NULL,
	[StateCode] [nvarchar](50) NULL,
	[GSTTIN] [nvarchar](100) NULL,
	[PanNumber] [nvarchar](100) NULL,
	[IDTDistributorType] [nvarchar](100) NULL,
	[AadharNo] [nvarchar](100) NULL,
	[DistributorStatus] [nvarchar](25) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE Name='Cn2Cs_Prk_IDTManagementApproval' AND Xtype ='U')
DROP TABLE Cn2Cs_Prk_IDTManagementApproval
GO
CREATE TABLE Cn2Cs_Prk_IDTManagementApproval
(
	[DistCode] [varchar](50) NULL,
	[IdtMngRefNo] [varchar](50) NULL,
	[SpmCode] [varchar](25) NULL,
	[LcnCode] [varchar](25) NULL,
	[PrdCCode] [varchar](50) NULL,
	[PrdBatCode] [varchar](50) NULL,
	[StkType] [varchar](50) NULL,
	[BaseQty] [bigint] NULL,
	[AppQty] [bigint] NULL,
	[DownloadFlag] [varchar](1) NULL
) ON [PRIMARY]
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_IDTManagementUpload' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_IDTManagementUpload
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_IDTManagementUpload 0,'2014-08-05'
SELECT * FROM CS2CN_Prk_IDTManagementUpload with (nolock)
--SELECT Upload,* from IDTManagement WITH (NOLOCK)
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2Cn_IDTManagementUpload
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_IDTMaster
* PURPOSE		: To Validate the Downloaded IDTMaster
* CREATED BY	: Sathishkumar Veeramani
* CREATED DATE	: 18/06/2013
* NOTE			: 
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {Date}		{Developer}		{Brief Modification Description}
* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Upload
**************************************************************************/
SET NOCOUNT ON
BEGIN

    SET @Po_ErrNo = 0
	DECLARE @ErrStatus INT
	DECLARE @DistCode AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor WITH (NOLOCK)
	DELETE FROM CS2CN_Prk_IDTManagementUpload WHERE UploadFlag='Y'
	
	--IDT Charges & Discounts
	SELECT DISTINCT IDTMngRefNo,PrdSlNo,SUM(IDTCharge) AS IDTCharge,SUM(DiscountAmt) AS DiscountAmt INTO #IDTDiscounts FROM (
	SELECT DISTINCT A.IDTMngRefNo,B.PrdSlNo,(CASE C.RefCode WHEN 'E' THEN ISNULL(SUM(C.LineBaseQtyAmount),0) ELSE 0 END) AS IDTCharge,
	(CASE C.RefCode WHEN 'F' THEN ISNULL(SUM(C.LineBaseQtyAmount),0) ELSE 0 END) AS DiscountAmt FROM IDTManagement A (NOLOCK) 
	INNER JOIN IDTManagementProduct B (NOLOCK) ON A.IDTMngRefNo = B.IDTMngRefNo
	INNER JOIN IDTManagementLineAmount C (NOLOCK) ON A.IDTMngRefNo = C.IDTMngRefNo AND B.IDTMngRefNo = C.IDTMngRefNo AND B.PrdSlNo = C.PrdSlNo
	INNER JOIN IDTSequenceDetail D (NOLOCK) ON A.IDTSeqId = D.IDTSeqId AND C.RefCode = D.RefCode
	WHERE A.Upload = 'N' AND D.RefCode IN ('E','F') GROUP BY A.IDTMngRefNo,B.PrdSlNo,C.RefCode) Qry
	GROUP BY IDTMngRefNo,PrdSlNo ORDER BY IDTMngRefNo

	SELECT IDTMngRefNo,PrdSlNo,SUM(DISTINCT TaxableAmount)  as TaxableAmount , 
	SUM(TaxAmount) as TaxAmount,	SUM(TaxPerc) as TaxPerc INTO #IDTManagementProductTax  
	FROM IDTManagementProductTax GROUP BY IDTMngRefNo,PrdSlNo

    --Till Here
	
    INSERT INTO CS2CN_Prk_IDTManagementUpload (DistCode,IDTMngRefNo,IDTMngDate,IDTDistCode,IDTDistName,LcnCode,LcnName,StkMgmtType,DocRefNo,
    LRNumber,LRDate,Remarks,Status,IDTGrossAmt,IDTTaxAmt,IDTNetAmt,IDTPaidAmt,ProductCode,ProductName,BatchCode,SystemStockType,StockType,BaseQty,MRP,
    ListPrice,ProductGrossAmt, IDTCharge,DiscountAmt,ProductTaxAmt,ProductNetAmt,UploadFlag,TaxPerc)
    
    SELECT @DistCode,A.IDTMngRefNo,A.IDTMngDate,C.SpmCode,C.SpmName,F.LcnCode,F.LcnName,
    (CASE A.StkMgmtTypeId WHEN 1 THEN 'IDT IN' ELSE 'IDT OUT' END) AS StkMgmtType,A.DocRefNo,LRNo,LRDate,Remarks,'CONFIRM',IDTGrossAmt,
    IDTTaxAmt,IDTNetAmt,IDTPaidAmt,PrdCCode,PrdName,PrdBatCode,SystemStockType,UserStockType,SUM(B.Qty) AS BaseQTy,B.PrdMRPRate,B.PrdUnitRate,
    SUM(B.PrdGrossAmount) AS PrdGrossAmount,IDTCharge,DiscountAmt,SUM(T.TaxAmount) AS PrdTaxAmount,SUM(B.PrdNetAmount) AS PrdNetAmount,'N' AS UploadFlag,
    T.TaxPerc 
    FROM IDTManagement A WITH (NOLOCK)
    INNER JOIN IDTManagementProduct B WITH (NOLOCK) ON A.IDTMngRefNo = B.IDTMngRefNo
    INNER JOIN #IDTManagementProductTax T ON A.IDTMngRefNo=T.IDTMngRefNo AND B.IDTMngRefNo=T.IDTMngRefNo AND B.PrdSlNo=T.PrdSlNo
    INNER JOIN IDTMaster C WITH (NOLOCK) ON A.SpmId = C.SpmId    
    INNER JOIN Product D WITH (NOLOCK) ON B.PrdId = D.PrdId
    INNER JOIN ProductBatch E WITH (NOLOCK) ON D.PrdId = E.PrdId AND B.PrdBatId = E.PrdBatId
    INNER JOIN Location F WITH (NOLOCK) ON A.LcnId = F.LcnId
    INNER JOIN StockType G WITH (NOLOCK) ON F.LcnId = G.LcnId AND B.StockTypeId = G.StockTypeId
    INNER JOIN #IDTDiscounts H ON A.IDTMngRefNo = H.IDTMngRefNo AND B.IDTMngRefNo = H.IDTMngRefNo AND B.PrdSlNo = H.PrdSlNo
    WHERE T.TaxableAmount>0 AND A.Status = 1 AND A.Upload = 'N' 
    GROUP BY A.IDTMngRefNo,A.IDTMngDate,C.SpmCode,C.SpmName,F.LcnCode,F.LcnName,A.StkMgmtTypeId,
    A.DocRefNo,LRNo,LRDate,Remarks,IDTGrossAmt,IDTTaxAmt,IDTNetAmt,IDTPaidAmt,PrdCCode,PrdName,PrdBatCode,SystemStockType,UserStockType,
    B.PrdMRPRate,B.PrdUnitRate,IDTCharge,DiscountAmt,T.TaxPerc
    
    UPDATE CS2CN_Prk_IDTManagementUpload SET ServerDate = @ServerDate
    
    UPDATE A SET A.Upload = 'Y' FROM IDTManagement A WITH (NOLOCK),CS2CN_Prk_IDTManagementUpload B WITH (NOLOCK) 
    WHERE A.IDTMngRefNo = B.IDTMngRefNo    
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_IDTManagementDownload' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_IDTManagementDownload
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_IDTManagementDownload 0
SELECT * FROM ErrorLog
SELECT * FROM EtlTempIDTManagement with (nolock)
SELECT * FROM EtlTempIDTManagementProduct with (nolock)
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_IDTManagementDownload
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_IDTManagementDownload
* PURPOSE		: To Validate the Downloaded IDTManagementProducts
* CREATED BY	: Sathishkumar Veeramani
* CREATED DATE	: 27/06/2013
* NOTE			: 
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {Date}		{Developer}		{Brief Modification Description}
* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Management
**************************************************************************/
SET NOCOUNT ON
BEGIN
    SET @Po_ErrNo = 0
    DECLARE @LcnId      BIGINT


	DECLARE @ErrStatus INT
	DELETE FROM CN2CS_Prk_IDTManagementDownload WHERE DownLoadFlag='Y'
	
	
	DECLARE @IDTToAvoidDownload TABLE
	(
	   IDTCmpInvNo NVARCHAR(200)
	)
	--IDT Distributor SpmCode,IDTCmpInvNo,PrdCcode,PrdBatCode Should not be Empty or NULL
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE ISNULL(LTRIM(RTRIM(IDTCmpInvNo)),'')= '' 
	           OR ISNULL(LTRIM(RTRIM(SpmCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdCCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdBatCode)),'')= '')
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT IDTCmpInvNo FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE ISNULL(LTRIM(RTRIM(IDTCmpInvNo)),'')= '' 
	       OR ISNULL(LTRIM(RTRIM(SpmCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdCCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdBatCode)),'')= ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','SpmCode','IDTManagement IDTDistributorCode,IDTCmpInvNo,PrdCcode,PrdBatCode Should not be Empty or NULL'
		   FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE ISNULL(LTRIM(RTRIM(IDTCmpInvNo)),'')= '' 
	       OR ISNULL(LTRIM(RTRIM(SpmCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdCCode)),'')= '' OR ISNULL(LTRIM(RTRIM(PrdBatCode)),'')= ''
	END
	--IDT Distributor Code not Available
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE SpmCode NOT IN (SELECT SpmCode FROM IDTMaster WITH (NOLOCK)) 
	           AND ISNULL(LTRIM(RTRIM(SpmCode)),'') <> '' )
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT IDTCmpInvNo FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE SpmCode NOT IN (SELECT SpmCode FROM IDTMaster WITH (NOLOCK)) 
	       AND ISNULL(LTRIM(RTRIM(SpmCode)),'') <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 2,'IDTMaster','SpmCode','IDT Distributor Code Not Available '+CAST(SpmCode AS NVARCHAR(100))
		   FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE SpmCode NOT IN (SELECT SpmCode FROM IDTMaster WITH (NOLOCK)) 
	       AND ISNULL(LTRIM(RTRIM(SpmCode)),'') <> ''
	END	
	--IDT Company InvoiceNo Already Available in CoreStocky	
	IF EXISTS (SELECT * FROM IDTManagement A WITH (NOLOCK),CN2CS_Prk_IDTManagementDownload B WITH (NOLOCK) WHERE A.DocRefNo = B.IDTCmpInvNo 
	           AND LTRIM(RTRIM(B.IDTCmpInvNo)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT B.IDTCmpInvNo FROM IDTManagement A WITH (NOLOCK),CN2CS_Prk_IDTManagementDownload B WITH (NOLOCK) 
		   WHERE A.DocRefNo = B.IDTCmpInvNo AND LTRIM(RTRIM(B.IDTCmpInvNo)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 3,'IDTManagement','DocRefNo','IDT Company InvoiceNo Already Available '+CAST(B.IDTCmpInvNo AS NVARCHAR(100))
		   FROM IDTManagement A WITH (NOLOCK),CN2CS_Prk_IDTManagementDownload B WITH (NOLOCK) WHERE A.DocRefNo = B.IDTCmpInvNo 
		   AND LTRIM(RTRIM(B.IDTCmpInvNo)) <> ''
	END
	--Product Code Not Available in CoreStocky
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) 
	           AND LTRIM(RTRIM(PrdCCode)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT IDTCmpInvNo FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) 
	       AND LTRIM(RTRIM(PrdCCode)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 4,'Product','PrdCCode','Product Code not Available'+CAST(PrdCCode AS NVARCHAR(200))
		   FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) 
	       AND LTRIM(RTRIM(PrdCCode)) <> ''
	END 
	--Batch Code Not Available in CoreStocky
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdBatCode NOT IN (SELECT PrdBatCode FROM ProductBatch WITH (NOLOCK)) 
	           AND LTRIM(RTRIM(PrdBatCode)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT IDTCmpInvNo FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdBatCode NOT IN (SELECT PrdBatCode FROM ProductBatch WITH (NOLOCK)) 
	       AND LTRIM(RTRIM(PrdBatCode)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 5,'ProductBatch','PrdBatCode','Batch Code not Available'+CAST(PrdBatCode AS NVARCHAR(200))
		   FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE PrdBatCode NOT IN (SELECT PrdBatCode FROM ProductBatch WITH (NOLOCK)) 
	       AND LTRIM(RTRIM(PrdBatCode)) <> ''
	END
	--Product BatchCode Not Available
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100))
	           NOT IN (SELECT CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100)) FROM Product A WITH (NOLOCK),ProductBatch B WITH(NOLOCK) 
	           WHERE A.PrdId = B.PrdId) AND LTRIM(RTRIM(PrdCCode)) <> '' AND LTRIM(RTRIM(PrdBatCode)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoidDownload(IDTCmpInvNo)
		   SELECT DISTINCT IDTCmpInvNo FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100))
           NOT IN (SELECT CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100)) FROM Product A WITH (NOLOCK),ProductBatch B WITH(NOLOCK) 
           WHERE A.PrdId = B.PrdId) AND LTRIM(RTRIM(PrdCCode)) <> '' AND LTRIM(RTRIM(PrdBatCode)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 6,'Product','PrdCcode','Product and BatchCode Not Available'+CAST(PrdCCode AS NVARCHAR(200))+'~'+CAST(PrdBatCode AS NVARCHAR(200))
		   FROM CN2CS_Prk_IDTManagementDownload WITH (NOLOCK) WHERE CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100))
           NOT IN (SELECT CAST(PrdCCode AS NVARCHAR(100))+'~'+CAST(PrdBatCode AS NVARCHAR(100)) FROM Product A WITH (NOLOCK),ProductBatch B WITH(NOLOCK) 
           WHERE A.PrdId = B.PrdId) AND LTRIM(RTRIM(PrdCCode)) <> '' AND LTRIM(RTRIM(PrdBatCode)) <> ''
	END
	
	--Default Location 
	  SELECT @LcnId = LcnId FROM Location WITH (NOLOCK) WHERE DefaultLocation = 1
	  
	--ETLTempIDTManagement	
	  INSERT INTO ETLTempIDTManagement (IDTCmpInvNo,IDTCmpInvDate,LcnId,SpmId,SpmCode,LRNo,LRDate,Remarks,IDTGrossAmt,IDTTaxAmt,IDTNetAmt,DownloadStatus)
	  SELECT DISTINCT IDTCmpInvNo,CONVERT(NVARCHAR(10),GETDATE(),121),@LcnId,B.SpmId,A.SpmCode,ISNULL(LRNo,''),ISNULL(LRDate,CONVERT(NVARCHAR(10),GETDATE(),121)),
	  ISNULL(Remarks,''),ISNULL(IDTGrossAmt,0.00),ISNULL(IDTTaxAmt,0.00),ISNULL(IDTNetAmt,0.00),0 AS DownloadStatus 
	  FROM CN2CS_Prk_IDTManagementDownload A WITH (NOLOCK)
	  INNER JOIN IDTMaster B WITH (NOLOCK) ON A.SpmCode = B.SpmCode WHERE IDTCmpInvNo NOT IN (SELECT IDTCmpInvNo FROM @IDTToAvoidDownload)
	  AND IDTCmpInvNo NOT IN (SELECT IDTCmpInvNo FROM ETLTempIDTManagement) AND DownloadFlag = 'D'
	
         
	--Product Download Details
		SELECT DISTINCT IDTCmpInvNo,A.PrdId,PrdDCode,A.PrdName,B.PrdBatId,B.PrdBatCode,C.PriceId,SystemStockType,BaseQty,
		D.PrdBatDetailValue AS MRP,C.PrdBatDetailValue AS SelRate,PrdGrossAmt,IDTCharge,DiscountAmt,PrdTaxAmount,PrdNetAmount 
		INTO #IDTProductDownloadDetails	FROM CN2CS_Prk_IDTManagementDownload IDT WITH (NOLOCK)
		INNER JOIN Product A WITH(NOLOCK) ON IDT.PrdCCode = A.PrdCcode
		INNER JOIN ProductBatch B WITH(NOLOCK) ON A.PrdId = B.PrdId AND IDT.PrdBatCode = B.PrdBatCode
		INNER JOIN ProductBatchDetails C WITH (NOLOCK) ON B.PrdBatId = C.PrdBatId
		INNER JOIN BatchCreation BC1 WITH (NOLOCK) ON B.BatchSeqId = BC1.BatchSeqId AND C.SLNo = BC1.SlNo AND BC1.ListPrice = 1
		INNER JOIN ProductBatchDetails D WITH (NOLOCK) ON B.PrdBatId = D.PrdBatId 
		INNER JOIN BatchCreation BC2 WITH (NOLOCK) ON B.BatchSeqId = BC2.BatchSeqId AND D.SLNo = BC2.SlNo AND BC2.MRP = 1
		INNER JOIN (
		SELECT DISTINCT A.PrdId,B.PrdBatId,MAX(PriceId) AS PriceId FROM Product A With (Nolock),ProductBatch B WITH(NOLOCK),
		ProductBatchDetails C WITH (NOLOCK) WHERE A.PrdId = B.PrdId AND B.PrdBatId = C.PrdBatId GROUP BY A.PrdId,B.PrdBatId) E
		ON A.PrdId = E.PrdId AND B.PrdBatId = E.PrdBatId AND C.PriceId = E.PriceId AND D.PriceId = E.PriceId
		WHERE IDT.IDTCmpInvNo NOT IN (SELECT IDTCmpInvNo FROM @IDTToAvoidDownload) AND DownloadFlag = 'D'
		ORDER BY A.Prdid,B.PrdBatId	
	
	--ETLTempIDTManagementProduct
	   INSERT INTO ETLTempIDTManagementProduct (IDTCmpInvNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,PriceId,StockTypeId,UserStockType,
	   BaseQty,AvailQty,PrdMRPRate,PrdUnitRate,PrdGrossAmt,IDTCharge,DiscountAmt,PrdTaxAmount,PrdNetAmount)
	   SELECT DISTINCT IDTCmpInvNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,PriceId,StockTypeId,UserStockType,BaseQty,0,MRP,SelRate,
	   ISNULL(PrdGrossAmt,0.00),ISNULL(IDTCharge,0),ISNULL(DiscountAmt,0),ISNULL(PrdTaxAmount,0.00),ISNULL(PrdNetAmount,0.00) 
	   FROM #IDTProductDownloadDetails A WITH (NOLOCK)
	   INNER JOIN StockType B WITH (NOLOCK) ON A.SystemStockType = B.SystemStockType AND LcnId = @LcnId
	   WHERE IDTCmpInvNo IN (SELECT DISTINCT IDTCmpInvNo FROM ETLTempIDTManagement WITH (NOLOCK) WHERE DownloadStatus = 0)
		   
	   --After Download Flag to be Change	   
       UPDATE A SET A.DownloadFlag = 'Y' FROM CN2CS_Prk_IDTManagementDownload A WITH (NOLOCK),ETLTempIDTManagement B WITH (NOLOCK),
       ETLTempIDTManagementProduct C WITH (NOLOCK) WHERE A.IDTCmpInvNo = B.IDTCmpInvNo AND A.IDTCmpInvNo = C.IDTCmpInvNo
RETURN	
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Validate_CN2CS_UdcDetails' AND XTYPE='P')
DROP PROCEDURE Proc_Validate_CN2CS_UdcDetails
GO
-- EXEC Proc_ValidateUdcDetails ''
CREATE PROCEDURE Proc_Validate_CN2CS_UdcDetails
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*********************************    
* PROCEDURE: Proc_Validate_CN2CS_UdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: S.Moorthi

* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Management UDC Added
*********************************/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	SET @TabName = 'ETL_Prk_CN2CS_UdcDetails'  
	SET @Po_ErrNo =0
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL(MasterName,'') MasterName,ISNULL([ColumnName],'') ColumnName,ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM ETL_Prk_CN2CS_UdcDetails (NOLOCK) WHERE UpdateFlag=0
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 

		IF @Po_ErrNo = 0 
		BEGIN
			
			IF @MasterName='PRODUCT MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('PRODUCT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCT','PrdCCode','PrdId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SUPPLIER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SUPPLIER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SUPPLIER','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DISTRIBUTOR INFO MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			-- Added by Venkat. M PMS  no: PARCS202100064
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'IDT MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('IDT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('IDTMaster','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END

					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))

					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				UPDATE ETL_Prk_CN2CS_UdcDetails SET UpdateFlag=1 WHERE MasterName=@MasterName and ColumnName=@ColName and [Column Code]=@ColCode
				
			END
		END

	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_IDTMaster' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_IDTMaster
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_IDTMaster 0
SELECT * FROM ErrorLog
SELECT * FROM IDTMaster WITH (NOLOCK)
SELECT * FROM CoaMaster WITH (NOLOCK) WHERE AcLevel = 4 AND MainGroup = 1 AND Status = 2
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_IDTMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_IDTMaster
* PURPOSE		: To Validate the Downloaded IDTMaster
* CREATED BY	: Sathishkumar Veeramani
* CREATED DATE	: 18/06/2013
* NOTE			: 
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {Date}		{Developer}		{Brief Modification Description}
* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Management
**************************************************************************/
SET NOCOUNT ON
BEGIN
    DECLARE @SpmId      BIGINT
	DECLARE @CmpCode    NVARCHAR(50)
	DECLARE @CmpId      BIGINT
	DECLARE @SpmCode    NVARCHAR(100)
	DECLARE @SpmName    NVARCHAR(200)
	DECLARE @SpmAdd1    NVARCHAR(600)
	DECLARE @SpmAdd2    NVARCHAR(200)
	DECLARE @SpmAdd3    NVARCHAR(200)
	DECLARE @SpmPhone   NVARCHAR(100) 
	DECLARE @SpmFax     NVARCHAR(200) 
	DECLARE @SpmMail    NVARCHAR(200) 
	DECLARE @SpmContact NVARCHAR(200) 
	DECLARE @SpmOnAcc   NUMERIC(18,6)
	DECLARE @IDTTaxGroupId  BIGINT
	DECLARE @CoaId AS BIGINT
	DECLARE @AccCode AS NUMERIC(18,0)
	DECLARE @TaxGroupCode AS NVARCHAR(100)
	DECLARE @ErrStatus INT
	DECLARE @PanNumber AS NVARCHAR(50)
	DECLARE @GSTTIN AS NVARCHAR(50)	
	DECLARE @AadharNo AS NVARCHAR(50)
	DECLARE @DistType AS NVARCHAR(50)
	DECLARE @Status AS NVARCHAR(50)
	DECLARE @StateCode AS NVARCHAR(50)
	DECLARE @StateName AS NVARCHAR(100)
	DELETE FROM CN2CS_Prk_IDTMaster WHERE DownLoadFlag='Y'
	SET @Po_ErrNo = 0
	
	DECLARE @IDTToAvoid TABLE
	(
	  SpmCode NVARCHAR(200)
	)
	--IDT Distributor Code,Name,Add1,Cmpany Should not be Empty
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE (ISNULL(LTRIM(RTRIM(SpmCode)),'') = '' OR ISNULL(LTRIM(RTRIM(SpmName)),'')= '' 
	           OR ISNULL(LTRIM(RTRIM(SpmAdd1)),'') = '' OR ISNULL(LTRIM(RTRIM(CmpCode)),'') = '' OR ISNULL(LTRIM(RTRIM(TaxGroupCode)),'') = ''
	           OR ISNULL(LTRIM(RTRIM(StateCode)),'') = '' OR ISNULL(LTRIM(RTRIM(IDTDistributorType)),'') = '' OR ISNULL(LTRIM(RTRIM(DistributorStatus)),'') = ''))
	BEGIN
		   INSERT INTO @IDTToAvoid(SpmCode)
		   SELECT DISTINCT SpmCode FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE (ISNULL(LTRIM(RTRIM(SpmCode)),'') = '' OR ISNULL(LTRIM(RTRIM(SpmName)),'')= '' 
	       OR ISNULL(LTRIM(RTRIM(SpmAdd1)),'') = '' OR ISNULL(LTRIM(RTRIM(CmpCode)),'') = '' OR ISNULL(LTRIM(RTRIM(TaxGroupCode)),'') = ''
	           OR ISNULL(LTRIM(RTRIM(StateCode)),'') = '' OR ISNULL(LTRIM(RTRIM(IDTDistributorType)),'') = '' OR ISNULL(LTRIM(RTRIM(DistributorStatus)),'') = '')
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','SpmCode','IDT SpmCode,SpmName,SpmAdd1,CmpCode,TaxGroupCode,StateCode,IDTDistributorType,DistributorStatus Should not be Empty or NULL'
		   FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE (ISNULL(LTRIM(RTRIM(SpmCode)),'') = '' OR ISNULL(LTRIM(RTRIM(SpmName)),'')= '' 
	       OR ISNULL(LTRIM(RTRIM(SpmAdd1)),'') = '' OR ISNULL(LTRIM(RTRIM(CmpCode)),'') = '' OR ISNULL(LTRIM(RTRIM(TaxGroupCode)),'') = ''
	       OR ISNULL(LTRIM(RTRIM(StateCode)),'') = '' OR ISNULL(LTRIM(RTRIM(IDTDistributorType)),'') = '' OR ISNULL(LTRIM(RTRIM(DistributorStatus)),'') = '')
	END
	--IDT Distributor Code Should not available in CoreStocky	
	IF EXISTS (SELECT * FROM IDTMaster A WITH (NOLOCK),CN2CS_Prk_IDTMaster B WITH (NOLOCK) WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(B.SpmCode)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoid(SpmCode)
		   SELECT DISTINCT A.SpmCode FROM IDTMaster A WITH (NOLOCK),CN2CS_Prk_IDTMaster B WITH (NOLOCK) 
		   WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(B.SpmCode)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','SpmCode','IDT Distributor Code Already Available'+CAST(A.Spmcode AS NVARCHAR(100))
		   FROM IDTMaster A WITH (NOLOCK),CN2CS_Prk_IDTMaster B WITH (NOLOCK) 
		   WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(B.SpmCode)) <> ''
	END
	--Company Code Should be available in CoreStocky
	IF EXISTS (SELECT * FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE CmpCode NOT IN (SELECT CmpCode FROM Company WITH (NOLOCK)) AND LTRIM(RTRIM(CmpCode)) <> '')
	BEGIN
		   INSERT INTO @IDTToAvoid(SpmCode)
		   SELECT DISTINCT SpmCode FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE CmpCode NOT IN (SELECT CmpCode FROM Company WITH (NOLOCK)) 
		   AND LTRIM(RTRIM(CmpCode)) <> ''
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','CmpCode','Company Code Not Available'+CAST(Spmcode AS NVARCHAR(100))
		   FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE CmpCode NOT IN (SELECT CmpCode FROM Company WITH (NOLOCK)) 
		   AND LTRIM(RTRIM(CmpCode)) <> ''
	END 
	
	----Tax Group Not Available in CoreStocky
	IF  EXISTS (SELECT * FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE TaxGroupCode Not in (SELECT RtrGroup from TaxGroupsetting where TaxGroup=3))
	BEGIN
		   INSERT INTO @IDTToAvoid(SpmCode)
		   SELECT DISTINCT SpmCode FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE TaxGroupCode Not in (SELECT RtrGroup from TaxGroupsetting where TaxGroup=3)
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','TaxGroupCode',' IDTMaster TaxGroupCode Not Available'+CAST(Spmcode AS NVARCHAR(100))
		   FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE TaxGroupCode Not in (SELECT RtrGroup from TaxGroupsetting where TaxGroup=3)
	END 
	
	----IDT Distributor Type Validation ---
	--IF  EXISTS (SELECT * FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
	--RTRIM(LTRIM(UPPER(ISNULL(IDTDistributorType,'')))) NOT IN ('Composition','Registered'))
	--BEGIN
	--	   INSERT INTO @IDTToAvoid(SpmCode)
	--	   SELECT DISTINCT SpmCode FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
	--	   RTRIM(LTRIM(UPPER(ISNULL(IDTDistributorType,'')))) NOT IN ('Composition','Registered')
	--	   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
	--	   SELECT DISTINCT 1,'IDTMaster','IDTDistributorType',' IDTMaster Distributor Type Should be Composition/Registered '+CAST(Spmcode AS NVARCHAR(100))
	--	   FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
	--       RTRIM(LTRIM(UPPER(ISNULL(IDTDistributorType,'')))) NOT IN ('Composition','Registered')
	--END 
	
	-----State Code Not Available in Corestocky
	IF EXISTS(SELECT DISTINCT Spmcode FROM CN2CS_Prk_IDTMaster A 
	WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	BEGIN
	
	     INSERT INTO @IDTToAvoid(SpmCode)
	     SELECT DISTINCT Spmcode FROM CN2CS_Prk_IDTMaster A 
	     WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'IDTMaster','State Code','IDTMaster State Code Not available'+CAST(Spmcode AS NVARCHAR(100)) FROM CN2CS_Prk_IDTMaster A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	END
	
   ----IDT Distributor Type Validation ---
	IF  EXISTS (SELECT * FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
	RTRIM(LTRIM(UPPER(ISNULL(DistributorStatus,'')))) NOT IN ('Active','InActive'))
	BEGIN
		   INSERT INTO @IDTToAvoid(SpmCode)
		   SELECT DISTINCT SpmCode FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
		   RTRIM(LTRIM(UPPER(ISNULL(DistributorStatus,'')))) NOT IN ('Active','InActive')
		   INSERT INTO Errorlog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 1,'IDTMaster','DistributorStatus',' IDTMaster Distributor Status Should be Active/InActive'+CAST(Spmcode AS NVARCHAR(100))
		   FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE 
	       RTRIM(LTRIM(UPPER(ISNULL(DistributorStatus,'')))) NOT IN ('Active','InActive')
	END
	
	--Tax Group ID
	---Commnented by Gopi to dont take default value
	--SELECT @IDTTaxGroupId = ISNULL(MAX(TaxGroupId),0) FROM TaxGroupsetting WITH (NOLOCK) WHERE TaxGroup = 4
	
	DECLARE Cur_IDTMaster CURSOR FOR
	SELECT SpmCode,SpmName,SpmAdd1,ISNULL(SpmAdd2,''),ISNULL(SpmAdd3,''),ISNULL(SpmPhone,''),ISNULL(SpmFax,''),ISNULL(SpmEmail,''),
	ISNULL(SpmContact,''),CmpCode,ISNULL(SpmOnAcc,0.00),ISNULL(TaxGroupCode,''),ISNULL(StateCode,''),ISNULL(IDTDistributorType,''),
	ISNULL(GSTTIN,''),ISNULL(PanNumber,''),ISNULL(AadharNo,''),ISNULL(DistributorStatus,'')
	FROM CN2CS_Prk_IDTMaster WITH (NOLOCK) WHERE SpmCode NOT IN (SELECT SpmCode FROM @IDTToAvoid)
	OPEN Cur_IDTMaster 
	FETCH NEXT FROM Cur_IDTMaster INTO @SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,@SpmPhone,@SpmFax,@SpmMail,
	@SpmContact,@CmpCode,@SpmOnAcc,@TaxGroupCode,@StateCode,@DistType,@GSTTIN,@PanNumber,@AadharNo,@Status
	WHILE @@FETCH_STATUS= 0
	BEGIN
		  SET @Po_ErrNo = 0
		  
		  IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'IDTMaster','GSTIN','Invalid GST Tin Number for Distributor'+CAST(@Spmcode AS NVARCHAR(100))
					SET @Po_ErrNo =1
				END
			END
	
		  IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'IDTMaster','PanNumber','Invalid Pan Number for Distributor'+CAST(@Spmcode AS NVARCHAR(100))
					SET @Po_ErrNo =1
				END
			END
		  
		  IF @Po_ErrNo=0
		  BEGIN
		  
	      SELECT @SpmId = ISNULL(MAX(SpmId)+1,1) FROM IDTMaster WITH (NOLOCK)
	      SELECT @CoaId = ISNULL((MAX(CoaId)+1),1) FROM COAMaster WITH (NOLOCK)
	      SELECT @AccCode = ISNULL((MAX(CAST(AcCode AS NUMERIC(18,0)))+1),'1330001') FROM COAMaster WITH (NOLOCK)
	      WHERE AcLevel = 4 AND MainGroup = 1 AND Status = 2
	      SELECT @CmpId = CmpId FROM Company WITH (NOLOCK) WHERE CmpCode = @CmpCode
	      
	      ----Added by Gopi to consider downloaded tax group value---
	      SET @IDTTaxGroupId = (SELECT ISNULL(MAX(TaxGroupId),0) FROM TaxGroupsetting WITH (NOLOCK) WHERE TaxGroup = 3 and RtrGroup=@TaxGroupCode)
	      
	      --Coa Master
	      INSERT INTO COAMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
	      SELECT @CoaId,@AccCode,@SpmName,4,1,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)
	      
	      --IDT Master
	      INSERT INTO IDTMaster(SpmId,SpmCode,SpmName,SpmAdd1,SpmAdd2,SpmAdd3,SpmPhone,SpmFax,SpmEmail,SpmContact,SpmDefault,
	      CoaId,CmpId,TaxGroupId,SpmOnAcc,Availability,LastModBy,LastModDate,AuthId,AuthDate,SpmTinNo,SpmSupplier,VATTaxGroupId)
	      SELECT @SpmId,@SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,@SpmPhone,@SpmFax,@SpmMail,@SpmContact,0,@CoaId,@CmpId,@IDTTaxGroupId,
	      @SpmOnAcc,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),@GSTTIN,2,@IDTTaxGroupId
	      
	      --Counters
	      UPDATE Counters SET CurrValue = @CoaId WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
	      UPDATE Counters SET CurrValue = @SpmId WHERE TabName = 'IDTMaster' AND FldName = 'SpmId'
	      
	      ----UDC Details ----
	      
	      DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='IDT MASTER' AND [Column Code]=@SpmCode
	      
	      SET @StateName=(SELECT StateName from StateMaster(Nolock) where StateCode=@StateCode)
	      
	       IF RTRIM(LTRIM(UPPER(ISNULL(@StateName,''))))<>''
			BEGIN
				INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'IDT MASTER','State Name',@SpmCode,@StateName,0 
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'IDT MASTER','GSTIN',@SpmCode,@GSTTIN,0 
			END
		
		  IF RTRIM(LTRIM(UPPER(ISNULL(@Status,''))))<>''
			BEGIN
				INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'IDT MASTER','Status',@SpmCode,@Status,0 
			END
		
			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='IDT MASTER')
			BEGIN
				EXEC Proc_Validate_CN2CS_UdcDetails 0			
			END
	      
	    END
	
	FETCH NEXT FROM Cur_IDTMaster INTO @SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,@SpmPhone,@SpmFax,@SpmMail,
	@SpmContact,@CmpCode,@SpmOnAcc,@TaxGroupCode,@StateCode,@DistType,@GSTTIN,@PanNumber,@AadharNo,@Status
	END
	CLOSE Cur_IDTMaster
	DEALLOCATE Cur_IDTMaster	
	UPDATE A SET A.DownloadFlag = 'Y' FROM CN2CS_Prk_IDTMaster A WITH (NOLOCK),IDTMaster B WITH (NOLOCK) WHERE A.SpmCode = B.SpmCode
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_UpdateStockLedger_IDTApproval' AND XTYPE='P')
DROP PROCEDURE Proc_UpdateStockLedger_IDTApproval
GO
CREATE PROCEDURE Proc_UpdateStockLedger_IDTApproval
(
	@StkMgmtRefNo	VARCHAR(100),
	@Pi_ErrNo		INT OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_UpdateStockLedger
* PURPOSE	: To Update StockLedger
* CREATED	: Thrinath
* CREATED DATE	: 05/01/2007
* NOTE		: General SP for Updating StockLedger
* MODIFIED BY : Boopathy On 23/03/2009 For Updating the Con
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	26/02/2015	PRAVEENRAJ BHASKARAN Modified For IDT Approval
*********************************/
SET NOCOUNT ON
BEGIN
			DECLARE @Pi_ColId		INT
			DECLARE @Pi_Type		INT
			DECLARE @Pi_PrdId		INT
			DECLARE @Pi_PrdBatId	INT
			DECLARE @Pi_LcnId		INT
			DECLARE @Pi_TranDate	DateTime
			DECLARE @Pi_TranQty		Numeric(38,0)
			DECLARE @Pi_UsrId		INT
			DECLARE @PrdCnt			INT
			DECLARE @SlNo			INT
			
			Declare @sSql as VARCHAR(2500)
			Declare @FldName as VARCHAR(100)
			Declare @ErrNo as INT
			DECLARE @LastTranDate  DATETIME
			DECLARE @OldValue	AS NUMERIC(38,6)
			DECLARE @MaxDate AS DATETIME
			DECLARE @CurVal	 AS NUMERIC(38,6)
			DECLARE @LcnId INT
			
			CREATE TABLE #StockManagementProduct
			(
				SlNo			numeric(18,0) identity (1,1),
				StkMngRefNo		nvarchar(25) ,
				PrdId			int ,
				PrdBatId		int ,
				StockTypeId		int ,
				UOMId1			int ,
				Qty1			int ,
				UOMId2			int ,
				Qty2			int ,
				TotalQty		int ,
				Rate			numeric(18, 6) ,
				Amount			numeric(18, 6) ,
				ReasonId		int ,
				PriceId			bigint ,
				StkMgmtTypeId	int
			)
			SELECT @LcnId=LcnId FROM StockManagement (NOLOCK) WHERE StkMngRefNo=@StkMgmtRefNo
			INSERT INTO #StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,PriceId,StkMgmtTypeId)
			SELECT StkMngRefNo,PrdId,PrdBatId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,PriceId,StkMgmtTypeId FROM StockManagementProduct
			WHERE StkMngRefNo=@StkMgmtRefNo
			SET @SlNo=1
			SELECT @PrdCnt=ISNULL(COUNT(PrdId),0) FROM StockManagement S (NOLOCK)
			INNER JOIN #StockManagementProduct SP (NOLOCK) ON S.StkMngRefNo=SP.StkMngRefNo WHERE S.StkMngRefNo=@StkMgmtRefNo
			WHILE @PrdCnt>=@SlNo
			BEGIN
					SELECT @Pi_ColId=CASE B.SystemStockType WHEN 1 THEN 10 WHEN 2 THEN 11 ELSE 12 END,
					 @Pi_Type=1,		
					 @Pi_PrdId=PrdId,	
					 @Pi_PrdBatId=PrdBatId,
					 @Pi_LcnId=@LcnId,	
					 @Pi_TranDate=CONVERT(VARCHAR(10),GETDATE(),121),
					 @Pi_TranQty=TotalQty,
					 @Pi_UsrId=1 FROM #StockManagementProduct A INNER JOIN StockType B ON A.StockTypeId=B.StockTypeId 
					 WHERE SlNo=@SlNo
				
				
					IF EXISTS (SELECT PrdId FROM Product Where PrdId = @Pi_PrdId and PrdType = 3)
					BEGIN
						--IF Product is a KIT Item Return True
						Set @Pi_ErrNo = 0
						RETURN
					END
					
					SELECT @OldValue=SUM(((B.SalPurchase+B.UnsalPurchase)-(B.SalSales+B.UnSalSales)+
							(-B.SalPurReturn-B.UnsalPurReturn+B.SalStockIn+B.UnSalStockIn-
							B.SalStockOut-B.UnSalStockOut+B.SalSalesReturn+B.UnSalSalesReturn+
							B.SalStkJurIn+B.UnSalStkJurIn-B.SalStkJurOut-B.UnSalStkJurOut+
							B.SalBatTfrIn+B.UnSalBatTfrIn-B.SalBatTfrOut-B.UnSalBatTfrOut+
							B.SalLcnTfrIn+B.UnSalLcnTfrIn-B.SalLcnTfrOut-B.UnSalLcnTfrOut+
							B.SalReplacement+B.DamageIn-B.DamageOut)) * PrdBatDetailValue) --AS StkValue
							FROM ProductBatchDetails A, StockLedger B,BatchCreation C 
							WHERE A.PrdBatId=B.PrdbatId AND A.DefaultPrice=1
							AND A.BatchSeqId=C.BatchSeqId AND C.ListPrice=1 AND A.SlNo=C.SlNo
							AND B.TransDate=@Pi_TranDate AND B.PrdId=@Pi_PrdId AND B.PrdBatId=@Pi_PrdBatId
							AND B.LcnId=@Pi_LcnId
					SET @OldValue =ISNULL(@OldValue,0)
					IF NOT EXISTS (SELECT PrdId FROM StockLedger Where PrdId = @Pi_PrdId
					and PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId
					and TransDate = CONVERT(VARCHAR(10),@Pi_TranDate,121))
					BEGIN
						INSERT INTO StockLedger
						(
						TransDate,LcnId,PrdId,PrdBatId,SalOpenStock,UnSalOpenStock,
						OfferOpenStock,SalPurchase,UnsalPurchase,OfferPurchase,
						SalPurReturn,UnsalPurReturn,OfferPurReturn,
						SalSales,UnSalSales,OfferSales,SalStockIn,UnSalStockIn,
						OfferStockIn,SalStockOut,UnSalStockOut,OfferStockOut,DamageIn,
						DamageOut,SalSalesReturn,UnSalSalesReturn,OfferSalesReturn,
						SalStkJurIn,UnSalStkJurIn,OfferStkJurIn,SalStkJurOut,
						UnSalStkJurOut,OfferStkJurOut,SalBatTfrIn,UnSalBatTfrIn,
						OfferBatTfrIn,SalBatTfrOut,UnSalBatTfrOut,OfferBatTfrOut,
						SalLcnTfrIn,UnSalLcnTfrIn,OfferLcnTfrIn,SalLcnTfrOut,
						UnSalLcnTfrOut,OfferLcnTfrOut,SalReplacement,OfferReplacement,
						SalClsStock,UnSalClsStock,OfferClsStock,Availability,
						LastModBy,LastModDate,AuthId,AuthDate
						) VALUES
						(
						@Pi_TranDate,@Pi_LcnId,@Pi_PrdId,@Pi_PrdBatId,0,0,
						0,0,0,0,
						0,0,0,
						0,0,0,0,0,
						0,0,0,0,0,
						0,0,0,0,
						0,0,0,0,
						0,0,0,0,
						0,0,0,0,
						0,0,0,0,
						0,0,0,0,
						0,0,0,1,
						@Pi_UsrId,@Pi_TranDate,@Pi_UsrId,@Pi_TranDate
						)
					 END
						EXEC Proc_UpdateOpeningStock @Pi_PrdId,@Pi_PrdBatId,@Pi_LcnId,@Pi_TranDate,@Pi_UsrId,@ErrNo
					 IF EXISTS (SELECT * FROM DayEndProcess WHERE NextUpDate > @Pi_TranDate AND ProcId = 2)
					 BEGIN
						UPDATE DayEndProcess SET NextUpDate = @Pi_TranDate WHERE ProcId = 2
					 END
	
					 IF EXISTS (SELECT * FROM DayEndProcess WHERE NextUpDate > @Pi_TranDate AND ProcId = 11)
					 BEGIN
						UPDATE DayEndProcess SET NextUpDate = @Pi_TranDate WHERE ProcId = 11
					 END
				 IF @Pi_ColId BETWEEN 7 AND 9
				 BEGIN
					IF EXISTS (SELECT * FROM DayEndProcess WHERE NextUpDate > @Pi_TranDate AND ProcId = 1)
					BEGIN
						UPDATE DayEndProcess SET NextUpDate = @Pi_TranDate WHERE ProcId = 1
					END
				 END
				 IF @Pi_ColId BETWEEN 1 AND 3
				 BEGIN
					IF EXISTS (SELECT * FROM DayEndProcess WHERE NextUpDate > @Pi_TranDate AND ProcId = 3)
					BEGIN
						UPDATE DayEndProcess SET NextUpDate = @Pi_TranDate WHERE ProcId = 3
					END
				 END
				 IF @Pi_ColId BETWEEN 18 AND 20
				 BEGIN
					IF EXISTS (SELECT * FROM DayEndProcess WHERE NextUpDate > @Pi_TranDate AND ProcId = 4)
					BEGIN
						UPDATE DayEndProcess SET NextUpDate = @Pi_TranDate WHERE ProcId = 4
					END
				 END
				 Select @FldName = CASE @Pi_ColId
					  WHEN 1 THEN 'SalPurchase'
					  WHEN 2 THEN 'UnsalPurchase'
					  WHEN 3 THEN 'OfferPurchase'
					  WHEN 4 THEN 'SalPurReturn'
					  WHEN 5 THEN 'UnsalPurReturn'
					  WHEN 6 THEN 'OfferPurReturn'
					  WHEN 7 THEN 'SalSales'
					  WHEN 8 THEN 'UnSalSales'
					  WHEN 9 THEN 'OfferSales'
					  WHEN 10 THEN 'SalStockIn'
					  WHEN 11 THEN 'UnSalStockIn'
					  WHEN 12 THEN 'OfferStockIn'
					  WHEN 13 THEN 'SalStockOut'
					  WHEN 14 THEN 'UnSalStockOut'
					  WHEN 15 THEN 'OfferStockOut'
					  WHEN 16 THEN 'DamageIn'
					  WHEN 17 THEN 'DamageOut'
					  WHEN 18 THEN 'SalSalesReturn'
					  WHEN 19 THEN 'UnSalSalesReturn'
					  WHEN 20 THEN 'OfferSalesReturn'
					  WHEN 21 THEN 'SalStkJurIn'
					  WHEN 22 THEN 'UnSalStkJurIn'
					  WHEN 23 THEN 'OfferStkJurIn'
					  WHEN 24 THEN 'SalStkJurOut'
					  WHEN 25 THEN 'UnSalStkJurOut'
					  WHEN 26 THEN 'OfferStkJurOut'
					  WHEN 27 THEN 'SalBatTfrIn'
					  WHEN 28 THEN 'UnSalBatTfrIn'
					  WHEN 29 THEN 'OfferBatTfrIn'
					  WHEN 30 THEN 'SalBatTfrOut'
					  WHEN 31 THEN 'UnSalBatTfrOut'
					  WHEN 32 THEN 'OfferBatTfrOut'
					  WHEN 33 THEN 'SalLcnTfrIn'
					  WHEN 34 THEN 'UnSalLcnTfrIn'
					  WHEN 35 THEN 'OfferLcnTfrIn'
					  WHEN 36 THEN 'SalLcnTfrOut'
					  WHEN 37 THEN 'UnSalLcnTfrOut'
					  WHEN 38 THEN 'OfferLcnTfrOut'
					  WHEN 39 THEN 'SalReplacement'
					  WHEN 40 THEN 'OfferReplacement' END
						SET @Pi_ErrNo = 0
					 IF (@Pi_ColId = 4  OR @Pi_ColId = 7  OR @Pi_ColId = 13
						 OR @Pi_ColId = 24 OR @Pi_ColId = 30 OR @Pi_ColId = 36 OR @Pi_ColId = 39) AND @Pi_Type = 1
					 BEGIN
						  IF EXISTS (SELECT PrdId FROM StockLedger Where PrdId = @Pi_PrdId
						   AND PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId
						   AND TransDate = CONVERT(VARCHAR(10),@Pi_TranDate,121)
						   AND (SalOpenStock    +
								SalPurchase     +
								SalStockIn    +
								SalSalesReturn   +
								SalStkJurIn   +
								SalBatTfrIn   +
								SalLcnTfrIn   -
								SalPurReturn   -
								SalSales     -
								SalStockOut  -	
								SalStkJurOut   -
								SalBatTfrOut   -
								SalLcnTfrOut   -
								SalReplacement) < @Pi_TranQty)
							  BEGIN
								   SET @Pi_ErrNo = 1
							  END
					 END
					 IF (@Pi_ColId = 5 OR @Pi_ColId = 8 OR @Pi_ColId = 14 OR @Pi_ColId = 17
						 OR @Pi_ColId = 25 OR @Pi_ColId = 31 OR @Pi_ColId = 37) AND @Pi_Type = 1
					 BEGIN
						  IF EXISTS (SELECT PrdId FROM StockLedger Where PrdId = @Pi_PrdId
						   AND PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId
						   AND TransDate = CONVERT(VARCHAR(10),@Pi_TranDate,121)
						   AND (UnSalOpenStock    +
								UnSalPurchase   +
								UnSalStockIn    +
								DamageIn      +
								UnSalSalesReturn  +
								UnSalStkJurIn    +
								UnSalBatTfrIn   +
								UnSalLcnTfrIn    -
								UnsalPurReturn  -
								UnSalSales   -
								UnSalStockOut   -
								DamageOut    -
								UnSalStkJurOut   -
								UnSalBatTfrOut   -
								UnSalLcnTfrOut) < @Pi_TranQty)
							  BEGIN
								   SET @Pi_ErrNo = 1
							  END
					 END
					 IF (@Pi_ColId = 6 OR @Pi_ColId = 9 OR @Pi_ColId = 15 OR @Pi_ColId = 26
						  OR @Pi_ColId = 32 OR @Pi_ColId = 38 OR @Pi_ColId = 40) AND @Pi_Type = 1
					 BEGIN
						  IF EXISTS (SELECT PrdId FROM StockLedger Where PrdId = @Pi_PrdId
						   AND PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId
						   AND TransDate = CONVERT(VARCHAR(10),@Pi_TranDate,121)
						   AND (OfferOpenStock    +
								OfferPurchase    +
								OfferStockIn     +
								OfferSalesReturn   +
								OfferStkJurIn   +
								OfferBatTfrIn   +
								OfferLcnTfrIn   -
								OfferPurReturn   -
								OfferSales      -
								OfferStockOut   -
								OfferStkJurOut   -
								OfferBatTfrOut   -
								OfferLcnTfrOut   -
								OfferReplacement) < @Pi_TranQty)
							  BEGIN
								   SET @Pi_ErrNo = 1
							  END
					 END
					 IF @Pi_ErrNo = 0
					 BEGIN
						  SET @sSql = 'Update StockLedger Set ' + @FldName + ' = ' + @FldName + ' + '
						  SET @sSql = @sSql + CASE @Pi_Type WHEN 2 Then '-1' Else '1' End + '* '
						  SET @sSql = @sSql + CAST(@Pi_TranQty as VARCHAR(10))
						  SET @sSql = @sSql + ', LastModDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
						  SET @sSql = @sSql + ', AuthDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
						  SET @sSql = @sSql + ', LastModBy = ' + CAST(@Pi_UsrId as VARCHAR(10))
						  SET @sSql = @sSql + ', AuthId = ' + CAST(@Pi_UsrId as VARCHAR(10)) + ' Where'
						  SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
						  SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
						  SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
						  SET @sSql = @sSql + ' AND TransDate = ''' + CONVERT(VARCHAR(10),@Pi_TranDate,121) + ''''
						  Exec (@sSql)
					
						  EXEC Proc_UpdateClosingStock @Pi_PrdId,@Pi_PrdBatId,@Pi_LcnId,@Pi_TranDate,@Pi_UsrId,@Pi_ClsErrNo = @ErrNo OutPut
						  IF @Pi_ErrNo = 0 AND @ErrNo = 1
						  BEGIN
							   Set @Pi_ErrNo = 1
						  END
						  Select @LastTranDate = ISNULL(MAX(TransDate),CONVERT(VARCHAR(10),'1981-05-30',121)) from
						   StockLedger where PrdId=@Pi_PrdId and PrdBatId=@Pi_PrdBatId
						   and LcnId=@Pi_LcnId and TransDate > @Pi_TranDate
						  IF @LastTranDate <> '1981-05-30'
						  BEGIN
							   SELECT @Pi_TranDate = DATEADD(DAY,1,@Pi_TranDate)
							   WHILE @Pi_TranDate <= @LastTranDate
							   BEGIN
									EXEC Proc_UpdateOpeningStock @Pi_PrdId,@Pi_PrdBatId,@Pi_LcnId,@Pi_TranDate,@Pi_UsrId,@Pi_OpnErrNo = @ErrNo OutPut
									SELECT @Pi_TranDate = DATEADD(DAY,1,@Pi_TranDate)
									IF @Pi_ErrNo = 0 AND @ErrNo = 1
									BEGIN
										 Set @Pi_ErrNo = 1
									END
							   END
						  END
 							IF EXISTS (SELECT TransDate FROM ConsolidateStockLedger WHERE 
										TransDate=@Pi_TranDate)
							BEGIN
										SELECT @CurVal=SUM(((B.SalPurchase+B.UnsalPurchase)-(B.SalSales+B.UnSalSales)+
										(-B.SalPurReturn-B.UnsalPurReturn+B.SalStockIn+B.UnSalStockIn-
										B.SalStockOut-B.UnSalStockOut+B.SalSalesReturn+B.UnSalSalesReturn+
										B.SalStkJurIn+B.UnSalStkJurIn-B.SalStkJurOut-B.UnSalStkJurOut+
										B.SalBatTfrIn+B.UnSalBatTfrIn-B.SalBatTfrOut-B.UnSalBatTfrOut+
										B.SalLcnTfrIn+B.UnSalLcnTfrIn-B.SalLcnTfrOut-B.UnSalLcnTfrOut+
										B.SalReplacement+B.DamageIn-B.DamageOut)) * PrdBatDetailValue) --AS StkValue
										FROM ProductBatchDetails A, StockLedger B,BatchCreation C 
										WHERE A.PrdBatId=B.PrdbatId AND A.DefaultPrice=1
										AND A.BatchSeqId=C.BatchSeqId AND C.ListPrice=1 AND A.SlNo=C.SlNo
										AND B.TransDate=@Pi_TranDate AND B.PrdId=@Pi_PrdId AND B.PrdBatId=@Pi_PrdBatId
										AND B.LcnId=@Pi_LcnId
										UPDATE ConsolidateStockLedger SET StockValue=  StockValue + ABS(@OldValue) - ABS(@CurVal) ---(@CurStkVal*-1)
										WHERE TransDate=@Pi_TranDate
							
										UPDATE ConsolidateStockLedger SET StockValue=  StockValue + ABS(@OldValue)  - ABS(@CurVal) --(@CurStkVal*-1)
										WHERE TransDate>@Pi_TranDate
							END
							ELSE
							BEGIN
								INSERT INTO ConsolidateStockLedger
									SELECT @Pi_TranDate,ISNULL((@Pi_TranQty * PrdBatDetailValue),0) AS StkValue
									FROM ProductBatchDetails A, StockLedger B,BatchCreation C 
									WHERE A.PrdBatId=B.PrdbatId AND A.DefaultPrice=1
									AND A.BatchSeqId=C.BatchSeqId AND C.ListPrice=1 AND A.SlNo=C.SlNo
									AND B.TransDate=@Pi_TranDate AND B.PrdId=@Pi_PrdId AND B.PrdBatId=@Pi_PrdBatId
									AND B.LcnId=@Pi_LcnId
									SELECT @CurVal=StockValue FROM ConsolidateStockLedger WHERE TransDate=@Pi_TranDate
									SELECT @MaxDate=MAX(TransDate) FROM ConsolidateStockLedger WHERE TransDate<@Pi_TranDate
									UPDATE ConsolidateStockLedger SET StockValue=  @CurVal + (SELECT StockValue FROM
									ConsolidateStockLedger WHERE TransDate=@MaxDate) WHERE TransDate=@Pi_TranDate
							END
					END
					IF @Pi_ErrNo = 0
					BEGIN
						IF NOT EXISTS(SELECT * FROM StockLedgerDateCheck WHERE LastTransDate>=@Pi_TranDate)
						BEGIN
							TRUNCATE TABLE StockLedgerDateCheck 
							INSERT INTO StockLedgerDateCheck(LastColId,LastTransDate)
							VALUES(@Pi_ColId,@Pi_TranDate)
						END	
					END
				
				SET @SlNo=@SlNo+1		
			END
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_UpdateProductBatchLocation_IDTApproval' AND XTYPE='P')
DROP PROCEDURE Proc_UpdateProductBatchLocation_IDTApproval
GO
--exec Proc_UpdateProductBatchLocation 1,2,1,8,5,'2006-02-15',150,1,0
CREATE PROCEDURE Proc_UpdateProductBatchLocation_IDTApproval
(
	@StkMgmtRefNo	VARCHAR(100),
	@Pi_ErrNo		INT	OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_UpdateProductBatchLocation
* PURPOSE	: To Update ProductBatchLocation 
* CREATED	: Thrinath
* CREATED DATE	: 05/01/2007
* NOTE		: General SP for Updating ProductBatchLocation
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}      
	26/02/2015	PRAVEENRAJ BHASKARAN Modified For IDT Approval
*********************************/ 
SET NOCOUNT ON
Begin
	Declare @sSql as VARCHAR(2500)
	Declare @FldName as VARCHAR(100)
	Declare @StkChkFldName as VARCHAR(100)
	Declare @ErrNo as INT
	DECLARE @LastTranDate 	DATETIME
	DECLARE @Pi_ColId 		INT
	DECLARE @Pi_Type		INT
	DECLARE @Pi_PrdId		INT
	DECLARE @Pi_PrdBatId	INT
	DECLARE @Pi_LcnId		INT
	DECLARE @Pi_TranDate	DateTime
	DECLARE @Pi_TranQty		Numeric(38,0)
	DECLARE @Pi_UsrId		INT
	DECLARE @PrdCnt			INT
	DECLARE @SlNo			INT
	DECLARE @LcnId			INT
	
		CREATE TABLE #StockManagementProduct
		(
			SlNo			numeric(18,0) identity (1,1),
			StkMngRefNo		nvarchar(25) ,
			PrdId			int ,
			PrdBatId		int ,
			StockTypeId		int ,
			UOMId1			int ,
			Qty1			int ,
			UOMId2			int ,
			Qty2			int ,
			TotalQty		int ,
			Rate			numeric(18, 6) ,
			Amount			numeric(18, 6) ,
			ReasonId		int ,
			PriceId			bigint ,
			StkMgmtTypeId	int
		)
			SELECT @LcnId=LcnId FROM StockManagement (NOLOCK) WHERE StkMngRefNo=@StkMgmtRefNo
			INSERT INTO #StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,PriceId,StkMgmtTypeId)
			SELECT StkMngRefNo,PrdId,PrdBatId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,PriceId,StkMgmtTypeId FROM StockManagementProduct
			WHERE StkMngRefNo=@StkMgmtRefNo
			SET @SlNo=1
			SELECT @PrdCnt=ISNULL(COUNT(PrdId),0) FROM StockManagement S (NOLOCK)
			INNER JOIN #StockManagementProduct SP (NOLOCK) ON S.StkMngRefNo=SP.StkMngRefNo WHERE S.StkMngRefNo=@StkMgmtRefNo
			WHILE @PrdCnt>=@SlNo
			BEGIN
					SELECT @Pi_ColId=B.SystemStockType,
					@Pi_Type=1,
					@Pi_PrdId=Prdid,
					@Pi_PrdBatId=PrdBatId,
					@Pi_LcnId=@LcnId,
					@Pi_TranDate=CONVERT(VARCHAR(10),GETDATE(),121),
					@Pi_TranQty=TotalQty,
					@Pi_UsrId=1
					FROM #StockManagementProduct A INNER JOIN StockType B ON A.StockTypeId=B.StockTypeId WHERE SlNo=@SlNo
					 
					IF EXISTS (SELECT PrdId FROM Product Where PrdId = @Pi_PrdId and PrdType = 3)
					BEGIN
						--IF Product is a KIT Item Return True
						Set @Pi_ErrNo = 0
						RETURN
					END

					IF NOT EXISTS (SELECT PrdId FROM ProductBatchLocation Where PrdId = @Pi_PrdId
						and PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId)
					BEGIN
						INSERT INTO ProductBatchLocation
						(
							LcnId,PrdId,PrdBatId,PrdBatLcnSih,PrdBatLcnUih,PrdBatLcnfre,
							PrdBatLcnResSih,PrdBatLcnResUih,PrdBatLcnResFre,
							Availability,LastModBy,LastModDate,AuthId,AuthDate
						) VALUES
						(
							@Pi_LcnId,@Pi_PrdId,@Pi_PrdBatId,0,0,0,
							0,0,0,
							1,@Pi_UsrId,@Pi_TranDate,@Pi_UsrId,@Pi_TranDate
						)
					END
					Select @FldName = CASE @Pi_ColId WHEN 1 THEN 'PrdBatLcnSih'
						WHEN 2 THEN 'PrdBatLcnUih'
						WHEN 3 THEN 'PrdBatLcnfre'
						WHEN 4 THEN 'PrdBatLcnResSih'
						WHEN 5 THEN 'PrdBatLcnResUih'
						WHEN 6 THEN 'PrdBatLcnResFre' END

					Select @StkChkFldName = CASE @Pi_ColId - 3 WHEN 1 THEN 'PrdBatLcnSih'
						WHEN 2 THEN 'PrdBatLcnUih'
						WHEN 3 THEN 'PrdBatLcnfre' END
			
					SET @Pi_ErrNo = 0
					IF @Pi_Type = 2 
					BEGIN
						Create Table #CheckStock 
						(	
							PrdId int
						)
						
						SET @sSql = ' Insert Into #CheckStock (Prdid) '
						SET @sSql = @sSql + 'Select Prdid From ProductBatchLocation Where'
						SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
						SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
						SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
						SET @sSql = @sSql + ' AND '  + @FldName + ' < ' + CAST(@Pi_TranQty as VARCHAR(10))
						
						Exec (@sSql)

						IF Exists(Select * From #CheckStock)
						BEGIN
							SET @Pi_ErrNo = 1
						END
					
						DROP TABLE #CheckStock 
					END
					IF @Pi_Type = 1 AND @Pi_ColId > 3
					BEGIN
						Create Table #CheckStock1 
						(	
							prdid int
						)
						
						SET @sSql = ' Insert Into #CheckStock1 (Prdid) '
						SET @sSql = @sSql + 'Select Prdid From ProductBatchLocation Where'
						SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
						SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
						SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
						SET @sSql = @sSql + ' AND ' + @StkChkFldName + ' < ' + @FldName + ' + ' 
						SET @sSql = @sSql + CAST(@Pi_TranQty as VARCHAR(10))
					
						Exec (@sSql)

						IF Exists(Select * From #CheckStock1)
						BEGIN
							SET @Pi_ErrNo = 1
						END
					
						DROP TABLE #CheckStock1 
					END
					IF @Pi_ErrNo = 0
					BEGIN
						SET @sSql = 'Update ProductBatchLocation Set ' + @FldName + ' = ' + @FldName + ' + '
						SET @sSql = @sSql + CASE @Pi_Type WHEN 2 Then '-1' Else '1' End + '* ' 
						SET @sSql = @sSql + CAST(@Pi_TranQty as VARCHAR(10)) 
						SET @sSql = @sSql + ', LastModDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
						SET @sSql = @sSql + ', AuthDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
						SET @sSql = @sSql + ', LastModBy = ' + CAST(@Pi_UsrId as VARCHAR(10))
						SET @sSql = @sSql + ', AuthId = ' + CAST(@Pi_UsrId as VARCHAR(10)) + ' Where'
						SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
						SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
						SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
					
						Exec (@sSql)
					End
				SET @SlNo=@SlNo+1
			END
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_Prk_IDTManagementApproval' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_Prk_IDTManagementApproval
GO
/*
	BEGIN TRAN
	DELETE FROM ErrorLog	
	EXEC Proc_Cn2Cs_Prk_IDTManagementApproval 0
	SELECT * FROM Cn2Cs_Prk_IDTManagementApproval
	--SELECT * FROM StockManagement Where StkMngRefNo='STM1400028'
	--SELECT * FROM StockManagementProduct WHERE StkMngRefNo='STM1400028'
	----SELECT * from Counters Where TabName='StockManagement'
	SELECT * FROM ErrorLog
	ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_Prk_IDTManagementApproval
(
	@Po_ErrNo INT OUT
)
AS
/*********************************
* PROCEDURE	: Proc_Cn2Cs_Prk_IDTManagementApproval
* PURPOSE	: To Download And validate IDT Managment Stock Details
* CREATED	: PRAVEENRAJ BHASKARAN
* CREATED DATE	: 26/02/2015
* NOTE		: General SP for Updating ProductBatchLocation
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}      
		 Modified For IDT Approval
* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Management UDC Added
*********************************/ 
SET NOCOUNT ON
BEGIN
		SET @Po_ErrNo=0
		DELETE Prk FROM Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE DownloadFlag='Y'
		SELECT * INTO #Cn2Cs_Prk_IDTManagementApproval FROM Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE DownloadFlag='D'
		IF NOT EXISTS (SELECT * FROM #Cn2Cs_Prk_IDTManagementApproval) RETURN
		DELETE Err FROM ErrorLog Err (NOLOCK) WHERE TableName='Cn2Cs_Prk_IDTManagementApproval'
		
		CREATE TABLE #IDTTOAvoid
		(
			IdtMngRefNo VARCHAR(50)
		)
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS 
		(SELECT DistributorCode FROM Distributor D (NOLOCK) WHERE D.DistributorCode=Prk.DistCode)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 1,'Cn2Cs_Prk_IDTManagementApproval','DistributorCode','Distributor Code Not Exists For the IDT -->'+Prk.IdtMngRefNo
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS 
		(SELECT DistributorCode FROM Distributor D (NOLOCK) WHERE D.DistributorCode=Prk.DistCode)
		
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT I.IDTMngRefNo FROM IDTManagement I (NOLOCK) WHERE Prk.IdtMngRefNo=I.IDTMngRefNo)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 2,'Cn2Cs_Prk_IDTManagementApproval','IdtMngRefNo','IDT Mng RefNo Not Exists For the IDT -->'+Prk.IdtMngRefNo
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT I.IDTMngRefNo FROM IDTManagement I (NOLOCK) WHERE Prk.IdtMngRefNo=I.IDTMngRefNo)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT IM.SpmCode FROM IDTMaster IM (NOLOCK) INNER JOIN IDTManagement I (NOLOCK) ON I.SpmId=IM.SpmId
		WHERE IM.SpmCode=Prk.SpmCode)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 3,'Cn2Cs_Prk_IDTManagementApproval','SpmCode','Supplier Not Exists For the IDT -->'+Prk.IdtMngRefNo
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT IM.SpmCode FROM IDTMaster IM (NOLOCK) INNER JOIN IDTManagement I (NOLOCK) ON I.SpmId=IM.SpmId
		WHERE IM.SpmCode=Prk.SpmCode)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT L.LcnCode FROM Location L (NOLOCK) INNER JOIN IDTManagement I (NOLOCK) ON I.LcnId=L.LcnId WHERE Prk.LcnCode=L.LcnCode)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 4,'Cn2Cs_Prk_IDTManagementApproval','LcnCode','Location Not Exists For the IDT -->'+Prk.IdtMngRefNo
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT L.LcnCode FROM Location L (NOLOCK) INNER JOIN IDTManagement I (NOLOCK) ON I.LcnId=L.LcnId WHERE Prk.LcnCode=L.LcnCode)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT I.IDTMngRefNo,P.PrdCCode FROM IDTManagement I (NOLOCK) INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 5,'Cn2Cs_Prk_IDTManagementApproval','PrdCCode','Product Code Not Exists For the IDT -->'+Prk.IdtMngRefNo
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS
		(SELECT I.IDTMngRefNo,P.PrdCCode FROM IDTManagement I (NOLOCK) INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS(
		SELECT I.IDTMngRefNo,P.PrdCCode,PB.PrdBatCode FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId 
		INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdBatId=IP.PrdBatId AND P.PrdId=PB.PrdId AND PB.PrdId=IP.PrdId
		WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode AND Prk.PrdBatCode=PB.PrdBatCode)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 6,'Cn2Cs_Prk_IDTManagementApproval','PrdBatCode','Product Batch Not Exists For the IDT -->'+Prk.IdtMngRefNo+' AND Product -->'+Prk.PrdCCode
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS(
		SELECT I.IDTMngRefNo,P.PrdCCode,PB.PrdBatCode FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId 
		INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdBatId=IP.PrdBatId AND P.PrdId=PB.PrdId AND PB.PrdId=IP.PrdId
		WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode AND Prk.PrdBatCode=PB.PrdBatCode)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		INSERT INTO #IDTTOAvoid (IdtMngRefNo)
		SELECT Prk.IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS(
		SELECT I.IDTMngRefNo,P.PrdCCode,PB.PrdBatCode,ST.UserStockType FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId 
		INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdBatId=IP.PrdBatId AND P.PrdId=PB.PrdId AND PB.PrdId=IP.PrdId
		INNER JOIN StockType ST ON ST.StockTypeId=IP.StockTypeId
		WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode AND Prk.PrdBatCode=PB.PrdBatCode AND Prk.StkType=ST.UserStockType)
		
		INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
		SELECT 7,'Cn2Cs_Prk_IDTManagementApproval','StkType','Stock Type Not Exists For the IDT -->'+Prk.IdtMngRefNo+' AND Product -->'+Prk.PrdCCode
		FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE NOT EXISTS(
		SELECT I.IDTMngRefNo,P.PrdCCode,PB.PrdBatCode,ST.UserStockType FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProduct IP (NOLOCK) ON I.IDTMngRefNo=IP.IDTMngRefNo
		INNER JOIN Product P (NOLOCK) ON P.PrdId=IP.PrdId 
		INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdBatId=IP.PrdBatId AND P.PrdId=PB.PrdId AND PB.PrdId=IP.PrdId
		INNER JOIN StockType ST ON ST.StockTypeId=IP.StockTypeId
		WHERE Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
		AND Prk.PrdCCode=P.PrdCCode AND Prk.PrdBatCode=PB.PrdBatCode AND Prk.StkType=ST.UserStockType)
		
		DELETE Prk FROM #IDTTOAvoid D (NOLOCK) INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) ON Prk.IdtMngRefNo=D.IdtMngRefNo
		
		DELETE Prk FROM #Cn2Cs_Prk_IDTManagementApproval Prk (NOLOCK) WHERE (BaseQty-AppQty)<=0
		
		IF NOT EXISTS (SELECT * FROM #Cn2Cs_Prk_IDTManagementApproval) RETURN
		
		DECLARE @IDTCnt			INT
		DECLARE @SlNo			INT
		DECLARE @IdtMngRefNo	VARCHAR(50)
		DECLARE @GetKeyStr		VARCHAR(50)
		DECLARE @BaseUomId 		INT
		DECLARE @ReasonId		INT
		DECLARE @StkMgmtTypeId  INT		
		CREATE TABLE #IDTCount (Slno INT IDENTITY (1,1),IdtMngRefNo VARCHAR(50))
		CREATE TABLE #PrdBatLcnNotExists (PrdId INT,PrdBatId BIGINT,LcnId INT,StockTypeId INT,StockMgmtTypeId INT,Qty BIGINT)
		
		INSERT INTO #IDTCount(IdtMngRefNo)		
		SELECT DISTINCT IdtMngRefNo FROM #Cn2Cs_Prk_IDTManagementApproval (NOLOCK)
		SET @SlNo=1
		SELECT @IDTCnt=COUNT(DISTINCT IdtMngRefNo) FROM #Cn2Cs_Prk_IDTManagementApproval (NOLOCK)
				
		SELECT DISTINCT TOP 1 @BaseUomId=M.UomId FROM UomGroup U INNER JOIN UomMaster M ON U.UomId=M.UomId
		WHERE BaseUom='Y' AND ConversionFactor=1
		
		SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE StkMgmtTypeId=1
		IF @StkMgmtTypeId<=0 SET @StkMgmtTypeId=1
		
		SELECT MAX(LP.PrdBatId) PrdBatID,MAX(LP.PriceId) PriceId , MAX(Convert(Numeric(18,6),LP.MRP)) MRP ,  
		MAX(Convert(Numeric(18,6),LP.ListPrice)) ListPrice ,MAX(Convert(Numeric(18,6),LP.SelRate)) SelRate , 
		Max(Convert(Numeric(18,6),LP.ClmRate)) ClmRate INTO #PriceDetails
		FROM (SELECT PBD.PrdBatId,PBD.PriceId, CASE BC.MRP WHEN 1 THEN PBD.PrdBatDetailValue ELSE 0 END MRP,  
		CASE BC.ListPrice WHEN 1 Then PBD.PrdBatDetailValue ELSE 0 END ListPrice, CASE  BC.SelRte WHEN 1 Then PBD.PrdBatDetailValue ELSE 0 END SelRate,  
		CASE BC.ClmRte WHEN 1 Then PBD.PrdBatDetailValue ELSE 0 END ClmRate  FROM ProductBatchDetails PBD (NOLOCK), 
		BatchCreation BC (NOLOCK) WHERE  PBD.DefaultPrice=1 
		AND PBD.SlNo = BC.SlNo  AND BC.BatchSeqId=PBD.BatchSeqId ) LP GROUP BY LP.PrdBatId,LP.PriceId
		
		SELECT @ReasonId=R.ReasonId FROM ReasonMaster R (NOLOCK) WHERE ReasonCode='IDT'
		
		WHILE @IDTCnt>=@SlNo
		BEGIN
		BEGIN TRY
		BEGIN TRANSACTION
		SET XACT_ABORT ON
			SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('StockManagement','StkMngRefNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))

			IF LEN(LTRIM(RTRIM(@GetKeyStr)))>0
			BEGIN
				
				SELECT @IdtMngRefNo=IdtMngRefNo FROM #IDTCount (NOLOCK) WHERE Slno=@Slno
				
				INSERT INTO StockManagement (StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,OpenBal,
											 Status,Availability,LastModBy,LastModDate,AuthId,AuthDate,ConfigValue,XMLUpload,VatGst)
				SELECT @GetKeyStr,CONVERT(VARCHAR(10),GETDATE(),121),L.LcnId,ISNULL(@StkMgmtTypeId,0),0,0,@IdtMngRefNo,
				'Stock Transfer For IDT Reference Number '+@IdtMngRefNo,2,0,1,1,1,GETDATE(),1,GETDATE(),0,0,'GST' FROM IDTManagement I
				INNER JOIN Location L ON L.LcnId=I.LcnId
				INNER JOIN 
				(SELECT DISTINCT IdtMngRefNo,LcnCode FROM #Cn2Cs_Prk_IDTManagementApproval ) Prk ON Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.LcnCode=L.LcnCode
				WHERE I.IdtMngRefNo=@IdtMngRefNo
				
				INSERT INTO StockManagementProduct (StkMngRefNo,PrdId,PrdBatId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,
													ReasonId,PriceId,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxAmt,StkMgmtTypeId)
				SELECT @GetKeyStr,IP.PrdId,IP.PrdBatId,ST.StockTypeId,@BaseUomId,(BaseQty-AppQty),0,0,(BaseQty-AppQty),
				PR.ListPrice,(BaseQty-AppQty)*PR.ListPrice,@ReasonId,PR.PriceId,1,1,GETDATE(),1,GETDATE(),0,ISNULL(@StkMgmtTypeId,0) FROM IDTManagement I
				INNER JOIN IDTManagementProduct IP ON I.IDTMngRefNo=IP.IDTMngRefNo
				INNER JOIN #Cn2Cs_Prk_IDTManagementApproval Prk ON Prk.IdtMngRefNo=I.IDTMngRefNo AND Prk.IdtMngRefNo=IP.IDTMngRefNo
				INNER JOIN Product P ON P.PrdId=IP.PrdId AND P.PrdCCode=Prk.PrdCCode
				INNER JOIN ProductBatch PB ON P.PrdId=PB.PrdId AND PB.PrdBatCode=Prk.PrdBatCode AND PB.PrdBatId=IP.PrdBatId
				INNER JOIN #PriceDetails PR ON PR.PrdBatID=PB.PrdBatId AND PB.DefaultPriceId=PR.PriceId AND PR.PriceId=IP.PriceId
				INNER JOIN StockType ST ON ST.StockTypeId=IP.StockTypeId AND ST.UserStockType=Prk.StkType
				WHERE I.IdtMngRefNo=@IdtMngRefNo
				IF @Po_ErrNo=0
				BEGIN
					EXEC Proc_UpdateStockLedger_IDTApproval @GetKeyStr,@Pi_ErrNo=@Po_ErrNo OUTPUT					
					IF @Po_ErrNo=0
					BEGIN
						EXEC Proc_UpdateProductBatchLocation_IDTApproval @GetKeyStr,@Pi_ErrNo=@Po_ErrNo OUTPUT
					END
				END
				IF @Po_ErrNo>0
				BEGIN
					ROLLBACK TRANSACTION
					INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc) VALUES (8,'Cn2Cs_Prk_IDTManagementApproval','UnKnown',ERROR_MESSAGE())
					SELECT 'Download'
				END			
				UPDATE Cnt SET CurrValue=CurrValue+1 FROM Counters Cnt (NOLOCK) WHERE TabName='StockManagement' AND FldName='StkMngRefNo'
				
				UPDATE Prk SET Prk.DownloadFlag='Y' FROM #Cn2Cs_Prk_IDTManagementApproval Tmp 
				INNER JOIN Cn2Cs_Prk_IDTManagementApproval Prk ON Tmp.IdtMngRefNo=Prk.IdtMngRefNo AND Tmp.SpmCode=Prk.SpmCode
				AND	Tmp.LcnCode=Prk.LcnCode	AND	Tmp.PrdCCode=Prk.PrdCCode AND Tmp.PrdBatCode=Prk.PrdBatCode	AND	Tmp.StkType=Prk.StkType
				INNER JOIN StockManagement SM ON SM.DocRefNo=Prk.IdtMngRefNo AND SM.DocRefNo=Tmp.IdtMngRefNo
				
				SET @SlNo=@SlNo+1
			END
			COMMIT TRANSACTION
			END TRY	
				BEGIN CATCH
					ROLLBACK TRANSACTION
					SET @Po_ErrNo=1
					INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc) VALUES (8,'Cn2Cs_Prk_IDTManagementApproval','UnKnown',ERROR_MESSAGE())
					SELECT 'Download'
				END CATCH
		END
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR1_B2B' AND XTYPE='P')
DROP PROCEDURE Proc_RptGSTR1_B2B
GO
/*
EXEC Proc_RptGSTR1_B2B 414,1,0,'',0,0,0
*/
CREATE PROCEDURE Proc_RptGSTR1_B2B
(
	
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptGSTR1_B2B
* PURPOSE		: To Generate a report GSTR1 B2B
* CREATED		: Murugan.R
* CREATED DATE	: 13/04/2017
* MODIFIED
------------------------------------------------
* DATE            AUTHOR				 CR/BZ			USER STORY ID			 DESCRIPTION   
* 20-06-2018	  Mohanakrishna A.B 	  BZ			ILCRSTNIV0351         IDT TAX AMOUNT NOT SHOWING
* 17-08-2018	  Muthulakshmi.V	      BZ	        ILCRSTNIV0599		  GSTR1 Report - REFRESH ISSUE FIX
* 12/03/2019    Venkat. M           ILCRSTZYD1119				Included KERALA CESS Tax
* 01-09-2020	Venkat. M		PARCS202100064		SR			IDT Management
*********************************/
SET NOCOUNT ON
BEGIN
		TRUNCATE TABLE RptGSTR1_B2B
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		--ILCRSTNIV0599 From here
		DELETE FROM  ReportFilterDt WHERE RptId IN(414,415,416,417,418,419,420,421) 
		INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)
		SELECT 414,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 415,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 416,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 417,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 418,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId	
		UNION ALL
		SELECT 419,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 420,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 421,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		--ILCRSTNIV0599 Till here
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET 10=7
		--SET 2018=2017
		
		
		CREATE TABLE #RptGSTR1_B2B
		(
		TransId				TINYINT,
		TranType			VARCHAR(20),
		Refid				BIGINT,
		RtrShipId			INT,
		RtrId				INT,
		RtrCode				VARCHAR(50),		
		RtrName				VARCHAR(100),
		[GSTIN/UIN of Recipient]	 VARCHAR(50),
		[Retailer Type]		 VARCHAR(50),
		[Invoice Number]	 VARCHAR(50),
		[Invoice date]		 DATETIME,
		[Invoice Value]		 NUMERIC(32,2),
		[Place Of Supply]	 VARCHAR(125),
		[Reverse Charge]	 VARCHAR(10),
		[Invoice Type]		 VARCHAR(50),
		[Kind of transaction]			Varchar(50),
		[Identifier if Goods or Services]	Varchar(50),		
		[E-Commerce GSTIN]	 VARCHAR(50),
		[Rate]				 NUMERIC(10,2),
		[Taxable Value]		 NUMERIC(32,2),
		[Cess Amount]		 NUMERIC(32,2),
		[IGST rate]			 Numeric(32,2),
		[IGST amount]		 Numeric(32,2),
		[CGST rate]			 Numeric(32,2),
		[CGST amount]		 Numeric(32,2),
		[SGST/UTGST rate]	 Numeric(32,2),
		[SGST/UTGST amount]	 Numeric(32,2),		
		UsrId				 INT,
		[Group Name]		 VARCHAR(100),
		GroupType			 TINYINT
		)
		
		SELECT PurRcptId INTO #Purchareceipt
		FROM PurchaseReceipt (NOLOCK)
		WHERE GoodsRcvdDate Between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		and Status=1
		
		---Retailer State
		SELECT DISTINCT R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		---Supplier State
		SELECT DISTINCT  R.SpmId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		---IDT Distributor State
		SELECT DISTINCT  R.SpmId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #IDTSupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=37 and ColumnName='State Name'
		
		
		---Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
				
		---IDT Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=37 and ColumnName='GSTIN'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
		
		---Sales Data
		SELECT S.RtrId,S.RtrshipId,S.Salid,Salinvno,SalInvdate,Prdslno,OrgNetAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #Sales		
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST')
		and ST.TaxableAmount>0
		GROUP BY S.RtrId,S.Salid,Salinvno,SalInvdate,Prdslno,S.RtrshipId,OrgNetAmount
		SELECT S.SalId,S.Rtrid,SUM(PrdNetAmount)PrdNetAmount INTO #SalesNetValue FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SI (NOLOCK) ON S.Salid=SI.SalId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		GROUP BY S.SalId,S.Rtrid
		UPDATE S SET OrgNetAmount=PrdNetAmount FROM #Sales S INNER JOIN #SalesNetValue SI ON S.Salid=SI.Salid
		
		--IDT Sales Data
		SELECT ToSpmId,I.IDTMngRefNo,IDTMngDate,PrdSlNo,IDTNetAmt,SUM(TaxPerc) as TaxPerc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #IDTSales
		FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProductTax IT (NOLOCK) ON I.IDTMngRefNo=IT.IDTMngRefNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=IT.TaxId
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		and StkMgmtTypeId=2 and IT.TaxableAmount>0
		GROUP BY ToSpmId,I.IDTMngRefNo,IDTMngDate,PrdSlNo,IDTNetAmt
		
		---Purchase Return Supply Data
		SELECT SpmId,I.PurRetId,I.PurRetRefNo,PurRetDate,PrdSlNo,NetAmount,SUM(IT.TaxPerc) as TaxPerc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(IT.TaxAmount) as TaxAmount
		INTO #PurchaseReturn
		FROM PurchaseReturn I (NOLOCK) 
		INNER JOIN PurchaseReturnProductTax IT (NOLOCK) ON I.PurRetId=IT.PurRetId
		INNER JOIN #Purchareceipt R ON R.PurRcptId=I.PurRcptId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=IT.TaxId
		WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
		and IT.TaxableAmount>0
		GROUP BY SpmId,I.PurRetRefNo,PurRetDate,PrdSlNo,I.PurRetId,NetAmount
		
		SELECT  S.ServiceToId,S.ServiceInvId as Salid,ServiceInvRefNo as Salinvno,ServiceInvDate as SalInvdate,
		RowNo,AppTotalAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #ServiceData
		FROM ServiceInvoiceHd S (NOLOCK) 
		INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK)
		ON S.ServiceInvId=SI.ServiceInvId
		WHERE ServiceInvFor=2 and  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear
		and SI.TaxableAmount>0
		GROUP BY S.ServiceToId,S.ServiceInvId,ServiceInvRefNo,ServiceInvDate,RowNo,AppTotalAmount
		
		-----Service
		--SELECT UniqueId,Proforma_Invoice_No ,Proforma_Invoice_Date ,
		--SUM(ISNULL(DocAmount+tax_Amount,0))ApprovedAmt ,SUM(CGST_Per+SGST_Per+IGST_Per+UTGST_Per) as Taxperc,
		--SUM(ISNULL(DocAmount,0)) as TaxableAmount,SUM(ISNULL(tax_Amount,0)) as TaxAmount,CGST_Per,SGST_Per,IGST_Per,UTGST_Per,
		--CGST_Amt,SGST_Amt,IGST_Amt,UTGST_Amt
		--INTO #ServiceData
		--FROM ClaimAcknowledgement WHERE ClaimType IN('Project1 Claim','Other Claim','Manual Claim',
		--'VAT Claim','Incentive Claim','ROI Subsidy Claim','VD ManPower Cost Claim','VD Subsidy Claim','OTHER SERVICE CLAIM')
		--and CAST(ClaimMonth as INT)=@MonthStart and ClaimYear=@Jcmyear 
		--and LEN(ISNULL(DocNumber,''))>0 and Status='APPROVED' and LEN(ISNULL(ServiceAcCode,''))>0
		--GROUP BY UniqueId,Proforma_Invoice_No,Proforma_Invoice_Date,CGST_Per,SGST_Per,IGST_Per,UTGST_Per,CGST_Amt,SGST_Amt,IGST_Amt,UTGST_Amt
		--HAVING SUM(ISNULL(IGST_AMT,0)+ISNULL(CGST_Amt,0)+ISNULL(SGST_Amt,0)+ISNULL(UTGST_Amt,0))>0
		
		---CALCULATE TAX SPLIT 
				
			SELECT TAXID,				
			CASE WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
				 WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
				 WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
				 WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
				 WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
				 WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
				 WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
				 WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
				 WHEN TaxCode IN ('OutputGSTCESS','CESS','GSTCESS','InputGSTCESS') Then 'OutputGSTCESS'
			END	 as TaxCode
			INTO #TaxConfiguration
			FROM  TaxConfiguration WHERE TaxCode 
			IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','CESS',
			'InputCGST','InputSGST','InputIGST','InputUTGST','OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS',
			'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','OutputGSTCESS','GSTCESS','CESS','InputGSTCESS')
		SELECT * INTO #SalesInvoiceProductTax FROM SalesInvoiceProductTax 
			WHERE SalId IN (SELECT DISTINCT salid FROM #Sales) 			
				
		SELECT * INTO #IDTManagementProductTax FROM IDTManagementProductTax 
			WHERE IDTMngRefNo IN (SELECT DISTINCT IDTMngRefNo FROM #IDTSales) 
		SELECT * INTO #PurchaseReturnProductTax  FROM PurchaseReturnProductTax 
			WHERE PurRetId IN (SELECT DISTINCT PurRetId FROM #PurchaseReturn) 
			SELECT * INTO #ServiceInvoiceTaxDetails  FROM ServiceInvoiceTaxDetails 
			WHERE ServiceInvId IN (SELECT DISTINCT ServiceInvId FROM #ServiceData) 
 			
  			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
			FROM
			(
			----SALES DATA
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,
			TaxCode+'Perc' AS TaxCode
			,ST.TaxPerc AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId  AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId 
			UNION ALL	
			-------IDT DETAILS	
			SELECT 2 AS BTYPE,SI.IDTMngRefNo AS Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #IDTSales SI
				INNER JOIN #IDTManagementProductTax ST ON ST.IDTMngRefNo=SI.IDTMngRefNo AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN (SELECT TAXID,TAXCODE FROM  #TaxConfiguration WHERE TaxCode --Added by Mohanakrishna A.B ILCRSTNIV0351
					IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','CESS',
					'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','OutputGSTCESS','GSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS')) T ON T.TaxId=ST.TaxId
			UNION ALL
			SELECT 2 AS BTYPE,SI.IDTMngRefNo  AS Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #IDTSales SI
				INNER JOIN #IDTManagementProductTax ST ON ST.IDTMngRefNo=SI.IDTMngRefNo AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN (SELECT TAXID,TAXCODE FROM  #TaxConfiguration WHERE TaxCode  --Added by Mohanakrishna A.B ILCRSTNIV0351
				IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','OutputGSTCESS','CESS','INputGSTCESS',
					'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','GSTCESS')) T ON T.TaxId=ST.TaxId
			UNION ALL	
  			---PURCHASE RETURN DETAILS
				SELECT 3 AS BTYPE,SI.PurRetRefNo AS Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #PurchaseReturn SI
				INNER JOIN #PurchaseReturnProductTax ST ON ST.PurRetId=SI.PurRetId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
				SELECT 3 AS BTYPE,SI.PurRetRefNo AS Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #PurchaseReturn SI
				INNER JOIN #PurchaseReturnProductTax ST ON ST.PurRetId=SI.PurRetId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId		
			UNION ALL	
  			---Service Invoice
				SELECT 4 AS BTYPE,SI.Salinvno AS Salinvno,SI.RowNo as Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #ServiceData SI
				INNER JOIN #ServiceInvoiceTaxDetails ST ON ST.ServiceInvId=SI.Salid AND ST.RowNo=SI.RowNo
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
				SELECT 4 AS BTYPE,SI.Salinvno AS Salinvno,SI.RowNo as Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #ServiceData SI
				INNER JOIN #ServiceInvoiceTaxDetails ST ON ST.ServiceInvId=SI.Salid AND ST.RowNo=SI.RowNo
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId			
  			)A
 			ORDER BY BTYPE 
 			SELECT BTYPE,Salinvno,Prdslno,SUM([OutputCGSTPerc])[OutputCGSTPerc],
				SUM([OutputCGST_Amt])[OutputCGST_Amt],SUM([OutputSGSTPerc])[OutputSGSTPerc],SUM([OutputSGST_Amt])[OutputSGST_Amt],
				SUM([OutputIGSTPerc])[OutputIGSTPerc],SUM([OutputIGST_Amt])[OutputIGST_Amt],SUM([OutputUTGSTPerc])[OutputUTGSTPerc],
				SUM([OutputUTGST_Amt])[OutputUTGST_Amt],
				SUM([OutputCGSTCESS_Amt])[OutputCGSTCESS_Amt],SUM([OutputSGSTCESSPerc])[OutputSGSTCESSPerc],SUM([OutputSGSTCESS_Amt])[OutputSGSTCESS_Amt],
				SUM([OutputIGSTCESSPerc])[OutputIGSTCESSPerc],SUM([OutputIGSTCESS_Amt])[OutputIGSTCESS_Amt],SUM([OutputUTGSTCESSPerc])[OutputUTGSTCESSPerc],
				SUM([OutputUTGSTCESS_Amt])[OutputUTGSTCESS_Amt],
				SUM([OutputGSTCESSPerc])[OutputGSTCESSPerc],SUM([OutputGSTCESS_Amt])[OutputGSTCESS_Amt]
			INTO #TAXDETAILS
			FROM(
			SELECT BTYPE,Salinvno,Prdslno,
			ISNULL([OutputCGSTPerc],0)[OutputCGSTPerc],ISNULL([OutputCGST_Amt],0)[OutputCGST_Amt],
			ISNULL([OutputSGSTPerc],0)[OutputSGSTPerc],ISNULL([OutputSGST_Amt],0)[OutputSGST_Amt],
			ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],
			ISNULL([OutputUTGSTPerc],0)[OutputUTGSTPerc],ISNULL([OutputUTGST_Amt],0)[OutputUTGST_Amt],
			ISNULL([OutputCGSTCESSPerc],0)[OutputCGSTCESSPerc],ISNULL([OutputCGSTCESS_Amt],0)[OutputCGSTCESS_Amt],
			ISNULL([OutputSGSTCESSPerc],0)[OutputSGSTCESSPerc],ISNULL([OutputSGSTCESS_Amt],0)[OutputSGSTCESS_Amt],
			ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],
			ISNULL([OutputUTGSTCESSPerc],0)[OutputUTGSTCESSPerc],ISNULL([OutputUTGSTCESS_Amt],0)[OutputUTGSTCESS_Amt],
			ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],ISNULL([OutputGSTCESS_Amt],0)[OutputGSTCESS_Amt]
			FROM (
			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt
			FROM #TAXPIVOT) up
			PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputCGST_Amt],[OutputCGSTPerc],
													[OutputSGST_Amt],[OutputSGSTPerc],
													[OutputIGST_Amt],[OutputIGSTPerc],
													[OutputUTGST_Amt],[OutputUTGSTPerc],
													[OutputCGSTCESS_Amt],[OutputCGSTCESSPerc],
													[OutputSGSTCESS_Amt],[OutputSGSTCESSPerc],
													[OutputIGSTCESS_Amt],[OutputIGSTCESSPerc],
													[OutputUTGSTCESS_Amt],[OutputUTGSTCESSPerc],
													[OutputGSTCESS_Amt],[OutputGSTCESSPerc]))  AS PVT 
			)A
			GROUP BY BTYPE,Salinvno,Prdslno 
			
					
 		INSERT INTO #RptGSTR1_B2B(TransId,TranType,Refid ,RtrShipId,RtrId,RtrCode,RtrName,
			[GSTIN/UIN of Recipient],[Retailer Type],[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],
			[Reverse Charge],[Invoice Type],[Kind of transaction],[Identifier if Goods or Services],[E-Commerce GSTIN],
			[Rate],[Taxable Value],[Cess Amount],[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],
			[SGST/UTGST amount],UsrId,[Group Name],GroupType)
		SELECT 1,'Sales',S.Salid,S.RtrShipId,R.RtrId,RtrCode,RtrName,'' as GSTTin,ISNULL(ColumnValue,'') as RetailerType,S.SalInvNo,Salinvdate, OrgNetAmount as SalesValue,'' as PlaceOfSupply,
			  'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount,
			 SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_Amt]) as CessAmount,[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			 ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #Sales S INNER JOIN Retailer R (NOLOCK) ON R.RtrId=S.RtrId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.SalInvNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=1
		LEFT OUTER JOIN #RetailerRegister Rr ON Rr.RtrId=S.RtrId
		GROUP BY 
			S.Salid,R.RtrId,RtrCode,RtrName,S.Salinvno,Salinvdate,Taxperc,S.RtrShipId,OrgNetAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc],ColumnValue
		UNION ALL
		SELECT 2,'IDT',0 as Salid,0 as RtrShipId,R.SpmId as RtrId,SpmCode as RtrCode,SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,
		S.IDTMngRefNo as Salinvno,IDTMngDate as Salinvdate,IDTNetAmt as SalesValue,'' as PlaceOfSupply,
		'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,'' as [E-Commerce],Taxperc,
		SUM(TaxableAmount) as TaxableAmount, SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			   ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #IDTSales S INNER JOIN IDTMaster R (NOLOCK) ON R.SpmId=S.ToSpmId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.IDTMngRefNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=2
		GROUP BY 
			R.SpmId,SpmCode,SpmName,S.IDTMngRefNo,IDTMngDate,Taxperc,IDTNetAmt,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		UNION ALL
		SELECT 3,'PurchaseReturn',S.PurRetId as Salid,0 as RtrShipId,R.SpmId as RtrId,SpmCode as RtrCode,
		SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,S.PurRetRefNo as Salinvno,PurRetDate as Salinvdate,NetAmount as SalesValue,
		'' as PlaceOfSupply,'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,
		'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount, SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,[OutputIGSTPerc],
		SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			   ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #PurchaseReturn S 	INNER JOIN Supplier R (NOLOCK) ON R.SpmId=S.SpmId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.PurRetRefNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=3
		GROUP BY 
		R.SpmId,SpmCode,SpmName,S.PurRetRefNo,PurRetDate,Taxperc,S.PurRetId,NetAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		UNION ALL
		SELECT 4,'Service',S.Salid as Salid,0 as RtrShipId,S.ServiceToId as RtrId,SpmCode as RtrCode,
		SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,
		S.Salinvno as Salinvno,SalInvdate as Salinvdate,AppTotalAmount as SalesValue,'' as PlaceOfSupply,
		'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of service' as Kind,
		'Services' as Goods,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount, 
		SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,
		[OutputIGSTPerc] as [OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc] as [OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
	   ([OutputSGSTPerc]+[OutputUTGSTPerc]) as [OutputSGSTPerc], SUM([OutputSGST_Amt]+[OutputUTGST_Amt]) AS [OutputSGST_Amt],
		@Pi_UsrId,'' as [Group Type],2
		FROM #ServiceData S INNER JOIN Supplier R (NOLOCK) ON R.SpmId=S.ServiceToId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.SalInvNo AND T.PrdSlNo=S.RowNo AND T.BTYPE=4
		GROUP BY S.ServiceToId,SpmCode,SpmName,S.Salinvno,SalInvdate,Taxperc,S.Salid,AppTotalAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		
		 
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #RetailerState A INNER JOIN #RptGSTR1_B2B B ON A.Rtrid=B.RtrId
		WHERE B.TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=GSTTinNo FROM #RptGSTR1_B2B R INNER JOIN RetailerShipAdd RS ON RS.RtrShipId=R.RtrShipId
		and R.TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #RetailerGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[GSTIN/UIN of Recipient],''))=0 and R.TransId=1
		
		DELETE A FROM #RptGSTR1_B2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		and TransId=1
		
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #SupplierState A INNER JOIN #RptGSTR1_B2B B ON A.RtrId=B.RtrId
		WHERE B.TransId IN(3,4)
	
		
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #IDTSupplierState A INNER JOIN #RptGSTR1_B2B B ON A.Rtrid=B.RtrId
		WHERE B.TransId=2
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #SupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE  R.TransId IN(3,4)
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #IDTSupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE  R.TransId=2
		
	 --select * from #RptGSTR1_B2B
		
		 
			
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR1_B2B)
		BEGIN
			INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
			,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
			[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
			[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)
			SELECT '' as [GSTIN/UIN of Recipient],'' as [Recipient Code in application],'' as [Recipient Name],'' as[Recipient Type],
			'' as [Invoice Number],'' as [Invoice date],0,'' as [Place Of Supply],'' as [Reverse Charge],'' as [Invoice Type],'' as [Kind of transaction],	
			'' as [Identifier if Goods or Services],'' as [E-Commerce GSTIN],0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),
			0 as [IGST rate],SUM([IGST amount]),0 as [CGST rate],SUM([CGST amount]),0 as [SGST/UTGST rate],SUM([SGST/UTGST amount]),
			@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
			FROM #RptGSTR1_B2B		
			SELECT * FROM RptGSTR1_B2B (NOLOCK) WHERE UsrId=@Pi_UsrId
			
			DELETE FROM RptGSTR1_B2B WHERE UsrId=@Pi_UsrId			
			
			RETURN
		END
		
		INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
		,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
		[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)		
		SELECT [GSTIN/UIN of Recipient],RtrCode,rtrname,[Retailer Type],[Invoice Number],
		REPLACE(REPLACE(CONVERT(VARCHAR,[Invoice date],106), ' ','-'), ',',''),[Invoice Value],[Place Of Supply],
		[Reverse Charge],[Invoice Type],[Kind of transaction],[Identifier if Goods or Services]	,[E-Commerce GSTIN],[Rate],[Taxable Value],
		[Cess Amount],[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType
		FROM #RptGSTR1_B2B 
		ORDER BY TransId,[GSTIN/UIN of Recipient],[Invoice date],[Invoice Number]
		
		SELECT DISTINCT TransId,[Invoice Number],[Invoice Value]
		INTO #GrandTotal
		FROM #RptGSTR1_B2B
		
		
		INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
		,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
		[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)
		SELECT '' as [GSTIN/UIN of Recipient],'' as [Recipient Code in application],'' as [Recipient Name],'' as[Recipient Type],
		'' as [Invoice Number],'' as [Invoice date],0,'' as [Place Of Supply],'' as [Reverse Charge],'' as [Invoice Type],'' as [Kind of transaction],	
		'' as [Identifier if Goods or Services],'' as [E-Commerce GSTIN],0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),
		0 as [IGST rate],SUM([IGST amount]),0 as [CGST rate],SUM([CGST amount]),0 as [SGST/UTGST rate],SUM([SGST/UTGST amount]),
		@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR1_B2B
		
		UPDATE RptGSTR1_B2B SET [Invoice Value]=(SELECT SUM([Invoice Value]) FROM #GrandTotal) WHERE GroupType=3
		
		
		SELECT * FROM RptGSTR1_B2B WHERE UsrId=@Pi_UsrId
				
END
GO
--Till Here Venkat
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME='SchNCP' AND id=OBject_ID ('SalesInvoice'))
BEGIN
	ALTER TABLE SalesInvoice ADD SchNCP INT DEFAULT 0 WITH VALUES
END
GO
DELETE FROM CustomUpdownload WHERE Module='RetailerWiseTargetForBilling' AND UpDownload ='Download'
INSERT INTO CustomUpDownload 
SELECT Max(slno)+1,1,'RetailerWiseTargetForBilling','RetailerWiseTargetForBilling','','','Cn2Cs_Prk_RetailerWiseTargetForBilling','Proc_Cn2Cs_RetailerWiseTargetForBilling','Transaction','Download',1
FROM CustomUpdownload Where UPDownload='Download'
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName = 'RetailerWiseTargetForBilling'
INSERT INTO Tbl_DownloadIntegration
SELECT  Max(SequenceNo)+1,'RetailerWiseTargetForBilling','Cn2Cs_Prk_RetailerWiseTargetForBilling','',0,500,GETDATE()
FROM Tbl_DownloadIntegration  
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_RetailerWiseTargetForBilling' AND TYPE='U')
DROP TABLE Cn2Cs_Prk_RetailerWiseTargetForBilling
GO
CREATE TABLE Cn2Cs_Prk_RetailerWiseTargetForBilling
(
	Distcode		 NVARCHAR(50) NULL,
	ValidMonth		 NVARCHAR(50) NULL,
	ValidYear		 INT NULL,
	RtrCode			 NVARCHAR(100) NULL,
	CmpRtrCode		 NVARCHAR(100) NULL,
	TargetAmt		 NUMERIC(38,6) NULL,	
	EffectiveDate	 DATETIME NULL,
	DownloadFlag	 VARCHAR(5) NULL,
	CreatedDate		 DATETIME NULL
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='RetailerWiseTargetForBilling' AND TYPE='U') 
BEGIN
	CREATE TABLE RetailerWiseTargetForBilling
	(
		RtrId			 INT,
		RtrCode			 NVARCHAR(100) NULL,
		CmpRtrCode		 NVARCHAR(100) NULL,
		ValidMonth		 NVARCHAR(50) NULL,
		ValidYear		 INT NULL,
		TargetAmt		 NUMERIC(38,6) NULL, 
		EffectiveDate	 DATETIME NULL,
		DownloadedDate	 DATETIME NULL
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_RetailerWiseTargetForBilling' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerWiseTargetForBilling
GO
/*
BEGIN TRAN  
select * from RetailerWiseTargetForBilling
EXEC Proc_Cn2Cs_RetailerWiseTargetForBilling 0 
select * from Cn2Cs_Prk_RetailerWiseTargetForBilling 
select * from RetailerWiseTargetForBilling
ROLLBACK TRAN
*/  
CREATE PROCEDURE Proc_Cn2Cs_RetailerWiseTargetForBilling
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/**********************************************************************************  
* PROCEDURE		: Proc_Cn2Cs_RetailerWiseTargetForBilling 
* PURPOSE		: To Validate Retailer Target data from console
* CREATED		: S.Mohana
* CREATED DATE	: 22-10-2020
* PMS NO		: PARCS202100057		
************************************************************************************/   
BEGIN  
SET NOCOUNT ON
SET @Po_ErrNo=0  
	BEGIN TRY    
			DELETE PRK FROM Cn2Cs_Prk_RetailerWiseTargetForBilling PRK (NOLOCK) WHERE DownloadFlag='Y'  
			
			SELECT ValidMonth,ValidYear,CmpRtrCode,MAX(CreatedDate) as CreatedDate INTO #TempRtrDet
			FROM Cn2Cs_Prk_RetailerWiseTargetForBilling(NOLOCK) GROUP BY ValidMonth,ValidYear,CmpRtrCode			
			
			SELECT A.* INTO #Cn2Cs_Prk_RetailerWiseTargetForBilling  FROM Cn2Cs_Prk_RetailerWiseTargetForBilling A INNER JOIN #TempRtrDet B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.Cmprtrcode=B.Cmprtrcode  WHERE A.CreatedDate=B.CreatedDate
	
			IF NOT EXISTS (SELECT * FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling (NOLOCK)) 
			BEGIN
				RETURN
			END

			CREATE TABLE #Avoid 
			(  
				RtrCode VARCHAR(50),  
				SlNo INT,  
				TableName NVARCHAR (200),  
				FieldName NVARCHAR (200),  
				ErrDesc NVARCHAR (1000)  
			) 
			
			INSERT INTO  #Avoid
			SELECT CmpRtrCode,1,'Cn2Cs_Prk_RetailerWiseTargetForBilling','CmpRtrcode','Retailer not available'+CmpRtrCode  FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling
			WHERE CmpRtrCode NOT IN (SELECT CmpRtrCode FROM Retailer) 

			INSERT INTO  #Avoid
			SELECT CmpRtrCode,1,'Cn2Cs_Prk_RetailerWiseTargetForBilling','TargetMonth/Year','TargetMonth/Year not available'+CmpRtrCode  FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling
			WHERE ValidMonth IS NULL OR ValidYear = 0 
			 
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
			SELECT DISTINCT SlNo,TableName,FieldName,ErrDesc FROM #Avoid (NOLOCK)  	
			
			SELECT A.* INTO #NOTExists FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling A WHERE NOT EXISTS (SELECT * FROM RetailerWiseTargetForBilling B WHERE A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.CmpRtrCode=B.CmpRtrCode)

			DELETE A FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling A INNER JOIN #NOTExists B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.CmpRtrCode=B.CmpRtrCode	
			
			IF EXISTS(SELECT *FROM #NOTExists)
			BEGIN
				INSERT INTO RetailerWiseTargetForBilling(RtrId,RtrCode,CmpRtrCode,ValidMonth,ValidYear,TargetAmt,Effectivedate,DownloadedDate)
		 		SELECT Rtrid,B.RtrCode,B.CmpRtrCode,ValidMonth,ValidYear,A.TargetAmt,A.EffectiveDate,Getdate() FROM #NOTExists A 
				INNER JOIN Retailer B ON A.CmpRtrCode = B.CmpRtrCode
				WHERE  EXISTS (SELECT * FROM #NOTExists C  WHERE A.ValidMonth=C.ValidMonth
				AND A.ValidYear=C.ValidYear AND A.CmpRtrCode=C.CmpRtrCode)
			END
			 
			IF EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling)
			BEGIN
				UPDATE B SET B.TargetAmt = A.TargetAmt  FROM #Cn2Cs_Prk_RetailerWiseTargetForBilling A INNER JOIN RetailerWiseTargetForBilling B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.CmpRtrCode=B.CmpRtrCode 
			--NOT EXISTS (SELECT * FROM #NOTExists C  WHERE A.ValidMonth=C.ValidMonth
			--	AND A.ValidYear=C.ValidYear AND A.CmpRtrCode=C.CmpRtrCode)
			END

			UPDATE A SET DownloadFlag='Y' FROM  Cn2Cs_Prk_RetailerWiseTargetForBilling A INNER JOIN RetailerWiseTargetForBilling B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.CmpRtrCode=B.CmpRtrCode
	END TRY 
	 
	BEGIN CATCH  
		INSERT INTO ErrorLog 
		SELECT 1,'RetailerWiseTargetForBilling','RetailerWiseTargetForBilling',ERROR_MESSAGE()
		SET @Po_ErrNo=1 -- 1 will rollback the process through Sync EXE  
		RETURN  
	END CATCH    
RETURN  
END
GO
DELETE FROM CustomUpdownload WHERE Module='RetailerTargetforGSTIN' AND UpDownload ='Download'
INSERT INTO CustomUpDownload 
SELECT Max(slno)+1,1,'RetailerTargetforGSTIN','RetailerTargetforGSTIN','','','Cn2Cs_Prk_RetailerTargetforGSTIN','Proc_Cn2Cs_RetailerTargetforGSTIN','Transaction','Download',1
FROM CustomUpdownload Where UPDownload='Download'
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName = 'RetailerTargetforGSTIN'
INSERT INTO Tbl_DownloadIntegration
SELECT  Max(SequenceNo)+1,'RetailerTargetforGSTIN','Cn2Cs_Prk_RetailerTargetforGSTIN','',0,500,GETDATE()
FROM Tbl_DownloadIntegration  
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_RetailerTargetforGSTIN' AND TYPE='U')
DROP TABLE Cn2Cs_Prk_RetailerTargetforGSTIN
GO
CREATE TABLE Cn2Cs_Prk_RetailerTargetforGSTIN
(
	Distcode		 NVARCHAR(50) NULL,
	ValidMonth		 NVARCHAR(50) NULL, --Name of the Month
	ValidYear		 INT NULL, --Year
	GroupCode		 NVARCHAR(100) NULL,
	GroupName		 NVARCHAR(100) NULL,
	TargetAmt		 NUMERIC(38,6) NULL,	
	EffectiveDate	 DATETIME NULL,
	DownloadFlag	 VARCHAR(5) NULL,
	CreatedDate		 DATETIME NULL
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='RetailerTargetforGSTIN' AND TYPE='U') 
BEGIN
	CREATE TABLE RetailerTargetforGSTIN
	(
		CtgMainId		 INT,
		CtgCode  		 NVARCHAR(100) NULL,
		CtgName			 NVARCHAR(100) NULL,
		ValidMonth		 NVARCHAR(50) NULL,
		ValidYear		 INT NULL,
		TargetAmt		 NUMERIC(38,6) NULL, 
		EffectiveDate	 DATETIME NULL,
		DownloadedDate	 DATETIME NULL
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_RetailerTargetforGSTIN' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerTargetforGSTIN
GO
/*
BEGIN TRAN  
EXEC Proc_Cn2Cs_RetailerTargetforGSTIN 0 
select * from RetailerTargetforGSTIN 
ROLLBACK TRAN
*/  
CREATE PROCEDURE Proc_Cn2Cs_RetailerTargetforGSTIN
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*****************************************************************************************************************************************************************  
* PROCEDURE		: Proc_Cn2Cs_RetailerTargetforGSTIN 
* PURPOSE		: To Validate Retailer Target data from console
* CREATED		: S.Mohana
* CREATED DATE	: 23-10-2020
* PMS NO		: PARCS202100057	
*******************************************************************************************************************************************************************/   
BEGIN  
SET @Po_ErrNo=0  
	BEGIN TRY    
			DELETE PRK FROM Cn2Cs_Prk_RetailerTargetforGSTIN PRK (NOLOCK) WHERE DownloadFlag='Y'  
			
			SELECT ValidMonth,ValidYear,GroupCode,MAX(CreatedDate) as CreatedDate INTO #TempDetails
			FROM Cn2Cs_Prk_RetailerTargetforGSTIN(NOLOCK) GROUP BY ValidMonth,ValidYear,GroupCode			
			
			SELECT A.* INTO #Cn2Cs_Prk_RetailerTargetforGSTIN  FROM Cn2Cs_Prk_RetailerTargetforGSTIN A INNER JOIN #TempDetails B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.GroupCode=B.GroupCode  WHERE A.CreatedDate=B.CreatedDate
	
			IF NOT EXISTS (SELECT * FROM #Cn2Cs_Prk_RetailerTargetforGSTIN (NOLOCK)) 
			BEGIN
				RETURN
			END

			CREATE TABLE #Avoid 
			(  
				RtrCode VARCHAR(50),  
				SlNo INT,  
				TableName NVARCHAR (200),  
				FieldName NVARCHAR (200),  
				ErrDesc NVARCHAR (1000)  
			) 
			
			INSERT INTO  #Avoid
			SELECT GroupCode,1,'Cn2Cs_Prk_RetailerTargetforGSTIN','GroupCode','GroupCode not available'+GroupCode  FROM #Cn2Cs_Prk_RetailerTargetforGSTIN
			WHERE GroupCode NOT IN (SELECT Ctgcode FROM RetailerCategory) 

			INSERT INTO  #Avoid
			SELECT GroupCode,1,'Cn2Cs_Prk_RetailerTargetforGSTIN','TargetMonth/Year','TargetMonth/Year not available'+GroupCode  FROM #Cn2Cs_Prk_RetailerTargetforGSTIN
			WHERE ValidMonth IS NULL OR ValidYear = 0 
			 
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
			SELECT DISTINCT SlNo,TableName,FieldName,ErrDesc FROM #Avoid (NOLOCK)  	
			
			SELECT A.* INTO #NOTExists FROM #Cn2Cs_Prk_RetailerTargetforGSTIN A WHERE NOT EXISTS (SELECT * FROM RetailerTargetforGSTIN B WHERE A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND   A.GroupCode=B.CtgCode)

			DELETE A FROM #Cn2Cs_Prk_RetailerTargetforGSTIN A INNER JOIN #NOTExists B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND   A.GroupCode=B.GroupCode
			
 
			IF EXISTS(SELECT *FROM #NOTExists)
			BEGIN
				INSERT INTO  RetailerTargetforGSTIN(CtgMainId,CtgCode,CtgName,ValidMonth,ValidYear,TargetAmt,Effectivedate,DownloadedDate)
		 		SELECT CtgMainId,CtgCode,CtgName,ValidMonth,ValidYear,TargetAmt,EffectiveDate,Getdate() FROM #NOTExists A 
				INNER JOIN RetailerCategory B ON A.GroupCode = B.CtgCode
			END
			 
			IF EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerTargetforGSTIN)
			BEGIN
				UPDATE B SET B.TargetAmt = A.TargetAmt  FROM #Cn2Cs_Prk_RetailerTargetforGSTIN A INNER JOIN RetailerTargetforGSTIN B ON A.ValidMonth=B.ValidMonth
				AND A.ValidYear=B.ValidYear AND A.GroupCode=B.CtgCode 
			END

			UPDATE A SET DownloadFlag='Y' FROM Cn2Cs_Prk_RetailerTargetforGSTIN A INNER JOIN RetailerTargetforGSTIN B ON A.ValidMonth=B.ValidMonth
			AND A.ValidYear=B.ValidYear AND A.GroupCode=B.CtgCode 
			
	END TRY 
	 
	BEGIN CATCH  
		INSERT INTO ErrorLog 
		SELECT 1,'RetailerTargetforGSTIN','RetailerTargetforGSTIN',ERROR_MESSAGE()
		SET @Po_ErrNo=1 -- 1 will rollback the process through Sync EXE  
		RETURN  
	END CATCH    
RETURN  
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='UDCGstinUpdate_Track' AND TYPE='U')
BEGIN
	CREATE TABLE UDCGstinUpdate_Track
	(
	Rtrid		INT, 
	Gstin		VARCHAR(100),
	UpdatedDate	DATETIME
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Trg_UDCGstinUpdate' AND TYPE='TR')
DROP TRIGGER Trg_UDCGstinUpdate
GO
CREATE TRIGGER Trg_UDCGstinUpdate

   ON [dbo].UdcDetails

   AFTER INSERT
AS 
/**********************************************************************************  
* PROCEDURE		: Trg_UDCGstinUpdate 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 12-11-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN

    SET NOCOUNT ON

	INSERT INTO UDCGstinUpdate_Track
	SELECT I.MasterRecordid,I.ColumnValue,Convert(varchar(10),Getdate(),121)    
    FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
    INNER JOIN Inserted I on B.MasterRecordid = I.MasterRecordid AND   I.UdcMasterId = B.UdcMasterId AND A.UdcMasterId = I.UdcMasterId

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Trg_UDCGstin_Update' AND TYPE='TR')
DROP TRIGGER Trg_UDCGstin_Update
GO
CREATE TRIGGER Trg_UDCGstin_Update

   ON [dbo].UdcDetails

   AFTER UPDATE
AS 
/**********************************************************************************  
* PROCEDURE		: Trg_UDCGstinUpdate 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 12-11-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN

    SET NOCOUNT ON

	INSERT INTO UDCGstinUpdate_Track
	SELECT I.MasterRecordid,I.ColumnValue,Convert(varchar(10),Getdate(),121)    
    FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
    INNER JOIN Inserted I on B.MasterRecordid = I.MasterRecordid AND   I.UdcMasterId = B.UdcMasterId AND A.UdcMasterId = I.UdcMasterId

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetTargetReach' AND TYPE='FN')
DROP FUNCTION Fn_GetTargetReach
GO
--SELECT Dbo.Fn_GetTargetReach(22,1,1,'2020-11-06',9338.47, 0 ,0)AS ValidMsg 
CREATE FUNCTION Fn_GetTargetReach(@Pi_Rtrid INT,@Pi_UsrId INT,@Mode INT,@Pi_BillDate DATETIME,@CurGross NUMERIC(38,6),@Pi_Salid INT,@ChkSchCP INT)
RETURNS VARCHAR(MAX)	
AS 
/**********************************************************************************  
* PROCEDURE		: Fn_GetTargetReach 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 23-10-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN
DECLARE @Msg AS VARCHAR(MAX)	
SET @Msg = ''
DECLARE @TotGross AS NUMERIC(38,2)
DECLARE @TargetAmt AS NUMERIC(38,2)
DECLARE @CtgMainId AS INT
DECLARE @ColumnValue NVARCHAR(100)
DECLARE @GstTarget AS NUMERIC(38,2)
DECLARE @EffDate AS DATETIME
DECLARE @EffDateChk AS DATETIME
DECLARE @ChkGST	AS INT
SET @GstTarget = 0
SET @TargetAmt = 0
SET @ChkGST =1
SELECT  @EffDateChk = CONVERT(VARCHAR(10),Effectivedate,121) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
IF (@Pi_BillDate<@EffDateChk)
BEGIN
	RETURN @Msg	
END
SELECT @CtgMainId = ISNULL(D.CtgMainId,0) FROM Retailer A INNER JOIN RetailerValueClassMap B ON A.Rtrid =B.Rtrid  AND A.RtrId = @Pi_Rtrid
INNER JOIN RetailerValueClass C ON B.RtrValueClassId = C.RtrClassId
INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 
SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
AND MasterRecordid = @Pi_Rtrid  

If @Mode = 2
BEGIN
	IF EXISTS (SELECT * FROM UdcGstinUpdate_Track WHERE Rtrid = @Pi_Rtrid)
	BEGIN
		SELECT @EffDate = UpdatedDate,@ColumnValue = Gstin   FROM (	
		SELECT MAx(UpdatedDate) UpdatedDate ,Gstin,Rtrid FROM UdcGstinUpdate_Track WHERE Rtrid = @Pi_Rtrid GROUP BY Gstin,Rtrid
		)A
		If @Pi_BillDate >= @EffDate
		BEGIN
			SET @ChkGST = 0
		END  
		ELSE
		BEGIN
			SET @ColumnValue = ''
		END
	END
	ELSE
	BEGIN
		SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
		AND MasterRecordid = @Pi_Rtrid  
	END
END 

SELECT @TargetAmt = ISNULL(TargetAmt,0) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)
IF @ColumnValue='NULL'
BEGIN
	SET @ColumnValue ='' 
END

IF @ChkGST = 1
BEGIN
	IF EXISTS(SELECT * FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
		AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		IF (len(@ColumnValue))<>15
		BEGIN					
			SELECT @GstTarget = ISNULL(TargetAmt,0) FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)

			IF @TargetAmt<>0 AND @TargetAmt> @GstTarget
			BEGIN
				SET @TargetAmt = @GstTarget
			END
			IF @TargetAmt=0 
			BEGIN
				SET @TargetAmt = @GstTarget
			END
		
		END
	END
END

IF @Mode <> 2
BEGIN
	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN

		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate) 
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A

	END
	ELSE
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON A.CtgMainId  =@CtgMainId 
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate) 
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121)  
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON  A.CtgMainId  =@CtgMainId 
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND ValidMonth =DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  
		AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
END
IF @Mode = 2  
BEGIN
	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
	ELSE
	BEGIN 
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON A.CtgMainId  =@CtgMainId 
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON A.CtgMainId  =@CtgMainId 
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121)
		)A 
	END
END

DECLARE @DisAmt Numeric (38,2)

	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Pi_Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @DisAmt= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END
	ELSE
	BEGIN
		SELECT @DisAmt= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN SalesInvoice B ON  A.CtgMainId  =@CtgMainId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@Pi_Rtrid AND SalId <> @Pi_Salid
		AND ValidMonth =DATENAME(Month,@Pi_BillDate) AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader  B ON A.CtgMainId  =@CtgMainId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@Pi_Rtrid AND B.SalId <> @Pi_Salid AND InvoiceType =1
		AND ValidMonth=DATENAME(Month,@Pi_BillDate)
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		)A
	END

SET @DisAmt= @TargetAmt - @DisAmt 

 	SET @Msg = ''
	IF @TargetAmt =0 
	BEGIN
		SET @Msg = ''
		RETURN (@Msg)
	END
	IF @Mode =0
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)
		BEGIN 
			SET @Msg = 'Retailer sales target exceeded. Scheme/Discount Will not apply in current Bill' -- + CAST(@TargetAmt AS VARCHAR(100))
		END
	END	
	IF @Mode = 1
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)	
		BEGIN
			If @ChkSchCP = 0 
			BEGIN
			SET @Msg = 'Sales Capping exceeds in this bill. Kindly tick the checkbox to continue without schemes/discount price for this month. ' +
			CHAR(13) + 'Capping Amount : '  + CAST (@TargetAmt as varchar(100))
			+ CHAR(13) + 'Balance Amount : '  + CAST (@DisAmt as varchar(100))
			END
			If @ChkSchCP = 1 
			BEGIN
				SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
			END
		END
	END
	IF @Mode = 2
	BEGIN
		IF @TargetAmt<(@TotGross+@CurGross)	
		BEGIN
			If @ChkSchCP = 0 
			BEGIN
				--SET @Msg = 'Retailer sales target exceeded. Kindly tick the checkbox to continue without schemes/discount price for this month.' +
				--CHAR(13) + 'All items in this bill need to be reentered' +CAST (@TargetAmt as varchar(100))
				SET @Msg = 'Sales Capping exceeds in this bill. Kindly tick the checkbox to continue without schemes/discount price for this month. ' +
					CHAR(13) + 'Capping Amount : '  + CAST (@TargetAmt as varchar(100))
					+ CHAR(13) + 'Balance Amount : '  + CAST (@DisAmt as varchar(100))
			END
			If @ChkSchCP = 1 
			BEGIN
				SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
			END
		END
	END
	--IF @Mode = 2
	--BEGIN
	--	IF @TargetAmt>(@TotGross+@CurGross)	
	--	BEGIN
	--		If @ChkSchCP = 1 
	--		BEGIN
	--			SET @Msg = ''
	--		END
	--		--If @ChkSchCP = 1 
	--		--BEGIN
	--		--	SET @Msg = 'Retailer sales target exceeded. Scheme/Discount is not applied in current Bill'  
	--		--END
	--	END
	--END
RETURN (@Msg)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetTargetForSalesPanel' AND TYPE='FN')
DROP FUNCTION Fn_GetTargetForSalesPanel
GO
--SELECT dbo.Fn_GetTargetForSalesPanel ('ORD2000019',2,0,3100,'2020-12-03')
CREATE FUNCTION Fn_GetTargetForSalesPanel(@Pi_Orderno NVARCHAR(100),@Pi_UsrId INT,@Mode INT,@CurGross NUMERIC(38,6),@Pi_BillDate DATETIME)
RETURNS VARCHAR(100)	
AS 
/**********************************************************************************  
* PROCEDURE		: Fn_GetTargetForSalesPanel 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 02-10-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN
DECLARE @Msg AS VARCHAR(MAX)	
SET @Msg = ''

DECLARE @TotGross AS NUMERIC(38,6)
DECLARE @TargetAmt AS NUMERIC(38,6)
DECLARE @CtgMainId AS INT
DECLARE @ColumnValue NVARCHAR(100)
DECLARE @GstTarget AS NUMERIC(38,6) 
DECLARE @EffDateChk AS DATETIME
DECLARE @RtrId AS INT

SET @GstTarget = 0

SET @TargetAmt = 0

SELECT @RtrId = RtrId FROM OrderBooking(NOLOCK) WHERE OrderNo= @Pi_Orderno

SELECT  @EffDateChk = CONVERT(VARCHAR(10),Effectivedate,121) FROM RetailerWiseTargetForBilling WHERE Rtrid = @Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) 
AND ValidYear = Year(@Pi_BillDate)

IF (@Pi_BillDate<@EffDateChk)
BEGIN
	RETURN @Msg	
END

SELECT @CtgMainId = ISNULL(D.CtgMainId,0) FROM Retailer A INNER JOIN RetailerValueClassMap B ON A.Rtrid =B.Rtrid  AND A.RtrId = @RtrId
INNER JOIN RetailerValueClass C ON B.RtrValueClassId = C.RtrClassId
INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 

SELECT @ColumnValue =ColumnValue FROM UdcMaster A INNER JOIN UdcDetails B ON A.MasterId =2 AND A.UdcMasterId = B.UdcMasterId AND A.ColumnName='GSTIN'
AND MasterRecordid = @RtrId 
IF @ColumnValue='NULL'
BEGIN
	SET @ColumnValue =''
END

SELECT @TargetAmt = isnull(TargetAmt,0) FROM RetailerWiseTargetForBilling WHERE Rtrid = @RtrId AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND   Year(@Pi_BillDate)=validyear 
AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121) 

IF Len(@ColumnValue)>0
BEGIN
	IF (len(@ColumnValue))<>15
	BEGIN
		IF EXISTS(SELECT * FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
		BEGIN					
			SELECT @GstTarget = ISNULL(TargetAmt,0) FROM RetailerTargetforGSTIN WHERE CtgMainId = @CtgMainId  AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
			AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121)

			IF @TargetAmt<>0 AND @TargetAmt> @GstTarget
			BEGIN
				SET @TargetAmt = @GstTarget
			END

			IF @TargetAmt=0 
			BEGIN
				SET @TargetAmt = @GstTarget
			END
		END		
	END
END

	IF EXISTS (SELECT * FROM RetailerWiseTargetForBilling WHERE Rtrid = @Rtrid AND ValidMonth=DATENAME(Month,@Pi_BillDate) AND ValidYear = Year(@Pi_BillDate)
	AND @Pi_BillDate>=CONVERT(VARCHAR(10),Effectivedate,121))
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN SalesInvoice B ON A.RtrId =B.RtrId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerWiseTargetForBilling A INNER JOIN ReturnHeader  B ON A.RtrId =B.RtrId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  )A
	END
	ELSE
	BEGIN
		SELECT @TotGross= ISNULL(SUM(TotGross),0) FROM (
		SELECT ISNULL(Sum(SalGrossAmount),0) TotGross FROM RetailerTargetforGSTIN  A INNER JOIN SalesInvoice B ON CtgMainId = @CtgMainId
		AND DATENAME(Month,SalInvDate)=A.ValidMonth AND Year(SalInvDate)=A.validyear And DlvSts <>3 AND B.Rtrid =@RtrId AND   ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		UNION
		SELECT -1*ISNULL(Sum(RtnGrossAmt),0) TotGross FROM RetailerTargetforGSTIN A INNER JOIN ReturnHeader B ON CtgMainId = @CtgMainId
		INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID AND StockTypeId =1 AND B.Rtrid =@RtrId AND ValidMonth =DATENAME(Month,@Pi_BillDate)AND @Pi_BillDate>= CONVERT(VARCHAR(10),Effectivedate,121) 
		AND DATENAME(Month,ReturnDate)=A.ValidMonth AND Year(ReturnDate)=A.validyear  )A
	END

	SET @Msg = ''

	IF @TargetAmt =0 
	BEGIN
		SET @Msg = ''
		RETURN @Msg
	END
  
  
	IF @TargetAmt<@TotGross+@CurGross
	BEGIN 
		SET @Msg = 'Retailer sales target exceeded. Order Not Processed  ' + @Pi_Orderno -- + CAST( @TargetAmt As varchar(100) )+ cast( @TotGross as varchar(100))
	END
  
RETURN (@Msg)
END
GO
DELETE FROM TBL_GENERIC_REPORTS WHERE RptId=26
INSERT INTO TBL_GENERIC_REPORTS(RptId,RptName,SPName,Instructions,DrillDown)
SELECT 26,'Retailer Wise Sales Target' ,'Proc_GR_RtrWiseSalesTarget','This will give you the visibility of Retailer Wise Sales Target','Not Available'
GO
DELETE FROM TBL_GENERIC_REPORTS_FILTERS WHERE RptId=26
INSERT INTO TBL_GENERIC_REPORTS_FILTERS([RptId],[FilterId],[FilterCaption],[ParamName],[rptname]) 
SELECT 26,1,'Month', 'Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target' UNION
SELECT 26,2,'Year','Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target' UNION
SELECT 26,3,'Not Applicable','Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target' UNION
SELECT 26,4,'Not Applicable','Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target' UNION
SELECT 26,5,'Not Applicable','Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target' UNION
SELECT 26,6,'Not Applicable','Proc_GR_RtrWiseSalesTarget_Values','Retailer Wise Sales Target'
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_GR_RtrWiseSalesTarget_Values')
DROP PROCEDURE Proc_GR_RtrWiseSalesTarget_Values
GO
--exec Proc_GR_RtrWiseSalesTarget_Values 'Month','j'
CREATE PROCEDURE Proc_GR_RtrWiseSalesTarget_Values
(
		@FILTERCAPTION  NVARCHAR(100),
		@TEXTLIKE  NVARCHAR(100)
)
as
begin 

		SET @TEXTLIKE='%'+ISNULL(@TEXTLIKE,'')+'%'
		 
		IF UPPER(@FILTERCAPTION)='Year' 
		BEGIN
			SELECT DISTINCT JcmYr as Filtervalues FROM JCMAST (NOLOCK) WHERE CAST(JCMYR AS VARCHAR(10)) LIKE @textlike 			
		END 
		IF UPPER(@FILTERCAPTION)='Month'
		BEGIN
			SELECT DISTINCT [MONTHNAME] as Filtervalues FROM MONTHDT WHERE [MONTHNAME] LIKE @textlike 			
		END 
		
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_GR_RtrWiseSalesTarget')
DROP PROCEDURE Proc_GR_RtrWiseSalesTarget 
GO
--Exec Proc_GR_ProgramRtrUtilization '','2019-01-01','2020-07-31','','','','','',''
CREATE PROCEDURE Proc_GR_RtrWiseSalesTarget
(    
  @Pi_RptName  NVARCHAR(100),    
  @Pi_FromDate DATETIME,    
  @Pi_ToDate   DATETIME,    
  @Pi_Filter1  NVARCHAR(100),    
  @Pi_Filter2  NVARCHAR(100),
  @Pi_Filter3  NVARCHAR(100),
  @Pi_Filter4  NVARCHAR(100),
  @Pi_Filter5  NVARCHAR(100),
  @Pi_Filter6  NVARCHAR(100)
)    
AS     
/**********************************************************************************  
* PROCEDURE		: Proc_GR_RtrWiseSalesTarget 
* PURPOSE		:  
* CREATED		: S.Mohana
* CREATED DATE	: 12-11-2020
* PMS NO		: PARCS202100057		
************************************************************************************/ 
BEGIN    
  SET @Pi_FILTER1='%'+ISNULL(@Pi_FILTER1,'')+'%'            
  SET @Pi_FILTER2='%'+ISNULL(@Pi_FILTER2,'')+'%'
  SET @Pi_FILTER3='%'+ISNULL(@Pi_FILTER3,'')+'%'             
  SET @Pi_FILTER4='%'+ISNULL(@Pi_FILTER4,'')+'%' 
  SET @Pi_FILTER5='%'+ISNULL(@Pi_FILTER5,'')+'%'      
  SET @Pi_FILTER6='%'+ISNULL(@Pi_FILTER6,'')+'%'  

  SELECT 'Retailer Wise Sales Target',A.RtrCode,A.CmpRtrCode,RtrName AS [Retailer Name],ValidMonth [Month],ValidYear [Year],TargetAmt,EffectiveDate FROM RetailerWiseTargetForBilling A INNER JOIN Retailer B ON A.Rtrid = B.Rtrid 
  AND ValidMonth like @Pi_FILTER1 AND ValidYear Like @Pi_FILTER2
			 
END
GO
DELETE FROM TBL_GENERIC_REPORTS WHERE RptId=27
INSERT INTO TBL_GENERIC_REPORTS(RptId,RptName,SPName,Instructions,DrillDown)
SELECT 27,'Group Wise Target For GSTIN' ,'Proc_GR_CtgWiseTargetForGSTIN','This will give you the visibility of Group  Wise Target For GSTIN','Not Available'
GO
DELETE FROM TBL_GENERIC_REPORTS_FILTERS WHERE RptId=27
INSERT INTO TBL_GENERIC_REPORTS_FILTERS([RptId],[FilterId],[FilterCaption],[ParamName],[rptname]) 
SELECT 27,1,'Month','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN' UNION
SELECT 27,2,'Year','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN' UNION
SELECT 27,3,'Not Applicable','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN' UNION
SELECT 27,4,'Not Applicable','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN' UNION
SELECT 27,5,'Not Applicable','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN' UNION
SELECT 27,6,'Not Applicable','Proc_GR_CtgWiseTargetForGSTIN_Values','Group Wise Target For GSTIN'
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_GR_CtgWiseTargetForGSTIN_Values')
DROP PROCEDURE Proc_GR_CtgWiseTargetForGSTIN_Values
GO
--exec Proc_GR_CtgWiseTargetForGSTTIN_Values 'Month','j'
CREATE PROCEDURE Proc_GR_CtgWiseTargetForGSTIN_Values
(
		@FILTERCAPTION  NVARCHAR(100),
		@TEXTLIKE  NVARCHAR(100)
)
as
begin 

		SET @TEXTLIKE='%'+ISNULL(@TEXTLIKE,'')+'%'
		 
		IF UPPER(@FILTERCAPTION)='Year' 
		BEGIN
			SELECT DISTINCT JcmYr as Filtervalues FROM JCMAST (NOLOCK) WHERE CAST(JCMYR AS VARCHAR(10)) LIKE @textlike 			
		END 
		IF UPPER(@FILTERCAPTION)='Month'
		BEGIN
			SELECT DISTINCT [MONTHNAME] as Filtervalues FROM MONTHDT WHERE [MONTHNAME] LIKE @textlike 			
		END 
		
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_GR_CtgWiseTargetForGSTIN')
DROP PROCEDURE Proc_GR_CtgWiseTargetForGSTIN 
GO
--Exec Proc_GR_ProgramRtrUtilization '','2019-01-01','2020-07-31','','','','','',''
CREATE PROCEDURE Proc_GR_CtgWiseTargetForGSTIN
(    
  @Pi_RptName  NVARCHAR(100),    
  @Pi_FromDate DATETIME,    
  @Pi_ToDate   DATETIME,    
  @Pi_Filter1  NVARCHAR(100),    
  @Pi_Filter2  NVARCHAR(100),
  @Pi_Filter3  NVARCHAR(100),
  @Pi_Filter4  NVARCHAR(100),
  @Pi_Filter5  NVARCHAR(100),
  @Pi_Filter6  NVARCHAR(100)
)    
AS     
/*********************************
* PROCEDURE		: Proc_GR_CtgWiseTargetForGSTIN
* PURPOSE		: To generate the Retailer wise Target report
* CREATED		: S.Mohana 
* CREATED DATE	: 12-10-2020
* PMS NO		: PARCS202100057
*********************************/
BEGIN    
  SET @Pi_FILTER1='%'+ISNULL(@Pi_FILTER1,'')+'%'            
  SET @Pi_FILTER2='%'+ISNULL(@Pi_FILTER2,'')+'%'
  SET @Pi_FILTER3='%'+ISNULL(@Pi_FILTER3,'')+'%'             
  SET @Pi_FILTER4='%'+ISNULL(@Pi_FILTER4,'')+'%' 
  SET @Pi_FILTER5='%'+ISNULL(@Pi_FILTER5,'')+'%'      
  SET @Pi_FILTER6='%'+ISNULL(@Pi_FILTER6,'')+'%'  

  SELECT 'Group Wise Target For GSTIN',A.CtgCode,A.CtgName,ValidMonth [Month],ValidYear [Year],TargetAmt,EffectiveDate 
  FROM RetailerTargetForGSTIN A   
  WHERE ValidMonth like @Pi_FILTER1 AND ValidYear Like @Pi_FILTER2
			 
END
GO
DELETE FROM ManualConfiguration WHERE ProjectName='PARLE' AND ModuleId='RtrSalesTarget'
INSERT INTO ManualConfiguration
SELECT 'PARLE','RtrSalesTarget','Billing','If Rtr Sales Exceeds,Scheme & CP will not Apply',1,0,0.00,1
GO
--Added By Mary
---CRCRSTPAR0105
DELETE FROM CustomCaptions WHERE TransId=45 AND CtrlName='fxtContribution'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 45,121,1,'fxtContribution','','Press Space bar / Double click to Select Contribute Scheme','Press Space bar / Double click to Select Contribute Scheme',1,1,1,GETDATE(),1,GETDATE(),'','Press Space bar / Double click to Select Contribute Scheme','Press Space bar / Double click to Select Contribute Scheme',1,1 UNION ALL
SELECT 45,100121,1,'fxtContribution','Contribution','','',1,1,1,GETDATE(),1,GETDATE(),'','','',1,1
GO
DELETE FROM CustomCaptions WHERE TransId=45 AND CtrlName='lblContribution'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 45,122,1,'lblContribution','Contribute Scheme','Contribute Scheme','',1,1,1,GETDATE(),1,GETDATE(),'Contribute Scheme','','',1,1
GO
DELETE FROM ScreenDefaultValues WHERE TransId=45 AND CtrlId=121
INSERT INTO ScreenDefaultValues (TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
SELECT 45,121,0,'NO',1,1,1,1,GETDATE(),1,GETDATE(),'NO' UNION 
SELECT 45,121,1,'YES',2,1,1,1,GETDATE(),1,GETDATE(),'YES'
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Etl_Prk_SchemeHD_Slabs_Rules' AND name='ContriPercentageScheme')
BEGIN
	ALTER TABLE Etl_Prk_SchemeHD_Slabs_Rules ADD ContriPercentageScheme  NVARCHAR(10) NULL
END
GO
UPDATE Etl_Prk_SchemeHD_Slabs_Rules SET ContriPercentageScheme ='NO' WHERE ContriPercentageScheme IS NULL
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SchemeMaster' AND name='ContriPercentageScheme')
BEGIN
	ALTER TABLE SchemeMaster ADD ContriPercentageScheme INT  NULL
END
GO
UPDATE SchemeMaster SET ContriPercentageScheme =0 WHERE ContriPercentageScheme IS NULL
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='ETL_Prk_SchemeMaster_Temp' AND name='ContriPercentageScheme')
BEGIN
	ALTER TABLE ETL_Prk_SchemeMaster_Temp ADD ContriPercentageScheme  NVARCHAR(10)
END
GO
UPDATE ETL_Prk_SchemeMaster_Temp SET ContriPercentageScheme ='NO' WHERE ContriPercentageScheme IS NULL
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME='OrgFromDate' AND id=OBject_ID ('SchemeMaster'))
BEGIN
	ALTER TABLE SchemeMaster ADD OrgFromDate DATETIME 
END
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME='OrgFromDate' AND id=OBject_ID ('ContractPricingMaster'))
BEGIN
	ALTER TABLE ContractPricingMaster ADD OrgFromDate DATETIME 
END
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME='OrgFromDate' AND id=OBject_ID ('ETL_Prk_SchemeMaster_Temp'))
BEGIN
	ALTER TABLE ETL_Prk_SchemeMaster_Temp ADD OrgFromDate DATETIME 
END
GO
UPDATE SchemeMaster SET OrgFromDate = SchValidFrom WHERE OrgFromDate IS NULL
GO
UPDATE ContractPricingMaster SET OrgFromDate = ValidFromDate WHERE OrgFromDate IS NULL
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_SchProductCategoryContriPerc')
DROP TABLE Cn2Cs_Prk_SchProductCategoryContriPerc
GO
CREATE TABLE [dbo].[Cn2Cs_Prk_SchProductCategoryContriPerc](
	[DistCode] [nvarchar](50) NULL,
	[PrdCatLevelCode][nvarchar](200) NULL,
	[PrdCategoryCode][nvarchar](200) NULL,
	[DefineContriPerc] [numeric](18,2) NULL,
	[DownLoadFlag] [nvarchar](10) NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='SchProductCategoryContriPercentage')
BEGIN
CREATE TABLE [dbo].[SchProductCategoryContriPercentage](
	[PrdLevelCode] [nvarchar] (200) NULL,
	[PrdCatCode] [nvarchar] (200) NULL,
	[PrdCatLevelId] [int] NULL,
	[PrdCtgValMainId] [int] NULL,
	[DefineContriPerc] [numeric](18,2) NULL,
	[Upload] [int] NULL,
	[DownloadDate] [datetime] NULL,
	[PStatus] [int] NULL,
	[Availability] [int] NULL
) ON [PRIMARY]
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='BK_SchProductCategoryContriPercentage')
BEGIN
CREATE TABLE [dbo].[BK_SchProductCategoryContriPercentage](
	[PrdLevelCode] [nvarchar] (200) NULL,
	[PrdCatCode] [nvarchar] (200) NULL,
	[PrdCatLevelId] [int] NULL,
	[PrdCtgValMainId] [int] NULL,
	[DefineContriPerc] [numeric](18,2) NULL,
	[Upload] [int] NULL,
	[DownloadDate] [datetime] NULL,
	[PStatus] [int] NULL,
	[Availability] [int] NULL,
	[BKDate] [datetime] NULL
) ON [PRIMARY]
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Import_SchProductCategoryContriPerc')
DROP PROCEDURE Proc_Import_SchProductCategoryContriPerc
GO
CREATE PROCEDURE Proc_Import_SchProductCategoryContriPerc
(
	@Pi_Records TEXT
)
AS
/***************************************************************************************************************************************   
* PROCEDURE		: Proc_Import_SchProductCategoryContriPerc
* PURPOSE		: To Insert records from xml file in the Table Proc_Cn2Cs_SchProductCategoryContriPerc
* CREATED		: MarySubashini.S
* CREATED DATE	: 27-11-2020
* MODIFIED
* DATE			AUTHOR				CR/BZ	USERSTORYID           DESCRIPTION                           
******************************************************************************************************************************************   
* 27-11-2020	MarySubashini.S		CR		CRCRSTPAR0105		 Scheme based on product category contribution percentage 
******************************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @hDoc INTEGER
	
	EXEC sp_xml_preparedocument @hDoc OUTPUT,@Pi_Records
	INSERT INTO Cn2Cs_Prk_SchProductCategoryContriPerc
	(
		DistCode,
		PrdCatLevelCode,
		PrdCategoryCode,
		DefineContriPerc,
		DownLoadFlag,
		CreatedDate
	)
	SELECT DistCode,
			PrdCatLevelCode,
			PrdCategoryCode,
			DefineContriPerc,
			DownLoadFlag,
			CreatedDate
	FROM OPENXML (@hdoc,'/Root/Console2CS_SchProductCategoryContriPerc',1)
	WITH
	(
		DistCode			NVARCHAR(50) ,
		PrdCatLevelCode		NVARCHAR(200),
		PrdCategoryCode		NVARCHAR(200),
		DefineContriPerc	NUMERIC(18,2),
		DownLoadFlag		NVARCHAR(10) ,
		CreatedDate			DATETIME
	) XMLObj
	EXEC sp_xml_removedocument @hDoc
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cn2Cs_SchProductCategoryContriPerc')
DROP PROCEDURE Proc_Cn2Cs_SchProductCategoryContriPerc
GO
/*  
BEGIN TRAN  
delete from errorlog  
EXEC Proc_Cn2Cs_SchProductCategoryContriPerc 0  
SELECT * FROM errorlog  
SELECT * FROM Cn2Cs_Prk_SchProductCategoryContriPerc 
ROLLBACK TRAN  
*/  
CREATE PROCEDURE Proc_Cn2Cs_SchProductCategoryContriPerc
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/***************************************************************************************************************************************   
* PROCEDURE  : Proc_Cn2Cs_SchProductCategoryContriPerc  
* PURPOSE  : To validate the downloaded Scheme based on product category contribution percentage  
* CREATED  : MarySubashini.S
* CREATED DATE : 27-11-2020
* MODIFIED  
* DATE			AUTHOR				CR/BZ	USERSTORYID           DESCRIPTION                           
******************************************************************************************************************************************   
* 27-11-2020	MarySubashini.S		CR		CRCRSTPAR0105		 Scheme based on product category contribution percentage 
******************************************************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
		SET @Po_ErrNo=0  
   
		DELETE FROM Cn2Cs_Prk_SchProductCategoryContriPerc WHERE DownLoadFlag='Y' 

		IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_SchProductCategoryContriPerc (NOLOCK) WHERE DownLoadFlag='D')  
		BEGIN  
			RETURN  
		END 
		 
		SELECT DISTINCT PrdCategoryCode,MAX(CreatedDate)  Mxdate INTO  #Duplicate  
		FROM Cn2Cs_Prk_SchProductCategoryContriPerc  WHERE DownloadFlag='D'
		GROUP BY  PrdCategoryCode 
 
		SELECT DISTINCT C.* INTO #Cn2Cs_Prk_SchProductCategoryContriPerc  
		FROM Cn2Cs_Prk_SchProductCategoryContriPerc  C 
		INNER JOIN #Duplicate D on C.PrdCategoryCode=D.PrdCategoryCode AND D.Mxdate=C.CreatedDate  
		WHERE C.DownloadFlag='D'
		 
		IF EXISTS (SELECT DISTINCT PrdCategoryCode FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A WHERE NOT EXISTS(
		SELECT CmpPrdCtgName FROM ProductCategoryLevel B (NOLOCK) WHERE A.PrdCatLevelCode=B.CmpPrdCtgName))
		BEGIN

			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
			SELECT 1,'Cn2Cs_Prk_SchProductCategoryContriPerc',PrdCatLevelCode,'Level Name Not Available' 
			FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A (NOLOCK) WHERE NOT EXISTS(
			SELECT CmpPrdCtgName FROM ProductCategoryLevel B (NOLOCK) WHERE A.PrdCatLevelCode=B.CmpPrdCtgName)

			DELETE A FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A WHERE NOT EXISTS(
			SELECT CmpPrdCtgName FROM ProductCategoryLevel B (NOLOCK) WHERE A.PrdCatLevelCode=B.CmpPrdCtgName)
		END

		IF EXISTS (SELECT DISTINCT PrdCategoryCode FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A WHERE NOT EXISTS(
		SELECT PrdCtgValCode FROM ProductCategoryValue B (NOLOCK) WHERE A.PrdCategoryCode=B.PrdCtgValCode))
		BEGIN

			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
			SELECT 2,'Cn2Cs_Prk_SchProductCategoryContriPerc',PrdCategoryCode,'Category Code Not Available' 
			FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A (NOLOCK) WHERE NOT EXISTS(
			SELECT PrdCtgValCode FROM ProductCategoryValue B (NOLOCK) WHERE A.PrdCategoryCode=B.PrdCtgValCode)

			DELETE A FROM #Cn2Cs_Prk_SchProductCategoryContriPerc A WHERE NOT EXISTS(
			SELECT PrdCtgValCode FROM ProductCategoryValue B (NOLOCK) WHERE A.PrdCategoryCode=B.PrdCtgValCode)
		END

    
		INSERT INTO BK_SchProductCategoryContriPercentage(PrdLevelCode,PrdCatCode,PrdCatLevelId,PrdCtgValMainId,DefineContriPerc,Upload,DownloadDate,PStatus,Availability,BKDate)
		SELECT A.PrdLevelCode,A.PrdCatCode,A.PrdCatLevelId,A.PrdCtgValMainId,A.DefineContriPerc,A.Upload,A.DownloadDate,A.PStatus,A.Availability,GETDATE() 
		FROM SchProductCategoryContriPercentage A 
		INNER JOIN ProductCategoryValue B ON B.PrdCtgValMainId =A.PrdCtgValMainId  
		INNER JOIN ProductCategoryLevel C ON C.CmpPrdCtgId =A.PrdCatLevelId 
		INNER JOIN #Cn2Cs_Prk_SchProductCategoryContriPerc D ON B.PrdCtgValCode =D.PrdCategoryCode  
		AND C.CmpPrdCtgName =D.PrdCatLevelCode 

		DELETE A FROM SchProductCategoryContriPercentage A 
		INNER JOIN ProductCategoryValue B ON B.PrdCtgValMainId =A.PrdCtgValMainId  
		INNER JOIN ProductCategoryLevel C ON C.CmpPrdCtgId =A.PrdCatLevelId 
		INNER JOIN #Cn2Cs_Prk_SchProductCategoryContriPerc D ON B.PrdCtgValCode =D.PrdCategoryCode  
		AND C.CmpPrdCtgName =D.PrdCatLevelCode 
   
		INSERT INTO SchProductCategoryContriPercentage(PrdLevelCode,PrdCatCode,PrdCatLevelId,PrdCtgValMainId,DefineContriPerc,Upload,DownloadDate,PStatus,Availability)  
		SELECT DISTINCT A.PrdCatLevelCode,A.PrdCategoryCode,C.CmpPrdCtgId,B.PrdCtgValMainId,DefineContriPerc,0,GETDATE(),1,1 FROM #Cn2Cs_Prk_SchProductCategoryContriPerc  A 
		INNER JOIN ProductCategoryValue B (NOLOCK) ON A.PrdCategoryCode=B.PrdCtgValCode
		INNER JOIN ProductCategoryLevel C (NOLOCK) ON A.PrdCatLevelCode=C.CmpPrdCtgName
		 
		UPDATE A SET DownloadFlag='Y' FROM Cn2Cs_Prk_SchProductCategoryContriPerc A 
		INNER JOIN #Cn2Cs_Prk_SchProductCategoryContriPerc B  ON A.PrdCategoryCode=B.PrdCategoryCode
				
 RETURN  
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cn2Cs_BLSchemeMaster')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeMaster
GO
/*
BEGIN TRANSACTION
update schememaster set schstatus = 0 where cmpschcode = 'SCH00007'
EXEC Proc_Cn2Cs_BLSchemeMaster 0
select *from schememaster where cmpschcode = 'SCH00007'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************
* PROCEDURE	: Proc_Cn2Cs_BLSchemeMaster
* PURPOSE	: To Insert and Update records Of Scheme Master
* CREATED	: Boopathy.P on 31/12/2008
* DATE         AUTHOR       DESCRIPTION
***************************************************************************************************************************
* 25.08.2009   Panneer		Added BudgetAllocationNo in SchemeMaster Table
* 20.10.2009   Thiru		Added SchBasedOn in SchemeMaster Table		
* 22/04/2010   Nanda 		Added FBM
* 28/12/2010   Nanda 		Added Settlement Type
****************************************************************************************************************************   
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]  
* 03
03-01-2018  Lakshman. M      ICRSTPAR7277        BUG      Scheme description amp;  (special character)Script validation added from CS.  
18-06-2018	Karthick.KJ		 CRCRSTPAR0007		 CR		  Claim Apply with/Without Tax
11-04-2019	MARY			 CRCRSTPAR0039		 CR		  new Columns added  NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount		
26-11-2020	MarySubashini.S	 CRCRSTPAR0105		 CR		  Scheme based on product category contribution percentage 
17-11-2020	MOHANA S		 PARCS202100059      CR		  Fromdate included based on Serverdate	

********************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 		AS NVARCHAR(100)
	DECLARE @SchDesc 		AS NVARCHAR(200)
	DECLARE @CmpCode 		AS NVARCHAR(50)
	DECLARE @ClmAble 		AS NVARCHAR(50)
	DECLARE @ClmAmtOn 		AS NVARCHAR(50)
	DECLARE @ClmGrpCode		AS NVARCHAR(50)
	DECLARE @SelnOn			AS NVARCHAR(50)
	DECLARE @SelLvl			AS NVARCHAR(50)
	DECLARE @SchType		AS NVARCHAR(50)
	DECLARE @BatLvl			AS NVARCHAR(50)
	DECLARE @FlxSch			AS NVARCHAR(50)
	DECLARE @FlxCond		AS NVARCHAR(50)
	DECLARE @CombiSch		AS NVARCHAR(50)
	DECLARE @Range			AS NVARCHAR(50)
	DECLARE @ProRata		AS NVARCHAR(50)
	DECLARE @Qps			AS NVARCHAR(50)
	DECLARE @QpsReset		AS NVARCHAR(50)
	DECLARE @ApyQpsOn		AS NVARCHAR(50)
	DECLARE @ForEvery		AS NVARCHAR(50)
	DECLARE @SchStartDate	AS NVARCHAR(50)
	DECLARE @SchEndDate		AS NVARCHAR(50)
	DECLARE @SchBudget		AS NVARCHAR(50)
	DECLARE @EditSch		AS NVARCHAR(50)
	DECLARE @AdjDisSch		AS NVARCHAR(50)
	DECLARE @SetDisMode		AS NVARCHAR(50)
	DECLARE @SchStatus		AS NVARCHAR(50)
	DECLARE @SchBasedOn		AS NVARCHAR(50)
	DECLARE @StatusId		AS INT
	DECLARE @CmpId			AS INT
	DECLARE @ClmGrpId		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @ClmableId		AS INT
	DECLARE @ClmAmtOnId		AS INT
	DECLARE @SelMode		AS INT
	DECLARE @SchTypeId		AS INT
	DECLARE @BatId			AS INT
	DECLARE @FlexiId		AS INT
	DECLARE @FlexiConId		AS INT
	DECLARE @CombiId		AS INT
	DECLARE @RangeId		AS INT
	DECLARE @ProRateId		AS INT
	DECLARE @QPSId			AS INT
	DECLARE @QPSResetId		AS INT
	DECLARE @AdjustSchId	AS INT
	DECLARE @ApplySchId		AS INT
	DECLARE @ForEveryId		AS INT
	DECLARE @SettleSchId	AS INT
	DECLARE @EditSchId		AS INT
	DECLARE @ChkCount		AS INT		
	DECLARE @ConFig			AS INT
	DECLARE @CmpCnt			AS INT
	DECLARE @EtlCnt			AS INT
	DECLARE @SLevel			AS INT
	DECLARE @SchBasedOnId	AS INT
	DECLARE @ErrDesc		AS NVARCHAR(1000)
	DECLARE @TabName		AS NVARCHAR(50)
	DECLARE @GetKey			AS INT
	DECLARE @GetKeyStr		AS NVARCHAR(200)
	DECLARE @Taction		AS INT
	DECLARE @sSQL			AS VARCHAR(4000)
	DECLARE @iCnt			AS INT
	DECLARE @BudgetAllocationNo	AS NVARCHAR(100)
	DECLARE @FBM				AS NVARCHAR(10)
	DECLARE @FBMId				AS INT
	DECLARE @SettlementType		AS NVARCHAR(10)
	DECLARE @SettlementTypeId	AS INT
	DECLARE @FBMDate			AS DATETIME
	DECLARE @AllowUnCheck		AS NVARCHAR(10)
	DECLARE @AllowUnCheckId		AS INT
	DECLARE @CombiType			AS NVARCHAR(50)
	DECLARE @CombiTypeId		AS INT
	DECLARE @SchApplyOn			AS VARCHAR(100)
	DECLARE @SchApplyOnId		AS INT
	DECLARE @ApplyTaxForClaim   AS VARCHAR(50)
	DECLARE @ApplyTax			AS INT
	DECLARE @NoOfMonth AS TINYINT --CRCRSTPAR0039
	DECLARE @Growth_Factor AS NUMERIC(18,2)
	DECLARE @Add_Growth_Factor AS NUMERIC(18,2)
	DECLARE @Cap_Amount AS NUMERIC(18,2)
	DECLARE @Validate_Cap AS VARCHAR(10)
	DECLARE @Validate_Cap_Id AS TINYINT
	DECLARE @ContriPercentageScheme	AS NVARCHAR(50) --CRCRSTPAR0105
	DECLARE @ContriPercentageSchemeId	AS INT --CRCRSTPAR0105
	DECLARE @FromDate DATETIME 
	
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	SET @AdjustSchId=0
	SET @iCnt=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE @DistCode AS  NVARCHAR(50)
	SELECT @DistCode=ISNULL(DistributorCode,'') FROM Distributor
	---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
	Declare @Lvar Int  
	Declare @MaxId Int
	Declare @SqlStr Varchar(8000)  
	Declare @Process Varchar(100)  
	Declare @colcount Int  
	Declare @Col Varchar(5000)
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Etl_Prk_SchemeHD_Slabs_Rules'
	And A.system_type_id = C.system_type_id And C.name='nvarchar' and A.column_id= 3
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ---------------------------------- Till here -------------------
	
	--->Added By Nanda on 17/09/2009
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SchToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SchToAvoid	
	END
	
	CREATE TABLE SchToAvoid
	(
		CmpSchCode NVARCHAR(50)
	)
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
	WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product'))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','CmpSchCode','Product :'+PrdCode+' not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)		
		SELECT @DistCode,'Scheme',CmpSchCode,'Product',PrdCode,'','N'
		FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND 
		CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Attributes','Attributes not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Products','Scheme Products not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
	END
	
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Header','Header not Available for Scheme:'+CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
	END
	
	--->Till Here
	DECLARE Cur_SchMaster CURSOR
	FOR SELECT DISTINCT
	ISNULL([CmpSchCode],'') AS [Company Scheme Code],
	ISNULL([SchDsc],'') AS [Scheme Description],
	ISNULL([CmpCode],'') AS [Company Code],
	ISNULL([Claimable],'') AS [Claimable],
	ISNULL([ClmAmton],'') AS [Claim Amount On],
	ISNULL([ClmGroupCode],'') AS [Claim Group Code],
	ISNULL([SchemeLevelMode],'') AS [Selection On],
	ISNULL([SchLevel],'') AS [Selection Level Value],
	ISNULL([SchType],'') AS [Scheme Type],
	ISNULL([BatchLevel],'') AS [Batch Level],
	ISNULL([FlexiSch],'') AS [Flexi Scheme],
	ISNULL([FlexiSchType],'') AS [Flexi Conditional],
	ISNULL([CombiSch],'') AS [Combi Scheme],
	ISNULL([Range],'') AS [Range],
	ISNULL([ProRata],'') AS [Pro - Rata],
	ISNULL([Qps],'NO') AS [Qps],
	ISNULL([QPSReset],'') AS [Qps Reset],
	ISNULL([ApyQPSSch],'') AS [Qps Based On],
	ISNULL([PurofEvery],'') AS [Allow For Every],
	ISNULL([SchValidFrom],'') AS [Scheme Start Date],
	ISNULL([SchValidTill],'') AS [Scheme End Date],
	ISNULL([Budget],'') AS [Scheme Budget],
	ISNULL([EditScheme],'') AS [Allow Editing Scheme],
	ISNULL([AdjWinDispOnlyOnce],'0') AS [Adjust Display Once],
	ISNULL([SetWindowDisp],'') AS [Settle Display Through],
	ISNULL(SchStatus,'') AS SchStatus,
	--ISNULL(BudgetAllocationNo,'') AS BudgetAllocationNo,
	ISNULL(CircularNo,'') AS BudgetAllocationNo,
	ISNULL(SchBasedOn,'') AS SchemeBasedOn,
	ISNULL(FBM,'No') AS FBM,
	ISNULL(SettlementType,'ALL') AS SettlementType,
	ISNULL([AllowUncheck],'NO') AS AllowUncheck,
	ISNULL([CombiType],'NORMAL') AS [CombiType],
	ISNULL(SchApplyOn,'SELLINGRATE') AS SchApplyOn,
	ISNULL(ApplyTaxForClaim,'YES') AS ApplyTaxForClaim,
	ISNULL(NoOfMonth,0) AS NoOfMonth, --CRCRSTPAR0039
	ISNULL(Growth_Factor,0) AS Growth_Factor,
	ISNULL(Add_Growth_Factor,0) AS Add_Growth_Factor,
	ISNULL(Validate_Cap,'NO') AS 	Validate_Cap,
	ISNULL(Cap_Amount,0) AS 	Cap_Amount,
	ISNULL(ContriPercentageScheme,'NO') ContriPercentageScheme --CRCRSTPAR0105
	FROM Etl_Prk_SchemeHD_Slabs_Rules (NOLOCK)
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'			 
	ORDER BY [Company Scheme Code]
	OPEN Cur_SchMaster
	FETCH NEXT FROM Cur_SchMaster INTO @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
	, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
	, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
	@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim,
	@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme --CRCRSTPAR0039/CRCRSTPAR0105
	WHILE @@FETCH_STATUS=0
	BEGIN
		SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer

		IF (DATEPART(MM,@SchStartDate) <> DATEPART (MM,@FromDate)) OR (YEar(@SchStartDate)<> YEar( @FromDate))
		BEGIN
			SET @FromDate = @SchStartDate
		END
		ELSE
		BEGIN
			SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer
		END

		SET @CombiTypeId=0	
		SET @SchBasedOn='RETAILER'
		SET @Po_ErrNo =0		
		SET @Taction = 2
		SET @iCnt=@iCnt+1
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchDesc))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Description should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (2,@TabName,'Scheme Description',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CmpCode))= ''
		BEGIN
			SET @ErrDesc = 'Company should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (3,@TabName,'Company',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAble))= ''
		BEGIN
			SET @ErrDesc = 'Claimable should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (4,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAmtOn))= ''
		BEGIN
			SET @ErrDesc = 'Claim Amount On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (5,@TabName,'Claim Amount On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (6,@TabName,'Scheme Level Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelLvl))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (7,@TabName,'Scheme Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchType))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (8,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@BatLvl))= ''
		BEGIN
			SET @ErrDesc = 'Batch Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (9,@TabName,'Batch Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxSch))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (10,@TabName,'Flexi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxCond))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (11,@TabName,'Flexi Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiSch))= ''
		BEGIN
			SET @ErrDesc = 'Combi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (12,@TabName,'Combi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Range))= ''
		BEGIN
			SET @ErrDesc = 'Range should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (13,@TabName,'Range Based Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ProRata))= ''
		BEGIN
			SET @ErrDesc = 'Pro-Rata should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (14,@TabName,'Pro-Rata',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Qps))= ''
		BEGIN
			SET @ErrDesc = 'QPS Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (15,@TabName,'QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@QpsReset))= ''
		BEGIN
			SET @ErrDesc = 'QPS Reset should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (16,@TabName,'QPS Reset',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ApyQpsOn))= ''
		BEGIN
			SET @ErrDesc = 'Apply QPS Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (17,@TabName,'Apply QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStartDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Start Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (19,@TabName,'Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchStartDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme Start Date is not Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (20,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchStartDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme Start Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (21,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchEndDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme End Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (23,@TabName,'End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchEndDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme End Date is not in Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (24,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchEndDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme End Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (25,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@EditSch))= ''
		BEGIN
			SET @ErrDesc = 'Allow Editing Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (28,@TabName,'Editing Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SetDisMode))= ''
		BEGIN
			SET @ErrDesc = 'Settle Window Display Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (30,@TabName,'Settle Window Display Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Selection On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (31,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStatus))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Status should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (32,@TabName,'Scheme Status',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchBasedOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiType))= ''
		BEGIN
			SET @ErrDesc = 'CombiType should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchApplyOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END 
		IF ((UPPER(LTRIM(RTRIM(@CombiType)))<> 'NORMAL') AND (UPPER(LTRIM(RTRIM(@CombiType)))<> 'FLUCTUATING'))
		BEGIN
			SET @ErrDesc = 'CombiType should be (NORMAL OR FLUCTUATING) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'SELLINGRATE') AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'MRP') 
		AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'PURCHASERATE'))
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should be (SELLINGRATE OR MRP OR PURCHASERATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'RETAILER') AND (UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'KEY GROUP'))
		BEGIN
			SET @ErrDesc = 'Scheme Based On should be (RETAILER OR KEY GROUP) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SelnOn)))<> 'UDC') AND (UPPER(LTRIM(RTRIM(@SelnOn)))<> 'PRODUCT'))
		BEGIN
			SET @ErrDesc = 'Selection On should be (UDC OR PRODUCT) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (33,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@ClmAble)))<> 'YES') AND (UPPER(LTRIM(RTRIM(@ClmAble)))<> 'NO'))
		BEGIN
			SET @ErrDesc = 'Claimable should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (34,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchStatus)))<> 'ACTIVE') AND (UPPER(LTRIM(RTRIM(@SchStatus)))<> 'INACTIVE'))
		BEGIN
			SET @ErrDesc = 'Scheme Stauts should be (ACTIVE OR INACTIVE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (35,@TabName,'Scheme Stauts',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES')
		BEGIN
			IF LTRIM(RTRIM(@ClmGrpCode))= ''
			BEGIN
				SET @ErrDesc = 'Claim Group Code should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (36,@TabName,'Claim Group Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'PURCHASE RATE' AND UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'SELLING RATE')
		BEGIN
			SET @ErrDesc = 'Claimable Amount should be (PURCHASE RATE OR SELLING RATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (37,@TabName,'Claimable Amount',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@SchType)))<>'WINDOW DISPLAY' AND UPPER(LTRIM(RTRIM(@SchType)))<>'AMOUNT'
		   AND UPPER(LTRIM(RTRIM(@SchType)))<>'WEIGHT' AND UPPER(LTRIM(RTRIM(@SchType)))<>'QUANTITY')
		BEGIN
			SET @ErrDesc = 'Scheme Type should be (WINDOW DISPLAY OR AMOUNT OR WEIGHT OR QUANTITY) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (38,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		--CRCRSTPAR0007
		IF (UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))<> 'NO')
		BEGIN
			SET @ErrDesc = 'ApplyTaxForClaim) should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'ApplyTaxForClaim',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY')
		BEGIN
			IF (UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL')
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (39,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (40,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (41,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (42,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (43,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (44,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (NO) for WINDOW DISPLAY SCHEME for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (45,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (NO)for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (46,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LTRIM(RTRIM(@AdjDisSch))= ''
			BEGIN
				SET @ErrDesc = 'Adjust Window Display Scheme Only Once should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (47,@TabName,'Adjust Window Display Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH' AND UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CHEQUE')
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH OR CHEQUE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (48,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE')
			BEGIN
				SET @ErrDesc = 'Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (50,@TabName,'Apply QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT' AND UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
			AND UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY')
		BEGIN
			IF UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL'
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (51,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL' AND UPPER(LTRIM(RTRIM(@FlxCond)))<> 'CONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL OR CONDITIONAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (53,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL')
				BEGIN
					SET @ErrDesc = 'Flexi Scheme Type should be UNCONDITIONAL When Flexi Scheme is YES for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (54,@TabName,'Flexi Scheme Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (55,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (56,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   OR UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (57,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then RANGE should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (58,@TabName,'Range',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then PRO-RATA should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (59,@TabName,'Pro-Rata',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (60,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'YES' AND UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (61,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO, Then QPS Reset should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (62,@TabName,'QPS Reset',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO,Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (63,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE' AND UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'QUANTITY'
				BEGIN
					SET @ErrDesc = 'Apply QPS Scheme Should be (DATE OR QUANTITY) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (64,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH'
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (65,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'YES' AND UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Allow uncheck claimable should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Allow Uncheck',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF NOT EXISTS(SELECT CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode)))
			BEGIN
				SET @ErrDesc = 'Company Not Found for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (66,@TabName,'Company',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @CmpId=CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode))
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			SET @GetKey=0
			SET @GetKeyStr=''
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster SM WHERE CMPID=@CmpId AND SM.CmpSchCode=LTRIM(RTRIM(@SchCode)))
			BEGIN
				SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('SchemeMaster','SchId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
				SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('SchemeMaster','SchCode',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))				
				SET @Taction = 2
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@GetKeyStr=SchCode FROM SchemeMaster WHERE CMPID=@CmpId AND CmpSchCode=LTRIM(RTRIM(@SchCode))
				SET @Taction = 1
			END
		END
		IF @GetKey=0	
		BEGIN
			SET @ErrDesc = 'Scheme Id should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Id',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LEN(LTRIM(RTRIM(@GetKeyStr )))=''
		BEGIN
			SET @ErrDesc = 'Scheme Code should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF @Taction = 2
		BEGIN 
			IF @GetKey<=(SELECT ISNULL(MAX(SchId),0) AS SchId FROM SchemeMaster)
			BEGIN
				SET @ErrDesc = 'Reset the counters/Check the system date'
				INSERT INTO Errorlog VALUES (67,@TabName,'SchId',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'RETAILER'
				SET @SchBasedOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'KEY GROUP'
				SET @SchBasedOnId=2
		END 
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ClmAble)))='YES'
			BEGIN
				IF NOT EXISTS(SELECT ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode)))
				BEGIN
					SET @ErrDesc = 'Claim Group Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (67,@TabName,'Claim Group',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @ClmGrpId=ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode))
				END
			END
			ELSE
			BEGIN
				SET @ClmGrpId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SelnOn)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@SelnOn)))='SKU' OR UPPER(LTRIM(RTRIM(@SelnOn)))='MATERIAL'
			BEGIN
				IF NOT EXISTS(SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=UPPER(LTRIM(RTRIM(@SelLvl))) AND LevelName <> 'Level1')
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (68,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=LTRIM(RTRIM(@SelLvl)) AND LevelName <> 'Level1'
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))='UDC'
			BEGIN
				IF NOT EXISTS(SELECT DISTINCT A.UdcMasterId FROM UdcMaster A
					INNER JOIN UdcHD B ON A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl)))
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (69,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=A.UdcMasterId FROM UdcMaster A INNER JOIN UdcHD B ON
					A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl))
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'ACTIVE'
				SET @StatusId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'INACTIVE'
				SET @StatusId=0
			IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES'
				SET @ClmableId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'NO'
				SET @ClmableId=0
			
			IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'PURCHASE RATE'
				SET @ClmAmtOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'SELLING RATE'
				SET @ClmAmtOnId=2
			
			IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'UDC'
				SET @SelMode=1
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'PRODUCT'
				SET @SelMode=0
			
			IF UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY'
				SET @SchTypeId=4
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT'
				SET @SchTypeId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
				SET @SchTypeId=3
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY'
				SET @SchTypeId=1
			
			IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'YES'
				SET @BatId=1
			ELSE IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))= 'ALL'
				SET @BatId=0
			
			
			IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'YES'
				SET @FlexiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO'
				SET @FlexiId=0
			
			IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'UNCONDITIONAL'
				SET @FlexiConId=2
			ELSE IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL'
				SET @FlexiConId=1
			ELSE
				SET @FlexiConId=2
			
			IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'YES'				
				SET @CombiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'NO'
				SET @CombiId=0
			IF UPPER(LTRIM(RTRIM(@CombiType)))= 'FLUCTUATING'
				SET @CombiTypeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NORMAL'
				SET @CombiTypeId=0
			
			IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'MRP'				
				SET @SchApplyOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'SELLINGRATE'
				SET @SchApplyOnId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'PURCHASERATE'
				SET @SchApplyOnId=3
				
			
			IF UPPER(LTRIM(RTRIM(@Range)))= 'YES'
				SET @RangeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NO'
				SET @RangeId=0
			
			IF UPPER(LTRIM(RTRIM(@ProRata)))= 'YES'
				SET @ProRateId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'NO'
				SET @ProRateId=0
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'ACTUAL'
				SET @ProRateId=2
			
			IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
				SET @QPSId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
				SET @QPSId=0
			
			IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'YES'
				SET @ForEveryId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'NO'
				SET @ForEveryId=0
			IF UPPER(LTRIM(RTRIM(@EditSch)))= 'YES'
				SET @EditSchId=0
			ELSE IF UPPER(LTRIM(RTRIM(@EditSch)))= 'NO'
				SET @EditSchId=0
			IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				SET @QPSResetId=1
			ELSE IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'NO'
				SET @QPSResetId=0
			IF LTRIM(RTRIM(@SchBudget))= ''
			BEGIN
				SET @SchBudget=0
			END
			
			IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'YES'
			BEGIN
				SET @ApplyTax=1
			END	
			ELSE IF UPPER(LTRIM(RTRIM(@ApplyTaxForClaim)))= 'NO'
			BEGIN
				SET @ApplyTax=0		
			END
			  
			IF @SchTypeId=4
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
					SET @ApplySchId=1
				IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CASH'
					SET @SettleSchId=1
				ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CHEQUE'
					SET @SettleSchId=2
				IF LTRIM(RTRIM(@AdjDisSch))= 'NO'
					SET @AdjustSchId=0
				ELSE IF LTRIM(RTRIM(@AdjDisSch))= 'YES'
					SET @AdjustSchId=1
			END
			ELSE
			BEGIN
				IF @QPSId=1
				BEGIN
					IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
						SET @ApplySchId=1
					ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))='QUANTITY'
						SET @ApplySchId=2
					SET @SettleSchId=1
				END
				ELSE
				BEGIN
					SET @SettleSchId=1
					SET @ApplySchId=1
				END
			END
		END
		
		
		IF UPPER(LTRIM(RTRIM(ISNULL(@Validate_Cap,'NO'))))= 'YES'
		BEGIN
			SET @Validate_Cap_Id=1
		END	
		ELSE IF UPPER(LTRIM(RTRIM(ISNULL(@Validate_Cap,'NO'))))= 'NO'
		BEGIN
			SET @Validate_Cap_Id=0		
		END
		--CRCRSTPAR0105
		IF UPPER(LTRIM(RTRIM(ISNULL(@ContriPercentageScheme,'NO'))))= 'YES'
		BEGIN
			SET @ContriPercentageSchemeId=1
		END	
		ELSE IF UPPER(LTRIM(RTRIM(ISNULL(@ContriPercentageScheme,'NO'))))= 'NO'
		BEGIN
			SET @ContriPercentageSchemeId=0		
		END
		ELSE 
		BEGIN
			SET @ContriPercentageSchemeId=0		
		END
		--CRCRSTPAR0105
		 		
		IF @Po_ErrNo = 0
		BEGIN
			IF @FBM='Yes'
			BEGIN
				SET @FBMId=1
				SET @SchBudget=0
			END
			ELSE
			BEGIN
				SET @FBMId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @SettlementType='Value'
			BEGIN
				SET @SettlementTypeId=1				
			END
			ELSE IF @SettlementType='Product'
			BEGIN
				SET @SettlementTypeId=2
			END
			ELSE 
			BEGIN
				SET @SettlementTypeId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@AllowUnCheck)))= 'YES'
			BEGIN
				SET @AllowUnCheckId=1
			END
			ELSE
			BEGIN
				SET @AllowUnCheckId=0
			END
		END
		 
		
		IF @Po_ErrNo = 0
		BEGIN
			IF @Taction=1
			BEGIN
				EXEC Proc_DependencyCheck 'SchemeMaster',@GetKey
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					UPDATE SCHEMEMASTER SET SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					--Budget=@SchBudget,SchStatus=@StatusId WHERE SchId=@GetKey
					Budget=@SchBudget,/*,SchStatus=@StatusId*/ 
					Validate_Cap=@Validate_Cap_Id,Cap_Amount=@Cap_Amount
					WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
				END
				ELSE
				BEGIN
					DELETE FROM SchemeProducts WHERE SchId=@GetKey
					DELETE FROM SchemeRetAttr WHERE SchId=@GetKey
					DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabFrePrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabMultiFrePrds WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRtrLevelValidation WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRuleSettings WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdDt WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdHd WHERE SchId=@GetKey
					DELETE FROM SchemeSlabs WHERE SchId=@GetKey
					
					UPDATE SCHEMEMASTER SET SchDsc=LTRIM(RTRIM(@SchDesc)),CmpId=@CmpId,
					Claimable=@ClmableId,ClmAmton=@ClmAmtOnId,ClmRefId=@ClmGrpId,
					SchLevelId=@CmpPrdCtgId,SchType=@SchTypeId,BatchLevel=@BatId,
					FlexiSch=@FlexiId,FlexiSchType=@FlexiConId,CombiSch=@CombiId,
					Range=@RangeId,ProRata=@ProRateId,QPS=@QPSId,QPSReset=@QPSResetId,
					SchValidFrom=LTRIM(RTRIM(@FromDate)),SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					Budget=@SchBudget,ApyQPSSch=@ApplySchId,SetWindowDisp=@SettleSchId,
					--SchemeLvlMode=@SelMode,SchStatus=@StatusId WHERE SchId=@GetKey
					SchemeLvlMode=@SelMode,/*,SchStatus=@StatusId*/ 
					Validate_Cap=@Validate_Cap_Id,Cap_Amount=@Cap_Amount,OrgFromDate =LTRIM(RTRIM(@SchStartDate)) 
					WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
					
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					and SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
				END
			END
			ELSE IF @Taction=2
			BEGIN
				IF @ConFig=1
				BEGIN
					SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
					IF @CmpPrdCtgId<@SLevel
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
	
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
						A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
					END
					ELSE
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
						AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
					END
						IF @EtlCnt=@CmpCnt
						BEGIN
							SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
	
							SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
							IF @EtlCnt=@CmpCnt
							BEGIN	
								INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
								AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,
								BudgetAllocationNo,AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,
								SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim,
								NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate)--CRCRSTPAR0105
								VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
								LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,
								CONVERT(VARCHAR(10),GETDATE(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,
								@BudgetAllocationNo,0,0,@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax,
								@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap_Id,@Cap_Amount,@ContriPercentageSchemeId,LTRIM(RTRIM(@SchStartDate)))--CRCRSTPAR0105
				
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
								IF @FBMId=1
								BEGIN
									SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
									SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
									EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								
								INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download,
								NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate) VALUES
								(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1,
								@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme,@SchStartDate)--CRCRSTPAR0105
							END
						END
						ELSE
						BEGIN
							DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							
							INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
							CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
							ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
							PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download,
							NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate) --CRCRSTPAR0105 
							VALUES
							(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
							@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
							@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
							@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1,
							@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme,@SchStartDate)--CRCRSTPAR0105
						END							
				END
				ELSE
				BEGIN
					INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
					CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
					ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
					PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
					AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,BudgetAllocationNo,
					AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,SettlementType,ApplyClaim,CombiType,ApplyTaxForClaim,
					NoOfMonth,Growth_Factor,Add_Growth_Factor,Validate_Cap,Cap_Amount,ContriPercentageScheme,OrgFromDate)--CRCRSTPAR0105
					VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
					LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
					@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
					@QPSResetId,LTRIM(RTRIM(@FromDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
					@ApplySchId,@SettleSchId,1,1,convert(varchar(10),getdate(),121),1,
					convert(varchar(10),getdate(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,@BudgetAllocationNo,0,0,
					@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId,@ApplyTax,
					@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap_Id,@Cap_Amount,@ContriPercentageSchemeId,@SchStartDate)--CRCRSTPAR0105
	
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					AND SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
					IF @FBMId=1
					BEGIN
						SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
						SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
						EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
					END
				END
			END
		END
		FETCH NEXT FROM Cur_SchMaster INTO  @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
		, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
		, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
		@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn,@ApplyTaxForClaim,
		@NoOfMonth,@Growth_Factor,@Add_Growth_Factor,@Validate_Cap,@Cap_Amount,@ContriPercentageScheme --CRCRSTPAR0105
	END
	CLOSE Cur_SchMaster
	DEALLOCATE Cur_SchMaster
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_CheckPrdCategorycontribution')
DROP PROCEDURE Proc_CheckPrdCategorycontribution
GO
--EXEC Proc_CheckPrdCategorycontribution 4683,1395,0,1,2
CREATE PROCEDURE Proc_CheckPrdCategorycontribution
(
	@Pi_SchId  		INT,
	@Pi_RtrId		INT,
	@Pi_SalId  		INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT	
)
AS
/***************************************************************************************************************************************   
* PROCEDURE  : Proc_CheckPrCategorycontribution  
* PURPOSE  : To Check the Scheme applicable condition based on   Product Category contribution percentage
* CREATED  : MarySubashini.S
* CREATED DATE : 27-11-2020
* MODIFIED  
* DATE			AUTHOR				CR/BZ	USERSTORYID           DESCRIPTION                           
******************************************************************************************************************************************   
* 27-11-2020	MarySubashini.S		CR		CRCRSTPAR0105		 Check the Scheme applicable condition based on   Product Category contribution percentage
******************************************************************************************************************************************/  
SET NOCOUNT ON
BEGIN
	DECLARE @CmpPrdtgId AS INT
	DECLARE @TotalGrsAmt AS INT
	SET @TotalGrsAmt=0
	SET @CmpPrdtgId=0

	DECLARE  @PrdCateLevel TABLE
	(
		PrdCtgValLinkCode VARCHAR(1000),
		PrdCtgValMainId INT,
		CmpPrdCtgId INT,
		PrdId INT,
		GrossAmount NUMERIC(38,6)
	)

	IF NOT EXISTS(SELECT 'X' FROM SchemeMaster WHERE ContriPercentageScheme=1 AND SchId = @Pi_SchId) 
	BEGIN 
		RETURN
	END

	IF (@Pi_TransId=3 AND @Pi_SalId<>0)
	BEGIN 
		RETURN
	END

	SELECT @CmpPrdtgId=MAX(PrdCatLevelId) FROM SchProductCategoryContriPercentage (NOLOCK)

	SELECT @TotalGrsAmt =ISNULL(SUM(GrossAmount),0) FROM BilledPrdHdForScheme (NOLOCK)
	WHERE Usrid=@Pi_UsrId AND TransId=@Pi_TransId	

	IF (@Pi_TransId=3 AND @Pi_SalId=0)
	BEGIN 
		INSERT INTO @PrdCateLevel(PrdCtgValLinkCode,PrdCtgValMainId,CmpPrdCtgId,PrdId,GrossAmount)
		SELECT LEFT(B.PrdCtgValLinkCode,@CmpPrdtgId*5)PrdCtgValLinkCode,P.PrdCtgValMainId,B.CmpPrdCtgId,A.PrdId,A.GrossAmount  
		FROM ReturnPrdHdForScheme A (NOLOCK) 
		INNER JOIN Fn_ReturnSchemeProductBatch (@Pi_SchId) RB ON 	A.PrdId = RB.PrdId
		INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId
		INNER JOIN ProductCategoryValue B (NOLOCK) ON P.PrdCtgValMainId=B.PrdCtgValMainId
		WHERE Usrid=@Pi_UsrId AND TransId=@Pi_TransId
	END

	IF (@Pi_TransId=2 OR @Pi_TransId=25)
	BEGIN 
		INSERT INTO @PrdCateLevel(PrdCtgValLinkCode,PrdCtgValMainId,CmpPrdCtgId,PrdId,GrossAmount)
		SELECT LEFT(B.PrdCtgValLinkCode,@CmpPrdtgId*5)PrdCtgValLinkCode,P.PrdCtgValMainId,B.CmpPrdCtgId,A.PrdId,A.GrossAmount
		FROM BilledPrdHdForScheme A (NOLOCK) 
		INNER JOIN Fn_ReturnSchemeProductBatch (@Pi_SchId) RB ON A.PrdId = RB.PrdId
		INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId
		INNER JOIN ProductCategoryValue B (NOLOCK) ON P.PrdCtgValMainId=B.PrdCtgValMainId
		WHERE Usrid=@Pi_UsrId AND TransId=@Pi_TransId
	END

	---BILLED PROUDCTS CATEGORY
	SELECT  B.PrdCtgValMainId,B.CmpPrdCtgId,A.PrdId,A.GrossAmount INTO #SchemeCategory 
	FROM @PrdCateLevel A
	INNER JOIN ProductCategoryValue B (NOLOCK) ON B.PrdCtgValLinkCode 
	LIKE CAST(A.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%' AND B.CmpPrdCtgId=@CmpPrdtgId
	---BILLED PROUDCTS CATEGORY

	---SCHEME PROUDCTS CATEGORY
	SELECT  LEFT(B.PrdCtgValLinkCode,@CmpPrdtgId*5)PrdCtgValLinkCode,P.PrdCtgValMainId,B.CmpPrdCtgId INTO #SCHEMEPR1
	FROM Fn_ReturnSchemeProductBatch (@Pi_SchId) A
	INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId
	INNER JOIN ProductCategoryValue B (NOLOCK) ON P.PrdCtgValMainId=B.PrdCtgValMainId

	SELECT DISTINCT B.PrdCtgValMainId,B.CmpPrdCtgId  INTO  #SCHEMEPR2
	FROM #SCHEMEPR1  A
	INNER JOIN ProductCategoryValue B (NOLOCK) ON B.PrdCtgValLinkCode 
	LIKE CAST(A.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%' AND B.CmpPrdCtgId=2 
	---SCHEME PROUDCTS CATEGORY

	----SELECT '#SCHEMEPR2',* FROM #SCHEMEPR2
	----SELECT '##SchemeCategory',* FROM #SchemeCategory

	IF EXISTS (SELECT 'X' FROM #SCHEMEPR2 A WHERE NOT EXISTS (SELECT B.PrdCtgValMainId FROM #SchemeCategory B
		WHERE A.PrdCtgValMainId=B.PrdCtgValMainId AND A.CmpPrdCtgId=B.CmpPrdCtgId))
	BEGIN
		DELETE A FROM  BillAppliedSchemeHd A (NOLOCK) WHERE A.SchId=@Pi_SchId AND A.Usrid=@Pi_UsrId AND A.TransId=@Pi_TransId	
		RETURN
	END

	SELECT PrdCtgValMainId,ISNULL(SUM(GrossAmount),0) GrossAmount,0 AS DefPercentage,0 AS AchPercentage 
	INTO #SchemeCategory1 FROM #SchemeCategory
	GROUP BY PrdCtgValMainId

	IF @TotalGrsAmt=0
	BEGIN
		SET @TotalGrsAmt=1
	END

	SELECT A.PrdCtgValMainId,A.GrossAmount,ISNULL(B.DefineContriPerc,0)  DefineContriPerc,
	CAST(((CAST(A.GrossAmount  AS NUMERIC(18,6)))/(CAST (@TotalGrsAmt AS NUMERIC(18,6))))*100 AS NUMERIC(18,2)) AS AchPercentage 
	INTO #AchPercentage
	FROM #SchemeCategory1 A 
	LEFT OUTER JOIN SchProductCategoryContriPercentage B (NOLOCK) ON A.PrdCtgValMainId=B.PrdCtgValMainId
	WHERE A.GrossAmount<>0

	--SELECT * FROM #AchPercentage --WHERE AchPercentage<DefineContriPerc AND DefineContriPerc<>0
	IF  EXISTS (SELECT 'X' FROM #AchPercentage WHERE AchPercentage<DefineContriPerc AND DefineContriPerc<>0)
	BEGIN
		DELETE A FROM  BillAppliedSchemeHd A (NOLOCK) WHERE A.SchId=@Pi_SchId AND A.Usrid=@Pi_UsrId AND A.TransId=@Pi_TransId	
	END
	--EXEC Proc_CheckPrdCategorycontribution 4683,1395,0,1,2

END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_ApplySchemeInBill')
DROP PROCEDURE Proc_ApplySchemeInBill
GO
/*
BEGIN TRANSACTION
EXEC Proc_ApplySchemeInBill 2561,1390,0,1,2
SELECT * FROM BillAppliedSchemeHd
-- SELECT * FROM BilledPrdHdForScheme(NOLOCK)
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ApplySchemeInBill
(
	@Pi_SchId  		INT,
	@Pi_RtrId		INT,
	@Pi_SalId  		INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT	
)
AS
/************************************************************************************************
* PROCEDURE		: Proc_ApplySchemeInBill
* PURPOSE		: To Apply the Scheme and Get the Scheme Details for the Selected Scheme
* CREATED		: Thrinath
* CREATED DATE	: 17/04/2007
* NOTE			: General SP for Returning the Scheme Details for the Selected Scheme
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------------------------------------------------------
* {date}       {developer}  {brief modification description}
* 08-08-2011	   Boopathy.P   Stock validation Removed
* 19-06-2018	   Karthick.KJ	CRCRSTPAR0007 Slab wise Retailer cap
* 30-08-2018	   S.MOORTHI	ILCRSTPAR1920 Slab wise Retailer cap
* 01-09-2018	   Amuthakumar P ILCRSTPAR1920 Slab wise Retailer cap
* 23-10-2018	   S.MOORTHI	ILCRSTPAR2412  Retailer CApping Logic to be changed (Calculate Eligible Retailers based on Slab Perc First)
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
		
	DECLARE @SchType		INT
	DECLARE @SchCode		nVarChar(40)
	DECLARE @BatchLevel		INT
	DECLARE @FlexiSch		INT
	DECLARE @FlexiSchType		INT
	DECLARE @CombiScheme		INT
	DECLARE @RangeScheme		INT
	DECLARE @ProRata		INT
	DECLARE @Qps			INT
	DECLARE @QpsReset		INT
	DECLARE @PurOfEveryReq		INT
	DECLARE @SchemeBudget		NUMERIC(38,6)
	DECLARE @SlabId			INT
	DECLARE @NoOfTimes		NUMERIC(38,6)
	DECLARE @GrossAmount		NUMERIC(38,6)
	DECLARE @BudgetUtilized		NUMERIC(38,6)
	DECLARE @BillDate 		DATETIME
	DECLARE @FrmValidDate		DateTime
	DECLARE @ToValidDate		DateTime
	DECLARE @RetailerCap	NUMERIC(18,2)--CRCRSTPAR0007
	DECLARE @SchValidFrom	DATETIME--CRCRSTPAR0007
	DECLARE @SchValidTill	DATETIME--CRCRSTPAR0007
	DECLARE @CtgLevelId INT--CRCRSTPAR0007
	DECLARE @CtgMainid INT--CRCRSTPAR0007
	DECLARE @RtrClassId INT--CRCRSTPAR0007
	DECLARE @Rtrid INT --CRCRSTPAR0007 
	DECLARE @TotRtrCnt	INT--CRCRSTPAR0007
	DECLARE @BilledRtrCnt INT--CRCRSTPAR0007
	DECLARE @AchPercentage	NUMERIC(18,2)--CRCRSTPAR0007
		
	DECLARE @TempBilled TABLE
	(
		PrdId				INT,
		PrdBatId			INT,
		SchemeOnQty 		NUMERIC(38,0),
		SchemeOnAmount		NUMERIC(38,6),
		SchemeOnKG			NUMERIC(38,6),
		SchemeOnLitre		NUMERIC(38,6),
		SchId 				INT,
		SchemeOnAmtWithTax NUMERIC(38,6)
	)
	
	DECLARE @TempBilledAch TABLE
	(
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		ToSchAch		NUMERIC(38,6),
		ToUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT,
		ToQty			NUMERIC(38,6),
		ToUomId			INT
	)
	
	DECLARE @TempSchSlabAmt TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		DiscPer			NUMERIC(38,6),
		FlatAmt			NUMERIC(38,6),
		Points			INT,
		FlxDisc			TINYINT,
		FlxValueDisc		TINYINT,
		FlxFreePrd		TINYINT,
		FlxGiftPrd		TINYINT,
		FlxPoints		TINYINT
	)
	
	DECLARE @TempSchSlabFree TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		FreePrdId		INT,
		FreeQty			INT
	)
	
	DECLARE @TempSchSlabGift TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		GiftPrdId		INT,
		GiftQty			INT
	)
	
	DECLARE @MoreBatch TABLE
	(
		SchId		INT,
		SlabId		INT,
		PrdId		INT,
		PrdCnt		INT,
		PrdBatCnt	INT
	)
	
	DECLARE @TempBillAppliedSchemeHd TABLE
	(
		SchId		int,
		SchCode		nvarchar(50),
		FlexiSch	tinyint,
		FlexiSchType	tinyint,
		SlabId		int,
		SchemeAmount	numeric(32,6),
		SchemeDiscount	numeric(32,6),
		Points		int,
		FlxDisc		tinyint,
		FlxValueDisc	tinyint,
		FlxFreePrd	tinyint,
		FlxGiftPrd	tinyint,
		FlxPoints	tinyint,
		FreePrdId	int,
		FreePrdBatId	int,
		FreeToBeGiven	int,
		GiftPrdId	int,
		GiftPrdBatId	int,
		GiftToBeGiven	int,
		NoOfTimes	numeric(32,6),
		IsSelected	tinyint,
		SchBudget	numeric(32,6),
		BudgetUtilized	numeric(32,6),
		TransId		tinyint,
		Usrid		int,
		PrdId		int,
		PrdBatId	int,
		SchType		int
	)
	
	SELECT @SchCode = SchCode,@SchType = SchType,@BatchLevel = BatchLevel,@FlexiSch = FlexiSch,
		@FlexiSchType = FlexiSchType,@CombiScheme = CombiSch,@RangeScheme = Range,@ProRata = ProRata,
		@Qps = QPS,@QpsReset = QPSReset,@SchemeBudget = Budget,
		@PurOfEveryReq = PurofEvery,@SchValidFrom=SchValidFrom,@SchValidTill=SchValidTill
	FROM SchemeMaster WHERE SchId = @Pi_SchId AND MasterType=1
	
	IF @SchType=2 
	BEGIN
		EXEC CALCULATE_RATEWITHTAX @Pi_UsrId,@Pi_TransId
	END
		
	IF @Pi_TransId=3 OR @Pi_TransId=25
	BEGIN
		INSERT INTO BilledPrdHdForScheme (RowId,RtrId,PrdId,PrdBatId,SelRate,BaseQty,GrossAmount,MRP,
		TransId,Usrid,ListPrice)
		SELECT A.Slno,@Pi_RtrId,A.Prdid,A.PrdBatId,0,A.BaseQty-A.ReturnedQty,0,0,@Pi_TransId,@Pi_UsrId,0
		FROM SalesInvoiceProduct A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		WHERE A.SalId=@Pi_SalId AND  A.PrdId NOT IN (
		SELECT PrdId FROM BilledPrdHdForScheme WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId)
	END
	
	--SELECT 'N3',* FROM BilledPrdHdForScheme
	-- To Get the Scheme Products - Billed Qty, Billed Value, Billed Weight in KG and Litre
	
	INSERT INTO @TempBilled(PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKG,SchemeOnLitre,SchId,SchemeOnAmtWithTax)		
	SELECT A.PrdId,A.PrdBatId,ISNULL(SUM(A.BaseQty),0) AS SchemeOnQty,ISNULL(SUM(A.BaseQty * A.SelRate),0) AS SchemeOnAmount,
		ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 3 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnKg,
		ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 5 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnLitre,@Pi_SchId,
		ISNULL(SUM(A.BaseQty * ISNULL(PT.SellRateWithTax,0)),0) AS SchemeOnAmtWithTax
		FROM BilledPrdHdForScheme A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		LEFT OUTER JOIN ProductSellingRateWithTax PT ON PT.PRDID=A.PRDID AND PT.PRDID=B.PRDID 
		/*Commented and Added by Raja.C for PMS No:ICRSTPAR2340 Begins Here*/
		--AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= B.PrdBatid
		AND PT.PRDBATID=A.PRDBATID AND PT.Prdbatid= CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		/*Commented and Added by Raja.C  for PMS No:ICRSTPAR2340 Ends Here*/
		WHERE A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId
		GROUP BY A.PrdId,A.PrdBatId,D.PrdUnitId
	
	--To Get the Sum of Quantity, Value or Weight Billed for the Scheme In From and To Uom Conversion - Slab Wise
	INSERT INTO @TempBilledAch(FrmSchAch,FrmUomAch,ToSchAch,ToUomAch,SlabId,FromQty,UomId,ToQty,ToUomId)
	SELECT ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.UomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS FrmSchAch,A.UomId AS FrmUomAch,
		ISNULL(CASE @SchType
		WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6)))
	-- 	WHEN 1 THEN SUM(CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
	--	WHEN 2 THEN SUM(SchemeOnAmount)
		WHEN 2 THEN SUM(SchemeOnAmtWithTax)
		WHEN 3 THEN (CASE A.ToUomId
				WHEN 2 THEN SUM(SchemeOnKg) * 1000
				WHEN 3 THEN SUM(SchemeOnKg)
				WHEN 4 THEN SUM(SchemeOnLitre) * 1000
				WHEN 5 THEN SUM(SchemeOnLitre)	END)
			END,0) AS ToSchAch,A.ToUomId AS ToUomAch,
		A.Slabid,(A.PurQty + A.FromQty) as FromQty,A.UomId,A.ToQty,A.ToUomId
		FROM SchemeSlabs A
		INNER JOIN @TempBilled B ON A.SchId = B.SchId
		INNER JOIN Product C ON B.PrdId = C.PrdId
		LEFT OUTER JOIN UomGroup D ON D.UomGroupId = C.UomGroupId AND D.UomId = A.UomId
		LEFT OUTER JOIN UomGroup E ON E.UomGroupId = C.UomGroupId AND E.UomId = A.UomId
		GROUP BY A.UomId,A.Slabid,A.PurQty,A.FromQty,A.UomId,A.ToQty,A.ToUomId
	--
	SELECT @SlabId = SlabId FROM (SELECT TOP 1 A.SlabId FROM @TempBilledAch A
	INNER JOIN @TempBilledAch B ON A.SlabId = B.SlabId
	WHERE
	A.FrmSchAch >= B.FromQty AND
	A.ToSchAch <= (CASE B.ToQty WHEN 0 THEN A.ToSchAch ELSE B.ToQty END)
	ORDER BY A.SlabId DESC) As SlabId
--Code To Check Slab Wise Retailer Cap	Added by karthick CRCRSTPAR0007
	DECLARE @ReverseSlab AS INT --ILCRSTPAR1920
	DECLARE @ActualRetToBilled AS INT  --ILCRSTPAR2412
	SET @ReverseSlab=0 --ILCRSTPAR1920
	SET @ActualRetToBilled=0
	---
	CREATE TABLE #TotalRetailerCount
		(	
			Rtrid INT 
		)
	
	NextPrd:
	
	IF @ReverseSlab=1 ---ILCRSTPAR1920
	BEGIN
		SELECT @SlabId=MAX(SlabId) FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId
		IF ISNULL(@SlabId,0)=0
		BEGIN
			RETURN
		END
		SET @ReverseSlab=0
	END --ILCRSTPAR1920
	
	SELECT @RetailerCap=RetailerCap FROM SchemeSlabs WHERE Schid=@Pi_SchId AND Slabid=@SlabId
	SET @ActualRetToBilled=0 --ILCRSTPAR2412
	IF @RetailerCap<100
	BEGIN
		SELECT  @CtgLevelId=ISNULL((SELECT TOP 1  Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=4),0)
		SELECT @CtgMainid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5),0)
		SELECT @RtrClassId=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6),0)
		SELECT @Rtrid=ISNULL((SELECT TOP 1 Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8),0)
		
		TRUNCATE TABLE #TotalRetailerCount
		
		INSERT INTO #TotalRetailerCount
		SELECT DISTINCT R.Rtrid 
		FROM  Retailercategory RC
		INNER JOIN RetailerCategory RC1 ON RC1.CtgLinkId=RC.CtgMainid
		INNER JOIN RetailerValueClass RVC ON RVC.CtgMainid=RC1.Ctgmainid
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.RtrValueClassId=RVC.RtrClassId
		INNER JOIN Retailer R ON R.RtrId=RVCM.RtrId
		WHERE RC.CtgLevelId=1 AND RC1.CtgLevelid=2  AND RtrStatus=1
		AND (
		RC.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC.CtgMainid ELSE @CtgMainid END)
		OR RC.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)
		OR RC1.CtgMainid =( CASE @CtgMainid WHEN 0 THEN RC1.CtgMainid ELSE @CtgMainid END)
		OR RC1.CtgMainid IN (SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=5)) 		
		AND (RVC.RtrClassId =( CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE @RtrClassId END)
		OR RVC.RtrClassId IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=6)) 		
		AND (R.Rtrid =( CASE @Rtrid WHEN 0 THEN R.Rtrid ELSE @Rtrid END)
		OR R.Rtrid IN(SELECT Attrid FROM Schemeretattr WHERE Schid=@Pi_SchId AND Attrtype=8))
		 SET @TotRtrCnt=(SELECT DISTINCT COUNT(Rtrid)  FROM #TotalRetailerCount)
		 
		 SET @ActualRetToBilled= CEILING((SELECT ((CAST(@TotRtrCnt AS NUMERIC(18,2))*CAST(@RetailerCap AS NUMERIC(18,2))/100))))
		SELECT @BilledRtrCnt=COUNT(Distinct SI.Rtrid) FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		
		--this logic will be commented ILCRSTPAR2412
		--IF @TotRtrCnt=0
		--BEGIN
		--	SET @AchPercentage=0
		--END 
		--ELSE
		--BEGIN
		----- Rounded by Amuthakumar on 01/09/2018 UAT ILCRSTPAR1920
		----SET @AchPercentage=ROUND((SELECT CAST((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100) AS DECIMAL(10,0))),0)
		----- Ceiling Value by Amuthakumar on 26/09/2018 UAT ILCRSTPAR1920	(ie. if Result 7.1 makes rounded 8.0 )
		--SET @AchPercentage= CEILING((SELECT ((CAST(@BilledRtrCnt AS NUMERIC(18,2))/CAST(@TotRtrCnt AS NUMERIC(18,2))*100))))
				
		--END
		
 		--SELECT @SlabId,@TotRtrCnt,@BilledRtrCnt,@AchPercentage,@RetailerCap
		IF (SELECT object_id('TempDB..#AchvdRetailers')) IS NOT NULL
		BEGIN
			DROP TABLE #AchvdRetailers
		END
				
		CREATE TABLE #AchvdRetailers
		(
		Rtrid Int
		)
		
		INSERT INTO #AchvdRetailers
		SELECT DISTINCT SI.Rtrid 
		FROM SalesInvoice SI INNER JOIN  #TotalRetailerCount T ON T.Rtrid=SI.Rtrid
		INNER JOIN SalesInvoiceSchemeLinewise SIS ON SIS.Salid=SI.Salid AND Schid=@Pi_SchId
		WHERE Dlvsts NOT IN (3) AND Salinvdate BETWEEN @SchValidFrom AND @SchValidTill AND SIS.Slabid=@SlabId
		
		--SELECT @AchPercentage,@RetailerCap
		--IF @AchPercentage>=@RetailerCap 
		--ILCRSTPAR2412 Perc logic removed
		if ISNULL(@ActualRetToBilled,0)<=ISNULL(@BilledRtrCnt,0)
		BEGIN
			IF NOT EXISTS(SELECT 'X' FROM #AchvdRetailers WHERE RtrId=@Pi_RtrId)
		    BEGIN	
					IF EXISTS(SELECT * FROM SchemeSlabs WHERE SchId=@Pi_SchId AND Slabid<@SlabId)
					BEGIN
						SET @ReverseSlab=1
						GOTO NextPrd
					END
				RETURN
			END			
		END 
	END
--Till here 
	
	--Store the Slab Amount Details into a temp table
	INSERT INTO @TempSchSlabAmt (ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,
		FlxFreePrd,FlxGiftPrd,FlxPoints)
	SELECT ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints
		FROM SchemeSlabs WHERE Schid = @Pi_SchId And SlabId = @SlabId
	
	--Store the Slab Free Product Details into a temp table
	INSERT INTO @TempSchSlabFree(ForEveryQty,ForEveryUomId,FreePrdId,FreeQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType <> 4
	
	--Store the Slab Gift Product Details into a temp table
	INSERT INTO @TempSchSlabGift(ForEveryQty,ForEveryUomId,GiftPrdId,GiftQty)
	SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
		SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
		AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
		WHERE A.Schid = @Pi_SchId And A.SlabId = @SlabId AND C.PrdType = 4
	
	--To Get the Number of Times the Scheme should apply
	IF @PurOfEveryReq = 0
	BEGIN
		SET @NoOfTimes = 1
	END
	ELSE
	BEGIN
		SELECT @NoOfTimes = A.FrmSchAch / (CASE B.ForEveryQty WHEN 0 THEN 1 ELSE B.ForEveryQty END) FROM
			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
--		SELECT A.FrmSchAch,B.ForEveryQty  FROM
--			@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
		IF @ProRata = 0
		BEGIN
			SET @NoOfTimes = FLOOR(@NoOfTimes)	
		END
		IF @ProRata = 1
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,0)
		END
		IF @ProRata = 2
		BEGIN
			SET @NoOfTimes = ROUND(@NoOfTimes,6) 
		END
	END
	
	
	
	--To Store the Gross amount for the Scheme billed Product
	SELECT @GrossAmount = ISNULL(SUM(SchemeOnAmount),0) FROM @TempBilled
	--SELECT 'N1',* FROM @TempBilled
	--SELECT 'N2',* FROM @TempSchSlabAmt
	--To Calculate the Scheme Flat Amount and Discount Percentage
	--Scheme Discount for Flat amount = ((FlatAmt * (LineLevel Gross / Total Gross) * 100)/100) * number of times
	--Scheme Discount for Disc Perc   = (LineLevel Gross * Disc Percentage) / 100
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SUM(SchemeAmount) AS SchemeAmount,
		SchemeDiscount AS SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,
		FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,
		IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,0
		FROM
		(
			SELECT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
			@SlabId as SlabId,PrdId,PrdBatId,
			(CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END) As Contri,
			((FlatAmt * (CASE @GrossAmount WHEN 0 THEN 0 ELSE (SchemeOnAmount / @GrossAmount) * 100 END))/100) * @NoOfTimes
			As SchemeAmount, DiscPer AS SchemeDiscount,(Points *@NoOfTimes) as Points,
			FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,0 as FreePrdId,0 as FreePrdBatId,
			0 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,
			0 as IsSelected,@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId As TransId,
			@Pi_UsrId as UsrId FROM @TempBilled , @TempSchSlabAmt
			WHERE (FlatAmt + DiscPer + FlxDisc + FlxValueDisc + FlxFreePrd + FlxGiftPrd + Points + FlxPoints) >=0
		) AS B
		GROUP BY SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeDiscount,Points,FlxDisc,FlxValueDisc,FlxFreePrd,
		FlxGiftPrd,FlxPoints,FreePrdId,FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,
		NoOfTimes,IsSelected,SchBudget,BudgetUtilized,TransId,Usrid,PrdId,PrdBatId
	--SELECT * FROM @TempBilled
	--To Calculate the Free Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,FreePrdId,0 as FreePrdBatId,
		CASE @SchType 
			WHEN 1 THEN 
				(CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END )
			WHEN 2 THEN 
				(CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
			WHEN 3 THEN
				(CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END)
		END
		 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,
		0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,@SchemeBudget as SchBudget,
		0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabFree
		GROUP BY FreePrdId,FreeQty,ForEveryQty
		
	--To Calculate the Gift Qty to be given
	INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
		Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
		FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
		BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
	SELECT DISTINCT @Pi_SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
		@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
		0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,0 As FreePrdId,0 as FreePrdBatId,
		0 as FreeToBeGiven,GiftPrdId as GiftPrdId,0 as GiftPrdBatId,
		CASE @SchType
			WHEN 1 THEN
				CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 2 THEN
				CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
			WHEN 3 THEN
				CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN ROUND((GiftQty*@NoOfTimes),0) ELSE GiftQty END
		END
		as GiftToBeGiven,@NoOfTimes as NoOfTimes,0 as IsSelected,
		@SchemeBudget as SchBudget,0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
		FROM @TempBilled , @TempSchSlabGift
		GROUP BY GiftPrdId,GiftQty,ForEveryQty
		IF @Pi_TransId=3 OR @Pi_TransId=25
		BEGIN
			UPDATE A Set A.FreePrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.FreePrdId=B.PrdId
			AND A.FreeToBeGiven>0
			UPDATE A Set A.GiftPrdBatId=B.PrdBatId FROM BillAppliedSchemeHd A INNER JOIN
			(SELECT B.PrdId,ISNULL(MAX(A.PrdbatId),0) AS PrdBatId FROM ProductBatchLocation A INNER JOIN
			ProductBatch B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
			WHERE (A.PrdBatLcnSih+A.PrdBatLcnUih+A.PrdBatLcnFre)>0 GROUP BY B.PrdId) B ON A.GiftPrdId=B.PrdId
			AND A.GiftToBeGiven>0
		END
		
	IF EXISTS (SELECT * FROM SchemeRtrLevelValidation WHERE Schid = @Pi_SchId AND RtrId = @Pi_RtrId)
	BEGIN
		IF Exists (SELECT * FROM SalesInvoice WHERE SalId = @Pi_SalId)
			SELECT @BillDate = SalInvDate FROM SalesInvoice WHERE SalId = @Pi_SalId
		ELSE
			SET @BillDate = CONVERT(VARCHAR(10),GETDATE(),121)
		SELECT @FrmValidDate = FromDate,@ToValidDate = ToDate,@SchemeBudget = BudgetAllocated
			FROM SchemeRtrLevelValidation WHERE @BillDate Between FromDate and ToDate
			AND Schid = @Pi_SchId AND RtrId = @Pi_RtrId
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilizedForRtr(@Pi_SchId,@Pi_RtrId,@FrmValidDate,@ToValidDate)
	END
	ELSE
	BEGIN
		SELECT @BudgetUtilized = dbo.Fn_ReturnBudgetUtilized(@Pi_SchId)
	END
	
	EXEC Proc_ApplySchemeInBill_Temp @Pi_SchId,@SlabId,@Pi_UsrId,@Pi_TransId
	
	EXEC Proc_ApplyDiscountScheme @Pi_SchId,@Pi_UsrId,@Pi_TransId
	
	UPDATE BillAppliedSchemeHd SET BudgetUtilized = ISNULL(@BudgetUtilized,0),
		SchBudget = ISNULL(@SchemeBudget,0) WHERE SchId = @Pi_SchId AND
		TransId = @Pi_TransId AND Usrid = @Pi_UsrId 

	 --CRCRSTPAR0105
	 EXEC Proc_CheckPrdCategorycontribution  @Pi_SchId,@Pi_RtrId,@Pi_SalId,@Pi_UsrId,@Pi_TransId		
	 --CRCRSTPAR0105
END
GO
--Till Here Mary
DELETE FROM ManualConfiguration  where moduleid ='SAL_RETURN6'
INSERT INTO ManualConfiguration
SELECT 'PARLE','SAL_RETURN6','Sales Return','Transfer Stock Automatically from old batch to new batch on new batch download',1,'',0.00,1
GO
DELETE FROM ManualConfiguration  where moduleid ='PURCHASE1'
INSERT INTO ManualConfiguration
SELECT 'PARLE','PURCHASE1','Purchase Receipt','Transfer Stock Automatically from old batch to new batch on new batch download',1,'',0.00,1
GO
DELETE FROM CustomCaptions WHERE TransId=3 and CtrlId=1000 and SubCtrlId=101
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) 
VALUES (3,1000,101,'MsgBox-3-1000-101','','','Auto Batch Transfer not done Properly',1,1,1,GETDATE(),1,GETDATE(),'','','Auto Batch Transfer not done Properly',1,1)
GO
DELETE FROM CustomCaptions WHERE TransId=5 and CtrlId=1000 and SubCtrlId=110
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) 
VALUES (5,1000,110,'MsgBox-5-1000-110','','','Auto Batch Transfer not done Properly',1,1,1,GETDATE(),1,GETDATE(),'','','Auto Batch Transfer not done Properly',1,1)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_AutoBatchTransferSalesReturn' AND XTYPE='P')
DROP PROCEDURE Proc_AutoBatchTransferSalesReturn
GO
/*
BEGIN TRAN
EXEC Proc_AutoBatchTransferSalesReturn 4515,0
SELECT * FROM PRODUCTBATCHLOCATION(nolock) WHERE PRDID =11100
select * from StockLedger (NOLOCK) where PRDID =11100 ORDER BY TRANSDATE DESC
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_AutoBatchTransferSalesReturn
(
	@Pi_ReturnId	INT,
	@Po_ErrNo INT OUTPUT	
)
AS
/************************************************************************************************************************
* PROCEDURE		: Proc_AutoBatchTransferSalesReturn
* PURPOSE		: To do Batch Transfer automatically while Sales Return (Same Logic for AutoBatch Transfer in Download)
* CREATED		: Mohana S
* CREATED DATE	: 30-11-2020
* MODIFIED
************************************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************
30-11-2020  Mohana.S	 CR     CRCRSTPAR0106          a) When Sales Return is made for a product attached to old Batch, 
														 stocks should be posted to the latest  batch for that product.

*************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 				AS 	INT
	DECLARE @Trans				AS 	INT
	DECLARE @Tabname 			AS  NVARCHAR(100)
	DECLARE @DestTabname 		AS 	NVARCHAR(100)
	DECLARE @Fldname 			AS  NVARCHAR(100)
	
	DECLARE @PrdDCode 	        AS 	NVARCHAR(100)
	DECLARE @BatchCode			AS 	NVARCHAR(100)
	DECLARE @CmpBatchCode		AS 	NVARCHAR(100)	
	DECLARE @PriceCode			AS 	NVARCHAR(4000)		
	DECLARE @MnfDate			AS 	NVARCHAR(100)
	DECLARE @ExpDate			AS 	NVARCHAR(100)
	DECLARE @TaxGroupCode		AS 	NVARCHAR(100)
	DECLARE @Status				AS 	NVARCHAR(100)
	DECLARE	@BatchSeqCode 		AS 	NVARCHAR(100)
	DECLARE @RefCode           	AS 	NVARCHAR(100)
	DECLARE @PriceValue         AS 	NVARCHAR(100)	
	DECLARE @DefaultPrice       AS 	NVARCHAR(100)	  	
	DECLARE @ExistPrdDCode		AS 	NVARCHAR(100)  	
	DECLARE @ExistBatchCode		AS 	NVARCHAR(100)
	DECLARE @ExistPriceCode		AS 	NVARCHAR(100)  	
	
	DECLARE @PrdId 				AS 	INT
	DECLARE @PrdBatId 			AS 	INT
	DECLARE @PriceId 			AS 	INT
	DECLARE @TaxGroupId 		AS 	INT
	DECLARE @BatchSeqId 		AS 	INT
	DECLARE @BatchStatus		AS 	INT
	DECLARE @SlNo	 			AS 	INT
	DECLARE @NoOfPrices 		AS 	INT
	DECLARE @ExistPrices 		AS 	INT
	DECLARE @DefaultPriceId 	AS 	INT
	DECLARE @ExistPriceId 		AS 	INT
	DECLARE @TransStr 			AS 	NVARCHAR(4000)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT
	DECLARE @ContPrdId 			AS 	INT
	DECLARE @ContPrdBatId 		AS 	INT
	DECLARE @ContExistPrdBatId 	AS 	INT
	DECLARE @ContPriceId 		AS 	INT
	DECLARE @ContractId 		AS 	INT
	DECLARE @ContPriceCode		AS NVARCHAR(100)
	DECLARE @ContPrdBatId1		AS INT
	DECLARE @ContPriceId1		AS INT
	DECLARE @BatchTransfer		AS INT
	DECLARE @SalStock			AS INT
	DECLARE @UnSalStock			AS INT
	DECLARE @OfferStock			AS INT
	DECLARE @FromPrdBatId		AS INT
	DECLARE @FromPrdBatCode		AS NVARCHAR(200)
	DECLARE @ToPrdBatId			AS INT
	DECLARE @LcnId				AS INT
	DECLARE @Po_StkPosting		AS INT
	DECLARE @TransDate			AS DATETIME
	DECLARE @ReturnNo AS VARCHAR(100)
	DECLARE @ToPriceID AS INT
	DECLARE @FromPriceID AS INT
	
	DECLARE @Pi_OldMaxPrdBatId AS INT
	DECLARE @Old_PrdId AS INT
	
	SET @BatchTransfer=0
	SELECT @TransDate=CONVERT(NVARCHAR(10),GETDATE(),121)

	SET @Po_ErrNo=0
	SET @Exist=0
	SET @ExistPrdDCode=''	
	SET @ExistBatchCode=''
	SET @ExistPriceCode=''


	SET @Exist=0
	
	DECLARE @KeyNumber AS VARCHAR(100)
	DECLARE @StockTypeId AS INT
	
	DECLARE @ReasonId AS INT
	SELECT @ReasonId=ReasonId FROM ReasonMaster WHERE Description='Free Stock Movement'
	
	CREATE TABLE #TempBatch
	(
		PrdId	INT,
		PrdBatId	INT
	)
	
	
	INSERT INTO #TempBatch(PrdId,PrdBatId)
	SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK)
	INNER JOIN ReturnProduct B (NOLOCK) ON A.PrdId=B.PrdId
	WHERE ReturnId = @Pi_ReturnId and A.[Status]=1
	GROUP BY A.PrdId
	
	BEGIN TRY
	
	DECLARE Cur_ReturnBatch CURSOR
	FOR SELECT ReturnCode,B.PrdId,B.PrdBatId FROM ReturnHeader A (NOLOCK)
	INNER JOIN  ReturnProduct B (NOLOCK) ON A.ReturnId = B.ReturnId 
	INNER JOIN ProductBatch C (NOLOCK) ON C.PrdId=B.PrdId and C.PrdBatId=B.PrdBatId
	WHERE A.ReturnId = @Pi_ReturnId --AND C.Status=0

	OPEN Cur_ReturnBatch
	FETCH NEXT FROM Cur_ReturnBatch INTO @ReturnNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	WHILE @@FETCH_STATUS=0
	BEGIN
	
		DECLARE Cur_ProductBatch CURSOR
		FOR SELECT PB.PrdId,PB.PrdBatId,PrdBatCode
			FROM ProductBatch PB(NOLOCK) 
			INNER JOIN #TempBatch A(NOLOCK) ON PB.Prdid=A.prdid and A.prdbatid = Pb.Prdbatid  WHERE PB.PrdBatId>@Pi_OldMaxPrdBatId AND PB.PrdId=@Old_PrdId
			AND PB.[Status]=1 AND EXISTS(SELECT * FROM #TempBatch TB WHERE TB.PrdId=PB.PrdId and TB.PrdBatId=PB.PrdBatId)
			ORDER BY PB.PrdId,PB.PrdBatId,PrdBatCode
		OPEN Cur_ProductBatch
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
		WHILE @@FETCH_STATUS=0
		BEGIN 
			--SELECT 'M',@PrdId,@PrdBatId,@BatchCode
			DECLARE Cur_BatchTransfer CURSOR
			FOR SELECT PBL.LcnId,PBL.PrdBatId,(PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) AS SalStock,(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) AS UnSalStock,
			(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) AS OfferStock
			FROM ProductBatchLocation PBL(NOLOCK) WHERE PBL.PrdId=@PrdId AND PBL.PrdBatId=@Pi_OldMaxPrdBatId
			AND ((PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih)+(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih)+(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre))>0
		
			OPEN Cur_BatchTransfer
			FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			WHILE @@FETCH_STATUS=0
			BEGIN
				--SELECT 'D',@PrdId,@PrdBatId,@LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock

				SELECT @FromPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@FromPrdBatId
				SELECT @ToPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@PrdBatId

				SET @Po_ErrNo=0			
				IF @SalStock>0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 1,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN
						Exec Proc_UpdateProductBatchLocation 1,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN	
							Exec Proc_UpdateStockLedger 30,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting=0
							BEGIN
								Exec Proc_UpdateStockLedger 27,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
								IF @Po_StkPosting<>0
								BEGIN
									SET @Po_ErrNo=1
								END
								ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=1
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@SalStock,@ReasonId,@ReturnNo,'Batch Transfer From Sales Return',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END											
							END
							ELSE
							BEGIN
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				
				IF @UnSalStock>0
				BEGIN
				Exec Proc_UpdateProductBatchLocation 2,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				IF @Po_StkPosting=0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 2,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN	
						Exec Proc_UpdateStockLedger 31,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN
							Exec Proc_UpdateStockLedger 28,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting<>0
							BEGIN
								SET @Po_ErrNo=1
							END	
							ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=2
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@UnSalStock,@ReasonId,'','Batch Transfer From Sales Return',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END						
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					SET @Po_ErrNo=1
				END
			END
	
				
				IF @Po_ErrNo>0
				BEGIN
					SET @Po_ErrNo=1
					ROLLBACK TRAN
					CLOSE Cur_BatchTransfer
					DEALLOCATE Cur_BatchTransfer
					CLOSE Cur_ProductBatch
					DEALLOCATE Cur_ProductBatch					
					RETURN
				END
				
				FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			END
			CLOSE Cur_BatchTransfer
			DEALLOCATE Cur_BatchTransfer
			FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
			
		END
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
	
		FETCH NEXT FROM Cur_ReturnBatch INTO @ReturnNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	END
	CLOSE Cur_ReturnBatch
	DEALLOCATE Cur_ReturnBatch
	
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
		SET @Po_ErrNo=1
		CLOSE Cur_BatchTransfer
		DEALLOCATE Cur_BatchTransfer
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
		RETURN		
	END CATCH			
	
	RETURN	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_AutoBatchTransferPurchaseReceipt' AND xtype='P')
DROP PROCEDURE Proc_AutoBatchTransferPurchaseReceipt
GO
/*
BEGIN TRANSACTION
SELECT * FROM  PurchaseReceiptProduct A (NOLOCK) WHERE PurRcptId=1208
EXEC Proc_AutoBatchTransferPurchaseReceipt 1208,0
SELECT * FROM BatchTransfer(NOLOCK) where prdid =10547 order by  battrfdate desc
select * from productbatchlocation where prdid =10547
select * from  StockLedger where prdid = 10547 and  transdate ='2018-03-21'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_AutoBatchTransferPurchaseReceipt
(
	@Pi_PurRcptId	INT,
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_AutoBatchTransferPurchaseReceipt
* PURPOSE		: To do Batch Transfer automatically while Purchase Receipt (Same Logic for AutoBatch Transfer in Download)
* CREATED		: S.Mohana  --CRCRSTPAR0106
* CREATED DATE	: 05-12-2020
* MODIFIED
************************************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************
05-12-2020  Mohana.S	 CR     CRCRSTPAR0106          a) When Sales Return is made for a product attached to old Batch, 
														 stocks should be posted to the latest  batch for that product.
**************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 				AS 	INT
	DECLARE @Trans				AS 	INT
	DECLARE @Tabname 			AS  NVARCHAR(100)
	DECLARE @DestTabname 		AS 	NVARCHAR(100)
	DECLARE @Fldname 			AS  NVARCHAR(100)
	
	DECLARE @PrdDCode 	        AS 	NVARCHAR(100)
	DECLARE @BatchCode			AS 	NVARCHAR(100)
	DECLARE @CmpBatchCode		AS 	NVARCHAR(100)	
	DECLARE @PriceCode			AS 	NVARCHAR(4000)		
	DECLARE @MnfDate			AS 	NVARCHAR(100)
	DECLARE @ExpDate			AS 	NVARCHAR(100)
	DECLARE @TaxGroupCode		AS 	NVARCHAR(100)
	DECLARE @Status				AS 	NVARCHAR(100)
	DECLARE	@BatchSeqCode 		AS 	NVARCHAR(100)
	DECLARE @RefCode           	AS 	NVARCHAR(100)
	DECLARE @PriceValue         AS 	NVARCHAR(100)	
	DECLARE @DefaultPrice       AS 	NVARCHAR(100)	  	
	DECLARE @ExistPrdDCode		AS 	NVARCHAR(100)  	
	DECLARE @ExistBatchCode		AS 	NVARCHAR(100)
	DECLARE @ExistPriceCode		AS 	NVARCHAR(100)  	
	
	DECLARE @PrdId 				AS 	INT
	DECLARE @PrdBatId 			AS 	INT
	DECLARE @PriceId 			AS 	INT
	DECLARE @TaxGroupId 		AS 	INT
	DECLARE @BatchSeqId 		AS 	INT
	DECLARE @BatchStatus		AS 	INT
	DECLARE @SlNo	 			AS 	INT
	DECLARE @NoOfPrices 		AS 	INT
	DECLARE @ExistPrices 		AS 	INT
	DECLARE @DefaultPriceId 	AS 	INT
	DECLARE @ExistPriceId 		AS 	INT
	DECLARE @TransStr 			AS 	NVARCHAR(4000)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT
	DECLARE @ContPrdId 			AS 	INT
	DECLARE @ContPrdBatId 		AS 	INT
	DECLARE @ContExistPrdBatId 	AS 	INT
	DECLARE @ContPriceId 		AS 	INT
	DECLARE @ContractId 		AS 	INT
	DECLARE @ContPriceCode		AS NVARCHAR(100)
	DECLARE @ContPrdBatId1		AS INT
	DECLARE @ContPriceId1		AS INT
	DECLARE @BatchTransfer		AS INT
	DECLARE @SalStock			AS INT
	DECLARE @UnSalStock			AS INT
	DECLARE @OfferStock			AS INT
	DECLARE @FromPrdBatId		AS INT
	DECLARE @FromPrdBatCode		AS NVARCHAR(200)
	DECLARE @ToPrdBatId			AS INT
	DECLARE @LcnId				AS INT
	DECLARE @Po_StkPosting		AS INT
	DECLARE @TransDate			AS DATETIME
	DECLARE @ReceiptNo AS VARCHAR(100)
	DECLARE @FromPriceId AS INT
	DECLARE @TOPriceId AS INT
	
	
	DECLARE @Pi_OldMaxPrdBatId AS INT
	DECLARE @Old_PrdId AS INT
	
	SET @BatchTransfer=0
	SELECT @TransDate=CONVERT(NVARCHAR(10),GETDATE(),121)
 
	SET @Po_ErrNo=0
	SET @Exist=0
	SET @ExistPrdDCode=''	
	SET @ExistBatchCode=''
	SET @ExistPriceCode=''

 
	
	SET @Exist=0
	
	DECLARE @KeyNumber AS VARCHAR(100)
	DECLARE @StockTypeId AS INT
	
	DECLARE @ReasonId AS INT
	SELECT @ReasonId=ReasonId FROM ReasonMaster WHERE Description='Free Stock Movement'
	
	CREATE TABLE #TempBatch
	(
		PrdId	INT,
		PrdBatId	INT
	)
	
	
	INSERT INTO #TempBatch(PrdId,PrdBatId)
	SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK)
	INNER JOIN PurchaseReceiptProduct B (NOLOCK) ON A.PrdId=B.PrdId
	WHERE PurRcptId = @Pi_PurRcptId
	GROUP BY A.PrdId
	
	DECLARE Cur_ReceiptBatch CURSOR
	FOR SELECT PurRcptRefNo,PrdId,PrdBatId FROM PurchaseReceiptProduct A (NOLOCK)
	INNER JOIN PurchaseReceipt B (NOLOCK) ON A.PurRcptId = B.PurRcptId WHERE A.PurRcptId = @Pi_PurRcptId
	 

	OPEN Cur_ReceiptBatch
	FETCH NEXT FROM Cur_ReceiptBatch INTO @ReceiptNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	WHILE @@FETCH_STATUS=0
	BEGIN
	
		DECLARE Cur_ProductBatch CURSOR
		FOR SELECT PB.PrdId,PB.PrdBatId,PrdBatCode
			FROM ProductBatch PB(NOLOCK) 
			INNER JOIN #TempBatch A(NOLOCK) ON PB.Prdid=A.prdid and A.prdbatid = Pb.Prdbatid  WHERE PB.PrdBatId>@Pi_OldMaxPrdBatId AND PB.PrdId=@Old_PrdId
			AND PB.[Status]=1 AND EXISTS(SELECT * FROM #TempBatch TB WHERE TB.PrdId=PB.PrdId and TB.PrdBatId=PB.PrdBatId)
			ORDER BY PB.PrdId,PB.PrdBatId,PrdBatCode
		OPEN Cur_ProductBatch
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
		WHILE @@FETCH_STATUS=0
		BEGIN
			DECLARE Cur_BatchTransfer CURSOR
			FOR SELECT PBL.LcnId,PBL.PrdBatId,(PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) AS SalStock,(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) AS UnSalStock,
			(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) AS OfferStock
			FROM ProductBatchLocation PBL WHERE PBL.PrdId=@PrdId AND PBL.PrdBatId<>@PrdBatId
			OPEN Cur_BatchTransfer
			FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			WHILE @@FETCH_STATUS=0
			BEGIN
				-- select @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
				SELECT @FromPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@FromPrdBatId
				SELECT @ToPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@PrdBatId

				SET @Po_ErrNo=0			
				IF @SalStock>0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 1,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN
						Exec Proc_UpdateProductBatchLocation 1,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN	
							Exec Proc_UpdateStockLedger 30,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting=0
							BEGIN
								Exec Proc_UpdateStockLedger 27,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
								IF @Po_StkPosting<>0
								BEGIN
									SET @Po_ErrNo=1
								END
								ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=1
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@SalStock,@ReasonId,@ReceiptNo,'Batch Transfer From Purchase Receipt',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END											
							END
							ELSE
							BEGIN
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				

				IF @Po_ErrNo>0
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					VALUES(@FromPrdBatId,'','Error','Error In ProdutBat Transfer')
					CLOSE Cur_BatchTransfer
					DEALLOCATE Cur_BatchTransfer
					CLOSE Cur_ProductBatch
					DEALLOCATE Cur_ProductBatch
					RETURN
				END
				
				FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			END
			CLOSE Cur_BatchTransfer
			DEALLOCATE Cur_BatchTransfer
			FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
			
		END
		CLOSE Cur_ProductBatch
		DEALLOCATE Cur_ProductBatch
	
		FETCH NEXT FROM Cur_ReceiptBatch INTO @ReceiptNo,@Old_PrdId,@Pi_OldMaxPrdBatId
	END
	CLOSE Cur_ReceiptBatch
	DEALLOCATE Cur_ReceiptBatch
	
	RETURN	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_UpdateProductBatchLocation' AND XTYPE='P')
DROP PROCEDURE Proc_UpdateProductBatchLocation
GO
CREATE Procedure Proc_UpdateProductBatchLocation
(
	@Pi_ColId 		INT,
	@Pi_Type		INT,
	@Pi_PrdId		INT,
	@Pi_PrdBatId		INT,
	@Pi_LcnId		INT,
	@Pi_TranDate		DateTime,
	@Pi_TranQty		Numeric(38,0),
	@Pi_UsrId		INT,
	@Pi_ErrNo		INT	OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_UpdateProductBatchLocation
* PURPOSE	: To Update ProductBatchLocation 
* CREATED	: Thrinath
* CREATED DATE	: 05/01/2007
* NOTE		: General SP for Updating ProductBatchLocation
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------------------------------------------------------------------------------
02-12-2018  Mohana.S	 CR     CRCRSTPAR0106     Inactive product has been updated as Active while delivery the bill. The same has been commented.
********************************************************************************************************************************************************/ 
SET NOCOUNT ON
Begin
	Declare @sSql as VARCHAR(2500)
	Declare @FldName as VARCHAR(100)
	Declare @StkChkFldName as VARCHAR(100)
	Declare @ErrNo as INT
	DECLARE @LastTranDate 	DATETIME
	IF EXISTS (SELECT PrdId FROM Product Where PrdId = @Pi_PrdId and PrdType = 3)
	BEGIN
		--IF Product is a KIT Item Return True
		Set @Pi_ErrNo = 0
		RETURN
	END
	BEGIN TRY --Code added by Muthuvel for Inventory check
		IF NOT EXISTS (SELECT PrdId FROM ProductBatchLocation Where PrdId = @Pi_PrdId
			and PrdBatId = @Pi_PrdBatId and LcnId = @Pi_LcnId)
		BEGIN
			INSERT INTO ProductBatchLocation
			(
				LcnId,PrdId,PrdBatId,PrdBatLcnSih,PrdBatLcnUih,PrdBatLcnfre,
				PrdBatLcnResSih,PrdBatLcnResUih,PrdBatLcnResFre,
				Availability,LastModBy,LastModDate,AuthId,AuthDate
			) VALUES
			(
				@Pi_LcnId,@Pi_PrdId,@Pi_PrdBatId,0,0,0,
				0,0,0,
				1,@Pi_UsrId,@Pi_TranDate,@Pi_UsrId,@Pi_TranDate
			)
		END
		Select @FldName = CASE @Pi_ColId WHEN 1 THEN 'PrdBatLcnSih'
			WHEN 2 THEN 'PrdBatLcnUih'
			WHEN 3 THEN 'PrdBatLcnfre'
			WHEN 4 THEN 'PrdBatLcnResSih'
			WHEN 5 THEN 'PrdBatLcnResUih'
			WHEN 6 THEN 'PrdBatLcnResFre' END
		Select @StkChkFldName = CASE @Pi_ColId - 3 WHEN 1 THEN 'PrdBatLcnSih'
			WHEN 2 THEN 'PrdBatLcnUih'
			WHEN 3 THEN 'PrdBatLcnfre' END
		SET @Pi_ErrNo = 0
		IF @Pi_Type = 2 
		BEGIN
			Create Table #CheckStock 
			(	
				PrdId int
			)
			
			SET @sSql = ' Insert Into #CheckStock (Prdid) '
			SET @sSql = @sSql + 'Select Prdid From ProductBatchLocation Where'
			SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
			SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
			SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
			SET @sSql = @sSql + ' AND '  + @FldName + ' < ' + CAST(@Pi_TranQty as VARCHAR(10))
			
			Exec (@sSql)
			IF Exists(Select * From #CheckStock)
			BEGIN
				SET @Pi_ErrNo = 1
			END
		
			DROP TABLE #CheckStock 
		END
		IF @Pi_Type = 1 AND @Pi_ColId > 3
		BEGIN
			Create Table #CheckStock1 
			(	
				prdid int
			)
			
			SET @sSql = ' Insert Into #CheckStock1 (Prdid) '
			SET @sSql = @sSql + 'Select Prdid From ProductBatchLocation Where'
			SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
			SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
			SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
			SET @sSql = @sSql + ' AND ' + @StkChkFldName + ' < ' + @FldName + ' + ' 
			SET @sSql = @sSql + CAST(@Pi_TranQty as VARCHAR(10))
		
			Exec (@sSql)
			IF Exists(Select * From #CheckStock1)
			BEGIN
				SET @Pi_ErrNo = 1
			END
		
			DROP TABLE #CheckStock1 
		END
		IF @Pi_ErrNo = 0
		BEGIN
			SET @sSql = 'Update ProductBatchLocation Set ' + @FldName + ' = ' + @FldName + ' + '
			SET @sSql = @sSql + CASE @Pi_Type WHEN 2 Then '-1' Else '1' End + '* ' 
			SET @sSql = @sSql + CAST(@Pi_TranQty as VARCHAR(10)) 
			SET @sSql = @sSql + ', LastModDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
			SET @sSql = @sSql + ', AuthDate = ''' + CONVERT(VARCHAR(10),GetDate(),121) + ''''
			SET @sSql = @sSql + ', LastModBy = ' + CAST(@Pi_UsrId as VARCHAR(10))
			SET @sSql = @sSql + ', AuthId = ' + CAST(@Pi_UsrId as VARCHAR(10)) + ' Where'
			SET @sSql = @sSql + ' PrdId = ' + CAST(@Pi_PrdId as VARCHAR(10))
			SET @sSql = @sSql + ' AND PrdBatId = ' + CAST(@Pi_PrdBatId as VARCHAR(10))
			SET @sSql = @sSql + ' AND LcnId = ' + CAST(@Pi_LcnId as VARCHAR(10))
		
			Exec (@sSql)
		End
	--COMMENTED BY MOHANA AS PER CLIENT REQUEST
	---- Added by Rajesh to activate the batch having stock. ICRSTPAR4148
	--	IF EXISTS(SELECT 'X' FROM ProductBatch A (NOLOCK)INNER JOIN ProductBatchLocation B(NOLOCK) ON A.PrdId =B.PrdId AND A.PrdBatId =B.PrdBatID
	--				WHERE ((B.PrdBatLcnSih-B.PrdBatLcnRessih)+(B.PrdBatLcnUih-B.PrdBatLcnResUih)+(B.PrdBatLcnFre-B.PrdBatLcnResFre))>0 AND A.Status =0 )
	--	BEGIN 	
	--		UPDATE A SET A.Status =1 FROM ProductBatch A (NOLOCK)INNER JOIN ProductBatchLocation B(NOLOCK) ON A.PrdId =B.PrdId AND A.PrdBatId =B.PrdBatID
	--		WHERE ((B.PrdBatLcnSih-B.PrdBatLcnRessih)+(B.PrdBatLcnUih-B.PrdBatLcnResUih)+(B.PrdBatLcnFre-B.PrdBatLcnResFre))>0 AND A .Status =0
	--	END
	--	-- Till here	
	/*Code added by Muthuvel for Inventory check begins here*/		
	END TRY
	BEGIN CATCH
		SET @Pi_ErrNo = 1
	END CATCH	
	/*Code added by Muthuvel for Inventory check ends here*/	
--print @Pi_ErrNo
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_AutoBatchTransfer' AND TYPE='P')
DROP PROCEDURE Proc_AutoBatchTransfer
GO
CREATE PROCEDURE Proc_AutoBatchTransfer
(
	@Pi_OldMaxPrdBatId	INT,
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_AutoBatchTransfer
* PURPOSE		: To do Batch Transfer automatically while downloading New Batch for Existing Product
* CREATED		: Nandakumar R.G
* CREATED DATE	: 06/02/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
10-12-2018  Mohana.S	 CR     CRCRSTPAR0106     Records are captured in batch transfer table.
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 				AS 	INT
	DECLARE @Trans				AS 	INT
	DECLARE @Tabname 			AS  NVARCHAR(100)
	DECLARE @DestTabname 		AS 	NVARCHAR(100)
	DECLARE @Fldname 			AS  NVARCHAR(100)
	
	DECLARE @PrdDCode 	        AS 	NVARCHAR(100)
	DECLARE @BatchCode			AS 	NVARCHAR(100)
	DECLARE @CmpBatchCode		AS 	NVARCHAR(100)	
	DECLARE @PriceCode			AS 	NVARCHAR(4000)		
	DECLARE @MnfDate			AS 	NVARCHAR(100)
	DECLARE @ExpDate			AS 	NVARCHAR(100)
	DECLARE @TaxGroupCode		AS 	NVARCHAR(100)
	DECLARE @Status				AS 	NVARCHAR(100)
	DECLARE	@BatchSeqCode 		AS 	NVARCHAR(100)
	DECLARE @RefCode           	AS 	NVARCHAR(100)
	DECLARE @PriceValue         AS 	NVARCHAR(100)	
	DECLARE @DefaultPrice       AS 	NVARCHAR(100)	  	
	DECLARE @ExistPrdDCode		AS 	NVARCHAR(100)  	
	DECLARE @ExistBatchCode		AS 	NVARCHAR(100)
	DECLARE @ExistPriceCode		AS 	NVARCHAR(100)  	
	
	DECLARE @PrdId 				AS 	INT
	DECLARE @PrdBatId 			AS 	INT
	DECLARE @PriceId 			AS 	INT
	DECLARE @TaxGroupId 		AS 	INT
	DECLARE @BatchSeqId 		AS 	INT
	DECLARE @BatchStatus		AS 	INT
	DECLARE @SlNo	 			AS 	INT
	DECLARE @NoOfPrices 		AS 	INT
	DECLARE @ExistPrices 		AS 	INT
	DECLARE @DefaultPriceId 	AS 	INT
	DECLARE @ExistPriceId 		AS 	INT
	DECLARE @TransStr 			AS 	NVARCHAR(4000)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT
	DECLARE @ContPrdId 			AS 	INT
	DECLARE @ContPrdBatId 		AS 	INT
	DECLARE @ContExistPrdBatId 	AS 	INT
	DECLARE @ContPriceId 		AS 	INT
	DECLARE @ContractId 		AS 	INT
	DECLARE @ContPriceCode		AS NVARCHAR(100)
	DECLARE @ContPrdBatId1		AS INT
	DECLARE @ContPriceId1		AS INT
	DECLARE @BatchTransfer		AS INT
	DECLARE @SalStock			AS INT
	DECLARE @UnSalStock			AS INT
	DECLARE @OfferStock			AS INT
	DECLARE @FromPrdBatId		AS INT
	DECLARE @FromPrdBatCode		AS NVARCHAR(200)
	DECLARE @ToPrdBatId			AS INT
	DECLARE @LcnId				AS INT
	DECLARE @Po_StkPosting		AS INT
	DECLARE @TransDate			AS DATETIME
	SET @BatchTransfer=0
	SELECT @TransDate=CONVERT(NVARCHAR(10),GETDATE(),121)
	---->Needs to be changed
	SELECT @BatchTransfer=Status FROM Configuration WHERE ModuleId='GENConfig000001'
	SET @Po_ErrNo=0
	SET @Exist=0
	SET @ExistPrdDCode=''	
	SET @ExistBatchCode=''
	SET @ExistPriceCode=''
	
	SET @DestTabname='ProductBatch'
	SET @Fldname='PrdBatId'
	SET @Tabname = 'ETL_Prk_ProductBatch'
	SET @Exist=0	

	DECLARE @ReasonId AS INT
	DECLARE @PreFix AS VARCHAR(20)	
	DECLARE @ZPad AS INT
	DECLARE @CurrValue AS NUMERIC(36,0)
	DECLARE @CurrYear AS NUMERIC(36,0)
	DECLARE @KeyNumber AS VARCHAR(50) 
	DECLARE @StockTypeId	AS INT
	DECLARE @ToPriceId AS BIGINT
	DECLARE @FromPriceId AS BIGINT

	SELECT TOP 1 @ReasonId=ReasonId from ReasonMaster (NOLOCK) WHERE  BatchTransfer=1 and ReasonCode='R03'
	
	--When Free Batch is downloaded last then stock is getting moved to Free batch. Added #FreeBatch--Rajesh on 21.12.2016 ICRSTPAR4195 
	
	SELECT DISTINCT Prdbatid INTO #FreeBatch FROM ProductBatchDetails(NOLOCK) GROUP BY Prdbatid HAVING SUM(PrdBatDetailValue)=0
	
	DECLARE Cur_ProductBatch CURSOR
	FOR SELECT PrdId,PrdBatId,PrdBatCode FROM ProductBatch(NOLOCK)
	--WHERE PrdBatId >@Pi_OldMaxPrdBatId  ORDER BY PrdId,PrdBatId,PrdBatCode--Commented and added by Rajesh on 21.12.2016 ICRSTPAR4195 
	WHERE PrdBatId >@Pi_OldMaxPrdBatId AND PrdbatId NOT IN(Select Prdbatid FROM #FreeBatch)
	ORDER BY PrdId,PrdBatId,PrdBatCode
	---
	OPEN Cur_ProductBatch
	FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
	WHILE @@FETCH_STATUS=0
	BEGIN
		--SELECT 'Nanda'
		--SELECT @PrdId,@PrdBatId,@BatchCode
		DECLARE Cur_BatchTransfer CURSOR
		FOR SELECT PBL.LcnId,PBL.PrdBatId,(PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih) AS SalStock,(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih) AS UnSalStock,
		(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre) AS OfferStock
		FROM ProductBatchLocation PBL WHERE PBL.PrdId=@PrdId AND PBL.PrdBatId<>@PrdBatId
		AND PBL.PrdbatId NOT IN(Select Prdbatid FROM #FreeBatch)--Added by Rajesh on 21.12.2016 ICRSTPAR4195 		
		AND ((PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih)+(PBL.PrdBatLcnUih-PBL.PrdBatLcnResUih)+(PBL.PrdBatLcnFre-PBL.PrdBatLcnResFre))>0
		OPEN Cur_BatchTransfer
		FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
		WHILE @@FETCH_STATUS=0
		BEGIN
			--SELECT @PrdId,@PrdBatId,@LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
			
				SELECT @FromPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@FromPrdBatId
				SELECT @ToPriceID=DefaultPriceid FROM ProductBatch(NOLOCK) WHERE PrdBatId=@PrdBatId


			SET @Po_ErrNo=0
			
			IF @SalStock>0
			BEGIN
				Exec Proc_UpdateProductBatchLocation 1,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				IF @Po_StkPosting=0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 1,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN	
						Exec Proc_UpdateStockLedger 30,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN
							Exec Proc_UpdateStockLedger 27,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@SalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting<>0
							BEGIN
								SET @Po_ErrNo=1
							END	
							ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=1
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@SalStock,@ReasonId,'','Auto Batch Transfer From Sync',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END													
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					SET @Po_ErrNo=1
				END
			END
			
			IF @UnSalStock>0
			BEGIN
				Exec Proc_UpdateProductBatchLocation 2,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				IF @Po_StkPosting=0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 2,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN	
						Exec Proc_UpdateStockLedger 31,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN
							Exec Proc_UpdateStockLedger 28,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@UnSalStock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting<>0
							BEGIN
								SET @Po_ErrNo=1
							END	
							ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=2
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@UnSalStock,@ReasonId,'','Auto Batch Transfer From Sync',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END						
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					SET @Po_ErrNo=1
				END
			END
				
			IF @Offerstock>0
			BEGIN
				Exec Proc_UpdateProductBatchLocation 3,2,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@Offerstock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				IF @Po_StkPosting=0
				BEGIN
					Exec Proc_UpdateProductBatchLocation 3,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@Offerstock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					IF @Po_StkPosting=0
					BEGIN	
						Exec Proc_UpdateStockLedger 32,1,@PrdId,@FromPrdBatId,@LcnId,@TransDate,@Offerstock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
						IF @Po_StkPosting=0
						BEGIN
							Exec Proc_UpdateStockLedger 29,1,@PrdId,@PrdBatId,@LcnId,@TransDate,@Offerstock,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
							IF @Po_StkPosting<>0
							BEGIN
								SET @Po_ErrNo=1
							END	
							ELSE
								BEGIN
									SET @KeyNumber=''
									SELECT @KeyNumber=dbo.Fn_GetPrimaryKeyString ('BatchTransfer','BatRefNo',YEAR(GETDATE()),MONTH(GETDATE()))
									SELECT @StockTypeId=StockTypeId FROM STOCKTYPE (NOLOCK) WHERE LcnId = @LcnId AND SystemStockType=3
									
									INSERT INTO BatchTransfer(BatRefNo,BatTrfDate,LcnId,PrdId,
									StockTypeId,FromBatId,ToBatId,TrfQty,ReasonId,DocRefNo,Remarks,FromPriceId,ToPriceId,
									Availability,LastModBy,LastModDate,AuthId,AuthDate)
									SELECT @KeyNumber,CONVERT(VARCHAR(10),GETDATE(),121),@LcnId,@PrdId,@StockTypeId,@FromPrdBatId,@PrdBatId,
									@Offerstock,@ReasonId,'','Auto Batch Transfer From Sync',@FromPriceID,@ToPriceID,1,1,GETDATE(),1,GETDATE()
									
									UPDATE A SET CurrValue=CurrValue+1 FROM COUNTERS A WHERE TabName='BatchTransfer' and FldName='BatRefNo'
								END						
						END
						ELSE
						BEGIN
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					SET @Po_ErrNo=1
				END
			END
			IF @Po_ErrNo>0
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				VALUES(@FromPrdBatId,'','Error','Error')
			END
			FETCH NEXT FROM Cur_BatchTransfer INTO @LcnId,@FromPrdBatId,@SalStock,@UnSalStock,@Offerstock
		END
		CLOSE Cur_BatchTransfer
		DEALLOCATE Cur_BatchTransfer
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchCode
	
	--Added By rajesh To Inactivate Other batches except Downloaded batch & free Batch ICRSTPAR4148
	--DECLARE @MaxBatchId INT
	--SET @MaxBatchId =0
	--SELECT @MaxBatchId =MAX(PrdBatId) FROM  ProductBatch A(NOLOCK) WHERE PrdId =@PrdId AND PrdbatId NOT IN(Select Prdbatid FROM #FreeBatch)
	UPDATE A SET Status = 0 FROM  ProductBatch A(NOLOCK) WHERE PrdId =@PrdId AND PrdbatId NOT IN(Select Prdbatid FROM #FreeBatch)
	UPDATE A SET Status = 1 FROM  ProductBatch A(NOLOCK) WHERE PrdId =@PrdId AND PrdBatId =ISNULL(@PrdBatId ,0)
	--Till Here
	END
	CLOSE Cur_ProductBatch
	DEALLOCATE Cur_ProductBatch
	
	RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_DiscountMaster_New' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_DiscountMaster_New
GO
/*
BEGIN TRANSACTION
delete from errorlog
EXEC Proc_Cn2Cs_DiscountMaster 0
Select * from SplRateToAvoidNew (NOLOCK)
Select * from Cn2Cs_Prk_ContractPricing_Header (NOLOCK)
Select * from Cn2Cs_Prk_ContractPricing_dETAIL (NOLOCK)
Select * from ContractPricingMaster (NOLOCK) WHERE CONTRACTID >= 355
Select * from ContractPricingDetails (NOLOCK) WHERE CONTRACTID >= 355
Select * from ContractPricingAttributes (NOLOCK) WHERE CONTRACTID = 355
select * from ErrorLog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_DiscountMaster_New
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_DiscountMaster
* PURPOSE		: To Insert and Update Special Rate records in the Table  
* CREATED		: Karthick
* CREATED DATE	: 10-03-2015
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}		{developer}  {brief modification description}
* 24-03-2020	MOHANA S        PARCS202100002			CR			Contract Pricing Optimization
* 17-11-2020	MOHANA S		PARCS202100059		    CR			Fromdate included based on Serverdate
*********************************/
SET NOCOUNT ON
BEGIN
	 
	DECLARE @CmpPrdCtgName			AS NVARCHAR(50)
	DECLARE @ErrStatus				AS	INT
	DECLARE @FromDate DATETIME

	SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer
	
	SET @Po_ErrNo=0
	SET @ErrStatus=0
	DELETE FROM Cn2Cs_Prk_ContractPricing_Header WHERE DownloadFlag='Y'
	DELETE FROM Cn2Cs_Prk_ContractPricing_Detail WHERE DownloadFlag='Y'
	
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SplRateToAvoidNew')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SplRateToAvoidNew
	END
	CREATE TABLE SplRateToAvoidNew
	(
		CPRefCode Nvarchar(50)
	)

	SET @CmpPrdCtgName=(SELECT TOP 1 CmpPrdCtgName FROM ProductCategoryLevel A INNER JOIN Company B ON A.CmpId=B.cmpId  WHERE DefaultCompany=1 Order BY CmpPrdCtgId DESC)


	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header   
	WHERE (ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR  
	ISNULL(RtrType,'')='' OR     ISNULL(CPStatus,'')='' OR  
	ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR  
	ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')='' )  AND UPPER(rtrType)<>'RETAILER'
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode  IN  
	(SELECT ComConRefNo FROM contractpricingmaster)  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode NOT IN  
	(SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail)  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE CPRefCode NOT IN  
	(SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header)  
	INSERT INTO SplRateToAvoidNew   
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header   
	WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)   AND UPPER(RtrType) <>'RETAILER'  
	INSERT INTO SplRateToAvoidNew   
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header  
	WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory) AND UPPER(RtrType) <>'RETAILER'  
	INSERT INTO SplRateToAvoidNew   
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header  
	WHERE RtrCode NOT IN (SELECT CmpRtrCode  FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail   
	WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
	ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('DISCPER','FLATAMT')  
	WHERE ISNULL(ApplyOn,'')=''  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
	ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('SPLPRICE')  
	WHERE ISNULL(SPWTax,'')=''  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
	ON A.CPRefCode=B.CPRefCode AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE') 
	  
	INSERT INTO SplRateToAvoidNew  
	SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel)    
	INSERT INTO ErrorLog   
	SELECT DISTINCT 1,'Discount Master','Contract RefCode','Discount Details Not Available'+CPRefCode   
	FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail)  
	UNION ALL  
	SELECT DISTINCT 2,'Discount Master','Contract RefCode','Header Details Not Available'+CPRefCode   
	FROM Cn2Cs_Prk_ContractPricing_Detail WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header)  
	UNION ALL  
	SELECT  DISTINCT 3,'Discount Master','','Mandatory Fields Cannot be Null'+CPRefCode  FROM Cn2Cs_Prk_ContractPricing_Header WHERE ( ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR ISNULL(RtrType,'')='' OR       
	ISNULL(CPStatus,'')='' OR ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')='' ) AND UPPER(rtrType)<>'RETAILER'  
	UNION ALL  
	SELECT DISTINCT 3,'Discount Master','Retailer Category Level','Retailer Category Level Not Available'+CPRefCode   
	FROM Cn2Cs_Prk_ContractPricing_Header WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)   AND UPPER(RtrType)<>'RETAILER'  
	UNION ALL  
	SELECT DISTINCT 4,'Discount Master','Retailer Category Level Value','Retailer Category Code Not Available'+CPRefCode   
	FROM Cn2Cs_Prk_ContractPricing_Header WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory)    AND UPPER(RtrType)<>'RETAILER' 
	UNION ALL    
	SELECT DISTINCT 5,'Discount Master','Retailer Code','Retailer Code Not Available'+CPRefCode    
	FROM Cn2Cs_Prk_ContractPricing_Header WHERE RtrCode NOT IN (SELECT cmpRtrCode FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
	UNION ALL  
	SELECT DISTINCT 6,'Discount Master','Product Category Level','Mandatory Fields Cannot be Null'+CPRefCode     
	FROM Cn2Cs_Prk_ContractPricing_Detail WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''    
	UNION ALL  
	SELECT DISTINCT 8,'Discount Master','ApllyOn','Aplly On Cannot be Null'+A.CPRefCode   
	FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
	AND UPPER(DiscType) IN ('DISCPER','FLATAMT') WHERE ISNULL(ApplyOn,'')=''  
	UNION ALL  
	SELECT DISTINCT 9,'Discount Master','WithTax','With Tax Cannot be Null'+A.CPRefCode    
	FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
	AND UPPER(DiscType) IN ('SPLPRICE') WHERE ISNULL(SPWTax,'')=''  
	UNION ALL  
	SELECT DISTINCT 10,'Discount Master','Status','Status Cannot be Null'+A.CPRefCode     
	FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
	AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE')  
	UNION ALL  
	SELECT DISTINCT 11,'Discount Master','PrdCatLvl','Product Category Level Not Available'+CPRefCode      
	FROM Cn2Cs_Prk_ContractPricing_Detail WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel) AND UPPER(PrdCatLvl)<>(UPPER(@CmpPrdCtgName))   
	UNION ALL  
	SELECT DISTINCT 12,'Discount Master','PrdCatCode','Product Code Not Available'+CPRefCode       
	FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)   
	AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl) =(UPPER(@CmpPrdCtgName))   
	UNION ALL  
	SELECT DISTINCT 13,'Discount Master','PrdCatCode','Product Category Level Value Not Available'+CPRefCode        
	FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
	AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) 
	
	 
	SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_Header FROM Cn2Cs_Prk_ContractPricing_Header  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D'  
	SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_DETAIL FROM Cn2Cs_Prk_ContractPricing_DETAIL  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D' 
	DELETE FROM #Cn2Cs_Prk_ContractPricing_DETAIL  WHERE PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) AND UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
	DELETE FROM #Cn2Cs_Prk_ContractPricing_DETAIL WHERE PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName) 
	 
	SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_HEADER FROM Cn2Cs_Prk_ContractPricing_Header GROUP BY CPRefCode  

	SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_DETAILS FROM Cn2Cs_Prk_ContractPricing_DETAIL GROUP BY CPRefCode 
	 
	DELETE A  FROM #Cn2Cs_Prk_ContractPricing_Header A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_HEADER B WHERE A.CPRefCode =B.CPRefCode 
	AND A.CREATEDDATE = B.CREATEDDATE)
	  
	DELETE A  FROM #Cn2Cs_Prk_ContractPricing_DETAIL A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_DETAILS B WHERE A.CPRefCode =B.CPRefCode 
	AND A.CREATEDDATE = B.CREATEDDATE) AND DOWNLOADFLAG='D'  

	SELECT DISTINCT CmpCode,PrdCtgValCode,PrdCtgValMainId INTO #ProductCategoryValue 
	FROM ProductCategoryValue A
	INNER JOIN ProductCategoryLevel B ON A.CmpPrdCtgId=B.CmpPrdCtgId
	INNER JOIN Company C ON C.CmpId=B.CmpId
		
	DECLARE @ConRefNo AS NVARCHAR(50)
	DECLARE @PrdCatLvl AS NVARCHAR(50)
	DECLARE @ContractId AS INT
	DECLARE @Year AS INT
	DECLARE @Month AS INT
	DECLARE @CPRefCode AS NVARCHAR(50)
	
	SELECT @Year=YEAR(GETDATE()),@Month=Month(GETDATE())

	SELECT @ContractId=CurrValue+1 from Counters WHERE TabName='ContractPricingMaster' and fldname='ContractId'
	
	
	DECLARE CUR_Contract Cursor
	FOR SELECT DISTINCT CPRefCode from #Cn2Cs_Prk_ContractPricing_Header	where CPRefCode Not in(select CPRefCode from SplRateToAvoidNew)
		AND DOWNLOADFLAG='D'
	OPEN CUR_Contract 
	FETCH NEXT FROM CUR_Contract  INTO	@CPRefCode
	WHILE @@FETCH_STATUS=0
	BEGIN
		SELECT  @ConRefNo=dbo.Fn_GetPrimaryKeyString ('ContractPricingMaster','ConRefNo',@Year,@Month)

		DECLARE @EffFromDate DATETIME

		SELECT @EffFromDate=EffFromDate FROM #Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode=@CPRefCode


		IF (DATEPART(MM,CONVERT(VARCHAR(10),@EffFromDate,121)	) <> DATEPART (MM,@FromDate)) OR (YEar(CONVERT(VARCHAR(10),@EffFromDate,121)	)<> YEar (@FromDate))
		BEGIN
			SET @FromDate = CONVERT(VARCHAR(10),@EffFromDate,121)	
		END
		ELSE
		BEGIN
			SELECT @FromDate = CONVERT(VARCHAR(10),ServerDate,121)  FROM CSTimer
		END
	 
	IF EXISTS(SELECT * FROM #Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode=@CPRefCode AND  UPPER(ProductLvl) ='PRODUCT')
	BEGIN
	 
		INSERT INTO ContractPricingMaster
					(ContractId,CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,PrdCtgValMainId,
					RtrId,RtrTaxGroupId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DisplayMode,ConRefNo,ConDate,
					ValidFromDate,ValidTillDate,Status,AllowDiscount,ComConRefNo,RtrLevel,ComConRefName,OrgFromDate)
		--SELECT DISTINCT @ContractId,1,0,0,0,0,0,0 AS Rtrid,0 AS RtrTaxGroupId,
		SELECT DISTINCT @ContractId,CP.CmpId,0,0,0,0,0,0 AS Rtrid,0 AS RtrTaxGroupId, 
		1,1,GETDATE(),1,GETDATE(),1 ,@ConRefNo,
		CONVERT(VARCHAR(10),GETDATE(),121),CONVERT(VARCHAR(10),@FromDate,121),CONVERT(VARCHAR(10),EffToDate,121),
		CASE UPPER(CPStatus) WHEN 'ACTIVE' THEN 1 ELSE 0 END,
		CASE UPPER(ApplyON) WHEN 'MRP' then 1 WHEN 'SellingRate' THEN 3 WHEN 'PurchaseRate' THEN 2 END AllowDiscount,
		@CPRefCode,CASE UPPER(Rtrtype) WHEN 'RTRCATEGORY' THEN 0 WHEN 'RETAILER' THEN 1 END,CPRefName,CONVERT(VARCHAR(10),EffFromDate,121)														
		FROM (SELECT DISTINCT CmpCode,CPRefCode,DiscType,Rtrtype,CPStatus,CPRefName,EffFromDate,EffToDate,RtrCatLvl FROM #Cn2Cs_Prk_ContractPricing_Header) C
		INNER JOIN (SELECT DISTINCT PrdCatLvl,CPRefCode,Applyon FROM #Cn2Cs_Prk_ContractPricing_Detail) CD ON CD.CPRefCode=C.CPRefCode
		LEFT OUTER JOIN RetailerCategoryLevel RC	ON C.RtrCatLvl =RC.CtgLevelName
		INNER JOIN Company CP ON CP.CmpCode=C.CmpCode
		WHERE C.CPRefCode=@CPRefCode
		INSERT INTO ContractPricingDetails
					(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,
					LastModDate,AuthId,AuthDate,CtgValMainId,ClaimablePercOnMRP,ApplyOn,WithTax,SpecialPrice)
		SELECT DISTINCT @ContractId,PrdId,0,0,CD.DiscPer,CD.FlatAmt,1,1,GETDATE(),1,GETDATE(),0,0,
			     CASE UPPER(CD.ApplyOn) WHEN 'SellingRate' THEN 0 ELSE
						CASE UPPER(C.dISCTYPE) WHEN 'Mark Up' THEN 1 WHEN 'Mark Down' THEN 2 END END,SPWTax,CD.SplPrice --MARK UP /MARK DOWN,CD.SplPrice
		FROM #Cn2Cs_Prk_ContractPricing_Header C
		INNER JOIN #Cn2Cs_Prk_ContractPricing_Detail CD ON CD.CPRefCode=C.CPRefCode
		INNER JOIN Company D ON D.CmpCode=C.CmpCode
		INNER JOIN Product P ON P.PrdCCode=CD.PrdCatCode and D.CmpId=P.CmpId		
		WHERE C.CPRefCode=@CPRefCode  AND UPPER(ProductLvl) ='PRODUCT'
	END
	IF EXISTS(SELECT * FROM #Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode=@CPRefCode AND  UPPER(ProductLvl) ='OTHERLEVEL')
	BEGIN
		INSERT INTO ContractPricingMaster
					(ContractId,CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,PrdCtgValMainId,
					RtrId,RtrTaxGroupId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DisplayMode,ConRefNo,ConDate,
					ValidFromDate,ValidTillDate,Status,AllowDiscount,ComConRefNo,RtrLevel,ComConRefName,OrgFromDate)
					
		--SELECT DISTINCT @ContractId,1,RC.CtgLevelId,0,0,PC.CmpPrdCtgId,0,0 AS Rtrid,0 AS RtrTaxGroupId,
		SELECT DISTINCT @ContractId,CP.CmpId,0,0,0,PC.CmpPrdCtgId,0,0 AS Rtrid,0 AS RtrTaxGroupId, -- CmpId = 0 Added by Aravindh Deva C UAT Support
		1,1,GETDATE(),1,GETDATE(),1,@ConRefNo,
		CONVERT(VARCHAR(10),GETDATE(),121),CONVERT(VARCHAR(10),@Fromdate,121),CONVERT(VARCHAR(10),EffToDate,121),
		CASE UPPER(CPStatus) WHEN 'ACTIVE' THEN 1 ELSE 0 END,
		CASE UPPER(ApplyON) WHEN 'MRP' then 1 WHEN 'SellingRate' THEN 3 WHEN 'PurchaseRate' THEN 2 END AllowDiscount, --MRP/SELLING RATE
		@CPRefCode,CASE UPPER(Rtrtype) WHEN 'RTRCATEGORY' THEN 0 WHEN 'RETAILER' THEN 1 END,CPRefName,CONVERT(VARCHAR(10),EffFromDate,121)															
		FROM (SELECT DISTINCT CmpCode,CPRefCode,DiscType,Rtrtype,CPStatus,CPRefName,EffFromDate,EffToDate,RtrCatLvl FROM #Cn2Cs_Prk_ContractPricing_Header) C
		INNER JOIN (SELECT DISTINCT PrdCatLvl,CPRefCode,ApplyON FROM #Cn2Cs_Prk_ContractPricing_Detail) CD ON CD.CPRefCode=C.CPRefCode
		LEFT OUTER JOIN RetailerCategoryLevel RC	ON C.RtrCatLvl =RC.CtgLevelName
		INNER JOIN ProductCategoryLevel PC ON PC.CmpPrdCtgName=CD.PrdCatLvl
		INNER JOIN Company CP ON CP.CmpCode=C.CmpCode and Pc.CmpId=CP.CmpId
		WHERE C.CPRefCode=@CPRefCode 
		
		INSERT INTO ContractPricingDetails
					(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,
					LastModDate,AuthId,AuthDate,CtgValMainId,ClaimablePercOnMRP,ApplyOn,WithTax,SpecialPrice)
		SELECT DISTINCT @ContractId,p.PrdCtgValMainId,0,0,CD.DiscPer,CD.FlatAmt,1,1,GETDATE(),1,GETDATE(),0,0,
			   CASE UPPER(CD.ApplyOn) WHEN 'SellingRate' THEN 0 ELSE
						CASE UPPER(C.dISCTYPE) WHEN 'Mark Up' THEN 1 WHEN 'Mark Down' THEN 2 END END,SPWTax,CD.SplPrice --MARK UP /MARK DOWN
		FROM #Cn2Cs_Prk_ContractPricing_Header C
		INNER JOIN #Cn2Cs_Prk_ContractPricing_Detail CD ON CD.CPRefCode=C.CPRefCode
		INNER JOIN #ProductCategoryValue P ON P.PrdCtgValCode =CD.PrdCatCode and P.Cmpcode=C.CmpCode		
		WHERE C.CPRefCode=@CPRefCode AND  UPPER(ProductLvl) ='OTHERLEVEL'		
	END
	IF EXISTS(SELECT * FROM #Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode=@CPRefCode AND UPPER(RtrType) = 'RTRCATEGORY')
	BEGIN
		INSERT INTO ContractPricingAttributes
		SELECT @ContractId,1,R.CtgMainId,GETDATE() FROM #Cn2Cs_Prk_ContractPricing_Header C  INNER JOIN RetailerCategory R
				ON C.RtrCatCode=R.CtgCode WHERE UPPER(RtrType) = 'RTRCATEGORY' AND CPRefCode=@CPRefCode 
		UNION
		SELECT @ContractId,2,0,GETDATE()		
	END
	
	IF EXISTS(SELECT * FROM #Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode=@CPRefCode AND UPPER(RtrType) = 'RETAILER')
	BEGIN
		INSERT INTO ContractPricingAttributes
		SELECT @ContractId,1,0,GETDATE() FROM #Cn2Cs_Prk_ContractPricing_Header C 
				 WHERE UPPER(RtrType) = 'RETAILER' AND CPRefCode=@CPRefCode 
		UNION
		SELECT @ContractId,2,RtrId,GETDATE() FROM #Cn2Cs_Prk_ContractPricing_Header C INNER JOIN Retailer R
		ON C.RtrCode =R.CmpRTRCODE WHERE UPPER(C.RtrType) = 'RETAILER' AND CPRefCode=@CPRefCode 
	END
	
	UPDATE counters SET currvalue=@ContractId WHERE TabName='ContractPricingMaster' and fldname='ContractId'
	UPDATE counters SET currvalue=@ContractId WHERE TabName='ContractPricingMaster' and fldname='ConRefNo' 
	
	SET @ContractId=@ContractId+1 	
	FETCH NEXT FROM CUR_Contract  INTO	@CPRefCode
	END
	CLOSE CUR_Contract  
	DEALLOCATE CUR_Contract  		
	
	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Header C INNER JOIN ContractPricingMaster CP
	ON C.CPRefCode=CP.ComConRefNo 
	--UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Detail C INNER JOIN ContractPricingMaster CP
	--ON C.CPRefCode=CP.ComConRefNo	
	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Detail C  
	INNER JOIN #Cn2Cs_Prk_ContractPricing_DETAIL A ON A. CPRefCode =C.CPRefCode 
	AND C.PrdCatCode = A.PrdCatCode AND C.CPRefCode IN (SELECT ComConRefNo FROM ContractPricingMaster)
	UPDATE B SET B.DownloadFlag ='D'  FROM Cn2Cs_Prk_ContractPricing_Detail A 
	INNER JOIN Cn2Cs_Prk_ContractPricing_Header B ON A.CPRefCode =B.CPRefCode  WHERE A.DownloadFlag ='D'
	
	RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_TradeSchemeClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_TradeSchemeClaimDetails
GO
CREATE PROCEDURE Proc_TradeSchemeClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_TradeSchemeClaimDetails
* PURPOSE	: TO LOAD SCHEME WISE CLAIM AMOUNT
* DATE		:  07-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
************************************************************************************************************************************
* DATE      |	  PERSON			  | USER STORY ID  |	  CR/BZ		|       REMARKS                      
************************************************************************************************************************************
* 09-01-2020		MOHANA S			ILCRSTPAR7358 		    SR			Changed the claim Logic based on Sch Budget & LiabPer
* 16-01-2020		MOHANA S			ILCRSTPAR7420			BZ			Same Product different Qty sales return issue fix (from debitnote report)
* 05-02-2020		Lakshman M         	ILCRSTPAR7726           BZ          Due to liability column values multiple with 100. 
* 06-02-2020		MOHNAA S			ILCRSTPAR7748			SR			Scheme Primary value increased with 5.5% only for comparision
* 26-11-2020		MOHANA S			PARCS202100059		    CR			OrgFromDate included in table
*************************************************************************************************************************************/
BEGIN
	DELETE FROM  TempTradeSchemeClaimDetails  
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
	 
	--EXEC Proc_SchUtilization_DNClaim @Pi_Year,@Pi_Month,@Pi_Usrid,@Pi_Transid    
	--EXEC Proc_ProductTaxPercentage_DNClaim  @Pi_Year,@Pi_Month,@Pi_Usrid,@Pi_Transid 
	     
			IF @FromDate ='2020-05-01'
			BEGIN
				SELECT Schid INTO #SchDelete FROM SchemeMaster WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchemeCorrection )
				DELETE A FROM DN_Claim_Scheme A INNER JOIN #SchDelete B ON A.SchId =B.SchId 
				DELETE A FROM DN_Claim_Scheme A INNER JOIN SchemeMaster B ON A.SchId = B.SchId 
				INNER JOIN SchemeCorrection C ON C.CmpSchCode = B.CmpSchCode 
				AND A.SalInvdate>C.ValidTill 			
			END
	SELECT * INTO #ParleOutputTaxPercentage FROM TaxPercentage_DNClaim (NOLOCK)  WHERE USRID =@Pi_Usrid AND TRANID = @Pi_Transid 
	
	SELECT S.Salid,SalInvNo,SalInvDate,RtrId ,Prdid,PrdBatId ,BaseQty,Slno,PrdTaxAmount,PrdUnitSelRate 
	INTO #SalesInvoice 
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
	WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP,          
	SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,StockTypeId,S.SalId       
	INTO #ReturnHeader          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND
	S.ReturnDate BETWEEN  @FromDate AND @ToDate AND S.[Status] = 0 
	SELECT DISTINCT * INTO #ProductBatchDetails
	FROM(
	SELECT P.* FROM ProductBatchDetails P WHERE EXISTS (SELECT * FROM #SalesInvoice S WHERE S.PRDBATID = P.PRDBATID) AND   DefaultPrice =1 AND SLNo =3  
	UNION 
	SELECT P.* FROM ProductBatchDetails P WHERE EXISTS (SELECT * FROM #SalesInvoice S WHERE S.PRDBATID = P.PRDBATID) AND   DefaultPrice =1 AND SLNo =3 
	)A
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,S.PrdId,S.PrdBatId,S.BaseQty BaseQty,          
	B.DefaultPriceId ActualPriceId,S.SlNo,S.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
	INTO #BillingDetails          
	FROM #SalesInvoice S (NOLOCK)     
	INNER JOIN ProductBatch B (NOLOCK) ON S.PrdBatId = B.PrdBatId       
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId AND DefaultPrice =1        
	AND  PBD.SLNo =3 
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,S.PrdId,S.PrdBatId,-1 * S.BaseQty BaseQty,S.PrdUnitMRP MRP,          
	B.DefaultPriceId,S.SlNo,S.PrdEditSelRte,S.prdtaxamount,S.PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
	INTO #ReturnDetails          
	FROM #RETURNHEADER S (NOLOCK)       
	INNER JOIN ProductBatch B (NOLOCK) ON S.PrdBatId = B.PrdBatId          
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId AND DefaultPrice =1 AND PBD.SLNo =3   
	AND StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)       
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,      
	PrdBatDetailValue as PrdUnitSelRate,Schid,         
	CAST (0 AS NUMERIC(18,6)) AS LCTR      
	INTO #DebitSalesDetails          
	FROM           
	(          
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #BillingDetails(NOLOCK)         
	UNION ALL          
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId ,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #ReturnDetails (NOLOCK)       
	) Consolidated       
	UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)          
	FROM #DebitSalesDetails M (NOLOCK),          
	#ProductBatchDetails D (NOLOCK)           
	WHERE M.ActualPriceId = D.PriceId AND D.SLNo = 3      
	UPDATE R SET R.LCTR = ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2)            
	FROM #DebitSalesDetails R (NOLOCK),          
	#ParleOutputTaxPercentage T (NOLOCK)      
	WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType   
	CREATE TABLE #ApplicableProduct      
	(      
	SchId  INT,      
	PrdId   INT      
	)      
	INSERT INTO #ApplicableProduct(SchId,PrdId)      
	SELECT DISTINCT A.SchId,B.Prdid      
	FROM SchemeMaster A(NOLOCK)      
	INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid  AND A.SchemeLvlMode = 0
	AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme(NOLOCK))    
	INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId  AND B.PrdId <> 0    
	UNION ALL      
	SELECT DISTINCT A.SchId,E.Prdid      
	FROM SchemeMaster A (NOLOCK)     
	INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid AND A.SchemeLvlMode = 0  AND B.PrdCtgValMainId <> 0 
	AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme(NOLOCK))
	INNER JOIN ProductCategoryValue C(NOLOCK) ON B.PrdCtgValMainId = C.PrdCtgValMainId       
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
	INNER JOIN Product E(NOLOCK) On D.PrdCtgValMainId = E.PrdCtgValMainId       
	INNER JOIN ProductBatch F(NOLOCK) On F.PrdId = E.Prdid	       
	UNION ALL      
	SELECT DISTINCT S.SchId,B.MasterRecordId      
	FROM SchemeProducts A(NOLOCK)   
	INNER JOIN UdcDetails B(NOLOCK) on B.UDCUniqueId =A.PrdCtgValMainId   AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme)     
	INNER JOIN SchemeMaster S(NOLOCK) ON A.SchId = S.SchId AND  S.SchemeLvlMode = 1     
	INSERT INTO #ApplicableProduct(SchId,PrdId)      
	SELECT Schid ,PrdId FROM SchemeMasterControlHistory A(NOLOCK)
	INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode  AND ChangeType='Remove' 
	AND EXISTS (SELECT SchId FROM SchemeProducts SP(NOLOCK) Where SP.SCHID=B.SCHID AND PrdCtgValMainId = 0 ) 
	AND EXISTS (SELECT SCHID FROM DN_Claim_Scheme D WHERE D.SCHID = B.SCHID)     
	INNER JOIN Product C ON c.PrdCCode = A.FromValue      
	WHERE ChangeType='Remove'   
	INSERT INTO #ApplicableProduct(SchId,PrdId)        
	SELECT DISTINCT A.SchId,E.Prdid      
	FROM SchemeMaster A      
	INNER JOIN SchemeMasterControlHistory B(NOLOCK) ON A.CmpSchCode = B.CmpSchCode  AND ChangeType='Remove' AND A.SchemeLvlMode = 0  
	AND EXISTS (SELECT SchId FROM SchemeProducts SP(NOLOCK) Where SP.SCHID=A.SCHID AND PrdCtgValMainId = 0 ) 
	AND EXISTS (SELECT SCHID FROM DN_Claim_Scheme D WHERE D.SCHID = A.SCHID)      
	INNER JOIN ProductCategoryValue C(NOLOCK) ON B.FromValue = C.PrdCtgValCode      
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
	INNER JOIN Product E(NOLOCK) On D.PrdCtgValMainId = E.PrdCtgValMainId       
	INNER JOIN ProductBatch F(NOLOCK) On F.PrdId = E.Prdid  
		 
	SELECT S.Schid,SUM(PrdNetAmount) SchPrimary INTO #PrimaryBasedOnSch FROM PurchaseReceipt A (NOLOCK)
	INNER JOIN PurchaseReceiptProduct B(NOLOCK) ON A.PurRcptId = B.PurRcptId 
	INNER JOIN #ApplicableProduct C(NOLOCK) ON B.Prdid =C.Prdid AND SchId in (SELECT SchId FROM DN_Claim_Scheme(NOLOCK) )
	INNER JOIN Schememaster S ON S.Schid = C.Schid  
			INNER JOIN TradeSchemeFactors T ON S.CmpschCode=T.CmpSchCode AND InvDate BETWEEN CONVERT(VARCHAR(10),T.ClaimDate,121) AND @ToDate
	GROUP BY S.Schid 
	CREATE TABLE #ApplicableScheme      
	(      
	SchId   INT,      
	SchDsc   NVARCHAR(100),      
	SchValidFrom DATETIME,      
	SchValidTill DATETIME,       
	Budget   NUMERIC(18,2),      
	BudgetAllocationNo VARCHAR(100),      
	PrdId   INT      
	)     
	 
	INSERT INTO #ApplicableScheme (SchId,SchDsc,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)         
	SELECT DISTINCT A.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId      
	FROM #ApplicableProduct A (NOLOCK),      
	SchemeMaster S (NOLOCK)      
	WHERE A.SchId = S.SchId AND A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme)       
	AND S.Claimable = 1  
	SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount     
	INTO #SchemeDebit1      
	FROM #ApplicableScheme S (NOLOCK), 
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM(NOLOCK) 
	LEFT OUTER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode   
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=1 AND      
	(B.Transdate BETWEEN @FromDate AND @ToDate OR B.TransDate BETWEEN @FromDate AND @ToDate)     
	AND SM.CmpSchCode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type IN ('Trade Scheme','General Scheme'))
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate      
	ORDER BY S.SchId      
	INSERT INTO #SchemeDebit1       
	SELECT APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(S.BaseQty) [SecSalesQty],Round(CAST((sum(S.BaseQty*PrdBatDetailValue)+ (sum(S.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,2)),2)  AS  [SecSalesVal],      
	CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
	from #SalesInvoice S (NOLOCK)      
	INNER JOIN SalesInvoiceSchemeLineWise SIL(NOLOCK) ON SIL.Salid=s.Salid   AND SIL.Prdid =S.Prdid AND sil.prdbatid =S.PrdBatId       
	INNER JOIN #DebitSalesDetails DS (NOLOCK)ON DS.Salid =S.Salid   AND DS.Salid =SIl.Salid AND DS.Prdid =S.Prdid AND DS.prdbatid = S.prdbatid 
	AND DS.Prdid =SIL.Prdid AND DS.prdbatid =SIl.prdbatid        
	INNER JOIN #ApplicableScheme APS(NOLOCK) ON APS.schid = SIL.schid AND APS.Prdid =DS.Prdid AND APS.Prdid =SIL.Prdid       
	INNER JOIN SchemeMaster SM(NOLOCK) ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
	INNER JOIN #ParleOutputTaxPercentage T(NOLOCK) ON T.Salid =DS.Salid AND S.Salid =T.Salid AND S.Salid =SIL.Salid AND DS.SlNo =T.PrdSlno AND T.TransId = DS.TransType       
	LEFT OUTER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode     
	INNER JOIN #ProductBatchDetails D(NOLOCK) on D.prdbatid=SIL.prdbatid AND D.prdbatid=S.prdbatid AND D.SlNo=3 AND DefaultPrice=1      
	WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  AND Transtype=1 AND   
	(DS.Transdate BETWEEN @FromDate AND @ToDate      
	OR DS.TransDate BETWEEN @FromDate AND @ToDate)     
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type NOT IN ('Trade Scheme','General Scheme'))      
	GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,S.BaseQty,PrdBatDetailValue,T.TaxPerc      
	ORDER BY APS.SchId      
	INSERT INTO #SchemeDebit1      
	SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	FROM #ApplicableScheme S (NOLOCK),      
	#DebitSalesDetails B (NOLOCK) ,      
	SchemeMaster SM (NOLOCK)
	LEFT OUTER JOIN SchemeCirculardetails SC (NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode     
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=2 AND       
	(B.Transdate BETWEEN @FromDate AND @ToDate      
	OR  B.Transdate  BETWEEN @FromDate AND @ToDate)     
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type  IN ('Trade Scheme','General Scheme'))     
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate       
	ORDER BY S.SchId      
	INSERT INTO #SchemeDebit1      
	SELECT  APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(S.BaseQty) [SecSalesQty],Round(cast((sum(S.BaseQty*PrdBatDetailValue)+ (sum(S.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,6)),2) AS  [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
	from #Returnheader S (NOLOCK)       
	INNER JOIN ReturnSchemeLineDt SIL(NOLOCK) ON SIL.Returnid=s.Returnid  AND SIL.Prdid =S.Prdid AND sil.prdbatid =S.PrdBatId       
	INNER JOIN #DebitSalesDetails DS(NOLOCK) ON DS.Salid =S.Returnid  AND DS.Salid =SIl.Returnid AND DS.Prdid =S.Prdid AND DS.prdbatid = S.prdbatid AND DS.Prdid =SIL.Prdid AND DS.prdbatid =SIl.prdbatid        
	INNER JOIN #ApplicableScheme APS(NOLOCK) ON APS.schid = SIL.schid AND APS.Prdid =DS.Prdid AND APS.Prdid =SIL.Prdid       
	INNER JOIN SchemeMaster SM(NOLOCK) ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
	INNER JOIN #ParleOutputTaxPercentage T(NOLOCK) ON T.Salid =DS.Salid AND S.Returnid =T.Salid AND S.Salid =SIL.Returnid       
	AND DS.slno =T.PrdSlno AND T.TransId = DS.TransType       
	LEFT Outer JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode       
	INNER JOIN #ProductBatchDetails D(NOLOCK) on D.prdbatid=SIL.prdbatid AND D.prdbatid=S.prdbatid AND D.SlNo=3 AND DefaultPrice=1      
	WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  AND Transtype=2 AND      
	(DS.Transdate BETWEEN @FromDate AND @ToDate      
	OR DS.TransDate BETWEEN @FromDate AND @ToDate)    
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type not IN ('Trade Scheme','General Scheme'))     
	GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,S.BaseQty,PrdBatDetailValue,T.TaxPerc      
	ORDER BY APS.SchId      
	DELETE FROM #SchemeDebit1 WHERE SchId NOT IN (SELECT Schid FROM DN_Claim_Scheme WHERE Linetype=1)            
	INSERT INTO #SchemeDebit1      
	SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	FROM #ApplicableScheme S (NOLOCK),      
	#DebitSalesDetails B (NOLOCK) ,      
	SchemeMaster SM INNER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
	,DN_Claim_Scheme D         
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=2        
	AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid       
	AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)      
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
	ORDER BY S.SchId      
	SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
	SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	INTO #SchemeDebit       
	from #SchemeDebit1 A (NOLOCK)     
	INNER JOIN SCHEMEMASTER B(NOLOCK) ON A.schid=B.schid AND B.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) 
	where Schcategory_type IN ('Trade Scheme','General Scheme') )        --ILCRSTPAR5132
	GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate 
	     
	INSERT  INTO #SchemeDebit      
	SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
	SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	from #SchemeDebit1 A      
	INNER JOIN SCHEMEMASTER B(NOLOCK) ON A.schid=B.schid AND 
	B.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type NOT IN ('Trade Scheme','General Scheme') )      --ILCRSTPAR5132  
	GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate      
	
	SELECT DISTINCT TaxPerc,B.SalId,B.PrdId  INTO #TaxPerc FROM SalesInvoiceProduct B(NOLOCK)       
	INNER JOIN #ParleOutputTaxPercentage P ON P.SalId = B.SalId AND  B.SlNo = P.PrdSlno AND TRANSID = 1     
	
	  
	SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt INTO #SchFinal FROM       
	(      
	SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt       
	FROM (              
	SELECT  Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM DN_Claim_Scheme A(NOLOCK)       
	INNER JOIN #TaxPerc B ON A.Salid = b.SalId AND a.Prdid = b.PrdId AND Linetype = 1   AND A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid     
	GROUP BY  A.PRDID,A.SchId,TaxPerc      
	)A      
	GROUP BY A.SchId,TaxPerc      
	)B Group by  sCHID 
	select DISTINCT TaxPerc,B.ReturnID AS Salid,B.PrdId 
	into #TaxPer_Return
	from  #ParleOutputTaxPercentage A INNER JOIN ReturnProduct B ON A.SalId = B.ReturnID  where --A.SalId = 2	and 
	TransId = 2 and A.PrdSlno = B.Slno and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)
	INSERT INTO #SchFinal      
	SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt FROM       
	(      
	SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt          
	FROM (      
	SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM DN_Claim_Scheme A(NOLOCK)      
	INNER JOIN #TaxPer_Return P ON   A.Salid = P.SalId   and a.Prdid = P.pRDID And  LineType=2 AND 
	A.UsriD =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	GROUP BY  A.PRDID,A.SchId,TaxPerc     
	)A      
	GROUP BY A.SchId,TaxPerc      
	)B Group by  sCHID
	       
	UPDATE SD SET SD.Amount = CASE S.ApplyTaxForClaim WHEN 0 THEN schamt ELSE  (SchAmt+TaxAmt) END      
	FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid,SUM(SchAmt) SchAmt ,Sum(Taxamt) TaxAmt FROM  #SchFinal GROUP BY Schid) D 
	ON SD.Schid = D.Schid --CHANGED FOR CLAIMAMT MISMATCH  
	INNER JOIN SchemeMaster S ON S.SchId = D.SCHID AND S.SchId = SD.SCHID   
	
	-----------------added by lakshman M PMS ID: ILCRSTPAR7726
	UPDATE SD SET SD.Liab = ((CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))) *100)
	FROM #SchemeDebit SD (NOLOCK)      
	WHERE SD.[SecSalesVal] <> 0   
	UPDATE #SchemeDebit SET Liab = (Amount / SecSalesVal) * 100 WHERE Liab > 0 
	---------------Till here ------------------
	INSERT INTO TempTradeSchemeClaimDetails 
	SELECT DISTINCT A.SchId,A.SchDsc,OrgFromDate,A.SchValidTill,ISNULL(CircularNo,''),ISNULL(SchemeBudget,0),0,0,0 AS SchPerdPriVal,SecSalesVal,
	Liab,Amount,Amount,0,@Pi_Usrid,@Pi_Transid FROM #SchemeDebit A INNER JOIN SchemeMaster B ON A.Schid=B.Schid
	--LEFT OUTER JOIN TradeSchemeFactors B(NOLOCK)
	--ON A.Schid = B.Schid 
	Order by A.Schid 
	
	UPDATE A SET Lst2Avg= B.L2MPrimarySales ,Wk4PriVal=B.L4WPrimarySales FROM  TempTradeSchemeClaimDetails A 
	INNER JOIN TradeSchemeFactors B(NOLOCK)ON A.Schid = B.Schid 
	 
	UPDATE A  SET SchPerdPriVal = B.SchPrimary FROM TempTradeSchemeClaimDetails A(NOLOCK) INNER JOIN #PrimaryBasedOnSch B(NOLOCK) ON A.SCHID =B.SchId 
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	
	--SELECT DISTINCT B.Schid,ISNULL(SUM(CapAmount+(SchPerdPriVal+((SchPerdPriVal*5.5)/100))),0)  AS CapAmount INTO #CapValue --SchPri Value Increased with 5.5% ILCRSTPAR7748
	SELECT DISTINCT B.Schid,ISNULL(SUM(CapAmount+SchPerdPriVal),0)  AS CapAmount INTO #CapValue
	FROM TempTradeSchemeClaimDetails A(NOLOCK) INNER JOIN TradeSchemeFactors B(NOLOCK) ON A.Schid = B.Schid 
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	GROUP BY B.Schid
	
	--UPDATE A SET CalClmAmt = ISNULL(( CASE WHEN ISNULL(CapAmount,0)>OrgClmAmt THEN OrgClmAmt ELSE ISNULL(CapAmount,0) END ),0),ApplycapVal =ISNULL(( CASE WHEN ISNULL(CapAmount,0)>OrgClmAmt THEN 0 ELSE 1 END ),0) 
	--FROM TempTradeSchemeClaimDetails A (NOLOCK)
	--INNER JOIN #CapValue B ON A.Schid = B.Schid  AND CapAmount>0
	--AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	SELECT  A.Schid,ISNULL(( CASE WHEN ISNULL(CapAmount,0)>SecSalValue  THEN (SecSalValue * (SchBudget/100)) 
	ELSE ISNULL((CapAmount * (SchBudget/100)),0) END ),0) AS CapAmt INTO #FinalCap
	FROM TempTradeSchemeClaimDetails A (NOLOCK)
	INNER JOIN #CapValue B ON A.Schid = B.Schid  --AND CapAmount>0
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	UPDATE A SET CalClmAmt = CASE WHEN ISNULL(CapAmt,0)>OrgClmAmt  THEN OrgClmAmt
	ELSE ISNULL(CapAmt,0) END , ApplyCapVal = CASE WHEN ISNULL(CapAmt,0)>OrgClmAmt  THEN 0
	ELSE 1 END
	FROM TempTradeSchemeClaimDetails A INNER JOIN #FinalCap B ON A.Schid = B.Schid 
	AND CapAmt>0
	-----------------added by lakshman M PMS ID: ILCRSTPAR7726
	UPDATE SD SET SD.LibPerc = (ISNULL(CAST(( SD.CalClmAmt/ nullif(SD.SecSalValue,0)) AS NUMERIC(18,6)),0)*100)
	FROM TempTradeSchemeClaimDetails SD (NOLOCK)      
	WHERE ApplyCapVal = 1 
	----------------- till here ----------
	--SELECT Schid,CASE WHEN LibPerc>SchBudget THEN ((CalClmAmt*SchBudget)/LibPerc)  ELSE 0 END NewClmAmt  INTO #NewClmAmt  FROM TempTradeSchemeClaimDetails A
	--WHERE  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	
	--UPDATE A SET CalClmAmt = NewClmAmt,  ApplycapVal = CASE ApplycapVal WHEN 0 THEN 2 ELSE 12 END  
	--FROM TempTradeSchemeClaimDetails A (NOLOCK)
	--INNER JOIN #NewClmAmt B ON A.Schid = B.Schid  AND NewClmAmt>0
	--AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid  
 	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_BLSchemeRulesetting' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeRulesetting
GO
/*
BEGIN TRANSACTION
delete from errorlog
delete from  schemertrlevelvalidation where schid =3874
EXEC Proc_CN2CS_BLSchemeRulesetting		0
Select * From schemertrlevelvalidation(Nolock)
select distinct * from Etl_Prk_Scheme_RetailerLevelValid
select * from  errorlog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeRulesetting
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_BLSchemeRulesetting
* PURPOSE		: To Insert and Update records in the Table Etl_Prk_SchemeRuleSettings_Temp,
				  Etl_Prk_SchemeRtrLevelValidation_Temp
* CREATED		: Nandakumar R.G
* CREATED DATE	: 06/01/2009
* MODIFIED
* DATE			AUTHOR				USERSTORYID			CR/BZ		DESCRIPTION 
------------------------------------------------------------------------------------------------------------------------------------------
* 09-Apr-2010   Jayakumar N										Change done based on "Rtr Cap" in SchConfig column in table Etl_Prk_SchemeRuleSettings.
																Based on "Rtr Cap" value updated in respective columns NoOfRtr and RtrCount in SchemeruleSettings table
* 19/12/2019	MarySubashini.S		CRCRSTPAR0094		CR		Retailer Level budget validation
* 03-02-2020	Mohana S			ILCRSTPAR7560		BZ		UAT ISSUE
* 12-02-2020	Mohana S			ILCRSTPAR7825 		BZ		IF Retailer Not Available in SchemertrlevelValidation, the Scheme will not apply	
* 27-11-2020	MOHANA S			PARCS202100059      CR		Fromdate Changed based on SchemeMaster(ServerDate)
*********************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 		AS INT
	DECLARE @Tabname AS     NVARCHAR(100)
	DECLARE @DestTabname AS NVARCHAR(100)
	DECLARE @Fldname AS     NVARCHAR(100)
	DECLARE @CmpSchCode AS NVARCHAR(200)
	DECLARE @SchConfig AS NVARCHAR(200)
	DECLARE @SchRules AS NVARCHAR(200)
	DECLARE @NoofBills AS NVARCHAR(200)
	DECLARE @FromDate AS NVARCHAR(200)
	DECLARE @ToDate AS NVARCHAR(200)
	DECLARE @MarketVisit AS NVARCHAR(200)
	DECLARE @ApplySchBasedOn AS NVARCHAR(200)
	DECLARE @EnableRtrLvl AS NVARCHAR(200)
	DECLARE @AllowSaving AS NVARCHAR(200)
	DECLARE @AllowSelection AS NVARCHAR(200)
	DECLARE @RtrCode AS NVARCHAR(200)
	DECLARE @RtrFromDate AS NVARCHAR(200)
	DECLARE @RtrToDate AS NVARCHAR(200)
	DECLARE @BudgetAllocated AS NVARCHAR(200)
	DECLARE @Status AS NVARCHAR(200)
	DECLARE @SchId AS INT
	DECLARE @SchConfigId AS INT
	DECLARE @SchRulesId AS INT
	DECLARE @ApplySchBasedOnId AS INT
	DECLARE @EnableRtrLvlId AS INT
	DECLARE @AllowSavingId AS INT
	DECLARE @AllowSelectionId AS INT
	DECLARE @RtrId AS INT
	DECLARE @StatusId AS INT
	DECLARE @SchLevelId 	AS INT
	DECLARE @ConFig		AS INT
	DECLARE @GetKey 	AS INT
	DECLARE @GetKeyCode	AS VARCHAR(200)
	DECLARE @CmpId 		AS INT
	DECLARE @SLevel		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @SlNo 		AS INT
	DECLARE @RtrAttrCnt	AS INT
	DECLARE @RtrLvlCnt	AS INT
	DECLARE @SchWithOutPrd AS INT	
	
	SET @DestTabname='SchemeRuleSetting'
	SET @Fldname='SchConfig'
	SET @Tabname = 'Etl_Prk_SchemeRuleSettings_Temp'
	SET @Exist=0
	SET @Po_ErrNo=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE Cur_SchemeRules CURSOR
	FOR SELECT DISTINCT ISNULL(CmpSchCode,'') AS CmpSchCode,ISNULL(SchConfig,''),ISNULL(SchRules,''),ISNULL(NoofBills,''),ISNULL(SchValidFrom,''),ISNULL(SchValidTill,''),
	ISNULL(MarketVisit,''),ISNULL(ApplySchBasedOn,''),ISNULL(EnableRtrLvl,''),ISNULL(AllowSaving,''),ISNULL(AllowSelection,'')
	FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY CmpSchCode
	OPEN Cur_SchemeRules
	FETCH NEXT FROM Cur_SchemeRules INTO @CmpSchCode,@SchConfig,@SchRules,@NoofBills,
	@FromDate,@ToDate,@MarketVisit,@ApplySchBasedOn,@EnableRtrLvl,@AllowSaving,@AllowSelection
	WHILE @@FETCH_STATUS=0
	BEGIN		
		SET @Po_ErrNo=0
		IF LTRIM(RTRIM(@CmpSchCode))=''
		BEGIN
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',
			'Company Scheme Code should not be empty')
			SET @Po_ErrNo=1
		END
		ELSE
		BEGIN
			SELECT @SchId=SchId,@SchLevelId=SchLevelId FROM SchemeMaster
			WHERE CmpSchCode=@CmpSchCode
		END
		
		IF @Po_ErrNo=0
		BEGIN
			IF LTRIM(RTRIM(@SchConfig))='---'
			BEGIN
				GOTO X 
				----CLOSE Cur_SchemeRules
				----DEALLOCATE Cur_SchemeRules
				----Return
			END
			IF LTRIM(RTRIM(@SchConfig))='YES'
			BEGIN
				SET @SchConfigId=1
			END
			ELSE 
			BEGIN
				SET @SchConfigId=0
			END
		END
		
		IF @SchConfigId=1 AND @Po_ErrNo=0
		BEGIN		
			IF LTRIM(RTRIM(@SchRules))=''
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Rules',
				'Scheme Rules should not be empty for Scheme Code:'+@CmpSchCode)
				SET @Po_ErrNo=1
			END
			ELSE
			BEGIN
				IF LTRIM(RTRIM(@SchRules))='PRODUCT'
				BEGIN
					SET @SchRulesId=0
				END
				ELSE IF LTRIM(RTRIM(@SchRules))='BILL'
				BEGIN
					SET @SchRulesId=1
				END	
				ELSE IF LTRIM(RTRIM(@SchRules))='DATE'
				BEGIN
					SET @SchRulesId=2
				END
				ELSE IF LTRIM(RTRIM(@SchRules))='MARKET'
				BEGIN
					SET @SchRulesId=3
				END			
			END
	
			IF @Po_ErrNo=0
			BEGIN
				IF @SchRulesId=1
				BEGIN
					IF NOT ISNUMERIC(@NoofBills)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme No Of Bills should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE IF @NoofBills<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme No Of Bills should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END	
				END
				ELSE IF @SchRulesId=2
				BEGIN
					IF @Po_ErrNo=0
					BEGIN
						IF ISDATE(@FromDate)=1 AND ISDATE(@ToDate)=1
						BEGIN
							IF DATEDIFF(DD,@FromDate,@ToDate)<0 OR @ToDate< CONVERT(NVARCHAR(10),GETDATE(),121)
							BEGIN
								INSERT INTO Errorlog VALUES (1,@TabName,'Date',
								'From Date should be less than To Date for Scheme Code:'+@CmpSchCode)           	
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Date',
							'Either From Date or To Date is wrong for Scheme Code:'+@CmpSchCode)           	
							SET @Po_ErrNo=1
						END
					END	
				END
				IF @SchRulesId=3
				BEGIN
					IF ISNUMERIC(@MarketVisit)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Market Visits',
						'Scheme Market Visits should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE IF @MarketVisit<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme Market Visits should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
				END
			END
	
			IF @Po_ErrNo=0
			BEGIN
				IF LTRIM(RTRIM(@ApplySchBasedOn))=''
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Scheme-Apply Based On',
					'Scheme-Apply Based On Rules should not be empty for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo=1
				END
				ELSE
				BEGIN
					IF LTRIM(RTRIM(@ApplySchBasedOn))='Company'
					BEGIN
						SET @ApplySchBasedOnId=0
					END
					ELSE IF LTRIM(RTRIM(@ApplySchBasedOn))='Retailer'
					BEGIN
						SET @ApplySchBasedOnId=1
					END	
					ELSE IF LTRIM(RTRIM(@ApplySchBasedOn))='JC'
					BEGIN
						SET @ApplySchBasedOnId=2
					END
				END	
			END
		END
		ELSE
		BEGIN
			SET @SchRulesId=-1
			SET @ApplySchBasedOnId=-1		
			SET @MarketVisit=-1		
			IF UPPER(@SchConfig)<>UPPER('Rtr Cap')
			BEGIN
				SET @NoofBills=-1					
			END
		END
	
		IF @Po_ErrNo=0
		BEGIN
			IF LTRIM(RTRIM(@EnableRtrLvl))='Yes'
			BEGIN
				SET @EnableRtrLvlId=1	
							
			END
			ELSE
			BEGIN
				SET @EnableRtrLvlId=0
			END
		END
			
		IF @Po_ErrNo=0
		BEGIN
			IF @EnableRtrLvlId=1
			BEGIN
				 
				IF NOT EXISTS (SELECT * FROM Etl_Prk_Scheme_RetailerLevelValid WHERE CmpSchCode=@CmpSchCode)
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Level Validation',
					'Retailer not found for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo =1
				END
				IF LTRIM(RTRIM(@AllowSaving))='Yes'
				BEGIN
					SET @AllowSavingId=1					
				END
				ELSE
				BEGIN
					SET @AllowSavingId=0					
				END
				IF LTRIM(RTRIM(@AllowSelection))='Yes'
				BEGIN
					SET @AllowSelectionId=1					
				END
				ELSE
				BEGIN
					SET @AllowSelectionId=0					
				END
			END
			ELSE
			BEGIN
				SET @AllowSavingId=0
				SET @AllowSelectionId=0
			END
		END
		 
		
		---Insert Rule
		IF @ConFig<>1
		BEGIN
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster 
			WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',
				'Company Scheme Code not found')
				SET @Exist=0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SET @Po_ErrNo =0
				IF EXISTS(SELECT * FROM SchemeRuleSettings WHERE SchId=@GetKey)
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
			END
		END
		ELSE
		BEGIN
			IF EXISTS(SELECT SchId FROM SchemeMaster 
			WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
			BEGIN
				SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster 
				WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId FROM SchemeMaster 
				WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				IF EXISTS(SELECT * FROM SchemeRuleSettings WHERE SchId=@GetKey)
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
				SET @Po_ErrNo =0
			END
			ELSE IF EXISTS(SELECT CmpSchCode FROM ETL_Prk_SchemeMaster_Temp WHERE
				CmpSchCode=LTRIM(RTRIM(@CmpSchCode)) AND UpLoadFlag='N')
			BEGIN
				SELECT @GetKeyCode=CmpSchCode,@CmpId=CmpId FROM ETL_Prk_SchemeMaster_Temp WHERE
				CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId
				FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				IF EXISTS(SELECT * FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
			END	
		END		
		
		IF @ConFig=1
		BEGIN	
			SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
			IF @CmpPrdCtgId<@SLevel
			BEGIN
				SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='NO'
				AND A.SlabId=0 AND A.SlabValue=0
				SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
				A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='NO'
				AND A.SlabId=0 AND A.SlabValue=0
			END
			ELSE
			BEGIN
				SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='YES'
				AND A.SlabId=0 AND A.SlabValue=0
				SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
				AND  A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='YES'
				AND A.SlabId=0 AND A.SlabValue=0
			END
			IF @EtlCnt=@CmpCnt
			BEGIN	
				SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
				INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode))
				IF @EtlCnt=@CmpCnt
				BEGIN
					SET @SchWithOutPrd=1
				END
				ELSE
				BEGIN
					SET @SchWithOutPrd=2
				END	
			END
			ELSE
			BEGIN
				SET @SchWithOutPrd=2
			END	
		END
		ELSE
		BEGIN
			SET @SchWithOutPrd=1		
		END
		---		
		IF @Exist=0 AND @SchWithOutPrd=1   
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END
			END 
			----CRCRSTPAR0094
			
			
			INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,
			FromDate,ToDate,MarketVisit,ApplySchBasedOn,EnableRtrLvl,AllowSaving,
			AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,NoOfRtr,RtrCount)
			VALUES(@GetKey,@SchConfigId,@SchRulesId,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN -1 ELSE @NoofBills END ,
			@FromDate,@ToDate,@MarketVisit,@ApplySchBasedOnId,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN 1 ELSE @EnableRtrLvlId END,
			@AllowSavingId,@AllowSelectionId,1,1,GETDATE(),1,GETDATE(),
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN 1 ELSE 0 END,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN @NoofBills ELSE 0 END)
		END
		IF @Exist=1 AND @SchWithOutPrd=1
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			UPDATE SchemeRuleSettings SET SchConfig=@SchConfigId,SchRules=@SchRulesId,
			NoofBills=@NoofBills,FromDate=@FromDate,ToDate=@ToDate,MarketVisit=@MarketVisit,
			ApplySchBasedOn=@ApplySchBasedOnId,EnableRtrLvl=@EnableRtrLvlId,AllowSaving=@AllowSavingId
			WHERE SchId=@GetKey			
		END
		IF @Exist=0 AND @SchWithOutPrd=2
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			INSERT INTO Etl_Prk_SchemeRuleSettings_Temp(CmpSchCode,SchConfig,SchRules,NoofBills,
			FromDate,ToDate,MarketVisit,ApplySchBasedOn,EnableRtrLvl,AllowSaving,AllowSelection)
			VALUES(@CmpSchCode,@SchConfigId,@SchRulesId,@NoofBills,@FromDate,@ToDate,
			@MarketVisit,@ApplySchBasedOnId,@EnableRtrLvlId,@AllowSavingId,
			@AllowSelectionId)
		END
		IF @Exist=1 AND @SchWithOutPrd=2
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			UPDATE Etl_Prk_SchemeRuleSettings_Temp SET SchConfig=@SchConfigId,
			SchRules=@SchRulesId,NoofBills=@NoofBills,FromDate=@FromDate,ToDate=@ToDate,
			MarketVisit=@MarketVisit,ApplySchBasedOn=@ApplySchBasedOnId,
			EnableRtrLvl=@EnableRtrLvlId,AllowSaving=@AllowSavingId
			WHERE CmpSchCode=@CmpSchCode			
		END
		IF @EnableRtrLvlId=1 AND @Po_ErrNo=0
		BEGIN
			SET @SlNo=1 ---CRCRSTPAR0094  
			
			IF EXISTS (SELECT 'X' FROM SchemeRtrLevelValidation WHERE SchId=@GetKey)
			BEGIN
				SET @Exist=1
			END 
			ELSE 
			BEGIN
				SET @Exist=0
			END 		
			 
			
			DECLARE Cur_SchemeRulesRetailer CURSOR
			FOR SELECT ISNULL(RtrCode,''),ISNULL(B.SchValidFrom,''),ISNULL(ToDate,''),
			ISNULL(BudgetAllocated,''),ISNULL(Status,'')
			FROM Etl_Prk_Scheme_RetailerLevelValid A INNER JOIN SchemeMaster B(NOLOCK) ON A.CmpSchCode = B.CmpSchCode  WHERE A.CmpSchCode=@CmpSchCode
			AND RtrCode IN (SELECT CmpRtrCode  FROM Retailer) AND ISNULL(BudgetAllocated,'0.00') <> '0.00' --ILCRSTPAR7560
			OPEN Cur_SchemeRulesRetailer
		
			FETCH NEXT FROM Cur_SchemeRulesRetailer INTO @RtrCode,@RtrFromDate,@RtrToDate,
			@BudgetAllocated,@Status
			WHILE @@FETCH_STATUS=0
			BEGIN
				SET @Po_ErrNo=0  --ILCRSTPAR7825
				IF LTRIM(RTRIM(@RtrCode))=''
				BEGIN
					INSERT INTO Errorlog VALUES (1,'Etl_Prk_Scheme_RetailerLevelValid','Retailer Code',
					'Retailer Code should not be empty for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo=1
				END
				IF @Po_ErrNo=0
				BEGIN
					IF NOT EXISTS(SELECT * FROM Retailer WITH (NOLOCK)
					WHERE CmpRtrCode=@RtrCode)---CRCRSTPAR0094 RtrCode to CmpRtrCode
					BEGIN
						INSERT INTO Errorlog VALUES (1,'Etl_Prk_Scheme_RetailerLevelValid','Retailer',
						'Retailer : '+@RtrCode+' is not available for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					ELSE
					BEGIN
						SELECT @RtrId=RtrId FROM Retailer WITH (NOLOCK)
						WHERE CmpRtrCode=@RtrCode ---CRCRSTPAR0094 RtrCode to CmpRtrCode
					END
				END		
				IF @Po_ErrNo=0
				BEGIN
					IF EXISTS(SELECT * FROM Etl_Prk_Scheme_OnAttributes WHERE 
						CmpSchCode=@CmpSchCode AND AttrType='RETAILER' AND AttrName<> 'ALL')
					BEGIN
						IF NOT EXISTS(SELECT * FROM Etl_Prk_Scheme_OnAttributes WHERE 
						CmpSchCode=@CmpSchCode AND AttrType='RETAILER' AND AttrName=@RtrCode)
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Level Validation',
							'Retailer Mismatch for Scheme Code:'+@CmpSchCode)
							SET @Po_ErrNo =1
						END	
					END
				END
				 
				IF @Po_ErrNo=0
				BEGIN
					IF ISDATE(@RtrFromDate)=1 AND ISDATE(@RtrToDate)=1
					BEGIN
						IF DATEDIFF(DD,@RtrFromDate,@RtrToDate)<0 OR @RtrToDate< CONVERT(NVARCHAR(10),GETDATE(),121)
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Date',
							'From Date should be less than To Date for Scheme Code:'+@CmpSchCode)           	
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Either From Date or To Date is wrong for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
				END
				
				IF @Po_ErrNo=0
				BEGIN
					IF (DATEDIFF(DD,@FromDate,@RtrFromDate)<0 OR DATEDIFF(DD,@RtrFromDate,@ToDate)<0)
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Retailer From Date should be within From and To Date for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					
					IF (DATEDIFF(DD,@FromDate,@RtrToDate)<0 OR DATEDIFF(DD,@RtrToDate,@ToDate)<0)
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Retailer To Date should be within From and To Date for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
				END
				
				IF @Po_ErrNo=0
				BEGIN
					IF NOT ISNUMERIC(@BudgetAllocated)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Budget Allocated',
						'Budget Allocated should be numeric value for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					ELSE IF (CAST(@BudgetAllocated AS NUMERIC(38,6)))<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Budget Allocated should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
				END
				IF @Po_ErrNo=0
				BEGIN				
					IF LTRIM(RTRIM(@Status))=''
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Status',
						'Retailer Status should not be empty for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE
					BEGIN
						IF LTRIM(RTRIM(@Status))='YES'
						BEGIN
							SET @StatusId=1					
						END
						ELSE
						BEGIN
							SET @StatusId=0					
						END
					END
				END	
				IF @Exist=0 AND @SchWithOutPrd=1
				BEGIN
					IF @Po_ErrNo=0 
					BEGIN
						INSERT INTO SchemeRtrLevelValidation(SchId,RtrId,FromDate,ToDate,
						BudgetAllocated,BudgetUtilized,BudgetAvailable,Status,Slno,
						Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@GetKey,@RtrId,@RtrFromDate,@RtrToDate,
						CAST(@BudgetAllocated AS NUMERIC(38,6)),0,0,@StatusId,@SlNo,1,1,GETDATE(),1,GETDATE())
					END
					IF @Exist=1 AND @SchWithOutPrd=1
					BEGIN
						 
						UPDATE SchemeRtrLevelValidation SET FromDate=@FromDate,ToDate=@ToDate,
						BudgetAllocated=CAST(@BudgetAllocated AS NUMERIC(38,6)),
						BudgetAvailable=CAST(@BudgetAllocated AS NUMERIC(38,6))-BudgetUtilized,
						Status=@StatusId
						WHERE SchId=@GetKey AND RtrId=@RtrId	
					END		 
				END
				IF @Po_ErrNo=0 
				BEGIN
					IF @Exist=0 AND @SchWithOutPrd=2
					BEGIN
						INSERT INTO Etl_Prk_SchemeRtrLevelValidation_Temp(CmpSchCode,RtrId,
						RtrCode,FromDate,ToDate,BudgetAllocated,BudgetUtilized,BudgetAvailable,
						Status,Slno)
						VALUES(@CmpSchCode,@RtrId,@RtrCode,@RtrFromDate,@RtrToDate,@BudgetAllocated,
						0,0,@Status,@Slno)
					END
				 
					IF @Exist=1 AND @SchWithOutPrd=2
					BEGIN
						UPDATE Etl_Prk_SchemeRtrLevelValidation_Temp SET FromDate=@FromDate,
						ToDate=@ToDate,BudgetAllocated=CAST(@BudgetAllocated AS NUMERIC(38,6)),Status=@Status
						WHERE CmpSchCode=@CmpSchCode AND RtrCode=@RtrCode			
					END
				END
				SET @SlNo=@SlNo+1
				FETCH NEXT FROM Cur_SchemeRulesRetailer INTO @RtrCode,@RtrFromDate,@RtrToDate,@BudgetAllocated,@Status
			END
			CLOSE Cur_SchemeRulesRetailer
			DEALLOCATE Cur_SchemeRulesRetailer
		END	
		X:			
		FETCH NEXT FROM Cur_SchemeRules INTO @CmpSchCode,@SchConfig,@SchRules,@NoofBills,@FromDate,@ToDate,
		@MarketVisit,@ApplySchBasedOn,@EnableRtrLvl,@AllowSaving,@AllowSelection
	END
	CLOSE Cur_SchemeRules
	DEALLOCATE Cur_SchemeRules
END
GO
--- Purchase notification Load config By venkat. M PMS no :CRCRSTPAR0107
DELETE FROM ManualConfiguration WHERE ModuleId ='PURCHASERECEIPT01'
INSERT INTO ManualConfiguration(ProjectName, Moduleid, ModuleName, Description, Status, Condition, ConfigValue, Seqno)
SELECT 'PARLE','PURCHASERECEIPT01','PurchaseReceipt','Pending Purchase Confirmation on ...',1,'','5.00',1
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='AutoDebitNoteTopSheet' 
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','AutoDebitNoteTopSheet','DebitNoteTopSheet','Auto Opening for DebitNoteTopSheet',1,0,0,1
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_NoRec' AND TYPE='U')
BEGIN
	CREATE TABLE DebitNoteTopSheetClaim_NoRec 
	(
	ClmYear		INT,
	MonthId		INT,
	ClmMonth	VARCHAR(100),
	Remarks		NVARCHAR(100),
	Upload		INT
	)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_DisableMenuForClaim' and XTYPE In ('TF','FN'))
DROP FUNCTION Fn_DisableMenuForClaim
GO
--Select MenuName From Fn_DisableMenuForClaim(2) 
CREATE FUNCTION [dbo].[Fn_DisableMenuForClaim](@PrfId INT)
RETURNS @MasterDetails TABLE
(
	MenuName			VARCHAR(80)
)
AS
/*********************************  
* PROCEDURE		: Fn_DisableMenuForClaim
* PURPOSE		: 
* CREATED BY	: Mohana.S
* CREATED DATE	: 14/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
*********************************/ 
BEGIN
	
		INSERT INTO @MasterDetails(MenuName)
		--SELECT DISTINCT  MenuName FROM MenuDef A  --INNER JOIN ProfileDt P ON A.MenuId = P.MenuId 
		----AND P.PrfId = @PrfId
		Select Distinct b.MenuName from profiledt a INNER JOIN MenuDef b ON  
		A.MenuId = B.MenuId AND a.PrfId =@PrfId  
		WHERE MenuName NOT IN ('mnuDebitNoteTopSheet','mnuClaimMgmt','mnuReports','MNUUSERPROFILEMAINTENANCE','MNUWEBSITE','MNUTARGETNORM','MNUDRILDOWN','MROUTEVILLAGEMAP')
		Group by b.MenuName Having Sum(BtnStatus)>0
		
		IF @PrfId >= 1
		BEGIN
			DELETE D FROM @MasterDetails D
			INNER JOIN MenuDef M ON D.MenuName = M.MenuName
			INNER JOIN ProfileDt P ON M.MenuId = P.MenuId 
			AND P.BtnStatus = 1 
			AND P.PrfId = @PrfId
			WHERE M.MenuId IN ('mClm14','mRep2','mRep5','mRep1','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9','mRot2','mPln1','mPln2')
			--WHERE M.MenuId IN ('mClm14','mStk','mStk31','mRep2','mRep5','mRep1','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9')
		END 
	RETURN
END
GO
--SELECT * from DBO.Fn_CheckPendingDebitNote(1) As RtnVal
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Fn_CheckPendingDebitNote' and xtype in ('TF','FN'))
DROP FUNCTION Fn_CheckPendingDebitNote
GO
CREATE FUNCTION Fn_CheckPendingDebitNote(@Type As INT)
RETURNS @PendingClaim Table
(
Pending	INT,
ValidMsg VARCHAR(500)
)
AS
/************************************************
* PROCEDURE		: Fn_CheckPendingDebitNote
* PURPOSE		: Check For Pending DEbitNote
* CREATED BY	: Mohana.S
* CREATED DATE	: 14/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
*************************************************/
BEGIN

DECLARE @ReturnVal AS INT
DECLARE @ConfigDays AS INT
DECLARE @ClmDate AS DATETIME
DECLARE @PrevMonthStDt AS DATETIME
 

SET @ReturnVal=0

	 
		SELECT @PrevMonthStDt=CONVERT(VARCHAR(10),DATEADD(month, DATEDIFF(month, -1, getdate()) - 2, 0),121)

		IF EXISTS(SELECT 'C' FROM ManualConfiguration WHERE ModuleId ='AutoDebitNoteTopSheet'  AND Status = 1)
		BEGIN

			IF EXISTS(SELECT * FROM JCMonthEnd WHERE @PrevMonthStDt BETWEEN JcmSdt AND JcmEdt AND Status=1)
			BEGIN
			 
				IF NOT EXISTS(SELECT 'C' FROM DebitNoteTopSheetClaimHd WHERE ClmMonth=DATENAME(Month,@PrevMonthStDt) AND ClmYear=Year(@PrevMonthStDt))
				BEGIN		
					IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaim_NoRec WHERE ClmMonth=DATENAME(Month,@PrevMonthStDt) AND ClmYear=Year(@PrevMonthStDt))
					BEGIN	
						SET @ReturnVal=1

						INSERT INTO @PendingClaim
						SELECT @ReturnVal, 'Claim Is Pending For ' + DATENAME(Month,@PrevMonthStDt)+' . '+ CHAR(13) 
						+ 'Click To Raise the CLaim'
					END
				END
				ELSE
				BEGIN
						INSERT INTO @PendingClaim
						SELECT 0,''
				END
			END
		END
 
	
RETURN 
END
GO
DELETE FROM CustomUpdownload WHERE Module='DebitNoteTopSheet_NoClaim' AND UpDownload ='Upload'
INSERT INTO CustomUpDownload 
SELECT Max(slno)+1,1,'DebitNoteTopSheet_NoClaim','DebitNoteTopSheet_NoClaim','Proc_CS2CN_DebitNoteTopSheet_NoClaim','','CS2CN_Prk_DebitNoteTopSheet_NoClaim','','Transaction','Upload',1
FROM CustomUpdownload Where UPDownload='UPload'
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName = 'DebitNoteTopSheet_NoClaim'
INSERT INTO Tbl_UploadIntegration
SELECT  Max(SequenceNo)+1,'DebitNoteTopSheet_NoClaim','DebitNoteTopSheet_NoClaim','CS2CN_Prk_DebitNoteTopSheet_NoClaim',GETDATE()
FROM Tbl_UploadIntegration WHERE SequenceNo NOT IN (1001,1002)
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CS2CN_Prk_DebitNoteTopSheet_NoClaim]') AND type in (N'U'))
DROP TABLE CS2CN_Prk_DebitNoteTopSheet_NoClaim
GO
CREATE TABLE CS2CN_Prk_DebitNoteTopSheet_NoClaim
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[ClmYear]		INT,
	[MonthId]		INT,
	[ClmMonth]	VARCHAR(100),
	[Remarks]		NVARCHAR(100),
	[UploadFlag] [nvarchar](2) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
)
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_CS2CN_DebitNoteTopSheet_NoClaim]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_CS2CN_DebitNoteTopSheet_NoClaim
GO
CREATE PROCEDURE Proc_CS2CN_DebitNoteTopSheet_NoClaim
(  
 @Po_ErrNo INT OUTPUT, 
 @ServerDate DATETIME 
)  
AS  
SET NOCOUNT ON  
BEGIN  
/********************************************************************* 
* PROCEDURE		: Proc_CS2CN_DebitNoteTopSheet_NoClaim
* PURPOSE		:  
* CREATED BY	: Mohana.S
* CREATED DATE	: 18/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
**********************************************************************/
 SET @Po_ErrNo = 0  
 DECLARE @CmpID   AS INTEGER  
 DECLARE @DistCode AS NVARCHAR(50)  

 TRUNCATE TABLE CS2CN_Prk_DebitNoteTopSheet_NoClaim      
 SELECT @DistCode = DistributorCode FROM Distributor 
	 	 
 INSERT INTO CS2CN_Prk_DebitNoteTopSheet_NoClaim(DistCode,ClmYear,MonthId,ClmMonth,Remarks,UploadFlag)
 SELECT @DistCode,ClmYear,MonthId,ClmMonth,Remarks,'N'
 FROM DebitNoteTopSheetClaim_NoRec WHERE Upload = 0
		  		  
 UPDATE A SET Upload =1 FROM DebitNoteTopSheetClaim_NoRec A INNER JOIN CS2CN_Prk_DebitNoteTopSheet_NoClaim B 
 ON A.ClmYear=B.ClmYear AND A.MonthId=B.MonthId AND A.ClmMonth = B.ClmMonth

END
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' 
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','PendingTransAlert','PendingTransAlert','PendingTransAlert For Billing,SalesReturn and Purchase',1,0,3,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='PendingTransDetails' AND TYPE='U')
DROP TABLE PendingTransDetails
GO
CREATE TABLE PendingTransDetails
(
	[ModuleName] [nvarchar](100) NULL,
	[PendingCount] [int] NULL
) 
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='TmpValidatePendingData' AND TYPE='U')
DROP TABLE TmpValidatePendingData
GO
CREATE TABLE TmpValidatePendingData
(
	[SlNo] [int] NULL,
	[ProcessName] [nvarchar](100) NULL,
	[MenuName] [nvarchar](200) NULL,
	[Validate] [int] NULL
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='ProfileDt_PendingTran' AND TYPE='U')
BEGIN
CREATE TABLE ProfileDt_PendingTran
(
	[PrfId] [int] NOT NULL,
	[MenuId] [varchar](50) NOT NULL,
	[BtnIndex] [int] NULL,
	[BtnDescription] [varchar](50) NULL,
	[BtnStatus] [tinyint] NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL,
	[Parentid] [varchar](50) NULL
)
END
GO
DELETE FROM ManualConfiguration WHERE ModuleId ='CSTimer2'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','CSTimer2','CS Timer','Enable Server Date Validation',1,'',1.00,1 
GO
DELETE FROM MenuDef WHERE  SrlNo = 254 and MenuId = 'mStk39'
GO
INSERT INTO MenuDef (SrlNo,MenuId,MenuName,ParentId,Caption,MenuStatus,FormName,DefaultCaption)
VALUES (254,'mStk39','mnuEInvoice','mStk','E-Invoice',0,'C:\CoreStocky-CITRIX\CSSourceCitrix\CoreStocky\E-Invoice API.exe','E-Invoice')
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_CheckDuplicateClmDate' AND TYPE='FN')
DROP FUNCTION Fn_CheckDuplicateClmDate
GO
CREATE FUNCTION Fn_CheckDuplicateClmDate (@Pi_Year INT,@Pi_Month INT)
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckDuplicateClmDate  
* PURPOSE	: To validate CLAIM DATA WHICH IS ALREADY RAISED
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 17-07-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @MonthEndDt AS DATETIME
DECLARE @FromDate  DATETIME
DECLARE @ToDate	   DATETIME
SET @ValidateMsg = ''

IF EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE ClmYear = @Pi_Year AND Monthid =@Pi_Month )
BEGIN
	SET @ValidateMsg='Claim Already Raised For Selected Month'
END

RETURN @ValidateMsg
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Fn_CheckZeroClm' AND TYPE='FN')
DROP FUNCTION Fn_CheckZeroClm
GO
CREATE FUNCTION Fn_CheckZeroClm (@Pi_Year INT,@Pi_Month INT)
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckDuplicateClmDate  
* PURPOSE	: To validate CLAIM DATA WHICH IS ALREADY RAISED FOR ZERO
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 18-01-2021
* PMS		: 
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @MonthEndDt AS DATETIME
DECLARE @FromDate  DATETIME
DECLARE @ToDate	   DATETIME
SET @ValidateMsg = ''

IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE ClmYear = @Pi_Year AND Monthid =@Pi_Month )
BEGIN
	IF EXISTS (SELECT * FROM DebitNoteTopSheetClaim_NoRec  WHERE ClmYear = @Pi_Year AND Monthid =@Pi_Month)
	BEGIN
		SET @ValidateMsg='Zero Claim Already Generated For Selected Month'
	END
END

RETURN @ValidateMsg
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CheckPendingTransaction' AND TYPE='P')
DROP PROCEDURE Proc_CheckPendingTransaction
GO
--EXEC Proc_CheckPendingTransaction 2,'2020-12-18',0
CREATE PROCEDURE Proc_CheckPendingTransaction
(
	@Po_Usrid INT,
	@Po_Serverdate DateTime,
	@Po_ErrNo INT OUTPUT
)
/*******************************************************
* PROCEDURE		: Proc_CheckPendingTransaction
* PURPOSE		: Check For Pending Transaction
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
 ********************************************************/ 
AS
SET NOCOUNT ON
BEGIN 

	EXEC Proc_MenuAccess 2

	DECLARE @Config INT
	DECLARE @Fromdate DATETIME
	DECLARE @Todate DATETIME
	SELECT @Config = ISNULL(ConfigValue,0)  FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1
	
	
	SET @Todate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Po_Serverdate,121))
	SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Todate), 0) 

	SET @Po_ErrNo=0
	BEGIN TRY
		BEGIN TRANSACTION  
			DELETE FROM PendingTransDetails 
			IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1)
			BEGIN
				CREATE TABLE #PendingTransDetails
				(
					ModuleName NVARCHAR(100),
					PendingCount	INT
				)
				--Pending Bills
				IF EXISTS(SELECT 1 FROM SalesInvoice SI (NOLOCK) INNER JOIN SalesInvoiceProduct SIP(NOLOCK) ON SI.SalId=SIP.SalId WHERE DLVSTS IN (1,2)
				AND  SalinvDate BETWEEN @Fromdate AND @Todate)
				BEGIN
					
					INSERT INTO #PendingTransDetails
					SELECT 'Billing',COUNT(DISTINCT Salinvno) FROM(
					SELECT SALINVNO FROM SalesInvoice SI (NOLOCK) 
					INNER JOIN SalesInvoiceProduct SIP(NOLOCK) ON SI.SalId=SIP.SalId WHERE DLVSTS IN (1,2)
					AND  SalinvDate BETWEEN @Fromdate AND @Todate)A
				 
				END
				--Purchase Receipt
				--IF EXISTS(SELECT 1 AS A FROM PurchaseReceipt(NOLOCK) WHERE STATUS=0  AND  GoodsRcvdDate BETWEEN @Fromdate AND @Todate UNION 
				--	SELECT 1 AS A from ETLTempPurchaseReceipt WHERE DownLoadStatus = 0 AND  InvDate BETWEEN @Fromdate AND @Todate)
				IF EXISTS(SELECT 1 AS A from ETLTempPurchaseReceipt WHERE DownLoadStatus = 0 AND  InvDate BETWEEN @Fromdate AND @Todate)
				BEGIN
					INSERT INTO #PendingTransDetails
					SELECT  'Purchase Receipt',COUNT(DISTINCT CmpInvNo) FROM
					(
						--SELECT CmpInvNo,InvDate FROM PurchaseReceipt (NOLOCK) WHERE STATUS=0  AND  GoodsRcvdDate  BETWEEN @Fromdate AND @Todate
						--UNION
						SELECT ETL.CmpInvNo,ETL.InvDate
						FROM ETLTempPurchaseReceipt ETL(NOLOCK),Company Cmp(NOLOCK),Supplier Spm(NOLOCK),Location Lcn(NOLOCK)
						WHERE ETL.CmpId=Cmp.CmpId AND  ETL.SpmId=Spm.SpmId AND  ETL.LcnId= Lcn.LcnId AND  
						ETL.DownLoadStatus = 0  AND  InvDate BETWEEN @Fromdate AND @Todate
					)A
				END
				
			--Sales Return
			IF EXISTS(SELECT 1 FROM Returnheader(NOLOCK) WHERE STATUS=1 AND ReturnDate BETWEEN @Fromdate AND @Todate)
			BEGIN
				INSERT INTO #PendingTransDetails
				SELECT  'Sales Return',COUNT(ReturnID) FROM Returnheader (NOLOCK) WHERE STATUS=1 
				AND ReturnDate  BETWEEN @Fromdate AND @Todate
			
			END
			--
			IF EXISTS(SELECT 1 FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate BETWEEN @Fromdate AND @Todate)
			BEGIN
				INSERT INTO #PendingTransDetails
				SELECT  'Sampling',COUNT(IssueId) FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate  BETWEEN @Fromdate AND @Todate
			
			END
	
			INSERT INTO  PendingTransDetails
			SELECT ModuleName,SUM(PendingCOunt) FROM #PendingTransDetails GROUP BY ModuleName
	 
		END	
		COMMIT TRANSACTION  	
	END TRY
	
	BEGIN CATCH			
			SET @Po_ErrNo=1
			ROLLBACK TRANSACTION  
	END CATCH
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidatePendingTransactionForAutoPopup' AND TYPE='P')
DROP PROCEDURE Proc_ValidatePendingTransactionForAutoPopup
GO
CREATE PROCEDURE Proc_ValidatePendingTransactionForAutoPopup
(
	@Pi_date DATETIME,
	@Type int
)
AS
/*******************************************************
* PROCEDURE		: Proc_ValidatePendingTransactionForAutoPopup
* PURPOSE		: Check For Pending Transaction
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
*********************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @Config INT
	DECLARE @Fromdate DATETIME
	DECLARE @Todate DATETIME

	SELECT @Config = ISNULL(ConfigValue,0)  FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1
	
	--SET @Fromdate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Pi_date,121))

	--SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Pi_date), 0) 

	SET @Todate = DATEADD(DAY, (-1*@Config), CONVERT(VARCHAR(10),@Pi_date,121))

	SET @Fromdate= DATEADD(month, DATEDIFF(month, 0, @Todate), 0)

	DELETE FROM TmpValidatePendingData
	IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId ='PendingTransAlert' AND Status =1)
	BEGIN 
	
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT 'X' FROM SalesInvoice (NOLOCK)  
			WHERE DlvSts=1 AND  SalInvDate BETWEEN @Fromdate AND @Todate		)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT 2,'Billing','mnuVehicleAllocation',1  
			END
			
			IF EXISTS (SELECT 'X' FROM SalesInvoice (NOLOCK)  
			WHERE DlvSts=2 AND  SalInvDate  BETWEEN @Fromdate AND @Todate
			)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT 2,'Billing','mnuDeliveryProcess',1  
			END
			IF EXISTS(SELECT * FROM TmpValidatePendingData WHERE MenuName='mnuVehicleAllocation')
			BEGIN
				IF NOT EXISTS(SELECT * FROM TmpValidatePendingData WHERE MenuName='mnuDeliveryProcess')
				BEGIN
					INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
					SELECT 2,'Billing','mnuDeliveryProcess',1 
				END
			END
		END
	
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT DISTINCT A.Returnid FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnProduct B (NOLOCK)
				ON A.Returnid=B.Returnid AND  A.Status=1 AND  ReturnDate  BETWEEN @Fromdate AND @Todate )
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate) 
				SELECT 2,'Sales Return','mnuSalesReturn',1
			END
		END
		IF @Type = 1
		BEGIN
			IF EXISTS(SELECT 1 AS A FROM PurchaseReceipt(NOLOCK) WHERE STATUS=0 UNION 
						SELECT 1 AS A from ETLTempPurchaseReceipt (NOLOCK) WHERE DownLoadStatus = 0)
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
				SELECT DISTINCT 2,'Purchase Receipt','mnuPurchaseReceipt',1 FROM
				(
				SELECT CmpInvNo,InvDate FROM PurchaseReceipt (NOLOCK) WHERE STATUS=0 AND GoodsRcvdDate BETWEEN @Fromdate AND @Todate
				UNION
				SELECT ETL.CmpInvNo,ETL.InvDate
				FROM ETLTempPurchaseReceipt ETL(NOLOCK),Company Cmp(NOLOCK),Supplier Spm(NOLOCK),Location Lcn(NOLOCK),Transporter Trans (NOLOCK)
				WHERE ETL.CmpId=Cmp.CmpId AND  ETL.SpmId=Spm.SpmId AND  ETL.LcnId= Lcn.LcnId AND  
				ETL.TransporterId = Trans.TransporterId AND  ETL.DownLoadStatus = 0  AND invdate BETWEEN @Fromdate AND @Todate
				)A
			END
		END
		
		IF @Type=1
		BEGIN
			IF EXISTS (SELECT 'X' FROM FreeIssueHd(NOLOCK) WHERE STATUS=0 AND IssueDate BETWEEN @Fromdate AND @Todate )
			BEGIN
				INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate) 
				SELECT 2,'Sample Invoice','mnuSampleMgmt',1
			END
		END
		 
	END
	IF NOT EXISTS (SELECT * FROM TmpValidatePendingData WHERE Validate IN (0,1))
	BEGIN
		INSERT INTO TmpValidatePendingData(SlNo,ProcessName,MenuName,Validate)
		SELECT 3,'Nothing','',0
	END
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_MenuAccess' AND TYPE='P')
DROP PROCEDURE Proc_MenuAccess
GO
CREATE PROCEDURE Proc_MenuAccess(@Type INT)
AS
/*******************************************************
* PROCEDURE		: Proc_MenuAccess
* PURPOSE		:  
* CREATED BY	: Mohana.S
* CREATED DATE	: 19/12/2020
* PMS NO		: CRCRSTPAR0107
* MODIFIED
********************************************************************************************/ 
BEGIN
		IF NOT EXISTS (SELECT 'X' FROM ProfileDt_PendingTran)
		BEGIN
			INSERT INTO ProfileDt_PendingTran(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,Parentid)
			SELECT A.PrfId,A.MenuId,A.BtnIndex,A.BtnDescription,A.BtnStatus,
			A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate,B.Parentid
			FROM ProfileDt A INNER JOIN Menudef B ON A.MenuId=B.MenuId
		END

		IF @Type=1
		BEGIN 
			UPDATE A SET BtnStatus=B.BtnStatus FROM 
			ProfileDt A (NOLOCK) INNER JOIN ProfileDt_PendingTran B (NOLOCK) ON A.MenuId=B.MenuId
			AND A.BtnIndex=B.BtnIndex AND A.PrfId=B.PrfId
			
			UPDATE ProfileDt SET BtnStatus=0 WHERE 
			MenuId NOT IN(
			SELECT MenuId FROM Menudef WHERE MenuName IN (SELECT MenuName FROM TmpValidatePendingData WHERE Validate =1)
			UNION SELECT MenuId FROM Menudef WHERE MenuId IN ('mPln2','mPln1','mRep7','mRep2','mStk25','mRep5','mRep4','mRep3','mRep6','mRep7','mRep8','mRep9','mRot2'))
		END

		IF @Type=2
		BEGIN 
			UPDATE A SET BtnStatus=B.BtnStatus FROM 
			ProfileDt A (NOLOCK) INNER JOIN ProfileDt_PendingTran B (NOLOCK) ON A.MenuId=B.MenuId
			AND A.BtnIndex=B.BtnIndex AND A.PrfId=B.PrfId			
		END

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_YEGetOpenTrans' AND TYPE='P')
DROP PROCEDURE Proc_YEGetOpenTrans
GO
--EXEC Proc_YEGetOpenTrans '2020-12-01','2020-12-31',1
--SELECT * FROM YearEndOpenTrans
CREATE PROCEDURE Proc_YEGetOpenTrans
(
	@Pi_FromDate 		DATETIME,
	@Pi_ToDate		    DATETIME,
	@Pi_UsrId           INT
)
AS
/*********************************
* PROCEDURE	: Proc_YEGetOpenTrans
* PURPOSE	: To get the Open transactions for Year End
* CREATED	: Nandakumar R.G
* CREATED DATE	: 09/03/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
15/10/2019  Lakshman   BZ		ILCRSTPAR6197			Year End skip Purchase Process
21-12-2020  Mohana	   CR		CRCRSTPAR0107			Included Purchase Process
*********************************/
SET NOCOUNT ON
BEGIN
	TRUNCATE TABLE YearEndOpenTrans
	TRUNCATE TABLE YearEndLog
	
	---------- commented by lakshma M Dated ON 04/10/2019 PMS ID: ILCRSTPAR6197-----------
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 1,'mCmp9','Purchase','PurchaseReceipt',Sum(Cnt),@Pi_UsrId
	FROM(
	SELECT ISNULL(COUNT(*),0) Cnt
	FROM PurchaseReceipt WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION
	SELECT ISNULL(COUNT(*),0) Cnt
	FROM EtlTempPurchaseReceipt WHERE DownloadStatus=0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate)A
	 
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 1,'Purchase',PurRcptRefNo
	FROM PurchaseReceipt
	WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 2,'mCmp11','Purchase Return','PurchaseReturn',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 2,'Purchase Return',PurRetRefNo
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	-----------------Till here ----------------------
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 3,'mCmp12','Return To Company','ReturnToCompany',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 3,'Return To Company',RtnCmpRefNo
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 4,'mInv4','Stock Management','StockManagement',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 4,'Stock Management',StkMngRefNo
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 5,'mInv7','Salvage','Salvage',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 5,'Salvage',SalvageRefNo
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 6,'mCus18','Billing','SalesInvoice',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 6,'Billing',SalInvNo
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 7,'Sales Return','ReturnHeader',ISNULL(COUNT(*),0),0,@Pi_UsrId
	FROM ReturnHeader
	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader
	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate

	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 7,'mCus20','Sales Return','Sales Return',A.Counts+B.Counts,@Pi_UsrId
	FROM 
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader
		WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) A	,
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader RH,SalesInvoice SI
		WHERE RH.Status=1 AND RH.ReturnType=1 
		AND RH.SalId=SI.SalId AND SI.DlvSts<3
		AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) B
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader
	WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader RH,SalesInvoice SI
	WHERE RH.Status=1 AND RH.ReturnType=1 AND RH.SalId=SI.SalId AND SI.DlvSts<3
	AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--->Till Here
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 8,'mCus23','Resell Damage Goods','ResellDamageMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 8,'Resell Damage Goods',ReDamRefNo
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 9,'mClm6','Salesman Salary And DA Claim','SalesmanClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 9,'Salesman Salary And DA Claim',ScmRefNo
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 10,'mClm7','Delivery Boy Salary And DA Claim','DeliveryBoyClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 10,'Delivery Boy Salary And DA Claim',DbcRefNo
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 11,'mClm5','Salesman Incentive Calculator','SMIncentiveCalculatorMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 11,'Salesman Incentive Calculator',SicRefNo
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 12,'mClm13','Van Subsidy Claim','VanSubsidyHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 12,'Van Subsidy Claim',RefNo
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 13,'mClm11','Transporter Claim','TransporterClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 13,'Transporter Claim',TrcRefNo
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 14,'mClm4','Special Discount Claim','SpecialDiscountMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 14,'Special Discount Claim',SdcRefNo
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 15,'mClm8','Rate Difference Claim','RateDifferenceClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 15,'Rate Difference Claim',RefNo
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 16,'mClm9','Purchase Shortage Claim','PurShortageClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 16,'Purchase Shortage Claim',PurShortRefNo
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 17,'mClm10','Purchase Excess Claim','PurchaseExcessClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 17,'Purchase Excess Claim',RefNo
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 18,'mClm3','Manual Claim','ManualClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 18,'Manual Claim',MacRefNo
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 19,'mClm16','VAT Claim','VatTaxClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 19,'VAT Claim',SvatNo
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 20,'Claim Top Sheet','ClaimSheetHD',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 20,'Claim Top Sheet',ClmCode
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 21,'mClm15','Spent and Received','SpentReceivedHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 21,'Spent and Received',SRDRefNo
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 22,'mCus29','Point Redemption Product','PntRetSchemeHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 22,'Point Redemption Product',PntRedRefNo
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 23,'mCus34','Coupon Redemption','CouponRedHd',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 23,'Coupon Redemption',CpnRedCode
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate	
    
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 25,'mCmp18','IDT Management','IDTManagement',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM IDTManagement WITH(NOLOCK) WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate    
    
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 25,'IDT Management',IDTMngRefNo FROM IDTManagement WITH(NOLOCK) 
    WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 26,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SampleIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 26,'Sample Issue',IssueRefNo FROM SampleIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 27,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM FreeIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 27,'Sample Issue',IssueRefNo FROM FreeIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate 
    
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 28,'mCus36','Sample Receipt','SampleReceipt',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SamplePurchaseReceipt WITH(NOLOCK) WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 28,'Sample Receipt',PurRcptRefNo FROM SamplePurchaseReceipt WITH(NOLOCK) 
    WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 
 --   INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	--SELECT 29,'mInv6','Batch Transfer','BatchTransfer',ISNULL(COUNT(*),0),@Pi_UsrId
 --   FROM BatchTransferHD WITH(NOLOCK) WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 --   INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
 --   SELECT 29,'Batch Transfer',BatRefNo FROM BatchTransferHD WITH(NOLOCK) 
 --   WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate              
END
GO
------ Accounts Calendar & JC Calendar 2021 SCRIPT.
DECLARE @AcmId AS INT
DECLARE @ACPeriod AS NUMERIC(18,0)
DECLARE @JCMId AS INT
IF NOT EXISTS (SELECT * FROM ACMaster WHERE AcmYr = 2021)
BEGIN
		SELECT @AcmId= dbo.Fn_GetPrimaryKeyInteger('ACMASTER','ACMID',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
		SELECT @ACPeriod = ISNULL(MAX(AcpId),0) FROM AcPeriod WITH(NOLOCK)
		UPDATE Counters SET CurrValue = @AcmId WHERE TabName='ACMASTER' and FldName='ACMID'
		INSERT INTO ACMaster (ACMID,ACMYR,ACMTYPE,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) 
		VALUES (@AcmId,2021,'1','1','2',GETDATE(),'1',GETDATE())
		
		DELETE FROM ACPeriod WHERE AcmId=@AcmId 
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+1,4,'2021-04-01','2021-04-30','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+2,5,'2021-05-01','2021-05-31','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+3,6,'2021-06-01','2021-06-30','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+4,7,'2021-07-01','2021-07-31','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+5,8,'2021-08-01','2021-08-31','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+6,9,'2021-09-01','2021-09-30','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+7,10,'2021-10-01','2021-10-31','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+8,11,'2021-11-01','2021-11-30','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+9,12,'2021-12-01','2021-12-31','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+10,1,'2022-01-01','2022-01-31','Q4','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+11,2,'2022-02-01','2022-02-28','Q4','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO ACPeriod (ACMID,ACPID,ACMONTH,ACMSDT,ACMEDT,ACMPERIOD,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@AcmId,@ACPeriod+12,3,'2022-03-01','2022-03-31','Q4','1','2',GETDATE(),'1',GETDATE())
END
IF NOT EXISTS(SELECT * FROM JCMast WHERE JcmYr=2021)
BEGIN
		SELECT @JCMId= dbo.Fn_GetPrimaryKeyInteger('JcMast','JcmId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))

		UPDATE Counters SET CurrValue = @JCMId WHERE TabName='JCMAST' and FldName='JCMID'

		INSERT INTO JCMAST (JCMID,JCMYR,CMPID,WKENDDAY,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) 
		VALUES (@JCMId,2021,1,'1','1','2',GETDATE(),'1',GETDATE())

		DELETE FROM JcMonth where JcmId=@JCMId
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,'2021-01-01','2021-01-31','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,2,'2021-02-01','2021-02-28','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,'2021-03-01','2021-03-31','Q1','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,'2021-04-01','2021-04-30','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,'2021-05-01','2021-05-31','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,'2021-06-01','2021-06-30','Q2','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,'2021-07-01','2021-07-31','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,'2021-08-01','2021-08-31','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,'2021-09-01','2021-09-30','Q3','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,'2021-10-01','2021-10-31','Q4','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,'2021-11-01','2021-11-30','Q4','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcMonth (JCMID,JCMJC,JCMSDT,JCMEDT,QUARTERDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,'2021-12-01','2021-12-31','Q4','1','2',GETDATE(),'1',GETDATE())

		DELETE FROM JcWeek where JcmId=@JCMId
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,1,'2021-01-01','2021-01-03','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,2,'2021-01-04','2021-01-10','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,3,'2021-01-11','2021-01-17','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,4,'2021-01-18','2021-01-24','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,1,5,'2021-01-25','2021-01-31','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,2,1,'2021-02-01','2021-02-07','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,2,2,'2021-02-08','2021-02-14','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,2,3,'2021-02-15','2021-02-21','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,2,4,'2021-02-22','2021-02-28','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,1,'2021-03-01','2021-03-07','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,2,'2021-03-08','2021-03-14','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,3,'2021-03-15','2021-03-21','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,4,'2021-03-22','2021-03-28','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,3,5,'2021-03-29','2021-03-31','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,1,'2021-04-01','2021-04-04','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,2,'2021-04-05','2021-04-11','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,3,'2021-04-12','2021-04-18','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,4,'2021-04-19','2021-04-25','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,4,5,'2021-04-26','2021-04-30','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,1,'2021-05-01','2021-05-02','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,2,'2021-05-03','2021-05-09','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,3,'2021-05-10','2021-05-16','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,4,'2021-05-17','2021-05-23','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,5,'2021-05-24','2021-05-30','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,5,6,'2021-05-31','2021-05-31','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,1,'2021-06-01','2021-06-06','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,2,'2021-06-07','2021-06-13','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,3,'2021-06-14','2021-06-20','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,4,'2021-06-21','2021-06-27','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,6,5,'2021-06-28','2021-06-30','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,1,'2021-07-01','2021-07-04','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,2,'2021-07-05','2021-07-11','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,3,'2021-07-12','2021-07-18','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,4,'2021-07-19','2021-07-25','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,7,5,'2021-07-26','2021-08-01','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,1,'2021-08-01','2021-08-01','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,2,'2021-08-02','2021-08-08','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,3,'2021-08-09','2021-08-15','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,4,'2021-08-16','2021-08-22','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,5,'2021-08-23','2021-08-29','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,8,6,'2021-08-30','2021-08-31','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,1,'2021-09-01','2021-09-05','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,2,'2021-09-06','2021-09-12','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,3,'2021-09-13','2021-09-19','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,4,'2021-09-20','2021-09-26','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,9,5,'2021-09-27','2021-09-30','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,1,'2021-10-01','2021-10-03','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,2,'2021-10-04','2021-10-10','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,3,'2021-10-11','2021-10-17','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,4,'2021-10-18','2021-10-24','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,10,5,'2021-10-25','2021-10-31','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,1,'2021-11-01','2021-11-07','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,2,'2021-11-08','2021-11-14','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,3,'2021-11-15','2021-11-21','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,4,'2021-11-22','2021-11-28','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,11,5,'2021-11-29','2021-11-30','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,1,'2021-12-01','2021-12-05','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,2,'2021-12-06','2021-12-12','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,3,'2021-12-13','2021-12-19','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,4,'2021-12-20','2021-12-26','1','2',GETDATE(),'1',GETDATE())
		INSERT INTO JcWeek (JCMID,JCMJC,JCWWK,JCWSDT,JCWEDT,AVAILABILITY,LASTMODBY,LASTMODDATE,AUTHID,AUTHDATE) VALUES (@JCMId,12,5,'2021-12-27','2021-12-31','1','2',GETDATE(),'1',GETDATE())

		UPDATE JcMast SET Availability = 1 Where Availability = 1
		UPDATE Configuration SET Configvalue='2.00' WHERE moduleid='DAYMONTHEND1'
		
END
GO
----OLD RM/SM CODE
--CRCRSTPAR0107
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Salesman' AND name='OldSMCode')
BEGIN
	ALTER TABLE Salesman ADD OldSMCode VARCHAR(100)  
END
GO
UPDATE Salesman SET OldSMCode=SMCode WHERE OldSMCode IS NULL
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='RouteMaster' AND name='OldRMCode')
BEGIN
	ALTER TABLE RouteMaster ADD OldRMCode VARCHAR(100)  
END
GO
UPDATE RouteMaster SET OldRMCode=RMCode WHERE OldRMCode IS NULL
GO
IF NOT EXISTS (SELECT SMCode,COUNT(SMCode) FROM Salesman (NOLOCK) 
GROUP BY SMCode HAVING COUNT(SMCode)>1)
BEGIN
	IF NOT  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[Salesman]') AND name = N'UK_SalesmanDup_SMCode')
	BEGIN
		ALTER TABLE Salesman  ADD CONSTRAINT UK_SalesmanDup_SMCode UNIQUE(SMCode)
	END
END
GO
IF NOT EXISTS (SELECT OldSMCode,COUNT(OldSMCode) FROM Salesman (NOLOCK) 
GROUP BY OldSMCode HAVING COUNT(OldSMCode)>1)
BEGIN
	IF NOT  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[Salesman]') AND name = N'UK_SalesmanDup_OldSMCode')
	BEGIN
		ALTER TABLE Salesman  ADD CONSTRAINT UK_SalesmanDup_OldSMCode UNIQUE(OldSMCode)
	END
END
GO
IF NOT EXISTS (SELECT RMCode,COUNT(RMCode) FROM RouteMaster (NOLOCK) 
GROUP BY RMCode HAVING COUNT(RMCode)>1)
BEGIN
	IF NOT  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[RouteMaster]') AND name = N'UK_RouteMasterDup_RMCode')
	BEGIN
		ALTER TABLE RouteMaster  ADD CONSTRAINT UK_RouteMasterDup_RMCode UNIQUE(RMCode)
	END
END
GO
IF NOT EXISTS (SELECT OldRMCode,COUNT(OldRMCode) FROM RouteMaster (NOLOCK) 
GROUP BY OldRMCode HAVING COUNT(OldRMCode)>1)
BEGIN
	IF NOT  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[RouteMaster]') AND name = N'UK_RouteMasterDup_OldRMCode')
	BEGIN
		ALTER TABLE RouteMaster  ADD CONSTRAINT UK_RouteMasterDup_OldRMCode UNIQUE(OldRMCode)
	END
END
GO
DELETE FROM   ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'All','BLOCKMSTCREATION','BlockMastersCreation','Block Retailer/Salesman/Route Creation',1,0,0,1
GO
DELETE FROM   ManualConfiguration WHERE ModuleId='ETLBLOCKMSTCREATION'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'All','ETLBLOCKMSTCREATION','ETLBlockMastersCreation','ETL Block Retailer/Salesman/Route Creation',1,0,0,1
GO
DELETE FROM   ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION1'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'All','BLOCKMSTCREATION1','Salesman Route Modification','Salesman Route Modification',1,0,0,1
GO
DELETE FROM   ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION2'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'All','BLOCKMSTCREATION2','Route Status Modification','Route Status Modification',1,0,0,1
GO
DELETE FROM CustomCaptions WHERE TransId=78 AND ctrlid=33 and SubCtrlId=0--CtrlName='fxtStatus'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 78,33,0,'fxtStatus','','Press Spacebar/Double Click to select status','Press Spacebar/Double Click to select status',1,1,1,GETDATE(),1,GETDATE(),'','Press Spacebar/Double Click to select status','Press Spacebar/Double Click to select status',1,1
GO
DELETE FROM CustomCaptions WHERE TransId=68 AND CtrlName='Msgbox-68-1000-26'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 68,1000,26,'Msgbox-68-1000-26','','Access Denied','Access Denied',1,1,1,GETDATE(),1,GETDATE(),'','Access Denied','Access Denied',1,1
GO
DELETE FROM CustomCaptions WHERE TransId=78 AND CtrlName='Msgbox-78-1000-15'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 78,1000,15,'Msgbox-78-1000-15','','Access Denied','Access Denied',1,1,1,GETDATE(),1,GETDATE(),'','Access Denied','Access Denied',1,1
GO
DELETE FROM CustomCaptions WHERE TransId=79 AND CtrlName='Msgbox-79-1000-101'
INSERT INTO CustomCaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],
[LastModBy],[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled])
SELECT 79,1000,101,'Msgbox-79-1000-101','','Access Denied','Access Denied',1,1,1,GETDATE(),1,GETDATE(),'','Access Denied','Access Denied',1,1
GO
IF EXISTS (SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND name='Fn_ReturnSRRERMasterControl')
DROP FUNCTION Fn_ReturnSRRERMasterControl
GO
--SELECT DBO.Fn_ReturnSRRERMasterControl(1,2,2)
CREATE FUNCTION [Fn_ReturnSRRERMasterControl](@Type AS TINYINT,@UsrId AS INT,@BtnId AS INT)
RETURNS TINYINT
AS
BEGIN
/*******************************************************************************************
* FUNCTION : Fn_ReturnSRRERMasterControl
* PURPOSE  : Return the Salesman/Route/Retailer Edit /Delete option
* NOTES    : 
* CREATED  : MarySubashini.S
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
*  28/12/2020  MarySubashini.S		CR     CRCRSTPAR0107        Block Salesman/Route/Retailer Add/Edit /Delete option
********************************************************************************************/
	DECLARE @Status AS TINYINT
	SET @Status=1
	 
	IF EXISTS (SELECT 'X'  FROM ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION' AND Status=1)
	BEGIN
		IF @Type<>79
		BEGIN
			IF @BtnId<>1
			BEGIN
				SET @Status=0
			END
		END
	END
	RETURN(@Status)
END
GO
IF EXISTS (SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND name='Fn_ReturnSMRORETOldCodes')
DROP FUNCTION Fn_ReturnSMRORETOldCodes
GO
--SELECT DBO.Fn_ReturnSMRORETOldCodes('2020-03-05',1)
CREATE FUNCTION [Fn_ReturnSMRORETOldCodes](@TransId AS INT,@CodeId AS INT)
RETURNS NVARCHAR(200)
AS
BEGIN
/*******************************************************************************************
* FUNCTION : Fn_ReturnSMRORETOldCodes
* PURPOSE  : Return the Salesman/Route/Retailer Old Code
* NOTES    : 
* CREATED  : MarySubashini.S
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
*  28/12/2020  MarySubashini.S		CR     CRCRSTPAR0107         Block Salesman/Route/Retailer Add/Edit /Delete option
********************************************************************************************/
	DECLARE @OldCode AS NVARCHAR(200)
	SET @OldCode=''

	IF  @TransId=68
	BEGIN
		SELECT @OldCode=ISNULL(OldSMCode,'') FROM Salesman (NOLOCK) WHERE SMId=@CodeId
	END
	IF  @TransId=78
	BEGIN
		SELECT @OldCode=ISNULL(OldRMCode,'') FROM RouteMaster (NOLOCK) WHERE RMId=@CodeId
	END
	----IF  @TransId=79
	----BEGIN
	----	SELECT @OldCode=ISNULL(OldRtrCode,'') FROM Retailer (NOLOCK) WHERE RtrId=@CodeId
	----END
	RETURN(@OldCode)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_ValidateSalesman')
DROP PROCEDURE Proc_ValidateSalesman
GO
CREATE  PROCEDURE Proc_ValidateSalesman
(
@Po_ErrNo int OUTPUT
)
AS
/***************************************************************************************************
* PROCEDURE: Proc_ValidateSalesman
* PURPOSE: To Insert and Update records  from xml file in the Table salesman
* CREATED: Gunasekaran.D. 17/09/2007
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
*  28/12/2020  MarySubashini.S		CR     CRCRSTPAR0107        Block Salesman/Route/Retailer Add/Edit /Delete option
********************************************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @hDoc INTEGER
	DECLARE @InsertCount INTEGER
	DECLARE @Taction Int
	DECLARE @StateId Int
	DECLARE @ErrDesc Varchar(1000)
	DECLARE @rno int
	DECLARE @Tabname Varchar(50)
	DECLARE @CmpId int
	DECLARE @CmpCode Varchar(50)
	DECLARE @SFId int
	DECLARE @SFCode Varchar(50)
	DECLARE @SMId int
	DECLARE @SMCode Varchar(50)
	DECLARE @SMName Varchar(100)
	DECLARE @Phno Varchar(50)
	DECLARE @EId Varchar(50)
	DECLARE @StatusId int
	DECLARE @Status Varchar(50)
	DECLARE @DailyAllow Varchar(30)
	DECLARE @MonSal Varchar(30)
	DECLARE @MktCr Varchar(50)
	DECLARE @CrAmtAlert Varchar(50)
	DECLARE @CrAmtAlertId INT
	DECLARE @CrDays Varchar(20)
	DECLARE @CrDaysAlert Varchar(50)
	DECLARE @CrDaysAlertId INT
	DECLARE @RMId int
	DECLARE @RMCode Varchar(50)
	DECLARE @Type Varchar(50)
	DECLARE @sStr nVarchar(4000)
	SET @Tabname = 'ETL_Prk_Salesman'
	SET @Po_ErrNo = 0
	SET @CrDaysAlertId=0
	SET @CrAmtAlertId=0

	---CRCRSTPAR0107
	IF EXISTS (SELECT * FROM  ManualConfiguration WHERE ModuleId='ETLBLOCKMSTCREATION' AND Status=1)
	BEGIN
		RETURN
	END
	---CRCRSTPAR0107

DECLARE Cur_ImpSalesman CURSOR
FOR SELECT DISTINCT ISNULL(CmpCode,''),ISNULL([Sales Force Level Value Code],''),ISNULL([Salesman Code],''),
ISNULL([Salesman Name],''),ISNULL([Phone No],'0'),ISNULL([Email Id],''),ISNULL(Status,''),
ISNULL([Daily Allowance],'0'),ISNULL([Monthly Salary],'0'),ISNULL([Market Credit],''),ISNULL([Alert On Market Credit],''),
ISNULL([Credit Days],''),ISNULL([Alert On Credit Days],'') FROM ETL_Prk_Salesman
OPEN Cur_ImpSalesman
FETCH NEXT FROM Cur_ImpSalesman INTO
@CmpCode,@SFCode,@SMCode,@SMName,@Phno,@EId,@Status,@DailyAllow,@MonSal,
@MktCr,@CrAmtAlert,@CrDays,@CrDaysAlert
Set @Rno = 0
WHILE @@FETCH_STATUS=0
BEGIN
	     Set @Rno = @Rno + 1
	     Set @Taction = 2 -- Insert
	
	     -- Validate Mandatory field is empty or null string
	     -- Company
	     IF IsNull(@CmpCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Company Code is empty'
	  INSERT INTO Errorlog VALUES (1,@TabName,'CmpCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END	
ELSE IF NOT exists (SELECT * FROM Company WHERE CmpCode = @CmpCode ) and IsNull(@CmpCode,'') <> ''
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Company Code '+ @CmpCode + ' Not found '
	  INSERT INTO Errorlog VALUES (2,@TabName,'CmpCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE IF exists (SELECT * FROM Company WHERE CmpCode = @CmpCode ) and IsNull(@CmpCode,'') <> ''
BEGIN
SELECT @CmpId = CmpId FROM Company WHERE CmpCode = @CmpCode
END
-- Sales Force Value
	     IF IsNull(@SFCode,'') = ''
	     BEGIN
SET @SFId = 0
END	
ELSE IF NOT exists (SELECT * FROM SalesForce WHERE SalesForceCode = @SFCode ) and IsNull(@SFCode,'') <> ''
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Sales Force Code '+ @SFCode + ' Not found '
	  INSERT INTO Errorlog VALUES (3,@TabName,'SFCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE IF exists (SELECT * FROM SalesForce WHERE SalesForceCode = @SFCode ) and IsNull(@SFCode,'') <> ''
BEGIN
SELECT @SFId = SalesForceMainId FROM SalesForce WHERE SalesForceCode = @SFCode
END
	     -- Salesman Code
	     IF IsNull(@SMCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Salesman Code is empty'
	  INSERT INTO Errorlog VALUES (4,@TabName,'SMCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END	
ELSE IF exists (SELECT * FROM Salesman WHERE SMCode = @SMCode ) and IsNull(@SMCode,'') <> ''
BEGIN
SET @Taction = 1 -- update
END
	     -- Salesman Name
	     IF IsNull(@SMName,'') = ''
	     BEGIN
	         SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Salesman Name is empty'
	  INSERT INTO Errorlog VALUES (5,@TabName,'SMName',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END	
-- Phone no
IF IsNull(@PhNo,'') = ''
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Phone Number '+ @PhNo + ' Not found '
	  INSERT INTO Errorlog VALUES (6,@TabName,'Phone Number',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE IF ISNUMERIC(@PhNo) = 0
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Phone number is not a numeric value'
	  INSERT INTO Errorlog VALUES (7,@TabName,'Phno',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
-- Status
	     IF IsNull(@Status,'') = ''
	     BEGIN
	          SET @StatusId = 1
END
ELSE IF Upper(@Status) = 'ACTIVE'
BEGIN
SET @StatusId = 1
END
ELSE IF Upper(@Status) = 'INACTIVE'
BEGIN
SET @StatusId = 0
END
ELSE
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Status value is wrong'
	  INSERT INTO Errorlog VALUES (8,@TabName,'Status',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
-- Daily Allowance
	     IF IsNull(@DailyAllow,'') = ''
	     BEGIN
SET @DailyAllow = 0
END
ELSE IF ISNUMERIC(@DailyAllow) = 0
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Daily allowance is not a numeric value'
	  INSERT INTO Errorlog VALUES (9,@TabName,'Daily allowance',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
-- Monthly Salary
	     IF IsNull(@MonSal,'') = ''
	     BEGIN
SET @MonSal = 0
END
ELSE IF ISNUMERIC(@MonSal) = 0
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Monthly Salary is not a numeric value'
	  INSERT INTO Errorlog VALUES (10,@TabName,'Monthly salary',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
-- Mkt Credit
	     IF IsNull(@MktCr,'') = ''
	     BEGIN
SET @MktCr = 0
END
ELSE IF ISNUMERIC(@MktCr) = 0
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Market Credit is not a numeric value'
	  INSERT INTO Errorlog VALUES (11,@TabName,'MktCr',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
-- Credit Days
	     IF IsNull(@CrDays,'') = ''
	     BEGIN
SET @CrDays = 0
END
ELSE IF ISNUMERIC(@CrDays) = 0
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Credit days is not a numeric value'
	  INSERT INTO Errorlog VALUES (12,@TabName,'Credit Days',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
IF LTRIM(RTRIM(@CrAmtAlert)) = ''
BEGIN
	 SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Market Credit Amount alert is empty'
	 INSERT INTO Errorlog VALUES (13,@TabName,'Credit Days',@ErrDesc)           	
	 SET @Taction = 0
	 SET @Po_ErrNo = 1
END
ELSE
BEGIN
	PRINT @CrAmtAlert
	IF UPPER(LTRIM(RTRIM(@CrAmtAlert)))='ALERT & STOP' OR UPPER(LTRIM(RTRIM(@CrAmtAlert)))='ALERT & ALLOW' OR UPPER(LTRIM(RTRIM(@CrAmtAlert)))='NONE'
	BEGIN
		IF UPPER(LTRIM(RTRIM(@CrAmtAlert)))='ALERT & STOP'
			BEGIN
				SET @CrAmtAlertId=2
			END
		ELSE IF UPPER(LTRIM(RTRIM(@CrAmtAlert)))='ALERT & ALLOW'
			BEGIN
				SET @CrAmtAlertId=1
			END
		ELSE IF UPPER(LTRIM(RTRIM(@CrAmtAlert)))='NONE'
			BEGIN
				SET @CrAmtAlertId=0
			END
	END
	ELSE
	BEGIN
		SET @Po_ErrNo=1		
		SET @Taction=0
		SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Market Credit Amount alert is not available'	
		INSERT INTO Errorlog VALUES (14,@Tabname,'Credit Amount Alert',@ErrDesc)
	END
END
IF LTRIM(RTRIM(@CrDaysAlert)) = ''
BEGIN
	 SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Credit days alert is empty'
	 INSERT INTO Errorlog VALUES (15,@TabName,'Credit Days',@ErrDesc)           	
	 SET @Taction = 0
	 SET @Po_ErrNo = 1
END
ELSE
BEGIN
	IF UPPER(LTRIM(RTRIM(@CrDaysAlert)))='ALERT & STOP' OR UPPER(LTRIM(RTRIM(@CrDaysAlert)))='ALERT & ALLOW' OR UPPER(LTRIM(RTRIM(@CrDaysAlert)))='NONE'
	BEGIN
		IF UPPER(LTRIM(RTRIM(@CrDaysAlert)))='ALERT & STOP'
			BEGIN
				SET @CrDaysAlertId=2
			END
		ELSE IF UPPER(LTRIM(RTRIM(@CrDaysAlert)))='ALERT & ALLOW'
			BEGIN
				SET @CrDaysAlertId=1
			END
		ELSE IF UPPER(LTRIM(RTRIM(@CrDaysAlert)))='NONE'
			BEGIN
				SET @CrDaysAlertId=0
			END
	END
	ELSE
	BEGIN
		SET @Po_ErrNo=1		
		SET @Taction=0
		SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + 'Credit Days alert is not available'	
		INSERT INTO Errorlog VALUES (16,@Tabname,'Credit Days Alert',@ErrDesc)
	END
END
--- Insert / Update to Master Table
	     IF @Taction = 1
	     BEGIN
	          UPDATE Salesman
		      SET Salesman.SMName = @SMName ,
		      Salesman.SMPhoneNumber = @Phno,
		      Salesman.SMEmailID = @EId,
		      Salesman.SMDailyAllowance = @DailyAllow,
		      Salesman.SMMonthlySalary = @MonSal,
		      Salesman.SMMktCredit = @MktCr,
		      Salesman.SMCreditDays = @CrDays ,
		      Salesman.CmpId = @CmpId ,
		      Salesman.SalesForceMainId = @SFId ,
		      Salesman.Status = @StatusId,
		      Salesman.SMCreditAmountAlert = @CrAmtAlertId,
		      Salesman.SMCreditDaysAlert = @CrDaysAlertId
		      WHERE   Salesman.SMCode = @SMCode
		
	          SET @sStr = 'UPDATE Salesman
		      SET Salesman.SMName = ''' + @SMName + ''',
		      Salesman.SMPhoneNumber = ''' + @Phno + ''',
		      Salesman.SMEmailID = ''' + @EId + ''',
		      Salesman.SMDailyAllowance = ' + CAST(@DailyAllow as VArchar(20)) + ',
		      Salesman.SMMonthlySalary = ' + CAST(@MonSal as VArchar(20)) + ',
		      Salesman.SMMktCredit = ' + CAST(@MktCr as VArchar(20)) + ',
		      Salesman.SMCreditDays = ' + CAST(@CrDays as VArchar(20)) + ',
		      Salesman.CmpId = ' + CAST(@CmpId as VArchar(20)) + ',
		      Salesman.SalesForceMainId = ' + CAST(@SFId as VArchar(20)) + ',
		      Salesman.Status = ' + CAST(@StatusId as VArchar(20)) + ',
		      Salesman.SMCreditAmountAlert = ' + CAST(@CrAmtAlertId as VArchar(20)) + ',
		      Salesman.SMCreditDaysAlert = ' + CAST(@CrDaysAlertId as VArchar(20)) + '
		      WHERE   Salesman.SMCode = ''' + @SMCode + ''''
			
			  INSERT INTO Translog(strSql1) Values (@sstr)		
END
	     ELSE IF @Taction = 2 AND @Po_ErrNo=0
	     BEGIN
          	SET @SMId = dbo.Fn_GetPrimaryKeyInteger('Salesman','SMId',CAST(YEAR(GetDate())AS INT),Month(GetDate()))	
		INSERT INTO Salesman (SMId,SMcode,SMName,SMPhoneNumber,SMEmailId,SMOtherDetails,
		SMDailyAllowance,SMMonthlySalary,SMMktCredit,SMCreditDays,CmpId,SalesForceMainId,
		Status,SMCreditAmountAlert,SMCreditDaysAlert,Upload,Availability,LastModBy,LastModDate,AuthId,AuthDate,XmlUpload,OldSMCode) VALUES --CRCRSTPAR0107
		(@SMId,@SMCode,@SMName,@Phno,@EId,'',@DailyAllow,@MonSal,@MktCr,@CrDays,@CmpId,@SFId,
		@StatusId,@CrAmtAlertId,@CrDaysAlertId,'N',1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,@SMCode) --CRCRSTPAR0107
		SET @sStr = 'INSERT INTO Salesman (SMId,SMcode,SMName,SMPhoneNumber,SMEmailId,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,SMCreditDays,CmpId,SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,Upload,Availability,LastModBy,Las
tModDate,AuthId,AuthDate,XmlUpload) VALUES  (' + CAST(@SMId as VArchar(6)) + ',''' + @SMCode + ''',''' + @SMName + ''',''' + @Phno + ''',''' + @EId + ''',''' + '' + ''',' + CAST(@DailyAllow as VArchar(20)) + ',' + CAST(@MonSal as VArchar(20)) + ',' + CAST
(@MktCr as VArchar(20)) + ',' + CAST(@CrDays as VArchar(20)) + ',' + CAST(@CmpId as Varchar(6))  + ',' +
		CAST(@SFId as Varchar(6)) + ',' + CAST(@StatusId as Varchar(6)) + ',' + CAST(@CrAmtAlertId as Varchar(6)) + ',' + CAST(@CrDaysAlertId as Varchar(6)) + ',''N'',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) 
+ ''',0)'
		
		INSERT INTO Translog(strSql1) Values (@sstr)		
		UPDATE Counters SET currvalue = @SMId WHERE Tabname = 'Salesman' and fldname = 'SMId'
		SET @sStr= 'UPDATE Counters SET currvalue = ' + CAST(@SMId as Varchar(6)) + ' WHERE Tabname = ' + '''Salesman''' + ' and fldname = ' + '''SMId'''
		
		INSERT INTO Translog(strSql1) Values (@sstr)		
	    END
FETCH NEXT FROM Cur_ImpSalesman INTO
@CmpCode,@SFCode,@SMCode,@SMName,@Phno,@EId,@Status,@DailyAllow,@MonSal,
@MktCr,@CrAmtAlert,@CrDays,@CrDaysAlert
END
CLOSE Cur_ImpSalesman
DEALLOCATE Cur_ImpSalesman
-------------- Salesman Market
DECLARE Cur_ImpSalesmanMarket CURSOR
FOR SELECT [Salesman Code],[Route Code],[Type] FROM ETL_Prk_Salesman
OPEN Cur_ImpSalesmanMarket
FETCH NEXT FROM Cur_ImpSalesmanMarket INTO @SMCode,@RMCode,@Type
Set @Rno = 0
WHILE @@FETCH_STATUS=0
BEGIN
	     Set @Rno = @Rno + 1
	     Set @Taction = 2 -- Insert
	
	     -- Validate Mandatory field is empty or null string
	     -- Salesman Code
	     IF IsNull(@SMCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Salesman Code is empty'
	  INSERT INTO Errorlog VALUES (3,@TabName,'SMCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END	
ELSE IF Not exists (SELECT SMId FROM Salesman WHERE SMCode = @SMCode ) and IsNull(@SMCode,'') <> ''
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Salesman Code ' + @SMCode + ' not found in Master table'
	  INSERT INTO Errorlog VALUES (3,@TabName,'SMCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE
BEGIN
SELECT @SMId = SMId FROM Salesman WHERE SMCode = @SMCode
END
	     -- RM Code
	     IF IsNull(@RMCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route Code is empty'
	  INSERT INTO Errorlog VALUES (3,@TabName,'RMCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END	
ELSE IF Not exists (SELECT RMId FROM RouteMaster WHERE RMCode = @RMCode ) and IsNull(@RMCode,'') <> ''
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route Code ' + @RMCode + ' not found in Master table'
	  INSERT INTO Errorlog VALUES (3,@TabName,'RMCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE
BEGIN
SELECT @RMId = RMId FROM RouteMaster WHERE RMCode = @RMCode
END
-- Type
IF IsNull(@Type,'') = ''
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Type should not be empty'
	  INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1         	
END
		 ELSE IF @Type <> 'Add' and @Type <> 'Reduce'
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Type should be wither Add or Reduce'
	  INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1		 	
		 END
-- Set mode
IF EXISTS (SELECT * FROM SalesmanMarket WHERE SMID = @SMId and RMID = @RMId)  and @Type = 'Add'
BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Record already exists in map table'
	  INSERT INTO Errorlog VALUES (3,@TabName,'SMId and RMId',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
END
ELSE IF NOT EXISTS (SELECT * FROM SalesmanMarket WHERE SMID = @SMId and RMID = @RMId) and @Taction <> 0 and @Type = 'Add'
BEGIN
SET @Taction = 2
END
		 ELSE IF @Type = 'Reduce'
		 BEGIN
		 	  DELETE FROM SalesmanMarket WHERE SMID = @SMId and RMID = @RMId
		 	  SET @sStr = 'DELETE FROM SalesmanMarket WHERE SMID = ' + CAST(@SMId as Varchar(6)) + ' and RMID = ' + CAST(@RMId as Varchar(6))
			
			  INSERT INTO Translog(strSql1) Values (@sstr)		 	
		      SET @Taction = 0
		 END
--- Insert / Update to Master Table
	     IF @Taction = 2
	     BEGIN
INSERT INTO SalesmanMarket (SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES
(@SMId,@RMId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
SET @sStr = 'INSERT INTO SalesmanMarket (SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES
(' + CAST(@SMId as Varchar(6)) + ',' + CAST(@RMId as Varchar(6)) + ',1,1,''' + convert(varchar(10),getdate(),121)  + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
			
			  INSERT INTO Translog(strSql1) Values (@sstr)		 	
END
FETCH NEXT FROM Cur_ImpSalesmanMarket INTO @SMCode,@RMCode,@Type
END
CLOSE Cur_ImpSalesmanMarket
DEALLOCATE Cur_ImpSalesmanMarket
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_ValidateRouteMaster')
DROP PROCEDURE Proc_ValidateRouteMaster
GO
-- exec Proc_ValidateRouteMaster 0
CREATE PROCEDURE Proc_ValidateRouteMaster
(
       @Po_ErrNo int OUTPUT
)
AS
/*************************************************************************************************
* PROCEDURE: Proc_ValidateRouteMaster
* PURPOSE: To Insert and Update records  from xml file in the Table Route Master
* CREATED: Gunasekaran.D. 17/09/2007
**************************************************************************************************
*25-06-2019		S.MOHANA			CR	   CRCRSTPAR0064		INCLUDE THE VALIDATION FOR ONE MANDATORY CAL DAYS
*28-12-2020		MarySubashini.S		CR     CRCRSTPAR0107        Block Salesman/Route/Retailer Add/Edit /Delete option
**************************************************************************************************/
BEGIN
	DECLARE @hDoc INTEGER
	DECLARE @InsertCount INTEGER
	DECLARE @Taction Int
	DECLARE @StateId Int
	DECLARE @ErrDesc Varchar(1000)
	DECLARE @rno int
	DECLARE @Tabname Varchar(50)
	DECLARE @RMId int
    DECLARE @RMCode Varchar(50)
    DECLARE @RMName Varchar(100)
    DECLARE @CmpCode Varchar(50)
    DECLARE @CmpId Int
    DECLARE @Dis Varchar(20)
    DECLARE @Pop Varchar(20)
    DECLARE @GeoMainId int
    DECLARE @HierVal Varchar(100)
    DECLARE @VanRoute Varchar(5)
    DECLARE @RMTypeId int
    DECLARE @RMType Varchar(50)
    DECLARE @LclUpId int
    DECLARE @LclUp Varchar(50)
    DECLARE @RMMon Varchar(5)
    DECLARE @RMTue Varchar(5)
    DECLARE @RMWed Varchar(5)
    DECLARE @RMThu Varchar(5)
    DECLARE @RMFri Varchar(5)
    DECLARE @RMSat Varchar(5)
    DECLARE @RMSun Varchar(5)
	DECLARE @sStr nVarchar(4000)
    Set @Tabname = 'ETL_Prk_RouteMaster'
    SET @Po_ErrNo = 0

	---CRCRSTPAR0107
	IF EXISTS (SELECT * FROM  ManualConfiguration WHERE ModuleId='ETLBLOCKMSTCREATION' AND Status=1)
	BEGIN
		RETURN
	END
	---CRCRSTPAR0107


    DECLARE Cur_ImpRoute CURSOR
            FOR SELECT * FROM ETL_Prk_RouteMaster
    OPEN Cur_ImpRoute
    FETCH NEXT FROM Cur_ImpRoute INTO
          @RMCode,@RMName,@CmpCode,@Dis,@Pop,@HierVal,@VanRoute,@RMType,@LclUp,
          @RMMon,@RMTue,@RMWed,@RMThu,@RMFri,@RMSat,@RMSun
    Set @Rno = 0
    WHILE @@FETCH_STATUS=0
    BEGIN
	     Set @Rno = @Rno + 1
	     Set @Taction = 2 -- Insert
	
	     -- Validate Mandatory field is empty or null string
		 IF IsNull(@RMCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route Master Code is empty'
         	  INSERT INTO Errorlog VALUES (1,@TabName,'RMCode',@ErrDesc)           	
		 	  SET @Taction = 0
		 	  SET @Po_ErrNo = 1
         END	
         ELSE IF exists (SELECT *  FROM RouteMaster WHERE RMCode = @RMCode) and IsNull(@RMCode,'') <> ''
         BEGIN
         	SET @Taction = 1
         	--SELECT '5'
         END
         -- Route Master Name
	     IF IsNull(@RMName,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route Master Name is empty'
        	  INSERT INTO Errorlog VALUES (2,@TabName,'RMName',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END	
	     -- Company
	     IF IsNull(@CmpCode,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Company Code is empty'
        	  INSERT INTO Errorlog VALUES (3,@TabName,'CmpCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END	
         ELSE IF NOT exists (SELECT * FROM Company WHERE CmpCode = @CmpCode ) and IsNull(@CmpCode,'') <> ''
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Company Code '+ @CmpCode + ' Not found '
        	  INSERT INTO Errorlog VALUES (4,@TabName,'CmpCode',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         ELSE IF exists (SELECT * FROM Company WHERE CmpCode = @CmpCode ) and IsNull(@CmpCode,'') <> ''
         BEGIN
              SELECT @CmpId = CmpId FROM Company WHERE CmpCode = @CmpCode
         END
         -- Distance
	     IF IsNull(@Dis,'') = ''
	     BEGIN
	          SET @Dis = 0
         END
         ELSE IF ISNUMERIC(@Dis) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Distance is not a numeric value'
        	  INSERT INTO Errorlog VALUES (4,@TabName,'Distance',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Population
	     IF IsNull(@Pop,'') = ''
	     BEGIN
	          SET @Pop = 0
         END
         ELSE IF ISNUMERIC(@Pop) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Population is not a numeric value'
        	  INSERT INTO Errorlog VALUES (5,@TabName,'Population',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Geo Value
	     IF IsNull(@HierVal,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Geography value is empty'
        	  INSERT INTO Errorlog VALUES (6,@TabName,'GeoName',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END	
         ELSE IF NOT exists (SELECT * FROM Geography WHERE GeoName = @HierVal ) and IsNull(@HierVal,'') <> ''
		 BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Geography Name '+ @HierVal + ' Not found '
        	  INSERT INTO Errorlog VALUES (7,@TabName,'GeoName',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         ELSE IF exists (SELECT * FROM Geography WHERE GeoName = @HierVal ) and IsNull(@HierVal,'') <> ''
         BEGIN
              SELECT @GeoMainId = GeoMainId FROM Geography WHERE GeoName = @HierVal
         END
         -- Van route
	     IF IsNull(@VanRoute,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Van Route is empty'
        	  INSERT INTO Errorlog VALUES (8,@TabName,'VanRoute',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         ELSE IF ISNUMERIC(@VanRoute) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Van route is not a numeric value'
        	  INSERT INTO Errorlog VALUES (9,@TabName,'Van route',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Route Type
	     IF IsNull(@RMType,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route Type is empty'
        	  INSERT INTO Errorlog VALUES (10,@TabName,'Route Type',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         ELSE IF Upper(@RMType) = 'SALES ROUTE'
         BEGIN
              SET @RMTypeId = 1
         END
         ELSE IF Upper(@RMType) = 'DELIVERY ROUTE'
         BEGIN
              SET @RMTypeId = 2
         END
         ELSE IF Upper(@RMType) = 'MERCHANDISING ROUTE'
         BEGIN
              SET @RMTypeId = 3
         END
         ELSE
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Route is wrong'
        	  INSERT INTO Errorlog VALUES (12,@TabName,'Route',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Local / Upcountry
	     IF IsNull(@LclUp,'') = ''
	     BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Local/upcoutry is empty'
        	  INSERT INTO Errorlog VALUES (11,@TabName,'Local/Upcountry',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         ELSE IF Upper(@LclUp) = 'LOCAL'
         BEGIN
              SET @LclUpId = 1
         END
         ELSE IF Upper(@RMType) = 'UPCOUNTRY'
         BEGIN
              SET @LclUpId = 2
         END
         ELSE
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Local Upcountry is wrong'
        	  INSERT INTO Errorlog VALUES (12,@TabName,'Local/Upcoutnry',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Monday
	     IF IsNull(@RMMon,'') = ''
	     BEGIN
	          SET @RMMon = 0
         END
         ELSE IF ISNUMERIC(@RMMon) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Mon is not a numeric value'
        	  INSERT INTO Errorlog VALUES (12,@TabName,'RMMon',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Tuesday
	     IF IsNull(@RMTue,'') = ''
	     BEGIN
	          SET @RMTue = 0
         END
         ELSE IF ISNUMERIC(@RMTue) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Tue is not a numeric value'
        	  INSERT INTO Errorlog VALUES (13,@TabName,'RMTue',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Wednesday
	     IF IsNull(@RMWed,'') = ''
	     BEGIN
	          SET @RMWed = 0
         END
         ELSE IF ISNUMERIC(@RMWed) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Wed is not a numeric value'
        	  INSERT INTO Errorlog VALUES (14,@TabName,'RMWed',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Thursday
	     IF IsNull(@RMThu,'') = ''
	     BEGIN
	          SET @RMThu = 0
         END
         ELSE IF ISNUMERIC(@RMThu) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Thu is not a numeric value'
        	  INSERT INTO Errorlog VALUES (15,@TabName,'RMThu',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Friday
	     IF IsNull(@RMFri,'') = ''
	     BEGIN
	          SET @RMFri = 0
         END
         ELSE IF ISNUMERIC(@RMFri) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Fri is not a numeric value'
        	  INSERT INTO Errorlog VALUES (61,@TabName,'RMFri',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Saturday
	     IF IsNull(@RMSat,'') = ''
	     BEGIN
	          SET @RMSat = 0
         END
         ELSE IF ISNUMERIC(@RMSat) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Sat is not a numeric value'
        	  INSERT INTO Errorlog VALUES (17,@TabName,'RMSat',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
         -- Sunday
	     IF IsNull(@RMSun,'') = ''
	     BEGIN
	          SET @RMSun = 0
         END
         ELSE IF ISNUMERIC(@RMSun) = 0
         BEGIN
	          SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' Call Days - Sun is not a numeric value'
        	  INSERT INTO Errorlog VALUES (18,@TabName,'RMSun',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
         END
		--	CRCRSTPAR0064
		IF (@RMSun = 0 AND @RMMon  = 0 AND @RMTue  = 0 AND @RMWed = 0 AND @RMThu = 0 AND @RMFri = 0 AND @RMSat = 0 )
		BEGIN 
			  SET @ErrDesc = 'In Row ' + cast (@Rno as varchar(10)) + ' ATLEAST ONE CALL DAY NEEDS TO DEFINE'
        	  INSERT INTO Errorlog VALUES (18,@TabName,'CAL DAYS',@ErrDesc)           	
			  SET @Taction = 0
			  SET @Po_ErrNo = 1
		END
		--CRCRSTPAR0064
		 IF @Taction = 1
	     BEGIN
               -- Dependancy check Company
	           EXEC Proc_DependencyCheck 'RouteMaster',@CmpId
		       IF (SELECT COUNT(*) FROM TempDepCheck) > 0
	           BEGIN
		            SET @ErrDesc = 'Transaction Exists ' + CAST(@CmpId AS VARCHAR(6))
		 	        INSERT INTO Errorlog VALUES (19,@TabName,'CmpId',@ErrDesc)
		 	        SET @Taction = 0
		 	        SET @Po_ErrNo = 1
               END
               -- Dependancy check Geography value
	           EXEC Proc_DependencyCheck 'RouteMaster',@GeoMainId
		       IF (SELECT COUNT(*) FROM TempDepCheck) > 0
	           BEGIN
		            SET @ErrDesc = 'Transaction Exists ' + CAST(@GeoMainId AS VARCHAR(6))
		 	        INSERT INTO Errorlog VALUES (20,@TabName,'GeoMainId',@ErrDesc)
		 	        SET @Taction = 0
		 	        SET @Po_ErrNo = 1
               END
		 END
         --- Insert / Update to Master Table
	     IF @Taction = 1
	     BEGIN
	          UPDATE RouteMaster
		      SET RouteMaster.RMName = @RMName ,
		      RouteMaster.CmpId = @CmpId ,
		      RouteMaster.RMDistance = @Dis ,
		      RouteMaster.RMPopulation = @Pop ,
		      RouteMaster.GeoMainId = @GeoMainId ,
		      RouteMaster.RMVanRoute = @VanRoute ,
		      RouteMaster.RMSRouteType = @RMTypeId ,
		      RouteMaster.RMLocalUpcountry = @LclUpId ,
		      RouteMaster.RMMon = @RMMon ,
		      RouteMaster.RMTue = @RMTue ,
		      RouteMaster.RMWed = @RMWed ,
		      RouteMaster.RMThu = @RMThu ,
		      RouteMaster.RMFri = @RMFri ,
		      RouteMaster.RMSat = @RMSat ,
		      RouteMaster.RMSun = @RMSun
		      WHERE   RouteMaster.RMCode = @RMCode
		      
	          SET @sStr = 'UPDATE RouteMaster
		      SET RouteMaster.RMName = ''' + @RMName + ''',
		      RouteMaster.CmpId = ' + CAST(@CmpId as Varchar(6)) + ',
		      RouteMaster.RMDistance = ' + CAST(@Dis as Varchar(10)) + ',
		      RouteMaster.RMPopulation = ' + CAST(@Pop as Varchar(10)) + ',
		      RouteMaster.GeoMainId = ' + CAST(@GeoMainId as Varchar(6)) + ',
		      RouteMaster.RMVanRoute = ''' + @VanRoute + ''',
		      RouteMaster.RMSRouteType = ' + CAST(@RMTypeId as Varchar(10)) + ',
		      RouteMaster.RMLocalUpcountry = ' + CAST(@LclUpId as Varchar(6)) + ',
		      RouteMaster.RMMon = ' + @RMMon + ',
		      RouteMaster.RMTue = ' + @RMTue   + ',
		      RouteMaster.RMWed = ' + @RMWed + ',
		      RouteMaster.RMThu = ' + @RMThu + ',
		      RouteMaster.RMFri = ' + @RMFri + ',
		      RouteMaster.RMSat = ' + @RMSat + ',
		      RouteMaster.RMSun = ' + @RMSun + '
		      WHERE   RouteMaster.RMCode = ''' + @RMCode + ''''
			  
			  INSERT INTO Translog(strSql1) Values (@sstr)
		
		
         END
	     ELSE IF @Taction = 2
	     BEGIN
	          SET @RMId = dbo.Fn_GetPrimaryKeyInteger('RouteMaster','RMId',CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
              INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GEOMainId,RMVanRoute,RMSRouteType,RMLocalUpCountry,RMMon,RMTue,RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,Upload,Availability,LastModBy,LastModDate,AuthId,AuthDate,OldRMCode) VALUES --CRCRSTPAR0107

              (@RMId,@RMCode,@RMName,@CmpId,@Dis,@Pop,@GeoMainId,@VanRoute,@RMTypeId,
                @LclUpId,@RMMon,@RMTue,@RMWed,@RMThu,@RMFri,@RMSat,@RMSun,1,'N',1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),@RMCode)--CRCRSTPAR0107
              SET @sStr = 'INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GEOMainId,RMVanRoute,RMSRouteType,RMLocalUpCountry,RMMon,RMTue,RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,Upload,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES
              (' + CAST(@RMId as Varchar(6)) + ',''' + @RMCode + ''',''' + @RMName + ''',' + CAST(@CmpId as Varchar(6)) + ',' + CAST(@Dis as Varchar(10)) + ',' + CAST(@Pop as Varchar(10)) + ',' + CAST(@GeoMainId as Varchar(6)) + ',' + CAST(@VanRoute as Varchar(6)) + ',' + CAST(@RMTypeId as Varchar(6)) + ',' +
                CAST(@LclUpId as Varchar(6)) + ',' + @RMMon + ',' + @RMTue + ',' + @RMWed + ',' + @RMThu + ',' + @RMFri + ',' + @RMSat + ',' + @RMSun + ',1,''N'',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
			  
			  INSERT INTO Translog(strSql1) Values (@sstr)
              UPDATE Counters SET currvalue = @RMId WHERE Tabname = 'RouteMaster' and fldname = 'RMId'
              SET @sStr = 'UPDATE Counters SET currvalue = ' + CAST(@RMId as VArchar(6)) + ' WHERE Tabname = ' + '''RouteMaster''' + ' and fldname = ' + '''RMId'''
			  
			  INSERT INTO Translog(strSql1) Values (@sstr)
         END
         FETCH NEXT FROM Cur_ImpRoute INTO
                @RMCode,@RMName,@CmpCode,@Dis,@Pop,@HierVal,@VanRoute,@RMType,@LclUp,
                @RMMon,@RMTue,@RMWed,@RMThu,@RMFri,@RMSat,@RMSun
      END
      CLOSE Cur_ImpRoute
      DEALLOCATE Cur_ImpRoute
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_ValidateRetailerMaster')
DROP PROCEDURE Proc_ValidateRetailerMaster
GO
CREATE PROCEDURE Proc_ValidateRetailerMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/***************************************************************************************************************************
* PROCEDURE		: Proc_ValidateRetailerMaster
* PURPOSE		: To Insert and Update records  from xml file in the Table Retailer
* CREATED		: MarySubashini.S
* CREATED DATE	: 13/09/2007
* MODIFIED
  * DATE         AUTHOR				CR/BZ	   USER STORY ID	DESCRIPTION                         
********************************************************************************************************************
  2013/10/10   Sathishkumar V		CR								Junk Characters Removed  
  10/05/2018   S.Moorthi			CR         CRCRSTPAR0001		Retailer Approval process - Manual
  24-06-2019   S.Mohana				CR		   CRCRSTPAR0064		Include validation procedure 
  26/06/2019   S.Moorthi			CR		  CRCRSTPAR0071			Salesman and Route master access level changes in user login
  19/07/2020   Murugan				CR		  PARCS202100043		RetailerCode Auto Generate
  20/08/2020   Deepak Philip        BZ		  PARLECS/0820/189      Validation added for Dummy Retailer code
  28/12/2020   MarySubashini.S		CR        CRCRSTPAR0107         Block Salesman/Route/Retailer Add/Edit /Delete option
**************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @RetailerCode AS NVARCHAR(100)
	DECLARE @RetailerName AS NVARCHAR(100)
	DECLARE	@Address1 AS NVARCHAR(100)
	DECLARE	@Address2 AS NVARCHAR(100)
	DECLARE	@Address3 AS NVARCHAR(100)
	DECLARE	@PinCode AS NVARCHAR(100)
	DECLARE	@PhoneNo AS NVARCHAR(100)
	DECLARE	@EmailId AS NVARCHAR(100)
	DECLARE	@KeyAccount AS NVARCHAR(100)
	DECLARE	@CoverageMode AS NVARCHAR(100)
	DECLARE	@RegistrationDate AS DATETIME
	DECLARE	@DayOff	AS NVARCHAR(100)
	DECLARE	@Status	AS NVARCHAR(100)
	DECLARE	@Taxable AS NVARCHAR(100)
	DECLARE	@TaxType AS NVARCHAR(100)
	DECLARE	@TINNumber AS NVARCHAR(100)
	DECLARE @CSTNumber AS NVARCHAR(100)
	DECLARE	@TaxGroup AS NVARCHAR(100)
	DECLARE	@CreditBills AS NVARCHAR(100)
	DECLARE	@CreditLimit AS NVARCHAR(100)
	DECLARE	@CreditDays AS NVARCHAR(100)
	DECLARE	@CashDiscountPercentage AS NVARCHAR(100)
	DECLARE	@CashDiscountCondition AS NVARCHAR(100)
	DECLARE	@CashDiscountLimitValue AS NVARCHAR(100)
	DECLARE	@LicenseNumber AS NVARCHAR(100)
	DECLARE	@LicNumberExDate AS NVARCHAR(10)
	DECLARE	@DrugLicNumber AS NVARCHAR(100)
	DECLARE	@DrugLicExDate AS NVARCHAR(10)
	DECLARE	@PestLicNumber	AS NVARCHAR(100)
	DECLARE	@PestLicExDate AS NVARCHAR(10)
	DECLARE	@GeographyHierarchyValue AS NVARCHAR(100)
	DECLARE	@DeliveryRoute	AS NVARCHAR(100)
	DECLARE	@ResidencePhoneNo AS NVARCHAR(100)
	DECLARE	@OfficePhoneNo 	AS NVARCHAR(100)
	DECLARE	@DepositAmount 	AS NVARCHAR(100)
	DECLARE	@VillageCode 	AS NVARCHAR(100)
	DECLARE	@PotentialClassCode AS NVARCHAR(100)
	DECLARE	@RetailerType AS NVARCHAR(100)
	DECLARE	@RetailerFrequency AS NVARCHAR(100)
	DECLARE	@RtrCrDaysAlert AS NVARCHAR(100)
	DECLARE	@RtrCrBillAlert AS NVARCHAR(100)
	DECLARE	@RtrCrLimitAlert AS NVARCHAR(100)
	DECLARE @GeoMainId AS INT
	DECLARE @RMId AS INT
	DECLARE @VillageId AS INT
	DECLARE @RtrId AS INT
	DECLARE @TaxGroupId AS INT
	DECLARE @RtrClassId AS INT
	DECLARE @Taction AS INT
	DECLARE @Tabname AS NVARCHAR(100)
	DECLARE @CntTabname AS NVARCHAR(100)
	DECLARE @Fldname AS NVARCHAR(100)
	DECLARE @ErrDesc AS NVARCHAR(1000)
	DECLARE @sSql AS NVARCHAR(4000)
	DECLARE @CoaId AS INT
	DECLARE @AcCode AS NVARCHAR(1000)
	DECLARE @CmpRtrCode AS NVARCHAR(200)	
	
	--RtrCode Auto Generate--PARCS202100043
	DECLARE @AutoRtrCode AS NVARCHAR(200)
	DECLARE @RtrCodeUserInput AS NVARCHAR(200)
	DECLARE @AutoRtrCodeConfig AS TINYINT
	SET @AutoRtrCodeConfig=0
	IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
	BEGIN
		SET @AutoRtrCodeConfig=1
	END
	--Till Here--PARCS202100043

	---CRCRSTPAR0107
	IF EXISTS (SELECT * FROM  ManualConfiguration WHERE ModuleId='ETLBLOCKMSTCREATION' AND Status=1)
	BEGIN
		RETURN
	END
	---CRCRSTPAR0107
	
	EXEC Proc_Validate_ETLRetailerDetails --added by Mohana 
	SET @CntTabname='Retailer'
	SET @Fldname='RtrId'
	SET @Tabname = 'ETL_Prk_Retailer'
	SET @Taction=0
	SET @Po_ErrNo=0
	SET @VillageId=0
	DECLARE Cur_Retailer CURSOR
	FOR SELECT dbo.Fn_Removejunk(ISNULL([Retailer Code],'')),dbo.Fn_Removejunk(ISNULL([Retailer Name],'')),dbo.Fn_Removejunk(ISNULL([Address1],'')),
		dbo.Fn_Removejunk(ISNULL([Address2],'')),dbo.Fn_Removejunk(ISNULL([Address3],'')),
		ISNULL([Pin Code],'0'),ISNULL([Phone No],'0'),dbo.Fn_Removejunk(ISNULL(EmailId,'')),ISNULL([Key Account],''),
		ISNULL([Coverage Mode],''),CAST([Registration Date] AS DATETIME) AS [Registration Date],ISNULL([Day Off],''),
		ISNULL([Status],''),ISNULL([Taxable],''),ISNULL([Tax Type],''),ISNULL([TIN Number],''),
		ISNULL([CST Number],''),ISNULL([Tax Group],''),ISNULL([Credit Bills],'0'),ISNULL([Credit Limit],'0'),
		ISNULL([Credit Days],'0'),ISNULL([Cash Discount Percentage],'0'),ISNULL([Cash Discount Condition],''),
		ISNULL([Cash Discount Limit Value],'0'),ISNULL([License Number],''),
		ISNULL([License Number Expiry Date],NULL),
		ISNULL([Drug License Number],''),ISNULL([Drug License Number Expiry Date],NULL),
		ISNULL([Pesticide License Number],''),ISNULL([Pesticide License Number Expiry Date],NULL),
		ISNULL([Geography Hierarchy Value],''),ISNULL([Delivery Route Code],''),ISNULL([Village Code],''),
		ISNULL([Residence Phone No],''),ISNULL([Office Phone No],''),ISNULL([Deposit Amount],'0'),
		ISNULL([Potential Class Code],''),
		ISNULL([Retailer Type],'') ,
		ISNULL([Retailer Frequency],''),ISNULL([Credit Days Alert],'') ,
		ISNULL([Credit Bills Alert],'') ,ISNULL([Credit Limit Alert],'')
	FROM ETL_Prk_Retailer WITH(NOLOCK) ORDER BY [Retailer Code]
	OPEN Cur_Retailer
	FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
	@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
	@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
	@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
	@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
	@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	WHILE @@FETCH_STATUS=0		
	BEGIN
		
		SET @RtrId=0
		
		---Start--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RetailerCode
		
	IF @RetailerCode <>'DUMMY'--PARLECS/0820/189
	BEGIN	
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
			
		
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RetailerCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END
				RETURN
			END
	 END		
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RetailerCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		IF NOT EXISTS  (SELECT * FROM Geography WHERE GeoCode = @GeographyHierarchyValue )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Geogrpahy Code: ' + @GeographyHierarchyValue + ' is not available'  		
			INSERT INTO Errorlog VALUES (1,@Tabname,'GeographyHierarchyValue',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoCode = @GeographyHierarchyValue
		END
		IF NOT EXISTS  (SELECT * FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'  		
			INSERT INTO Errorlog VALUES (2,@Tabname,'DeliveryRoute',@ErrDesc)
		END
		ELSE
		BEGIN		
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute
		END
		IF LTRIM(RTRIM(@PotentialClassCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode )
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Potential Class Code ' + @PotentialClassCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (3,@Tabname,'PotentialClassCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @RtrClassId =RtrClassId FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode
			END
		END
		SELECT @TaxGroupId = 0
		IF LTRIM(RTRIM(@TaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @TaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (4,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup
			END
		END
		IF LTRIM(RTRIM(@VillageCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RouteVillage WHERE VillageCode = @VillageCode)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Village Code ' + @VillageCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (5,@Tabname,'VillageCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @VillageId =VillageId FROM RouteVillage WHERE VillageCode = @VillageCode
			END
		END
		IF (LTRIM(RTRIM(@RetailerCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'')
		BEGIN
			IF EXISTS  (SELECT * FROM Retailer WHERE 
			(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput
				))
			BEGIN
				SET @Taction=2
				SELECT @RtrId=RtrId from Retailer WHERE 
				(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			END
			ELSE
			BEGIN
				SET @Taction=1
			END
		END
		ELSE
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Code should not be empty '  		
			INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
		END
		
			
		IF LTRIM(RTRIM(@RetailerName))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Name should not be empty'		
			INSERT INTO Errorlog VALUES (7,@Tabname,'RetailerName',@ErrDesc)
		END	
		IF LTRIM(RTRIM(@Address1))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Address  should not be empty'		
			INSERT INTO Errorlog VALUES (8,@Tabname,'Address',@ErrDesc)
		END
		IF LEN(@PinCode)<>0
		BEGIN
			IF ISNUMERIC(@PinCode)=0
			BEGIN
				SET @Po_ErrNo=1	
				SET @Taction=0
				SET @ErrDesc = 'PinCode is not in correct format'		
				INSERT INTO Errorlog VALUES (9,@Tabname,'PinCode',@ErrDesc)
			END	
		END					
				
		IF LTRIM(RTRIM(@KeyAccount))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'KeyAccount should not be empty'		
			INSERT INTO Errorlog VALUES (10,@Tabname,'KeyAccount',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@KeyAccount))='Yes' OR LTRIM(RTRIM(@KeyAccount))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Key Account Type '+@KeyAccount+ ' is not available'		
				INSERT INTO Errorlog VALUES (11,@Tabname,'KeyAccount',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CoverageMode))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Coverage Mode should not be empty'		
			INSERT INTO Errorlog VALUES (12,@Tabname,'CoverageMode',@ErrDesc)
		END
		ELSE
			BEGIN
			IF LTRIM(RTRIM(@CoverageMode))='Order Booking' OR LTRIM(RTRIM(@CoverageMode))='Van Sales' OR LTRIM(RTRIM(@CoverageMode))='Counter Sales'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Coverage Mode Type '+@CoverageMode+ ' does not exists'		
				INSERT INTO Errorlog VALUES (13,@Tabname,'CoverageMode',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RegistrationDate))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Registration Date should not be empty'		
			INSERT INTO Errorlog VALUES (14,@Tabname,'RegistrationDate',@ErrDesc)
		END
		ELSE
		BEGIN
			IF ISDATE(@RegistrationDate)=0
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Registration Date '+@RegistrationDate+ ' not in date format'		
				INSERT INTO Errorlog VALUES (15,@Tabname,'RegistrationDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF @RegistrationDate > (CONVERT(NVARCHAR(11),GETDATE(),121))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Invalid Registration Date'		
					INSERT INTO Errorlog VALUES (16,@Tabname,'RegistrationDate',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@DayOff))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Day Off should not be empty'		
			INSERT INTO Errorlog VALUES (17,@Tabname,'DayOff',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@DayOff))='Sunday' OR LTRIM(RTRIM(@DayOff))='Monday' OR LTRIM(RTRIM(@DayOff))='Tuesday' OR
			LTRIM(RTRIM(@DayOff))='Wednesday' OR LTRIM(RTRIM(@DayOff))='Thursday' OR LTRIM(RTRIM(@DayOff))='Friday' OR
			LTRIM(RTRIM(@DayOff))='Saturday'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Day Off Type '+@DayOff+ ' is not available'		
				INSERT INTO Errorlog VALUES (18,@Tabname,'DayOff',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Status))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Status should not be empty'		
			INSERT INTO Errorlog VALUES (19,@Tabname,'Status',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Status))='Active' OR LTRIM(RTRIM(@Status))='Inactive'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Status Type '+@Status+ ' is not available'		
				INSERT INTO Errorlog VALUES (20,@Tabname,'Status',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Taxable))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Taxable should not be empty'		
			INSERT INTO Errorlog VALUES (21,@Tabname,'Taxable',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Taxable))='Yes' OR LTRIM(RTRIM(@Taxable))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Taxable Type '+@Taxable+ ' is not available'		
				INSERT INTO Errorlog VALUES (22,@Tabname,'Taxable',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (23,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (24,@Tabname,'TaxType',@ErrDesc)
			END
		END
		IF @TaxType='VAT'
		BEGIN
			IF LTRIM(RTRIM(@TINNumber))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'TIN Number should not be empty'		
				INSERT INTO Errorlog VALUES (25,@Tabname,'TINNumber',@ErrDesc)
			END
			ELSE
			BEGIN
				IF LEN(@TINNumber)>11
				BEGIN
					SET @Po_ErrNo=1
					SET @Taction=0
					SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
					INSERT INTO Errorlog VALUES (26,@Tabname,'TINNumber',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@CreditBills))<>''
		BEGIN
			IF ISNUMERIC(@CreditBills)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Bills value Should be Number'		
				INSERT INTO Errorlog VALUES (27,@Tabname,'CreditBills',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditLimit))<>''
		BEGIN
			IF ISNUMERIC(@CreditLimit)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit value Should be Number'		
				INSERT INTO Errorlog VALUES (28,@Tabname,'CreditLimit',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditDays))<>''
		BEGIN
			IF ISNUMERIC(@CreditDays)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Days value Should be Number'		
				INSERT INTO Errorlog VALUES (29,@Tabname,'CreditDays',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (30,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (31,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountCondition))<>''
		BEGIN
			IF LTRIM(RTRIM(@CashDiscountCondition))='>=' OR LTRIM(RTRIM(@CashDiscountCondition))='<='
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Condition Type '+@CashDiscountCondition+ ' is not available'		
				INSERT INTO Errorlog VALUES (32,@Tabname,'CashDiscountCondition',@ErrDesc)
			END
		END
			
	
		IF LTRIM(RTRIM(@CashDiscountLimitValue))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountLimitValue)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Limit Value value Should be Number'		
				INSERT INTO Errorlog VALUES (33,@Tabname,'CashDiscountLimitValue',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@LicenseNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@LicNumberExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (34,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@LicNumberExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'License Number Expiry Date '+@LicNumberExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (35,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF  (CONVERT(NVARCHAR(10),@LicNumberExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (36,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@DrugLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@DrugLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Drug License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (37,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@DrugLicExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Drug License Number Expiry Date '+@DrugLicExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (38,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@DrugLicExDate,121))< CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Drug License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (39,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@PestLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@PestLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Pesticide License Number Expiry Date  was not given'		
				INSERT INTO Errorlog VALUES (40,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@PestLicExDate,121))=0
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Pesticide License Number Expiry Date '+@PestLicExDate+ 'not in date format'		
						INSERT INTO Errorlog VALUES (41,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@PestLicExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Pesticide License Number Expiry Date '		
						INSERT INTO Errorlog VALUES (42,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@RetailerType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Type should not be empty'		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Retailer Type',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerType))='Retailer' OR LTRIM(RTRIM(@RetailerType))='Sub Stockist'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Type '+@RetailerType+ ' is not available'		
				INSERT INTO Errorlog VALUES (44,@Tabname,'Retailer Type',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RetailerFrequency))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency should not be empty'		
			INSERT INTO Errorlog VALUES (45,@Tabname,'Retailer Frequency',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerFrequency))='Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Bi-Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Fort Nightly' OR LTRIM(RTRIM(@RetailerFrequency))='Monthly' OR LTRIM(RTRIM(@RetailerFrequency))='Daily'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Frequency '+@RetailerFrequency+ ' is not available'		
				INSERT INTO Errorlog VALUES (46,@Tabname,'Retailer Frequency',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrDaysAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Days Alert should not be empty'		
			INSERT INTO Errorlog VALUES (47,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrDaysAlert))='None' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrDaysAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (48,@Tabname,'Credit Days Alert',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RtrCrBillAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Bills Alert should not be empty'		
			INSERT INTO Errorlog VALUES (49,@Tabname,'Credit Bills Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrBillAlert))='None' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrBillAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (50,@Tabname,'Credit Bills Alert',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrLimitAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Limit Alert should not be empty'		
			INSERT INTO Errorlog VALUES (51,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrLimitAlert))='None' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit Alert '+@RtrCrLimitAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (52,@Tabname,'Credit Limit Alert',@ErrDesc)
			END
		END
		
		IF @Taction=1
		BEGIN
			SET @CmpRtrCode=''
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger(@CntTabname,@FldName,CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')	
			
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1
			BEGIN			
				IF NOT EXISTS(SELECT * FROM Retailer)
				BEGIN
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'	
				END
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))			
			END
			ELSE
			BEGIN
				SET @CmpRtrCode=@RetailerCode
			END
			
			SELECT @CmpRtrCode=@RetailerCode where @RetailerCode='DUMMY'--PARLECS/0820/189
			IF @CmpRtrCode=''
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Company Retailer Code should not be empty'		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
			END
		END
		
		
		
		IF @RtrId=0
		BEGIN
			SET @Po_ErrNo=1		
			SET @Taction=0
			SET @ErrDesc = 'Reset the Counter Year Value '		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
		END
		
		IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
		BEGIN
			IF LTRIM(RTRIM(@PhoneNo))=''
			BEGIN
				--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtdId NOT IN (@RetailerCode))
				IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
				(RtrCode NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
				OR RtrCode NOT IN (@RtrCodeUserInput)))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Retailer Phone Number not be Empty '		
					INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
				END				
			END			
		END
		
		IF LTRIM(RTRIM(@PhoneNo))<>''
		BEGIN
			--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtrId  NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
			(RtrCode  NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Phone Number should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
			END			
		END
		IF LTRIM(RTRIM(@TINNumber))<>''
		BEGIN
			--IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND RtrId NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND 
			(RtrCode NOT IN (@RetailerCode)OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tin Number Should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'TiN Number',@ErrDesc)
			END			
		END
		
		IF @Po_ErrNo=0
		BEGIN		
			DECLARE @MSG AS VARCHAR(100)
			SET @MSG=''
			SELECT @MSG=DBO.Fn_RetailerApprovalStatus(@RtrId)
			IF ISNULL(@MSG,'')<>''
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
				SELECT DISTINCT 5,'Retailer ApprovalStatus','ApprovalStatus',@MSG 
				SET @Po_ErrNo =1 
			END
		END
		
					
		IF  @Taction=1 AND @Po_ErrNo=0
		BEGIN	
			INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,RtrDrugLicNo,RtrDrugExpiryDate,
			RtrPestLicNo,RtrPestExpiryDate,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,Approved,XmlUpload,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrUniqueCode,RtrCodeUserInput)--Gopi at 08/11/2016
			VALUES(@RtrId,@RetailerCode,@CmpRtrCode,@RetailerName,@Address1,@Address2,@Address3,CAST(@PinCode AS INT),@PhoneNo,@EmailId,
			(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END),
			@RegistrationDate,
			(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),@TINNumber,@CSTNumber,@TaxGroupId,CAST(@CreditBills AS INT),CAST(@CreditLimit AS NUMERIC(18,2)),CAST(@CreditDays AS INT),
			(CAST(@CashDiscountPercentage AS NUMERIC(18,2))),(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),CAST(@CashDiscountLimitValue AS NUMERIC (18,2)),
			@LicenseNumber,CONVERT(NVARCHAR(10),@LicNumberExDate,121),@DrugLicNumber,CONVERT(NVARCHAR(10),@DrugLicExDate,121),
			@PestLicNumber,CONVERT(NVARCHAR(10),@PestLicExDate,121),@GeoMainId,@RMId,@VillageId,@ResidencePhoneNo,@OfficePhoneNo,
			CAST(@DepositAmount AS NUMERIC(18,2)),CONVERT(NVARCHAR(10),GETDATE(),121),CONVERT(NVARCHAR(10),GETDATE(),121),@CoaId,0,0,
			(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			'N',0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'',@RtrCodeUserInput)
			
			UPDATE CompanyCounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
			--RtrCode Auto Generate
			IF @AutoRtrCodeConfig=1
			BEGIN
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''RtrCode'''
				INSERT INTO Translog(strSql1) VALUES (@sSql) 
				
			END
			--Till Here
			
			
			SET @sSql='UPDATE CompanyCounters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''CmpRtrCode'''
			INSERT INTO Translog(strSql1) VALUES (@sSql) 		
			SET @sSql='INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,RtrCashDiscPerc,
			RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrDrugLicNo,RtrPestLicNo,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,XmlUpload,Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrLicExpiryDate,RtrDrugExpiryDate,RtrPestExpiryDate,Approved,RtrCodeUserInput)
			VALUES('+CAST(@RtrId AS VARCHAR(10))+','''+@RetailerCode+''','''+@CmpRtrCode+''','''+@RetailerName+''','''+@Address1+''','''+@Address2+''','''+@Address3+''','+CAST(CAST(@PinCode AS INT)AS VARCHAR(10))+','''+@PhoneNo+''','''+@EmailId+''',
			'+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+',
			'''+CAST(@RegistrationDate AS VARCHAR(12))+''',
			'+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			'+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+','''+@TINNumber+''','''+@CSTNumber+''','+CAST(@TaxGroupId AS VARCHAR(10))+','+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+','+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20)

)+','+CAST(CAST(@CreditDays AS INT) AS VARCHAR(10))+',
			'+CAST((CAST(@CashDiscountPercentage AS NUMERIC(18,2)))AS VARCHAR(20))+','+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+','+CAST(CAST(@CashDiscountLimitValue AS NUMERIC (18,2))AS VARCHAR(20))+',
			'''+@LicenseNumber+''','''+@DrugLicNumber+''',
			'''+@PestLicNumber+''','+CAST(@GeoMainId AS VARCHAR(10))+','+CAST(@RMId AS VARCHAR(10))+','+CAST(@VillageId AS VARCHAR(10))+','''+@ResidencePhoneNo+''','''+@OfficePhoneNo+''',
			'+CAST(CAST(@DepositAmount AS NUMERIC(18,2))AS VARCHAR(20))+','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','+CAST(@CoaId AS VARCHAR(10))+',0,0
			,'+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+'
			,''N'',0,0,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',0'
			
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			--RtrCode Auto Generate
			SET @sSql=@sSql + ','''+ISNULL(@RtrCodeUserInput,'')+''')'
			---Till Here
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  @CntTabname AND Fldname = @FldName
			SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname ='''+@CntTabname+''' AND Fldname ='''+@FldName+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			IF EXISTS (SELECT * FROM Retailer WHERE RtrId=@RtrId)
			BEGIN
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RetailerName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VeLUES ('+CAST(@CoaId AS VARCHAR(10))+','''+@AcCode+''','''+@RetailerName+''',4,2,2,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				IF @PotentialClassCode<>''
				BEGIN
					DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
					SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
					INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
					SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				END
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =  ''CoaMaster'' AND Fldname = ''CoaId'''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END			
		END		
		IF  @Taction=2 AND @Po_ErrNo=0
		BEGIN
			--CRCRSTPAR0070
			IF @Taction=2
			BEGIN
				
				----PARCS202100043 OR condition added RtrCodeUserInput
				DECLARE @ReturnMsg AS VARCHAR(100)
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrName',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
					BEGIN
					SET @RetailerName=(SELECT RtrName FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrStatus',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @Status=(SELECT CASE RTRSTATUS WHEN 1 THEN 'Active' ELSE 'InActive' END FROM Retailer 
					WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))					
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'Geography',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @GeoMainId=(SELECT GeoMainId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
			END
			
			--Added By S.Moorthi CRCRSTPAR0001
				IF EXISTS (SELECT '*' FROM Retailer (NOLOCK) WHERE RTRID = @RtrId and (RtrName<>@RetailerName
				or RtrStatus<>(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) or ISNULL(GeoMainId,0)<>ISNULL(@GeoMainId,0)))
				BEGIN
					IF NOT EXISTS (SELECT DISTINCT RtrId FROM RetailerApprovalStatus WHERE RtrId = @RtrId)
					BEGIN
						INSERT INTO RetailerApprovalStatus(RtrId,RtrCtgId,RtrClassId,RtrStatus,
						Rtrname,Geoid,Upload,Mode,ModDate)
						SELECT @RtrId,0,0,
						CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) END,
						CASE WHEN RtrName=@RetailerName THEN '' ELSE @RetailerName END,
						CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END,
						0,2,GETDATE() FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					END
								  
					UPDATE A SET RtrName = CASE WHEN RTRIM(LTRIM(B.RtrName))=RTRIM(LTRIM(@RetailerName)) THEN '' ELSE @RetailerName END,
					RtrStatus=CASE WHEN B.RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 ENd) END,
					GeoId=CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END FROM RetailerApprovalStatus A INNER JOIN Retailer B ON A.RtrId=B.RtrId
					WHERE A.RtrId = @RtrId 
					SELECT @RetailerName=CASE WHEN RtrName=@RetailerName THEN @RetailerName ELSE RtrName END,
					@GeoMainId=CASE WHEN GeoMainId=@GeoMainId THEN @GeoMainId ELSE GeoMainId END,	
					@Status= CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) ELSE RtrStatus END 
					FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					UPDATE R SET R.Upload='N' FROM RetailerApprovalStatus A(NOLOCK)     
					INNER JOIN  RETAILER R (NOLOCK) ON A.RTRID=R.RTRID    
					WHERE A.Upload=0 AND R.RtrId=@RtrId    
						
				END
			--Till Here
					
			UPDATE Retailer SET  RtrName=@RetailerName,RtrAdd1=@Address1,RtrAdd2=@Address2,RtrAdd3=@Address3,
			RtrPinNo=CAST (@PinCode AS INT),RtrPhoneNo=@PhoneNo,
			RtrEmailId=@EmailId,
			RtrKeyAcc=(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrCovMode=(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)
			,RtrRegDate=CONVERT(NVARCHAR(10),@RegistrationDate,121),
			RtrDayOff=(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			RtrTaxable=(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrTaxType=(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),
			RtrTINNo=@TINNumber,
			RtrCSTNo=@CSTNumber,TaxGroupId=@TaxGroupId,RtrCrBills=CAST(@CreditBills AS INT),RtrCrLimit=CAST(@CreditLimit AS NUMERIC(18,2)),RtrCrDays=CAST(@CreditDays AS INT),
			RtrCashDiscPerc=CAST(@CashDiscountPercentage AS NUMERIC(18,2)),
			RtrCashDiscCond=(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),RtrCashDiscAmt=CAST(@CashDiscountLimitValue AS NUMERIC(18,2)),
			RtrLicNo=@LicenseNumber,RtrLicExpiryDate=CONVERT(NVARCHAR(10),@LicNumberExDate,121),RtrDrugLicNo=@DrugLicNumber,
			RtrDrugExpiryDate=CONVERT(NVARCHAR(10),@DrugLicExDate,121),RtrPestLicNo=@PestLicNumber,
			RtrPestExpiryDate=CONVERT(NVARCHAR(10),@PestLicExDate,121),GeoMainId=@GeoMainId,
			RMId=@RMId,VillageId=@VillageId,RtrResPhone1=@ResidencePhoneNo,RtrOffPhone1=@OfficePhoneNo,RtrDepositAmt=CAST(@DepositAmount AS NUMERIC(18,2)), 
			RtrType=(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			RtrFrequency=(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			RtrCrDaysAlert=(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrBillsAlert=(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrLimitAlert=(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)
			WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput =@RtrCodeUserInput OR RtrCode=@RtrCodeUserInput)
				
			SET @sSql='UPDATE Retailer SET  RtrName='''+@RetailerName+''',RtrAdd1='''+@Address1+''',RtrAdd2='''+@Address2+''',RtrAdd3='''+@Address3+''',
			RtrPinNo='+CAST(CAST(@PinCode AS INT) AS VARCHAR(20))+',RtrPhoneNo='''+@PhoneNo+''',
			RtrEmailId='''+@EmailId+''',
			RtrKeyAcc='+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrCovMode='+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+'
			,RtrRegDate='''+CONVERT(NVARCHAR(10),@RegistrationDate,121)+''',
			RtrDayOff='+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			RtrStatus='+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxable='+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxType='+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+',
			RtrTINNo='''+@TINNumber+''',
			RtrCSTNo='''+@CSTNumber+''',TaxGroupId='+CAST(@TaxGroupId AS VARCHAR(10))+',RtrCrBills='+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+',RtrCrLimit='+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20))+',RtrCrDays='+CAST(CAST(@CreditDays AS INT)
 AS VARCHAR(10))+',
			RtrCashDiscPerc='+CAST(CAST(@CashDiscountPercentage AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrCashDiscCond='+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+',RtrCashDiscAmt='+CAST(CAST(@CashDiscountLimitValue AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrLicNo='''+@LicenseNumber+''',RtrDrugLicNo='''+@DrugLicNumber+''',RtrPestLicNo='''+@PestLicNumber+''',GeoMainId='+CAST(@GeoMainId AS VARCHAR(10))+',
			RMId='+CAST(@RMId AS VARCHAR(20))+',VillageId='+CAST(@VillageId AS VARCHAR(20))+',RtrResPhone1='''+@ResidencePhoneNo+''',RtrOffPhone1='''+@OfficePhoneNo+''',RtrDepositAmt='+CAST(CAST(@DepositAmount AS NUMERIC(18,2)) AS VARCHAR(20))+''
					
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate='''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate='''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate='''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			SET @sSql=@sSql + ',RtrType='+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,RtrFrequency='+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,RtrCrDaysAlert='+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrBillsAlert='+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrLimitAlert='+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+''
			SET @sSql=@sSql +' WHERE RtrCode='''+@RetailerCode+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @CoaId=CoaId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			UPDATE CoaMAster SET AcName=@RetailerName WHERE CoaId=@CoaId
			SET @sSql='UPDATE CoaMaster SET AcName='''+@RetailerName+''' WHERE CoaId='+CAST(@CoaId AS VARCHAR(10))+''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @RtrId=RtrId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			IF @PotentialClassCode<>''
			BEGIN
				DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
				SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END
		END
		FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
		@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
		@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
		@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
		@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
		@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	END
	CLOSE Cur_Retailer
	DEALLOCATE Cur_Retailer
	RETURN
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='HHTDeviceSerialNumber' AND Object_id = Object_ID('Cn2Cs_Prk_SalesManMaster'))
BEGIN
	ALTER TABLE Cn2Cs_Prk_SalesManMaster ADD HHTDeviceSerialNumber VARCHAR(100)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='OldSmCode' AND Object_id = Object_ID('Cn2Cs_Prk_SalesManMaster'))
BEGIN
	ALTER TABLE Cn2Cs_Prk_SalesManMaster ADD OldSmCode VARCHAR(100)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='OldRmCode' AND Object_id = Object_ID('Cn2Cs_Prk_RouteMaster'))
BEGIN
	ALTER TABLE Cn2Cs_Prk_RouteMaster ADD OldRmCode VARCHAR(100)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='HHTDeviceSerialNumber' AND Object_id = Object_ID('SalesmanMasterTrack'))
BEGIN
	ALTER TABLE SalesmanMasterTrack ADD HHTDeviceSerialNumber VARCHAR(100)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='OldSmCode' AND Object_id = Object_ID('SalesmanMasterTrack'))
BEGIN
	ALTER TABLE SalesmanMasterTrack ADD OldSmCode VARCHAR(100)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='OldRmCode' AND Object_id = Object_ID('RouteMasterTrack'))
BEGIN
	ALTER TABLE RouteMasterTrack ADD OldRmCode VARCHAR(100)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_Retailer' AND name='Aadhaar')
BEGIN
      ALTER TABLE Cs2Cn_Prk_Retailer ADD Aadhaar NVARCHAR(50) 
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_Retailer' AND name='TCSApplicable')
BEGIN
      ALTER TABLE Cs2Cn_Prk_Retailer ADD TCSApplicable NVARCHAR(20) 
END
GO
IF NOT EXISTS (SELECT * FROM SYS.COLUMNS WHERE  Name ='RtrUniqueCode' AND Object_id = Object_ID('Cs2Cn_Prk_Retailer'))
BEGIN
	ALTER TABLE Cs2Cn_Prk_Retailer ADD RtrUniqueCode NVARCHAR(100)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CN2CS_SalesManMaster' AND XTYPE ='P')
DROP PROCEDURE Proc_CN2CS_SalesManMaster
GO
/*
BEGIN TRANSACTION
DELETE FROM ERRORLOG
EXEC Proc_CN2CS_SalesManMaster 0
SELECT * FROM SALESMAN
SELECT * FROM Cn2Cs_Prk_SalesManMaster
SELECT * FROM ERRORLOG
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_CN2CS_SalesManMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_CN2CS_SalesManMaster
* PURPOSE		: To Download the SalesMan details from Console to Core Stocky
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 28/12/2020	 Venkat. M	 CR		CRCRSTPAR0107		OldSmcode column added
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @ErrStatus			INT
	DECLARE @sSql				NVARCHAR(2000)
	DECLARE @ErrDesc  			NVARCHAR(1000)
	DECLARE @Tabname  			NVARCHAR(50)
	DECLARE @Exists				INT
	DECLARE @SMId				INT
	
	SET @ErrStatus=1
	SET @Po_ErrNo=0
	SET @Tabname = 'Cn2Cs_Prk_SalesManMaster'
	
	DECLARE @DistCode		[nvarchar](100)
	DECLARE @SMCode			[nvarchar](100)
	DECLARE @SMName			[nvarchar](100)
	DECLARE @SMPhoneNo		[nvarchar](100)
	DECLARE @SMEmail		[nvarchar](100)
	DECLARE @SMOtherDetails [nvarchar](500)
	DECLARE @SMDailyAllowance [numeric](38, 6)
	DECLARE @SMMonthlySalary [numeric](38, 6)
	DECLARE @SMMktCredit	[numeric](38, 6)
	DECLARE @SMCreditDays	[int]
	DECLARE @Status			INT
	DECLARE @RMCode			[nvarchar](100)
	DECLARE @RMName			[nvarchar](100)	
	DECLARE @OldSMCode		[nvarchar](100)
	
	DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_SalesManMaster'
	
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SalesManToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SalesManToAvoid	
	END
	CREATE TABLE SalesManToAvoid
	(		
		SMCode		NVARCHAR(200),
		RMCODE		VARCHAR(100)
	)
	
	IF EXISTS(SELECT * FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR ISNULL(SMName,'')='' OR ISNULL(OLDSMCODE,'')='')
	BEGIN
		INSERT INTO SalesManToAvoid(SMCode,RMCODE)
		SELECT SMCODE,RMCODE FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR  ISNULL(SMName,'')=''OR ISNULL(OLDSMCODE,'')=''
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT 1,'Cn2Cs_Prk_SalesManMaster','SM Code','Salesman code should not be empty'
		FROM Cn2Cs_Prk_SalesManMaster WHERE ISNULL(SMCode,'')='' OR  ISNULL(SMName,'')=''
	END
	
	INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	SELECT SMCODE,RMCode FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster B (NOLOCK) WHERE  A.RMCode=B.RMCODE) AND Status ='ACTIVE'
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_SalesManMaster','RM Code','Route Code ' + RMCode + ' Not Available for '+ SMCode   
	FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster B (NOLOCK) WHERE A.RMCode=B.RMCODE) AND Status ='ACTIVE'
	
	--INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	--SELECT SMCODE,RMCode FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE EXISTS(
	--SELECT SMCode FROM SalesMan B (NOLOCK) WHERE A.SMCode=B.SMCode)
	
	--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--SELECT DISTINCT 1,'Cn2Cs_Prk_SalesManMaster','SalesMan Code','SalesMan Code ' + SMCode + ' Already Available' 
	--FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK) WHERE EXISTS(
	--SELECT SMCode FROM SalesMan B (NOLOCK) WHERE A.SMCode=B.SMCode)
	
	--INSERT INTO SalesManToAvoid(SMCode,RMCODE)
	--SELECT A.SMCODE,A.RMCODE FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	--INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	--INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	--INNER JOIN SalesmanMarket D (NOLOCK) ON D.SMId=B.SMId AND D.RMId=C.RMId 
	
	--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--SELECT 1,'Cn2Cs_Prk_SalesManMaster','RM Code','SalesMan and SalesManMarket ' + A.SMCode + '+'+ A.RMCode +' Details Already Available' 
	--FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	--INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	--INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	--INNER JOIN SalesmanMarket D (NOLOCK) ON D.SMId=B.SMId AND D.RMId=C.RMId 
	
	SELECT @SMId = ISNULL(MAX(SMId),0) FROM SalesMan (NOLOCK)
	SET @SMId=ISNULL(@SMId,0)
	-- Added By Venkat. M PMS No :CRCRSTPAR0107
	SELECT A.*INTO #INSERT FROM Cn2Cs_Prk_SalesManMaster  A 
	WHERE NOT EXISTS (SELECT B.SMCode FROM Salesman B (NOLOCK) WHERE  A.SMCode <>B.SMCode AND A.OldSMCode =B.OldSmCode)
	AND SmCode NOT IN (SElECT SMCode FROM SalesManToAvoid)
	
	SELECT A.* INTO #UPDATE FROM Cn2Cs_Prk_SalesManMaster A 
	WHERE EXISTS (SELECT B.SMCode FROM Salesman B (NOLOCK) WHERE B.SMCode=B.OldSMCode AND A.OldSMCode=B.OldSMCode AND A.SMCode <>B.SMCode )
	AND SmCode NOT IN (SElECT SMCode FROM SalesManToAvoid) 
	
	IF EXISTS (SELECT * FROM #UPDATE)
	BEGIN
		UPDATE A SET A.SmCode =B .SMCode,A.Status =(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),WsUpload='N'
		FROM Salesman A(NOLOCK) INNER JOIN #UPDATE B ON A.OldSmCode=B.OldSmCode

		DELETE FROM SalesmanMarket WHERE SmId IN(SELECT SMID FROM Salesman S (NOLOCK) INNER JOIN #UPDATE B ON S.SmCode=B.SmCode)
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #UPDATE A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END
	IF EXISTS (SELECT * FROM #INSERT WHERE SMCode IN(SELECT SMCode FROM Salesman (NOLOCK)))
	BEGIN
		UPDATE A SET A.SMName  =B .SMName ,A.Status =(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),WsUpload='N'
		FROM Salesman A(NOLOCK) INNER JOIN #INSERT B ON A.OldSmCode=B.OldSmCode WHERE B.SMCode IN(SELECT SMCode FROM Salesman (NOLOCK))

		DELETE FROM SalesmanMarket WHERE SmId IN(SELECT SMID FROM Salesman S (NOLOCK) INNER JOIN #INSERT B ON S.SmCode=B.SmCode)
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #INSERT A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END
	
	DELETE FROM #INSERT WHERE SMCode IN(SELECT SMCode FROM Salesman (NOLOCK))
	
	IF EXISTS (SELECT * FROM #INSERT)
	BEGIN
		INSERT INTO SalesmanMasterTrack(SMCode,SMName,SMPhoneNo,SMEmail,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,
									SMMktCredit,SMCreditDays,Status,RMCode,RMName,CreateDate,HHTDeviceSerialNumber,OldSmCode)
		SELECT A.SMCode,A.SMName,A.SMPhoneNo,A.SMEmail,A.SMOtherDetails,A.SMDailyAllowance,A.SMMonthlySalary,
		A.SMMktCredit,A.SMCreditDays,A.Status,A.RMCode,A.RMName,GETDATE(),A.HHTDeviceSerialNumber,A.OldSmCode FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK)
		INNER JOIN #INSERT B ON A.SMCode =B.SMCode AND A.OldSmCode = B.OLdSmCode
		WHERE A.DownloadFlag='D' AND ISNULL(A.SMCODE,'')<>'' AND NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid B (NOLOCK) 
		WHERE A.SMCODE=B.SMCODE AND A.RMCODE=B.RMCODE) AND NOT EXISTS(SELECT SMCODE FROM Salesman D(NOLOCK) WHERE D.SMCode=A.SMCODE)
		
		INSERT INTO SalesMan(SMId,SMCode,SMName,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,
						SMCreditDays,CmpId,SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,UpLoad,
						Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,HHTDeviceSerialNumber,OldsmCode)
		SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY A.SMCODE,A.SMName)+@SMId) AS SMId,A.SMCode,A.SMName,ISNULL(A.SMPhoneNo,''),ISNULL(A.SMEmail,''),ISNULL(A.SMOtherDetails,''),ISNULL(A.SMDailyAllowance,0),
		ISNULL(A.SMMonthlySalary,0),isnull(A.SMMktCredit,0),ISNULL(A.SMCreditDays,0),0 AS CmpId,0 AS SalesForceMainId,(CASE UPPER(ISNULL(A.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),
		0,0,'N',1,1,GETDATE(),1,GETDATE(),0,ISNULL(A.HHTDeviceSerialNumber,''),A.OldSmcode
		FROM Cn2Cs_Prk_SalesManMaster A (NOLOCK)  INNER JOIN #INSERT B ON A.SMCode =B.SMCode 
		AND A.OldSmCode = B.OLdSmCode WHERE A.DownloadFlag='D' AND ISNULL(A.SMCode ,'')<>'' AND  
		NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid B (NOLOCK) WHERE A.SMCODE=B.SMCODE AND A.RMCODE=B.RMCODE) AND 
		NOT EXISTS(SELECT SMCODE FROM Salesman D(NOLOCK) WHERE D.SMCode=A.SMCODE)
			
		SELECT @SMId = ISNULL(MAX(SMId),0) FROM SalesMan (NOLOCK)
		UPDATE Counters SET CurrValue = @SMId WHERE TabName = 'SalesMan' AND FldName = 'SMId'
			
		INSERT INTO SalesmanMarket(SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT B.SMId,C.RMId,1,1,GETDATE(),1,GETDATE() FROM #INSERT A(NOLOCK) 
		INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
		INNER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
		WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
		WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE)AND DownloadFlag='D'
	END

	UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_SalesManMaster A(NOLOCK) 
	INNER JOIN SalesMan B (NOLOCK) ON A.SMCODE=B.SMCode 
	LEFT OUTER JOIN RouteMaster C (NOLOCK) ON C.RMCode=A.RMCODE
	WHERE NOT EXISTS (SELECT SMCODE,RMCODE FROM SalesManToAvoid D (NOLOCK) 
	WHERE A.SMCODE=D.SMCODE AND A.RMCODE=D.RMCODE) AND DownloadFlag='D' 
	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CN2CS_RouteMaster' AND XTYPE ='P')
DROP PROCEDURE Proc_CN2CS_RouteMaster
GO
/*
BEGIN TRANSACTION
DELETE FROM ERRORLoG
EXEC Proc_CN2CS_RouteMaster 0
SELECT * FROM Cn2Cs_Prk_RouteMaster Where OldRmCode Is Null
SELECT OldRmcode,* FROM RouteMaster WHERE OldRMCode In(SELECT OldRmCode FROM Cn2Cs_Prk_RouteMaster) 
select * FROM ERRORLoG
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_CN2CS_RouteMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_CN2CS_SalesManMaster
* PURPOSE		: To Download the Route Details from Console to Core Stocky
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 08-09-2020  Deepk Philip BZ    PARLECS/0920/089    To avoid duplicate routes.
 28/12/2020	 Venkat. M	 CR		CRCRSTPAR0107		OldSmcode column added
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @ErrStatus			INT
	DECLARE @sSql				NVARCHAR(2000)
	DECLARE @ErrDesc  			NVARCHAR(1000)
	DECLARE @Tabname  			NVARCHAR(50)
	DECLARE @DistCode			[nvarchar](100)
	DECLARE @Exists				INT
	DECLARE @RmId				INT
	DECLARE @CmpId AS	 INT
	
	SET @ErrStatus=1
	SET @Po_ErrNo=0
	SET @CmpId=0
	SET @Tabname = 'Cn2Cs_Prk_RouteMaster'
	
	DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_RouteMaster'
	
	SELECT @CmpId=CmpId FROM Company WHERE DefaultCompany=1
		
	CREATE TABLE #ToAvoidRoute
	( 
	  RouteCode		 NVARCHAR(200),
	  GeoLevel       NVARCHAR(200),
	  GeoCode        NVARCHAR(200)
	)
	--
	SELECT DISTINCT * INTO #Cn2Cs_Prk_RouteMaster FROM Cn2Cs_Prk_RouteMaster
	DELETE A FROM Cn2Cs_Prk_RouteMaster A (NOLOCK)
	INSERT INTO Cn2Cs_Prk_RouteMaster
	SELECT * FROM #Cn2Cs_Prk_RouteMaster
	
	SELECT PR.RMCode INTO #ParkingDuplicateRetailers FROM Cn2Cs_Prk_RouteMaster PR (NOLOCK)
	WHERE DownloadFlag = 'D' GROUP BY PR.RMCode
	HAVING COUNT(7)>1
	
	INSERT INTO #ToAvoidRoute(RouteCode)
	SELECT DISTINCT RMCODE FROM #ParkingDuplicateRetailers
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteName','Duplicate Route Code Available-'+RMCode  
	FROM #ParkingDuplicateRetailers WITH(NOLOCK) 
	
	INSERT INTO #ToAvoidRoute(RouteCode)
	SELECT DISTINCT RMCode FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK)
	WHERE ISNULL(RMCODE,'')='' OR ISNULL(RMNAME,'')=''OR ISNULL(OldRMCode,'')='' AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteName','Route Code/Name can not be Empty-'+RMCode+'+'+RMName  
	FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE ISNULL(RMCODE,'')='' OR ISNULL(RMNAME,'')=''OR ISNULL(OldRMCode,'')='' AND DownloadFlag = 'D'
	
	--INSERT INTO #ToAvoidRoute(RouteCode)
	--SELECT DISTINCT A.RMCode FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	--INNER JOIN ROUTEMASTER B (NOLOCK) ON A.RMCODE=B.RMCODE
	--WHERE DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteCode','Route Code Already Available-'+A.RMCode
	--FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	--INNER JOIN ROUTEMASTER B (NOLOCK) ON A.RMCODE=B.RMCODE
	--WHERE DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoLevel)
	SELECT DISTINCT RMCode,GeoLevel FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) WHERE GeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoLevelName','Route Geography Level Not Available-'+GeoLevel 
	FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE GeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoCode)
	SELECT DISTINCT RMCode,GeoValue FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) WHERE GeoValue NOT IN 
	(SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoCode','Route Geography Not Available-'+RMCode+'-'+GeoValue FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE GeoValue NOT IN (SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoCode)
	SELECT DISTINCT RMCODE,GeoValue FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.GeoLevel = B.GeoLevelName AND A.GeoValue = C.GeoCode)AND DownloadFlag = 'D'
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoCode','Route Geography Wrongly Mapped-'+RMCode+'-'+GeoLevel+'-'+GeoValue 
	FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) WHERE NOT EXISTS 
		(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
		INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId 
		WHERE A.GeoLevel = B.GeoLevelName AND A.GeoValue = C.GeoCode)AND DownloadFlag = 'D'
	
	--To Insert the Sales Route Details 
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	SET @RmId=ISNULL(@RmId,0)
	-- Added By Venkat. M PMS No : CRCRSTPAR0107
	SELECT A.*INTO #INSERT 	FROM Cn2Cs_Prk_RouteMaster  A 
	WHERE NOT EXISTS (SELECT B.RmCode FROM RouteMaster  B (NOLOCK) WHERE  A.RMCode <>B.RMCode AND A.OldRMCode =B.OldRmCode)
	AND RmCode NOT IN (SELECT RouteCode  FROM #ToAvoidRoute)

	SELECT A.* INTO #UPDATE FROM Cn2Cs_Prk_RouteMaster A 
	WHERE EXISTS (SELECT B.RMCode FROM RouteMaster B (NOLOCK) WHERE B.RMCode=B.OldRMCode AND A.OldRMCode=B.OldRMCode AND A.RMCode <>B.RMCode ) 
	AND A.RmCode NOT IN (SELECT RouteCode  FROM #ToAvoidRoute)
	
	IF EXISTS (SELECT * FROM #UPDATE)
	BEGIN
		UPDATE A SET A.RmCode =B .RMCode, A.RMstatus=(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END)
		 FROM RouteMaster A(NOLOCK) INNER JOIN #UPDATE B ON A.OldRmCode=B.OldRmCode
	END
	IF EXISTS (SELECT * FROM #INSERT WHERE RmCode IN(SELECT RmCode FROM RouteMaster (NOLOCK)))
	BEGIN
		UPDATE A SET A.RmName =B .RMName, A.RMstatus=(CASE UPPER(ISNULL(B.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END),
		A.RMMon =(CASE UPPER(ISNULL(B.MonDay ,'YES')) WHEN 'YES' THEN 1 ELSE 0 END),
		A.RMTue = (CASE UPPER(ISNULL(B .TuesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) ,
		A.RMWed =(CASE UPPER(ISNULL(B.WednesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END),
		A.RMThu = (CASE UPPER(ISNULL(B.ThursDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) ,
		A.RMFri =(CASE UPPER(ISNULL(B.FriDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) ,
		A.RMSat =(CASE UPPER(ISNULL(B.SaturDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) ,
		A.RMSun =(CASE UPPER(ISNULL(B.SunDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END)
		FROM RouteMaster A(NOLOCK) INNER JOIN #INSERT B ON A.RmCode=B.RmCode
	END
	DELETE FROM #INSERT WHERE RmCode IN(SELECT RmCode FROM RouteMaster (NOLOCK))

	IF EXISTS (SELECT * FROM #INSERT)
	BEGIN
		INSERT INTO RouteMasterTrack(RMCode,RMName,Distance,RMPopulation,VanRoute,RouteType,LocalUpCountry,GeoLevel,GeoValue,Status,
							MonDay,TuesDay,WednesDay,ThursDay,FriDay,SaturDay,SunDay,CreatedDate,OldRmCode)
		SELECT A.RMCode,A.RMName,A.Distance,A.RMPopulation,A.VanRoute,A.RouteType,A.LocalUpCountry,A.GeoLevel,A.GeoValue,A.Status,
		A.MonDay,A.TuesDay,A.WednesDay,A.ThursDay,A.FriDay,A.SaturDay,A.SunDay,GETDATE(),A.OldRmCode FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
		INNER JOIN #INSERT I ON A.RMCode =I.RMCode 
		INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
		INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
		WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND A.DownloadFlag='D'
		AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND A.DownloadFlag = 'D'
		
		INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,
		RMSRouteType,RMLocalUpcountry,RMMon,RMTue,RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,
		Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,OldRmCode)
		SELECT DISTINCT @RmId + ROW_NUMBER() OVER (ORDER BY A.RMCODE,A.RMName) AS RmId,A.RMCODE,A.RMNAME,@CmpId,ISNULL(A.Distance,0),ISNULL(A.RMPopulation,0),GeoMainId,
		ISNULL(A.VanRoute ,0),A.RouteType,ISNULL(A.LocalUpCountry,1),(CASE UPPER(ISNULL(A.MonDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS Monday,
		(CASE UPPER(ISNULL(A.TuesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS TuesDay,
		(CASE UPPER(ISNULL(A.WednesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS WednesDay,
		(CASE UPPER(ISNULL(A.ThursDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS ThursDay,
		(CASE UPPER(ISNULL(A.FriDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS FriDay,
		(CASE UPPER(ISNULL(A.SaturDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS SaturDay,
		(CASE UPPER(ISNULL(A.SunDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS SunDay,
		(CASE UPPER(ISNULL(A.Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END) AS RMStatus,
		'N',1,1,GETDATE(),1,GETDATE(),0,A.OldRmCode
		FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) INNER JOIN #INSERT I ON A.RMCode =I.RMCode 
		INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
		INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
		WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND A.DownLoadFlag ='D'
		AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND A.DownloadFlag = 'D'
		
		SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
		UPDATE Counters SET CurrValue = @RmId WHERE TabName = 'RouteMaster' AND FldName = 'RMId'
	END
	
	UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
	INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
	WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND DownloadFlag='D'
	AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND DownloadFlag = 'D'
	
	RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_Cn2Cs_RetailerMigration' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerMigration
GO
/*
Begin transaction
delete from ErrorLog
select * from RetailerMasterMigration
exec Proc_Cn2Cs_RetailerMigration 0
select * from RetailerMasterMigration
select * from ErrorLog
rollback transaction
*/  
CREATE PROCEDURE Proc_Cn2Cs_RetailerMigration
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMigration 0
* PURPOSE		: Retailer to be Migrated from One DB to Other DB
* CREATED		: Sathishkumar Veeramani
* CREATED DATE	: 06/06/2014
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
17-01-2018  lakshman M   BZ     ICRSTPAR7316          Retailer Tin No & Retailer Phone Number null values validation removed in Core stocky.
03-02-2018  lakshman M   BZ     ICRSTPAR7619          RtrPhone Number & RtrTinNumber Null values allowed in RetailerMasterMigartion Table
28-12-2018  Lakshman M   SR     ILCRSTPAR2934         As per client request Retailer default taxgroup validation included in core stocky.
22-06-2020	MOHANA S	 BZ		PARCS202100035		  NEW COLUMN IS NOT DOWNLOADED FOR SALEMAN. HENCE NULL ERROR OCURRED WHILE LOADING IN SALESMAN SCREEN
20-07-2020  Deepan       CR     PARCS202100041         USER INPUT added
29-12-2020	Venkat. M	 CR		CRCRSTPAR0107		  OLD SMcode, RMCode column added in salesman,Route
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
SET @Po_ErrNo=0
DECLARE @CmpId AS NUMERIC(18,0)
DECLARE @SmId AS NUMERIC(18,0)
DECLARE @RmId AS NUMERIC(18,0)
DECLARE @DlvRmId AS NUMERIC(18,0)
DECLARE @UdcMasterId AS NUMERIC(18,0)
DECLARE @DistCode AS NVARCHAR(200)
DECLARE @Taxgroupid AS INT
DELETE FROM Cn2Cs_Prk_RetailerMigration WHERE DownLoadFlag = 'Y'
SELECT @DistCode = DistributorCode FROM Distributor WITH(NOLOCK)
SELECT @CmpId = CmpId FROM Company (NOLOCK) WHERE DefaultCompany = 1
	
	CREATE TABLE #ToAvoidRetailerMigration
	(
	  SalesmanCode   NVARCHAR(200),
	  SalRouteCode   NVARCHAR(200),
	  DlvRouteCode   NVARCHAR(200), 
	  RetailerCode   NVARCHAR(200),
	  GeoLevel       NVARCHAR(200),
	  GeoCode        NVARCHAR(200)
	)
	
	--Route Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoLevel)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Route Geography Level Not Available-'+RouteGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	--Route Geography Value Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RouteGeoCode NOT IN 
	(SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Not Available-'+RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RouteGeoCode NOT IN (SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode,DlvRouteCode,GeoCode)
	SELECT DISTINCT SalRouteCode,DlvRouteCode,RouteGeoCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Route Geography Wrongly Mapped-'+RouteGeoLevel+'-'+RouteGeoCode	
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RouteGeoLevel = B.GeoLevelName AND A.RouteGeoCode = C.GeoCode)
	
	--Salesman Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalesmanCode)
	SELECT DISTINCT SalesManCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManName IN 
	(SELECT SmName FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Salesman','Salesman Name','Salesman Name Already Availabe-'+SalesManName 
	--FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalesManName IN (SELECT SmName FROM Salesman WITH(NOLOCK)) AND DownloadFlag = 'D'
	
	--Sales Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(SalRouteCode)
	SELECT DISTINCT SalRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE SalRouteName IN 
	(SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Sales Route Name Already Availabe-'+SalRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE SalRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 1) AND DownloadFlag = 'D'
	
	--Delivery Route Details Validation
	INSERT INTO #ToAvoidRetailerMigration(DlvRouteCode)
	SELECT DISTINCT DlvRouteCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DlvRouteName IN 
	(SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'RouteMaster','Route Name','Delivery Route Name Already Availabe-'+DlvRouteName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	--WHERE DlvRouteName IN (SELECT RMName FROM RouteMaster WITH(NOLOCK) WHERE RMSRouteType = 2) AND DownloadFlag = 'D'
	
	--Retailer Details Validation
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
--	(RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Duplicate Retailer Unique Code Not Allow-'+RtrUniqueCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE EXISTS(
	SELECT * FROM RETAILER B WHERE A.RtrUniqueCode=B.RtrUniqueCode) AND DownloadFlag = 'D'
	
	
	--Retailer UNIQUE Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrUniqueCode','Retailer Unique Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrUniqueCode IS NULL OR RtrUniqueCode = '') AND DownloadFlag = 'D'
		
	----Duplicate Retailer Phone No & Tin No.
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	And ISNULL(A.RTRPHONENO,'') <> ''
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Duplicate Phone Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrPhoneNo=B.RtrPhoneNo) AND DownloadFlag = 'D'
	AND ISNULL(A.RTRPHONENO,'') <> ''
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	AND ISNULL(A.RtrTinNumber,'') <> ''
	----------------- Retailer Tin No validation commented by lakshman M on 17/01/2018 PMS ID: ICRSTPAR7316 --------------------
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Duplicate Tin Number Not allow-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--EXISTS(SELECT RTRID FROM RETAILER B(NOLOCK) WHERE A.RtrTinNumber=B.RtrTINNo) AND DownloadFlag = 'D'
	--AND ISNULL(A.RtrTinNumber,'') <> ''
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrTinNumber','Tin Number length Should be between 8 to 12-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrTinNumber) NOT BETWEEN 8 AND 12 AND DownloadFlag = 'D'
	
	--INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	--SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
	--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Phone Number length Should be between 8 to 10-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE 
	--LEN(RtrPhoneNo) NOT BETWEEN 8 AND 10 AND DownloadFlag = 'D'
---------------------- Till Here ---------------------
	--Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Code Should Not be Empty-'+RtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrCode IS NULL OR RtrCode = '') AND DownloadFlag = 'D'
	
	--Company Retailer Code
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Company Retailer Code Should Not be Empty-'+CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (CmpRtrCode IS NULL OR CmpRtrCode = '') AND DownloadFlag = 'D'
	
	--Retailer Name
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Name Should Not be Empty-'+RtrName FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrName IS NULL OR RtrName = '') AND DownloadFlag = 'D'
	
	--Retailer Address
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrCode','Retailer Address1 Should Not be Empty-'+RtrAddress1 FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE (RtrAddress1 IS NULL OR RtrAddress1 = '') AND DownloadFlag = 'D'
	
	--Retailer Geography Level Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Not Available-'+RetailerGeoLevel FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS RetailerGeoLevel 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Level Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoLevel) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoLevel) > 1)Qry
	
	--Retailer Geography Value Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE RetailerGeoCode NOT IN 
	(SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Not Available-'+RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) 
	WHERE RetailerGeoCode NOT IN (SELECT GeoName FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'GeographyLevel','GeoLevelName','Retailer Geography Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT RetailerGeoCode) AS RetailerGeoCode FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode HAVING COUNT(DISTINCT RetailerGeoCode) > 1)Qry
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Geography','GeoCode','Retailer Geography Wrongly Mapped-'+RetailerGeoLevel+'-'+RetailerGeoCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE NOT EXISTS (SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
	INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId WHERE A.RetailerGeoLevel = B.GeoLevelName AND A.RetailerGeoCode = C.GeoName)
	
	--Retailer Multiple Delivery Route
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
	SELECT DISTINCT CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D'
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Route','RMcode','Retailer Delivery Route Should be Same-'+CmpRtrCode FROM (
	SELECT DISTINCT CmpRtrCode,COUNT(DISTINCT DlvRouteCode) AS Counts FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	GROUP BY CmpRtrCode	HAVING COUNT(DISTINCT DlvRouteCode) >1) Qry	
	
	--Retailer Category Value Class	Validation
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)
    SELECT CmpRtrCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'RetailerValueClass','ValueClassCode','Retailer Category and Value Class Not Available-'+
	RtrChannelCode+'-'+RtrGroupCode+'-'+RtrClassCode FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS (
    SELECT DISTINCT C.CtgCode,D.CtgCode,E.ValueClassCode FROM RetailerCategoryLevel B WITH(NOLOCK)
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgLevelId = C.CtgLevelId 
    INNER JOIN RetailerCategory D WITH(NOLOCK) ON C.CtgMainId = D.CtgLinkId 
    INNER JOIN RetailerValueClass E WITH(NOLOCK) ON D.CtgMainId = E.CtgMainId WHERE A.RtrChannelCode = C.CtgCode AND
    A.RtrGroupCode = D.CtgCode AND A.RtrClassCode = E.ValueClassCode)
    -- Phone & Tin Number Dublicate Validation
	--IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
	--BEGIN
	--	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	--	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration (NOLOCK) WHERE isnull(RtrPhoneNo,'') = ''
		
	--	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	--	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Mandatory-'+ RtrCode 
	--	FROM Cn2Cs_Prk_RetailerMigration  (NOLOCK)	where isnull(RtrPhoneNo,'') = ''		
		
	--END
    	
	SELECT DISTINCT RtrPhoneNo,COUNT(RtrPhoneNo) AS Counts INTO #RtrPhoneNo FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	group BY RtrPhoneNo HAVING COUNT(RtrPhoneNo) >1	
	
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo
	where isnull(A.RtrPhoneNo,'') <> ''
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrPhoneNo','Retailer Phone Number Should be Unique-'+ A.RtrCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrPhoneNo B (NOLOCK) ON A.RtrPhoneNo = B.RtrPhoneNo	
	where isnull(A.RtrPhoneNo,'') <> ''
	--Tin Number Validation
	SELECT DISTINCT RtrTinNumber,COUNT(RtrTinNumber) AS Counts INTO #RtrTinNumber FROM Cn2Cs_Prk_RetailerMigration WITH(NOLOCK) WHERE DownloadFlag = 'D' 
	group BY RtrTinNumber HAVING COUNT(RtrTinNumber) >1
	INSERT INTO #ToAvoidRetailerMigration(RetailerCode)		
	SELECT DISTINCT CmpRtrCode from Cn2Cs_Prk_RetailerMigration A (NOLOCK) 
	INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Retailer','RtrTinNumber','Retailer Tin Number Should be Unique-'+ A.RtrCode 
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) INNER JOIN #RtrTinNumber B (NOLOCK) ON A.RtrTinNumber = B.RtrTinNumber
	WHERE isnull(A.RtrTinNumber,'') <> '' 
     	
	--To Insert the Salesman Details
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)
	
	INSERT INTO SalesmanMasterMigration (SMDCode,SMNCode,SMName,Upload,DownloadedDate)
	SELECT DISTINCT SalesmanCode,SalesmanCode AS SMCode,
	SalesManName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS 
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	INSERT INTO Salesman (SMId,SMCode,SMName,SMPhoneNumber,SMEmailID,SMOtherDetails,SMDailyAllowance,SMMonthlySalary,SMMktCredit,SMCreditDays,CmpId,
    SalesForceMainId,Status,SMCreditAmountAlert,SMCreditDaysAlert,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,HHTDeviceSerialNumber,OldSmCode) -- UAT ISSUE
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalesManName)+@SmId) AS SmId,
	SalesmanCode AS SMCode,SalesManName,0 AS SMPhoneNumer,
	'' AS SMEmailID,'' AS SMOtherDetails,0.00 AS SMDailyAllowance,0.00 AS SMMonthlySalary,0.00 AS SMMktCredit,0 AS SMCreditDays,0 AS CmpId,
	0 AS SalesForceMainId,1 AS [Status],0 AS SMCreditAmountAlert,0 AS SMCreditDaysAlert,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
	CONVERT(NVARCHAR(10),GETDATE(),121),0,'' ,SalesmanCode AS OldSMCode--CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A (NOLOCK) WHERE DownLoadFlag = 'D' AND NOT EXISTS -- UAT ISSUE
	(SELECT ISNULL(SalesmanCode,'') FROM #ToAvoidRetailerMigration B WHERE A.SalesmanCode = ISNULL(B.SalesmanCode,''))
	
	SELECT @SmId = ISNULL(MAX(SMId),0) FROM Salesman (NOLOCK)	
	UPDATE Counters SET CurrValue = @SmId WHERE TabName = 'Salesman' AND FldName = 'SMId'
	
	--To Insert the Sales Route Details 
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	SELECT @DlvRmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMasterMigration (RMSalDCode,RMSalNCode,RMSalName,RMDlvDCode,RMDlvNCode,RMDlvName,Upload,DownloadedDate)
	SELECT DISTINCT SalRouteCode,SalRouteCode AS RMCode,SalRouteName,DlvRouteCode,DlvRouteCode AS RMCode,
	DlvRouteName,0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121)
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C 
	WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,'') AND A.DlvRouteCode = ISNULL(C.DlvRouteCode,'')) 
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,OLDRmCode)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY SalRouteName)+@RmId) AS RmId,
	SalRouteCode AS RMCode,SalRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,1 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0,
	SalRouteCode AS OldRMCode   --CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(SalRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.SalRouteCode = ISNULL(C.SalRouteCode,''))
	
	--To Insert the Delivery Route Details
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,RMSRouteType,RMLocalUpcountry,RMMon,RMTue,
    RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,OldRmCode)
	SELECT DISTINCT (DENSE_RANK ()OVER (ORDER BY DlvRouteName)+@RmId) AS RmId,
	DlvRouteCode AS RMCode,DlvRouteName,@CmpId,0.00 AS RMDistance,
	0.00 AS RMPopulation,GeoMainId,1 AS RMVanRoute,2 AS RMSRouteType,1 AS RMLocalUpcountry,0 AS RMMon,0 AS RMTue,0 AS RMWed,0 AS RMThu,0 AS RMFri,
	0 AS RMSat,0 AS RMSun,1 AS RMstatus,'N' AS UpLoad,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0 ,
	DlvRouteCode AS OldRMCode  ---CRCRSTPAR0107
	FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) INNER JOIN Geography B WITH(NOLOCK) ON A.RouteGeoCode = B.GeoCode 
	WHERE DownLoadFlag = 'D' AND NOT EXISTS (SELECT ISNULL(DlvRouteCode,'') FROM #ToAvoidRetailerMigration C WHERE A.DlvRouteCode = ISNULL(C.DlvRouteCode,''))
	
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	UPDATE Counters SET CurrValue = @RmId WHERE TabName = 'RouteMaster' AND FldName = 'RMId'
	
	--Salesman Market Value Added
	INSERT INTO SalesmanMarket (SMId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT DISTINCT SMId,RmId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH(NOLOCK) ON A.SalRouteName = B.RMName 
	INNER JOIN Salesman C WITH(NOLOCK) ON A.SalesmanName = C.SMName WHERE B.RMSRouteType = 1 AND NOT EXISTS
	(SELECT SMId,RMId FROM SalesmanMarket D WITH(NOLOCK) WHERE C.SMId = D.SMId AND B.RMId = D.RMId)	
	
	
	--To Insert the Retailer Details
    SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,B.CtgMainId AS CtgLevelId,
    B.CtgCode AS CtgLevelCode,B.CtgName AS CtgLevelName,C.CtgMainId,C.CtgCode,C.CtgName,D.RtrClassId,D.ValueClassCode,D.ValueClassName,
    SalRouteName,DlvRouteName,[Status],RetailerGeoLevel,RetailerGeoCode,RtrPhoneNo,RtrTinNumber,RtrTaxGroupCode,ISNULL(E.RtrUniqueCode,'')  AS RtrUniqueCode,
    ISNULL(E.RtrCodeUserInput,'') AS RtrCodeUserInput
    INTO #RetailerMigrationDetails FROM RetailerCategoryLevel A WITH(NOLOCK) 
    INNER JOIN RetailerCategory B WITH(NOLOCK) ON A.CtgLevelId = B.CtgLevelId
    INNER JOIN RetailerCategory C WITH(NOLOCK) ON B.CtgMainId = C.CtgLinkId  
    INNER JOIN RetailerValueClass D WITH(NOLOCK) ON C.CtgMainId = D.CtgMainId 
    INNER JOIN Cn2Cs_Prk_RetailerMigration E WITH(NOLOCK) ON B.CtgCode = E.RtrChannelCode AND C.CtgCode = E.RtrGroupCode AND DownLoadFlag = 'D'
    AND D.ValueClassCode = E.RtrClassCode WHERE CmpRtrCode NOT IN (SELECT ISNULL(RetailerCode,'') FROM #ToAvoidRetailerMigration)
	
	INSERT INTO RetailerMasterMigration (SMName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPincode,RtrCtgLevelId,RtrChannelCode,
	RtrCtgMainId,RtrGroupCode,RtrValClassId,RtrClassCode,RtrGeoLevelId,RtrGeoLvelName,RtrGeoId,RtrGeoName,RtrSalRMId,RtrSalRoute,RtrDlvRMId,RtrDlvRoute,
	RtrStatus,Upload,DownloadedDate,RtrPhoneNo,RtrTinNumber,RtrTaxGroupId,RtrUniqueCode,RtrCodeUserInput)
	SELECT DISTINCT SalesManName,RtrCode,CmpRtrCode,RtrName,RtrAddress1,ISNULL(RtrAddress2,0) AS RtrAddress2,ISNULL(RtrAddress3,0) as RtrAddress3,RtrPincode,CtgLevelId,CtgLevelName,
	CtgMainId,CtgName,RtrClassId,ValueClassName,B.GeoLevelId,RetailerGeoLevel,C.GeoMainId,GeoName,D.RmId,SalRouteName,E.RmId,DlvRouteName,
	[Status],0 AS Upload,CONVERT(NVARCHAR(10),GETDATE(),121),ISNULL(RtrPhoneNo,0) AS RtrPhoneNo,ISNULL(RtrTinNumber,0) AS RtrTinNumber,---------- Null Values validation added in CS Pms id: ICRSTPAR7619
	ISNULL(TaxGroupId,0)AS RtrTaxGroupId,A.RtrUniqueCode,A.RtrCodeUserInput
	FROM #RetailerMigrationDetails A (NOLOCK) 
	INNER JOIN GeographyLevel B WITH(NOLOCK) ON A.RetailerGeoLevel = B.GeoLevelName
	INNER JOIN Geography C WITH(NOLOCK) ON A.RetailerGeoCode = C.Geoname AND B.GeoLevelId = C.GeoLevelId
	INNER JOIN RouteMaster D WITH(NOLOCK) ON A.SalRouteName = D.RMName AND D.RMSRouteType = 1
	INNER JOIN RouteMaster E WITH(NOLOCK) ON A.DlvRouteName = E.RMName AND E.RMSRouteType = 2
	LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON A.RtrTaxGroupCode = TGS.RtrGroup AND TGS.TaxGroup = 1
	WHERE CmpRtrCode NOT IN (SELECT DISTINCT CmpRtrCode FROM RetailerMasterMigration (NOLOCK))
			
	UPDATE A SET A.Upload = 1 FROM SalesmanMasterMigration A WITH(NOLOCK) INNER JOIN Salesman B WITH (NOLOCK) ON A.SMName = B.SMName 
	
	UPDATE A SET A.Upload = 1 FROM RouteMasterMigration A WITH(NOLOCK) 
	INNER JOIN RouteMaster B WITH (NOLOCK) ON A.RMSalName = B.RMName AND B.RMSRouteType = 1
	INNER JOIN RouteMaster C WITH (NOLOCK) ON A.RMDlvName = C.RMName AND C.RMSRouteType = 2
	UPDATE A SET DownloadFlag = 'Y' FROM Cn2Cs_Prk_RetailerMigration A WITH(NOLOCK) 
	INNER JOIN RetailerMasterMigration B WITH(NOLOCK) ON A.CmpRtrCode = B.CmpRtrCode
	--------------- Added  by Lakshman M Dated ON 28-12-2018 PMS ID:ILCRSTPAR2934 Default taxgroup validation added.
	SELECT  @Taxgroupid = Taxgroupid from TaxGroupSetting where RtrGroup ='RTRINTRA'
	UPDATE A set Rtrtaxgroupid =@Taxgroupid FROM RetailerMasterMigration A WHERE Rtrtaxgroupid = 0
	------------- Till here ------------
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_Retailer' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_Retailer
GO
/*
BEGIN TRAN
delete FROM RETAILERvalueclassmap where rtrid in(1,2,3,5,6)
update A set upload ='N' FROM  RETAILER A 
EXEC Proc_Cs2Cn_Retailer 0,'2020-07-20'
SELECT RtrUniqueCode,* FROM CS2CN_PRK_RETAILER 
--SELECT * FROM RETAILER
--SELECT * FROM RETAILERvalueclassmap
--SELECT 'Approval Track After upload',* FROM RetailerApprovalStatus
ROLLBACK TRAN 
*/
CREATE PROCEDURE Proc_Cs2Cn_Retailer
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
SET NOCOUNT ON
BEGIN
/*********************************
* PROCEDURE	: Proc_Cs2Cn_Retailer 0,'2016-11-11'
* PURPOSE	: Extract Retailer Details from CoreStocky to Console
* NOTES		:
* CREATED	: Nandakumar R.G 09-01-2009
* MODIFIED	:
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  10/05/2018   S.Moorthi     CR        CRCRSTPAR0001   Retailer Approval process - Manual
  05-04-2019   M. Lkashman   BZ        ILCRSTPAR3971   Retailer values class valiation included based on retailer wise upload process.
  21-05-2019   M.Lakshman    BZ        ILCRSTPAR4514   Retailer approval process trace validation included.
  07/05/2020	Murugan.R	CR		   PARCS202100016  Retailer Type Consumer added instead of HUB  
  20-07-2020    Deepan       CR        PARCS202100041   Reason and  USER INPUT added
  18-01-2021	Venkat. M	 CR		   CRCRSTPAR0107	RtrUnique code add
  01-10-2020    S.Moorthi    CR        DABCS202100016   TCS Tax amount and TCS Applicable columns added in Upload
*********************************/
	DECLARE @CmpID 		AS INTEGER
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	----Commented by Moorthi CRCRSTPAR0001 --CHANGED BY MAHESH FOR ICRSTPAR1505
	--IF EXISTS (SELECT * FROM RETAILER WHERE APPROVED=0)
	--BEGIN
	--	UPDATE RETAILER SET Approved=1 WHERE Approved=0
	--END
	----Till Here
	DELETE FROM Cs2Cn_Prk_Retailer WHERE UploadFlag = 'Y'
	SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor
	-------------------- Added by lakshman M Dated ON 05-04-2019 PMS ID: ILCRSTPAR3971 ------------- 
	INSERT INTO Cs2Cn_Prk_Retailer
	(
		DistCode ,
		RtrId ,
		RtrCode ,
		CmpRtrCode,
		RtrName ,
		RtrAddress1,
		RtrAddress2,
		RtrAddress3,
		RtrPINCode,
		RtrChannelCode ,
		RtrGroupCode ,
		RtrClassCode ,
		Status,
		KeyAccount,
		RelationStatus,
		ParentCode,
		RtrRegDate,
		GeoLevel,
		GeoLevelValue,
		VillageId,
		VillageCode,
		VillageName,
		Mode,
		DrugLNo,
		RtrFrequency,
		RtrPhoneNo,
		RtrTINNumber,
		RtrTaxGroupCode,
		RtrCrLimit,
		RtrCrDays,
		Approved,
		RtrType,
		RtrLandLine,
		ReasonCode,
		ReasonName,
		RtrCodeUserInput,
		UploadFlag,
		RtrUniqueCode
		)
		
		SELECT @DistCode ,
		R.RtrId ,
		R.RtrCode ,
		R.CmpRtrCode ,
		R.RtrName ,
		R.RtrAdd1 ,
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		RC1.CtgCode ,
		RC.CtgCode,
		RVC.ValueClassCode,
		RtrStatus,	
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','New',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),ISNULL(TGS.RtrGroup,''),R.RtrCrLimit,
		R.RtrCrDays,(CASE ISNULL(R.Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
		(CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Consumer' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END) AS RtrType,
		R.RtrLandLine,ISNULL(RAM.ReasonCode,''),ISNULL(RAM.Description,''),R.RtrCodeUserInput,'N',R.RtrUniqueCode					
		FROM Retailer R (NOLOCK)
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE (NOLOCK)
		INNER JOIN Retailer K (NOLOCK)ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN ReasonMaster RAM(NOLOCK) ON RAM.REASONID=R.Reason
		LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.Rtrid =R.Rtrid
		inner join RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
		inner join RetailerCategory RC ON RVC.CtgMainId=RC.CtgMainId
		inner join RetailerCategoryLevel RCL ON RCL.CtgLevelId=RC.CtgLevelId
		inner join RetailerCategory RC1 ON RC.CtgLinkId = RC1.CtgMainId
		WHERE R.Upload = 'N' AND  NOT EXISTS (SELECT DISTINCT RAS.RtrId FROM RetailerApprovalStatus RAS (NOLOCK) WHERE R.RtrId = RAS.RtrId)		
	UNION
	SELECT
		@DistCode ,
		RCC.RtrId,
		R.RtrCode,
		R.CmpRtrCode,
		(CASE ISNULL(RCC.RtrName,'') WHEN '' THEN R.RtrName ELSE RCC.RtrName END) AS RtrName,
		--RCC.RtrName ,
		R.RtrAdd1 ,	
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		RC1.CtgCode ,
		RC.CtgCode,
		RVC.ValueClassCode ,
		--RtrStatus,
		(CASE ISNULL(RCC.RtrStatus,2) WHEN 2 THEN R.RtrStatus ELSE RCC.RtrStatus END) AS RtrStatus,
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','AP',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),ISNULL(TGS.RtrGroup,''),R.RtrCrLimit,
        R.RtrCrDays,(CASE ISNULL(R.Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
        (CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Consumer' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END) AS RtrType,
        	R.RtrLandLine,ISNULL(RAM.ReasonCode,''),ISNULL(RAM.Description,''),R.RtrCodeUserInput,'N',R.RtrUniqueCode	
	
	FROM 
		RetailerApprovalStatus RCC (NOLOCK)	--CRCRSTPAR0001		
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=RCC.RtrId
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE (NOLOCK)
		INNER JOIN Retailer K (NOLOCK) ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN ReasonMaster RAM(NOLOCK) ON RAM.REASONID=R.Reason
		LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.Rtrid =R.Rtrid
		inner join RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
		inner join RetailerCategory RC ON RVC.CtgMainId=RC.CtgMainId
		inner join RetailerCategoryLevel RCL ON RCL.CtgLevelId=RC.CtgLevelId
		inner join RetailerCategory RC1 ON RC.CtgLinkId = RC1.CtgMainId
		WHERE RCC.Upload=0 
		
	--	RetailerClassficationChange RCC			
	--	INNER JOIN Retailer R ON R.RtrId=RCC.RtrId
	--	LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE
	--	INNER JOIN Retailer K ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
	--	LEFT OUTER JOIN TaxGroupSetting TGS (NOLOCK) ON R.TaxGroupId = TGS.TaxGroupId AND TGS.TaxGroup = 1
	--WHERE 	
	--	UpLoadFlag=0
	
	------------ commented by lakshman M dated on 05-04-2019 PMS ID: ILCRSTPAR3971 -----------
	--UPDATE ETL SET ETL.RtrChannelCode=RVC.ChannelCode,ETL.RtrGroupCode=RVC.GroupCode,ETL.RtrClassCode=RVC.ValueClassCode
	--FROM Cs2Cn_Prk_Retailer ETL,
	--(
	--	SELECT R.RtrId,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode ,RVC.ValueClassCode
	--	FROM
	--	RetailerValueClassMap RVCM ,
	--	RetailerValueClass RVC	,
	--	RetailerCategory RC ,
	--	RetailerCategoryLevel RCL,
	--	RetailerCategory RC1,
	--	Retailer R  		
	--WHERE
	--	R.Rtrid = RVCM.RtrId
	--	AND	RVCM.RtrValueClassId = RVC.RtrClassId
	--	AND	RVC.CtgMainId=RC.CtgMainId
	--	AND	RCL.CtgLevelId=RC.CtgLevelId
	--	AND	RC.CtgLinkId = RC1.CtgMainId
	--) AS RVC
	--WHERE ETL.RtrId=RVC.RtrId
	--------------------- Till here  -------------
	
	UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoName,'') AS GeoName
		FROM			
		Retailer R  		
		LEFT OUTER JOIN Geography G (NOLOCK) ON R.GeoMainId=G.GeoMainId  
		LEFT OUTER JOIN GeographyLevel GL(NOLOCK) ON GL.GeoLevelId=G.GeoLevelId  
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId	
	
	UPDATE ETL SET ETL.VillageId=V.VillageId,ETL.VillageCode=V.VillageCode,ETL.VillageName=V.VillageName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,R.VillageId,V.VillageCode,V.VillageName
		FROM			
		Retailer R  		
		INNER JOIN RouteVillage V ON R.VillageId=V.VillageId
	) V
	WHERE ETL.RtrId=V.RtrId	
	
	--Added By MohanaKrishna A.B For GST
	Update Cs2Cn_Prk_Retailer SET StateName='' where StateName is Null
	Update Cs2Cn_Prk_Retailer SET GSTTIN ='' where GSTTIN is Null
	Update Cs2Cn_Prk_Retailer SET PanNumber ='' where PanNumber is Null
	Update Cs2Cn_Prk_Retailer SET RetailerType ='' where RetailerType is Null
	Update Cs2Cn_Prk_Retailer SET Composite ='' where Composite is Null
	Update Cs2Cn_Prk_Retailer SET RelatedParty ='' where RelatedParty is Null
	----
	
	--Added By Mohana For GST
	SELECT C.MasterRecordId,B.ColumnName,ISNULL(C.ColumnValue,'') ColumnValue INTO #RtrUDC FROM UdcHD A 
	INNER JOIN UdcMaster B ON A.MasterId=B.MasterId AND A.MasterName='Retailer Master'
	INNER JOIN UdcDetails C ON A.MasterId= C.MasterId AND B.UdcMasterId=C.UdcMasterId --AND masterrecordid =445
	INNER JOIN Retailer R ON R.RtrId =C.MasterRecordId AND B.ColumnName IN ('State name','GSTIN',
	'PAN Number','Retailer Type','Related Party','Composition','Aadhaar','TCS Applicable')

	UPDATE A SET StateName =ISNULL(C.ColumnValue,'') FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='State Name'
	UPDATE A SET GSTTIN = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='GSTIN'
	UPDATE A SET PanNumber = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='PAN Number'
	UPDATE A SET RetailerType = ISNULL(C.ColumnValue,'') FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Retailer Type'
	UPDATE A SET RelatedParty = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Related Party'
	UPDATE A SET Composite = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Composition'

	Update Cs2Cn_Prk_Retailer SET Aadhaar ='' where Aadhaar is Null
	Update Cs2Cn_Prk_Retailer SET TCSApplicable ='' where TCSApplicable is Null
	
	UPDATE A SET Aadhaar = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='Aadhaar'
	
	UPDATE A SET TCSApplicable = ISNULL(C.ColumnValue,'')  FROM Cs2Cn_Prk_Retailer A INNER JOIN Retailer B ON A.RtrCode=B.RtrCode
	INNER JOIN #RtrUDC C ON B.RtrId = C.MasterRecordid AND ColumnName ='TCS Applicable'
	--Till Here
	 --Added By lakshman M DAted ON 21-05-2019 PMS ID: ILCRSTPAR4514  
	 INSERT INTO RetailerApprovalStatus_Trace (RtrId,Rtrctgid,Rtrclassid,Rtrstatus,Rtrname,Geoid,Upload,Mode,ModDate,Uploadeddate)  
	 SELECT R.RtrId,R.Rtrctgid,R.Rtrclassid,R.Rtrstatus,R.Rtrname,R.Geoid,R.Upload,R.Mode,R.ModDate,GETDATE() AS Uploadeddate  
	 FROM RetailerApprovalStatus R (NOLOCK) WHERE R.Upload=0  
	 --------- Till here -------  
	--Added By S.Moorthi	
	SELECT R.RtrId,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode,RVC.ValueClassCode 
	INTO #TempCategory	
		   FROM
		   RetailerValueClass RVC (NOLOCK),  
		   RetailerCategory RC (NOLOCK) ,  
		   RetailerCategoryLevel RCL (NOLOCK),  
		   RetailerCategory RC1 (NOLOCK),    
		   RetailerApprovalStatus R (NOLOCK)  
		WHERE			
			R.RtrClassId = RVC.RtrClassId
			AND	RVC.CtgMainId=RC.CtgMainId
			AND	RCL.CtgLevelId=RC.CtgLevelId
			AND	RC.CtgLinkId = RC1.CtgMainId
			AND ISNULL(R.RtrClassId,0)<>0
			AND R.Upload=0
			
	UPDATE ETL SET ETL.RtrChannelCode=RVC.ChannelCode,ETL.RtrGroupCode=RVC.GroupCode,
	ETL.RtrClassCode=RVC.ValueClassCode
	FROM Cs2Cn_Prk_Retailer ETL (NOLOCK) 
	INNER JOIN RetailerApprovalStatus RAS (NOLOCK) ON ETL.RtrId=RAS.RtrId 
 	INNER JOIN #TempCategory RVC (NOLOCK) ON RVC.RtrId=ETL.RtrId and RVC.RtrId=RAS.RtrId  
	WHERE ETL.UploadFlag='N' AND RAS.Upload=0
	
	UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoName
	FROM Cs2Cn_Prk_Retailer ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoName,'') AS GeoName
		FROM			
		Retailer R  	
		INNER JOIN RetailerApprovalStatus RAS (NOLOCK) ON R.RtrId=RAS.RtrId 	
		LEFT OUTER JOIN Geography G ON R.GeoMainId=G.GeoMainId
  		LEFT OUTER JOIN GeographyLevel GL (NOLOCK) ON GL.GeoLevelId=G.GeoLevelId  
		WHERE ISNULL(RAS.Geoid,0)<>0  AND RAS.Upload=0
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId
	--UPDATE Cs2Cn_Prk_Retailer SET Mode = 'CR' WHERE ISNULL(Approved,'PENDING') IN ('APPROVED','REJECTED') AND Mode = 'New' AND UploadFlag='N'
	--UPDATE Cs2Cn_Prk_Retailer SET Mode = 'New' WHERE ISNULL(Approved,'PENDING') NOT IN ('APPROVED','REJECTED') AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'CR' WHERE ISNULL(Approved,'PENDING') IN ('APPROVED') AND Mode = 'New' AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'New' WHERE ISNULL(Approved,'PENDING') IN ('PENDING','REJECTED') AND UploadFlag='N'
	UPDATE Cs2Cn_Prk_Retailer SET Mode = 'SFA' WHERE ISNULL(RtrUniqueCode,'') ='' AND UploadFlag='N'
	--Till Here
	
	UPDATE Retailer SET Upload='Y' WHERE Upload='N'
	AND CmpRtrCode IN(SELECT CmpRtrCode FROM Cs2Cn_Prk_Retailer WHERE UploadFlag='N') --WHERE Mode='New')
	
	UPDATE RetailerClassficationChange SET UpLoadFlag=1 WHERE UpLoadFlag=0
	AND RtrCode IN(SELECT RtrCode FROM Cs2Cn_Prk_Retailer WHERE Mode='AP' AND UploadFlag='N')
	
	UPDATE RetailerApprovalStatus SET Upload=1 WHERE Upload=0
	AND RtrId IN(SELECT RtrId FROM Cs2Cn_Prk_Retailer WHERE Mode='AP' AND UploadFlag='N')
	
	UPDATE Cs2Cn_Prk_Retailer SET ServerDate=@ServerDate
	 ----------- added by lakshman M Dated ON 21-05-2019 PMS ID: ILCRSTPAR4514  
	 INSERT INTO Cs2Cn_Prk_Retailer_trace (DistCode,RtrId,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPINCode,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,   
	 ParentCode,RtrRegDate,GeoLevel,GeoLevelValue,VillageId,VillageCode,VillageName,Status,Mode,DrugLNo,RtrFrequency,RtrPhoneNo,RtrTINNumber,RtrTaxGroupCode,RtrCrLimit,RtrCrDays,   
	 Approved,RtrType,UploadFlag,SyncId,ServerDate,StateName,GSTTIN,PanNumber,RetailerType,Composite,RelatedParty,Uploadeddate)  
	 SELECT DistCode,RtrId,RtrCode,CmpRtrCode,RtrName,RtrAddress1,RtrAddress2,RtrAddress3,RtrPINCode,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,   
	 ParentCode,RtrRegDate,GeoLevel,GeoLevelValue,VillageId,VillageCode,VillageName,Status,Mode,DrugLNo,RtrFrequency,RtrPhoneNo,RtrTINNumber,RtrTaxGroupCode,RtrCrLimit,RtrCrDays,   
	 Approved,RtrType,UploadFlag,SyncId,ServerDate,StateName,GSTTIN,PanNumber,RetailerType,Composite,RelatedParty,GETDATE() AS Uploadeddate FROM Cs2Cn_Prk_Retailer (NOLOCK) WHERE UploadFlag ='N'  
	 -------------- Till here -----------------------  
END
GO
DELETE FROM CustomCaptions WHERE TransId =504 AND ctrlname ='MsgBox-504-1000-10'
INSERT INTO customcaptions
SELECT 504,1000,10,'MsgBox-504-1000-10','','','No Claim Is Available',1,1,1,GETDATE(),1,GETDATE(),'','','No Claim Is Available',1,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CS2CNMonthEndClosingStock' AND TYPE='P')
DROP PROCEDURE Proc_CS2CNMonthEndClosingStock
GO
--EXEC Proc_CS2CNMonthEndClosingStock 0
CREATE PROCEDURE Proc_CS2CNMonthEndClosingStock
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_CS2CNMonthEndClosingStock
* PURPOSE	: To Get Stock Ledger Detail
* CREATED	: Murugan.R
* CREATED DATE	: 17/09/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}		{developer}  {brief modification description}
* 06-01-2021	MOHANA	 BZ		UAT ISSUE	INcluded Serverdate 
*********************************/
SET NOCOUNT ON
BEGIN
    SET @Po_ErrNo = 0
	DECLARE @CmpID 		AS INTEGER
	DECLARE @DistCode	As nVarchar(50)
	DECLARE @ChkDate	AS DATETIME	
	DECLARE @Pi_ToDate AS DATETIME
	DECLARE @Pi_ToDate1 AS DATETIME
	DECLARE @Pi_FromDate AS DATETIME

	DECLARE @Date AS DATETIME

	SET @Date = GETDATE()
	
	SELECT @DistCode = DistributorCode FROM Distributor

	DELETE FROM CS2CN_Prk_MonthEndClosingStock WHERE UploadFlag='Y'

	IF EXISTS(SELECT StkMonth,StkYear FROM MonthEndClosing WHERE UploadFlag='N')	
	BEGIN

		EXEC Proc_CS2CN_CurrentStockSnapShot 0,@Date 

		SELECT @Pi_ToDate1=CONVERT(DATETIME,CONVERT(VARCHAR(10),DBO.Fn_ReturnLastMonthEndDate(Getdate()),121),121)
		
		SET @Pi_ToDate=@Pi_ToDate1
		
		SELECT @Pi_FromDate =DATEADD(mm, DATEDIFF(mm,0,@Pi_ToDate1), 0)
	
	
	CREATE TABLE #CS2CN_Prk_MonthEndClosingStock(
	Transdate Datetime,
	[PrdId] [int] NULL,
	[PrdCode] [nvarchar](100)  COLLATE DATABASE_DEFAULT,
	[PrdName] [nvarchar](100)  COLLATE DATABASE_DEFAULT,
	[PrdBatId] [int] NULL,
	[PrdBatchCode] [nvarchar](100)  COLLATE DATABASE_DEFAULT,
	[MRP] Numeric(36,6),
	[CLP] Numeric (36,6),
	OpeningSales Numeric(36,0),
	OpeningUnSaleable Numeric(36,0),
	OpenignOffer Numeric(36,0),
	PurchaseSales	Numeric(36,0),
	PurchaseUnSaleable Numeric(36,0),
	PurchaseOffer Numeric(36,0),
	InvoiceSales Numeric(36,0),
	InvoiceUnSaleable Numeric(36,0),
	InvoiceOffer Numeric(36,0),
	[SalPurReturn] [numeric](18, 0) NULL,
	[UnsalPurReturn] [numeric](18, 0) NULL,
	[OfferPurReturn] [numeric](18, 0) NULL,
	[SalStockIn] [numeric](18, 0) NULL,
	[UnSalStockIn] [numeric](18, 0) NULL,
	[OfferStockIn] [numeric](18, 0) NULL,
	[SalStockOut] [numeric](18, 0) NULL,
	[UnSalStockOut] [numeric](18, 0) NULL,
	[OfferStockOut] [numeric](18, 0) NULL,
	[DamageIn] [numeric](18, 0) NULL,
	[DamageOut] [numeric](18, 0) NULL,
	[SalSalesReturn] [numeric](18, 0) NULL,
	[UnSalSalesReturn] [numeric](18, 0) NULL,
	[OfferSalesReturn] [numeric](18, 0) NULL,
	[SalStkJurIn] [numeric](18, 0) NULL,
	[UnSalStkJurIn] [numeric](18, 0) NULL,
	[OfferStkJurIn] [numeric](18, 0) NULL,
	[SalStkJurOut] [numeric](18, 0) NULL,
	[UnSalStkJurOut] [numeric](18, 0) NULL,
	[OfferStkJurOut] [numeric](18, 0) NULL,
	[SalBatTfrIn] [numeric](18, 0) NULL,
	[UnSalBatTfrIn] [numeric](18, 0) NULL,
	[OfferBatTfrIn] [numeric](18, 0) NULL,
	[SalBatTfrOut] [numeric](18, 0) NULL,
	[UnSalBatTfrOut] [numeric](18, 0) NULL,
	[OfferBatTfrOut] [numeric](18, 0) NULL,
	[SalLcnTfrIn] [numeric](18, 0) NULL,
	[UnSalLcnTfrIn] [numeric](18, 0) NULL,
	[OfferLcnTfrIn] [numeric](18, 0) NULL,
	[SalLcnTfrOut] [numeric](18, 0) NULL,
	[UnSalLcnTfrOut] [numeric](18, 0) NULL,
	[OfferLcnTfrOut] [numeric](18, 0) NULL,
	[SalReplacement] [numeric](18, 0) NULL,
	[OfferReplacement] [numeric](18, 0) NULL,
	ClosingSales Numeric(36,0),
	ClosingUnSaleable Numeric(36,0),
	ClosingOffer Numeric(36,0),
	SecondarySales  Numeric(36,6),
	LastInvoiceNumber Varchar(50),
	LastInvoiceDate Datetime,
	StockInTrans Numeric(36,0)
	)
	
	SELECT Prdid,Prdbatid,LcnId,Max(Transdate) as TransDate INTO #Stock1 FROM STOCKLEDGER
	WHERE TransDate < @Pi_FromDate
	GROUP BY Prdid,Prdbatid,LcnId
	SELECT Prdid,Prdbatid,LcnId,Max(Transdate) as TransDate INTO #Stock2 FROM STOCKLEDGER
	WHERE TransDate <= @Pi_ToDate
	GROUP BY Prdid,Prdbatid,LcnId
	SELECT Transdate,Prdid,Prdbatid,
	SUM(SalesOpening) as SalesOpening,SUM(UnSaleableOpening) as UnSaleableOpening,SUM(OfferOpening) as OfferOpening,
	SUM(SalPurchase) as SalPurchase,SUM(UnsalPurchase) as UnsalPurchase,SUM(OfferPurchase) as OfferPurchase,
	SUM(SalSales) as SalSales, SUM(UnSalSales) as UnSalSales , SUM(OfferSales) as OfferSales,
	SUM([SalPurReturn]) as [SalPurReturn] ,SUM([UnsalPurReturn]) as [UnsalPurReturn] ,SUM([OfferPurReturn] ) as [OfferPurReturn],
	SUM([SalStockIn] ) as [SalStockIn],SUM([UnSalStockIn] ) as [UnSalStockIn],SUM([OfferStockIn] ) as [OfferStockIn],
	SUM([SalStockOut] ) as [SalStockOut],SUM([UnSalStockOut] ) as [UnSalStockOut],SUM([OfferStockOut] ) as [OfferStockOut],
	SUM([DamageIn] ) as [DamageIn],SUM([DamageOut] ) as [DamageOut],
	SUM([SalSalesReturn] ) as [SalSalesReturn],SUM([UnSalSalesReturn] ) as [UnSalSalesReturn],SUM([OfferSalesReturn] ) as [OfferSalesReturn],
	SUM([SalStkJurIn] ) as [SalStkJurIn],SUM([UnSalStkJurIn] ) as [UnSalStkJurIn],SUM([OfferStkJurIn] ) as [OfferStkJurIn],
	SUM([SalStkJurOut] ) as [SalStkJurOut],SUM([UnSalStkJurOut] ) as [UnSalStkJurOut],SUM([OfferStkJurOut] ) as [OfferStkJurOut],
	SUM([SalBatTfrIn] ) as [SalBatTfrIn],SUM([UnSalBatTfrIn] ) as [UnSalBatTfrIn],SUM([OfferBatTfrIn] ) as [OfferBatTfrIn],
	SUM([SalBatTfrOut] ) as [SalBatTfrOut],SUM([UnSalBatTfrOut] ) as [UnSalBatTfrOut],SUM([OfferBatTfrOut] ) as [OfferBatTfrOut],
	SUM([SalLcnTfrIn] ) as [SalLcnTfrIn],SUM([UnSalLcnTfrIn] ) as [UnSalLcnTfrIn],SUM([OfferLcnTfrIn] ) as [OfferLcnTfrIn],
	SUM([SalLcnTfrOut] ) as [SalLcnTfrOut],SUM([UnSalLcnTfrOut] ) as [UnSalLcnTfrOut],SUM([OfferLcnTfrOut] ) as [OfferLcnTfrOut],
	SUM([SalReplacement] ) as [SalReplacement],SUM([OfferReplacement] ) as [OfferReplacement],
	SUM(SalClsStock) as SalClsStock,SUM(UnSalClsStock) as UnSalClsStock,
	SUM(OfferClsStock) as OfferClsStock,0 as MRP,0 as CLP
	INTO #StockSummary 
	FROM(
		SELECT @Pi_ToDate  as TransDate,
		ST.PrdId,St.Prdbatid,SUM(SalClsStock) as SalesOpening,SUM(UnSalClsStock) as UnSaleableOpening,
		SUM(OfferClsStock) as OfferOpening,0 as SalPurchase,0 as UnsalPurchase,0 as  OfferPurchase,
		0 as SalSales,0 as UnSalSales ,0 as OfferSales,
		0 as [SalPurReturn] ,
		0 as [UnsalPurReturn] ,
		0 as [OfferPurReturn] ,
		0 as [SalStockIn] ,
		0 as [UnSalStockIn] ,
		0 as [OfferStockIn] ,
		0 as [SalStockOut] ,
		0 as [UnSalStockOut] ,
		0 as [OfferStockOut] ,
		0 as [DamageIn] ,
		0 as [DamageOut] ,
		0 as [SalSalesReturn] ,
		0 as [UnSalSalesReturn] ,
		0 as [OfferSalesReturn] ,
		0 as [SalStkJurIn] ,
		0 as [UnSalStkJurIn] ,
		0 as [OfferStkJurIn] ,
		0 as [SalStkJurOut] ,
		0 as [UnSalStkJurOut] ,
		0 as [OfferStkJurOut] ,
		0 as [SalBatTfrIn] ,
		0 as [UnSalBatTfrIn] ,
		0 as [OfferBatTfrIn] ,
		0 as [SalBatTfrOut] ,
		0 as [UnSalBatTfrOut] ,
		0 as [OfferBatTfrOut] ,
		0 as [SalLcnTfrIn] ,
		0 as [UnSalLcnTfrIn] ,
		0 as [OfferLcnTfrIn] ,
		0 as [SalLcnTfrOut] ,
		0 as [UnSalLcnTfrOut] ,
		0 as [OfferLcnTfrOut] ,
		0 as [SalReplacement] ,
		0 as [OfferReplacement] ,		
		0 as SalClsStock,0 as UnSalClsStock,0 as OfferClsStock
		FROM STOCKLEDGER ST
		INNER JOIN #Stock1 X ON X.Prdid=ST.Prdid and X.Prdbatid=ST.Prdbatid
		and X.Lcnid=ST.LcnId and X.Transdate=ST.Transdate		
		GROUP BY ST.PrdId,St.Prdbatid
				
		UNION ALL	
			
		SELECT @Pi_ToDate as TransDate,
		ST.PrdId,ST.Prdbatid,0 as SalesOpening,0 as UnSaleableOpening,0 as OfferOpening,
		0 as SalPurchase,0 as UnsalPurchase,0 as  OfferPurchase,
		0 as SalSales,0 as UnSalSales ,0 as OfferSales,
		0 as [SalPurReturn] ,
		0 as [UnsalPurReturn] ,
		0 as [OfferPurReturn] ,
		0 as [SalStockIn] ,
		0 as [UnSalStockIn] ,
		0 as [OfferStockIn] ,
		0 as [SalStockOut] ,
		0 as [UnSalStockOut] ,
		0 as [OfferStockOut] ,
		0 as [DamageIn] ,
		0 as [DamageOut] ,
		0 as [SalSalesReturn] ,
		0 as [UnSalSalesReturn] ,
		0 as [OfferSalesReturn] ,
		0 as [SalStkJurIn] ,
		0 as [UnSalStkJurIn] ,
		0 as [OfferStkJurIn] ,
		0 as [SalStkJurOut] ,
		0 as [UnSalStkJurOut] ,
		0 as [OfferStkJurOut] ,
		0 as [SalBatTfrIn] ,
		0 as [UnSalBatTfrIn] ,
		0 as [OfferBatTfrIn] ,
		0 as [SalBatTfrOut] ,
		0 as [UnSalBatTfrOut] ,
		0 as [OfferBatTfrOut] ,
		0 as [SalLcnTfrIn] ,
		0 as [UnSalLcnTfrIn] ,
		0 as [OfferLcnTfrIn] ,
		0 as [SalLcnTfrOut] ,
		0 as [UnSalLcnTfrOut] ,
		0 as [OfferLcnTfrOut] ,
		0 as [SalReplacement] ,
		0 as [OfferReplacement] ,
		--0 as Adjustments,
		SUM(SalClsStock) as SalClsStock,SUM(UnSalClsStock) as UnSalClsStock,
		SUM(OfferClsStock) as OfferClsStock 
		FROM STOCKLEDGER ST
		INNER JOIN  #Stock2 X ON X.Prdid=ST.Prdid and X.Prdbatid=ST.Prdbatid
		and X.Lcnid=ST.LcnId and X.Transdate=ST.Transdate
		GROUP BY ST.PrdId,St.Prdbatid
		
		UNION ALL
		
		SELECT @Pi_ToDate as TransDate,Sl.PrdId,Sl.PrdBatId,
		0 as SalesOpening,0 as UnSaleableOpening,0 as OfferOpening,
		SUM(Sl.SalPurchase) as SalPurchase,SUM(Sl.UnsalPurchase) as UnsalPurchase,SUM(Sl.OfferPurchase) as OfferPurchase,
		SUM(Sl.SalSales) as SalSales,SUM(Sl.UnSalSales) as UnSalSales,SUM(Sl.OfferSales) as OfferSales,		
		SUM([SalPurReturn]) ,
		SUM([UnsalPurReturn]) ,
		SUM([OfferPurReturn] ),
		SUM([SalStockIn] ),
		SUM([UnSalStockIn] ),
		SUM([OfferStockIn] ),
		SUM([SalStockOut] ),
		SUM([UnSalStockOut] ),
		SUM([OfferStockOut] ),
		SUM([DamageIn] ),
		SUM([DamageOut] ),
		SUM([SalSalesReturn] ),
		SUM([UnSalSalesReturn] ),
		SUM([OfferSalesReturn] ),
		SUM([SalStkJurIn] ),
		SUM([UnSalStkJurIn] ),
		SUM([OfferStkJurIn] ),
		SUM([SalStkJurOut] ),
		SUM([UnSalStkJurOut] ),
		SUM([OfferStkJurOut] ),
		SUM([SalBatTfrIn] ),
		SUM([UnSalBatTfrIn] ),
		SUM([OfferBatTfrIn] ),
		SUM([SalBatTfrOut] ),
		SUM([UnSalBatTfrOut] ),
		SUM([OfferBatTfrOut] ),
		SUM([SalLcnTfrIn] ),
		SUM([UnSalLcnTfrIn] ),
		SUM([OfferLcnTfrIn] ),
		SUM([SalLcnTfrOut] ),
		SUM([UnSalLcnTfrOut] ),
		SUM([OfferLcnTfrOut] ),
		SUM([SalReplacement] ),
		SUM([OfferReplacement] ),	
		0 as SalClsStock,0 as UnSalClsStock,0 as OfferClsStock
	
		--SUM((-Sl.SalPurReturn-Sl.UnsalPurReturn-Sl.OfferPurReturn+Sl.SalStockIn+Sl.UnSalStockIn+Sl.OfferStockIn-
		--Sl.SalStockOut-Sl.UnSalStockOut-Sl.OfferStockOut+Sl.SalSalesReturn+Sl.UnSalSalesReturn+Sl.OfferSalesReturn+
		--Sl.SalStkJurIn+Sl.UnSalStkJurIn+Sl.OfferStkJurIn-Sl.SalStkJurOut-Sl.UnSalStkJurOut-Sl.OfferStkJurOut+
		--Sl.SalBatTfrIn+Sl.UnSalBatTfrIn+Sl.OfferBatTfrIn-Sl.SalBatTfrOut-Sl.UnSalBatTfrOut-Sl.OfferBatTfrOut+
		--Sl.SalLcnTfrIn+Sl.UnSalLcnTfrIn+Sl.OfferLcnTfrIn-Sl.SalLcnTfrOut-Sl.UnSalLcnTfrOut-Sl.OfferLcnTfrOut-
		--Sl.SalReplacement-Sl.OfferReplacement+Sl.DamageIn-Sl.DamageOut)) AS Adjustments,
		--0 as SalClsStock,0 as UnSalClsStock,0 as OfferClsStock
		FROM StockLedger Sl WHERE Sl.TransDate BETWEEN @Pi_FromDate AND  @Pi_ToDate	
		GROUP BY Sl.PrdId,Sl.PrdBatId
		)X GROUP BY  Transdate,Prdid,Prdbatid
	
	
			
		DELETE FROM #CS2CN_Prk_MonthEndClosingStock 
	
	--      Stocks for the given date---------
		INSERT INTO #CS2CN_Prk_MonthEndClosingStock
		(Transdate,PrdId,PrdCode,PrdName,PrdBatId,PrdBatchCode,
		MRP,CLP,OpeningSales,OpeningUnSaleable,OpenignOffer,
		PurchaseSales,PurchaseUnSaleable,PurchaseOffer,
		InvoiceSales,InvoiceUnSaleable,InvoiceOffer,
		[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
		[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
		[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
		[DamageIn] ,[DamageOut] ,
		[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
		[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
		[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
		[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
		[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
		[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
		[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
		[SalReplacement] ,[OfferReplacement] ,ClosingSales,ClosingUnSaleable,
		ClosingOffer,SecondarySales,
		LastInvoiceNumber,LastInvoiceDate,StockInTrans)
					
		SELECT Transdate,P.PrdId,PrdcCode,PrdName,pb.PrdBatId,PrdBatCode,
		MRP,CLP,SalesOpening,UnSaleableOpening,OfferOpening,
		SalPurchase,UnsalPurchase,OfferPurchase,
		SalSales,UnSalSales,OfferSales,[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
		[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
		[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
		[DamageIn] ,[DamageOut] ,
		[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
		[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
		[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
		[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
		[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
		[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
		[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
		[SalReplacement] ,[OfferReplacement],
		SalClsStock,UnSalClsStock,OfferClsStock,0 as SecondarySales,'' as LastInvoiceNumber,
		Getdate() as LastInvoiceDate,0 as StockInTrans
		FROM #StockSummary S INNER JOIN Product P ON S.Prdid=P.PrdId
		INNER JOIN ProductBatch PB ON P.PrdId=PB.PrdId and S.PrdBatId=PB.PrdBatId
		
	
	SELECT Prdid,Prdbatid,PriceId,Status,SUM(SelRte) as SelRte,SUM(ListPrice) as ListPrice,SUM(MRP) as MRP
	INTO #Productbatch
	FROM(
		SELECT Prdid,P.Prdbatid,PriceId,Status,PrdBatDetailValue as SelRte,0 as ListPrice,0 as MRP   FROM BatchCreation BC 
		INNER JOIN ProductBatch P  ON BC.BatchSeqId=P.BatchSeqId
		INNER JOIN ProductBatchDetails PB ON P.PrdBatId=PB.PrdBatId and P.DefaultPriceId=PB.PriceId
		and BC.SlNo=pb.SLNo WHERE DefaultPrice=1 and Bc.SelRte=1
		UNION ALL
		SELECT Prdid,P.Prdbatid,PriceId,Status, 0 as SelRte,PrdBatDetailValue as ListPrice,0 as MRP  FROM BatchCreation BC 
		INNER JOIN ProductBatch P  ON BC.BatchSeqId=P.BatchSeqId
		INNER JOIN ProductBatchDetails PB ON P.PrdBatId=PB.PrdBatId and P.DefaultPriceId=PB.PriceId
		and BC.SlNo=pb.SLNo WHERE DefaultPrice=1 and Bc.ListPrice=1
		UNION ALL
		SELECT Prdid,P.Prdbatid,PriceId,Status,0 as SelRte,0 as ListPrice,PrdBatDetailValue as MRP  FROM BatchCreation BC 
		INNER JOIN ProductBatch P  ON BC.BatchSeqId=P.BatchSeqId
		INNER JOIN ProductBatchDetails PB ON P.PrdBatId=PB.PrdBatId and P.DefaultPriceId=PB.PriceId
		and BC.SlNo=pb.SLNo WHERE DefaultPrice=1 and Bc.MRP=1
	) X GROUP BY 	Prdid,Prdbatid,PriceId,Status
	
	Update A Set A.MRP=B.MRP, A.CLP=b.ListPrice,SecondarySales=(InvoiceSales*b.ListPrice)
	FROM #CS2CN_Prk_MonthEndClosingStock A INNER JOIN #Productbatch B
	ON A.PrdId=B.PrdId and A.PrdBatId=B.PrdBatId
	
	
	SELECT Prdid,PrdbatId,SUM(InvBaseQty) as  InvBaseQty INTO #StkTransIn 
	FROM(
		SELECT Prdid,Prdbatid, SUM(InvBaseQty) as InvBaseQty
		FROM PurchaseReceipt P INNER JOIN PurchaseReceiptProduct PR ON P.PurRcptId=PR.PurRcptId
		WHERE InvDate Between @Pi_FromDate AND  @Pi_ToDate and Status=0
		GROUP BY Prdid,Prdbatid
		UNION ALL
		SELECT PR.Prdid,Prdbatid, SUM(InvQty*U.ConversionFactor) as InvBaseQty
		FROM ETLTempPurchaseReceipt P INNER JOIN ETLTempPurchaseReceiptProduct PR ON P.CmpInvNo=PR.CmpInvNo
		INNER JOIN Product Pd ON Pd.PrdId=Pr.Prdid
		INNER JOIN UomGroup U ON U.UomGroupId=Pd.UomGroupId and U.UomId=Pr.InvUOMId
		WHERE InvDate Between @Pi_FromDate AND  @Pi_ToDate and DownLoadStatus=0
		and P.CmpInvNo NOT IN(SELECT CmpInvNo FROM PurchaseReceipt )
		GROUP BY PR.Prdid,Prdbatid
	)X GROUP  BY Prdid,PrdbatId
	
	
	Update CS  SET StockInTrans=InvBaseQty 
	FROM #CS2CN_Prk_MonthEndClosingStock CS INNER JOIN #StkTransIn St ON CS.Prdid=St.PrdId
	and Cs.PrdBatId=St.PrdBatId
	
	
	SELECT P.CmpInvno,P.Invdate INTO #Purchase
	FROM PurchaseReceipt P INNER JOIN ( 
	Select MAX(PurRcptId)  as  PurRcptId 
	FROM  PurchaseReceipt WHERE InvDate Between @Pi_FromDate AND  @Pi_ToDate  and Status=1)X
	ON P.PurRcptId=X.PurRcptId
	
	Update CS set LastInvoiceDate=Invdate,LastInvoiceNumber=CmpInvno
	FROM #Purchase,#CS2CN_Prk_MonthEndClosingStock CS
	
	INSERT INTO CS2CN_Prk_MonthEndClosingStock(DistCode,StkMonth,StkYear,
	PrdCode,PrdName,PrdBatchCode,MRP,CLP,OpeningSales,OpeningUnSaleable,
	OpenignOffer,PurchaseSales,PurchaseUnSaleable,PurchaseOffer,InvoiceSales,
	InvoiceUnSaleable,InvoiceOffer,[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
	[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
	[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
	[DamageIn] ,[DamageOut] ,
	[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
	[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
	[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
	[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
	[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
	[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
	[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
	[SalReplacement] ,[OfferReplacement],ClosingSales,ClosingUnSaleable,
	ClosingOffer,SecondarySales,LastInvoiceNumber,LastInvoiceDate,StockInTrans,UploadFlag)
	SELECT @DistCode as DistCode,StkMonth,StkYear,
	PrdCode,PrdName,PrdBatchCode,MRP,CLP,OpeningSales,OpeningUnSaleable,
	OpenignOffer,PurchaseSales,PurchaseUnSaleable,PurchaseOffer,InvoiceSales,
	InvoiceUnSaleable,InvoiceOffer,[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
	[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
	[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
	[DamageIn] ,[DamageOut] ,
	[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
	[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
	[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
	[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
	[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
	[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
	[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
	[SalReplacement] ,[OfferReplacement],ClosingSales,ClosingUnSaleable,
	ClosingOffer,SecondarySales,LastInvoiceNumber,LastInvoiceDate,StockInTrans,'N' as UploadFlag
	FROM #CS2CN_Prk_MonthEndClosingStock  CROSS JOIN MonthEndClosing  
	WHERE (OpeningSales+OpeningUnSaleable+OpenignOffer+PurchaseSales+PurchaseUnSaleable+PurchaseOffer+InvoiceSales+
			InvoiceUnSaleable+InvoiceOffer+[SalPurReturn]+[UnsalPurReturn]+[OfferPurReturn] +
			[SalStockIn] +[UnSalStockIn] +[OfferStockIn] +
			[SalStockOut] +	[UnSalStockOut]+[OfferStockOut] +
			[DamageIn]+[DamageOut] +
			[SalSalesReturn] +[UnSalSalesReturn] +[OfferSalesReturn]+
			[SalStkJurIn] +	[UnSalStkJurIn] +[OfferStkJurIn]+
			[SalStkJurOut] +[UnSalStkJurOut] +[OfferStkJurOut] +
			[SalBatTfrIn] +	[UnSalBatTfrIn] +[OfferBatTfrIn] +
			[SalBatTfrOut] +[UnSalBatTfrOut] +[OfferBatTfrOut] +
			[SalLcnTfrIn] +	[UnSalLcnTfrIn] +[OfferLcnTfrIn] +
			[SalLcnTfrOut] +[UnSalLcnTfrOut] +[OfferLcnTfrOut] +
		[SalReplacement] +[OfferReplacement]+ClosingSales+ClosingUnSaleable+ClosingOffer+StockInTrans)>0
	AND UploadFlag='N'
		
	UPDATE MonthEndClosing SET UploadFlag='Y'
	
	DELETE A FROM MonthEndClosingStockSnapShot A WHERE EXISTS(SELECT StkMonth,StkYear FROM CS2CN_Prk_MonthEndClosingStock B WHERE A.StkMonth=B.StkMonth and A.StkYear=B.StkYear)
	
	INSERT INTO MonthEndClosingStockSnapShot
	(StkMonth,StkYear,PrdCode,PrdName,
	PrdBatchCode,MRP,CLP,
	OpeningSales,OpeningUnSaleable,OpenignOffer,
	PurchaseSales,PurchaseUnSaleable,PurchaseOffer,
	InvoiceSales,InvoiceUnSaleable,InvoiceOffer,
	[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
	[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
	[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
	[DamageIn] ,[DamageOut] ,
	[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
	[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
	[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
	[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
	[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
	[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
	[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
	[SalReplacement] ,[OfferReplacement],ClosingSales,ClosingUnSaleable,ClosingOffer,
	SecondarySales,LastInvoiceNumber,LastInvoiceDate,StockInTrans,
	UploadFlag,UploadedDate)
	SELECT StkMonth,StkYear,
	PrdCode,PrdName,PrdBatchCode,MRP,CLP,OpeningSales,OpeningUnSaleable,
	OpenignOffer,PurchaseSales,PurchaseUnSaleable,PurchaseOffer,InvoiceSales,
	InvoiceUnSaleable,InvoiceOffer,[SalPurReturn] ,[UnsalPurReturn] ,[OfferPurReturn] ,
	[SalStockIn] ,[UnSalStockIn] ,[OfferStockIn] ,
	[SalStockOut] ,	[UnSalStockOut] ,[OfferStockOut] ,
	[DamageIn] ,[DamageOut] ,
	[SalSalesReturn] ,[UnSalSalesReturn] ,[OfferSalesReturn] ,
	[SalStkJurIn] ,	[UnSalStkJurIn] ,[OfferStkJurIn] ,
	[SalStkJurOut] ,[UnSalStkJurOut] ,[OfferStkJurOut] ,
	[SalBatTfrIn] ,	[UnSalBatTfrIn] ,[OfferBatTfrIn] ,
	[SalBatTfrOut] ,[UnSalBatTfrOut] ,[OfferBatTfrOut] ,
	[SalLcnTfrIn] ,	[UnSalLcnTfrIn] ,[OfferLcnTfrIn] ,
	[SalLcnTfrOut] ,[UnSalLcnTfrOut] ,[OfferLcnTfrOut] ,
	[SalReplacement] ,[OfferReplacement],ClosingSales,ClosingUnSaleable,
	ClosingOffer,SecondarySales,LastInvoiceNumber,LastInvoiceDate,StockInTrans,
	0 as UploadFlag ,GETDATE() as UploadedDate
	FROM CS2CN_Prk_MonthEndClosingStock WHERE UploadFlag='N'
	
	
	END
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnSalesRouteAddControl]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnSalesRouteAddControl]
GO
--SELECT DBO.Fn_ReturnSalesRouteAddControl(78,1,1,'')
CREATE FUNCTION [Fn_ReturnSalesRouteAddControl](@Trans AS TINYINT,@UsrId AS INT,@Imode AS INT,@CtrlName NVARCHAR(100))
RETURNS TINYINT
AS
BEGIN
/*******************************************************************************************
* FUNCTION : Fn_ReturnSRRERMasterControl
* PURPOSE  : Return the Salesman/Route/Retailer Edit /Delete option
* NOTES    : 
* CREATED  : MarySubashini.S
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
*  28/12/2020  MarySubashini.S		CR     CRCRSTPAR0107        Block Salesman/Route/Retailer Add/Edit /Delete option
********************************************************************************************/
	DECLARE @Status AS TINYINT
	SET @Status=1
	IF @Imode=2 
	BEGIN
		IF @Trans=68
		BEGIN
			IF EXISTS (SELECT 'X'  FROM ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION1' AND Status=1)
			BEGIN
				SET @Status=0
			END
		END
		IF @Trans=78
		BEGIN
			IF EXISTS (SELECT 'X'  FROM ManualConfiguration WHERE ModuleId='BLOCKMSTCREATION2' AND Status=1)
			BEGIN
				SET @Status=0
			END
		END
	END
	RETURN(@Status)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnRouteStatus]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnRouteStatus]
GO
--SELECT DBO.Fn_ReturnRouteStatus('2020-03-05',1)
CREATE FUNCTION [Fn_ReturnRouteStatus](@RMId AS INT)
RETURNS @RouteStatus TABLE
(
	StatusId INT,
	StatusName NVARCHAR(100)
)
AS
BEGIN
/*******************************************************************************************
* FUNCTION : Fn_ReturnSRRERMasterControl
* PURPOSE  : Return the Salesman/Route/Retailer Edit /Delete option
* NOTES    : 
* CREATED  : MarySubashini.S
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
*  28/12/2020  MarySubashini.S		CR     CRCRSTPAR0107        Block Salesman/Route/Retailer Add/Edit /Delete option
********************************************************************************************/
	INSERT INTO @RouteStatus(StatusId,StatusName)
	SELECT RMStatus,(CASE RMStatus WHEN 1 THEN 'Active' ELSE 'InActive' END) StatName FROM RouteMaster(NOLOCK) WHERE RMId=@RMId

	RETURN
END
GO
--- Process Name : "Stock Transfer" PMS No : CRCRSTPAR0107
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName in ('Stock Transfer')
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,selectCount,CreatedDate)
SELECT Max(SequenceNo )+1,'Stock Transfer' ,'Cn2Cs_Prk_StockTransfer','PROC_Import_StockTransfer',0,500,Getdate() FROM Tbl_DownloadIntegration 
GO
DELETE FROM CustomUpDownload WHERE Screen in ('Stock Transfer') AND UpDownload='Download' 
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT MAX(Slno)+1 ,1,'Stock Transfer','Stock Transfer','','PROC_Import_StockTransfer','Cn2Cs_Prk_StockTransfer',
'Proc_ValidateStockTransfer_Download','Transaction','Download',1 FROM CustomUpDownload WHERE UpDownload='Download' 
GO
DELETE FROM CustomUpDownloadCount WHERE Module in ('Stock Transfer') and UpDownload='Download'
INSERT INTO CustomUpDownloadCount(SlNo,SeqNo,Module,Screen,ParkTable,MainTable,KeyField1,KeyField2,KeyField3,
UpDownload,OldMax,OldCount,NewMax,NewCount,DownloadedCount,SelectQuery)
SELECT MAX(Slno)+1,1,'Stock Transfer','Stock Transfer','Cn2Cs_Prk_StockTransfer','Cn2Cs_Prk_StockTransfer',
'DownLoadFlag','','','Download',0,0,0,0,0,'' FROM CustomUpDownloadCount where UpDownload='Download'
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cn2Cs_Prk_StockTransfer' AND XTYPE='U')
DROP TABLE Cn2Cs_Prk_StockTransfer
GO
CREATE TABLE Cn2Cs_Prk_StockTransfer
(
	[DistCode] [nvarchar](50) NULL,
	[DocRefNo] [nvarchar](50) NULL,
	[TransType] [nvarchar](50) NULL,---- ADD/REDUCE
	[ProductCode] [nvarchar](50) NULL,
	[BatchCode] [nvarchar](50) NULL,
	[SysStkType] [nvarchar](50) NULL,----Saleable/UnSaleable/Offer
	[Location] [nvarchar](50) NULL,--- Location Code "MG" 
	[Uom Code] [nvarchar](50) NULL,
	[Qty] [Int] NULL,
	[Type] [Int] NULL,-------------1 Then Opening Stock, 0 then Stock Adjustment
	[DownloadFlag][nvarchar](10) NULL,
	[CreatedDate] [DateTime]
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidateStockTransfer_Download' AND XTYPE='P')
DROP PROCEDURE Proc_ValidateStockTransfer_Download
GO
CREATE PROCEDURE Proc_ValidateStockTransfer_Download
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_ValidateStockTransfer_Download
* PURPOSE: To Insert and Update records
* CREATED: Venkat.M.P on 13/01/2021  PMS No : CRCRSTPAR0107
*********************************/
--EXCEL IMPORT STOCK MANAGEMENT TYPE ADDED BY PRAVEENRAJ B ON 31-01-2014
SET NOCOUNT ON
BEGIN
	DECLARE @ErrDesc AS VARCHAR(1000)
	DECLARE @rno AS INT
	DECLARE @TabName AS VARCHAR(50)
	DECLARE @DocRefNo As VARCHAR(100)
	DECLARE @TransType As VARCHAR(50)
	DECLARE @PrdCode As VARCHAR(50)
	DECLARE @PrdBat As VARCHAR(50)
	DECLARE @StkType AS VARCHAR(50)
	DECLARE @LocCode AS VARCHAR(50)
	DECLARE @UomCode AS VARCHAR(50)
	DECLARE @Qty AS INT
	DECLARE @Po_StkPosting INT
	DECLARE @PrdId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @PriceId AS INT
	DECLARE @LcnId AS INT
	DECLARE @UomId AS INT
	DECLARE @StkId AS INT
	DECLARE @StkTypeId AS INT
	DECLARE @StockLegdStkTypeId AS INT
	DECLARE @GetKey AS VARCHAR(20)
	DECLARE @Taction AS INT
	DECLARE @TransId AS INT
	DECLARE @SelRte AS NUMERIC(18,6)
	DECLARE @Amount AS NUMERIC(18,2)
	DECLARE @Pi_Date DATETIME
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @TypeDesc AS INT
	DECLARE @Type AS INT
	DECLARE @ChkDate AS DATETIME
	DECLARE @iCnt AS INT
	DECLARE @iOpnDebit AS NUMERIC(18,2)
	DECLARE @iOpnCredit AS NUMERIC(18,2)
	DECLARE @ErrStatus		INT
	DECLARE @iVocDate	NVARCHAR(10)
	
	DECLARE @StkMgmtTypeId INT
	
	SET @iVocDate=CONVERT(NVARCHAR(10),GETDATE(),121)
	SET @TabName = 'Cn2Cs_Prk_StockTransfer'
	DECLARE Cur_StkTransHd CURSOR
	FOR SELECT DISTINCT ISNULL([Location],'') AS [Location],ISNULL([TransType],''),
		ISNULL([DocRefNo],'')AS [Reference Number],ISNULL([Type],'') AS [Type]
		FROM Cn2Cs_Prk_StockTransfer WHERE DownloadFlag='D' ORDER BY [Location]
	OPEN Cur_StkTransHd
	FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@TypeDesc
	SET @Rno = 0
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Taction = 2
		IF LTRIM(RTRIM(@LocCode))= ''
		BEGIN
			SET @ErrDesc = 'Location should not be blank'
			INSERT INTO Errorlog VALUES (1,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@TransType))= ''
		BEGIN
			SET @ErrDesc = 'Transaction Type should not be blank'
			INSERT INTO Errorlog VALUES (2,@TabName,'Transaction Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@Type))= ''
		BEGIN
			SET @ErrDesc = 'Type should not be blank'
			INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		IF @TypeDesc= '0'
			SET @Type=0
		ELSE IF @TypeDesc= '1'
			SET @Type=1
		IF LTRIM(RTRIM(@TransType)) = 'REDUCE'
			SET @TransId=1
		ELSE IF LTRIM(RTRIM(@TransType)) = 'ADD'
			SET @TransId=0
		IF NOT EXISTS(SELECT StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId)
		BEGIN
			SET @ErrDesc = 'Transaction Not Found'
			INSERT INTO Errorlog VALUES (4,@TabName,'Transaction',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @TransId=StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId
		END
		IF NOT EXISTS(SELECT LcnId FROM Location WHERE LcnCode=@LocCode)
		BEGIN
			SET @ErrDesc = 'Location Not Found'
			INSERT INTO Errorlog VALUES (5,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @LcnId=LcnId FROM Location WHERE LcnCode=@LocCode
		END
		SELECT @GetKey= dbo.Fn_GetPrimaryKeyString('StockManagement','StkMngRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
		IF @Taction = 2
		BEGIN
			INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal,Status)
			VALUES(@GetKey,convert(varchar(10),getdate(),121),@LcnId,@TransId,0,0,@DocRefNo,'',4,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),@Type,1)
			SET @sSQL ='INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal) VALUES(''' +
					CAST(@GetKey AS VARCHAR(50)) + ''',''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@LcnId AS VARCHAR(10)) + ',' +
					CAST(@TransId AS VARCHAR(10)) + ',0,0,''' + CAST(@DocRefNo AS VARCHAR(50)) + ''','''',4,1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@Type AS VARCHAR(10)) + ',1)'
			INSERT INTO Translog(strSql1) Values (@sSQL)
			UPDATE counters SET currvalue = currvalue+1  WHERE tabname = 'StockManagement' and fldname = 'StkMngRefNo'
			SET @sSQL ='UPDATE counters SET currvalue = currvalue+1  WHERE tabname = ''StockManagement'' and fldname = ''StkMngRefNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			IF @Po_ErrNo =1
				SET @Po_ErrNo =1
			ELSE
				SET @Po_ErrNo =0
		END
		DECLARE  Cur_StkTransDt CURSOR
		FOR SELECT [ProductCode],[BatchCode],[SysStkType],[Uom Code],[Qty]
		FROM Cn2Cs_Prk_StockTransfer WHERE DownloadFlag='D' AND [TransType] = @TransType AND [Location]=@LocCode
		ORDER BY [ProductCode],[BatchCode],[Location]
		OPEN Cur_StkTransDt
		FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		WHILE @@FETCH_STATUS=0
		BEGIN
		
			IF LTRIM(RTRIM(@PrdCode))= ''
			BEGIN
				SET @ErrDesc = 'Product should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@PrdBat))= ''
			BEGIN
				SET @ErrDesc = 'Product Batch should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END			
			IF LTRIM(RTRIM(@StkType))= ''
			BEGIN
				SET @ErrDesc = 'System Stock Type should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'System Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@UomCode))= ''
			BEGIN
				SET @ErrDesc = 'Uom Code should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Uom Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))= ''
			BEGIN
				SET @ErrDesc = 'Quantity should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF ISNUMERIC(LTRIM(RTRIM(@Qty)))= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be numeric'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))<= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be greater than Zero'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @TransType='ADD'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment In'
			END
			ELSE IF @TransType='REDUCE'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment Out'
			END
			IF ISNULL(@StkMgmtTypeId,0)=0
			BEGIN
				SET @ErrDesc = 'Trans Type Should ADD/REDUCE'
				INSERT INTO Errorlog VALUES (7,@TabName,'Trans Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @StkType='Saleable'
			BEGIN
			
				SET @StkTypeId =1
				IF @TransType='ADD'
					BEGIN
						
						SET @StockLegdStkTypeId=10
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=13
					END
			END	
			ELSE IF @StkType='Unsaleable'
			BEGIN
				SET @StkTypeId =2
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=11
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=14
					END
			END
			ELSE IF @StkType='Offer'
			BEGIN
				SET @StkTypeId =3
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=12
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=15
					END
			END
			IF NOT EXISTS(SELECT PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode)))
			BEGIN
				SET @ErrDesc = 'Product:'+@PrdCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdId=PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode))
			END
			IF NOT EXISTS(SELECT PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)))
			BEGIN
				SET @ErrDesc = 'Product Batch:'+@PrdBat+' Not Found For Product:'+@PrdCode
				INSERT INTO Errorlog VALUES (8,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
				SET @PrdBatId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdBatId=PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)) AND PrdId=@PrdId
			END		
			
			SELECT @PriceId=PriceId FROM ProductBatchDetails WHERE DefaultPrice=1 AND PrdBatId=@PrdBatId AND SlNo=1
			
			
			IF NOT EXISTS(SELECT StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId)
			BEGIN
				SET @ErrDesc = 'Stock Type Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @StkId=StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId
			END	
			
			IF NOT EXISTS(SELECT UomId FROM UomMaster WHERE UomCode=@UomCode)
			BEGIN
				SET @ErrDesc = 'Uom:'+@UomCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Uom',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @UomId=UomId FROM UomMaster WHERE UomCode=@UomCode
			END
			IF @PrdId <> 0 AND @PrdBatId <> 0 AND @PriceId <> 0
			BEGIN
				SELECT @SelRte=CONVERT(NUMERIC(18,2),C.PrdBatDetailValue) FROM ProductBatch A (NOLOCK)
				INNER JOIN ProductBatchDetails C (NOLOCK)ON A.PrdBatId = C.PrdBatID AND C.PriceId=@PriceId
				INNER JOIN Product P ON A.PrdId = P.PrdId
				INNER JOIN BatchCreation D (NOLOCK)
				ON D.BatchSeqId = C.BatchSeqId AND D.SlNo = C.SlNo
				AND D.SelRte = 1 WHERE P.PrdId = @PrdId AND A.PrdBatId = @PrdBatId
				SET @Amount = (CONVERT(NUMERIC(18,2),@SelRte) * CONVERT(INT,REPLACE(@Qty,'	','')))
			END
			ELSE
			BEGIN
				SET @ErrDesc = 'Selling Rate Not Found for Product:'+@PrdCode+' for Batch:'+@PrdBat
				INSERT INTO Errorlog VALUES (8,@TabName,'Selling Rate',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			--Added By Maha on 15/06/2009
			SET @iOpnDebit=0
			SET @iOpnCredit=0
			SELECT @iCnt=Count(CoaId) FROM COAOpeningBalance Where CoaId=291
			SELECT @iOpnDebit=ISNULL(OpeningDebit,0),@iOpnCredit=ISNULL(OpeningCredit,0) FROM COAOpeningBalance Where CoaId=74
			SET @iOpnDebit=@iOpnDebit+@Amount
			SET @iOpnCredit=@iOpnCredit
			IF @Type = 1	--Opening Balance
			BEGIN
				SELECT @ChkDate=ISNULL(MIN(TransDate),GETDATE())  FROM StockLedger WITH (NOLOCK)
				IF CONVERT(NVARCHAR(10),GETDATE(),121)=CONVERT(NVARCHAR(10),@ChkDate,121)
				BEGIN			
					IF @iCnt=0
					BEGIN
						INSERT INTO CoaOpeningBalance(CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)
								VALUES(291,@iOpnDebit,@iOpnCredit,1,1,GETDATE(),1,GETDATE())
				
						SET @sSQL = 'INSERT INTO CoaOpeningBalance (CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)'
						SET @sSQL = @sSQL + ' VALUES(291,' + CAST(@iOpnDebit AS NVARCHAR(100))+ ',' + CAST(@iOpnCredit AS NVARCHAR(100))+ ',1,1,GETDATE(),1,GETDATE())'
						INSERT INTO Translog(strSql1) Values (@sSQL)		
					END
					ELSE
					BEGIN
						UPDATE CoaOpeningBalance SET OpeningDebit=@iOpnDebit WHERE CoaId=291
					
						SET @sSQL='UPDATE CoaOpeningBalance SET OpeningDebit=' + CAST(@iOpnDebit AS NVARCHAR(100)) + ' WHERE CoaId=291'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				ELSE
				BEGIN
					SET @ErrDesc = 'Transaction Exists'
					INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END	
			--Till Here
			IF @Taction =2
			BEGIN
				INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxAmt,StkMgmtTypeId)
				VALUES (@GetKey,@PrdId,@PrdBatId,@PriceId,@StkId,@UomId,@Qty,0,0,@Qty,CONVERT(NUMERIC(18,2),@SelRte),@Amount,0,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,@StkMgmtTypeId)
				
				SET @sSQL ='INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(''' +
					   CAST(@GetKey AS VARCHAR(50)) + ''',' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@PriceId AS VARCHAR(10)) + ','+
							   CAST(@StkId AS VARCHAR(10)) + ',' +CAST(@UomId AS VARCHAR(10)) + ',' + CAST(@Qty AS VARCHAR(10)) +
							   ',0,0,' + CAST(@Qty AS VARCHAR(10)) + ',' + CAST(@SelRte AS VARCHAR(24)) + ',' + CAST(@Amount AS VARCHAR(24)) + ',0,1,1,''' +
							   convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @Pi_Date = CONVERT(NVARCHAR(10),GETDATE(),121)
				Exec Proc_UpdateStockLedger @StockLegdStkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				SET @sSQL ='Exec Proc_UpdateStockLedger ' + CAST(@StockLegdStkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
						CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
				INSERT INTO Translog(strSql1) Values (@sSQL)
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Stock Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Stock Posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				IF @TransType='ADD'
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,2,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',2,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				--Voucher Posting	Added By Maha on 15-03-2009
				IF @Type=0
				BEGIN
					IF @TransType='ADD'
					BEGIN
						EXEC Proc_VoucherPosting 13,1,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,1,'''+ CAST(@GetKey AS VARCHAR(10))+ ''' ,5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @TransType='REDUCE'
					BEGIN
						EXEC Proc_VoucherPosting 13,0,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,0,'''+ CAST(@GetKey AS VARCHAR(10)) + ',5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				IF @ErrStatus < 0
				BEGIN
					 SET @ErrDesc = 'Voucher Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Voucher posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				IF @Po_ErrNo =1
				BEGIN
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SET @Po_ErrNo =0
				END
				--Till Here
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Product batch location posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Product batch location posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				
				IF @Po_ErrNo =1
					SET @Po_ErrNo =1
				ELSE
					SET @Po_ErrNo =0
				END
				SET @PrdId = 0
				SET @PrdBatId = 0
			FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		END
		
		CLOSE Cur_StkTransDt
		DEALLOCATE Cur_StkTransDt
		SET @GetKey=''
		FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@Type
		
	END
	CLOSE Cur_StkTransHd
	DEALLOCATE Cur_StkTransHd
	UPDATE A SET DownloadFlag='Y' FROM Cn2Cs_Prk_StockTransfer  A INNER JOIN StockManagement B WITH (NOLOCK)ON A.DocRefNo =B.DocRefNo WHERE A.DocRefNo =@DocRefNo
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2CS_Prk_RetailerMasterUpdate' AND name='SalesRoute')
BEGIN
      ALTER TABLE Cn2CS_Prk_RetailerMasterUpdate ADD [SalesRoute] NVARCHAR(50) 
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cn2CS_Prk_RetailerMasterUpdate' AND name='DeliveryRoute')
BEGIN
      ALTER TABLE Cn2CS_Prk_RetailerMasterUpdate ADD [DeliveryRoute] NVARCHAR(50) 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_RetailerMasterUpdate' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
GO
CREATE PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMasterUpdate
* PURPOSE		: To Validate Retailer Master data update from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 25/06/2019
* MODIFIED
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON	  | USER STORY ID  |  CR/BZ |   REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  441		 25/06/2019	    S.Moorthi		CRCRSTPAR0069	 CR		   Need to block the edit option in Sehyog and the group, channel and status should be allowed to edit in console end and this will download and update in 
																		Sehyog end. Excel upload facility require in Console    
  443		 12-09-2020     Deepak Philip   PARLECS/0920/138 BZ        To avaoid duplicate Retailer Master Download.
  445		 22-01-2021		Venkat. M		CRCRSTPAR0107	 CR			SalesRoute, DlvRoute column add	
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	CREATE TABLE #ToAvoidRetailer
	(
		RtrCode [nvarchar](50)
	)
	CREATE TABLE #Cn2CS_Prk_RetailerMasterUpdate(
	[RtrCode]			[nvarchar](50),
	[RetailerName]		[nvarchar](100),
	[RetailerChannal]	[nvarchar](50),
	[RetailerGroup]		[nvarchar](50),
	[RetailerClass]		[nvarchar](50),
	[RetailerStatus]	[nvarchar](50),
	[SalesRoute]		[nvarchar](50),
	[DeliveryRoute]		[nvarchar](50)
	)
	
	--PARLECS/0920/138
	SELECT DISTINCT * INTO #RetailerUpdate FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK)
	DELETE A FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK)
	INSERT INTO Cn2CS_Prk_RetailerMasterUpdate
	SELECT * FROM #RetailerUpdate
	
	DELETE FROM Cn2CS_Prk_RetailerMasterUpdate WHERE DownLoadFlag='Y'
	SELECT RtrCode,MAX(CreatedDate) as CreatedDate
	INTO #PrgMaxDate
	FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK) 
	WHERE DownLoadFlag='D' GROUP BY RtrCode
	
	INSERT INTO #Cn2CS_Prk_RetailerMasterUpdate
	([RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus],[SalesRoute] ,[DeliveryRoute] )
	SELECT DISTINCT A.[RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus],[SalesRoute] ,[DeliveryRoute] 
	FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK) 
	INNER JOIN #PrgMaxDate B ON A.RtrCode=B.RtrCode and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status shoud be Active/InActive '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
		
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Code Not Available '+ M.RtrCode 
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')='' OR ISNULL([SalesRoute] ,'')=''OR ISNULL([DeliveryRoute] ,'')='')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status/Name/Channel/Group/Class/Route can not be blank '+ RtrCode
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')=''OR ISNULL([SalesRoute] ,'')=''OR ISNULL([DeliveryRoute] ,'')='')
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Channel/Group/Value Class details not available '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode)
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster A(NOLOCK) WHERE A.RMCode=M.SalesRoute AND RMSRouteType =1 )
	UNION	
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT RMCode FROM RouteMaster A(NOLOCK) WHERE A.RmCode=M.DeliveryRoute AND RMSRouteType =2 )
	
	INSERT INTO RetailerMasterUpdateTrack(RtrCode,RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,OldRetailerName,OldRetailerGroup,OldRetailerClass,OldRetailerStatus,CreatedDate)	
	SELECT B.RtrCode,B.RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,A.RtrName,RC.CtgCode,RVC.ValueClassCode,A.RtrStatus,GETDATE() 
	FROM Retailer A (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM(NOLOCK) ON A.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgMainId=RVC.CtgMainId 	
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)  
	
	UPDATE A SET A.RtrName=B.RetailerName,A.RtrStatus=(CASE WHEN B.RetailerStatus='Active' THEN 1 ELSE 0 END) FROM Retailer A 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)
	
	UPDATE A SET A.RtrValueClassId=RVC.RtrClassId FROM RetailerValueClassMap A 
	INNER JOIN Retailer B ON A.RtrId=B.RtrId
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=B.CmpRtrCode 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.ValueClassCode=M.RetailerClass
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgCode=M.RetailerGroup AND RC.CtgMainId=RVC.CtgMainId 
	INNER JOIN RetailerCategory RC1(NOLOCK) ON RC1.CtgCode=M.RetailerChannal AND RC1.CtgMainId=RC.CtgLinkId
	-- Added by Venkat.M PMS No : CRCRSTPAR0107
	UPDATE A SET A.RmId =R.Rmid FROM Retailer A (NOLOCK) INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	INNER JOIN RouteMaster R (NOLOCK) ON B.DeliveryRoute=R.RmCode AND RMSRouteType =2
	
	UPDATE RM SET Rm.Rmid =R.Rmid, Upload=0 FROM Retailer A (NOLOCK) INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode
	INNER JOIN RETAILERMarket RM (NOLOCK) ON Rm.Rtrid=A.Rtrid
	INNER JOIN RouteMaster R (NOLOCK) ON B.SalesRoute=R.RmCode AND RMSRouteType =1
		
	UPDATE C SET DownloadFlag='Y' FROM  Cn2CS_Prk_RetailerMasterUpdate C 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=C.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE C.RtrCode=N.RtrCode) 
	
RETURN 
END
GO
---Added by Deepan
IF NOT EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='Cn2Cs_Prk_BLPurchaseReceipt'  AND S.Name='GSTInvoiceNumber')
BEGIN
	ALTER TABLE Cn2Cs_Prk_BLPurchaseReceipt ADD  GSTInvoiceNumber NVARCHAR(50)
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[PurchaseReceiptGstInvoiceNumber]') AND type in (N'U'))
CREATE TABLE [PurchaseReceiptGstInvoiceNumber](
	[CompInvNo] [varchar](25) NULL,
	[GSTInvoiceNumber] [nvarchar](50) NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_PurchaseReceipt]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_PurchaseReceipt]
GO
/*    
BEGIN TRANSACTION   
EXEC Proc_Cn2Cs_PurchaseReceipt 0 
select *from ETLTempPurchaseReceipt --WHERE DownLoadStatus=0
select *from etltemppurchasereceiptproduct where cmpinvno in(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=0)
SELECT * FROM ETLTempPurchaseReceiptClaimScheme 
ROLLBACK TRANSACTION    
*/    
CREATE PROCEDURE [Proc_Cn2Cs_PurchaseReceipt]
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/***********************************************************    
* PROCEDURE : Proc_Cn2Cs_PurchaseReceipt    
* PURPOSE : To Insert the records FROM Console into Temp Tables    
* SCREEN : Console Integration-PurchaseReceipt    
* CREATED BY: Nandakumar R.G On 03-05-2010    
* MODIFIED :    
* DATE      AUTHOR     DESCRIPTION    
14/08/2013 Murugan.R Logistic Material Management    
* {date} {developer}  {brief modIFication description}    
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-09-2018  Lakshman M		SR     ILCRSTPAR2251         Purchase backup date validation included from CS As per request 5 days configuration .
04-10-2018  lakshman M		 BZ    ILCRSTPAR2285         purchase downloaded status validation added from CS.
28-01-2019  Lakshman M		SR     ILCRSTPAR3256         Purchase backup date validation increased from CS As per request 10 days configuration .
05-03-2019  Lakshman M		SR     ILCRSTPAR3638         Purchase backup date validation decreased from CS As per request 7 days only configuration.
19-10-2019  Lakshman M		SR     ILCRSTPAR6350         Purchase process trace validation included for one month date Range current month less than 30 days.
14-01-2020  Lakshman M		SR     ILCRSTPAR7425         Purchase backup date validation increased from CS As per request 20 days only configuration.
17-03-2020  MarySubashini.S CR     ILCRSTPAR8294		 IRNNumber,TCSTaxAmt column added
19-01-2021	Deepan			CR	   CRCRSTPAR0110		 GSTInvoiceNumber added	
***************************************************************************************************/  
SET NOCOUNT ON    
BEGIN    
		-- For Clearing the Prking/Temp Table -----     
		---------------->  Added by Lakshman M on 29/09/2018  <-------------------
		DECLARE @FROMDATE AS Datetime
		DECLARE @TodayDt AS datetime
		SELECT @FROMDATE = cast(DATEADD(DAY, -20, GETDATE()) AS DATETIME)
		SELECT @FROMDATE=CONVERT(VARCHAR(11), @FROMDATE, 121)
		SELECT @TodayDt= CAST(convert(varchar,getdate()) AS DATETIME)
		SELECT @TodayDt= CONVERT(VARCHAR(11), @TodayDt, 121)
		
		SELECT * INTO #ETLTempPurchaseReceipt_temp FROM ETLTempPurchaseReceipt WHERE InvDate between CONVERT(VARCHAR(11), @FROMDATE, 121) and CONVERT(VARCHAR(11), @TodayDt, 121)
		UPDATE A SET A.downloadstatus = 0 FROM ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp B ON A.CmpInvNo =B.CmpInvNo
		UPDATE A SET A.downloadstatus = 1 from ETLTempPurchaseReceipt A where CmpInvNo in(select CmpInvNo from PurchaseReceipt)   ---> added By Lakshman M PMS ID: ILCRSTPAR2285 
		SELECT * INTO #ETLTempPurchaseReceipt_temp1 FROM ETLTempPurchaseReceipt WHERE InvDate < CONVERT(VARCHAR(11),@FROMDATE, 121)
		Delete A from ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo  
		Delete A from ETLTempPurchaseReceiptproduct A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
		Delete A from ETLTempPurchaseReceiptClaimScheme A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
		Delete A from ETLTempPurchaseReceiptClaimScheme A where A.CmpInvNo not in(select B.CmpInvNo from #ETLTempPurchaseReceipt_temp1 B)
		
		----------------- Added by lakshman M Dated ON dated ON 19-10-2019 PMS ID: ILCRSTPAR6350 
		INSERT INTO Cn2Cs_Prk_BLPurchaseReceipt_Trace(
		DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
		PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
		SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,PurDownloadedDate,TCSTaxAmt)--ILCRSTPAR8294
		SELECT DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
		PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
		SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,GETDATE(),ISNULL(TCSTaxAmt,0)TCSTaxAmt FROM Cn2Cs_Prk_BLPurchaseReceipt--ILCRSTPAR8294
		
		DELETE FROM Cn2Cs_Prk_BLPurchaseReceipt_Trace WHERE CONVERT(varchar(12),compinvdate,121) < convert(varchar(12),(cast(DATEADD(DAY, -15, GETDATE()) AS DATETIME)),121)
		
		---------------->  Till Here  <----------------------
		DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
		DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in     
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
		DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN     
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1    
		DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments WHERE CmpInvNo     
		IN (SELECT CmpInvNo FROM PurchaseReceipt WHERE Status = 1) AND DownloadStatus = 1    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim    
		TRUNCATE TABLE ETL_Prk_PurchaseReceipt    
		TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptCrDbAdjustments  
		--------------------------------------    
		DECLARE @ErrStatus INT    
		DECLARE @BatchNo   NVARCHAR(200)    
		DECLARE @ProductCode  NVARCHAR(100)    
		DECLARE @ListPrice   NUMERIC(38,6)    
		DECLARE @FreeSchemeFlag  NVARCHAR(5)    
		DECLARE @CompInvNo   NVARCHAR(25)    
		DECLARE @UOMCode   NVARCHAR(25)    
		DECLARE @Qty    INT    
		DECLARE @PurchaseDiscount NUMERIC(38,6)    
		DECLARE @VATTaxValue  NUMERIC(38,6)    
		DECLARE @SchemeRefrNo  NVARCHAR(25)    
		DECLARE @SupplierCode  NVARCHAR(30)    
		DECLARE @TransporterCode NVARCHAR(30)    
		DECLARE @POUOM    INT    
		DECLARE @RowId    INT    
		DECLARE @LineLvlAmt   NUMERIC(38,6)    
		DECLARE @QtyInKg   NUMERIC(38,6)    
		DECLARE @ExistCompInvNo  NVARCHAR(25)    
		DECLARE @FreightCharges  NUMERIC(38,6)   
		DECLARE @TcstaxAmt       NUMERIC(18,6) ---ILCRSTPAR8294
		DECLARE @GSTInvoiceNumber NVARCHAR(50)
		SET @RowId=1    
		--->Added By Nanda on 17/09/2009    
		IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')    
		AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)    
		BEGIN    
		DROP TABLE InvToAvoid     
		END    
		CREATE TABLE InvToAvoid    
		(    
			CmpInvNo NVARCHAR(50)    
		)    
		--ILCRSTPAR8294
		CREATE TABLE #IRNNUMBERValidate
		(
		  CompInvNo NVARCHAR(100),
		  IRNNumber NVARCHAR(200)
		)
		--ILCRSTPAR8294
		IF EXISTS (SELECT DISTINCT CompInvNo,SupplierCode FROM Cn2Cs_Prk_BLPurchaseReceipt  
		WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST'))  
		BEGIN  
			INSERT INTO InvToAvoid (CmpInvNo)  
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
			WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
			SELECT DISTINCT 1,'Purchase Receipt','Tax Type','Purchase Tax Type should be VAT or GST '+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
			WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
		END 
		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
		END 
		   
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
		END   
		
		
		--ILCRSTPAR8294
		INSERT INTO #IRNNUMBERValidate
		SELECT DISTINCT CompInvNo,IRNNumber FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE DownLoadFlag='D' and ISNULL(IRNNumber,'')<>''

		IF EXISTS (SELECT DISTINCT CompInvNo from #IRNNUMBERValidate(NOLOCK) GROUP BY CompInvNo
		HAVING COUNT(IRNNumber)>1)
		BEGIN
		   INSERT INTO InvToAvoid(CmpInvNo)
		   SELECT DISTINCT CompInvNo from #IRNNUMBERValidate(NOLOCK) GROUP BY CompInvNo
		   Having Count(IRNNumber)>1
		   INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 133,'Purchase Receipt','CmpInvNo','Multiple IRNNumber downloaded for Invoice:'+CompInvNo FROM  #IRNNUMBERValidate(NOLOCK) 
		   GROUP BY CompInvNo HAVING COUNT(IRNNumber)>1
		END
		--ILCRSTPAR8294

		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			--->Added By Nanda on 05/05/2010    
			INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
			SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			--->Till Here        
		END
		   
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE ProductCode+'~'+BatchNo    
		NOT IN    
		(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN    
			(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			--->Added By Nanda on 05/05/2010    
			INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
			SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			--->Till Here    
		END  
		  
		--Supplier Credit Note Validations     
		IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
		(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit')    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
			(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'CreditNoteSupplier','PostedRefNo','Supplier Credit Note Not Available'+[CompInvNo]    
			FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
			(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'      
		END    
		--Supplier Debit Note Validations     
		IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
		(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit')    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
			(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'DebitNoteSupplier','PostedRefNo','Supplier Debit Note Not Available'+[CompInvNo]    
			FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
			(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'      
		END   
		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvDate>GETDATE())     
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvDate>GETDATE()    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo     
			FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE CompInvDate>GETDATE()    
		END 
		   
		--Commented and Added By Mohana.S PMS NO: DCRSTKAL0012    
		--IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		--WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))     
		--BEGIN    
		-- INSERT INTO InvToAvoid(CmpInvNo)    
		-- SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		-- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
		-- INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
		-- SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		-- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
		--END    
		IF EXISTS (SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
		FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
			FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt',PRODUCTCODE+'Product UOM','UOMCode:'+UOMCode+' is not available for Invoice:'+CompInvNo     
			FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode  NOT IN (SELECT PrdCCode+'~'+UomCode      
			FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
		END     
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK)))     
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Invoice Supplier','Supplier:'+SupplierCode+' is not available for Invoice:'+CompInvNo    
			FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
		END     
		--->Till Here    
		-- Eliminated Duplicate records insertion on 02/03/2015  
		SET @ExistCompInvNo=0    
		DECLARE Cur_Purchase CURSOR    
		FOR    
		SELECT DISTINCT ProductCode,BatchNo,ListPriceNSP,    
		FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,    
		ISNULL(FreightCharges,0) AS FreightCharges,ISNULL(TCSTaxAmt,0) AS TCSTaxAmt   --ILCRSTPAR8294     
		FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)    
		ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,    
		FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges,TCSTaxAmt 
		OPEN Cur_Purchase    
		FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
		@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
		@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges,@TcstaxAmt    --ILCRSTPAR8294  
		WHILE @@FETCH_STATUS = 0    
		BEGIN    
			--  IF @ExistCompInvNo<>@CompInvNo    
			--  BEGIN    
			--   SET @ExistCompInvNo=@CompInvNo    
			--   SET @RowId=2    
			--  END    
			--To insert into ETL_Prk_PurchaseReceiptPrdDt    
			IF(@FreeSchemeFlag='0')    
			BEGIN    
				INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],    
				[PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges
				,TCSTaxAmt) ---ILCRSTPAR8294
				VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,    
				@PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges,@TcstaxAmt) ---ILCRSTPAR8294 
				  
				INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)  
				  
				INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)    
				--   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				--   VALUES(@CompInvNo,@RowId,'E',@QtyInKg)    
			END    
			--To insert into ETL_Prk_PurchaseReceiptClaim    
			IF(@FreeSchemeFlag='1')    
			BEGIN    
				INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],    
				[Batch Code],[Qty],[Stock Type],[Amount],FreightAmt,TCSTaxAmt) --ILCRSTPAR8294    
				VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0,@FreightCharges,@TcstaxAmt) --ILCRSTPAR8294   
			END    
			--  SET @RowId=@RowId+1    
			FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
			@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
			@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges,@TcstaxAmt--ILCRSTPAR8294
		END    
		CLOSE Cur_Purchase    
		DEALLOCATE Cur_Purchase 
		   
		--To insert into ETL_Prk_PurchaseReceipt    
		SELECT @TransporterCode=TransporterCode FROM Transporter    
		WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter WITH(NOLOCK))
		    
		IF @TransporterCode=''    
		BEGIN    
			INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter','Transporter not available')    
		END 
		   
		INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],  
		[Invoice Date],[Transporter Code],[NetPayable Amount],[TaxType],[IRNNumber]) ---ILCRSTPAR8294)  
		SELECT DISTINCT C.CmpCode,SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue,  
		P.TaxType ,P.IRNNumber  ---ILCRSTPAR8294
		FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P  
		WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)
		  
		UPDATE A SET [TaxType]='VAT' FROM ETL_Prk_PurchaseReceipt A (NOLOCK)   
		INNER JOIN Cn2Cs_Prk_BLPurchaseReceipt B (NOLOCK) ON B.CompInvNo=A.[Company Invoice No]   
		AND A.[Supplier Code]=B.SupplierCode WHERE ISNULL(A.TaxType,'')=''  
		--CRCRSTPAR0110
		INSERT INTO PurchaseReceiptGstInvoiceNumber(CompInvNo,GSTInvoiceNumber,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT CompInvNo,GSTInvoiceNumber,1,1,GETDATE(),1,GETDATE()
		FROM Cn2Cs_Prk_BLPurchaseReceipt 
		WHERE  DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)
		
		--Added By Sathishkumar Veeramani 2013/08/13    
		--INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)    
		--SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)    
		--WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
		--Added by Sathishkumar Veeramani 2013/11/22    
		
		INSERT INTO ETL_Prk_PurchaseReceiptCrDbAdjustments([Company Invoice No],[Adjustment Type],[Ref No],[Amount])    
		SELECT DISTINCT CompInvNo,AdjType,RefNo,Amount FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WITH (NOLOCK)    
		WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
		EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT    
		IF @ErrStatus =0    
		BEGIN    
			EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT    
			IF @ErrStatus =0    
			BEGIN    
				EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT    
				IF @ErrStatus =0    
				BEGIN    
					EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT    
					IF @ErrStatus =0    
					BEGIN    
						EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT    
						IF @ErrStatus =0    
						BEGIN    
							EXEC Proc_Validate_PurchaseReceiptCrDbAdjustments @Po_ErrNo= @ErrStatus OUTPUT    
							IF @ErrStatus =0    
							BEGIN    
								SET @ErrStatus=@ErrStatus    
							END        
						END        
					END    
				END    
			END    
		END    
		--Proc_Validate_PurchaseReceiptCrDbAdjustments    
		--->Added By Nanda on 17/09/2009    
		DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN    
	   (SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)    
	   
		UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'    
		WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)
		    
		--->Till Here    
		SET @Po_ErrNo= @ErrStatus    
 RETURN    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptPurchaseTaxGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptPurchaseTaxGST]
GO
--EXEC Proc_RptPurchaseTaxGST  402,1,0,'',1,0,''
CREATE PROCEDURE [dbo].[Proc_RptPurchaseTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptPurchaseTaxGST
* PURPOSE	: To get the GST Purchase Tax details
* CREATED	: Raja C
* CREATED DATE	: 20/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR		UPDATED ZERO FOR QTY AND NETAMOUNT IF THE TAX PERC IS CESS and Included CESS Tax
* 21/01/2021    Deepan			CRCRSTPAR0110	   CR		GST Invoice number included reports	 
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))	
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptPurchaseTaxGST')
	BEGIN
		DELETE FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(   
		    [GRN No] NVarchar(100),
            [GRN date] DateTime,
			[InvDate] DateTime,
			[InvId] [bigint] NULL,
			[RefNo] [varchar](100) NULL,
			[ODN Number] [varchar](100) NULL,
			GstInvoiceNumber [nvarchar](50) NULL,
			[SupplierCode] Varchar(75),
			[SupplierName] Varchar(150),
			[SupplierAddress] Varchar(150),
			[Supplier GSTIN] Varchar(150),
			[Supplier State] Varchar(150),
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[SpmId] [int] NULL,
			[Prdid] [int] NULL,
			[InvQty] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			[TaxableAmountCESS] [numeric](38, 6) NULL,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[LineNetAmount] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId])
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'Purchase' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId   
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId 
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		--LEFT OUTER JOIN PurchaseReceiptGstInvoiceNumber  PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
		WHERE PR.InvDate  Between @FromDate and @ToDate and PR.Status=1
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount) >0  
			
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'Purchase' as IOTaxType,1 as TaxFlag,SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId    
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING  SUM(PRPT.TaxAmount+PRPT.TaxableAmount) > 0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'PurchaseReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING SUM(TaxableAmount) >0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'PurchaseReturn' as IOTaxType,1 as TaxFlag,-1*SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount+PRPT.TaxAmount) >0 
		
		UPDATE A SET LineNetAmount=0,InvQty=0,TaxableAmountcess = TaxableAmount,TaxableAmount = 0 FROM #TmpRptIOTaxSummary A WHERE TAXPERC IN ('INPUTCGSTCESS Value','INPUTSGSTCESS Value',
		'INPUTIGSTCESS Value',	'INPUTUTGSTCESS Value','CGSTCESS Value','SGSTCESS Value','IGSTCESS Value','UTGSTCESS Value','CESS Value',
		'INPUTCGSTCESS Rate','INPUTSGSTCESS Rate','INPUTIGSTCESS Rate','INPUTUTGSTCESS Rate','INPUTGSTCESS Rate','INPUTGSTCESS Value',
		'CGSTCESS Rate','SGSTCESS Rate','IGSTCESS Rate','UTGSTCESS Rate','CESS Rate','GSTCESS Rate','GSTCESS Value') --ILCRSTBOT0006
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT  '' AS [GRN No],'' AS [GRN date],NULL, 0 [InvId],'' AS [RefNo],'' AS [ODN Number],'' AS [SupplierCode],'' AS [SupplierName],''AS [SupplierAddress],'' AS [Supplier GSTIN],
		'' AS [Supplier State],'' AS [Product Name] ,'' AS [Product Code],'' AS [HSN Code],0 [SpmId],0 as Prdid,0 as [InvQty],0 as[CmpId],  [TaxPerc] ,0 as [TaxableAmount],0 [TaxableAmountCESS],'' as [IOTaxType] ,
		100 as [TaxFlag],SUM([TaxPercent]) as [TaxPercent],0 as [TaxId],0 as  LineNetAmount,0 as [UPC],'ZZZZZZ' as [Group Name],3 as [GroupType],[UsrId]
		FROM #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
		SELECT StateCode,StateName,TinFirst2Digit,MasterRecordId
		INTO #SupplierState 
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
		and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
		INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue and E.StateName=C.ColumnValue
		WHERE MasterName='Supplier Master' and ColumnName='State Name'
		
					
		UPDATE A  SET A.[Supplier State]=B.StateName 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierState  B  ON A.Spmid=B.MasterRecordId
		
		SELECT MasterRecordId,ColumnName AS SupplierGSTIN
		INTO #SupplierGSTIN
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId	
		WHERE MasterName='Supplier Master' and ColumnName='GSTIN'
		
        UPDATE A  SET A.[Supplier GSTIN]=B.SupplierGSTIN 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierGSTIN  B  ON A.Spmid=B.MasterRecordId
		
		
		UPDATE #TmpRptIOTaxSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TmpRptIOTaxSummary T INNER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON T.RefNo=PG.CompInvNo
		WHERE T.IOTaxType='Purchase'
		
		UPDATE #TmpRptIOTaxSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TmpRptIOTaxSummary T INNER JOIN PurchaseReturn PR(NOLOCK) ON T.RefNo=PR.PurRetRefNo
		INNER JOIN  PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
		WHERE T.IOTaxType='PurchaseReturn'
		
		
		
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master' and ColumnName='HSN Code'
		
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
        SELECT DISTINCT
		[GRN No],[GRN date],[InvDate],[InvId],[RefNo],GstInvoiceNumber,[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],
		[TaxableAmount],[IOTaxType],[TaxFlag],LineNetAmount,[UsrId]
		INTO #LineLevelGross	
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY NVARCHAR(MAX)--ILCRSTBOT0006
		
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)
		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId	
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxperc)+'),0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		
		SET @ColSelect='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'InvDate,[ODN Number],GstInvoiceNumber,[Product Code],[Product Name],[HSN Code],[UPC],SUM(InvQty) InvQty,SUM(TaxableAmount) TaxableAmount,SUM(TaxableAmountCESS) TaxableAmountCESS,'+@ColSelect+'SUM(LineNetAmount) LineNetAmount,'+
		'[Group Name],[GroupType],[UsrId]'
		SET @GROUPBY = ' GROUP BY SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
					'InvDate,[ODN Number],GstInvoiceNumber,[Product Code],[Product Name],[HSN Code],[UPC],[Group Name],[GroupType],[UsrId]'
				
		SET @TableCol= 'Slno BIGINT IDENTITY(1,1),[SupplierCode] Varchar(75),[SupplierName] Varchar(150),[SupplierAddress] Varchar(150),[Supplier GSTIN] Varchar(150),'+
        '[Supplier State] Varchar(150),[IOTaxType] [varchar](100) NULL,[GRN No] NVarchar(100),[GRN date] DateTime,[Invoice Number] NVarchar(100),[Invoice Date] Datetime,[ODN Number] Varchar(100),'+
        '[GstInvoiceNumber] NVARCHAR(75) NULL,[Product Code] Varchar(75),[Product Name] Varchar(150),[HSN Code] Varchar(50),UPC INT,[InvQty] [int] NULL,[TaxableAmount] [numeric](38, 6) NULL,[TaxableAmountCESS] [numeric](38, 6) NULL,'
		
		SET @Columns1='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'Invdate,[ODN Number],GstInvoiceNumber,[Product Code],[Product Name],[HSN Code],UPC,[InvQty],[TaxableAmount],[TaxableAmountcess],LineNetAmount,TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,Invdate,SupplierName,[Product Name]'
		
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptPurchaseTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptPurchaseTaxGST'+
		' CREATE TABLE RptPurchaseTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),[Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--PRINT @CreateTable
	    EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptPurchaseTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBY + @OrderBy
		--PRINT @SQL
		EXEC(@SQL)
		
		
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,SUM(TaxableAmount) as TaxableAmount
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount 
		FROM RptPurchaseTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,402,'Product Wise Input Tax',1,'Supplier State',20,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',2,'SupplierCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',3,'SupplierName',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',4,'SupplierAddress',75,1,0,1,1,'Supplier','Address','',0,GETDATE()			
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',5,'IOTaxType',75,1,0,1,1,'Purchase/','PurReturn','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',6,'GRN No',75,1,0,1,1,'GRN.','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',7,'GRN date',75,1,0,1,4,'GRN.','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',8,'Invoice Number',75,1,0,1,1,'Comp InvoiceNo/','ReturnRefNo','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',9,'Invoice Date',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',10,'[ODN Number]',75,1,0,1,1,'Purchase Order','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',11,'[GstInvoiceNumber]',75,1,0,1,1,'GstInvoiceNumber','GstInvoiceNumber','',0,GETDATE()
			UNION ALL						
			SELECT 1,402,'Product Wise Input Tax',12,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',13,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',14,'HSN Code',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',15,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',16,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',17,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',18,'TaxableAmountCESS',20,1,0,2,3,'Taxable','AmountCESS','',2,GETDATE()
		
		
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			19,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptInputtaxCreditGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptInputtaxCreditGST]
GO
/*
BEGIN tran
EXEC Proc_RptInputtaxCreditGST 405,1,0,'schvalidtill18072020',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [dbo].[Proc_RptInputtaxCreditGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputtaxCreditGST
* PURPOSE	: To get the Input Tax
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 21/01/2021    Deepan			CRCRSTPAR0110	   CR		GST Invoice number included reports	 

*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptInputtaxCreditGST
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			SpmCode Varchar(50),
			Spmname Varchar(100),	
			Refid BIGINT,
			RefNo Varchar(50),
			CmpInvno Varchar(50),
			PurchaseOrderNo Varchar(50),
			GstInvoiceNumber [nvarchar](50) NULL,
			InvoiceDate Datetime,
			RefDate DateTime,
			SpmId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCESS Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT PurRcptId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseTaxableAmount
		FROM(
		SELECT S.PurRcptId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId
		WHERE  TaxableAmount>0 and Status=1
		AND SI.InvDate   Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.PurRcptId,PrdSlno ,TaxId
		)X GROUP BY PurRcptId,Prdslno,TaxId
		
		SELECT PurRetId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseRtnTaxableAmount
		FROM(
		SELECT S.PurRetId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId
		WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1
		GROUP BY S.PurRetId,PrdSlno,TaxId
		)X GROUP BY  PurRetId,Prdslno,TaxId
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		WHERE InvDate Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		
		
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE InvDate Between @FromDate and @ToDate
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCess,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCess,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		--ILCRSTBOT0006
		
		
		UPDATE #TaxHSNSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TaxHSNSummary T INNER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON T.CmpInvno=PG.CompInvNo
		WHERE T.TaxType='Purchase of Goods'
		
		UPDATE #TaxHSNSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TaxHSNSummary T INNER JOIN PurchaseReturn PR(NOLOCK) ON T.RefNo=PR.PurRetRefNo
		INNER JOIN  PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
		WHERE T.TaxType='Purchase Return of Goods'
		
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','OutputGSTCESS','GSTCESS','CESS','InputGSTCESS')
		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		--ILCRSTBOT0006
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,
		Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,'' as GstInvoiceNumber,NUll,Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
	
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN
		FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId
		
		SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo
		INTO #Refcode
		FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId
		
		UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo 
		FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @SumCol AS Varchar(Max)
		DECLARE @GroupByCol AS VARCHAR(Max)
		SET @GroupByCol=''
		SET @SumCol=''
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		--SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,TaxableAmountCess,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		
		SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,TaxType,SalesOrderType,SUM(TaxableAmount) as TaxableAmount,SUM(TaxableAmountCESS) as TaxableAmountCESS,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
	
		
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		SpmId INT,
		SpmCode Varchar(50),
		Spmname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		CmpInvno Varchar(50),
		PurchaseOrderNo Varchar(50),
		GstInvoiceNumber NVarchar(50),
		InvoiceDate Datetime,
		RefDate DateTime,
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),
		TaxableAmountCESS Numeric(34,2),
		'
		SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,TaxableAmountCESS,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptInputtaxCreditGST'' and XTYPE=''U'')'+
		' DROP TABLE RptInputtaxCreditGST'+
		' CREATE TABLE RptInputtaxCreditGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptInputtaxCreditGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GroupByCol+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		SELECT DISTINCT
		StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptInputtaxCreditGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,405,'Input Tax Summary',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',9,'GstInvoiceNumber',75,1,0,1,1,'Gst','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',10,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',11,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',12,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',13,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',14,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
	
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			19,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptInputtaxCreditGST)
			BEGIN
				SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT NAME FROM Tempdb..SYSOBJECTS WHERE XTYPE='U' AND NAME='##RptInputOutPutGSTTax')
BEGIN
	DROP TABLE ##RptInputOutPutGSTTax
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptInputOutPutGSTTax]') AND type in (N'U'))
DROP TABLE [dbo].[RptInputOutPutGSTTax]
GO
CREATE TABLE [dbo].[RptInputOutPutGSTTax](
	[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
	[Product Name] [varchar](150) NULL,
	[Product Code] [varchar](75) NULL,
	[HSN Code] [varchar](50) NULL,
	GstInvoiceNumber [nvarchar](50) NULL,
	[InPutQty] [int] NULL,
	[OutPutQty] [int] NULL,
	[TaxableAmount] [numeric](38, 6) NULL,
	[InputCGST Rate] [numeric](36, 2) NULL,
	[InputCGST Value] [numeric](36, 2) NULL,
	[InputSGST Rate] [numeric](36, 2) NULL,
	[InputSGST Value] [numeric](36, 2) NULL,
	[InputIGST Rate] [numeric](36, 2) NULL,
	[InputIGST Value] [numeric](36, 2) NULL,
	[InputUTGST Rate] [numeric](36, 2) NULL,
	[InputUTGST Value] [numeric](36, 2) NULL,
	[InputCGSTCESS Rate] [numeric](36, 2) NULL,
	[InputCGSTCESS Value] [numeric](36, 2) NULL,
	[InputSGSTCESS Rate] [numeric](36, 2) NULL,
	[InputSGSTCESS Value] [numeric](36, 2) NULL,
	[InputIGSTCESS Rate] [numeric](36, 2) NULL,
	[InputIGSTCESS Value] [numeric](36, 2) NULL,
	[InputUTGSTCESS Rate] [numeric](36, 2) NULL,
	[InputUTGSTCESS Value] [numeric](36, 2) NULL,
	[InputGSTCESS Rate] [numeric](36, 2) NULL,
	[InputGSTCESS Value] [numeric](36, 2) NULL,
	[OutputCGST Rate] [numeric](36, 2) NULL,
	[OutputCGST Value] [numeric](36, 2) NULL,
	[OutputSGST Rate] [numeric](36, 2) NULL,
	[OutputSGST Value] [numeric](36, 2) NULL,
	[OutputIGST Rate] [numeric](36, 2) NULL,
	[OutputIGST Value] [numeric](36, 2) NULL,
	[OutputUTGST Rate] [numeric](36, 2) NULL,
	[OutputUTGST Value] [numeric](36, 2) NULL,
	[OutputCGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputCGSTCESS Value] [numeric](36, 2) NULL,
	[OutputSGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputSGSTCESS Value] [numeric](36, 2) NULL,
	[OutputIGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputIGSTCESS Value] [numeric](36, 2) NULL,
	[OutputUTGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputUTGSTCESS Value] [numeric](36, 2) NULL,
	[OutputGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputGSTCESS Value] [numeric](36, 2) NULL,
	[DiffCGST Value] [numeric](36, 2) NULL,
	[DiffSGST Value] [numeric](36, 2) NULL,
	[DiffIGST Value] [numeric](36, 2) NULL,
	[DiffUTGST Value] [numeric](36, 2) NULL,
	[DiffCGSTCESS Value] [numeric](36, 2) NULL,
	[DiffSGSTCESS Value] [numeric](36, 2) NULL,
	[DiffIGSTCESS Value] [numeric](36, 2) NULL,
	[DiffUTGSTCESS Value] [numeric](36, 2) NULL,
	[DiffGSTCESS Value] [numeric](36, 2) NULL,
	[Group Name] [varchar](100) NULL,
	[Grouptype] [tinyint] NULL,
	[UsrId] [int] NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_RptInputOutputProductWiseGSTTax]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_RptInputOutputProductWiseGSTTax]
GO
---EXEC Proc_RptInputOutputProductWiseGSTTax 407,1,0,'',0,0,1
CREATE PROCEDURE [Proc_RptInputOutputProductWiseGSTTax]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputOutputProductWiseGSTTax
* PURPOSE	: To get the Tax details
* CREATED	: Murugan.R
* CREATED DATE	: 12/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	        CR		ILCRSTBOT0006			Included CESS Tax
* 21/01/2021    Deepan			CRCRSTPAR0110	   CR		GST Invoice number included reports	 
	  
************************************************************************************************************************************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptInputOutPutGSTTax')
	BEGIN
		TRUNCATE TABLE RptInputOutPutGSTTax
	END
	
	IF EXISTS(SELECT NAME FROM Tempdb..SYSOBJECTS WHERE XTYPE='U' AND NAME='##RptInputOutPutGSTTax')
	BEGIN
		DROP TABLE ##RptInputOutPutGSTTax
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			GstInvoiceNumber [nvarchar](50) NULL,
			[Prdid] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			InputQty INT,
			OutPutQty INT,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,			
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		CREATE TABLE #PurchaseVsSales
		(
			TransId TinyInt,
			PrdId INT,
			GstInvoiceNumber [nvarchar](50) NULL,
			InOutPutQty INT,
			TaxableAmount Numeric(32,4),
			TaxAmount Numeric(25,4),
			TaxPerc Numeric(10,2),
			TaxId INT
		)
		
		
		CREATE TABLE ##RptInputOutPutGSTTax(
		[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
		[Product Name] [varchar](150) NULL,
		[Product Code] [varchar](75) NULL,
		[HSN Code] [varchar](50) NULL,
		GstInvoiceNumber [nvarchar](50) NULL,
		[InPutQty] [int] NULL,
		[OutPutQty] [int] NULL,
		[TaxableAmount] [numeric](38, 6) NULL,
		[InputCGST Rate] [numeric](36, 2) NULL,
		[InputCGST Value] [numeric](36, 2) NULL,
		[InputSGST Rate] [numeric](36, 2) NULL,
		[InputSGST Value] [numeric](36, 2) NULL,
		[InputIGST Rate] [numeric](36, 2) NULL,
		[InputIGST Value] [numeric](36, 2) NULL,
		[InputUTGST Rate] [numeric](36, 2) NULL,
		[InputUTGST Value] [numeric](36, 2) NULL,
		[InputCGSTCESS Rate] [numeric](36, 2) NULL,
		[InputCGSTCESS Value] [numeric](36, 2) NULL,
		[InputSGSTCESS Rate] [numeric](36, 2) NULL,
		[InputSGSTCESS Value] [numeric](36, 2) NULL,
		[InputIGSTCESS Rate] [numeric](36, 2) NULL,
		[InputIGSTCESS Value] [numeric](36, 2) NULL,
		[InputUTGSTCESS Rate] [numeric](36, 2) NULL,
		[InputUTGSTCESS Value] [numeric](36, 2) NULL,
		[InputGSTCESS Rate] [numeric](36, 2) NULL,
		[InputGSTCESS Value] [numeric](36, 2) NULL,
		[OutputCGST Rate] [numeric](36, 2) NULL,
		[OutputCGST Value] [numeric](36, 2) NULL,
		[OutputSGST Rate] [numeric](36, 2) NULL,
		[OutputSGST Value] [numeric](36, 2) NULL,
		[OutputIGST Rate] [numeric](36, 2) NULL,
		[OutputIGST Value] [numeric](36, 2) NULL,
		[OutputUTGST Rate] [numeric](36, 2) NULL,
		[OutputUTGST Value] [numeric](36, 2) NULL,
		[OutputCGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputCGSTCESS Value] [numeric](36, 2) NULL,
		[OutputSGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputSGSTCESS Value] [numeric](36, 2) NULL,
		[OutputIGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputIGSTCESS Value] [numeric](36, 2) NULL,
		[OutputUTGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputUTGSTCESS Value] [numeric](36, 2) NULL,
		[OutputGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputGSTCESS Value] [numeric](36, 2) NULL,
		[Group Name] [varchar](100) NULL,
		[Grouptype] [tinyint] NULL,
		[UsrId] [int] NULL
		)
		CREATE TABLE #SalesInvoiceProductTax
		(
		[SalId] [bigint] NOT NULL,
		[PrdSlNo] [int] NOT NULL,
		[TaxId] [int] NOT NULL,
		[TaxPerc] [numeric](10, 6) NOT NULL,
		[TaxableAmount] [numeric](18, 6) NOT NULL,
		[TaxAmount] [numeric](18, 6) NOT NULL
		)
		INSERT INTO #PurchaseVsSales(TransId,PrdId,GstInvoiceNumber,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)		
		SELECT 1 as TransId ,Prdid,GstInvoiceNumber,SUM(InputQty) as InputQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM
		(
			SELECT PrdId ,PG.GstInvoiceNumber,SUM(PRP.RcvdGoodBaseQty) as InputQty,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(PRPT.TaxAmount) as TaxAmount,TaxPerc ,PRPT.TaxId		
			FROM 
			PurchaseReceipt PR WITH (NOLOCK)  
			INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
			INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			LEFT OUTER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
			WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId,PG.GstInvoiceNumber
			HAVING Sum(TaxableAmount) >0  
			UNION ALL
			SELECT Prdid,PG.GstInvoiceNumber,-1*SUM(RetSalBaseQty+RetUnSalBaseQty) as InputQty,
					-1*SUM(PRPT.TaxableAmount) as TaxableAmount,
					-1*SUM(PRPT.TaxAmount) as TaxAmount, TaxPerc ,PRPT.TaxId
			
			FROM 
			PurchaseReturn  PR WITH (NOLOCK)  
			INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
			INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			LEFT OUTER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
			WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId,PG.GstInvoiceNumber
			HAVING SUM(TaxableAmount) >0 		
		)X GROUP BY Prdid,TaxPerc,TaxId,GstInvoiceNumber
		
		
		
		INSERT INTO #PurchaseVsSales(TransId,PrdId,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)
		SELECT 2 as TransId ,Prdid,SUM(OutPutQty) as OutPutQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM(
				SELECT Prdid,SUM(BaseQty) as OutPutQty,
				SUM(TaxableAmount)	AS TaxableAmount,
				SUM(TaxAmount) as TaxAmount,TaxPerc,SPT.TaxId
				FROM 
				SalesInvoice SI WITH (NOLOCK)  
				INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
				INNER JOIN SalesInvoiceProductTax SPT  ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
				WHERE SI.Salinvdate Between @FromDate and @ToDate
				and SI.Dlvsts >3 and VatGst='GST' and SPT.TaxableAmount>0
				GROUP BY TaxPerc,PrdId,SPT.TaxId				
				UNION ALL
				Select Prdid,-1*SUM(BaseQty) as OutPutQty,	
				-1*SUM(TaxableAmt) AS TaxableAmount	,
				-1*SUM(RPT.TaxAmt),TaxPerc,RPT.TaxID
				FROM ReturnHeader RH WITH (NOLOCK)  
				INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
				INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
				WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate and VatGst='GST'
				and RPT.TaxableAmt>0
				GROUP BY TaxPerc,PrdId,RPT.TaxId
				 
		) X GROUP BY Prdid,TaxPerc,TaxId
			
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],GstInvoiceNumber,[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],PRP.GstInvoiceNumber,
		P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Rate'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Rate'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Rate'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Rate'
				WHEN TaxCode IN('InputIGSTCESS','IGSTCESS') THEN 'InputIGSTCESS Rate'
				WHEN TaxCode IN ('InputCGSTCESS','CGSTCESS') Then 'InputCGSTCESS Rate'
				WHEN TaxCode IN ('InputSGSTCESS','SGSTCESS') Then 'InputSGSTCESS Rate'
				WHEN TaxCode IN ('InputUTGSTCESS','UTGSTCESS') Then 'InputUTGSTCESS Rate'				
				WHEN TaxCode IN ('InputGSTCESS','GSTCESS','CESS') Then 'InputGSTCESS Rate'
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty as InputQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','InputGSTCESS','GSTCESS')
		and TransId=1
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],GstInvoiceNumber,[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],PRP.GstInvoiceNumber,P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Value'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Value'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Value'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Value'
				WHEN TaxCode IN('InputIGSTCESS','IGSTCESS') THEN 'InputIGSTCESS Value'
				WHEN TaxCode IN ('InputCGSTCESS','CGSTCESS') Then 'InputCGSTCESS Value'
				WHEN TaxCode IN ('InputSGSTCESS','SGSTCESS') Then 'InputSGSTCESS Value'
				WHEN TaxCode IN ('InputUTGSTCESS','UTGSTCESS') Then 'InputUTGSTCESS Value'
				WHEN TAXCODE IN ('InputGSTCess','GSTCESS','CESS') THEN 'InputGSTCess Value'		
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','InputGSTCESS','GSTCESS')
		and TransId=1
	
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],GstInvoiceNumber,[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],PRP.GstInvoiceNumber,P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Rate'
				WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Rate'
				WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Rate'
				WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Rate'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS') THEN 'OutputIGSTCESS Rate'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS') Then 'OutputCGSTCESS Rate'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS') Then 'OutputSGSTCESS Rate'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS') Then 'OutputUTGSTCESS Rate'
						WHEN TAXCODE IN ('OutPutGSTCess','GSTCESS','CESS') THEN 'OutputGSTCess Rate'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0 as InputQty,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS','CESS',
		'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','GSTCESS')
		and TransId=2
		
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],GstInvoiceNumber,[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],PRP.GstInvoiceNumber,P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Value'
				WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Value'
				WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Value'
				WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Value'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS') THEN 'OutputIGSTCESS Value'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS') Then 'OutputCGSTCESS Value'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS') Then 'OutputSGSTCESS Value'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS') Then 'OutputUTGSTCESS Value'
						WHEN TAXCODE IN ('OutPutGSTCess','GSTCESS','CESS') THEN 'OutputGSTCess Value'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS')
		and TransId=2
		
				
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		
	
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN		
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax	WHERE UsrId=@Pi_UsrId			
			RETURN
		END
				
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50)		
		)
		
		INSERT INTO #DynamicCol
		SELECT 'OutputIGST Rate'
		UNION
		SELECT 'OutputCGST Rate'
		UNION
		SELECT 'OutputSGST Rate'
		UNION
		SELECT 'OutputUTGST Rate'
		UNION
		SELECT 'OutputIGST Value'
		UNION
		SELECT 'OutputCGST Value'
		UNION
		SELECT 'OutputSGST Value'
		UNION
		SELECT 'OutputUTGST Value'
		UNION
		SELECT 'OutputIGSTCESS Rate'
		UNION
		SELECT 'OutputUTGSTCESS Rate'
		UNION
		SELECT 'OutputCGSTCESS Rate'
		UNION
		SELECT 'OutputSGSTCESS Rate'
		UNION
		SELECT 'OutputGSTCESS Rate'
		UNION
		SELECT 'OutputIGSTCESS Value'
		UNION
		SELECT 'OutputUTGSTCESS Value'
		UNION
		SELECT 'OutputCGSTCESS Value'
		UNION
		SELECT 'OutputSGSTCESS Value'
		UNION
		SELECT 'OutputGSTCESS Value'
		UNION
		SELECT 'InputIGST Rate'
		UNION
		SELECT 'InputCGST Rate'
		UNION
		SELECT 'InputSGST Rate'
		UNION
		SELECT 'InputUTGST Rate'
		UNION
		SELECT 'InputIGST Value'
		UNION
		SELECT 'InputCGST Value'
		UNION
		SELECT 'InputSGST Value'
		UNION
		SELECT 'InputUTGST Value'
		UNION
		SELECT 'InputIGSTCESS Rate'
		UNION
		SELECT 'InputUTGSTCESS Rate'
		UNION
		SELECT 'InputCGSTCESS Rate'
		UNION
		SELECT 'InputSGSTCESS Rate'
		UNION
		SELECT 'InputGSTCESS Rate'
		UNION
		SELECT 'InputIGSTCESS Value'
		UNION
		SELECT 'InputUTGSTCESS Value'
		UNION
		SELECT 'InputCGSTCESS Value'
		UNION
		SELECT 'InputSGSTCESS Value'
		UNION
		SELECT 'InputGSTCESS Value'
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxperc)+',0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,InPutQty,OutPutQty,[TaxableAmount],'+@ColSelect+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'[Product Name] Varchar(150),[Product Code] Varchar(75),[HSN Code] varchar(50),GstInvoiceNumber Nvarchar(50),'+		
		'InPutQty INT,OutPutQty INT,[TaxableAmount] [numeric](38, 6) NULL,'
	
		SET @Columns1='SELECT [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,InPutQty,OutPutQty,[TaxableAmount],TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM Tempdb..SYSOBJECTS WHERE NAME=''##RptInputOutPutGSTTax'' and XTYPE=''U'')'+
		' DROP TABLE ##RptInputOutPutGSTTax'+
		' CREATE TABLE ##RptInputOutPutGSTTax ('+@TableCol+@ColSelectDataType+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO ##RptInputOutPutGSTTax '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		
		
		SELECT [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		SUM([InputCGST Rate]) as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		SUM([InputSGST Rate]) as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		SUM([InputIGST Rate]) as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		SUM([InputUTGST Rate]) as  [InputUTGST Rate],SUM([InputUTGST Value]) as [InputUTGST Value],
		SUM([InputCGSTCESS Rate]) as [InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		SUM([InputSGSTCESS Rate]) as [InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		SUM([InputIGSTCESS Rate]) as [InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		SUM([InputUTGSTCESS Rate]) as  [InputUTGSTCESS Rate],SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		SUM([InputGSTCESS Rate]) as  [InputGSTCESS Rate],SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		SUM([OutputCGST Rate]) as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		SUM([OutputSGST Rate]) as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		SUM([OutputIGST Rate]) as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		SUM([OutputUTGST Rate]) as [OutputUTGST Rate] ,SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		SUM([OutputCGSTCESS Rate]) as [OutputCGSTCESS Rate],SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value],
		SUM([OutputSGSTCESS Rate]) as [OutputSGSTCESS Rate],SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value],
		SUM([OutputIGSTCESS Rate]) as [OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		SUM([OutputUTGSTCESS Rate]) as [OutputUTGSTCESS Rate] ,SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		SUM([OutputGSTCESS Rate]) as [OutputGSTCESS Rate] ,SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		[Group Name],Grouptype,UsrId
		INTO #RptProductTaxGroup
		FROM ##RptInputOutPutGSTTax		
		GROUP BY [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,[Group Name],Grouptype,UsrId
		
		
	
		
		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],GstInvoiceNumber,[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[InputCGSTCESS Rate],[InputCGSTCESS Value],
		[InputSGSTCESS Rate],[InputSGSTCESS Value],[InputIGSTCESS Rate],[InputIGSTCESS Value],
		[InputUTGSTCESS Rate],[InputUTGSTCESS Value],[InputGSTCESS Rate],[InputGSTCESS Value],
		[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[OutputCGSTCESS Rate],[OutputCGSTCESS Value],
		[OutputSGSTCESS Rate],[OutputSGSTCESS Value],[OutputIGSTCESS Rate],[OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],[OutputUTGSTCESS Value],[OutputGSTCESS Rate],
		[OutputGSTCESS Value],[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[DiffCGSTCESS Value],[DiffSGSTCESS Value],
		[DiffIGSTCESS Value],[DiffUTGSTCESS Value],[DiffGSTCESS Value],
		[Group Name],[Grouptype],[UsrId])
		SELECT [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		[InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		[InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		[InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		[InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		[InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		[InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		[InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		[InputUTGSTCESS Rate] ,SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		[InputGSTCESS Rate],SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		[OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		[OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		[OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		[OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		[OutputCGSTCESS Rate] ,SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value] ,
		[OutputSGSTCESS Rate] ,SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value] ,
		[OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		[OutputGSTCESS Rate] ,SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		[Group Name],Grouptype,UsrId
		FROM #RptProductTaxGroup		
		GROUP BY [Product Name],[Product Code],[HSN Code],GstInvoiceNumber,[Group Name],Grouptype,UsrId,
		[InputCGST Rate],[InputSGST Rate],[InputIGST Rate],[InputUTGST Rate],[InputGSTCESS Rate],
		[OutputCGST Rate],[OutputSGST Rate],[OutputIGST Rate],[OutputUTGST Rate],
		[InputCGSTCESS Rate],[InputSGSTCESS Rate],[InputIGSTCESS Rate],[InputUTGSTCESS Rate],
		[OutputCGSTCESS Rate],[OutputSGSTCESS Rate],[OutputIGSTCESS Rate],[OutputUTGSTCESS Rate],[OutputGSTCESS Rate] 
		ORDER BY [HSN Code], [Product Name]
		
			
		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],GstInvoiceNumber,[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[InputCGSTCESS Rate],[InputCGSTCESS Value],
		[InputSGSTCESS Rate],[InputSGSTCESS Value],[InputIGSTCESS Rate],[InputIGSTCESS Value],
		[InputUTGSTCESS Rate],[InputUTGSTCESS Value],[InputGSTCESS Rate],[InputGSTCESS Value],
		[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[OutputCGSTCESS Rate],[OutputCGSTCESS Value],
		[OutputSGSTCESS Rate],[OutputSGSTCESS Value],[OutputIGSTCESS Rate],[OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],[OutputUTGSTCESS Value],[OutputGSTCESS Rate],[OutputGSTCESS Value],
		[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[DiffCGSTCESS Value],[DiffSGSTCESS Value],
		[DiffIGSTCESS Value],[DiffUTGSTCESS Value],[DiffGSTCESS Value],[Group Name],[Grouptype],[UsrId])
		
		SELECT '' as [Product Name],'' as [Product Code],'' as [HSN Code],'' AS GstInvoiceNumber,SUM([InPutQty]) as [InPutQty],
		SUM([OutPutQty]) as [OutPutQty],
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		0 as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		0 as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		0 as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		0 as [InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		0 as [InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		0 as [InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		0 as [InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		0 as [InputUTGSTCESS Rate] ,SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		0 as [InputGSTCESS Rate] ,SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		0 as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		0 as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		0 as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		0 as [OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		0 as [OutputCGSTCESS Rate],SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value],
		0 as [OutputSGSTCESS Rate],SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value],
		0 as [OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		0 as [OutputUTGSTCESS Rate],SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		0 as [OutputGSTCESS Rate],SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		ABS(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		ABS(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		ABS(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		ABS(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		ABS(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		ABS(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		ABS(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		ABS(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		ABS(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		'ZZZZZZ' as [Group Name],3 as Grouptype,@Pi_UsrId as UsrId
		FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
		
		
		DELETE FROM RptInputOutPutGSTTax WHERE ([InPutQty]+[OutPutQty])=0
		AND UsrId=@Pi_UsrId
		
		DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
		INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
		FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
		RoundOff,CreatedDate)
		SELECT 1,407,'Product Wise Input Output Tax',1,'Product Name',50,1,0,1,1,'Product Name','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',2,'Product Code',20,1,0,1,1,'Product Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',3,'HSN Code',20,1,0,1,1,'HSN Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',4,'GstInvoiceNumber',50,1,0,1,1,'GstInvoiceNumber','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',5,'InPutQty',50,1,0,2,2,'Input','Total','Quantity',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',6,'OutPutQty',50,1,0,2,2,'Output','Total','Quantity',0,GETDATE()
		--UNION ALL
		--SELECT 1,407,'Product Wise Input Output Tax',6,'TaxableAmount',16,1,0,2,3,'Taxable','Amount','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',7,'InputCGST Rate',16,1,0,2,3,'Input','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',8,'InputSGST Rate',16,1,0,2,3,'Input','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',9,'InputIGST Rate',16,1,0,2,3,'Input','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',10,'InputUTGST Rate',16,1,0,2,3,'Input','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',11,'InputCGST Value',16,1,0,2,3,'Input','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',12,'InputSGST Value',16,1,0,2,3,'Input','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',13,'InputIGST Value',16,1,0,2,3,'Input','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',14,'InputUTGST Value',16,1,0,2,3,'Input','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',15,'InputCGSTCESS Rate',16,1,0,2,3,'Input','CGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',16,'InputSGSTCESS Rate',16,1,0,2,3,'Input','SGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',17,'InputIGSTCESS Rate',16,1,0,2,3,'Input','IGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',18,'InputUTGSTCESS Rate',16,1,0,2,3,'Input','UTGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',19,'InputGSTCESS Rate',16,1,0,2,3,'Input','GSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',20,'InputCGSTCESS Value',16,1,0,2,3,'Input','CGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',21,'InputSGSTCESS Value',16,1,0,2,3,'Input','SGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',22,'InputIGSTCESS Value',16,1,0,2,3,'Input','IGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',23,'InputUTGSTCESS Value',16,1,0,2,3,'Input','UTGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',24,'InputGSTCESS Value',16,1,0,2,3,'Input','GSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',25,'OutPutCGST Rate',16,1,0,2,3,'OutPut','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',26,'OutPutSGST Rate',16,1,0,2,3,'OutPut','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',27,'OutPutIGST Rate',16,1,0,2,3,'OutPut','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',28,'OutPutUTGST Rate',16,1,0,2,3,'OutPut','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',29,'OutPutCGST Value',16,1,0,2,3,'OutPut','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',30,'OutPutSGST Value',16,1,0,2,3,'OutPut','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',31,'OutPutIGST Value',16,1,0,2,3,'OutPut','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',32,'OutPutUTGST Value',16,1,0,2,3,'OutPut','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',33,'OutPutCGSTCESS Rate',16,1,0,2,3,'OutPut','CGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',34,'OutPutSGSTCESS Rate',16,1,0,2,3,'OutPut','SGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',35,'OutPutIGSTCESS Rate',16,1,0,2,3,'OutPut','IGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',36,'OutPutUTGSTCESS Rate',16,1,0,2,3,'OutPut','UTGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',37,'OutPutGSTCESS Rate',16,1,0,2,3,'OutPut','GSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',38,'OutPutCGSTCESS Value',16,1,0,2,3,'OutPut','CGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',39,'OutPutSGSTCESS Value',16,1,0,2,3,'OutPut','SGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',40,'OutPutIGSTCESS Value',16,1,0,2,3,'OutPut','IGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',41,'OutPutUTGSTCESS Value',16,1,0,2,3,'OutPut','UTGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',42,'OutPutGSTCESS Value',16,1,0,2,3,'OutPut','GSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',43,'DiffCGST Value',16,1,0,2,3,'Differential of','CGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',44,'DiffSGST Value',16,1,0,2,3,'Differential of','SGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',45,'DiffIGST Value',16,1,0,2,3,'Differential of','IGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',46,'DiffUTGST Value',16,1,0,2,3,'Differential of','UTGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',47,'DiffCGSTCESS Value',16,1,0,2,3,'Differential of','CGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',48,'DiffSGSTCESS Value',16,1,0,2,3,'Differential of','SGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',49,'DiffIGSTCESS Value',16,1,0,2,3,'Differential of','IGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',50,'DiffUTGSTCESS Value',16,1,0,2,3,'Differential of','UTGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',51,'DiffGSTCESS Value',16,1,0,2,3,'Differential of','GSTCESS','Input OutPut Tax Amount',2,GETDATE()
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptHSNInputTaxGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptHSNInputTaxGST]
GO
/*
BEGIN tran
EXEC Proc_RptHSNInputTaxGST 423,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [dbo].[Proc_RptHSNInputTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptHSNOutPutTax
* PURPOSE	: To get the HSN Wise Tax Report
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 21/01/2021    Deepan			CRCRSTPAR0110	   CR		GST Invoice number included reports	 

*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptHSNInputTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		
		SELECT DISTINCT P.Prdid,ColumnValue as HSNCODE 
		INTO #HSNCODE
		FROM UdcHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
		and C.UdcMasterId=B.UdcMasterId 
		INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
		WHERE A.MasterName='Product Master' and B.ColumnName='HSN CODE'
	
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			SpmCode Varchar(50),
			Spmname Varchar(100),	
			HsnCode Varchar(50),
			Refid BIGINT,
			RefNo Varchar(50),
			CmpInvno Varchar(50),
			PurchaseOrderNo Varchar(50),
			GstInvoiceNumber [nvarchar](50) NULL,
			InvoiceDate Datetime,
			RefDate DateTime,
			SpmId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCESS Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT PurRcptId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseTaxableAmount
		FROM(
		SELECT S.PurRcptId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId
		WHERE  TaxableAmount>0 and Status=1
		AND SI.InvDate  Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.PurRcptId,PrdSlno ,TaxId
		)X GROUP BY PurRcptId,Prdslno,TaxId
		
		SELECT PurRetId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseRtnTaxableAmount
		FROM(
		SELECT S.PurRetId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId
		WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1
		GROUP BY S.PurRetId,PrdSlno,TaxId
		)X GROUP BY  PurRetId,Prdslno,TaxId
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE InvDate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE InvDate Between @FromDate and @ToDate
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		
		
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		
		UPDATE #TaxHSNSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TaxHSNSummary T INNER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON T.CmpInvno=PG.CompInvNo
		WHERE T.TaxType='Purchase of Goods'
		
		UPDATE #TaxHSNSummary SET GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #TaxHSNSummary T INNER JOIN PurchaseReturn PR(NOLOCK) ON T.RefNo=PR.PurRetRefNo
		INNER JOIN  PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON PR.CmpInvNo=PG.CompInvNo
		WHERE T.TaxType='Purchase Return of Goods'
		
		--ILCRSTBOT0006
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','OutputGSTCESS','GSTCESS','INputGSTCESS')		
		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		
		--ILCRSTBOT0006
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,
		Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,'' AS GstInvoiceNumber,NUll,Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
	
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN
		FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId
		
		SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo
		INTO #Refcode
		FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId
		
		UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo 
		FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount),'
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY AS VARCHAR(4000)
		DECLARE @GROUPBYCOL AS VARCHAR(4000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''
		SET @GROUPBYCOL = ''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount),SUM(TaxableAmountCESS),'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		SpmId INT,
		SpmCode Varchar(50),
		Spmname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		CmpInvno Varchar(50),
		PurchaseOrderNo Varchar(50),
		GstInvoiceNumber NVarchar(50),
		InvoiceDate Datetime,
		RefDate DateTime,
		HsnCode Varchar(50),	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),
		TaxableAmountCESS Numeric(34,4),'
		SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount) TaxableAmount,SUM(TaxableAmountCESS) TaxableAmountCESS,SUM(NetAmount) NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		
		SET @GROUPBY =' GROUP BY StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] '
		 
		SET @GROUPBYCOL=' GROUP BY  StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,GstInvoiceNumber,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptHSNInputTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptHSNInputTaxGST'+
		' CREATE TABLE RptHSNInputTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptHSNInputTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+ @GROUPBY +
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBYCOL + @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		SELECT DISTINCT
		StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,HsnCode,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptHSNInputTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,423,'HSN Code Wise Input Tax',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',9,'GstInvoiceNumber',75,1,0,1,1,'Gst','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',10,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',11,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',12,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',13,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',14,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',15,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
	
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				19,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			19,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptHSNInputTaxGST)
			BEGIN
				SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
END
GO
DELETE FROM Report_Template_GST where rptid=425 AND ColId =22
INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,
HeaderCaption2,RoundOff,CreatedDate)
SELECT 1,425,'FORM GSTR2-B2B',22,'GstInvoiceNumber',50,1,0,1,1,'Gst','Invoice','Number',0,GETDATE() 
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptGSTR2_B2B]') AND type in (N'U'))
DROP TABLE [dbo].[RptGSTR2_B2B]
GO
CREATE TABLE [dbo].[RptGSTR2_B2B](
	[Slno] [int] IDENTITY(1,1) NOT NULL,
	[Your GSTIN] [varchar](50) NULL,
	[Return Period] [varchar](20) NULL,
	[GSTIN of Supplier] [varchar](50) NULL,
	[Invoice Num] [varchar](50) NULL,
	[Invoice Date] [datetime] NULL,
	[Invoice Value] [numeric](32, 6) NULL,
	[Place of supply] [varchar](50) NULL,
	[Invoice type] [varchar](10) NULL,
	[Serial no] [int] NULL,
	[Tax Rate] [numeric](10, 2) NULL,
	[Taxable value] [numeric](32, 6) NULL,
	[IGST] [numeric](32, 6) NULL,
	[CGST] [numeric](32, 6) NULL,
	[SGST] [numeric](32, 6) NULL,
	[CESS] [numeric](32, 6) NULL,
	[ITC IGST Amt] [numeric](32, 6) NULL,
	[ITC CGST Amt] [numeric](32, 6) NULL,
	[ITC SGST Amt] [numeric](32, 6) NULL,
	[ITC Cess Amt] [numeric](32, 6) NULL,
	[Eligibility] [varchar](10) NULL,
	[Reverse Charge] [varchar](10) NULL,
	[UsrId] [int] NULL,
	[Group Name] [varchar](100) NULL,
	[GroupType] [tinyint] NULL,
	[GstInvoiceNumber] [nvarchar](50) NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptGSTR2_B2B]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptGSTR2_B2B]
GO
--EXEC Proc_RptGSTR2_B2B 425,2,0,'',0,0,1
CREATE PROCEDURE [dbo].[Proc_RptGSTR2_B2B]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_B2B
* PURPOSE    : To Generate GSTR2 B2B Report
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
----------------------------------------------------------------------------------------------
* DATE        AUTHOR             CR/BZ	 USER STORY ID       DESCRIPTION   
----------------------------------------------------------------------------------------------
17-08-2018	  Muthulakshmi.V	  BZ	 ILCRSTNIV0599		 GSTR2 Report - REFRESH ISSUE FIX
* 12/03/2019    Venkat. M           ILCRSTZYD1119				Included KERALA CESS Tax
**********************************************************************************************/
BEGIN
SET NOCOUNT ON		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_B2B
		--ILCRSTNIV0599  From here
		DELETE FROM  ReportFilterDt WHERE RptId IN(425,426,427,428,429,430) 
		INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)
		SELECT 425,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 426,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 427,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 428,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 429,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId	
		UNION ALL
		SELECT 430,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		--ILCRSTNIV0599   Till here
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=8
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
		
		CREATE TABLE #RptGSTR2_B2B
		(
		TRANSID	TINYINT	,
		SpmId	INT,
		[Your GSTIN]	Varchar(50),
		[Return Period]	Varchar(20),
		[GSTIN of Supplier]	Varchar(50),
		[Refid] BIGINT,		
		[Invoice Num]	Varchar(50),
		[Invoice Date]	DateTime,
		GstInvoiceNumber NVarchar(50),
		[Invoice Value]	Numeric(32,6),
		[Place of supply]	Varchar(50),
		[Invoice type]	Varchar(10),
		[Serial no]	INT,
		[Tax Rate]	Numeric(10,2),
		[Taxable value]	Numeric(32,6),
		[IGST]	Numeric(32,6),
		[CGST]	Numeric(32,6),
		[SGST]	Numeric(32,6),
		[CESS]	Numeric(32,6),
		[ITC IGST Amt]	Numeric(32,6),
		[ITC CGST Amt]	Numeric(32,6),
		[ITC SGST Amt]	Numeric(32,6),
		[ITC Cess Amt]	Numeric(32,6),
		[Eligibility]	Varchar(10),
		[Reverse Charge]	Varchar(10)
		)
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		--Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		----IDT GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=37 and ColumnName='GSTIN'
		--Retailer GSTIN
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		--Retailer Registered
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerRegistered
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and UT.ColumnValue='Registered'
		
		--Retailer State
		SELECT DISTINCT  Rtrid as Rtrid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name' 
		
		--Supplier State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name' 
		
		----IDT State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #IDTState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=37 and ColumnName='State Name' 
	
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
	
		SELECT SpmId,X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Pruchase
		FROM(
				SELECT SpmId,S.PurRcptId,CmpInvNo,InvDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputGSTCess','CESS','GSTCESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess')
				 THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM PurchaseReceipt S (NOLOCK) 
				INNER JOIN PurchaseReceiptProductTax ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
				and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess',
				'InputGSTCess','CESS','GSTCESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.PurRcptId,CmpInvNo,InvDate,Prdslno,ST.TaxableAmount,TaxCode,SpmId
			)	X 
			GROUP BY X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,TaxableAmount,SpmId
			ORDER BY X.Prdslno
			
			
			SELECT S.PurRcptId,SUM(PrdNetAmount) as PrdNetAmount
			INTO #PurchaseReceiptProduct
			FROM PurchaseReceipt S (NOLOCK) 
			INNER JOIN PurchaseReceiptProduct ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
			WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
			GROUP BY S.PurRcptId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #Pruchase A INNER JOIN #PurchaseReceiptProduct B
			ON A.PurRcptId=B.PurRcptId
						
			---Sales Return		
			SELECT RtrId,X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #SalesReturn
			FROM(
				SELECT R.Rtrid,S.ReturnID,ReturnCode,ReturnDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmt) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputGSTCESS','GSTCESS','CESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS')
				 THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.RtrId
				INNER JOIN #Sales C ON C.SalId=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
				and TaxCode IN ('InputGSTCESS','OutputGSTCESS','GSTCESS','CESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputGSTCess','OutputGSTCess','CESS','GSTCESS','InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS'
				,'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS')
				and ST.TaxableAmt>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode,R.Rtrid
			)	X 
			GROUP BY X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,RtrId
			ORDER BY X.Prdslno	
			
						
			SELECT S.ReturnID,SUM(PrdNetAmt) as PrdNetAmount
			INTO #SalesReturnProduct
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProduct ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.ReturnID
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #SalesReturn A INNER JOIN #SalesReturnProduct B
			ON A.ReturnID=B.ReturnID
			
			-----IDT IN
			
			SELECT FromSpmId,IDTMngRefNo,IDTMngDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #IDTIN
			FROM(
				SELECT FromSpmId,S.IDTMngRefNo,IDTMngDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM IDTManagement S (NOLOCK) 
				INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
				and StkMgmtTypeId=1
				and TaxCode IN ('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.IDTMngRefNo,IDTMngDate,Prdslno,TaxCode,FromSpmId
			)	X 
			GROUP BY IDTMngRefNo,IDTMngDate,X.Prdslno,FromSpmId
			ORDER BY X.Prdslno	
						
			SELECT S.IDTMngRefNo,SUM(PrdNetAmount) as PrdNetAmount
			INTO #IDTProduct
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProduct ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.IDTMngRefNo
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #IDTIN A INNER JOIN #IDTProduct B
			ON A.IDTMngRefNo=B.IDTMngRefNo
			
			---Service Invoice
			SELECT ServiceFromId,X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #ServiceRetailer
			FROM(
				SELECT ServiceFromId,S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM ServiceInvoiceHd S (NOLOCK) 
				INNER JOIN ServiceInvoiceTaxDetails ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.ServiceFromId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
				and ServiceInvFor=1
				and TaxCode IN ('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				--and ReverseCharges=0
				GROUP BY S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,TaxCode,ServiceFromId
			)	X 
			GROUP BY X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,ServiceFromId
			ORDER BY X.RowNo
			
			SELECT S.ServiceInvId,SUM(TotServiceAmount) as PrdNetAmount
			INTO #ServiceLineAmt
			FROM ServiceInvoiceHd S (NOLOCK) 
			INNER JOIN ServiceInvoiceDT ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
			WHERE Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
			--and ReverseCharges=0
			GROUP BY S.ServiceInvId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #ServiceRetailer A INNER JOIN #ServiceLineAmt B
			ON A.ServiceInvId=B.ServiceInvId
						
			----Purchase
			 
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 1 AS TRANSID,SpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],X.PurRcptId,CmpInvNo,InvDate,
			PrdNetAmount as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by X.PurRcptId ORDER BY Taxperc,X.PurRcptId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(X.TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #Pruchase X 
			GROUP BY Taxperc,X.PurRcptId,CmpInvNo,InvDate,SpmId,PrdNetAmount
		---Sales Return
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 2 AS TRANSID,RtrId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ReturnID,ReturnCode,ReturnDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ReturnID ORDER BY Taxperc,ReturnID ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #SalesReturn
			GROUP BY Taxperc,ReturnID,ReturnCode,ReturnDate,RtrId,PrdNetAmount
		-----IDT IN	
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 3 AS TRANSID,FromSpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],0,IDTMngRefNo,IDTMngDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by IDTMngRefNo ORDER BY Taxperc,IDTMngRefNo ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #IDTIN
			GROUP BY Taxperc,IDTMngRefNo,IDTMngDate,FromSpmId,PrdNetAmount
			
		-----Service Invoice Retailer		
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 4 AS TRANSID,ServiceFromId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ServiceInvId,ServiceInvRefNo,ServiceInvDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ServiceInvId ORDER BY Taxperc,ServiceInvId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #ServiceRetailer
			GROUP BY Taxperc,ServiceInvRefNo,ServiceInvDate,ServiceFromId,ServiceInvId,PrdNetAmount	
			
			--GSTIN
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTSupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
			--Place Of Supply
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierState B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTState B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
			
			
			UPDATE #RptGSTR2_B2B SET  GstInvoiceNumber=PG.GSTInvoiceNumber
		FROM #RptGSTR2_B2B T INNER JOIN PurchaseReceiptGstInvoiceNumber PG(NOLOCK) ON T.[Invoice Num]=PG.CompInvNo
		WHERE T.TransId=1
			
		
		UPDATE #RptGSTR2_B2B SET [Invoice Value] = 0 WHERE CESS >0 AND [ITC Cess Amt]>0
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_B2B)
		BEGIN
			INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],GstInvoiceNumber,
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],'' AS GstInvoiceNumber,
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],0 as [IGST],0 as [CGST],0 as [SGST],0 as [CESS],0 as [ITC IGST Amt],0 as [ITC CGST Amt],0 as [ITC SGST Amt],
			0 as [ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
			
			SELECT * FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			
			DELETE FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],GstInvoiceNumber,
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT 	[Your GSTIN],@ReturnPeriod as [Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],GstInvoiceNumber,
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
			FROM #RptGSTR2_B2B
		
		SELECT 
			SUM(IGST) as [IGST],
			SUM([CGST]) as [CGST],
			SUM([SGST]) as [SGST],
			SUM([CESS]) as [CESS],		
			SUM([ITC IGST Amt]) as [ITC IGST Amt],
			SUM([ITC CGST Amt]) as [ITC CGST Amt],
			SUM([ITC SGST Amt]) as [ITC SGST Amt],
			SUM([ITC Cess Amt]) as [ITC Cess Amt]
		INTO #TaxTotal	
		FROM #RptGSTR2_B2B	
		
		SELECT 3 as GroupType,SUM([Invoice Value]) as [Invoice Value]
		INTO #InvoiceGT
		FROM(
		SELECT DISTINCT TransId,[Refid],[Invoice Num],[Invoice Value]
		FROM #RptGSTR2_B2B
		)X
					
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],GstInvoiceNumber,
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],'' AS GstInvoiceNumber,
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #TaxTotal
		
		UPDATE A SET A.[Invoice Value]=B.[Invoice Value] FROM  RptGSTR2_B2B A 
		INNER JOIN #InvoiceGT B ON  A.GroupType=B.GroupType
		WHERE A.GroupType=3 and UsrId=@Pi_UsrId
		
		UPDATE RptGSTR2_B2B SET [Taxable value] =(SELECT SUM([Taxable value])
		FROM #RptGSTR2_B2B WHERE [CESS]=0) WHERE GroupType=3 and UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTR2_B2B (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
---E-Invoice starts
DELETE FROM ManualConfiguration WHERE ModuleId='E-Invoice'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','E-Invoice','E-Invoice','Allow to generate E-invoice',1,'',0.00,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='E-Invoice-API'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','E-Invoice-API','E-Invoice','Allow to generate E-invoice-API',1,'',0.00,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='E-Invoice-JSON'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','E-Invoice-JSON','E-Invoice','Allow to generate E-invoice-JSON',1,'',0.00,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='E-Invoice-Sales-Print'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','E-Invoice-Sales-Print','Bill Print','Without IRN should not allow to print invoice',0,'',0.00,1
GO
DELETE FROM ManualConfiguration WHERE ModuleId='E-Invoice-Return-Print'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','E-Invoice-Return-Print','Bill Print','Without IRN should not allow to print invoice',0,'',0.00,1
GO
IF EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='RptBillTemplateFinal'  AND S.Name='SignedQRCode')
BEGIN
	ALTER TABLE RptBillTemplateFinal DROP COLUMN  SignedQRCode
END
GO
IF NOT EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='RptBillTemplateFinal'  AND S.Name='Irn')
BEGIN
	ALTER TABLE RptBillTemplateFinal ADD  Irn Varchar(100)
END
GO
IF NOT EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='RptBillTemplateFinal'  AND S.Name='SignedInvoice')
BEGIN
	ALTER TABLE RptBillTemplateFinal ADD  SignedInvoice Varchar(8000)
END
GO
IF NOT EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='RptBillTemplateFinal'  AND S.Name='SignedQRCode')
BEGIN
	ALTER TABLE RptBillTemplateFinal ADD  SignedQRCode  VARBINARY(MAX)
END
GO
IF EXISTS (SELECT 'X'  FROM sys.columns S INNER JOIN Sys.objects  SO ON S.object_id=SO.object_id
AND SO.Name='RptSRNSALESRETURN'  AND S.Name='SignedQRCode')
BEGIN
	ALTER TABLE RptSRNSALESRETURN DROP COLUMN  SignedQRCode
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='Irn' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD Irn Varchar(100) 
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedInvoice' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD SignedInvoice Varchar(8000)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedQRCode' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD SignedQRCode VARBINARY(MAX)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TempEInvoice')
DROP TABLE TempEInvoice
GO
CREATE TABLE [TempEInvoice](
	[InvId] [int] NULL,
	[TransId] [int] NULL,
	[InvoiceNo] [nvarchar](100) NULL,
	[InvStatus] [int] NULL
)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Tbl_ECockPitStatus')
DROP TABLE Tbl_ECockPitStatus
GO
CREATE TABLE [Tbl_ECockPitStatus](
	[Id] [int] NULL,
	[Status] [varchar](10) NULL
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Tbl_EInvoiceIntegration')
DROP TABLE Tbl_EInvoiceIntegration
GO
CREATE TABLE Tbl_EInvoiceIntegration
(
	[SequenceNo] [int] NULL,
	[ProcessName] [varchar](100) NULL,
	[TableName] [varchar](100) NULL,
	[SPName] [varchar](100) NULL,
	[Active] TinyInt,
	[CreatedDate] [datetime] NULL,
)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoiceErrorLog')
DROP TABLE EInvoiceErrorLog
GO
CREATE TABLE [EInvoiceErrorLog]
(
	[SlNo] [int] NULL,
	[RefNo] [nvarchar](100) NULL,
	[ErrDesc] [nvarchar](500) NULL
)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoiceAttempt')
DROP TABLE EInvoiceAttempt
GO
CREATE TABLE [EInvoiceAttempt]
(
	[IPAddress] [varchar](300) NULL,
	[Status] [int] NULL,
	[StartTime] [datetime] NULL
) 
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Tbl_EInvoiceIntegration')
DROP TABLE Tbl_EInvoiceIntegration
GO
CREATE TABLE Tbl_EInvoiceIntegration
(
	[SequenceNo] [int] NULL,
	[ProcessName] [varchar](100) NULL,
	[TableName] [varchar](100) NULL,
	[SPName] [varchar](100) NULL,
	[Active] TinyInt,
	[CreatedDate] [datetime] NULL,
	
)
GO
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (1,'Sales','RptEInvoice_Sales','Proc_RptEInvoice_Sales',1,Getdate())
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (2,'Return','RptEInvoice_Sales','Proc_RptEInvoice_SalesReturn',1,Getdate())
--Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (3,'Purchase Return','RptEInvoice_Sales','Proc_RptEInvoice_PurchaseReturn',0,Getdate())
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (4,'IDT Sales','RptEInvoice_Sales','Proc_RptEInvoice_IDTSales',1,Getdate())
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Columns')
DROP TABLE EInvoice_Columns
GO
CREATE TABLE EInvoice_Columns
(
	SLNO INT,
	NodeId INT,
	TransType Varchar(50),
	ColumnName Varchar(150),
	ColRequired TINYINT
)
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Acknowledgment')
BEGIN
CREATE TABLE EInvoice_Acknowledgment
(
	TransId	 TINYINT,
	Invoice_Id	BIGINT,
	Invoice_no  Varchar(50),
	Invoice_date Datetime,
	Ack_Number Varchar(200),
	Ack_Date Datetime,
	Irn Varchar(100),
	SignedInvoice Varchar(Max),
	SignedQRCode Varchar(Max),
	QRCodeImage Varbinary(Max),
	Ack_Status varchar(20),
	Response_Status TINYINT,
	Err_code Varchar(50),
	Err_desc Varchar(5000),
	Lastmoddate Datetime,
	MovedOnDate Datetime,
	CancelDate DateTime,
	CONSTRAINT PK_EInvoice_Acknowledgment PRIMARY KEY CLUSTERED 
	(
	TransId,Invoice_Id,Invoice_no ASC
	)
)
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSCOLUMNS A INNER JOIN SYSOBJECTS B ON A.id=B.Id WHERE B.XTYPE='U' AND B.NAME='EInvoice_Acknowledgment' AND A.NAME='CancelDate')
BEGIN
	ALTER TABLE EInvoice_Acknowledgment Add CancelDate DateTime
END
GO
IF NOT EXISTS(SELECT A.NAME FROM SYSCOLUMNS A INNER JOIN SYSOBJECTS B ON A.id=B.Id WHERE B.XTYPE='U' AND B.NAME='EInvoice_Acknowledgment' AND A.NAME='QRCodeImage')
BEGIN
	ALTER TABLE EInvoice_Acknowledgment Add QRCodeImage Varbinary(Max)
END
GO
IF EXISTS(SELECT A.NAME FROM SYSCOLUMNS A INNER JOIN SYSOBJECTS B ON A.id=B.Id WHERE B.XTYPE='U' AND B.NAME='EInvoice_Acknowledgment' AND A.NAME='SignedInvoice')
BEGIN
	ALTER TABLE EInvoice_Acknowledgment ALTER COLUMN SignedInvoice VARCHAR(MAX)
END
GO
IF EXISTS(SELECT A.NAME FROM SYSCOLUMNS A INNER JOIN SYSOBJECTS B ON A.id=B.Id WHERE B.XTYPE='U' AND B.NAME='EInvoice_Acknowledgment' AND A.NAME='SignedQRCode')
BEGIN
	ALTER TABLE EInvoice_Acknowledgment ALTER COLUMN SignedQRCode VARCHAR(MAX)
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Acknowledgment_Failed')
BEGIN
CREATE TABLE EInvoice_Acknowledgment_Failed
(
	TransId	 TINYINT,
	Invoice_Id	BIGINT,
	Invoice_no  Varchar(50),
	Invoice_date Datetime,
	Err_code Varchar(50),
	Err_desc Varchar(Max),
	Lastmoddate Datetime
)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptEInvoice_ErrorDetails')
DROP TABLE RptEInvoice_ErrorDetails
GO
CREATE TABLE RptEInvoice_ErrorDetails
(
	[Transaction Type] Varchar(50),
	[Reference No] Varchar(50),
	[Reference Date] DATETIME,
	[Buyer Name] Varchar(100),
	[Buyer GSTIN] Varchar(20),
	Err_desc Varchar(Max)
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_ErrorLog')
DROP TABLE EInvoice_ErrorLog
GO
CREATE TABLE EInvoice_ErrorLog
(
	SLNO INT,
	ProcessName Varchar(100),
	ErrorDesc Varchar(Max)	
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_ExcelColumns')
DROP TABLE EInvoice_ExcelColumns
GO
CREATE TABLE EInvoice_ExcelColumns
(
	SLNO INT,
	ColumnName Varchar(100),
	ColRequired Tinyint
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptEInvoice_Custom_report')
DROP TABLE RptEInvoice_Custom_report
GO
CREATE TABLE [RptEInvoice_Custom_report](
	[Catg] [varchar](5) NULL,
	[RegRev] [varchar](4) NULL,
	[Typ] [varchar](5) NULL,
	[EcmTrn] [varchar](2) NULL,
	[EcmGstin] [varchar](20) NULL,
	[DTyp] [varchar](5) NULL,
	[No] [varchar](16) NULL,
	[Dt] [datetime] NULL,
	[OrgInvNo] [varchar](16) NULL,
	[Gstin] [varchar](15) NULL,
	[TrdNm] [varchar](100) NULL,
	[Bno] [varchar](60) NULL,
	[Bnm] [varchar](60) NULL,
	[Flno] [varchar](60) NULL,
	[Loc] [varchar](60) NULL,
	[Dst] [varchar](60) NULL,
	[Pin] [varchar](6) NULL,
	[Stcd] [varchar](2) NULL,
	[Ph] [varchar](10) NULL,
	[Em] [varchar](50) NULL,
	[BGstin] [varchar](15) NULL,
	[BTrdNm] [varchar](100) NULL,
	[BBno] [varchar](60) NULL,
	[BBnm] [varchar](60) NULL,
	[BFlno] [varchar](60) NULL,
	[BLoc] [varchar](60) NULL,
	[BDst] [varchar](60) NULL,
	[BPin] [varchar](6) NULL,
	[BStcd] [varchar](2) NULL,
	[BPh] [varchar](10) NULL,
	[BEm] [varchar](50) NULL,
	[ShipGstin] [varchar](15) NULL,
	[ShipTrdNm] [varchar](100) NULL,
	[ShipBno] [varchar](60) NULL,
	[ShipBnm] [varchar](60) NULL,
	[ShipFlno] [varchar](60) NULL,
	[ShipLoc] [varchar](60) NULL,
	[ShipDst] [varchar](60) NULL,
	[ShipPin] [varchar](6) NULL,
	[ShipStcd] [varchar](2) NULL,
	[ShipPh] [varchar](10) NULL,
	[ShipEm] [varchar](50) NULL,
	[PrdNm] [varchar](100) NULL,
	[PrdDesc] [varchar](100) NULL,
	[HsnCd] [varchar](8) NULL,
	[Barcde] [varchar](30) NULL,
	[Qty] [numeric](18, 2) NULL,
	[FreeQty] [numeric](18, 2) NULL,
	[Unit] [varchar](3) NULL,
	[UnitPrice] [numeric](18, 6) NULL,
	[TotAmt] [numeric](18, 6) NULL,
	[Discount] [numeric](18, 6) NULL,
	[OthChrg] [numeric](18, 6) NULL,
	[AssAmt] [numeric](18, 6) NULL,
	[CgstRt] [numeric](8, 2) NULL,
	[SgstRt] [numeric](8, 2) NULL,
	[IgstRt] [numeric](8, 2) NULL,
	[CesRt] [numeric](8, 2) NULL,
	[CesNonAdval] [numeric](8, 3) NULL,
	[StateCes] [numeric](8, 3) NULL,
	[TotItemVal] [numeric](18, 6) NULL,
	[AssVal] [numeric](18, 6) NULL,
	[CgstVal] [numeric](18, 6) NULL,
	[SgstVal] [numeric](18, 6) NULL,
	[IgstVal] [numeric](18, 6) NULL,
	[CesVal] [numeric](18, 6) NULL,
	[StCesVal] [numeric](18, 6) NULL,
	[TCesNonAdVal] [numeric](18, 6) NULL,
	[Disc] [numeric](18, 6) NULL,
	[TOthChrg] [numeric](18, 6) NULL,
	[TotInvVal] [numeric](18, 6) NULL,
	[ExcelAssVal] [numeric](18, 6) NULL,
	[ExcelCgstVal] [numeric](18, 6) NULL,
	[ExcelSgstVal] [numeric](18, 6) NULL,
	[ExcelIgstVal] [numeric](18, 6) NULL,
	[ExcelCesVal] [numeric](18, 6) NULL,
	[ExcelStCesVal] [numeric](18, 6) NULL,
	[ExcelTCesNonAdVal] [numeric](18, 6) NULL,
	[ExcelDisc] [numeric](18, 6) NULL,
	[ExcelTOthChrg] [numeric](18, 6) NULL,
	[ExcelTotInvVal] [numeric](18, 6) NULL,
	[TransId] [tinyint] NULL,
	[Invoice_Id] [bigint] NULL,
	[StockType] [tinyint] NULL,
	[PrdId] [int] NULL,
	[RtrId] [int] NULL,
	[ExcelTaxRate] [varchar](50) NULL,
	[ExcelInvoiceType] [varchar](20) NULL,
	[ExcelSubCategory] [varchar](20) NULL,
	[ExcelEcomTran] [varchar](5) NULL,
	[ExcelUnits] [varchar](20) NULL,
	[ExcelStateName] [varchar](100) NULL,
	[GstRt] [numeric](8, 2) NULL,
	[OrdLineRef] [varchar](50) NULL,
	[OrgCntry] [varchar](50) NULL,
	[SellerState] [varchar](100) NULL,
	[IsService] [varchar](2) NULL,
	[RndOffAmt] [numeric](18, 2) NULL,
	[TotInvValFc] [numeric](18, 6) NULL,
	[PrdSlno] [int] NULL,
	[PreTaxVal] [numeric](18, 6) NULL,
	OrgInvDt datetime,
	CRAdjAmount [numeric](18, 6) NULL
)
GO
DELETE FROM Tbl_ECockPitStatus
INSERT INTO Tbl_ECockPitStatus([Id],Status)
SELECT 0,'Pending' UNION ALL
SELECT 1,'Success' UNION ALL
SELECT 2,'Failure'
GO
DELETE FROM EInvoice_ExcelColumns
INSERT INTO EInvoice_ExcelColumns(SLNO,ColumnName,ColRequired)
SELECT 1,'Catg AS [Category]',1
UNION ALL
SELECT 2,'RegRev AS [Sub Category]',1
UNION ALL
SELECT 3,''''' AS [Igst On Intra]',1
UNION ALL
SELECT 4,'ExcelEcomTran AS [E-Com Trn]',0
UNION ALL
SELECT 5,'EcmGstin AS [E-Com GSTIN]',1
UNION ALL
SELECT 6,'ExcelInvoiceType as [Doc Type]',1
UNION ALL
SELECT 7,'No as [Doc No]',1
UNION ALL
SELECT 8,'Dt as [Doc Date]',1
UNION ALL
SELECT 9,'BGstin AS [Buyer GSTIN]',1
UNION ALL
SELECT 10,'BTrdNm as [Buyer Legal Name]',1
UNION ALL
SELECT 11,'BTrdNm as [Buyer Trade Name]',1
UNION ALL
SELECT 12,'BStcd as [Byer POS]',1
UNION ALL
SELECT 13,'BBno as [Buyer address1]',1
UNION ALL
SELECT 14,'BBnm as [Buyer address2]',1
UNION ALL
SELECT 15,'Em AS [Email Id]',0
UNION ALL
SELECT 16,'BLoc as [Byer Location]',1
UNION ALL
SELECT 17,'BPin as [Buyer PinCode]',1
UNION ALL
SELECT 18,'BStcd as [Byer State]',1
UNION ALL
SELECT 19,'BPh as [Byer Phone Number]',1
UNION ALL
SELECT 20,'BEm as [Byer Email Id]',1
UNION ALL
SELECT 21,'TrdNm as [Dispatch Name]',1
UNION ALL
SELECT 22,'Bno AS [Dispatch Address1]',1
UNION ALL
SELECT 23,'Bnm AS [Dispatch Address2]',1
UNION ALL
SELECT 24,'Loc AS [Dispatch Location]',1
UNION ALL
SELECT 25,'Pin AS [Dispatch PinCode]',1
UNION ALL
SELECT 26,'SellerState AS [Dispatch State]',1
UNION ALL
SELECT 27,'ShipGstin as [Shipping Gstin]',1
UNION ALL
SELECT 28,'ShipTrdNm as [Shipping Legal Name]',1
UNION ALL
SELECT 29,'ShipTrdNm as [Shipping Trade Name]',1
UNION ALL
SELECT 30,'ShipBno as [Shipping Addr1]',1
UNION ALL
SELECT 31,'ShipBnm as [Shipping Addr2]',1
UNION ALL
SELECT 32,'ShipLoc as [Shipping Location]',1
UNION ALL
SELECT 33,'ShipPin as [Shipping Pin Code]',1
UNION ALL
SELECT 34,'ShipStcd as [Shipping State]',1
UNION ALL
SELECT 35,'BFlno as [Floor No]',0
UNION ALL
SELECT 36,'BDst as [District]',0
UNION ALL
SELECT 37,'OrgInvNo AS [Original Inv No]',0
UNION ALL
SELECT 38,'Gstin AS [Seller GSTIN]',0
UNION ALL
SELECT 39,'TrdNm AS [Legal Name]',0
UNION ALL
SELECT 40,'Flno AS [Floor No]',0
UNION ALL
SELECT 41,'Dst AS [District]',0
UNION ALL
SELECT 42,'ExcelStateName as [State]',0
UNION ALL
SELECT 43,'PrdSlno as SlNo',1
UNION ALL
SELECT 44,'PrdNm AS [Product Name]',0
UNION ALL
SELECT 45,'PrdDesc AS [Product Description]',1
UNION ALL
SELECT 46,'''No'' AS [Is Service]',1
UNION ALL
SELECT 47,'HsnCd AS [HSN Code]',1
UNION ALL
SELECT 48,'Barcde AS [Bar Code]',1
UNION ALL
SELECT 49,'Qty AS [Quantity]',1
UNION ALL
SELECT 50,'FreeQty',1
UNION ALL
SELECT 51,'ExcelUnits as Unit',1
UNION ALL
SELECT 52,'CAST(ROUND(UnitPrice,2,1) as Numeric(18,2)) as UnitPrice',1
UNION ALL   
SELECT 53,'ROUND(TotAmt,2,1)  AS [Total Amt (Qty*Unit Price)]',1
UNION ALL
SELECT 54,'ROUND(Discount,2,1)  AS Discount',1
UNION ALL
SELECT 55,'0  AS [Pre Tax Value]',1
UNION ALL
SELECT 56,'ROUND(AssAmt,2,1)  AS [Assessable Amount]',1
UNION ALL
SELECT 57,'GstRt',1
UNION ALL
SELECT 58,'ROUND(SgstVal,2,1)  as SgstAmt',1
UNION ALL
SELECT 59,'ROUND(CgstVal,2,1) as CgstAmt',1
UNION ALL
SELECT 60,'ROUND(IgstVal,2,1) as IgstAmt',1
UNION ALL
SELECT 61,'CesRt',1
UNION ALL
SELECT 62,'ROUND(CesVal,2,1) as CesAmt',1
UNION ALL
SELECT 63,'CesNonAdval',1
UNION ALL
SELECT 64,'StateCes  AS [State Cess] ',1
UNION ALL
SELECT 65,'StCesVal',1
UNION ALL
SELECT 66,'TCesNonAdVal as CesNonAdVal',1
UNION ALL
SELECT 67,'OthChrg  AS [Other Charges]',1
UNION ALL
SELECT 68,'ROUND(TotItemVal,2,1)  AS [Total Item Value] ',1 
UNION ALL
SELECT 69,''''' AS [Batch Name]',1
UNION ALL
SELECT 70,''''' AS [Batch Exp Dt]',1
UNION ALL
SELECT 71,''''' AS [Warranty Dt]',1
UNION ALL
SELECT 	72,'ROUND(ExcelAssVal,2,1) AS [Total Assessable Value]',1 
UNION ALL
SELECT 	73,'ROUND(ExcelSgstVal,2,1) AS [Total SGST Value]',1 
UNION ALL
SELECT 	74,'ROUND(ExcelCgstVal,2,1) AS [Total CGST Value]',1 
UNION ALL
SELECT 	75,'ROUND(ExcelIgstVal,2,1) AS [Total IGST Value]',1 
UNION ALL
SELECT 	76,'ROUND(ExcelCesVal,2,1) AS [Total CESS Value]',1 
UNION ALL
SELECT 	77,'ROUND(ExcelStCesVal,2,1) AS [Total State Cess Value]',1 
UNION ALL
SELECT 	78,'ROUND(ExcelTCesNonAdVal,2,1) AS [Total Cess Non Advol]',0 
UNION ALL		
--SELECT 	79,'ROUND(ExcelDisc,2,1) AS [Discount On Invoice]',1 
SELECT 	79,'''0'' AS [Discount On Invoice]',1
UNION ALL
SELECT 	80,'ROUND(ExcelTOthChrg,2,1) AS [Other Charges On Invoice]',1 
UNION ALL
SELECT 81,'RndOffAmt as RndOffAmt',1
UNION ALL
SELECT 	82,'ROUND(ExcelTotInvVal,2,1) AS [Total Invoice Value]',0 
UNION ALL
SELECT 83,'TotInvValFc as TotInvValFc',1
UNION ALL
SELECT 84,'SgstRt AS [SGST] ',0
UNION ALL
SELECT 85,'CgstRt AS [CGST] ',0
UNION ALL
SELECT 86,'CesVal',0
UNION ALL
SELECT 87,'ExcelTaxRate  AS [Tax Rate]',0 
UNION ALL
SELECT 88,'IgstRt AS [IGST] ',0
UNION ALL
SELECT 89,'CesRt AS [CESS] ',0
UNION ALL
SELECT 90,'SgstVal',0
UNION ALL
SELECT 91,'OrdLineRef',0
UNION ALL
SELECT 92,'Ph AS [Phone Number]',0
GO
INSERT INTO EInvoice_Columns(SLNO,NodeId,TransType,ColumnName,ColRequired)
SELECT 1,1,'TranDtls','''GST'' as TaxSch',1
UNION ALL
SELECT 2,1,'TranDtls','Catg as SupTyp',1
UNION ALL
SELECT 3,1,'TranDtls','RegRev',1
UNION ALL
SELECT 4,1,'TranDtls','Typ',0
UNION ALL
SELECT 5,1,'TranDtls','EcmTrn',0
UNION ALL
SELECT 6,1,'TranDtls','null as EcmGstin',1
UNION ALL
SELECT 1,2,'DocDtls','DTyp as Typ',1
UNION ALL
SELECT 2,2,'DocDtls','No',1
UNION ALL
SELECT 3,2,'DocDtls','Dt',1
UNION ALL
SELECT 4,2,'DocDtls','OrgInvNo',0
UNION ALL
SELECT 1,3,'SellerDtls','Gstin',1
UNION ALL
SELECT 2,3,'SellerDtls','TrdNm as LglNm',1
UNION ALL
SELECT 3,3,'SellerDtls','TrdNm',1
UNION ALL
SELECT 4,3,'SellerDtls','Bno as Addr1',1
UNION ALL
SELECT 5,3,'SellerDtls','Bnm as Addr2',0
UNION ALL
SELECT 6,3,'SellerDtls','Flno',0
UNION ALL
SELECT 7,3,'SellerDtls','Loc',1
UNION ALL
SELECT 8,3,'SellerDtls','Dst',0
UNION ALL
SELECT 9,3,'SellerDtls','CAST(Pin as BIGINT) AS Pin',1
UNION ALL
SELECT 10,3,'SellerDtls','Stcd',1
UNION ALL
SELECT 11,3,'SellerDtls','Ph',0
UNION ALL
SELECT 12,3,'SellerDtls','Em',0
UNION ALL
SELECT 1,4,'BuyerDtls','BGstin as Gstin',1
UNION ALL
SELECT 2,4,'BuyerDtls','BTrdNm as LglNm',1
UNION ALL
SELECT 3,4,'BuyerDtls','BTrdNm as TrdNm',1
UNION ALL
SELECT 4,4,'BuyerDtls','BStcd as Pos',1
UNION ALL
SELECT 5,4,'BuyerDtls','BBno as Addr1',1
UNION ALL
SELECT 6,4,'BuyerDtls','BBnm as Addr2',0
UNION ALL
SELECT 7,4,'BuyerDtls','BFlno as Flno',0
UNION ALL
SELECT 8,4,'BuyerDtls','BLoc as Loc',1
UNION ALL
SELECT 9,4,'BuyerDtls','BDst as Dst',0
UNION ALL
SELECT 10,4,'BuyerDtls','CAST(BPin as BIGINT) as Pin',1
UNION ALL
SELECT 11,4,'BuyerDtls','BStcd as Stcd',1
UNION ALL
SELECT 12,4,'BuyerDtls','BPh as Ph',0
UNION ALL
SELECT 13,4,'BuyerDtls','BEm as Em',0
UNION ALL
SELECT 1,5,'ShipDtls','ShipGstin as Gstin',0
UNION ALL
SELECT 2,5,'ShipDtls','ShipTrdNm as LglNm',0
UNION ALL
SELECT 3,5,'ShipDtls','ShipTrdNm as TrdNm',0
UNION ALL
SELECT 4,5,'ShipDtls','ShipBno as Addr1',0
UNION ALL
SELECT 5,5,'ShipDtls','ShipBnm as Addr2',0
UNION ALL
SELECT 6,5,'ShipDtls','ShipFlno as Flno',0
UNION ALL
SELECT 7,5,'ShipDtls','ShipLoc as Loc',0
UNION ALL
SELECT 8,5,'ShipDtls','ShipDst as Dst',0
UNION ALL
SELECT 9,5,'ShipDtls','CAST(ShipPin as BIGINT) as Pin',0
UNION ALL
SELECT 10,5,'ShipDtls','ShipStcd as Stcd',0
UNION ALL
SELECT 11,5,'ShipDtls','ShipPh as Ph',0
UNION ALL
SELECT 12,5,'ShipDtls','ShipEm as Em',0
UNION ALL
SELECT 1,6,'ItemList','CAST(PrdSlno as VARCHAR(10)) as SlNo',1
UNION ALL
SELECT 2,6,'ItemList','PrdNm',0
UNION ALL
SELECT 3,6,'ItemList','PrdDesc',1
UNION ALL
SELECT 4,6,'ItemList','IsService as IsServc',1
UNION ALL
SELECT 5,6,'ItemList','HsnCd',1
UNION ALL
SELECT 6,6,'ItemList','null as Barcde',1
UNION ALL
SELECT 7,6,'ItemList','Qty',1
UNION ALL
SELECT 8,6,'ItemList','FreeQty',1
UNION ALL
SELECT 9,6,'ItemList','Unit',1
UNION ALL
SELECT 10,6,'ItemList','CAST(ROUND(UnitPrice,2,1) as Numeric(18,2)) as UnitPrice',1
UNION ALL
SELECT 11,6,'ItemList','CAST(ROUND(TotAmt,2,1) as Numeric(18,2)) as TotAmt',1
UNION ALL
SELECT 12,6,'ItemList','CAST(ROUND(Discount,2,1)  as Numeric(18,2)) As Discount',1
UNION ALL
SELECT 13,6,'ItemList','PreTaxVal',0
UNION ALL
SELECT 14,6,'ItemList','CAST(ROUND(OthChrg,2,1)  as Numeric(18,2)) As OthChrg',1
UNION ALL
SELECT 15,6,'ItemList','CAST(ROUND(AssAmt,2,1)  as Numeric(18,2)) as AssAmt',1
UNION ALL
SELECT 16,6,'ItemList','GstRt',1
UNION ALL
SELECT 17,6,'ItemList','CgstRt',0
UNION ALL
SELECT 18,6,'ItemList','SgstRt',0
UNION ALL                           
SELECT 19,6,'ItemList','IgstRt',0
UNION ALL
SELECT 20,6,'ItemList','CAST(ROUND(IgstVal,2,1) as Numeric(18,2)) as IgstAmt',1
UNION ALL
SELECT 21,6,'ItemList','CAST(ROUND(CgstVal,2,1)  as Numeric(18,2)) as CgstAmt',1
UNION ALL
SELECT 22,6,'ItemList','CAST(ROUND(SgstVal,2,1)  as Numeric(18,2)) as SgstAmt',1
UNION ALL
SELECT 23,6,'ItemList','CAST(ROUND(CesRt,2,1)  as Numeric(18,2)) as CesRt',1
UNION ALL
SELECT 24,6,'ItemList','CAST(ROUND(CesVal,2,1) as Numeric(18,2)) as CesAmt',1
UNION ALL
SELECT 25,6,'ItemList','CAST(ROUND(CesNonAdval,2,1) as Numeric(18,2)) as CesNonAdvlAmt',1
UNION ALL
SELECT 26,6,'ItemList','CAST(ROUND(StateCes,2,1) as Numeric(18,2))   as StateCesRt',1
UNION ALL
SELECT 27,6,'ItemList','0 as StateCesAmt',1
UNION ALL
SELECT 28,6,'ItemList','0 as StateCesNonAdvlAmt',1
UNION ALL
SELECT 29,6,'ItemList','CAST(ROUND(TotItemVal,2,1)as Numeric(18,2)) AS TotItemVal',1
UNION ALL
SELECT 30,6,'ItemList','null as OrdLineRef',1
UNION ALL
SELECT 31,6,'ItemList','OrgCntry',0
UNION ALL
SELECT 32,6,'ItemList','PrdSlno',0
UNION ALL
SELECT 1,7,'ValDtls','CAST(ROUND(SUM(AssVal),2,1)as Numeric(18,2)) as AssVal',1
UNION ALL
SELECT 2,7,'ValDtls','CAST(ROUND(SUM(CgstVal),2,1)as Numeric(18,2)) as CgstVal',1
UNION ALL
SELECT 3,7,'ValDtls','CAST(ROUND(SUM(SgstVal),2,1) as Numeric(18,2))as SgstVal',1
UNION ALL
SELECT 4,7,'ValDtls','CAST(ROUND(SUM(IgstVal),2,1)as Numeric(18,2)) as IgstVal',1
UNION ALL
SELECT 5,7,'ValDtls','CAST(ROUND(SUM(CesVal),2,1)as Numeric(18,2)) as CesVal',1
UNION ALL
SELECT 6,7,'ValDtls','CAST(ROUND(SUM(StCesVal),2,1)as Numeric(18,2)) as StCesVal',1
UNION ALL
SELECT 7,7,'ValDtls','CAST(ROUND(SUM(TCesNonAdVal),2,1)as Numeric(18,2)) as CesNonAdVal',1
UNION ALL
SELECT 8,7,'ValDtls','CAST(ROUND(SUM(Disc),2,1)as Numeric(18,2)) as Disc',1
UNION ALL
SELECT 9,7,'ValDtls','CAST(ROUND(SUM(DISTINCT ExcelTOthChrg),2,1)as Numeric(18,2)) as OthChrg',1
UNION ALL
SELECT 10,7,'ValDtls','SUM(DISTINCT RndOffAmt) as RndOffAmt',1
UNION ALL
SELECT 11,7,'ValDtls','CAST(ROUND(SUM(DISTINCT TotInvValFc),2,1)as Numeric(18,2)) as TotInvVal',1
UNION ALL
SELECT 12,7,'ValDtls','CAST(ROUND(SUM(DISTINCT TotInvValFc),2,1)as Numeric(18,2))as TotInvValFc',0
UNION ALL
SELECT 1,8,'DispDtls','TrdNm as Nm',1
UNION ALL
SELECT 2,8,'DispDtls','Bno as Addr1',1
UNION ALL
SELECT 3,8,'DispDtls','Loc',1
UNION ALL
SELECT 4,8,'DispDtls','CAST(Pin as BIGINT) as Pin',1
UNION ALL
SELECT 5,8,'DispDtls','Stcd',1
UNION ALL
SELECT 1,9,'AddlDocDtls','''https://einv-apisandbox.nic.in'' as Url',1
UNION ALL
SELECT 2,9,'AddlDocDtls','''Test Doc'' as Docs',1
UNION ALL
SELECT 3,9,'AddlDocDtls','''Document Test'' as Info',1
UNION ALL
SELECT 1,10,'PrecDocDtls','OrgInvNo as InvNo',1
UNION ALL
SELECT 2,10,'PrecDocDtls','OrgInvDt as InvDt',1
UNION ALL
SELECT 3,10,'PrecDocDtls','null as OthRefNo',1
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_ReturnEinvoceQuery')
DROP FUNCTION Fn_ReturnEinvoceQuery
GO
/*
SELECT DBO.Fn_ReturnEinvoceQuery('ValDtls',1,'C512630717000016','RptEInvoice_Sales','CSV')
SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp as Typ,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin as Gstin,BTrdNm as TrdNm,BBno as Bno,BBnm as BBnm,BFlno as Flno,BLoc as Loc,BDst as Dst,BPin as Pin,BStcd as Stcd,BPh as Ph,BEm as Em,ShipGstin as Gstin,ShipTrdNm as TrdNm,ShipBno as Bno,ShipBnm as BBnm,ShipFlno as Flno,ShipLoc as Loc,ShipDst as Dst,ShipPin as Pin,ShipStcd as Stcd,ShipPh as Ph,ShipEm as Em,PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,UnitPrice,TotAmt,Discount,OthChrg,AssAmt,IgstRt,IgstVal,CgstRt,CgstVal,SgstRt,SgstVal,CesRt,CesVal,CesNonAdval,TCesNonAdVal as CesNonAdVal,StateCes,StCesVal,TotItemVal FROM RptEInvoice_Sales (NOLOCK)  ORDER BY TransId,Dt,No,StockType
*/
CREATE     FUNCTION [Fn_ReturnEinvoceQuery](@TransType AS Varchar(50),@TransId AS VARCHAR(50),@TransNo Varchar(50),
@Table_Name AS VARCHAR(100),@Option AS Varchar(20))  
RETURNS VARCHAR(Max)  
AS  
BEGIN  
/*********************************  
* FUNCTION: Fn_ReturnEinvoceQuery  
* PURPOSE: Retunr Query Formation
* NOTES:  
* CREATED: Murugan.R 22-01-2020  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
12/02/2020	  Mohanakrishna A.B		CR	   ILCRSTJNJ4860		   E- Invoice
21/12/2020	  Mohanakrishna A.B		CR	   CRCRSTJNJ0057		   E- Invoice
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
*********************************/  
DECLARE @SSQL AS VARCHAR(MAX)
IF @Option='JSON'
BEGIN
	IF @TransType IN('ItemList','ValDtls')
	BEGIN
		SET @SSQL='SELECT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_Columns WHERE TransType=@TransType and ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK) WHERE TransId='+@TransId+' and No='''+@TransNo+''''
	END
	ELSE
	BEGIN
		SET @SSQL='SELECT DISTINCT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_Columns WHERE TransType=@TransType and ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK) WHERE TransId='+@TransId+' and No='''+@TransNo+''''
	END
END
IF @Option='CSV'
BEGIN
		SET @SSQL='SELECT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_ExcelColumns WHERE ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK)  ORDER BY TransId,Dt,No,StockType'
END	
RETURN (@SSQL)  
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptEInvoice_Sales')
DROP TABLE RptEInvoice_Sales
GO
CREATE TABLE RptEInvoice_Sales
(
Catg Varchar(5),
RegRev Varchar(4),
Typ Varchar(5),
EcmTrn Varchar(2),
EcmGstin Varchar(20),
DTyp Varchar(5),
No Varchar(16),
Dt Varchar(10),
OrgInvNo Varchar(16),
Gstin Varchar(15),
TrdNm Varchar(100),
Bno	Varchar(60),
Bnm Varchar(60),
Flno Varchar(60),
Loc Varchar(60),
Dst Varchar(60),
Pin Varchar(6),
Stcd Varchar(2),
Ph Varchar(10),
Em Varchar(50),
BGstin Varchar(15),
BTrdNm Varchar(100),
BBno Varchar(60),
BBnm Varchar(60),
BFlno Varchar(60),
BLoc Varchar(60),
BDst Varchar(60),
BPin Varchar(6),
BStcd Varchar(100),
BPh Varchar(10),
BEm Varchar(50),
ShipGstin Varchar(15),
ShipTrdNm Varchar(100),
ShipBno Varchar(60),
ShipBnm Varchar(60),
ShipFlno Varchar(60),
ShipLoc Varchar(60),
ShipDst Varchar(60),
ShipPin Varchar(6),
ShipStcd Varchar(100),
ShipPh Varchar(10),
ShipEm Varchar(50),
PrdNm Varchar(100),
PrdDesc Varchar(100),
HsnCd Varchar(8),
Barcde  Varchar(30),
Qty  Numeric(18,2),
FreeQty  Numeric(18,2),
Unit  Varchar(3),
UnitPrice Numeric(18,6),
TotAmt Numeric(18,6),
Discount Numeric(18,6),
OthChrg Numeric(18,6),
AssAmt Numeric(18,6),
CgstRt Numeric(8,2),
SgstRt  Numeric(8,2),
IgstRt Numeric(8,2), 
CesRt  Numeric(8,2),
CesNonAdval  Numeric(8,3),
StateCes  Numeric(8,3),  
TotItemVal  Numeric(18,6),
AssVal Numeric(18,6),
CgstVal Numeric(18,6),
SgstVal Numeric(18,6),
IgstVal Numeric(18,6),
CesVal Numeric(18,6),
StCesVal Numeric(18,6),
TCesNonAdVal Numeric(18,6),			
Disc Numeric(18,6),
TOthChrg Numeric(18,6),
TotInvVal Numeric(18,6),
ExcelAssVal Numeric(18,6),
ExcelCgstVal Numeric(18,6),
ExcelSgstVal Numeric(18,6),
ExcelIgstVal Numeric(18,6),
ExcelCesVal Numeric(18,6),
ExcelStCesVal Numeric(18,6),
ExcelTCesNonAdVal Numeric(18,6),			
ExcelDisc Numeric(18,6),
ExcelTOthChrg Numeric(18,6),
ExcelTotInvVal Numeric(18,6),
TransId TINYINT,
Invoice_Id BIGINT,
StockType TINYINT,
PrdId INT,
RtrId INT,
ExcelTaxRate Varchar(50),
ExcelInvoiceType Varchar(20),
ExcelSubCategory Varchar(20),
ExcelEcomTran Varchar(5),
ExcelUnits Varchar(20),
ExcelStateName Varchar(100),
GstRt Numeric(8,2),
OrdLineRef Varchar(50),
OrgCntry Varchar(50),
SellerState Varchar(100),
IsService Varchar(2),
RndOffAmt Numeric(18,2),
TotInvValFc Numeric(18,6),
PrdSlno INT,
PreTaxVal Numeric(18,6),
[Ack_Number] [varchar](200) NULL,
[Ack_Date]	DateTime,
[Irn] [varchar](100) NULL,
[SignedInvoice] Varchar(8000) NULL,
[SignedQRCode] Varchar(8000) NULL,
[Ack_Status]  Varchar(20) NULL,
[EStatus] Varchar(20) NULL,
[Err_desc] Varchar(Max) NULL,
OrgInvDt Varchar(10),
CRAdjAmount Numeric(18,6),
OrgNetAmount Numeric(18,6),
DBAdjAmount  Numeric(18,6),
WindowDisplayAmount  Numeric(18,6)
)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptE_Invoice_Acknowledgement_Excel')
DROP TABLE RptE_Invoice_Acknowledgement_Excel
GO
CREATE TABLE [RptE_Invoice_Acknowledgement_Excel](
	[Catg] [varchar](5) NULL,
	[RegRev] [varchar](4) NULL,
	[Typ] [varchar](5) NULL,
	[EcmTrn] [varchar](2) NULL,
	[EcmGstin] [varchar](20) NULL,
	[DTyp] [varchar](5) NULL,
	[No] [varchar](16) NULL,
	[Dt] [datetime] NULL,
	[OrgInvNo] [varchar](16) NULL,
	[Gstin] [varchar](15) NULL,
	[TrdNm] [varchar](100) NULL,
	[Bno] [varchar](60) NULL,
	[Bnm] [varchar](60) NULL,
	[Flno] [varchar](60) NULL,
	[Loc] [varchar](60) NULL,
	[Dst] [varchar](60) NULL,
	[Pin] [varchar](6) NULL,
	[Stcd] [varchar](2) NULL,
	[Ph] [varchar](10) NULL,
	[Em] [varchar](50) NULL,
	[BGstin] [varchar](15) NULL,
	[BTrdNm] [varchar](100) NULL,
	[BBno] [varchar](60) NULL,
	[BBnm] [varchar](60) NULL,
	[BFlno] [varchar](60) NULL,
	[BLoc] [varchar](60) NULL,
	[BDst] [varchar](60) NULL,
	[BPin] [varchar](6) NULL,
	[BStcd] [varchar](2) NULL,
	[BPh] [varchar](10) NULL,
	[BEm] [varchar](50) NULL,
	[ShipGstin] [varchar](15) NULL,
	[ShipTrdNm] [varchar](100) NULL,
	[ShipBno] [varchar](60) NULL,
	[ShipBnm] [varchar](60) NULL,
	[ShipFlno] [varchar](60) NULL,
	[ShipLoc] [varchar](60) NULL,
	[ShipDst] [varchar](60) NULL,
	[ShipPin] [varchar](6) NULL,
	[ShipStcd] [varchar](2) NULL,
	[ShipPh] [varchar](10) NULL,
	[ShipEm] [varchar](50) NULL,
	[PrdNm] [varchar](100) NULL,
	[PrdDesc] [varchar](100) NULL,
	[HsnCd] [varchar](8) NULL,
	[Barcde] [varchar](30) NULL,
	[Qty] [numeric](18, 2) NULL,
	[FreeQty] [numeric](18, 2) NULL,
	[Unit] [varchar](3) NULL,
	[UnitPrice] [numeric](18, 6) NULL,
	[TotAmt] [numeric](18, 6) NULL,
	[Discount] [numeric](18, 6) NULL,
	[OthChrg] [numeric](18, 6) NULL,
	[AssAmt] [numeric](18, 6) NULL,
	[CgstRt] [numeric](8, 2) NULL,
	[SgstRt] [numeric](8, 2) NULL,
	[IgstRt] [numeric](8, 2) NULL,
	[CesRt] [numeric](8, 2) NULL,
	[CesNonAdval] [numeric](8, 3) NULL,
	[StateCes] [numeric](8, 3) NULL,
	[TotItemVal] [numeric](18, 6) NULL,
	[AssVal] [numeric](18, 6) NULL,
	[CgstVal] [numeric](18, 6) NULL,
	[SgstVal] [numeric](18, 6) NULL,
	[IgstVal] [numeric](18, 6) NULL,
	[CesVal] [numeric](18, 6) NULL,
	[StCesVal] [numeric](18, 6) NULL,
	[TCesNonAdVal] [numeric](18, 6) NULL,
	[Disc] [numeric](18, 6) NULL,
	[TOthChrg] [numeric](18, 6) NULL,
	[TotInvVal] [numeric](18, 6) NULL,
	[ExcelAssVal] [numeric](18, 6) NULL,
	[ExcelCgstVal] [numeric](18, 6) NULL,
	[ExcelSgstVal] [numeric](18, 6) NULL,
	[ExcelIgstVal] [numeric](18, 6) NULL,
	[ExcelCesVal] [numeric](18, 6) NULL,
	[ExcelStCesVal] [numeric](18, 6) NULL,
	[ExcelTCesNonAdVal] [numeric](18, 6) NULL,
	[ExcelDisc] [numeric](18, 6) NULL,
	[ExcelTOthChrg] [numeric](18, 6) NULL,
	[ExcelTotInvVal] [numeric](18, 6) NULL,
	[TransId] [tinyint] NULL,
	[Invoice_Id] [bigint] NULL,
	[StockType] [tinyint] NULL,
	[PrdId] [int] NULL,
	[RtrId] [int] NULL,
	[ExcelTaxRate] [varchar](50) NULL,
	[ExcelInvoiceType] [varchar](20) NULL,
	[ExcelSubCategory] [varchar](20) NULL,
	[ExcelEcomTran] [varchar](5) NULL,
	[ExcelUnits] [varchar](20) NULL,
	[ExcelStateName] [varchar](100) NULL,
	[GstRt] [numeric](8, 2) NULL,
	[OrdLineRef] [varchar](50) NULL,
	[OrgCntry] [varchar](50) NULL,
	[SellerState] [varchar](100) NULL,
	[IsService] [varchar](2) NULL,
	[RndOffAmt] [numeric](18, 2) NULL,
	[TotInvValFc] [numeric](18, 6) NULL,
	[PrdSlno] [int] NULL,
	[PreTaxVal] [numeric](18, 6) NULL,
	[ExcelGrossVal] [numeric](18, 6) NULL,
	[Ack_Number] [varchar](200) NULL,
	[Ack_Date] [datetime] NULL,
	[Irn] [varchar](100) NULL,
	[Ack_Status] [varchar](20) NULL,
	[CancelDate] DateTime,
	[Err_desc] [varchar](5000) NULL,
	[RtrCode] Varchar(50),
	CRAdjAmount [numeric](18, 6) NULL,
	OrgNetAmount Numeric(18,6)
	)
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EInvoiceAuthentication]') AND type in (N'U')) 
BEGIN
CREATE TABLE [dbo].[EInvoiceAuthentication]
	(
		[EInvAuthId] [int] NOT NULL,
		[AuthToken] [nvarchar](200) NOT NULL,
		[OwnerId] [nvarchar](200) NOT NULL,
		[GSTTIN] [nvarchar](50) NOT NULL,
		[NICUserName] [nvarchar](100) NULL,
		[NICPassword] [nvarchar](50) NULL,
		[Availability] [tinyint] NOT NULL,
		[LastModBy] [tinyint] NOT NULL,
		[LastModDate] [datetime] NOT NULL,
		[AuthId] [tinyint] NOT NULL,
		[AuthDate] [datetime] NOT NULL,
		[Upload] [int] NULL
		 CONSTRAINT [PK_EInvoiceAuthentication_EInvAuthId] PRIMARY KEY CLUSTERED 
		(
			[EInvAuthId] ASC
		)
	)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_RptEInvoice_Sales' AND xtype='P')
DROP PROCEDURE Proc_RptEInvoice_Sales
GO
/*
BEGIN TRAN 
DELETE FROM EInvoice_ErrorLog
DELETE FROM RptEInvoice_Sales
EXEC Proc_RptEInvoice_Sales '2021-01-23','2021-01-23','JSON',0,'',0,''
SELECT * FROM RptEInvoice_Sales
SELECT * FROM EInvoice_ErrorLog
ROLLBACK TRAN
*/
CREATE PROCEDURE [dbo].[Proc_RptEInvoice_Sales]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option AS Varchar(10),
	@EStatus AS Varchar(20),
	@ExportOption AS TINYINT,
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_Sales
* PURPOSE    : To Generate Einvoice-Sales
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
************************************************************************************************
DATE			AUTHOR			CR/BZ	USER STORY ID			DESCRIPTION 
************************************************************************************************      
14/02/2020	  	MOHANA S			CR	   ILCRSTPAR7871		   E- Invoice
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
************************************************************************************************/
BEGIN
SET NOCOUNT ON	
BEGIN TRY
		SET @ErrorId =0
		SET @ErrorMessage =''	
		CREATE TABLE #EInvoice_Sales
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(30),
			DTyp Varchar(5),
			No Varchar(50),
			Dt DateTime,
			OrgInvNo Varchar(50),
			Gstin Varchar(30),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(20),
			Stcd Varchar(100),
			Ph Varchar(20),
			Em Varchar(50),
			BGstin Varchar(30),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(20),
			BStcd Varchar(100),
			BPh Varchar(20),
			BEm Varchar(50),
			ShipGstin Varchar(30),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(20),
			ShipStcd Varchar(100),
			ShipPh Varchar(20),
			ShipEm Varchar(50),
			PrdNm Varchar(200),
			PrdDesc Varchar(200),
			HsnCd Varchar(20),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			RtrId INT,
			Salid BIGINT,
			Prdid INT,
			StockType TINYINT,
			ExcelStateName Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,2),
			PrdSlno INT,
			PreTaxVal Numeric(18,6),
			OrgInvDt DateTime,
			CRAdjAmount	 Numeric(18,6),
			OrgNetAmount Numeric(18,6),
			DBAdjAmount	Numeric(18,6),
			WindowDisplayAmount	Numeric(18,6)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
	
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		SELECT DISTINCT  R.DistributorId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		---Retailer State
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
	
		---Sales B2B
		SELECT RtrId,RtrShipId,SalId,Salinvno,SalInvDate,prdslno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,OrderKeyNo,SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,
		WindowDisplayAmount
		INTO #SalesTax
		FROM(
		SELECT RtrId,RtrShipId,S.SalId,Salinvno,SalInvDate,prdslno,TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxAmount ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxAmount ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxAmount ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxAmount ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		ISNULL(OrderKeyNo,'') as OrderKeyNo,
		SalRoundOffAmt,
		SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,S.WindowDisplayAmount 
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax SS (NOLOCK) ON S.SalId=SS.Salid
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE DlvSts>3 and SalInvDate between @FromDate and @ToDate
		and TaxableAmount>0 AND UPPER(S.RtrType) = 'R'
		)X GROUP BY RtrId,RtrShipId,SalId,Salinvno,SalInvDate,prdslno,OrderKeyNo,
		SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		ORDER BY Salid
		
			
		SELECT B.Prdid,RtrShipId,RtrId,A.SalId,A.Salinvno,SalInvDate,Prdccode,PrdName,SUM(baseQty) as baseQty,PrdUnitSelRate as PrdUnitSelRate,SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmount) as PrdNetAmount,
		SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(SplDiscAmount+PrdSplDiscAmount+PrdSchDiscAmount+PrdDBDiscAmount+PrdCDAmount) as Discounts,
		ROW_NUMBER()OVER(PARTITION BY A.Salid Order by Max(B.SlNo)) as SalPrdSlno,
		OrderKeyNo,SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,
		SUM(ISNULL(PrdTCSTaxAmount,0)) as PrdTCSTaxAmount,DBAdjAmount,WindowDisplayAmount
		INTO #SalesB2B 
		FROM #SalesTax A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.Salid
		AND A.Prdslno=B.SlNo
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		--INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		--INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		--INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		--AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		--AND PBD.PriceId=B.PriceId
		--WHERE BC.SelRte=1
		GROUP BY B.Prdid,RtrShipId,RtrId,A.SalId,A.Salinvno,SalInvDate,Prdccode,PrdName,
		--PrdBatDetailValue,
		PrdUnitSelRate,
		OrderKeyNo,
		SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		
		
	--	DELETE A FROM #SalesB2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		
		
		SELECT DISTINCT Salid,Salinvno,Salinvdate,RtrId,RtrShipId,MAX(SalPrdSlno) as SalPrdSlno,OrderKeyNo,
		SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		INTO #Invoice FROM #SalesB2B
		GROUP BY Salid,Salinvno,Salinvdate,RtrId,RtrShipId,OrderKeyNo,SalRoundOffAmt,SalNetAmt,CRAdjAmount,
		OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		
	
		
		---FreeQty
		SELECT RtrId,SF.Salid,Salinvno,Salinvdate,RtrShipId,FreePrdId as Prdid,PrdName,Prdccode,SUM(FreeQty) as FreeQty ,
		SalPrdSlno+ROW_NUMBER()OVER(PARTITION BY SF.Salid Order by FreePrdId ) as SalPrdSlno,
		OrderKeyNo,SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		INTO #FreeProduct
		FROM  SalesInvoiceSchemeDtFreePrd SF (NOLOCK)
		INNER JOIN Product P (NOLOCK) ON SF.FreePrdId=P.Prdid
		INNER JOIN #Invoice X ON X.Salid=SF.Salid
		GROUP BY  RtrId,SF.Salid,Salinvno,Salinvdate,FreePrdId ,PrdName,Prdccode,RtrShipId,OrderKeyNo,SalPrdSlno,
		SalRoundOffAmt,SalNetAmt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		
		
		
	
		---Sales B2B END
		INSERT INTO #EInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,
		Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,Rtrid,Salid,Prdid,StockType,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,CRAdjAmount,OrgNetAmount,
		DBAdjAmount,WindowDisplayAmount)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,Salinvno as [No],SalInvDate as Dt,'' as OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, 
		SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'NOS' as Unit,
		PrdUnitSelRate as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal,0 as StCesVal,0 as TCesNonAdVal,Discounts as Disc,PrdTCSTaxAmount as TOthChrg,PrdNetAmount as TotInvVal,
		1 as TransId,R.Rtrid,Salid,Prdid,1,
		TaxPer,OrderKeyNo,'IN','' as SellerState,'N' as IsService,SalRoundOffAmt as RndOffAmt,
		SalNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		FROM #SalesB2B A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		UNION ALL
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,Salinvno as [No],SalInvDate as Dt,'' as OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,0 as Qty,FreeQty as FreeQty,'NOS' as Unit,
		0 as UnitPrice,0 as TotAmt,0 as Discount,0 as OthChrg,0 as AssAmt,
		0 as CgstRt,0 as SgstRt,0 as IgstRt,0 as CesRt,
		0 as CesNonAdval,0 as StateCes,0 as TotItemVal,
		0 as AssVal,0 as CgstVal,0 as SgstVal,0 as IgstVal,
		0 as CesVal,0 as StCesVal,0 as TCesNonAdVal,0 as Disc,0 as TOthChrg,0 as TotInvVal,
		1 as TransId,R.Rtrid,Salid,Prdid,2,
		0 as TaxPer,OrderKeyNo,'IN','' as SellerState,'N' as IsService,SalRoundOffAmt as RndOffAmt,
		SalNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		FROM #FreeProduct A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_Sales B ON A.PrdId=B.Prdid 
		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'') FROM #RetailerGSTIN A 
		INNER JOIN #EInvoice_Sales B ON A.RtrId=B.RtrId
		
		UPDATE B SET BStcd=ISNULL(StateCode,'')	,ShipStcd=ISNULL(StateCode,''),
		ExcelStateName=	ISNULL(StateName,'')
		FROM #RetailerState A INNER JOIN #EInvoice_Sales B ON A.RtrId=B.RtrId 
		
			
		UPDATE C SET ShipBno=SUBSTRING(RtrShipAdd1,1,60),
		ShipBnm=SUBSTRING(RtrShipAdd2,1,60),
		ShipFlno=SUBSTRING(RtrShipAdd3,1,60),
		ShipPin=SUBSTRING(CAST(RtrShipPinNo as Varchar(30)),1,6), 
		ShipPh=SUBSTRING(RtrShipPhoneNo ,1,10)
		FROM RetailerShipAdd A INNER JOIN #Invoice B ON A.RtrId=B.RtrId
		and A.RtrShipId=B.RtrShipId
		INNER JOIN #EInvoice_Sales C ON C.Salid=B.Salid AND C.RtrId=A.RtrId
		
		Update A SET A.ShipPin=isnull(B.RtrPinNo,0) From #EInvoice_Sales A INNER JOIN Retailer B ON A.Rtrid=B.Rtrid Where Len(A.ShipPin)<=5
						
		UPDATE #EInvoice_Sales SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #DistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #DistributorState)		
		
		
		Delete From EInvoice_ErrorLog where ProcessName = 'Sales'
				
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'Sales','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_Sales
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'Sales','HSN Code should be 8 digit' FROM #EInvoice_Sales
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 and 8
		
		--IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) where ProcessName = 'Sales')
		--BEGIN
		--	SET @ErrorId =1
		--	SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
		--	RETURN
		--END
		
				
			
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,Prdid,RtrId,ExcelTaxRate,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,
		[Ack_Number],[Ack_Date],[Irn],[SignedInvoice],[SignedQRCode],[Ack_Status],
		[EStatus],[Err_desc],OrgInvDt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,CONVERT(varchar,dt,103) AS Dt,OrgInvNo,Gstin,TrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Flno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Flno,
		ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BFlno,
		BLoc,BDst,BPin,BStcd,BPh,BEm,ShipGstin,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS  ShipFlno,
		ShipLoc,ShipDst,ShipPin,ShipStcd,ShipPh,ShipEm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' '),'*',' '),'~',' ') AS PrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdDesc,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') ,'*',' '),'~',' ')AS PrdDesc,
		HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,
		Salid,StockType,Prdid,RtrId,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'Tax Invoice' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		'NUMBERS' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,
		TotInvValFc,
		--OrgNetAmount,
		PrdSlno,PreTaxVal,
		'' as [Ack_Number],NULL as [Ack_Date],'' as [Irn],'' as [SignedInvoice],'' as [SignedQRCode],'' as [Ack_Status],
		@EStatus as [EStatus],'' as [Err_desc],null as OrgInvDt,CRAdjAmount,OrgNetAmount,DBAdjAmount,WindowDisplayAmount
		FROM #EInvoice_Sales ORDER BY Dt,No
			

		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal,
		SUM(DISTINCT ISNULL(CRAdjAmount,0)) as CRAdjAmount,
		SUM(DISTINCT ISNULL(DBAdjAmount,0)) as DBAdjAmount,
		SUM(DISTINCT ISNULL(WindowDisplayAmount,0)) as WindowDisplayAmount	
		INTO #SalesSummary
		FROM #EInvoice_Sales 
		GROUP BY No
		
		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=ISNULL(B.Disc,0),ExcelTOthChrg=ISNULL(B.TOthChrg,0),ExcelTotInvVal=B.TotInvVal,
		TotInvValFc= CASE WHEN (B.CRAdjAmount+B.DBAdjAmount+B.WindowDisplayAmount)>0 THEN ISNULL(B.TOthChrg,0)+B.TotInvVal ELSE TotInvValFc END,
		[RndOffAmt]= CASE WHEN (B.CRAdjAmount+B.DBAdjAmount+B.WindowDisplayAmount)>0 THEN 0 ELSE [RndOffAmt] END
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No AND TransId=1
		
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
		--UPDATE RptEInvoice_Sales SET [RndOffAmt]=[RndOffAmt]+(OrgNetAmount-([ExcelAssVal]+ExcelCgstVal+[ExcelSgstVal]+[ExcelIgstVal]+[RndOffAmt]+ISNULL(ExcelTOthChrg,0)))
		UPDATE RptEInvoice_Sales SET [RndOffAmt]=[RndOffAmt]+(TotInvValFc -([ExcelAssVal]+ExcelCgstVal+[ExcelSgstVal]+[ExcelIgstVal]+[RndOffAmt]
		+ISNULL(ExcelTOthChrg,0)))


		UPDATE A SET A.[Ack_Status]='FAILED',
		A.[Err_desc]='IRN GENERATE FAILED'
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment_Failed B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=1
		
		UPDATE A SET A.[Ack_Number] =B.[Ack_Number],
		A.[Ack_Date]=B.[Ack_Date],
		A.[Irn]=B.[Irn],
		A.[Ack_Status]=B.[Ack_Status],
		A.[Err_desc]=B.[Err_desc]
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=1 AND ISNULL(B.Ack_Status,'')='ACT'


		IF @ExportOption=1 --GENERATE IRN Only show pending invoice
		BEGIN
			IF UPPER(@EStatus)='PENDING'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=1
			END
		END
		IF @ExportOption=2 --CANCEL IRN Only show Success invoice
		BEGIN
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=1 )
				
				DELETE A FROM RptEInvoice_Sales A (NOLOCK) 
				INNER JOIN SalesInvoice B (NOLOCK) ON A.Invoice_id=B.Salid WHERE TransId=1
                AND Dlvsts>2
                
			END
		END
		IF @ExportOption=3 --VIEW SUCCESS & FAILED IRN
		BEGIN
			--'SUCCESS'
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=1 )
			END

			--'FAILED'
			IF UPPER(@EStatus)='FAILURE'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment_Failed B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId AND A.No=B.Invoice_no
				AND B.TransId=1)

				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=1
			END
		END
				
	
		DROP TABLE #RetailerState
		DROP TABLE #RetailerGSTIN	
		DROP TABLE #SalesTax
		DROP TABLE #SalesB2B	
		DROP TABLE #ProductHsnCode
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'Sales',ERROR_MESSAGE()
END CATCH			
RETURN		
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_SalesReturn')
DROP PROCEDURE Proc_RptEInvoice_SalesReturn
GO
/**
BEGIN TRAN 
EInvoice_ErrorLog
DELETE FROM EInvoice_ErrorLog
EXEC Proc_RptEInvoice_SalesReturn '2020-02-01','2020-02-14','JSON',0,''
--SELECT * FROM Salesinvoice
SELECT * FROM RptEInvoice_Sales
SELECT * FROM EInvoice_ErrorLog
ROLLBACK TRAN
**/
CREATE PROCEDURE [Proc_RptEInvoice_SalesReturn]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option AS Varchar(10),
	@EStatus AS Varchar(20),
	@ExportOption TinyInt,
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_SalesReturn
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
************************************************************************************************
DATE			AUTHOR			CR/BZ	USER STORY ID			DESCRIPTION 
************************************************************************************************      
14/02/2020	  	MOHANA S			CR	   ILCRSTPAR7871		   E- Invoice
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
************************************************************************************************/
BEGIN
SET NOCOUNT ON
BEGIN TRY	
		SET @ErrorId =0
		SET @ErrorMessage =''
		CREATE TABLE #EInvoice_SalesReturn
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(20),
			DTyp Varchar(5),
			No Varchar(16),
			Dt DateTime,
			OrgInvNo Varchar(16),
			Gstin Varchar(15),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(6),
			Stcd Varchar(100),
			Ph Varchar(10),
			Em Varchar(50),
			BGstin Varchar(15),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(6),
			BStcd Varchar(100),
			BPh Varchar(10),
			BEm Varchar(50),
			ShipGstin Varchar(15),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(6),
			ShipStcd Varchar(100),
			ShipPh Varchar(10),
			ShipEm Varchar(50),
			PrdNm Varchar(100),
			PrdDesc Varchar(100),
			HsnCd Varchar(10),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			RtrId INT,
			Salid BIGINT,
			Prdid INT,
			StockType TINYINT,
			ExcelStateName	Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,6),
			PrdSlno INT,
			PreTaxVal Numeric(18,6),
			OrgInvDt DateTime	
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
		
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		
	
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		---Retailer State
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		SELECT DISTINCT  R.DistributorId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
		
		SELECT C.RtrId,CrNoteNumber,CrNoteDate,PostedFrom AS ReturnCode,C.Amount   
		INTO #CREDITNOTEDETAILS  
		FROM Creditnoteretailer C (NOLOCK)
		WHERE TransId=30 AND CrNoteDate between @FromDate and @ToDate  
		
		
 ----SELECT SalInvNo,Salinvdate,ReturnID,ReturnCode  INTO #INVOICEDETAILS FROM (  
	SELECT DISTINCT SI.SALID,SalInvNo,Salinvdate,RH.ReturnID,RH.ReturnCode,RtrShipId,SI.RtrId,ISNULL(SI.RtrType,'') RtrType   
	INTO #INVOICEDETAILS  
	FROM SalesInvoice SI(NOLOCK) INNER JOIN ReturnHeader RH (NOLOCK) ON RH.SalId=SI.Salid  
	INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode  
	WHERE ReturnDate between @FromDate and @ToDate AND RH.InvoiceType=1
  UPDATE B SET RtrShipid=A.RtrShipid from RetailerShipAdd A (Nolock) INNER JOIN #INVOICEDETAILS B
  ON A.Rtrid=B.RtrId and B.RtrShipId=0  and A.RtrShipDefaultAdd=1
	  UPDATE  A SET RtrType = UPPER(left(B.ColumnValue,1)) FROM #INVOICEDETAILS A
	  INNER JOIN #RetailerRegister B ON A.RtrId = B.RtrId AND A.RtrType = ''
 -- --UNION ALL
 -- --SELECT DISTINCT SalInvNo,Salinvdate,RH.ReturnID,RH.ReturnCode    
 -- --FROM SalesInvoice SI(NOLOCK)  
 -- --INNER JOIN ReturnProduct RP (NOLOCK) ON RP.SalId=SI.SalId  
 -- --INNER JOIN ReturnHeader RH (NOLOCK) ON RH.ReturnId=RP.ReturnId  
 -- --INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode AND C.SalRefNo=RP.SalId --ILCRSTGCP1930  
 -- --WHERE MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear   
 -- -- AND Salinvdate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND RH.InvoiceType=2 AND RH.SRNSRSType=1  AND SRNRefType =1  ) A --CRCRSTGCP0045  
 --  ----Till Here CRCRSTGCP0038  
  SELECT * INTO #ReturnProductTax FROM ReturnProductTax   
   WHERE ReturnID IN (SELECT DISTINCT ReturnID FROM #INVOICEDETAILS)   
	
		---Sales B2B
		SELECT RtrId,ReturnID,ReturnCode,ReturnDate,prdslno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		RtnRoundOffAmt,RtnNetAmt
		INTO #SalesReturnTax
		FROM(
		SELECT S.RtrId,S.ReturnID,S.ReturnCode,ReturnDate,PrdSlno,TaxableAmt as TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxAmt ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxAmt ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxAmt ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxAmt ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		RtnRoundOffAmt ,RtnNetAmt
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProductTax SS (NOLOCK) ON S.ReturnID=SS.ReturnID
		INNER JOIN #INVOICEDETAILS I ON I.ReturnID=S.ReturnID and I.ReturnID=SS.ReturnId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE Status=0 and ReturnDate between @FromDate and @ToDate and S.InvoiceType=1
		and TaxableAmt>0 AND UPPER(I.RtrType) = 'R'
		)X GROUP BY RtrId,ReturnID,ReturnCode,ReturnDate,prdslno,RtnRoundOffAmt,RtnNetAmt
		ORDER BY ReturnID
		SELECT B.Prdid,A.RtrId,A.ReturnID,A.ReturnCode,ReturnDate,Prdccode,PrdName,SUM(baseQty) as baseQty,PrdUnitSelRte as PrdUnitSelRte,SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmt) as PrdNetAmount,
		SUM(PrdGrossAmt) as PrdGrossAmount,
		SUM(PrdSplDisAmt+PrdSchDisAmt+PrdDBDisAmt+PrdCDDisAmt) as Discounts,
		CAST(ISNULL(SalInvNo,'') as Varchar(50)) as OrgInvNo,
		ROW_NUMBER()OVER(PARTITION BY A.ReturnID Order by Max(B.Slno)) as SalPrdSlno,
		RtnRoundOffAmt,RtnNetAmt,
		SUM(ISNULL(PrdTCSTaxAmount,0)) as PrdTCSTaxAmount,
		CAST(null as DATETIME) as  OrgInvDt
		INTO #SalesReturnB2B 
		FROM #SalesReturnTax A INNER JOIN ReturnProduct B ON A.ReturnID=B.ReturnID
		AND A.Prdslno=B.Slno
		LEFT OUTER JOIN Salesinvoice S (NOLOCK) ON S.Salid=B.Salid
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		--INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		--INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		--INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		--AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		--AND PBD.PriceId=B.PriceId
		--WHERE BC.SelRte=1
		GROUP BY CAST(ISNULL(SalInvNo,'') as Varchar(50)),B.Prdid,A.RtrId,A.ReturnID,A.ReturnCode,ReturnDate,Prdccode,PrdName,
		--PrdBatDetailValue,
		PrdUnitSelRte,
		RtnRoundOffAmt,RtnNetAmt
					
			
		--DELETE A FROM #SalesReturnB2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		
		
		--FREE Qty
		SELECT DISTINCT RtrId,ReturnID,ReturnCode,ReturnDate,RtnRoundOffAmt,RtnNetAmt,MAX(SalPrdSlno) as SalPrdSlno 
		INTO #ReturnHd  FROM #SalesReturnB2B
		GROUP BY RtrId,ReturnID,ReturnCode,ReturnDate,RtnRoundOffAmt,RtnNetAmt
		
		SELECT RtrId,A.ReturnId,ReturnCode,ReturnDate,FreePrdId as Prdid,PrdName,Prdccode,SUM(ReturnFreeQty) as ReturnFreeQty,
		CAST('' as Varchar(50)) as OrgInvNo,CAST (null AS DATETIME) as OrgInvDt,
		RtnRoundOffAmt,RtnNetAmt,SalPrdSlno+ROW_NUMBER()OVER(PARTITION BY A.ReturnId Order by FreePrdId ) as SalPrdSlno
		INTO #ReturnFreeProduct  
		FROM ReturnSchemeFreePrdDt A (NOLOCK)
		INNER JOIN #ReturnHd B ON A.ReturnID=B.ReturnID
		INNER JOIN Product P (NOLOCK) ON P.PrdId=A.FreePrdId
		GROUP BY RtrId,A.ReturnId,ReturnCode,ReturnDate,FreePrdId,PrdName,Prdccode,SalPrdSlno,RtnRoundOffAmt,RtnNetAmt
		
		
		UPDATE B SET OrgInvNo=SalInvNo,OrgInvDt=Salinvdate
		FROM #INVOICEDETAILS A INNER JOIN #SalesReturnB2B B ON A.ReturnID=B.ReturnId WHERE LEN(ISNULL(B.OrgInvNo,''))=0 
		
		UPDATE B SET OrgInvDt=Salinvdate
		FROM #INVOICEDETAILS A INNER JOIN #SalesReturnB2B B ON A.ReturnID=B.ReturnId WHERE OrgInvDt IS NULL 
		UPDATE B SET OrgInvNo=SalInvNo,OrgInvDt=Salinvdate
		FROM #INVOICEDETAILS A INNER JOIN #ReturnFreeProduct B ON A.ReturnID=B.ReturnId  WHERE LEN(ISNULL(B.OrgInvNo,''))=0 
		
		
		
		---Sales B2B END
	
		INSERT INTO #EInvoice_SalesReturn(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,Rtrid,Salid,Prdid,StockType,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,OrgInvDt)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'CRN' as DTyp,ReturnCode as [No],ReturnDate as Dt,OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,
		SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRte as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal, 0 as  StCesVal,0 as TCesNonAdVal,Discounts as Disc,PrdTCSTaxAmount as TOthChrg,PrdNetAmount as TotInvVal,
		2 as TransId,A.Rtrid,ReturnId,Prdid,1,
		TaxPer as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,RtnRoundOffAmt as RndOffAmt,
		RtnNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal,OrgInvDt
		FROM #SalesReturnB2B A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		UNION ALL
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'CRN' as DTyp,ReturnCode as [No],ReturnDate as Dt,OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,0 as Qty,ReturnFreeQty as FreeQty,'PCS' as Unit,
		0 as UnitPrice,0 as TotAmt,0 as Discount,0 as OthChrg,0 as AssAmt,
		0 as CgstRt,0 as SgstRt,0 as IgstRt,0 as CesRt,
		0 as CesNonAdval,0 as StateCes,0 as TotItemVal,
		0 as AssVal,0 as CgstVal,0 as SgstVal,0 as IgstVal,
		0 as CesVal,0 as StCesVal,0 as TCesNonAdVal,0 as Disc,0 as TOthChrg,0 as TotInvVal,
		2 as TransId,A.Rtrid,ReturnId,Prdid,2,
		0 as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,RtnRoundOffAmt as RndOffAmt,
		RtnNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal,OrgInvDt
		FROM #ReturnFreeProduct A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		
		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_SalesReturn B ON A.PrdId=B.Prdid 
		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'') FROM #RetailerGSTIN A INNER JOIN #EInvoice_SalesReturn B ON A.RtrId=B.RtrId
		
		UPDATE B SET BStcd=ISNULL(StateCode,''),ShipStcd=ISNULL(StateCode,''),
		ExcelStateName	=	ISNULL(StateName,'')
		FROM #RetailerState A INNER JOIN #EInvoice_SalesReturn B ON A.RtrId=B.RtrId 
		UPDATE #EInvoice_SalesReturn SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #DistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #DistributorState)
		
		UPDATE C SET ShipBno=SUBSTRING(RtrShipAdd1,1,60),
		ShipBnm=SUBSTRING(RtrShipAdd2,1,60),
		ShipFlno=SUBSTRING(RtrShipAdd3,1,60),
		ShipPin=SUBSTRING(CAST(RtrShipPinNo as VARCHAR(20)),1,6), 
		ShipPh=SUBSTRING(RtrShipPhoneNo,1,10)
		FROM RetailerShipAdd A INNER JOIN #INVOICEDETAILS B ON A.RtrId=B.RtrId
		and A.RtrShipId=B.RtrShipId
		INNER JOIN #EInvoice_SalesReturn C ON C.Salid=B.ReturnID AND C.RtrId=A.RtrId
		
		
		Update A SET A.ShipPin=isnull(B.RtrPinNo,0) From #EInvoice_SalesReturn A INNER JOIN Retailer B ON A.Rtrid=B.Rtrid Where Len(A.ShipPin)<=5
		Delete From EInvoice_ErrorLog where ProcessName = 'Return'
				
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'Return','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_SalesReturn
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'Return','HSN Code should be 8 digit' FROM #EInvoice_SalesReturn
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 and 8
		
		--IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) where ProcessName='Return')
		--BEGIN
		--	SET @ErrorId =1
		--	SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
		--	RETURN
		--END
	
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,PrdId,RtrId,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,ExcelTaxRate,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,
		[Ack_Number],[Ack_Date],[Irn],[SignedInvoice],[SignedQRCode],[Ack_Status],
		[EStatus],[Err_desc],OrgInvDt)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No, CONVERT(varchar,dt,103) AS Dt,OrgInvNo,Gstin,TrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Flno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Flno,
		ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,
				REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BFlno,
		BLoc,BDst,
		BPin,BStcd,BPh,BEm,
		ShipGstin,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS  ShipFlno,
		ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' '),'*',' '),'~',' ') AS PrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdDesc,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') ,'*',' '),'~',' ')AS PrdDesc,
		HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,salid,StockType,Prdid,RtrId,'Credit Note' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,
		'' as [Ack_Number],NULL as [Ack_Date],'' as [Irn],'' as [SignedInvoice],'' as [SignedQRCode],'' as [Ack_Status],
		@EStatus as [EStatus],'' as [Err_desc],convert(varchar(10),OrgInvDt, 103)		
		FROM #EInvoice_SalesReturn ORDER BY Dt,No
		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_SalesReturn 
		GROUP BY No
		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
		--ROUDN OFF DIFFERENCE
		UPDATE RptEInvoice_Sales SET [RndOffAmt]=[RndOffAmt]+([TotInvValFc]-([ExcelAssVal]+ExcelCgstVal+[ExcelSgstVal]+[ExcelIgstVal]+[RndOffAmt]++ISNULL(ExcelTOthChrg,0)))

		UPDATE A SET A.[Ack_Status]='FAILED',
		A.[Err_desc]='IRN GENERATE FAILED'
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment_Failed B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=2

			
		UPDATE A SET A.[Ack_Number] =B.[Ack_Number],
		A.[Ack_Date]=B.[Ack_Date],
		A.[Irn]=B.[Irn],
		--A.[SignedInvoice]=B.[SignedInvoice],
		--A.[SignedQRCode]=B.[SignedQRCode],
		A.[Ack_Status]=B.[Ack_Status],
		A.[Err_desc]=B.[Err_desc]
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=2 AND ISNULL(B.Ack_Status,'')='ACT'

		IF @ExportOption=1 --GENERATE IRN Only show pending invoice
		BEGIN
			IF UPPER(@EStatus)='PENDING'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=2
			END
		END
		IF @ExportOption=2 --CANCEL IRN Only show Success invoice
		BEGIN
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=2 )
			END
		END
		IF @ExportOption=3 --VIEW SUCCESS & FAILED IRN
		BEGIN
			--'SUCCESS'
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=2 )
			END

			--'FAILED'
			IF UPPER(@EStatus)='FAILURE'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment_Failed B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId AND A.No=B.Invoice_no
				 AND B.TransId=2)
				
				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=2
		
			END
		END	
		
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'Return',ERROR_MESSAGE()
END CATCH			
		RETURN	
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_IDTSales')
DROP PROCEDURE Proc_RptEInvoice_IDTSales
GO
--EXEC Proc_RptEInvoice_IDTSales '2018-01-01','2020-01-01','Json',0,''
--SELECT * FROM IDTManagement
CREATE PROCEDURE [Proc_RptEInvoice_IDTSales]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option AS Varchar(10),
	@EStatus AS Varchar(20),
	@ExportOption TinyInt,
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_IDTSales
* PURPOSE    : To Generate Einvoice-IDT Sales
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION			
*  07/02/2020	  Deepak K		CR	   	CRCRSTMTR0036		   E- Invoice		
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
*************************************************
*/
BEGIN
SET NOCOUNT ON
	BEGIN TRY	
		SET @ErrorId =0
		SET @ErrorMessage =''
		CREATE TABLE #EInvoice_IDTSales
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(20),
			DTyp Varchar(5),
			No Varchar(16),
			Dt DateTime,
			OrgInvNo Varchar(50),
			Gstin Varchar(15),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(6),
			Stcd Varchar(100),
			Ph Varchar(10),
			Em Varchar(50),
			BGstin Varchar(15),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(20),
			BStcd Varchar(100),
			BPh Varchar(10),
			BEm Varchar(50),
			ShipGstin Varchar(15),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(6),
			ShipStcd Varchar(100),
			ShipPh Varchar(10),
			ShipEm Varchar(50),
			PrdNm Varchar(100),
			PrdDesc Varchar(100),
			HsnCd Varchar(10),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			FromSpmId INT,
			ToSpmId INT,			
			Prdid INT,
			ExcelStateName Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,2),
			PrdSlno INT,
			PreTaxVal Numeric(18,6)		
		)	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		
		
				--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		
		SELECT DISTINCT  R.DistributorId as DistributorId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #FromDistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
			
		--Distributor GSTIN
		SELECT UT.ColumnValue,R.SpmId
		INTO #Gtstin		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMASTER R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId in (37,8) and ColumnName='GSTIN'
					
		SELECT DISTINCT  R.SpmId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMASTER R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=37 and ColumnName='State Name'
	
		---Sales B2B
		SELECT FromSpmId,ToSpmId,IDTMngRefNo,IDTMngDate,PrdSlno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		CAST(0.00 AS NUMERIC(18,6)) as Discounts,
		IDTNetAmt
		INTO #IDTTax
		FROM(
		SELECT FromSpmId,ToSpmId,S.IDTMngRefNo,IDTMngDate,PrdSlno,TaxableAmount as TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST') THEN SS.TaxAmount ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST') THEN SS.TaxAmount ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST') THEN SS.TaxAmount ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess','InPutCess') THEN SS.TaxAmount ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess','InPutCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		IDTNetAmt
		FROM IDTManagement S (NOLOCK) 
		INNER JOIN IDTManagementproducttax SS (NOLOCK) ON S.IDTMngRefNo=SS.IDTMngRefNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE Status=1 
		and IDTMngDate between @FromDate and @ToDate
		and StkMgmtTypeId=2
		and TaxableAmount>0
		)X GROUP BY FromSpmId,ToSpmId,IDTMngRefNo,IDTMngDate,PrdSlno,IDTNetAmt
		ORDER BY IDTMngRefNo
		
			
		SELECT A.IDTMngRefNo,PrdSlno,SUM(LineBaseQtyAmount) as Discounts 
		INTO #IDTDiscounts
		FROM IDTManagement A (NOLOCK)
		INNER JOIN IDTManagementLineAmount B (NOLOCK)ON A.IDTMngRefNo=B.IDTMngRefNo
		WHERE Status=1 
		and IDTMngDate between @FromDate and @ToDate
		and StkMgmtTypeId=2 and RefCode IN('E','F')
		GROUP BY A.IDTMngRefNo,PrdSlno
		
		UPDATE A SET A.Discounts=B.Discounts FROM #IDTTax A INNER JOIN #IDTDiscounts B ON A.IDTMngRefNo=B.IDTMngRefNo
		AND A.PrdSlno=B.PrdSlno
	
		
		SELECT B.Prdid,FromSpmId,ToSpmId,A.IDTMngRefNo,IDTMngDate,Prdccode,PrdName,SUM(Qty) as baseQty,PrdBatDetailValue as PrdUnitSelRte,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmount) as PrdNetAmount,
		SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ISNULL(A.Discounts,0)) as Discounts,
		CAST('' as Varchar(50)) as OrgInvNo,
		ROW_NUMBER()OVER(PARTITION BY A.IDTMngRefNo Order by Max(B.PrdSlNo)) as SalPrdSlno,
		IDTNetAmt
		INTO #IDTSales
		FROM #IDTTax A INNER JOIN IDTManagementproduct B (NOLOCK) ON A.IDTMngRefNo=B.IDTMngRefNo
		AND A.Prdslno=B.Prdslno
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		AND PBD.PriceId=B.PriceId
		WHERE BC.ListPrice=1
		GROUP BY B.Prdid,FromSpmId,ToSpmId,A.IDTMngRefNo,IDTMngDate,Prdccode,PrdName,PrdBatDetailValue,IDTNetAmt
		
			
		INSERT INTO #EInvoice_IDTSales(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,
		Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,FromSpmId,ToSpmId,Prdid,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,IDTMngRefNo as [No],IDTMngDate as Dt,OrgInvNo,		
		@DistGSTIN as [GSTIN],B.DistributorName as TrdNm,SUBSTRING(B.DistributorAdd1,1,60) as Bno,SUBSTRING(B.DistributorAdd2,1,60) as Bnm,SUBSTRING(B.DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(B.PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(B.PhoneNo,1,10) as Ph,'' as Em,
		'' as BGstin,C.SpmName as  BTrdNm,SUBSTRING(C.SpmAdd1,1,60) as BBno,SUBSTRING(C.SpmAdd2,1,60) as BBnm,SUBSTRING(C.SpmAdd3,1,60) as BFlno,'' as BLoc,'' as BDst,'' as BPin,'' as BStcd,
		SUBSTRING(C.SpmPhone,1,10) as BPh,'' as BEm,
		'' as ShipGstin,C.SpmName as ShipTrdNm,SUBSTRING(C.SpmAdd1,1,60)as ShipBno,SUBSTRING(C.SpmAdd2,1,60) as ShipBnm,SUBSTRING(C.SpmAdd3,1,60) as ShipFlno,'' as ShipLoc,'' as ShipDst,
		'' as ShipPin,'' as ShipStcd,SUBSTRING(C.SpmPhone,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRte as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal,0 as StCesVal,0 as TCesNonAdVal,Discounts as Disc,0 as TOthChrg,PrdNetAmount as TotInvVal,
		4 as TransId,FromSpmId,ToSpmId,Prdid,
		TaxPer as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,0 as RndOffAmt,
		IDTNetAmt as TotInvValFc,SalPrdSlno as PrdSlno	,0 as PreTaxVal	
		FROM #IDTSales A 
		INNER JOIN Distributor B (NOLOCK) ON A.FromSpmId=B.DistributorId
		INNER JOIN IDTMASTER C (NOLOCK) ON A.ToSpmId=C.SpmId
		
	
		
	
		
		
		
		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_IDTSales B ON A.PrdId=B.Prdid 
		
	
		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'')		
		FROM #Gtstin A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.ToSpmId
		UPDATE B SET Stcd=ISNULL(StateCode,''),BLoc=SUBSTRING(StateName,1,60),ShipLoc=SUBSTRING(StateName,1,60)	 FROM #DistributorState A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.FromSpmId
		
		UPDATE B SET BStcd=ISNULL(StateCode,''),ShipStcd=ISNULL(StateCode,''),
		ExcelStateName=ISNULL(StateName,'')
		FROM #DistributorState A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.ToSpmId
		
		UPDATE #EInvoice_IDTSales SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #FromDistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #FromDistributorState)
		
		--INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
	
		
		--INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		--SELECT DISTINCT 3,'Sales Invoice','HSN Code should be 8 digit' FROM #EInvoice_IDTSales
		--WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 AND 8
		
		--IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK))
		--BEGIN
		--	SET @ErrorId =1
		--	SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
		--	RETURN
		--END
		Delete From EInvoice_ErrorLog where ProcessName = 'IDT Sales'
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'IDT Sales','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_IDTSales
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'IDT Sales','HSN Code should be 8 digit' FROM #EInvoice_IDTSales
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 AND 8
		
		
							
		IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) Where ProcessName = 'IDT Sales')
		BEGIN
			SET @ErrorId =1
			SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
			RETURN
		END
		
		
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,
		Bno,Bnm,Flno,
		Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,PrdId,RtrId,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,ExcelTaxRate,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,
		[Ack_Number],[Ack_Date],[Irn],[SignedInvoice],[SignedQRCode],[Ack_Status],
		[EStatus],[Err_desc],OrgInvDt)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No, CONVERT(varchar,dt,103) AS Dt,OrgInvNo,Gstin,TrdNm,
		--Bno,Bnm,Flno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Bnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Bnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Flno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS Flno,
		ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,
		---BTrdNm,BBno,BBnm,BFlno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(BFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS BFlno,
		BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,--ShipTrdNm,ShipBno,ShipBnm,ShipFlno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipTrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipTrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBno,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipBnm,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS ShipBnm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(ShipFlno,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') AS  ShipFlno,
		ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		--PrdNm,PrdDesc,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdNm,'(',''),')',''),'.',''),'#',''),':',''),'&',' '),'*',' '),'~',' ') AS PrdNm,
		REPLACE(REPLACE(REPLACE(REPLACE(Replace(Replace(Replace(Replace(PrdDesc,'(',''),')',''),'.',''),'#',''),':',''),'&',' ') ,'*',' '),'~',' ')AS PrdDesc,
		HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,0,1,Prdid,FromSpmId,'Tax Invoice' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,
		'' as [Ack_Number],NULL as [Ack_Date],'' as [Irn],'' as [SignedInvoice],'' as [SignedQRCode],'' as [Ack_Status],
		@EStatus as [EStatus],'' as [Err_desc],null as OrgInvDt
		FROM #EInvoice_IDTSales ORDER BY Dt,No
		
		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_IDTSales 
		GROUP BY No
		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
			
		--ROUDN OFF DIFFERENCE
		UPDATE RptEInvoice_Sales SET [RndOffAmt]=[RndOffAmt]+([TotInvValFc]-([ExcelAssVal]+ExcelCgstVal+[ExcelSgstVal]+[ExcelIgstVal]+[RndOffAmt]))

		UPDATE A SET A.[Ack_Status]='FAILED',
		A.[Err_desc]='IRN GENERATE FAILED'
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment_Failed B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=4
		
		UPDATE A SET A.[Ack_Number] =B.[Ack_Number],
		A.[Ack_Date]=B.[Ack_Date],
		A.[Irn]=B.[Irn],
		A.[Ack_Status]=B.[Ack_Status],
		A.[Err_desc]=B.[Err_desc]
		FROM RptEInvoice_Sales A INNER JOIN EInvoice_Acknowledgment B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND No=B.Invoice_no
		WHERE B.TransId=4 AND ISNULL(B.Ack_Status,'')='ACT'

		IF @ExportOption=1 --GENERATE IRN Only show pending invoice
		BEGIN
			IF UPPER(@EStatus)='PENDING'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=4
			END
		END
		IF @ExportOption=2 --CANCEL IRN Only show Success invoice
		BEGIN
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=4 )
			END
		END
		IF @ExportOption=3 --VIEW SUCCESS & FAILED IRN
		BEGIN
			--'SUCCESS'
			IF UPPER(@EStatus)='SUCCESS'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
				AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1) AND B.TransId=4 )
			END

			--'FAILED'
			IF UPPER(@EStatus)='FAILURE'
			BEGIN
				DELETE A FROM RptEInvoice_Sales A 
				WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment_Failed B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId AND A.No=B.Invoice_no
				 AND B.TransId=4)
				
				DELETE A FROM RptEInvoice_Sales A 
				INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
				AND ISNULL(Response_Status,0) IN(1,2) AND B.TransId=4
		
			END
		END
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'IDT Sales',ERROR_MESSAGE()		
END CATCH		
		RETURN	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='TF' AND NAME='Fn_ReturnLoadEinvoceDt')
DROP FUNCTION Fn_ReturnLoadEinvoceDt
GO
/*
SELECT * FROM DBO.Fn_ReturnLoadEinvoceDt()
*/
CREATE     FUNCTION [Fn_ReturnLoadEinvoceDt]()  
RETURNS @EInvoiceDT TABLE
(
	[Slno] INT IDENTITY(1,1),
	[EStatus] VARCHAR(20),
	[Err_desc] VARCHAR(MAX),
	[Ack_Number] VARCHAR(100),
	[Ack_Date] DATETIME,
	[Irn] VARCHAR(100),
	TRANSID TINYINT, 
	[Transaction Type] VARCHAR(50),
	[Reference No] VARCHAR(50), 
	[Reference Date] DATETIME,
	[Buyer Name] VARCHAR(100),
	[Buyer GSTIN] VARCHAR(20),
	[Taxable Amount] Numeric(18,2),
	[Total Tax] Numeric(18,2),
	[NetAmount] Numeric(18,2)
)
AS  
BEGIN  
/*********************************  
* FUNCTION: Fn_ReturnLoadEinvoceDt  
* PURPOSE: Return E-invoice details
* NOTES:  
* CREATED: Murugan.R 14-12-2020  
* MODIFIED  
* DATE				AUTHOR		CR\BUG  USER STORY ID			DESCRIPTION  
------------------------------------------------  
*  14-12-2020	  MURUGAN		CR	   	CRCRSTMRC0235		   E- Invoice
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
*********************************/  
INSERT INTO @EInvoiceDT ([EStatus],[Err_desc],[Ack_Number],[Ack_Date],[Irn],TRANSID, [Transaction Type],[Reference No], [Reference Date],[Buyer Name],[Buyer GSTIN],[Taxable Amount],[Total Tax],[NetAmount])
SELECT [EStatus],[Err_desc],[Ack_Number],[Ack_Date],[Irn],TRANSID, [Transaction Type],[Reference No], CONVERT(DATETIME,CONVERT(VARCHAR(10),[Reference Date],103),103),[Buyer Name],[Buyer GSTIN],[Taxable Amount],[Total Tax],[NetAmount]
FROM (
SELECT DISTINCT [EStatus],[Err_desc],[Ack_Number],[Ack_Date],[Irn],TRANSID,CASE TRANSID 
WHEN 1 THEN 'Sales'
WHEN 2 THEN 'Sales Return'
WHEN 3 THEN 'Purchase Return'
WHEN 4 THEN 'IDT Sales' END as [Transaction Type],
No as [Reference No],
CONVERT(DATETIME,CONVERT(VARCHAR(10),Dt,103),103) as [Reference Date],
BTrdNm as [Buyer Name],
BGstin as [Buyer GSTIN],
SUM(AssVal) as [Taxable Amount],
SUM(CgstVal+SgstVal+IgstVal+CesVal+StCesVal+CesNonAdVal) as [Total Tax],
SUM(DISTINCT TotInvValFc) as [NetAmount]
 FROM RptEInvoice_Sales
 GROUP BY TRANSID,No,Dt,BTrdNm,BGstin,
 [Ack_Number],[Ack_Date],[Irn],[EStatus],[Err_desc]
 ) X ORDER BY X.TRANSID,CONVERT(DATETIME,CONVERT(VARCHAR(10),[Reference Date],103),103),[Reference No]

RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'P' AND NAME = 'Proc_GetDataSetInvoice')
DROP PROCEDURE Proc_GetDataSetInvoice
GO
--Exec Proc_GetDataSetInvoice 1,'JJGST2013680',1
CREATE PROCEDURE [Proc_GetDataSetInvoice]
@typeid int = 0,
@InvoiceNum varchar(100) = '',
@Processid int = 0,
@tablename varchar(200) = ''
AS
/*

    //  Created Date :     15-02-2020          
    //  Created By   :     SIVA                             
    //  Description  :               
    //  PMS Number   :    ILCONSAML5704                       
    //  CR NUmber    : 
    
    //------------------------------------------------------------------------------------
    // Modify Date       Edited By         CR/BZ				Change Description
	   22/12/2020		 Uday				CRCONSMRC0226 		
    //------------------------------------------------------------------------------------
    //------------------------------------------------------------------------------------

	Exec Proc_GetDataSetInvoice 1,'MLBL051120000770',1

*/
BEGIN

	IF @TYPEID = 1
	BEGIN

	        CREATE TABLE #temp_EInvoiceColumn
			(
			  id INT IDENTITY ,
			  Nodeid INT ,
			  TransType VARCHAR(50)
			 )

			 CREATE TABLE #ETransType
			(
			  Jid INT IDENTITY ,
			  TransType VARCHAR(50),
			  Nodeid INT 			  
			 )

			 Create table #ETransType3
			 (
				 ETid INT IDENTITY ,
				 StrQuery varchar(max)
			 )

	         INSERT INTO #temp_EInvoiceColumn(Nodeid, TransType)
			 SELECT  DISTINCT Nodeid ,TransType   FROM EInvoice_Columns(NOLOCK)   WHERE  ColRequired=1 order by Nodeid

			 
			 if (@Processid <> 2)
			 Begin
				 Delete FROM #temp_EInvoiceColumn WHERE TransType = 'PrecDocDtls' 
			 End 

			  SELECT id,Nodeid ,TransType   FROM #temp_EInvoiceColumn order by id   ----ALWAYS KEEP THIS AS FIRST TABLE                                                       

			 Insert into #ETransType
			 Select distinct TransType,NodeId  from EInvoice_Columns(Nolock)   Where  ColRequired=1 Order by NodeId 

			 if (@Processid <> 2)
			 Begin
				 Delete FROM #ETransType WHERE TransType = 'PrecDocDtls' 
			 End 

			 insert into #ETransType3
			 select '''SELECT DBO.Fn_ReturnEinvoceQuery(''''' + TransType +''''','+CONVERT (varchar(20), @Processid)+','''''+@InvoiceNum +''''', ''''RptEInvoice_Sales'''',''''JSON'''')''' as StrQuery 
			 from #ETransType order by Jid

			 select 'Exec('+StrQuery +')' as StrQuery into #ETransType4  from #ETransType3 order by ETid

		 
			 CREATE TABLE #tbl_query
			 (
				strquery varchar(max)
			 )

			 DECLARE @listStr nVARCHAR(MAX)
			SELECT @listStr = COALESCE(@listStr+' ' ,'') + StrQuery
			FROM #ETransType4

			insert into #tbl_query
			Execute sp_executesql @listStr


			DECLARE @listStr2 nVARCHAR(MAX)
			
			select @listStr2 =  COALESCE(@listStr2+' ' ,'') + StrQuery from #tbl_query
			--select @listStr

			Exec(@listStr2)


			

	END
	IF @TYPEID = 2
	BEGIN

		Select   distinct No as InvoiceNumber from RptEInvoice_Sales A (Nolock) join TempEInvoice B 
		on A.no = B.InvoiceNo and A.TransId = B.TransId where A.TransId = @Processid 

	END
	IF @TYPEID = 3
	BEGIN      
		select SequenceNo , ProcessName , TableName ,SPName  from Tbl_EInvoiceIntegration (Nolock) Where Active =1
	END
	IF @TYPEID = 4   --// export to csv resultset
	BEGIN

		DECLARE @strQuery nvarchar(max) = ''
		set @strQuery =  DBO.Fn_ReturnEinvoceQuery('','','','RptEInvoice_Sales','CSV')  

		EXEC  sp_executesql @strQuery 
		--select @strQuery
	END
	IF @TYPEID = 5   --// TRUNCATE TABLE 
	BEGIN

		Truncate table TempEInvoice

		Truncate table RptEInvoice_Custom_report

		declare @tablename4 varchar(max) = '';

		set  @tablename4 = (select  Distinct TableName   from Tbl_EInvoiceIntegration (Nolock) Where Active =1 )

		--select * from RptEInvoice_Sales

		declare @strsql4  nvarchar(max) = ''
		set @strsql4  = 'Truncate table '+@tablename4
		exec sp_executesql @strsql4




	END

	if @TYPEID = 6  -- Header Node as Default
	begin

	
	--SELECT '1.1' as Version

	SELECT   'http://json-schema.org/draft-04/schema#' AS [$schema],
             'GST-India Invoice Document' AS Title ,
             'GST Invoice format for IRN Generation in INDIA' AS Description,
             '1.1' AS Version
	end
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_EInvoice_CancelIRNXML')
DROP PROCEDURE Proc_EInvoice_CancelIRNXML
GO
CREATE PROCEDURE [Proc_EInvoice_CancelIRNXML]
(
	@strXML ntext = Null ,
	@TransId int = 0  
)
/************************************************
* PROCEDURE  : Proc_EInvoice_CancelIRNXML
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Udhay
* CREATED ON : 09/09/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR			CR/BZ		USER STORY ID		DESCRIPTION	
*21/12/2020  Udhay.R       CR			CRCONSMRC0226       E-invoice generation
				
*************************************************
*/
As
Begin
Declare @iDoc INT

	 
/*
 
 
	
*/ 
	EXECUTE sp_xml_preparedocument @iDoc OUTPUT,@strXML

	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Ltrim(Rtrim(document_status)) as document_status,  
		0 as FileStatus     
	into #document_status	 
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		document_status varchar(100) 
	)    
         
	SELECT 	 
		Ltrim(Rtrim(Success)) as Success, 
		Ltrim(Rtrim(Irn)) as Irn, 
		Ltrim(Rtrim(CancelDate)) as CancelDate, 
		0 as FileStatus     		
	into #Success
	FROM OpenXML(@iDoc,'root/Title/govt_response',2)                                                      
	WITH                                                       
	(                         
		Success varchar(1000),
		Irn varchar(100),
		CancelDate varchar(100)
	)   
	
	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Convert(varchar(100),'') as document_status,
		Convert(varchar(100),'') as Document_Type,
		Ltrim(Rtrim(AckNo)) as AckNo, 
		Ltrim(Rtrim(AckDt)) as AckDt, 
		Ltrim(Rtrim(Irn)) as Irn, 
		Ltrim(Rtrim(SignedInvoice)) as SignedInvoice, 
		Ltrim(Rtrim(SignedQRCode)) as SignedQRCode, 
		0 as FileStatus     		
	into #SuccessAckNo
	FROM OpenXML(@iDoc,'root/Title/govt_response',2)                                                      
	WITH                                                       
	(                         
		AckNo varchar(500),
		AckDt varchar(500),
		Irn varchar(100),
		SignedInvoice nvarchar(max),
		SignedQRCode nvarchar(max)
	)             
          

	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Convert(varchar(100),'') as document_status,
		Convert(varchar(100),'') as Document_Type,
		Ltrim(Rtrim(error_code)) as error_code, 
		Ltrim(Rtrim(error_message)) as error_message, 
		Ltrim(Rtrim(error_source)) as error_source, 
		0 as FileStatus    
	into #ErrorDetails 		
	FROM OpenXML(@iDoc,'root/Title/govt_response/ErrorDetails',2)                                                      
	WITH                                                       
	(                        
		error_code varchar(1000),   
		error_message varchar(1000),
		error_source varchar(1000)
	)             

	SELECT 	 
		Ltrim(Rtrim(transaction_id)) as transaction_id, 
		Ltrim(Rtrim(transaction_id)) as InvNo,
		0 as FileStatus     	
	into #transaction_id	
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		transaction_id varchar(1000) 
	)    

	SELECT 	 
		Ltrim(Rtrim(gstin)) as gstin, 
		0 as FileStatus      
	into #gstin
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		gstin varchar(50) 
	)
	
	
	SELECT 	 		 
		Ltrim(Rtrim(Typ)) as Typ, 
		Ltrim(Rtrim([No])) as [No], 
		Ltrim(Rtrim(Dt)) as Dt, 
		0 as FileStatus    
	into #DocDtls	
	FROM OpenXML(@iDoc,'root/Title/transaction/DocDtls',2)                                                      
	WITH                                                       
	(                        
		Typ varchar(100),   
		[No] varchar(100),
		Dt varchar(100)
	)       
	
	EXECUTE sp_xml_removedocument @iDoc

	----
 
	Declare @InvNo as varchar(50)
	Declare @gstin as varchar(50)

	----Update A Set A.InvNo = REPLACE(InvNo,B.gstin+'_','') 
	----From 
	----	#transaction_id A , #gstin B
						
	----	set @InvNo = (select substring(InvNo,0,CharIndex('_',InvNo)) From #transaction_id)
 
	update #Success set Success = 'N' where Success is null
 
	
	If ((Select count(1) from #Success where Success = 'N') > 0)  
	Begin	
			Update A Set A.Document_Type = B.Typ , A.InvNo = B.[No]
			From 
				#ErrorDetails A ,
				#DocDtls B
			--where A.InvNo = B.[No]


			Update #document_status set InvNo = @InvNo

			Update A Set A.document_status = B.document_status
			From 
				#ErrorDetails A ,
				#document_status B
			--where A.InvNo = B.InvNo


			Update A Set A.Err_desc = B.error_message , EStatus = 'Failure'
			From 
				RptEInvoice_Sales A (nolock) join
				#ErrorDetails B 
			On	
				A.No = B.InvNo 

			select * From Sys.tables where name like '%fail%'

			if @TransId = 1 
			Begin 
				Insert into EInvoice_Acknowledgment_Failed
				(
					TransId,
					Invoice_Id,
					Invoice_no,
					Invoice_date,
					Err_code,
					Err_desc,
					Lastmoddate
				)
				Select distinct 
					@TransId as TransId,
					SalId as Invoice_Id,
					SalInvNo as Invoice_no,
					Salinvdate as Invoice_date,
					error_code as Err_code,
					[error_message] as Err_desc,
					getdate() as Lastmoddate
				From 
					#ErrorDetails A INNER JOIN SalesInvoice B (NOLOCK)
				ON A.InvNo=B.SalInvNo
			End
			
			if @TransId = 2 
			Begin 
				Insert into EInvoice_Acknowledgment_Failed
				(
					TransId,
					Invoice_Id,
					Invoice_no,
					Invoice_date,
					Err_code,
					Err_desc,
					Lastmoddate
				)
				Select distinct 
					@TransId as TransId,
					ReturnID as Invoice_Id,
					ReturnCode as Invoice_no,
					ReturnDate as Invoice_date,
					error_code as Err_code,
					[error_message] as Err_desc,
					getdate() as Lastmoddate
				From 
					#ErrorDetails A INNER JOIN ReturnHeader B (NOLOCK)
				ON A.InvNo=B.ReturnCode  

			End


 

--- Update A Set A.Err_desc = '' , EStatus = 'PENDING' From RptEInvoice_Sales A
		
	End

	If ((Select count(1) from #Success where Success = 'Y') > 0)  
	Begin
	
			Update A Set A.Document_Type = B.Typ , A.InvNo = B.[No]
			From 
				#SuccessAckNo A ,
				#DocDtls B
			--where	A.InvNo = B.[No]


			Update A Set A.document_status = B.document_status
			From 
				#SuccessAckNo A ,
				#document_status B
			--where A.InvNo = B.InvNo

				delete From #SuccessAckNo where AckNo is null or AckNo = ''
			 	select * From #SuccessAckNo 


				------Update A Set Response_Status=2 
				------From 
				------	EInvoice_Acknowledgment A join
				------	#SuccessAckNo B
				------On
				------	 A.Invoice_no=B.InvNo

 
				Update A Set A.Response_Status = 2 , A.CancelDate = B.CancelDate
				From 
					EInvoice_Acknowledgment A join
					#Success B
				On
					 A.Irn = B.Irn

	 

	End 

End
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'P' AND NAME = 'Proc_EInvoice_GenerateIRNXML')
DROP PROCEDURE Proc_EInvoice_GenerateIRNXML
GO
CREATE Procedure [Proc_EInvoice_GenerateIRNXML]
(
	@strXML ntext = Null ,
	@TransId int = 0 
)
/************************************************
* PROCEDURE  : Proc_EInvoice_GenerateIRNXML
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Udhay
* CREATED ON : 09/09/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR			CR/BZ		USER STORY ID		DESCRIPTION	
*21/12/2020  Udhay.R       CR			CRCONSMRC0226       E-invoice generation
				
*************************************************
*/
As
Begin
Declare @iDoc INT
	EXECUTE sp_xml_preparedocument @iDoc OUTPUT,@strXML

	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Ltrim(Rtrim(document_status)) as document_status,  
		0 as FileStatus     
	into #document_status	 
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		document_status varchar(100) 
	)    
         
	SELECT 	 
		Ltrim(Rtrim(Success)) as Success, 
		0 as FileStatus     		
	into #Success
	FROM OpenXML(@iDoc,'root/Title/govt_response',2)                                                      
	WITH                                                       
	(                         
		Success varchar(1000) 
	)   
	
	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Convert(varchar(100),'') as document_status,
		Convert(varchar(100),'') as Document_Type,
		Ltrim(Rtrim(AckNo)) as AckNo, 
		Ltrim(Rtrim(AckDt)) as AckDt, 
		Ltrim(Rtrim(Irn)) as Irn, 
		Ltrim(Rtrim(SignedInvoice)) as SignedInvoice, 
		Ltrim(Rtrim(SignedQRCode)) as SignedQRCode, 
		0 as FileStatus     		
	into #SuccessAckNo
	FROM OpenXML(@iDoc,'root/Title/govt_response',2)                                                      
	WITH                                                       
	(                         
		AckNo varchar(500),
		AckDt varchar(500),
		Irn varchar(100),
		SignedInvoice nvarchar(max),
		SignedQRCode nvarchar(max)
	)             
          

	SELECT 	 
		Convert(varchar(50),'') as InvNo,
		Convert(varchar(100),'') as document_status,
		Convert(varchar(100),'') as Document_Type,
		Ltrim(Rtrim(error_code)) as error_code, 
		Ltrim(Rtrim(error_message)) as error_message, 
		Ltrim(Rtrim(error_source)) as error_source, 
		0 as FileStatus    
	into #ErrorDetails 		
	FROM OpenXML(@iDoc,'root/Title/govt_response/ErrorDetails',2)                                                      
	WITH                                                       
	(                        
		error_code varchar(1000),   
		error_message varchar(1000),
		error_source varchar(1000)
	)             

	SELECT 	 
		Ltrim(Rtrim(transaction_id)) as transaction_id, 
		Ltrim(Rtrim(transaction_id)) as InvNo,
		0 as FileStatus     	
	into #transaction_id	
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		transaction_id varchar(1000) 
	)    

	SELECT 	 
		Ltrim(Rtrim(gstin)) as gstin, 
		0 as FileStatus      
	into #gstin
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                         
		gstin varchar(50) 
	)
	
	
	SELECT 	 		 
		Ltrim(Rtrim(Typ)) as Typ, 
		Ltrim(Rtrim([No])) as [No], 
		Ltrim(Rtrim(Dt)) as Dt, 
		0 as FileStatus    
	into #DocDtls	
	FROM OpenXML(@iDoc,'root/Title/transaction/DocDtls',2)                                                      
	WITH                                                       
	(                        
		Typ varchar(100),   
		[No] varchar(100),
		Dt varchar(100)
	)       


	

	EXECUTE sp_xml_removedocument @iDoc

	----
 
	Declare @InvNo as varchar(50)
	Declare @gstin as varchar(50)

	----Update A Set A.InvNo = REPLACE(InvNo,B.gstin+'_','') 
	----From 
	----	#transaction_id A , #gstin B
						
	----	set @InvNo = (select substring(InvNo,0,CharIndex('_',InvNo)) From #transaction_id)
 
	update #Success set Success = 'N' where Success is null
 
	
	If ((Select count(1) from #Success where Success = 'N') > 0)  
	Begin	
			Update A Set A.Document_Type = B.Typ , A.InvNo = B.[No]
			From 
				#ErrorDetails A ,
				#DocDtls B
			--where A.InvNo = B.[No]


			Update #document_status set InvNo = @InvNo

			Update A Set A.document_status = B.document_status
			From 
				#ErrorDetails A ,
				#document_status B
			--where A.InvNo = B.InvNo


			Update A Set A.Err_desc = B.error_message , EStatus = 'Failure'
			From 
				RptEInvoice_Sales A (nolock) join
				#ErrorDetails B 
			On	
				A.No = B.InvNo and 
				A.TransId = @TransId

			select * From Sys.tables where name like '%fail%'

			if @TransId = 1 
			Begin 
				Insert into EInvoice_Acknowledgment_Failed
				(
					TransId,
					Invoice_Id,
					Invoice_no,
					Invoice_date,
					Err_code,
					Err_desc,
					Lastmoddate
				)
				Select distinct 
					@TransId as TransId,
					SalId as Invoice_Id,
					SalInvNo as Invoice_no,
					Salinvdate as Invoice_date,
					error_code as Err_code,
					[error_message] as Err_desc,
					getdate() as Lastmoddate
				From 
					#ErrorDetails A INNER JOIN SalesInvoice B (NOLOCK)
				ON A.InvNo=B.SalInvNo
			End
			
			if @TransId = 2 
			Begin 
				Insert into EInvoice_Acknowledgment_Failed
				(
					TransId,
					Invoice_Id,
					Invoice_no,
					Invoice_date,
					Err_code,
					Err_desc,
					Lastmoddate
				)
				Select distinct 
					@TransId as TransId,
					ReturnID as Invoice_Id,
					ReturnCode as Invoice_no,
					ReturnDate as Invoice_date,
					error_code as Err_code,
					[error_message] as Err_desc,
					getdate() as Lastmoddate
				From 
					#ErrorDetails A INNER JOIN ReturnHeader B (NOLOCK)
				ON A.InvNo=B.ReturnCode  

			End
			
 
		
	End

	If ((Select count(1) from #Success where Success = 'Y') > 0)  
	Begin
	

			Update A Set A.Document_Type = B.Typ , A.InvNo = B.[No]
			From 
				#SuccessAckNo A ,
				#DocDtls B
			--where	A.InvNo = B.[No]


			Update A Set A.document_status = B.document_status
			From 
				#SuccessAckNo A ,
				#document_status B
			--where A.InvNo = B.InvNo

				delete From #SuccessAckNo where AckNo is null or AckNo = ''
			 	select * From #SuccessAckNo 


				if @TransId = 1 
				Begin 

					INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
					Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
					Err_code,Err_desc,Lastmoddate,MovedOnDate)
					SELECT Distinct @TransId,SalId,SalInvNo,Salinvdate,	
					AckNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),AckDt,121),121) as Ack_Date,Irn as Irn,SignedInvoice as SignedInvoice,
					SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],CASE A.document_status WHEN 'IRN_GENERATED' THEN 1 ELSE 0 END,'' as Err_code,'' as Err_desc,
					GETDATE(),GETDATE()
					FROM #SuccessAckNo A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)
					ON A.InvNo=B.SalInvNo
					WHERE A.document_status='IRN_GENERATED'
					AND A.Document_Type='INV'
					AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
					C.Invoice_Id=B.Salid AND C.Invoice_no=B.SalInvNo AND C.Invoice_no=A.InvNo
					AND TransId=1)

					Update A Set A.EStatus = 'Success' , A.Ack_Number = B.AckNo , A.Err_desc = '',
					A.Ack_Status = 'ACT'  , A.Ack_Date = B.AckDt , A.SignedInvoice = B.SignedInvoice ,
					A.SignedQRCode = B.SignedQRCode , A.Irn = B.Irn
					From 
						RptEInvoice_Sales A (nolock) join
						#SuccessAckNo B 
					On	
						A.No = B.InvNo and 
						A.TransId = @TransId

				End 

				if @TransId = 2 
				Begin 

					INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
					Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
					Err_code,Err_desc,Lastmoddate,MovedOnDate)
					SELECT Distinct @TransId,ReturnID,ReturnCode,ReturnDate,	
					AckNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),AckDt,121),121) as Ack_Date,Irn as Irn,SignedInvoice as SignedInvoice,
					SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],CASE A.document_status WHEN 'IRN_GENERATED' THEN 1 ELSE 0 END,'' as Err_code,'' as Err_desc,
					GETDATE(),GETDATE()
					FROM #SuccessAckNo A (NOLOCK) INNER JOIN ReturnHeader B (NOLOCK)
					ON A.InvNo=B.ReturnCode
					WHERE A.document_status='IRN_GENERATED'
					AND A.Document_Type='CRN'
					AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
					C.Invoice_Id=B.ReturnID AND C.Invoice_no=B.ReturnCode AND C.Invoice_no=A.InvNo
					AND TransId = 2)

					Update A Set A.EStatus = 'Success' , A.Ack_Number = B.AckNo ,  A.Err_desc = '',
					A.Ack_Status = 'ACT' , A.Ack_Date = B.AckDt , A.SignedInvoice = B.SignedInvoice ,
					A.SignedQRCode = B.SignedQRCode, A.Irn = B.Irn
					From 
						RptEInvoice_Sales A (nolock) join
						#SuccessAckNo B 
					On	
						A.No = B.InvNo and 
						A.TransId = @TransId

				End 
		
		

	End
End
GO
IF NOT EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Tbl_EITransactions' AND XTYPE = 'U')
BEGIN
	Create Table Tbl_EITransactions
	(
		Slno	Bigint,
		TransName	Varchar(50),
		Transid		INT,
		TransType	Varchar(50),		
		CONSTRAINT [PK_EITransactions_SLNO_TransType] PRIMARY KEY CLUSTERED 
		(
			Slno,Transid ASC
		)
	)	
END
GO
DELETE FROM Tbl_EITransactions
INSERT INTO Tbl_EITransactions (Slno,TransName,Transid,TransType)
SELECT 1,'Sales',1,'Export' UNION ALL
SELECT 2,'Return',1,'Export' UNION ALL
SELECT 3,'Purcahse Return',1,'Export' UNION ALL
SELECT 4,'IDT Sales',1,'Export' UNION ALL
SELECT 5,'Services Invoice',1,'Export' UNION ALL
SELECT 1,'Microsoft.Jet.OLEDB.4.0/Excel 8.0',2,'Import' UNION ALL
SELECT 2,'Microsoft.ACE.OLEDB.12.0/Excel 12.0',2,'Import'
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Report_Template_EI' AND XTYPE = 'U')
DROP TABLE Report_Template_EI
GO
CREATE TABLE Report_Template_EI(
	ColId			int NOT NULL,
	FieldName		varchar(100) NULL,
	FieldSize		int NULL,
	FieldSelection	tinyint NULL,
	GroupField		tinyint NULL,
	FieldType		tinyint NULL,
	Alignment		tinyint NULL,
	HeaderCaption	varchar(150) NULL,
	HeaderCaption1	varchar(150) NULL,
	HeaderCaption2	varchar(150) NULL,
	RoundOff		tinyint NULL,
	CreatedDate		datetime NULL,
 CONSTRAINT [PK_Report_Template_EI_ColId] PRIMARY KEY CLUSTERED 
(
	ColId ASC
)
) ON [PRIMARY]
GO
Delete From Report_Template_EI 
INSERT INTO Report_Template_EI(ColId,FieldName,FieldSize,FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,
HeaderCaption1,HeaderCaption2,RoundOff,CreatedDate)
Select 1,'Transid',20,4,0,1,1,'TransId','','',0,GETDATE() UNION ALL
Select 2,'TransType',20,4,0,1,1,'TransType','','',0,GETDATE() UNION ALL
Select 3,'Code',20,4,0,1,1,'Code','','',0,GETDATE() UNION ALL
Select 4,'Name',20,4,0,1,1,'Name','','',0,GETDATE() UNION ALL
Select 5,'InvoiceDate',20,4,0,1,1,'Invoice_date','','',0,GETDATE() UNION ALL
Select 6,'Invoiceno',20,4,0,1,1,'Invoice_no','','',0,GETDATE() UNION ALL
Select 7,'Ack_Number',20,4,0,1,1,'Ack_Number','','',0,GETDATE() UNION ALL
Select 8,'Ack_Date',20,4,0,1,1,'Ack_Date','','',0,GETDATE() UNION ALL
Select 9,'IRNno',20,4,0,1,1,'Irn','','',0,GETDATE() UNION ALL
Select 10,'QRCode',20,4,0,1,1,'SignedQRCode','','',0,GETDATE() 
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'ReportTransEI' AND XTYPE = 'U')
DROP TABLE ReportTransEI
GO
CREATE TABLE ReportTransEI
(
	SLNO		BIGINT	IDENTITY(1,1),
	Transid		Int,
	TransType	Varchar(50),
	Code		NVARCHAR(50),
	Name		NVARCHAR(100),
	InvoiceDate	DateTime,
	InvoiceNo	NVARCHAR(100),
	Ack_Number	NVARCHAR(100),
	Ack_Date	VARCHAR(10),
	IRNno		NVARCHAR(200),
	QRCode		NVARCHAR(4000)
)
GO
IF EXISTS (Select '' From Sysobjects Where Name = 'EIErrorlog' and Xtype = 'U')
Drop Table EIErrorlog
GO
CREATE TABLE EIErrorlog(
	[Code] [nvarchar](50) NULL,
	[NAME] [nvarchar](100) NULL,
	[Invoice_no] [varchar](50) NULL,
	[TrnasType] [varchar](50) NULL,
	[ErrDesc] [nvarchar](200) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Proc_ExportEInvoice' AND XTYPE = 'P')
DROP PROCEDURE Proc_ExportEInvoice
GO
--EXEC Proc_ExportEInvoice 1,'Sales','2020-01-01','2020-03-10'
CREATE PROCEDURE Proc_ExportEInvoice
(
	@Pi_TransID			INT,
	@Pi_TransType		Varchar(50),
	@Pi_FromDate		Datetime,
	@Pi_ToDate			Datetime
)
AS
SET NOCOUNT ON
BEGIN
	
  TRUNCATE TABLE ReportTransEI	
	
  IF @Pi_TransID = 1
  BEGIN		
	INSERT INTO ReportTransEI (Code,Name,InvoiceDate,InvoiceNo,Ack_Number,Ack_Date,IRNno,QRCode,Transid,TransType)
	SELECT B.RtrCode,B.RtrName,SalInvDate,SalInvNo,'' Ack_Number, '' Ack_Date,'' Irno, 
	'' QRCode,@Pi_TransID,@Pi_TransType
	FROM SalesInvoice A (NOLOCK) 
	INNER JOIN Retailer B (NOLOCK) ON A.RtrId = B.RtrId
	Where SalInvDate Between @Pi_FromDate and @Pi_ToDate ORDER BY A.SalInvDate,A.SalInvNo,B.RtrName
  END  
  ELSE IF @Pi_TransID = 2
  BEGIN		
	INSERT INTO ReportTransEI (Code,Name,InvoiceDate,InvoiceNo,Ack_Number,Ack_Date,IRNno,QRCode,Transid,TransType)
	SELECT B.RtrCode,B.RtrName,ReturnDate,ReturnCode,'' Ack_Number, '' Ack_Date,'' Irno, 
	'' QRCode,@Pi_TransID,@Pi_TransType
	FROM ReturnHeader A (NOLOCK) 
	INNER JOIN Retailer B (NOLOCK) ON A.RtrId = B.RtrId
	Where ReturnDate Between @Pi_FromDate and @Pi_ToDate
  END 
  ELSE IF @Pi_TransID = 3
  BEGIN		
	INSERT INTO ReportTransEI (Code,Name,InvoiceDate,InvoiceNo,Ack_Number,Ack_Date,IRNno,QRCode,Transid,TransType)
	SELECT B.SpmCode,B.SpmName,PurRetDate,PurRetRefNo,'' Ack_Number, '' Ack_Date,'' Irno, 
	'' QRCode,@Pi_TransID,@Pi_TransType
	FROM PurchaseReturn A (NOLOCK) 
	INNER JOIN Supplier B (NOLOCK) ON A.SpmId = B.SpmId
	Where PurRetDate  Between @Pi_FromDate and @Pi_ToDate
  END   
  ELSE IF @Pi_TransID = 4
  BEGIN		
	INSERT INTO ReportTransEI (Code,Name,InvoiceDate,InvoiceNo,Ack_Number,Ack_Date,IRNno,QRCode,Transid,TransType)
	SELECT B.SpmCode,B.SpmName,IDTMngDate,IDTMngRefNo,'' Ack_Number, '' Ack_Date,'' Irno, 
	'' QRCode,@Pi_TransID,@Pi_TransType
	FROM IDTManagement A (NOLOCK) 
	INNER JOIN IDTMaster B (NOLOCK) ON A.ToSpmId = B.SpmId
	Where IDTMngDate  Between @Pi_FromDate and @Pi_ToDate AND A.StkMgmtTypeId = 2
  END      
RETURN
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Proc_ImportEInvoice' AND XTYPE = 'P')
DROP PROCEDURE Proc_ImportEInvoice
GO
/*
Begin Transaction
EXEC Proc_ImportEInvoice 'Sales','Microsoft.Jet.OLEDB.4.0','Excel 8.0','E:\Kishore\Amul\E-Invoice\ExcelReports\EInvoice-Sales13032073111028.xls','',0,''
Select * from EInvoice_Acknowledgment
Rollback Transaction
*/
CREATE PROCEDURE Proc_ImportEInvoice
(
	@Pi_TransType AS VARCHAR(50),
	@Pi_Provider as NVARCHAR(200),
	@Pi_Excon as NVARCHAR(100),
	@Pi_Path as  VARCHAR(2000),
	@Pi_Sheets as Nvarchar(100),
	@Pi_Error	Int OUTPUT,
	@Pi_Errmsg   Nvarchar(100) OUTPUT
)
AS
SET NOCOUNT ON
BEGIN

	SET @Pi_Error=0
	SET @Pi_Errmsg = ''
	SET @Pi_Sheets = 'Sheet1$'

CREATE TABLE #EInvoice_Acknowledgment
(
	Transid			INT,
	TrnasType		Varchar(50),
	Code			Nvarchar(50),
	Name			Nvarchar(100),
	Invoice_date	Datetime,
	Invoice_no		Varchar(50),
	Ack_Number		Varchar(200),
	Ack_Date		Datetime,
	Irn				Varchar(100),
	SignedQRCode	Varchar(8000)
)
	
  BEGIN TRY
	DECLARE @SSQL AS NVARCHAR(MAX)
	
	TRUNCATE TABLE EIErrorlog

	--DECLARE @Pi_TransType AS VARCHAR(50)
	--DECLARE @Pi_Provider as NVARCHAR(200)
	--DECLARE @Pi_Excon as NVARCHAR(100)
	--DECLARE @Pi_Path as NVARCHAR(200)
	--Declare @Pi_Sheets as Nvarchar(100)
	----SET @Pi_Provider = 'Microsoft.Jet.OLEDB.4.0'
	----SET @Pi_Path = 'C:\ExcelReports\EInvoice-Sales12032072122634.xls'
	----SET @Pi_Excon = 'Excel 8.0'
	----SET @Pi_Sheets = '[Sheet1$]'
		
	--SET @SSQL = 'INSERT INTO #EInvoice_Acknowledgment SELECT *
	--FROM OPENROWSET('''+ @Pi_Provider + ''','''+ @Pi_Excon + ''+';Database='+ @Pi_Path + ''''+',' +@Pi_Sheets+')
	--WHERE Rtrim(Ltrim(Irn)) IS NOT NULL AND Rtrim(Ltrim(Irn)) <> ''''
	--AND Rtrim(Ltrim(SignedQRCode)) IS NOT NULL AND Rtrim(Ltrim(SignedQRCode)) <> '''''
	
	SET @SSQL = 'INSERT INTO #EInvoice_Acknowledgment SELECT *
	FROM OPENROWSET('''+ @Pi_Provider + ''','''+ @Pi_Excon + ''+';Database='+ @Pi_Path + ''''+',' +@Pi_Sheets+')'
	--PRINT @SSQL
	EXEC (@SSQL)
				
	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)	
	SELECT Code,NAME,Invoice_no,TrnasType,'IRNno/QRCode Is Blank' FROM #EInvoice_Acknowledgment
	WHERE Rtrim(Ltrim(ISNULL(Irn,''))) = '' AND  Rtrim(Ltrim(ISNULL(SignedQRCode,''))) = ''	

	Delete FROM #EInvoice_Acknowledgment	
	WHERE Rtrim(Ltrim(ISNULL(Irn,''))) = '' AND  Rtrim(Ltrim(ISNULL(SignedQRCode,''))) = ''		
				
	--Sales
	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)			
	SELECT Code,NAME,Invoice_no,TrnasType,'Invoice No Does not match with Sales' FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM Salesinvoice B (NOLOCK) WHERE A.Invoice_no = B.SalInvNo) AND A.Transid = 1
	AND UPPER(A.TrnasType) = 'SALES'
		
	Delete A FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM Salesinvoice B (NOLOCK) WHERE A.Invoice_no = B.SalInvNo) AND A.Transid = 1
	AND UPPER(A.TrnasType) = 'SALES'
	
	UPDATE C SET C.Ack_Number = B.Ack_Number,C.Ack_Date = B.Ack_Date,C.Irn = B.Irn,C.SignedQRCode = B.SignedQRCode
	FROM SalesInvoice A (NOLOCK)  
	INNER JOIN #EInvoice_Acknowledgment B ON  A.SalInvNo = B.Invoice_no
	INNER JOIN EInvoice_Acknowledgment C (NOLOCK) ON C.Invoice_Id = A.SalId AND C.Invoice_no = B.Invoice_no
	AND C.Invoice_no = A.SalInvNo		
	WHERE C.TransId = 1	AND B.Transid = 1 AND UPPER(B.TrnasType) = 'SALES'

	INSERT INTO EInvoice_Acknowledgment (TransId,Invoice_Id,Invoice_no,Invoice_date,Ack_Number,Ack_Date,Irn,SignedInvoice,
	SignedQRCode,Ack_Status,Response_Status,Err_code,Err_desc,Lastmoddate,MovedOnDate)
	
	SELECT 1 TransId,B.SalId Invoice_Id,B.SalInvNo Invoice_no,B.SalInvDate Invoice_date,
	ISNULL(A.Ack_Number,'') Ack_Number,ISNULL(A.Ack_Date,'1900-01-01') Ack_Date,A.Irn,''SignedInvoice,
	A.SignedQRCode,'ACT' Ack_Status,1 Response_Status,'' Err_code,'' Err_desc,GETDATE() Lastmoddate,'1900-01-01' MovedOnDate	
	FROM #EInvoice_Acknowledgment A
	INNER JOIN SalesInvoice B (NOLOCK) ON A.Invoice_no = B.SalInvNo		
	where NOT EXISTS (SELECT * FROM EInvoice_Acknowledgment EI (NOLOCK) WHERE EI.Invoice_Id = B.SalId 
	AND EI.Invoice_no = B.SalInvNo AND EI.Invoice_no = A.Invoice_no AND EI.TRANSID = 1)				
	AND A.Transid = 1 AND UPPER(A.TrnasType) = 'SALES'

	--Sales Return
	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)			
	SELECT Code,NAME,Invoice_no,TrnasType,'Invoice No Does not match with Return' FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM ReturnHeader B (NOLOCK) WHERE A.Invoice_no = B.ReturnCode) AND A.Transid = 2
	AND UPPER(A.TrnasType) = 'RETURN'
	
	Delete A FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM ReturnHeader B (NOLOCK) WHERE A.Invoice_no = B.ReturnCode) AND A.Transid = 2
	AND UPPER(A.TrnasType) = 'RETURN'
	
	UPDATE C SET C.Ack_Number = B.Ack_Number,C.Ack_Date = B.Ack_Date,C.Irn = B.Irn,C.SignedQRCode = B.SignedQRCode
	FROM ReturnHeader A (NOLOCK)  
	INNER JOIN #EInvoice_Acknowledgment B ON  A.ReturnCode = B.Invoice_no
	INNER JOIN EInvoice_Acknowledgment C (NOLOCK) ON C.Invoice_Id = A.ReturnID AND C.Invoice_no = B.Invoice_no
	AND C.Invoice_no = A.ReturnCode		
	WHERE C.TransId = 2	AND B.Transid = 2 AND UPPER(B.TrnasType) = 'RETURN'

	INSERT INTO EInvoice_Acknowledgment (TransId,Invoice_Id,Invoice_no,Invoice_date,Ack_Number,Ack_Date,Irn,SignedInvoice,
	SignedQRCode,Ack_Status,Response_Status,Err_code,Err_desc,Lastmoddate,MovedOnDate)
	
	SELECT 2 TransId,B.ReturnID Invoice_Id,B.ReturnCode Invoice_no,B.ReturnDate Invoice_date,
	ISNULL(A.Ack_Number,'') Ack_Number,ISNULL(A.Ack_Date,'1900-01-01') Ack_Date,A.Irn,''SignedInvoice,
	A.SignedQRCode,'ACT' Ack_Status,1 Response_Status,'' Err_code,'' Err_desc,GETDATE() Lastmoddate,'1900-01-01' MovedOnDate	
	FROM #EInvoice_Acknowledgment A
	INNER JOIN ReturnHeader B (NOLOCK) ON A.Invoice_no = B.ReturnCode		
	where NOT EXISTS (SELECT * FROM EInvoice_Acknowledgment EI (NOLOCK) WHERE EI.Invoice_Id = B.ReturnID 
	AND EI.Invoice_no = B.ReturnCode AND EI.Invoice_no = A.Invoice_no AND EI.TRANSID = 2)				
	AND A.Transid = 2 AND UPPER(A.TrnasType) = 'RETURN'	
	
	--Purchase Return
	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)			
	SELECT Code,NAME,Invoice_no,TrnasType,'Invoice No Does not match with Purchase' FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM PurchaseReturn B (NOLOCK) WHERE A.Invoice_no = B.PurRcptRefNo) AND A.Transid = 3
	AND UPPER(A.TrnasType) = 'PURCAHSE RETURN'
	
	Delete A FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM PurchaseReturn B (NOLOCK) WHERE A.Invoice_no = B.PurRcptRefNo) AND A.Transid = 3
	AND UPPER(A.TrnasType) = 'PURCAHSE RETURN'
	
	UPDATE C SET C.Ack_Number = B.Ack_Number,C.Ack_Date = B.Ack_Date,C.Irn = B.Irn,C.SignedQRCode = B.SignedQRCode
	FROM PurchaseReturn A (NOLOCK)  
	INNER JOIN #EInvoice_Acknowledgment B ON  A.PurRcptRefNo = B.Invoice_no
	INNER JOIN EInvoice_Acknowledgment C (NOLOCK) ON C.Invoice_Id = A.PurRcptId AND C.Invoice_no = B.Invoice_no
	AND C.Invoice_no = A.PurRcptRefNo		
	WHERE C.TransId = 3	AND B.Transid = 3 AND UPPER(B.TrnasType) = 'PURCAHSE RETURN'

	INSERT INTO EInvoice_Acknowledgment (TransId,Invoice_Id,Invoice_no,Invoice_date,Ack_Number,Ack_Date,Irn,SignedInvoice,
	SignedQRCode,Ack_Status,Response_Status,Err_code,Err_desc,Lastmoddate,MovedOnDate)
	
	SELECT 3 TransId,B.PurRcptId Invoice_Id,B.PurRcptRefNo Invoice_no,B.PurRetDate Invoice_date,
	ISNULL(A.Ack_Number,'') Ack_Number,ISNULL(A.Ack_Date,'1900-01-01') Ack_Date,A.Irn,''SignedInvoice,
	A.SignedQRCode,'ACT' Ack_Status,1 Response_Status,'' Err_code,'' Err_desc,GETDATE() Lastmoddate,'1900-01-01' MovedOnDate	
	FROM #EInvoice_Acknowledgment A
	INNER JOIN PurchaseReturn B (NOLOCK) ON A.Invoice_no = B.PurRcptRefNo		
	where NOT EXISTS (SELECT * FROM EInvoice_Acknowledgment EI (NOLOCK) WHERE EI.Invoice_Id = B.PurRcptId 
	AND EI.Invoice_no = B.PurRcptRefNo AND EI.Invoice_no = A.Invoice_no AND EI.TRANSID = 3)				
	AND A.Transid = 3 AND UPPER(A.TrnasType) = 'PURCAHSE RETURN'	

	--IDT Sales
	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)			
	SELECT Code,NAME,Invoice_no,TrnasType,'Invoice No Does not match with IDT Sales' FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM IDTManagement B (NOLOCK) WHERE A.Invoice_no = B.IDTMngRefNo AND B.StkMgmtTypeId = 2) 
	AND A.Transid = 4 AND UPPER(A.TrnasType) = 'IDT SALES'
		
	Delete A FROM #EInvoice_Acknowledgment A
	WHERE NOT EXISTS (SELECT * FROM IDTManagement B (NOLOCK) WHERE A.Invoice_no = B.IDTMngRefNo AND B.StkMgmtTypeId = 2) 
	AND A.Transid = 4 AND UPPER(A.TrnasType) = 'IDT SALES'
	
	UPDATE C SET C.Ack_Number = B.Ack_Number,C.Ack_Date = B.Ack_Date,C.Irn = B.Irn,C.SignedQRCode = B.SignedQRCode
	FROM IDTManagement A (NOLOCK)  
	INNER JOIN #EInvoice_Acknowledgment B ON  A.IDTMngRefNo = B.Invoice_no
	INNER JOIN EInvoice_Acknowledgment C (NOLOCK) ON C.Invoice_no = B.Invoice_no AND C.Invoice_no = A.IDTMngRefNo
	WHERE C.TransId = 4	AND B.Transid = 4 AND UPPER(B.TrnasType) = 'IDT SALES' AND A.StkMgmtTypeId = 2

	INSERT INTO EInvoice_Acknowledgment (TransId,Invoice_Id,Invoice_no,Invoice_date,Ack_Number,Ack_Date,Irn,SignedInvoice,
	SignedQRCode,Ack_Status,Response_Status,Err_code,Err_desc,Lastmoddate,MovedOnDate)
	
	SELECT 4 TransId,0 Invoice_Id,B.IDTMngRefNo Invoice_no,B.IDTMngDate Invoice_date,
	ISNULL(A.Ack_Number,'') Ack_Number,ISNULL(A.Ack_Date,'1900-01-01') Ack_Date,A.Irn,''SignedInvoice,
	A.SignedQRCode,'ACT' Ack_Status,1 Response_Status,'' Err_code,'' Err_desc,GETDATE() Lastmoddate,'1900-01-01' MovedOnDate	
	FROM #EInvoice_Acknowledgment A
	INNER JOIN IDTManagement B (NOLOCK) ON A.Invoice_no = B.IDTMngRefNo		
	where NOT EXISTS (SELECT * FROM EInvoice_Acknowledgment EI (NOLOCK) 
	WHERE EI.Invoice_no = B.IDTMngRefNo AND EI.Invoice_no = A.Invoice_no AND EI.TRANSID = 4)				
	AND A.Transid = 4 AND UPPER(A.TrnasType) = 'IDT SALES' AND B.StkMgmtTypeId = 2
		
  END TRY
	BEGIN CATCH		
		SET @Pi_Error = @@ERROR		
		IF @Pi_Error = 7303 
		BEGIN
			set @Pi_Error = 1			
			SET @Pi_Errmsg = 'Excel Application was already Open'	
		END
		ELSE IF @Pi_Error = 7314 
		BEGIN
			set @Pi_Error = 1
			SET @Pi_Errmsg = 'File Not Found'	
		END
		ELSE
		BEGIN
			set @Pi_Error = 1
			SELECT @Pi_Errmsg=  ERROR_MESSAGE()   
		END		
	END CATCH  
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS Where Name = 'Proc_RptEInvoiceLoadDetails' and Xtype = 'P')
Drop Procedure Proc_RptEInvoiceLoadDetails
GO
CREATE PROCEDURE [dbo].[Proc_RptEInvoiceLoadDetails]
(
	@Typeid INT = 0,
	@ProcessId int = 0,
	@FROMDate VARCHAR(10) = '',
	@Todate VARCHAR(10) = '',
	@InvNo varchar(50) = '',
	@TransactionType INT =  0,
	@StatusId INT = 0
)
/************************************************
* PROCEDURE  : Proc_EInvoice_CancelIRNXML
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Udhay
* CREATED ON : 17/12/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR			CR/BZ		USER STORY ID		DESCRIPTION	
*17/12/2020  Udhay.R       CR			CRCONSMRC0226       E-invoice generation
				
*************************************************
*/
AS
BEGIN

	DECLARE @HostName AS VARCHAR(50)
	
	IF @Typeid = 1
	BEGIN
		SELECT DISTINCT SequenceNo, ProcessName FROM Tbl_EInvoiceIntegration (NOLOCK) WHERE Active = 1

		if (@ProcessId = 1)
		Begin
			SELECT * FROM Tbl_ECockPitStatus (nolock) where Id = 0 ORDER BY Id
		End
		if (@ProcessId = 2)
		Begin
			SELECT * FROM Tbl_ECockPitStatus (nolock) where Id = 1 ORDER BY Id
		End
		if (@ProcessId = 3)
		Begin
			SELECT * FROM Tbl_ECockPitStatus (nolock) where Id in (1,2) ORDER BY Id
		End

		 select distinct Slno,TransName From Tbl_EITransactions where TransId = 2 
				
	END
	IF @Typeid = 2
	BEGIN

		SELECT Slno,
			EStatus as [Status],
			Err_desc as [Error Description],
			Ack_Number as [Acknowledgment Number],
			Ack_Date as [Acknowledgment Date],
			Irn as [IRN],
			TRANSID,
			[Transaction Type],
			[Reference No],
			[Reference Date],
			[Buyer Name],
			[Buyer GSTIN],
			[Taxable Amount],
			[Total Tax],
			[NetAmount]
 FROM DBO.Fn_ReturnLoadEinvoceDt() ----WHERE EStatus = @Status

	END
	IF @Typeid = 3
	BEGIN
		select 
			'https://einvoicing.internal.cleartax.co/v2/eInvoice/generate' as API_Path,
			AuthToken as [x-cleartax-auth-token], 
			'EInvoice' as [x-cleartax-product],
			OwnerId as [owner_id],
			GSTTIN as [gstin]
		From 
			EInvoiceAuthentication
	End
	IF @Typeid = 4
	BEGIN
	
		select distinct 
			 Irn as irn,
			 Convert(varchar,1) as CnlRsn,
			 'Wrong' as CnlRem
		From 
			EInvoice_Acknowledgment (nolock)
		where 
			Invoice_no = @InvNo
	End
	IF @Typeid = 5
	BEGIN
		select 
			'https://einvoicing.internal.cleartax.co/v2/eInvoice/cancel' as API_Path,
			AuthToken as [x-cleartax-auth-token], 
			'EInvoice' as [x-cleartax-product],
			OwnerId as [owner_id],
			GSTTIN as [gstin]
		From 
			EInvoiceAuthentication
	End
	IF @Typeid = 6
	BEGIN
		SET @HostName = (SELECT Top 1 HostName FROM Sys.sysprocesses WHERE  status='RUNNABLE' Order By login_time desc)    
		IF ((SELECT Count(*) FROM EInvoiceAttempt) < 1)    
		BEGIN    
			INSERT INTO EInvoiceAttempt    
			SELECT @HostName,1,Getdate()    
			SELECT 1    
		END     
		ELSE    
		BEGIN    
			IF (SELECT Status FROM EInvoiceAttempt) = 0    
			BEGIN    
				UPDATE EInvoiceAttempt SET IPAddress = @HostName,Status = 1,StartTime = Getdate()     
				SELECT 1    
			END    
			ELSE    
			BEGIN    
				IF ((SELECT DatedIFf(hh,StartTime,Getdate()) FROM EInvoiceAttempt) > 1)    
				BEGIN    
					UPDATE EInvoiceAttempt SET IPAddress = @HostName,Status = 1,StartTime = Getdate()     
					SELECT 1    
				END    
				ELSE    
				IF ((SELECT Count(*) FROM EInvoiceAttempt WHERE IPAddress = @HostName) = 1 )    
				BEGIN    
					UPDATE EInvoiceAttempt SET Status = 1,StartTime = Getdate()     
					SELECT 1    
					END    
				ELSE    
				BEGIN    
					SELECT 0             
				END    
			END    

		END

	END
	IF @TypeId = 7
	 Begin    
	  SELECT @HostName =  HostName FROM Sys.sysprocesses WHERE  status='RUNNABLE'    
	  UPDATE EInvoiceAttempt SET Status=0 WHERE IPAddress = @HostName    
	 End 
	 IF @TypeId = 8
	 Begin    
	   Select distinct [Status] FROM ManualConfiguration (nolock) WHERE ModuleId='E-Invoice'
	 End     
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_GetQrcodeType')
DROP FUNCTION Fn_GetQrcodeType
GO
CREATE  FUNCTION Fn_GetQrcodeType()
RETURNS CHAR(1) AS 
/************************************************
* FUNCTION  : Fn_GetQrcodeType
* PURPOSE    : Return QR Code Generate Type 1 for API Response 2 for BASE64 PNG Image
* CREATED BY : Siraj
* CREATED ON : 24/12/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR			CR/BZ		USER STORY ID		DESCRIPTION	
*24/12/2020  Siraj.R       CR			CRCONSMRC0227       E-invoice generation
				
*************************************************
*/
BEGIN
RETURN '1'
END
GO
DELETE FROM RptGroup WHERE RptId=441
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSTReports',441,'E-Invoice-Acknowledgement-Status','E-Invoice-Acknowledgement-Status',1
GO
DELETE FROM RptHeader where RptId=441
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'E-Invoice-Acknowledgement-Status','E-Invoice-Acknowledgement-Status',441,'E-Invoice-Acknowledgement-Status','Proc_E_Invoice_Acknowledgement_Excel','RptE_Invoice_Acknowledgement_Excel','RptE_Invoice_Acknowledgement_Excel_Export.rpt',''
GO
DELETE FROM Rptdetails WHERE RptId=441
INSERT INTO Rptdetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (441,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO Rptdetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (441,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO Rptdetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (441,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Status*','',1,'',208,1,1,'Press F4/Double Click to select Status',0)
INSERT INTO Rptdetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (441,4,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Transaction Type*','',1,'',123,1,1,'Press F4/Double Click to select transaction',0)
INSERT INTO Rptdetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (441,5,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Report Type*','',1,'',128,1,1,'Press F4/Double Click to select Report type',0)
GO
DELETE FROM RptFilter WHERE RptId=441 and SelcId=208
INSERT INTO RptFilter(RptId,SelcId,FilterId,FilterDesc)
SELECT 441,208,1,'Success' UNION ALL
SELECT 441,208,2,'Pending' UNION ALL
SELECT 441,208,3,'Failed' UNION ALL
SELECT 441,208,4,'All'
GO
DELETE FROM RptFilter WHERE RptId=441 and SelcId=123
INSERT INTO RptFilter(RptId,SelcId,FilterId,FilterDesc)
SELECT 441,123,1,'Sales' UNION ALL
SELECT 441,123,2,'Sale Return'
GO
DELETE FROM RptFilter WHERE RptId=441 and SelcId=128
INSERT INTO RptFilter(RptId,SelcId,FilterId,FilterDesc)
SELECT 441,128,1,'Summary' UNION ALL
SELECT 441,128,2,'Detail'
GO
DELETE FROM RptExcelHeaders WHERE RptId=441
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
SELECT 441,1,'No','Document No.',1,1 
UNION ALL
SELECT 441,2,'dt','Document Date',1,1 
UNION ALL
SELECT 441,3,'RtrCode','Buyer Code',1,1
UNION ALL
SELECT 441,4,'BTrdNm','Buyer Name',1,1
UNION ALL
SELECT 441,5,'BGstin','BuyerGSTIN',1,1
UNION ALL
SELECT 441,6,'ExcelStateName','State Name',1,1
UNION ALL
SELECT 441,7,'ExcelGrossVal','Gross Amount',1,1
UNION ALL
SELECT 441,8,'ExcelDisc','Discount Amount',1,1
UNION ALL
SELECT 441,9,'ExcelAssVal','Taxable Amount',1,1
UNION ALL
SELECT 441,10,'ExcelCgstVal','CGST Amount',1,1
UNION ALL
SELECT 441,11,'ExcelSgstVal','SGST Amount',1,1
UNION ALL
SELECT 441,12,'ExcelIgstVal','IGST Amount',1,1
UNION ALL
SELECT 441,13,'RndOffAmt','Round Off',1,1
UNION ALL
SELECT 441,14,'TotInvValFc','Net Amount',1,1
UNION ALL
SELECT 441,15,'Ack_Number','Acknowledgment No',1,1 UNION ALL
SELECT 441,16,'Ack_Date','Acknowledgment Date',1,1 UNION ALL
SELECT 441,17,'Irn','Invoice Reference No',1,1 UNION ALL
SELECT 441,18,'Ack_Status','Acknowledgment Status',1,1 
UNION ALL
SELECT 441,19,'CancelDate','Cancel Date',1,1
UNION ALL
SELECT 441,20,'Err_desc','Error',1,1
UNION ALL
SELECT 441,21,'TransId','TransId',0,1
UNION ALL
SELECT 441,22,'Invoice_Id','Invoice_Id',0,1
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_E_Invoice_Acknowledgement_Excel')
DROP PROCEDURE Proc_E_Invoice_Acknowledgement_Excel
GO
--EXEC Proc_E_Invoice_Acknowledgement_Excel 467,1,0,'',0,1,1
CREATE  PROCEDURE Proc_E_Invoice_Acknowledgement_Excel
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************************
* CREATED BY	: Murugan.R
* CREATED DATE	: 17/12/2020
* NOTE		:
* MODIFIED
* DATE			 AUTHOR			USER STORY ID   DESCRIPTION
-------------------------------------------------------------------------------------------------------------
* 17/12/2020	Murugan.R		MARCS202100082	 E-Invoice Sales & Sales Return
25/12/2020	  Mohanakrishna A.B		CR	   CRCRSTJNJ0057		   E- Invoice
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
*************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
		--Filter Variable
		DECLARE @FromDate	   AS	DATETIME
		DECLARE @ToDate	 	   AS	DATETIME
		DECLARE @Status	 	   AS	Tinyint
		DECLARE @SalesType	   AS	TInyint	
		DECLARE @ReportType	   AS	TINYINT	
		DECLARE @ErrNo   AS INT
		
		
		SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
		SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
		SET @Status = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId)) 
		SET @SalesType = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,123,@Pi_UsrId)) 
		SET @ReportType = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,128,@Pi_UsrId)) 
	
		TRUNCATE TABLE  RptEInvoice_Sales		
		TRUNCATE TABLE RptE_Invoice_Acknowledgement_Excel

		CREATE TABLE #RptE_Invoice_Acknowledgement_Excel(
		[No] [varchar](16) NULL,
		[Dt] [datetime] NULL,	
		[RtrCode] [varchar](50) NULL,	
		[BTrdNm] [varchar](100) NULL,
		[BGstin] [varchar](15) NULL,
		[ExcelStateName] [varchar](100) NULL,
		[PrdSlno] [int] NULL,
		[HsnCd] [varchar](8) NULL,
		[PrdDesc] [varchar](100) NULL,	
		[Qty] [numeric](18, 2) NULL,
		[Unit] [varchar](3) NULL,
		[UnitPrice] [numeric](18, 6) NULL,
		[FreeQty] [numeric](18, 2) NULL,	
		[TotAmt] [numeric](18, 6) NULL,
		[Discount] [numeric](18, 6) NULL,
		[OthChrg] [numeric](18, 6) NULL,
		[AssAmt] [numeric](18, 6) NULL,
		[GstRt] [numeric](8, 2) NULL,
		[CgstVal] [numeric](18, 6) NULL,
		[SgstVal] [numeric](18, 6) NULL,
		[IgstVal] [numeric](18, 6) NULL,
		[TotItemVal] [numeric](18, 6) NULL,
		[Ack_Number] [varchar](200) NULL,
		[Ack_Date] [datetime] NULL,
		[Ack_Status] [varchar](20) NULL,
		[Irn] [varchar](100) NULL,
		[CancelDate] [datetime] NULL,
		[Err_desc] [varchar](MAX) NULL,
		[TransId] [tinyint] NULL,
		[Invoice_Id] [bigint] NULL,
		)

		CREATE TABLE #ErrorCode
		(
		Slno INT IDENTITY (1,1),
		Err_code Varchar(50)
		)

		CREATE TABLE #Error_Desc
		(
		TransId TINYINT,
		Invoice_Id BIGINT,
		Invoice_No Varchar(50),
		Err_desc Varchar(Max),
		Err_code Varchar(50),
		PrdSlno INT
		)

		IF @ReportType =2 
		BEGIN
				DELETE FROM RptExcelHeaders WHERE RptId=441
				INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
				SELECT 441,1,'No','Document No.',1,1 
				UNION ALL
				SELECT 441,2,'dt','Document Date',1,1 
				UNION ALL
				SELECT 441,3,'RtrCode','Buyer Code',1,1
				UNION ALL
				SELECT 441,4,'BTrdNm','Buyer Name',1,1
				UNION ALL
				SELECT 441,5,'BGstin','BuyerGSTIN',1,1
				UNION ALL
				SELECT 441,6,'ExcelStateName','State Name',1,1
				UNION ALL
				SELECT 441,7,'PrdSlno','SlNo',1,1
				UNION ALL
				SELECT 441,8,'HsnCd','HSN/SAC Code',1,1
				UNION ALL
				SELECT 441,9,'PrdDesc','Item Name',1,1
				UNION ALL
				SELECT 441,10,'Qty','Qty',1,1
				UNION ALL
				SELECT 441,11,'Unit','Unit',1,1
				UNION ALL
				SELECT 441,12,'UnitPrice','Unit Price',1,1
				UNION ALL
				SELECT 441,13,'FreeQty','Free Qty',1,1
				UNION ALL
				SELECT 441,14,'TotAmt','Gross Amount',1,1
				UNION ALL
				SELECT 441,15,'Discount','Discount',1,1
				UNION ALL
				SELECT 441,16,'OthChrg','Other Charges',0,1
				UNION ALL
				SELECT 441,17,'GstRt','GST Rate',1,1
				UNION ALL
				SELECT 441,18,'AssAmt','Taxable Amount',1,1
				UNION ALL
				SELECT 441,19,'CgstVal','CGST Amount',1,1
				UNION ALL
				SELECT 441,20,'SgstVal','SGST Amount',1,1
				UNION ALL
				SELECT 441,21,'IgstVal','IGST Amount',1,1
				UNION ALL
				SELECT 441,22,'TotItemVal','Net Amount',1,1
				UNION ALL
				SELECT 441,23,'Ack_Number','Acknowledgment No',1,1 UNION ALL
				SELECT 441,24,'Ack_Date','Acknowledgment Date',1,1 UNION ALL
				SELECT 441,25,'Irn','Invoice Reference No',1,1 UNION ALL
				SELECT 441,26,'Ack_Status','Acknowledgment Status',1,1 
				UNION ALL
				SELECT 441,27,'CancelDate','Cancel Date',1,1
				UNION ALL
				SELECT 441,28,'Err_desc','Error',1,1
				UNION ALL
				SELECT 441,29,'TransId','TransId',0,1
				UNION ALL
				SELECT 441,30,'Invoice_Id','Invoice_Id',0,1
		END
		IF @ReportType =1
		BEGIN
			DELETE FROM RptExcelHeaders WHERE RptId=441
			INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
			SELECT 441,1,'No','Document No.',1,1 
			UNION ALL
			SELECT 441,2,'dt','Document Date',1,1 
			UNION ALL
			SELECT 441,3,'RtrCode','Buyer Code',1,1
			UNION ALL
			SELECT 441,4,'BTrdNm','Buyer Name',1,1
			UNION ALL
			SELECT 441,5,'BGstin','BuyerGSTIN',1,1
			UNION ALL
			SELECT 441,6,'ExcelStateName','State Name',1,1
			UNION ALL
			SELECT 441,7,'ExcelGrossVal','Gross Amount',1,1
			UNION ALL
			SELECT 441,8,'ExcelDisc','Discount Amount',1,1
			UNION ALL
			SELECT 441,9,'ExcelAssVal','Taxable Amount',1,1
			UNION ALL
			SELECT 441,10,'ExcelCgstVal','CGST Amount',1,1
			UNION ALL
			SELECT 441,11,'ExcelSgstVal','SGST Amount',1,1
			UNION ALL
			SELECT 441,12,'ExcelIgstVal','IGST Amount',1,1
			UNION ALL
			SELECT 441,13,'RndOffAmt','Round Off',1,1
			UNION ALL
			SELECT 441,14,'TotInvValFc','Net Amount',1,1
			UNION ALL
			SELECT 441,15,'Ack_Number','Acknowledgment No',1,1 UNION ALL
			SELECT 441,16,'Ack_Date','Acknowledgment Date',1,1 UNION ALL
			SELECT 441,17,'Irn','Invoice Reference No',1,1 UNION ALL
			SELECT 441,18,'Ack_Status','Acknowledgment Status',1,1 
			UNION ALL
			SELECT 441,19,'CancelDate','Cancel Date',1,1
			UNION ALL
			SELECT 441,20,'Err_desc','Error',1,1
			UNION ALL
			SELECT 441,21,'TransId','TransId',0,1
			UNION ALL
			SELECT 441,22,'Invoice_Id','Invoice_Id',0,1
		END

			
		IF @SalesType=1
		BEGIN
			EXEC Proc_RptEInvoice_Sales @FromDate,@ToDate,'','',0,0,''
		END
		IF @SalesType=2
		BEGIN
			EXEC Proc_RptEInvoice_SalesReturn @FromDate,@ToDate,'','',0,0,''
		END
		IF @SalesType=4
		BEGIN
			EXEC Proc_RptEInvoice_IDTSales @FromDate,@ToDate,'','',0,0,''
		END
		
		IF @Status=1--Success
		BEGIN
			DELETE A FROM RptEInvoice_Sales A 
			WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId
			AND A.No=B.Invoice_no AND ISNULL(Response_Status,0) IN(1,2) )
		END
		IF @Status=2--Pending
		BEGIN
			DELETE A FROM RptEInvoice_Sales A 
			INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
			AND ISNULL(Response_Status,0) IN(1,2)
		END
		IF @Status=3 --Failed
		BEGIN
			DELETE A FROM RptEInvoice_Sales A 
			WHERE NOT EXISTS(SELECT * FROM EInvoice_Acknowledgment_Failed B (NOLOCK) WHERE A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId AND A.No=B.Invoice_no)

			DELETE A FROM RptEInvoice_Sales A 
			INNER JOIN EInvoice_Acknowledgment B (NOLOCK) ON A.Invoice_Id=B.Invoice_Id AND A.TransId=B.TransId  AND A.No=B.Invoice_no
			AND ISNULL(Response_Status,0) IN(1,2)
		END
		

		INSERT INTO RptE_Invoice_Acknowledgement_Excel(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,Prdid,RtrId,ExcelTaxRate,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,RtrCode,
		ExcelAssVal,ExcelCgstVal,ExcelSgstVal,ExcelIgstVal,ExcelDisc,ExcelTOthChrg
		)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,convert(Datetime,convert(varchar(10),dt, 103),103),OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,Prdid,A.RtrId,ExcelTaxRate,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal,RtrCode,
		ExcelAssVal,ExcelCgstVal,ExcelSgstVal,ExcelIgstVal,ExcelDisc,ExcelTOthChrg
		FROM RptEInvoice_Sales A INNER JOIN Retailer B ON A.RtrId=B.RtrId


		SELECT TransId,No,SUM(TotAmt) as TotAmt		
		INTO #SalesSummary
		FROM RptE_Invoice_Acknowledgement_Excel
		GROUP BY No,TransId

		UPDATE A SET ExcelGrossVal=B.TotAmt
		FROM RptE_Invoice_Acknowledgement_Excel a INNER JOIN #SalesSummary B ON A.No=B.No AND A.TransId=B.TransId


		UPDATE RptE_Invoice_Acknowledgement_Excel SET [RndOffAmt]=[RndOffAmt]+([TotInvValFc]-([ExcelAssVal]+ExcelCgstVal+[ExcelSgstVal]+[ExcelIgstVal]+[RndOffAmt]))

		IF (@Status=3 Or @Status=4)--Failed
		BEGIN
			UPDATE A SET A.[Ack_Status]='IRN NOT GENERATED',
			A.[Err_desc]=null
			FROM RptE_Invoice_Acknowledgement_Excel A INNER JOIN EInvoice_Acknowledgment_Failed B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
			AND No=B.Invoice_no
		END

		UPDATE A SET A.[Ack_Number] =B.[Ack_Number],
		A.[Ack_Date]=B.[Ack_Date],
		A.[Irn]=B.[Irn],
		A.[Ack_Status]=CASE Response_Status WHEN 1 THEN 'IRN GENERATED' WHEN 2 THEN 'IRN CANCELLED' END ,
		A.CancelDate=B.CancelDate,
		A.Err_desc=''
		FROM RptE_Invoice_Acknowledgement_Excel A INNER JOIN EInvoice_Acknowledgment B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id
		AND A.No=B.Invoice_no
		WHERE Response_Status IN(1,2)


		---Failed Invoice Error Details
		SELECT TransId,Invoice_Id,Invoice_no,Max(Lastmoddate) as Lastmoddate 
		INTO #EInvoice_Acknowledgment_Failed
		FROM EInvoice_Acknowledgment_Failed
		GROUP BY TransId,Invoice_Id,Invoice_no

		SELECT B.* INTO #EInvoice_Acknowledgment_Failed1 FROM  #EInvoice_Acknowledgment_Failed A 
		INNER JOIN EInvoice_Acknowledgment_Failed B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id AND A.Invoice_no=B.Invoice_no
		AND A.Lastmoddate=B.Lastmoddate

		--Deleting If E-invoice sucess from Failed table
		DELETE A FROM #EInvoice_Acknowledgment_Failed1 A INNER JOIN EInvoice_Acknowledgment B ON A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id AND A.Invoice_no=B.Invoice_no

		

		IF @ReportType=1--Summary
		BEGIN		
			SELECT DISTINCT No,convert(Datetime,convert(varchar(10),dt, 103),103) as dt,RtrCode,BTrdNm,BGstin,ExcelStateName,
			CAST(ExcelGrossVal as Numeric(18,2)) as ExcelGrossVal,CAST(ExcelDisc  as Numeric(18,2)) as ExcelDisc,CAST(ExcelAssVal  as Numeric(18,2)) as ExcelAssVal,
			CAST(ExcelCgstVal  as Numeric(18,2)) as ExcelCgstVal,
			CAST(ExcelSgstVal as Numeric(18,2)) as ExcelSgstVal,CAST(ExcelIgstVal  as Numeric(18,2)) as ExcelIgstVal,RndOffAmt,CAST(TotInvValFc  as Numeric(18,2)) as TotInvValFc,
			Ack_Number,convert(Datetime,convert(varchar(25),dt, 103),103),Irn,Ack_Status,CancelDate,ISNULL(Err_desc,'') as Err_desc,TransId,Invoice_Id
			FROM RptE_Invoice_Acknowledgement_Excel
			ORDER BY TransId,convert(Datetime,convert(varchar(10),dt, 103),103),No
		END
		ELSE
		BEGIN--Details
				INSERT INTO #RptE_Invoice_Acknowledgement_Excel(No,dt,RtrCode,BTrdNm,BGstin,ExcelStateName,PrdSlno,HsnCd,PrdDesc,Qty ,Unit,UnitPrice,FreeQty,
				TotAmt,Discount,[OthChrg],GstRt,AssAmt,
				CgstVal,SgstVal,IgstVal,TotItemVal,
				Ack_Number,Ack_Date,Irn,Ack_Status,CancelDate,Err_desc,A.TransId,A.Invoice_Id)
				SELECT No,convert(Datetime,convert(varchar(10),dt, 103),103) as dt,RtrCode,BTrdNm,BGstin,ExcelStateName,PrdSlno,HsnCd,PrdDesc,Qty ,Unit,UnitPrice,FreeQty,
				TotAmt as TotAmt,Discount as Discount,[OthChrg]as [OthChrg],GstRt, 
				AssAmt,CgstVal,SgstVal,IgstVal,TotItemVal,
				Ack_Number,convert(Datetime,convert(varchar(25),dt, 103),103),Irn,Ack_Status,CancelDate,iSNULL(A.Err_desc,'') as Err_desc,A.TransId,A.Invoice_Id
				FROM RptE_Invoice_Acknowledgement_Excel A (NOLOCK) 
				
				IF (@Status=3 Or @Status=4)--Failed
				BEGIN
						---Error Number 
						INSERT INTO #ErrorCode(Err_code)
						SELECT DISTINCT Err_code
						FROM RptEInvoice_Sales A (NOLOCK)
						INNER JOIN #EInvoice_Acknowledgment_Failed1 B ON  A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id AND A.No=B.Invoice_no 

					

						DECLARE @Min AS INT
						DECLARE @Max AS INT
						DECLARE @ErrorCode Varchar(50)
						Set @Min=1
						SELECT @Max=MAX(Slno) FROM #ErrorCode
						WHILE @Min<=@Max
						BEGIN
								TRUNCATE TABLE #Error_Desc

								SELECT @ErrorCode=Err_code FROM #ErrorCode WHERE Slno=@Min

								UPDATE A SET A.Err_desc=ISNULL(A.Err_desc,'')+ISNULL(B.Err_desc,'')
								FROM #RptE_Invoice_Acknowledgement_Excel A 
								INNER JOIN EInvoice_Acknowledgment_Failed B ON  A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id AND A.No=B.Invoice_no
								WHERE B.Err_desc NOT Like 'lineItems%' AND Err_code=@ErrorCode AND Ack_Status ='IRN NOT GENERATED'

								INSERT INTO #Error_Desc(TransId,Invoice_Id,Invoice_No,Err_desc,Err_code,PrdSlno)
								SELECT TransId,Invoice_Id,Invoice_No,Err_desc,Err_code,
								SUBSTRING(Err_desc,CharIndex('[',Err_desc,1)+1,
								CHARINDEX(']',SUBSTRING(Err_desc,CharIndex('[',Err_desc,1)+1,LEN(Err_desc)),1)-1)+1 as PrdSlno
								FROM EInvoice_Acknowledgment_Failed WHERE Err_desc like 'lineItems%'
								AND Err_code=@ErrorCode 
								---Update Invoice wise row number wise error details
								UPDATE A SET A.Err_desc=ISNULL(A.Err_desc,'')+ CHAR(13) +ISNULL(B.Err_desc,'')
								FROM #RptE_Invoice_Acknowledgement_Excel A 
								INNER JOIN #Error_Desc B ON  A.Transid=B.TransId and A.Invoice_Id=B.Invoice_Id AND A.No=B.Invoice_no and A.PrdSlno=B.PrdSlno
								AND B.Err_code=@ErrorCode AND Ack_Status ='IRN NOT GENERATED'

						SET @Min=@Min+1
						END
				END

					--Detail Final Output Product wise Failed,Pending and Success report
					SELECT No,dt,RtrCode,BTrdNm,BGstin,ExcelStateName,PrdSlno,HsnCd,PrdDesc,Qty ,Unit,CAST(UnitPrice as Numeric(18,2)),FreeQty,
					CAST(TotAmt as Numeric(18,2)) as TotAmt,CAST(Discount as Numeric(18,2)) as Discount,CAST([OthChrg] as Numeric(18,2)) as [OthChrg],GstRt,CAST(AssAmt as Numeric(18,2)) as AssAmt,
					CAST(CgstVal as Numeric(18,2)) as CgstVal,CAST(SgstVal as Numeric(18,2)) as SgstVal,CAST(IgstVal as Numeric(18,2)) as IgstVal,CAST(TotItemVal as Numeric(18,2)),
					Ack_Number,convert(Datetime,convert(varchar(25),dt, 103),103),Irn,Ack_Status,CancelDate,Err_desc,TransId,Invoice_Id
					FROM #RptE_Invoice_Acknowledgement_Excel
		

			

		END

		Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptE_Invoice_Acknowledgement_Excel
RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_EInvoice_GenerateIRNXML_Manual')
DROP PROCEDURE Proc_EInvoice_GenerateIRNXML_Manual
GO
CREATE Procedure [Proc_EInvoice_GenerateIRNXML_Manual]
(
	@strXML ntext = Null ,
	@TransId int = 0 
)
/************************************************
* PROCEDURE  : Proc_EInvoice_GenerateIRNXML_Manual
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Udhay
* CREATED ON : 09/09/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR			CR/BZ		USER STORY ID		DESCRIPTION	
*21/12/2020  Udhay.R       CR			CRCONSMRC0226       E-invoice generation
				
*************************************************
*/
As
Begin
Declare @iDoc INT
 


	EXECUTE sp_xml_preparedocument @iDoc OUTPUT,@strXML


	SELECT 	 		 
		Ltrim(Rtrim(Typ)) as Typ, 
		Ltrim(Rtrim([No])) as [No], 
		Ltrim(Rtrim(Irn)) as Irn,
		Ltrim(Rtrim([Status])) as [Status],
		Ltrim(Rtrim(QRImage)) as QRImage,
		Ltrim(Rtrim(signedQRCode)) as signedQRCode,
		Ltrim(Rtrim(ackNo)) as ackNo,
		Ltrim(Rtrim(ackDt)) as ackDt,
		Ltrim(Rtrim(success)) as success,
		0 as FileStatus    
	into #SuccessAckNo	
	FROM OpenXML(@iDoc,'root/Title',2)                                                      
	WITH                                                       
	(                        
		Typ varchar(100),   
		[No] varchar(100),		 
		Irn varchar(100),
		[Status] varchar(100),
		QRImage nvarchar(max),
		signedQRCode nvarchar(max),
		ackNo varchar(500),
		ackDt varchar(500),
		success varchar(100)
	)  

	select * From #SuccessAckNo

	If ((Select count(1) from #SuccessAckNo where [Status] = 'ACT') > 0)  
	Begin

 
				--if @TransId = 1 
				--Begin 

					INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
					Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
					Err_code,Err_desc,Lastmoddate,MovedOnDate)
					SELECT Distinct 1,SalId,SalInvNo,Salinvdate,	
					A.ackNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),A.ackDt,121),121) as Ack_Date,Irn as Irn,'' as SignedInvoice,
					SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],CASE A.success WHEN 'true' THEN 1 ELSE 0 END,'' as Err_code,'' as Err_desc,
					GETDATE(),GETDATE()
					FROM #SuccessAckNo A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)
					ON A.No=B.SalInvNo
					WHERE A.success='true'
					AND A.Typ='INV'
					AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
					C.Invoice_Id=B.Salid AND C.Invoice_no=B.SalInvNo AND C.Invoice_no=A.No
					AND TransId=1)

					

				--End 

				--if @TransId = 2 
				--Begin 

					INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
					Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
					Err_code,Err_desc,Lastmoddate,MovedOnDate)
					SELECT Distinct 2,ReturnID,ReturnCode,ReturnDate,	
					A.ackNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),A.ackDt,121),121) as Ack_Date,Irn as Irn,'' as SignedInvoice,
					SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],CASE A.success WHEN 'true' THEN 1 ELSE 0 END,'' as Err_code,'' as Err_desc,
					GETDATE(),GETDATE()
					FROM #SuccessAckNo A (NOLOCK) INNER JOIN ReturnHeader B (NOLOCK)
					ON A.No=B.ReturnCode
					WHERE A.success='true'
					AND A.Typ='CRN'
					AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
					C.Invoice_Id=B.ReturnID AND C.Invoice_no=B.ReturnCode AND C.Invoice_no=A.No
					AND TransId = 2)

				 

				--End 

				--if @TransId = 4
				--Begin 

					INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
					Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
					Err_code,Err_desc,Lastmoddate,MovedOnDate)
					SELECT Distinct 4,0,IDTMngRefNo,IDTMngDate,	
					A.ackNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),A.ackDt,121),121) as Ack_Date,Irn as Irn,'' as SignedInvoice,
					SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],CASE A.success WHEN 'true' THEN 1 ELSE 0 END,'' as Err_code,'' as Err_desc,
					GETDATE(),GETDATE()
					FROM #SuccessAckNo A (NOLOCK) INNER JOIN IDTManagement B (NOLOCK)
					ON A.No=B.IDTMngRefNo
					WHERE A.success='true'
					AND A.Typ='INV'
					AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
					C.Invoice_no=B.IDTMngRefNo AND C.Invoice_no=A.No AND TransId = 4)
									

				--End

					Update A Set A.EStatus = 'Success' , A.Ack_Number = B.ackNo , A.Err_desc = '',
					A.Ack_Status = 'ACT'  , A.Ack_Date =CONVERT(DATETIME,CONVERT(VARCHAR(25),B.ackDt,121),121), A.SignedInvoice = '' ,
					A.SignedQRCode = B.SignedQRCode , A.Irn = B.Irn
					From 
						RptEInvoice_Sales A (nolock) join
						#SuccessAckNo B 
					On	
						A.No = B.No and 
						A.DTyp=B.Typ

	End
	If ((Select count(1) from #SuccessAckNo where [Status] = 'C') > 0)  
	Begin
 

			Update A Set A.Response_Status = 2 , A.CancelDate = CONVERT(DATETIME,CONVERT(VARCHAR(25),getdate(),121),121)
				From 
					EInvoice_Acknowledgment A join
					#SuccessAckNo B
				On
					 A.Irn = B.Irn

	End


END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_RptBillTemplateFinal')
DROP PROCEDURE Proc_RptBillTemplateFinal
GO
-- EXEC PROC_RptBillTemplateFinal 16,1,0,'BILLPrintissue03012018',0,0,1,'RPTBT_VIEW_FINAL1_BILLTEMPLATE'           
CREATE PROCEDURE Proc_RptBillTemplateFinal
(      
	 @Pi_RptId  INT,      
	 @Pi_UsrId  INT,      
	 @Pi_SnapId  INT,      
	 @Pi_DbName  NVARCHAR(50),      
	 @Pi_SnapRequired INT,      
	 @Pi_GetFromSnap  INT,      
	 @Pi_CurrencyId  INT,      
	 @Pi_BTTblName    NVARCHAR(50)      
)      
AS      
/***************************************************************************************************      
* PROCEDURE : Proc_RptBillTemplateFinal      
* PURPOSE : General Procedure      
* NOTES  :        
* CREATED :      
* MODIFIED      
* DATE       AUTHOR     DESCRIPTION      
----------------------------------------------------------------------------------------------------      
* 01.10.2009  Panneer      Added Tax summary Report Part(UserId Condition)      
* 10/07/2015  PRAVEENRAJ BHASKARAN     Added Grammge For Parle  
* DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  10-01-2018  LAKSHMAN			BZ     ICRSTPAR7339             Bill Print Allot ment Issue
  11-04-2019  Lakshman M		SR     ILCRSTPAR4044            product default price new column added
  16/03/2020  MarySubashini.S   SR     ILCRSTPAR8294            TCS Tax Column added    
  04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice        
****************************************************************************************************/      
SET NOCOUNT ON      
BEGIN      
	 --Added By Murugan 04/09/2009      
	 DECLARE @FieldCount AS INT      
	 DECLARE @UomStatus AS INT       
	 DECLARE @UOMCODE AS nVARCHAR(25)      
	 DECLARE @pUOMID as INT      
	 DECLARE @UomFieldList as nVARCHAR(3000)      
	 DECLARE @UomFields as nVARCHAR(3000)      
	 DECLARE @UomFields1 as nVARCHAR(3000)      
	 --END      
	 DECLARE @NewSnapId  AS INT      
	 DECLARE @DBNAME  AS  nvarchar(50)      
	 DECLARE @TblName  AS nvarchar(500)      
	 DECLARE @TblStruct  AS nVarchar(4000)      
	 DECLARE @TblFields  AS nVarchar(4000)      
	 DECLARE @sSql  AS  nVarChar(4000)      
	 DECLARE @ErrNo   AS INT      
	 DECLARE @PurDBName AS nVarChar(50)      
	 Declare @Sub_Val  AS TINYINT      
	 DECLARE @FromDate AS DATETIME      
	 DECLARE @ToDate   AS DATETIME      
	 DECLARE @FromBillNo  AS   BIGINT      
	 DECLARE @TOBillNo    AS   BIGINT      
	 DECLARE @SMId   AS INT      
	 DECLARE @RMId   AS INT      
	 DECLARE @RtrId   AS INT      
	 DECLARE @vFieldName    AS nvarchar(255)      
	 DECLARE @vFieldType AS nvarchar(10)      
	 DECLARE @vFieldLength as nvarchar(10)      
	 DECLARE @FieldList as      nvarchar(4000)      
	 DECLARE @FieldTypeList as varchar(8000)      
	 DECLARE @FieldTypeList2 as varchar(8000)      
	 DECLARE @DeliveredBill  AS INT      
	 DECLARE @SSQL1 AS NVARCHAR(4000)      
	 DECLARE @FieldList1 as      nvarchar(4000)      
	 --For B&L Bill Print Configurtion      
	 SELECT @DeliveredBill=Status FROM  Configuration WHERE ModuleName='Discount & Tax Collection' AND ModuleId='DISTAXCOLL5'      
	IF @DeliveredBill=1      
	BEGIN        
		DELETE FROM RptBillToPrint WHERE [Bill Number] IN(      
		SELECT SalInvNo FROM SalesInvoice WHERE DlvSts NOT IN(4,5))      
	END      
	 --Till Here      
	 --Added By Murugan 04/09/2009      
	 --print @Pi_BTTblName      
	 SET @FieldCount=0      
	 SELECT @UomStatus=Isnull(Status,0) FROM configuration  WHERE ModuleName='General Configuration' and ModuleId='GENCONFIG22' and SeqNo=22      
	 --Till Here      
	 SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))      
	 SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))      
	 DECLARE CurField CURSOR FOR      
	 SELECT sc.name fieldname,st.name fieldtype,sc.length FROM syscolumns sc, systypes st      
	 WHERE sc.id in (SELECT id FROM sysobjects WHERE name like @Pi_BTTblName )      
	 and sc.xtype = st.xtype      
	 and sc.xusertype = st.xusertype      
	 Set @FieldList = ''      
	 Set @FieldTypeList = ''
	       
	 OPEN CurField      
		FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
		WHILE @@Fetch_Status = 0      
		BEGIN      
			if len(@FieldTypeList) > 3060      
			BEGIN      
				Set @FieldTypeList2 = @FieldTypeList      
				Set @FieldTypeList = ''      
			end      
			--->Added By Nanda on 12/03/2010      
			IF LEN(@FieldList)>3060      
			BEGIN      
				SET @FieldList1=@FieldList      
				SET @FieldList=''    
			END      
			--->Till Here      
			if @vFieldName = 'UsrId'      
			BEGIN      
				Set @FieldList = @FieldList  + 'V.[' + @vFieldName + '] , '      
			end      
			else      
			BEGIN      
				Set @FieldList = @FieldList + '[' + @vFieldName + '] , '      
			end      
			if @vFieldType = 'nvarchar' or @vFieldType = 'varchar' or @vFieldType = 'char'      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(' + @vFieldLength + ')' + ','      
			end      
			else if @vFieldType = 'numeric'      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(38,2)' + ','      
			end      
			else      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + ','      
			end      
			FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
		END      
	 Set @FieldList = left(@FieldList,len(@FieldList)-1)      
	 Set @FieldTypeList = left(@FieldTypeList,len(@FieldTypeList)-1)      
	 CLOSE CurField      
	 DEALLOCATE CurField      
	 --Added by Murugan UomCoversion 04/09/2009      
	IF @UomStatus=1      
	BEGIN       
		TRUNCATE TABLE BillTemplateUomBased       
		SET @UomFieldList=''      
		SET @UomFields=''      
		SET @UomFields1=''      
		SET @FieldCount= @FieldCount+1 
		  
		DECLARE CUR_UOM CURSOR      
		FOR SELECT UOMID,UOMCODE FROM UOMMASTER  Order BY UOMID      
		OPEN CUR_UOM      
		FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
		WHILE @@FETCH_STATUS=0      
		BEGIN      
			SET @FieldCount= @FieldCount+1      
			SET @UomFieldList=@UomFieldList+'['+@UOMCODE +'] INT,'      
			SET @UomFields=@UomFields+'0 AS ['+@UOMCODE +'],'      
			SET @UomFields1=@UomFields1+'['+@UOMCODE +'],'       
			INSERT INTO BillTemplateUomBased(ColId,UOMID,UomCode)      
			VALUES (@FieldCount,@pUOMID,@UOMCODE)  
			    
			FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
		END       
		CLOSE CUR_UOM      
		DEALLOCATE CUR_UOM      
		
		SET @UomFieldList= subString(@UomFieldList,1,Len(Ltrim(rtrim(@UomFieldList)))-1)      
		SET @UomFields= subString(@UomFields,1,Len(Ltrim(rtrim(@UomFields)))-1)      
		SET @UomFields1= subString(@UomFields1,1,Len(Ltrim(rtrim(@UomFields1)))-1)        
	END      
	 -----      
	 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)      
	if EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[RptBillTemplateFinal]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)      
	drop table [RptBillTemplateFinal]      
	IF @UomStatus=1      
	BEGIN       
		EXEC('CREATE TABLE RptBillTemplateFinal      
		(' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500),'+ @UomFieldList +')')      
	END      
	ELSE      
	BEGIN      
		EXEC('CREATE TABLE RptBillTemplateFinal      
		(' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500))')      
	END      
	SET @TblName = 'RptBillTemplateFinal'      
	SET @TblStruct = @FieldTypeList2 + @FieldTypeList      
	SET @TblFields = @FieldTypeList2 + @FieldTypeList     
	 
	IF @Pi_GetFromSnap = 1      
	BEGIN      
		SELECT @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId      
		SET @DBNAME =   @DBNAME      
	END      
	ELSE      
	BEGIN      
		SELECT @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3      
		SET @DBNAME = @PI_DBNAME + @DBNAME      
	END      
	--Nanda01      
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data      
	BEGIN      
		DELETE FROM RptBillTemplateFinal WHERE UsrId = @Pi_UsrId      
		IF @UomStatus=1      
		BEGIN      
			EXEC ('INSERT INTO RptBillTemplateFinal (' + @FieldList1+@FieldList + ','+ @UomFields1 + ')' +      
			'SELECT  DISTINCT' + @FieldList1+@FieldList +','+ @UomFields+'  FROM ' + @Pi_BTTblName + ' V,RptBillToPrint T WHERE V.[Sales Invoice Number] = T.[Bill Number]')      
		END      
		ELSE      
		BEGIN      
			--SELECT 'Nanda002'       
			Exec ('INSERT INTO RptBillTemplateFinal (' +@FieldList1+ @FieldList + ')' +      
			'SELECT  DISTINCT' + @FieldList1+ @FieldList + '  FROM ' + @Pi_BTTblName + ' V,RptBillToPrint T WHERE V.[Sales Invoice Number] = T.[Bill Number]')      
		END      
		IF LEN(@PurDBName) > 0      
		BEGIN      
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT      
			SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
			'(' + @TblFields + ')' +      
			' SELECT DISTINCT' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName + ' WHERE UsrId = ' + @Pi_UsrId      
			EXEC (@SSQL)      
			PRINT @SSQL      
			PRINT 'Retrived Data FROM Purged Table'      
		END      
		IF @Pi_SnapRequired = 1      
		BEGIN      
			SELECT @NewSnapId = @Pi_SnapId      
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
			IF @ErrNo = 0      
			BEGIN      
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +      
				'(SnapId,UserId,RptId,' + @TblFields + ')' +      
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +      
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM RptBillTemplateFinal'      
				EXEC (@SSQL)      
				PRINT 'Saved Data Into SnapShot Table'      
			END      
		END      
	END      
	--Nanda02      
	ELSE    --To Retrieve Data FROM Snap Data      
	BEGIN      
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
		PRINT @ErrNo      
		IF @ErrNo = 0      
		BEGIN      
			SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
			'(' + @TblFields + ')' +      
			' SELECT DISTINCT' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +      
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +      
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))      
			EXEC (@SSQL)      
			PRINT 'Retrived Data FROM Snap Shot Table'      
		END      
		ELSE      
			BEGIN      
			PRINT 'DataBase or Table not Found'      
		END      
	END      
	 --Update SplitUp Tax Amount & Perc      
	IF @UomStatus=1      
	BEGIN       
		EXEC Proc_BillTemplateUOM @Pi_UsrId      
	END      
	-- EXEC Proc_BillPrintingTax @Pi_UsrId      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 1')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 1]=BillPrintTaxTemp.[Tax1Perc]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount1')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount1]=BillPrintTaxTemp.[Tax1Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 2')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 2]=BillPrintTaxTemp.[Tax2Perc],[RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount2')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 3')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 3]=BillPrintTaxTemp.[Tax3Perc]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount3')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount3] =BillPrintTaxTemp.[Tax3Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 4')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 4]=BillPrintTaxTemp.[Tax4Perc],[RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END    
		  
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount4')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 5')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 5]=BillPrintTaxTemp.[Tax5Perc],[RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount5')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)  
		END      
		--Till Here      
		--- Sl No added  ---      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product SL No')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Product SL No]=SalesInvoiceProduct.[SlNo]      
			FROM SalesInvoiceProduct,Product,ProductBatch WHERE [RptBillTemplateFinal].SalId=SalesInvoiceProduct.[SalId] AND [RptBillTemplateFinal].[Product Code]=Product.[PrdCCode]      
			AND Product.Prdid=SalesInvoiceProduct.prdid      
			And ProductBatch.Prdid=Product.Prdid and ProductBatch.PrdBatid=SalesInvoiceProduct.PrdBatId      
			AND [RptBillTemplateFinal].[Batch Code] =ProductBatch.[PrdBatCode]'      
			EXEC (@SSQL1)      
		END       
	 --- End Sl No      
	 --->Added By Nanda on 2011/02/24 for Henkel      
		IF NOT EXISTS (SELECT Id,name FROM Syscolumns WHERE name = 'Product Weight' and id in (SELECT id FROM       
		Sysobjects WHERE name ='RptBillTemplateFinal'))      
		BEGIN      
			ALTER TABLE [dbo].[RptBillTemplateFinal]      
			ADD [Product Weight] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
		END      
		IF NOT EXISTS (SELECT Id,name FROM Syscolumns WHERE name = 'Product UPC' and id in (SELECT id FROM       
		Sysobjects WHERE name ='RptBillTemplateFinal'))      
		BEGIN      
			ALTER TABLE [dbo].[RptBillTemplateFinal]      
			ADD [Product UPC] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD GSTTIN VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Pan Number] VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Retailer Type] VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='Composite')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD Composite VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD RelatedParty VARCHAR(50) DEFAULT '' WITH VALUES      
		END
		      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [State Name] VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [State Code] VARCHAR(10) DEFAULT '' WITH VALUES      
		END 
		     
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [StateTinNo] VARCHAR(10) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD HSNCode VARCHAR(100) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD HSNDescription VARCHAR(100) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorGstTin VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateName VARCHAR(50) DEFAULT '' WITH VALUES      
		END 
		     
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Distributor Type] VARCHAR(50) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD AadharNo VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateCode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateCode VARCHAR(10) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateTinNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateTinNo VARCHAR(10) DEFAULT '' WITH VALUES      
		END        
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Dist Food Lic No] VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Dist Drug Lic no] VARCHAR(50) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='SalesInvoice NetAmount Actual')      
		BEGIN      
			ALTER  TABLE RptBillTemplateFinal ADD [SalesInvoice NetAmount Actual] Numeric(18,2)      
		END    
		  
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product Weight')      
		BEGIN      
			SET @SSQL1='UPDATE Rpt SET Rpt.[Product Weight]=P.PrdWgt*(CASE P.PrdUnitId WHEN 2 THEN Rpt.[Base Qty]/1000 ELSE Rpt.[Base Qty] END)      
			FROM Product P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code] AND P.PrdUnitId IN (2,3)'      
			EXEC (@SSQL1) 
		END      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product UPC')      
		BEGIN      
			SET @SSQL1='UPDATE Rpt SET Rpt.[Product UPC]=Rpt.[Base Qty]/P.ConversionFactor       
			FROM       
			(      
			SELECT P.PrdId,P.PrdCCode,MAX(U.ConversionFactor)AS ConversionFactor FROM Product P,UOMGroup U      
			WHERE P.UOMGroupId=U.UOMGroupId      
			GROUP BY P.PrdId,P.PrdCCode      
			) P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code]'      
			EXEC (@SSQL1)      
		END      
	 --->Till Here      
	 --Check for Report Data      
	 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId      
	 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
	 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptBillTemplateFinal      
	 -- Till Here      
	 DELETE FROM RptBillTemplate_Tax WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Other WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Replacement WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_CrDbAdjustment WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_MarketReturn WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_SampleIssue WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Scheme WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_PrdUOMDetails WHERE UsrId = @Pi_UsrId      
	 ---------------------------------TAX (SubReport)      
	-- SELECT @Sub_Val = TaxDt  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	-- If @Sub_Val = 1      
	-- BEGIN      
	  DELETE FROM RptBillTemplate_Tax WHERE UsrId = @Pi_UsrId          
	  INSERT INTO RptBillTemplate_Tax(SalId,SalInvNo,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
	  SELECT SI.SalId,S.SalInvNo,0,SI.TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmount),SUM(TaxAmount),@Pi_UsrId      
	  FROM SalesInvoiceProductTax SI , TaxConfiguration T,SalesInvoice S,RptBillToPrint B      
	  WHERE SI.TaxId = T.TaxId and SI.SalId = S.SalId and S.SalInvNo = B.[Bill Number] and B.UsrId = @Pi_UsrId      
	  GROUP BY SI.SalId,S.SalInvNo,SI.TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmount) > 0 --Muthuvel      
	-- End      
	 ------------------------------ Other      
	 --SELECT @Sub_Val = OtherCharges FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_Other WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_Other(SalId,SalInvNo,AccDescId,Description,Effect,Amount,UsrId)      
	  SELECT SI.SalId,S.SalInvNo,      
	  SI.AccDescId,P.Description,Case P.Effect When 0 Then 'Add' else 'Reduce' End Effect,      
	  Adjamt Amount,@Pi_UsrId      
	  FROM SalInvOtherAdj SI,PurSalAccConfig P,SalesInvoice S,RptBillToPrint B      
	  WHERE P.TransactionId = 2      
	  and SI.AccDescId = P.AccDescId      
	  and SI.SalId = S.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	 --End      
	 ---------------------------------------Replacement      
	 --SELECT @Sub_Val = Replacement FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_Replacement WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_Replacement(SalId,SalInvNo,RepRefNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Rate,Tax,Amount,UsrId)      
	  SELECT H.SalId,SI.SalInvNo,H.RepRefNo,D.PrdId,P.PrdName,D.PrdBatId,PB.PrdBatCode,RepQty,SelRte,Tax,RepAmount,@Pi_UsrId      
	  FROM ReplacementHd H, ReplacementOut D, Product P, ProductBatch PB,SalesInvoice SI,RptBillToPrint B      
	  WHERE H.SalId <> 0      
	  and H.RepRefNo = D.RepRefNo      
	  and D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = SI.SalId      
	  and SI.SalInvNo = B.[Bill Number]      
	 --End      
	 ----------------------------------Credit Debit Adjus      
	 --SELECT @Sub_Val = CrDbAdj  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_CrDbAdjustment WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_CrDbAdjustment(SalId,SalInvNo,NoteNumber,Amount,UsrId)      
	  SELECT A.SalId,S.SalInvNo,CrNoteNumber,A.CrAdjAmount,@Pi_UsrId      
	  FROM SalInvCrNoteAdj A,SalesInvoice S,RptBillToPrint B      
	  WHERE A.SalId = s.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	  UNION ALL      
	  SELECT A.SalId,S.SalInvNo,DbNoteNumber,A.DbAdjAmount,@Pi_UsrId      
	  FROM SalInvDbNoteAdj A,SalesInvoice S,RptBillToPrint B      
	  WHERE A.SalId = s.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	 --End      
	 ---------------------------------------Market Return      
	-- SELECT @Sub_Val = MarketRet FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	-- If @Sub_Val = 1      
	-- BEGIN      
	  DELETE FROM RptBillTemplate_MarketReturn WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_MarketReturn(Type,SalId,SalInvNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Amount,UsrId)      
	  SELECT 'Market Return' Type ,H.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
	  D.PrdBatId,PB.PrdBatCode,BaseQty,PrdNetAmt,@Pi_UsrId      
	  FROM ReturnHeader H,ReturnProduct D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B      
	  WHERE returntype = 1      
	  and H.ReturnID = D.ReturnID      
	  and D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = S.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	  UNION ALL      
	  SELECT 'Market Return Free Product' Type,D.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
	  D.PrdBatId,PB.PrdBatCode,D.BaseQty,GrossAmount,@Pi_UsrId      
	  FROM ReturnPrdHdForScheme D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B,ReturnHeader H,ReturnProduct T      
	  WHERE returntype = 1 AND      
	  D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = T.SalId      
	  and H.ReturnID = T.ReturnID      
	  and S.SalInvNo = B.[Bill Number]      
	-- End      
	 ------------------------------ SampleIssue      
	SELECT @Sub_Val = SampleIssue FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	If @Sub_Val = 1      
	BEGIN      
		INSERT INTO RptBillTemplate_SampleIssue(SalId,SalInvNo,SchId,SchCode,SchName,PrdId,PrdCCode,CmpId,CmpCode,      
		CmpName,PrdDCode,PrdShrtName,PrdBatId,PrdBatCode,UomId,UomCode,Qty,TobeReturned,DueDate,UsrId)      
		SELECT A.SalId,C.SalInvNo,D.SchId,D.SchCode,D.SchDsc,B.PrdId,      
		E.PrdCCode,E.CmpId,F.CmpCode,F.CmpName,E.PrdDCode,E.PrdShrtName,B.PrdBatId,G.PrdBatCode,      
		B.IssueUomID,H.UomCode,B.IssueQty,CASE B.TobeReturned WHEN 0 THEN 'No' ELSE 'Yes' END AS TobeReturned,      
		B.DueDate,@Pi_UsrId      
		FROM SampleIssueHd A WITH (NOLOCK)      
		INNER JOIN SampleIssueDt B WITH(NOLOCK)ON A.IssueId=B.IssueID      
		INNER JOIN SalesInvoice C WITH(NOLOCK)ON A.SalId=C.SalId      
		INNER JOIN SampleSchemeMaster D WITH(NOLOCK)ON B.SchId=D.SchId      
		INNER JOIN Product E WITH (NOLOCK) ON B.PrdID=E.PrdId      
		INNER JOIN Company F WITH (NOLOCK) ON E.CmpId=F.CmpId      
		INNER JOIN ProductBatch G WITH (NOLOCK) ON E.PrdID=G.PrdID AND B.PrdBatId=G.PrdBatId      
		INNER JOIN UOMMaster H WITH (NOLOCK) ON B.IssueUomID=H.UomID      
		INNER JOIN RptBillToPrint I WITH (NOLOCK) ON C.SalInvNo=I.[Bill Number]      
	End      
	 --->Added By Nanda on 10/03/2010      
	 ------------------------------ Scheme      
		SELECT @Sub_Val = [Scheme] FROM BillTemplateHD WHERE TempName=SUBSTRING(@Pi_BTTblName,18,LEN(@Pi_BTTblName))      
		If @Sub_Val = 1      
		BEGIN      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISL.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
			0,'',0,0,SUM(SISL.DiscountPerAmount+SISL.FlatAmount),0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeLineWise SISL,SchemeMaster SM,RptBillToPrint RBT      
			WHERE SISL.SchId=SM.SchId AND SI.SalId=SISL.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.SalId,SI.SalInvNo,SISL.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
			HAVING SUM(SISL.DiscountPerAmount+SISL.FlatAmount)>0      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.FreePrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.FreePrdBatId,PB.PrdBatCode,SISFP.FreeQty,PBD.PrdBatDetailValue,SISFP.FreeQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
			ProductBatchDetails PBD,BatchCreation BC      
			WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.FreePrdId=P.PrdId AND SISFP.FreePrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
			PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.GiftPrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.GiftPrdBatId,PB.PrdBatCode,SISFP.GiftQty,PBD.PrdBatDetailValue,SISFP.GiftQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
			ProductBatchDetails PBD,BatchCreation BC      
			WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.GiftPrdId=P.PrdId AND SISFP.GiftPrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
			PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SIWD.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
			0,'',0,0,SUM(SIWD.AdjAmt),0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceWindowDisplay SIWD,SchemeMaster SM,RptBillToPrint RBT      
			WHERE SIWD.SchId=SM.SchId AND SI.SalId=SIWD.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.SalId,SI.SalInvNo,SIWD.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
			UPDATE RPT SET SalInvSchemeValue=A.SalInvSchemeValue      
			FROM RptBillTemplate_Scheme RPT,(SELECT SalId,SUM(SchemeValueInAmt) AS SalInvSchemeValue FROM RptBillTemplate_Scheme GROUP BY SalId)A      
			WHERE A.SAlId=RPT.SalId      
			--->Added By Jay on 09/12/2010      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.PrdBatId,PB.PrdBatCode,0,PBD.PrdBatDetailValue,0,SUM(Points),0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtPoints SISFP,SchemeMaster SM,      
			RptBillToPrint RBT,Product P,ProductBatch PB,ProductBatchDetails PBD,BatchCreation BC      
			WHERE SI.SalId=SISFP.SalId AND SISFP.SchId=SM.SchId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.PrdId=P.PrdId AND SISFP.PrdBatId=PB.PrdBatId AND RBT.UsrId=@Pi_UsrId      
			AND PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1 AND LEN(SISFP.ReDimRefId)=0        
			GROUP BY SI.SalId,SI.SalInvNo,SISFP.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,      
			P.PrdName,SISFP.PrdBatId,PB.PrdBatCode,PBD.PrdBatDetailValue      
			--->Till Here      
			--->Added By Nanda on 22/12/2010       
			UPDATE R SET SchemeCumulativePoints=A.CumulativePoints      
			FROM RptBillTemplate_Scheme R,SalesInvoice SI,      
			(SELECT SI.RtrId,SISP.SchId,SUM(SISP.Points-SISP.ReturnPoints) AS CumulativePoints      
			FROM SalesInvoiceSchemeDtPoints SISP      
			INNER JOIN SalesInvoice SI ON SI.SalId=SISP.SalId AND SI.DlvSts<>3      
			--INNER JOIN RptBillToPrint R ON R.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.RtrId,SISP.SchId) A      
			WHERE R.SalId=SI.SalId AND A.RtrId=SI.RtrId      
			--->Till Here        
		End      
	 --->Till Here       
	 --->Added By Nanda on 14/03/2011      
	 ------------------------------ Prd UOM Details      
	 --INSERT INTO RptBillTemplate_PrdUOMDetails(SalId,SalInvNo,TotPrdVolume,TotPrdKG,TotPrdLtrs,TotPrdUnits,      
	 --TotPrdDrums,TotPrdCartons,TotPrdBuckets,TotPrdPieces,TotPrdBags,UsrId)       
	 --SELECT SalId,SalInvNo,SUM(TotPrdVolume) AS TotPrdVolume,SUM(TotPrdKG) AS TotPrdKG,SUM(TotPrdLtrs) AS TotPrdLtrs,SUM(TotPrdUnits) AS TotPrdUnits,      
	 --SUM(TotPrdDrums) AS TotPrdDrums,SUM(TotPrdCartons) AS TotPrdCartons,SUM(TotPrdBuckets) AS TotPrdBuckets,SUM(TotPrdPieces) AS TotPrdPieces,SUM(TotPrdBags) AS TotPrdBags,@Pi_UsrId      
	 --FROM      
	 --(      
	 -- SELECT DISTINCT SI.SalId,SI.SalInvNo,SIP.PrdId,SIP.BaseQty*dbo.Fn_ReturnProductVolumeInLtrs(SIP.PrdId) AS TotPrdVolume,      
	 -- SIP.BaseQty*P.PrdUpSKU * (CASE P.PrdUnitId WHEN 2 THEN .001 WHEN 3 THEN 1 ELSE 0 END) AS TotPrdKG,      
	 -- SIP.BaseQty * P.PrdWgt * (CASE P.PrdUnitId WHEN 4 THEN .001 WHEN 5 THEN 1 ELSE 0 END) AS TotPrdLtrs,      
	 -- SIP.BaseQty*(CASE P.PrdUnitId WHEN 1 THEN 0 ELSE 0 END) AS TotPrdUnits,      
	 -- (CASE ISNULL(UMP1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMP2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP2.UOM2Qty,0) END) AS TotPrdPieces,      
	 -- (CASE ISNULL(UMBU1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMBU2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU2.UOM2Qty,0) END) AS TotPrdBuckets,      
	 -- (CASE ISNULL(UMBA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMBA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA2.UOM2Qty,0) END) AS TotPrdBags,      
	 -- (CASE ISNULL(UMDR1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMDR2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR2.UOM2Qty,0) END) AS TotPrdDrums,      
	 -- (CASE ISNULL(UMCA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMCA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA2.UOM2Qty,0) END)+       
	 -- CEILING((CASE ISNULL(UMCN1.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN1.UOM1Qty,0) AS NUMERIC(38,6))/CAST(UGC1.ConvFact AS NUMERIC(38,6)) END))+      
	 -- CEILING((CASE ISNULL(UMCN2.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN2.UOM2Qty,0) AS NUMERIC(38,6))/CAST(UGC2.ConvFact AS NUMERIC(38,6)) END)) AS TotPrdCartons      
	 -- FROM SalesInvoice SI INNER JOIN SalesInvoiceProduct SIP ON SI.SalId=SIP.SalId      
	 -- INNER JOIN RptBillToPrint Rpt ON SI.SalInvNo = Rpt.[Bill Number] AND Rpt.UsrId=@Pi_UsrId      
	 -- INNER JOIN Product P ON SIP.PrdID=P.PrdID      
	 -- INNER JOIN ProductBatch PB ON SIP.PrdBatID=PB.PrdBatID AND P.PrdID=PB.PrdId      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP1 ON SI.SalId=SIPP1.SalId AND SIP.PrdID=SIPP1.PrdID AND SIP.PrdBatID=SIPP1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP2 ON SI.SalId=SIPP2.SalId AND SIP.PrdID=SIPP2.PrdID AND SIP.PrdBatID=SIPP2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU1 ON SI.SalId=SIPBU1.SalId AND SIP.PrdID=SIPBU1.PrdID AND SIP.PrdBatID=SIPBU1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU2 ON SI.SalId=SIPBU2.SalId AND SIP.PrdID=SIPBU2.PrdID AND SIP.PrdBatID=SIPBU2.PrdBatID        
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA1 ON SI.SalId=SIPBA1.SalId AND SIP.PrdID=SIPBA1.PrdID AND SIP.PrdBatID=SIPBA1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA2 ON SI.SalId=SIPBA2.SalId AND SIP.PrdID=SIPBA2.PrdID AND SIP.PrdBatID=SIPBA2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR1 ON SI.SalId=SIPDR1.SalId AND SIP.PrdID=SIPDR1.PrdID AND SIP.PrdBatID=SIPDR1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR2 ON SI.SalId=SIPDR2.SalId AND SIP.PrdID=SIPDR2.PrdID AND SIP.PrdBatID=SIPDR2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA1 ON SI.SalId=SIPCA1.SalId AND SIP.PrdID=SIPCA1.PrdID AND SIP.PrdBatID=SIPCA1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA2 ON SI.SalId=SIPCA2.SalId AND SIP.PrdID=SIPCA2.PrdID AND SIP.PrdBatID=SIPCA2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN1 ON SI.SalId=SIPCN1.SalId AND SIP.PrdID=SIPCN1.PrdID AND SIP.PrdBatID=SIPCN1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN2 ON SI.SalId=SIPCN2.SalId AND SIP.PrdID=SIPCN2.PrdID AND SIP.PrdBatID=SIPCN2.PrdBatID      
	 -- LEFT OUTER JOIN UOMMaster UMP1 ON UMP1.UOMId=SIPP1.UOM1Id AND UMP1.UOMDescription='PIECES'      
	 -- LEFT OUTER JOIN UOMMaster UMP2 ON UMP1.UOMId=SIPP2.UOM2Id AND UMP2.UOMDescription='PIECES'      
	 -- LEFT OUTER JOIN UOMMaster UMBU1 ON UMBU1.UOMId=SIPBU1.UOM1Id AND UMBU1.UOMDescription='BUCKETS'       
	 -- LEFT OUTER JOIN UOMMaster UMBU2 ON UMBU1.UOMId=SIPBU2.UOM2Id AND UMBU2.UOMDescription='BUCKETS'      
	 -- LEFT OUTER JOIN UOMMaster UMBA1 ON UMBA1.UOMId=SIPBA1.UOM1Id AND UMBA1.UOMDescription='BAGS'       
	 -- LEFT OUTER JOIN UOMMaster UMBA2 ON UMBA1.UOMId=SIPBA2.UOM2Id AND UMBA2.UOMDescription='BAGS'      
	 -- LEFT OUTER JOIN UOMMaster UMDR1 ON UMDR1.UOMId=SIPDR1.UOM1Id AND UMDR1.UOMDescription='DRUMS'       
	 -- LEFT OUTER JOIN UOMMaster UMDR2 ON UMDR1.UOMId=SIPDR2.UOM2Id AND UMDR2.UOMDescription='DRUMS'      
	 -- LEFT OUTER JOIN UOMMaster UMCA1 ON UMCA1.UOMId=SIPCA1.UOM1Id AND UMCA1.UOMDescription='CARTONS'       
	 -- LEFT OUTER JOIN UOMMaster UMCA2 ON UMCA1.UOMId=SIPCA2.UOM2Id AND UMCA2.UOMDescription='CARTONS'      
	 -- LEFT OUTER JOIN UOMMaster UMCN1 ON UMCN1.UOMId=SIPCN1.UOM1Id AND UMCN1.UOMDescription='CANS'       
	 -- LEFT OUTER JOIN UOMMaster UMCN2 ON UMCN1.UOMId=SIPCN2.UOM2Id AND UMCN2.UOMDescription='CANS'      
	 -- LEFT OUTER JOIN (  
	 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
	 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
	 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
	 -- GROUP BY P.PrdID) UGC1 ON SIPCN1.PrdId=UGC1.PrdID      
	 -- LEFT OUTER JOIN (      
	 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
	 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
	 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
	 -- GROUP BY P.PrdID) UGC2 ON SIPCN2.PrdId=UGC2.PrdID      
	 --) A      
	 --GROUP BY SalId,SalInvNo      
	 --->Till Here      
	 --Added By Sathishkumar Veeramani 2012/12/13      
		IF NOT EXISTS (SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Payment Mode] NVARCHAR(20)      
		END      
		IF EXISTS(SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')          
		BEGIN          
			SET @SSQL1='UPDATE A SET A.[Payment Mode] = Z.[Payment Mode] FROM RptBillTemplateFinal A INNER JOIN       
			(SELECT SalId,(CASE RtrPayMode WHEN 1 THEN ''Cash'' ELSE ''Cheque'' END) AS [Payment Mode] FROM SalesInvoice WITH (NOLOCK)) Z ON A.Salid = Z.SalId       
			AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END       
	 --Till Here      
	 --->Added By Nanda on 23/03/2010-For Grouping the details based on product for nondrug products      
		 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeBillPrinting01' AND ModuleName='Botree Bill Printing' AND Status=1)      
		 BEGIN      
		  IF EXISTS (SELECT * FROM dbo.SysObjects WHERE Id = Object_Id(N'[RptBillTemplateFinal_Group]') AND OBJECTPROPERTY(Id, N'IsUserTable') = 1)      
		  DROP TABLE [RptBillTemplateFinal_Group]   
		     
		  SELECT * INTO RptBillTemplateFinal_Group FROM RptBillTemplateFinal  WHERE [Visibility]=1
		  
		  SELECT * FROM RptBillTemplateFinal_Group     
		  
		  DELETE FROM RptBillTemplateFinal    
		  INSERT INTO RptBillTemplateFinal      
		  (      
		   [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
		   [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
		   [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		   [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
		   [CD Disc Header Amount],[CD Disc LineUnit Amount],      
		   [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		   [CD Disc UOM Amount],[CD Disc UOM Percentage],      
		   [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
		   [DB Disc Header Amount],[DB Disc LineUnit Amount],      
		   [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
		   [DB Disc UOM Amount],[DB Disc UOM Percentage],      
		   [Line Base Qty Amount],[Line Base Qty Percentage],      
		   [Line Effect Amount],[Line Unit Amount],      
		   [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
		   [Manual Free Qty],      
		   [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
		   [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
		   [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		   [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
		   [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
		   [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
		   [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		   [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
		   [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		   [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
		   [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
		   [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
		   [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
		   [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
		   [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
		   [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		   [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
		   [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		   [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		   [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		   [Route Code],[Route Name],      
		   [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		   [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		   [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		   [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		   [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		   [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		   [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		   [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		   [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		   [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		   [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		   [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		   [LST Number],[Order Date],[Order Number],      
		   [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		   [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  )        
		  SELECT      
		  [SalId],      
		  [Sales Invoice Number],      
		  [Product Code],[Product Name],[Product Short Name],MIN([Product SL No]) AS [Product SL No],[Product Type],[Scheme Points],      
		  SUM([Base Qty]) AS [Base Qty],      
		  '' AS [Batch Code],MAX([Batch Expiry Date]) AS [Batch Expiry Date],MIN([Batch Manufacturing Date]) AS [Batch Manufacturing Date],      
		  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  SUM([CD Disc Base Qty Amount]) AS [CD Disc Base Qty Amount],SUM([CD Disc Effect Amount]) AS [CD Disc Effect Amount],      
		  SUM(DISTINCT [CD Disc Header Amount]) AS [CD Disc Header Amount],SUM([CD Disc LineUnit Amount]) AS [CD Disc LineUnit Amount],      
		  --SUM([CD Disc Qty Percentage]) AS [CD Disc Qty Percentage],SUM([CD Disc Unit Percentage]) AS [CD Disc Unit Percentage],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  SUM([CD Disc UOM Amount]),SUM([CD Disc UOM Percentage]) AS [CD Disc UOM Percentage],      
		  SUM([DB Disc Base Qty Amount]) AS [DB Disc Base Qty Amount],SUM([DB Disc Effect Amount]) AS [DB Disc Effect Amount],      
		  SUM(DISTINCT [DB Disc Header Amount]) AS [DB Disc Header Amount],SUM([DB Disc LineUnit Amount]) AS [DB Disc LineUnit Amount],      
		  --SUM([DB Disc Qty Percentage]) AS [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]) AS [DB Disc Unit Percentage],      
		  [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]),      
		  SUM([DB Disc UOM Amount]) AS [DB Disc UOM Amount],SUM([DB Disc UOM Percentage]) AS [DB Disc UOM Percentage],      
		  SUM([Line Base Qty Amount]) AS [Line Base Qty Amount],SUM([Line Base Qty Percentage]) AS [Line Base Qty Percentage],      
		  SUM([Line Effect Amount]) AS [Line Effect Amount],      
		  --SUM([Line Unit Amount]) AS [Line Unit Amount],      
		  [Line Unit Amount],      
		  SUM([Line Unit Percentage]) AS [Line Unit Percentage],SUM([Line UOM1 Amount]) AS [Line UOM1 Amount],SUM([Line UOM1 Percentage]) AS [Line UOM1 Percentage],      
		  SUM([Manual Free Qty]),      
		  SUM([Sch Disc Base Qty Amount]) AS [Sch Disc Base Qty Amount],SUM([Sch Disc Effect Amount]) AS [Sch Disc Effect Amount],      
		  SUM(DISTINCT [Sch Disc Header Amount]) AS [Sch Disc Header Amount],SUM([Sch Disc LineUnit Amount]) AS [Sch Disc LineUnit Amount],      
		  --SUM([Sch Disc Qty Percentage]) AS [Sch Disc Qty Percentage],SUM([Sch Disc Unit Percentage]) AS [Sch Disc Unit Percentage],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  SUM([Sch Disc UOM Amount]) AS [Sch Disc UOM Amount],SUM([Sch Disc UOM Percentage]) AS [Sch Disc UOM Percentage],      
		  SUM([Spl. Disc Base Qty Amount]) AS [Spl. Disc Base Qty Amount],SUM([Spl. Disc Effect Amount]) AS [Spl. Disc Effect Amount],      
		  SUM(DISTINCT [Spl. Disc Header Amount]) AS [Spl. Disc Header Amount],SUM([Spl. Disc LineUnit Amount]) AS [Spl. Disc LineUnit Amount],      
		  --SUM([Spl. Disc Qty Percentage]) AS [Spl. Disc Qty Percentage],SUM([Spl. Disc Unit Percentage]) AS [Spl. Disc Unit Percentage],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		  SUM([Spl. Disc UOM Amount]) AS [Spl. Disc UOM Amount],SUM([Spl. Disc UOM Percentage]) AS [Spl. Disc UOM Percentage],      
		  --SUM([Tax 1]) AS [Tax 1],SUM([Tax 2]) AS [Tax 2],SUM([Tax 3]) AS [Tax 3],SUM([Tax 4]) AS [Tax 4],      
		  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  SUM([Tax Amount1]) AS [Tax Amount1],SUM([Tax Amount2]) AS [Tax Amount2],SUM([Tax Amount3]) AS [Tax Amount3],SUM([Tax Amount4]) AS [Tax Amount4],      
		  SUM([Tax Amt Base Qty Amount]) AS [Tax Amt Base Qty Amount],SUM([Tax Amt Effect Amount]) AS [Tax Amt Effect Amount],      
		  SUM(DISTINCT [Tax Amt Header Amount]) AS [Tax Amt Header Amount],SUM([Tax Amt LineUnit Amount]) AS [Tax Amt LineUnit Amount],      
		  SUM([Tax Amt Qty Percentage]) AS [Tax Amt Qty Percentage],SUM([Tax Amt Unit Percentage]) AS [Tax Amt Unit Percentage],      
		  SUM([Tax Amt UOM Amount]) AS [Tax Amt UOM Amount],SUM([Tax Amt UOM Percentage]) AS [Tax Amt UOM Percentage],      
		  '' AS [Uom 1 Desc],SUM([Base Qty]) AS [Uom 1 Qty],'' AS [Uom 2 Desc],0 AS [Uom 2 Qty],[Vehicle Name],      
		  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  SUM([SalesInvoice Line Gross Amount]) AS [SalesInvoice Line Gross Amount],SUM([SalesInvoice Line Net Amount]) AS [SalesInvoice Line Net Amount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [Route Code],[Route Name],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],[Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  FROM RptBillTemplateFinal_Group,Product P      
		  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType<>5   AND  [Visibility]=1  
		  GROUP BY [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],      
		  [Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],      
		  [Product Code],[Product Name],[Product Short Name],[Product Type],      
		  [Remarks],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],      
		  [Route Code],[Route Name],      
		  [Sales Invoice Number],[SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [SalId],      
		  [Scheme Points],      
		  [Tax Type],[TIN Number],      
		  [Vehicle Name],[Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  [DB Disc Qty Percentage],--[DB Disc Unit Percentage],      
		  [Line Unit Amount],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],        
		  [UsrId],[Visibility],[AmtInWrd] ,
		  [Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd] ---------------- Group by columns Added by Lakshman M  on 09/01/2018    
		  UNION ALL      
		  SELECT [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
		  [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
		  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
		  [CD Disc Header Amount],[CD Disc LineUnit Amount],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  [CD Disc UOM Amount],[CD Disc UOM Percentage],      
		  [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
		  [DB Disc Header Amount],[DB Disc LineUnit Amount],      
		  [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
		  [DB Disc UOM Amount],[DB Disc UOM Percentage],      
		  [Line Base Qty Amount],[Line Base Qty Percentage],      
		  [Line Effect Amount],[Line Unit Amount],      
		  [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
		  [Manual Free Qty],      
		  [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
		  [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
		  [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
		  [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		  [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
		  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
		  [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
		  [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
		  [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
		  [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
		  [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
		  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [Route Code],[Route Name],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],[Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  FROM RptBillTemplateFinal_Group,Product P      
		  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType=5   AND  [Visibility]=1   
	 END       
	 --->Till Here      
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD InvDisc NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END 
		     
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD InvDiscPer NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END
		
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD SalesmanPhoneNo NVARCHAR(100)
		END 
		       
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD Grammage NUMERIC (38,2) DEFAULT 0 WITH VALUES       
		END  
		    
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')          
		BEGIN          
			SET @SSQL1='UPDATE A SET A.InvDisc=B.SalInvLvlDisc FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
			ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END
		       
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.InvDiscPer=B.SalInvLvlDiscPer FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
			ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.SalesmanPhoneNo=ISNULL(B.SMPhoneNumber,'''') FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesMan B (NOLOCK)       
			ON A.[SalesMan Code]=B.SMCode AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END 
		     
		--- Added by Rajesh ICRSTPAR3196      
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='bx')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.bx=bx+box FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))      
			EXEC (@SSQL1)          
		END   
		   
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='PBG')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.PB=PB+PBG FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END   
		   
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIN')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.Tn=TN+TIN FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
			EXEC (@SSQL1)          
		END  
		    
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIF')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.TIF=TIF+TBX FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
			EXEC (@SSQL1)          
		END   
		   
		--Till here      
		-------------------GST Changes(Mohanakrishna A.B) begins here      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Dist Food Lic No]=R.DrugLicNo2       
			FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Dist Drug Lic no]=R.DrugLicNo1       
			FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)       
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[GSTTIN]=B.GSTTinNo FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Pan Number]=R.[ColumnValue]       
			FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Retailer Type]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Retailer Type'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END     
		 
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[RelatedParty]=R.[ColumnValue] FROM RptBillTemplateFinal B   
			INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Related Party'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END    
		  
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[State Name]=C.StateName FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[State Code]=C.StateCode FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[StateTinNo]=C.TinFirst2Digit FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)       
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[HSNCode]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.prdid,R.prdccode,U.ColumnValue FROM UdcDetails u inner JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN product  R on R.prdid=U.MasterRecordId  WHERE US.MasterId=1   and ColumnName=''HSN Code'' ) R ON B.[Product Code]=R.[prdccode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[HSNDescription]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.prdid,R.prdccode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Product  R on R.prdid=U.MasterRecordId  WHERE US.MasterId=1   AND ColumnName=''HSN Description'' ) R ON B.[Product Code]=R.[prdccode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[DistributorGstTin]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  and ColumnName=''GSTIN'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
		BEGIN      
			SELECT StateCode,StateName,TinFirst2Digit,DistributorCode      
			INTO #DistState       
			FROM UDCHD A (NOLOCK)      
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId      
			INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId      
			AND B.UdcMasterId=C.UdcMasterId      
			INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId AND D.MasterId=B.MasterId      
			AND D.UdcMasterId=C.UdcMasterId AND D.UdcMasterId=B.UdcMasterId      
			INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue AND E.StateName=C.ColumnValue      
			INNER JOIN Distributor DB ON DB.DistributorId=C.MasterRecordId      
			WHERE MasterName='Distributor Info Master' AND ColumnName='State Name'      
			SET @SSQL1='UPDATE B SET B.[DistributorStateName]=R.StateName,DistributorStateCode=R.StateCode,       
			DistributorStateTinNo=R.TinFirst2Digit FROM RptBillTemplateFinal B INNER JOIN #DistState R ON B.[Distributor Code]=R.DistributorCode'       
			EXEC (@SSQL1)   
			   
			DROP TABLE #DistState      
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Distributor Type]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  AND ColumnName=''Distributor Type'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[AadharNo]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  AND ColumnName=''Aadhar No'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END      
	 -------------------GST Changes(Mohanakrishna) Ends here      
	  ---ILCRSTPAR8294
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSLineLevelTax')
		BEGIN
			ALTER TABLE RptBillTemplateFinal ADD TCSLineLevelTax Numeric(18,6)
		END
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSHeadLevelTax')
		BEGIN
			ALTER TABLE RptBillTemplateFinal ADD TCSHeadLevelTax Numeric(18,6)
		END
  		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSLineLevelTax')
		BEGIN
			SET @SSQL1='UPDATE A SET A.TCSLineLevelTax=B.PrdTCSTaxAmount 
				FROM RptBillTemplateFinal A INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.Salid=B.SalId and A.[Product SL No]=B.slno '
			EXEC (@SSQL1)	
		END	
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSHeadLevelTax')
		BEGIN
			SET @SSQL1='UPDATE A SET A.TCSHeadLevelTax=B.SalTCSTaxAmount 
				FROM RptBillTemplateFinal A INNER JOIN SALESINVOICE B (NOLOCK) ON A.Salid=B.SalId'
			EXEC (@SSQL1)	
		END	
		--ILCRSTPAR8294
	 
	 
	 
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')          
		BEGIN       
			--SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
			--    INNER JOIN (      
			--     SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,ISNULL(      
			--     CASE U.PRDUNITID WHEN 2 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0)/1000      
			--     WHEN 3 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0) END,0) AS Grammage      
			--     FROM RptBillTemplateFinal SP (NOLOCK)      
			--     INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
			--     INNER JOIN PRODUCTUNIT U (NOLOCK) ON P.PrdUnitId=U.PrdUnitId      
			--     WHERE SP.USRID=      
			--     GROUP BY P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,U.PRDUNITID,SP.[Sales Invoice Number]      
			--    ) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''
			SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
			INNER JOIN (      
			SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,P.PrdWgt Grammage      
			FROM RptBillTemplateFinal SP (NOLOCK)      
			INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
			WHERE SP.USRID='+CAST(@Pi_UsrId AS VARCHAR(10))+'      
			) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''               
			EXEC (@SSQL1)          
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='[SalesInvoice NetAmount Actual]')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[SalesInvoice NetAmount Actual]=B.OrgNetAmount       
			FROM RptBillTemplateFinal A INNER JOIN SalesInvoice B (NOLOCK) ON A.Salid=B.SalId'      
			EXEC (@SSQL1)       
		END
		IF EXISTS (SELECT A.SalId FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo)      
		BEGIN      
			TRUNCATE TABLE RptFinalBillTemplate_DC      
			INSERT INTO RptFinalBillTemplate_DC(SalId,InvNo,DCNo,DCDate)      
			SELECT A.SalId,B.SalInvNo,A.DCNo,DCDate FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B      
			ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo      
		END      
		ELSE      
		BEGIN      
			TRUNCATE TABLE RptFinalBillTemplate_DC      
		END
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='PrdtDefaultPricevalue')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD PrdtDefaultPricevalue NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END
		
		 --------------- Added by lakshman M Dated ON 11-04-2019 PMS ID: ILCRSTPAR4044 
	  UPDATE D SET D.PrdtDefaultPricevalue  = Round(cast(PBD.PrdBatDetailValue As Numeric(18,2)),2)
	  FROM SalesInvoice S (NOLOCK)        
	  INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
	  INNER JOIn Product P ON P.Prdid =SP.Prdid       
	  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId     
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1     
	  INNER JOIN rptbilltemplatefinal D ON D.Salid = S.SalId AND SP.SalId = D.Salid AND D.[Distributor Product Code] =P.Prdccode   
	  WHERE PBD.SLNo =3
		  ------------ Till here ------------
	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='Irn' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD Irn Varchar(100) NULL
	  END
	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedInvoice' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD SignedInvoice Varchar(8000) NULL
	  END
	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedQRCode' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD SignedQRCode VARBINARY(MAX) NULL
	  END
	 IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('Irn'))
	 BEGIN
	 
		SET @SSQL1='UPDATE A SET A.Irn=ISNULL(B.Irn,'''')
		FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
		AND A.[Sales Invoice Number] = B.Invoice_no	'      
			EXEC (@SSQL1) 
	 END
	  --IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('SignedInvoice'))
	  --BEGIN
			
			--SET @SSQL1='UPDATE A SET  A.SignedInvoice=B.SignedInvoice 
			--FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
			--AND A.[Sales Invoice Number] = B.Invoice_no	'      
			
			--EXEC (@SSQL1)
	  
				 
	  --END
	  IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('SignedQRCode'))
	  BEGIN
		
			SET @SSQL1='UPDATE A SET  A.SignedQRCode =ISNULL(B.QRCodeImage,NULL)
			FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
			AND A.[Sales Invoice Number] = B.Invoice_no	'      
			
			EXEC (@SSQL1)
						 
	  END
	  
	  IF EXISTS(SELECT * FROM ManualConfiguration(NOLOCK) WHERE ModuleId='E-Invoice-Sales-Print' AND Status=1)
      BEGIN
            DELETE A FROM RptBillTemplateFinal A(NOLOCK)
            INNER JOIN SalesInvoice SI ON SI.SalId=A.SalId WHERE ISNULL(Irn,'')='' and [Bill date]>'2020-12-31' AND SI.RtrType='R'

            DELETE A FROM RptBillTemplateFinal A(NOLOCK) 
            INNER JOIN SalesInvoice SI ON SI.SalId=A.SalId WHERE (SignedQRCode IS NULL or SignedQRCode='') 
            and [Bill date]>'2020-12-31' AND SI.RtrType='R'
      END

RETURN      
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' and NAME='Proc_RptSRNSALESRETURN')
DROP PROCEDURE Proc_RptSRNSALESRETURN
GO
--Exec Proc_RptSRNSALESRETURN 1,1
CREATE PROCEDURE  [dbo].[Proc_RptSRNSALESRETURN]
(
	@Pi_UsrId Int = 1,
	@Pi_Type INT 
) 
As SET NOCOUNT ON 
/****************************************************************************************************************
* DATE			NAME			USERSTORYID			CR/BZ				DESCRIPTION
*****************************************************************************************************************
* 23-05-2019    MOHANA S		CRCRSTPAR0052		CR					SUB REPORT FOR SALES RETURN TAX SPLIT UP
* 02-07-2019    Lakshman M      ILCRSTPAR4957       SR                  product line level tax percenatge split validation included.
* 09-03-2020    MOHANA S	    ILCRSTPAR8165		CR			        Added New columns For E-Invoice 
04-01-2021	  MOHANA S				CR	   CRCRSTPAR0111		   E- Invoice
*****************************************************************************************************************/
Begin  
 DECLARE @FromReturnId AS  VARCHAR(25)  
 DECLARE @ToReturnId   AS  VARCHAR(25) 
 DECLARE @Cnt AS INT 
 DECLARE @TempReturnId TABLE (ReturnId INT) 
 CREATE Table #RptSRNTemplate  
( 
	[Credit Note Reference No] nvarchar(50),
	[Distributor Code] nvarchar(20),
	[Distributor Name] nvarchar(50),
	[Distributor Address1] nvarchar(50),
	[Distributor Address2] nvarchar(50),
	[Distributor Address3] nvarchar(50),
	[PinCode] int,
	[PhoneNo] nvarchar(50),
	[Tax Type] tinyint,
	[TIN Number] nvarchar(50),
	[Deposit Amount] numeric(38,2),
	[CST Number] nvarchar(50),
	[LST Number] nvarchar(50),
	[Licence Number] nvarchar(50),
	[Drug Licence Number 1] nvarchar(50),
	[Drug1 Expiry Date] DateTime,
	[Drug Licence Number 2] nvarchar(50),
	[Drug2 Expiry Date] DateTime,
	[Pesticide Licence Number] nvarchar(50),
	[Pesticide Expiry Date] DateTime,
	[SalId] INT,
	[Invoice Number] nvarchar(50),
	[Invoice Date] DATETIME,
	[ReturnId] INT,
	[Sales Return Number] nvarchar(50),
	[Sales Return Date] DATETIME,
	[Sales Man] nvarchar(50),
	[Route] nvarchar(50),
	[Retailer Code] nvarchar(50),
	[Retailer Name] nvarchar(150),
	[Retailer Phone Number] nvarchar(50),
	[Retailer CST Number] nvarchar(50),
	[Retailer Drug Lic  Number] nvarchar(50),
	[Retailer Lic Number] nvarchar(50),
	[Retailer Tin Number] nvarchar(50),
	[Retailer Address] nvarchar(50),
	[Product Company Code] nvarchar(20),
	[Product Company Name] nvarchar(150),
	[Product Short Code] nvarchar(100),
	[Product Short Name] nvarchar(150),
	[Product Name] nvarchar(150),
	[Product Slno] INT,
	[Stock Type] nvarchar(100),
	[Return Quantity] NUMERIC(18,0),
	[Selling Rate] NUMERIC(18,6),
	[Gross Amount] NUMERIC(18,6),
	[Special Discount] NUMERIC(18,6),
	[Scheme Discount] NUMERIC(18,6),
	[Distributor Discount] NUMERIC(18,6),
	[Cash Discount] NUMERIC(18,6),
	[TaxName] NVARCHAR(50),
	[Tax Percentage] NUMERIC(18,6),
	[Tax Amount Line Level] NUMERIC(18,6),
	[Line level Net Amount] NUMERIC(18,6),
	[Reason] nvarchar(100),
	[Type] nvarchar(50),
	[Mode] nvarchar(50),
	[Total Gross Amount] NUMERIC(18,6),
	[Total Special Discount] NUMERIC(18,6),
	[Total Scheme Discount] NUMERIC(18,6),
	[Total Distributor Discount] NUMERIC(18,6),
	[Total Cash Discount] NUMERIC(18,6),
	[Total Tax Amount] NUMERIC(18,6),
	[Total Net Amount] NUMERIC(18,6),
	[Total Discount] NUMERIC(18,6),
	[RtrId] INT,
	[RMID] INT,
	[SMID] INT,
	[MRP] NUMERIC(18,6),
	[Credit Note/Replacement Reference No] nvarchar(50),
	UsrId int,Visibility tinyint ,
	Irn VARCHAR(100) NULL,
	SignedInvoice VARCHAR(8000) NULL,
	SignedQRCode VARBINARY(MAX) NULL
) 
	IF @Pi_Type=1 
	BEGIN   
		INSERT INTO @TempReturnId SELECT SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 32  AND UsrId=@Pi_UsrId
	END
	ELSE   
	BEGIN 
		SELECT @FromReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 14 AND UsrId=@Pi_UsrId
		SELECT @ToReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 15  AND UsrId=@Pi_UsrId
	END
	IF @Pi_Type=1 
	BEGIN 
		Insert into #RptSRNTemplate ([Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],
		[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],
		[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],
		[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
		[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
		[Product Short Name],[Product Name],[Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
		[Distributor Discount],[Cash Discount],[TaxName],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],
		[Total Special Discount],		[Total Scheme Discount],[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],
		[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility]) 
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,
		DistributorAdd2,	DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,
		CSTNo,	LSTNo,	LicNo,	DrugLicNo1,	Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,
		PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,	SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,
		ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,	RtrCstNo,	RtrDrugLicNo,	RtrLicNo,
		RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,	Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,
		UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,	PrdSchDisAmt,	PrdDBDisAmt,
		PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,	ReturnMode,	RtnGrossAmt,
		RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,	Retailer.RtrId,
		RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId 
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode 
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode AND CreditNoteRetailer.TransId = 30 
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId IN (SELECT ReturnId FROM @TempReturnId)  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,
		DISTRIBUTORADD1,	DISTRIBUTORADD2,	DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,
		CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,	DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,
		SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,	RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,
		RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,	RTRADD1,	CMPCODE,
		CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,	PRDEDITSELRTE,
		PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,	INVOICETYPE,
		RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,	RTNNETAMT,
		RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno 
	END  
	ELSE 
	BEGIN 
		Insert into #RptSRNTemplate ([Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],
		[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],
		[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],
		[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
		[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
		[Product Short Name],[Product Name],[Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
		[Distributor Discount],[Cash Discount],[TaxName],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],
		[Total Special Discount],		[Total Scheme Discount],[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],
		[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility])  
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,	DistributorAdd2,
		DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,	CSTNo,	LSTNo,	LicNo,	DrugLicNo1,
		Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,	PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,
		SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,	ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,
		RtrCstNo,	RtrDrugLicNo,	RtrLicNo,	RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,
		Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,	UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,
		PrdSchDisAmt,	PrdDBDisAmt,	PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,
		ReturnMode,	RtnGrossAmt,	RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,
		Retailer.RtrId,	RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility 
		FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode  AND CreditNoteRetailer.TransId=30
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId BETWEEN  @FromReturnId  AND  @ToReturnId  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,	DISTRIBUTORADD1,	DISTRIBUTORADD2,
		DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,	CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,
		DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,	SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,
		RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,	RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,
		RTRADD1,	CMPCODE,	CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,
		PRDEDITSELRTE,	PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,
		INVOICETYPE,	RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,
		RTNNETAMT,	RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno
	
	END
	--INSERT INTO RptSRNSALESRETURN 
	SELECT * INTO #SRNSALESRETURNTEMP FROM #RptSRNTemplate 
	DELETE FROM RptSRNSALESRETURN
	----- added by lakshman ILCRSTPAR4957
	SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue 
	INTO #RetailerGSTIN
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='GSTIN'
	
	INSERT INTO RptSRNSALESRETURN ([Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility])
	SELECT DISTINCT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility] 	FROM #SRNSALESRETURNTEMP
	
	UPDATE A SET [CGST Perc] = B.[TAX PERCENTAGE],[CGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CGST'
	UPDATE A SET [SGST Perc] = B.[TAX PERCENTAGE],[SGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'SGST'
	UPDATE A SET [IGST Perc] = B.[TAX PERCENTAGE],[IGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'IGST'
	UPDATE A SET [UTGST Perc] = B.[TAX PERCENTAGE],[UTGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'UTGST'
	UPDATE A SET [CESS Perc] = B.[TAX PERCENTAGE],[CESS TaxAmt] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CESS'
	--INSERT INTO RptSRNSALESRETURN 
	--([Credit Note Reference No],[Distributor Code],[Distributor Name], [Distributor Address1], [Distributor Address2], [Distributor Address3], 
	--[PinCode], [PhoneNo],[Tax Type], [TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1], [Drug1 Expiry Date],
	--[Drug Licence Number 2], [Drug2 Expiry Date], [Pesticide Licence Number], [Pesticide Expiry Date], [SalId],[Invoice Number], [Invoice Date], [ReturnId], 
	--[Sales Return Number], [Sales Return Date], [Sales Man], [Route], [Retailer Code], [Retailer Name], [Retailer Phone Number], [Retailer CST Number], 
	--[Retailer Drug Lic  Number],[Retailer Lic Number], [Retailer Tin Number], [Retailer Address], [Product Company Code], [Product Company Name], [Product Short Code], 
	--[Product Short Name], [Product Name],[Product Slno], [Stock Type], [Return Quantity],[Selling Rate], [Gross Amount], [Special Discount], [Scheme Discount], 
	--[Distributor Discount], [Cash Discount],[Line level Net Amount], [Reason], [Type], [Mode], [Total Gross Amount], [Total Special Discount], [Total Scheme Discount], 
	--[Total Distributor Discount], [Total Cash Discount], [Tax Amount Line Level],[Total Tax Amount], [Total Net Amount], [Total Discount], [RtrId],
	--[RMID], [SMID], [MRP], [Credit Note/Replacement Reference No], [UsrId], [Visibility], [CGST Perc], [SGST Perc], [IGST Perc],[UTGST Perc],[CESS Perc])
	
	--SELECT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount] ,ISNULL(Sum([Tax Amount Line Level]),0) AS [Tax Amount Line Level],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0) 
	--from #SRNSALESRETURNTEMP
	--	PIVOT
	--		(
	--			SUM([Tax Percentage])
	--			FOR [TaxName] IN ([CGST],[SGST],[IGST],[UTGST],[CESS])
	--		) AS P
	--GROUP BY [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0)
	--order by Salid,[Product Slno],[Product Short Code] Asc
	
	UPDATE A SET RtrGSTTinNo = B.ColumnValue FROM RptSRNSALESRETURN A inner join #RetailerGSTIN B ON A.Rtrid =B.Rtrid 
	
	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='Irn' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD Irn Varchar(100) NULL
	END
	 
	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedInvoice' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD SignedInvoice Varchar(8000) NULL
	END
	 
	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedQRCode' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD SignedQRCode VARBINARY(MAX) NULL
	END
	IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('Irn'))
	BEGIN
		UPDATE A SET A.Irn=ISNULL(B.Irn,'')
		FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
		AND A.[Sales Return Number]  = B.Invoice_no			 
	END
	
	--IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('SignedInvoice'))
	--BEGIN
	--	UPDATE A SET A.SignedInvoice=ISNULL(B.SignedInvoice,'')
	--	FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
	--	AND A.[Sales Return Number]  = B.Invoice_no			 
	--END
	IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('SignedQRCode'))
	BEGIN
		UPDATE A SET A.SignedQRCode =ISNULL(B.QRCodeImage,NULL)
		FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
		AND A.[Sales Return Number]  = B.Invoice_no			 
	END

	IF EXISTS(SELECT * FROM ManualConfiguration(NOLOCK) WHERE ModuleId='E-Invoice-Return-Print' AND Status=1)
	BEGIN
		DELETE A FROM RptSRNSALESRETURN A(NOLOCK)
		INNER JOIN RETURNHEADER R ON R.ReturnId=A.ReturnId 
		WHERE ISNULL(Irn,'')='' AND [Sales Return Date]>'2020-12-31' and R.RtrType='R'
		DELETE A FROM RptSRNSALESRETURN A(NOLOCK)
		INNER JOIN RETURNHEADER R ON R.ReturnId=A.ReturnId  
		WHERE (SignedQRCode IS NULL or SignedQRCode='') AND [Sales Return Date]>'2020-12-31' and R.RtrType='R'
	END   

	------------------ Till here -----------------
	--Added by Mohana  CRCRSTPAR0052
	DELETE FROM RptSRNTaxFinalTemplate WHERE UsrId = @Pi_UsrId 
	INSERT INTO RptSRNTaxFinalTemplate(ReturnId,ReturnCode,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
	SELECT Returnid,REturnCode,0 Prdslno,TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmt) TaxableAmt,SUM(TaxAmt) TaxAmt,@Pi_UsrId      
	FROM 
	(
	SELECT DISTINCT SI.Returnid,S.REturnCode,Prdslno,SI.TaxId,TaxCode,TaxName,TaxPerc,TaxableAmt,TaxAmt     
	FROM ReturnproductTax SI , TaxConfiguration T,REturnHeader S,RptSRNSALESRETURN B      
	WHERE SI.TaxId = T.TaxId and SI.ReturnId = S.ReturnId and S.returncode = B.[Sales Return Number]  and B.UsrId = @Pi_UsrId      
	)A GROUP BY Returnid,REturnCode,TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmt) > 0  
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS Where Name = 'Proc_ImportEInvoice_IRN' and Xtype = 'P')
Drop Procedure Proc_ImportEInvoice_IRN
GO
/*
Begin Transaction
Delete from EInvoice_Acknowledgment
EXEC Proc_ImportEInvoice_IRN 'Sales','Microsoft.Jet.OLEDB.4.0','Excel 8.0',
'E:\Kishore\489\E-Invoice-Excel-Csv-Import\ExcelReports\Invoice_Ack_From_NIC_Portal_UploadedInvoiceDetails.xls','',0,''
SELECT * FROM EInvoice_Acknowledgment
Rollback Transaction
*/
Create PROCEDURE Proc_ImportEInvoice_IRN
(
	@Pi_TransType AS VARCHAR(50),
	@Pi_Provider as NVARCHAR(200),
	@Pi_Excon as NVARCHAR(100),
	@Pi_Path as  VARCHAR(2000),
	@Pi_Sheets as Nvarchar(100),
	@Pi_Error	Int OUTPUT,
	@Pi_Errmsg   Nvarchar(100) OUTPUT
)
AS
SET NOCOUNT ON
BEGIN
	SET @Pi_Error=0
	SET @Pi_Errmsg = ''
	SET @Pi_Sheets = 'UploadedInvoiceDetails$'

CREATE TABLE #EInvoice_Acknowledgment_IRN
(

	IRN				Varchar(100),
	ACKNO			Varchar(200),
	ACKDate			Datetime,
	DocNo			Varchar(100),
	DocTyp			Varchar(100),
	DocDate			Varchar(20),
	Status			INT,
	SignedQRCode	Varchar(MAX)
)
	
  BEGIN TRY
	DECLARE @SSQL AS NVARCHAR(MAX)
	
	TRUNCATE TABLE EIErrorlog
		
	--SET @SSQL = 'INSERT INTO #EInvoice_Acknowledgment SELECT *
	--FROM OPENROWSET('''+ @Pi_Provider + ''','''+ @Pi_Excon + ''+';Database='+ @Pi_Path + ''''+',' +@Pi_Sheets+')
	--WHERE Rtrim(Ltrim(Irn)) IS NOT NULL AND Rtrim(Ltrim(Irn)) <> ''''
	--AND Rtrim(Ltrim(SignedQRCode)) IS NOT NULL AND Rtrim(Ltrim(SignedQRCode)) <> '''''

	SET @SSQL = 'INSERT INTO #EInvoice_Acknowledgment_IRN 
	SELECT IRN,[ACK NO],[ACK Date],[Doc No],[Doc Typ],[Doc Date],Status,[Signed QR Code] 
	FROM OPENROWSET('''+ @Pi_Provider + ''','''+ @Pi_Excon + ''+';Database='+ @Pi_Path + ''''+',' +@Pi_Sheets+')
	WHERE Rtrim(Ltrim(Irn)) IS NOT NULL AND Rtrim(Ltrim(Irn)) <> '''''
	--PRINT @SSQL
	EXEC (@SSQL)


	Insert Into EIErrorlog(Code,NAME,Invoice_no,TrnasType,ErrDesc)	
	SELECT ''Code,'' NAME,DocNo,DocTyp,'IRNno/QRCode Is Blank' FROM #EInvoice_Acknowledgment_IRN
	WHERE Rtrim(Ltrim(ISNULL(Irn,''))) = '' OR  Rtrim(Ltrim(ISNULL(SignedQRCode,''))) = ''	
	
	Delete FROM #EInvoice_Acknowledgment_IRN	
	WHERE Rtrim(Ltrim(ISNULL(Irn,''))) = '' or  Rtrim(Ltrim(ISNULL(SignedQRCode,''))) = ''			
	
	INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
	Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
	Err_code,Err_desc,Lastmoddate,MovedOnDate)
	SELECT Distinct 1,SalId,SalInvNo,Salinvdate,	
	A.ackNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),A.ACKDate,121),121) as Ack_Date,Irn as Irn,'' as SignedInvoice,
	SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],1,'' as Err_code,'' as Err_desc,
	GETDATE(),GETDATE()
	FROM #EInvoice_Acknowledgment_IRN A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)
	ON A.DocNo=B.SalInvNo
	WHERE A.DocTyp='Tax Invoice'
	AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
	C.Invoice_Id=B.Salid AND C.Invoice_no=B.SalInvNo AND C.Invoice_no=A.DocNo
	AND TransId=1)
	
	INSERT INTO EInvoice_Acknowledgment(TransId,Invoice_Id,Invoice_no,Invoice_date,
	Ack_Number,Ack_Date,Irn,SignedInvoice,SignedQRCode,Ack_Status,Response_Status,
	Err_code,Err_desc,Lastmoddate,MovedOnDate)
	SELECT Distinct 2,ReturnID,ReturnCode,ReturnDate,	
	A.ackNo as Ack_Number,CONVERT(DATETIME,CONVERT(VARCHAR(25),getdate(),121),121) as Ack_Date,Irn as Irn,'' as SignedInvoice,
	SignedQRCode as SignedQRCode,'ACT' as [IRN Generated Status],1,'' as Err_code,'' as Err_desc,
	GETDATE(),GETDATE()
	FROM #EInvoice_Acknowledgment_IRN A (NOLOCK) INNER JOIN ReturnHeader B (NOLOCK)
	ON A.DocNo=B.ReturnCode
	WHERE --A.success='true' AND 
	A.DocTyp='Credit Note'
	AND NOT EXISTS(SELECT Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment  C (NOLOCK) WHERE 
	C.Invoice_Id=B.ReturnID AND C.Invoice_no=B.ReturnCode AND C.Invoice_no=A.DocTyp
	AND TransId = 2)	
		
  END TRY
	BEGIN CATCH		
		SET @Pi_Error = @@ERROR		
		IF @Pi_Error = 7303 
		BEGIN
			set @Pi_Error = 1			
			SET @Pi_Errmsg = 'Excel Application was already Open'	
		END
		ELSE IF @Pi_Error = 7314 
		BEGIN
			set @Pi_Error = 1
			SET @Pi_Errmsg = 'File Not Found'	
		END
		ELSE
		BEGIN
			set @Pi_Error = 1
			SELECT @Pi_Errmsg=  ERROR_MESSAGE()   
		END		
		select @Pi_Error,@Pi_Errmsg
	END CATCH  
END
GO
---E-invoice till Here
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CN2Cs_RetailerMasterDownload_New' AND XTYPE='P')
DROP PROCEDURE Proc_CN2Cs_RetailerMasterDownload_New
GO
/*
BEGIN TRAN
delete from errorlog
exec Proc_CN2Cs_RetailerMasterDownload_New 0
----select * from CN2Cs_Prk_RetailerMasterDownload
--select * from retailer -- where Rtrid >574
--select * from errorlog
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_CN2Cs_RetailerMasterDownload_New
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : NG2Cs_Prk_RetailerMasterDownload  
* PURPOSE  : To Update RetailerMaster data.
* CREATED  : VENKAT. M PMS NO : ILCRSTCKL0147
* CREATED DATE : 25-01-2019  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* 23/09/2019  Kishore R			  ILCRSTPAR5992		 SR		   Retailer Download From Console		
* 13/11/2019  M Lakshman          ILCRSTPAR6671      SR        Due to Phone no & TIN no blank and max length validation has been removed in CS. 
* 18/07/2020  Murugan.R          PARCS202100043      CR        Retailer Code Auto Generate
* 28/01/2021  Venkat. M			 CRCRSTPAR0107		 CR			UDC NULL value validate change
*********************************/  
SET NOCOUNT ON  
BEGIN  
 DECLARE @sSql   NVARCHAR(2000)  
 DECLARE @Taction    INT  
 DECLARE @ErrDesc    NVARCHAR(1000)  
 DECLARE @Tabname    NVARCHAR(50)  
 Declare @RtrCode  	varchar	(50) 
 Declare @RtrName  	varchar	(100) 
 Declare @RtrAddress1  	varchar	(100) 
 Declare @RtrAddress2  	varchar	(100)
 Declare @RtrAddress3  	varchar	(100) 
 Declare @CityName  	varchar	(100) 
 Declare @StateName  	varchar	(50)
 Declare @PostalCode  	varchar	(50) 
 Declare @RtrChannelCode  	varchar (50) 
 Declare @RtrGroupCode  	varchar (50) 
 Declare @RtrClassCode  	varchar	(50) 
 Declare @RtrKeyAcc  	varchar	(50) 
 Declare @RelationStatus 	nvarchar (100)
 Declare @ParentCode 	nvarchar (100)
 Declare @Status  	varchar	(50) 
 Declare @GeoLevel  	nvarchar	(100) 
 Declare @GeoLevelValue  	nvarchar	(200) 
 Declare @PhNumber  	varchar	(50) 
 Declare @ContactPerson  	varchar	(50)
 Declare @TinNumber  	varchar	(50) 
 Declare @TaxType  	varchar	(50) 
 Declare @RtrTaxGroup  	varchar	(50) 
 Declare @SalesRoute  	varchar	(50) 
 Declare @DeliveryRoute  	varchar	(50) 
 Declare @CashDisc  	numeric	(9, 2) 
 Declare @RtrCrLimit 	numeric	(18,2) 
 Declare @RtrCrDays  	int	 
 Declare @CSRtrType  	varchar	(50) 
 Declare @RegDate  	DateTime	 
 Declare @FrequencyMode  	varchar	(50) 
 Declare @Eligible  	int	       
 Declare @RetailerType  	varchar	(50) 
 Declare @Composition  	varchar	(50) 
 Declare @PANNumber  	varchar	(50) 
 Declare @GSTIN  	varchar	(50) 
 Declare @RelatedParty  	varchar	(50) 
 Declare @Latitude  	varchar	(50) 
	Declare @Longitude  	varchar	(50) 
	Declare @RtrUniqueCode  	varchar	(50)        
	Declare @Approved  	varchar	(50) 
	Declare @DownLoadFlag  	varchar	(10) 
	Declare @CreatedDate  	datetime	 
	Declare @RtrMobileNo  	varchar	(50) 
	DeClare @RtrCovMode as Int
	Declare @RtrDayOff as Int
	Declare @RtrTaxable as varchar(10)
	Declare @KeyAccId as Int
	   Declare @CtgClassMainId as Int
	   Declare @RtrClassId as Int
	   Declare @TaxGroupId as Int
	   Declare @RMID as Int
	   Declare @SRMID as Int	   
	   Declare @ApprovedId as Int
	   Declare @RTRFREQUENCYID as Int
	   Declare @CmpRtrCode as Varchar(50)
	   Declare @RtrId as Int
	   Declare @Pi_UserId as Int
	   Declare @DefultRMid as Int
	   Declare @DefultRMNAME as varchar(50)
	   DECLARE @GeoLevelId AS INT 
	   Declare @GeoMainId as Int	   
	   Declare @RelationStatusID as Int
	   Declare @RtrChildId as Int
	   Declare @RtrCashDiscPerc as numeric(18,2)
	   Declare @CoaId as Int
	   Declare @AcCode	as Nvarchar(100)
	   Declare @RtrType as varchar(50)
	   Declare @RtrTypeID as Int
	   Declare @RtrShipId as Int
	   	   
 Declare @Aadhaar	varchar	(50) 
 Declare @TCSApplicable  	varchar	(50) 
 SET @Taction=0 
 SET @Po_ErrNo=0  
 SET @Tabname = 'CN2Cs_Prk_RetailerMasterDownload'  
 SET @Pi_UserId=1  
 SET @GeoLevelId = 0
 SET @RtrChildId = 0
--RtrCode Auto Generate--PARCS202100043
DECLARE @AutoRtrCode AS NVARCHAR(200)
DECLARE @RtrCodeUserInput AS NVARCHAR(200)
DECLARE @AutoRtrCodeConfig AS TINYINT
SET @AutoRtrCodeConfig=0
IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
BEGIN
	SET @AutoRtrCodeConfig=1
END
--Till Here--PARCS202100043
 DELETE FROM CN2Cs_Prk_RetailerMasterDownload WHERE DOWNLOADFLAG='Y'
 DECLARE Cur_RetailerMasterDownload_New CURSOR  
 FOR SELECT DISTINCT ISNULL(RtrCode,''),ISNULL(RtrName,''),ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),ISNULL(RtrAddress3,''),ISNULL(PostalCode,''),ISNULL(PhNumber,''),
 ISNULL(ContactPerson,''),ISNULL(RtrKeyAcc,''),1 AS RtrCovMode, ISNULL(RegDate,'1900-01-01'),0 AS RtrDayOff,ISNULL(Status,''),'Yes' as RtrTaxable,ISNULL(TaxType,''),
 ISNULL(TinNumber,''),ISNULL(GeoLevel,''),ISNULL(GeoLevelValue,''),ISNULL(DeliveryRoute,''),ISNULL(SalesRoute,''),
 ISNULL(CashDisc,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0)
 ,ISNULL(RtrTaxGroup,''),
 ISNULL(RtrMobileNo,''),ISNULL(FrequencyMode,''),ISNULL(RtrUniqueCode,''), ISNULL(Approved,''),ISNULL(RelationStatus,''),
 ISNULL(ParentCode,''),ISNULL(RtrGroupCode,''),ISNULL(RtrChannelCode,''),ISNULL(RtrClassCode,''),ISNULL(CSRtrType,''),
 ISNULL(Latitude,''),ISNULL(Longitude,''),ISNULL(StateName,''),ISNULL(RetailerType,''),ISNULL(Composition,''),
 ISNULL(PANNumber,''),ISNULL(GSTIN,''),ISNULL(RelatedParty,''),ISNULL(AaadharNo,''),ISNULL(TCSApplicable,'No')		
 FROM CN2Cs_Prk_RetailerMasterDownload WHERE [DownLoadFlag] ='D' -- and CSRtrType='Sub Stockist' 
 OPEN Cur_RetailerMasterDownload_New  
 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable
 WHILE @@FETCH_STATUS=0  
 BEGIN  
		SET @Po_ErrNo=0  
		SET @Taction=0 
		Delete from ETL_Prk_UdcDetails
		
		 --START--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RtrCode
		
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
						
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RtrCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END
				RETURN
			END	
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RtrCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		
		
		
					
		IF (LTRIM(RTRIM(@RtrCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'') 
		BEGIN  
			IF EXISTS (SELECT '*' FROM Retailer WHERE (RtrCode = @RtrCode 
			OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			)  
			BEGIN  
				SET @Taction=2  
			END  
			ELSE  
			BEGIN  
				SET @Taction=1  
			END  
		END  
		ELSE  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Code should not be empty '      
			INSERT INTO Errorlog VALUES (1,@Tabname,'RetailerCode',@ErrDesc)  
		END  
		IF LTRIM(RTRIM(@RtrName))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Name should not be empty'    
			INSERT INTO Errorlog VALUES (2,@Tabname,'RetailerName',@ErrDesc)  
		END
		IF LTRIM(RTRIM(@RtrAddress1))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Address  should not be empty'    
			INSERT INTO Errorlog VALUES (3,@Tabname,'Address',@ErrDesc)  
		END 		   
		--IF LTRIM(RTRIM(@PhNumber))=''
		--BEGIN
		--	SET @Po_ErrNo=1
		--	SET @Taction=0
		--	SET @ErrDesc = 'Ph Number should not be empty'		
		--	INSERT INTO Errorlog VALUES (4,@Tabname,'TINNumber',@ErrDesc)
		--END
		--ELSE
		--BEGIN
		--	IF LEN(@PhNumber)>12
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'Ph Number Maximum Length should be 12'		
		--		INSERT INTO Errorlog VALUES (5,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--END
		IF UPPER(LTRIM(RTRIM(@RtrKeyAcc)))=UPPER('Yes')  
		BEGIN  
			SET @KeyAccId=1   
		END 
		ELSE  
		BEGIN  
			SET	@KeyAccId=0
		END		
		IF UPPER(LTRIM(RTRIM(@Status)))=UPPER('ACTIVE')  
		--IF UPPER(LTRIM(RTRIM(@Status)))= 1  
		BEGIN  
			SET @Status=1   
		END  
		ELSE  
		BEGIN  
			SET @Status=0  
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (6,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT' OR LTRIM(RTRIM(@TaxType))='GST' 
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (7,@Tabname,'TaxType',@ErrDesc)
			END
		END
		--IF @TaxType='VAT'
		--BEGIN
		--	IF LTRIM(RTRIM(@TINNumber))=''
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'TIN Number should not be empty'		
		--		INSERT INTO Errorlog VALUES (8,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--	ELSE
		--	BEGIN
		--		IF LEN(@TINNumber)>11
		--		BEGIN
		--			SET @Po_ErrNo=1
		--			SET @Taction=0
		--			SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
		--			INSERT INTO Errorlog VALUES (9,@Tabname,'TINNumber',@ErrDesc)
		--		END
		--	END
		--END
		
		IF LTRIM(RTRIM(@RtrTaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup)
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @RtrTaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (10,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup
			END
		END
		IF NOT EXISTS  (SELECT '*' FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'      
			INSERT INTO Errorlog VALUES (11,@Tabname,'DeliveryRoute',@ErrDesc)  
		END  
		ELSE  
		BEGIN    
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 
		END
		IF NOT EXISTS (SELECT '*' FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute)  
		BEGIN  
		   SET @ErrDesc = 'Route Code:'+@SalesRoute+'does not Mapped Salesman'  
		   INSERT INTO Errorlog VALUES (12,@TabName,'Route Code',@ErrDesc)  
		   SET @Po_ErrNo=1  
		   
		END  
		ELSE  
		BEGIN  
			SELECT @SRMID =B.Rmid  FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute    
		END 		
		IF LTRIM(RTRIM(@FrequencyMode))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency  should not be empty'		
			INSERT INTO Errorlog VALUES (13,@Tabname,'Retailer Frequency',@ErrDesc)
		END		
		IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Bi-Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Fort Nightly')  
		BEGIN  
			SET @RTRFREQUENCYID=2  
		END 
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Monthly')  
		BEGIN  
			SET @RTRFREQUENCYID=3  
		END
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Daily')  
		BEGIN  
			SET @RTRFREQUENCYID=4 
		END 
		IF ISNULL(@RtrUniqueCode,'')='' AND UPPER(ISNULL(@Approved,'PENDING'))='APPROVED'  
		BEGIN  
			SET @ErrDesc = 'Retailer Unique Code Mandatory for Approved retailers :'+@RtrCodeUserInput  
			INSERT INTO Errorlog VALUES (14,@TabName,'Retailer Unique Code',@ErrDesc)  
			SET @Po_ErrNo=1  
		END 
		
		IF @Approved = ''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Approved  should not be empty'		
			INSERT INTO Errorlog VALUES (24,@Tabname,'Approved',@ErrDesc)		
		END
		ELSE
		IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('PENDING')  
		BEGIN  
			SET @ApprovedId=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('APPROVED')  
		BEGIN  
			SET @ApprovedId=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('REJECTED')  
		BEGIN  
			SET @ApprovedId=2  
		END
		
		IF LTRIM(RTRIM(@RtrCrLimit))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrLimit)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Limit value Should be Number'    
				INSERT INTO Errorlog VALUES (15,@Tabname,'CreditLimit',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCrDays))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrDays)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Days value Should be Number'    
				INSERT INTO Errorlog VALUES (16,@Tabname,'CreditDays',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCashDiscPerc))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCashDiscPerc)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'    
				INSERT INTO Errorlog VALUES (17,@Tabname,'CashDiscountPercentage',@ErrDesc)  
			END  
		END  
		 
		IF NOT EXISTS  (SELECT '*' FROM GEOGRAPHYLEVEL(NOLOCK) WHERE GeoLevelName = @GeoLevel )  
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Geogrpahy Level: ' + @GeoLevel + ' is not available'      
			INSERT INTO Errorlog VALUES (18,@Tabname,'GEOGRAPHYLEVEL',@ErrDesc)				
		END
		ELSE
		BEGIN
			SELECT @GeoLevelId = GeoLevelId FROM GEOGRAPHYLEVEL WHERE GeoLevelName = @GeoLevel 
		END
		 
		IF @GeoLevelId <> 0 
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM Geography(NOLOCK) WHERE GeoName = @GeoLevelValue )  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Geogrpahy Code: ' + @GeoLevelValue + ' is not available'      
				INSERT INTO Errorlog VALUES (19,@Tabname,'GeographyHierarchyValue',@ErrDesc)  
			END  
			ELSE  
			BEGIN  
				SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoName = @GeoLevelValue  
			END	
		END
	
		IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Independent')
		BEGIN
			SET @RelationStatusID =1
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Parent')
		BEGIN
			SET @RelationStatusID =2
			IF UPPER(LTRIM(RTRIM(@ParentCode))) <> ''
			BEGIN			
				Select @RtrChildId = rtrid from Retailer (Nolock) where RtrCode = @ParentCode
			END
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Child')
		BEGIN
			SET @RelationStatusID =3 
		END
		
		IF UPPER(LTRIM(RTRIM(@RtrType)))=UPPER('Sub Stockist')
		BEGIN
			SET @RtrTypeID = 2
		END
		ELSE
		BEGIN
			SET @RtrTypeID = 1		
		END
	
		IF NOT EXISTS(SELECT '*' FROM RETAILERCATEGORY A (NOLOCK) 
		INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
		inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
		where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode)
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Category: ' + @RtrClassCode + ' is not available'      
			INSERT INTO Errorlog VALUES (20,@Tabname,'RETAILERCATEGORY',@ErrDesc)		 
		END
		ELSE
		BEGIN
			 SELECT @RtrClassId = RtrClassId FROM RETAILERCATEGORY A (NOLOCK)
			 INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
			 inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
			 where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode		 
		END
		SET @CmpRtrCode = ''			
		--IF @Po_ErrNo = 0 AND @Taction = 1
		--BEGIN
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger('Retailer','RtrId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @RtrShipId=dbo.Fn_GetPrimaryKeyInteger('retailershipadd','RtrShipId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) 
			FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')  
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1  
			BEGIN     
				IF NOT EXISTS(SELECT '*' FROM Retailer)  
				BEGIN  
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'   
				END  
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))     				
			END  
			ELSE  
			BEGIN  
				SET @CmpRtrCode=@RtrCode  
			END 	
			IF @CmpRtrCode=''  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Company Retailer Code should not be empty'    
				INSERT INTO Errorlog VALUES (21,@Tabname,'Counter Value',@ErrDesc)  
			END  
			IF @RtrId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (22,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @RtrShipId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (23,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @StateName = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Sate name Should not be Empty '    
				INSERT INTO Errorlog VALUES (25,@Tabname,'Sate name',@ErrDesc) 			
			
			END
			IF @RetailerType = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer Type Should not be Empty '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer Type',@ErrDesc) 			
			
			END
			ELSE
			BEGIN
				IF Upper(@RetailerType) = 'REGISTERED'
				BEGIN
					IF UPPER(@Composition) NOT IN('YES','NO','')
					BEGIN
						SET @Po_ErrNo=1    
						SET @Taction=0  
						SET @ErrDesc = 'REGISTERED Retailer Composition Should not be Empty OR either Yes / No'    
						INSERT INTO Errorlog VALUES (27,@Tabname,'Composition',@ErrDesc) 			
					
					END
				END
			END	
			IF UPPER(@RelatedParty) NOT IN('YES','NO')
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer PARTY Should not be yes / No '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer PARTY',@ErrDesc) 			
			
			END				
		
		IF @Po_ErrNo = 0 AND @Taction = 1
		BEGIN			
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrContactPerson,RtrKeyAcc,
			RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrDepositAmt,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrOffPhone2,RtrDOB,
			RtrAnniversary,RtrRemark1,CoaId,RtrOnAcc,RtrType,RtrFrequency,RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,
			RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,Approved,XMLUpload,RtrPayment,RtrUniqueCode,
			WSUpload,RtrCodeUserInput)
			
			SELECT @RtrId,@RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
			@ContactPerson,@KeyAccId,@RtrCovMode,@RegDate,@RtrDayOff,@Status,(CASE UPPER(@RtrTaxable) WHEN 'YES' THEN 1 ELSE 0 END) RtrTaxable,
			(CASE @TaxType WHEN 'VAT' THEN 0 WHEN 'GST' THEN 2 ELSE 1 END) TaxType
			,@TinNumber,0 RtrDepositAmt,0 RtrCrBills,@RtrCrLimit,@RtrCrDays,@RtrCashDiscPerc,1 RtrCashDiscCond,0 RtrCashDiscAmt,
			@GeoMainId,@RMId,0 VillageId,@RtrShipId,@TaxGroupId,@RtrMobileNo,@RegDate,@RegDate,'Downloaded Retailer',@CoaId,0 RtrOnAcc,
			@RtrTypeID,@RTRFREQUENCYID,0 RtrCrBillsAlert,0 RtrCrLimitAlert,0 RtrCrDaysAlert,'N' Upload,@RelationStatusID,
			1,@Pi_UserId,GETDATE(),@Pi_UserId,GETDATE(),@CmpRtrCode,@ApprovedId,0 XMLUpload,1 RtrPayment,@RtrUniqueCode,
			'N' WSUpload,@RtrCodeUserInput
			
			IF EXISTS (SELECT '*' FROM Retailer WHERE RtrId=@RtrId)  
			BEGIN  
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RtrName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),
				GETDATE(),121))  
			 			
				INSERT INTO RETAILERMARKET(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
				SELECT @Rtrid,@SRMID,1,1,GETDATE(),1,GETDATE(),0
				
				INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121))
				
				IF ISNULL(@RtrChildId,0) <> 0
				BEGIN
					INSERT INTO Retailerrelation(RtrId,RtrChildId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					Select @RtrId,@RtrChildId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
					CONVERT(NVARCHAR(10),GETDATE(),121)
				END
								
				INSERT INTO Retailershipadd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,
				RtrShipDefaultAdd,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxGroupId,StateId,GSTTinNo,Upload)
				SELECT @RtrShipId,@RtrId,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,1,1,@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@TaxGroupId,0,'','N'
					
				INSERT INTO ETL_Prk_UdcDetails
				SELECT 'Retailer Master','Latitude', @RtrCode,(CASE @Latitude WHEN '' THEN '0' ELSE @Latitude END) UNION ALL								
				SELECT 'Retailer Master','Longitude', @RtrCode,(CASE @Longitude WHEN '' THEN '0' ELSE @Longitude END) UNION ALL
				SELECT 'Retailer Master','State Name', @RtrCode,@StateName  UNION ALL
				SELECT 'Retailer Master','Retailer Type', @RtrCode,@RetailerType UNION ALL				
				SELECT 'Retailer Master','Composition', @RtrCode,(CASE @Composition WHEN '' THEN 'NA' ELSE @Composition END) UNION ALL
				SELECT 'Retailer Master','PAN Number', @RtrCode,(CASE @PANNumber WHEN '' THEN '0' ELSE @PANNumber END) UNION ALL
				SELECT 'Retailer Master','GSTIN', @RtrCode,(CASE @GSTIN WHEN '' THEN '0' ELSE @GSTIN END) UNION ALL
				SELECT 'Retailer Master','Related Party', @RtrCode,(CASE @RelatedParty WHEN '' THEN 'NO' ELSE @RelatedParty END) UNION ALL
				SELECT 'Retailer Master','Aadhaar', @RtrCode,@Aadhaar UNION ALL
				SELECT 'Retailer Master','TCS Applicable', @RtrCode,(CASE WHEN @TCSApplicable='Yes' THEN 'Yes' ELSE 'No' END)
				
				
				IF EXISTS(SELECT * FROM ETL_Prk_UdcDetails)
				BEGIN
					EXEC Proc_ValidateUdcDetails 0
				END
				
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'retailershipadd' AND Fldname = 'RtrShipId'  
				UPDATE companycounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'RtrId'
				--RtrCode Auto Generate
				IF @AutoRtrCodeConfig=1
				BEGIN
					UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				END
				--Till Here
				
			END		  		  
		END
	 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
	 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
	 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
	 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
	 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
	 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable
 END  
 CLOSE Cur_RetailerMasterDownload_New  
 DEALLOCATE Cur_RetailerMasterDownload_New  
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCode=C.RtrCODE 
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCodeUserInput=C.RtrCODE
 RETURN  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidateStockTransfer' AND XTYPE='P')
DROP PROCEDURE Proc_ValidateStockTransfer
GO
--    begin transaction SA
--    exec Proc_ValidateStockTransfer 0
--    rollback transaction SA
CREATE PROCEDURE Proc_ValidateStockTransfer
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE: Proc_ValidateStockTransfer
* PURPOSE: To Insert and Update records
* CREATED: Boopathy.P on 18/09/2007
* 28/01/2021  Venkat. M			 CRCRSTPAR0107		 CR			Stock transfer block.
*********************************/
--EXCEL IMPORT STOCK MANAGEMENT TYPE ADDED BY PRAVEENRAJ B ON 31-01-2014
SET NOCOUNT ON
BEGIN
	DECLARE @ErrDesc AS VARCHAR(1000)
	DECLARE @rno AS INT
	DECLARE @TabName AS VARCHAR(50)
	DECLARE @DocRefNo As VARCHAR(100)
	DECLARE @TransType As VARCHAR(50)
	DECLARE @PrdCode As VARCHAR(50)
	DECLARE @PrdBat As VARCHAR(50)
	DECLARE @StkType AS VARCHAR(50)
	DECLARE @LocCode AS VARCHAR(50)
	DECLARE @UomCode AS VARCHAR(50)
	DECLARE @Qty AS VARCHAR(20)
	DECLARE @Po_StkPosting INT
	DECLARE @PrdId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @PriceId AS INT
	DECLARE @LcnId AS INT
	DECLARE @UomId AS INT
	DECLARE @StkId AS INT
	DECLARE @StkTypeId AS INT
	DECLARE @StockLegdStkTypeId AS INT
	DECLARE @GetKey AS VARCHAR(20)
	DECLARE @Taction AS INT
	DECLARE @TransId AS INT
	DECLARE @SelRte AS NUMERIC(18,6)
	DECLARE @Amount AS NUMERIC(18,2)
	DECLARE @Pi_Date DATETIME
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @TypeDesc AS NVARCHAR(10)
	DECLARE @Type AS INT
	DECLARE @ChkDate AS DATETIME
	DECLARE @iCnt AS INT
	DECLARE @iOpnDebit AS NUMERIC(18,2)
	DECLARE @iOpnCredit AS NUMERIC(18,2)
	DECLARE @ErrStatus		INT
	DECLARE @iVocDate	NVARCHAR(10)
	
	DECLARE @StkMgmtTypeId INT
	
	SET @iVocDate=CONVERT(NVARCHAR(10),GETDATE(),121)
	SET @TabName = 'ETL_Prk_StockTransfer'
	SET @Po_ErrNo = 0
	---CRCRSTPAR0107
	IF EXISTS (SELECT * FROM  ManualConfiguration WHERE ModuleId='ETLBLOCKMSTCREATION' AND Status=1)
	BEGIN
		RETURN
	END
	---CRCRSTPAR0107
	DECLARE Cur_StkTransHd CURSOR
	FOR SELECT DISTINCT ISNULL([Location],'') AS [Location],ISNULL([Trans Type],''),
		ISNULL([Document Reference Number],'')AS [Reference Number],ISNULL([Type],'') AS [Type]
		FROM ETL_Prk_StockTransfer Order By [Location]
	OPEN Cur_StkTransHd
	FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@TypeDesc
	SET @Rno = 0
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Taction = 2
		IF LTRIM(RTRIM(@LocCode))= ''
		BEGIN
			SET @ErrDesc = 'Location should not be blank'
			INSERT INTO Errorlog VALUES (1,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@TransType))= ''
		BEGIN
			SET @ErrDesc = 'Transaction Type should not be blank'
			INSERT INTO Errorlog VALUES (2,@TabName,'Transaction Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LTRIM(RTRIM(@Type))= ''
		BEGIN
			SET @ErrDesc = 'Type should not be blank'
			INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		
		IF @TypeDesc= '0'
			SET @Type=0
		ELSE IF @TypeDesc= '1'
			SET @Type=1
		IF LTRIM(RTRIM(@TransType)) = 'REDUCE'
			SET @TransId=1
		ELSE IF LTRIM(RTRIM(@TransType)) = 'ADD'
			SET @TransId=0
		IF NOT EXISTS(SELECT StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId)
		BEGIN
			SET @ErrDesc = 'Transaction Not Found'
			INSERT INTO Errorlog VALUES (4,@TabName,'Transaction',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @TransId=StkMgmtTypeId FROM StockManagementType WHERE TransactionType=@TransId
		END
		IF NOT EXISTS(SELECT LcnId FROM Location WHERE LcnCode=@LocCode)
		BEGIN
			SET @ErrDesc = 'Location Not Found'
			INSERT INTO Errorlog VALUES (5,@TabName,'Location',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
			SET @TransId=0
		END
		ELSE
		BEGIN
			SELECT @LcnId=LcnId FROM Location WHERE LcnCode=@LocCode
		END
		SELECT @GetKey= dbo.Fn_GetPrimaryKeyString('StockManagement','StkMngRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
		IF @Taction = 2
		BEGIN
			INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal,Status)
			VALUES(@GetKey,convert(varchar(10),getdate(),121),@LcnId,@TransId,0,0,@DocRefNo,'',4,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),@Type,1)
			SET @sSQL ='INSERT INTO StockManagement(StkMngRefNo,StkMngDate,LcnId,StkMgmtTypeId,RtrId,SpmId,DocRefNo,Remarks,DecPoints,Availability,LAstModBy,LastModDate,AuthId,AuthDate,OpenBal) VALUES(''' +
					CAST(@GetKey AS VARCHAR(50)) + ''',''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@LcnId AS VARCHAR(10)) + ',' +
					CAST(@TransId AS VARCHAR(10)) + ',0,0,''' + CAST(@DocRefNo AS VARCHAR(50)) + ''','''',4,1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''',' + CAST(@Type AS VARCHAR(10)) + ',1)'
			INSERT INTO Translog(strSql1) Values (@sSQL)
			UPDATE counters SET currvalue = currvalue+1  WHERE tabname = 'StockManagement' and fldname = 'StkMngRefNo'
			SET @sSQL ='UPDATE counters SET currvalue = currvalue+1  WHERE tabname = ''StockManagement'' and fldname = ''StkMngRefNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			IF @Po_ErrNo =1
				SET @Po_ErrNo =1
			ELSE
				SET @Po_ErrNo =0
		END
		DECLARE  Cur_StkTransDt CURSOR
		FOR SELECT [Product Code],[Batch Code],[System Stock Type],[Uom Code],[Qty]
		FROM ETL_Prk_StockTransfer WHERE [Trans Type] = @TransType AND [Location]=@LocCode
		ORDER BY [Product Code],[Batch Code],[Location]
		OPEN Cur_StkTransDt
		FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		WHILE @@FETCH_STATUS=0
		BEGIN
			IF LTRIM(RTRIM(@PrdCode))= ''
			BEGIN
				SET @ErrDesc = 'Product should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@PrdBat))= ''
			BEGIN
				SET @ErrDesc = 'Product Batch should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END			
			IF LTRIM(RTRIM(@StkType))= ''
			BEGIN
				SET @ErrDesc = 'System Stock Type should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'System Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@UomCode))= ''
			BEGIN
				SET @ErrDesc = 'Uom Code should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Uom Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))= ''
			BEGIN
				SET @ErrDesc = 'Quantity should not be blank'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF ISNUMERIC(LTRIM(RTRIM(@Qty)))= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be numeric'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF LTRIM(RTRIM(@Qty))<= 0
			BEGIN
				SET @ErrDesc = 'Quantity should be greater than Zero'
				INSERT INTO Errorlog VALUES (7,@TabName,'Quantity',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @TransType='ADD'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment In'
			END
			ELSE IF @TransType='REDUCE'
			BEGIN
				SELECT @StkMgmtTypeId=ISNULL(StkMgmtTypeId,0) FROM StockManagementType WHERE Description='IRA Adjustment Out'
			END
			IF ISNULL(@StkMgmtTypeId,0)=0
			BEGIN
				SET @ErrDesc = 'Trans Type Should ADD/REDUCE'
				INSERT INTO Errorlog VALUES (7,@TabName,'Trans Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			IF @StkType='Saleable'
			BEGIN
			
				SET @StkTypeId =1
				IF @TransType='ADD'
					BEGIN
						
						SET @StockLegdStkTypeId=10
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=13
					END
			END	
			ELSE IF @StkType='Unsaleable'
			BEGIN
				SET @StkTypeId =2
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=11
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=14
					END
			END
			ELSE IF @StkType='Offer'
			BEGIN
				SET @StkTypeId =3
				IF @TransType='ADD'
					BEGIN
						SET @StockLegdStkTypeId=12
					END
				ELSE
					BEGIN
						SET @StockLegdStkTypeId=15
					END
			END
			IF NOT EXISTS(SELECT PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode)))
			BEGIN
				SET @ErrDesc = 'Product:'+@PrdCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Product',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdId=PrdId FROM Product WHERE PrdDCode=LTRIM(RTRIM(@PrdCode)) OR PrdCCode=LTRIM(RTRIM(@PrdCode))
			END
			IF NOT EXISTS(SELECT PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)))
			BEGIN
				SET @ErrDesc = 'Product Batch:'+@PrdBat+' Not Found For Product:'+@PrdCode
				INSERT INTO Errorlog VALUES (8,@TabName,'Product Batch',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
				SET @PrdId = 0
				SET @PrdBatId = 0
			END
			ELSE
			BEGIN
				SELECT @PrdBatId=PrdBatId FROM ProductBatch WHERE PrdBatCode=LTRIM(RTRIM(@PrdBat)) AND PrdId=@PrdId
			END		
			
			SELECT @PriceId=PriceId FROM ProductBatchDetails WHERE DefaultPrice=1 AND PrdBatId=@PrdBatId AND SlNo=1
			
			
			IF NOT EXISTS(SELECT StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId)
			BEGIN
				SET @ErrDesc = 'Stock Type Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Stock Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @StkId=StockTypeId FROM StockType WHERE LcnId=@LcnId AND SystemStockType=@StkTypeId
			END	
			
			IF NOT EXISTS(SELECT UomId FROM UomMaster WHERE UomCode=@UomCode)
			BEGIN
				SET @ErrDesc = 'Uom:'+@UomCode+' Not Found'
				INSERT INTO Errorlog VALUES (8,@TabName,'Uom',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @UomId=UomId FROM UomMaster WHERE UomCode=@UomCode
			END
			IF @PrdId <> 0 AND @PrdBatId <> 0 AND @PriceId <> 0
			BEGIN
				SELECT @SelRte=CONVERT(NUMERIC(18,2),C.PrdBatDetailValue) FROM ProductBatch A (NOLOCK)
				INNER JOIN ProductBatchDetails C (NOLOCK)ON A.PrdBatId = C.PrdBatID AND C.PriceId=@PriceId
				INNER JOIN Product P ON A.PrdId = P.PrdId
				INNER JOIN BatchCreation D (NOLOCK)
				ON D.BatchSeqId = C.BatchSeqId AND D.SlNo = C.SlNo
				AND D.SelRte = 1 WHERE P.PrdId = @PrdId AND A.PrdBatId = @PrdBatId
				SET @Amount = (CONVERT(NUMERIC(18,2),@SelRte) * CONVERT(INT,REPLACE(@Qty,'	','')))
			END
			ELSE
			BEGIN
				SET @ErrDesc = 'Selling Rate Not Found for Product:'+@PrdCode+' for Batch:'+@PrdBat
				INSERT INTO Errorlog VALUES (8,@TabName,'Selling Rate',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			--Added By Maha on 15/06/2009
			SET @iOpnDebit=0
			SET @iOpnCredit=0
			SELECT @iCnt=Count(CoaId) FROM COAOpeningBalance Where CoaId=291
			SELECT @iOpnDebit=ISNULL(OpeningDebit,0),@iOpnCredit=ISNULL(OpeningCredit,0) FROM COAOpeningBalance Where CoaId=74
			SET @iOpnDebit=@iOpnDebit+@Amount
			SET @iOpnCredit=@iOpnCredit
			IF @Type = 1	--Opening Balance
			BEGIN
				SELECT @ChkDate=ISNULL(MIN(TransDate),GETDATE())  FROM StockLedger WITH (NOLOCK)
				IF CONVERT(NVARCHAR(10),GETDATE(),121)=CONVERT(NVARCHAR(10),@ChkDate,121)
				BEGIN			
					IF @iCnt=0
					BEGIN
						INSERT INTO CoaOpeningBalance(CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)
								VALUES(291,@iOpnDebit,@iOpnCredit,1,1,GETDATE(),1,GETDATE())
				
						SET @sSQL = 'INSERT INTO CoaOpeningBalance (CoaId,OpeningDebit,OpeningCredit,Availability,LastModBy,LastModDate,AuthId,AuthDate)'
						SET @sSQL = @sSQL + ' VALUES(291,' + CAST(@iOpnDebit AS NVARCHAR(100))+ ',' + CAST(@iOpnCredit AS NVARCHAR(100))+ ',1,1,GETDATE(),1,GETDATE())'
						INSERT INTO Translog(strSql1) Values (@sSQL)
			
						SELECT * FROM CoaOpeningBalance
					END
					ELSE
					BEGIN
						UPDATE CoaOpeningBalance SET OpeningDebit=@iOpnDebit WHERE CoaId=291
					
						SET @sSQL='UPDATE CoaOpeningBalance SET OpeningDebit=' + CAST(@iOpnDebit AS NVARCHAR(100)) + ' WHERE CoaId=291'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				ELSE
				BEGIN
					SET @ErrDesc = 'Transaction Exists'
					INSERT INTO Errorlog VALUES (3,@TabName,'Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END	
			--Till Here
			IF @Taction =2
			BEGIN
				INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxAmt,StkMgmtTypeId)
				VALUES (@GetKey,@PrdId,@PrdBatId,@PriceId,@StkId,@UomId,@Qty,0,0,@Qty,CONVERT(NUMERIC(18,2),@SelRte),@Amount,0,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0,@StkMgmtTypeId)
				
				SET @sSQL ='INSERT INTO StockManagementProduct(StkMngRefNo,PrdId,PrdBatId,PriceId,StockTypeId,UOMId1,Qty1,UOMId2,Qty2,TotalQty,Rate,Amount,ReasonId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(''' +
					   CAST(@GetKey AS VARCHAR(50)) + ''',' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@PriceId AS VARCHAR(10)) + ','+
							   CAST(@StkId AS VARCHAR(10)) + ',' +CAST(@UomId AS VARCHAR(10)) + ',' + CAST(@Qty AS VARCHAR(10)) +
							   ',0,0,' + CAST(@Qty AS VARCHAR(10)) + ',' + CAST(@SelRte AS VARCHAR(24)) + ',' + CAST(@Amount AS VARCHAR(24)) + ',0,1,1,''' +
							   convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @Pi_Date = CONVERT(NVARCHAR(10),GETDATE(),121)
				Exec Proc_UpdateStockLedger @StockLegdStkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
				SET @sSQL ='Exec Proc_UpdateStockLedger ' + CAST(@StockLegdStkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' + CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
						CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
				INSERT INTO Translog(strSql1) Values (@sSQL)
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Stock Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Stock Posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				IF @TransType='ADD'
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,1,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',1,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE
				BEGIN
					Exec Proc_UpdateProductBatchLocation @StkTypeId,2,@PrdId,@PrdBatId,@LcnId,@Pi_Date,@Qty,1,@Pi_ErrNo = @Po_StkPosting OUTPUT
					SET @sSQL ='Exec Proc_UpdateProductBatchLocation ' + CAST(@StkTypeId AS VARCHAR(10)) + ',2,' + CAST(@PrdId AS VARCHAR(10)) + ',' +CAST(@PrdBatId AS VARCHAR(10)) + ',' + CAST(@LcnId AS VARCHAR(10)) + ',''' +
							CAST(@Pi_Date AS VARCHAR(20)) + ''',' + CAST(@Qty AS VARCHAR(10)) + ',1,' + CAST( @Po_StkPosting AS VARCHAR(10)) + ''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				--Voucher Posting	Added By Maha on 15-03-2009
				IF @Type=0
				BEGIN
					IF @TransType='ADD'
					BEGIN
						EXEC Proc_VoucherPosting 13,1,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,1,'''+ CAST(@GetKey AS VARCHAR(10))+ ''' ,5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @TransType='REDUCE'
					BEGIN
						EXEC Proc_VoucherPosting 13,0,@GetKey ,5,0,1,@iVocDate,@Po_ErrNo = @ErrStatus OUTPUT
						SET @sSQL='EXEC Proc_VoucherPosting 13,0,'''+ CAST(@GetKey AS VARCHAR(10)) + ',5,0,1,GETDATE(),@Po_PurErrNo = @ErrStatus OUTPUT'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END
				IF @ErrStatus < 0
				BEGIN
					 SET @ErrDesc = 'Voucher Posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Voucher posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				IF @Po_ErrNo =1
				BEGIN
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SET @Po_ErrNo =0
				END
				--Till Here
				IF @Po_StkPosting = 1
				BEGIN
					 SET @ErrDesc = 'Product batch location posting Error'
					 INSERT INTO Errorlog VALUES (8,@TabName,'Product batch location posting Error',@ErrDesc)
					 SET @Taction = 0
					 SET @Po_ErrNo =1
				END
				
				IF @Po_ErrNo =1
					SET @Po_ErrNo =1
				ELSE
					SET @Po_ErrNo =0
				END
				SET @PrdId = 0
				SET @PrdBatId = 0
			FETCH NEXT FROM Cur_StkTransDt INTO @PrdCode,@PrdBat,@StkType,@UomCode,@Qty
		END
		CLOSE Cur_StkTransDt
		DEALLOCATE Cur_StkTransDt
		SET @GetKey=''
		FETCH NEXT FROM Cur_StkTransHd INTO @LocCode,@TransType,@DocRefNo,@Type
	END
	CLOSE Cur_StkTransHd
	DEALLOCATE Cur_StkTransHd
END
GO
---Added by Venkatachalam
DELETE WSMasterExportUploadTrack  Where ProcessName In('Beat Master','Salesman Details')
GO
--Added by Mary
UPDATE HotSearchEditorHd SET RemainsltString ='
SELECT SMId,SMCode,SMName,Routes,Retailers FROM (SELECT SM.SMId,SM.SMCode,SM.SMName,COUNT(DISTINCT SMM.RMId) AS Routes,
COUNT(DISTINCT RM.RtrId) AS Retailers   FROM Salesman SM WITH (NOLOCK) LEFT OUTER JOIN SalesmanMarket SMM WITH (NOLOCK) 
ON SM.SMId = SMM.SMId   LEFT OUTER JOIN RetailerMarket RM WITH (NOLOCK) ON RM.RMId = SMM.RMId WHERE SM.Status=1
GROUP BY SM.SMId,SM.SMCode,SM.SMName) as MainQry' WHERE FormId=418
GO
----From Updater
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_ImpSetupDetails' AND xtype='P')
DROP PROCEDURE Proc_ImpSetupDetails
GO
CREATE PROCEDURE Proc_ImpSetupDetails
(
@pRecords Text      
)
AS
/**************************************************************************************************************
DATE			AUTHOR	    CR/BZ	  USER STORY ID		DESCRIPTION                         
***************************************************************************************************************
18/09/2020	  Kishore R		CR	   AMLCS202100043		RegRequired Disabled specfic DLL
***************************************************************************************************************/      
--select * from Setup_Details
SET NOCOUNT ON  
BEGIN     
	DECLARE @hDoc INTEGER,       
		@InsertCount INTEGER  
	Declare @File_Names as Varchar(50)
	Declare @File_CrDate as datetime
	Declare @File_Path as Varchar(100)
	Declare @Status as Int
	Declare @RegRequired as int
	Declare @HotfixNo as int
	Declare @VersionNo as int
	Declare @DistCode as Varchar(50)
	Declare @DCode as Varchar(50)
	TRUNCATE TABLE SetupDetails
	EXEC sp_xml_preparedocument @hDoc OUTPUT, @pRecords 
      	SELECT 	File_Names as File_Names,
		Convert(Datetime,File_CrDate,101) as File_CrDate,
		File_Path as File_Path,
		Status as Status,
		RegRequired as RegRequired,
		HotfixNo as HotfixNo,
		VersionNo as VersionNo,
		COnVert(Datetime,File_UnZipDate,101) as File_UnZipDate,
		UploadFileSize as UploadFileSize,
		DownloadFileSize as DownloadFileSize,
		FileExtension as FileExtension,
		FileSplitStatus as FileSplitStatus
		INTO #Setup_Details   
       		FROM  OPENXML (@hdoc, '/MAST/SETUPDETAILS',1)                            
       		WITH ( 	
			File_Names Varchar(50),
			File_CrDate Varchar(10),
			File_Path Varchar(100),
			Status int,   
			RegRequired int,
			HotfixNo int,
			VersionNo Varchar(100),
			File_UnZipDate Varchar(10),
			UploadFileSize BigInt,
			DownloadFileSize Bigint,
			FileExtension  VarChar(5),
			FileSplitStatus Int
			
	    	 ) XMLGodown   
		   
		INSERT INTO SetupDetails 
		SELECT File_Names,File_CrDate,File_Path,Status,RegRequired,HotfixNo,
		VersionNo,File_UnZipDate ,UploadFileSize,DownloadFileSize,FileExtension,FileSplitStatus 
		FROM #Setup_Details
		
		DECLARE @CCount AS NUMERIC(38,0) 
		CREATE TABLE #Files
		(
			SubDirectory NVARCHAR(512),
			Depth INT
		)

		INSERT INTO #Files
		EXEC xp_dirtree 'C:\Program Files (x86)\Common Files\Crystal Decisions'
		SELECT @CCount= @@ROWCOUNT
		IF @CCount=0
		BEGIN
			UPDATE SetupDetails SET File_Path = 'C:\Program Files\Common Files\Crystal Decisions\2.0\bin' WHERE [File_Names] like 'Craxdrt%'
		END
		ELSE
		BEGIN
			UPDATE SetupDetails SET File_Path = 'C:\Program Files (x86)\Common Files\Crystal Decisions\2.0\bin' WHERE [File_Names] like 'Craxdrt%'
		END 
		
		--UPDATE SetupDetails SET File_Path = 'C:\Program Files\Common Files\Crystal Decisions\2.0\bin' WHERE [File_Names] like 'Craxdrt%'
		
		----AMLCS202100043
		UPDATE SetupDetails SET RegRequired = 0 where File_Names in ('zxing.dll','Interop.Excel.dll','Newtonsoft.Json.dll')
				
		DELETE A FROM SetupDetails A (NOLOCK) WHERE File_Names = 'CSUpdates Alert.exe' AND FileExtension = 'EXE'
EXECUTE sp_xml_removedocument @hDoc 
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE Name='Proc_Export_CS2WS_Customer' AND type ='P')
DROP PROCEDURE Proc_Export_CS2WS_Customer
GO
CREATE PROCEDURE Proc_Export_CS2WS_Customer
(
   @SalRpCode varchar(100)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_Customer 
* PURPOSE		: To Export Customer details to the PDA Intermediate Database
* CREATED		: AMUTHA KUMAR P
* CREATED DATE	: 16-08-2018
* MODIFIED		: 
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 16/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export Customer details
* 29/11/2018   S.Moorthi		    ILCRSTPAR2692		  SR	 0 price moved to SFA Application from Sehyog .
* 14-08-2020   S.Mohana				PARLESECS/0820/085	  BZ	 Allowed GT Category for DUmmy retailer
* 20-11-2020   Deepak Philip        PARLECS/1120/097      BZ     Retailer Active Status validation has been removed and And script modified to Upload data on every sync.
*********************************************************************************************************************/
BEGIN
	IF NOT EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
	BEGIN
		DELETE FROM ETL_Prk_Retailer
		DELETE FROM ETL_Prk_RetailerShippingAddress
		DELETE FROM ETL_Prk_RetailerRoute
		DELETE FROM ETL_Prk_RetailerValueClassMap
		INSERT INTO ETL_Prk_Retailer([Retailer Code],[Retailer Name],[Address1],[Address2],[Address3],[Pin Code],[Phone No],[EmailId],[Key Account],[Coverage Mode],[Registration Date],[Day Off],[Status],[Taxable],[Tax Type],[TIN Number],[CST Number],[Tax Group],[Credit Bills],[Credit Limit],[Credit Days],[Cash Discount Percentage],[Cash Discount Condition],[Cash Discount Limit Value],[License Number],[License Number Expiry Date],[Drug License Number],[Drug License Number Expiry Date],[Pesticide License Number],
		[Pesticide License Number Expiry Date],[Geography Hierarchy Value],[Delivery Route Code],[Village Code],[Residence Phone No],[Office Phone No],[Deposit Amount],[Potential Class Code],[Retailer Type],[Retailer Frequency],[Credit Days Alert],[Credit Bills Alert],[Credit Limit Alert]) 
		VALUES ('Dummy','Dummy','Dummy','','','0','1201301401','','NO','Order Booking',CONVERT(varchar(10),GETDATE(),121),'Sunday','Active','Yes','NON VAT','','','RTRINTRA','0','0.00','0','0.00','>=','0.00','',NULL,'',NULL,'',NULL,'','',NULL,'','','0.00',NULL,'Retailer','Weekly','None','None','None')
		UPDATE ETL_Prk_Retailer SET [Delivery Route Code]=(
		SELECT TOP 1 RMCode FROM RouteMaster WHERE RMSRouteType=2 Order by RMId DESC)
		UPDATE ETL_Prk_Retailer SET [Geography Hierarchy Value]=(
		SELECT TOP 1 GeoCode FROM Geography Order by GeoMainId DESC)
		INSERT INTO ETL_Prk_RetailerShippingAddress([Retailer Code],[Address1],[Address2],[Address3],[Retailer Shipping Pin Code],[Retailer Shipping Phone No],[Default Shipping Address])
		VALUES ('Dummy','Dummy','0','0','0','0','YES')
		
		INSERT INTO ETL_Prk_RetailerRoute([Retailer Code],[Route Code],[Selection Type])
		SELECT TOP 1 'Dummy',RMCode,'ADD' FROM RouteMaster WHERE RMSRouteType=1 
		AND RMId IN (SELECT MAX(RMID) AS RMID FROM SalesmanMarket GROUP BY SMId)
		
		INSERT INTO ETL_Prk_RetailerValueClassMap([Retailer Code],[Value Class Code],[Category Level Value],[Selection Type])
		SELECT TOP 1 'Dummy',A.ValueClassCode,B.CtgCode,'ADD' FROM RetailerValueClass A (NOLOCK)
		INNER JOIN RetailerCategory B (NOLOCK) ON A.CtgMainId=B.CtgMainId 
		INNER JOIN RetailerCategory C (NOLOCK) ON B.CtgLinkId = C.CtgMainId AND C.CtgCode ='GT' --PARLESECS/0820/085
		ORDER BY RtrClassId DESC
		EXEC Proc_ValidateRetailerMaster 0
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
		BEGIN
			EXEC Proc_ValidateRetailerValueClassMap 0
			EXEC Proc_ValidateRetailerRoute 0
			EXEC Proc_ValidateRetailerShippingAddress 0 
		END
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy' AND ISNULL(CmpRtrCode,'')<>'Dummy')
		BEGIN
			UPDATE Retailer SET CmpRtrCode='Dummy' WHERE RtrCode='Dummy'
			UPDATE CompanyCounters SET CurrValue = CurrValue-1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
		END  
	END
	DECLARE @Smid AS int
	DECLARE @Sql AS varchar(3000)
	DECLARE @Date AS datetime
	DECLARE @Week AS int
	DECLARE @WCal AS int
	DECLARE @StartDate AS datetime
	DECLARE @EndDate AS datetime
	SELECT @StartDate=JcmSdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @EndDate = JcmEdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @Week=jcwwk FROM JCWeek WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcwSdt AND JcwEdt
	
	SELECT @date=CONVERT(varchar(10),getdate(),121)
	DELETE FROM Export_CS2WS_Customer WHERE UploadFlag='Y'
	
	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailer' and xtype='U')
	BEGIN
		DROP TABLE TempRetailer
	END
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=6)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=6 END 
	IF @Week=2	BEGIN SET @WCal=5 END 
	IF @Week=3	BEGIN SET @WCal=4 END 
	IF @Week=4	BEGIN SET @WCal=3 END
	IF @Week=5	BEGIN SET @WCal=2 END
	IF @Week=6	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=5)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=5 END 
	IF @Week=2	BEGIN SET @WCal=4 END 
	IF @Week=3	BEGIN SET @WCal=3 END 
	IF @Week=4	BEGIN SET @WCal=2 END
	IF @Week=5	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=4)
BEGIN 
	IF @Week=1	BEGIN SET @WCal=4 END 
	IF @Week=2	BEGIN SET @WCal=3 END 
	IF @Week=3	BEGIN SET @WCal=2 END 
	IF @Week=4	BEGIN SET @WCal=1 END 
END 
SET @Sql ='SELECT distinct  DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
	RtrRemark1,RC1.CtgCode AS ChannelCode,RC.CtgCode as GroupCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,CAST('''' AS VARCHAR(100)) AS CustomerPricingKey,0 RmId,RtrCrLimit,0 AS TotalBalanceDue,
	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
	FROM Retailer R 
	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	CROSS JOIN Distributor D'
	EXEC (@Sql)
--SET @Sql ='SELECT DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
--	RtrRemark1,CtgCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,0 AS CustomerPricingKey,RM.RmId,RtrCrLimit,0 AS TotalBalanceDue,
--	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
--	FROM Retailer R 
--	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
--	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
--	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
--	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
--	INNER JOIN RetailerMarket RM ON RM.RtrId=R.RtrId
--	INNER JOIN SalesmanMarket SM ON sm.RMId=RM.RMId
--	CROSS JOIN Distributor D WHERE RtrStatus in(1) AND
--	sm.SMId in('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
--	EXEC (@Sql)
		
	SELECT DISTINCT B.ColumnName,A.ColumnValue,MasterRecordId INTO #TEMPUDCROUTE1
	FROM UdcDetails A,UdcMaster B, UdcHD C WHERE  A.UdcMasterId=B.UdcMasterId
	AND A.MasterId=B.MasterId AND ColumnName='State Name' AND MasterName='Retailer Master'
	
		
	UPDATE T SET [State]=R.ColumnValue FROM TempRetailer T INNER JOIN #TEMPUDCROUTE1 R ON T.rtrid=R.MasterRecordId 
	
	SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	
	
	CREATE TABLE #PricingKey
	(
		CustomerCode	VARCHAR(100),
		CtgCode			VARCHAR(100)
	)
	
		
	SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	GROUP BY PBL.PrdId,PBL.PrdBatId
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT R.CmpRtrCode,R.CmpRtrCode AS CmpRtrCode1 FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.RtrId<>0
	
	UPDATE A SET A.CustomerPricingKey=B.CustomerCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	
	delete from #PricingKey
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT T.CmpRtrCode,R.CtgCode
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.CtgMainId<>0
	
	UPDATE A SET A.CustomerPricingKey=B.CtgCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	WHERE ISNULL(CustomerPricingKey,'')=''
	
	INSERT INTO Export_CS2WS_Customer(TenantCode,LocationCode,CustomerCode,CustomerName,Address1,Address2,Address3,Address4,City,State,Zip,Phone,Fax,Email,ContactPerson,
	Notes,CategoryCode1,CategoryCode2,CategoryCode3,CustomerStatus,SalesMode,PaymentType,CustomerPricingKey,TotalCreditLimit,TotalBalanceDue,
	IsTaxable,TaxID,HierarchyCode,TerritoryHierarchy,SurveyKey,DateofBirth,IDNumber,TINNumber,UploadFlag)
	SELECT DISTINCT  DistributorCode,DistributorCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,'' as Address4,GeoName,State,RtrPinNo,RtrPhoneNo,'' as Fax,RtrEmailId,RtrContactPerson,
	RtrRemark1,ChannelCode,GroupCode,ValueClassCode,CustomerStatus,SalesMode,PaymentType,ISNULL(CustomerPricingKey,''),RtrCrLimit,TotalBalanceDue,IsTaxable,TaxID,GroupCode,'',SurveyKey,DateofBirth,'',RtrTinNo,
	'N' AS UploadFlag FROM TempRetailer R 
	--WHERE NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = R.CmpRtrCode AND R.CustomerPricingKey=M.Reference2 AND M.ProcessName='Customer') 
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'Customer',CustomerCode,CustomerName,GETDATE(),0,LocationCode,CustomerPricingKey,CategoryCode2,0 FROM Export_CS2WS_Customer WHERE UploadFlag='N'
	 
	
	UPDATE R SET R.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.MasterCode=R.CmpRtrCode
	WHERE ISNULL(R.WSUpload,'N')='N' AND ProcessName='Customer'
		
	SELECT	DISTINCT TenantCode,LocationCode,CustomerCode,CustomerName,Address1,Address2,Address3,Address4,City,State,	Zip,Phone,Fax,Email,ContactPerson,Notes,CategoryCode1,
	CategoryCode2,CategoryCode3,CustomerStatus,SalesMode,PaymentType,CustomerPricingKey,TotalCreditLimit,TotalBalanceDue,IsTaxable,TaxID,HierarchyCode,
	TerritoryHierarchy,SurveyKey,DateofBirth,IDNumber,TINNumber FROM Export_CS2WS_Customer WITH (NOLOCK)
	
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Fn_CheckMonthEnd' AND TYPE='FN')
DROP FUNCTION Fn_CheckMonthEnd
GO
--SELECT DBO.Fn_CheckMonthEnd(2020,4,2,504)
CREATE FUNCTION Fn_CheckMonthEnd (@Pi_Year INT,@Pi_Month INT,@Pi_UsrId INT,@Pi_TransId INT)  
RETURNS VARCHAR(500)   
AS  
/*******************************************************************************************************************  
* PROCEDURE : Fn_CheckMonthEnd    
* PURPOSE : To validate month end details before generating debit note top sheet report  
* NOTES  :    
* CREATED : S.MOHANA   
* DATE  : 18-11-2019  
* PMS  : CRCRSTPAR0079 
* 28-02-2020  MOHANA S  SR ILCRSTPAR8064 enabled the validation
* DATE				 AUTHOR				CR\BUG	UserStorageID		DESCRIPTION
------------------------------------------------------------------------------------------------
* 18/05/2020		 S.MOORTHI			  CR	PARCS202100019		Target achievement should be calculated in the Core Stocky   
* 17-11-2020         Deepak Philip        BZ    PARLECS/1120/083    Month End status has been checked. 
**********************************************************************************************************************/  
BEGIN  
	DECLARE @ValidateMsg AS VARCHAR(500)  
	DECLARE @MonthEndDt AS DATETIME  
	DECLARE @FromDate  DATETIME  
	DECLARE @ToDate    DATETIME  
		SET  @ValidateMsg  = ''  
		SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))  
		SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))  
		IF @Pi_Month =0
		BEGIN
		SET @ValidateMsg='Seleted Month Period Date format not correct. Hence Debit Note Top Sheet Claim Cannot generate' 
		END
		IF @Pi_Year =0
		BEGIN
		SET @ValidateMsg='Seleted Year Date format not correct. Hence Debit Note Top Sheet Claim Cannot generate' 
		END
		IF EXISTS(SELECT * FROM JCMonthEnd)  
		BEGIN  
			SELECT @MonthEndDt=MAX(JcmEdt) FROM JCMonthEnd  Where Status=1
			IF @ToDate>@MonthEndDt  
			BEGIN  
				SET @ValidateMsg='Month end not completed for selected period . Hence Debit Note Top Sheet Claim Cannot generate'  
			END  
		END  
		IF @FromDate <='2019-11-30' 
		BEGIN  
		SET @ValidateMsg='Debit Note top sheet can be Genearte after dated on 01-12-2019'  
		END  
		--TARGET DOWNLOAD ISSUE
		IF @ValidateMsg = ''   
		BEGIN  
		IF @Pi_Month = 4 AND @Pi_Year = 2020
		BEGIN
				IF EXISTS (SELECT * FROM Distributor WHERE DISTRIBUTORCODE IN
							('1000006','1000009','1000010','1000016','1000022','1000026','1000027','1000033','1000040','1000048','1000050','1000068','1000069','1000074','1000078','1000079',
							'1000082','1000088','1000093','1000103','1000104','1000105','1000107','1000109','1000112','1000117','1000124','1000132','1000137','1000141','1000149','1000150',
							'1000156','1000164','1000169','1000173','1000175','1000178','1000190','1000191','1000199','1000206','1000207','1000210','1000224','1000228','1000247','1000252',
							'1000261','1000266','1000272','1000280','1000290','1000295','1000301','1000302','1000303','1000305','1000311','1000312','1000314','1000319','1000325','1000327',
							'1000331','1000333','1000334','1000341','1000342','1000352','1000353','1000355','1000370','1000373','1000374','1000384','1000392','1000401','1000404','1000417',
							'1000420','1000425','1000429','1000431','1000448','1000449','1000450','1000460','1000464','1000476','1000479','1000481','1000484','1000491','1000494','1000501',
							'1000502','1000503','1000504','1000506','1000509','1000511','1000514','1000517','1000520','1000521','1000522','1000524','1000527','1000528','1000530','1000539',
							'1000548','1000551','1000554','1000555','1000558','1000560','1000562','1000564','1000570','1000575','1000577','1000591','1000592','1000598','1000601','1000602',
							'1000609','1000610','1000640','1000649','1000660','1000665','1000666','1000674','1000678','1000689','1000708','1000712','1000716','1000717','1000721','1000722',
							'1000723','1000724','1000739','1000742','1000743','1000746','1000756','1000757','1000763','1000767','1000771','1000772','1000773','1000774','1000775','1000779',
							'1000790','1000810','1000813','1000815','1000816','1000831','1000837','1000842','1000846','1000847','1000859','1000862','1000864','1000873','1000882','1000883',
							'1000899','1000906','1000913','1000931','1000938','1000944','1000948','1000949','1000954','1000956','1000959','1000962','1000965','1000968','1000971','1000973',
							'1000982','1000986','1000997','1001006','1001012','1001013','1001016','1001031','1001032','1001038','1001048','1001065','1001066','1001081','1001087','1001091',
							'1001094','1001095','1001098','1001100','1001109','1001113','1001123','1001124','1001132','1001136','1001141','1001142','1001143','1001145','1001146','1001147',
							'1001151','1001152','1001160','1001161','1001174','1001195','1001202','1001219','1001223','1001242','1001243','1001252','1001260','1001264','1001265','1001267',
							'1001277','1001286','1001291','1001296','1001297','1001304','1001307','1001310','1001311','1001313','1001317','1001324','1001335','1001343','1001344','1001351',
							'1001361','1001380','1001384','1001389','1001393','1001395','1001403','1001417','1001421','1001427','1001434','1001437','1001441','1001442','1001443','1001444',
							'1001447','1001453','1001458','1001459','1001460','1001464','1001468','1001469','1001470','1001491','1001499','1001508','1001523','1001529','1001531','1001534',
							'1001536','1001538','1001549','1001550','1001551','1001556','1001558','1001560','1001561','1001574','1001583','1001585','1001587','1001588','1001598','1001614',
							'1001616','1001618','1001622','1001623','1001624','1001634','1001635','1001652','1001656','1001668','1001670','1001671','1001676','1001678','1001689','1001695',
							'1001728','1001730','1001733','1001735','1001745','1001755','1001769','1001777','1001782','1001783','1001785','1001789','1001790','1001792','1001798','1001801',
							'1001802','1001803','1001815','1001818','1001819','1001828','1001831','1001835','1001837','1001838','1001844','1001846','1001854','1001861','1001867','1001873',
							'1001875','1001876','1001884','1001896','1001906','1001908','1001917','1001919','1001923','1001931','1001944','1001951','1001952','1001955','1001956','1001958',
							'1001961','1001972','1001974','1001976','1001977','1001978','1002002','1002003','1002004','1002006','1002007','1002009','1002013','1002014','1002016','1002018',
							'1002020','1002026','1002028','1002034','1002037','1002041','1002042','1002044','1002051','1002055','1002057','1002064','1002070','1002072','1002074','1002076',
							'1002090','1002093','1002094','1002097','1002098','1002112','1002115','1002116','1002118','1002120','1002124','1002126','1002128','1002130','1002132','1002133',
							'1002134','1002135','1002136','1002140','1002144','1002148','1002149','1002159','1002160','1002166','1002170','1002172','1002173','1002175','1002183','1002187',
							'1002188','1002192','1002193','1002194','1002199','1002204','1002210','1002216','1002220','1002221','1002225','1002226','1002227','1002229','1002230','1002231',
							'1002235','1002238','1002240','1002249','1002251','1002256','1002259','1002264','1002267','1002269','1002270','1002271','1002276','1002287','1002290','1002291',
							'1002295','1002299','1002300','1002301','1002302','1002303','1002306','1002307','1002313','1002318','1002320','1002322','1002326','1002333','1002337','1002342',
							'1002349','1002352','1002360','1002361','1002365','1002366','1002367','1002370','1002372','1002374','1002378','1002381','1002382','1002394','1002398','1002399',
							'1002405','1002406','1002407','1002411','1002412','1002413','1002415','1002416','1002417','1002418','1002419','1002420','1002421','1002423','1002446','1002449',
							'1002459','1002481','1002484','1002486','1002487','1002490','1002512','1002522','1002526','1002527','1002528','1002530','1002532','1002533','1002535','1002544',
							'1002548','1002553','1002556','1002570','1002576','1002577','1002580','1002587','1002591','1002592','1002602','1002606','1002607','1002615','1002617','1002618',
							'1002619','1002620','1002622','1002624','1002633','1002634','1002635','1002637','1002638','1002642','1002646','1002654','1002655','1002661','1002664','1002668',
							'1002673','1002674','1002675','1002677','1002678','1002679','1002682','1002683','1002685','1002686','1002691','1002701','1002702','1002704','1002713','1002718',
							'1002720','1002724','1002728','1002729','1002731','1002734','1002736','1002739','1002742','1002743','1002745','1002746','1002747','1002749','1002753','1002754',
							'1002757','1002764','1002772','1002774','1002775','1002776','1002787','1002788','1002792','1002795','1002798','1002803','1002804','1002805','1002806','1002807',
							'1002811','1002815','1002816','1002820','1002821','1002822','1002824','1002825','1002828','1002830','1002836','1002838','1002839','1002844','1002847','1002852',
							'1002863','1002866','1002877','1002891','1002906','1002914','1002922','1002937','1002951','1002957','1002959','1002965','1002973','1002974','1002986','1002993',
							'1002994','1002999','1003006','1003015','1003024','1003037','1003038','1003039','1003040','1003054','1003058','1003061','1003076','1003082','1003083','1003093',
							'1003096','1003098','1003100','1003101','1003112','1003114','1003117','1003123','1003136','1003142','1003152','1003153','1003157','1003158','1003177','1003183',
							'1003194','1003206','1003215','1003222','1003224','1003226','1003230','1003239','1003240','1003242','1003243','1003256','1003257','1003272','1003273','1003276',
							'1003281','1003284','1003291','1003294','1003298','1003299','1003302','1003306','1003308','1003316','1003327','1003330','1003332','1003333','1003335','1003337',
							'1003338','1003342','1003353','1003392','1003393','1003395','1003407','1003409','1003410','1003433','1003452','1003454','1003458','1003459','1003462','1003463',
							'1003464','1003468','1003485','1003488','1003489','1003495','1003505','1003512','1003521','1003525','1003540','1003543','1003556','1003561','1003564','1003571',
							'1003577','1003584','1003586','1003591','1003592','1003595','1003599','1003609','1003615','1003624','1003629','1003642','1003645','1003649','1003655','1003660',
							'1003663','1003676','1003697','1003698','1003708','1003710','1003718','1003719','1003724','1003729','1003733','1003737','1003747','1003757','1003779','1003791',
							'1003794','1003795','1003803','1003810','1003812','1003820','1003821','1003825','1003858','1003864','1003870','1003893','1003899','1003905','1003907','1003909',
							'1003914','1003918','1003930','1003933','1003934','1003937','1003964','1003966','1003973','1003975','1003981','1004001','1004003','1004009','1004016','1004034',
							'1004043','1004044','1004055','1004072','1004074','1004081','1004088','1004099','1004101','1004107','1004112','1004114','1004121','1004130','1004134','1004147',
							'1004148','1004155','1004161','1004162','1004175','1004184','1004191','1004207','1004212','1004220','1004235','1004238','1004249','1004252','1004254','1004255',
							'1004279','1004284','1004292','1004299','1004303','1004304','1004325','1004337','1004345','1004356','1004358','1004362','1004372','1004381','1004393','1004395',
							'1004397','1004405','1004407','1004425','1004448','1004453','1004457','1004476','1004478','1004495','1004505','1004506','1004516','1004521','1004524','1004531',
							'1004532','1004579','1004583','1004586','1004592','1004600','1004608','1004617','1004619','1004624','1004633','1004644','1004652','1004656','1004660','1004663',
							'1004674','1004675','1004676','1004677','1004679','1004681','1004683','1004684','1004685','1004686','1004688','1004690','1004692','1004693','1004695','1004696',
							'1004699','1004701','1004707','1004708','1004710','1004719','1004721','1004724','1004727','1004728','1004729','1004732','1004735','1004736','1004739','1004746',
							'1004747','1004748','1004751','1004752','1004753','1004754','1004760','1004762','1004763','1004764','1004765','1004766','1004768','1004784','1004786','1004790',
							'1004795','1004796','1004798','1004801','1004803','1004809','1004812','1004813','1004814','1004819','1004844','1004846','1004848','1004851','1004853','1004857',
							'1004858','1004860','1004865','1004866','1004873','1004879','1004882','1004889','1004890','1004892','1004893','1004898','1004902','1004907','1004909','1004911',
							'1004912','1004913','1004914','1004918','1004919','1004921','1004924','1004925','1004926','1004931','1004933','1004944','1004950','1004951','1004953','1004955',
							'1004957','1004958','1004963','1004965','1004967','1004968','1004970','1004975','1004977','1004979','1004980','1004981','1004983','1004985','1004986','1004989',
							'1004996','1005000','1005005','1005014','1005024','1005027','1005033','1005039','1005047','1005052','1005055','1005058','1005064','1005074','1005077','1005078',
							'1005089','1005098','1005099','1005112','1005113','1005117','1005118','1005119','1005120','1005121','1005122','1005126','1005131','1005133','1005138','1005140',
							'1005141','1005142','1005147','1005149','1005150','1005157','1005158','1005164','1005165','1005169','1005172','1005173','1005180','1005184','1005194','1005199',
							'1005203','1005207','1005215','1005218','1005223','1005224','1005228','1005230','1005231','1005234','1005237','1005242','1005250','1005267','1005269','1005270',
							'1005278','1005282','1005285','1005287','1005288','1005289','1005297','1005305','1005306','1005308','1005311','1005320','1005324','1005328','1005330','1005331',
							'1005332','1005335','1005336','1005337','1005339','1005340','1005348','1005352','1005354','1005360','1005364','1005365','1005371','1005390','1005394','1005401',
							'1005403','1005408','1005409','1005412','1005413','1005418','1005420','1005423','1005427','1005433','1005435','1005436','1005439','1005444','1005446','1005448',
							'1005450','1005453','1005454','1005455','1005458','1005460','1005461','1005463','1005471','1005475','1005477','1005484','1005488','1005491','1005495','1005496',
							'1005500','1005501','1005504','1005506','1005510','1005511','1005512','1005517','1005518','1005519','1005520','1005521','1005522','1005527','1005528','1005531',
							'1005533','1005538','1005541','1005543','1005546','1005550','1005555','1005558','1005559','1005562','1005563','1005565','1005567','1005569','1005574','1005575',
							'1005577','1005583','1005587','1005589','1005591','1005592','1005593','1005600','1005601','1005602','1005605','1005621','1005625','1005628','1005629','1005634',
							'1005640','1005641','1005644','1005653','1005659','1005661','1005662','1005665','1005666','1005667','1005668','1005669','1005672','1005673','1005685','1005686',
							'1005689','1005691','1005692','1005693','1005694','1005696','1005699','1005715','1005718','1005719','1005721','1005722','1005723','1005724','1005726','1005727',
							'1005728','1005729','1005732','1005733','1005736','1005737','1005739','1005740','1005742','1005743','1005746','1005747','1005752','1005754','1005756','1005759',
							'1005760','1005761','1005766','1005773','1005775','1005791','1005798','1005801','1005808','1005809','1005810','1005811','1005816','1005819','1005821','1005824',
							'1005829','1005832','1005834','1005837','1005840','1005844','1005847','1005848','1005852','1005853','1005855','1005856','1005860','1005861','1005862','1005864',
							'1005866','1005867','1005875','1005876','1005881','1005882','1005884','1005885','1005887','1005888','1005889','1005890','1005891','1005893','1005899','1005902',
							'1005908','1005913','1005915','1005919','1005920','1005921','1005922','1005925','1005926','1005927','1005929','1005930','1005934','1005935','1005936','1005949',
							'1005959','1005962','1005963','1005964','1005968','1005971','1005973','1005976','1005978','1005980','1005981','1005985','1006001','1006008','1006009','1006010',
							'1006023','1006024','1006027','1006033','1006036','1006041','1006072','1006074','1006075','1006079','1006085','1006092','1006097','1006098','1006113','1006116',
							'1006125','1006128','1006129','1006145','1006163','1006166','1006177','1006211','1006213','1006220','1006221','1006225','1006246','1006250','1006255','1006262',
							'1006279','1006287','1006290','1006291','1006292','1006295','1006296','1006302','1006303','1006310','1006317','1006329','1006341','1006366','1006400','1006402',
							'1006404','1006405','1006407','1006413','1006416','1006429','1006447','1006449','1006481','1006483','1006488','1006489','1006490','1006505','1006506','1006507',
							'1006521','1006524','1006528','1006561','1006565','1006579','1006586','1006589','1006590','1006592','1006596','1006606','1006613','1006614','1006617','1006621',
							'1006625','1006639','1006650','1006651','1006665','1006690','1006695','1006696','1006697','1006701','1006703','1006718','1006729','1006730','1006731','1006736',
							'1006757','1006760','1006770','1006779','1006780','1006786','1006788','1006818','1006837','1006842','1006847','1006848','1006863','1006866','1006872','1006876',
							'1006893','1006896','1006898','1006907','1006915','1006919','1006920','1006925','1006926','1006929','1006933','1006936','1006945','1006946','1006953','1006954',
							'1006955','1006959','1006960','1006978','1006980','1006984','1006987','1007000','1007005','1007027','1007031','1007032','1007034','1007037','1007038','1007053',
							'1007057','1007071','1007074','1007077','1007086','1007092','1007099','1007102','1007107','1007110','1007113','1007114','1007116','1007119','1007139','1007141',
							'1007144','1007146','1007148','1007151','1007169','1007180','1007192','1007195','1007214','1007217','1007227','1007232','1007233','1007237','1007244','1007254',
							'1007256','1007260','1007269','1007270','1007272','1007273','1007276','1007291','1007302','1007304','1007305','1007306','1007307','1007316','1007332','1007341',
							'1007342','1007344','1007350','1007355','1007358','1007361','1007366','1007370','1007371','1007372','1007373','1007391','1007392','1007396','1007401','1007412',
							'1007421','1007427','1007429','1007430','1007439','1007465','1007471','1007472','1007474','1007477','1007482','1007486','1007488','1007495','1007496','1007502',
							'1007509','1007518','1007529','1007534','1007540','1007557','1007559','1007561','1007569','1007577','1007608','1007616','1007619','1007628','1007630','1007631',
							'1007635','1007645','1007648','1007649','1007650','1007659','1007662','1007665','1007666','1007672','1007678','1007681','1007682','1007683','1007689','1007694',
							'1007704','1007717','1007719','1007721','1007724','1007741','1007744','1007752','1007754','1007755','1007758','1007767','1007768','1007773','1007775','1007784',
							'1007786','1007788','1007791','1007832','1007842','1007843','1007846','1007847','1007851','1007858','1007859','1007876','1007883','1007884','1007893','1007894',
							'1007895','1007899','1007901','1007902','1007920','1007924','1007926','1007943','1007944','1007955','1007959','1007962','1007968','1007969','1007971','1007978',
							'1007990','1007999','1008001','1008004','1008013','1008014','1008016','1008017','1008018','1008024','1008034','1008040','1008041','1008043','1008044','1008058',
							'1008060','1008064','1008080','1008085','1008091','1008103','1008111','1008112','1008119','1008130','1008132','1008136','1008141','1008144','1008151','1008157',
							'1008181','1008182','1008183','1008187','1008189','1008197','1008200','1008201','1008204','1008205','1008208','1008210','1008216','1008217','1008218','1008220',
							'1008221','1008222','1008224','1008233','1008238','1008240','1008246','1008259','1008266','1008270','1008275','1008276','1008279','1008281','1008284','1008285',
							'1008286','1008287','1008289','1008301','1008303','1008311','1008314','1008315','1008318','1008319','1008328','1008329','1008332','1008352','1008358','1008359',
							'1008363','1008364','1008367','1008368','1008381','1008382','1008386','1008387','1008425','1008426','1008432','1008437','1008441','1008457','1008461','1008471',
							'1008478','1008485','1008505','1008516','1008518','1008520','1008521','1008524','1008530','1008535','1008538','1008541','1008542','1008554','1008556','1008572',
							'1008576','1008577','1008578','1008590','1008593','1008594','1008599','1008600','1008611','1008620','1008628','1008630','1008632','1008633','1008639','1008642',
							'1008644','1008660','1008662','1008663','1008680','1008681','1008687','1008688','1008705','1008722','1008726','1008732','1008736','1008751','1008759','1008762',
							'1008769','1008780','1008791','1008795','1008797','1008799','1008802','1008804','1008807','1008809','1008813','1008817','1008818','1008819','1008820','1008839',
							'1008855','1008857','1008867','1008868','1008869','1008887','1008889','1008891','1008893','1008894','1008899','1008901','1008904','1008907','1008912','1008915',
							'1008925','1008936','1008937','1008938','1008939','1008941','1008949','1008950','1008952','1008953','1008955','1008966','1008974','1008976','1008993','1008996',
							'1009001','1009020','1009036','1009037','1009040','1009041','1009043','1009047','1009050','1009068','1009069','1009070','1009092','1009094','1009109','1009122',
							'1009129','1009130','1009140','1009141','1009142','1009144','1009161','1009163','1009165','1009167','1009169','1009176','1009182','1009192','1009198','1009199',
							'1009211','1009212','1009232','1009233','1009236','1009238','1009239','1009249','1009254','1009256','1009261','1009263','1009277','1009278','1009279','1009280',
							'1009286','1009287','1009290','1009298','1009299','1009300','1009303','1009307','1009309','1009327','1009330','1009334','1009337','1009341','1009354','1009364',
							'1009365','1009366','1009376','1009379','1009383','1009387','1009392','1009393','1009401','1009402','1009406','1009416','1009421','1009425','1009427','1009447',
							'1009450','1009451','1009457','1009460','1009464','1009467','1009476','1009491','1009505','1009508','1009511','1009521','1009528','1009531','1009532','1009540',
							'1009548','1009554','1009558','1009568','1009570','1009572','1009574','1009575','1009588','1009592','1009593','1009596','1009598','1009605','1009606','1009610',
							'1009616','1009619','1009622','1009636','1009640','1009642','1009647','1009648','1009650','1009651','1009661','1009662','1009663','1009664','1009677','1009683',
							'1009691','1009696','1009699','1009705','1009708','1009712','1009723','1009726','1009727','1009731','1009733','1009736','1009738','1009739','1009740','1009752',
							'1009770','1009773','1009776','1009777','1009778','1009780','1009790','1009804','1009805','1009817','1009824','1009828','1009831','1009834','1009835','1009839',
							'1009840','1009844','1009851','1009853','1009864','1009867','1009871','1009873','1009877','1009878','1009880','1009882','1009896','1009897','1009900','1009907',
							'1009908','1009914','1009936','1009937','1009941','1009942','1009949','1009950','1009952','1009954','1009955','1009956','1009957','1009960','1009963','1009974',
							'1009975','1009983','1009984','1009985','1009986','1009992','1009994','1009996','1009998','1009999','1010001','1010011','1010030','1010031','1010037','1010042',
							'1010043','1010048','1010051','1010069','1010082','1010083','1010084','1010092','1010102','1010108','1010128','1010131','1010136','1010139','1010145','1010148',
							'1010156','1010160','1010169','1010181','1010182','1010183','1010190','1010192','1010197','1010199','1010200','1010211','1010215','1010217','1010220','1010236',
							'1010244','1010248','1010249','1010250','1010251','1010255','1010259','1010261','1010262','1010263','1010265','1010267','1010270','1010271','1010273','1010275',
							'1010288','1010289','1010294','1010295','1010296','1010300','1010306','1010309','1010311','1010317','1010318','1010319','1010320','1010324','1010327','1010329',
							'1010330','1010333','1010334','1010338','1010339','1010351','1010355','1010365','1010369','1010376','1010377','1010378','1010380','1010386','1010388','1010390',
							'1010399','1010400','1010407','1010412','1010415','1010417','1010419','1010420','1010421','1010426','1010435','1010444','1010445','1010446','1010451','1010462',
							'1010463','1010466','1010467','1010468','1010469','1010470','1010471','1010475','1010476','1010479','1010487','1010488','1010492','1010494','1010495','1010496',
							'1010497','1010498','1010499','1010503','1010504','1010513','1010514','1010515','1010518','1010532','1010534','1010538','1010539','1010543','1010545','1010546',
							'1010547','1010552','1010553','1010565','1010578','1010581','1010582','1010585','1010586','1010587','1010589','1010591','1010594','1010595','1010602','1010605',
							'1010611','1010612','1010614','1010619','1010628','1010629','1010638','1010641','1010645','1010650','1010658','1010672','1010674','1010676','1010680','1010681',
							'1010682','1010683','1010685','1010686','1010694','1010697','1010700','1010710','1010714','1010716','1010727','1010731','1010732','1010733','1010734','1010735',
							'1010738','1010739','1010740','1010741','1010742','1010743','1010745','1010747','1010754','1010762','1010763','1010767','1010770','1010771','1010772','1010774',
							'1010776','1010778','1010780','1010783','1010785','1010787','1010788','1010789','1010797','1010798','1010803','1010807','1010810','1010813','1010817','1010818',
							'1010819','1010820','1010821','1010822','1010835','1010841','1010846','1010849','1010850','1010861','1010865','1010868','1010870','1010876','1010878','1010879',
							'1010880','1010885','1010892','1010893','1010895','1010897','1010898','1010911','1010913','1010914','1010915','1010916','1010917','1010918','1010919','1010921',
							'1010922','1010926','1010928','1010934','1010936','1010939','1010940','1010942','1010945','1010948','1010960','1010973','1010975','1010984','1010986','1010987',
							'1010988','1010989','1010990','1010992','1010997','1010998','1011002','1011007','1011019','1011022','1011024','1011025','1011027','1011029','1011030','1011033',
							'1011036','1011037','1011044','1011045','1011053','1011058','1011063','1011071','1011082','1011083','1011086','1011090','1011094','1011098','1011102','1011103',
							'1011112','1011126','1011127','1011128','1011129','1011141','1011151','1011155','1011161','1011167','1011174','1011178','1011186','1011193','1011194','1011195',
							'1011205','1011207','1011209','1011216','1011220','1011226','1011232','1011234','1011235','1011241','1011245','1011251','1011253','1011254','1011256','1011264',
							'1011268','1011269','1011273','1011274','1011277','1011278','1011281','1011284','1011294','1011306','1011310','1011320','1011325','1011331','1011334','1011335',
							'1011340','1011342','1011345','1011346','1011365','1011369','1011375','1011376','1011391','1011393','1011394','1011396','1011402','1011403','1011405','1011407',
							'1011413','1011418','1011419','1011422','1011423','1011425','1011431','1011435','1011436','1011437','1011439','1011440','1011443','1011447','1011454','1011463',
							'1011467','1011468','1011469','1011480','1011487','1011496','1011497','1011499','1011502','1011512','1011514','1011517','1011524','1011530','1011535','1011541',
							'1011543','1011544','1011545','1011551','1011553','1011560','1011564','1011565','1011568','1011577','1011586','1011587','1011602','1011603','1011604','1011607',
							'1011611','1011612','1011615','1011616','1011617','1011619','1011620','1011621','1011623','1011624','1011627','1011630','1011638','1011639','1011642','1011647',
							'1011650','1011651','1011652','1011653','1011655','1011659','1011666','1011670','1011671','1011679','1011681','1011682','1011683','1011684','1011686','1011688',
							'1011692','1011693','1011697','1011711','1011721','1011722','1011723','1011724','1011725','1011726','1011728','1011737','1011738','1011744','1011754','1011755',
							'1011756','1011757','1011758','1011760','1011768','1011772','1011774','1011784','1011792','1011798','1011801','1011805','1011810','1011814','1011815','1011818',
							'1011820','1011822','1011823','1011826','1011831','1011833','1011838','1011840','1011842','1011844','1011845','1011857','1011872','1011876','1011877','1011879',
							'1011883','1011884','1011886','1011887','1011890','1011891','1011892','1011895','1011896','1011897','1011898','1011899','1011901','1011906','1011909','1011915',
							'1011916','1011922','1011923','1011925','1011934','1011936','1011937','1011939','1011942','1011944','1011949','1011951','1011953','1011961','1011969','1011978',
							'1011981','1011982','1011992','1011993','1011994','1011995','1011998','1012001','1012005','1012006','1012007','1012008','1012012','1012017','1012019','1012025',
							'1012031','1012033','1012034','1012042','1012046','1012049','1012052','1012057','1012058','1012060','1012062','1012064','1012066','1012067','1012073','1012085',
							'1012087','1012088','1012089','1012090','1012094','1012102','1012105','1012107','1012110','1012111','1012116','1012117','1012123','1012126','1012129','1012131',
							'1012141','1012152','1012156','1012159','1012162','1012163','1012165','1012166','1012168','1012170','1012174','1012181','1012186','1012187','1012188','1012191',
							'1012195','1012196','1012197','1012204','1012205','1012210','1012215','1012219','1012220','1012227','1012228','1012231','1012234','1012235','1012236','1012247',
							'1012250','1012252','1012259','1012262','1012264','1012280','1012289','1012291','1012292','1012294','1012296','1012297','1012298','1012299','1012300','1012302',
							'1012303','1012305','1012308','1012310','1012317','1012318','1012319','1012321','1012323','1012324','1012325','1012326','1012327','1012328','1012329','1012330',
							'1012332','1012333','1012334','1012343','1012344','1012347','1012349','1012350','1012353','1012356','1012361','1012364','1012366','1012368','1012370','1012371',
							'1012372','1012373','1012375','1012376','1012378','1012379','1012380','1012384','1012391','1012392','1012394','1012397','1012398','1012401','1012402','1012403',
							'1012404','1012407','1012409','1012411','1012413','1012414','1012423','1012424','1012425','1012429','1012430','1012432','1012435','1012437','1012439','1012441',
							'1012446','1012447','1012448','1012453','1012454','1012457','1012458','1012460','1012464','1012465','1012469','1012472','1012473','1012474','1012475','1012476',
							'1012477','1012478','1012479','1012480','1012484','1012487','1012503','1012504','1012505','1012511','1012512','1012513','1012514','1012516','1012517','1012521',
							'1012522','1012525','1012526','1012528','1012531','1012536','1012538','1012539','1012540','1012543','1012545','1012552','1012554','1012555','1012556','1012557',
							'1012558','1012560','1012562','1012565','1012569','1012571','1012572','1012575','1012576','1012581','1012582','1012586','1012587','1012589','1012591','1012598',
							'1012599','1012603','1012604','1012605','1012611','1012612','1012613','1012615','1012618','1012621','1012625','1012626','1012628','1012630','1012634','1012635',
							'1012640','1012641','1012642','1012644','1012647','1012648','1012650','1012652','1012654','1012655','1012661','1012666','1012667','1012668','1012674','1012675',
							'1012677','1012679','1012682','1012683','1012686','1012688','1012690','1012694','1012696','1012697','1012701','1012702','1012703','1012704','1012705','1012707',
							'1012726','1012727','1012728','1012729','1012730','1012731','1012733','1012739','1012741','1012749','1012750','1012753','1012754','1012757','1012758','1012760',
							'1012767','1012769','1012773','1012775','1012778','1012786','1012787','1012789','1012794','1012796','1012799','1012801','1012806','1012807','1012809','1012814',
							'1012821','1012823','1012825','1012829','1012830','1012840','1012847','1012849','1012850','1012851','1012854','1012858','1012859','1012860','1012861','1012864',
							'1012871','1012872','1012873','1012876','1012879','1012880','1012881','1012882','1012886','1012890','1012895','1012896','1012901','1012903','1012904','1012905',
							'1012911','1012916','1012918','1012919','1012920','1012927','1012928','1012931','1012935','1012936','1012937','1012941','1012942','1012944','1012945','1012946',
							'1012949','1012950','1012951','1012956','1012959','1012960','1012963','1012969','1012977','1012978','1012979','1012981','1012982','1012987','1012994','1012996',
							'1012997','1012998','1012999','1013000','1013002','1013005','1013006','1013009','1013011','1013013','1013014','1013016','1013018','1013021','1013027','1013029',
							'1013034','1013037','1013044','1013052','1013057','1013058','1013059','1013062','1013063','1013064','1013066','1013069','1013072','1013075','1013077','1013078',
							'1013079','1013083','1013084','1013090','1013091','1013092','1013093','1013094','1013100','1013111','1013112','1013117','1013121','1013122','1013123','1013131',
							'1013132','1013134','1013135','1013139','1013140','1013146','1013150','1013151','1013152','1013154','1013162','1013163','1013164','1013165','1013172','1013173',
							'1013183','1013187','1013188','1013189','1013190','1013191','1013196','1013200','1013201','1013204','1013226','1013227','1013231','1013232','1013233','1013237',
							'1013238','1013239','1013246','1013249','1013254','1013255','1013257','1013259','1013271','1013273','1013274','1013276','1013277','1013278','1013279','1013282',
							'1013283','1013284','1013285','1013291','1013292','1013294','1013295','1013296','1013298','1013301','1013302','1013303','1013307','1013309','1013310','1013317',
							'1013319','1013321','1013322','1013324','1013334','1013335','1013337','1013351','1013353','1013354','1013371','1013372','1013373','1013374','1013375','1013381',
							'1013382','1013387','1013388','1013389','1013390','1013391','1013394','1013397','1013398','1013399','1013400','1013412','1013415','1013416','1013419','1013420',
							'1013421','1013425','1013426','1013430','1013434','1013438','1013441','1013442','1013443','1013444','1013445','1013446','1013457','1013458','1013459','1013460',
							'1013463','1013464','1013465','1013466','1013471','1013474','1013477','1013483','1013485','1013490','1013491','1013506','1013507','1013511','1013515','1013516',
							'1013520','1013521','1013523','1013529','1013530','1013535','1013538','1013540','1013541','1013542','1013543','1013544','1013545','1013547','1013554','1013555',
							'1013556','1013557','1013558','1013559','1013560','1013561','1013567','1013572','1013573','1013575','1013579','1013589','1013590','1013604','1013605','1013608',
							'1013609','1013610','1013613','1013618','1013626','1013627','1013630','1013646','1013650','1013654','1013655','1013660','1013665','1013668','1013672','1013678',
							'1013682','1013683','1013687','1013691','1013702','1013703','1013707','1013727','1013728','1013729','1013730','1013735','1013743','1013745','1013747','1013748',
							'1013749','1013752','1013760','1013762','1013778','1013779','1013780','1013784','1013786','1013787','1013789','1013790','1013806','1013808','1013809','1013813',
							'1013816','1013819','1013821','1013853','1013866','1013868','1013869','1013870','1013871','1013876','1013877','1013878','1013879','1013885','1013887','1013901',
							'1013906','1013908','1013911','1013916','1013928','1013929','1013941','1013954','1013961','1013963','1013964','1013968','1013976','1013977','1013987','1013996',
							'1014014','1014015','1014016','1014025','1014036','1014045','1014047','1014051','1014052','1014057','1014083','1014091','2000002','2000083','2000095','2000505',
							'2000581','2000609','2000641','2000654','2000658','2000745','2000813','2000851','2000891','2000899','2000937','2001269','2001312','2001399','2001453','2001471',
							'2001681','2001848','2002005','2002098','2002303','2002323','2002343','2002379','2002403','2002632','2002747','2002752','2002764','2002770','2002776','2002806',
							'2002808','2002838','2002842','2002861','2003011','2003116','2003196','2003272','2003330','2003398','2003436','2003531','2003647','3000065','3000074','3000075',
							'3000085','3000151','3000166','3000179','3000187','3000189','3000194','3000204','3000356','3000397'))
				BEGIN
					IF NOT EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid     
					WHERE A.targetmonth =4 AND A.TargetYear =2020 and A.Status =1 AND InsRefNo='Target0112')  
					BEGIN  
				  
						SET @ValidateMsg='Target Not Download From Console for Selected Month.' + CHAR(13) +  
							'Hence Debit Note Top Sheet Claim Cannot generate'    
					END 
				END
			END
		END  
		IF @ValidateMsg = ''   
		BEGIN
			IF @Pi_Month = 4 AND @Pi_Year = 2020
			BEGIN
				IF EXISTS (SELECT * FROM Distributor WHERE DistributorCode IN ('1000016','1000022','1000069','1000074','1000109','1000117','1000137','1000156','1000175','1000193','1000222','1000333','1000342','1000362','1000431','1000554',
				'1000558','1000666','1000790','1001124','1001132','1001142','1001146','1001147','1001151','1001202','1001212','1001226','1001313','1001380','1001384','1001460',
				'1001489','1001508','1001536','1001588','1001671','1001689','1001784','1002016','1002026','1002033','1002042','1002055','1002072','1002130','1002173','1002220',
				'1002227','1002231','1002256','1002291','1002299','1002307','1002313','1002320','1002381','1002410','1002437','1002553','1002576','1002599','1002638','1002642',
				'1002675','1002685','1002704','1002720','1002722','1002772','1002773','1002787','1002811','1002816','1002825','1002844','1002854','1002898','1002902','1002940',
				'1002993','1002995','1002999','1003015','1003038','1003071','1003112','1003227','1003230','1003239','1003273','1003291','1003337','1003463','1003464','1003543',
				'1003561','1003584','1003599','1003601','1003708','1003722','1003791','1003812','1003825','1003864','1003893','1003973','1004014','1004055','1004074','1004107',
				'1004108','1004112','1004199','1004220','1004238','1004381','1004457','1004521','1004582','1004583','1004586','1004608','1004735','1004752','1004764','1004809',
				'1004814','1004854','1004891','1004913','1004921','1004925','1004945','1004958','1004977','1005065','1005109','1005257','1005335','1005364','1005365','1005371',
				'1005412','1005413','1005460','1005521','1005550','1005563','1005621','1005686','1005688','1005735','1005752','1005766','1005773','1005821','1005855','1005866',
				'1005887','1005908','1005919','1005946','1005985','1006024','1006033','1006072','1006074','1006105','1006120','1006177','1006183','1006202','1006221','1006290',
				'1006303','1006398','1006404','1006416','1006447','1006528','1006561','1006586','1006610','1006614','1006701','1006730','1006779','1006789','1006837','1006847',
				'1006907','1006936','1006954','1006978','1007034','1007052','1007077','1007227','1007254','1007256','1007260','1007300','1007302','1007305','1007341','1007371',
				'1007430','1007491','1007529','1007608','1007719','1007744','1007767','1007773','1007775','1007812','1007832','1007858','1007900','1007967','1008001','1008014',
				'1008043','1008044','1008064','1008080','1008157','1008181','1008182','1008183','1008201','1008246','1008255','1008270','1008314','1008342','1008352','1008358',
				'1008383','1008426','1008530','1008590','1008630','1008639','1008671','1008731','1008769','1008799','1008809','1008815','1008819','1008861','1008868','1008917',
				'1008923','1008938','1008987','1009016','1009021','1009041','1009069','1009094','1009109','1009122','1009140','1009142','1009144','1009163','1009243','1009254',
				'1009256','1009332','1009364','1009392','1009447','1009451','1009572','1009616','1009662','1009677','1009696','1009726','1009736','1009738','1009739','1009742',
				'1009805','1009835','1009877','1009900','1009949','1009996','1010043','1010052','1010082','1010124','1010139','1010192','1010197','1010198','1010215','1010261',
				'1010267','1010275','1010295','1010319','1010330','1010334','1010343','1010351','1010360','1010367','1010386','1010446','1010466','1010497','1010534','1010538',
				'1010602','1010611','1010614','1010616','1010619','1010657','1010680','1010700','1010706','1010707','1010708','1010732','1010733','1010758','1010771','1010779',
				'1010783','1010786','1010787','1010939','1010945','1010948','1010951','1010990','1010998','1011027','1011029','1011030','1011037','1011038','1011094','1011103',
				'1011104','1011141','1011151','1011155','1011186','1011209','1011253','1011254','1011265','1011277','1011306','1011310','1011337','1011342','1011343','1011402',
				'1011425','1011447','1011468','1011484','1011517','1011570','1011603','1011616','1011650','1011670','1011692','1011697','1011758','1011760','1011772','1011774',
				'1011798','1011852','1011876','1011877','1011890','1011899','1011915','1011925','1011969','1011993','1011995','1012004','1012017','1012025','1012052','1012058',
				'1012060','1012073','1012086','1012088','1012094','1012105','1012129','1012179','1012181','1012205','1012236','1012260','1012266','1012291','1012298','1012300',
				'1012302','1012308','1012318','1012319','1012325','1012330','1012333','1012347','1012354','1012373','1012380','1012397','1012402','1012424','1012429','1012436',
				'1012439','1012451','1012452','1012465','1012476','1012503','1012514','1012517','1012522','1012523','1012528','1012552','1012569','1012571','1012591','1012613',
				'1012647','1012681','1012683','1012688','1012690','1012702','1012703','1012729','1012757','1012797','1012807','1012814','1012861','1012862','1012867','1012895',
				'1012901','1012916','1012919','1012960','1012969','1013009','1013027','1013064','1013096','1013100','1013132','1013139','1013149','1013165','1013190','1013235',
				'1013239','1013256','1013257','1013269','1013271','1013283','1013285','1013291','1013293','1013294','1013301','1013302','1013307','1013317','1013322','1013368',
				'1013369','1013387','1013412','1013415','1013419','1013460','1013515','1013557','1013558','1013567','1013589','1013610','1013612','1013618','1013628','1013633',
				'1013654','1013682','1013691','1013694','1013701','1013703','1013730','1013741','1013745','1013746','1013748','1013749','1013768','1013770','1013780','1013816',
				'1013830','1013853','1013870','1013901','1013904','1013913','1013923','1013963','1013968','1014029','2000002','2000607','2000851','2000937','2001816','2001848',
				'2002403','2002752','2002776','2002838','2002935','2003019','2003156','2003272','2003647','3000203'))
				BEGIN
					IF NOT EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid     
						WHERE A.targetmonth =4 AND A.TargetYear =2020 and A.Status =1 AND InsRefNo='Target0113')  
						BEGIN  
				  
							SET @ValidateMsg='Target Not Download From Console for Selected Month.' + CHAR(13) +  
								'Hence Debit Note Top Sheet Claim Cannot generate'    
						END 
				END
			END
		END 
		--TARGET DOWNLOAD ISSUE
		IF @ValidateMsg = ''   
		BEGIN  
			IF EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid     
			WHERE A.targetmonth =@Pi_Month AND A.TargetYear =@Pi_Year and A.Status =1)  
			BEGIN  
				IF NOT EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid   
				INNER JOIN InsTargetDetailsAch C ON A.insid =b.insid AND b.insid =c.insid  AND B.rtrid =C.Rtrid  
				WHERE A.targetmonth =@Pi_Month AND A.TargetYear =@Pi_Year and A.Status =1)  
				BEGIN  
						---PARCS202100019 Ach not download from console So msg changed
						--SET @ValidateMsg='Target Achievement Not Download From Console for Selected Month.' + CHAR(13) + 
						SET @ValidateMsg='Target Achievement Not Generate in Month End for Selected Month.' + CHAR(13) +   
						'Hence Debit Note Top Sheet Claim Cannot generate'   
				END  
			END  
		END  
	RETURN @ValidateMsg  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidateRetailerCategoryLevelValue' AND XTYPE='P')
DROP PROCEDURE Proc_ValidateRetailerCategoryLevelValue
GO
CREATE Procedure Proc_ValidateRetailerCategoryLevelValue
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_ValidateRetailerCategoryLevelValue
* PURPOSE	: To Insert and Update records  from xml file in the Table RetailerCategoryLevel 
* CREATED	: MarySubashini.S
* CREATED DATE	: 13/09/2007
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 2020-12-09		Venkat. M		CR				Existing Retailer category change     
*********************************/ 
SET NOCOUNT ON
BEGIN
DECLARE @LevelCode AS NVARCHAR(100)
DECLARE @ParentLevelValueCode AS NVARCHAR(100)
DECLARE @LevelValueCode AS NVARCHAR(100)
DECLARE @LevelValueName AS NVARCHAR(100)
DECLARE @CompanyCode AS NVARCHAR(100)
DECLARE @CtgLevelId AS INT
DECLARE @CtgMainId AS INT
DECLARE @CtgLinkId AS INT
DECLARE @CmpId AS INT
DECLARE @Code AS INT 
DECLARE @CtgLinkCode AS NVARCHAR(500)
DECLARE @ParLinkCode AS NVARCHAR(500)
DECLARE @NewLinkCode AS NVARCHAR(500)
DECLARE @CtgLevelName AS NVARCHAR(100)
DECLARE @Taction AS INT
DECLARE @Tabname AS NVARCHAR(100)
DECLARE @CntTabname AS NVARCHAR(100)
DECLARE @Fldname AS NVARCHAR(100)
DECLARE @ErrDesc AS NVARCHAR(1000)
DECLARE @sSql AS NVARCHAR(4000)
	SET @Po_ErrNo=0
	SET @CntTabname='RetailerCategory'
	SET @Fldname='CtgMainId'
	SET @Tabname = 'ETL_Prk_RetailerCategoryLevelValue'
	SET @Taction=0
	---- AddedBy Venkat. M
	Declare @ParentCatLevelId   INT
	Declare @ChildCatLevelId    INT
	SET @ParentCatLevelId = 0 
	SET @ChildCatLevelId  = 0  
	Select  @ParentCatLevelId = CtgLevelId From RetailerCategoryLevel (Nolock) Where  UPPER(CtgLevelName) = 'CHANNEL'
	Select  @ChildCatLevelId = CtgLevelId From RetailerCategoryLevel (Nolock) Where UPPER(CtgLevelName) = 'GROUP'
	SET @ParentCatLevelId = ISNULL(@ParentCatLevelId,0)
	SET @ChildCatLevelId = ISNULL(@ChildCatLevelId,0)
	
	IF @ParentCatLevelId = 0 
	BEGIN
		SET @Po_ErrNo=1
		SET @ErrDesc = ' ParentCatLevelId ' + @ParentCatLevelId + ' is zero'  		 
		INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'ParentCatLevelId',@ErrDesc)
		RETURN
	END
	IF @ChildCatLevelId = 0 
	BEGIN
		SET @Po_ErrNo=1
		SET @ErrDesc = ' ChildCatLevelId ' + @ChildCatLevelId + ' is zero'  		 
		INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'ChildCatLevelId',@ErrDesc)
		RETURN
	END
	---- Till END
		
	DECLARE Cur_RetailerCategoryLevelValue CURSOR 
	FOR SELECT	ISNULL([Hierarchy Level Code],''),ISNULL([Parent Hierarchy Level Value Code],''),
    			ISNULL([Hierarchy Level Value Code],''),ISNULL([Hierarchy Level Value Name],''),ISNULL([Company Code],'')
	FROM ETL_Prk_RetailerCategoryLevelValue A,RetailerCategoryLevel b
	WHERE CtgLevelName = [Hierarchy Level Code] ORDER BY LevelName
	
 	OPEN Cur_RetailerCategoryLevelValue
	FETCH NEXT FROM Cur_RetailerCategoryLevelValue INTO @LevelCode,@ParentLevelValueCode,@LevelValueCode,@LevelValueName,@CompanyCode
	WHILE @@FETCH_STATUS=0
		BEGIN	
				
			IF NOT EXISTS  (SELECT * FROM Company WHERE CmpCode = @CompanyCode )    
	  		BEGIN
					SET @Po_ErrNo=1
					SET @ErrDesc = 'Company Code: ' + @CompanyCode + ' is not availble'  		 
					INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'CompanyCode',@ErrDesc)
			END
		
			SELECT @CmpId =CmpId FROM  Company WHERE CmpCode=@CompanyCode
			IF NOT EXISTS  (SELECT * FROM RetailerCategoryLevel WHERE CmpId = @CmpId AND CtgLevelName=@LevelCode)    
	  		BEGIN
					SET @Po_ErrNo=1
					SET @ErrDesc = 'Category Level: ' + @LevelCode + ' is not available'  		 
					INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'HierarchyLevelCode',@ErrDesc)
			END
			
			SELECT @CtgLevelName=LevelName FROM RetailerCategoryLevel WITH (NOLOCK)WHERE CmpId = @CmpId AND CtgLevelName=@LevelCode 
			IF @CtgLevelName <>'Level1'
			BEGIN
				IF @ParentLevelValueCode <> '' 
					BEGIN
						IF NOT EXISTS (SELECT CtgLevelId FROM RetailerCategory WHERE CtgCode=@ParentLevelValueCode)
							BEGIN
								SET @Po_ErrNo=1
								SET @ErrDesc = 'Parent Category: ' + @ParentLevelValueCode+ ' is not available'	 
								INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'ParentHierarchyLevelValueCode',@ErrDesc)
							END
					END
			END
			IF @CtgLevelName <> 'Level1' 
			BEGIN
					SELECT @CtgLinkId=CtgMainId,@CtgLevelId=CtgLevelId + 1,@ParLinkCode=CtgLinkCode FROM RetailerCategory WHERE CtgCode=@ParentLevelValueCode
			END
			ELSE
			BEGIN
					SET @CtgLinkId=1
					SELECT @CtgLevelId=CtgLevelId FROM RetailerCategoryLevel WITH (NOLOCK) WHERE  CmpId = @CmpId AND CtgLevelName=@LevelCode 
					SELECT @ParLinkCode=''--+CAST(@CtgLevelId AS NVARCHAR(1000))
			END
			
			SELECT @NewLinkCode=ISNULL(MAX(CtgLinkCode),0) 
			FROM RetailerCategory 
			WHERE LEN(CtgLinkCode)=  Len(@ParLinkCode) +3			AND CtgLinkCode LIKE  @ParLinkCode +'%' AND CtgLevelId =@CtgLevelId
			SELECT @CtgLinkCode=dbo.Fn_ReturnNewCode(@ParLinkCode,3,@NewLinkCode)
			
			IF LTRIM(RTRIM(@LevelValueCode))='' 
			BEGIN
					SET @Po_ErrNo=1	
					SET @ErrDesc = 'Category Level Value Code should not be empty'		 
					INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'HierarchyLevelValueCode',@ErrDesc)
			END
					
			IF EXISTS (SELECT CtgCode  FROM RetailerCategory WHERE CtgCode=@LevelValueCode)
			BEGIN
					SET @Taction=2
			END
			ELSE
			BEGIN
					SET @Taction=1
			END					    	
				
			IF LTRIM(RTRIM(@LevelValueName))='' 
			BEGIN
				SET @Po_ErrNo=1	
				SET @ErrDesc = 'Category Level Value Name should not be empty'		 
				INSERT INTO Errorlog VALUES (@Po_ErrNo,@Tabname,'HierarchyLevelValueName',@ErrDesc)
			END
				 
			SELECT @CtgMainId=dbo.Fn_GetPrimaryKeyInteger(@CntTabname,@FldName,CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
		
			IF  @Taction=1 AND @Po_ErrNo=0
			BEGIN	
				INSERT INTO RetailerCategory 	(CtgMainId,CtgLinkId,CtgLevelId,CtgLinkCode,CtgCode,CtgName,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES (@CtgMainId,@CtgLinkId,@CtgLevelId,@CtgLinkCode,@LevelValueCode,@LevelValueName,
				1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  @CntTabname AND Fldname = @FldName	
				SET @sSql='INSERT INTO RetailerCategory VALUES('+ CAST(@CtgMainId AS VARCHAR(10))+','+ CAST(@CtgLinkId AS VARCHAR(10))+' 
				,'+ CAST(@CtgLevelId AS VARCHAR(10))+','''+@CtgLinkCode+''','''+@LevelValueCode+''','''+@LevelValueName+''',
				1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				SET @sSql='UPDATE Counters SET CurrValue = CurrValue'+'+1'+' WHERE Tabname ='''+ @CntTabname+''' AND Fldname = '''+@FldName+''''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
						
			END
			IF  @Taction=2 AND @Po_ErrNo=0
			BEGIN
				IF @CtgLevelName <> 'Level1' 
				BEGIN 
				---- Existing Category Update Added by Venkat. M PMS no :		 2020-12-09
					  DECLARE @CatParentId   INT
					  DECLARE @LevGroupId	 INT
					  SELECT @CatParentId =  CtgMainId FROM  RetailerCategory B (NOLOCK) WHERE CtgCode =  @ParentLevelValueCode AND  CtgLevelId =  @ParentCatLevelId
					  SET @CatParentId = Isnull(@CatParentId,0)
					  IF @CatParentId <> 0 
					  BEGIN
					   	IF NOT EXISTS (SELECT * FROM RetailerCategory (NOLOCK) WHERE  CtgLevelId =  @ChildCatLevelId and  CtgCode = @LevelValueCode and CtgLinkId = @CatParentId)
						BEGIN
							Select  @LevGroupId =  CtgMainId from RetailerCategory (NOLOCK)  WHERE CtgCode=@LevelValueCode
							SELECT @ParLinkCode=CTGLINKCODE,@CtgLevelId=CtgLevelId FROM RetailerCategory (NOLOCK) WHERE Ctgcode = @ParentLevelValueCode
							
							SELECT @NewLinkCode=ISNULL(MAX(CtgLinkCode),0) FROM RetailerCategory (NOLOCK) WHERE LEN(CtgLinkCode)=  LEN(@ParLinkCode) +3 AND CtgLinkCode LIKE  @ParLinkCode +'%' AND CtgLevelId = @ChildCatLevelId
							SELECT @CtgLinkCode=dbo.Fn_ReturnNewCode(@ParLinkCode,3,@NewLinkCode)
							UPDATE RetailerCategory SET CtgLinkId = @CtgLinkId ,CtgLinkCode =@CtgLinkCode  ,LastModDate = CONVERT(VARCHAR(10), GETDATE() ,121 )
							WHERE CtgCode = @LevelValueCode
							--SET @sSql='UPDATE RetailerCategory SET CtgLinkId = '''+@CtgLinkId+''' ,CtgLinkCode ='''+@CtgLinkCode+'''  ,LastModDate = '''+CONVERT(VARCHAR(10), GETDATE() ,121 )
							--INSERT INTO Translog(strSql1) VALUES (@sSql)
						END
					 End
				END
				UPDATE RetailerCategory SET CtgName=@LevelValueName WHERE CtgCode=@LevelValueCode
				SET @sSql='UPDATE RetailerCategory SET CtgName='''+@LevelValueName+''' WHERE CtgCode='''+@LevelValueCode+''''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				 
			END
	FETCH NEXT FROM Cur_RetailerCategoryLevelValue INTO @LevelCode,@ParentLevelValueCode,@LevelValueCode,@LevelValueName,@CompanyCode
	END
	CREATE TABLE #RTRCTGDETAILS	(	CHILDCODE VARCHAR(50),	CHILDNAME VARCHAR(50),	PARENTCODE VARCHAR(50)	)
	DELETE FROM #RTRCTGDETAILS
	INSERT INTO #RTRCTGDETAILS
	SELECT DISTINCT 
		A.CTGCODE,A.CtgName,E.CTGCODE AS PARENTCODE 
	FROM 
		RetailerCategory A  
		INNER JOIN RetailerCategory E ON A.CTGLINKID=E.CTGMAINID
		INNER JOIN RetailerCategoryLevel RG ON A.CtgLevelId=RG.CtgLevelId
	WHERE upper(CtgLevelName)='GROUP'
	 	 
	UPDATE A SET A.DownloadFlag = 'Y' FROM Cn2Cs_Prk_BLRetailerCategoryLevelValue A WITH (NOLOCK),RetailerCategory B WITH (NOLOCK)
	WHERE A.[Hierarchy Level Value Code] = B.CtgCode AND A.[Hierarchy Level Value Name] = B.CtgName   AND UPPER(a.[Hierarchy Level Code]) = 'CHANNEL'
	
	UPDATE A SET A.DownloadFlag = 'Y' FROM Cn2Cs_Prk_BLRetailerCategoryLevelValue A WITH (NOLOCK),#RTRCTGDETAILS B WITH (NOLOCK)
	WHERE A.[Hierarchy Level Value Code] = B.CHILDCODE AND A.[Hierarchy Level Value Name] = B.CHILDNAME 
		  AND A.[Parent Hierarchy Level Value Code] = B.PARENTCODE AND UPPER (a.[Hierarchy Level Code]) = 'GROUP'
		  --- Till END
	CLOSE Cur_RetailerCategoryLevelValue
	DEALLOCATE Cur_RetailerCategoryLevelValue

	DROP TABLE #RTRCTGDETAILS
RETURN
END
GO
--CRCRSTPAR0109 // Deepak Philip // 28-12-2020 // To upload all salesman with dummy routes.
IF NOT EXISTS (SELECT * FROM sys.objects WHERE Name='SalesmanmarketDummyRoute' AND type in (N'U'))
CREATE TABLE SalesmanmarketDummyRoute
(
	[SMId] [int] NOT NULL,
	[RMId] [int] NOT NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL
)
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_AttachDummyRoutesWithSM' AND Type='P')
DROP PROC Proc_AttachDummyRoutesWithSM
GO
CREATE PROCEDURE Proc_AttachDummyRoutesWithSM
AS
/*********************************
* PROCEDURE		: Proc_AttachDummyRoutesWithSM
* PURPOSE		: To attache dummy routes with all salesman for SFA
* CREATED		: Deepak Philip
* CREATED DATE	: 28-12-2020
*********************************/
BEGIN
	IF  EXISTS (SELECT * FROM Salesman where SMCode ='SMDummy01')
	BEGIN
		 DECLARE @smid AS INT
		 DECLARE @Rmid AS INT
		 DECLARE Cur_Retailer CURSOR   
		 FOR SELECT DISTINCT smid from salesman
		 OPEN Cur_Retailer   
		 FETCH NEXT FROM Cur_Retailer INTO @smid   
		 WHILE @@FETCH_STATUS = 0          
		 BEGIN 

		 SELECT @Rmid=Rmid FROM RouteMaster WHERE Rmcode ='SRDummy01'

			IF NOT EXISTS(SELECT * FROM SalesmanmarketDummyRoute WHERE SMId=@smid AND RMId=@Rmid)
			BEGIN
				INSERT INTO SalesmanmarketDummyRoute
				SELECT @smid,@Rmid,1,2,getdate(),2,getdate()
			END

		 FETCH NEXT FROM Cur_Retailer INTO @smid            
		 END          
		 CLOSE Cur_Retailer          
		 DEALLOCATE Cur_Retailer
	 END
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_Export_CS2WS_JourneyPlan' AND Type='P')
DROP PROC Proc_Export_CS2WS_JourneyPlan
GO
CREATE PROCEDURE Proc_Export_CS2WS_JourneyPlan
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_JourneyPlan
* PURPOSE		: To Export Journy Plan details to the PDA Intermediate Database
* CREATED		: S.Moorthi
* CREATED DATE	: 16/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
  04/08/2018   S.Moorthi    CR         CRCRSTPAR0017   SFA-Upload-Download Integration --Product
  28-12-2020   Deepak Philip CR        CRCRSTPAR0109   To attach and upload Dummy routes for all salesman.
********************************************************************************************/
BEGIN
	DECLARE @DelSQL AS VARCHAR(1000)
	DECLARE @InsSQL AS VARCHAR(5000)
	DECLARE @@JcwWk AS INT
	DECLARE @RMId AS INT
	DECLARE @RMMon AS INT
	DECLARE @RtrID AS INT
	DECLARE @Smid AS int 
	DECLARE @Sql AS varchar(3000)
	DECLARE @Ssql AS varchar(3000)
	DELETE FROM Export_CS2WS_JourneyPlan 
	 
	TRUNCATE TABLE TempJourneyCycle
	
	--Added By Deepak Philip
	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailerHd' and xtype='U')
	BEGIN
		DROP TABLE TempRetailerHd
	END
	
	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailerHdr' and xtype='U')
	BEGIN
		DROP TABLE TempRetailerHdr
	END

	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailerDummy' and xtype='U')
	BEGIN
		DROP TABLE TempRetailerDummy
	END
	
	EXEC Proc_AttachDummyRoutesWithSM
	--Till here
	---Company rtr code
	SET @Sql= 'SELECT DistributorCode,SMCode,RM.RMID,RMCode,R.RtrId,CmpRtrCode as RtrCode,0 AS SeqWk,0 AS SeqDay,0 SeqNo INTO TempRetailerHd
	FROM Retailer R
	INNER JOIN RetailerMarket RM ON R.RtrId = RM.RtrId
	INNER JOIN RouteMaster ROT ON ROT.RMId = RM.RMId
	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	INNER JOIN SalesmanMarket SM ON RM.RMId = SM.RMId
	INNER JOIN Salesman S ON S.SMId = SM.SMId
	CROSS JOIN Distributor
	WHERE S.Status = 1 AND RMstatus = 1 AND RtrStatus = 1 AND S.SMId IN ('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
	EXEC (@Sql)	
	
	--Added By Deepak Philip
	SET @Ssql= 'SELECT DistributorCode,SMCode,RM.RMID,RMCode,R.RtrId,CmpRtrCode as RtrCode,0 AS SeqWk,0 AS SeqDay,0 SeqNo INTO TempRetailerDummy
	FROM Retailer R
	INNER JOIN RetailerMarket RM ON R.RtrId = RM.RtrId
	INNER JOIN RouteMaster ROT ON ROT.RMId = RM.RMId
	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	INNER JOIN SalesmanmarketDummyRoute SM ON RM.RMId = SM.RMId
	INNER JOIN Salesman S ON S.SMId = SM.SMId
	CROSS JOIN Distributor
	WHERE S.Status = 1 AND RMstatus = 1 AND RtrStatus = 1 AND S.SMId IN ('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
	EXEC (@Ssql)	
	
	SELECT A.* INTO TempRetailerHdr FROM(
	SELECT * FROM TempRetailerHd
	UNION
	SELECT * FROM TempRetailerDummy) A
	--Till Here
	
	--For Monday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMMon= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,1,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Tuesday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMTue= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,2,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Wednesday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMWed= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,3,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Thursday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMThu= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,4,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Friday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMFri= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,5,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Saturday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMSat= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,6,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	--For Sunday
	DECLARE Cur_RMId Cursor For
	SELECT distinct A.RMId,RMMon,RtrID FROM RouteMaster A,TempRetailerHdr B
	WHERE RMSun= 1 AND A.RMID = B.RmID ORDER BY A.RMId
	OPEN Cur_RMId	
	FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	WHILE @@FETCH_STATUS =0
	BEGIN
			DECLARE Cur_RMIdWK Cursor For
			SELECT JcwWk FROM (
			SELECT DISTINCT JcwWk FROM JCWeek WHERE JcwWk <=4
			UNION ALL 
			SELECT 5)A
			OPEN Cur_RMIdWK	
			FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			WHILE @@FETCH_STATUS =0
			BEGIN
				INSERT INTO TempJourneyCycle(DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,SeqWk,SeqDay,SeqNo)
				SELECT DistributorCode,SMCode,RMID,RMCode,RtrId,RtrCode,@@JcwWk,7,0 AS SeqNo FROM TempRetailerHdr
				WHERE RMID = @RMId AND RtrID = @RtrID
				UPDATE TempJourneyCycle SET SeqNo = RtrSeqDtId FROM TempJourneyCycle A,RetailerSequence B,RetailerSeqDetails C
				WHERE A.RMID = B.RMID AND B.RtrSeqId = C.RtrSeqId AND A.RtrId = C.RtrId AND A.RMID = @RMId AND A.RtrID = @RtrID
			
				FETCH NEXT FROM Cur_RMIdWK INTO @@JcwWk
			END
		CLOSE Cur_RMIdWK
		DEALLOCATE Cur_RMIdWK
		FETCH NEXT FROM Cur_RMId INTO @RMId,@RMMon,@RtrID
	END
	CLOSE Cur_RMId
	DEALLOCATE Cur_RMId
	
	UPDATE A SET A.SMNAME=B.SMName FROM TempJourneyCycle A 
	INNER JOIN SalesMan B (NOLOCK) ON A.SMCode=B.SMCode  
	
	INSERT INTO Export_CS2WS_JourneyPlan(TenantCode,LocationCode,JourneyPlanCode,
	JourneyPlanDescription,CustomerCode,SequenceWeek,SequenceDay,SequenceNumber,BeatCode,UploadFlag)
	SELECT DistributorCode AS TenantCode,DistributorCode AS LocationCode,SMCode AS SalesmanCode,
	SMNAME AS SalesmanName,RtrCode AS CmpRtrCode,SeqWk AS SequenceWeek,SeqDay AS SequenceDay,
	SeqNo AS SequenceNumber,RMCode AS BeatCode,'N' AS UploadFlag FROM TempJourneyCycle
	
	--Data Set Return
	SELECT distinct TenantCode,
		LocationCode,
		JourneyPlanCode,
		JourneyPlanDescription,
		CustomerCode,
		SequenceWeek,
		SequenceDay,
		SequenceNumber,
		BeatCode 
		FROM Export_CS2WS_JourneyPlan (NOLOCK)
	 
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_GenerateInsTargetAchievement')
DROP PROCEDURE Proc_GenerateInsTargetAchievement
GO
--EXEC Proc_GenerateInsTargetAchievement 1,'2020-05-16',0,''
CREATE PROCEDURE Proc_GenerateInsTargetAchievement
(
	@Pi_UserId AS [int],
	@Pi_gServerDate AS DATETIME,
	@Po_ErrNo AS TinyINT OUTPUT,
	@Po_ErrorMessage AS [VARCHAR](4000) OUTPUT
)
AS
SET NOCOUNT ON
BEGIN
/********************************************************************************
* PROCEDURE		: Proc_GenerateInsTargetAchievement
* PURPOSE		: To Validate and Generate Ins Target Achievement
* CREATED		: S.Moorthi
* CREATED DATE	: 16/05/2020
* MODIFIED
* DATE				 AUTHOR				CR\BUG	UserStorageID		DESCRIPTION
------------------------------------------------------------------------------------------------
* 16/05/2020		 S.MOORTHI			  CR	PARCS202100019		Target achievement should be calculated in the Core Stocky													
* 06/07/2020		 S.MOORTHI			  SR	PARCS202100019		1.	All sales amount should consider Net amount (We use gross amount currently)
																	2.	Target slab percentage should be decided by Target+10% amount (We use sales amount to decide slab percentage currently)
* 16/07/2020		 S.MOORTHI			  CR	PARCS202100032		Target Achievement Credit note generation and adjusted in billing
* 04-01-2020		 S.Mohana			  BZ	PARLECS/0121/015	Target Year Wrongly updated. 
**********************************************************************************/
	
	SET @Po_ErrNo=0
	SET @Po_ErrorMessage=''
	
	BEGIN TRY
			
			DECLARE @JcmSdt AS DATETIME
			DECLARE @JcmEdt AS DATETIME
			DECLARE @JCMONTH as VARCHAR(50)
			DECLARE @JCYEAR as VARCHAR(50)
			----Credit Note Raised
			DECLARE @RtrId AS INT
			DECLARE @InsRefNo AS VARCHAR(100)
			DECLARE @CreditAmount AS NUMERIC(18,3)
			DECLARE @CrNoteNumber AS NVARCHAR(100)
			DECLARE @CreditDate AS DATETIME
			DECLARE @CoaId AS INT
			DECLARE @ReasonId AS INT
			DECLARE @ErrStatus as INT
			---Credit Note
			DECLARE @TargetPerc AS [numeric](18, 6)
			SET @TargetPerc=110.00
			SET @ErrStatus=0
			
			IF EXISTS(SELECT * FROM TargetPerc (NOLOCK))
			BEGIN
				SELECT @TargetPerc=TargetPerc FROM TargetPerc (NOLOCK)
			END
			
			SELECT @JcmEdt=DATEADD(D,-1,JcmSdt),@JCYEAR=YEAR(DATEADD(D,-1,JcmSdt)) FROM JCMonth A (NOLOCK) INNER JOIN JCMast B(NOLOCK) ON A.JcmId=B.JcmId 
			WHERE @Pi_gServerDate BETWEEN JcmSdt and JcmEdt		--PARLECS/0121/015
			
			
			SELECT @JcmSdt=JcmSdt FROM JCMonth WHERE JCMEDT=@JcmEdt
			
			SELECT @JCMONTH=DATENAME(M,@JcmSdt)
			
			IF @JcmSdt<'2020-08-01'
			BEGIN
				PRINT 'Cut Off date Validated'
				RETURN
			END
						
			--- Check Month End 
			IF NOT EXISTS(SELECT * FROM JCMonthEnd (NOLOCK) WHERE Status=1 AND JcmSdt=@JcmSdt AND JcmEdt=@JcmEdt)
			BEGIN
				RETURN
			END	
			
			IF EXISTS(SELECT * FROM InsTargetDetailsAch WHERE TargetMonth=@JCMONTH AND TargetYear=@JCYEAR)
			BEGIN
				RETURN
			END
								
			--- MultiUser Validation
			IF EXISTS(SELECT UserId FROM MultiUserTransValidation (NOLOCK) WHERE TransId=505)
			BEGIN
				RETURN
			END
			
			SELECT  InsId,H.InsRefNo,H.ChnId INTO #Temp FROM InsTargetHD H (NOLOCK)       
			INNER JOIN  JCMonth A (NOLOCK) ON H.TargetMonth = A.JcmJc      
			INNER JOIN  JCMast b(NOLOCK) on a.JcmId = b.JcmId AND H.TargetYear =  B.JcmYr
			WHERE A.JCMSDT= @JcmSdt AND H.[Status] = 1  AND Confirm=0
			
			IF NOT EXISTS(SELECT * FROM #Temp)
			BEGIN
				RETURN 
			END
			
			IF EXISTS(SELECT * FROM #Temp A WHERE NOT EXISTS(SELECT * FROM InsTargetDetails B WHERE A.InsId=B.InsId))
			BEGIN
				SET @Po_ErrNo=1				
				SET @Po_ErrorMessage='Ins. Target achievement not generate due to Ins. Target Retailer details not available'
				RETURN 
			END
			
			IF EXISTS(SELECT * FROM #Temp A WHERE NOT EXISTS(SELECT * FROM InsTargetSlabs B WHERE A.InsId=B.InsId))
			BEGIN
				SET @Po_ErrNo=1
				SET @Po_ErrorMessage='Ins. Target achievement not generate due to Ins. Target Slab details not available'
				RETURN 
			END
			
			BEGIN TRANSACTION
			
				INSERT INTO MultiUserTransValidation(UserId,UserName,TransId,TransName,LockedDate)
				SELECT @Pi_UserId,'',505,'Generate Ins. Target achievement',@Pi_gServerDate	
				
								
				CREATE TABLE #InsTargetDetailsAch(
					[InsId]				[bigint] NULL,
					[TargetYear]		[bigint] NULL,
					[TargetMonth]		[nvarchar](50) NULL,
					[RtrId]				[int] NULL,
					[SlabId]				[int] NULL,
					[CmpRtrCode]		[nvarchar](100) NULL,
					[Target]			[numeric](18, 6) NULL,
					[TargetWithPerc]	[numeric](18, 6) NULL,
					[Achievement]		[numeric](18, 6) NULL,
					[BaseAch]			[numeric](18, 6) NULL,
					[TargetAch]			[numeric](18, 6) NULL,
					[ValBaseAch]		[numeric](18, 6) NULL,
					[ValTargetAch]		[numeric](18, 2) NULL,
					[ClmAmount]			[numeric](18, 2) NULL,  ---,6
					[Liability]			[numeric](18, 6) NULL,
					[RtrUniqueCode]		[nvarchar](400) NULL,
					[TotalSales]		[numeric](18, 6) NULL,
				) ON [PRIMARY]
				
				CREATE TABLE #RetailerCategory
				(
					ChannelId		[int],
					ChannelCode		[VARCHAR](100),
					GroupId			[int],
					GroupCode		[VARCHAR](100),
					ValueClassId	[int]
				)
				CREATE TABLE #InsRetailer
				(
					InsId			[int],
					RtrId			[VARCHAR](100),
					ChannelId		[int],
					ValueClassId	[int],
					[Target]		[numeric](18, 6),
					TargetWithPerc	[numeric](18, 6),
					TargetToAch		[numeric](18, 6)
				)
				CREATE TABLE #InsRetailerAchievement
				(
					InsId			[int],
					RtrId			[int],
					GrossAmount		[numeric](18, 6),
					TaxAmount		[numeric](18, 6),
					NetAmount		[numeric](18, 6)														
				)
				CREATE TABLE #InsProductAchievement
				(
					InsId		[int],
					GrpId		[int],
					RtrId		[int],
					PrdId		[BIGInt],
					GrossAmount	[numeric](18, 6),
					TaxAmount	[numeric](18, 6),
					NetAmount	[numeric](18, 6),
					[ClmAmount]	[numeric](18, 6)			
				)
				CREATE TABLE #RetailerSlab
				(
					InsId		[int],
					RtrId		[int],
					SlabId		INT					
				)
			
				INSERT INTO #InsRetailer(InsId,RtrId,ChannelId,ValueClassId,[Target],TargetWithPerc,TargetToAch)
				SELECT DISTINCT A.InsId,R.RtrId,A.ChnId,ISNULL(RVCM.RtrValueClassId,0),C.[Target],
				(C.[Target]*@TargetPerc/100.00),(C.[Target]*@TargetPerc/100.00) FROM InsTargetHD A (NOLOCK)
				INNER JOIN #Temp B ON A.InsId=B.InsId AND A.InsRefNo=B.InsRefNo 
				INNER JOIN InsTargetDetails C(NOLOCK) ON C.InsId=B.InsId AND C.InsId=A.InsId 
				INNER JOIN Retailer R (NOLOCK) ON R.CmpRtrCode=C.CmpRtrCode 
				LEFT OUTER JOIN RetailerValueClassMap RVCM (NOLOCK) ON RVCM.RtrId=R.RtrId
				
				INSERT INTO #RetailerCategory(ChannelId,ChannelCode,GroupId,GroupCode,ValueClassId)
				SELECT RC.CtgMainId,RC.CtgCode,RG.CtgMainId,RG.CtgCode,RVC.RtrClassId FROM RetailerCategory RC (NOLOCK)
				INNER JOIN RetailerCategory RG(NOLOCK) ON RC.CtgMainId=RG.CtgLinkId 
				INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.CtgMainId=RG.CtgMainId 
				
						
				INSERT INTO #InsProductAchievement(InsId,GrpId,RtrId,PrdId,GrossAmount,TaxAmount,NetAmount)
				SELECT InsId,GroupId,RtrId,PrdId,SUM(SalGrossAmount),SUM(SalTaxAmount),SUM(SalNetAmt) FROM
				(
					SELECT A.InsId,RC.GroupId,A.RtrId,SIP.PrdId,SUM(SIP.PrdGrossAmount) AS SalGrossAmount,SUM(SIP.PrdTaxAmount) as SalTaxAmount,
					SUM(SIP.PrdNetAmount) as SalNetAmt FROM #InsRetailer A (NOLOCK)
					INNER JOIN #RetailerCategory RC ON RC.ChannelId=A.ChannelId
					INNER JOIN SalesInvoice SI(NOLOCK) ON SI.RtrId=A.RtrId and SI.RtrValueClassId=RC.ValueClassId
					INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SI.SalId=SIP.SalId 
					WHERE SI.SalInvDate Between @JcmSdt and @JcmEdt and SI.DlvSts>3 and ISNULL(SI.RtrValueClassId,0)<>0
					GROUP BY A.InsId,RC.GroupId,A.RtrId,SIP.PrdId ----Value class properly updated
					UNION
					SELECT A.InsId,RC.GroupId,A.RtrId,SIP.PrdId,SUM(SIP.PrdGrossAmount) AS SalGrossAmount,SUM(SIP.PrdTaxAmount) as SalTaxAmount,
					SUM(SIP.PrdNetAmount) as SalNetAmt FROM #InsRetailer A (NOLOCK)
					INNER JOIN #RetailerCategory RC ON RC.ChannelId=A.ChannelId AND A.ValueClassId=RC.ValueClassId
					INNER JOIN SalesInvoice SI(NOLOCK) ON SI.RtrId=A.RtrId 
					INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SI.SalId=SIP.SalId 
					WHERE SI.SalInvDate Between @JcmSdt and @JcmEdt and SI.DlvSts>3 and ISNULL(SI.RtrValueClassId,0)=0
					GROUP BY A.InsId,RC.GroupId,A.RtrId,SIP.PrdId ----if Value class not updated then take current retailer value class id	
					UNION			
					SELECT A.InsId,RC.GroupId,A.RtrId,SIP.PrdId,-1*SUM(SIP.PrdGrossAmt) AS SalGrossAmount,-1*SUM(SIP.PrdTaxAmt) as SalTaxAmount,
					-1*SUM(PrdNetAmt) as SalNetAmt FROM #InsRetailer A (NOLOCK)
					INNER JOIN #RetailerCategory RC ON RC.ChannelId=A.ChannelId
					INNER JOIN ReturnHeader SI(NOLOCK) ON SI.RtrId=A.RtrId and SI.RtrValueClassId=RC.ValueClassId
					INNER JOIN ReturnProduct SIP (NOLOCK) ON SI.ReturnID=SIP.ReturnID 
					WHERE SI.ReturnDate Between @JcmSdt and @JcmEdt and SI.Status=0 and ISNULL(SI.RtrValueClassId,0)<>0
					GROUP BY A.InsId,RC.GroupId,A.RtrId,SIP.PrdId ----Value class properly updated
					UNION
					SELECT A.InsId,RC.GroupId,A.RtrId,SIP.PrdId,-1*SUM(SIP.PrdGrossAmt) AS SalGrossAmount,-1*SUM(SIP.PrdTaxAmt) as SalTaxAmount,
					-1*SUM(PrdNetAmt) as SalNetAmt FROM #InsRetailer A (NOLOCK)
					INNER JOIN #RetailerCategory RC ON RC.ChannelId=A.ChannelId and RC.ValueClassId=A.ValueClassId
					INNER JOIN ReturnHeader SI(NOLOCK) ON SI.RtrId=A.RtrId 
					INNER JOIN ReturnProduct SIP (NOLOCK) ON SI.ReturnID=SIP.ReturnID
					WHERE SI.ReturnDate Between @JcmSdt and @JcmEdt and SI.Status=0 and ISNULL(SI.RtrValueClassId,0)=0
					GROUP BY A.InsId,RC.GroupId,A.RtrId,SIP.PrdId ----if Value class not updated then take current retailer value class id
				)X GROUP BY InsId,GroupId,RtrId,PrdId
				
			
			------Line Level Net amount consider for Calculation			
			INSERT INTO #InsRetailerAchievement(InsId,RtrId,GrossAmount,TaxAmount,NetAmount)
			SELECT InsId,RtrId,SUM(GrossAmount),SUM(TaxAmount),SUM(NetAmount) FROM #InsProductAchievement
			GROUP BY InsId,RtrId
			
			--	------------------------------Program Eligible Slab------------------------------
			--EXEC Proc_GenerateInsTargetAchievement 1,'2020-06-16',0,''
			
			INSERT INTO #RetailerSlab(InsId,RtrId,SlabId)			
			SELECT A.InsId,A.RtrId,MAX(C.SlabId) AS SlabId FROM #InsRetailer A 
			INNER JOIN #InsRetailerAchievement B ON A.InsId=B.InsId and A.RtrId=B.RtrId
			INNER JOIN InsTargetSlabs C (NOLOCK) ON C.InsId=B.InsId AND  C.InsId=A.InsId
			WHERE A.[TargetWithPerc]>=C.FromSales AND NetAmount>=A.Target 
			and NetAmount >= [TargetWithPerc]
			--WHERE GrossAmount>=C.FromSales AND GrossAmount>=A.Target
			GROUP BY A.InsId,A.RtrId
			
			INSERT INTO #RetailerSlab(InsId,RtrId,SlabId)			
			SELECT A.InsId,A.RtrId,MAX(C.SlabId) AS SlabId FROM #InsRetailer A 
			INNER JOIN #InsRetailerAchievement B ON A.InsId=B.InsId and A.RtrId=B.RtrId
			INNER JOIN InsTargetSlabs C (NOLOCK) ON C.InsId=B.InsId AND  C.InsId=A.InsId
			WHERE NetAmount>=C.FromSales AND NetAmount>=A.Target 
			and NetAmount<[TargetWithPerc]
			and NOT EXISTS(SELECT * FROM #RetailerSlab M WHERE M.InsId=A.InsId and M.RtrId=A.RtrId)
			--WHERE GrossAmount>=C.FromSales AND GrossAmount>=A.Target
			GROUP BY A.InsId,A.RtrId
			----
			
							
			INSERT INTO #InsTargetDetailsAch([InsId],[TargetYear],[TargetMonth],[RtrId],[CmpRtrCode],[Target],[TargetWithPerc],
			[Achievement],[BaseAch],[TargetAch],[ValBaseAch],[ValTargetAch],[ClmAmount],
			[Liability],[RtrUniqueCode],[SlabId],[TotalSales])
			SELECT A.InsId,@JCYEAR,@JCMONTH,A.RtrId,R.CmpRtrCode,A.[Target],A.TargetWithPerc,0,0,0,0,0,0,0,
			R.RtrUniqueCode,0,0 FROM #InsRetailer A 
			INNER JOIN InsTargetHD B ON A.InsId=B.InsId 
			INNER JOIN Retailer R ON A.RtrId=R.RtrId 
			
			---To Update the Achivement - Gross salary
			--UPDATE  A SET [TotalSales]=B.GrossAmount FROM #InsTargetDetailsAch A
			
			---Take Net Amount instead of Gross amount for Calculation 
			UPDATE  A SET [TotalSales]=B.NetAmount FROM #InsTargetDetailsAch A 
			INNER JOIN #InsRetailerAchievement B ON A.InsId=B.InsId AND A.RtrId=B.RtrId 
			
			
			---To Update the Achived Slab Perc
			UPDATE  A SET --A.[BaseAch]=C.BaseDiscount,
			A.TargetAch=C.TargetIncentive,A.SlabId=B.SlabId FROM #InsTargetDetailsAch A 
			INNER JOIN #RetailerSlab B ON A.InsId=B.InsId AND A.RtrId=B.RtrId 
			INNER JOIN InsTargetSlabs C (NOLOCK) ON C.InsId=B.InsId and C.InsId=A.InsId and C.SlabId=B.SlabId			
			 
			---To Calculate & Update Claim Amount
			UPDATE  A SET A.[Achievement]=A.TargetWithPerc,
			A.[ValTargetAch]= ISNULL((ISNULL(A.TargetWithPerc,0) * ISNULL(A.TargetAch,0)) / 100,0)		
			 FROM #InsTargetDetailsAch A 
			INNER JOIN #InsRetailerAchievement B ON A.InsId=B.InsId AND A.RtrId=B.RtrId 
			WHERE A.[TotalSales] >= A.[TargetWithPerc] And ISNULL(A.TargetAch,0) > 0
			
			---To Calculate & Update Claim Amount
			UPDATE  A SET  A.[Achievement]=A.[TotalSales],
			A.[ValTargetAch]= ISNULL((ISNULL(A.[TotalSales],0) * ISNULL(A.TargetAch,0)) / 100,0)
			FROM #InsTargetDetailsAch A 
			INNER JOIN #InsRetailerAchievement B ON A.InsId=B.InsId AND A.RtrId=B.RtrId 
			WHERE A.[TotalSales] < A.[TargetWithPerc] And ISNULL(A.TargetAch,0) > 0			
			
			UPDATE  A SET  A.[ValBaseAch]=0 FROM #InsTargetDetailsAch A  ----As per PM & Mr. Anand confirmation Base Discount not consider for Calculation
			
			UPDATE #InsTargetDetailsAch SET ClmAmount=[ValTargetAch]+ISNULL([ValBaseAch],0.00)
			
			---To Calculate & Update Liaability
			UPDATE #InsTargetDetailsAch SET Liability=NULLIF([TotalSales]/ClmAmount,0) WHERE ClmAmount>0
			
					
			UPDATE M SET M.Confirm=1,Upload=0,AuthDate=GETDATE() FROM #InsTargetDetailsAch A INNER JOIN InsTargetHD M ON A.InsId=m.InsId 
			WHERE NOT EXISTS(SELECT * FROM InsTargetDetailsAch B WHERE A.InsId=b.InsId 
			AND A.TargetYear=B.TargetYear and A.TargetMonth=b.TargetMonth AND B.InsId=M.InsId)
			
			INSERT INTO InsTargetDetailsAch (InsId,TargetYear,TargetMonth,RtrId,Achievement,BaseAch,TargetAch,ValBaseAch,
			ValTargetAch,ClmAmount,Liability,Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrUniqueCode,CmpRtrCode,
			[Target],[TargetWithPerc],[SlabId],[TotalSales],EligibleAmount)
			SELECT DISTINCT InsId,TargetYear,TargetMonth,RtrId,[TotalSales] as Achievement,BaseAch,TargetAch,ValBaseAch,
			ValTargetAch,ClmAmount,Liability,1 Availability,@Pi_UserId LastModBy,GetDate() LastModDate,@Pi_UserId AuthId,GetDate() AuthDate,
			RtrUniqueCode,CmpRtrCode,[Target],[TargetWithPerc],SlabId,[TotalSales],Achievement
			FROM #InsTargetDetailsAch A WHERE NOT EXISTS(SELECT * FROM InsTargetDetailsAch B(NOLOCK) WHERE A.InsId=b.InsId 
			AND A.TargetYear=B.TargetYear and A.TargetMonth=b.TargetMonth)
					
			
			UPDATE #InsProductAchievement SET ClmAmount=0
			
			---Net Amount taken instead of Gross
			UPDATE B SET 
			B.ClmAmount= ((ISNULL(B.NetAmount,0)/ISNULL((A.[TotalSales]/A.[TargetWithPerc]),0))*(ISNULL(A.TargetAch,0)/100)) 
			FROM #InsTargetDetailsAch A 
			INNER JOIN #InsProductAchievement B ON A.InsId=B.InsId and A.RtrId=B.RtrId		
			WHERE A.[TotalSales] >= A.[TargetWithPerc] And ISNULL(A.TargetAch,0) > 0
			
			
			---Net Amount taken instead of Gross
			---To Calculate & Update Claim Amount
			UPDATE  B SET B.ClmAmount= ISNULL((ISNULL(B.NetAmount,0) * ISNULL(A.TargetAch,0)) / 100,0) 
			FROM #InsTargetDetailsAch A 
			INNER JOIN #InsProductAchievement B ON A.InsId=B.InsId and A.RtrId=B.RtrId	
			WHERE A.[TotalSales] < A.[TargetWithPerc] And ISNULL(A.TargetAch,0) > 0
			
			---Net Amount taken instead of Gross
			INSERT INTO InsTargetDetailsProductLevelAch(InsId,TargetYear,TargetMonth,RtrId,RtrUniqueCode,CmpRtrCode,SlabId,
			PrdCCode,BrandCode,PriceSlot,FlavorCode,[Target],TargetWithPerc,TotalAchievement,PrdAchievement,
			BaseAch,TargetAch,ValBaseAch,ValTargetAch,ClmAmount,Liability,CreatedDate,GrpId)
			SELECT A.InsId,A.TargetYear,A.TargetMonth,A.RtrId,A.RtrUniqueCode,A.CmpRtrCode,A.SlabId,P.ProductCode,
			Brand_Code,PriceSlot_Code,Flavor_Code,A.[Target],A.[TargetWithPerc],A.TotalSales,B.NetAmount,BaseAch,TargetAch,
			ValBaseAch,B.ClmAmount,B.ClmAmount,Liability,GetDate(),B.GrpId FROM #InsTargetDetailsAch A 
			INNER JOIN #InsProductAchievement B ON A.InsId=B.InsId and A.RtrId=B.RtrId
			INNER JOIN TBL_GR_BUILD_PH P ON P.PrdId=B.PrdId
			WHERE NOT EXISTS(SELECT * FROM InsTargetDetailsProductLevelAch B(NOLOCK) WHERE A.InsId=B.InsId 
			AND A.TargetYear=B.TargetYear and A.TargetMonth=B.TargetMonth)
			
			-----------------------------Credit Note Generation------------------------
			DECLARE @Remarks AS VARCHAR(1000)
			SET @CreditDate=@Pi_gServerDate	
			SET @CoaId =(SELECT TOP 1 CoaId FROM  CoaMaster WHERE AcName='Institutions Target Setting')
			SET @ReasonId =(SELECT TOP 1 ReasonId FROM  ReasonMaster (Nolock) WHERE DESCRIPTION='Institutions Target Setting')
			SET @Remarks='Institutional Target '+@JCMONTH+' - '+@JCYEAR			
			
			
			SELECT DISTINCT A.RtrId,B.InsRefNo,A.ClmAmount INTO #TempCreditNote FROM InsTargetDetailsAch A 
			INNER JOIN InsTargetHD B ON A.InsId=B.InsId 
			WHERE Confirm=1 and ClmAmount>0 AND A.TargetMonth=@JCMONTH AND A.TargetYear=@JCYEAR
			AND NOT EXISTS(SELECT * FROM CreditNoteRetailer N WHERE N.RtrId=A.RtrId and N.PostedRefNo=B.InsRefNo AND N.Remarks=@Remarks)
				
			
			DECLARE Cur_TgtCreditNoteRetailer CURSOR 
			FOR SELECT RtrId,InsRefNo,ClmAmount FROM #TempCreditNote
			OPEN Cur_TgtCreditNoteRetailer
			FETCH NEXT FROM Cur_TgtCreditNoteRetailer INTO @RtrId,@InsRefNo,@CreditAmount
			WHILE @@FETCH_STATUS=0
			BEGIN
					SET @CrNoteNumber=''
					
					SELECT @CrNoteNumber= dbo.Fn_GetPrimaryKeyString('CreditNoteRetailer','CrNoteNumber',CAST(YEAR(GETDATE()) AS INT),MONTH(GETDATE()))
					IF @CrNoteNumber=''
					BEGIN
						SET @Po_ErrNo=1							
						SET @Po_ErrorMessage='Reset the Counter Value to raise the Credit Note for Ins. Target achievement'								 
					END
						
					IF @Po_ErrNo=0
					BEGIN
						    				    
							INSERT INTO CreditNoteRetailer (CrNoteNumber,CrNoteDate,Rtrid,CoaId,ReasonId,Amount,CrAdjAmount,Status,
							PostedFrom,TransId,PostedRefNo,Availability,LastModBy,LastModDate,AuthId,AuthDate,Remarks,XMLUpload) 
							VALUES(@CrNoteNumber,CONVERT(NVARCHAR(10),@CreditDate,121),@Rtrid,@CoaId,@ReasonId,CAST(@CreditAmount AS NUMERIC(18,2)),
							0,1,@CrNoteNumber,32,@InsRefNo,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),
							@Remarks,0)
							
							UPDATE Counters SET CurrValue=CurrValue+1 WHERE TabName='CreditNoteRetailer' AND FldName='CrNoteNumber'
							
							EXEC Proc_VoucherPosting 18,1,@CrNoteNumber,3,6,1,@CreditDate,@Po_ErrNo=@ErrStatus OUTPUT
							IF @ErrStatus<>1
							BEGIN
								SET @Po_ErrNo=1	
								SET @Po_ErrorMessage='Error in Voucher Posting to raise the Credit note for Ins. Target achievement'	
							END
							ELSE
							BEGIN
								SET @Po_ErrNo=0
							END
					END
					
					IF @Po_ErrNo=1
					BEGIN						
						CLOSE Cur_TgtCreditNoteRetailer
						DEALLOCATE Cur_TgtCreditNoteRetailer
						ROLLBACK TRAN
						RETURN
					END
					
				FETCH NEXT FROM Cur_TgtCreditNoteRetailer INTO @RtrId,@InsRefNo,@CreditAmount
			END
			CLOSE Cur_TgtCreditNoteRetailer
			DEALLOCATE Cur_TgtCreditNoteRetailer
						
			COMMIT TRANSACTION
				
			DELETE A FROM MultiUserTransValidation A(NOLOCK) WHERE TransId=505
			
	END TRY
	BEGIN CATCH
		SET @Po_ErrNo=1		
		SET @Po_ErrorMessage= ERROR_MESSAGE()	
		--select @Po_ErrorMessage	
		ROLLBACK TRANSACTION
	END CATCH
	RETURN
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME='Proc_ReturnSplDiscountClaim_New' AND TYPE='P')
DROP PROCEDURE Proc_ReturnSplDiscountClaim_New
GO
/* 
 BEGIN TRAN 
 EXEC Proc_ReturnSplDiscountClaim 0,'2020-09-01','2020-09-30',1,1  
 SELECT * FROM ReturnSplDiscountClaimAmt  
 ROLLBACK TRAN
*/ 
CREATE PROCEDURE Proc_ReturnSplDiscountClaim_New
(  
@Pi_ClmId INT,  
@Pi_FrmDate DateTime,  
@Pi_ToDate DateTime,  
@Pi_CmpId INT,  
@Pi_UsrID INT  
)  
AS  
BEGIN  
/*********************************  
* FUNCTION: Proc_ReturnSplDiscountClaim  
* PURPOSE: Returns the Special Discount Claim  
* NOTES:   
* CREATED: Thrinath Kola 12-12-2007  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------ 
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-03-2018  lakshman M   BZ     ICRSTPAR8158            sales Product id,batch id & base qty script validation added in CS .
09-04-2018	Mohana S	 BZ		ILCRSTPAR0085			Special Discount Claim Value mismatch
14-09-2018  Lakshman M   SR     ILCRSTPAR2050           Special Discount Claim Negative value consider in core stocky script has been changed.
25-09-2018  Vasantharaj  SR     ILCRSTPAR2190           Special Discount claim should load only With Negative and Positive Values (Zero value is not Loaded).
09-10-2018  Amuthakumar  BZ     CRCRSTPAR0031			Ignore Unsaleable Sales Return Products when claim
25-03-2020	MOHANA S     CR     PARCS202100002			Contract Pricing Optimization
23-10-2020	Mohana S	 BZ     PARLECS/1020/214		Spl Rate Validation Added.
**************************************************************************************************************/  
 CREATE TABLE #SalesTax  
 (  
  Salid NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
 CREATE TABLE #ReturnSalesTax  
 (  
  ReturnId NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
 DELETE A FROM ReturnSplDiscountClaimAmt A (NOLOCK) WHERE UsrId=@Pi_UsrID  
 INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END ,TaxableAmount   
 FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid  
 WHERE  TaxableAmount>0 and DlvSts in (4,5)  
 AND SI.SalInvDate  Between @Pi_FrmDate and @Pi_ToDate 
 --and SI.SalInvDate Between '2017-02-03' AND '2017-06-03'   
 GROUP BY S.Salid,PrdSlno,TaxableAmount,VatGst ORDER BY Prdslno  
 SELECT Salid,PrdSlno Into #TaxCess   
 FROM #SalesTax   
 GROUP BY Salid,PrdSlno  
 HAVING Count(PrdSlno)>1 
 SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1   
 FROM #SalesTax TT  
 INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno  
 DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno  
 INSERT INTO #ReturnSalesTax(ReturnId,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END,TaxableAmt   
 FROM ReturnProductTax S (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnId=SI.ReturnId  
 WHERE  TaxableAmt>0 and SI.Status=0  
 AND SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate 
 GROUP BY S.ReturnId,PrdSlno,TaxableAmt,VatGst ORDER BY PrdSlno
 SELECT ReturnId,PrdSlno Into #ReturnTaxCess FROM #ReturnSalesTax   
 GROUP BY ReturnId,PrdSlno  
 HAVING Count(PrdSlno)>1  
 SELECT TT.ReturnId,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1   
 FROM #ReturnSalesTax TT  
 INNER JOIN #ReturnTaxCess T ON T.ReturnId= TT.ReturnId and T.PrdSlNo=TT.PrdSlno  
 DELETE A FROM #ReturnSalesTax  A INNER JOIN #ReturnTaxCess B ON A.ReturnId=B.ReturnId and A.PrdSlno=B.PrdSlno  
  INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
  SELECT A.SalId,A.SalInvno,0 as Status,R.RtrName,  
  SUM(PrdSplDiscAmount) as SpentAmt,  
  ISNULL(SUM(PrdSplDiscAmount*TaxValue),0),   
  ISNULL(SUM(PrdSplDiscAmount)+SUM(PrdSplDiscAmount*TaxValue),0),  
  ISNULL(TaxPerc,0),0 as RecAmt,1,@Pi_UsrID  
  FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceProduct B  (NOLOCK) 
  ON A.SalId = B.SalId INNER JOIN Retailer R ON A.RtrId = R.RtrId   
  INNER JOIN Product P(NOLOCK) ON B.PrdId = P.PrdId  
  LEFT OUTER JOIN #SalesTax PT ON PT.SalId=B.SalId and PT.SalId=A.SalId and PT.PrdSlNo=B.SlNo    
  where B.SPLDiscClaimId IN (0,0) AND P.CmpId = 1 AND   
  A.SalInvDate Between @Pi_FrmDate and @Pi_ToDate    
  --A.SalInvDate Between '2017-02-03' AND '2017-06-03'  
  AND A.Dlvsts in (4,5)  
  GROUP BY A.SalId,A.SalInvno,R.RtrName,TaxPerc  
 --  Having SUM(PrdSplDiscAmount) > 0  ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
  Having SUM(PrdSplDiscAmount) <> 0   -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
  SELECT B.* INTO #ProductBatchDetails FROM  ProductBatch A (NOLOCK)    
  INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
  INNER JOIN BatchCreation C (NOLOCK) ON  
  C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1   
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT SI.SalId,SI.SalInvNo,0 as Status,RT.RtrName,  
	SUM(Sp.BaseQty * (Orgselrate-Splrate)) as SpentAmt,  
	ISNULL(SUM((Sp.BaseQty * (Orgselrate-Splrate))*TaxValue),0),  
	ISNULL(SUM(Sp.BaseQty * (Orgselrate-Splrate))+SUM((Sp.BaseQty * (Orgselrate-Splrate))*TaxValue),0),  
	ISNULL(TaxPerc,0),  
	0.00 as RecAmt,1,@Pi_UsrID  
	from SalesInvoice SI INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN SalesInvoiceProduct SP ON SI.SalID = SP.SalID  AND SplRate>0
	LEFT OUTER JOIN #SalesTax PT ON PT.SalId=SI.SalId and PT.SalId=SP.SalId and PT.PrdSlNo=SP.SlNo   
	--INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	--INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	--INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	--INNER JOIN BatchCreation C (NOLOCK) ON  
	--C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	--AND B.PriceId=SP.SplPriceId    
	--INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	--AND D.PriceId=SP.PriceId 
	--INNER JOIN BatchCreation E (NOLOCK) ON
	--E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	--A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	--INNER JOIN Contractpricingmaster CM on CM.ContractId=Sp.splpriceid     
	WHERE   
	SI.SalInvDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.dlvsts in (4,5) AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	--AND PR.CmpId= @Pi_CmpId		
	GROUP BY SI.SalId,SI.SalInvNo,RT.RtrName,TaxPerc,sp.prdid,sp.prdbatid,sp.baseqty
	-- Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0   ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	Having SUM(Sp.BaseQty * (Orgselrate-Splrate)) <> 0    -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
	---Sales Return  
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT A.ReturnId,A.ReturnCode,0 as Status,R.RtrName,-1 * SUM(PrdSplDisAmt) as SpentAmt,  
	-1 * ISNULL(SUM(PrdSplDisAmt*TaxValue),0),  ISNULL(-1*(SUM(PrdSplDisAmt)+SUM(PrdSplDisAmt*TaxValue)),0),ISNULL(TaxPerc,0),  
	0 as RecAmt,2,@Pi_UsrID  
	FROM ReturnHeader A   
	INNER JOIN ReturnProduct B  ON A.ReturnId = B.ReturnId  
	AND B.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) --- Added By Amuthakumar on 09/10/2018 CRCRSTPAR0031
	LEFT OUTER JOIN #ReturnSalesTax RS ON  A.ReturnId =RS.ReturnId and RS.ReturnId= B.ReturnId  and RS.PrdSlno=B.Slno  
	INNER JOIN Retailer R ON A.RtrId = R.RtrId    
	INNER JOIN Product P ON B.PrdId = P.PrdId   
	where B.SPLDiscClaimId IN (0,@Pi_ClmId) AND P.CmpId = @Pi_CmpId AND   
	A.ReturnDate Between @Pi_FrmDate AND @Pi_ToDate AND A.Status = 0  
	GROUP BY A.ReturnId,A.ReturnCode,R.RtrName,TaxPerc,B.prdid,B.prdbatid,B.baseqty ---------- Added By Lakshman M On 29-03-2018 Pms id:ICRSTPAR8158   
	-- Having SUM(PrdSplDisAmt) > 0  ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	 Having SUM(PrdSplDisAmt) <> 0   -- PMS ID: ILCRSTPAR2190 ON 25-09-2018  
	
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  --ADDED BY MOHANA ILCRSTPAR0085
	SELECT SI.ReturnId,SI.ReturnCode,0 as Status,RT.RtrName,  
	-1 * SUM(Sp.BaseQty * (Orgselrate-SplRate)) as SpentAmt,  
	ISNULL(-1 * SUM((Sp.BaseQty * (Orgselrate-SplRate))*Taxvalue) ,0),  
	-1*(ISNULL(SUM(Sp.BaseQty * (Orgselrate-SplRate)),0) +ISNULL(SUM((Sp.BaseQty * (Orgselrate-SplRate))*Taxvalue) ,0)),  
	ISNULL(TaxPerc,0),0.00 as RecAmt,2,@Pi_UsrID  
	from ReturnHeader SI   
	INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN ReturnProduct SP ON SI.ReturnId = SP.ReturnId  
	AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) --- Added By Amuthakumar on 09/10/2018 CRCRSTPAR0031
	INNER JOIN SalesInvoiceProduct SIP ON SIP.SALID =SI.SALID AND SP.Prdid = SIP.Prdid AND SIP.PrdBatId = SP.PrdBatId AND SP.ActSalRowid = SIP.Slno AND SplRate>0
	LEFT OUTER JOIN #ReturnSalesTax RS ON  SI.ReturnId =RS.ReturnId and RS.ReturnId= SP.ReturnId  and RS.PrdSlno=SP.Slno  
	--INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	--INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	--INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	--INNER JOIN BatchCreation C (NOLOCK) ON  
	--C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	--AND B.PriceId=SP.SplPriceId
	--INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	--AND D.PriceId=SP.PriceId 
	--INNER JOIN BatchCreation E (NOLOCK) ON
	--E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	--A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	where SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.Status = 0 AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	--AND PR.CmpId= @Pi_CmpId 
	GROUP BY SI.ReturnId,SI.ReturnCode,RT.RtrName,RS.TaxPerc,sp.prdid,sp.prdbatid,sp.baseqty ---------- Added By Lakshman M On 29-03-2018 Pms id:ICRSTPAR8158
	-- Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0 ------  commented by Lakshman M dated ON 14-09-2019 PMS ID: ILCRSTPAR2050
	 Having SUM(Sp.BaseQty * (Orgselrate-SplRate)) <> 0  -- PMS ID: ILCRSTPAR2190 ON 25-09-2018
RETURN  
END
GO
--Till Here SU
UPDATE UtilityProcess SET VersionId = '3.1.0.23' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.23',445
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 445)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(445,'D','2021-01-28',GETDATE(),1,'Core Stocky Service Pack 445')
GO