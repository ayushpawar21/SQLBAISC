--[Stocky HotFix Version]=444
DELETE FROM Versioncontrol WHERE Hotfixid='444'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone)
VALUES('444','3.1.0.22','D','2020-10-10','2020-10-10','2020-10-10',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: TCS')
GO
/*
	ILCRSTPAR8294 --> TCS Tax Column added  (MarySubashini S)  
	
	Proc_ImpSetupDetails,Proc_InStBaseDiscountClaim,Fn_GetDistributorData,
	PROC_Validate_WS2CS_NewCustomerRequest,Proc_RptBTBillTemplate,
	Proc_GR_BillWISESales,Proc_Export_CS2WS_Customer,Proc_Export_CS2WS_PricingPlan,
	Proc_ValidateRetailerMaster,Proc_ReturnSalesProductTaxPercentageNew,
	Proc_TOTClaimDetails_NEW,Proc_Cs2Cn_SpecialRateDifference,Proc_CN2CS_RouteMaster,
	Proc_Cn2Cs_RetailerGST,Proc_Cn2Cs_RetailerMasterUpdate,Proc_Validate_Product,
	Proc_Cn2Cs_TaxSetting,Proc_Cs2Cn_CostCenterNotAvailable,Proc_BackupUploadDailyOnceFlag,
	Proc_Console2CS_ConsolidatedDownload,Proc_SyncValidation,Proc_Cs2Cn_DNTSClaimBrandWise,
	Proc_Cs2Cn_DebitNoteTopSheetClaimDt,Proc_RptGRNListing
*/
--ILCRSTPAR8294 (TCS Tax Column added) 
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesInvoice' AND name='SalTCSTaxAmount')
BEGIN
	ALTER TABLE SalesInvoice ADD SalTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='SalesInvoiceProduct' AND name='PrdTCSTaxAmount')
BEGIN
	ALTER TABLE SalesInvoiceProduct ADD PrdTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='ReturnHeader' AND name='SalTCSTaxAmount')
BEGIN
	ALTER TABLE ReturnHeader ADD SalTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='ReturnProduct' AND name='PrdTCSTaxAmount')
BEGIN
	ALTER TABLE ReturnProduct ADD PrdTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='TCS Applicable' and MasterName='Distributor Info Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Distributor Info Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'TCS Applicable','Varchar',10,0,1,1,1,1,Getdate(),1,GETDATE(),0
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
			INSERT INTO UdcDefault(SeqId,MasterId,UdcMasterId,ColValue)
			SELECT 1,@MasterId,@UdcMasterId+1,'YES'
			UNION ALL
			SELECT 2,@MasterId,@UdcMasterId+1,'NO'
			
			SELECT @DistCode =DistributorCode FROM Distributor
			
			INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)	
			SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','TCS Applicable',@DistCode,'NO',0
			
			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='DISTRIBUTOR INFO MASTER')
			BEGIN		
				EXEC Proc_Validate_CN2CS_UdcDetails 0			
			END			
		END
	END
END
GO
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
                           WHERE ColumnName='TurnOver' and MasterName='Distributor Info Master')
BEGIN
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
                     
       SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Distributor Info Master'
       IF @MasterId>0
       BEGIN
              SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
              SET @UdcMasterId=ISNULL(@UdcMasterId,1)
              IF @UdcMasterId>0
              BEGIN
                     INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
                     ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
                     AuthDate,Editable)
                     SELECT @UdcMasterId+1,@MasterId,'TurnOver','Numeric',38,2,0,0,1,1,Getdate(),1,GETDATE(),1
                     
                     UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'             
              END
       END
END
GO
--DECLARE @MasterId AS INT
--DECLARE @UdcMasterId AS INT
--DECLARE @DistCode AS VARCHAR(50)
--IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
--				 WHERE ColumnName='TCS Effective Date' and MasterName='Distributor Info Master')
--BEGIN				 
--	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Distributor Info Master'
--	IF @MasterId>0
--	BEGIN
--		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
--		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
--		IF @UdcMasterId>0
--		BEGIN
--			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
--			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
--			AuthDate,Editable)
--			SELECT @UdcMasterId+1,@MasterId,'TCS Effective Date','DateTime',10,0,1,0,1,1,Getdate(),1,GETDATE(),0
				
--			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
--			SELECT @DistCode =DistributorCode FROM Distributor
			
--			INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)	
--			SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','TCS Effective Date',@DistCode,'NO',0
			
--			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='DISTRIBUTOR INFO MASTER')
--			BEGIN		
--				EXEC Proc_Validate_CN2CS_UdcDetails 0			
--			END			
--		END
--	END
--END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='TCS Applicable' and MasterName='Retailer Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'TCS Applicable','Varchar',10,0,1,1,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
			INSERT INTO UdcDefault(SeqId,MasterId,UdcMasterId,ColValue)
			SELECT 1,@MasterId,@UdcMasterId+1,'YES'
			UNION ALL
			SELECT 2,@MasterId,@UdcMasterId+1,'NO'
			

			
			INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)	
			SELECT DISTINCT 'Retailer Master','TCS Applicable',RtrCode,'NO',0
			FROM Retailer (NOLOCK)
			
			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Retailer Master')
			BEGIN		
				EXEC Proc_Validate_CN2CS_UdcDetails 0			
			END
			
			
			
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='PAN Number' and MasterName='Retailer Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'PAN Number','Varchar',15,0,1,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Aadhaar' and MasterName='Retailer Master')
BEGIN
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'

	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Aadhaar','Varchar',20,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
DECLARE @DistCode AS VARCHAR(50)
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='PAN/Aadhaar Available' and MasterName='Retailer Master')
BEGIN
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'

	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'PAN/Aadhaar Available','Varchar',10,0,1,1,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
			
			INSERT INTO UdcDefault(SeqId,MasterId,UdcMasterId,ColValue)
			SELECT 1,@MasterId,@UdcMasterId+1,'YES'
			UNION ALL
			SELECT 2,@MasterId,@UdcMasterId+1,'NO'
			
			
			INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)	
			SELECT DISTINCT 'Retailer Master','PAN/Aadhaar Available',RtrCode,'NO',0
			FROM Retailer (NOLOCK)
			
			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Retailer Master')
			BEGIN		
				EXEC Proc_Validate_CN2CS_UdcDetails 0			
			END
			
			
		END
	END
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TCS_BilledPrdDtCalculatedTax')
DROP TABLE TCS_BilledPrdDtCalculatedTax
GO
CREATE TABLE [TCS_BilledPrdDtCalculatedTax](
	[RowId] [int] NULL,
	[PrdId] [int] NULL,
	[PrdBatId] [int] NULL,
	[TaxSeqId] INT NOT NULL ,
	[TaxCode] VARCHAR(20) NULL,	
	[TaxPercentage] [numeric](12, 6) NULL,
	[TaxableAmount] [numeric](28, 6) NULL,
	[TaxAmount] [numeric](28, 6) NULL,
	[Usrid] [int] NULL,
	[TransId] [int] NULL
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TCS_InvoicePrdDtCalculatedTax')
DROP TABLE TCS_InvoicePrdDtCalculatedTax
GO
CREATE TABLE TCS_InvoicePrdDtCalculatedTax
(
	[RowId] [int] NULL,
	[PrdId] [int] NULL,
	[PrdBatId] [int] NULL,
	[TaxSeqId] INT NOT NULL ,
	[TaxCode] VARCHAR(20) NULL,	
	[TaxPercentage] [numeric](12, 6) NULL,
	[TaxableAmount] [numeric](28, 6) NULL,
	[TaxAmount] [numeric](28, 6) NULL,
	[Usrid] [int] NULL,
	[TransId] [int] NULL
)
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='InvoicePrdDtCalculatedTax_TCSFinal' and Xtype='U')
DROP TABLE InvoicePrdDtCalculatedTax_TCSFinal
GO
CREATE TABLE InvoicePrdDtCalculatedTax_TCSFinal
(
	[RowId] [int] NULL,
	[PrdId] [int] NULL,
	[PrdBatId] [int] NULL,
	[TaxId] [int] NULL,
	[TaxSlabId] [int] NULL,
	[TaxPercentage] [numeric](12, 6)NULL,
	[TaxableAmount] [numeric](28, 10) NULL,
	[TaxAmount] [numeric](28, 10) NULL,
	[Usrid] [int] NULL,
	[TransId] [int] NULL
)
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TCS_TaxSetting_Master')
BEGIN
CREATE TABLE TCS_TaxSetting_Master
(
	TaxCode Varchar(20) NOT NULL,
	TaxName	Varchar(100) NOT NULL,
	CoaId	INT NOT NULL,
	InputCoaId	INT NOT NULL,
	Availability TinyInt,
	LastModBy	TinyInt,
	LastModDate	DateTime,
	AuthId		TinyInt,
	AuthDate	DateTime,
	CONSTRAINT PK_TCS_TaxSetting_Master_TaxCode  PRIMARY KEY CLUSTERED(TaxCode)
)
END
GO
UPDATE Counters SET CurrValue =(SELECT MAX(CoaId) FROM CoaMaster (NOLOCK)) WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='TCS_TaxSetting_Details')
BEGIN
CREATE TABLE TCS_TaxSetting_Details(
	TaxSeqId INT	 NOT NULL ,
	TaxCode Varchar(20) NOT NULL,
	Eeffective_Date DateTime,	
	TaxPANAADHAR_YES		Numeric(12,6) NOT NULL,
	TaxPANAADHAR_NO		Numeric(12,6) NOT NULL,
	ActiveStatus		TinyInt,
	Availability TinyInt,
	LastModBy	TinyInt,
	LastModDate	DateTime,
	AuthId		TinyInt,
	AuthDate	DateTime,
	CONSTRAINT PK_TCS_TaxSetting_Details_TaxSeqId_TaxCode  PRIMARY KEY CLUSTERED(TaxSeqId,TaxCode),
	CONSTRAINT FK_TCS_TaxSetting_Details__TaxCode FOREIGN KEY (TaxCode) REFERENCES TCS_TaxSetting_Master(TaxCode)
	
)	
END
GO
IF NOT EXISTS(SELECT 'x' FROM SYSOBJECTS WHERE XTYPE='U' AND name='SalesInvoiceTCSTaxNew')
BEGIN
	CREATE TABLE SalesInvoiceTCSTaxNew
	(
		Salid BIGINT NOT NULL,
		PrdSlno INT NOT NULL,
		TaxSeqId INT NOT NULL,
		TaxCode Varchar(20) NOT NULL,
		[TaxPercentage] [numeric](12, 6) NOT NULL,
		[TaxableAmount] [numeric](28, 6) NOT NULL,
		[TaxAmount] [numeric](28, 6) NOT NULL,
		Availability TinyInt,
		LastModBy	TinyInt,
		LastModDate	DateTime,
		AuthId		TinyInt,
		AuthDate	DateTime,
		CONSTRAINT PK_SalesInvoiceTCSTax  PRIMARY KEY CLUSTERED(Salid,PrdSlno,TaxCode),
		CONSTRAINT FK_SalesInvoiceTCSTax__TaxCode FOREIGN KEY (TaxCode) REFERENCES TCS_TaxSetting_Master(TaxCode),
		CONSTRAINT FK_SalesInvoiceTCSTax__Salid FOREIGN KEY (Salid) REFERENCES SalesInvoice(Salid)
	)	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND name='Cn2Cs_Prk_TCS_Taxsetting_Dt')
DROP TABLE Cn2Cs_Prk_TCS_Taxsetting_Dt
GO
CREATE TABLE Cn2Cs_Prk_TCS_Taxsetting_Dt
(
	[DistCode] [nvarchar](100) NULL,
	TaxCode Varchar(20) NOT NULL,
	TaxName Varchar(100) NOT NULL,
	Eeffective_Date DateTime,	
	TaxPANAADHAR_YES		Numeric(12,6) NOT NULL,
	TaxPANAADHAR_NO		Numeric(12,6) NOT NULL,
	ActiveStatus		Varchar(20) NOT NULL,
	[DownLoadFlag] [nvarchar](100) NULL,
	[CreatedDate] [datetime] NULL
)
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Cn2Cs_Prk_DistTCSUDCDetails' and Xtype='U')
DROP TABLE Cn2Cs_Prk_DistTCSUDCDetails
GO
CREATE TABLE Cn2Cs_Prk_DistTCSUDCDetails
(
       [DistCode] [nvarchar](50) NULL,
       [ColumnName] [nvarchar](200) NULL,
       [ColumnValue] [nvarchar](100) NULL,
       [DownLoadFlag] [nvarchar](1) NULL,
       [CreatedDate] [datetime] NULL
)
GO
IF NOT EXISTS(SELECT 'x' FROM SYSOBJECTS WHERE XTYPE='U' AND name='ReturnProductTCSTaxNew')
BEGIN
	CREATE TABLE ReturnProductTCSTaxNew
	(
		Returnid BIGINT NOT NULL,
		PrdSlno INT NOT NULL,
		TaxSeqId INT NOT NULL,
		TaxCode Varchar(20) NOT NULL,
		[TaxPercentage] [numeric](12, 6) NOT NULL,
		[TaxableAmount] [numeric](28, 6) NOT NULL,
		[TaxAmount] [numeric](28, 6) NOT NULL,
		Availability TinyInt,
		LastModBy	TinyInt,
		LastModDate	DateTime,
		AuthId		TinyInt,
		AuthDate	DateTime,
		CONSTRAINT PK_ReturnProductTCSTaxNew  PRIMARY KEY CLUSTERED(Returnid,PrdSlno,TaxCode),
		CONSTRAINT FK_ReturnProductTCSTaxNew__TaxCode FOREIGN KEY (TaxCode) REFERENCES TCS_TaxSetting_Master(TaxCode),
		CONSTRAINT FK_ReturnProductTCSTaxNew__Returnid FOREIGN KEY (Returnid) REFERENCES ReturnHeader(Returnid)
	)	
END
GO
IF EXISTS (SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND name='Fn_TCSTaxApplicablePercentage')
DROP FUNCTION Fn_TCSTaxApplicablePercentage
GO
--SELECT DBO.Fn_TCSTaxApplicablePercentage(1,'2020-03-05')
CREATE FUNCTION [Fn_TCSTaxApplicablePercentage](@Pi_RtrId AS BIGINT,@Pi_ServerDate DateTime)
RETURNS TINYINT
AS
BEGIN
/*************************************************************************
* FUNCTION : Fn_TCSTaxApplicablePercentage
* PURPOSE  : Return TCS Tax percentage mode
* NOTES    : 
* CREATED  : Murugan.R
* MODIFIED 
 * DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  05/03/2020  Murugan.R		CR	
  18/09/2020  S.Moorthi		CR     DABCS202100016            TCS Tax Column added   
**************************************************************************/
	DECLARE @TaxMode AS TINYINT
	SET @TaxMode=0
	--Distributor TCS Applicable		
	IF NOT EXISTS(SELECT 'X' FROM  Distributor A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.DistributorId
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='TCS Applicable'
	WHERE E.MasterId=16 and UPPER(D.ColumnValue)='YES')
	BEGIN
		SET @TaxMode=0
		RETURN (@TaxMode)
	END
	---Retailer TCS Applicable
	IF NOT EXISTS(SELECT 'X' FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='TCS Applicable' 
	WHERE E.MasterId=2 and UPPER(D.ColumnValue)='YES' and D.MasterRecordId=@Pi_RtrId)
	BEGIN
		SET @TaxMode=0
		RETURN (@TaxMode)
	END
	---Tax Percentage 
	IF EXISTS (SELECT 'X' FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='PAN/Aadhaar Available'
	WHERE E.MasterId=2 and UPPER(D.ColumnValue)=UPPER('YES') and D.MasterRecordId=@Pi_RtrId)
	BEGIN
		SET @TaxMode = 1
		RETURN (@TaxMode)
	END
	
	IF EXISTS (SELECT 'X' FROM Retailer A (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId 
	INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
	AND E.ColumnName='PAN/Aadhaar Available'
	WHERE E.MasterId=2 and UPPER(D.ColumnValue)=UPPER('NO') and D.MasterRecordId=@Pi_RtrId)
	BEGIN
		SET @TaxMode =2
		RETURN (@TaxMode)
	END
	
	RETURN(@TaxMode)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_Cn2Cs_TCS_TaxSetting')
DROP PROCEDURE  Proc_Cn2Cs_TCS_TaxSetting
GO
CREATE PROCEDURE Proc_Cn2Cs_TCS_TaxSetting
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_TCS_TaxSetting
* PURPOSE		: To validate and insert TCS Tax details
* CREATED		: Murugan.R
* CREATED DATE	: 21/02/2020
* MODIFIED
* DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  18/09/2020  S.Moorthi		SR      DABCS202100016            TCS Tax Column added   
**************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @AcCode			VARCHAR(20)	
	DECLARE @TaxCode		NVARCHAR(200)	
	DECLARE @TaxName		NVARCHAR(200)
	DECLARE @OutPutTaxId	INT
	DECLARE @InPutTaxId	INT
	DECLARE @TaxSeqId AS INT
		
		DELETE FROM Cn2Cs_Prk_TCS_Taxsetting_Dt WHERE DownLoadFlag='Y'
		
			
		CREATE TABLE #Cn2Cs_Prk_TCS_Taxsetting_Dt
		(
		TaxCode Varchar(20) NOT NULL,
		TaxName Varchar(100) NOT NULL,
		Eeffective_Date DateTime,	
		TaxPANAADHAR_YES		Numeric(12,6) NOT NULL,
		TaxPANAADHAR_NO		Numeric(12,6) NOT NULL,
		ActiveStatus		TINYINT
		)
	
		SELECT TaxCode,MAX([CreatedDate]) as [CreatedDate] 
		INTO #TaxMax
		FROM Cn2Cs_Prk_TCS_Taxsetting_Dt WHERE DownLoadFlag='D'
		GROUP BY TaxCode
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Cn2Cs_Prk_TCS_Taxsetting_Dt','TaxCode','Tax Code:'+A.TaxCode+' : Mandatory Field validation failed' 
		FROM Cn2Cs_Prk_TCS_Taxsetting_Dt A (NOLOCK) INNER JOIN  #TaxMax B ON A.TaxCode=B.TaxCode
		AND A.CreatedDate=B.CreatedDate
		WHERE DownLoadFlag='D'
		AND (
		LEN(LTRIM(RTRIM(ISNULL(A.TaxCode,''))))=0 OR 
		LEN(LTRIM(RTRIM(ISNULL(ActiveStatus,'ACTIVE'))))=0 OR
		(ISNULL(TaxPANAADHAR_YES,0)+ISNULL(TaxPANAADHAR_NO,0))=0 OR
		LEN(LTRIM(RTRIM(ISNULL(A.TaxName,''))))=0		
		)
		
		INSERT INTO #Cn2Cs_Prk_TCS_Taxsetting_Dt(TaxCode,TaxName,Eeffective_Date,TaxPANAADHAR_YES,TaxPANAADHAR_NO,ActiveStatus)
		SELECT DISTINCT ISNULL(A.TaxCode,'') as TaxCode,ISNULL(TaxName,'') as TaxName,
		ISNULL(Eeffective_Date,CONVERT(VARCHAR(10),GETDATE(),121)),
		ISNULL(TaxPANAADHAR_YES,0) as TaxWithGSTIN,
		ISNULL(TaxPANAADHAR_NO,0) as TaxWithoutGSTIN,
		CASE ISNULL(ActiveStatus,'ACTIVE') WHEN 'ACTIVE' THEN 1 ELSE 0 END as ActiveStatus	
		FROM Cn2Cs_Prk_TCS_Taxsetting_Dt A (NOLOCK) INNER JOIN  #TaxMax B ON A.TaxCode=B.TaxCode
		AND A.CreatedDate=B.CreatedDate
		WHERE DownLoadFlag='D'
		AND (
		LEN(LTRIM(RTRIM(ISNULL(A.TaxCode,''))))<>0 AND 
		LEN(LTRIM(RTRIM(ISNULL(ActiveStatus,'ACTIVE'))))<>0 AND
		(ISNULL(TaxPANAADHAR_YES,0)+ISNULL(TaxPANAADHAR_NO,0))<>0 AND
		LEN(LTRIM(RTRIM(ISNULL(A.TaxName,''))))<>0		
		)

	DECLARE Cur_TCStax CURSOR
	FOR SELECT DISTINCT TaxCode,TaxName FROM #Cn2Cs_Prk_TCS_Taxsetting_Dt 	
	OPEN Cur_TCStax
	FETCH NEXT FROM Cur_TCStax INTO @TaxCode,@TaxName
	WHILE @@FETCH_STATUS=0
	BEGIN		
			SET @AcCode=''
				
			IF NOT EXISTS(SELECT 'X' FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='1' and accode like '131%'
			AND AcName=@TaxName)
			BEGIN
						IF NOT EXISTS(SELECT * FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
						WHERE a.aclevel= '4' and a.maingroup='1' and a.accode like '131%'))
						BEGIN
							SET @AcCode = '1310001'
						END
						ELSE
						BEGIN
							SELECT @AcCode=AcCode FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
							WHERE a.aclevel= '4' and a.maingroup='1' and a.accode like '131%')
							SET @AcCode= CAST(@AcCode AS BIGINT) + 1
						END
						
						SELECT @OutPutTaxId=MAX(CoaId) FROM COAMaster (NOLOCK)
						SET @OutPutTaxId=ISNULL(@OutPutTaxId,0)+1
						
						INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
													LastModDate,AuthId,AuthDate) VALUES (@OutPutTaxId,CAST(@AcCode AS VARCHAR(50)),
													CAST(@TaxName AS VARCHAR(100)),4,1,0,1,1,GETDATE(),1,GETDATE())

						
						UPDATE Counters SET CurrValue = @OutPutTaxId WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
				END
				ELSE
				BEGIN
					SELECT @OutPutTaxId=CoaId FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='1' and accode like '131%'
					AND AcName=@TaxName
				END	
			--Input tax
				
			SET @AcCode=''
				
			IF NOT EXISTS(SELECT 'X' FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='2' and accode like '217%'
			AND AcName=@TaxName)
			BEGIN
						IF NOT EXISTS(SELECT * FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
						WHERE a.aclevel= '4' and a.maingroup='2' and a.accode like '217%'))
						BEGIN
							SET @AcCode = '2170001'
						END
						ELSE
						BEGIN
							SELECT @AcCode=AcCode FROM coamaster (NOLOCK) WHERE coaid=(SELECT max(a.coaid) FROM coamaster a
							WHERE a.aclevel= '4' and a.maingroup='2' and a.accode like '217%')
							SET @AcCode= CAST(@AcCode AS BIGINT) + 1
						END
						
						SELECT @InPutTaxId=MAX(CoaId) FROM COAMaster (NOLOCK)
						SET @InPutTaxId=ISNULL(@InPutTaxId,0)+1
						
						INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
													LastModDate,AuthId,AuthDate) VALUES (@InPutTaxId,CAST(@AcCode AS VARCHAR(50)),
													CAST(@TaxName AS VARCHAR(100)),4,2,0,1,1,GETDATE(),1,GETDATE())

						
						UPDATE Counters SET CurrValue = @InPutTaxId WHERE TabName = 'CoaMaster' AND FldName = 'CoaId'
				END
				ELSE
				BEGIN
					SELECT @InPutTaxId=CoaId FROM 	coamaster (NOLOCK) WHERE aclevel= '4' and maingroup='2' and accode like '217%'
					AND AcName=@TaxName
				END	
				
				
					
				
				INSERT INTO TCS_TaxSetting_Master(TaxCode,TaxName,CoaId,InputCoaId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				SELECT DISTINCT @TaxCode,@TaxName,@OutPutTaxId,@InPutTaxId,1,1,GETDATE(),1,GETDATE()
				FROM #Cn2Cs_Prk_TCS_Taxsetting_Dt A 
				WHERE NOT EXISTS(SELECT TaxCode FROM TCS_TaxSetting_Master B (NOLOCK) WHERE A.TaxCode=B.TaxCode) 
				AND TaxCode=@TaxCode
				
				UPDATE TCS_TaxSetting_Master SET TaxName=@TaxName,CoaId=@OutPutTaxId,InputCoaId=@InPutTaxId
				WHERE TaxCode=@TaxCode
				
	FETCH NEXT FROM Cur_TCStax INTO @TaxCode,@TaxName
	END
	CLOSE Cur_TCStax
	DEALLOCATE Cur_TCStax
	
	
	SELECT @TaxSeqId=MAX(TaxSeqId) FROM TCS_TaxSetting_Details (NOLOCK)
	SET @TaxSeqId=ISNULL(@TaxSeqId,0)
	
	INSERT INTO TCS_TaxSetting_Details(TaxSeqId,TaxCode,Eeffective_Date,TaxPANAADHAR_YES,TaxPANAADHAR_NO,ActiveStatus,
	Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT @TaxSeqId+ROW_NUMBER()OVER(ORDER BY TaxCode), TaxCode,CONVERT(DATETIME,CONVERT(VARCHAR(10),Eeffective_Date,121),121),TaxPANAADHAR_YES,TaxPANAADHAR_NO,ActiveStatus,
	1,1,GETDATE(),1,GETDATE()
	FROM #Cn2Cs_Prk_TCS_Taxsetting_Dt A
	WHERE NOT EXISTS(SELECT * FROM TCS_TaxSetting_Details B (NOLOCK) WHERE A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Eeffective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Eeffective_Date,121),121)
	AND A.TaxPANAADHAR_YES=B.TaxPANAADHAR_YES
	AND A.TaxPANAADHAR_NO=B.TaxPANAADHAR_NO)
	ORDER BY CONVERT(DATETIME,CONVERT(Varchar(10),A.Eeffective_Date,121),121)
	
	UPDATE A SET A.ActiveStatus=B.ActiveStatus FROM TCS_TaxSetting_Details  A
	INNER JOIN #Cn2Cs_Prk_TCS_Taxsetting_Dt B (NOLOCK) ON A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Eeffective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Eeffective_Date,121),121)
	AND A.TaxPANAADHAR_YES=B.TaxPANAADHAR_YES
	AND A.TaxPANAADHAR_NO=B.TaxPANAADHAR_NO

	
	
	UPDATE A SET [DownLoadFlag]='Y' FROM Cn2Cs_Prk_TCS_Taxsetting_Dt A INNER JOIN TCS_TaxSetting_Details B 
	ON A.Taxcode=B.TaxCode
	AND CONVERT(DATETIME,CONVERT(Varchar(10),A.Eeffective_Date,121),121)=CONVERT(DATETIME,CONVERT(Varchar(10),B.Eeffective_Date,121),121)
	AND A.TaxPANAADHAR_YES=B.TaxPANAADHAR_YES
	AND A.TaxPANAADHAR_NO=B.TaxPANAADHAR_NO
	WHERE [DownLoadFlag]='D'

	RETURN
END
GO
/**
INSERT INTO Cn2Cs_Prk_TCS_Taxsetting_Dt(DistCode,
TaxCode,
TaxName,
Eeffective_Date,
TaxPANAADHAR_YES,
TaxPANAADHAR_NO,
ActiveStatus,
DownLoadFlag,
CreatedDate)
SELECT '','TCS','TCS',GETDATE(),2 as TaxWithGSTIN,1 as TaxWithoutGSTIN,'ACTIVE','D',Getdate()
BEGIN TRAN
EXEC Proc_Cn2Cs_TCS_TaxSetting 0
SELECT * FROM coaMaster (NOLOCK) Order by Coaid Desc
SELECT * FROM TCS_TaxSetting_Master
SELECT * FROM TCS_TaxSetting_Details
SELECT * FROM Cn2Cs_Prk_TCS_Taxsetting_Dt
EXEC Proc_Cn2Cs_TCS_TaxSetting 0
--Update TCS_TaxSetting_Details SET TaxWithoutGSTIN=.1
ROLLBACK TRAN
**/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_TCS_ComputeTax')
DROP PROCEDURE Proc_TCS_ComputeTax
GO
CREATE PROCEDURE Proc_TCS_ComputeTax
(      
	 @Pi_RowId  INT,      
	 @Pi_CalledFrom  INT,        
	 @Pi_UserId  INT,
	 @Pi_RtrShipId  INT=0,
	 @Pi_gServerDate DateTime='1990-01-01',
	 @TaxMode AS TINYINT
)      
AS      
/****************************************************************************************      
* PROCEDURE : Proc_TCS_ComputeTax      
* PURPOSE : To Calculate the Line Level TCS Tax      
* CREATED : Murugan.R      
* CREATED DATE : 22/02/2020     
* MODIFIED
* DATE			AUTHOR				USER STORY ID	CR/BZ	    DESCRIPTION  
**************************************************************************                       
* 22/02/2020    MURUGAN.R           ICRSTMRC7864       CR      To Calculate the Line Level TCS Tax  
* 18/09/2020	MarySubashini.S		DABCS202100016	   CR      TCS Tax Changes  
*************************************************************************        
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
*********************************/       
SET NOCOUNT ON      
BEGIN  

DECLARE @TcsTaxSeqId AS INT
DECLARE @TCSTaxCode AS VARCHAR(20)
DECLARE @TaxPANAADHAR_YES AS NUMERIC(12,6)
DECLARE @TaxPANAADHAR_NO AS NUMERIC(12,6)

	SET @TCSTaxCode='TCS'

	DELETE FROM TCS_BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId        
	AND TransId = @Pi_CalledFrom  

	IF @TaxMode=0
	BEGIN
	  RETURN
	END
	
	
	SELECT @TcsTaxSeqId=MAX(TaxSeqId) FROM TCS_TaxSetting_Master A (NOLOCK) INNER JOIN TCS_TaxSetting_Details B (NOLOCK) ON 
	A.TaxCode=B.TaxCode WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),Eeffective_Date,121),121) <=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121)
	AND A.TaxCode=@TCSTaxCode AND ActiveStatus=1
	SET @TcsTaxSeqId=ISNULL(@TcsTaxSeqId,0)

	IF NOT EXISTS(SELECT 'X' FROM TCS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TcsTaxSeqId and Taxcode=@TCSTaxCode)
	BEGIN
		RETURN
	END

	SELECT @TaxPANAADHAR_YES=TaxPANAADHAR_YES,@TaxPANAADHAR_NO=TaxPANAADHAR_NO 
	FROM TCS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TcsTaxSeqId and Taxcode=@TCSTaxCode
	

	INSERT INTO TCS_BilledPrdDtCalculatedTax(RowId,PrdId,PrdBatId,TaxSeqId,TaxCode,TaxPercentage,TaxableAmount,TaxAmount,Usrid,TransId)
	SELECT RowId,PrdId,PrdbatId,@TcsTaxSeqId,@TCSTaxCode,
	CASE @TaxMode WHEN 1 THEN ISNULL(@TaxPANAADHAR_YES,0)
				  WHEN 2 THEN ISNULL(@TaxPANAADHAR_NO,0)
	END TaxPercentage,			  
	ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)) as  TaxableAmount,
	CASE @TaxMode WHEN 1 THEN ((ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)))*(ISNULL(@TaxPANAADHAR_YES,0)/100.00))
				  WHEN 2 THEN ((ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)))*(ISNULL(@TaxPANAADHAR_NO,0)/100.00)) 
	END TaxAmount,
	@Pi_UserId as Usrid,@Pi_CalledFrom as TransId
	FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE UsrId=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
	AND TaxableAmount>0
	GROUP BY  RowId,PrdId,PrdbatId
RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_TCS_ComputeTax_SR')
DROP PROCEDURE Proc_TCS_ComputeTax_SR
GO
CREATE PROCEDURE Proc_TCS_ComputeTax_SR
(      
	 @Pi_RowId  INT,      
	 @Pi_CalledFrom  INT,        
	 @Pi_UserId  INT,
	 @Pi_RtrShipId  INT=0,
	 @Pi_gServerDate DateTime='1990-01-01',
	 @TaxMode AS TINYINT,
	 @Salid Int,
	 @SRMODE int
)      
AS      
/****************************************************************************************      
* PROCEDURE : Proc_TCS_ComputeTax_SR      
* PURPOSE : To Calculate the Line Level TCS Tax      
* CREATED : Murugan.R      
* CREATED DATE : 22/02/2020     
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]      [DESCRIPTION]
* 22/02/2020    MURUGAN>R          ICRSTMRC7864       CR      To Calculate the Line Level TCS Tax  
* 18/09/2020	MarySubashini.S	   DABCS202100016	  CR      TCS Tax Changes
----------------------------------------------------------------------------------------      
* {date} {developer}  {brief modification description}            
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
*********************************/       
SET NOCOUNT ON      
BEGIN  

DECLARE @TcsTaxSeqId AS INT
DECLARE @TCSTaxCode AS VARCHAR(20)
DECLARE @TaxPANAADHAR_YES AS NUMERIC(12,6)
DECLARE @TaxPANAADHAR_NO AS NUMERIC(12,6)

	SET @TCSTaxCode='TCS'

	DELETE FROM TCS_BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId        
	AND TransId = @Pi_CalledFrom  

	--IF @TaxMode=0
	--BEGIN
	--  RETURN
	--END

	IF NOT EXISTS (SELECT 'X' FROM SalesInvoiceTCSTaxNew WHERE Salid=@Salid)
	BEGIN
	    RETURN
	END
	
	
	--SELECT @TcsTaxSeqId=MAX(TaxSeqId) FROM TCS_TaxSetting_Master A (NOLOCK) INNER JOIN TCS_TaxSetting_Details B (NOLOCK) ON 
	--A.TaxCode=B.TaxCode WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),Eeffective_Date,121),121) <=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121)
	--AND A.TaxCode=@TCSTaxCode AND ActiveStatus=1
	--SET @TcsTaxSeqId=ISNULL(@TcsTaxSeqId,0)

	--IF NOT EXISTS(SELECT 'X' FROM TCS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TcsTaxSeqId and Taxcode=@TCSTaxCode)
	--BEGIN
	--	RETURN
	--END

	--SELECT @TaxPANAADHAR_YES=TaxPANAADHAR_YES,@TaxPANAADHAR_NO=TaxPANAADHAR_NO 
	--FROM TCS_TaxSetting_Details (NOLOCK) WHERE TaxSeqId=@TcsTaxSeqId and Taxcode=@TCSTaxCode

	SET @TaxPANAADHAR_YES=(select TOP 1 taxPercentage from SalesInvoiceTCSTaxNew(Nolock) where Salid=@Salid)
	SET @TcsTaxSeqId=(select TOP 1 TaxSeqId from SalesInvoiceTCSTaxNew(Nolock) where Salid=@Salid)
	--SET @TCSTaxCode=(select TOP 1 TaxCode from SalesInvoiceTCSTaxNew(Nolock) where Salid=@Salid)
	

	INSERT INTO TCS_BilledPrdDtCalculatedTax(RowId,PrdId,PrdBatId,TaxSeqId,TaxCode,TaxPercentage,TaxableAmount,TaxAmount,Usrid,TransId)
	SELECT RowId,PrdId,PrdbatId,@TcsTaxSeqId,@TCSTaxCode,
	--CASE @TaxMode WHEN 1 THEN ISNULL(@TaxPANAADHAR_YES,0)
	--			  WHEN 2 THEN ISNULL(@TaxPANAADHAR_NO,0)
	--END 
	ISNULL(@TaxPANAADHAR_YES,0) as TaxPercentage,			  
	ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)) as  TaxableAmount,
	--CASE @TaxMode WHEN 1 THEN ((ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)))*(ISNULL(@TaxPANAADHAR_YES,0)/100.00))
	--			  WHEN 2 THEN ((ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)))*(ISNULL(@TaxPANAADHAR_NO,0)/100.00)) 
	--END TaxAmount,
	((ISNULL(MAX(TaxableAmount),0)+Sum(Isnull(TaxAmount,0)))*(ISNULL(@TaxPANAADHAR_YES,0)/100.00)) as TAXAmount,
	@Pi_UserId as Usrid,@Pi_CalledFrom as TransId
	FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE UsrId=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
	AND TaxableAmount>0
	GROUP BY  RowId,PrdId,PrdbatId
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_CN2CS_DistTCSUDCDetails' and Xtype='P')
DROP PROCEDURE Proc_CN2CS_DistTCSUDCDetails
GO
/*
BEGIN Transaction
 EXEC Proc_CN2CS_DistTCSUDCDetails 0
Rollback Transaction
*/
CREATE PROCEDURE Proc_CN2CS_DistTCSUDCDetails
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*********************************    
* PROCEDURE: Proc_Validate_CN2CS_UdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: S.Moorthi
*************************************************
* DATE       AUTHOR     CR/BZ  USER STORY ID       DESCRIPTION                         
*********************************************************************************************
02-09-2020   Kishore       CR      NIVCS202100015      TCS Tax Amount included
*********************************/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	SET @TabName = 'Cn2Cs_Prk_DistTCSUDCDetails'  
	SET @Po_ErrNo =0

	DELETE FROM Cn2Cs_Prk_DistTCSUDCDetails WHERE DownloadFlag='Y'

	select @ColCode=DistributorCode from Distributor
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT ISNULL([ColumnName],'') ColumnName,ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM Cn2Cs_Prk_DistTCSUDCDetails (NOLOCK) WHERE DownloadFlag='D' AND ColumnName in ('TCS Applicable','TurnOver')
		Order by CreatedDate
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @ColName,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 
		IF @Po_ErrNo = 0 
		BEGIN
			
		  SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')


				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
							  
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
	
	

			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				
			END
	END
	
		FETCH NEXT FROM Cur_UdcDt INTO @ColName,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
	UPDATE Cn2Cs_Prk_DistTCSUDCDetails SET DownLoadFlag='Y' WHERE ColumnName in ('TCS Applicable','TurnOver')
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_VoucherPostingSales' and Xtype='P')
DROP PROCEDURE Proc_VoucherPostingSales
GO
/*
Begin Transaction
EXEC Proc_VoucherPosting 3,1,'GSTR1700019',4,0,1,'2017-10-26',0
RollBack Transaction
*/
CREATE PROCEDURE Proc_VoucherPostingSales
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/******************************************************************************************
* PROCEDURE	: Proc_VoucherPostingSales
* PURPOSE	: General SP for posting Sales Account
* CREATED	: Thrinath
* CREATED DATE	: 26/12/2007
* MODIFIED
* DATE       AUTHOR			CR/BZ  USER STORY ID       DESCRIPTION                         
*********************************************************************************************
16/03/2020	MarySubashini.S	   ILCRSTPAR8294	  CR      TCS Tax Changes
**********************************************************************************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @SalRtnId	INT
DECLARE @Cnt		INT
DECLARE @DCoaId		INT
DECLARE @CCoaId		INT
DECLARE @sSql           VARCHAR(4000)
DECLARE @InputCoaid  INT  ---ILCRSTPAR8294
SET @Po_PurErrNo = 1
IF @Pi_TransId = 3 AND @Pi_SubTransId = 1	--Sales Return
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Sale Return Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From SalesReturn ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
	--For Posting Sales Return Account in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110002')
	BEGIN
		SET @Po_PurErrNo = -19
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110002'
	SELECT  @Amt = SUM(B.PrdActualGross) FROM ReturnHeader A INNER JOIN ReturnProduct B
	ON A.ReturnId=B.ReturnId WHERE A.ReturnCode = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReturnHeader C ON B.RtrId = C.RtrId
		WHERE C.ReturnCode = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReturnHeader C ON B.RtrId = C.RtrId
		WHERE C.ReturnCode = @Pi_ReferNo
		
	IF NOT EXISTS (SELECT RtnRoundOff FROM ReturnHeader WHERE ReturnCode = @Pi_ReferNo 
			AND RtnRoundOff=1)
	BEGIN
		SELECT @Amt = SUM(A.PrdNetAmt)+SUM(A.EditedNetRte)+Sum(A.PrdTCSTaxAmount)  FROM ReturnProduct A   ---ILCRSTPAR8294
			      INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId
			      WHERE B.ReturnCode = @Pi_ReferNo
	END
	ELSE
	BEGIN
		SELECT @Amt = SUM(A.PrdNetAmt)+SUM(A.EditedNetRte) +Sum(A.PrdTCSTaxAmount)---ILCRSTPAR8294
					FROM ReturnProduct A 
			      INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId
			      WHERE B.ReturnCode = @Pi_ReferNo
		SELECT @Amt=@Amt+RtnRoundOffAmt FROM ReturnHeader 
				WHERE ReturnCode = @Pi_ReferNo
	END
	
	--->Added By Nanda on 11/04/2011 for Invoice Level Discount
	SELECT @Amt=@Amt-ISNULL(RtnInvLvlDisc,0) FROM ReturnHeader WHERE ReturnCode = @Pi_ReferNo
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Invoice Level Discount Account in Details Table On Credit
	--Added By Nanda on 11/04/2011 
	IF EXISTS (SELECT RtnInvLvlDisc FROM ReturnHeader (NOLOCK) WHERE ReturnCode = @Pi_ReferNo AND RtnInvLvlDisc>0)
	BEGIN
		SELECT @Amt=0
		SELECT @CoaId = D.CoaId FROM  ReturnHeader A (NOLOCK) INNER JOIN BillSequenceDetail D (NOLOCK) ON
							D.BillSeqId = A.BillSeqId AND D.RefCode='G' WHERE A.ReturnCode =@Pi_ReferNo
		SELECT @Amt =RtnInvLvlDisc FROM ReturnHeader (NOLOCK) WHERE ReturnCode = @Pi_ReferNo
		IF NOT EXISTS (SELECT CoaId FROM StdVocDetails WHERE CoaId =@CoaId AND VocRefNo=@VocRefNo)
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		END
		ELSE
		BEGIN
			UPDATE StdVocDetails SET Amount=Amount+@Amt WHERE CoaId=@CoaId AND VocRefNo=@VocRefNo
		END
	END 
	--Till Here
	--For Posting Sales Return Discount Account in Details Table to Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,2,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = @Pi_ReferNo AND
			B.EffectInNetAmount = 2 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,2,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + ''' AND
			B.EffectInNetAmount = 2 AND B.BaseQtyAmount > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Return Addition in Details Table to Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,1,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = @Pi_ReferNo AND B.RefCode <> 'H' AND
			B.EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,1,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + ''' AND B.RefCode <> ''' + 'H' + ''' AND
			B.EffectInNetAmount = 1 AND B.BaseQtyAmount > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Return Tax Account in Details Table on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.OutPutTaxId,1,ISNULL(SUM(B.TaxAmt),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnProductTax B ON
			A.ReturnId = B.ReturnId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.ReturnCode = @Pi_ReferNo
		Group By C.OutPutTaxId
		HAVING ISNULL(SUM(B.TaxAmt),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.OutPutTaxId,1,ISNULL(SUM(B.TaxAmt),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM ReturnHeader A INNER JOIN ReturnProductTax B ON
			A.ReturnId = B.ReturnId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + '''
		Group By C.OutPutTaxId
		HAVING ISNULL(SUM(B.TaxAmt),0) > 0'
	
	
	 ---Sales Return TCS Tax posting  ILCRSTPAR8294

   		SET  @InputCoaid =(SELECT TOP 1 D.InputCoaId 
		FROM ReturnHeader A INNER JOIN ReturnProductTCSTaxNew B ON
			A.Returnid = B.Returnid
		INNER JOIN TCS_TaxSetting_Details C ON
			B.TaxSeqId = C.TaxSeqId and B.TaxCode=C.TaxCode
		INNER JOIN TCS_TaxSetting_Master D ON C.TaxCode=d.TaxCode
		WHERE A.ReturnCode = @Pi_ReferNo AND A.ReturnDate = Convert(varchar(10),@Pi_VocDate,121))

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,@InputCoaid,1,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnProductTCSTaxNew B ON
			A.ReturnId = B.ReturnId
		WHERE A.ReturnCode = @Pi_ReferNo
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0

	---ILCRSTPAR8294  
	
	-- Posting the Selling Rate and Net Rate Difference
	SET @Amt = 0
	SELECT @SalRtnId= ReturnId FROM ReturnHeader WHERE ReturnCode=@Pi_ReferNo
	SET @SalRtnId = ISNULL(@SalRtnId,0)
	SELECT @Amt=SUM(RateDiff) FROM 
	(SELECT CASE  WHEN Slno > 0 THEN PrdRateDiffAmt + EditedNetRte WHEN Slno<0 THEN PrdRateDiffAmt + EditedNetRte  END AS RateDiff
	FROM ReturnProduct WHERE ReturnId = @SalRtnId)a
	HAVING SUM(RateDiff) <> 0
	
	IF @Amt < 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3210003')
		BEGIN
			SET @Po_PurErrNo = -15
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3210003'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	IF @Amt > 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220007')
		BEGIN
			SET @Po_PurErrNo = -16
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220007'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account reduce in Details Table to Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3220001')
	BEGIN
		SET @Po_PurErrNo = -4
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3220001'
	SET @Amt = 0
	SELECT @Amt = RtnRoundoffAmt FROM ReturnHeader WHERE ReturnCode = @Pi_ReferNo
		AND RtnRoundOffAmt > 0
	
	IF @Amt > 0
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,Abs(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(Abs(@Amt) As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account Add in Details Table to Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210001')
	BEGIN
		SET @Po_PurErrNo = -5
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210001'
	SET @Amt = 0
	SELECT @Amt = RtnRoundoffAmt FROM ReturnHeader WHERE ReturnCode = @Pi_ReferNo
		AND RtnRoundOffAmt < 0
	
	IF @Amt < 0
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(ABS(@Amt) As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account Add in Details Table to Debit
	SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
	IF @sSql='-4'
	BEGIN
		SET @Po_PurErrNo = -4
		Return
	END
	ELSE IF @sSql='-5'
	BEGIN
		SET @Po_PurErrNo = -5
		Return
	END
	ELSE IF @sSql<>'0'
	BEGIN
		EXEC(@sSql)
	END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId=24		--Return And Replacement
BEGIN
	IF @Pi_SubTransId=1	--Return
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		--For Posting Return Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Return & Replacement - Return '
			+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
			
		--For Posting Sales Return Account in Details Table on Debit
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110002')
		BEGIN
			SET @Po_PurErrNo = -19
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110002'
	
		SELECT @Amt = ROUND(SUM(RtnQty*SelRte),2) FROM ReplacementIn WHERE RepRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)		
	
		--For Posting Input Tax in Details Table on Debit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,C.OutputTaxId,1,ROUND(ISNULL(SUM(B.TaxAmount),0),2),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM ReplacementHd A INNER JOIN ReplacementInPrdTax B ON A.RepRefNo = B.RepRefNo
			INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
			WHERE A.RepRefNo = @Pi_ReferNo Group By C.OutputTaxId
			HAVING ISNULL(SUM(B.TaxAmount),0) > 0
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT ''' + @VocRefNo + ''',C.OutputTaxId,1,ISNULL(SUM(B.TaxAmount),0),1,' +
			CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
			FROM ReplacementHd A INNER JOIN ReplacementInPrdTax B ON A.RepRefNo = B.RepRefNo
			INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
			WHERE A.RepRefNo = ''' + @Pi_ReferNo + '''Group By C.OutputTaxId
			HAVING ISNULL(SUM(B.TaxAmount),0) > 0'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)				
	
		--For Posting Retailer Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
			WHERE C.RepRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
			WHERE C.RepRefNo = @Pi_ReferNo
	
		SELECT @Amt = ROUND(SUM(RtnAmount),2) FROM ReplacementIn WHERE RepRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	
		--Validate Credit amount is Equal to Debit
		
			SELECT DebitCredit,Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo
		
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	
	END
	ELSE IF @Pi_SubTransId=2	--Replacement
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting Replacement Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Return and Replacement - Replacement '
			+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
		--For Posting Replacement Account in Details Table on Credit
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110001')
		BEGIN
			SET @Po_PurErrNo = -17
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110001'
	
		SELECT @Amt = ROUND(SUM(RepQty*SelRte),2) FROM ReplacementOut WHERE RepRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Output Tax in Details Table on Credit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,C.OutputTaxId,2,ROUND(ISNULL(SUM(B.TaxAmount),0),2),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM ReplacementHd A INNER JOIN ReplacementOutPrdTax B ON A.RepRefNo = B.RepRefNo
			INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
			WHERE A.RepRefNo = @Pi_ReferNo Group By C.OutputTaxId
			HAVING ISNULL(SUM(B.TaxAmount),0) > 0
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT ''' + @VocRefNo + ''',C.OutputTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,' +
			CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
			FROM ReplacementHd A INNER JOIN ReplacementOutPrdTax B ON A.RepRefNo = B.RepRefNo
			INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
			WHERE A.RepRefNo = ''' + @Pi_ReferNo + '''Group By C.OutputTaxId
			HAVING ISNULL(SUM(B.TaxAmount),0) > 0'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)		
	
		--For Posting Retailer Account in Details Table to Debit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
			WHERE C.RepRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
			WHERE C.RepRefNo = @Pi_ReferNo
	
		SELECT @Amt = ROUND(SUM(RepAmount),2) FROM ReplacementOut WHERE RepRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END	
		
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END	
IF @Pi_TransId = 29 AND @Pi_SubTransId = 1	--Sales Voucher
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE CONVERT(nVarChar(10),@Pi_VocDate,121) between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Sales Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,CONVERT(nVarChar(10),@Pi_VocDate,121),'Posted From Billing ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	SELECT @Pi_VocDate=Salinvdate FROM Salesinvoice (NOLOCK) WHERE SalInvNo = @Pi_ReferNo
	
	--For Posting Retailer Account in Details Table on Debit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvNo = @Pi_ReferNo)-- AND C.SalInvDate = Convert(varchar(10),@Pi_VocDate,121))
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvNo = @Pi_ReferNo --AND C.SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
	SELECT @Amt = (SalNetAmt + OnAccountAmount + MarketRetAmount + CrAdjAmount -
		ReplacementDiffAmount - DBAdjAmount) FROM SalesInvoice Where SalInvNo = @Pi_ReferNo AND SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Account in Details Table on Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110001')
	BEGIN
		SET @Po_PurErrNo = -17
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110001'
	SELECT @Amt = SUM(PrdGrossAmount) FROM SalesInvoiceProduct WHERE SalId IN 
	(SELECT SalId FROM SalesInvoice Where SalInvNo = @Pi_ReferNo AND SalInvDate = Convert(varchar(10),@Pi_VocDate,121))
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Discount Account in Details Table On Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,1,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalesInvoiceHdAmount B ON
			A.SalId = B.SalId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.SalInvNo = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121) AND 
			EffectInNetAmount = 2 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,1,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM SalesInvoice A INNER JOIN SalesInvoiceHdAmount B ON
			A.SalId = B.SalId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.SalInvNo = ''' + @Pi_ReferNo + ''' AND A.SalInvDate = ''' + Convert(varchar(10),@Pi_VocDate,121) + ''' AND
			EffectInNetAmount = 2 AND B.BaseQtyAmount > 0'
	--For Posting Sales Invoice Level Discount Account in Details Table On Debit
	--Added By Mary on 24/06/2009 
	IF EXISTS (SELECT SalInvLvlDisc FROM SalesInvoice (NOLOCK) WHERE SalInvNo = @Pi_ReferNo AND SalInvLvlDisc>0)
	BEGIN
		SELECT @Amt=0
		SELECT @CoaId = D.CoaId FROM  SalesInvoice A (NOLOCK) INNER JOIN BillSequenceDetail D (NOLOCK) ON
							D.BillSeqId = A.BillSeqId AND D.RefCode='G' WHERE A.SalInvNo =@Pi_ReferNo
		SELECT @Amt =SalInvLvlDisc FROM SalesInvoice (NOLOCK) WHERE SalInvNo = @Pi_ReferNo
		IF NOT EXISTS (SELECT CoaId FROM StdVocDetails WHERE CoaId =@CoaId AND VocRefNo=@VocRefNo)
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		END
		ELSE
		BEGIN
			UPDATE StdVocDetails SET Amount=Amount+@Amt WHERE CoaId=@CoaId AND VocRefNo=@VocRefNo
		END
	END 
	--Till Here
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Addition Account in Details Table To Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,2,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalesInvoiceHdAmount B ON
			A.SalId = B.SalId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.SalInvNo = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121) AND D.RefCode <> 'H' AND
			EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,2,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM SalesInvoice A INNER JOIN SalesInvoiceHdAmount B ON
			A.SalId = B.SalId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.SalInvNo = ''' + @Pi_ReferNo + ''' AND A.SalInvDate = ''' + Convert(varchar(10),@Pi_VocDate,121) + ''' AND D.RefCode <> ''H'' AND
			EffectInNetAmount = 1 AND B.BaseQtyAmount > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Tax Account in Details Table To Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.OutputTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalesInvoiceProductTax B ON
			A.SalId = B.SalId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.SalInvNo = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
		Group By C.OutputTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.OutputTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM SalesInvoice A INNER JOIN SalesInvoiceProductTax B ON
			A.SalId = B.SalId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.SalInvNo = ''' + @Pi_ReferNo + ''' AND A.SalInvDate = ''' + Convert(varchar(10),@Pi_VocDate,121) + '''
		Group By C.OutputTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0'
		
		---ILCRSTPAR8294
		SELECT  TOP 1 @CoaId =D.Coaid 
		FROM SalesInvoice A INNER JOIN SalesInvoiceTCSTaxNew B ON
			A.SalId = B.SalId
		INNER JOIN TCS_TaxSetting_Details C ON
			B.TaxSeqId = C.TaxSeqId and B.TaxCode=C.TaxCode
		INNER JOIN TCS_TaxSetting_Master D ON C.TaxCode=d.TaxCode
		WHERE A.SalInvNo = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121)


		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	   SELECT @VocRefNo,@Coaid,2,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalesInvoiceTCSTaxNew B ON
			A.SalId = B.SalId
		WHERE A.SalInvNo = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0

		---ILCRSTPAR8294		
		

	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Window Display Scheme Discount in Details Table to Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220005')
	BEGIN
		SET @Po_PurErrNo = -14
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220005'
	SET @Amt = 0
	SELECT @Amt = WindowDisplayAmount FROM SalesInvoice WHERE Salinvno = @Pi_ReferNo AND SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
		AND WindowDisplayAmount > 0
	
	IF @Amt > 0
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Rate Difference Amount in Details Table Amount > 0 Debit and < 0 Credit
	SET @Amt = 0
	SELECT @Amt = (SalNetRateDiffAmount+SalRateDiffAmount) FROM SalesInvoice
		WHERE Salinvno = @Pi_ReferNo AND SalInvDate = Convert(varchar(10),@Pi_VocDate,121) AND (SalNetRateDiffAmount+SalRateDiffAmount) <> 0
	
	IF @Amt > 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220007')
		BEGIN
			SET @Po_PurErrNo = -16
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220007'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	-- Posting the Selling Rate and Net Rate Difference
	--SET @Amt = 0
	--SELECT @SalRtnId= ReturnId FROM ReturnHeader WHERE ReturnCode=@Pi_ReferNo
	--SET @SalRtnId = ISNULL(@SalRtnId,0)
	--SELECT @Amt=SUM(RateDiff) FROM 
	--(SELECT CASE  WHEN Slno > 0 THEN PrdRateDiffAmt + EditedNetRte WHEN Slno<0 THEN PrdRateDiffAmt + EditedNetRte  END AS RateDiff
	--FROM ReturnProduct WHERE ReturnId = @SalRtnId)a
	--HAVING SUM(RateDiff) <> 0
	IF @Amt < 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3210003')
		BEGIN
			SET @Po_PurErrNo = -15
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3210003'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(ABS(@Amt) As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Other Charges Add in Details Table For Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.CoaId,1,ISNULL(SUM(B.AdjAmt),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2
		WHERE A.SalInvno = @Pi_ReferNo AND A.SalInvDate = @Pi_VocDate AND C.Effect = 0
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.CoaId,1,ISNULL(SUM(B.AdjAmt),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2
		WHERE A.SalInvno = ''' + @Pi_ReferNo + ''' AND A.SalInvDate = ''' + Convert(varchar(10),@Pi_VocDate,121)  + ''' AND C.Effect = 0
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Other Charges Reduce in Details Table To Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.CoaId,2,ISNULL(SUM(B.AdjAmt),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2
		WHERE A.SalInvno = @Pi_ReferNo AND A.SalInvDate = Convert(varchar(10),@Pi_VocDate,121) AND C.Effect = 1
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.CoaId,2,ISNULL(SUM(B.AdjAmt),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2
		WHERE A.SalInvno = ''' + @Pi_ReferNo + ''' AND A.SalInvDate = ''' + Convert(varchar(10),@Pi_VocDate,121) + ''' AND C.Effect = 1
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account reduce in Details Table to Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3220001')
	BEGIN
		SET @Po_PurErrNo = -4
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3220001'
	SET @Amt = 0
	SELECT @Amt = SalRoundoffAmt FROM SalesInvoice WHERE SalInvno = @Pi_ReferNo AND SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
		AND SalRoundoffAmt > 0
	
	IF @Amt > 0
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,Abs(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(Abs(@Amt) As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account Add in Details Table to Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210001')
	BEGIN
		SET @Po_PurErrNo = -5
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210001'
	SET @Amt = 0
	SELECT @Amt = SalRoundoffAmt FROM SalesInvoice WHERE SalInvno = @Pi_ReferNo AND 
	SalInvDate = Convert(varchar(10),@Pi_VocDate,121)
		AND SalRoundoffAmt < 0
	
	IF @Amt < 0
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(ABS(@Amt) As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 29 AND @Pi_SubTransId = 3	--Market Return
BEGIN
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Sale Return Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Market Return ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
	--For Posting Sales Return Account in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110002')
	BEGIN
		SET @Po_PurErrNo = -19
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110002'
	SELECT @Pi_ReferNo = ReturnCode FROM ReturnHeader A INNER JOIN
		SalesInvoiceMarketReturn B ON B.ReturnId = A.ReturnId
		INNER JOIN SalesInvoice C ON B.SalId = C.SalId AND C.SalInvNo = @Pi_ReferNo
	SELECT @Amt = SUM(B.PrdActualGross) FROM ReturnHeader A INNER JOIN ReturnProduct B
	ON A.ReturnId=B.ReturnId WHERE A.ReturnCode = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReturnHeader C ON B.RtrId = C.RtrId
		WHERE C.ReturnCode = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
--------	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
--------		A.CoaId = B.CoaId INNER JOIN ReturnHeader C ON B.RtrId = C.RtrId
--------		WHERE C.ReturnCode = @Pi_ReferNo
--------
--------	SELECT @Amt = SUM(A.PrdNetAmt)+SUM(A.EditedNetRte) FROM ReturnProduct A 
--------	      INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId
--------	      WHERE B.ReturnCode = @Pi_ReferNo
	
SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReturnHeader C ON B.RtrId = C.RtrId
		WHERE C.ReturnCode = @Pi_ReferNo
	IF NOT EXISTS (SELECT RtnRoundOff FROM ReturnHeader WHERE ReturnCode = @Pi_ReferNo 
			AND RtnRoundOff=1)
	BEGIN
		SELECT @Amt = SUM(A.PrdNetAmt)+SUM(A.EditedNetRte) FROM ReturnProduct A 
			      INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId
			      WHERE B.ReturnCode = @Pi_ReferNo
	END
	ELSE
	BEGIN
		SELECT @Amt = SUM(A.PrdNetAmt)+SUM(A.EditedNetRte) 
					FROM ReturnProduct A 
			      INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId
			      WHERE B.ReturnCode = @Pi_ReferNo
		SELECT @Amt=@Amt+RtnRoundOffAmt FROM ReturnHeader 
				WHERE ReturnCode = @Pi_ReferNo
	END 
--Till here
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Return Discount Account in Details Table to Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,2,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = @Pi_ReferNo AND
			B.EffectInNetAmount = 2 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,2,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + ''' AND
			B.EffectInNetAmount = 2 AND B.BaseQtyAmount > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Return Addition in Details Table to Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,D.CoaId,1,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = @Pi_ReferNo AND B.RefCode <> 'H' AND
			B.EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',D.CoaId,1,B.BaseQtyAmount,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		 FROM ReturnHeader A INNER JOIN ReturnHDAmount B ON
			A.ReturnId = B.ReturnId
		INNER JOIN BillSequenceMaster C ON
			A.BillSeqId = C.BillSeqId
		INNER JOIN BillSequenceDetail D ON
			C.BillSeqId = D.BillSeqId AND B.RefCode = D.RefCode
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + ''' AND B.RefCode <> ''' + 'H' + ''' AND
			B.EffectInNetAmount = 1 AND B.BaseQtyAmount > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Sales Return Tax Account in Details Table on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.OutPutTaxId,1,ISNULL(SUM(B.TaxAmt),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReturnHeader A INNER JOIN ReturnProductTax B ON
			A.ReturnId = B.ReturnId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.ReturnCode = @Pi_ReferNo
		Group By C.OutPutTaxId
		HAVING ISNULL(SUM(B.TaxAmt),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.OutPutTaxId,1,ISNULL(SUM(B.TaxAmt),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM ReturnHeader A INNER JOIN ReturnProductTax B ON
			A.ReturnId = B.ReturnId
		INNER JOIN TaxConfiguration C ON
			B.TaxId = C.TaxId
		WHERE A.ReturnCode = ''' + @Pi_ReferNo + '''
		Group By C.OutPutTaxId
		HAVING ISNULL(SUM(B.TaxAmt),0) > 0'
	
	--For Posting Rate Diff Discount allowed in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220007')
	BEGIN
		SET @Po_PurErrNo = -19
		Return
	END
-- 	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220007'
-- 	IF @Amt>0
-- 	BEGIN
-- 		SELECT  @Amt =  SUM(B.PrdRateDiffAmt) FROM ReturnHeader A INNER JOIN ReturnProduct B
-- 		ON A.ReturnId=B.ReturnId WHERE A.ReturnCode = @Pi_ReferNo
-- 		
-- 		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
-- 			LastModDate,AuthId,AuthDate) VALUES
-- 		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
-- 			@Pi_UserId,Convert(varchar(10),Getdate(),121))
-- 	
-- 		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
-- 			LastModDate,AuthId,AuthDate) VALUES
-- 		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
-- 			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
-- 			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
-- 			Convert(nvarchar(10),Getdate(),121) + ''')'
-- 	
-- 		--INSERT INTO Translog(strSql1) Values (@sstr)
-- 	END
	-- Posting the Selling Rate and Net Rate Difference
	SET @Amt = 0
	SELECT @SalRtnId= ReturnId FROM ReturnHeader WHERE ReturnCode=@Pi_ReferNo
	SET @SalRtnId = ISNULL(@SalRtnId,0)
-- 	SELECT SUM(RateDiff) FROM 
-- 	(SELECT CASE  WHEN Slno > 0 THEN PrdRateDiffAmt WHEN Slno<0 THEN PrdRateDiffAmt END AS RateDiff
-- 	FROM ReturnProduct WHERE ReturnId = 28)a
-- 	HAVING SUM(RateDiff) <> 0
	PRINT @SalRtnId
	SELECT @Amt=SUM(RateDiff) FROM 
	(SELECT CASE  WHEN Slno > 0 THEN PrdRateDiffAmt+EditedNetRte WHEN Slno<0 THEN PrdRateDiffAmt+EditedNetRte  END AS RateDiff
	FROM ReturnProduct WHERE ReturnId = @SalRtnId)a
	HAVING SUM(RateDiff) <> 0
-- 	SELECT @Amt = SUM(PrdRateDiffAmt) FROM ReturnProduct
-- 		WHERE ReturnId = @SalRtnId
-- 		HAVING SUM(PrdRateDiffAmt)<> 0
	
	IF @Amt < 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3210003')
		BEGIN
			SET @Po_PurErrNo = -15
			Return
		END
	PRINT @Amt
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3210003'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	IF @Amt > 0
	BEGIN
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220007')
		BEGIN
			SET @Po_PurErrNo = -16
			Return
		END
	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220007'
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
	END
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId=29 AND @Pi_SubTransId =4	--Return And Replacement
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Replacement Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Billing - Replacement '
		+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
	--For Posting Replacement Account in Details Table on Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110001')
	BEGIN
		SET @Po_PurErrNo = -17
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110001'
	SELECT @Amt = ReplacementDiffAmount FROM SalesInvoice WHERE SalInvno = @Pi_ReferNo
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	
	--For Posting Retailer Account in Details Table to Debit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvno = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvno = @Pi_ReferNo
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)	
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END	
IF @Pi_TransId=29 AND @Pi_SubTransId=5		--Return And Replacement
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Replacement Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Billing - Replacement '
		+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
	--For Posting Replacement Account in Details Table on Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110002')
	BEGIN
		SET @Po_PurErrNo = -19
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110002'
	SELECT @Amt = ReplacementDiffAmount FROM SalesInvoice WHERE SalInvno = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Debit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvno = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN SalesInvoice C ON B.RtrId = C.RtrId
		WHERE C.SalInvno = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)	
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END	
IF @Pi_TransId=29 AND @Pi_SubTransId=7		--Replacement Debit Entry
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Replacement Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Billing - Replacement '
		+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
	--For Posting Replacement Account in Details Table on Credit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110001')
	BEGIN
		SET @Po_PurErrNo = -17
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110001'
	SELECT @Amt = SUM(RepQty*SelRte) FROM ReplacementOut WHERE RepRefNo = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Output Tax in Details Table on Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,C.OutputTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM ReplacementHd A INNER JOIN ReplacementOutPrdTax B ON A.RepRefNo = B.RepRefNo
		INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
		WHERE A.RepRefNo = @Pi_ReferNo Group By C.OutputTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',C.OutputTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM ReplacementHd A INNER JOIN ReplacementOutPrdTax B ON A.RepRefNo = B.RepRefNo
		INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
		WHERE A.RepRefNo = ''' + @Pi_ReferNo + '''Group By C.OutputTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0'
	--INSERT INTO Translog(strSql1) Values (@sstr)		
	--For Posting Retailer Account in Details Table to Debit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
		WHERE C.RepRefNo = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN ReplacementHd C ON B.RtrId = C.RtrId
		WHERE C.RepRefNo = @Pi_ReferNo
	SELECT @Amt = SUM(RepAmount) FROM ReplacementOut WHERE RepRefNo = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)	
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId=31		--Resell damage goods
BEGIN
	IF @Pi_SubTransId=1	
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','SalesVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		--For Posting Resell damage goods Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Resell damage goods'
			+ @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='SalesVoc'
	
		
		--For Posting Sales Resell damage goods Account in Details Table on Debit
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3110003')
		BEGIN
			SET @Po_PurErrNo = -23
			Return
		END	
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3110003'
	
		SELECT @Amt = DbAmt FROM ReSellDamageMaster WHERE ReDamRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)						
	
		--For Posting Retailer Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReSellDamageMaster C ON B.RtrId = C.RtrId
			WHERE C.ReDamRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN ReSellDamageMaster C ON B.RtrId = C.RtrId
			WHERE C.ReDamRefNo = @Pi_ReferNo
	
		SELECT @Amt = DbAmt FROM ReSellDamageMaster WHERE ReDamRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	
	END
	
END
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='IRNNumber' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_BLPurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE Cn2Cs_Prk_BLPurchaseReceipt ADD IRNNumber Nvarchar(400)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_BLPurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE Cn2Cs_Prk_BLPurchaseReceipt ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='IRNNumber' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_BLPurchaseReceipt_Trace' AND XTYPE='U'))
BEGIN
ALTER TABLE Cn2Cs_Prk_BLPurchaseReceipt_Trace ADD IRNNumber Nvarchar(200)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Cn2Cs_Prk_BLPurchaseReceipt_Trace' AND XTYPE='U'))
BEGIN
ALTER TABLE Cn2Cs_Prk_BLPurchaseReceipt_Trace ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETL_Prk_PurchaseReceiptPrdDt' AND XTYPE='U'))
BEGIN
ALTER TABLE ETL_Prk_PurchaseReceiptPrdDt ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETLTempPurchaseReceiptProduct' AND XTYPE='U'))
BEGIN
ALTER TABLE ETLTempPurchaseReceiptProduct ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='IRNNumber' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETL_Prk_PurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE ETL_Prk_PurchaseReceipt ADD IRNNumber Nvarchar(200)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='IRNNumber' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETLTempPurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE ETLTempPurchaseReceipt ADD IRNNumber Nvarchar(200)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='IRNNumber' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='PurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE PurchaseReceipt ADD IRNNumber Nvarchar(200)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TotalTCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='PurchaseReceipt' AND XTYPE='U'))
BEGIN
ALTER TABLE PurchaseReceipt ADD TotalTCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='PurchaseReceiptProduct' AND XTYPE='U'))
BEGIN
ALTER TABLE PurchaseReceiptProduct ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='PurchaseReceiptClaimScheme' AND XTYPE='U'))
BEGIN
ALTER TABLE PurchaseReceiptClaimScheme ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETL_Prk_PurchaseReceiptClaim' AND XTYPE='U'))
BEGIN
ALTER TABLE ETL_Prk_PurchaseReceiptClaim ADD TCSTaxAmt Numeric(18,6)
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSTaxAmt' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='ETLTempPurchaseReceiptClaimScheme' AND XTYPE='U'))
BEGIN
ALTER TABLE ETLTempPurchaseReceiptClaimScheme ADD TCSTaxAmt Numeric(18,6)
END
GO
UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET IRNNumber='' where IRNNumber is null
UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE ETL_Prk_PurchaseReceiptPrdDt SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE ETLTempPurchaseReceiptProduct SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE ETL_Prk_PurchaseReceipt SET IRNNumber='' where IRNNumber is null
UPDATE ETLTempPurchaseReceipt SET IRNNumber='' where IRNNumber is null
UPDATE PurchaseReceipt SET IRNNumber='' where IRNNumber is null
UPDATE PurchaseReceipt SET TotalTCSTaxAmt=0.00 where TotalTCSTaxAmt is null
UPDATE PurchaseReceiptProduct SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE PurchaseReceiptClaimScheme SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE ETL_Prk_PurchaseReceiptClaim SET TCSTaxAmt=0.00 where TCSTaxAmt is null
UPDATE ETLTempPurchaseReceiptClaimScheme SET TCSTaxAmt=0.00 where TCSTaxAmt is null
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Cn2Cs_PurchaseReceipt' and Xtype='P')
DROP PROCEDURE Proc_Cn2Cs_PurchaseReceipt
GO
/*    
BEGIN TRANSACTION   
EXEC Proc_Cn2Cs_PurchaseReceipt 0 
select *from ETLTempPurchaseReceipt --WHERE DownLoadStatus=0
select *from etltemppurchasereceiptproduct where cmpinvno in(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=0)
SELECT * FROM ETLTempPurchaseReceiptClaimScheme 
ROLLBACK TRANSACTION    
*/    
CREATE PROCEDURE Proc_Cn2Cs_PurchaseReceipt
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/***********************************************************    
* PROCEDURE : Proc_Cn2Cs_PurchaseReceipt    
* PURPOSE : To Insert the records FROM Console into Temp Tables    
* SCREEN : Console Integration-PurchaseReceipt    
* CREATED BY: Nandakumar R.G On 03-05-2010    
* MODIFIED :    
* DATE      AUTHOR     DESCRIPTION    
14/08/2013 Murugan.R Logistic Material Management    
* {date} {developer}  {brief modIFication description}    
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-09-2018  Lakshman M		SR     ILCRSTPAR2251         Purchase backup date validation included from CS As per request 5 days configuration .
04-10-2018  lakshman M		 BZ    ILCRSTPAR2285         purchase downloaded status validation added from CS.
28-01-2019  Lakshman M		SR     ILCRSTPAR3256         Purchase backup date validation increased from CS As per request 10 days configuration .
05-03-2019  Lakshman M		SR     ILCRSTPAR3638         Purchase backup date validation decreased from CS As per request 7 days only configuration.
19-10-2019  Lakshman M		SR     ILCRSTPAR6350         Purchase process trace validation included for one month date Range current month less than 30 days.
14-01-2020  Lakshman M		SR     ILCRSTPAR7425         Purchase backup date validation increased from CS As per request 20 days only configuration.
17-03-2020  MarySubashini.S CR     ILCRSTPAR8294		 IRNNumber,TCSTaxAmt column added
***************************************************************************************************/  
SET NOCOUNT ON    
BEGIN    
		-- For Clearing the Prking/Temp Table -----     
		---------------->  Added by Lakshman M on 29/09/2018  <-------------------
		DECLARE @FROMDATE AS Datetime
		DECLARE @TodayDt AS datetime
		SELECT @FROMDATE = cast(DATEADD(DAY, -20, GETDATE()) AS DATETIME)
		SELECT @FROMDATE=CONVERT(VARCHAR(11), @FROMDATE, 121)
		SELECT @TodayDt= CAST(convert(varchar,getdate()) AS DATETIME)
		SELECT @TodayDt= CONVERT(VARCHAR(11), @TodayDt, 121)
		
		SELECT * INTO #ETLTempPurchaseReceipt_temp FROM ETLTempPurchaseReceipt WHERE InvDate between CONVERT(VARCHAR(11), @FROMDATE, 121) and CONVERT(VARCHAR(11), @TodayDt, 121)
		UPDATE A SET A.downloadstatus = 0 FROM ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp B ON A.CmpInvNo =B.CmpInvNo
		UPDATE A SET A.downloadstatus = 1 from ETLTempPurchaseReceipt A where CmpInvNo in(select CmpInvNo from PurchaseReceipt)   ---> added By Lakshman M PMS ID: ILCRSTPAR2285 
		SELECT * INTO #ETLTempPurchaseReceipt_temp1 FROM ETLTempPurchaseReceipt WHERE InvDate < CONVERT(VARCHAR(11),@FROMDATE, 121)
		Delete A from ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo  
		Delete A from ETLTempPurchaseReceiptproduct A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
		Delete A from ETLTempPurchaseReceiptClaimScheme A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
		Delete A from ETLTempPurchaseReceiptClaimScheme A where A.CmpInvNo not in(select B.CmpInvNo from #ETLTempPurchaseReceipt_temp1 B)
		
		----------------- Added by lakshman M Dated ON dated ON 19-10-2019 PMS ID: ILCRSTPAR6350 
		INSERT INTO Cn2Cs_Prk_BLPurchaseReceipt_Trace(
		DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
		PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
		SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,PurDownloadedDate,TCSTaxAmt)--ILCRSTPAR8294
		SELECT DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
		PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
		SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,GETDATE(),ISNULL(TCSTaxAmt,0)TCSTaxAmt FROM Cn2Cs_Prk_BLPurchaseReceipt--ILCRSTPAR8294
		
		DELETE FROM Cn2Cs_Prk_BLPurchaseReceipt_Trace WHERE CONVERT(varchar(12),compinvdate,121) < convert(varchar(12),(cast(DATEADD(DAY, -15, GETDATE()) AS DATETIME)),121)
		
		---------------->  Till Here  <----------------------
		DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
		DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in    
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in     
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
		DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN     
		(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
		DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1    
		DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments WHERE CmpInvNo     
		IN (SELECT CmpInvNo FROM PurchaseReceipt WHERE Status = 1) AND DownloadStatus = 1    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim    
		TRUNCATE TABLE ETL_Prk_PurchaseReceipt    
		TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges    
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptCrDbAdjustments  
		--------------------------------------    
		DECLARE @ErrStatus INT    
		DECLARE @BatchNo   NVARCHAR(200)    
		DECLARE @ProductCode  NVARCHAR(100)    
		DECLARE @ListPrice   NUMERIC(38,6)    
		DECLARE @FreeSchemeFlag  NVARCHAR(5)    
		DECLARE @CompInvNo   NVARCHAR(25)    
		DECLARE @UOMCode   NVARCHAR(25)    
		DECLARE @Qty    INT    
		DECLARE @PurchaseDiscount NUMERIC(38,6)    
		DECLARE @VATTaxValue  NUMERIC(38,6)    
		DECLARE @SchemeRefrNo  NVARCHAR(25)    
		DECLARE @SupplierCode  NVARCHAR(30)    
		DECLARE @TransporterCode NVARCHAR(30)    
		DECLARE @POUOM    INT    
		DECLARE @RowId    INT    
		DECLARE @LineLvlAmt   NUMERIC(38,6)    
		DECLARE @QtyInKg   NUMERIC(38,6)    
		DECLARE @ExistCompInvNo  NVARCHAR(25)    
		DECLARE @FreightCharges  NUMERIC(38,6)   
		DECLARE @TcstaxAmt       NUMERIC(18,6) ---ILCRSTPAR8294
		SET @RowId=1    
		--->Added By Nanda on 17/09/2009    
		IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')    
		AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)    
		BEGIN    
		DROP TABLE InvToAvoid     
		END    
		CREATE TABLE InvToAvoid    
		(    
			CmpInvNo NVARCHAR(50)    
		)    
		--ILCRSTPAR8294
		CREATE TABLE #IRNNUMBERValidate
		(
		  CompInvNo NVARCHAR(100),
		  IRNNumber NVARCHAR(200)
		)
		--ILCRSTPAR8294
		IF EXISTS (SELECT DISTINCT CompInvNo,SupplierCode FROM Cn2Cs_Prk_BLPurchaseReceipt  
		WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST'))  
		BEGIN  
			INSERT INTO InvToAvoid (CmpInvNo)  
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
			WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
			SELECT DISTINCT 1,'Purchase Receipt','Tax Type','Purchase Tax Type should be VAT or GST '+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
			WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
		END 
		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
		END 
		   
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
		END   
		
		
		--ILCRSTPAR8294
		INSERT INTO #IRNNUMBERValidate
		SELECT DISTINCT CompInvNo,IRNNumber FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE DownLoadFlag='D' and ISNULL(IRNNumber,'')<>''

		IF EXISTS (SELECT DISTINCT CompInvNo from #IRNNUMBERValidate(NOLOCK) GROUP BY CompInvNo
		HAVING COUNT(IRNNumber)>1)
		BEGIN
		   INSERT INTO InvToAvoid(CmpInvNo)
		   SELECT DISTINCT CompInvNo from #IRNNUMBERValidate(NOLOCK) GROUP BY CompInvNo
		   Having Count(IRNNumber)>1
		   INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		   SELECT DISTINCT 133,'Purchase Receipt','CmpInvNo','Multiple IRNNumber downloaded for Invoice:'+CompInvNo FROM  #IRNNUMBERValidate(NOLOCK) 
		   GROUP BY CompInvNo HAVING COUNT(IRNNumber)>1
		END
		--ILCRSTPAR8294

		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			--->Added By Nanda on 05/05/2010    
			INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
			SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
			--->Till Here        
		END
		   
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE ProductCode+'~'+BatchNo    
		NOT IN    
		(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN    
			(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			--->Added By Nanda on 05/05/2010    
			INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
			SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE ProductCode+'~'+BatchNo    
			NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
			--->Till Here    
		END  
		  
		--Supplier Credit Note Validations     
		IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
		(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit')    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
			(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'CreditNoteSupplier','PostedRefNo','Supplier Credit Note Not Available'+[CompInvNo]    
			FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
			(SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'      
		END    
		--Supplier Debit Note Validations     
		IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
		(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit')    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
			(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'DebitNoteSupplier','PostedRefNo','Supplier Debit Note Not Available'+[CompInvNo]    
			FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
			(SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'      
		END   
		 
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE CompInvDate>GETDATE())     
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE CompInvDate>GETDATE()    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo     
			FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE CompInvDate>GETDATE()    
		END 
		   
		--Commented and Added By Mohana.S PMS NO: DCRSTKAL0012    
		--IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		--WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))     
		--BEGIN    
		-- INSERT INTO InvToAvoid(CmpInvNo)    
		-- SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		-- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
		-- INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
		-- SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		-- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
		--END    
		IF EXISTS (SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
		FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId))    
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
			FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt',PRODUCTCODE+'Product UOM','UOMCode:'+UOMCode+' is not available for Invoice:'+CompInvNo     
			FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode  NOT IN (SELECT PrdCCode+'~'+UomCode      
			FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
		END     
		IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
		WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK)))     
		BEGIN    
			INSERT INTO InvToAvoid(CmpInvNo)    
			SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
			WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
			SELECT DISTINCT 1,'Purchase Receipt','Invoice Supplier','Supplier:'+SupplierCode+' is not available for Invoice:'+CompInvNo    
			FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
		END     
		--->Till Here    
		-- Eliminated Duplicate records insertion on 02/03/2015  
		SET @ExistCompInvNo=0    
		DECLARE Cur_Purchase CURSOR    
		FOR    
		SELECT DISTINCT ProductCode,BatchNo,ListPriceNSP,    
		FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,    
		ISNULL(FreightCharges,0) AS FreightCharges,ISNULL(TCSTaxAmt,0) AS TCSTaxAmt   --ILCRSTPAR8294     
		FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)    
		ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,    
		FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges,TCSTaxAmt 
		OPEN Cur_Purchase    
		FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
		@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
		@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges,@TcstaxAmt    --ILCRSTPAR8294  
		WHILE @@FETCH_STATUS = 0    
		BEGIN    
			--  IF @ExistCompInvNo<>@CompInvNo    
			--  BEGIN    
			--   SET @ExistCompInvNo=@CompInvNo    
			--   SET @RowId=2    
			--  END    
			--To insert into ETL_Prk_PurchaseReceiptPrdDt    
			IF(@FreeSchemeFlag='0')    
			BEGIN    
				INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],    
				[PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges
				,TCSTaxAmt) ---ILCRSTPAR8294
				VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,    
				@PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges,@TcstaxAmt) ---ILCRSTPAR8294 
				  
				INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)  
				  
				INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)    
				--   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
				--   VALUES(@CompInvNo,@RowId,'E',@QtyInKg)    
			END    
			--To insert into ETL_Prk_PurchaseReceiptClaim    
			IF(@FreeSchemeFlag='1')    
			BEGIN    
				INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],    
				[Batch Code],[Qty],[Stock Type],[Amount],FreightAmt,TCSTaxAmt) --ILCRSTPAR8294    
				VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0,@FreightCharges,@TcstaxAmt) --ILCRSTPAR8294   
			END    
			--  SET @RowId=@RowId+1    
			FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
			@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
			@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges,@TcstaxAmt--ILCRSTPAR8294
		END    
		CLOSE Cur_Purchase    
		DEALLOCATE Cur_Purchase 
		   
		--To insert into ETL_Prk_PurchaseReceipt    
		SELECT @TransporterCode=TransporterCode FROM Transporter    
		WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter WITH(NOLOCK))
		    
		IF @TransporterCode=''    
		BEGIN    
			INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter','Transporter not available')    
		END 
		   
		INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],  
		[Invoice Date],[Transporter Code],[NetPayable Amount],[TaxType],[IRNNumber]) ---ILCRSTPAR8294)  
		SELECT DISTINCT C.CmpCode,SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue,  
		P.TaxType ,P.IRNNumber  ---ILCRSTPAR8294
		FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P  
		WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)
		  
		UPDATE A SET [TaxType]='VAT' FROM ETL_Prk_PurchaseReceipt A (NOLOCK)   
		INNER JOIN Cn2Cs_Prk_BLPurchaseReceipt B (NOLOCK) ON B.CompInvNo=A.[Company Invoice No]   
		AND A.[Supplier Code]=B.SupplierCode WHERE ISNULL(A.TaxType,'')=''  
		
		--Added By Sathishkumar Veeramani 2013/08/13    
		--INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)    
		--SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)    
		--WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
		--Added by Sathishkumar Veeramani 2013/11/22    
		
		INSERT INTO ETL_Prk_PurchaseReceiptCrDbAdjustments([Company Invoice No],[Adjustment Type],[Ref No],[Amount])    
		SELECT DISTINCT CompInvNo,AdjType,RefNo,Amount FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WITH (NOLOCK)    
		WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
		EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT    
		IF @ErrStatus =0    
		BEGIN    
			EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT    
			IF @ErrStatus =0    
			BEGIN    
				EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT    
				IF @ErrStatus =0    
				BEGIN    
					EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT    
					IF @ErrStatus =0    
					BEGIN    
						EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT    
						IF @ErrStatus =0    
						BEGIN    
							EXEC Proc_Validate_PurchaseReceiptCrDbAdjustments @Po_ErrNo= @ErrStatus OUTPUT    
							IF @ErrStatus =0    
							BEGIN    
								SET @ErrStatus=@ErrStatus    
							END        
						END        
					END    
				END    
			END    
		END    
		--Proc_Validate_PurchaseReceiptCrDbAdjustments    
		--->Added By Nanda on 17/09/2009    
		DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN    
	   (SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)    
	   
		UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'    
		WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)
		    
		--->Till Here    
		SET @Po_ErrNo= @ErrStatus    
 RETURN    
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Validate_PurchaseReceipt' and Xtype='P')
DROP PROCEDURE Proc_Validate_PurchaseReceipt
GO
/*
BEGIN TRANSACTION
Exec Proc_Validate_PurchaseReceipt 0
SELECT * FROM ETL_Prk_PurchaseReceipt
SELECT * FROM ETLTempPurchaseReceipt
SELECT * FROM ErrorLog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Validate_PurchaseReceipt
(
@Po_ErrNo INT OUTPUT
)
AS
/*********************************************************************************
* PROCEDURE		: Proc_Validate_PurchaseReceipt
* PURPOSE		: To Insert and Update records in the Table PurchaseReceipt
* CREATED		: Nandakumar R.G
* CREATED DATE	: 03/05/2010
* MODIFIED
* DATE         AUTHOR            CR/BZ     USER STORY ID      DESCRIPTION                         
**********************************************************************************************
17-03-2020  MarySubashini.S		CR     ILCRSTPAR8294	   IRNNumber,TCSTaxAmt column added
*****************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist   AS  INT
	
	DECLARE @CmpCode  AS  NVARCHAR(100)
	DECLARE @SpmCode AS  NVARCHAR(100)
	DECLARE @CmpInvNo AS  NVARCHAR(100)
	DECLARE @PONo  AS  NVARCHAR(100)
	DECLARE @InvoiceDate AS  DATETIME
	DECLARE @TransCode AS  NVARCHAR(100)
	DECLARE @PurRcptNo AS  NVARCHAR(100)
	
	DECLARE @CmpId   AS  INT
	DECLARE @SpmId   AS  INT
	DECLARE @TransId  AS  INT
	DECLARE @NetAmt  AS  NUMERIC(18,0)	
	DECLARE @LcnId   AS  INT
	DECLARE @TaxType AS VARCHAR(100)
	DECLARE @TransStr  AS  NVARCHAR(4000)
	DECLARE @IRNNumber AS NVARCHAR(200) --ILCRSTPAR8294
	
	SET @Po_ErrNo=0
	SET @Exist=0
	
	SET @Exist=0
	DECLARE Cur_PurchaseReceipt CURSOR
	FOR SELECT DISTINCT ISNULL([Company Code],''),ISNULL([Supplier Code],''),ISNULL([Company Invoice No],''),
	ISNULL([PO Number],''),ISNULL([Invoice Date],GETDATE()),ISNULL([Transporter Code],''),ISNULL([NetPayable Amount],0),
	ISNULL([TaxType],''),ISNULL([IRNNumber],'')--ILCRSTPAR8294
	FROM ETL_Prk_PurchaseReceipt
	
	OPEN Cur_PurchaseReceipt
	FETCH NEXT FROM Cur_PurchaseReceipt INTO @CmpCode,@SpmCode,@CmpInvNo,@PONo,@InvoiceDate,@TransCode,@NetAmt,@TaxType,@IRNNumber --ILCRSTPAR8294
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Po_ErrNo=0	
		SET @Exist=0
		
		SELECT @CmpId=ISNULL(CmpId,0) FROM Company WITH (NOLOCK) WHERE CmpCode=@CmpCode  											
		SELECT @SpmId=ISNULL(SpmId,0) FROM Supplier WITH (NOLOCK) WHERE SpmCode=@SpmCode
		SELECT @TransId=ISNULL(TransporterId,0) FROM Transporter WITH (NOLOCK) WHERE TransporterCode=@TransCode
		SELECT @LcnId=ISNULL(LcnId,0) FROM Location WHERE DefaultLocation=1		
		IF EXISTS(SELECT * FROM ETLTempPurchaseReceipt WITH (NOLOCK) WHERE CmpInvNo=@CmpInvNo)
		BEGIN
			DELETE FROM dbo.ETLTempPurchaseReceipt WHERE CmpInvNo=@CmpInvNo
			DELETE FROM dbo.ETLTempPurchaseReceiptProduct WHERE CmpInvNo=@CmpInvNo
			DELETE FROM dbo.ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo=@CmpInvNo
			DELETE FROM dbo.ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo=@CmpInvNo
			DELETE FROM dbo.ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo=@CmpInvNo			 		
		END		
		
		IF @Po_ErrNo=0
		BEGIN
			INSERT INTO ETLTempPurchaseReceipt(CmpId,SpmId,PONo,CmpInvNo,InvDate,LcnId,TransporterId,NetAmt,DownLoadStatus,TaxType,IRNNumber) ---ILCRSTPAR8294
			VALUES(@CmpId,@SpmId,@PONo,@CmpInvNo,@InvoiceDate,@LcnId,@TransId,@NetAmt,0,@TaxType,@IRNNumber)  ---ILCRSTPAR8294
			DELETE FROM ETL_Prk_PurchaseReceipt where [Company Invoice No]=@CmpInvno
		END
		FETCH NEXT FROM Cur_PurchaseReceipt INTO @CmpCode,@SpmCode,@CmpInvNo,@PONo,@InvoiceDate,@TransCode,@NetAmt,@TaxType,@IRNNumber --ILCRSTPAR8294
	END
	CLOSE Cur_PurchaseReceipt
	DEALLOCATE Cur_PurchaseReceipt
			
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Validate_PurchaseReceiptProduct' and Xtype='P')
DROP PROCEDURE Proc_Validate_PurchaseReceiptProduct
GO
-- EXEC Proc_Validate_PurchaseReceiptProduct 0
CREATE PROCEDURE Proc_Validate_PurchaseReceiptProduct
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*****************************************************************************************  
* PROCEDURE		: Proc_Validate_PurchaseReceiptProduct  
* PURPOSE		: To Insert and Update records in the Table PurchaseReceiptProduct 
* CREATED		: Nandakumar R.G  
* CREATED DATE	: 03/05/2010  
* MODIFIED  
* DATE      AUTHOR				USERSTORYID					DESCRIPTION  
***************************************************************************************************
05-03-2019  Lakshman M			SR		ILCRSTPAR6947       Purchase backup date validation decreased from CS As per request 7 days only configuration.
17-03-2020  MarySubashini.S		CR      ILCRSTPAR8294		IRNNumber,TCSTaxAmt column added
***************************************************************************************************/  
SET NOCOUNT ON  
BEGIN
	
	DECLARE @Exist			AS  INT  
	DECLARE @Tabname		AS  NVARCHAR(100)  
	DECLARE @Fldname		AS  NVARCHAR(100)  
	DECLARE @CmpInvNo		AS  NVARCHAR(100)   
	DECLARE @RowId			AS  INT
	DECLARE @PrdCode		AS  NVARCHAR(100)  
	DECLARE @PrdBatCode		AS  NVARCHAR(100)  
	DECLARE @InvUOMCode		AS  NVARCHAR(100)  
	DECLARE @InvQty			AS  NUMERIC(38,0)
	DECLARE @PRRate			AS  NUMERIC(38,6)
	DECLARE @GrossAmt		AS  NUMERIC(38,6)
	DECLARE @DiscAmt		AS  NUMERIC(38,6)  
	DECLARE @TaxAmt			AS  NUMERIC(38,6)  
	DECLARE @NetAmt			AS  NUMERIC(38,6)
	DECLARE @FreightCharges AS  NUMERIC(38,6)
	DECLARE @TcstaxAmt          NUMERIC(18,6) ---ILCRSTPAR8294   
	
	DECLARE @PrdId			AS  INT  
	DECLARE @PrdBatId		AS  INT  
	DECLARE @InvUOMId		AS  INT  
	DECLARE @NewPrd			AS  INT  
	DECLARE @SubFlag		AS	INT
	
	SET @Po_ErrNo=0  
	SET @Exist=0  
	SET @SubFlag=0
	
	SET @Fldname='CmpInvNo'  
	SET @Tabname = 'ETL_Prk_PurchaseReceiptPrdDt'  
	SET @Exist=0  
	
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvProductToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE InvProductToAvoid	
	END
	CREATE TABLE InvProductToAvoid
	(
		CmpInvNo NVARCHAR(50)
	)
	
	DECLARE Cur_PurchaseReceiptProduct CURSOR  
	FOR SELECT ISNULL([Company Invoice No],''),ISNULL([RowId],0),ISNULL([Product Code],''),  
	ISNULL([Batch Code],''),ISNULL([UOM],''),ISNULL([Invoice Qty],0),ISNULL([Purchase Rate],0),ISNULL([Gross],0),ISNULL([Discount In Amount],0),  
	ISNULL([Tax In Amount],0),ISNULL([Net Amount],0), ISNULL([NewPrd],0),ISNULL([FreightCharges],0),ISNULL(TCSTaxAmt,0) TCSTaxAmt ---ILCRSTPAR8294
	FROM ETL_Prk_PurchaseReceiptPrdDt  
	
	OPEN Cur_PurchaseReceiptProduct  	
	FETCH NEXT FROM Cur_PurchaseReceiptProduct INTO @CmpInvNo,@RowId,@PrdCode,@PrdBatCode,  
	@InvUOMCode,@InvQty,@PRRate,@GrossAmt,@DiscAmt,@TaxAmt,@NetAmt,@NewPrd,@FreightCharges ,@TcstaxAmt --ILCRSTPAR8294 
	
	WHILE @@FETCH_STATUS=0  
	BEGIN
	
		SET @PrdId =0
		SET @PrdBatId=0
		SET @InvUOMId=0
		SET @Po_ErrNo=0 
		
		SET @Exist=0  
		
		IF NOT EXISTS(SELECT * FROM ETLTempPurchaseReceipt WITH (NOLOCK) WHERE CmpInvNo=@CmpInvNo)  
		BEGIN  
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Invoice No',  
			'Company Invoice No:'+ CAST(@CmpInvNo AS NVARCHAR(100)) +' is not available')    
			SET @Po_ErrNo=1  
		END  		
		
		SELECT @PrdId=PrdId FROM Product WITH (NOLOCK) WHERE PrdCCode=@PrdCode  		
		SELECT @PrdBatId=PrdBatId FROM ProductBatch WITH (NOLOCK) WHERE PrdBatCode=@PrdBatCode AND PrdId=@PrdId  
		SELECT @InvUOMId=UOMId FROM UOMMaster WITH (NOLOCK) WHERE UOMCode=@InvUOMCode  
		IF @Po_ErrNo=0
		BEGIN
			IF NOT EXISTS(SELECT UM.UomId,um.UomCode,UG.ConversionFactor
			FROM UomGroup UG,UomMaster UM ,Product P
			WHERE UG.UomId = UM.UomId AND P.UomGroupId = UG.UomGroupId AND
			P.PrdId = @PrdId AND UG.UomId = @InvUOMId)
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Invoice UOM',
				'Invoice UOM:'+ CAST(@InvUOMCode AS NVARCHAR(100)) +' is not available for the product:'+ CAST(@PrdCode  AS NVARCHAR(100)))
				
				INSERT INTO InvProductToAvoid
				SELECT @CmpInvNo
				SET @Po_ErrNo=1
			END
		END
		
		IF @Po_ErrNo=0  
		BEGIN  
			INSERT INTO ETLTempPurchaseReceiptProduct   
			(CmpInvNo,RowId,PrdId,PrdBatId,POUOMId,POQty,InvUOMId,InvQty,GrossAmt,DiscAmt,TaxAmt,NetAmt,NewPrd,FreightCharges,TCSTaxAmt)  --ILCRSTPAR8294
			VALUES(@CmpInvNo,@RowId,@PrdId,@PrdBatId,0,0,@InvUOMId,@InvQty,@GrossAmt,@DiscAmt,@TaxAmt,@NetAmt,@NewPrd,@FreightCharges,@TcstaxAmt)   --ILCRSTPAR8294
		END  		
		
		IF @Po_ErrNo<>0  
		BEGIN   
			SET @SubFlag=1
		END
		
		--To capture all the missing UOM
		--IF @Po_ErrNo<>0  
		--BEGIN  
		--	CLOSE Cur_PurchaseReceiptProduct  
		--	DEALLOCATE Cur_PurchaseReceiptProduct  
		--	DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo IN (SELECT DISTINCT CmpInvNo FROM InvProductToAvoid)
		--	RETURN  
		--END  
		
		FETCH NEXT FROM Cur_PurchaseReceiptProduct INTO @CmpInvNo,@RowId,@PrdCode,@PrdBatCode,  
		@InvUOMCode,@InvQty,@PRRate,@GrossAmt,@DiscAmt,@TaxAmt,@NetAmt,@NewPrd,@FreightCharges,@TcstaxAmt --ILCRSTPAR8294
	
	END  
	CLOSE Cur_PurchaseReceiptProduct  
	DEALLOCATE Cur_PurchaseReceiptProduct  
	
	IF @SubFlag<>0  
	BEGIN  
		SET @Po_ErrNo=1
		DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo IN (SELECT DISTINCT CmpInvNo FROM InvProductToAvoid)
		RETURN  
	END

	------------------- Added By lakshman M Dated ON 05/12/2019 PMS ID: ILCRSTPAR6947 --------------
	--SELECT CmpInvNo,count(CmpInvNo) AS TotallinelevelCount INTO #Tempinvoicecount FROM ETLTempPurchaseReceiptProduct 
	--GROUP BY CmpInvNo 

	--SELECT [Company Invoice No] AS CmpInvNo ,count([Company Invoice No]) AS TotallinelevelCount INTO #Tempinvoicecount1 FROM ETL_Prk_PurchaseReceiptPrdDt 
	--GROUP BY [Company Invoice No]

	--IF NOT EXISTS(SELECT * FROM ETL_Prk_PurchaseReceiptPrdDt A inner join Product B ON A.[Product Code]  =B.PrdCCode  inner join ETLTempPurchaseReceiptProduct C ON C.PrdId=B.PrdId AND A.[Company Invoice No] =C.CmpInvNo)
	--BEGIN
	--		DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo  NOT IN (SELECT A.CmpInvNo FROM #Tempinvoicecount A inner join #Tempinvoicecount1 B ON A.CmpInvNo =B.CmpInvNo AND A.TotallinelevelCount <>B.TotallinelevelCount )
	--END
	--------------------------------- Till here ------------------
	
	IF @Po_ErrNo=0  
	BEGIN  
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt
	END
	
	RETURN   
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Validate_PurchaseReceiptClaimScheme' and Xtype='P')
DROP PROCEDURE Proc_Validate_PurchaseReceiptClaimScheme
GO
--Exec Proc_Validate_PurchaseReceiptClaimScheme 0
--SELECT * FROM ETL_Prk_PurchaseReceiptClaim
--SELECT * FROM ETLTempPurchaseReceiptClaimScheme
CREATE PROCEDURE Proc_Validate_PurchaseReceiptClaimScheme
(
	@Po_ErrNo INT OUTPUT
)
AS
/************************************************************************************************************************
* PROCEDURE		: Proc_Validate_PurchaseReceiptClaimScheme
* PURPOSE		: To Insert and Update records in the Table PurchaseReceiptClaimScheme
* CREATED		: Nandakumar R.G
* CREATED DATE	: 03/05/2010
* MODIFIED
---------------------------------------------------------------------------------------------------------------------------------
* [DATE]       [DEVELOPER]		[CR/BUG]      [USER_STORY_ID]          [DESCRIPTION]  
* 26-03-2018   lakshman M		  BZ	       ILCRSTPAR3871            Remove duplicate value in ETL_Prk_PurchaseReceiptClaim table  to main table (distinct values)
* 17-03-2020   MarySubashini.S    CR		   ILCRSTPAR8294			IRNNumber,TCSTaxAmt column added
************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 			AS 	INT
	DECLARE @Tabname 		AS  NVARCHAR(100)
	DECLARE @DestTabname 	AS 	NVARCHAR(100)
	DECLARE @Fldname 		AS  NVARCHAR(100)
	
	DECLARE @CmpInvNo		AS 	NVARCHAR(100)
	DECLARE @Type			AS 	NVARCHAR(100)	
	DECLARE @RefCode		AS 	NVARCHAR(100)	
	DECLARE @RefDesc		AS 	NVARCHAR(100)	
	DECLARE @PrdCode		AS 	NVARCHAR(100)
	DECLARE @PrdBatCode		AS 	NVARCHAR(100)
	DECLARE @Qty			AS 	NUMERIC(38,0)
	DECLARE @StockType		AS 	NVARCHAR(100)
	DECLARE @Amt			AS 	NUMERIC(38,6)
	DECLARE @FreightAmt		AS 	NUMERIC(38,6)
	DECLARE @TypeId			AS 	INT
	DECLARE @RefId			AS 	INT
	DECLARE @PrdId			AS 	INT
	DECLARE @PrdBatId		AS 	INT
	DECLARE @StockTypeId	AS 	INT
	DECLARE @TcstaxAmt      AS NUMERIC(18,6) ---ILCRSTPAR8294
			
	DECLARE @TransStr 		AS 	NVARCHAR(4000)
	SET @Po_ErrNo=0
	SET @Exist=0
	
	SET @DestTabname='ETLTempPurchaseReceiptClaimScheme'
	SET @Fldname='CmpInvNo'
	SET @Tabname = 'ETL_Prk_PurchaseReceiptClaim'
	SET @Exist=0
	
	DECLARE Cur_PurchaseReceiptClaim CURSOR
	FOR SELECT DISTINCT ISNULL([Company Invoice No],''),ISNULL([Type],''),ISNULL([Ref No],''),
	ISNULL([Product Code],''),ISNULL([Batch Code],''),ISNULL([Qty],0),ISNULL([Stock Type],''),
	ISNULL([Amount],0),ISNULL([FreightAmt],0),ISNULL(TCSTaxAmt,0) TCSTaxAmt ---ILCRSTPAR8294
	 FROM ETL_Prk_PurchaseReceiptClaim WITH(NOLOCK)
	OPEN Cur_PurchaseReceiptClaim 
	FETCH NEXT FROM Cur_PurchaseReceiptClaim INTO @CmpInvNo,@Type,@RefCode,@PrdCode,@PrdBatCode,
	@Qty,@StockType,@Amt,@FreightAmt,@TcstaxAmt ---ILCRSTPAR8294
	WHILE @@FETCH_STATUS=0
	BEGIN
		
		SET @Exist=0
		SET @PrdId=0
		SET @PrdBatId=0
		SET @StockTypeId=0		
		IF NOT EXISTS(SELECT * FROM ETLTempPurchaseReceipt WITH (NOLOCK) WHERE CmpInvNo=@CmpInvNo)
		BEGIN
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Invoice No',
			'Company Invoice No:'+@CmpInvNo+' is not available')  
         	
			SET @Po_ErrNo=1
		END				
		IF @Po_ErrNo=0
		BEGIN			
			IF @Type='Claim'	
			BEGIN
				SET @TypeId=1
			END
			ELSE IF @Type='Scheme'	
			BEGIN
				SET @TypeId=2
			END
			ELSE
			BEGIN
				SET @TypeId=3
				SET @RefCode=''
			END			
		END				
		IF @Po_ErrNo=0
		BEGIN
			IF @TypeId=1 
			BEGIN
				IF NOT EXISTS(SELECT * FROM ClaimSheetHd CH,ClaimSheetDetail CD,ClaimGroupMaster CG 
				WHERE CD.Status = 1 AND CH.Confirm = 1  AND CD.Clmid = CH.ClmId 
				AND (CD.RecommendedAmount - CD.ReceivedAmount) > 0 AND CG.ClmGrpId = Ch.ClmGrpId AND CD.RefCode=@RefCode)
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Ref No',
					'Claim Group Code:'+@RefCode+' is not available in Company Invoice No:'+@CmpInvNo) 
					
					SET @Po_ErrNo=1
				END
				ELSE
				BEGIN
					SELECT @RefId=CD.ClmId,@RefDesc=CH.ClmDesc FROM ClaimSheetDetail CD WITH (NOLOCK),
					ClaimSheetHd CH WITH (NOLOCK) 
					WHERE CD.RefCode=@RefCode AND CD.ClmId=CH.ClmId
				END	
			END
			ELSE IF @TypeId=2 
			BEGIN
				IF NOT EXISTS(SELECT * FROM SchemeMaster WITH (NOLOCK) 
				WHERE SchCode=@RefCode)
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Ref No',
					'Scheme Code:'+@RefCode+' is not available in Company Invoice No:'+@CmpInvNo)           	
	
					SET @Po_ErrNo=1
				END
				ELSE
				BEGIN
					SELECT @RefId=SchId,@RefDesc=SchDsc FROM SchemeMaster WITH (NOLOCK) 
					WHERE SchCode=@RefCode
				END	
			END
			ELSE
			BEGIN
				SET @RefId=0
				SET @RefDesc='Offer'
			END
		END		
		
		SELECT @PrdId=PrdId FROM Product WITH (NOLOCK) WHERE PrdCCode=@PrdCode
		SELECT @PrdBatId=PrdBatId FROM ProductBatch WITH (NOLOCK) WHERE PrdBatCode=@PrdBatCode AND PrdId=@PrdId
		IF @PrdBatId<>0
		BEGIN
			IF (@StockType)='Saleable'
			BEGIN
				SET @StockTypeId=1
			END		
			ELSE IF (@StockType)='Offer'
			BEGIN
				SET @StockTypeId=3
			END
			ELSE
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Stock Type',
				'Stock Type should be either saleable or offer for product code:'+@PrdCode+ 'in Company Invoice No:'+@CmpInvNo)  
				SET @Po_ErrNo=1
			END	
		END
		IF @Po_ErrNo=0
		BEGIN
			IF NOT CAST(@Qty AS NUMERIC(18,0))+CAST(@Amt AS NUMERIC(18,0))>0 
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Qty/Amount',
				'Either Qty or Amount for product code:'+@PrdCode+ ' should be greater than zero in Company Invoice No:'+@CmpInvNo)  
				SET @Po_ErrNo=1
			END
		END		
		IF @Po_ErrNo=0
		BEGIN
			INSERT INTO ETLTempPurchaseReceiptClaimScheme(CmpInvNo,TypeId,RefCode,RefId,RefDescription,PrdId,
			PrdBatId,StockTypeId,Qty,Amt,FreightAmt,TCSTaxAmt)---ILCRSTPAR8294
			VALUES(@CmpInvNo,@TypeId,@RefCode,@RefId,@RefDesc,@PrdId,@PrdBatId,@stockTypeId,@Qty,@Amt,@FreightAmt,@TcstaxAmt) ---ILCRSTPAR8294
		END
			
		IF @Po_ErrNo<>0
		BEGIN
			CLOSE Cur_PurchaseReceiptClaim
			DEALLOCATE Cur_PurchaseReceiptClaim
			RETURN
		END
		FETCH NEXT FROM Cur_PurchaseReceiptClaim INTO @CmpInvNo,@Type,@RefCode,@PrdCode,@PrdBatCode,
		@Qty,@StockType,@Amt,@FreightAmt,@TcstaxAmt ---ILCRSTPAR8294
	END
	CLOSE Cur_PurchaseReceiptClaim
	DEALLOCATE Cur_PurchaseReceiptClaim
	IF @Po_ErrNo=0
	BEGIN
		TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim
	END
	RETURN	
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_LoadConsolePurchaseInvoice' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_LoadConsolePurchaseInvoice
GO
--SELECT * FROM Fn_LoadConsolePurchaseInvoice('1516304516-1',1)  
CREATE FUNCTION [dbo].[Fn_LoadConsolePurchaseInvoice](@InvoiceNo VARCHAR(100),@lDisplay AS INT)  
RETURNS @PurchaseInvoice TABLE  
(  
	CmpInvNo  VARCHAR(100),  
	RowId   INT,  
	PrdId   BIGINT,  
	PrdDCode  VARCHAR(100),  
	PrdName   VARCHAR(200),  
	PrdBatId  BIGINT,  
	PrdBatCode  VARCHAR(100),  
	DefaultPriceId BIGINT,  
	POUOMId   INT,  
	POUOMCode  VARCHAR(100),  
	POQty   INT,  
	InvUOMId  INT,  
	InvUOMCode  VARCHAR(100),  
	InvQty   NUMERIC(18,0),  
	GrossAmt  NUMERIC(18,6),  
	DiscAmt   NUMERIC(18,6),  
	TaxAmt   NUMERIC(18,6),  
	FreightCharges  NUMERIC(18,6),  
	NetAmt   NUMERIC(18,6),  
	NewPrd   INT,  
	PrdBEDAmount NUMERIC(18,6),  
	QtyInKg   NUMERIC(18,6),  
	AddDiscAmt  NUMERIC(18,6) ,
	TcsTaxAmt		NUMERIC(18,6)  --ILCRSTPAR8294 
)  
AS 
/*********************************************************************************************
* PROCEDURE		: 
* PURPOSE		: 
* CREATED		: 
* CREATED DATE	: 
* MODIFIED
* DATE        AUTHOR             CR/BZ          USERSTORYID            DESCRIPTION
**********************************************************************************************    
* 17-03-2020   MarySubashini.S    CR		   ILCRSTPAR8294			IRNNumber,TCSTaxAmt column added
***************************************************************************************************/
BEGIN  
	DECLARE @TaxType AS VARCHAR(20)  
	DECLARE @GstEnabled AS INT  
	SET @GstEnabled=0  
	SET @TaxType=''  
	SELECT @TaxType=ISNULL(TaxType,'VAT') FROM ETLTempPurchaseReceipt(NOLOCK) WHERE CmpInvNo=@InvoiceNo  
	IF EXISTS(SELECT * FROM GSTCONFIGURATION (NOLOCK) WHERE ActivationStatus=1 AND AcknowledgeStatus=1 AND ConsoleAckStatus=1)  
	BEGIN  
		SET @GstEnabled=1   
	END  
	IF @GstEnabled=1 AND RTRIM(LTRIM(UPPER(ISNULL(@TaxType,'VAT'))))='VAT'  
	BEGIN  
		--ProductBatchVATTaxB4GST  
		INSERT INTO @PurchaseInvoice(CmpInvNo,RowId,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,DefaultPriceId,POUOMId,  
		POUOMCode,POQty,InvUOMId,InvUOMCode,InvQty,GrossAmt,DiscAmt,TaxAmt,FreightCharges,NetAmt,NewPrd,PrdBEDAmount,QtyInKg,AddDiscAmt,TcsTaxAmt) --ILCRSTPAR8294 
		SELECT DISTINCT ETL.CmpInvNo,ETL.RowId,ETL.PrdId,CASE @lDisplay WHEN 1 THEN  P.PrdCCode WHEN 2 THEN P.PrdDCode END AS PrdDCode,  
		P.PrdName,ETL.PrdBatId,PB.PrdBatCode,PBV.DefaultPriceId,ETL.POUOMId,'' AS POUOMCode,ETL.POQty,ETL.InvUOMId,UI.UOMCode AS InvUOMCode,  
		ETL.InvQty,ETL.GrossAmt,ETL.DiscAmt,ETL.TaxAmt,ISNULL(ETL.FreightCharges,0) AS FreightCharges,ETL.NetAmt,ETL.NewPrd,  
		ISNULL(ETL.PrdBEDAmount,0) AS PrdBEDAmount,ISNULL(ETL.QtyInKg,0) AS QtyInKg,ETL.AddDiscAmt ,ISNULL(ETL.TCSTaxAmt,0) TcsTaxAmt --ILCRSTPAR8294
		FROM ETLTempPurchaseReceiptProduct ETL,Product P,ProductBatch PB,ProductBatchVATTaxB4GST PBV,  
		UOMMaster UI WHERE ETL.PrdId=P.PrdId AND ETL.PrdBatId=PB.PrdBatId AND ETL.InvUOMId= UI.UOMId AND P.PrdId=PBV.PrdId   
		AND PB.PrdBatId=PBV.PrdBatId AND ETL.PrdId=PBV.PrdId AND ETL.PrdBatId=PBV.PrdBatId  
		and cmpinvno=@InvoiceNo  
	END  
	ELSE  
	BEGIN  
		INSERT INTO @PurchaseInvoice(CmpInvNo,RowId,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,DefaultPriceId,POUOMId,  
		POUOMCode,POQty,InvUOMId,InvUOMCode,InvQty,GrossAmt,DiscAmt,TaxAmt,FreightCharges,NetAmt,NewPrd,PrdBEDAmount,QtyInKg,AddDiscAmt,TcsTaxAmt) --ILCRSTPAR8294
		SELECT DISTINCT ETL.CmpInvNo,ETL.RowId,ETL.PrdId,CASE @lDisplay WHEN 1 THEN  P.PrdCCode WHEN 2 THEN P.PrdDCode END AS PrdDCode,  
		P.PrdName,ETL.PrdBatId,PB.PrdBatCode,PB.DefaultPriceId,ETL.POUOMId,'' AS POUOMCode,ETL.POQty,ETL.InvUOMId,UI.UOMCode AS InvUOMCode,  
		ETL.InvQty,ETL.GrossAmt,ETL.DiscAmt,ETL.TaxAmt,ISNULL(ETL.FreightCharges,0) AS FreightCharges,ETL.NetAmt,ETL.NewPrd,  
		ISNULL(ETL.PrdBEDAmount,0) AS PrdBEDAmount,ISNULL(ETL.QtyInKg,0) AS QtyInKg,ETL.AddDiscAmt,ISNULL(ETL.TCSTaxAmt,0) TcsTaxAmt --ILCRSTPAR8294
		FROM ETLTempPurchaseReceiptProduct ETL,  
		Product P,ProductBatch PB,UOMMaster UI WHERE ETL.PrdId=P.PrdId AND ETL.PrdBatId=PB.PrdBatId AND   
		ETL.InvUOMId= UI.UOMId and cmpinvno=@InvoiceNo   
	END  
RETURN  
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_LoadPRTCSTaxAmt' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_LoadPRTCSTaxAmt
GO
--SELECT * FROM Fn_LoadPRTCSTaxAmt(1)  
CREATE FUNCTION [dbo].[Fn_LoadPRTCSTaxAmt](@PurRcptId AS BIGINT,@PrdSlno AS INT)  
RETURNS @PurchaseInvoice TABLE  
(  
	PurRcptId BIGINT,
	PrdSlno INT, 
	TCSTaxAmt NUMERIC(38,6) 
)  
AS 
/*********************************************************************************************
* PROCEDURE		: Fn_LoadPRProductDetails
* PURPOSE		: 
* CREATED		: MarySubashini.S FOR ILCRSTPAR8294
* CREATED DATE	: 
* MODIFIED
* DATE        AUTHOR             CR/BZ          USERSTORYID            DESCRIPTION
**********************************************************************************************    
* 17-03-2020   MarySubashini.S    CR		   ILCRSTPAR8294			IRNNumber,TCSTaxAmt column added
***************************************************************************************************/
BEGIN 
	INSERT INTO @PurchaseInvoice(PurRcptId,PrdSlno,TCSTaxAmt)
	 SELECT  PurRcptId,PrdSlno,ISNULL(TCSTaxAmt,0) AS TCSTaxAmt 
	 FROM PurchaseReceiptProduct  (NOLOCK) 
	 WHERE  PurRcptId = @PurRcptId   AND PrdSlno=@PrdSlno
RETURN
END 
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnPurchaseClaimScheme' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnPurchaseClaimScheme
GO
--SELECT DISTINCT * FROM Dbo.Fn_ReturnPurchaseClaimScheme(36)
CREATE FUNCTION [dbo].[Fn_ReturnPurchaseClaimScheme] (@Pi_PurRcptId AS BIGINT)
RETURNS @ReturnPurchaseClaimScheme TABLE
(
    TypeId           INT,
    [Type]           NVARCHAR(200),
    RefId            INT,
    RefCode          NVARCHAR(200),
    SlNo             INT,
    [Description]    NVARCHAR(200),
    PrdId            NUMERIC(18,0),
    PrdName          NVARCHAR(200),
    PrdBatId         NUMERIC(18,0),
    PrdBatCode       NVARCHAR(200),
    Quantity         NUMERIC(18,0),
    StockTypeId      INT,
    UserStockType    NVARCHAR(200),
    RateforClaim     NUMERIC(18,6),
    Value            NUMERIC(18,6),
    Amount           NUMERIC(18,6),
    FreightAmt       NUMERIC(18,6) ,
	TCSTaxAmt        NUMERIC(18,6) --ILCRSTPAR8294
)
AS
BEGIN
/**********************************************************
* FUNCTION    : Fn_ReturnPurchaseClaimScheme
* PURPOSE     : Returns the Purchase Receipt Claim Scheme 
* NOTES: 
* CREATED     : Sathishkumar Veeramani 2014/06/20
* MODIFIED 
* DATE        AUTHOR             CR/BZ          USERSTORYID            DESCRIPTION
**********************************************************************************************    
* 17-03-2020   MarySubashini.S    CR		   ILCRSTPAR8294			IRNNumber,TCSTaxAmt column added
***************************************************************************************************/
    INSERT INTO @ReturnPurchaseClaimScheme (TypeId,[Type],RefId,RefCode,SlNo,[Description],PrdId,PrdName,PrdBatId,PrdBatCode,
    Quantity,StockTypeId,UserStockType,RateforClaim,Value,Amount,FreightAmt,TCSTaxAmt) --ILCRSTPAR8294
	SELECT DISTINCT TypeId, 'Claim' AS Type,RefId,RefCode,PCS.SlNo,ClmDesc AS Description,pcs.PrdId,ISNULL(PrdName,'') AS PrdName,
	pcs.PrdBatId,ISNULL(PrdBatCode,'') AS PrdBatCode,Quantity,pcs.StockTypeId,UserStockType,RateforClaim,Value,Amount,FreightAmt
	,ISNULL(PCS.TCSTaxAmt,0)--ILCRSTPAR8294  
	FROM PurchaseReceiptClaimScheme PCS (NOLOCK) 
	LEFT OUTER JOIN  Product P (NOLOCK)  ON P.PrdId = pcs.prdid  
	LEFT OUTER JOIN  productbatch pb (NOLOCK)  ON p.prdid = pb.prdid AND pcs.prdid = pb.prdid AND pcs.prdbatid = pb.prdbatid   
	INNER JOIN Stocktype s (NOLOCK)  ON s.stocktypeid = pcs.stocktypeid INNER JOIN claimsheethd ch ON pcs.RefId = ch.clmid 
	INNER JOIN ClaimsheetDetail cd (NOLOCK)  ON ch.clmid = cd.clmid  AND  PCS.SlNo=cd.SlNo  WHERE Typeid = 1 AND PurRcptId = @Pi_PurRcptId  UNION 
	SELECT TypeId, 'Scheme' AS Type, RefId, SchCode AS RefCode,0 AS SlNo,SchDsc AS Description, pcs.PrdId,
	ISNULL(PrdName,'') AS PrdName,pcs.PrdBatId,ISNULL(PrdBatCode,'') AS PrdBatCode,Quantity,Pcs.StockTypeId, 
	UserStockType,RateforClaim ,Value,Amount,FreightAmt,ISNULL(PCS.TCSTaxAmt,0) FROM purchASereceiptclaimscheme PCS  --ILCRSTPAR8294
	LEFT OUTER JOIN  Product P (NOLOCK) ON  P.PrdId = pcs.prdid 
	LEFT OUTER JOIN  productbatch pb (NOLOCK) ON p.prdid = pb.prdid AND pcs.prdbatid = pb.prdbatid AND  pcs.prdid = pb.prdid 
	INNER JOIN Stocktype s (NOLOCK) ON s.stocktypeid = pcs.stocktypeid  
	INNER JOIN SchemeMaster  ch  (NOLOCK) ON pcs.RefId = ch.schid  Where Typeid = 2  AND PurRcptId = @Pi_PurRcptId UNION 
	SELECT DISTINCT TypeId, 'Offer' AS Type, RefId,'' AS RefCode,0 AS SlNo,'' AS Description, pcs.PrdId,ISNULL(PrdName,'') AS  PrdName, 
	pcs.PrdBatId,ISNULL(PrdBatCode,'') AS PrdBatCode,Quantity, pcs.StockTypeId, UserStockType,RateforClaim,Value,Amount,FreightAmt 
	,ISNULL(PCS.TCSTaxAmt,0)--ILCRSTPAR8294
	FROM PurchaseReceiptClaimScheme PCS  (NOLOCK) 
	LEFT OUTER JOIN  Product P (NOLOCK) ON  P.PrdId = pcs.prdid 
	LEFT OUTER JOIN ProductBatch pb (NOLOCK) ON p.prdid = pb.prdid AND pcs.prdbatid = pb.prdbatid 
	AND PCS.PrdId = pb.prdid INNER JOIN Stocktype s (NOLOCK) ON s.stocktypeid = pcs.stocktypeid  
	WHERE Typeid = 3 AND PurRcptId = @Pi_PurRcptId
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ReturnRedistFrDiscfromConsole' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnRedistFrDiscfromConsole
GO
CREATE FUNCTION Fn_ReturnRedistFrDiscfromConsole(@CmpInvNo AS NVARCHAR(100))
RETURNS @ReturnRedistFrDiscfromConsole Table 
(
	ReDistFrDisc Numeric(18,6),
	TcsTaxAmount Numeric(18,6)
)
AS
/*********************************
* FUNCTION		: Fn_ReturnRedistFrDiscfromConsole
* PURPOSE		: To Return DSR Mapped Routes
* CREATED		: MarySubashini.S 
* CREATED DATE	: 17/03/2020
* MODIFIED
* DATE         AUTHOR            CR/BZ    USER STORY ID      DESCRIPTION                         
**********************************************************************************************
* 17/03/2020   MarySubashini.S    CR	  ILCRSTPAR8294	     TCS Tax amount will show in Footer level
*****************************************************************************************/
BEGIN	
	INSERT INTO @ReturnRedistFrDiscfromConsole(ReDistFrDisc,TcsTaxAmount)
	SELECT 0 RedistFrDisc,ISNULL(SUM(TcsTaxAmount),0) AS TcsTaxAmount FROM 
	(SELECT 0 as RedistFrDisc,ISNULL(SUM(TCSTaxAmt),0) AS TcsTaxAmount  FROM ETLTempPurchaseReceiptProduct (NOLOCK)  WHERE CmpInvNo=@CmpInvNo
	UNION ALL
	SELECT 0 as RedistFrDisc,ISNULL(SUM(TCSTaxAmt),0) AS TcsTaxAmount FROM ETLTempPurchaseReceiptClaimScheme (NOLOCK) WHERE CmpInvNo=@CmpInvNo) A
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ReturnTCSTaxDetailsNew' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnTCSTaxDetailsNew
GO
--SELECT * FROM DBO.Fn_ReturnPurchaseDiscount('308','',1)
CREATE FUNCTION Fn_ReturnTCSTaxDetailsNew(@Salinvno AS Nvarchar(50),@Salid AS INT,@Imode as INT,@Userid INT,@Transid INT)
RETURNS @ReturnTCSTaxDetailsNew TABLE 
(
    PrdName    Nvarchar(500),
    Batch      Nvarchar(500),
	TaxPerc NUMERIC(18,6),
	TaxableAmt NUMERIC(18,4),
	TaxAmt NUMERIC(18,4)
)
AS
/*************************************************************************************************
* PROCEDURE  : Fn_ReturnTCSTaxDetailsNew
* PURPOSE    : To display TCS tax details in Billing
* CREATED BY : MarySubashini.S
* CREATED ON : 17/03/2020
* MODIFICATION
**************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
****************************************************************************************************
* 17/03/2020   MarySubashini.S    CR     DABCS202100016      To display TCS tax details in Billing
***************************************************************************************************/
BEGIN
	  IF @Imode=1
	   BEGIN
			INSERT INTO @ReturnTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM TCS_BilledPrdDtCalculatedTax T (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE T.Usrid=@Userid and T.TransId=@Transid
			Order by T.Rowid

		END
	IF @Imode=2
	   BEGIN
			INSERT INTO @ReturnTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM TCS_BilledPrdDtCalculatedTax T (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE T.Usrid=@Userid and T.TransId=@Transid
			Order by T.Rowid

		END
	IF @Imode=0
	   BEGIN   
			INSERT INTO @ReturnTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM SalesInvoiceTCSTaxNew ST (NOLOCK) INNER JOIN Salesinvoiceproduct T (Nolock)
			on ST.Salid=T.Salid  and ST.PrdSlno=T.SlNo
			INNER JOIN Product P (NOLOCK) ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE ST.Salid=@Salid
			Order by ST.Prdslno

		END
  	
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnPurchaseTCSTaxdetails' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnPurchaseTCSTaxdetails
GO
--SELECT * FROM DBO.Fn_ReturnPurchaseTCSTaxdetails('308','',1)
CREATE FUNCTION Fn_ReturnPurchaseTCSTaxdetails (@CmpInvoiceNo AS Nvarchar(50),@PurRcptId AS INT,@Imode as INT)
RETURNS @ReturnPurchaseTCSTaxdetails  TABLE 
(
    PrdId      NUMERIC(18,0),
	Prdname Nvarchar(250),
	Taxamt NUMERIC(18,6)
	
)
AS
/************************************************
* PROCEDURE  : Fn_ReturnPurchaseTCSTaxdetails
* PURPOSE    : To display Purchase TCS tax details
* CREATED BY : MarySubashini.S
* CREATED ON : 17/03/2020
* MODIFICATION
**************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
****************************************************************************************************
* 17/03/2020   MarySubashini.S    CR     ILCRSTPAR8294      To display TCS tax details in Billing
***************************************************************************************************/
BEGIN
	  IF @Imode=1
	   BEGIN
			INSERT INTO @ReturnPurchaseTCSTaxdetails(Prdid,PrdName,Taxamt)
			SELECT E.PrdId,P.PrdName,Sum(TCSTaxAmt)
			FROM ETLTempPurchaseReceiptProduct E (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON P.PRDID=E.PRDID	WHERE CmpInvNo=@CmpInvoiceNo
			GROUP BY E.PrdId,P.prdname
			HAVING SUM(isnull(TCSTaxAmt,0)) > 0
		END
	   ELSE
	   BEGIN
			INSERT INTO @ReturnPurchaseTCSTaxdetails(Prdid,PrdName,Taxamt)
			SELECT E.PrdId,P.PrdName,Sum(TCSTaxAmt)
			FROM PurchaseReceiptProduct E (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON P.PRDID=E.PRDID	WHERE PurRcptId=@PurRcptId
			GROUP BY E.PrdId,P.prdname
			HAVING SUM(isnull(TCSTaxAmt,0)) > 0
	   END 	  	
	RETURN
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_SalesReturn' AND name='PrdTCSTaxAmount')
BEGIN
ALTER TABLE Cs2Cn_Prk_SalesReturn ADD PrdTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSCOLUMNS WHERE OBJECT_NAME(ID)='Cs2Cn_Prk_DailySales' AND name='PrdTCSTaxAmount')
BEGIN
ALTER TABLE Cs2Cn_Prk_DailySales ADD PrdTCSTaxAmount Numeric(18,6) DEFAULT 0 WITH VALUES
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Cs2Cn_DailySales' and Xtype='P')
DROP PROCEDURE Proc_Cs2Cn_DailySales
GO
/*
BEGIN Transaction
EXEC Proc_Cs2Cn_DailySales 0,'2020-03-13'
SELECT * FROM Cs2cn_prk_DailySales
SELECT * FROM Cs2cn_prk_DailySales_New
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_DailySales
(    
 @Po_ErrNo INT OUTPUT,    
 @ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_DailySales    
* PURPOSE  : To Extract Daily Sales Details from CoreStocky to upload to Console    
* CREATED BY : Nandakumar R.G    
* CREATED DATE : 19/03/2010    
* NOTE   :    
* MODIFIED BY : LAKSHMAN M  
* MODIFIED DATE : 06/11/2017   
* PMS ID   : ICRSTPAR6569  
* PURPOSE  : Daily Sales Details from CoreStocky upload LCTR Calculation Validation changed.    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
21/10/2014 Jisha Mathew Included Undelivered bills New Column Added BillStatus,UploadedDate     
12/12/2015 PRAVEENRAJ BHASKARAN LCTRAmount ADDED FOR CCRSTPAR0118    
09/11/2016 Gopikrishnan RtrUniqueCode Added
* DATE       AUTHOR			CR/BZ		USER STORY ID           DESCRIPTION                         
*************************************************************************************************************************************    
09-01-2018  lakshman M			BZ     ICRSTPAR7284          LCTR Formula velidation changed (special price not consider in LCTR Value).
06-02-2017	MOHANA				BZ     ICRSTPAR7955			 DELVIERED BILLS NOT UPLOADED PROPERLY
25-05-2019  lakshman M			BS     ILCRSTPAR4571         While uploading dat one product done in billing different uom that time LCTR amount same amount reflct in two line level
11-11-2019  Deepan				CR     CRCRSTPAR0089         Category and Value Class and channel Added
06-01-2020  Deepan				BZ 	   ILCRSTPAR7329		 Category and channel modified	
17-03-2020  MarySubashini.S     CR     ILCRSTPAR8294		 To display TCS tax details in Billing
************************************************************************************************************************************/    
SET NOCOUNT ON    
BEGIN    
		 DECLARE @CmpId    AS INT    
		 DECLARE @DistCode As nVarchar(50)    
		 DECLARE @DefCmpAlone AS INT    
		 SET @Po_ErrNo=0    
	 
		DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'Y'    
		IF EXISTS (SELECT * FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2)    
		BEGIN    
			DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2    
		END    
		SELECT @DefCmpAlone=Status FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'    
		SELECT @DistCode = DistributorCode FROM Distributor     
		SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1     
	 --INSERT INTO Cs2Cn_Prk_DailySales    
	 --(    
	 -- DistCode  ,    
	 -- SalInvNo  ,    
	 -- SalInvDate  ,    
	 -- SalDlvDate  ,    
	 -- SalInvMode  ,    
	 -- SalInvType  ,    
	 -- SalGrossAmt  ,    
	 -- SalSplDiscAmt ,    
	 -- SalSchDiscAmt ,    
	 -- SalCashDiscAmt ,    
	 -- SalDBDiscAmt ,    
	 -- SalTaxAmt  ,    
	 -- SalWDSAmt  ,    
	 -- SalDbAdjAmt  ,    
	 -- SalCrAdjAmt  ,    
	 -- SalOnAccountAmt ,    
	 -- SalMktRetAmt ,    
	 -- SalReplaceAmt ,    
	 -- SalOtherChargesAmt,    
	 -- SalInvLevelDiscAmt,    
	 -- SalTotDedn  ,    
	 -- SalTotAddn  ,    
	 -- SalRoundOffAmt ,    
	 -- SalNetAmt  ,    
	 -- LcnId   ,    
	 -- LcnCode   ,    
	 -- SalesmanCode ,    
	 -- SalesmanName ,     
	 -- SalesRouteCode ,    
	 -- SalesRouteName ,    
	 -- RtrId   ,    
	 -- RtrCode   ,    
	 -- RtrName   ,    
	 -- VechName  ,    
	 -- DlvBoyName  ,    
	 -- DeliveryRouteCode ,     
	 -- DeliveryRouteName ,     
	 -- PrdCode    ,    
	 -- PrdBatCde   ,    
	 -- PrdQty    ,    
	 -- PrdSelRateBeforeTax ,    
	 -- PrdSelRateAfterTax ,    
	 -- PrdFreeQty  ,    
	 -- PrdGrossAmt  ,    
	 -- PrdSplDiscAmt ,    
	 -- PrdSchDiscAmt ,    
	 -- PrdCashDiscAmt ,    
	 -- PrdDBDiscAmt ,    
	 -- PrdTaxAmt  ,    
	 -- PrdNetAmt  ,    
	 -- UploadFlag  ,    
	 -- SalInvLineCount ,    
	 -- SalInvLvlDiscPer,    
	 -- BillStatus,    
	 -- UploadedDate,    
	 -- OrderRefNo,    
	 -- SFAOrderRefNo,    
	 -- RtrUniqueCode,
	 -- CtgCode,
	 -- CtgName,
	 -- ValueClassCode,
	 -- ValueClassName,
	 -- ChannelCode,
	 -- ChannelName      
	 --)    
	 --SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
	 --(CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
	 --(CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
	 --A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
	 --A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
	 --A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
	 --B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
	 --ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
	 --G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
	 --G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
	 --G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
	 --'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
	 --GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,''),RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
	 --RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName     
	 --FROM SalesInvoice A  (NOLOCK)    
	 --INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
	 --INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
	 --INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
	 --LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
	 --LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
	 --INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
	 --INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
	 --INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
	 --INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
	 --INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId  
	 ----Code Added by Deepan on 11/11/2019
	 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
	 --AND A.RTRValueClassId=RM.RtrValueClassId
	 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 --WHERE A.Upload=0 ORDER BY A.SalId   
	 INSERT INTO Cs2Cn_Prk_DailySales    
	 (    
		  DistCode  ,    
		  SalInvNo  ,    
		  SalInvDate  ,    
		  SalDlvDate  ,    
		  SalInvMode  ,    
		  SalInvType  ,    
		  SalGrossAmt  ,    
		  SalSplDiscAmt ,    
		  SalSchDiscAmt ,    
		  SalCashDiscAmt ,    
		  SalDBDiscAmt ,    
		  SalTaxAmt  ,    
		  SalWDSAmt  ,    
		  SalDbAdjAmt  ,    
		  SalCrAdjAmt  ,    
		  SalOnAccountAmt ,    
		  SalMktRetAmt ,    
		  SalReplaceAmt ,    
		  SalOtherChargesAmt,    
		  SalInvLevelDiscAmt,    
		  SalTotDedn  ,    
		  SalTotAddn  ,    
		  SalRoundOffAmt ,    
		  SalNetAmt  ,    
		  LcnId   ,    
		  LcnCode   ,    
		  SalesmanCode ,    
		  SalesmanName ,     
		  SalesRouteCode ,    
		  SalesRouteName ,    
		  RtrId   ,    
		  RtrCode   ,    
		  RtrName   ,    
		  VechName  ,    
		  DlvBoyName  ,    
		  DeliveryRouteCode ,     
		  DeliveryRouteName ,     
		  PrdCode    ,    
		  PrdBatCde   ,    
		  PrdQty    ,    
		  PrdSelRateBeforeTax ,    
		  PrdSelRateAfterTax ,    
		  PrdFreeQty  ,    
		  PrdGrossAmt  ,    
		  PrdSplDiscAmt ,    
		  PrdSchDiscAmt ,    
		  PrdCashDiscAmt ,    
		  PrdDBDiscAmt ,    
		  PrdTaxAmt  ,    
		  PrdNetAmt  ,    
		  UploadFlag  ,    
		  SalInvLineCount ,    
		  SalInvLvlDiscPer,    
		  BillStatus,    
		  UploadedDate,    
		  OrderRefNo,    
		  SFAOrderRefNo,    
		  RtrUniqueCode,
		  PrdTCSTaxAmount  --ILCRSTPAR8294
	 )    
	 SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
	 (CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
	 (CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
	 A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
	 A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
	 A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
	 B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
	 ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
	 G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
	 G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
	 G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
	 'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
	 GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,'')
	 ,ISNULL(PrdTCSTaxAmount,0) AS PrdTCSTaxAmount  --ILCRSTPAR8294
	 FROM SalesInvoice A  (NOLOCK)    
	 INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
	 INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
	 INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
	 LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
	 LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
	 INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
	 INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
	 INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
	 INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
	 INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId 
	 LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 WHERE A.Upload=0 ORDER BY A.SalId  
	 ----Code Added by Deepan on 11/11/2019
	 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
	 --AND A.RTRValueClassId=RM.RtrValueClassId
	 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
	 --WHERE A.Upload=0 ORDER BY A.SalId   

	  --ILCRSTPAR7329
	 
	 UPDATE  Cs2Cn_Prk_DailySales SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName,
	 CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName
	 FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN SALESINVOICE S(NOLOCK) ON C.SALINVNO=S.SALINVNO
	AND C.RtrId =S.RtrId 
	 INNER JOIN RetailerValueClass RC(NOLOCK) ON S.RtrValueClassId =RC.RtrClassId
	 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 
	 
	 
	 --UPDATE  Cs2Cn_Prk_DailySales SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
	 --FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
	 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 --UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
	 --FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
	 --INNER JOIN (    
	 --SELECT SalId,SalInvNo,PrdCCode,CmpBatCode,ISNULL(GrossAmt,0) AS GrossAmt,ISNULL(TaxAmount,0) AS TaxAmount,  
	 --ISNULL(GrossAmt+TaxAmount,0) AS LCTRAmt     
	 --FROM(    
	 --SELECT S.SALID,S.SALINVNO,P.PRDID,P.PRDCCODE,PB.CmpBatCode,SP.BASEQTY,SP.PrdUom1EditedSelRate,  
	 --ISNULL((SP.BASEQTY*SP.PrdUom1EditedSelRate),0) AS GrossAmt,    
	 --ISNULL(Tax.TaxAmount,0) AS TaxAmount    
	 --FROM SalesInvoice S (NOLOCK)    
	 --INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId=SP.SALID    
	 --INNER JOIN (    
	 --SELECT SalId,PrdSlno,SUM(TaxAmount) TaxAmount FROM SalesInvoiceProductTax (NOLOCK)    
	 --GROUP BY SalId,PrdSlno    
	 --)Tax ON Tax.SalId=S.SalId AND SP.SalId=Tax.SalId AND SP.SlNo=Tax.PrdSlNo    
	 --INNER JOIN Product P (NOLOCK) ON P.PrdId=SP.PrdId    
	 --INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId AND PB.PrdBatId=SP.PrdBatId    
	 --) X    
	 --WHERE EXISTS (SELECT SalInvNo,PrdCode,PrdBatCde FROM Cs2Cn_Prk_DailySales Y WHERE     
	 --X.SalInvNo=Y.SalInvNo AND X.PrdCCode=Y.PrdCode AND X.CmpBatCode=Y.PrdBatCde)    
	 --) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
	 ---------- Modified by Lakshman M on 06/11/2017 PMS_ICRSTPAR6569 ------------  
	  UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
	 FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
	 INNER JOIN (    
		SELECT SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,SUM(TaxableAmount) as TaxableAmount,SUM(LCTRAmt)as LCTRAmt,BaseQty FROM (
		SELECT DISTINCT A.SalId SalID ,A.SalInvNo SalInvNo,B.PrdId PrdId,P.PrdCCode PrdCCode,PB.CmpBatCode CmpBatCode,(C.TaxPerc) As taxperc,  
	  (C.TaxableAmount) AS TaxableAmount,--PBD.PrdBatDetailValue,
	  ((B.BaseQty *(PBD.PrdBatDetailValue))+((B.BaseQty *(PBD.PrdBatDetailValue))*sum(c.TaxPerc/100)))  As LCTRAmt,
	  B.BaseQty As BaseQty
	  FROM SalesInvoice A (NOLOCK)  
	  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.SALID=B.SALID  
	  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON A.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo  
	  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId  
	  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId  
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1	
	  INNER JOIN Cs2Cn_Prk_DailySales PRK (NOLOCK)  
	  ON PRK.SalInvNo=A.SalInvNo AND PRK.PrdCode=P.PrdCCode AND PRK.PrdBatCde=PB.CmpBatCode and prk.PrdQty=B.BaseQty   ------------- ILCRSTPAR4571 add by lakshman M Dated ON 25-05-2019 
	  where C.TaxableAmount >0 and PBD.SLNo =3 -- AND A.salinvno ='P88071822390'-- AND b.prdid = 4777
	  GROUP BY A.SalId,A.SalInvNo,B.PrdId,B.PrdUom1EditedSelRate,C.TaxPerc,P.PrdCCode,PB.CmpBatCode,C.TaxableAmount,B.PrdGrossAmount,B.PrdTaxAmount,
	  B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue--,B.PrdUnitSelRate,
	  HAVING (SUM(C.TaxableAmount))>0 ) A 
	  Group by  SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,BaseQty
	 ) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde AND Z.BaseQty= A.PrdQty
	   ----------------- till here --------------------  
	 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
	 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
	 Where ProcId = 1    
	 UPDATE A SET SalInvLineCount=B.SalInvLineCount    
	 FROM Cs2Cn_Prk_DailySales A,(SELECT SI.SalInvNo,COUNT(SIP.PrdId) AS SalInvLineCount     
	 FROM SalesInvoice SI,SalesInvoiceProduct SIP WHERE     
	 SI.UPload=0 AND SI.SalId=SIP.SalId    
	 GROUP BY SI.SalInvNo) B    
	 WHERE A.SalInvNo=B.SalInvNo   
	  
	 --->Added By Nanda on 17/08/2010    
	 INSERT INTO Cs2Cn_Prk_SalesInvoiceOrders(DistCode,SalInvNo,OrderNo,OrderDate,UploadFlag)    
	 SELECT DISTINCT @DistCode,SI.SalInvNo,OB.OrderNo,OB.OrderDate,'N'    
	 FROM SalesInvoice SI,SalesinvoiceOrderBooking SIOB,OrderBooking OB    
	 WHERE SI.SalId=SIOB.SalId AND SIOB.OrderNo=OB.OrderNo AND SI.Upload=0 AND SI.DlvSts>3  
	 
	 --->Till Here    
	 --UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT    
	 --SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N') AND Dlvsts IN (3,4,5)   
  		--COMMENTED AND ADDED BY MOHANA  ICRSTPAR7955 
	UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT
	SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N' AND BillStatus in(3,4,5))
		--TILL HERE
		
		
	UPDATE Cs2Cn_Prk_DailySales SET ServerDate=@ServerDate   
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ReturnSRTCSTaxDetailsNew' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnSRTCSTaxDetailsNew
GO
--SELECT * FROM DBO.Fn_ReturnPurchaseDiscount('308','',1)
CREATE FUNCTION Fn_ReturnSRTCSTaxDetailsNew(@Salinvno AS Nvarchar(50),@Salid AS INT,@Imode as INT,@Userid INT,@Transid INT)
RETURNS @ReturnSRTCSTaxDetailsNew TABLE 
(
    PrdName    Nvarchar(500),
    Batch      Nvarchar(500),
	TaxPerc NUMERIC(18,6),
	TaxableAmt NUMERIC(18,4),
	TaxAmt NUMERIC(18,4)
)
AS
/************************************************
* PROCEDURE  : Fn_ReturnTCSTaxDetailsNew
* PURPOSE    : To display TCS tax details in Billing
* CREATED BY : MarySubashini.S
* CREATED ON : 17/03/2020
* MODIFICATION
**************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
****************************************************************************************************
* 17/03/2020   MarySubashini.S    CR     DABCS202100016      To display TCS tax details in Billing
***************************************************************************************************/
BEGIN
	  IF @Imode=1
	   BEGIN
			INSERT INTO @ReturnSRTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM TCS_BilledPrdDtCalculatedTax T (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE T.Usrid=@Userid and T.TransId=@Transid
			Order by T.Rowid

		END
	IF @Imode=2
	   BEGIN
			INSERT INTO @ReturnSRTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM TCS_BilledPrdDtCalculatedTax T (NOLOCK) INNER JOIN Product P (NOLOCK)
			ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE T.Usrid=@Userid and T.TransId=@Transid
			Order by T.Rowid

		END
	IF @Imode=0
	   BEGIN   
			INSERT INTO @ReturnSRTCSTaxDetailsNew (Prdname,batch,TaxPerc,TaxableAmt,TaxAmt)
			SELECT PrdName,PrdBatCode,TaxPercentage,TaxableAmount,TaxAmount
			FROM ReturnproductTCSTaxNew ST (NOLOCK) INNER JOIN Returnproduct T (Nolock)
			on ST.Returnid=T.Returnid  and ST.PrdSlno=T.SlNo
			INNER JOIN Product P (NOLOCK) ON T.PRDID=P.PRDID	
			INNER JOIN Productbatch PB (Nolock) on PB.Prdid=P.Prdid and T.Prdid=PB.Prdid and T.Prdbatid=PB.Prdbatid
			WHERE ST.Returnid=@Salid
			Order by ST.Prdslno

		END
  	
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Cs2Cn_SalesReturn' and Xtype='P')
DROP PROCEDURE Proc_Cs2Cn_SalesReturn
GO
/*
	BEGIN TRANSACTION
	EXEC Proc_Cs2Cn_SalesReturn 0,'2020-03-16'
	SELECT * FROM Cs2Cn_Prk_SalesReturn (NOLOCK)
	ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2Cn_SalesReturn
(  
 @Po_ErrNo INT OUTPUT,
 @ServerDate DATETIME  
)  
AS
/*********************************  
* PROCEDURE  : Proc_Cs2Cn_SalesReturn  
* PURPOSE  : To Extract Sales Return Details from CoreStocky to upload to Console  
* CREATED BY : Nandakumar R.G  
* CREATED DATE : 21/03/2010  
* NOTE   :  
* MODIFIED  
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
21-12-2018   Lakshman M        SR      ILCRSTPAR2905        AS per client request LCTR Formula validation changed special price not consider Now default price only considered in LCTR Value. 
19-09-2019   Lakshman M        BZ      ILCRSTPAR6012        while upload sales return values tax perc values column script level validation missing in.
11-11-2019   Deepan			   CR	   CRCRSTPAR0089         Category and Value Class and channel Added
13-12-2019	 MOHANA S		   SR	   CRCRSTPAR0079		LCTR Calculation For New CR
12-11-2019   LAKSHMAN M        SR      ILCRSTPAR6643        Product tax calculation procedure validation splited for sales return upload process.											
06-01-2020	  Deepan		   BZ 	   ILCRSTPAR7329		 Category and channel modified	
28-05-2020	MOHANA S		   BZ	   PARCS202100027		fromdate and todate taken from Return table
17-03-2020   MarySubashini.S   CR      ILCRSTPAR8294		To display TCS tax details in Billing
************************************************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
		DECLARE @CmpId    AS INT  
		DECLARE @DistCode  As nVarchar(50)  
		DECLARE @DefCmpAlone AS INT  
		SET @Po_ErrNo=0 
		DECLARE @FromDate DATETIME  
		DECLARE @ToDate DATETIME 
		 
		 --SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK)

		 --PARCS202100027
		 SELECT @FromDate = MIN(ReturnDate),@ToDate = MAX(ReturnDate)  FROM ReturnHeader WHERE UpLoad = 0 AND Status = 0 
		 
		EXEC Proc_SchUtilization_Report @FromDate,@ToDate
		EXEC Proc_ReturnSalesProductTaxPercentage_SR @FromDate,@ToDate  
		SELECT * INTO #ParleOutputTaxPercentage  FROM ParleOutputTaxPercentage_SR (NOLOCK) 
		DECLARE @SlNo AS INT  
		SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'

		SELECT @DefCmpAlone=ISNULL(Status,0) FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'  
		DELETE FROM Cs2Cn_Prk_SalesReturn WHERE UploadFlag = 'Y'  
		SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1   
		SELECT @DistCode = DistributorCode FROM Distributor  
		--INSERT INTO [Cs2Cn_Prk_SalesReturn]  
		--(  
		-- DistCode  ,  
		-- SRNRefNo  ,  
		-- SRNRefType  ,  
		-- SRNDate   ,  
		-- SRNMode   ,  
		-- SRNType   ,   
		-- SRNGrossAmt  ,  
		-- SRNSplDiscAmt ,   
		-- SRNSchDiscAmt ,  
		-- SRNCashDiscAmt ,  
		-- SRNDBDiscAmt ,  
		-- SRNTaxAmt  ,  
		-- SRNRoundOffAmt ,
		-- SRNInvDiscount,  
		-- SRNNetAmt  ,  
		-- SalesmanName ,  
		-- SalesRouteName ,  
		-- RtrId   ,  
		-- RtrCode   ,  
		-- RtrName   ,  
		-- PrdSalInvNo  ,  
		-- PrdLcnId  ,  
		-- PrdLcnCode  ,  
		-- PrdCode   ,  
		-- PrdBatCde  ,  
		-- PrdSalQty  ,  
		-- PrdUnSalQty  ,  
		-- PrdOfferQty  ,  
		-- PrdSelRate  ,  
		-- PrdGrossAmt  ,  
		-- PrdSplDiscAmt ,  
		-- PrdSchDiscAmt ,  
		-- PrdCashDiscAmt ,  
		-- PrdDBDiscAmt ,  
		-- PrdTaxAmt  ,  
		-- PrdNetAmt  ,  
		-- UploadFlag,
		-- RtrUniqueCode,
		-- CtgCode,
		-- CtgName,
		-- ValueClassCode,
		-- ValueClassName,
		-- ChannelCode,
		-- ChannelName    
		--)  
		--SELECT  
		-- @DistCode ,  
		-- A.ReturnCode ,  
		-- (CASE ReturnType WHEN 1 THEN 'Market Return' ELSE 'Sales Return' END),  
		-- A.ReturnDate ,  
		-- (CASE A.ReturnMode WHEN 0 THEN '' WHEN 1 THEN 'Full' ELSE 'Partial' END),  
		-- (CASE A.InvoiceType WHEN 1 THEN 'Single Invoice' ELSE 'Multi Invoice' END),  
		-- A.RtnGrossAmt,A.RtnSplDisAmt,A.RtnSchDisAmt,A.RtnCashDisAmt,A.RtnDBDisAmt,  
		-- A.RtnTaxAmt,A.RtnRoundOffAmt,A.RtnInvLvlDisc,A.RtnNetAmt,  
		-- SM.SMName,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,  
		-- ISNULL(G.SalInvno,B.SalCode) AS SalInvNo,  
		-- L.LcnId,L.LcnCode,    
		-- D.PrdCCode,F.CmpBatCode,  
		-- (CASE ST.SystemStockType WHEN 1 THEN BaseQty ELSE 0 END)AS SalQty,  
		-- (CASE ST.SystemStockType WHEN 2 THEN BaseQty ELSE 0 END)AS UnSalQty,  
		-- (CASE ST.SystemStockType WHEN 3 THEN BaseQty ELSE 0 END)AS OfferQty,  
		-- B.PrdEditSelRte ,  
		-- B.PrdGrossAmt,B.PrdSplDisAmt,B.PrdSchDisAmt,B.PrdCDDisAmt,B.PrdDBDisAmt,  
		-- B.PrdTaxAmt,B.PrdNetAmt,  
		-- 'N' AS UploadFlag,ISNULL(R.RtrUniqueCode,'') ,RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
		-- RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName   
		-- FROM ReturnHeader A INNER JOIN ReturnProduct B ON A.ReturnId = B.ReturnId  
		-- INNER JOIN RouteMaster C ON A.RMID = C.RMID  
		-- INNER JOIN Product D ON B.PrdId = D.PrdId  
		-- INNER JOIN Company E ON D.CmpId = E.CmpId  
		-- INNER JOIN ProductBatch F ON B.PrdBatId = F.PrdBatId  
		-- INNER JOIN Retailer R ON R.RtrId=A.RtrId  
		-- LEFT OUTER JOIN SalesInvoice G ON B.SalId = G.SalId  
		-- INNER JOIN Salesman SM ON A.SMId=SM.SMId  
		-- INNER JOIN StockType ST ON B.StockTypeId=ST.StockTypeId  
		-- INNER JOIN Location L ON L.LcnId=ST.LcnId  
		--  --Code Added by Deepan on 11/11/2019
		--INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON A.RTRID =RM.RTRID AND A.RTRValueClassId=RM.RtrValueClassId
		--INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
		--INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
		--INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
		--INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
		--WHERE A.Status = 0 AND E.CmpId = (CASE @DefCmpAlone WHEN 1 THEN @CmpId ELSE E.CmpId END)  
		-- AND A.Upload=0 
		INSERT INTO [Cs2Cn_Prk_SalesReturn]  
		(  
			DistCode  ,  
			SRNRefNo  ,  
			SRNRefType  ,  
			SRNDate   ,  
			SRNMode   ,  
			SRNType   ,   
			SRNGrossAmt  ,  
			SRNSplDiscAmt ,   
			SRNSchDiscAmt ,  
			SRNCashDiscAmt ,  
			SRNDBDiscAmt ,  
			SRNTaxAmt  ,  
			SRNRoundOffAmt ,
			SRNInvDiscount,  
			SRNNetAmt  ,  
			SalesmanName ,  
			SalesRouteName ,  
			RtrId   ,  
			RtrCode   ,  
			RtrName   ,  
			PrdSalInvNo  ,  
			PrdLcnId  ,  
			PrdLcnCode  ,  
			PrdCode   ,  
			PrdBatCde  ,  
			PrdSalQty  ,  
			PrdUnSalQty  ,  
			PrdOfferQty  ,  
			PrdSelRate  ,  
			PrdGrossAmt  ,  
			PrdSplDiscAmt ,  
			PrdSchDiscAmt ,  
			PrdCashDiscAmt ,  
			PrdDBDiscAmt ,  
			PrdTaxAmt  ,  
			PrdNetAmt  ,  
			UploadFlag,
			RtrUniqueCode ,
			PrdTCSTaxAmount --ILCRSTPAR8294
		)  
		SELECT  
			@DistCode ,  
			A.ReturnCode ,  
			(CASE ReturnType WHEN 1 THEN 'Market Return' ELSE 'Sales Return' END),  
			A.ReturnDate ,  
			(CASE A.ReturnMode WHEN 0 THEN '' WHEN 1 THEN 'Full' ELSE 'Partial' END),  
			(CASE A.InvoiceType WHEN 1 THEN 'Single Invoice' ELSE 'Multi Invoice' END),  
			A.RtnGrossAmt,A.RtnSplDisAmt,A.RtnSchDisAmt,A.RtnCashDisAmt,A.RtnDBDisAmt,  
			A.RtnTaxAmt,A.RtnRoundOffAmt,A.RtnInvLvlDisc,A.RtnNetAmt,  
			SM.SMName,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,  
			ISNULL(G.SalInvno,B.SalCode) AS SalInvNo,  
			L.LcnId,L.LcnCode,    
			D.PrdCCode,F.CmpBatCode,  
			(CASE ST.SystemStockType WHEN 1 THEN BaseQty ELSE 0 END)AS SalQty,  
			(CASE ST.SystemStockType WHEN 2 THEN BaseQty ELSE 0 END)AS UnSalQty,  
			(CASE ST.SystemStockType WHEN 3 THEN BaseQty ELSE 0 END)AS OfferQty,  
			B.PrdEditSelRte ,  
			B.PrdGrossAmt,B.PrdSplDisAmt,B.PrdSchDisAmt,B.PrdCDDisAmt,B.PrdDBDisAmt,  
			B.PrdTaxAmt,B.PrdNetAmt,  
			'N' AS UploadFlag,ISNULL(R.RtrUniqueCode,'')  
			,ISNULL(B.PrdTCSTaxAmount,0) AS PrdTCSTaxAmount --ILCRSTPAR8294
		FROM ReturnHeader A INNER JOIN ReturnProduct B ON A.ReturnId = B.ReturnId  
		INNER JOIN RouteMaster C ON A.RMID = C.RMID  
		INNER JOIN Product D ON B.PrdId = D.PrdId  
		INNER JOIN Company E ON D.CmpId = E.CmpId  
		INNER JOIN ProductBatch F ON B.PrdBatId = F.PrdBatId  
		INNER JOIN Retailer R ON R.RtrId=A.RtrId  
		LEFT OUTER JOIN SalesInvoice G ON B.SalId = G.SalId  
		INNER JOIN Salesman SM ON A.SMId=SM.SMId  
		INNER JOIN StockType ST ON B.StockTypeId=ST.StockTypeId  
		INNER JOIN Location L ON L.LcnId=ST.LcnId  
		--Code Added by Deepan on 11/11/2019
		--INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON A.RTRID =RM.RTRID AND A.RTRValueClassId=RM.RtrValueClassId
		--INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
		--INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
		--INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
		--INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
		WHERE A.Status = 0 AND E.CmpId = (CASE @DefCmpAlone WHEN 1 THEN @CmpId ELSE E.CmpId END)  
		AND A.Upload=0 

		UPDATE  [Cs2Cn_Prk_SalesReturn] SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName,
		CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
		FROM [Cs2Cn_Prk_SalesReturn] C(NOLOCK) INNER JOIN ReturnHeader S(NOLOCK) ON C.SRNRefNo=S.ReturnCode
		AND C.RtrId =S.RtrId 
		INNER JOIN RetailerValueClass RC(NOLOCK) ON S.RtrValueClassId =RC.RtrClassId
		INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
		INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId

		--UPDATE  [Cs2Cn_Prk_SalesReturn] SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
		--FROM [Cs2Cn_Prk_SalesReturn] C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
		--INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
		--INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
		--INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
		-------------- Added By LAkshman M dated ON 21-12-2018 PMS ID: ILCRSTPAR2905
		UPDATE PRK SET PRK.LCTRAmount=ISNULL(LCTRAmt,0)
		FROM Cs2Cn_Prk_SalesReturn PRK (NOLOCK)
		INNER JOIN 
		(
				SELECT R.ReturnId,R.ReturnCode,P.PrdCCode,PB.CmpBatCode,
				--(SUM(RP.BaseQty)*RP.PrdEditSelRte)+(SUM(RP.BaseQty)*RP.PrdEditSelRte)*(RPT.TaxPerc/100) AS LCTRAmt,
				ROUND(((Rp.BaseQty *(PBD.PrdBatDetailValue))+(Rp.BaseQty*PBD.PrdBatDetailValue)*(T.TaxPerc/100)),2) AS LCTRAmt,
				SUM(RPT.TaxableAmt) AS TaxableAmt,RPT.TaxPerc  
				FROM ReturnHeader R (NOLOCK)
				INNER JOIN ReturnProduct RP (NOLOCK) ON R.RETURNID=RP.RETURNID
				INNER JOIN ReturnProductTax RPT (NOLOCK) ON R.RETURNID=RPT.RETURNID AND RP.RETURNID=RPT.RETURNID AND RP.SlNO=RPT.PrdSlNo
				INNER JOIN Product P (NOLOCK) ON P.PrdId=RP.PrdId
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId AND PB.PrdId=RP.PrdId AND RP.PrdBatId=PB.PrdBatId
				INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1 AND PBD.SLNo =3
				INNER JOIN Cs2Cn_Prk_SalesReturn Prk (NOLOCK) ON Prk.PrdCode=P.PrdCCode AND Prk.PrdBatCde=PB.CmpBatCode
				INNER JOIN #ParleOutputTaxPercentage T (NOLOCK) ON R.ReturnID  = T.Salid AND Rp.Slno = T.PrdSlno  --  ILCRSTPAR6012 added by lakshman M 
				GROUP BY R.ReturnId,R.ReturnCode,P.PrdCCode,PB.CmpBatCode,RPT.TaxPerc,RP.PrdEditSelRte,Rp.BaseQty,PBD.PrdBatDetailValue,T.TaxPerc
				HAVING (SUM(RPT.TaxableAmt))>0
		) Z ON Z.ReturnCode=PRK.SRNRefNo AND Z.PrdCCode=PRK.PrdCode AND Z.CmpBatCode=PRK.PrdBatCde


		--------------- commented as per PM confirmation. dated on 28-01-2020 PMS ID: ILCRSTPAR7591
		-- SELECT DISTINCT P.Prdccode,PrdBatCode, PrdBatDetailValue LCTR INTO #LCTR 
		-- FROM  Product P 
		-- INNER JOIN ProductBatch A ON A.prdid =P.Prdid
		-- INNER JOIN ProductBatchDetails B ON A.PrdBatId = B.PrdBatId and DefaultPrice =1 and slno=5

		--UPDATE A SET LCTRAmount = B.LCTR FROM Cs2Cn_Prk_SalesReturn A INNER JOIN #LCTR B ON A.PrdBatCde = B.PrdBatCode AND A.PrdCode = B.PrdCCode 
		--WHERE B.LCTR>0
		----------------------------- till here -----------------------
		------------ Till here  ---------------

		UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),  
		ProcDate = CONVERT(nVarChar(10),GetDate(),121)  
		Where ProcId = 4  
		
		UPDATE ReturnHeader SET Upload=1 WHERE Upload=0 AND ReturnCode IN (SELECT DISTINCT  
		SRNRefNo FROM Cs2Cn_Prk_SalesReturn WHERE UploadFlag = 'N') AND Status=0   
		
		UPDATE Cs2Cn_Prk_SalesReturn SET ServerDate=@ServerDate
END
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName in ('TCS Tax Settings','TCS Dist UDCDetails')
INSERT INTO Tbl_DownloadIntegration(SequenceNo,ProcessName,PrkTableName,SPName,TRowCount,selectCount,CreatedDate)
SELECT 105,'TCS Tax Settings' ,'Cn2Cs_Prk_TCS_Taxsetting_Dt','Proc_Import_TCS_Taxsetting_Dt',0,500,
Getdate() 
UNION ALL
SELECT 106,'TCS Dist UDCDetails' ,'Cn2Cs_Prk_DistTCSUDCDetails','Proc_Import_DistTCSUDCDetails',0,500,
Getdate() 
GO
DELETE FROM CustomUpDownload WHERE Screen in ('TCS Tax Settings','TCS Dist UDCDetails') and UpDownload='Download' 
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,
ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 294 ,1,'TCS Tax Settings','TCS Tax Settings','','Proc_Import_TCS_Taxsetting_Dt','Cn2Cs_Prk_TCS_Taxsetting_Dt',
'Proc_Cn2Cs_TCS_TaxSetting','Master','Download',1 
UNION ALL
SELECT 295,1,'TCS Dist UDCDetails','TCS Dist UDCDetails','','Proc_Import_DistTCSUDCDetails',
'Cn2Cs_Prk_DistTCSUDCDetails','Proc_CN2CS_DistTCSUDCDetails','Master','Download',1
GO
DELETE FROM CustomUpDownloadCount WHERE Module in ('TCS Tax Settings','TCS Dist UDCDetails') and UpDownload='Download'
INSERT INTO CustomUpDownloadCount(SlNo,SeqNo,Module,Screen,ParkTable,MainTable,KeyField1,KeyField2,KeyField3,
UpDownload,OldMax,OldCount,NewMax,NewCount,DownloadedCount,SelectQuery)
SELECT 245,1,'TCS Tax Settings','TCS Tax Settings','Cn2Cs_Prk_TCS_Taxsetting_Dt','Cn2Cs_Prk_TCS_Taxsetting_Dt',
'DownLoadFlag','','','Download',0,0,0,0,0,'' 
UNION ALL
SELECT 246,1,'TCS Dist UDCDetails','TCS Dist UDCDetails','Cn2Cs_Prk_DistTCSUDCDetails','Cn2Cs_Prk_DistTCSUDCDetails',
'DownLoadFlag','','','Download',0,0,0,0,0,'' 
GO
IF NOT EXISTS (SELECT * FROM CustomCaptions where Transid=506)
BEGIN
INSERT INTO Customcaptions(TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,
DefaultMsgBox,Visibility,Enabled)
SELECT 506,5,1,'CoreHeaderTool','TCS Tax Setting','','',1,1,1,GETDATE(),1,GETDATE(),'TCS Tax Setting','','',1,1 UNION ALL
SELECT 506,5,12,'CoreHeaderTool','Stocky','','',1,1,1,GETDATE(),1,GETDATE(),'Stocky','','',1,1 UNION ALL
SELECT 506,6,2,'DgCommon-506-6-2','TCS Code','','',1,1,1,GETDATE(),1,GETDATE(),'TCS Code','','',1,1 UNION ALL
SELECT 506,6,3,'DgCommon-506-6-3','TCS Name','','',1,1,1,GETDATE(),1,GETDATE(),'TCS Name','','',1,1 UNION ALL
SELECT 506,6,4,'DgCommon-506-6-4','Effecitive Date','','',1,1,1,GETDATE(),1,GETDATE(),'Effecitive Date','','',1,1 UNION ALL
SELECT 506,6,5,'DgCommon-506-6-5','PAN/AADHAAR Yes%','','',1,1,1,GETDATE(),1,GETDATE(),'PAN/AADHAAR Yes%','','',1,1 UNION ALL
SELECT 506,6,6,'DgCommon-506-6-6','PAN/AADHAAR No%','','',1,1,1,GETDATE(),1,GETDATE(),'PAN/AADHAAR No%','','',1,1 
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='FN_ReturnTCS_TaxSetting_Master' and XTYPE IN ('TF','FN'))
DROP FUNCTION FN_ReturnTCS_TaxSetting_Master
GO
--SELECT * FROM FN_ReturnTCSTaxSetting() ORDER BY TCSTAXID DESC
CREATE FUNCTION FN_ReturnTCS_TaxSetting_Master()
RETURNS @ReturnTCS_TaxSetting_Master TABLE
(
		TaxId		INT,
		TaxCode		VARCHAR(20),
		TaxName		VARCHAR(100),
		EffectiveDate	DATETIME,
		TaxPANAADHAR_YES		NUMERIC(18,6),
		TaxPANAADHAR_No		NUMERIC(18,6),
		Availability	INT,
		LastModBy		INT,
		LastModDate		DATETIME,
		AuthId			INT,
		AuthDate		DATETIME
)
AS
/*********************************  
* PROCEDURE  : FN_ReturnTCS_TaxSetting_Master  
* PURPOSE  : To Return TCS Tax setting details 
* CREATED BY : MarySubashini.S   ILCRSTPAR8294
* CREATED DATE : 17-03-2020 
* NOTE   :  
* MODIFIED  
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
17-03-2020   MarySubashini.S   CR      ILCRSTPAR8294		To display TCS tax details in Billing
************************************************************************************************************************************/  

BEGIN
	INSERT INTO @ReturnTCS_TaxSetting_Master(TaxId,TaxCode,TaxName,EffectiveDate,TaxPANAADHAR_YES,TaxPANAADHAR_No,
	Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT Taxseqid as TaxId,A.TaxCode,A.TaxName,Eeffective_Date AS EffectiveDate,TaxPANAADHAR_YES,TaxPANAADHAR_No,
	A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate FROM TCS_TaxSetting_Master A (NOLOCK)
	INNER JOIN TCS_TaxSetting_Details B	(NOLOCK) ON A.TaxCode=B.TaxCode 
	Order by TaxSeqId
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ISAadhaar' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ISAadhaar
GO
--SELECT DBO.Fn_ISPanNumber('GAAAY3556Y')
CREATE FUNCTION Fn_ISAadhaar(@gAadhar AS Varchar(20))--,@StateId as Int
RETURNS INT
/*********************************
* FUNCTION: Fn_ISPanNumber
* PURPOSE: Pancard Number Validation
* NOTES: 
* CREATED: Murugan.R 27/02/2017
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 
*********************************/
AS
BEGIN
	/*	
	1. First 5 character should alphabetic. 
	2. Next 4 character should be Numeric 
	3. Last character should alphabetic.	
	*/
	DECLARE @gAahar AS TINYINT
	
	SET @gAahar=0
	
	IF LEN(LTRIM(RTRIM(@gAadhar)))<>12
	BEGIN
		SET @gAahar=1
	END

		
	IF (SELECT DBO.Fn_ISInt(SUBSTRING(@gAadhar,12,1)))=0
	BEGIN
		SET @gAahar=1
	END
	
	RETURN @gAahar
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ValidateSavePANAADHRAUDC' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ValidateSavePANAADHRAUDC
GO
--SELECT dbo.Fn_ValidateSavePANAADHRAUDC(79,2,2,'PAN/AADHAAR AVAILABLE','YES','','789078907890') as ValMsg
CREATE FUNCTION Fn_ValidateSavePANAADHRAUDC(@TransId as INT,@RtrId as BIGINT,@MasterId AS INT,@ColumnName AS VARCHAR(200),
@ColumnValue AS VARCHAR(200),@VPANNumber as varchar(50),@Vaadhar as VARCHAR(50))
RETURNS VARCHAR(200)
AS
/*********************************
* PROCEDURE		: Fn_ValidateSaveUDC
* PURPOSE		: To Validate UDC 
* CREATED		: S.Moorthi
* CREATED DATE	: 11-05-2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
	DECLARE @ValMsg AS VARCHAR(200)
	SET @ValMsg=''
	     
		 IF @VPANNumber=''
		BEGIN
			SET @VPANNumber='NULL'
		END

		IF @Vaadhar=''
		BEGIN
			SET @Vaadhar='NULL'
		END

 
			IF RTRIM(LTRIM(UPPER(ISNULL(@VPANNumber,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@VPANNumber))=1
				BEGIN
					SET @ValMsg='Invalid Pan Number.So PAN/Aadhaar available must be No'
				END
			END

           IF RTRIM(LTRIM(UPPER(ISNULL(@Vaadhar,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISAadhaar(@Vaadhar))=1
				BEGIN
					SET @ValMsg='Invalid Aadhaar.So PAN/Aadhaar available must be No'
				END
			END	

			
	       IF RTRIM(LTRIM(UPPER(ISNULL(@VPANNumber,'NULL'))))='NULL' and RTRIM(LTRIM(UPPER(ISNULL(@Vaadhar,'NULL'))))='NULL'
		     BEGIN
			     SET @ValMsg='Invalid.So PAN/Aadhaar available must be No'
			 END


RETURN @ValMsg
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ValidateSaveUDC' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ValidateSaveUDC
GO
--SELECT dbo.Fn_ValidateSaveUDC(79,446,2,'GSTIN','11GPKPM5222K1G5')
CREATE FUNCTION Fn_ValidateSaveUDC(@TransId as INT,@RtrId as BIGINT,@MasterId AS INT,@ColumnName AS VARCHAR(200),@ColumnValue AS VARCHAR(200))
RETURNS VARCHAR(200)
AS
/*********************************
* PROCEDURE		: Fn_ValidateSaveUDC
* PURPOSE		: To Validate UDC 
* CREATED		: S.Moorthi
* CREATED DATE	: 11-05-2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
18/09/2020  S.Moorthi		CR      DABCS202100016				To display TCS tax details in Billing
************************************************************************************************************************************/
BEGIN
	DECLARE @ValMsg AS VARCHAR(200)
	--DECLARE @Vaadhar as VARCHAR(50)
	--DECLARE @VPANNumber as VARCHAR(100)
	SET @ValMsg=''

	--SET @Vaadhar=''
	--SET @VPANNumber=''
	
	IF NOT EXISTS(SELECT * FROM GSTConfiguration (NOLOCK) 
	WHERE ModuleId='GSTCONFIG' and ActivationStatus=1 and 
	ConsoleAckStatus=1)
	BEGIN
		RETURN @ValMsg
	END 
	
	IF @ColumnValue=''
	BEGIN
		SET @ColumnValue='NULL'
	END
	
	IF @TransId=41
	BEGIN
		IF EXISTS(SELECT b.* FROM Retailer A (NOLOCK)
		INNER JOIN UdcDetails B(NOLOCK) ON A.RtrId=B.MasterRecordId 
		INNER JOIN UdcMaster C(NOLOCK) ON C.MasterId=B.MasterId AND C.UdcMasterId=B.UdcMasterId
		WHERE C.ColumnName='Retailer Type' and UPPER(B.ColumnValue)='REGISTERED' AND C.MasteriD=2)
		BEGIN
			IF @ColumnValue='NULL'
			BEGIN
				SET @ColumnValue=''
			END
		END
	END
	
	IF @TransId in (79,41)
	BEGIN
	
	IF @TransId=41  ----Gopi at 25/06/2017 GST10
	 BEGIN
	  IF EXISTS(SELECT b.* FROM Retailer A (NOLOCK)
		INNER JOIN UdcDetails B(NOLOCK) ON A.RtrId=B.MasterRecordId 
		INNER JOIN UdcMaster C(NOLOCK) ON C.MasterId=B.MasterId AND C.UdcMasterId=B.UdcMasterId
		WHERE A.Rtrid=@Rtrid and C.ColumnName='Retailer Type' and UPPER(B.ColumnValue)='UNREGISTERED' AND C.MasteriD=2)
		BEGIN
		   RETURN @ValMsg
		END
	  END  ---Till Here 
		
		IF UPPER(@ColumnName)='GSTIN'
		BEGIN
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColumnValue,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISGSTINNumber(@ColumnValue))=1
				BEGIN					
					SET @ValMsg='Invalid GST Tin Number'					
				END
			END
		END
		
		IF @ColumnName='PAN Number'
		BEGIN	
		  -- SET @VPANNumber=@ColumnValue
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColumnValue,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@ColumnValue))=1
				BEGIN
					SET @ValMsg='Invalid Pan Number'
				END
				
			END
		END

---MARCS202100060
	IF @TransId=79
	BEGIN
	  	IF @ColumnName='Aadhaar'
		BEGIN	
		   -- SET @Vaadhar=@ColumnValue
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColumnValue,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISAadhaar(@ColumnValue))=1
				BEGIN
					SET @ValMsg='Invalid Aadhaar'
				END
				
			END
		END
     END
	 ----Till here

		--IF @ColumnName='GSTIN' or @ColumnName='PAN Number'
		--IF  @ColumnName='PAN Number'
		--BEGIN
		--	IF ISNULL(@ColumnValue,'')<>'' AND ISNULL(@ColumnValue,'NULL')<>'NULL'
		--	BEGIN
		--		IF EXISTS(SELECT UD.* FROM UdcHD A (NOLOCK)
		--			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
		--			INNER JOIN UdcDetails UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId 
		--			INNER JOIN Retailer R (NOLOCK) ON R.RtrId=UD.MasterRecordId 
		--			WHERE A.MasterId=@MasterId AND B.ColumnName=@ColumnName and ISNULL(ColumnValue,'')<>''
		--			AND R.RtrId<>@RtrId and ColumnValue=@ColumnValue)
		--		BEGIN
		--			SET @ValMsg='Duplicate '+ @ColumnName +' Not Allow'
		--		END
		--	END
		--END
	END
	
RETURN @ValMsg
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_VoucherPostingPurchase' and Xtype='P')
DROP PROCEDURE Proc_VoucherPostingPurchase
GO
/*
BEGIN TRANSACTION
--EXEC Proc_VoucherPostingPurchase 5,1,'GRN14000217',5,0,1,'2014-06-22',0
EXEC Proc_VoucherPostingPurchase 7,1,'PRT14000002',5,0,1,'2014-06-23',0
select * from StdVocDetails (nolock) Where VocRefNo = 'PUR1400246'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_VoucherPostingPurchase
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingPurchase
* PURPOSE	: General SP for posting Purchase Voucher
* CREATED	: Thrinath
* CREATED DATE	: 25/12/2007
* MODIFIED
* DATE        AUTHOR             CR/BZ          USERSTORYID            DESCRIPTION
**********************************************************************************************    
* 17-03-2020   MarySubashini.S    CR		   ILCRSTPAR8294			TCSTaxAmt column added
* 09-10-2020   S.MOORTHI		  SR		   DBRS/1020/073			TCSTaxAmt
**************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @AcmId 		INT
	DECLARE @AcpId		INT
	DECLARE @CoaId		INT
	DECLARE @VocRefNo	nVarChar(100)
	DECLARE @sStr		nVarChar(4000)
	DECLARE @Amt		Numeric(25,6)
	DECLARE @DCoaId		INT
	DECLARE @CCoaId		INT
	DECLARE @DiffAmt	Numeric(25,6)
	DECLARE @sSql           VARCHAR(4000)
	DECLARE @InputCoaId  INT --ILCRSTPAR8294
	SET @Po_PurErrNo = 1
	IF @Pi_TransId = 5 AND @Pi_SubTransId = 1
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		--For Posting Purchase Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From GRN ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'
		--For Posting Purchase Account in Details Table on Debit(Gross Amount)
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4110001')
		BEGIN
			SET @Po_PurErrNo = -2
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4110001'
		SELECT @Amt = SUM(PrdGrossAmount) FROM PurchaseReceiptProduct
		WHERE PurRcptId IN (SELECT PurRcptId FROM
		PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo)
		
		DECLARE @Amt1 AS NUMERIC(38,6)
		SELECT @Amt1=LessScheme FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt-@Amt1,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		
		--For Posting Supplier Account in Details Table to Credit(Net Payable)
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN PurchaseReceipt C ON B.SpmId = C.SpmId
			WHERE C.PurRcptRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN PurchaseReceipt C ON B.SpmId = C.SpmId
			WHERE C.PurRcptRefNo = @Pi_ReferNo
		--->Modified By Nanda on 29/10/2010
		--SELECT @Amt = NetPayable FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
		SELECT @Amt = NetPayable+DbAdjustAmt-CrAdjustAmt FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
			
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		--For Posting Purchase Discount Account in Details Table to Credit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,D.CoaId,2,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptHdAmount B ON
				A.PurRcptId = B.PurRcptId
			INNER JOIN PurchaseSequenceMaster C ON
				A.PurSeqId = C.PurSeqId
			INNER JOIN PurchaseSequenceDetail D ON
				C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
			WHERE A.PurRcptRefNo = @Pi_ReferNo AND
				EffectInNetAmount = 2 AND B.BaseQtyAmount > 0
		--For Posting Purchase Addition Account in Details Table on Debit
		SELECT @VocRefNo AS VocRefNo,D.CoaId,1 AS DebitCredit,B.BaseQtyAmount AS Amount,1 AS Availability,
			@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,
			@Pi_UserId AS AuthId,Convert(varchar(10),Getdate(),121) AS AuthDate
		INTO #PurTotAdd
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptHdAmount B ON
			A.PurRcptId = B.PurRcptId
		INNER JOIN PurchaseSequenceMaster C ON
			A.PurSeqId = C.PurSeqId
		INNER JOIN PurchaseSequenceDetail D ON
			C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND B.RefCode <> 'D' AND
			EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
			
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT * FROM #PurTotAdd
		
		--For Posting Purchase Tax Account in Details Table on Debit
		SELECT @VocRefNo AS VocRefNo,C.InputTaxId,1 AS DebitCredit,ISNULL(SUM(B.TaxAmount),0) AS Amount,1 AS Availability,
			@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,@Pi_UserId AS AuthId,
			Convert(varchar(10),Getdate(),121) AS AuthDate
		INTO #PurTaxForDiff
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptProductTax B ON
				A.PurRcptId = B.PurRcptId
			INNER JOIN TaxConfiguration C ON
				B.TaxId = C.TaxId
			WHERE A.PurRcptRefNo = @Pi_ReferNo
			Group By C.InputTaxId
			HAVING ISNULL(SUM(B.TaxAmount),0) > 0
		
		--Added by Sathishkumar Veeramani 2013/11/26	
		SELECT @DiffAmt=ISNULL((SUM(A.TotalAddition)-(SUM(B.Amount)+SUM(C.Amount)+SUM(A.CrAdjustAmt))),0)
		FROM PurchaseReceipt A,(SELECT SUM(Amount) AS Amount FROM #PurTaxForDiff)B,#PurTotAdd C
		WHERE A.PurRcptRefNo = @Pi_ReferNo
		
		UPDATE #PurTaxForDiff SET Amount=Amount+@DiffAmt
		WHERE InputTaxId IN (SELECT MIN(InputTaxId) FROM #PurTaxForDiff)
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT * FROM #PurTaxForDiff
		
		
		---TCS Tax amount for Purchase ILCRSTPAR8294
		--DBRS/1020/073 START
		SET @InputCoaId=(SELECT TOP 1 InputCoaid from TCS_TaxSetting_Details A INNER JOIN TCS_TaxSetting_Master B
		ON A.TaxCode=B.TaxCode ORDER BY A.LastModDate desc)
	   INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		--For Posting Purchase TCS Tax Account in Details Table on Debit
		SELECT VocRefNo,CoaId,DebitCredit,SUM(Amount) as Amount,Availability,Lastmodby,LastModDate,Authid,AuthDate FROM(
		SELECT @VocRefNo AS VocRefNo,@InputCoaId AS CoaId,1 AS DebitCredit,ISNULL(SUM(B.TCSTaxAmt),0) AS Amount,1 AS Availability,
			@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,@Pi_UserId AS AuthId,
			Convert(varchar(10),Getdate(),121) AS AuthDate
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptProduct B ON
				A.PurRcptId = B.PurRcptId
			WHERE A.PurRcptRefNo = @Pi_ReferNo
			HAVING ISNULL(SUM(B.TCSTaxAmt),0) > 0
		---DABCS202100016
		UNION ALL
			SELECT @VocRefNo AS VocRefNo,@InputCoaId as CoaId,1 AS DebitCredit,ISNULL(SUM(B.TCSTaxAmt),0) AS Amount,1 AS Availability,
			@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,@Pi_UserId AS AuthId,
			Convert(varchar(10),Getdate(),121) AS AuthDate
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptClaimScheme B ON
				A.PurRcptId = B.PurRcptId
			WHERE A.PurRcptRefNo = @Pi_ReferNo
			HAVING ISNULL(SUM(B.TCSTaxAmt),0) > 0
			) A	Group by VocRefNo,CoaId,DebitCredit,Availability,Lastmodby,LastModDate,Authid,AuthDate
		---DBRS/1020/073 END
		
		--For Posting Scheme Discount in Details Table to Credit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3210002')
		BEGIN
			SET @Po_PurErrNo = -9
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3210002'
		SET @Amt = 0
		SELECT @Amt = LessScheme FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
			AND LessScheme > 0
		
		IF @Amt > 0
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		END
		--For Posting Other Charges Add in Details Table For Debit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,B.CoaId,1,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
				A.PurRcptId = B.PurRcptId
			WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 0
			Group By B.CoaId
			HAVING ISNULL(SUM(B.Amount),0) > 0
		--For Posting Other Charges Reduce in Details Table To Credit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,B.CoaId,2,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
				A.PurRcptId = B.PurRcptId
			WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 1
			Group By B.CoaId
			HAVING ISNULL(SUM(B.Amount),0) > 0
		--For Posting Round Off Account reduce in Details Table to Debit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3220001')
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3220001'
		SET @Amt = 0
		SELECT @Amt = DifferenceAmount FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
			AND DifferenceAmount > 0
		
		IF @Amt > 0
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,2,Abs(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		END
		--For Posting Round Off Account Add in Details Table to Credit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210001')
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210001'
		SET @Amt = 0
		SELECT @Amt = DifferenceAmount FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
			AND DifferenceAmount < 0
		
		IF @Amt < 0
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,1,ABS(@Amt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		END
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
	IF @Pi_TransId = 7 AND @Pi_SubTransId = 1	--Purchase Return
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		--For Posting Purchase Return Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Purchase Return ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'
		--For Posting Purchase Return Account in Details Table on Debit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4110002')
		BEGIN
			SET @Po_PurErrNo = -22
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4110002'
		SELECT @Amt = GrossAmount FROM PurchaseReturn WHERE PurRetRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Supplier Account in Details Table to Credit
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN PurchaseReturn C ON B.SpmId = C.SpmId
			WHERE C.PurRetRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN PurchaseReturn C ON B.SpmId = C.SpmId
			WHERE C.PurRetRefNo = @Pi_ReferNo
		SELECT @Amt = NetAmount FROM PurchaseReturn WHERE PurRetRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Purchase Return Discount Account in Details Table to Credit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT @VocRefNo,D.CoaId,1,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121)
			FROM PurchaseReturn A INNER JOIN PurchaseReturnHdAmount B ON
				A.PurRetId = B.PurRetId
			INNER JOIN PurchaseSequenceMaster C ON
				A.PurSeqId = C.PurSeqId
			INNER JOIN PurchaseSequenceDetail D ON
				C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
			WHERE A.PurRetRefNo = @Pi_ReferNo AND
				EffectInNetAmount = 2 AND B.BaseQtyAmount > 0
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT ''' + @VocRefNo + ''',D.CoaId,1,B.BaseQtyAmount,1,' +
			CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
			 FROM PurchaseReturn A INNER JOIN PurchaseReturnHdAmount B ON
				A.PurRetId = B.PurRetId
			INNER JOIN PurchaseSequenceMaster C ON
				A.PurSeqId = C.PurSeqId
			INNER JOIN PurchaseSequenceDetail D ON
				C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
			WHERE A.PurRetRefNo = ''' + @Pi_ReferNo + ''' AND
				EffectInNetAmount = 2 AND B.BaseQtyAmount > 0'
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Purchase Return Addition Account in Details Table on Debit
		SELECT @VocRefNo AS VocRefNo,D.CoaId,2 AS DebitCredit,B.BaseQtyAmount AS Amount,1 AS Availability,
			@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,
			@Pi_UserId AS AuthId,Convert(varchar(10),Getdate(),121) AS AuthDate
		INTO #PurRetTotAdd
		FROM PurchaseReturn A INNER JOIN PurchaseReturnHdAmount B ON
			A.PurRetId = B.PurRetId
		INNER JOIN PurchaseSequenceMaster C ON A.PurSeqId = C.PurSeqId
		INNER JOIN PurchaseSequenceDetail D ON C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
		WHERE A.PurRetRefNo = @Pi_ReferNo AND B.RefCode <> 'D' AND	EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
			
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT * FROM #PurRetTotAdd
		--INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		--	LastModDate,AuthId,AuthDate)
		--SELECT @VocRefNo,D.CoaId,2,B.BaseQtyAmount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		--	@Pi_UserId,Convert(varchar(10),Getdate(),121)
		--	FROM PurchaseReturn A INNER JOIN PurchaseReturnHdAmount B ON
		--		A.PurRetId = B.PurRetId
		--	INNER JOIN PurchaseSequenceMaster C ON
		--		A.PurSeqId = C.PurSeqId
		--	INNER JOIN PurchaseSequenceDetail D ON
		--		C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
		--	WHERE A.PurRetRefNo = @Pi_ReferNo AND B.RefCode <> 'D' AND
		--		EffectInNetAmount = 1 AND B.BaseQtyAmount > 0
		--SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		--	LastModDate,AuthId,AuthDate)
		--SELECT ''' + @VocRefNo + ''',D.CoaId,2,B.BaseQtyAmount,1,' +
		--	CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		--	+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		--	 FROM PurchaseReturn A INNER JOIN PurchaseReturnHdAmount B ON
		--		A.PurRetId = B.PurRetId
		--	INNER JOIN PurchaseSequenceMaster C ON
		--		A.PurSeqId = C.PurSeqId
		--	INNER JOIN PurchaseSequenceDetail D ON
		--		C.PurSeqId = D.PurSeqId AND B.RefCode = D.RefCode
		--	WHERE A.PurRetRefNo = ''' + @Pi_ReferNo + ''' AND B.RefCode <> ''' + 'D' + ''' AND
		--		EffectInNetAmount = 1 AND B.BaseQtyAmount > 0'
		--INSERT INTO Translog(strSql1) Values (@sstr)
		
		--For Posting Purchase Return Tax Account in Details Table on Debit
		SELECT @VocRefNo AS VocRefNo,C.InputTaxId,2 AS DebitCredit,ISNULL(SUM(B.TaxAmount),0) AS Amount,1 AS Availability,
		@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,@Pi_UserId AS AuthId,
		Convert(varchar(10),Getdate(),121) AS AuthDate	INTO #PurRetnTaxForDiff
		FROM PurchaseReturn A INNER JOIN PurchaseReturnProductTax B ON A.PurRetId = B.PurRetId
		INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
		WHERE A.PurRetRefNo = @Pi_ReferNo GROUP BY C.InputTaxId HAVING ISNULL(SUM(B.TaxAmount),0) > 0
		
		
		--Added by Sathishkumar Veeramani 2013/11/26	
		SELECT @DiffAmt=ISNULL((SUM(A.TotalAddition)-(SUM(B.Amount)+SUM(C.Amount))),0)
		FROM PurchaseReturn A,(SELECT SUM(Amount) AS Amount FROM #PurRetnTaxForDiff)B,#PurRetTotAdd C
		WHERE A.PurRetRefNo = @Pi_ReferNo
		
		UPDATE #PurRetnTaxForDiff SET Amount=Amount+@DiffAmt
		WHERE InputTaxId IN (SELECT MIN(InputTaxId) FROM #PurRetnTaxForDiff)
			
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate)
		SELECT * FROM #PurRetnTaxForDiff
		--INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		--	LastModDate,AuthId,AuthDate)
		--SELECT @VocRefNo,C.InPutTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
		--	Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		--	FROM PurchaseReturn A INNER JOIN PurchaseReturnProductTax B ON
		--		A.PurRetId = B.PurRetId
		--	INNER JOIN TaxConfiguration C ON
		--		B.TaxId = C.TaxId
		--	WHERE A.PurRetRefNo = @Pi_ReferNo
		--	Group By C.InPutTaxId
		--	HAVING ISNULL(SUM(B.TaxAmount),0) > 0
			
		--SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		--	LastModDate,AuthId,AuthDate)
		--SELECT ''' + @VocRefNo + ''',C.InPutTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,' +
		--	CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		--	+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		--	FROM PurchaseReturn A INNER JOIN PurchaseReturnProductTax B ON
		--		A.PurRetId = B.PurRetId
		--	INNER JOIN TaxConfiguration C ON
		--		B.TaxId = C.TaxId
		--	WHERE A.PurRetRefNo = ''' + @Pi_ReferNo + '''
		--	Group By C.InPutTaxId
		--	HAVING ISNULL(SUM(B.TaxAmount),0) > 0'
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Scheme Discount in Details Table to Credit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '3210002')
		BEGIN
			SET @Po_PurErrNo = -9
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '3210002'
		SET @Amt = 0
		SELECT @Amt = LessScheme FROM PurchaseReturn WHERE PurRetRefNo = @Pi_ReferNo
			AND LessScheme > 0
		
		IF @Amt > 0
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
				',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''')'
			--INSERT INTO Translog(strSql1) Values (@sstr)
		END
		--For Posting Round Off Account Add in Details Table to Debit
			SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
			IF @sSql='-4'
			BEGIN
				SET @Po_PurErrNo = -4
				Return
			END
			ELSE IF @sSql='-5'
			BEGIN
				SET @Po_PurErrNo = -5
				Return
			END
			ELSE IF @sSql<>'0'
			BEGIN
				EXEC(@sSql)
			END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END	
	IF @Pi_TransId = 13 AND @Pi_SubTransId = 0  -- Stock Out
	BEGIN
		IF EXISTS (SELECT SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo  AND SMT.Coaid=299)	
		BEGIN	
			SELECT @Amt=SUM(Amount)+SUM(TaxAmt) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
		END
		ELSE
		BEGIN
			SELECT @Amt=SUM(Amount) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
		END
				
		
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		
		
		--For Posting StockAdjustment StockAdd Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
			(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Stock Adjustment ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
				
			
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'
		
		IF NOT Exists (Select SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=1
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo )
		BEGIN
			SET @Po_PurErrNo = -26
			Return
		END
		IF NOT Exists (Select SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo )
		BEGIN
			SET @Po_PurErrNo = -27
			Return
		END
		SELECT @DCoaid=SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=1
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
		SELECT @CCoaid=SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2 
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo AND SMT.Coaid<>299
			
		
		--For Posting Default Sales Account details on Debit
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@DCoaid,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@DCoaid as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
			--For Posting Default Debtor Account details on Debit
			SELECT @Amt=SUM(Amount) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
			
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CCoaid,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@CCoaid as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
				',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''')'
			IF EXISTS (SELECT SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				WHERE SMP.StkMngRefNo=@Pi_ReferNo  AND SMT.Coaid=299)	
			BEGIN	
				SET @CCoaid=299
				SELECT @Amt=SUM(TaxAmt) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=1
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
				IF @Amt > 0
				BEGIN
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
					(@VocRefNo,@CCoaid,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))
					SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
					(''' + @VocRefNo + ''',' + CAST(@CCoaid as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
						',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
						+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
						Convert(nvarchar(10),Getdate(),121) + ''')'
				END
			END
		--For Posting Round Off Account Add in Details Table to Debit
			SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
			IF @sSql='-4'
			BEGIN
				SET @Po_PurErrNo = -4
				Return
			END
			ELSE IF @sSql='-5'
			BEGIN
				SET @Po_PurErrNo = -5
				Return
			END
			ELSE IF @sSql<>'0'
			BEGIN
				EXEC(@sSql)
			END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			RETURN
		END
	END
	IF @Pi_TransId = 13 AND @Pi_SubTransId = 1   -- Stock In
	BEGIN
		
		Select @Amt=SUM(Amount) FROM StockManagement SM
		INNER JOIN StockManagementProduct SMP ON SM.StkMngRefNo= SMP.StkMngRefNo
		INNER JOIN StockManagementType SMT ON SMT.StkMgmtTypeId=SMP.StkMgmtTypeId AND SMT.TransactionType=0
		WHERE SM.StkMngRefNo=@Pi_ReferNo
			
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		
		
		--For Posting StockAdjustment StockAdd Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
			(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Stock Adjustment ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
				
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'
		
		IF NOT Exists (Select SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=1
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				WHERE SMP.StkMngRefNo=@Pi_ReferNo )
		BEGIN
			SET @Po_PurErrNo = -26
			Return
		END
		IF NOT Exists (Select SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				WHERE SMP.StkMngRefNo=@Pi_ReferNo )
		BEGIN
			SET @Po_PurErrNo = -27
			Return
		END
				
		SELECT @DCoaid=SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=1
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				WHERE SMP.StkMngRefNo=@Pi_ReferNo  AND SMT.CoaId<>298
		SELECT @CCoaid=SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId AND DebitCredit=2
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				WHERE SMP.StkMngRefNo=@Pi_ReferNo 
			
		
		--For Posting Default Purchase Account details on Debit
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@DCoaid,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
				(''' + @VocRefNo + ''',' + CAST(@DCoaid as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
				',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''')'
		IF EXISTS (SELECT SMT.Coaid From CoaMaster CM INNER JOIN StockManagementTypeDt SMT ON SMT.Coaid =CM.Coaid
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId 
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				WHERE SMP.StkMngRefNo=@Pi_ReferNo AND DebitCredit=1 AND SMT.Coaid=298)	
		BEGIN
--			Select @Amt=SUM(TaxAmt) FROM StockManagement SM
--			INNER JOIN StockManagementProduct SMP ON SM.StkMngRefNo= SMP.StkMngRefNo
--			WHERE SM.StkMngRefNo=@Pi_ReferNo
			SELECT @Amt=SUM(TaxAmt) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId 
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo AND DebitCredit=1
			SET @DCoaid=298
			IF @Amt >0 
			BEGIN
				INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
					LastModDate,AuthId,AuthDate) VALUES
					(@VocRefNo,@DCoaid,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))
				SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(''' + @VocRefNo + ''',' + CAST(@DCoaid as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
						',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
						+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
						Convert(nvarchar(10),Getdate(),121) + ''')'
			END
		END
--		Select @Amt=SUM(Amount)+SUM(TaxAmt) FROM StockManagement SM
--			INNER JOIN StockManagementProduct SMP ON SM.StkMngRefNo= SMP.StkMngRefNo
--			WHERE SM.StkMngRefNo=@Pi_ReferNo
			SELECT @Amt=SUM(Amount)+SUM(TaxAmt) FROM StockManagementTypeDt SMT 
				INNER JOIN StockManagementProduct SMP ON SMP.StkMgmtTypeId=SMT.StkMgmtTypeId 
				INNER JOIN StockManagementType SM ON SMP.StkMgmtTypeId=SM.StkMgmtTypeId AND SM.TransactionType=0
				INNER JOIN StockManagement Hd ON HD.StkMngRefNo=SMP.StkMngRefNo
				WHERE SMP.StkMngRefNo=@Pi_ReferNo AND DebitCredit=1
			
		--For Posting Default Purchase Account details on Credit
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CCoaid,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CCoaid as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
		--For Posting Round Off Account Add in Details Table to Debit
			SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
			IF @sSql='-4'
			BEGIN
				SET @Po_PurErrNo = -4
				Return
			END
			ELSE IF @sSql='-5'
			BEGIN
				SET @Po_PurErrNo = -5
				Return
			END
			ELSE IF @sSql<>'0'
			BEGIN
				EXEC(@sSql)
			END
		
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			RETURN
		END
	END
	IF @Po_PurErrNo=1
	BEGIN
			EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
	END
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='RptSRNSALESRETURN' and Xtype='U')
DROP TABLE RptSRNSALESRETURN
GO
CREATE TABLE RptSRNSALESRETURN(
	[Credit Note Reference No] [nvarchar](50) NULL,
	[Distributor Code] [nvarchar](20) NULL,
	[Distributor Name] [nvarchar](50) NULL,
	[Distributor Address1] [nvarchar](50) NULL,
	[Distributor Address2] [nvarchar](50) NULL,
	[Distributor Address3] [nvarchar](50) NULL,
	[PinCode] [int] NULL,
	[PhoneNo] [nvarchar](50) NULL,
	[Tax Type] [tinyint] NULL,
	[TIN Number] [nvarchar](50) NULL,
	[Deposit Amount] [numeric](38, 2) NULL,
	[CST Number] [nvarchar](50) NULL,
	[LST Number] [nvarchar](50) NULL,
	[Licence Number] [nvarchar](50) NULL,
	[Drug Licence Number 1] [nvarchar](50) NULL,
	[Drug1 Expiry Date] [datetime] NULL,
	[Drug Licence Number 2] [nvarchar](50) NULL,
	[Drug2 Expiry Date] [datetime] NULL,
	[Pesticide Licence Number] [nvarchar](50) NULL,
	[Pesticide Expiry Date] [datetime] NULL,
	[SalId] [int] NULL,
	[Invoice Number] [nvarchar](50) NULL,
	[Invoice Date] [datetime] NULL,
	[ReturnId] [int] NULL,
	[Sales Return Number] [nvarchar](50) NULL,
	[Sales Return Date] [datetime] NULL,
	[Sales Man] [nvarchar](50) NULL,
	[Route] [nvarchar](50) NULL,
	[Retailer Code] [nvarchar](50) NULL,
	[Retailer Name] [nvarchar](150) NULL,
	[Retailer Phone Number] [nvarchar](50) NULL,
	[Retailer CST Number] [nvarchar](50) NULL,
	[Retailer Drug Lic  Number] [nvarchar](50) NULL,
	[Retailer Lic Number] [nvarchar](50) NULL,
	[Retailer Tin Number] [nvarchar](50) NULL,
	[Retailer Address] [nvarchar](50) NULL,
	[Product Company Code] [nvarchar](20) NULL,
	[Product Company Name] [nvarchar](150) NULL,
	[Product Short Code] [nvarchar](100) NULL,
	[Product Short Name] [nvarchar](150) NULL,
	[Product Name] [nvarchar](150) NULL,
	[Stock Type] [nvarchar](100) NULL,
	[Return Quantity] [numeric](18, 0) NULL,
	[Selling Rate] [numeric](18, 6) NULL,
	[Gross Amount] [numeric](18, 6) NULL,
	[Special Discount] [numeric](18, 6) NULL,
	[Scheme Discount] [numeric](18, 6) NULL,
	[Distributor Discount] [numeric](18, 6) NULL,
	[Cash Discount] [numeric](18, 6) NULL,
	[Tax Percentage] [numeric](18, 6) NULL,
	[Tax Amount Line Level] [numeric](18, 6) NULL,
	[Line level Net Amount] [numeric](18, 6) NULL,
	[Reason] [nvarchar](100) NULL,
	[Type] [nvarchar](50) NULL,
	[Mode] [nvarchar](50) NULL,
	[Total Gross Amount] [numeric](18, 6) NULL,
	[Total Special Discount] [numeric](18, 6) NULL,
	[Total Scheme Discount] [numeric](18, 6) NULL,
	[Total Distributor Discount] [numeric](18, 6) NULL,
	[Total Cash Discount] [numeric](18, 6) NULL,
	[Total Tax Amount] [numeric](18, 6) NULL,
	[Total Net Amount] [numeric](18, 6) NULL,
	[Total Discount] [numeric](18, 6) NULL,
	[RtrId] [int] NULL,
	[RMID] [int] NULL,
	[SMID] [int] NULL,
	[MRP] [numeric](18, 6) NULL,
	[Credit Note/Replacement Reference No] [nvarchar](50) NULL,
	[UsrId] [int] NULL,
	[Visibility] [tinyint] NULL,
	[CGST Perc] [numeric](5, 2) NULL,
	[SGST Perc] [numeric](5, 2) NULL,
	[IGST Perc] [numeric](5, 2) NULL,
	[UTGST Perc] [numeric](5, 2) NULL,
	[CESS Perc] [numeric](5, 2) NULL,
	[Product Slno] [int] NULL,
	[RtrGSTTinNo] [nvarchar](50) NULL,
	[CGST TaxAmt] [numeric](18, 6) NULL,
	[SGST TaxAmt] [numeric](18, 6) NULL,
	[IGST TaxAmt] [numeric](18, 6) NULL,
	[UTGST TaxAmt] [numeric](18, 6) NULL,
	[CESS TaxAmt] [numeric](18, 6) NULL,
	TCSLineleveltax	 Numeric(18,6),--CRCRSTNIV0082
	TCSHeadleveltax  Numeric(18,6)--CRCRSTNIV0082
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Proc_RptSRNSALESRETURN' and Xtype='P')
DROP PROCEDURE Proc_RptSRNSALESRETURN
GO
--Exec Proc_RptSRNSALESRETURN 1,1
CREATE PROCEDURE Proc_RptSRNSALESRETURN 
(
	@Pi_UsrId Int = 1,
	@Pi_Type INT 
) 
As SET NOCOUNT ON 
/****************************************************************************************************************
* DATE			NAME				USERSTORYID			CR/BZ				DESCRIPTION
*****************************************************************************************************************
* 23-05-2019    MOHANA S			CRCRSTPAR0052		CR					SUB REPORT FOR SALES RETURN TAX SPLIT UP
* 02-07-2019    Lakshman M			ILCRSTPAR4957       SR                  product line level tax percenatge split validation included.
* 16.03.2020    MarySubashini.S		ILCRSTPAR8294       CR					TCS Tax Column added   
*****************************************************************************************************************/
Begin  
 DECLARE @FromReturnId AS  VARCHAR(25)  
 DECLARE @ToReturnId   AS  VARCHAR(25) 
 DECLARE @Cnt AS INT 
 DECLARE @TempReturnId TABLE (ReturnId INT) 
 CREATE Table #RptSRNTemplate  
( 
	[Credit Note Reference No] nvarchar(50),
	[Distributor Code] nvarchar(20),
	[Distributor Name] nvarchar(50),
	[Distributor Address1] nvarchar(50),
	[Distributor Address2] nvarchar(50),
	[Distributor Address3] nvarchar(50),
	[PinCode] int,
	[PhoneNo] nvarchar(50),
	[Tax Type] tinyint,
	[TIN Number] nvarchar(50),
	[Deposit Amount] numeric(38,2),
	[CST Number] nvarchar(50),
	[LST Number] nvarchar(50),
	[Licence Number] nvarchar(50),
	[Drug Licence Number 1] nvarchar(50),
	[Drug1 Expiry Date] DateTime,
	[Drug Licence Number 2] nvarchar(50),
	[Drug2 Expiry Date] DateTime,
	[Pesticide Licence Number] nvarchar(50),
	[Pesticide Expiry Date] DateTime,
	[SalId] INT,
	[Invoice Number] nvarchar(50),
	[Invoice Date] DATETIME,
	[ReturnId] INT,
	[Sales Return Number] nvarchar(50),
	[Sales Return Date] DATETIME,
	[Sales Man] nvarchar(50),
	[Route] nvarchar(50),
	[Retailer Code] nvarchar(50),
	[Retailer Name] nvarchar(150),
	[Retailer Phone Number] nvarchar(50),
	[Retailer CST Number] nvarchar(50),
	[Retailer Drug Lic  Number] nvarchar(50),
	[Retailer Lic Number] nvarchar(50),
	[Retailer Tin Number] nvarchar(50),
	[Retailer Address] nvarchar(50),
	[Product Company Code] nvarchar(20),
	[Product Company Name] nvarchar(150),
	[Product Short Code] nvarchar(100),
	[Product Short Name] nvarchar(150),
	[Product Name] nvarchar(150),
	[Product Slno] INT,
	[Stock Type] nvarchar(100),
	[Return Quantity] NUMERIC(18,0),
	[Selling Rate] NUMERIC(18,6),
	[Gross Amount] NUMERIC(18,6),
	[Special Discount] NUMERIC(18,6),
	[Scheme Discount] NUMERIC(18,6),
	[Distributor Discount] NUMERIC(18,6),
	[Cash Discount] NUMERIC(18,6),
	[TaxName] NVARCHAR(50),
	[Tax Percentage] NUMERIC(18,6),
	[Tax Amount Line Level] NUMERIC(18,6),
	[Line level Net Amount] NUMERIC(18,6),
	[Reason] nvarchar(100),
	[Type] nvarchar(50),
	[Mode] nvarchar(50),
	[Total Gross Amount] NUMERIC(18,6),
	[Total Special Discount] NUMERIC(18,6),
	[Total Scheme Discount] NUMERIC(18,6),
	[Total Distributor Discount] NUMERIC(18,6),
	[Total Cash Discount] NUMERIC(18,6),
	[Total Tax Amount] NUMERIC(18,6),
	[Total Net Amount] NUMERIC(18,6),
	[Total Discount] NUMERIC(18,6),
	[RtrId] INT,
	[RMID] INT,
	[SMID] INT,
	[MRP] NUMERIC(18,6),
	[Credit Note/Replacement Reference No] nvarchar(50),
	UsrId int,Visibility tinyint ,
	TCSLineleveltax	 Numeric(18,6),--CRCRSTNIV0082
	TCSHeadleveltax  Numeric(18,6)--CRCRSTNIV0082
) 
	IF @Pi_Type=1 
	BEGIN   
		INSERT INTO @TempReturnId SELECT SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 32  AND UsrId=@Pi_UsrId
	END
	ELSE   
	BEGIN 
		SELECT @FromReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 14 AND UsrId=@Pi_UsrId
		SELECT @ToReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 15  AND UsrId=@Pi_UsrId
	END
	IF @Pi_Type=1 
	BEGIN 
		Insert into #RptSRNTemplate  
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,
		DistributorAdd2,	DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,
		CSTNo,	LSTNo,	LicNo,	DrugLicNo1,	Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,
		PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,	SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,
		ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,	RtrCstNo,	RtrDrugLicNo,	RtrLicNo,
		RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,	Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,
		UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,	PrdSchDisAmt,	PrdDBDisAmt,
		PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,	ReturnMode,	RtnGrossAmt,
		RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,	Retailer.RtrId,
		RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility  ,
		SUM(Returnproduct.PrdTCSTaxAmount) as TCSLineleveltax,--CRCRSTNIV0082
		SUM(ReturnHeader.SalTCSTaxAmount) as TCSHeadleveltax--CRCRSTNIV0082
		FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId 
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode 
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode AND CreditNoteRetailer.TransId = 30 
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId IN (SELECT ReturnId FROM @TempReturnId)  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,
		DISTRIBUTORADD1,	DISTRIBUTORADD2,	DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,
		CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,	DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,
		SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,	RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,
		RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,	RTRADD1,	CMPCODE,
		CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,	PRDEDITSELRTE,
		PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,	INVOICETYPE,
		RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,	RTNNETAMT,
		RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno 
	END  
	ELSE 
	BEGIN 
		Insert into #RptSRNTemplate  
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,	DistributorAdd2,
		DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,	CSTNo,	LSTNo,	LicNo,	DrugLicNo1,
		Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,	PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,
		SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,	ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,
		RtrCstNo,	RtrDrugLicNo,	RtrLicNo,	RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,
		Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,	UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,
		PrdSchDisAmt,	PrdDBDisAmt,	PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,
		ReturnMode,	RtnGrossAmt,	RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,
		Retailer.RtrId,	RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility,
		SUM(Returnproduct.PrdTCSTaxAmount) as TCSLineleveltax,--CRCRSTNIV0082
		SUM(ReturnHeader.SalTCSTaxAmount) as TCSHeadleveltax--CRCRSTNIV0082
		FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode  AND CreditNoteRetailer.TransId=30
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId BETWEEN  @FromReturnId  AND  @ToReturnId  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,	DISTRIBUTORADD1,	DISTRIBUTORADD2,
		DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,	CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,
		DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,	SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,
		RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,	RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,
		RTRADD1,	CMPCODE,	CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,
		PRDEDITSELRTE,	PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,
		INVOICETYPE,	RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,
		RTNNETAMT,	RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno
	
	END
	--INSERT INTO RptSRNSALESRETURN 
	SELECT * INTO #SRNSALESRETURNTEMP FROM #RptSRNTemplate 
	DELETE FROM RptSRNSALESRETURN
	----- added by lakshman ILCRSTPAR4957
	SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue 
	INTO #RetailerGSTIN
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='GSTIN'
	
	INSERT INTO RptSRNSALESRETURN ([Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility],TCSLineleveltax,TCSHeadleveltax)--CRCRSTNIV0082
	SELECT DISTINCT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility],TCSLineleveltax,TCSHeadleveltax--CRCRSTNIV0082 
	FROM #SRNSALESRETURNTEMP
	
	UPDATE A SET [CGST Perc] = B.[TAX PERCENTAGE],[CGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CGST'
	UPDATE A SET [SGST Perc] = B.[TAX PERCENTAGE],[SGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'SGST'
	UPDATE A SET [IGST Perc] = B.[TAX PERCENTAGE],[IGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'IGST'
	UPDATE A SET [UTGST Perc] = B.[TAX PERCENTAGE],[UTGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'UTGST'
	UPDATE A SET [CESS Perc] = B.[TAX PERCENTAGE],[CESS TaxAmt] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CESS'
	--INSERT INTO RptSRNSALESRETURN 
	--([Credit Note Reference No],[Distributor Code],[Distributor Name], [Distributor Address1], [Distributor Address2], [Distributor Address3], 
	--[PinCode], [PhoneNo],[Tax Type], [TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1], [Drug1 Expiry Date],
	--[Drug Licence Number 2], [Drug2 Expiry Date], [Pesticide Licence Number], [Pesticide Expiry Date], [SalId],[Invoice Number], [Invoice Date], [ReturnId], 
	--[Sales Return Number], [Sales Return Date], [Sales Man], [Route], [Retailer Code], [Retailer Name], [Retailer Phone Number], [Retailer CST Number], 
	--[Retailer Drug Lic  Number],[Retailer Lic Number], [Retailer Tin Number], [Retailer Address], [Product Company Code], [Product Company Name], [Product Short Code], 
	--[Product Short Name], [Product Name],[Product Slno], [Stock Type], [Return Quantity],[Selling Rate], [Gross Amount], [Special Discount], [Scheme Discount], 
	--[Distributor Discount], [Cash Discount],[Line level Net Amount], [Reason], [Type], [Mode], [Total Gross Amount], [Total Special Discount], [Total Scheme Discount], 
	--[Total Distributor Discount], [Total Cash Discount], [Tax Amount Line Level],[Total Tax Amount], [Total Net Amount], [Total Discount], [RtrId],
	--[RMID], [SMID], [MRP], [Credit Note/Replacement Reference No], [UsrId], [Visibility], [CGST Perc], [SGST Perc], [IGST Perc],[UTGST Perc],[CESS Perc])
	
	--SELECT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount] ,ISNULL(Sum([Tax Amount Line Level]),0) AS [Tax Amount Line Level],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0) 
	--from #SRNSALESRETURNTEMP
	--	PIVOT
	--		(
	--			SUM([Tax Percentage])
	--			FOR [TaxName] IN ([CGST],[SGST],[IGST],[UTGST],[CESS])
	--		) AS P
	--GROUP BY [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0)
	--order by Salid,[Product Slno],[Product Short Code] Asc
	
	UPDATE A SET RtrGSTTinNo = B.ColumnValue FROM RptSRNSALESRETURN A inner join #RetailerGSTIN B ON A.Rtrid =B.Rtrid 
	
	------------------ Till here -----------------
	--Added by Mohana  CRCRSTPAR0052
	DELETE FROM RptSRNTaxFinalTemplate WHERE UsrId = @Pi_UsrId 
	INSERT INTO RptSRNTaxFinalTemplate(ReturnId,ReturnCode,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
	SELECT Returnid,REturnCode,0 Prdslno,TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmt) TaxableAmt,SUM(TaxAmt) TaxAmt,@Pi_UsrId      
	FROM 
	(
	SELECT DISTINCT SI.Returnid,S.REturnCode,Prdslno,SI.TaxId,TaxCode,TaxName,TaxPerc,TaxableAmt,TaxAmt     
	FROM ReturnproductTax SI , TaxConfiguration T,REturnHeader S,RptSRNSALESRETURN B      
	WHERE SI.TaxId = T.TaxId and SI.ReturnId = S.ReturnId and S.returncode = B.[Sales Return Number]  and B.UsrId = @Pi_UsrId      
	)A GROUP BY Returnid,REturnCode,TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmt) > 0  
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnTotalTCSHdAmount' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ReturnTotalTCSHdAmount
GO
--SELECT DISTINCT * FROM Dbo.Fn_ReturnTotalTCSHdAmount(36)
CREATE FUNCTION [dbo].[Fn_ReturnTotalTCSHdAmount] (@TransId AS INT,@UsrId AS INT)
RETURNS NUMERIC(18,6)
AS
BEGIN
/**********************************************************
* FUNCTION    : Fn_ReturnPurchaseClaimScheme
* PURPOSE     : Returns Total TCS Hd Amount
* NOTES: 
* CREATED     : Sathishkumar Veeramani 2014/06/20
* MODIFIED 
* DATE        AUTHOR             CR/BZ          USERSTORYID            DESCRIPTION
**********************************************************************************************    
* 17-03-2020   MarySubashini.S    CR		   CRCRSTNIV0082			IRNNumber,TCSTaxAmt column added
***************************************************************************************************/
    DECLARE @TCSHDAmt AS NUMERIC(18,6)
    SET @TCSHDAmt=0
    IF EXISTS (SELECT 'X' FROM TCS_BilledPrdDtCalculatedTax(NOLOCK) WHERE Usrid=@UsrId AND TransId=@TransId)
    BEGIN
		SELECT @TCSHDAmt=ISNULL(SUM(TaxAmount),0) FROM TCS_BilledPrdDtCalculatedTax(NOLOCK) 
		WHERE Usrid=@UsrId AND TransId=@TransId 
    END
RETURN(@TCSHDAmt)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='ETL_Prk_CN2CS_RtrPanaadhar' and Xtype='U')
DROP TABLE ETL_Prk_CN2CS_RtrPanaadhar
GO
CREATE TABLE ETL_Prk_CN2CS_RtrPanaadhar
(
       [MasterName] [nvarchar](100) NULL,
       [ColumnName] [nvarchar](100) NULL,
       [Column Code] [nvarchar](100) NULL,
       [ColumnValue] [nvarchar](100) NULL,
       [UpdateFlag] [int] NULL
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_Validate_RetailerPANAAdharAvailable' AND xtype='P')
DROP PROCEDURE Proc_Validate_RetailerPANAAdharAvailable
GO
-- EXEC Proc_ValidateUdcDetails ''
CREATE PROCEDURE Proc_Validate_RetailerPANAAdharAvailable
(
    @RtrCode VARCHAR(100),
	@Po_ErrNo INT OUTPUT 
)
AS       
/*********************************    
* PROCEDURE: Proc_Validate_CN2CS_UdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: S.Moorthi
*********************************/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	SET @TabName = 'ETL_Prk_CN2CS_RtrPanaadhar'  
	SET @Po_ErrNo =0

	DELETE FROM ETL_Prk_CN2CS_RtrPanaadhar WHERE MasterName='RETAILER MASTER' and ColumnName='PAN/Aadhaar Available' and [Column Code]=@RtrCode

	INSERT INTO ETL_Prk_CN2CS_RtrPanaadhar (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)	
	SELECT 'Retailer Master','PAN/Aadhaar Available',@RtrCode,'NO',0



	IF EXISTS (SELECT * FROM UDCDetails A (Nolock) INNER JOIN UDCMaster B (Nolock) ON A.MasterId=B.MasterId
	AND A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C (Nolock) ON A.MasterId=C.MasterId
	INNER JOIN Retailer D (Nolock) ON D.Rtrid=A.MasterRecordId and D.RtrCode=@RtrCode
	WHERE C.MasterName='Retailer Master'  AND B.ColumnName='PAN Number' and Isnull(ColumnValue,'null') NOT in('null',''))
	BEGIN
	   UPDATE ETL_Prk_CN2CS_RtrPanaadhar SET ColumnValue='YES' where [Column Code]=@RtrCode
	END

	IF EXISTS (SELECT * FROM UDCDetails A (Nolock) INNER JOIN UDCMaster B (Nolock) ON A.MasterId=B.MasterId
		AND A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C (Nolock) ON A.MasterId=C.MasterId
		INNER JOIN Retailer D (Nolock) ON D.Rtrid=A.MasterRecordId and D.RtrCode=@RtrCode
		WHERE C.MasterName='Retailer Master'  AND B.ColumnName='Aadhaar' and Isnull(ColumnValue,'null') NOT in('null',''))		  BEGIN
		  
		  UPDATE ETL_Prk_CN2CS_RtrPanaadhar SET ColumnValue='YES' where [Column Code]=@RtrCode

		END
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL(MasterName,'') MasterName,ISNULL([ColumnName],'') ColumnName,ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM ETL_Prk_CN2CS_RtrPanaadhar (NOLOCK) WHERE UpdateFlag=0
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 
		IF @Po_ErrNo = 0 
		BEGIN
		
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
		
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)),UPLOAD=0 WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121),0)
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				UPDATE ETL_Prk_CN2CS_RtrPanaadhar SET UpdateFlag=1 WHERE MasterName=@MasterName and ColumnName=@ColName and [Column Code]=@ColCode
				
			END
		END
	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_ETLValidate_UdcDetailsGST' and Xtype='P')
DROP PROCEDURE Proc_ETLValidate_UdcDetailsGST
GO
-- EXEC Proc_ETLValidate_UdcDetailsGST ''
-- EXEC Proc_ETLValidate_UdcDetailsGST ''
CREATE PROCEDURE Proc_ETLValidate_UdcDetailsGST
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*********************************    
* PROCEDURE: Proc_ETLValidate_UdcDetailsGST    
* PURPOSE: To Insert and Update records      
* CREATED: Mohanakrishna A.B
*********************************/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	DECLARE @ColCode99 AS VARCHAR(100)   ---MARCS202100060
	SET @TabName = 'ETL_Prk_RetailerGST'  
	SET @Po_ErrNo =0

	 ---MARCS202100060
	DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='RETAILER MASTER' and ColumnName='PAN/Aadhaar Available'

  CREATE TABLE #ETL_Prk_CN2CS_UdcDetails999
	(
	ColCode Varchar(100)
	)

	INSERT INTO #ETL_Prk_CN2CS_UdcDetails999
	SELECT Distinct ISNULL([Column Code],'') from ETL_Prk_UDCRetailerGST(Nolock) WHERE MasterName='RETAILER MASTER'
	and ISNULL([Column Code],'')<>'' and UpdateFlag=0
	----Till here  ---MARCS202100060
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL(MasterName,'') MasterName,ISNULL([ColumnName],'') ColumnName,ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM ETL_Prk_UDCRetailerGST (NOLOCK) WHERE UpdateFlag=0
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 
		IF @Po_ErrNo = 0 
		BEGIN
			
			IF @MasterName='PRODUCT MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('PRODUCT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCT','PrdCCode','PrdId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SUPPLIER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SUPPLIER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SUPPLIER','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DISTRIBUTOR INFO MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				UPDATE ETL_Prk_UDCRetailerGST SET UpdateFlag=1 WHERE MasterName=@MasterName and ColumnName=@ColName and [Column Code]=@ColCode
				
			END
		END
	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
	 ---MARCS202100060
	DECLARE Cur_UdcDt1 CURSOR   
	FOR SELECT DISTINCT Colcode from #ETL_Prk_CN2CS_UdcDetails999
	OPEN Cur_UdcDt1  
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	WHILE @@FETCH_STATUS=0  
	BEGIN  
	EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0

	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	END  
	CLOSE Cur_UdcDt1  
	DEALLOCATE Cur_UdcDt1
	----Till here
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Validate_CN2CS_UdcDetails' and Xtype='P')
DROP PROCEDURE Proc_Validate_CN2CS_UdcDetails
GO
-- EXEC Proc_ValidateUdcDetails ''
CREATE PROCEDURE Proc_Validate_CN2CS_UdcDetails 
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*************************************** ********************************* ********************************* ***************************    
* PROCEDURE: Proc_Validate_CN2CS_UdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: S.Moorthi
***************************************************************************************************************************************
' Version      Date           Person          User Story ID    CR/BZ            Remarks             Code Review By   Review Date
' 442          11/11/2019	 S.Moorthi        CRCRSTDBC0125		CR				IDT New Process Add
*********************************************************** ********************************* ********************************* *******/       
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColName1 AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	DECLARE @ColCode99 AS VARCHAR(100)  ---MARCS202100060
	SET @TabName = 'ETL_Prk_CN2CS_UdcDetails'  
	SET @Po_ErrNo =0

	 ---MARCS202100060
	DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='RETAILER MASTER' and ColumnName='PAN/Aadhaar Available'

	CREATE TABLE #ETL_Prk_CN2CS_UdcDetails999
	(
	ColCode Varchar(100)
	)

	INSERT INTO #ETL_Prk_CN2CS_UdcDetails999
	SELECT Distinct ISNULL([Column Code],'') from ETL_Prk_CN2CS_UdcDetails(Nolock) WHERE MasterName='RETAILER MASTER'
	and ISNULL([Column Code],'')<>'' and UpdateFlag=0
	---Till here  ---MARCS202100060
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL(MasterName,'') MasterName,ISNULL([ColumnName],'') ColumnName,ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM ETL_Prk_CN2CS_UdcDetails (NOLOCK) WHERE UpdateFlag=0
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
		SET @Po_ErrNo = 0 
		IF @Po_ErrNo = 0 
		BEGIN
			
			IF @MasterName='PRODUCT MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('PRODUCT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCT','PrdCCode','PrdId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SUPPLIER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SUPPLIER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SUPPLIER','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'IDT MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('IDT MASTER')
				--select @UdcHdId,@ColCode,@ColName
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('IDTMaster','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DISTRIBUTOR INFO MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			IF @RecId <> 0 			
			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END					
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
				END
				
				UPDATE ETL_Prk_CN2CS_UdcDetails SET UpdateFlag=1 WHERE MasterName=@MasterName and ColumnName=@ColName and [Column Code]=@ColCode
				
			END
		END
	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt
	 ---MARCS202100060
	DECLARE Cur_UdcDt1 CURSOR   
	FOR SELECT DISTINCT Colcode from #ETL_Prk_CN2CS_UdcDetails999
	OPEN Cur_UdcDt1  
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	WHILE @@FETCH_STATUS=0  
	BEGIN  
	EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0

	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	END  
	CLOSE Cur_UdcDt1  
	DEALLOCATE Cur_UdcDt1
	 ---Till here MARCS202100060
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Fn_ExportRetailerGST' and Xtype IN ('TF','FN'))
DROP FUNCTION Fn_ExportRetailerGST
GO
--Select dbo.Fn_ExportRetailerGST()
CREATE    FUNCTION Fn_ExportRetailerGST ()
RETURNS NVARCHAR(MAX)
AS
/*********************************
* FUNCTION: Fn_ExportRetailer
* PURPOSE: Return Retailer Master Details For GST
* NOTES:
* CREATED: Mohanakrishna A.B
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 29-08-2020   Gopikrishnan.R    CR     MARCS202100060      TCSApplicable and AAdhar column will export
*********************************/
BEGIN
DECLARE @StateCode AS VARCHAR(100)
SET @StateCode=''
	SELECT @StateCode=ISNULL(S.StateCode,'') FROM UdcMaster U (NOLOCK) 
	INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
	INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
	INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
	WHERE U.MasterId=16 and ColumnName='State Name' 
DECLARE @sSql NVARCHAR(MAX)
SET @sSql  = 'SELECT DISTINCT A.RtrCode AS [Retailer Code],A.RtrName AS [Retailer Name],ISNULL(C.StateCode,'''+@StateCode+''') AS StateCode,
            isnull(D.GSTIN,'''')  AS GSTTIN,isnull(E.PANNumber,'''')  AS PanNumber,isnull(F.RetailerType,'''')  AS RetailerType,
			isnull(G.Composition,'''') AS Composite,isnull(H.RelatedParty,'''') AS RelatedParty ,ISNULL(TG.RtrGroup,'''') AS  [Tax Group],
			isnull(I.TCSApplicable,'''') AS TCSApplicable,isnull(j.Aadhaar,'''')  as Aadhaar
			 INTO #TEMP 
			From Retailer A WITH (NOLOCK)  INNER JOIN RetailerShipAdd B WITH (NOLOCK) ON A.Rtrid=B.RtrId 
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as GSTIN FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''GSTIN'') D
			ON D.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as PANNumber FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'') E
			ON E.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as RetailerType FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Retailer Type'') F
			ON F.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as Composition FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Composition'') G
			ON G.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as RelatedParty FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Related Party'') H
			ON H.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as TCSApplicable FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''TCS Applicable'') I
			ON I.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as Aadhaar FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Aadhaar'') J
			ON J.RtrId=A.RtrId
			LEFT OUTER JOIN TaxGroupSetting TG WITH (NOLOCK) ON TG.TaxGroupId=A.TaxGroupId
			LEFT OUTER JOIN StateMaster C ON C.StateId=B.StateId  Order by A.RtrCode
		  SELECT * FROM #TEMP'
RETURN (@sSql)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='ETL_Prk_RetailerGST' and Xtype='U')
DROP TABLE ETL_Prk_RetailerGST
GO
CREATE TABLE ETL_Prk_RetailerGST
(
	[Retailer Code] [nvarchar](100) NULL,
	[Retailer Name] [nvarchar](100) NULL,
	[StateCode] [nvarchar](100) NULL,
	[GSTTIN] [nvarchar](100) NULL,
	[PanNumber] [nvarchar](100) NULL,
	[Composite] [nvarchar](100) NULL,
	[RetailerType] [nvarchar](100) NULL,
	[RelatedParty] [nvarchar](100) NULL,
	[Tax Group] [nvarchar](100) NULL,
	[TCSApplicable][nvarchar](100),
	[Aadhaar][nvarchar](100)
)
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_ValidateRetailerMasterGST' and Xtype='P')
DROP PROCEDURE Proc_ValidateRetailerMasterGST
GO
/*
 BEGIN TRAN
 Delete  FROM ERRORLOG
 update retailer set taxgroupid=0 where RtrCode='CDP1134'
 EXEC Proc_ValidateRetailerMasterGST 0
 SELECT * FROM ETL_Prk_UDCRetailerGST
 Select * from ETL_Prk_RetailerGST
 SELECT  * FROM ERRORLOG
 EXEC Proc_ETLValidate_UdcDetailsGST 0
 SELECT * FROM UdcDetails where masterid=2 AND MasterRecordId=1129
 Select * from Retailer where RtrCode='CDP1134'
 ROLLBACK TRAN
 */
CREATE PROCEDURE Proc_ValidateRetailerMasterGST
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateRetailerMasterGST
* PURPOSE		: To validate the downloaded Retailer GST details from Console
* CREATED		: Mohanakrishna A.B
* CREATED DATE	: 23/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @StateCode VARCHAR(100)
	DECLARE @RtrTaxGroup VARCHAR(100)
	DECLARE @Composite VARCHAR(10)
	DECLARE @RelatedParty AS VARCHAR(10)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @GSTTIN AS VARCHAR(25)
	DECLARE @TaxGrpId AS INT
	DECLARE @StateName as VARCHAR(200)
	DECLARE @RetailerType as VARCHAR(100)
	DECLARE @RtrId AS INT
	DECLARE @TCSAPP AS VARCHAR(100)  ---MARCS202100060
	DECLARE @Aadhaar AS VARCHAR(100)
	DECLARE @ColCode99 as varchar(100)
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #ETL_Prk_RetailerGST
	(
		RtrCode			[Varchar](50),
		RtrName			[Varchar](75),
		StateCode		[Varchar](50),
		GSTTIN			[Varchar](25),
		PanNumber		[Varchar](15),
		Composite		[Varchar](5),
		RetailerType	[Varchar](25),
		RelatedParty	[Varchar](5),
		RtrTaxGroup		[Varchar](50),
		TCSApplicable[nvarchar](100),
		Aadhaar[nvarchar](100)
	)
	
	DECLARE @GSTEnabled AS TINYINT
	SET @GSTEnabled=0
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)
	BEGIN
		SET @GSTEnabled=1
	END
	DELETE FROM ErrorLog WHERE TableName='Retailer GST'
	
	INSERT INTO #ETL_Prk_RetailerGST
	SELECT ISNULL([Retailer Code],''),ISNULL([Retailer Name],''),ISNULL([StateCode],''),ISNULL([GSTTIN],''),ISNULL([PanNumber],''),
	ISNULL([Composite],''),ISNULL([RetailerType],''),ISNULL(RelatedParty	,''),ISNULL([Tax Group]	,''),
	isnull([TCSApplicable],''),ISNULL([Aadhaar],'')
	from ETL_Prk_RetailerGST
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer GST','Retailer Code','Retailer GST Details Should not be empty' 
	FROM #ETL_Prk_RetailerGST
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='')
	--OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	DELETE A FROM #ETL_Prk_RetailerGST A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='') 
	--OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #ETL_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  2,'RetailerGST','Retailer','Retailer GST Details Not allow more than 1-'+RtrCode FROM #ETL_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) ---and DownLoadFlag='D'
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'RetailerGST','RetailerCode','Retailer Code not Available-'+RtrCode FROM #ETL_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) ---and DownLoadFlag='D'
	IF EXISTS(SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST A 
	WHERE  NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	BEGIN
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST A 
		WHERE NOT  EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 4,'RetailerGST','State Code','Retailer GST State Code Not available-'+RtrCode FROM #ETL_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	END
	
	
	IF EXISTS(SELECT '*' FROM #ETL_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
				)
	BEGIN
	
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
		INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
		WHERE NOT EXISTS(
			SELECT UD.* FROM UdcHD A (NOLOCK)
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
			INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
			WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
			AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 5,'Retailer GST','StateName','Retailer State Code Not available '+RtrCode FROM #ETL_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	END
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','RetailerType','RetailerType Should be REGISTERED / UN REGISTERED / NOT ASSIGNED'+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composite Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composite Not allow YES/NO, when Retailer Type is  Non Regesitered'+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 7,'Retailer GST','Related Party','Related Party Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')


	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 9,'Retailer GST','TCSApplicable','TCSApplicable Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')---MARCS202100060
		
	DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1
	
	
	
	DECLARE Cur_RetailerGST CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([RtrCode])),''),ISNULL(LTRIM(RTRIM([StateCode])),''),
	ISNULL(LTRIM(RTRIM([Composite])),'NA'),ISNULL(LTRIM(RTRIM([RelatedParty])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([GSTTIN])),''),ISNULL(LTRIM(RTRIM([RetailerType])),''),ISNULL(LTRIM(RTRIM(RtrTaxGroup)),''),
	ISNULL(LTRIM(RTRIM([TCSApplicable])),''),ISNULL(LTRIM(RTRIM([Aadhaar])),'')
	FROM #ETL_Prk_RetailerGST WHERE --[DownLoadFlag] ='D' AND
	RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerGST
	FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@Composite,
	@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrTaxGroup,@TCSApp,@Aadhaar
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
			SET @TaxGrpId=0
			
			SET @Rtrid=''
			SELECT @Rtrid=Rtrid FROM Retailer(NOLOCK ) WHERE RtrCode =@RtrCode
			
			--DELETE FROM ETL_Prk_RetailerGST WHERE MasterName='RETAILER MASTER' AND [Column Code]=@RtrCode
			DECLARE @DistState AS VARCHAR(100)
			SET @DistState=''
			SET @StateName=''
			SELECT @StateName=StateName FROM StateMaster WHERE StateCode=@StateCode
								
			SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
			INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
			INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
			INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
			WHERE U.MasterId=16 and ColumnName='State Name' 
			
			IF UPPER(@DistState)<>UPPER(@StateName)
			BEGIN
				SET @RtrTaxGroup='RTRINTER'	
			END
			ELSE IF UPPER(@DistState)=UPPER(@StateName)
			BEGIN
				SET @RtrTaxGroup='RTRINTRA'	
			END
			
			IF NOT EXISTS(SELECT * FROM TaxGroupSetting WHERE RtrGroup=UPPER(@RtrTaxGroup) AND TaxGroup=1)
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				SELECT DISTINCT 1,'Retailer GST','Tax Group Code','Tax Group Code Not Foud'
				SET @Po_ErrNo =1
				SET @TaxGrpId=0
			END
			ELSE
			BEGIN
				SELECT @TaxGrpId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN)					
					SET @Po_ErrNo =1
				END
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
				
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@RetailerType,''))))='REGISTERED' 
			BEGIN			
				IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
				
				IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END			
									

		---CRCRSTMRC0193/MARCS202100060
		    IF RTRIM(LTRIM(UPPER(ISNULL(@Aadhaar,''))))<>''
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@Aadhaar))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer GST','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
			IF @Po_ErrNo=0
			BEGIN
				
				IF @GSTEnabled=1
				BEGIN
					IF ISNULL(@TaxGrpId,0)<>0
					BEGIN
						UPDATE A SET TaxGroupId=@TaxGrpId,LastModDate=CONVERT(VARCHAR(10),GETDATE(),121) FROM Retailer A 
						WHERE RtrCode=@RtrCode
					END
				END
				ELSE
				BEGIN
					DELETE FROM RetailerGSTTaxGroupUpdate WHERE RetailerCode=@RtrCode
					INSERT INTO RetailerGSTTaxGroupUpdate(RetailerCode,TaxGroup,UpdateDateTime,UpdateFlag)
					SELECT @RtrCode,@RtrTaxGroup,Getdate(),0
				END	
				
				--IF ISNULL(@TaxGrpId,0)<>0
				--BEGIN
				
				--	UPDATE A SET TaxGroupId=@TaxGrpId,LastModDate=CONVERT(VARCHAR(10),GETDATE(),121),Upload='N' FROM Retailer A 
				--	WHERE RtrCode=@RtrCode
					
				----	--UPDATE A SET A.TaxGroupId=@TaxGrpId,A.Upload='N' FROM RetailerShipAdd A (NOLOCK)
				----	--INNER JOIN Retailer R(NOLOCK) ON A.RtrId=R.RtrId
				----	--WHERE A.RtrShipDefaultAdd=1
					
				--END
				DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master' and ColumnName='PAN/Aadhaar Available'
			
				INSERT INTO ETL_Prk_UDCRetailerGST (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','State Name',@RtrCode,@StateName,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','GSTIN',@RtrCode,@GSTTIN,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Composition',@RtrCode,@Composite,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Related Party',@RtrCode,@RelatedParty,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Retailer Type',@RtrCode,@RetailerType,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','TCS Applicable',@RtrCode,@TCSApp,0 UNION ALL---MARCS202100060
				SELECT DISTINCT 'Retailer Master','Aadhaar',@RtrCode,@Aadhaar,0--MARCS202100060
				
				IF EXISTS(SELECT * FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master')
				BEGIN
					EXEC Proc_ETLValidate_UdcDetailsGST 0
				END
				
				EXEC Proc_UpdateRetailerShipping @RtrId,0
				
				
			END
							
		FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@Composite,
		@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrTaxGroup,@TCSApp,@Aadhaar
	END
	CLOSE Cur_RetailerGST
	DEALLOCATE Cur_RetailerGST
	---Added by Gopi at 05-09-2020 to Capture PAN/Aadhar availability column Capture MARCS202100060
	DECLARE Cur_UdcDt1 CURSOR   
	FOR SELECT DISTINCT ISNULL(LTRIM(RTRIM([RtrCode])),'')
	FROM #ETL_Prk_RetailerGST WHERE 
	RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_UdcDt1  
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	WHILE @@FETCH_STATUS=0  
	BEGIN  
	EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0

	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	END  
	CLOSE Cur_UdcDt1  
	DEALLOCATE Cur_UdcDt1
   
   IF EXISTS (SELECT 'X' FROM  ErrorLog WHERE TableName='Retailer GST')
	BEGIN
	   SET @Po_ErrNo =1
	END
	RETURN
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='AaadharNo' AND ID IN (SELECT ID FROM SYSOBJECTS 
WHERE NAME='Cn2Cs_Prk_RetailerGST' AND XTYPE='U'))
BEGIN
ALTER TABLE Cn2Cs_Prk_RetailerGST ADD AaadharNo Nvarchar(50) ---Values must be 12 digit aadhaar No
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_Cn2Cs_RetailerGST' and Xtype='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerGST
GO
/*
 BEGIN TRAN
 EXEC Proc_Cn2Cs_RetailerGST 0
 SELECT * FROM Cn2Cs_Prk_RetailerGST where downloadflag='D'
 Select * from UDCMASTER where Masterid=2
 SELECT  * FROM ERRORLOG
 ROLLBACK TRAN
 */
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_RetailerGST]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerGST
* PURPOSE		: To validate the downloaded Retailer GST details from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 12/04/2017
* MODIFIED
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08-09-2020  Deepk Philip BZ    PARLECS/0920/089    To avoid Null values in UDC.
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @StateCode VARCHAR(100)
	DECLARE @RtrTaxGroup VARCHAR(100)
	DECLARE @Composite VARCHAR(10)
	DECLARE @RelatedParty AS VARCHAR(10)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @GSTTIN AS VARCHAR(25)
	DECLARE @TaxGrpId AS INT
	DECLARE @StateName as VARCHAR(200)
	DECLARE @RetailerType as VARCHAR(100)
	DECLARE @GSTEnabled AS TINYINT
	DECLARE @Aadhaar AS VARCHAR(100)
	SET @GSTEnabled=0
	
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #Cn2Cs_Prk_RetailerGST
	(
		RtrCode			[Varchar](50),
		StateCode		[Varchar](20),
		RtrTaxGroup		[Varchar](75),
		Composite		[Varchar](5),
		RelatedParty	[Varchar](5),
		PanNumber		[Varchar](15),
		GSTTIN			[Varchar](25),
		RetailerType	[Varchar](25),
		DownLoadFlag	[nvarchar](100),
		Aadhaar[nvarchar](100)
	)
		
	DELETE FROM Cn2Cs_Prk_RetailerGST WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_RetailerGST (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)
	BEGIN
		SET @GSTEnabled=1
	END
	
	SELECT RtrCode,MAX(CreatedDate) as CreatedDate
	INTO #LatestMaster
	FROM Cn2Cs_Prk_RetailerGST WHERE DownLoadFlag='D'
	GROUP BY RtrCode
	--PARLECS/0920/089
	UPDATE A SET Relatedparty='NO'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE Relatedparty IS NULL OR Relatedparty=''
	UPDATE A SET Composite='NO'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE Composite IS NULL OR Composite='' AND retailertype='Registered'
	UPDATE A SET RetailerType='UNREGISTERED'  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE RetailerType IS NULL OR RetailerType=''
	UPDATE A SET Composite=''  FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) WHERE retailertype='Unregistered'
	
	INSERT INTO #Cn2Cs_Prk_RetailerGST(RtrCode,StateCode,RtrTaxGroup,
	Composite,RelatedParty,PanNumber,GSTTIN,RetailerType,DownLoadFlag,Aadhaar)
	SELECT DISTINCT A.RtrCode,StateCode,RtrTaxGroup,
	Composite,RelatedParty,PanNumber,GSTTIN,RetailerType,DownLoadFlag,AaadharNo
	FROM Cn2Cs_Prk_RetailerGST A (NOLOCK) INNER JOIN #LatestMaster B ON A.RtrCode=B.RtrCode
	and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'	
			
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer GST','Retailer Code','Retailer GST Details Should not be empty' 
	FROM #Cn2Cs_Prk_RetailerGST
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	DELETE A FROM #Cn2Cs_Prk_RetailerGST A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #Cn2Cs_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  2,'RetailerGST','Retailer','Retailer GST Details Not allow more than 1-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) and DownLoadFlag='D'
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'RetailerGST','RetailerCode','Retailer Code not Available-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) and DownLoadFlag='D'
	IF EXISTS(SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
	WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	BEGIN
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 4,'RetailerGST','State Code','Retailer GST State Code Not available-'+RtrCode FROM #Cn2Cs_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	END
	
	
	IF EXISTS(SELECT '*' FROM #Cn2Cs_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
				)
	BEGIN
	
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
		INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
		WHERE NOT EXISTS(
			SELECT UD.* FROM UdcHD A (NOLOCK)
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
			INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
			WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
			AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 5,'Retailer GST','StateName','Retailer State Code Not available '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	END
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','RetailerType','RetailerType Should be REGISTERED / UN REGISTERED / NOT ASSIGNED'+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composition Should be YES / No '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composition Not allow YES/NO, when Retailer Type is  Non Regesitered'+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2Cs_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 7,'Retailer GST','Related Party','Related Party Should be YES / No '+RtrCode FROM #Cn2Cs_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
		
	DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1
	
	DECLARE @RtrId AS INT
	SET @RtrId=0
	
	DECLARE Cur_RetailerGST CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM(A.RtrCode)),''),ISNULL(LTRIM(RTRIM([StateCode])),''),ISNULL(LTRIM(RTRIM([RtrTaxGroup])),''),
	ISNULL(LTRIM(RTRIM([Composite])),'NA'),ISNULL(LTRIM(RTRIM([RelatedParty])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([GSTTIN])),''),ISNULL(LTRIM(RTRIM([RetailerType])),''),R.RtrId,ISNULL(LTRIM(RTRIM([Aadhaar])),'')
	FROM #Cn2Cs_Prk_RetailerGST A
	INNER JOIN Retailer R (NOLOCK) ON A.RtrCode=R.RtrCode WHERE [DownLoadFlag] ='D' AND
	A.RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerGST
	FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@RtrTaxGroup,@Composite,
	@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrId,@Aadhaar
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
			SET @TaxGrpId=0			
			
			DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='RETAILER MASTER' AND [Column Code]=@RtrCode
			
			IF NOT EXISTS(SELECT * FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1)
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				SELECT DISTINCT 1,'Retailer GST','Tax Group Code','Tax Group Code Not Foud'
				SET @Po_ErrNo =1
				SET @TaxGrpId=0
			END
			ELSE
			BEGIN
				SELECT @TaxGrpId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN)					
					SET @Po_ErrNo =1
				END
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
				
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@RetailerType,''))))='REGISTERED' 
			BEGIN			
				IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
				
				IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END			
			
			SET @StateName=''
			SELECT @StateName=StateName FROM StateMaster WHERE StateCode=@StateCode
			
		

		  IF RTRIM(LTRIM(UPPER(ISNULL(@Aadhaar,''))))<>''
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@Aadhaar))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer GST','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
			 			
			IF @Po_ErrNo=0
			BEGIN		
				IF @GSTEnabled=1
				BEGIN
					IF ISNULL(@TaxGrpId,0)<>0
					BEGIN
						UPDATE A SET TaxGroupId=@TaxGrpId,LastModDate=CONVERT(VARCHAR(10),GETDATE(),121) FROM Retailer A 
						WHERE RtrCode=@RtrCode
					END
				END
				ELSE
				BEGIN
					DELETE FROM RetailerGSTTaxGroupUpdate WHERE RetailerCode=@RtrCode
					INSERT INTO RetailerGSTTaxGroupUpdate(RetailerCode,TaxGroup,UpdateDateTime,UpdateFlag)
					SELECT @RtrCode,@RtrTaxGroup,Getdate(),0
				END	
			
				INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','State Name',@RtrCode,@StateName,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','GSTIN',@RtrCode,@GSTTIN,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Composition',@RtrCode,@Composite,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Related Party',@RtrCode,@RelatedParty,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Retailer Type',@RtrCode,@RetailerType,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Aadhaar',@RtrCode,@Aadhaar,0
				
				IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Retailer Master')
				BEGIN
					EXEC Proc_Validate_CN2CS_UdcDetails 0
				END
				--Shipping Address
				EXEC Proc_UpdateRetailerShipping @RtrId,0
				
			END
			
		FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@RtrTaxGroup,@Composite,
		@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrId,@Aadhaar
	END
	CLOSE Cur_RetailerGST
	DEALLOCATE Cur_RetailerGST
	UPDATE E SET E.DownLoadFlag='Y' FROM Cn2Cs_Prk_RetailerGST E (NOLOCK) 
	WHERE EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails A WHERE UPPER(A.MasterName)='RETAILER MASTER' AND [Column Code]=E.RtrCode)
	AND NOT EXISTS(SELECT RtrCode from #ToAvoidUDCRetailer C WHERE C.RtrCode=E.RtrCode)
		
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='Proc_ValidateUdcDetails' and Xtype='P')
DROP PROCEDURE Proc_ValidateUdcDetails
GO
CREATE PROCEDURE [dbo].[Proc_ValidateUdcDetails]
(
	@Po_ErrNo INT OUTPUT 
)
AS       
/*************************************************************************************************
* PROCEDURE: Proc_ValidateUdcDetails    
* PURPOSE: To Insert and Update records      
* CREATED: Boopathy.P on 20/09/2007  
*************************************************************************************************
[DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
*************************************************************************************************
24-12-2018   Muthulakshmi.V     CRCRSTMTR0016        CR     UDC MTR should be default Yes
*************************************************************************************************/   
   
SET NOCOUNT ON    
BEGIN       
	DECLARE @ErrDesc AS VARCHAR(1000)  
	DECLARE @rno AS INT  
	DECLARE @TabName AS VARCHAR(50)  
	DECLARE @GetKey AS INT
	DECLARE @Taction AS INT
	DECLARE @MasterName AS Varchar(100)
	DECLARE @ColName AS Varchar(100)
	DECLARE @ColCode AS Varchar(100)
	DECLARE @ColValue AS Varchar(100)
	DECLARE @UdcHdId AS INT
	DECLARE @UdcMasId AS INT
	DECLARE @RecId AS INT
	DECLARE @UdcDtId AS INT
	DECLARE @TempStr AS VARCHAR(4000)
	DECLARE @sSQL AS VARCHAR(4000)
	DECLARE @UniqueId AS INT
	DECLARE @Mandatory AS INT
	DECLARE @RtrId AS INT
	DECLARE @TempUdcMasterId AS Varchar(50)
	DECLARE @ColCode99 AS VARCHAR(100)   ---MARCS202100060
	SET @TabName = 'ETL_Prk_UdcDetails'  
	SET @Po_ErrNo =0
	
	SELECT * INTO #ETL_Prk_UdcDetails FROM ETL_Prk_UdcDetails
	CREATE TABLE #UdcToAvoid
	(
		[MasterName]	VARCHAR(100),
		[ColumnName]	VARCHAR(100)
	)
 ---MARCS202100060
   CREATE TABLE #ETL_Prk_CN2CS_UdcDetails999
	(
	ColCode Varchar(100)
	)
		
	INSERT INTO #UdcToAvoid([MasterName],[ColumnName])
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'PRODUCT MASTER' 
	and [ColumnName] IN ('HSN Code','HSN Description')
	UNION ALL	
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'SUPPLIER MASTER' 
	AND [ColumnName] in ('State Name','GSTIN','Status')
	UNION ALL
	SELECT DISTINCT MasterName,ColumnName FROM ETL_Prk_UdcDetails (NOLOCK) WHERE UPPER(LTRIM(RTRIM([MasterName])))= 'DISTRIBUTOR INFO MASTER' 
	AND [ColumnName] in ('State Name','GSTIN','Distributor Type','PAN Number')

	 ---MARCS202100060
	INSERT INTO #ETL_Prk_CN2CS_UdcDetails999
	SELECT Distinct ISNULL([Column Code],'') from ETL_Prk_CN2CS_UdcDetails(Nolock) WHERE MasterName='RETAILER MASTER'
	and ISNULL([Column Code],'')<>'' 

	DELETE FROM ETL_Prk_UdcDetails WHERE MasterName='RETAILER MASTER' and ColumnName='PAN/Aadhaar Available'
	--- ---MARCS202100060
	IF EXISTS(SELECT * FROM #UdcToAvoid)
	BEGIN
		INSERT INTO Errorlog 
		SELECT 1,@TabName,'MasterName,ColumnName','Udc Details should be download from Console : '
		+[MasterName]+' - '+ColumnName FROM #UdcToAvoid 
	END
	
	DECLARE Cur_UdcDt CURSOR   
	FOR SELECT DISTINCT ISNULL([MasterName],'') AS [MasterName],ISNULL([ColumnName],'') AS [ColumnName],
    	ISNULL([Column Code],'') AS [Column Code],ISNULL([ColumnValue],'') AS [ColumnValue]
    	FROM #ETL_Prk_UdcDetails A
    	WHERE NOT EXISTS(SELECT * FROM #UdcToAvoid B WHERE A.[MasterName]=B.[MasterName] AND A.ColumnName=B.ColumnName)
    	Order By [MasterName],[ColumnName],[Column Code]
	
	OPEN Cur_UdcDt  
	FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue 
	set @Rno = 0  
	WHILE @@FETCH_STATUS=0  
	BEGIN  	  
		set @Taction = 2
	
		IF LTRIM(RTRIM(@MasterName))= ''
		BEGIN
			SET @ErrDesc = 'Master Name should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Master Name',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		ELSE IF LTRIM(RTRIM(@ColName))= ''
		BEGIN
			SET @ErrDesc = 'Column Name should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Column Name',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		ELSE IF LTRIM(RTRIM(@ColCode))= ''
		BEGIN
			SET @ErrDesc = 'Column Code should not be blank'  
			INSERT INTO Errorlog VALUES (1,@TabName,'Column Code',@ErrDesc)   
			SET @Taction = 0 
			SET @Po_ErrNo =1 
		END
		
		SELECT @TempUdcMasterId=B.UdcMasterId FROM UdcHD A INNER JOIN UdcMaster B ON A.MasterId=B.MasterId WHERE UPPER(B.ColumnName)=UPPER(LTRIM(RTRIM(@ColName)))
		IF EXISTS (SELECT UdcMasterId FROM UdcMaster WHERE UdcMasterId=@TempUdcMasterId)
		BEGIN
			SELECT @Mandatory=ColumnMandatory FROM UdcMaster WHERE UdcMasterId=@TempUdcMasterId
		END
		IF @Mandatory=1
		BEGIN
			IF LTRIM(RTRIM(@ColValue))= ''
			BEGIN
				SET @ErrDesc = 'Column Value should not be blank'  
				INSERT INTO Errorlog VALUES (1,@TabName,'Column Value',@ErrDesc)   
				SET @Taction = 0 
				SET @Po_ErrNo =1 
			END
		END
		--ELSE
		--BEGIN
			--SET @ColValue=NULL
		--END
		
		IF @ColName='GSTIN'
		BEGIN
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColValue,''))))<>''
			BEGIN
				IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
				BEGIN					
					SET @RtrId=0
					SELECT @RtrId=RtrId FROM Retailer where RtrCode=@ColCode
					IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@ColValue))<>''
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@ColValue)	
						SET @Po_ErrNo =1
					END				
					ELSE
					BEGIN
						IF (SELECT DBO.Fn_ISGSTINNumber(@ColValue))=1
						BEGIN
							INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
							SELECT DISTINCT 1,@TabName,'GSTIN','Invalid GST Tin Number'
							SET @Po_ErrNo =1
						END
					END
				END
			END
		END
		
		IF @ColName='PanNumber' or @ColName='PAN Number'
		BEGIN
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColValue,''))))<>''
			BEGIN
				IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
				BEGIN
					SET @RtrId=0
					SELECT @RtrId=RtrId FROM Retailer where RtrCode=@ColCode
					IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@ColValue))<>''
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@ColValue)	
						SET @Po_ErrNo =1
					END				
				END			
				ELSE
				BEGIN
					IF (SELECT DBO.Fn_ISPanNumber(@ColValue))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
						SET @Po_ErrNo =1
					END
				END
			END
		END
		
		IF RTRIM(LTRIM(UPPER(ISNULL(@ColName,''))))='REGISTERED' 
		BEGIN
			IF @ColName='GSTIN'
			BEGIN		
				IF (SELECT DBO.Fn_ISGSTINNumber(@ColValue))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
			END
			
			IF @ColName='PanNumber' or @ColName='PAN Number'
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@ColValue))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END
		END		
		---------''' CRCRSTMTR0016
		IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ColName)))='MTR' AND UPPER(LTRIM(RTRIM(@ColValue)))<> 'YES'
			BEGIN				
				SET @ErrDesc = 'Column Value should be YES For MTR'  
				INSERT INTO Errorlog VALUES (1,@TabName,'Column Value',@ErrDesc)   
				SET @Taction = 0 
				SET @Po_ErrNo =1				
			END			
		END
		----- Till here CRCRSTMTR0016
		
				IF @ColName='Aadhaar'   ---MARCS202100060
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@ColValue))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'UDCDetails','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
		IF @Po_ErrNo = 0 
		BEGIN
			IF UPPER(LTRIM(RTRIM(@MasterName)))= 'PRODUCT MASTER' 
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('PRODUCT MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCT','PrdCCode','PrdId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILER','RtrCode','RtrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'ROUTE MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('ROUTE MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ROUTEMASTER','RMCode','RMId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SALESMAN MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SALESMAN MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SALESMAN','SMCode','SMId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BANK MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BANK MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('BANK','BnkCode','BnkId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BANK BRANCH MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BANK BRANCH MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('BANKBRANCH','BnkBrCode','BnkBrId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'COMPANY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('COMPANY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('COMPANY','CmpCode','CmpId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SUPPLIER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SUPPLIER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SUPPLIER','SpmCode','SpmId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END  
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'ROUTE VILLAGE MAPPING'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('ROUTE VILLAGE MAPPING')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ROUTEVILLAGE','VillageCode','VillageId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TRANSPORTER MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TRANSPORTER MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TRANSPORTER','TransporterCode','TransporterId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER SHIPPING ADDRESS'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER SHIPPING ADDRESS')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILERSHIPADD','RtrCode','RtrShipId',LTRIM(RTRIM(@ColCode)),2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE CATEGORY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE CATEGORY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLECATEGORY','VehicleCtgCode','VehicleCtgId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLE','VehicleCode','VehicleId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TAXGROUPSETTING'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TAXGROUPSETTING')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TaxGroupSetting','RtrGroup','TaxGroupId',LTRIM(RTRIM(@ColCode)),3)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'TAXCONFIGURATION'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('TAXCONFIGURATION')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('TAXCONFIGURATION','TaxCode','TaxId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DISTRIBUTOR INFO MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DISTRIBUTOR INFO MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DISTRIBUTOR','DistributorCode','DistributorId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'VEHICLE SUBSIDY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('VEHICLE SUBSIDY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('VEHICLESUBSIDY','VehicleSubCode','VehicleSubId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'BATCH MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('BATCH MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('PRODUCTBATCH','PrdbatCode','PrdBatId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DELIVERYBOY MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DELIVERYBOY MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('DELIVERYBOY','DlvBoyCode','DlvBoyId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'KIT PRODUCT REGISTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('KIT PRODUCT REGISTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('KITPRODUCT','PrdDCode','PrdId',LTRIM(RTRIM(@ColCode)),4)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'LOCATION MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('LOCATION MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('LOCATION','LcnCode','LcnId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'RETAILER CATEGORY HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('RETAILER CATEGORY HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('RETAILERCATEGORY','CtgCode','CtgMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'SALESFORCE HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('SALESFORCE HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('SALESFORCE','SalesForceCode','SalesForceMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'GEOGRAPHY HIERARCHY'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('GEOGRAPHY HIERARCHY')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('GEOGRAPHY','GeoCode','GeoMainId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'REASON MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('REASON MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('REASONMASTER','ReasonCode','ReasonId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CREDIT NOTE RETAILER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CREDIT NOTE RETAILER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('CREDITNOTERETAILER','RtrCode','CrNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DEBIT NOTE RETAILER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DEBIT NOTE RETAILER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('DEBITNOTERETAILER','RtrCode','DbNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CREDIT NOTE SUPPLIER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CREDIT NOTE SUPPLIER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('CREDITNOTESUPPLIER','SpmCode','CrNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'DEBIT NOTE SUPPLIER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('DEBIT NOTE SUPPLIER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQueryWithMaster('DEBITNOTESUPPLIER','SpmCode','DbNoteNumber',LTRIM(RTRIM(@ColCode)),@UdcHdId,@UdcMasId,2)
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'CLAIM GROUP MASTER'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('CLAIM GROUP MASTER')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('CLAIMGROUPMASTER','ClmGrpCode','ClmGrpId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'STOCK MANAGEMENT'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('STOCK MANAGEMENT')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('STOCKMANAGEMENTTYPE','Description','StkMgmtTypeId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			ELSE IF UPPER(LTRIM(RTRIM(@MasterName)))= 'MANUAL CLAIM'
			BEGIN
				SELECT @UdcHdId=dbo.Fn_ReturnUdcHdId('MANUAL CLAIM')
				IF @UdcHdId <> 0
				BEGIN
					SELECT @UdcMasId=DBO.Fn_ReturnUdcMasterId(LTRIM(RTRIM(@ColName)),@UdcHdId)
					IF @UdcMasId <> 0 
					BEGIN
						SELECT @TempStr =DBO.Fn_ReturnBuildQuery('ManualClaimMaster','MacRefNo','MacRefId',LTRIM(RTRIM(@ColCode)),1)
					END
				END
			END 
			IF exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempTbl]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [dbo].[TempTbl]
			CREATE TABLE TempTbl (ColId INT)
			INSERT INTO TempTbl EXEC (@TempStr)
			IF (SELECT Count(*) FROM TempTbl) > 0
			BEGIN
				SELECT @RecId = ColId FROM TempTbl
			END
			ELSE
			BEGIN
				SET @RecId=0
			END
			IF @RecId <> 0 			BEGIN			
				SELECT @UdcDtId = dbo.Fn_ReturnMasterRecId(@RecId,@UdcHdId,@UdcMasId)	
				IF @UdcDtId <> 0
				BEGIN
					UPDATE UdcDetails SET ColumnValue =LTRIM(RTRIM(@ColValue)) WHERE MasterId = @UdcHdId AND UdcMasterId = @UdcMasId AND MasterRecordId=@RecId 			
					SET @sSQL = 'UPDATE UdcDetails SET ColumnValue = ' + CAST(@ColValue AS VARCHAR(50)) + 'WHERE MasterId =' + CAST(@UdcHdId AS VARCHAR(10)) + 
						    ' AND UdcMasterId =' + CAST(@UdcMasId AS VARCHAR(10)) + ' AND MasterRecordId=' + CAST(@RecId AS VARCHAR(10)) 
				DELETE FROM ETL_Prk_UdcDetails WHERE MasterName=@MasterName AND ColumnName=@ColName and [Column Code]=@ColCode and ColumnValue=@ColValue ---ABM
				END
				ELSE
				BEGIN
					SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UdcDetailsId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					
					SELECT @UniqueId= Dbo.Fn_ReturnUDCUniqueId(LTRIM(RTRIM(@ColValue)),@UdcMasId)
					
					IF @UniqueId=0 
					BEGIN
						SELECT @UniqueId=dbo.Fn_GetPrimaryKeyInteger('UDCDetails','UDCUniqueId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
					END
					INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) 
					VALUES (@GetKey,@UdcMasId,@UdcHdId,@RecId,LTRIM(RTRIM(@ColValue)),@UniqueId,1,1,convert(varchar(10),getdate(),121),1,convert(varchar(10),getdate(),121))
				DELETE FROM ETL_Prk_UdcDetails WHERE MasterName=@MasterName AND ColumnName=@ColName and [Column Code]=@ColCode and ColumnValue=@ColValue --ABM
					SET @sSQL = 'INSERT INTO UDCDetails(UdcDetailsId,UdcMasterId,MasterId,MasterRecordId,ColumnValue,UDCUniqueId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(' +
						    CAST(@GetKey AS VARCHAR(50)) + ',' + CAST(@UdcMasId AS VARCHAR(10)) + ',' + CAST(@UdcHdId AS VARCHAR(10)) + ',' + CAST(@UdcHdId AS VARCHAR(50)) + ',' + 
						    CAST(@RecId AS VARCHAR(50)) + ',' + CAST(@ColValue AS VARCHAR(50)) + ','+ CAST(@UniqueId AS VARCHAR(50)) + ',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
					INSERT INTO Translog(strSql1) Values (@sSQL)
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UdcDetailsId'
					SET @sSQL = 'UPDATE counters SET currvalue = currvalue + 1 where tabname = ''UDCDetails'' and fldname = ''UdcDetailsId'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					UPDATE counters SET currvalue = currvalue+1 where tabname = 'UDCDetails' and fldname = 'UDCUniqueId'
					SET @sSQL = 'UPDATE counters SET currvalue = currvalue + 1 where tabname = ''UDCDetails'' and fldname = ''UDCUniqueId'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
			END
		END	
		FETCH NEXT FROM Cur_UdcDt INTO @MasterName,@ColName,@ColCode,@ColValue
	END  
	CLOSE Cur_UdcDt  
	DEALLOCATE Cur_UdcDt 
	-- ---MARCS202100060
	DECLARE Cur_UdcDt1 CURSOR   
	FOR SELECT DISTINCT Colcode from #ETL_Prk_CN2CS_UdcDetails999
	OPEN Cur_UdcDt1  
	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	WHILE @@FETCH_STATUS=0  
	BEGIN  
	EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0

	FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
	END  
	CLOSE Cur_UdcDt1  
	DEALLOCATE Cur_UdcDt1  
	 ---MARCS202100060
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_UpdateRetailerShipping' AND xtype='P')
DROP PROCEDURE Proc_UpdateRetailerShipping
GO
/*
Begin Tran
SELECT * FROM UdcDetails Where MasterId=2 AND MasterRecordId=117 AND UdcMasterId >77
EXEC Proc_UpdateRetailerShipping 117,21
Select * from  RetailerShipAdd where rtrid=117
Rollback Tran
*/  
CREATE PROCEDURE [Proc_UpdateRetailerShipping](@RtrId AS BIGINT,@RtrShipAddId AS INT)  
AS  
/*********************************
* PROCEDURE		: Proc_UpdateRetailerShipping
* PURPOSE		: To validate and insert TCS Tax details
* CREATED		: 
* CREATED DATE	: 21/02/2020
* MODIFIED
* DATE			AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  18/09/2020  S.Moorthi		SR      DABCS202100016            TCS Tax Column added   
**************************************************************************/
BEGIN  
DECLARE @StateId as INT  
DECLARE @GSTTin as VARCHAR(100)  
DECLARE @TaxGroupId AS INT  
DECLARE @GSTEnabled AS TINYINT  
SET @GSTEnabled=0  
SET @StateId=0  
SET @TaxGroupId=0  
SET @GSTTin=''  
  IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1   
  and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)  
  BEGIN  
   SET @GSTEnabled=1  
  END  
  IF @RtrShipAddId=0  
  BEGIN  
   SELECT @RtrShipAddId=RtrShipId FROM RetailerShipAdd WHERE RtrId=@RtrId and RtrShipDefaultAdd=1   
  END  
  SELECT @StateId=SM.StateId FROM UdcHD A (NOLOCK)  
  INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
  INNER JOIN UdcDetails UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId   
  INNER JOIN Retailer R (NOLOCK) ON R.RtrId=UD.MasterRecordId   
  INNER JOIN StateMaster SM (NOLOCK) ON SM.StateName=UD.ColumnValue  
  WHERE A.MasterId=2 AND B.ColumnName='State Name' and ISNULL(ColumnValue,'')<>''  
  AND R.RtrId=@RtrId   
  SELECT @GSTTin=UD.ColumnValue FROM UdcHD A (NOLOCK)  
  INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
  INNER JOIN UdcDetails UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId   
  INNER JOIN Retailer R (NOLOCK) ON R.RtrId=UD.MasterRecordId     
  WHERE A.MasterId=2 AND B.ColumnName='GSTIN' and ISNULL(ColumnValue,'')<>'' AND ISNULL(ColumnValue,'')<>'NULL'
  AND R.RtrId=@RtrId  
  SELECT @TaxGroupId=ISNULL(TaxGroupId,0) FROM Retailer (NOLOCK) WHERE RtrId=@RtrId  
  IF ISNULL(@StateId,0)<>0  
  BEGIN  
   UPDATE A SET StateId=@StateId FROM RetailerShipAdd A WHERE RtrId=@RtrId and RtrShipId=@RtrShipAddId  
  END  
  UPDATE A SET GSTTinNo=ISNULL(@GSTTin,'') FROM RetailerShipAdd A WHERE RtrId=@RtrId and RtrShipId=@RtrShipAddId  --Added by Mohanakrishna A.B 
   /* No Valadation for GSTTINNo Commented by Mohanakrishna A.B
  IF ISNULL(@GSTTin,'')<>'' 
  BEGIN  
	  UPDATE A SET GSTTinNo=@GSTTin FROM RetailerShipAdd A WHERE RtrId=@RtrId and RtrShipId=@RtrShipAddId  
  END  
  */
  IF @GSTEnabled=1  
  BEGIN  
   IF ISNULL(@TaxGroupId,0)<>0  
   BEGIN  
    UPDATE A SET TaxGroupId=@TaxGroupId FROM RetailerShipAdd A WHERE RtrId=@RtrId and RtrShipId=@RtrShipAddId  
   END  
  END
  
  -----DABCS202100016
  DECLARE @ColCode99 AS VARCHAR(100)
  SELECT @ColCode99=RtrCode FROM Retailer Where RtrId=@RtrId
  EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0
RETURN  
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='RptSalesBillWise_Excel' and xtype='U')
DROP TABLE RptSalesBillWise_Excel
GO
CREATE TABLE RptSalesBillWise_Excel(
	[Bill Number] [nvarchar](50) NULL,
	[Bill Type] [nvarchar](25) NULL,
	[Bill Mode] [nvarchar](25) NULL,
	[Bill Date] [datetime] NULL,
	[Retailer Code] [nvarchar](50) NULL,
	[Retailer Name] [nvarchar](150) NULL,
	[Gross Amount] [numeric](38, 6) NULL,
	[Scheme Disc] [numeric](38, 6) NULL,
	[Sales Return] [numeric](38, 6) NULL,
	[Replacement] [numeric](38, 6) NULL,
	[Discount] [numeric](38, 6) NULL,
	[Tax Amount] [numeric](38, 6) NULL,
	[WindowDisplayAmount] [numeric](38, 6) NULL,
	[Credit Adjustmant] [numeric](38, 6) NULL,
	[Debit Adjustment] [numeric](38, 6) NULL,
	[Net Amount] [numeric](38, 6) NULL,
	[DlvStatus] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='view_SalesBillWise' and xtype='V')
DROP VIEW view_SalesBillWise
GO
CREATE  VIEW view_SalesBillWise
/************************************************************
* VIEW	: View_SalesBillWise
* PURPOSE	: To get the Bill details
* CREATED BY	: Boopathy.P
* CREATED DATE	: 30/07/2007
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
AS
SELECT SI.SalId,SI.SalInvNo as [Bill Number],Si.BillType as BillTypeId,BS.SeriesDesc as [Bill Type],
SI.BillMode as BillModeId,BSF.SeriesDesc as [Bill Mode]
,SI.SalInvDate as [Bill Date],R.RtrName as [Retailer Name],R.RtrId,SM.SMId,RM.RMId,SI.LcnId,
SUM(SI.SalGrossAmount) AS  [Gross Amount],SUM(SI.SalSchDiscAmount) as  [Scheme Disc]
,SUM(SI.MarketRetAmount) as [Sales Return],SUM(SI.ReplacementDiffAmount) as [Replacement],
(SUM(SI.SalCDAmount)+SUM(SI.SalDBDiscAmount)+SUM(SI.SalSplDiscAmount)) as [Discount],
SUM(SI.SalTaxAmount)  as [Tax Amount],SUM(SI.CRAdjAmount) AS [Credit Adjustment],
SUM(SI.DBAdjAmount) as [Debit Adjustment],SUM(SI.SalTCSTaxAmount) AS [TCS Tax Amount],SUM(SI.SalNetAmt) AS [Net Amount],SI.DlvSts
FROM Retailer R WITH (NOLOCK),
Salesman SM WITH (NOLOCK),RouteMaster RM WITH (NOLOCK),SalesInvoice SI WITH (NOLOCK)
Inner JOIN BillSeriesConfig BS  WITH (NOLOCK) on (SI.BillType=BS.SeriesValue and BS.SeriesMasterId=2)
INNER JOIN BillSeriesConfig BSF  WITH (NOLOCK) on (SI.BillMode = BSF.SeriesValue  and BSF.SeriesMasterId=1)
WHERE SI.RtrId=R.RtrId AND SI.RMId=RM.RMId AND SI.SMId=SM.SMId
GROUP BY SI.SalId,SI.SalInvNo,SI.SalInvDate,R.RtrName,Si.BillType,SI.BillMode,
R.RtrId,SM.SMId,RM.RMId,SI.LcnId,BS.SeriesDesc,BSF.SeriesDesc,SI.DlvSts
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSalesBillWise' AND xtype='P')
DROP PROCEDURE Proc_RptSalesBillWise
GO
---EXEC Proc_RptSalesBillWise 1,2,0,'Henkel',0,0,1
CREATE PROCEDURE Proc_RptSalesBillWise  
(  
 @Pi_RptId  INT,  
 @Pi_UsrId  INT,  
 @Pi_SnapId  INT,  
 @Pi_DbName  nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
/****************************************************************************  
* PROCEDURE  : Proc_RptSalesBillWise  
* PURPOSE    : To Generate Sales Bill Wise  
* CREATED BY : Boopathy.P  
* CREATED ON : 30/07/2007  
* MODIFICATION  
*****************************************************************************  
* DATE        AUTHOR      DESCRIPTION  
07/12/2007  MURUGAN.R     Adding Retailer Category  
01-07-2014  Jai Ganesh R  Order By Billdate, Bll Number added in the Final Output
*****************************************************************************/  
SET NOCOUNT ON  
BEGIN  
DECLARE @NewSnapId  AS INT  
DECLARE @DBNAME  AS  nvarchar(50)  
DECLARE @TblName  AS nvarchar(500)  
DECLARE @TblStruct  AS nVarchar(4000)  
DECLARE @TblFields  AS nVarchar(4000)  
DECLARE @sSql  AS  nVarChar(4000)  
DECLARE @ErrNo   AS INT  
DECLARE @PurDBName AS nVarChar(50)  
--Filter Variable  
DECLARE @FromDate AS DATETIME  
DECLARE @ToDate   AS DATETIME  
DECLARE @FromBillNo AS  BIGINT  
DECLARE @TOBillNo   AS  BIGINT  
DECLARE @CmpId      AS  INT  
DECLARE @LcnId      AS  INT  
DECLARE @SMId   AS INT  
DECLARE @RMId   AS INT  
DECLARE @RtrId   AS INT  
DECLARE @BillType    AS INT  
DECLARE @BillMode    AS INT  
DECLARE @CtgLevelId AS  INT  
DECLARE @RtrClassId AS  INT  
DECLARE @CtgMainId  AS  INT  
DECLARE @BillStatus AS INT  
DECLARE @CancelValue AS INT  
--Till Here  
--Assgin Value for the Filter Variable  
SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))  
SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))  
SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))  
SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))  
SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))  
SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
SET @LcnId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))  
SET @FromBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))  
SET @TOBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))  
SET @BillType =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId))  
SET @BillMode =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId))  
SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))  
SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))  
SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))  
SET @BillStatus =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId))  
SET @CancelValue =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,193,@Pi_UsrId))  
--Till Here  
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)  
--Till Here  
CREATE TABLE #RptSalesBillWise  
(  
     [Bill Number]         NVARCHAR(50),  
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,  
    [Retailer Name]       NVARCHAR(50),  
  [Gross Amount]        NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6),  
  [Net Amount]          NUMERIC (38,6), 
  [TCS Tax Amount]	  NUMERIC (38,6), 
  [DlvStatus]       INT  
)  
SET @TblName = 'RptSalesBillWise'  
SET @TblStruct = '     [Bill Number]         NVARCHAR(50),  
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,  
    [Retailer Name]       NVARCHAR(50),  
  [Gross Amount]   NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6), 
  [TCS Tax Amount]	  NUMERIC (38,6),   
  [Net Amount]          NUMERIC (38,6),
  [DlvStatus]       INT'  
SET @TblFields = '[Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
  [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
  [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus]'  
IF @Pi_GetFromSnap = 1  
   BEGIN  
 Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId  
 SET @DBNAME =  @DBNAME  
   END  
ELSE  
   BEGIN  
 Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3  
 SET @DBNAME = @PI_DBNAME + @DBNAME  
   END  
IF @Pi_GetFromSnap = 0  --To Generate For New Report Data  
   BEGIN  
 PRINT @CtgLevelId   
 IF @FromBillNo <> 0 AND @TOBillNo <> 0  
 BEGIN  
         PRINT 'A'  
  IF @CtgLevelId=1  
  BEGIN   
   IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TempRetailerCategory')  
    BEGIN       
     DROP TABLE TempRetailerCategory  
    END   
    SELECT * INTO TempRetailerCategory FROM RetailerCategory   
     WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgLevelId IN (SELECT CtgLevelId FROM RetailerCategoryLevel   
      WHERE CtgLevelId=1) AND CtgMainId=(CASE @CtgMainId WHEN 0 THEN CtgMainId ELSE 0 END) OR  
       CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   INSERT INTO #RptSalesBillWise([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],A.[TCS Tax Amount],[Net Amount],[DlvSts]  
    FROM view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,TempRetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
--   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
--   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
--   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
--   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId    
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))  
   AND (DlvSts=(CASE @BillStatus WHEN 0 THEN DlvSts ELSE @BillStatus END))   
     AND ([Bill Date] Between @FromDate and @ToDate)  
     AND (SalId Between @FromBillNo and @TOBillNo)  
  END  
        ELSE  
        BEGIN   
   INSERT INTO #RptSalesBillWise([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],A.[TCS Tax Amount],[Net Amount],[DlvSts]  
    FROM view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId    
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))  
   AND (DlvSts=(CASE @BillStatus WHEN 0 THEN DlvSts ELSE @BillStatus END))   
     AND ([Bill Date] Between @FromDate and @ToDate)  
     AND (SalId Between @FromBillNo and @TOBillNo)  
  END   
 END  
 ELSE  
 BEGIN  
  PRINT 'B'  
  IF @CtgLevelId=1  
  BEGIN   
   IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TempRetailerCategory')  
    BEGIN       
     DROP TABLE TempRetailerCategory  
    END   
    SELECT * INTO TempRetailerCategory FROM RetailerCategory   
     WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgLevelId IN (SELECT CtgLevelId FROM RetailerCategoryLevel   
      WHERE CtgLevelId=1) AND CtgMainId=(CASE @CtgMainId WHEN 0 THEN CtgMainId ELSE 0 END) OR  
       CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   INSERT INTO #RptSalesBillWise([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],A.[TCS Tax Amount],[Net Amount],[DlvSts]  
     from view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,TempRetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
--   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
--   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
--   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
--   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId   
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))  
     AND ([DlvSts]=(CASE @BillStatus WHEN 0 THEN [DlvSts] ELSE 0 END) OR  
       [DlvSts] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId)))  
     AND ([Bill Date] Between @FromDate and @ToDate)  
  END   
  ELSE  
  BEGIN   
   INSERT INTO #RptSalesBillWise([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],A.[TCS Tax Amount],[Net Amount],[DlvSts]  
     from view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId   
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))  
     AND ([DlvSts]=(CASE @BillStatus WHEN 0 THEN [DlvSts] ELSE 0 END) OR  
       [DlvSts] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId)))  
     AND ([Bill Date] Between @FromDate and @ToDate)  
  END    
 END  
 /*  
  For ProductCategory Value and Product Filter  
  R.PrdId = (CASE @fPrdCatPrdId WHEN 0 THEN R.PrdId Else 0 END) OR  
  R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))  
  AND R.PrdId = (CASE @fPrdId WHEN 0 THEN R.PrdId Else 0 END) OR  
  R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))  
 */  
 IF LEN(@PurDBName) > 0  
 BEGIN  
  EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT  
  SET @SSQL = 'INSERT INTO #RptSalesBillWise ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +  
   'WHERE (RtrId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN RtrId ELSE 0 END) OR  
     RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',3,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND (RMId=(CASE ' + CAST(@RMId AS INTEGER) + ' WHEN 0 THEN RMId ELSE 0 END) OR  
     RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',2,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND (SMId=(CASE '+ CAST(@SMId AS INTEGER) + 'WHEN 0 THEN SMId ELSE 0 END) OR  
     SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',1,' + CAST(@Pi_UsrId as INTEGER) + ')))  
    AND (LcnId=(CASE '+ CAST(@LcnId AS INTEGER) + 'WHEN 0 THEN LcnId ELSE 0 END) OR  
     LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',22,' + CAST(@Pi_UsrId as INTEGER) + ')))  
            AND ([BillTypeId] =(CASE ' + CAST(@BillType AS INTEGER) + ' WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
     [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',17,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND ([BillModeId]=(CASE ' + CAST(@BillMode AS INTEGER) + 'WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
     [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',33,' + CAST(@Pi_UsrId as INTEGER) + ')))  
            AND ([Bill Date] Between ' + @FromDate +' and ' + @ToDate + ')  
            AND (SalId Between ' + @FromBillNo +' and ' + @TOBillNo +')'  
  EXEC (@SSQL)  
  PRINT 'Retrived Data From Purged Table'  
 END  
 IF @Pi_SnapRequired = 1  
    BEGIN  
  SELECT @NewSnapId = @Pi_SnapId  
  EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
  IF @ErrNo = 0  
     BEGIN  
   SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +  
    '(SnapId,UserId,RptId,' + @TblFields + ')' +  
    ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSalesBillWise'  
   EXEC (@SSQL)  
   PRINT 'Saved Data Into SnapShot Table'  
     END  
    END  
   END  
ELSE    --To Retrieve Data From Snap Data  
   BEGIN  
 EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
 PRINT @ErrNo  
 IF @ErrNo = 0  
    BEGIN  
  SET @SSQL = 'INSERT INTO #RptSalesBillWise ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +  
   ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +  
   ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
   ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))  
  EXEC (@SSQL)  
  PRINT 'Retrived Data From Snap Shot Table'  
    END  
 ELSE  
    BEGIN  
  PRINT 'DataBase or Table not Found'  
    END  
   END  
--Check for Report Data  
Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId  
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSalesBillWise  
-- Till Here  
 IF (@BillStatus=3 AND  @CancelValue=1) OR (@BillStatus=0 AND  @CancelValue=1)  
 BEGIN  
  UPDATE #RptSalesBillWise SET [Gross Amount]=0,[Scheme Disc]=0,[Sales Return]=0,[Replacement]=0,[Discount]=0,  
    [Tax Amount]=0,[Credit Adjustmant]=0,[Debit Adjustment]=0,[Net Amount]=0,[TCS Tax Amount]=0  
    WHERE [DlvStatus]=3  
 END  
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID = @Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
 BEGIN  
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptSalesBillWise_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  
  DROP TABLE RptSalesBillWise_Excel  
  CREATE TABLE RptSalesBillWise_Excel  
  (  
     [Bill Number]         NVARCHAR(50),  
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,  
        [Retailer Code]       NVARCHAR(50),  
    [Retailer Name]       NVARCHAR(150),  
  [Gross Amount]        NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [WindowDisplayAmount] NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6),  
  [TCS Tax Amount] [numeric](38, 6) NULL,
  [Net Amount]          NUMERIC (38,6),  
  [DlvStatus]       INT  
  )  
  INSERT INTO RptSalesBillWise_Excel ([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
  [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
  [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT  [Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus] FROM #RptSalesBillWise  Order by [Bill Date],[Bill Number]
  UPDATE RPT SET RPT.[Retailer Code]=R.RtrCode FROM RptSalesBillWise_Excel RPT,Retailer R,SalesINvoice SI WHERE RPT.[Retailer Name]=R.RtrName  
  AND SI.SalInvNo=RPT.[Bill NUmber] AND R.RtrId=SI.RtrId  
       UPDATE RPT SET RPT.[WindowDisplayAmount]=R.[WindowDisplayAmount] FROM RptSalesBillWise_Excel RPT,SalesInvoice R WHERE RPT.[Bill Number]=R.SalInvNo  
 END   
    DELETE FROM #RptSalesBillWise WHERE [Gross Amount]=0 AND [Scheme Disc]=0 AND [Sales Return]=0 AND [Replacement]=0 AND [Discount]=0 AND   
    [Tax Amount]=0 AND [Credit Adjustmant]=0 AND [Debit Adjustment]=0 AND [Net Amount]=0 AND [TCS Tax Amount]=0
 SELECT * FROM #RptSalesBillWise  Order by [Bill Date],[Bill Number]
 RETURN  
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='AaadharNo' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='CN2Cs_Prk_RetailerMasterDownload' AND XTYPE='U'))
BEGIN
	ALTER TABLE CN2Cs_Prk_RetailerMasterDownload ADD AaadharNo Nvarchar(50) ---Values must be 12 digit aadhaar No
END
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='TCSApplicable' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='CN2Cs_Prk_RetailerMasterDownload' AND XTYPE='U'))
BEGIN
	ALTER TABLE CN2Cs_Prk_RetailerMasterDownload ADD TCSApplicable Nvarchar(20) ---Values must be Yes/No
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_CN2Cs_RetailerMasterDownload_New' AND xtype='P')
DROP PROCEDURE Proc_CN2Cs_RetailerMasterDownload_New
GO
/*
BEGIN TRAN
delete from errorlog
exec Proc_CN2Cs_RetailerMasterDownload_New 0
----select * from CN2Cs_Prk_RetailerMasterDownload
--select * from retailer -- where Rtrid >574
--select * from errorlog
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_CN2Cs_RetailerMasterDownload_New]
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : NG2Cs_Prk_RetailerMasterDownload  
* PURPOSE  : To Update RetailerMaster data.
* CREATED  : VENKAT. M PMS NO : ILCRSTCKL0147
* CREATED DATE : 25-01-2019  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* 23/09/2019  Kishore R			  ILCRSTPAR5992		 SR		   Retailer Download From Console		
* 13/11/2019  M Lakshman          ILCRSTPAR6671      SR        Due to Phone no & TIN no blank and max length validation has been removed in CS. 
* 18/07/2020  Murugan.R          PARCS202100043      CR        Retailer Code Auto Generate

*********************************/  
SET NOCOUNT ON  
BEGIN  
 DECLARE @sSql   NVARCHAR(2000)  
 DECLARE @Taction    INT  
 DECLARE @ErrDesc    NVARCHAR(1000)  
 DECLARE @Tabname    NVARCHAR(50)  
 Declare @RtrCode  	varchar	(50) 
 Declare @RtrName  	varchar	(100) 
 Declare @RtrAddress1  	varchar	(100) 
 Declare @RtrAddress2  	varchar	(100)
 Declare @RtrAddress3  	varchar	(100) 
 Declare @CityName  	varchar	(100) 
 Declare @StateName  	varchar	(50)
 Declare @PostalCode  	varchar	(50) 
 Declare @RtrChannelCode  	varchar (50) 
 Declare @RtrGroupCode  	varchar (50) 
 Declare @RtrClassCode  	varchar	(50) 
 Declare @RtrKeyAcc  	varchar	(50) 
 Declare @RelationStatus 	nvarchar (100)
 Declare @ParentCode 	nvarchar (100)
 Declare @Status  	varchar	(50) 
 Declare @GeoLevel  	nvarchar	(100) 
 Declare @GeoLevelValue  	nvarchar	(200) 
 Declare @PhNumber  	varchar	(50) 
 Declare @ContactPerson  	varchar	(50)
 Declare @TinNumber  	varchar	(50) 
 Declare @TaxType  	varchar	(50) 
 Declare @RtrTaxGroup  	varchar	(50) 
 Declare @SalesRoute  	varchar	(50) 
 Declare @DeliveryRoute  	varchar	(50) 
 Declare @CashDisc  	numeric	(9, 2) 
 Declare @RtrCrLimit 	numeric	(18,2) 
 Declare @RtrCrDays  	int	 
 Declare @CSRtrType  	varchar	(50) 
 Declare @RegDate  	DateTime	 
 Declare @FrequencyMode  	varchar	(50) 
 Declare @Eligible  	int	       
 Declare @RetailerType  	varchar	(50) 
 Declare @Composition  	varchar	(50) 
 Declare @PANNumber  	varchar	(50) 
 Declare @GSTIN  	varchar	(50) 
 Declare @RelatedParty  	varchar	(50) 
 Declare @Latitude  	varchar	(50) 
	Declare @Longitude  	varchar	(50) 
	Declare @RtrUniqueCode  	varchar	(50)        
	Declare @Approved  	varchar	(50) 
	Declare @DownLoadFlag  	varchar	(10) 
	Declare @CreatedDate  	datetime	 
	Declare @RtrMobileNo  	varchar	(50) 
	DeClare @RtrCovMode as Int
	Declare @RtrDayOff as Int
	Declare @RtrTaxable as varchar(10)
	Declare @KeyAccId as Int
	   Declare @CtgClassMainId as Int
	   Declare @RtrClassId as Int
	   Declare @TaxGroupId as Int
	   Declare @RMID as Int
	   Declare @SRMID as Int	   
	   Declare @ApprovedId as Int
	   Declare @RTRFREQUENCYID as Int
	   Declare @CmpRtrCode as Varchar(50)
	   Declare @RtrId as Int
	   Declare @Pi_UserId as Int
	   Declare @DefultRMid as Int
	   Declare @DefultRMNAME as varchar(50)
	   DECLARE @GeoLevelId AS INT 
	   Declare @GeoMainId as Int	   
	   Declare @RelationStatusID as Int
	   Declare @RtrChildId as Int
	   Declare @RtrCashDiscPerc as numeric(18,2)
	   Declare @CoaId as Int
	   Declare @AcCode	as Nvarchar(100)
	   Declare @RtrType as varchar(50)
	   Declare @RtrTypeID as Int
	   Declare @RtrShipId as Int
	   	   
 Declare @Aadhaar	varchar	(50) 
 Declare @TCSApplicable  	varchar	(50) 

 SET @Taction=0 
 SET @Po_ErrNo=0  
 SET @Tabname = 'CN2Cs_Prk_RetailerMasterDownload'  
 SET @Pi_UserId=1  
 SET @GeoLevelId = 0
 SET @RtrChildId = 0
 
--RtrCode Auto Generate--PARCS202100043
DECLARE @AutoRtrCode AS NVARCHAR(200)
DECLARE @RtrCodeUserInput AS NVARCHAR(200)
DECLARE @AutoRtrCodeConfig AS TINYINT
SET @AutoRtrCodeConfig=0
IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
BEGIN
	SET @AutoRtrCodeConfig=1
END
--Till Here--PARCS202100043
 
 DELETE FROM CN2Cs_Prk_RetailerMasterDownload WHERE DOWNLOADFLAG='Y'
 DECLARE Cur_RetailerMasterDownload_New CURSOR  
 FOR SELECT DISTINCT ISNULL(RtrCode,''),ISNULL(RtrName,''),ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),ISNULL(RtrAddress3,''),ISNULL(PostalCode,''),ISNULL(PhNumber,''),
 ISNULL(ContactPerson,''),ISNULL(RtrKeyAcc,''),1 AS RtrCovMode, ISNULL(RegDate,'1900-01-01'),0 AS RtrDayOff,ISNULL(Status,''),'Yes' as RtrTaxable,ISNULL(TaxType,''),
 ISNULL(TinNumber,''),ISNULL(GeoLevel,''),ISNULL(GeoLevelValue,''),ISNULL(DeliveryRoute,''),ISNULL(SalesRoute,''),
 ISNULL(CashDisc,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0)
 ,ISNULL(RtrTaxGroup,''),
 ISNULL(RtrMobileNo,''),ISNULL(FrequencyMode,''),ISNULL(RtrUniqueCode,''), ISNULL(Approved,''),ISNULL(RelationStatus,''),
 ISNULL(ParentCode,''),ISNULL(RtrGroupCode,''),ISNULL(RtrChannelCode,''),ISNULL(RtrClassCode,''),ISNULL(CSRtrType,''),
 ISNULL(Latitude,''),ISNULL(Longitude,''),ISNULL(StateName,''),ISNULL(RetailerType,''),ISNULL(Composition,''),
 ISNULL(PANNumber,''),ISNULL(GSTIN,''),ISNULL(RelatedParty,''),ISNULL(AaadharNo,''),ISNULL(TCSApplicable,'No')		
 FROM CN2Cs_Prk_RetailerMasterDownload WHERE [DownLoadFlag] ='D' -- and CSRtrType='Sub Stockist' 
 OPEN Cur_RetailerMasterDownload_New  
 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable
 WHILE @@FETCH_STATUS=0  
 BEGIN  
		SET @Po_ErrNo=0  
		SET @Taction=0 
		Delete from ETL_Prk_UdcDetails
		
		 --START--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RtrCode
		
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
						
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RtrCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END
				RETURN
			END	
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RtrCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_RetailerMasterDownload_New')) >= -1
				BEGIN
					DEALLOCATE Cur_RetailerMasterDownload_New
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		
		
		
					
		IF (LTRIM(RTRIM(@RtrCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'') 
		BEGIN  
			IF EXISTS (SELECT '*' FROM Retailer WHERE (RtrCode = @RtrCode 
			OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			)  
			BEGIN  
				SET @Taction=2  
			END  
			ELSE  
			BEGIN  
				SET @Taction=1  
			END  
		END  
		ELSE  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Code should not be empty '      
			INSERT INTO Errorlog VALUES (1,@Tabname,'RetailerCode',@ErrDesc)  
		END  
		IF LTRIM(RTRIM(@RtrName))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Name should not be empty'    
			INSERT INTO Errorlog VALUES (2,@Tabname,'RetailerName',@ErrDesc)  
		END
		IF LTRIM(RTRIM(@RtrAddress1))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Address  should not be empty'    
			INSERT INTO Errorlog VALUES (3,@Tabname,'Address',@ErrDesc)  
		END 		   
		--IF LTRIM(RTRIM(@PhNumber))=''
		--BEGIN
		--	SET @Po_ErrNo=1
		--	SET @Taction=0
		--	SET @ErrDesc = 'Ph Number should not be empty'		
		--	INSERT INTO Errorlog VALUES (4,@Tabname,'TINNumber',@ErrDesc)
		--END
		--ELSE
		--BEGIN
		--	IF LEN(@PhNumber)>12
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'Ph Number Maximum Length should be 12'		
		--		INSERT INTO Errorlog VALUES (5,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--END
		IF UPPER(LTRIM(RTRIM(@RtrKeyAcc)))=UPPER('Yes')  
		BEGIN  
			SET @KeyAccId=1   
		END 
		ELSE  
		BEGIN  
			SET	@KeyAccId=0
		END		
		IF UPPER(LTRIM(RTRIM(@Status)))=UPPER('ACTIVE')  
		--IF UPPER(LTRIM(RTRIM(@Status)))= 1  
		BEGIN  
			SET @Status=1   
		END  
		ELSE  
		BEGIN  
			SET @Status=0  
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (6,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT' OR LTRIM(RTRIM(@TaxType))='GST' 
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (7,@Tabname,'TaxType',@ErrDesc)
			END
		END
		--IF @TaxType='VAT'
		--BEGIN
		--	IF LTRIM(RTRIM(@TINNumber))=''
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'TIN Number should not be empty'		
		--		INSERT INTO Errorlog VALUES (8,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--	ELSE
		--	BEGIN
		--		IF LEN(@TINNumber)>11
		--		BEGIN
		--			SET @Po_ErrNo=1
		--			SET @Taction=0
		--			SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
		--			INSERT INTO Errorlog VALUES (9,@Tabname,'TINNumber',@ErrDesc)
		--		END
		--	END
		--END
		
		IF LTRIM(RTRIM(@RtrTaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup)
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @RtrTaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (10,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup
			END
		END
		IF NOT EXISTS  (SELECT '*' FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'      
			INSERT INTO Errorlog VALUES (11,@Tabname,'DeliveryRoute',@ErrDesc)  
		END  
		ELSE  
		BEGIN    
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 
		END
		IF NOT EXISTS (SELECT '*' FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute)  
		BEGIN  
		   SET @ErrDesc = 'Route Code:'+@SalesRoute+'does not Mapped Salesman'  
		   INSERT INTO Errorlog VALUES (12,@TabName,'Route Code',@ErrDesc)  
		   SET @Po_ErrNo=1  
		   
		END  
		ELSE  
		BEGIN  
			SELECT @SRMID =B.Rmid  FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute    
		END 		
		IF LTRIM(RTRIM(@FrequencyMode))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency  should not be empty'		
			INSERT INTO Errorlog VALUES (13,@Tabname,'Retailer Frequency',@ErrDesc)
		END		
		IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Bi-Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Fort Nightly')  
		BEGIN  
			SET @RTRFREQUENCYID=2  
		END 
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Monthly')  
		BEGIN  
			SET @RTRFREQUENCYID=3  
		END
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Daily')  
		BEGIN  
			SET @RTRFREQUENCYID=4 
		END 
		IF ISNULL(@RtrUniqueCode,'')='' AND UPPER(ISNULL(@Approved,'PENDING'))='APPROVED'  
		BEGIN  
			SET @ErrDesc = 'Retailer Unique Code Mandatory for Approved retailers :'+@RtrCodeUserInput  
			INSERT INTO Errorlog VALUES (14,@TabName,'Retailer Unique Code',@ErrDesc)  
			SET @Po_ErrNo=1  
		END 
		
		IF @Approved = ''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Approved  should not be empty'		
			INSERT INTO Errorlog VALUES (24,@Tabname,'Approved',@ErrDesc)		
		END
		ELSE
		IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('PENDING')  
		BEGIN  
			SET @ApprovedId=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('APPROVED')  
		BEGIN  
			SET @ApprovedId=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('REJECTED')  
		BEGIN  
			SET @ApprovedId=2  
		END
		
		IF LTRIM(RTRIM(@RtrCrLimit))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrLimit)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Limit value Should be Number'    
				INSERT INTO Errorlog VALUES (15,@Tabname,'CreditLimit',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCrDays))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrDays)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Days value Should be Number'    
				INSERT INTO Errorlog VALUES (16,@Tabname,'CreditDays',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCashDiscPerc))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCashDiscPerc)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'    
				INSERT INTO Errorlog VALUES (17,@Tabname,'CashDiscountPercentage',@ErrDesc)  
			END  
		END  
		 
		IF NOT EXISTS  (SELECT '*' FROM GEOGRAPHYLEVEL(NOLOCK) WHERE GeoLevelName = @GeoLevel )  
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Geogrpahy Level: ' + @GeoLevel + ' is not available'      
			INSERT INTO Errorlog VALUES (18,@Tabname,'GEOGRAPHYLEVEL',@ErrDesc)				
		END
		ELSE
		BEGIN
			SELECT @GeoLevelId = GeoLevelId FROM GEOGRAPHYLEVEL WHERE GeoLevelName = @GeoLevel 
		END
		 
		IF @GeoLevelId <> 0 
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM Geography(NOLOCK) WHERE GeoName = @GeoLevelValue )  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Geogrpahy Code: ' + @GeoLevelValue + ' is not available'      
				INSERT INTO Errorlog VALUES (19,@Tabname,'GeographyHierarchyValue',@ErrDesc)  
			END  
			ELSE  
			BEGIN  
				SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoName = @GeoLevelValue  
			END	
		END
	
		IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Independent')
		BEGIN
			SET @RelationStatusID =1
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Parent')
		BEGIN
			SET @RelationStatusID =2
			IF UPPER(LTRIM(RTRIM(@ParentCode))) <> ''
			BEGIN			
				Select @RtrChildId = rtrid from Retailer (Nolock) where RtrCode = @ParentCode
			END
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Child')
		BEGIN
			SET @RelationStatusID =3 
		END
		
		IF UPPER(LTRIM(RTRIM(@RtrType)))=UPPER('Sub Stockist')
		BEGIN
			SET @RtrTypeID = 2
		END
		ELSE
		BEGIN
			SET @RtrTypeID = 1		
		END
	
		IF NOT EXISTS(SELECT '*' FROM RETAILERCATEGORY A (NOLOCK) 
		INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
		inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
		where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode)
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Category: ' + @RtrClassCode + ' is not available'      
			INSERT INTO Errorlog VALUES (20,@Tabname,'RETAILERCATEGORY',@ErrDesc)		 
		END
		ELSE
		BEGIN
			 SELECT @RtrClassId = RtrClassId FROM RETAILERCATEGORY A (NOLOCK)
			 INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
			 inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
			 where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode		 
		END
		SET @CmpRtrCode = ''			
		--IF @Po_ErrNo = 0 AND @Taction = 1
		--BEGIN
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger('Retailer','RtrId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @RtrShipId=dbo.Fn_GetPrimaryKeyInteger('retailershipadd','RtrShipId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) 
			FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')  
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1  
			BEGIN     
				IF NOT EXISTS(SELECT '*' FROM Retailer)  
				BEGIN  
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'   
				END  
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))     				
			END  
			ELSE  
			BEGIN  
				SET @CmpRtrCode=@RtrCode  
			END 	
			IF @CmpRtrCode=''  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Company Retailer Code should not be empty'    
				INSERT INTO Errorlog VALUES (21,@Tabname,'Counter Value',@ErrDesc)  
			END  
			IF @RtrId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (22,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @RtrShipId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (23,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @StateName = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Sate name Should not be Empty '    
				INSERT INTO Errorlog VALUES (25,@Tabname,'Sate name',@ErrDesc) 			
			
			END
			IF @RetailerType = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer Type Should not be Empty '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer Type',@ErrDesc) 			
			
			END
			ELSE
			BEGIN
				IF Upper(@RetailerType) = 'REGISTERED'
				BEGIN
					IF UPPER(@Composition) NOT IN('YES','NO','')
					BEGIN
						SET @Po_ErrNo=1    
						SET @Taction=0  
						SET @ErrDesc = 'REGISTERED Retailer Composition Should not be Empty OR either Yes / No'    
						INSERT INTO Errorlog VALUES (27,@Tabname,'Composition',@ErrDesc) 			
					
					END
				END
			END	
			IF UPPER(@RelatedParty) NOT IN('YES','NO')
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer PARTY Should not be yes / No '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer PARTY',@ErrDesc) 			
			
			END				
		
		IF @Po_ErrNo = 0 AND @Taction = 1
		BEGIN			
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrContactPerson,RtrKeyAcc,
			RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrDepositAmt,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrOffPhone2,RtrDOB,
			RtrAnniversary,RtrRemark1,CoaId,RtrOnAcc,RtrType,RtrFrequency,RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,
			RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,Approved,XMLUpload,RtrPayment,RtrUniqueCode,
			WSUpload,RtrCodeUserInput)
			
			SELECT @RtrId,@RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
			@ContactPerson,@KeyAccId,@RtrCovMode,@RegDate,@RtrDayOff,@Status,(CASE UPPER(@RtrTaxable) WHEN 'YES' THEN 1 ELSE 0 END) RtrTaxable,
			(CASE @TaxType WHEN 'VAT' THEN 0 WHEN 'GST' THEN 2 ELSE 1 END) TaxType
			,@TinNumber,0 RtrDepositAmt,0 RtrCrBills,@RtrCrLimit,@RtrCrDays,@RtrCashDiscPerc,1 RtrCashDiscCond,0 RtrCashDiscAmt,
			@GeoMainId,@RMId,0 VillageId,@RtrShipId,@TaxGroupId,@RtrMobileNo,@RegDate,@RegDate,'Downloaded Retailer',@CoaId,0 RtrOnAcc,
			@RtrTypeID,@RTRFREQUENCYID,0 RtrCrBillsAlert,0 RtrCrLimitAlert,0 RtrCrDaysAlert,'N' Upload,@RelationStatusID,
			1,@Pi_UserId,GETDATE(),@Pi_UserId,GETDATE(),@CmpRtrCode,@ApprovedId,0 XMLUpload,1 RtrPayment,@RtrUniqueCode,
			'N' WSUpload,@RtrCodeUserInput
			
			IF EXISTS (SELECT '*' FROM Retailer WHERE RtrId=@RtrId)  
			BEGIN  
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RtrName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),
				GETDATE(),121))  
			 			
				INSERT INTO RETAILERMARKET(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
				SELECT @Rtrid,@SRMID,1,1,GETDATE(),1,GETDATE(),0
				
				INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121))
				
				IF ISNULL(@RtrChildId,0) <> 0
				BEGIN
					INSERT INTO Retailerrelation(RtrId,RtrChildId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					Select @RtrId,@RtrChildId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
					CONVERT(NVARCHAR(10),GETDATE(),121)
				END
								
				INSERT INTO Retailershipadd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,
				RtrShipDefaultAdd,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxGroupId,StateId,GSTTinNo,Upload)
				SELECT @RtrShipId,@RtrId,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,1,1,@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@TaxGroupId,0,'','N'
					
				INSERT INTO ETL_Prk_UdcDetails
				SELECT 'Retailer Master','Latitude', @RtrCode,(CASE @Latitude WHEN '' THEN '0' ELSE @Latitude END) UNION ALL								
				SELECT 'Retailer Master','Longitude', @RtrCode,(CASE @Longitude WHEN '' THEN '0' ELSE @Longitude END) UNION ALL
				SELECT 'Retailer Master','State Name', @RtrCode,@StateName  UNION ALL
				SELECT 'Retailer Master','Retailer Type', @RtrCode,@RetailerType UNION ALL				
				SELECT 'Retailer Master','Composition', @RtrCode,(CASE @Composition WHEN '' THEN 'NA' ELSE @Composition END) UNION ALL
				SELECT 'Retailer Master','PAN Number', @RtrCode,(CASE @PANNumber WHEN '' THEN NULL ELSE @PANNumber END) UNION ALL
				SELECT 'Retailer Master','GSTIN', @RtrCode,(CASE @GSTIN WHEN '' THEN NULL ELSE @GSTIN END) UNION ALL
				SELECT 'Retailer Master','Related Party', @RtrCode,(CASE @RelatedParty WHEN '' THEN 'NO' ELSE @RelatedParty END) UNION ALL
				SELECT 'Retailer Master','Aadhaar', @RtrCode,@Aadhaar UNION ALL
				SELECT 'Retailer Master','TCS Applicable', @RtrCode,(CASE WHEN @TCSApplicable='Yes' THEN 'Yes' ELSE 'No' END)
				
				
				IF EXISTS(SELECT * FROM ETL_Prk_UdcDetails)
				BEGIN
					EXEC Proc_ValidateUdcDetails 0
				END
				
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'retailershipadd' AND Fldname = 'RtrShipId'  
				UPDATE companycounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'RtrId'
				--RtrCode Auto Generate
				IF @AutoRtrCodeConfig=1
				BEGIN
					UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				END
				--Till Here
				
			END		  		  
		END
	 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
	 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
	 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
	 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
	 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
	 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty,@Aadhaar,@TCSApplicable
 END  
 CLOSE Cur_RetailerMasterDownload_New  
 DEALLOCATE Cur_RetailerMasterDownload_New  
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCode=C.RtrCODE 
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCodeUserInput=C.RtrCODE
 RETURN  
END
GO
--E-Invoice Starts Here------------------
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Tbl_EInvoiceIntegration')
DROP TABLE Tbl_EInvoiceIntegration
GO
CREATE TABLE Tbl_EInvoiceIntegration
(
	[SequenceNo] [int] NULL,
	[ProcessName] [varchar](100) NULL,
	[TableName] [varchar](100) NULL,
	[SPName] [varchar](100) NULL,
	[Active] TinyInt,
	[CreatedDate] [datetime] NULL,
	
)
GO
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (1,'Sales','RptEInvoice_Sales','Proc_RptEInvoice_Sales',1,Getdate())
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (2,'Return','RptEInvoice_Sales','Proc_RptEInvoice_SalesReturn',1,Getdate())
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (3,'Purchase Return','RptEInvoice_Sales','Proc_RptEInvoice_PurchaseReturn',1,Getdate())
Insert Into Tbl_EInvoiceIntegration (SequenceNo,ProcessName,TableName,SPName,Active,CreatedDate) Values (4,'IDT Sales','RptEInvoice_Sales','Proc_RptEInvoice_IDTSales',1,Getdate())
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Columns')
DROP TABLE EInvoice_Columns
GO
CREATE TABLE EInvoice_Columns
(
	SLNO INT,
	NodeId INT,
	TransType Varchar(50),
	ColumnName Varchar(50),
	ColRequired TINYINT
)
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Acknowledgment')
BEGIN
CREATE TABLE EInvoice_Acknowledgment
(
	TransId	 TINYINT,
	Invoice_Id	BIGINT,
	Invoice_no  Varchar(50),
	Invoice_date Datetime,
	Ack_Number Varchar(200),
	Ack_Date Datetime,
	Irn Varchar(100),
	SignedInvoice Varchar(8000),
	SignedQRCode Varchar(8000),
	QRCodeImage Varbinary(Max),
	Ack_Status varchar(20),
	Response_Status TINYINT,
	Err_code Varchar(50),
	Err_desc Varchar(5000),
	Lastmoddate Datetime,
	MovedOnDate Datetime,
	CONSTRAINT PK_EInvoice_Acknowledgment PRIMARY KEY CLUSTERED 
	(
	TransId,Invoice_Id,Invoice_no ASC
	)
)
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_ErrorLog')
DROP TABLE EInvoice_ErrorLog
GO
CREATE TABLE EInvoice_ErrorLog
(
	SLNO INT,
	ProcessName Varchar(50),
	ErrorDesc Varchar(Max)	
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_ExcelColumns')
DROP TABLE EInvoice_ExcelColumns
GO
CREATE TABLE EInvoice_ExcelColumns
(
	SLNO INT,
	ColumnName Varchar(100),
	ColRequired Tinyint
)
GO
DELETE FROM EInvoice_ExcelColumns
INSERT INTO EInvoice_ExcelColumns(SLNO,ColumnName,ColRequired)
SELECT 1,'Catg AS [Category]',1
UNION ALL
SELECT 2,'RegRev AS [Sub Category]',1
UNION ALL
SELECT 3,'Typ',0
UNION ALL
SELECT 4,'ExcelEcomTran AS [E-Com Trn]',0
UNION ALL
SELECT 5,'EcmGstin AS [E-Com GSTIN]',1
UNION ALL
SELECT 6,'ExcelInvoiceType as [Doc Type]',1
UNION ALL
SELECT 7,'No as [Doc No]',1
UNION ALL
SELECT 8,'Dt as [Doc Date]',1
UNION ALL
SELECT 9,'OrgInvNo AS [Original Inv No]',0
UNION ALL
SELECT 10,'Gstin AS [Seller GSTIN]',1
UNION ALL
SELECT 11,'TrdNm AS [Legal Name]',1
UNION ALL
SELECT 12,'TrdNm as [Trade Name]',1
UNION ALL
SELECT 13,'Bno AS [Address1]',1
UNION ALL
SELECT 14,'Bnm AS [Address2]',1
UNION ALL
SELECT 15,'Flno AS [Floor No]',0
UNION ALL
SELECT 16,'Loc AS [Location]',1
UNION ALL
SELECT 17,'Dst AS [District]',1
UNION ALL
SELECT 18,'Pin AS [PinCode]',1
UNION ALL
SELECT 19,'SellerState AS [State]',1
UNION ALL
SELECT 20,'Ph AS [Phone Number]',1
UNION ALL
SELECT 21,'Em AS [Email Id]',1
UNION ALL
SELECT 22,'BGstin AS [Buyer GSTIN]',1
UNION ALL
SELECT 23,'BTrdNm as [Legal Name]',1
UNION ALL
SELECT  24,'BTrdNm as [Trade Name]',1
UNION ALL
SELECT 25,'BStcd as Pos',1
UNION ALL
SELECT 26,'BBno as [Buyer address1]',1
UNION ALL
SELECT 27,'BBnm as [Buyer address2]',1
UNION ALL
SELECT 28,'BFlno as [Floor No]',0
UNION ALL
SELECT 29,'BLoc as [Location]',1
UNION ALL
SELECT 30,'BDst as [District]',1
UNION ALL
SELECT 31,'BPin as [PinCode]',1
UNION ALL
SELECT 32,'ExcelStateName as [State]',1
UNION ALL
SELECT 33,'BPh as [Phone Number]',1
UNION ALL
SELECT 34,'BEm as [Email Id]',1
UNION ALL
SELECT 35,'ShipGstin as Gstin',0
UNION ALL
SELECT 36,'ShipTrdNm as TrdNm',0
UNION ALL
SELECT 37,'ShipBno as Bno',0
UNION ALL
SELECT 38,'ShipBnm as Bnm',0
UNION ALL
SELECT 39,'ShipFlno as Flno',0
UNION ALL
SELECT 40,'ShipLoc as Loc',0
UNION ALL
SELECT 41,'ShipDst as Dst',0
UNION ALL
SELECT 42,'ShipPin as Pin',0
UNION ALL
SELECT 43,'ShipStcd as Stcd',0
UNION ALL
SELECT 44,'ShipPh as Ph',0
UNION ALL
SELECT 45,'ShipEm as Em',0
UNION ALL
SELECT 46,'PrdSlno as SlNo',1
UNION ALL
SELECT 47,'PrdNm AS [Product Name]',0
UNION ALL
SELECT 48,'PrdDesc AS [Product Description]',1
UNION ALL
SELECT 49,'HsnCd AS [HSN Code]',1
UNION ALL
SELECT 50,'Barcde AS [Bar Code]',0
UNION ALL
SELECT 51,'Qty AS [Quantity]',1
UNION ALL
SELECT 52,'FreeQty',1
UNION ALL
SELECT 53,'ExcelUnits as Unit',1
UNION ALL
SELECT 54,'UnitPrice as [Unit Price]',1
UNION ALL
SELECT 55,'TotAmt AS [Total Amt (Qty*Unit Price)]',1
UNION ALL
SELECT 56,'Discount',1
UNION ALL
SELECT 57,'OthChrg  AS [Other Charges]',1
UNION ALL
SELECT 58,'AssAmt  AS [Assessable Amount]',1
UNION ALL
SELECT 59,'ExcelTaxRate  AS [Tax Rate]',1 
UNION ALL
SELECT 60,'GstRt',1
UNION ALL
SELECT 61,'IgstRt AS [IGST] ',0
UNION ALL
SELECT 62,'CgstRt AS [CGST] ',0
UNION ALL
SELECT 63,'SgstRt AS [SGST] ',0
UNION ALL
SELECT 64,'IgstVal as IgstAmt',1
UNION ALL
SELECT 65,'CgstVal as CgstAmt',1
UNION ALL
SELECT 66,'SgstVal as SgstAmt',1
UNION ALL
SELECT 67,'CesRt',1
UNION ALL
SELECT 68,'CesVal as CesAmt',1
UNION ALL
SELECT 69,'SgstVal',0
UNION ALL
SELECT 70,'CesRt AS [CESS] ',0
UNION ALL
SELECT 71,'CesVal',0
UNION ALL
SELECT 72,'CesNonAdval',1
UNION ALL
SELECT 73,'TCesNonAdVal as CesNonAdVal',0
UNION ALL
SELECT 74,'StateCes  AS [State Cess] ',1
UNION ALL
SELECT 75,'StCesVal',0
UNION ALL
SELECT 76,'ROUND(TotItemVal,2,1)  AS [Total Item Value] ',1 
UNION ALL
SELECT 77,'OrdLineRef',1
UNION ALL
SELECT 	78,'ROUND(ExcelAssVal,2,1) AS [Total Assessable Value]',1 
UNION ALL
SELECT 	79,'ROUND(ExcelCgstVal,2,1) AS [Total CGST Value]',1 
UNION ALL
SELECT 	80,'ROUND(ExcelSgstVal,2,1) AS [Total SGST Value]',1 
UNION ALL
SELECT 	81,'ROUND(ExcelIgstVal,2,1) AS [Total IGST Value]',1 
UNION ALL
SELECT 	82,'ROUND(ExcelCesVal,2,1) AS [Total CESS Value]',1 
UNION ALL
SELECT 	83,'ROUND(ExcelStCesVal,2,1) AS [Total State Cess Value]',1 
UNION ALL
SELECT 	84,'ROUND(ExcelTCesNonAdVal,2,1) AS [Total Cess Non Advol]',1 
UNION ALL		
SELECT 	85,'ROUND(ExcelDisc,2,1) AS [Discount On Invoice]',1 
UNION ALL
SELECT 	86,'ROUND(ExcelTOthChrg,2,1) AS [Other Charges On Invoice]',1 
UNION ALL
SELECT 87,'RndOffAmt as RndOffAmt',1
UNION ALL
SELECT 	88,'ROUND(ExcelTotInvVal,2,1) AS [Total Invoice Value]',1 
UNION ALL
SELECT 89,'TotInvValFc as TotInvValFc',1
GO
INSERT INTO EInvoice_Columns(SLNO,NodeId,TransType,ColumnName,ColRequired)
SELECT 1,1,'TranDtls','''GST'' as TaxSch',1
UNION ALL
SELECT 2,1,'TranDtls','Catg as SupTyp',1
UNION ALL
SELECT 3,1,'TranDtls','RegRev',1
UNION ALL
SELECT 4,1,'TranDtls','Typ',0
UNION ALL
SELECT 5,1,'TranDtls','EcmTrn',0
UNION ALL
SELECT 6,1,'TranDtls','EcmGstin',1
UNION ALL
SELECT 1,2,'DocDtls','DTyp as Typ',1
UNION ALL
SELECT 2,2,'DocDtls','No',1
UNION ALL
SELECT 3,2,'DocDtls','Dt',1
UNION ALL
SELECT 4,2,'DocDtls','OrgInvNo',0
UNION ALL
SELECT 1,3,'SellerDtls','Gstin',1
UNION ALL
SELECT 2,3,'SellerDtls','TrdNm as LglNm',1
UNION ALL
SELECT 3,3,'SellerDtls','TrdNm',1
UNION ALL
SELECT 4,3,'SellerDtls','Bno as Addr1',1
UNION ALL
SELECT 5,3,'SellerDtls','Bnm as Addr2',1
UNION ALL
SELECT 6,3,'SellerDtls','Flno',0
UNION ALL
SELECT 7,3,'SellerDtls','Loc',1
UNION ALL
SELECT 8,3,'SellerDtls','Dst',0
UNION ALL
SELECT 9,3,'SellerDtls','Pin',1
UNION ALL
SELECT 10,3,'SellerDtls','SellerState as State',1
UNION ALL
SELECT 11,3,'SellerDtls','Ph',1
UNION ALL
SELECT 12,3,'SellerDtls','Em',1
UNION ALL
SELECT 1,4,'BuyerDtls','BGstin as Gstin',1
UNION ALL
SELECT 2,4,'BuyerDtls','BTrdNm as LglNm',1
UNION ALL
SELECT 3,4,'BuyerDtls','BTrdNm as TrdNm',1
UNION ALL
SELECT 4,4,'BuyerDtls','BStcd as Pos',1
UNION ALL
SELECT 5,4,'BuyerDtls','BBno as Addr1',1
UNION ALL
SELECT 6,4,'BuyerDtls','BBnm as Addr2',1
UNION ALL
SELECT 7,4,'BuyerDtls','BFlno as Flno',0
UNION ALL
SELECT 8,4,'BuyerDtls','BLoc as Loc',1
UNION ALL
SELECT 9,4,'BuyerDtls','BDst as Dst',0
UNION ALL
SELECT 10,4,'BuyerDtls','BPin as Pin',1
UNION ALL
SELECT 11,4,'BuyerDtls','ExcelStateName as State',1
UNION ALL
SELECT 12,4,'BuyerDtls','BPh as Ph',1
UNION ALL
SELECT 13,4,'BuyerDtls','BEm as Em',1
UNION ALL
SELECT 1,5,'ShipDtls','ShipGstin as Gstin',0
UNION ALL
SELECT 2,5,'ShipDtls','ShipTrdNm as LglNm',0
UNION ALL
SELECT 3,5,'ShipDtls','ShipTrdNm as TrdNm',0
UNION ALL
SELECT 4,5,'ShipDtls','ShipBno as Addr1',0
UNION ALL
SELECT 5,5,'ShipDtls','ShipBnm as Addr2',0
UNION ALL
SELECT 6,5,'ShipDtls','ShipFlno as Flno',0
UNION ALL
SELECT 7,5,'ShipDtls','ShipLoc as Loc',0
UNION ALL
SELECT 8,5,'ShipDtls','ShipDst as Dst',0
UNION ALL
SELECT 9,5,'ShipDtls','ShipPin as Pin',0
UNION ALL
SELECT 10,5,'ShipDtls','ShipStcd as Stcd',0
UNION ALL
SELECT 11,5,'ShipDtls','ShipPh as Ph',0
UNION ALL
SELECT 12,5,'ShipDtls','ShipEm as Em',0
UNION ALL
SELECT 1,6,'ItemList','PrdSlno as SlNo',1
UNION ALL
SELECT 2,6,'ItemList','PrdNm',0
UNION ALL
SELECT 3,6,'ItemList','PrdDesc',1
UNION ALL
SELECT 4,6,'ItemList','IsService as IsServc',1
UNION ALL
SELECT 5,6,'ItemList','HsnCd',1
UNION ALL
SELECT 6,6,'ItemList','Barcde',1
UNION ALL
SELECT 7,6,'ItemList','Qty',1
UNION ALL
SELECT 8,6,'ItemList','FreeQty',1
UNION ALL
SELECT 9,6,'ItemList','Unit',1
UNION ALL
SELECT 10,6,'ItemList','UnitPrice',1
UNION ALL
SELECT 11,6,'ItemList','ROUND(TotAmt,2,1) as TotAmt',1
UNION ALL
SELECT 12,6,'ItemList','Discount',1
UNION ALL
SELECT 13,6,'ItemList','PreTaxVal',0
UNION ALL
SELECT 14,6,'ItemList','OthChrg',1
UNION ALL
SELECT 15,6,'ItemList','ROUND(AssAmt,2,1) as AssAmt',1
UNION ALL
SELECT 16,6,'ItemList','GstRt',1
UNION ALL
SELECT 17,6,'ItemList','CgstRt',0
UNION ALL
SELECT 18,6,'ItemList','SgstRt',0
UNION ALL
SELECT 19,6,'ItemList','IgstRt',0
UNION ALL
SELECT 20,6,'ItemList','IgstVal as IgstAmt',1
UNION ALL
SELECT 21,6,'ItemList','CgstVal as CgstAmt',1
UNION ALL
SELECT 22,6,'ItemList','SgstVal as SgstAmt',1
UNION ALL
SELECT 23,6,'ItemList','CesRt',1
UNION ALL
SELECT 24,6,'ItemList','CesVal as CesAmt',1
UNION ALL
SELECT 25,6,'ItemList','CesNonAdval as CesNonAdvlAmt',1
UNION ALL
SELECT 26,6,'ItemList','StateCes as StateCesRt',1
UNION ALL
SELECT 27,6,'ItemList','0 as StateCesAmt',1
UNION ALL
SELECT 28,6,'ItemList','0 as StateCesNonAdvlAmt',1
UNION ALL
SELECT 29,6,'ItemList','TotItemVal',1
UNION ALL
SELECT 30,6,'ItemList','OrdLineRef',1
UNION ALL
SELECT 31,6,'ItemList','OrgCntry',0
UNION ALL
SELECT 32,6,'ItemList','PrdSlno',0
UNION ALL
SELECT 1,7,'ValDtls','ROUND(SUM(AssVal),2,1) as AssVal',1
UNION ALL
SELECT 2,7,'ValDtls','ROUND(SUM(CgstVal),2,1) as CgstVal',1
UNION ALL
SELECT 3,7,'ValDtls','ROUND(SUM(SgstVal),2,1) as SgstVal',1
UNION ALL
SELECT 4,7,'ValDtls','ROUND(SUM(IgstVal),2,1) as IgstVal',1
UNION ALL
SELECT 5,7,'ValDtls','ROUND(SUM(CesVal),2,1) as CesVal',1
UNION ALL
SELECT 6,7,'ValDtls','ROUND(SUM(StCesVal),2,1) as StCesVal',1
UNION ALL
SELECT 7,7,'ValDtls','ROUND(SUM(TCesNonAdVal),2,1) as CesNonAdVal',1
UNION ALL
SELECT 8,7,'ValDtls','ROUND(SUM(Disc),2,1) as Disc',1
UNION ALL
SELECT 9,7,'ValDtls','ROUND(SUM(TOthChrg),2,1) as OthChrg',1
UNION ALL
SELECT 10,7,'ValDtls','SUM(DISTINCT RndOffAmt) as RndOffAmt',1
UNION ALL
SELECT 11,7,'ValDtls','ROUND(SUM(TotInvVal),2,1) as TotInvVal',1
UNION ALL
SELECT 12,7,'ValDtls','SUM(DISTINCT TotInvValFc) as TotInvValFc',1
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_ReturnEinvoceQuery')
DROP FUNCTION Fn_ReturnEinvoceQuery
GO
/*
SELECT DBO.Fn_ReturnEinvoceQuery('ValDtls',1,'UC00002','RptEInvoice_Sales','JSON')
SELECT SUM(AssVal) as AssVal,SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as CesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as OthChrg,SUM(DISTINCT RndOffAmt) as RndOffAmt,SUM(TotInvVal) as TotInvVal,SUM(DISTINCT TotInvValFc) as TotInvValFc FROM RptEInvoice_Sales (NOLOCK) WHERE TransId=1 and No='UC00002'
*/
CREATE     FUNCTION [Fn_ReturnEinvoceQuery](@TransType AS Varchar(50),@TransId AS VARCHAR(50),@TransNo Varchar(50),
@Table_Name AS VARCHAR(100),@Option AS Varchar(20))  
RETURNS VARCHAR(Max)  
AS  
BEGIN  
/*********************************  
* FUNCTION: Fn_ReturnEinvoceQuery  
* PURPOSE: Retunr Query Formation
* NOTES:  
* CREATED: Murugan.R 22-01-2020  
* MODIFIED  
************************************************************************************************
DATE			AUTHOR			CR/BZ	USER STORY ID			DESCRIPTION 
************************************************************************************************      
14/02/2020	       MOHANA S			CR	   ILCRSTPAR7871		   E- Invoice
************************************************************************************************/  
DECLARE @SSQL AS VARCHAR(MAX)
IF @Option='JSON'
BEGIN
	IF @TransType IN('ItemList','ValDtls')
	BEGIN
		SET @SSQL='SELECT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_Columns WHERE TransType=@TransType and ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK) WHERE TransId='+@TransId+' and No='''+@TransNo+''''
	END
	ELSE
	BEGIN
		SET @SSQL='SELECT DISTINCT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_Columns WHERE TransType=@TransType and ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK) WHERE TransId='+@TransId+' and No='''+@TransNo+''''
	END
END
IF @Option='CSV'
BEGIN
		SET @SSQL='SELECT '
		SELECT @SSQL=@SSQL+ColumnName+',' FROM EInvoice_ExcelColumns WHERE ColRequired=1 ORDER BY SLNO
		SET @SSQL= SUBSTRING(@SSQL,1,LEN(@SSQL)-1)+ ' FROM '+@Table_Name+' (NOLOCK)  ORDER BY TransId,Dt,No,StockType'
END	
RETURN (@SSQL)  
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptEInvoice_Sales')
DROP TABLE RptEInvoice_Sales
GO
CREATE TABLE RptEInvoice_Sales
(
Catg Varchar(5),
RegRev Varchar(4),
Typ Varchar(5),
EcmTrn Varchar(2),
EcmGstin Varchar(20),
DTyp Varchar(5),
No Varchar(16),
Dt Varchar(10),
OrgInvNo Varchar(16),
Gstin Varchar(15),
TrdNm Varchar(100),
Bno	Varchar(60),
Bnm Varchar(60),
Flno Varchar(60),
Loc Varchar(60),
Dst Varchar(60),
Pin Varchar(6),
Stcd Varchar(2),
Ph Varchar(10),
Em Varchar(50),
BGstin Varchar(15),
BTrdNm Varchar(100),
BBno Varchar(60),
BBnm Varchar(60),
BFlno Varchar(60),
BLoc Varchar(60),
BDst Varchar(60),
BPin Varchar(6),
BStcd Varchar(2),
BPh Varchar(10),
BEm Varchar(50),
ShipGstin Varchar(15),
ShipTrdNm Varchar(100),
ShipBno Varchar(60),
ShipBnm Varchar(60),
ShipFlno Varchar(60),
ShipLoc Varchar(60),
ShipDst Varchar(60),
ShipPin Varchar(6),
ShipStcd Varchar(2),
ShipPh Varchar(10),
ShipEm Varchar(50),
PrdNm Varchar(100),
PrdDesc Varchar(100),
HsnCd Varchar(8),
Barcde  Varchar(30),
Qty  Numeric(18,2),
FreeQty  Numeric(18,2),
Unit  Varchar(3),
UnitPrice Numeric(18,6),
TotAmt Numeric(18,6),
Discount Numeric(18,6),
OthChrg Numeric(18,6),
AssAmt Numeric(18,6),
CgstRt Numeric(8,2),
SgstRt  Numeric(8,2),
IgstRt Numeric(8,2), 
CesRt  Numeric(8,2),
CesNonAdval  Numeric(8,3),
StateCes  Numeric(8,3),  
TotItemVal  Numeric(18,6),
AssVal Numeric(18,6),
CgstVal Numeric(18,6),
SgstVal Numeric(18,6),
IgstVal Numeric(18,6),
CesVal Numeric(18,6),
StCesVal Numeric(18,6),
TCesNonAdVal Numeric(18,6),			
Disc Numeric(18,6),
TOthChrg Numeric(18,6),
TotInvVal Numeric(18,6),
ExcelAssVal Numeric(18,6),
ExcelCgstVal Numeric(18,6),
ExcelSgstVal Numeric(18,6),
ExcelIgstVal Numeric(18,6),
ExcelCesVal Numeric(18,6),
ExcelStCesVal Numeric(18,6),
ExcelTCesNonAdVal Numeric(18,6),			
ExcelDisc Numeric(18,6),
ExcelTOthChrg Numeric(18,6),
ExcelTotInvVal Numeric(18,6),
TransId TINYINT,
Invoice_Id BIGINT,
StockType TINYINT,
PrdId INT,
RtrId INT,
ExcelTaxRate Varchar(50),
ExcelInvoiceType Varchar(20),
ExcelSubCategory Varchar(20),
ExcelEcomTran Varchar(5),
ExcelUnits Varchar(20),
ExcelStateName Varchar(100),
GstRt Numeric(8,2),
OrdLineRef Varchar(50),
OrgCntry Varchar(50),
SellerState Varchar(100),
IsService Varchar(2),
RndOffAmt Numeric(18,2),
TotInvValFc Numeric(18,6),
PrdSlno INT,
PreTaxVal Numeric(18,6)
)
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_Sales')
DROP PROCEDURE Proc_RptEInvoice_Sales
GO
/*
BEGIN TRAN EInvoice_ErrorLog
DELETE FROM EInvoice_ErrorLog
EXEC Proc_RptEInvoice_Sales '2020-02-01','2020-02-14','JSON',0,''
--SELECT * FROM Salesinvoice
SELECT * FROM RptEInvoice_Sales
SELECT * FROM EInvoice_ErrorLog
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_RptEInvoice_Sales]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option AS Varchar(10),
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_Sales
* PURPOSE    : To Generate Einvoice-Sales
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
************************************************************************************************
DATE			AUTHOR			CR/BZ	USER STORY ID			DESCRIPTION 
************************************************************************************************      
14/02/2020	  	MOHANA S			CR	   ILCRSTPAR7871		   E- Invoice
************************************************************************************************/
BEGIN
SET NOCOUNT ON	

BEGIN TRY
		SET @ErrorId =0
		SET @ErrorMessage =''	
		CREATE TABLE #EInvoice_Sales
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(30),
			DTyp Varchar(5),
			No Varchar(50),
			Dt DateTime,
			OrgInvNo Varchar(50),
			Gstin Varchar(30),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(20),
			Stcd Varchar(2),
			Ph Varchar(20),
			Em Varchar(50),
			BGstin Varchar(30),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(20),
			BStcd Varchar(2),
			BPh Varchar(20),
			BEm Varchar(50),
			ShipGstin Varchar(30),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(20),
			ShipStcd Varchar(2),
			ShipPh Varchar(20),
			ShipEm Varchar(50),
			PrdNm Varchar(200),
			PrdDesc Varchar(200),
			HsnCd Varchar(20),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			RtrId INT,
			Salid BIGINT,
			Prdid INT,
			StockType TINYINT,
			ExcelStateName Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,2),
			PrdSlno INT,
			PreTaxVal Numeric(18,6)		
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
	
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		SELECT DISTINCT  R.DistributorId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'



		---Retailer State
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
	

		---Sales B2B
		SELECT RtrId,RtrShipId,SalId,Salinvno,SalInvDate,prdslno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,OrderKeyNo,SalRoundOffAmt,SalNetAmt
		INTO #SalesTax
		FROM(
		SELECT RtrId,RtrShipId,S.SalId,Salinvno,SalInvDate,prdslno,TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxAmount ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxAmount ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxAmount ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxAmount ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		ISNULL(OrderKeyNo,'') as OrderKeyNo,
		SalRoundOffAmt,
		SalNetAmt
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax SS (NOLOCK) ON S.SalId=SS.Salid
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE DlvSts>3 and SalInvDate between @FromDate and @ToDate
		and TaxableAmount>0 AND UPPER(RtrType) = 'R'
		)X GROUP BY RtrId,RtrShipId,SalId,Salinvno,SalInvDate,prdslno,OrderKeyNo,
		SalRoundOffAmt,SalNetAmt
		ORDER BY Salid
		

		SELECT B.Prdid,RtrShipId,RtrId,A.SalId,A.Salinvno,SalInvDate,Prdccode,PrdName,SUM(baseQty) as baseQty,PrdBatDetailValue as PrdUnitSelRate,SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmount) as PrdNetAmount,
		SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(SplDiscAmount+PrdSplDiscAmount+PrdSchDiscAmount+PrdDBDiscAmount+PrdCDAmount) as Discounts,
		ROW_NUMBER()OVER(PARTITION BY A.Salid Order by Max(B.SlNo)) as SalPrdSlno,
		OrderKeyNo,SalRoundOffAmt,SalNetAmt
		INTO #SalesB2B 
		FROM #SalesTax A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.Salid
		AND A.Prdslno=B.SlNo
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		AND PBD.PriceId=B.PriceId
		WHERE BC.SelRte=1
		GROUP BY B.Prdid,RtrShipId,RtrId,A.SalId,A.Salinvno,SalInvDate,Prdccode,PrdName,PrdBatDetailValue,OrderKeyNo,
		SalRoundOffAmt,SalNetAmt
		
		
		--DELETE A FROM #SalesB2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		
		SELECT DISTINCT Salid,Salinvno,Salinvdate,RtrId,RtrShipId,MAX(SalPrdSlno) as SalPrdSlno,OrderKeyNo,
		SalRoundOffAmt,SalNetAmt
		INTO #Invoice FROM #SalesB2B
		GROUP BY Salid,Salinvno,Salinvdate,RtrId,RtrShipId,OrderKeyNo,SalRoundOffAmt,SalNetAmt
		
	
		
		---FreeQty
		SELECT RtrId,SF.Salid,Salinvno,Salinvdate,RtrShipId,FreePrdId as Prdid,PrdName,Prdccode,SUM(FreeQty) as FreeQty ,
		SalPrdSlno+ROW_NUMBER()OVER(PARTITION BY SF.Salid Order by FreePrdId ) as SalPrdSlno,
		OrderKeyNo,SalRoundOffAmt,SalNetAmt
		INTO #FreeProduct
		FROM  SalesInvoiceSchemeDtFreePrd SF (NOLOCK)
		INNER JOIN Product P (NOLOCK) ON SF.FreePrdId=P.Prdid
		INNER JOIN #Invoice X ON X.Salid=SF.Salid
		GROUP BY  RtrId,SF.Salid,Salinvno,Salinvdate,FreePrdId ,PrdName,Prdccode,RtrShipId,OrderKeyNo,SalPrdSlno,
		SalRoundOffAmt,SalNetAmt
		
		
		
	
		---Sales B2B END

		INSERT INTO #EInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,
		Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,Rtrid,Salid,Prdid,StockType,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,Salinvno as [No],SalInvDate as Dt,'' as OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, 
		SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRate as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal,0 as StCesVal,0 as TCesNonAdVal,Discounts as Disc,0 as TOthChrg,PrdNetAmount as TotInvVal,
		1 as TransId,R.Rtrid,Salid,Prdid,1,
		TaxPer,OrderKeyNo,'IN','' as SellerState,'N' as IsService,SalRoundOffAmt as RndOffAmt,
		SalNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal
		FROM #SalesB2B A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		UNION ALL
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,Salinvno as [No],SalInvDate as Dt,'' as OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,0 as Qty,FreeQty as FreeQty,'PCS' as Unit,
		0 as UnitPrice,0 as TotAmt,0 as Discount,0 as OthChrg,0 as AssAmt,
		0 as CgstRt,0 as SgstRt,0 as IgstRt,0 as CesRt,
		0 as CesNonAdval,0 as StateCes,0 as TotItemVal,
		0 as AssVal,0 as CgstVal,0 as SgstVal,0 as IgstVal,
		0 as CesVal,0 as StCesVal,0 as TCesNonAdVal,0 as Disc,0 as TOthChrg,0 as TotInvVal,
		1 as TransId,R.Rtrid,Salid,Prdid,2,
		0 as TaxPer,OrderKeyNo,'IN','' as SellerState,'N' as IsService,SalRoundOffAmt as RndOffAmt,
		SalNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal
		FROM #FreeProduct A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId


		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_Sales B ON A.PrdId=B.Prdid 

		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'') FROM #RetailerGSTIN A 
		INNER JOIN #EInvoice_Sales B ON A.RtrId=B.RtrId
		
		UPDATE B SET BStcd=ISNULL(StateCode,'')	,ShipStcd=ISNULL(StateCode,''),
		ExcelStateName=	ISNULL(StateName,'')
		FROM #RetailerState A INNER JOIN #EInvoice_Sales B ON A.RtrId=B.RtrId 
		
			
		UPDATE C SET ShipBno=SUBSTRING(RtrShipAdd1,1,60),
		ShipBnm=SUBSTRING(RtrShipAdd2,1,60),
		ShipFlno=SUBSTRING(RtrShipAdd3,1,60),
		ShipPin=SUBSTRING(CAST(RtrShipPinNo as Varchar(30)),1,6), 
		ShipPh=SUBSTRING(RtrShipPhoneNo ,1,10)
		FROM RetailerShipAdd A INNER JOIN #Invoice B ON A.RtrId=B.RtrId
		and A.RtrShipId=B.RtrShipId
		INNER JOIN #EInvoice_Sales C ON C.Salid=B.Salid AND C.RtrId=A.RtrId
		
				
		UPDATE #EInvoice_Sales SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #DistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #DistributorState)
		
		--SELECT MAX(LEN(Catg)) as Catg
		--,MAX(LEN(RegRev)) as RegRev,MAX(LEN(Typ)) as Typ,MAX(LEN(EcmTrn)) as EcmTrn,
		--MAX(LEN(EcmGstin)) as EcmGstin,
		--MAX(LEN(DTyp)) as DTyp,MAX(LEN(No)) as No,MAX(LEN(Dt)) as Dt,MAX(LEN(OrgInvNo)) as OrgInvNo,
		--MAX(LEN(Gstin)) as Gstin,MAX(LEN(TrdNm)) as TrdNm,MAX(LEN(Bno)) as Bno,MAX(LEN(Bnm)) as Bnm,
		--MAX(LEN(Flno)) as Flno,MAX(LEN(Loc)) as Loc,MAX(LEN(Dst)) as Dst,MAX(LEN(Pin)) as Pin,
		--MAX(LEN(Stcd)) as Stcd,MAX(LEN(Ph)) as Ph,MAX(LEN(Em)) as Em,
		--MAX(LEN(BGstin)) as BGstin,MAX(LEN(BTrdNm)) as BTrdNm,MAX(LEN(BBno)) as BBno,MAX(LEN(BBnm)) as BBnm,
		--MAX(LEN(BFlno)) as BFlno,MAX(LEN(BLoc)) as BLoc,MAX(LEN(BDst)) as BDst,
		--MAX(LEN(BPin)) as BPin,MAX(LEN(BStcd)) as BStcd,MAX(LEN(BPh)) as BPh,
		--MAX(LEN(BEm)) as BEm,MAX(LEN(ShipGstin)) as ShipGstin,
		--MAX(LEN(ShipTrdNm)) as ShipTrdNm,MAX(LEN(ShipBno)) as ShipBno,
		--MAX(LEN(ShipBnm)) as ShipBnm,MAX(LEN(ShipFlno)) as ShipFlno,MAX(LEN(ShipLoc)) as ShipLoc,MAX(LEN(ShipDst)) as ShipDst,
		--MAX(LEN(ShipPin)) as ShipPin,MAX(LEN(ShipStcd)) as ShipStcd,MAX(LEN(ShipPh)) as ShipPh,MAX(LEN(ShipEm)) as ShipEm,
		--MAX(LEN(PrdNm)) as PrdNm,MAX(LEN(PrdDesc)) as PrdDesc,MAX(LEN(HsnCd)) as HsnCd,MAX(LEN(Barcde)) as Barcde
		--FROM #EInvoice_Sales
		
		Delete From EInvoice_ErrorLog where ProcessName = 'Sales'
				
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'Sales','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_Sales
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'Sales','HSN Code should be 8 digit' FROM #EInvoice_Sales
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 and 8
		
		IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) where ProcessName = 'Sales')
		BEGIN
			SET @ErrorId =1
			SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
			RETURN
		END
									
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,Prdid,RtrId,ExcelTaxRate,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,convert(varchar(10), dt, 105),OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,
		Salid,StockType,Prdid,RtrId,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'Tax Invoice' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal
		FROM #EInvoice_Sales ORDER BY Dt,No
		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_Sales 
		GROUP BY No

		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END

				
	
		DROP TABLE #RetailerState
		DROP TABLE #RetailerGSTIN	
		DROP TABLE #SalesTax
		DROP TABLE #SalesB2B	
		DROP TABLE #ProductHsnCode
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'Sales',ERROR_MESSAGE()
END CATCH			
RETURN		
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_SalesReturn')
DROP PROCEDURE Proc_RptEInvoice_SalesReturn
GO
/**
BEGIN TRAN 
EInvoice_ErrorLog
DELETE FROM EInvoice_ErrorLog
EXEC Proc_RptEInvoice_SalesReturn '2020-02-01','2020-02-14','JSON',0,''
--SELECT * FROM Salesinvoice
SELECT * FROM RptEInvoice_Sales
SELECT * FROM EInvoice_ErrorLog
ROLLBACK TRAN
**/
CREATE PROCEDURE [Proc_RptEInvoice_SalesReturn]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option Varchar(10),
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_SalesReturn
* PURPOSE    : To Generate Einvoice-SalesReturn
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
************************************************************************************************
DATE			AUTHOR			CR/BZ	USER STORY ID			DESCRIPTION 
************************************************************************************************      
14/02/2020	  	MOHANA S			CR	   ILCRSTPAR7871		   E- Invoice
************************************************************************************************/
BEGIN
SET NOCOUNT ON
BEGIN TRY	
		SET @ErrorId =0
		SET @ErrorMessage =''
		CREATE TABLE #EInvoice_SalesReturn
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(20),
			DTyp Varchar(5),
			No Varchar(16),
			Dt DateTime,
			OrgInvNo Varchar(16),
			Gstin Varchar(15),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(6),
			Stcd Varchar(2),
			Ph Varchar(10),
			Em Varchar(50),
			BGstin Varchar(15),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(6),
			BStcd Varchar(2),
			BPh Varchar(10),
			BEm Varchar(50),
			ShipGstin Varchar(15),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(6),
			ShipStcd Varchar(2),
			ShipPh Varchar(10),
			ShipEm Varchar(50),
			PrdNm Varchar(100),
			PrdDesc Varchar(100),
			HsnCd Varchar(10),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			RtrId INT,
			Salid BIGINT,
			Prdid INT,
			StockType TINYINT,
			ExcelStateName	Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,6),
			PrdSlno INT,
			PreTaxVal Numeric(18,6)	
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
		
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		
	
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'



		---Retailer State
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		SELECT DISTINCT  R.DistributorId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
		
		SELECT C.RtrId,CrNoteNumber,CrNoteDate,PostedFrom AS ReturnCode,C.Amount   
		INTO #CREDITNOTEDETAILS  
		FROM Creditnoteretailer C (NOLOCK)
		WHERE TransId=30 AND CrNoteDate between @FromDate and @ToDate  
		
		
 ----SELECT SalInvNo,Salinvdate,ReturnID,ReturnCode  INTO #INVOICEDETAILS FROM (  
	SELECT DISTINCT SI.SALID,SalInvNo,Salinvdate,RH.ReturnID,RH.ReturnCode,RtrShipId,SI.RtrId,ISNULL(SI.RtrType,'') RtrType   
	INTO #INVOICEDETAILS  
	FROM SalesInvoice SI(NOLOCK) INNER JOIN ReturnHeader RH (NOLOCK) ON RH.SalId=SI.Salid  
	INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode  
	WHERE ReturnDate between @FromDate and @ToDate AND RH.InvoiceType=1
  
  
	  UPDATE  A SET RtrType = UPPER(left(B.ColumnValue,1)) FROM #INVOICEDETAILS A
	  INNER JOIN #RetailerRegister B ON A.RtrId = B.RtrId AND A.RtrType = ''

 -- --UNION ALL
 -- --SELECT DISTINCT SalInvNo,Salinvdate,RH.ReturnID,RH.ReturnCode    
 -- --FROM SalesInvoice SI(NOLOCK)  
 -- --INNER JOIN ReturnProduct RP (NOLOCK) ON RP.SalId=SI.SalId  
 -- --INNER JOIN ReturnHeader RH (NOLOCK) ON RH.ReturnId=RP.ReturnId  
 -- --INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode AND C.SalRefNo=RP.SalId --ILCRSTGCP1930  
 -- --WHERE MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear   
 -- -- AND Salinvdate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND RH.InvoiceType=2 AND RH.SRNSRSType=1  AND SRNRefType =1  ) A --CRCRSTGCP0045  
 --  ----Till Here CRCRSTGCP0038  
 -- SELECT * INTO #ReturnProductTax FROM ReturnProductTax   
 --  WHERE ReturnID IN (SELECT DISTINCT ReturnID FROM #INVOICEDETAILS)   
	

		---Sales B2B
		SELECT RtrId,ReturnID,ReturnCode,ReturnDate,prdslno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		RtnRoundOffAmt,RtnNetAmt
		INTO #SalesReturnTax
		FROM(
		SELECT S.RtrId,S.ReturnID,S.ReturnCode,ReturnDate,PrdSlno,TaxableAmt as TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxAmt ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxAmt ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxAmt ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxAmt ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		RtnRoundOffAmt ,RtnNetAmt
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProductTax SS (NOLOCK) ON S.ReturnID=SS.ReturnID
		INNER JOIN #INVOICEDETAILS I ON I.ReturnID=S.ReturnID and I.ReturnID=SS.ReturnId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE Status=0 and ReturnDate between @FromDate and @ToDate
		and TaxableAmt>0 AND UPPER(I.RtrType) = 'R'
		)X GROUP BY RtrId,ReturnID,ReturnCode,ReturnDate,prdslno,RtnRoundOffAmt,RtnNetAmt
		ORDER BY ReturnID

		SELECT B.Prdid,A.RtrId,A.ReturnID,A.ReturnCode,ReturnDate,Prdccode,PrdName,SUM(baseQty) as baseQty,PrdBatDetailValue as PrdUnitSelRte,SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmt) as PrdNetAmount,
		SUM(PrdGrossAmt) as PrdGrossAmount,
		SUM(PrdSplDisAmt+PrdSchDisAmt+PrdDBDisAmt+PrdCDDisAmt) as Discounts,
		CAST(ISNULL(SalInvNo,'') as Varchar(50)) as OrgInvNo,
		ROW_NUMBER()OVER(PARTITION BY A.ReturnID Order by Max(B.Slno)) as SalPrdSlno,
		RtnRoundOffAmt,RtnNetAmt
		INTO #SalesReturnB2B 
		FROM #SalesReturnTax A INNER JOIN ReturnProduct B ON A.ReturnID=B.ReturnID
		AND A.Prdslno=B.Slno
		LEFT OUTER JOIN Salesinvoice S (NOLOCK) ON S.Salid=B.Salid
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		AND PBD.PriceId=B.PriceId
		WHERE BC.SelRte=1
		GROUP BY CAST(ISNULL(SalInvNo,'') as Varchar(50)),B.Prdid,A.RtrId,A.ReturnID,A.ReturnCode,ReturnDate,Prdccode,PrdName,PrdBatDetailValue,
		RtnRoundOffAmt,RtnNetAmt
					
			
		--DELETE A FROM #SalesReturnB2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		
		
		--FREE Qty
		SELECT DISTINCT RtrId,ReturnID,ReturnCode,ReturnDate,RtnRoundOffAmt,RtnNetAmt,MAX(SalPrdSlno) as SalPrdSlno 
		INTO #ReturnHd  FROM #SalesReturnB2B
		GROUP BY RtrId,ReturnID,ReturnCode,ReturnDate,RtnRoundOffAmt,RtnNetAmt
		
		SELECT RtrId,A.ReturnId,ReturnCode,ReturnDate,FreePrdId as Prdid,PrdName,Prdccode,SUM(ReturnFreeQty) as ReturnFreeQty,
		CAST('' as Varchar(50)) as OrgInvNo,
		RtnRoundOffAmt,RtnNetAmt,SalPrdSlno+ROW_NUMBER()OVER(PARTITION BY A.ReturnId Order by FreePrdId ) as SalPrdSlno
		INTO #ReturnFreeProduct  
		FROM ReturnSchemeFreePrdDt A (NOLOCK)
		INNER JOIN #ReturnHd B ON A.ReturnID=B.ReturnID
		INNER JOIN Product P (NOLOCK) ON P.PrdId=A.FreePrdId
		GROUP BY RtrId,A.ReturnId,ReturnCode,ReturnDate,FreePrdId,PrdName,Prdccode,SalPrdSlno,RtnRoundOffAmt,RtnNetAmt
		
		
		UPDATE B SET OrgInvNo=SalInvNo
		FROM #INVOICEDETAILS A INNER JOIN #SalesReturnB2B B ON A.ReturnID=B.ReturnId WHERE LEN(ISNULL(B.OrgInvNo,''))=0 
		
		UPDATE B SET OrgInvNo=SalInvNo
		FROM #INVOICEDETAILS A INNER JOIN #ReturnFreeProduct B ON A.ReturnID=B.ReturnId  WHERE LEN(ISNULL(B.OrgInvNo,''))=0 

		
		
		
		---Sales B2B END
	
		INSERT INTO #EInvoice_SalesReturn(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,Rtrid,Salid,Prdid,StockType,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'CRN' as DTyp,ReturnCode as [No],ReturnDate as Dt,OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,
		SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRte as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal, 0 as  StCesVal,0 as TCesNonAdVal,Discounts as Disc,0 as TOthChrg,PrdNetAmount as TotInvVal,
		2 as TransId,A.Rtrid,ReturnId,Prdid,1,
		TaxPer as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,RtnRoundOffAmt as RndOffAmt,
		RtnNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal
		FROM #SalesReturnB2B A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		UNION ALL
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'CRN' as DTyp,ReturnCode as [No],ReturnDate as Dt,OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,RtrName as  BTrdNm,SUBSTRING(RtrAdd1,1,60) as BBno,SUBSTRING(RtrAdd2,1,60) as BBnm,SUBSTRING(RtrAdd3,1,60) as BFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as BLoc,'' as BDst,ISNULL(RtrPinNo,'') as BPin,'' as BStcd,
		SUBSTRING(RtrPhoneNo,1,10) as BPh,'' as BEm,
		'' as ShipGstin,RtrName as ShipTrdNm,SUBSTRING(RtrAdd1,1,60) as ShipBno,SUBSTRING(RtrAdd2,1,60) as ShipBnm,SUBSTRING(RtrAdd3,1,60) as ShipFlno,
		SUBSTRING(ISNULL(GeoName,''),1,60) as ShipLoc,'' as ShipDst,
		ISNULL(RtrPinNo,'') as ShipPin,'' as ShipStcd,SUBSTRING(RtrPhoneNo,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,0 as Qty,ReturnFreeQty as FreeQty,'PCS' as Unit,
		0 as UnitPrice,0 as TotAmt,0 as Discount,0 as OthChrg,0 as AssAmt,
		0 as CgstRt,0 as SgstRt,0 as IgstRt,0 as CesRt,
		0 as CesNonAdval,0 as StateCes,0 as TotItemVal,
		0 as AssVal,0 as CgstVal,0 as SgstVal,0 as IgstVal,
		0 as CesVal,0 as StCesVal,0 as TCesNonAdVal,0 as Disc,0 as TOthChrg,0 as TotInvVal,
		2 as TransId,A.Rtrid,ReturnId,Prdid,2,
		0 as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,RtnRoundOffAmt as RndOffAmt,
		RtnNetAmt as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal
		FROM #ReturnFreeProduct A CROSS JOIN Distributor
		INNER JOIN Retailer R (NOLOCK) ON R.RtrId=A.RtrId
		LEFT OUTER JOIN Geography G (NOLOCK) ON G.GeoMainId=R.GeoMainId
		



		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_SalesReturn B ON A.PrdId=B.Prdid 

		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'') FROM #RetailerGSTIN A INNER JOIN #EInvoice_SalesReturn B ON A.RtrId=B.RtrId
		
		UPDATE B SET BStcd=ISNULL(StateCode,''),ShipStcd=ISNULL(StateCode,''),
		ExcelStateName	=	ISNULL(StateName,'')
		FROM #RetailerState A INNER JOIN #EInvoice_SalesReturn B ON A.RtrId=B.RtrId 

		UPDATE #EInvoice_SalesReturn SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #DistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #DistributorState)
		
		UPDATE C SET ShipBno=SUBSTRING(RtrShipAdd1,1,60),
		ShipBnm=SUBSTRING(RtrShipAdd2,1,60),
		ShipFlno=SUBSTRING(RtrShipAdd3,1,60),
		ShipPin=SUBSTRING(CAST(RtrShipPinNo as VARCHAR(20)),1,6), 
		ShipPh=SUBSTRING(RtrShipPhoneNo,1,10)
		FROM RetailerShipAdd A INNER JOIN #INVOICEDETAILS B ON A.RtrId=B.RtrId
		and A.RtrShipId=B.RtrShipId
		INNER JOIN #EInvoice_SalesReturn C ON C.Salid=B.ReturnID AND C.RtrId=A.RtrId
		
		
		Delete From EInvoice_ErrorLog where ProcessName = 'Return'
				
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'Return','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_SalesReturn
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'Return','HSN Code should be 8 digit' FROM #EInvoice_SalesReturn
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 and 8
		
		IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) where ProcessName='Return')
		BEGIN
			SET @ErrorId =1
			SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
			RETURN
		END

	
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,PrdId,RtrId,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,ExcelTaxRate,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No, convert(varchar(10),dt, 111),OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,salid,StockType,Prdid,RtrId,'Credit Note' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal		
		FROM #EInvoice_SalesReturn ORDER BY Dt,No

		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_SalesReturn 
		GROUP BY No

		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
		
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'Return',ERROR_MESSAGE()
END CATCH			
		RETURN	
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_PurchaseReturn')
DROP PROCEDURE Proc_RptEInvoice_PurchaseReturn
GO
--SELECT * FROM ReturnHeader where ReturnCode='PPLGST1700003'
--SELECT * FROM ReturnProduct where ReturnId=3
--SELECT * FROM PurchaseReturn
--EXEC Proc_RptEInvoice_PurchaseReturn '2018-06-30','2019-11-04','Json',0,''
--SELECT * FROM RptEInvoice_Sales
CREATE PROCEDURE [Proc_RptEInvoice_PurchaseReturn]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option Varchar(10),
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_PurchaseReturn
* PURPOSE    : To Generate Einvoice-PurchaseReturn
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION		
*  07/02/2020	  Deepak K		CR	   	CRCRSTMTR0036		   E- Invoice			
*************************************************
*/
BEGIN
SET NOCOUNT ON

	BEGIN TRY	
		SET @ErrorId =0
		SET @ErrorMessage =''
		CREATE TABLE #EInvoice_PurchaseReturn
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(20),
			DTyp Varchar(5),
			No Varchar(16),
			Dt DateTime,
			OrgInvNo Varchar(16),
			Gstin Varchar(15),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(6),
			Stcd Varchar(2),
			Ph Varchar(10),
			Em Varchar(50),
			BGstin Varchar(15),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(6),
			BStcd Varchar(2),
			BPh Varchar(10),
			BEm Varchar(50),
			ShipGstin Varchar(15),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(6),
			ShipStcd Varchar(2),
			ShipPh Varchar(10),
			ShipEm Varchar(50),
			PrdNm Varchar(100),
			PrdDesc Varchar(100),
			HsnCd Varchar(10),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			SpmId INT,
			Salid BIGINT,
			Prdid INT,
			StockType TINYINT,
			ExcelStateName Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,2),
			PrdSlno INT,
			PreTaxVal Numeric(18,6)		
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
	
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		SELECT DISTINCT  R.DistributorId as RtrId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'



		---Supplier State
		SELECT DISTINCT  R.SpmId as SpmId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		---Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmId ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
	
		

		  SELECT DISTINCT SI.CmpInvNo,InvDate,RH.PurRetId,RH.PurRetRefNo  
		  INTO #INVOICEDETAILS  
		  FROM PurchaseReceipt SI(NOLOCK) INNER JOIN PurchaseReturn RH (NOLOCK) ON RH.PurRcptId=SI.PurRcptId  
		  WHERE PurRetDate between @FromDate and @ToDate AND RH.Status=1

	

		---Sales B2B
		SELECT SpmId,PurRetId,PurRetRefNo,PurRetDate,prdslno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		NetAmount
		INTO #PurchaseReturnTax
		FROM(
		SELECT SpmId,S.PurRetId,S.PurRetRefNo,PurRetDate,PrdSlno,TaxableAmount as TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SS.TaxAmount ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SS.TaxAmount ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SS.TaxAmount ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess') THEN SS.TaxAmount ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		NetAmount
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProductTax SS (NOLOCK) ON S.PurRetId=SS.PurRetId
		INNER JOIN #INVOICEDETAILS I ON I.PurRetId=S.PurRetId and I.PurRetId=SS.PurRetId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE Status=1 and PurRetDate between @FromDate and @ToDate
		and TaxableAmount>0
		)X GROUP BY SpmId,PurRetId,PurRetRefNo,PurRetDate,PrdSlno,NetAmount
		ORDER BY PurRetId
		

		SELECT B.Prdid,A.spmId,A.PurRetId,A.PurRetRefNo,PurRetDate,Prdccode,PrdName,SUM(RetInvBaseQty) as baseQty,PrdBatDetailValue as PrdUnitSelRte,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmount) as PrdNetAmount,
		SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(PrdDiscount) as Discounts,
		CAST('' as Varchar(50)) as OrgInvNo,
		ROW_NUMBER()OVER(PARTITION BY A.PurRetId Order by Max(B.Prdslno)) as SalPrdSlno,
		NetAmount
		INTO #PurchaseReturn
		FROM #PurchaseReturnTax A INNER JOIN PurchaseReturnProduct B ON A.PurRetId=B.PurRetId
		AND A.Prdslno=B.Prdslno
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		AND PBD.PriceId=B.PriceId
		WHERE BC.ListPrice=1
		GROUP BY B.Prdid,A.spmId,A.PurRetId,A.PurRetRefNo,PurRetDate,Prdccode,PrdName,PrdBatDetailValue,NetAmount
		
		UPDATE B SET OrgInvNo=CmpInvNo
		FROM #INVOICEDETAILS A INNER JOIN #PurchaseReturn B ON A.PurRetId=B.PurRetId
		
		INSERT INTO #EInvoice_PurchaseReturn(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,
		Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,SpmId,Salid,Prdid,StockType,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'DBN' as DTyp,PurRetRefNo as [No],PurRetDate as Dt,OrgInvNo,
		@DistGSTIN as [GSTIN],DistributorName as TrdNm,SUBSTRING(DistributorAdd1,1,60) as Bno,
		SUBSTRING(DistributorAdd2,1,60)  as Bnm,SUBSTRING(DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(ISNULL(PhoneNo,0),1,10) as Ph,''  as Em,
		'' as BGstin,SpmName as  BTrdNm,SUBSTRING(SpmAdd1,1,60) as BBno,SUBSTRING(SpmAdd2,1,60) as BBnm,SUBSTRING(SpmAdd3,1,60) as BFlno,'' as BLoc,
		'' as BDst,'' as BPin,'' as BStcd,SUBSTRING(SpmPhone,1,10) as BPh,'' as BEm,
		'' as ShipGstin,SpmName as ShipTrdNm,SUBSTRING(SpmAdd1,1,60) as ShipBno,SUBSTRING(SpmAdd2,1,60) as ShipBnm,SUBSTRING(SpmAdd3,1,60) as ShipFlno,'' as ShipLoc,'' as ShipDst,
		'' as ShipPin,'' as ShipStcd,SUBSTRING(SpmPhone,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRte as UnitPrice,PrdGrossAmount as TotAmt,ISNULL(Discounts,0) as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal,0 as StCesVal,0 as TCesNonAdVal,Discounts as Disc,0 as TOthChrg,PrdNetAmount as TotInvVal,
		3 as TransId,A.SpmId,PurRetId,Prdid,1,
		TaxPer as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,0 as RndOffAmt,
		NetAmount as TotInvValFc,SalPrdSlno as PrdSlno,0 as PreTaxVal
		FROM #PurchaseReturn A CROSS JOIN Distributor
		INNER JOIN Supplier S ON S.SpmId=A.SpmId
		

		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_PurchaseReturn B ON A.PrdId=B.Prdid 
		
		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'') FROM #SupplierGSTIN A INNER JOIN #EInvoice_PurchaseReturn B ON A.SpmId=B.SpmId
		
		UPDATE B SET BStcd=ISNULL(StateCode,''),ShipStcd=ISNULL(StateCode,''),BLoc=	StateName,
		ShipLoc=StateName,ExcelStateName=StateName			
		FROM #SupplierState A INNER JOIN #EInvoice_PurchaseReturn B ON A.Spmid=B.Spmid 

	
		UPDATE #EInvoice_PurchaseReturn SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #DistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #DistributorState)
		
		Delete From EInvoice_ErrorLog where ProcessName = 'Purchase Return'
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'Purchase Return','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_PurchaseReturn
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)
		
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'Purchase Return','HSN Code should be 8 digit' FROM #EInvoice_PurchaseReturn
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 and 8
		
		IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) Where ProcessName = 'Purchase Return')
		BEGIN
			SET @ErrorId =1
			SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
			RETURN
		END
	
		
		
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,PrdId,RtrId,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,ExcelTaxRate,
		ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,convert(varchar(10),dt, 111),OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Salid,
		StockType,PrdId,SpmId,'Debit Note' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal
		FROM #EInvoice_PurchaseReturn ORDER BY Dt,No
		--Added By Mohana For Excel  ( Murugan)
			SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_PurchaseReturn 
		GROUP BY No

		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'Purchase Return',ERROR_MESSAGE()
END CATCH		
		RETURN	
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptEInvoice_IDTSales')
DROP PROCEDURE Proc_RptEInvoice_IDTSales
GO
--EXEC Proc_RptEInvoice_IDTSales '2018-01-01','2020-01-01','Json',0,''
--SELECT * FROM IDTManagement
CREATE PROCEDURE [Proc_RptEInvoice_IDTSales]
(
	@FromDate AS DATETIME,
	@ToDate AS DATETIME,
	@Option AS VARCHAR(10),
	@ErrorId AS TinyInt OUTPUT,
	@ErrorMessage AS VARCHAR(MAX) OUTPUT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptEInvoice_IDTSales
* PURPOSE    : To Generate Einvoice-IDT Sales
* CREATED BY : Murugan.R
* CREATED ON : 23/01/2020
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION			
*  07/02/2020	  Deepak K		CR	   	CRCRSTMTR0036		   E- Invoice		
*************************************************
*/
BEGIN
SET NOCOUNT ON

	BEGIN TRY	
		SET @ErrorId =0
		SET @ErrorMessage =''
		CREATE TABLE #EInvoice_IDTSales
		(
			Catg Varchar(5),
			RegRev Varchar(4),
			Typ Varchar(5),
			EcmTrn Varchar(2),
			EcmGstin Varchar(20),
			DTyp Varchar(5),
			No Varchar(16),
			Dt DateTime,
			OrgInvNo Varchar(50),
			Gstin Varchar(15),
			TrdNm Varchar(100),
			Bno	Varchar(100),
			Bnm Varchar(100),
			Flno Varchar(100),
			Loc Varchar(100),
			Dst Varchar(100),
			Pin Varchar(6),
			Stcd Varchar(2),
			Ph Varchar(10),
			Em Varchar(50),
			BGstin Varchar(15),
			BTrdNm Varchar(100),
			BBno Varchar(100),
			BBnm Varchar(100),
			BFlno Varchar(100),
			BLoc Varchar(100),
			BDst Varchar(100),
			BPin Varchar(20),
			BStcd Varchar(2),
			BPh Varchar(10),
			BEm Varchar(50),
			ShipGstin Varchar(15),
			ShipTrdNm Varchar(100),
			ShipBno Varchar(100),
			ShipBnm Varchar(100),
			ShipFlno Varchar(100),
			ShipLoc Varchar(100),
			ShipDst Varchar(100),
			ShipPin Varchar(6),
			ShipStcd Varchar(2),
			ShipPh Varchar(10),
			ShipEm Varchar(50),
			PrdNm Varchar(100),
			PrdDesc Varchar(100),
			HsnCd Varchar(10),
			Barcde  Varchar(30),
			Qty  Numeric(18,2),
			FreeQty  Numeric(18,2),
			Unit  Varchar(3),
			UnitPrice Numeric(18,6),
			TotAmt Numeric(18,6),
			Discount Numeric(18,6),
			OthChrg Numeric(18,6),
			AssAmt Numeric(18,6),
			CgstRt Numeric(8,2),
			SgstRt  Numeric(8,2),
			IgstRt Numeric(8,2), 
			CesRt  Numeric(8,2),
			CesNonAdval  Numeric(8,2),
			StateCes  Numeric(8,2),  
			TotItemVal  Numeric(18,6),
			AssVal Numeric(18,6),
			CgstVal Numeric(18,6),
			SgstVal Numeric(18,6),
			IgstVal Numeric(18,6),
			CesVal Numeric(18,6),
			StCesVal Numeric(18,6),
			TCesNonAdVal Numeric(18,6),			
			Disc Numeric(18,6),
			TOthChrg Numeric(18,6),
			TotInvVal Numeric(18,6),
			TransId TINYINT,
			FromSpmId INT,
			ToSpmId INT,			
			Prdid INT,
			ExcelStateName Varchar(100),
			GstRt Numeric(8,2),
			OrdLineRef Varchar(50),
			OrgCntry Varchar(50),
			SellerState Varchar(100),
			IsService Varchar(2),
			RndOffAmt Numeric(18,2),
			TotInvValFc Numeric(18,2),
			PrdSlno INT,
			PreTaxVal Numeric(18,6)		
		)	


		DECLARE @DistGSTIN VARCHAR(50)
		DECLARE @DistGeoName Varchar(100)
		SELECT @DistGeoName=SUBSTRING(ISNULL(GeoName,''),1,60) 
		FROM Distributor A (NOLOCK) INNER JOIN Geography G (NOLOCK) ON G.GeoMainId=A.GeoMainId
		
		
				--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		
		
		SELECT DISTINCT  R.DistributorId as DistributorId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #FromDistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=16 and ColumnName='State Name'
		
		---HSN code
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
			
		--Distributor GSTIN
		SELECT UT.ColumnValue,R.SpmId
		INTO #Gtstin		
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMASTER R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId in (37,8) and ColumnName='GSTIN'
					
		SELECT DISTINCT  R.SpmId,TinFirst2Digit+'-'+StateName as StateName_code,
		TinFirst2Digit as StateCode,StateName
		INTO #DistributorState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMASTER R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=37 and ColumnName='State Name'

	
		---Sales B2B
		SELECT FromSpmId,ToSpmId,IDTMngRefNo,IDTMngDate,PrdSlno,MAX(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		CAST(0.00 AS NUMERIC(18,6)) as Discounts,
		IDTNetAmt
		INTO #IDTTax
		FROM(
		SELECT FromSpmId,ToSpmId,S.IDTMngRefNo,IDTMngDate,PrdSlno,TaxableAmount as TaxableAmount,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST') THEN SS.TaxAmount ELSE 0 END IGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST') THEN SS.TaxAmount ELSE 0 END CGSTTaxAmt,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST') THEN SS.TaxAmount ELSE 0 END SGSTTaxAmt,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess','InPutCess') THEN SS.TaxAmount ELSE 0 END CESSTaxAmt,
		CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST') THEN TaxPerc ELSE 0 END IGSTTaxper,
		CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST') THEN TaxPerc ELSE 0 END CGSTTaxPer,
		CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST') THEN TaxPerc ELSE 0 END SGSTTaxPer,
		CASE WHEN TaxCode IN('CESS','OutputCESS','GST CESS','GSTCESS','OutputGSTCess','KFCess','InputGSTCess','InPutCess') THEN TaxPerc ELSE 0 END CESSTaxPer,
		IDTNetAmt
		FROM IDTManagement S (NOLOCK) 
		INNER JOIN IDTManagementproducttax SS (NOLOCK) ON S.IDTMngRefNo=SS.IDTMngRefNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SS.TaxId
		WHERE Status=1 
		and IDTMngDate between @FromDate and @ToDate
		and StkMgmtTypeId=2
		and TaxableAmount>0
		)X GROUP BY FromSpmId,ToSpmId,IDTMngRefNo,IDTMngDate,PrdSlno,IDTNetAmt
		ORDER BY IDTMngRefNo
		
			
		SELECT A.IDTMngRefNo,PrdSlno,SUM(LineBaseQtyAmount) as Discounts 
		INTO #IDTDiscounts
		FROM IDTManagement A (NOLOCK)
		INNER JOIN IDTManagementLineAmount B (NOLOCK)ON A.IDTMngRefNo=B.IDTMngRefNo
		WHERE Status=1 
		and IDTMngDate between @FromDate and @ToDate
		and StkMgmtTypeId=2 and RefCode IN('E','F')
		GROUP BY A.IDTMngRefNo,PrdSlno
		
		UPDATE A SET A.Discounts=B.Discounts FROM #IDTTax A INNER JOIN #IDTDiscounts B ON A.IDTMngRefNo=B.IDTMngRefNo
		AND A.PrdSlno=B.PrdSlno
	
		

		SELECT B.Prdid,FromSpmId,ToSpmId,A.IDTMngRefNo,IDTMngDate,Prdccode,PrdName,SUM(Qty) as baseQty,PrdBatDetailValue as PrdUnitSelRte,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmt) as IGSTTaxAmt,SUM(CGSTTaxAmt) as CGSTTaxAmt,SUM(SGSTTaxAmt) as SGSTTaxAmt,
		SUM(CESSTaxAmt) as CESSTaxAmt,
		MAX(IGSTTaxper)+MAX(CGSTTaxPer)+MAX(SGSTTaxPer) as TaxPer,
		MAX(IGSTTaxper) as IGSTTaxper,MAX(CGSTTaxPer) as CGSTTaxPer,MAX(SGSTTaxPer) as SGSTTaxPer,
		MAX(CESSTaxPer) as CESSTaxPer,
		SUM(PrdNetAmount) as PrdNetAmount,
		SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ISNULL(A.Discounts,0)) as Discounts,
		CAST('' as Varchar(50)) as OrgInvNo,
		ROW_NUMBER()OVER(PARTITION BY A.IDTMngRefNo Order by Max(B.PrdSlNo)) as SalPrdSlno,
		IDTNetAmt
		INTO #IDTSales
		FROM #IDTTax A INNER JOIN IDTManagementproduct B (NOLOCK) ON A.IDTMngRefNo=B.IDTMngRefNo
		AND A.Prdslno=B.Prdslno
		INNER JOIN Product C (NOLOCK) ON C.PrdId=B.Prdid
		INNER JOIN Productbatch PB (NOLOCK) ON C.PrdId=PB.PrdId and  B.Prdid=PB.Prdid and PB.PrdBatId=B.PrdBatId
		INNER JOIN BatchCreation BC (NOLOCK) ON  BC.BatchSeqId=PB.BatchSeqId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON BC.BatchSeqId=PBD.BatchSeqId AND PB.BatchSeqId=PBD.BatchSeqId
		AND PBD.PrdBatId=B.PrdBatId and PBD.PrdBatId=PB.PrdBatId and BC.SlNo=PBD.SLNo
		AND PBD.PriceId=B.PriceId
		WHERE BC.ListPrice=1
		GROUP BY B.Prdid,FromSpmId,ToSpmId,A.IDTMngRefNo,IDTMngDate,Prdccode,PrdName,PrdBatDetailValue,IDTNetAmt
		
			
		INSERT INTO #EInvoice_IDTSales(Catg,RegRev,Typ,EcmTrn,EcmGstin,
		DTyp,No,Dt,OrgInvNo,
		Gstin,TrdNm,Bno,Bnm,Flno,Loc,Dst,Pin,Stcd,Ph,Em,
		BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,BPin,BStcd,BPh,BEm,
		ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,
		TransId,FromSpmId,ToSpmId,Prdid,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)	
		SELECT 'B2B' as Catg,'N' as RegRev,'REG' as Typ,'N' as EcmTrn,'' as EcmGstin,
		'INV' as DTyp,IDTMngRefNo as [No],IDTMngDate as Dt,OrgInvNo,		
		@DistGSTIN as [GSTIN],B.DistributorName as TrdNm,SUBSTRING(B.DistributorAdd1,1,60) as Bno,SUBSTRING(B.DistributorAdd2,1,60) as Bnm,SUBSTRING(B.DistributorAdd3,1,60) as Flno,'' as Loc,'' as Dst,SUBSTRING(B.PinCode,1,6) as Pin,'' as Stcd, SUBSTRING(B.PhoneNo,1,10) as Ph,'' as Em,
		'' as BGstin,C.SpmName as  BTrdNm,SUBSTRING(C.SpmAdd1,1,60) as BBno,SUBSTRING(C.SpmAdd2,1,60) as BBnm,SUBSTRING(C.SpmAdd3,1,60) as BFlno,'' as BLoc,'' as BDst,'' as BPin,'' as BStcd,
		SUBSTRING(C.SpmPhone,1,10) as BPh,'' as BEm,
		'' as ShipGstin,C.SpmName as ShipTrdNm,SUBSTRING(C.SpmAdd1,1,60)as ShipBno,SUBSTRING(C.SpmAdd2,1,60) as ShipBnm,SUBSTRING(C.SpmAdd3,1,60) as ShipFlno,'' as ShipLoc,'' as ShipDst,
		'' as ShipPin,'' as ShipStcd,SUBSTRING(C.SpmPhone,1,10) as ShipPh,'' as ShipEm,
		PrdName as PrdNm,PrdName as PrdDesc,'' as HsnCd,'' as Barcde,baseQty as Qty,0 as FreeQty,'PCS' as Unit,
		PrdUnitSelRte as UnitPrice,PrdGrossAmount as TotAmt,Discounts as Discount,0 as OthChrg,TaxableAmount as AssAmt,
		CGSTTaxPer as CgstRt,SGSTTaxPer as SgstRt,IGSTTaxper as IgstRt,CESSTaxPer as CesRt,
		0 as CesNonAdval,0 as StateCes,PrdNetAmount as TotItemVal,
		TaxableAmount as AssVal,CGSTTaxAmt as CgstVal,SGSTTaxAmt as SgstVal,IGSTTaxAmt as IgstVal,
		CESSTaxAmt as CesVal,0 as StCesVal,0 as TCesNonAdVal,Discounts as Disc,0 as TOthChrg,PrdNetAmount as TotInvVal,
		4 as TransId,FromSpmId,ToSpmId,Prdid,
		TaxPer as GstRt,'' as OrdLineRef,'IN' as OrgCntry,'' as SellerState,'N' as IsService,0 as RndOffAmt,
		IDTNetAmt as TotInvValFc,SalPrdSlno as PrdSlno	,0 as PreTaxVal	
		FROM #IDTSales A 
		INNER JOIN Distributor B (NOLOCK) ON A.FromSpmId=B.DistributorId
		INNER JOIN IDTMASTER C (NOLOCK) ON A.ToSpmId=C.SpmId
		
	
		
	
		
		
		

		UPDATE B SET HsnCd=REPLACE(REPLACE(ISNULL(HSNCode,''),' ',''),'.','') FROM #ProductHsnCode A (NOLOCK) INNER JOIN #EInvoice_IDTSales B ON A.PrdId=B.Prdid 
		
	
		
		UPDATE B SET BGstin=ISNULL(ColumnValue,''),ShipGstin=ISNULL(ColumnValue,'')		
		FROM #Gtstin A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.ToSpmId

		UPDATE B SET Stcd=ISNULL(StateCode,''),BLoc=SUBSTRING(StateName,1,60),ShipLoc=SUBSTRING(StateName,1,60)	 FROM #DistributorState A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.FromSpmId
		
		UPDATE B SET BStcd=ISNULL(StateCode,''),ShipStcd=ISNULL(StateCode,''),
		ExcelStateName=ISNULL(StateName,'')
		FROM #DistributorState A INNER JOIN #EInvoice_IDTSales B ON A.SpmId=B.ToSpmId
		
		UPDATE #EInvoice_IDTSales SET Stcd=(SELECT ISNULL(StateCode,'')	FROM #FromDistributorState),
		Loc=@DistGeoName,SellerState=(SELECT ISNULL(StateName,'')	FROM #FromDistributorState)
		
		--INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
	
		
		--INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		--SELECT DISTINCT 3,'Sales Invoice','HSN Code should be 8 digit' FROM #EInvoice_IDTSales
		--WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 AND 8
		
		--IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK))
		--BEGIN
		--	SET @ErrorId =1
		--	SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
		--	RETURN
		--END
		Delete From EInvoice_ErrorLog where ProcessName = 'IDT Sales'

		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 2,'IDT Sales','Seller or Buyer GSTIN should be 15 digit' FROM #EInvoice_IDTSales
		WHERE (LEN(RTRIM(LTRIM(ISNULL(BGstin,''))))<>15 OR	LEN(RTRIM(LTRIM(ISNULL(Gstin,''))))<>15)

		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT DISTINCT 3,'IDT Sales','HSN Code should be 8 digit' FROM #EInvoice_IDTSales
		WHERE LEN(RTRIM(LTRIM(ISNULL(HsnCd,'')))) NOT BETWEEN 4 AND 8
		
		
							
		IF EXISTS(SELECT 'X' FROM EInvoice_ErrorLog (NOLOCK) Where ProcessName = 'IDT Sales')
		BEGIN
			SET @ErrorId =1
			SET @ErrorMessage ='Erro in E-invoice generation, Please check the error log'		
			RETURN
		END
		
		
		INSERT INTO RptEInvoice_Sales(Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No,Dt,OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,Loc,Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,Invoice_Id,StockType,PrdId,RtrId,ExcelInvoiceType,ExcelSubCategory,ExcelEcomTran,ExcelTaxRate,
		ExcelUnits,ExcelStateName,GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal)
		SELECT Catg,RegRev,Typ,EcmTrn,EcmGstin,DTyp,No, convert(varchar(10),dt, 111),OrgInvNo,Gstin,TrdNm,Bno,Bnm,
		Flno,ISNULL(Loc,''),Dst,Pin,Stcd,Ph,Em,BGstin,BTrdNm,BBno,BBnm,BFlno,BLoc,BDst,
		BPin,BStcd,BPh,BEm,ShipGstin,ShipTrdNm,ShipBno,ShipBnm,ShipFlno,ShipLoc,ShipDst,
		ShipPin,ShipStcd,ShipPh,ShipEm,
		PrdNm,PrdDesc,HsnCd,Barcde,Qty,FreeQty,Unit,
		UnitPrice,TotAmt,Discount,OthChrg,AssAmt,CgstRt,SgstRt,IgstRt,CesRt,
		CesNonAdval,StateCes,TotItemVal,
		AssVal,CgstVal,SgstVal,IgstVal,CesVal,StCesVal,TCesNonAdVal,Disc,TOthChrg,TotInvVal,TransId,0,1,Prdid,FromSpmId,'Tax Invoice' as ExcelInvoiceType,'Regular' as ExcelSubCategory,'No' as ExcelEcomTran,
		CAST(SgstRt as Varchar(10))+'+'+ CAST(CgstRt as Varchar(10))+'+'+ 
		CAST(IgstRt as Varchar(10))+'+'+CAST(CesRt as Varchar(10)) as  ExcelTaxRate,
		'PIECES' as ExcelUnits,ExcelStateName,
		GstRt,OrdLineRef,OrgCntry,SellerState,IsService,RndOffAmt,TotInvValFc,PrdSlno,PreTaxVal
		FROM #EInvoice_IDTSales ORDER BY Dt,No
		
		--Added By Mohana For Excel  ( Murugan)
		SELECT No,SUM(AssVal) as AssVal,
		SUM(CgstVal) as CgstVal,SUM(SgstVal) as SgstVal,SUM(IgstVal) as IgstVal,SUM(CesVal) as CesVal,
		SUM(StCesVal) as StCesVal,SUM(TCesNonAdVal) as TCesNonAdVal,SUM(Disc) as Disc,SUM(TOthChrg) as TOthChrg,
		SUM(TotInvVal) as TotInvVal
		INTO #SalesSummary
		FROM #EInvoice_IDTSales 
		GROUP BY No

		UPDATE A SET ExcelAssVal=B.AssVal,
		ExcelCgstVal=B.CgstVal,ExcelSgstVal=B.SgstVal,ExcelIgstVal=B.IgstVal,ExcelCesVal=B.CesVal,
		ExcelStCesVal=B.StCesVal,
		ExcelTCesNonAdVal=B.TCesNonAdVal,ExcelDisc=B.Disc,ExcelTOthChrg=B.TOthChrg,ExcelTotInvVal=B.TotInvVal
		FROM RptEInvoice_Sales a INNER JOIN #SalesSummary B ON A.No=B.No
		
		IF UPPER(@Option)='IRP'
		BEGIN
			DELETE A FROM RptEInvoice_Sales A WHERE EXISTS(SELECT TransId,Invoice_Id,Invoice_no FROM EInvoice_Acknowledgment B
			WHERE A.TransId=B.TransId and A.No=B.Invoice_no and Response_Status=1)
		END
END TRY
BEGIN CATCH			
		SET @ErrorId =1
		SET @ErrorMessage =ERROR_MESSAGE()
		INSERT INTO EInvoice_ErrorLog(SLNO,ProcessName,ErrorDesc)
		SELECT 0,'IDT Sales',ERROR_MESSAGE()		
END CATCH		
		RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'P' AND NAME = 'Proc_GetDataSetInvoice')
DROP PROCEDURE Proc_GetDataSetInvoice
GO
CREATE PROCEDURE Proc_GetDataSetInvoice
@typeid int = 0,
@InvoiceNum varchar(100) = '',
@Processid int = 0,
@tablename varchar(200) = ''
AS
/*

    //  Created Date :     15-02-2020          
    //  Created By   :     SIVA                             
    //  Description  :               
    //  PMS Number   :    ILCONSAML5704                       
    //  CR NUmber    : 
    
    //------------------------------------------------------------------------------------
    // Modify Date       Edited By         CR/BZ        Change Description
    //------------------------------------------------------------------------------------
    //------------------------------------------------------------------------------------


*/
BEGIN

	IF @TYPEID = 1
	BEGIN

	        CREATE TABLE #temp_EInvoiceColumn
			(
			  id INT IDENTITY ,
			  Nodeid INT ,
			  TransType VARCHAR(50)
			 )

	         INSERT INTO #temp_EInvoiceColumn(Nodeid, TransType)
			 SELECT  DISTINCT Nodeid ,TransType   FROM EInvoice_Columns(NOLOCK)   WHERE  ColRequired=1 

			  SELECT id,Nodeid ,TransType   FROM #temp_EInvoiceColumn    ----ALWAYS KEEP THIS AS FIRST TABLE                                                       

			 Select distinct TransType,NodeId into #ETransType from EInvoice_Columns(Nolock)   Where  ColRequired=1 Order by NodeId 

			 select '''SELECT DBO.Fn_ReturnEinvoceQuery(''''' + TransType +''''','+CONVERT (varchar(20), @Processid)+','''''+@InvoiceNum +''''', ''''RptEInvoice_Sales'''',''''JSON'''')''' as StrQuery 
			 into  #ETransType3 from #ETransType 

			 
			 select 'Exec('+StrQuery +')' as StrQuery into #ETransType4  from #ETransType3 

		 
			 CREATE TABLE #tbl_query
			 (
				strquery varchar(max)
			 )

			 DECLARE @listStr nVARCHAR(MAX)
			SELECT @listStr = COALESCE(@listStr+' ' ,'') + StrQuery
			FROM #ETransType4

			insert into #tbl_query
			Execute sp_executesql @listStr


			DECLARE @listStr2 nVARCHAR(MAX)
			
			select @listStr2 =  COALESCE(@listStr2+' ' ,'') + StrQuery from #tbl_query
			--select @listStr

			Exec(@listStr2)


			

	END
	IF @TYPEID = 2
	BEGIN

		Select   distinct No as InvoiceNumber from RptEInvoice_Sales (Nolock) where TransId = @Processid 

	END
	IF @TYPEID = 3
	BEGIN      
		select SequenceNo , ProcessName , TableName ,SPName  from Tbl_EInvoiceIntegration (Nolock) Where Active =1
	END
	IF @TYPEID = 4   --// export to csv resultset
	BEGIN

		DECLARE @strQuery nvarchar(max) = ''
		set @strQuery =  DBO.Fn_ReturnEinvoceQuery('','','','RptEInvoice_Sales','CSV')  

		EXEC  sp_executesql @strQuery 
		--select @strQuery
	END
	IF @TYPEID = 5   --// TRUNCATE TABLE 
	BEGIN

		declare @tablename4 varchar(max) = '';

				set  @tablename4 = (select  Distinct TableName   from Tbl_EInvoiceIntegration (Nolock) Where Active =1 )

				--select * from RptEInvoice_Sales

		declare @strsql4  nvarchar(max) = ''
		set @strsql4  = 'Truncate table '+@tablename4
		exec sp_executesql @strsql4


	END

	if @TYPEID = 6  -- Header Node as Default
	begin
	SELECT   'http://json-schema.org/draft-04/schema#' AS [$schema],
             'GST-India Invoice Document' AS Title ,
             'GST Invoice format for IRN Generation in INDIA' AS Description,
             '1.00' AS Version
	end
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='EInvoice_Acknowledgment')
BEGIN
CREATE TABLE EInvoice_Acknowledgment
(
    TransId            TINYINT,
    Invoice_Id      BIGINT,
    Invoice_no  Varchar(50),
    Invoice_date Datetime,
    Ack_Number Varchar(200),
    Ack_Date Datetime,
    Irn Varchar(100),
    SignedInvoice Varchar(8000),
    SignedQRCode Varchar(8000),
    Ack_Status varchar(20),
    Response_Status TINYINT,
    Err_code Varchar(50),
    Err_desc Varchar(5000),
    Lastmoddate Datetime,
    MovedOnDate Datetime,
    CONSTRAINT PK_EInvoice_Acknowledgment PRIMARY KEY CLUSTERED 
    (
    TransId,Invoice_Id,Invoice_no ASC
    )
)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='Irn' )
BEGIN
ALTER TABLE RptBillTemplateFinal ADD Irn Varchar(100) 
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedInvoice' )
BEGIN
ALTER TABLE RptBillTemplateFinal ADD SignedInvoice Varchar(8000)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedQRCode' )
BEGIN
ALTER TABLE RptBillTemplateFinal ADD SignedQRCode Varchar(8000)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='TCSLineLevelTax' )
BEGIN
ALTER TABLE RptBillTemplateFinal ADD TCSLineLevelTax Numeric(18,6)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='TCSHeadLevelTax' )
BEGIN
ALTER TABLE RptBillTemplateFinal ADD TCSHeadLevelTax Numeric(18,6) 
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Name='Proc_RptBillTemplateFinal' and Xtype='P')
DROP PROCEDURE Proc_RptBillTemplateFinal
GO
-- EXEC PROC_RptBillTemplateFinal 16,1,0,'BILLPrintissue03012018',0,0,1,'RPTBT_VIEW_FINAL1_BILLTEMPLATE'           
CREATE PROCEDURE Proc_RptBillTemplateFinal
(      
	 @Pi_RptId  INT,      
	 @Pi_UsrId  INT,      
	 @Pi_SnapId  INT,      
	 @Pi_DbName  NVARCHAR(50),      
	 @Pi_SnapRequired INT,      
	 @Pi_GetFromSnap  INT,      
	 @Pi_CurrencyId  INT,      
	 @Pi_BTTblName    NVARCHAR(50)      
)      
AS      
/***************************************************************************************************      
* PROCEDURE : Proc_RptBillTemplateFinal      
* PURPOSE : General Procedure      
* NOTES  :        
* CREATED :      
* MODIFIED      
* DATE       AUTHOR     DESCRIPTION      
----------------------------------------------------------------------------------------------------      
* 01.10.2009  Panneer      Added Tax summary Report Part(UserId Condition)      
* 10/07/2015  PRAVEENRAJ BHASKARAN     Added Grammge For Parle  
* DATE       AUTHOR				CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  10-01-2018  LAKSHMAN			BZ     ICRSTPAR7339             Bill Print Allot ment Issue
  11-04-2019  Lakshman M		SR     ILCRSTPAR4044            product default price new column added
  16/03/2020  MarySubashini.S   SR     ILCRSTPAR8294            TCS Tax Column added            
****************************************************************************************************/      
SET NOCOUNT ON      
BEGIN      
	 --Added By Murugan 04/09/2009      
	 DECLARE @FieldCount AS INT      
	 DECLARE @UomStatus AS INT       
	 DECLARE @UOMCODE AS nVARCHAR(25)      
	 DECLARE @pUOMID as INT      
	 DECLARE @UomFieldList as nVARCHAR(3000)      
	 DECLARE @UomFields as nVARCHAR(3000)      
	 DECLARE @UomFields1 as nVARCHAR(3000)      
	 --END      
	 DECLARE @NewSnapId  AS INT      
	 DECLARE @DBNAME  AS  nvarchar(50)      
	 DECLARE @TblName  AS nvarchar(500)      
	 DECLARE @TblStruct  AS nVarchar(4000)      
	 DECLARE @TblFields  AS nVarchar(4000)      
	 DECLARE @sSql  AS  nVarChar(4000)      
	 DECLARE @ErrNo   AS INT      
	 DECLARE @PurDBName AS nVarChar(50)      
	 Declare @Sub_Val  AS TINYINT      
	 DECLARE @FromDate AS DATETIME      
	 DECLARE @ToDate   AS DATETIME      
	 DECLARE @FromBillNo  AS   BIGINT      
	 DECLARE @TOBillNo    AS   BIGINT      
	 DECLARE @SMId   AS INT      
	 DECLARE @RMId   AS INT      
	 DECLARE @RtrId   AS INT      
	 DECLARE @vFieldName    AS nvarchar(255)      
	 DECLARE @vFieldType AS nvarchar(10)      
	 DECLARE @vFieldLength as nvarchar(10)      
	 DECLARE @FieldList as      nvarchar(4000)      
	 DECLARE @FieldTypeList as varchar(8000)      
	 DECLARE @FieldTypeList2 as varchar(8000)      
	 DECLARE @DeliveredBill  AS INT      
	 DECLARE @SSQL1 AS NVARCHAR(4000)      
	 DECLARE @FieldList1 as      nvarchar(4000)      
	 --For B&L Bill Print Configurtion      
	 SELECT @DeliveredBill=Status FROM  Configuration WHERE ModuleName='Discount & Tax Collection' AND ModuleId='DISTAXCOLL5'      
	IF @DeliveredBill=1      
	BEGIN        
		DELETE FROM RptBillToPrint WHERE [Bill Number] IN(      
		SELECT SalInvNo FROM SalesInvoice WHERE DlvSts NOT IN(4,5))      
	END      
	 --Till Here      
	 --Added By Murugan 04/09/2009      
	 --print @Pi_BTTblName      
	 SET @FieldCount=0      
	 SELECT @UomStatus=Isnull(Status,0) FROM configuration  WHERE ModuleName='General Configuration' and ModuleId='GENCONFIG22' and SeqNo=22      
	 --Till Here      
	 SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))      
	 SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))      
	 DECLARE CurField CURSOR FOR      
	 SELECT sc.name fieldname,st.name fieldtype,sc.length FROM syscolumns sc, systypes st      
	 WHERE sc.id in (SELECT id FROM sysobjects WHERE name like @Pi_BTTblName )      
	 and sc.xtype = st.xtype      
	 and sc.xusertype = st.xusertype      
	 Set @FieldList = ''      
	 Set @FieldTypeList = ''
	       
	 OPEN CurField      
		FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
		WHILE @@Fetch_Status = 0      
		BEGIN      
			if len(@FieldTypeList) > 3060      
			BEGIN      
				Set @FieldTypeList2 = @FieldTypeList      
				Set @FieldTypeList = ''      
			end      
			--->Added By Nanda on 12/03/2010      
			IF LEN(@FieldList)>3060      
			BEGIN      
				SET @FieldList1=@FieldList      
				SET @FieldList=''    
			END      
			--->Till Here      
			if @vFieldName = 'UsrId'      
			BEGIN      
				Set @FieldList = @FieldList  + 'V.[' + @vFieldName + '] , '      
			end      
			else      
			BEGIN      
				Set @FieldList = @FieldList + '[' + @vFieldName + '] , '      
			end      
			if @vFieldType = 'nvarchar' or @vFieldType = 'varchar' or @vFieldType = 'char'      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(' + @vFieldLength + ')' + ','      
			end      
			else if @vFieldType = 'numeric'      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(38,2)' + ','      
			end      
			else      
			BEGIN      
				Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + ','      
			end      
			FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
		END      
	 Set @FieldList = left(@FieldList,len(@FieldList)-1)      
	 Set @FieldTypeList = left(@FieldTypeList,len(@FieldTypeList)-1)      
	 CLOSE CurField      
	 DEALLOCATE CurField      
	 --Added by Murugan UomCoversion 04/09/2009      
	IF @UomStatus=1      
	BEGIN       
		TRUNCATE TABLE BillTemplateUomBased       
		SET @UomFieldList=''      
		SET @UomFields=''      
		SET @UomFields1=''      
		SET @FieldCount= @FieldCount+1 
		  
		DECLARE CUR_UOM CURSOR      
		FOR SELECT UOMID,UOMCODE FROM UOMMASTER  Order BY UOMID      
		OPEN CUR_UOM      
		FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
		WHILE @@FETCH_STATUS=0      
		BEGIN      
			SET @FieldCount= @FieldCount+1      
			SET @UomFieldList=@UomFieldList+'['+@UOMCODE +'] INT,'      
			SET @UomFields=@UomFields+'0 AS ['+@UOMCODE +'],'      
			SET @UomFields1=@UomFields1+'['+@UOMCODE +'],'       
			INSERT INTO BillTemplateUomBased(ColId,UOMID,UomCode)      
			VALUES (@FieldCount,@pUOMID,@UOMCODE)  
			    
			FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
		END       
		CLOSE CUR_UOM      
		DEALLOCATE CUR_UOM      
		
		SET @UomFieldList= subString(@UomFieldList,1,Len(Ltrim(rtrim(@UomFieldList)))-1)      
		SET @UomFields= subString(@UomFields,1,Len(Ltrim(rtrim(@UomFields)))-1)      
		SET @UomFields1= subString(@UomFields1,1,Len(Ltrim(rtrim(@UomFields1)))-1)        
	END      
	 -----      
	 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)      
	if EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[RptBillTemplateFinal]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)      
	drop table [RptBillTemplateFinal]      
	IF @UomStatus=1      
	BEGIN       
		EXEC('CREATE TABLE RptBillTemplateFinal      
		(' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500),'+ @UomFieldList +')')      
	END      
	ELSE      
	BEGIN      
		EXEC('CREATE TABLE RptBillTemplateFinal      
		(' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500))')      
	END      
	SET @TblName = 'RptBillTemplateFinal'      
	SET @TblStruct = @FieldTypeList2 + @FieldTypeList      
	SET @TblFields = @FieldTypeList2 + @FieldTypeList     
	 
	IF @Pi_GetFromSnap = 1      
	BEGIN      
		SELECT @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId      
		SET @DBNAME =   @DBNAME      
	END      
	ELSE      
	BEGIN      
		SELECT @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3      
		SET @DBNAME = @PI_DBNAME + @DBNAME      
	END      
	--Nanda01      
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data      
	BEGIN      
		DELETE FROM RptBillTemplateFinal WHERE UsrId = @Pi_UsrId      
		IF @UomStatus=1      
		BEGIN      
			EXEC ('INSERT INTO RptBillTemplateFinal (' + @FieldList1+@FieldList + ','+ @UomFields1 + ')' +      
			'SELECT  DISTINCT' + @FieldList1+@FieldList +','+ @UomFields+'  FROM ' + @Pi_BTTblName + ' V,RptBillToPrint T WHERE V.[Sales Invoice Number] = T.[Bill Number]')      
		END      
		ELSE      
		BEGIN      
			--SELECT 'Nanda002'       
			Exec ('INSERT INTO RptBillTemplateFinal (' +@FieldList1+ @FieldList + ')' +      
			'SELECT  DISTINCT' + @FieldList1+ @FieldList + '  FROM ' + @Pi_BTTblName + ' V,RptBillToPrint T WHERE V.[Sales Invoice Number] = T.[Bill Number]')      
		END      
		IF LEN(@PurDBName) > 0      
		BEGIN      
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT      
			SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
			'(' + @TblFields + ')' +      
			' SELECT DISTINCT' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName + ' WHERE UsrId = ' + @Pi_UsrId      
			EXEC (@SSQL)      
			PRINT @SSQL      
			PRINT 'Retrived Data FROM Purged Table'      
		END      
		IF @Pi_SnapRequired = 1      
		BEGIN      
			SELECT @NewSnapId = @Pi_SnapId      
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
			IF @ErrNo = 0      
			BEGIN      
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +      
				'(SnapId,UserId,RptId,' + @TblFields + ')' +      
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +      
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM RptBillTemplateFinal'      
				EXEC (@SSQL)      
				PRINT 'Saved Data Into SnapShot Table'      
			END      
		END      
	END      
	--Nanda02      
	ELSE    --To Retrieve Data FROM Snap Data      
	BEGIN      
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
		PRINT @ErrNo      
		IF @ErrNo = 0      
		BEGIN      
			SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
			'(' + @TblFields + ')' +      
			' SELECT DISTINCT' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +      
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +      
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))      
			EXEC (@SSQL)      
			PRINT 'Retrived Data FROM Snap Shot Table'      
		END      
		ELSE      
			BEGIN      
			PRINT 'DataBase or Table not Found'      
		END      
	END      
	 --Update SplitUp Tax Amount & Perc      
	IF @UomStatus=1      
	BEGIN       
		EXEC Proc_BillTemplateUOM @Pi_UsrId      
	END      
	-- EXEC Proc_BillPrintingTax @Pi_UsrId      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 1')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 1]=BillPrintTaxTemp.[Tax1Perc]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount1')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount1]=BillPrintTaxTemp.[Tax1Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 2')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 2]=BillPrintTaxTemp.[Tax2Perc],[RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount2')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 3')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 3]=BillPrintTaxTemp.[Tax3Perc]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount3')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount3] =BillPrintTaxTemp.[Tax3Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 4')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 4]=BillPrintTaxTemp.[Tax4Perc],[RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END    
		  
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount4')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax 5')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 5]=BillPrintTaxTemp.[Tax5Perc],[RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Tax Amount5')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
			FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
			AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
			EXEC (@SSQL1)  
		END      
		--Till Here      
		--- Sl No added  ---      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product SL No')      
		BEGIN      
			SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Product SL No]=SalesInvoiceProduct.[SlNo]      
			FROM SalesInvoiceProduct,Product,ProductBatch WHERE [RptBillTemplateFinal].SalId=SalesInvoiceProduct.[SalId] AND [RptBillTemplateFinal].[Product Code]=Product.[PrdCCode]      
			AND Product.Prdid=SalesInvoiceProduct.prdid      
			And ProductBatch.Prdid=Product.Prdid and ProductBatch.PrdBatid=SalesInvoiceProduct.PrdBatId      
			AND [RptBillTemplateFinal].[Batch Code] =ProductBatch.[PrdBatCode]'      
			EXEC (@SSQL1)      
		END       
	 --- End Sl No      
	 --->Added By Nanda on 2011/02/24 for Henkel      
		IF NOT EXISTS (SELECT Id,name FROM Syscolumns WHERE name = 'Product Weight' and id in (SELECT id FROM       
		Sysobjects WHERE name ='RptBillTemplateFinal'))      
		BEGIN      
			ALTER TABLE [dbo].[RptBillTemplateFinal]      
			ADD [Product Weight] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
		END      
		IF NOT EXISTS (SELECT Id,name FROM Syscolumns WHERE name = 'Product UPC' and id in (SELECT id FROM       
		Sysobjects WHERE name ='RptBillTemplateFinal'))      
		BEGIN      
			ALTER TABLE [dbo].[RptBillTemplateFinal]      
			ADD [Product UPC] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD GSTTIN VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Pan Number] VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Retailer Type] VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='Composite')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD Composite VARCHAR(50) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD RelatedParty VARCHAR(50) DEFAULT '' WITH VALUES      
		END
		      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [State Name] VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [State Code] VARCHAR(10) DEFAULT '' WITH VALUES      
		END 
		     
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [StateTinNo] VARCHAR(10) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD HSNCode VARCHAR(100) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD HSNDescription VARCHAR(100) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorGstTin VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateName VARCHAR(50) DEFAULT '' WITH VALUES      
		END 
		     
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Distributor Type] VARCHAR(50) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD AadharNo VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateCode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateCode VARCHAR(10) DEFAULT '' WITH VALUES      
		END  
		    
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateTinNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD DistributorStateTinNo VARCHAR(10) DEFAULT '' WITH VALUES      
		END        
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Dist Food Lic No] VARCHAR(50) DEFAULT '' WITH VALUES      
		END   
		   
		IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Dist Drug Lic no] VARCHAR(50) DEFAULT '' WITH VALUES      
		END      
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='SalesInvoice NetAmount Actual')      
		BEGIN      
			ALTER  TABLE RptBillTemplateFinal ADD [SalesInvoice NetAmount Actual] Numeric(18,2)      
		END    
		  
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product Weight')      
		BEGIN      
			SET @SSQL1='UPDATE Rpt SET Rpt.[Product Weight]=P.PrdWgt*(CASE P.PrdUnitId WHEN 2 THEN Rpt.[Base Qty]/1000 ELSE Rpt.[Base Qty] END)      
			FROM Product P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code] AND P.PrdUnitId IN (2,3)'      
			EXEC (@SSQL1)      
		END      
		IF EXISTS(SELECT Name FROM dbo.sysColumns WHERE id = object_id(N'RptBillTemplateFinal') and name='Product UPC')      
		BEGIN      
			SET @SSQL1='UPDATE Rpt SET Rpt.[Product UPC]=Rpt.[Base Qty]/P.ConversionFactor       
			FROM       
			(      
			SELECT P.PrdId,P.PrdCCode,MAX(U.ConversionFactor)AS ConversionFactor FROM Product P,UOMGroup U      
			WHERE P.UOMGroupId=U.UOMGroupId      
			GROUP BY P.PrdId,P.PrdCCode      
			) P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code]'      
			EXEC (@SSQL1)      
		END      
	 --->Till Here      
	 --Check for Report Data      
	 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId      
	 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
	 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptBillTemplateFinal      
	 -- Till Here      
	 DELETE FROM RptBillTemplate_Tax WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Other WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Replacement WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_CrDbAdjustment WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_MarketReturn WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_SampleIssue WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_Scheme WHERE UsrId = @Pi_UsrId      
	 DELETE FROM RptBillTemplate_PrdUOMDetails WHERE UsrId = @Pi_UsrId      
	 ---------------------------------TAX (SubReport)      
	-- SELECT @Sub_Val = TaxDt  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	-- If @Sub_Val = 1      
	-- BEGIN      
	  DELETE FROM RptBillTemplate_Tax WHERE UsrId = @Pi_UsrId          
	  INSERT INTO RptBillTemplate_Tax(SalId,SalInvNo,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
	  SELECT SI.SalId,S.SalInvNo,0,SI.TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmount),SUM(TaxAmount),@Pi_UsrId      
	  FROM SalesInvoiceProductTax SI , TaxConfiguration T,SalesInvoice S,RptBillToPrint B      
	  WHERE SI.TaxId = T.TaxId and SI.SalId = S.SalId and S.SalInvNo = B.[Bill Number] and B.UsrId = @Pi_UsrId      
	  GROUP BY SI.SalId,S.SalInvNo,SI.TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmount) > 0 --Muthuvel      
	-- End      
	 ------------------------------ Other      
	 --SELECT @Sub_Val = OtherCharges FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_Other WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_Other(SalId,SalInvNo,AccDescId,Description,Effect,Amount,UsrId)      
	  SELECT SI.SalId,S.SalInvNo,      
	  SI.AccDescId,P.Description,Case P.Effect When 0 Then 'Add' else 'Reduce' End Effect,      
	  Adjamt Amount,@Pi_UsrId      
	  FROM SalInvOtherAdj SI,PurSalAccConfig P,SalesInvoice S,RptBillToPrint B      
	  WHERE P.TransactionId = 2      
	  and SI.AccDescId = P.AccDescId      
	  and SI.SalId = S.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	 --End      
	 ---------------------------------------Replacement      
	 --SELECT @Sub_Val = Replacement FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_Replacement WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_Replacement(SalId,SalInvNo,RepRefNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Rate,Tax,Amount,UsrId)      
	  SELECT H.SalId,SI.SalInvNo,H.RepRefNo,D.PrdId,P.PrdName,D.PrdBatId,PB.PrdBatCode,RepQty,SelRte,Tax,RepAmount,@Pi_UsrId      
	  FROM ReplacementHd H, ReplacementOut D, Product P, ProductBatch PB,SalesInvoice SI,RptBillToPrint B      
	  WHERE H.SalId <> 0      
	  and H.RepRefNo = D.RepRefNo      
	  and D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = SI.SalId      
	  and SI.SalInvNo = B.[Bill Number]      
	 --End      
	 ----------------------------------Credit Debit Adjus      
	 --SELECT @Sub_Val = CrDbAdj  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	 --If @Sub_Val = 1      
	 --BEGIN      
	  DELETE FROM RptBillTemplate_CrDbAdjustment WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_CrDbAdjustment(SalId,SalInvNo,NoteNumber,Amount,UsrId)      
	  SELECT A.SalId,S.SalInvNo,CrNoteNumber,A.CrAdjAmount,@Pi_UsrId      
	  FROM SalInvCrNoteAdj A,SalesInvoice S,RptBillToPrint B      
	  WHERE A.SalId = s.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	  UNION ALL      
	  SELECT A.SalId,S.SalInvNo,DbNoteNumber,A.DbAdjAmount,@Pi_UsrId      
	  FROM SalInvDbNoteAdj A,SalesInvoice S,RptBillToPrint B      
	  WHERE A.SalId = s.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	 --End      
	 ---------------------------------------Market Return      
	-- SELECT @Sub_Val = MarketRet FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	-- If @Sub_Val = 1      
	-- BEGIN      
	  DELETE FROM RptBillTemplate_MarketReturn WHERE UsrId = @Pi_UsrId      
	  INSERT INTO RptBillTemplate_MarketReturn(Type,SalId,SalInvNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Amount,UsrId)      
	  SELECT 'Market Return' Type ,H.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
	  D.PrdBatId,PB.PrdBatCode,BaseQty,PrdNetAmt,@Pi_UsrId      
	  FROM ReturnHeader H,ReturnProduct D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B      
	  WHERE returntype = 1      
	  and H.ReturnID = D.ReturnID      
	  and D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = S.SalId      
	  and S.SalInvNo = B.[Bill Number]      
	  UNION ALL      
	  SELECT 'Market Return Free Product' Type,D.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
	  D.PrdBatId,PB.PrdBatCode,D.BaseQty,GrossAmount,@Pi_UsrId      
	  FROM ReturnPrdHdForScheme D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B,ReturnHeader H,ReturnProduct T      
	  WHERE returntype = 1 AND      
	  D.PrdId = P.PrdId      
	  and D.PrdBatId = PB.PrdBatId      
	  and H.SalId = T.SalId      
	  and H.ReturnID = T.ReturnID      
	  and S.SalInvNo = B.[Bill Number]      
	-- End      
	 ------------------------------ SampleIssue      
	SELECT @Sub_Val = SampleIssue FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
	If @Sub_Val = 1      
	BEGIN      
		INSERT INTO RptBillTemplate_SampleIssue(SalId,SalInvNo,SchId,SchCode,SchName,PrdId,PrdCCode,CmpId,CmpCode,      
		CmpName,PrdDCode,PrdShrtName,PrdBatId,PrdBatCode,UomId,UomCode,Qty,TobeReturned,DueDate,UsrId)      
		SELECT A.SalId,C.SalInvNo,D.SchId,D.SchCode,D.SchDsc,B.PrdId,      
		E.PrdCCode,E.CmpId,F.CmpCode,F.CmpName,E.PrdDCode,E.PrdShrtName,B.PrdBatId,G.PrdBatCode,      
		B.IssueUomID,H.UomCode,B.IssueQty,CASE B.TobeReturned WHEN 0 THEN 'No' ELSE 'Yes' END AS TobeReturned,      
		B.DueDate,@Pi_UsrId      
		FROM SampleIssueHd A WITH (NOLOCK)      
		INNER JOIN SampleIssueDt B WITH(NOLOCK)ON A.IssueId=B.IssueID      
		INNER JOIN SalesInvoice C WITH(NOLOCK)ON A.SalId=C.SalId      
		INNER JOIN SampleSchemeMaster D WITH(NOLOCK)ON B.SchId=D.SchId      
		INNER JOIN Product E WITH (NOLOCK) ON B.PrdID=E.PrdId      
		INNER JOIN Company F WITH (NOLOCK) ON E.CmpId=F.CmpId      
		INNER JOIN ProductBatch G WITH (NOLOCK) ON E.PrdID=G.PrdID AND B.PrdBatId=G.PrdBatId      
		INNER JOIN UOMMaster H WITH (NOLOCK) ON B.IssueUomID=H.UomID      
		INNER JOIN RptBillToPrint I WITH (NOLOCK) ON C.SalInvNo=I.[Bill Number]      
	End      
	 --->Added By Nanda on 10/03/2010      
	 ------------------------------ Scheme      
		SELECT @Sub_Val = [Scheme] FROM BillTemplateHD WHERE TempName=SUBSTRING(@Pi_BTTblName,18,LEN(@Pi_BTTblName))      
		If @Sub_Val = 1      
		BEGIN      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISL.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
			0,'',0,0,SUM(SISL.DiscountPerAmount+SISL.FlatAmount),0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeLineWise SISL,SchemeMaster SM,RptBillToPrint RBT      
			WHERE SISL.SchId=SM.SchId AND SI.SalId=SISL.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.SalId,SI.SalInvNo,SISL.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
			HAVING SUM(SISL.DiscountPerAmount+SISL.FlatAmount)>0      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.FreePrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.FreePrdBatId,PB.PrdBatCode,SISFP.FreeQty,PBD.PrdBatDetailValue,SISFP.FreeQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
			ProductBatchDetails PBD,BatchCreation BC      
			WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.FreePrdId=P.PrdId AND SISFP.FreePrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
			PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.GiftPrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.GiftPrdBatId,PB.PrdBatCode,SISFP.GiftQty,PBD.PrdBatDetailValue,SISFP.GiftQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
			ProductBatchDetails PBD,BatchCreation BC      
			WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.GiftPrdId=P.PrdId AND SISFP.GiftPrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
			PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SIWD.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
			0,'',0,0,SUM(SIWD.AdjAmt),0,0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceWindowDisplay SIWD,SchemeMaster SM,RptBillToPrint RBT      
			WHERE SIWD.SchId=SM.SchId AND SI.SalId=SIWD.SalId AND RBT.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.SalId,SI.SalInvNo,SIWD.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
			UPDATE RPT SET SalInvSchemeValue=A.SalInvSchemeValue      
			FROM RptBillTemplate_Scheme RPT,(SELECT SalId,SUM(SchemeValueInAmt) AS SalInvSchemeValue FROM RptBillTemplate_Scheme GROUP BY SalId)A      
			WHERE A.SAlId=RPT.SalId      
			--->Added By Jay on 09/12/2010      
			INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
			PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
			SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
			WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
			SISFP.PrdBatId,PB.PrdBatCode,0,PBD.PrdBatDetailValue,0,SUM(Points),0,0,@Pi_UsrId      
			FROM SalesInvoice SI,SalesInvoiceSchemeDtPoints SISFP,SchemeMaster SM,      
			RptBillToPrint RBT,Product P,ProductBatch PB,ProductBatchDetails PBD,BatchCreation BC      
			WHERE SI.SalId=SISFP.SalId AND SISFP.SchId=SM.SchId AND RBT.[Bill Number]=SI.SalInvNo      
			AND SISFP.PrdId=P.PrdId AND SISFP.PrdBatId=PB.PrdBatId AND RBT.UsrId=@Pi_UsrId      
			AND PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1 AND LEN(SISFP.ReDimRefId)=0        
			GROUP BY SI.SalId,SI.SalInvNo,SISFP.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,      
			P.PrdName,SISFP.PrdBatId,PB.PrdBatCode,PBD.PrdBatDetailValue      
			--->Till Here      
			--->Added By Nanda on 22/12/2010       
			UPDATE R SET SchemeCumulativePoints=A.CumulativePoints      
			FROM RptBillTemplate_Scheme R,SalesInvoice SI,      
			(SELECT SI.RtrId,SISP.SchId,SUM(SISP.Points-SISP.ReturnPoints) AS CumulativePoints      
			FROM SalesInvoiceSchemeDtPoints SISP      
			INNER JOIN SalesInvoice SI ON SI.SalId=SISP.SalId AND SI.DlvSts<>3      
			--INNER JOIN RptBillToPrint R ON R.[Bill Number]=SI.SalInvNo      
			GROUP BY SI.RtrId,SISP.SchId) A      
			WHERE R.SalId=SI.SalId AND A.RtrId=SI.RtrId      
			--->Till Here        
		End      
	 --->Till Here       
	 --->Added By Nanda on 14/03/2011      
	 ------------------------------ Prd UOM Details      
	 --INSERT INTO RptBillTemplate_PrdUOMDetails(SalId,SalInvNo,TotPrdVolume,TotPrdKG,TotPrdLtrs,TotPrdUnits,      
	 --TotPrdDrums,TotPrdCartons,TotPrdBuckets,TotPrdPieces,TotPrdBags,UsrId)       
	 --SELECT SalId,SalInvNo,SUM(TotPrdVolume) AS TotPrdVolume,SUM(TotPrdKG) AS TotPrdKG,SUM(TotPrdLtrs) AS TotPrdLtrs,SUM(TotPrdUnits) AS TotPrdUnits,      
	 --SUM(TotPrdDrums) AS TotPrdDrums,SUM(TotPrdCartons) AS TotPrdCartons,SUM(TotPrdBuckets) AS TotPrdBuckets,SUM(TotPrdPieces) AS TotPrdPieces,SUM(TotPrdBags) AS TotPrdBags,@Pi_UsrId      
	 --FROM      
	 --(      
	 -- SELECT DISTINCT SI.SalId,SI.SalInvNo,SIP.PrdId,SIP.BaseQty*dbo.Fn_ReturnProductVolumeInLtrs(SIP.PrdId) AS TotPrdVolume,      
	 -- SIP.BaseQty*P.PrdUpSKU * (CASE P.PrdUnitId WHEN 2 THEN .001 WHEN 3 THEN 1 ELSE 0 END) AS TotPrdKG,      
	 -- SIP.BaseQty * P.PrdWgt * (CASE P.PrdUnitId WHEN 4 THEN .001 WHEN 5 THEN 1 ELSE 0 END) AS TotPrdLtrs,      
	 -- SIP.BaseQty*(CASE P.PrdUnitId WHEN 1 THEN 0 ELSE 0 END) AS TotPrdUnits,      
	 -- (CASE ISNULL(UMP1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMP2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP2.UOM2Qty,0) END) AS TotPrdPieces,      
	 -- (CASE ISNULL(UMBU1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMBU2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU2.UOM2Qty,0) END) AS TotPrdBuckets,      
	 -- (CASE ISNULL(UMBA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMBA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA2.UOM2Qty,0) END) AS TotPrdBags,      
	 -- (CASE ISNULL(UMDR1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMDR2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR2.UOM2Qty,0) END) AS TotPrdDrums,      
	 -- (CASE ISNULL(UMCA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA1.UOM1Qty,0) END)+      
	 -- (CASE ISNULL(UMCA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA2.UOM2Qty,0) END)+       
	 -- CEILING((CASE ISNULL(UMCN1.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN1.UOM1Qty,0) AS NUMERIC(38,6))/CAST(UGC1.ConvFact AS NUMERIC(38,6)) END))+      
	 -- CEILING((CASE ISNULL(UMCN2.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN2.UOM2Qty,0) AS NUMERIC(38,6))/CAST(UGC2.ConvFact AS NUMERIC(38,6)) END)) AS TotPrdCartons      
	 -- FROM SalesInvoice SI INNER JOIN SalesInvoiceProduct SIP ON SI.SalId=SIP.SalId      
	 -- INNER JOIN RptBillToPrint Rpt ON SI.SalInvNo = Rpt.[Bill Number] AND Rpt.UsrId=@Pi_UsrId      
	 -- INNER JOIN Product P ON SIP.PrdID=P.PrdID      
	 -- INNER JOIN ProductBatch PB ON SIP.PrdBatID=PB.PrdBatID AND P.PrdID=PB.PrdId      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP1 ON SI.SalId=SIPP1.SalId AND SIP.PrdID=SIPP1.PrdID AND SIP.PrdBatID=SIPP1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP2 ON SI.SalId=SIPP2.SalId AND SIP.PrdID=SIPP2.PrdID AND SIP.PrdBatID=SIPP2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU1 ON SI.SalId=SIPBU1.SalId AND SIP.PrdID=SIPBU1.PrdID AND SIP.PrdBatID=SIPBU1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU2 ON SI.SalId=SIPBU2.SalId AND SIP.PrdID=SIPBU2.PrdID AND SIP.PrdBatID=SIPBU2.PrdBatID        
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA1 ON SI.SalId=SIPBA1.SalId AND SIP.PrdID=SIPBA1.PrdID AND SIP.PrdBatID=SIPBA1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA2 ON SI.SalId=SIPBA2.SalId AND SIP.PrdID=SIPBA2.PrdID AND SIP.PrdBatID=SIPBA2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR1 ON SI.SalId=SIPDR1.SalId AND SIP.PrdID=SIPDR1.PrdID AND SIP.PrdBatID=SIPDR1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR2 ON SI.SalId=SIPDR2.SalId AND SIP.PrdID=SIPDR2.PrdID AND SIP.PrdBatID=SIPDR2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA1 ON SI.SalId=SIPCA1.SalId AND SIP.PrdID=SIPCA1.PrdID AND SIP.PrdBatID=SIPCA1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA2 ON SI.SalId=SIPCA2.SalId AND SIP.PrdID=SIPCA2.PrdID AND SIP.PrdBatID=SIPCA2.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN1 ON SI.SalId=SIPCN1.SalId AND SIP.PrdID=SIPCN1.PrdID AND SIP.PrdBatID=SIPCN1.PrdBatID      
	 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN2 ON SI.SalId=SIPCN2.SalId AND SIP.PrdID=SIPCN2.PrdID AND SIP.PrdBatID=SIPCN2.PrdBatID      
	 -- LEFT OUTER JOIN UOMMaster UMP1 ON UMP1.UOMId=SIPP1.UOM1Id AND UMP1.UOMDescription='PIECES'      
	 -- LEFT OUTER JOIN UOMMaster UMP2 ON UMP1.UOMId=SIPP2.UOM2Id AND UMP2.UOMDescription='PIECES'      
	 -- LEFT OUTER JOIN UOMMaster UMBU1 ON UMBU1.UOMId=SIPBU1.UOM1Id AND UMBU1.UOMDescription='BUCKETS'       
	 -- LEFT OUTER JOIN UOMMaster UMBU2 ON UMBU1.UOMId=SIPBU2.UOM2Id AND UMBU2.UOMDescription='BUCKETS'      
	 -- LEFT OUTER JOIN UOMMaster UMBA1 ON UMBA1.UOMId=SIPBA1.UOM1Id AND UMBA1.UOMDescription='BAGS'       
	 -- LEFT OUTER JOIN UOMMaster UMBA2 ON UMBA1.UOMId=SIPBA2.UOM2Id AND UMBA2.UOMDescription='BAGS'      
	 -- LEFT OUTER JOIN UOMMaster UMDR1 ON UMDR1.UOMId=SIPDR1.UOM1Id AND UMDR1.UOMDescription='DRUMS'       
	 -- LEFT OUTER JOIN UOMMaster UMDR2 ON UMDR1.UOMId=SIPDR2.UOM2Id AND UMDR2.UOMDescription='DRUMS'      
	 -- LEFT OUTER JOIN UOMMaster UMCA1 ON UMCA1.UOMId=SIPCA1.UOM1Id AND UMCA1.UOMDescription='CARTONS'       
	 -- LEFT OUTER JOIN UOMMaster UMCA2 ON UMCA1.UOMId=SIPCA2.UOM2Id AND UMCA2.UOMDescription='CARTONS'      
	 -- LEFT OUTER JOIN UOMMaster UMCN1 ON UMCN1.UOMId=SIPCN1.UOM1Id AND UMCN1.UOMDescription='CANS'       
	 -- LEFT OUTER JOIN UOMMaster UMCN2 ON UMCN1.UOMId=SIPCN2.UOM2Id AND UMCN2.UOMDescription='CANS'      
	 -- LEFT OUTER JOIN (      
	 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
	 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
	 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
	 -- GROUP BY P.PrdID) UGC1 ON SIPCN1.PrdId=UGC1.PrdID      
	 -- LEFT OUTER JOIN (      
	 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
	 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
	 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
	 -- GROUP BY P.PrdID) UGC2 ON SIPCN2.PrdId=UGC2.PrdID      
	 --) A      
	 --GROUP BY SalId,SalInvNo      
	 --->Till Here      
	 --Added By Sathishkumar Veeramani 2012/12/13      
		IF NOT EXISTS (SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD [Payment Mode] NVARCHAR(20)      
		END      
		IF EXISTS(SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')          
		BEGIN          
			SET @SSQL1='UPDATE A SET A.[Payment Mode] = Z.[Payment Mode] FROM RptBillTemplateFinal A INNER JOIN       
			(SELECT SalId,(CASE RtrPayMode WHEN 1 THEN ''Cash'' ELSE ''Cheque'' END) AS [Payment Mode] FROM SalesInvoice WITH (NOLOCK)) Z ON A.Salid = Z.SalId       
			AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END       
	 --Till Here      
	 --->Added By Nanda on 23/03/2010-For Grouping the details based on product for nondrug products      
		 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeBillPrinting01' AND ModuleName='Botree Bill Printing' AND Status=1)      
		 BEGIN      
		  IF EXISTS (SELECT * FROM dbo.SysObjects WHERE Id = Object_Id(N'[RptBillTemplateFinal_Group]') AND OBJECTPROPERTY(Id, N'IsUserTable') = 1)      
		  DROP TABLE [RptBillTemplateFinal_Group]   
		     
		  SELECT * INTO RptBillTemplateFinal_Group FROM RptBillTemplateFinal  WHERE [Visibility]=1
		  
		  SELECT * FROM RptBillTemplateFinal_Group     
		  
		  DELETE FROM RptBillTemplateFinal    
		  INSERT INTO RptBillTemplateFinal      
		  (      
		   [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
		   [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
		   [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		   [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
		   [CD Disc Header Amount],[CD Disc LineUnit Amount],      
		   [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		   [CD Disc UOM Amount],[CD Disc UOM Percentage],      
		   [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
		   [DB Disc Header Amount],[DB Disc LineUnit Amount],      
		   [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
		   [DB Disc UOM Amount],[DB Disc UOM Percentage],      
		   [Line Base Qty Amount],[Line Base Qty Percentage],      
		   [Line Effect Amount],[Line Unit Amount],      
		   [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
		   [Manual Free Qty],      
		   [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
		   [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
		   [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		   [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
		   [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
		   [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
		   [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		   [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
		   [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		   [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
		   [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
		   [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
		   [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
		   [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
		   [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
		   [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		   [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
		   [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		   [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		   [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		   [Route Code],[Route Name],      
		   [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		   [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		   [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		   [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		   [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		   [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		   [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		   [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		   [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		   [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		   [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		   [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		   [LST Number],[Order Date],[Order Number],      
		   [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		   [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  )        
		  SELECT      
		  [SalId],      
		  [Sales Invoice Number],      
		  [Product Code],[Product Name],[Product Short Name],MIN([Product SL No]) AS [Product SL No],[Product Type],[Scheme Points],      
		  SUM([Base Qty]) AS [Base Qty],      
		  '' AS [Batch Code],MAX([Batch Expiry Date]) AS [Batch Expiry Date],MIN([Batch Manufacturing Date]) AS [Batch Manufacturing Date],      
		  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  SUM([CD Disc Base Qty Amount]) AS [CD Disc Base Qty Amount],SUM([CD Disc Effect Amount]) AS [CD Disc Effect Amount],      
		  SUM(DISTINCT [CD Disc Header Amount]) AS [CD Disc Header Amount],SUM([CD Disc LineUnit Amount]) AS [CD Disc LineUnit Amount],      
		  --SUM([CD Disc Qty Percentage]) AS [CD Disc Qty Percentage],SUM([CD Disc Unit Percentage]) AS [CD Disc Unit Percentage],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  SUM([CD Disc UOM Amount]),SUM([CD Disc UOM Percentage]) AS [CD Disc UOM Percentage],      
		  SUM([DB Disc Base Qty Amount]) AS [DB Disc Base Qty Amount],SUM([DB Disc Effect Amount]) AS [DB Disc Effect Amount],      
		  SUM(DISTINCT [DB Disc Header Amount]) AS [DB Disc Header Amount],SUM([DB Disc LineUnit Amount]) AS [DB Disc LineUnit Amount],      
		  --SUM([DB Disc Qty Percentage]) AS [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]) AS [DB Disc Unit Percentage],      
		  [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]),      
		  SUM([DB Disc UOM Amount]) AS [DB Disc UOM Amount],SUM([DB Disc UOM Percentage]) AS [DB Disc UOM Percentage],      
		  SUM([Line Base Qty Amount]) AS [Line Base Qty Amount],SUM([Line Base Qty Percentage]) AS [Line Base Qty Percentage],      
		  SUM([Line Effect Amount]) AS [Line Effect Amount],      
		  --SUM([Line Unit Amount]) AS [Line Unit Amount],      
		  [Line Unit Amount],      
		  SUM([Line Unit Percentage]) AS [Line Unit Percentage],SUM([Line UOM1 Amount]) AS [Line UOM1 Amount],SUM([Line UOM1 Percentage]) AS [Line UOM1 Percentage],      
		  SUM([Manual Free Qty]),      
		  SUM([Sch Disc Base Qty Amount]) AS [Sch Disc Base Qty Amount],SUM([Sch Disc Effect Amount]) AS [Sch Disc Effect Amount],      
		  SUM(DISTINCT [Sch Disc Header Amount]) AS [Sch Disc Header Amount],SUM([Sch Disc LineUnit Amount]) AS [Sch Disc LineUnit Amount],      
		  --SUM([Sch Disc Qty Percentage]) AS [Sch Disc Qty Percentage],SUM([Sch Disc Unit Percentage]) AS [Sch Disc Unit Percentage],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  SUM([Sch Disc UOM Amount]) AS [Sch Disc UOM Amount],SUM([Sch Disc UOM Percentage]) AS [Sch Disc UOM Percentage],      
		  SUM([Spl. Disc Base Qty Amount]) AS [Spl. Disc Base Qty Amount],SUM([Spl. Disc Effect Amount]) AS [Spl. Disc Effect Amount],      
		  SUM(DISTINCT [Spl. Disc Header Amount]) AS [Spl. Disc Header Amount],SUM([Spl. Disc LineUnit Amount]) AS [Spl. Disc LineUnit Amount],      
		  --SUM([Spl. Disc Qty Percentage]) AS [Spl. Disc Qty Percentage],SUM([Spl. Disc Unit Percentage]) AS [Spl. Disc Unit Percentage],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		  SUM([Spl. Disc UOM Amount]) AS [Spl. Disc UOM Amount],SUM([Spl. Disc UOM Percentage]) AS [Spl. Disc UOM Percentage],      
		  --SUM([Tax 1]) AS [Tax 1],SUM([Tax 2]) AS [Tax 2],SUM([Tax 3]) AS [Tax 3],SUM([Tax 4]) AS [Tax 4],      
		  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  SUM([Tax Amount1]) AS [Tax Amount1],SUM([Tax Amount2]) AS [Tax Amount2],SUM([Tax Amount3]) AS [Tax Amount3],SUM([Tax Amount4]) AS [Tax Amount4],      
		  SUM([Tax Amt Base Qty Amount]) AS [Tax Amt Base Qty Amount],SUM([Tax Amt Effect Amount]) AS [Tax Amt Effect Amount],      
		  SUM(DISTINCT [Tax Amt Header Amount]) AS [Tax Amt Header Amount],SUM([Tax Amt LineUnit Amount]) AS [Tax Amt LineUnit Amount],      
		  SUM([Tax Amt Qty Percentage]) AS [Tax Amt Qty Percentage],SUM([Tax Amt Unit Percentage]) AS [Tax Amt Unit Percentage],      
		  SUM([Tax Amt UOM Amount]) AS [Tax Amt UOM Amount],SUM([Tax Amt UOM Percentage]) AS [Tax Amt UOM Percentage],      
		  '' AS [Uom 1 Desc],SUM([Base Qty]) AS [Uom 1 Qty],'' AS [Uom 2 Desc],0 AS [Uom 2 Qty],[Vehicle Name],      
		  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  SUM([SalesInvoice Line Gross Amount]) AS [SalesInvoice Line Gross Amount],SUM([SalesInvoice Line Net Amount]) AS [SalesInvoice Line Net Amount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [Route Code],[Route Name],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],[Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  FROM RptBillTemplateFinal_Group,Product P      
		  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType<>5   AND  [Visibility]=1  
		  GROUP BY [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],      
		  [Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],      
		  [Product Code],[Product Name],[Product Short Name],[Product Type],      
		  [Remarks],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],      
		  [Route Code],[Route Name],      
		  [Sales Invoice Number],[SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [SalId],      
		  [Scheme Points],      
		  [Tax Type],[TIN Number],      
		  [Vehicle Name],[Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  [DB Disc Qty Percentage],--[DB Disc Unit Percentage],      
		  [Line Unit Amount],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],        
		  [UsrId],[Visibility],[AmtInWrd] ,
		  [Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd] ---------------- Group by columns Added by Lakshman M  on 09/01/2018    
		  UNION ALL      
		  SELECT [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
		  [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
		  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
		  [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
		  [CD Disc Header Amount],[CD Disc LineUnit Amount],      
		  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
		  [CD Disc UOM Amount],[CD Disc UOM Percentage],      
		  [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
		  [DB Disc Header Amount],[DB Disc LineUnit Amount],      
		  [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
		  [DB Disc UOM Amount],[DB Disc UOM Percentage],      
		  [Line Base Qty Amount],[Line Base Qty Percentage],      
		  [Line Effect Amount],[Line Unit Amount],      
		  [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
		  [Manual Free Qty],      
		  [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
		  [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
		  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
		  [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
		  [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
		  [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
		  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
		  [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
		  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
		  [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
		  [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
		  [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
		  [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
		  [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
		  [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
		  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
		  [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
		  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
		  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
		  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
		  [Route Code],[Route Name],      
		  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
		  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
		  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
		  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
		  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
		  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
		  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
		  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
		  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
		  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
		  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
		  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
		  [LST Number],[Order Date],[Order Number],      
		  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
		  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
		  FROM RptBillTemplateFinal_Group,Product P      
		  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType=5   AND  [Visibility]=1   
	 END       
	 --->Till Here      
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD InvDisc NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END 
		     
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD InvDiscPer NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END
		
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD SalesmanPhoneNo NVARCHAR(100)
		END 
		       
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD Grammage NUMERIC (38,2) DEFAULT 0 WITH VALUES       
		END  
		    
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')          
		BEGIN          
			SET @SSQL1='UPDATE A SET A.InvDisc=B.SalInvLvlDisc FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
			ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END
		       
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.InvDiscPer=B.SalInvLvlDiscPer FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
			ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.SalesmanPhoneNo=ISNULL(B.SMPhoneNumber,'''') FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesMan B (NOLOCK)       
			ON A.[SalesMan Code]=B.SMCode AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END 
		     
		--- Added by Rajesh ICRSTPAR3196      
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='bx')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.bx=bx+box FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))      
			EXEC (@SSQL1)          
		END   
		   
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='PBG')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.PB=PB+PBG FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
			EXEC (@SSQL1)          
		END   
		   
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIN')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.Tn=TN+TIN FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
			EXEC (@SSQL1)          
		END  
		    
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIF')          
		BEGIN        
			SET @SSQL1='UPDATE A SET A.TIF=TIF+TBX FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
			EXEC (@SSQL1)          
		END   
		   
		--Till here      
		-------------------GST Changes(Mohanakrishna A.B) begins here      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Dist Food Lic No]=R.DrugLicNo2       
			FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Dist Drug Lic no]=R.DrugLicNo1       
			FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)       
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[GSTTIN]=B.GSTTinNo FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Pan Number]=R.[ColumnValue]       
			FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Retailer Type]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Retailer Type'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END     
		 
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[RelatedParty]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Related Party'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
			EXEC (@SSQL1)      
		END    
		  
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[State Name]=C.StateName FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END 
		     
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[State Code]=C.StateCode FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[StateTinNo]=C.TinFirst2Digit FROM RptBillTemplateFinal A       
			INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
			EXEC (@SSQL1)       
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[HSNCode]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.prdid,R.prdccode,U.ColumnValue FROM UdcDetails u inner JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN product  R on R.prdid=U.MasterRecordId  WHERE US.MasterId=1   and ColumnName=''HSN Code'' ) R ON B.[Product Code]=R.[prdccode]'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[HSNDescription]=R.[ColumnValue] FROM RptBillTemplateFinal B       
			INNER JOIN (SELECT R.prdid,R.prdccode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Product  R on R.prdid=U.MasterRecordId  WHERE US.MasterId=1   AND ColumnName=''HSN Description'' ) R ON B.[Product Code]=R.[prdccode]'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[DistributorGstTin]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  and ColumnName=''GSTIN'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END  
		    
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
		BEGIN      
			SELECT StateCode,StateName,TinFirst2Digit,DistributorCode      
			INTO #DistState       
			FROM UDCHD A (NOLOCK)      
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId      
			INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId      
			AND B.UdcMasterId=C.UdcMasterId      
			INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId AND D.MasterId=B.MasterId      
			AND D.UdcMasterId=C.UdcMasterId AND D.UdcMasterId=B.UdcMasterId      
			INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue AND E.StateName=C.ColumnValue      
			INNER JOIN Distributor DB ON DB.DistributorId=C.MasterRecordId      
			WHERE MasterName='Distributor Info Master' AND ColumnName='State Name'      
			SET @SSQL1='UPDATE B SET B.[DistributorStateName]=R.StateName,DistributorStateCode=R.StateCode,       
			DistributorStateTinNo=R.TinFirst2Digit FROM RptBillTemplateFinal B INNER JOIN #DistState R ON B.[Distributor Code]=R.DistributorCode'       
			EXEC (@SSQL1)   
			   
			DROP TABLE #DistState      
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[Distributor Type]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  AND ColumnName=''Distributor Type'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END   
		   
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
		BEGIN      
			SET @SSQL1='UPDATE B SET B.[AadharNo]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
			SELECT D.DistributorCode,u.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
			INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  AND ColumnName=''Aadhar No'') R on B.[Distributor Code]=R.DistributorCode'      
			EXEC (@SSQL1)      
		END      
	 -------------------GST Changes(Mohanakrishna) Ends here      
	  ---ILCRSTPAR8294
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSLineLevelTax')
		BEGIN
			ALTER TABLE RptBillTemplateFinal ADD TCSLineLevelTax Numeric(18,6)
		END
		IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSHeadLevelTax')
		BEGIN
			ALTER TABLE RptBillTemplateFinal ADD TCSHeadLevelTax Numeric(18,6)
		END
  		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSLineLevelTax')
		BEGIN
			SET @SSQL1='UPDATE A SET A.TCSLineLevelTax=B.PrdTCSTaxAmount 
				FROM RptBillTemplateFinal A INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.Salid=B.SalId and A.[Product SL No]=B.slno '
			EXEC (@SSQL1)	
		END	

		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='TCSHeadLevelTax')
		BEGIN
			SET @SSQL1='UPDATE A SET A.TCSHeadLevelTax=B.SalTCSTaxAmount 
				FROM RptBillTemplateFinal A INNER JOIN SALESINVOICE B (NOLOCK) ON A.Salid=B.SalId'
			EXEC (@SSQL1)	
		END	
		--ILCRSTPAR8294
	 
	 
	 
		IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')          
		BEGIN       
			--SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
			--    INNER JOIN (      
			--     SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,ISNULL(      
			--     CASE U.PRDUNITID WHEN 2 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0)/1000      
			--     WHEN 3 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0) END,0) AS Grammage      
			--     FROM RptBillTemplateFinal SP (NOLOCK)      
			--     INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
			--     INNER JOIN PRODUCTUNIT U (NOLOCK) ON P.PrdUnitId=U.PrdUnitId      
			--     WHERE SP.USRID=      
			--     GROUP BY P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,U.PRDUNITID,SP.[Sales Invoice Number]      
			--    ) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''

			SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
			INNER JOIN (      
			SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,P.PrdWgt Grammage      
			FROM RptBillTemplateFinal SP (NOLOCK)      
			INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
			WHERE SP.USRID='+CAST(@Pi_UsrId AS VARCHAR(10))+'      
			) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''               
			EXEC (@SSQL1)          
		END      
		IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='[SalesInvoice NetAmount Actual]')      
		BEGIN      
			SET @SSQL1='UPDATE A SET A.[SalesInvoice NetAmount Actual]=B.OrgNetAmount       
			FROM RptBillTemplateFinal A INNER JOIN SalesInvoice B (NOLOCK) ON A.Salid=B.SalId'      
			EXEC (@SSQL1)       
		END
		IF EXISTS (SELECT A.SalId FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo)      
		BEGIN      
			TRUNCATE TABLE RptFinalBillTemplate_DC      
			INSERT INTO RptFinalBillTemplate_DC(SalId,InvNo,DCNo,DCDate)      
			SELECT A.SalId,B.SalInvNo,A.DCNo,DCDate FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B      
			ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo      
		END      
		ELSE      
		BEGIN      
			TRUNCATE TABLE RptFinalBillTemplate_DC      
		END
		IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='PrdtDefaultPricevalue')      
		BEGIN      
			ALTER TABLE RptBillTemplateFinal ADD PrdtDefaultPricevalue NUMERIC (18,2) DEFAULT 0 WITH VALUES       
		END
		
		 --------------- Added by lakshman M Dated ON 11-04-2019 PMS ID: ILCRSTPAR4044 
	  UPDATE D SET D.PrdtDefaultPricevalue  = Round(cast(PBD.PrdBatDetailValue As Numeric(18,2)),2)
	  FROM SalesInvoice S (NOLOCK)        
	  INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
	  INNER JOIn Product P ON P.Prdid =SP.Prdid       
	  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId     
	  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1     
	  INNER JOIN rptbilltemplatefinal D ON D.Salid = S.SalId AND SP.SalId = D.Salid AND D.[Distributor Product Code] =P.Prdccode   
	  WHERE PBD.SLNo =3
		  ------------ Till here ------------
	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='Irn' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD Irn Varchar(100) 
	  END

	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedInvoice' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD SignedInvoice Varchar(8000)
	  END

	  IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name ='SignedQRCode' )
	  BEGIN
		ALTER TABLE RptBillTemplateFinal ADD SignedQRCode Varchar(8000)
	  END

 
	 IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('Irn'))
	 BEGIN
	 
		SET @SSQL1='UPDATE A SET A.Irn=B.Irn 
		FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
		AND A.[Sales Invoice Number] = B.Invoice_no	'      
			EXEC (@SSQL1) 
	 END

	  IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('SignedInvoice'))
	  BEGIN
			
			SET @SSQL1='UPDATE A SET  A.SignedInvoice=B.SignedInvoice 
			FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
			AND A.[Sales Invoice Number] = B.Invoice_no	'      
			
			EXEC (@SSQL1)
	  
				 
	  END

	  IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptBillTemplateFinal') AND name IN ('SignedQRCode'))
	  BEGIN
		
			SET @SSQL1='UPDATE A SET  A.SignedQRCode =B.SignedQRCode 
			FROM RptBillTemplateFinal A INNER JOIN EInvoice_Acknowledgment B ON A.Salid = B.Invoice_Id AND B.TransId = 1
			AND A.[Sales Invoice Number] = B.Invoice_no	'      
			
			EXEC (@SSQL1)
						 
	  END
RETURN      
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='Irn' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD Irn Varchar(100) 
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedInvoice' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD SignedInvoice Varchar(8000)
END
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedQRCode' )
BEGIN
	ALTER TABLE RptSRNSALESRETURN ADD SignedQRCode Varchar(8000)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSRNSALESRETURN' AND TYPE='P')
DROP PROCEDURE Proc_RptSRNSALESRETURN
GO
--Exec Proc_RptSRNSALESRETURN 6,1
CREATE PROCEDURE Proc_RptSRNSALESRETURN  
(
	@Pi_UsrId Int = 1,
	@Pi_Type INT 
) 
As SET NOCOUNT ON 
/****************************************************************************************************************
* DATE			NAME			USERSTORYID			CR/BZ				DESCRIPTION
*****************************************************************************************************************
* 23-05-2019    MOHANA S		CRCRSTPAR0052		CR					SUB REPORT FOR SALES RETURN TAX SPLIT UP
* 02-07-2019    Lakshman M      ILCRSTPAR4957       SR                  product line level tax percenatge split validation included.
* 09-03-2020    MOHANA S	    ILCRSTPAR8165		CR			        Added New columns For E-Invoice 
*****************************************************************************************************************/
Begin  
 DECLARE @FromReturnId AS  VARCHAR(25)  
 DECLARE @ToReturnId   AS  VARCHAR(25) 
 DECLARE @Cnt AS INT 
 DECLARE @TempReturnId TABLE (ReturnId INT) 
 CREATE Table #RptSRNTemplate  
( 
	[Credit Note Reference No] nvarchar(50),
	[Distributor Code] nvarchar(20),
	[Distributor Name] nvarchar(50),
	[Distributor Address1] nvarchar(50),
	[Distributor Address2] nvarchar(50),
	[Distributor Address3] nvarchar(50),
	[PinCode] int,
	[PhoneNo] nvarchar(50),
	[Tax Type] tinyint,
	[TIN Number] nvarchar(50),
	[Deposit Amount] numeric(38,2),
	[CST Number] nvarchar(50),
	[LST Number] nvarchar(50),
	[Licence Number] nvarchar(50),
	[Drug Licence Number 1] nvarchar(50),
	[Drug1 Expiry Date] DateTime,
	[Drug Licence Number 2] nvarchar(50),
	[Drug2 Expiry Date] DateTime,
	[Pesticide Licence Number] nvarchar(50),
	[Pesticide Expiry Date] DateTime,
	[SalId] INT,
	[Invoice Number] nvarchar(50),
	[Invoice Date] DATETIME,
	[ReturnId] INT,
	[Sales Return Number] nvarchar(50),
	[Sales Return Date] DATETIME,
	[Sales Man] nvarchar(50),
	[Route] nvarchar(50),
	[Retailer Code] nvarchar(50),
	[Retailer Name] nvarchar(150),
	[Retailer Phone Number] nvarchar(50),
	[Retailer CST Number] nvarchar(50),
	[Retailer Drug Lic  Number] nvarchar(50),
	[Retailer Lic Number] nvarchar(50),
	[Retailer Tin Number] nvarchar(50),
	[Retailer Address] nvarchar(50),
	[Product Company Code] nvarchar(20),
	[Product Company Name] nvarchar(150),
	[Product Short Code] nvarchar(100),
	[Product Short Name] nvarchar(150),
	[Product Name] nvarchar(150),
	[Product Slno] INT,
	[Stock Type] nvarchar(100),
	[Return Quantity] NUMERIC(18,0),
	[Selling Rate] NUMERIC(18,6),
	[Gross Amount] NUMERIC(18,6),
	[Special Discount] NUMERIC(18,6),
	[Scheme Discount] NUMERIC(18,6),
	[Distributor Discount] NUMERIC(18,6),
	[Cash Discount] NUMERIC(18,6),
	[TaxName] NVARCHAR(50),
	[Tax Percentage] NUMERIC(18,6),
	[Tax Amount Line Level] NUMERIC(18,6),
	[Line level Net Amount] NUMERIC(18,6),
	[Reason] nvarchar(100),
	[Type] nvarchar(50),
	[Mode] nvarchar(50),
	[Total Gross Amount] NUMERIC(18,6),
	[Total Special Discount] NUMERIC(18,6),
	[Total Scheme Discount] NUMERIC(18,6),
	[Total Distributor Discount] NUMERIC(18,6),
	[Total Cash Discount] NUMERIC(18,6),
	[Total Tax Amount] NUMERIC(18,6),
	[Total Net Amount] NUMERIC(18,6),
	[Total Discount] NUMERIC(18,6),
	[RtrId] INT,
	[RMID] INT,
	[SMID] INT,
	[MRP] NUMERIC(18,6),
	[Credit Note/Replacement Reference No] nvarchar(50),
	UsrId int,Visibility tinyint 
) 
	IF @Pi_Type=1 
	BEGIN   
		INSERT INTO @TempReturnId SELECT SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 32  AND UsrId=@Pi_UsrId
	END
	ELSE   
	BEGIN 
		SELECT @FromReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 14 AND UsrId=@Pi_UsrId
		SELECT @ToReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 15  AND UsrId=@Pi_UsrId
	END
	IF @Pi_Type=1 
	BEGIN 
		Insert into #RptSRNTemplate  
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,
		DistributorAdd2,	DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,
		CSTNo,	LSTNo,	LicNo,	DrugLicNo1,	Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,
		PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,	SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,
		ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,	RtrCstNo,	RtrDrugLicNo,	RtrLicNo,
		RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,	Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,
		UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,	PrdSchDisAmt,	PrdDBDisAmt,
		PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,	ReturnMode,	RtnGrossAmt,
		RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,	Retailer.RtrId,
		RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId 
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode 
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode AND CreditNoteRetailer.TransId = 30 
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId IN (SELECT ReturnId FROM @TempReturnId)  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,
		DISTRIBUTORADD1,	DISTRIBUTORADD2,	DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,
		CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,	DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,
		SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,	RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,
		RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,	RTRADD1,	CMPCODE,
		CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,	PRDEDITSELRTE,
		PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,	INVOICETYPE,
		RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,	RTNNETAMT,
		RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno 
	END  
	ELSE 
	BEGIN 
		Insert into #RptSRNTemplate  
		SELECT CreditNoteRetailer.CrNoteNumber,	DistributorCode,	DistributorName,	DistributorAdd1,	DistributorAdd2,
		DistributorAdd3,	PinCode,	PhoneNo,	TaxType,	TINNo,	DepositAmt,	CSTNo,	LSTNo,	LicNo,	DrugLicNo1,
		Drug1ExpiryDate,	DrugLicNo2,	Drug2ExpiryDate,	PestLicNo,	PestExpiryDate,	SalesInvoice.SalId,	SalInvNo,
		SalInvDate,	ReturnProduct.ReturnId,	ReturnCode,	ReturnDate,	SMCode,	RMCode,	RtrCode,	RtrName,	RtrPhoneNo,
		RtrCstNo,	RtrDrugLicNo,	RtrLicNo,	RtrTINNo,	RtrAdd1,	CmpCode,	CmpName,	Product.PrdDCode,
		Product.PrdShrtName,	Product.PrdName,ReturnProduct.Slno,	UserStockType,	BaseQty,	PrdEditSelRte,	PrdGrossAmt,	PrdSplDisAmt,
		PrdSchDisAmt,	PrdDBDisAmt,	PrdCDDisAmt,CASE WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'CGST'
		WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'SGST'
		WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'IGST'
		WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'UTGST'
		WHEN TaxCode IN('OutputCess','OutputGSTCess','CESS') THEN 'CESS'		
		END as TaxName,TaxPerc,	SUM(TaxAmt) AS TaxAmt,	PrdNetAmt,	Description,	InvoiceType,
		ReturnMode,	RtnGrossAmt,	RtnSplDisAmt,	RtnSchDisAmt,	RtnDBDisAmt,	RtnCashDisAmt,	RtnTaxAmt,	RtnNetAmt,	RtnNetAmt,
		Retailer.RtrId,	RouteMaster.RMId,	SalesMan.SMId,	ReturnProduct.PrdUnitMRP,	CreditNoteReplacementHd.CNRRefNo,
		@Pi_UsrId,1 Visibility 
		FROM  Distributor,ReturnProduct INNER JOIN ReturnHeader ON ReturnHeader.ReturnId=ReturnProduct.ReturnId
		INNER JOIN Retailer ON ReturnHeader.RtrId=Retailer.RtrId
		INNER JOIN SalesMan ON ReturnHeader.SMId=SalesMan.SMId
		INNER JOIN RouteMaster ON ReturnHeader.RMId=RouteMaster.RMId
		LEFT OUTER JOIN SalesInvoice ON SalesInvoice.SalId=ReturnProduct.SalId
		LEFT OUTER JOIN CreditNoteReplacementHd ON CreditNoteReplacementHd.SrNo=ReturnHeader.ReturnCode
		LEFT OUTER JOIN CreditNoteRetailer ON CreditNoteRetailer.PostedFrom=ReturnHeader.ReturnCode  AND CreditNoteRetailer.TransId=30
		INNER JOIN Product ON ReturnProduct.PrdId=Product.PrdId
		INNER JOIN Company ON Product.CmpId=Company.CmpId
		INNER JOIN StockType ON StockType.StockTypeId=ReturnProduct.StockTypeId
		LEFT OUTER JOIN ReturnProductTax ON ReturnProductTax.ReturnId=ReturnProduct.ReturnId AND ReturnProduct.Slno=ReturnProductTax.PrdSlNo
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =ReturnProductTax.TaxId
		LEFT OUTER JOIN ReasonMaster ON ReasonMaster.ReasonId=ReturnProduct.ReasonId 
		WHERE ReturnHeader.ReturnId BETWEEN  @FromReturnId  AND  @ToReturnId  
		GROUP BY CREDITNOTERETAILER.CRNOTENUMBER,	DISTRIBUTORCODE,	DISTRIBUTORNAME,	DISTRIBUTORADD1,	DISTRIBUTORADD2,
		DISTRIBUTORADD3,	PINCODE,	PHONENO,	TAXTYPE,	TINNO,	DEPOSITAMT,	CSTNO,	LSTNO,	LICNO,	DRUGLICNO1,	DRUG1EXPIRYDATE,
		DRUGLICNO2,	DRUG2EXPIRYDATE,	PESTLICNO,	PESTEXPIRYDATE,	SALESINVOICE.SALID,	SALINVNO,	SALINVDATE,	RETURNPRODUCT.RETURNID,
		RETURNCODE,	RETURNDATE,	SMCODE,	RMCODE,	RTRCODE,	RTRNAME,	RTRPHONENO,	RTRCSTNO,	RTRDRUGLICNO,	RTRLICNO,	RTRTINNO,
		RTRADD1,	CMPCODE,	CMPNAME,	PRODUCT.PRDDCODE,	PRODUCT.PRDSHRTNAME,	PRODUCT.PRDNAME,	USERSTOCKTYPE,	BASEQTY,
		PRDEDITSELRTE,	PRDGROSSAMT,	PRDSPLDISAMT,	PRDSCHDISAMT,	PRDDBDISAMT,	PRDCDDISAMT,	PRDNETAMT,	DESCRIPTION,
		INVOICETYPE,	RETURNMODE,	RTNGROSSAMT,	RTNSPLDISAMT,	RTNSCHDISAMT,	RTNDBDISAMT,	RTNCASHDISAMT,	RTNTAXAMT,
		RTNNETAMT,	RTNNETAMT,	RETAILER.RTRID,	ROUTEMASTER.RMID,	SALESMAN.SMID,	RETURNPRODUCT.PRDUNITMRP,	CREDITNOTEREPLACEMENTHD.CNRREFNO,TaxPerc,Taxcode,ReturnProduct.Slno
	
	END
	--INSERT INTO RptSRNSALESRETURN 
	SELECT * INTO #SRNSALESRETURNTEMP FROM #RptSRNTemplate 
	DELETE FROM RptSRNSALESRETURN
	----- added by lakshman ILCRSTPAR4957
	SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue 
	INTO #RetailerGSTIN
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='GSTIN'
	
	INSERT INTO RptSRNSALESRETURN ([Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility])
	SELECT DISTINCT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],
	[Drug Licence Number 1],[Drug1 Expiry Date],[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId],[Invoice Number],[Invoice Date],[ReturnId],[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],
	[Retailer Phone Number],[Retailer CST Number],[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],[Product Short Name],[Product Name],[Stock Type],
	[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],[Distributor Discount],[Cash Discount],[Tax Percentage],[Tax Amount Line Level],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],[Total Net Amount],[Total Discount],[RtrId],[RMID],[SMID],[MRP],[Credit Note/Replacement Reference No],[UsrId],[Visibility]  
	FROM #SRNSALESRETURNTEMP
	
	UPDATE A SET [CGST Perc] = B.[TAX PERCENTAGE],[CGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CGST'
	UPDATE A SET [SGST Perc] = B.[TAX PERCENTAGE],[SGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'SGST'
	UPDATE A SET [IGST Perc] = B.[TAX PERCENTAGE],[IGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'IGST'
	UPDATE A SET [UTGST Perc] = B.[TAX PERCENTAGE],[UTGST TAXAMT] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'UTGST'
	UPDATE A SET [CESS Perc] = B.[TAX PERCENTAGE],[CESS TaxAmt] = B.[Tax Amount Line Level] FROM RptSRNSALESRETURN A INNER JOIN #SRNSALESRETURNTEMP B ON A.[Credit Note Reference No] = B.[Credit Note Reference No] AND A.[Product Short Code]=B.[Product Short Code] 
	WHERE TAXNAME = 'CESS'
	--INSERT INTO RptSRNSALESRETURN 
	--([Credit Note Reference No],[Distributor Code],[Distributor Name], [Distributor Address1], [Distributor Address2], [Distributor Address3], 
	--[PinCode], [PhoneNo],[Tax Type], [TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1], [Drug1 Expiry Date],
	--[Drug Licence Number 2], [Drug2 Expiry Date], [Pesticide Licence Number], [Pesticide Expiry Date], [SalId],[Invoice Number], [Invoice Date], [ReturnId], 
	--[Sales Return Number], [Sales Return Date], [Sales Man], [Route], [Retailer Code], [Retailer Name], [Retailer Phone Number], [Retailer CST Number], 
	--[Retailer Drug Lic  Number],[Retailer Lic Number], [Retailer Tin Number], [Retailer Address], [Product Company Code], [Product Company Name], [Product Short Code], 
	--[Product Short Name], [Product Name],[Product Slno], [Stock Type], [Return Quantity],[Selling Rate], [Gross Amount], [Special Discount], [Scheme Discount], 
	--[Distributor Discount], [Cash Discount],[Line level Net Amount], [Reason], [Type], [Mode], [Total Gross Amount], [Total Special Discount], [Total Scheme Discount], 
	--[Total Distributor Discount], [Total Cash Discount], [Tax Amount Line Level],[Total Tax Amount], [Total Net Amount], [Total Discount], [RtrId],
	--[RMID], [SMID], [MRP], [Credit Note/Replacement Reference No], [UsrId], [Visibility], [CGST Perc], [SGST Perc], [IGST Perc],[UTGST Perc],[CESS Perc])
	
	--SELECT [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount] ,ISNULL(Sum([Tax Amount Line Level]),0) AS [Tax Amount Line Level],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0) 
	--from #SRNSALESRETURNTEMP
	--	PIVOT
	--		(
	--			SUM([Tax Percentage])
	--			FOR [TaxName] IN ([CGST],[SGST],[IGST],[UTGST],[CESS])
	--		) AS P
	--GROUP BY [Credit Note Reference No],[Distributor Code],[Distributor Name],[Distributor Address1],[Distributor Address2],[Distributor Address3],
	--[PinCode],[PhoneNo],[Tax Type],[TIN Number],[Deposit Amount],[CST Number],[LST Number],[Licence Number],[Drug Licence Number 1],[Drug1 Expiry Date], 
	--[Drug Licence Number 2],[Drug2 Expiry Date],[Pesticide Licence Number],[Pesticide Expiry Date],[SalId] ,[Invoice Number],[Invoice Date],[ReturnId] ,
	--[Sales Return Number],[Sales Return Date],[Sales Man],[Route],[Retailer Code],[Retailer Name],[Retailer Phone Number],[Retailer CST Number],
	--[Retailer Drug Lic  Number],[Retailer Lic Number],[Retailer Tin Number],[Retailer Address],[Product Company Code],[Product Company Name],[Product Short Code],
	--[Product Short Name],[Product Name], [Product Slno],[Stock Type],[Return Quantity],[Selling Rate],[Gross Amount],[Special Discount],[Scheme Discount],
	--[Distributor Discount],[Cash Discount],[Line level Net Amount],[Reason],[Type],[Mode],[Total Gross Amount],[Total Special Discount],[Total Scheme Discount],
	--[Total Distributor Discount],[Total Cash Discount],[Total Tax Amount],	[Total Net Amount],[Total Discount],[RtrId],
	--[RMID],[SMID] ,[MRP],[Credit Note/Replacement Reference No], [UsrId], [Visibility],isnull([CGST],0),isnull([SGST],0),isnull([IGST],0),isnull([UTGST],0),isnull([CESS],0)
	--order by Salid,[Product Slno],[Product Short Code] Asc
	
	UPDATE A SET RtrGSTTinNo = B.ColumnValue FROM RptSRNSALESRETURN A inner join #RetailerGSTIN B ON A.Rtrid =B.Rtrid 
	

	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='Irn' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD Irn Varchar(100) 
	END
	 
	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedInvoice' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD SignedInvoice Varchar(8000)
	END
	 
	IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name ='SignedQRCode' )
	BEGIN
		ALTER TABLE RptSRNSALESRETURN ADD SignedQRCode Varchar(8000)
	END

	IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('Irn'))
	BEGIN
		UPDATE A SET A.Irn=B.Irn
		FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
		AND A.[Sales Return Number]  = B.Invoice_no			 
	END

	
	IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('SignedInvoice'))
	BEGIN
		UPDATE A SET A.SignedInvoice=B.SignedInvoice
		FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
		AND A.[Sales Return Number]  = B.Invoice_no			 
	END

	IF EXISTS (SELECT * FROM SysColumns WHERE ID = OBJECT_ID('RptSRNSALESRETURN') AND name IN ('SignedQRCode'))
	BEGIN
		UPDATE A SET A.SignedQRCode =B.SignedQRCode 
		FROM RptSRNSALESRETURN A INNER JOIN EInvoice_Acknowledgment B ON A.ReturnId = B.Invoice_Id AND B.TransId = 2
		AND A.[Sales Return Number]  = B.Invoice_no			 
	END

	------------------ Till here -----------------
	--Added by Mohana  CRCRSTPAR0052
	DELETE FROM RptSRNTaxFinalTemplate WHERE UsrId = @Pi_UsrId 
	INSERT INTO RptSRNTaxFinalTemplate(ReturnId,ReturnCode,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
	SELECT Returnid,REturnCode,0 Prdslno,TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmt) TaxableAmt,SUM(TaxAmt) TaxAmt,@Pi_UsrId      
	FROM 
	(
	SELECT DISTINCT SI.Returnid,S.REturnCode,Prdslno,SI.TaxId,TaxCode,TaxName,TaxPerc,TaxableAmt,TaxAmt     
	FROM ReturnproductTax SI , TaxConfiguration T,REturnHeader S,RptSRNSALESRETURN B      
	WHERE SI.TaxId = T.TaxId and SI.ReturnId = S.ReturnId and S.returncode = B.[Sales Return Number]  and B.UsrId = @Pi_UsrId      
	)A GROUP BY Returnid,REturnCode,TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmt) > 0  
END
GO
--E-Invoice Till Here--------------------
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptCmpWisePurchase_Excel')
DROP TABLE RptCmpWisePurchase_Excel
GO
CREATE TABLE RptCmpWisePurchase_Excel(
	[CmpId] [bigint] NULL,
	[CmpName] [nvarchar](100) NULL,
	[SpmId] [int] NULL,
	[SpmName] [varchar](50) NULL,
	[SpmTinNo] [nvarchar](50) NULL,
	[PurRcptId] [bigint] NULL,
	[PurRcptRefNo] [nvarchar](100) NULL,
	[InvDate] [datetime] NULL,
	[CmpInvNo] [nvarchar](100) NULL,
	[CmpInvDate] [datetime] NULL,
	[UsrId] [int] NULL,
	[Gross Amount] [numeric](38, 6) NULL,
	[Scheme Disc.] [numeric](38, 6) NULL,
	[Other Charges Addition] [numeric](38, 6) NULL,
	[Disc] [numeric](38, 6) NULL,
	[FreightCharges] [numeric](38, 6) NULL,
	[Qty in Kg] [numeric](38, 6) NULL,
	[CD Disc] [numeric](38, 6) NULL,
	[Tax] [numeric](38, 6) NULL,
	[BED] [numeric](38, 6) NULL,
	[CESS] [numeric](38, 6) NULL,
	[TCS Amt] [numeric](38, 6) NULL,
	[Net Amt.] [numeric](38, 6) NULL
) ON [PRIMARY]
GO
DELETE FROM RptExcelHeaders WHERE RptId=23 AND SlNo>21
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) 
SELECT 23,22,'[TCS Amt]','TCS Amt.',1,1   UNION ALL
Select 23,23,'[Net Amt.]','Net Amt.',1,1 
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_RptCmpWisePurchase' AND xtype='P')
DROP PROCEDURE Proc_RptCmpWisePurchase
GO
--EXEC Proc_RptCmpWisePurchase 23,1,0,'CoreStocky',0,0,1
CREATE PROCEDURE Proc_RptCmpWisePurchase
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	--@Po_Errno		INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_RptCmpWisePurchase
* PURPOSE		: Company wise Purchase Report
* CREATED		: 
* CREATED DATE	: 
* MODIFIED
-------------------------------------------------------------------------------------------------------
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* Date            Name              PMS NO            CR/BUG      Remarks
-------------------------------------------------------------------------------------------------------
* {date}		{developer}			{brief modification description}
* 28.02.2013	Aravindh Deva C		Parle-GR005-CR002 Tin Number required in Company wise Purchase Report
* 2013-05-10    Alphonse J          Other charge addition deduction Modified ICRSTPAR0033
* 2019-03-06    Deepak Philip       ILCRSTPAR3657      BUG     Script has been modified to take the claim free products as FREE and Slno validation removed in gross.
* 18-09-2020   S.Moorthi		    DABCS202100016		CR		TCSTaxAmt column added
*********************************/
BEGIN
SET NOCOUNT ON
DECLARE @NewSnapId 	AS	INT
DECLARE @DBNAME		AS 	nvarchar(50)
DECLARE @TblName 	AS	nvarchar(500)
DECLARE @TblStruct 	AS	nVarchar(4000)
DECLARE @TblFields 	AS	nVarchar(4000)
DECLARE @sSql		AS 	nVarChar(4000)
DECLARE @ErrNo	 	AS	INT
DECLARE @PurDBName	AS	nVarChar(50)
DECLARE @FromDate	AS	DATETIME
DECLARE @ToDate		AS	DATETIME
DECLARE @CmpId	 	AS	INT
DECLARE @PurRcptID 	AS	INT
DECLARE @EXLFlag	AS	INT
--select * from reportfilterdt
SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @PurRcptID = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,197,@Pi_UsrId))
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
Create TABLE #RptCmpWisePurchase
(
		CmpId 				INT,
		CmpName  			NVARCHAR(50),		
		PurRcptId 			BIGINT,
		PurRcptRefNo 		NVARCHAR(50),
		InvDate 			DATETIME,
		GrossAmount 		NUMERIC(38,6),
		SlNo 				INT,
		RefCode 			NVARCHAR(25),
		FieldDesc 			NVARCHAR(100),
		LineBaseQtyAmount 	NUMERIC(38,6),
		LessScheme 			NUMERIC(38,6),
		OtherChgAddition	NUMERIC(38,6),	
		OtherChgDeduction	NUMERIC(38,6),		
		NetAmount 			NUMERIC(38,6),
		CmpInvNo			NVARCHAR(25),
		CmpInvDate 			DATETIME,
		TCSTaxAmt NUMERIC(38,6) ---AMLCS202100043
	)
SET @TblName = 'RptCmpWisePurchase'
SET @TblStruct = '
		CmpId 				INT,
		CmpName  			NVARCHAR(50),		
		PurRcptId 			BIGINT,
		PurRcptRefNo 		NVARCHAR(50),
		InvDate 			DATETIME,
		GrossAmount 		NUMERIC(38,6),
		SlNo 				INT,
		RefCode 			NVARCHAR(25),
		FieldDesc 			NVARCHAR(100),
		LineBaseQtyAmount 	NUMERIC(38,6),
		LessScheme 			NUMERIC(38,6),
		OtherChgAddition	NUMERIC(38,6),	
		OtherChgDeduction	NUMERIC(38,6),	
		NetAmount 			NUMERIC(38,6),
		CmpInvNo			NVARCHAR(25),
		CmpInvDate 			DATETIME,
		TCSTaxAmt NUMERIC(38,6)'  ---AMLCS202100043  
			
SET @TblFields = 'CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
		 ,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpInvNo,CmpInvDate,TCSTaxAmt'
/*		 
--Parle-GR005-CR002
	SELECT S.SpmId [SpmId],S.SpmName [SpmName],ISNULL(D.ColumnValue,'') [SpmTINNo]
	INTO #SupplierTIN
	FROM UdcMaster M (NOLOCK)
	INNER JOIN UdcDetails D (NOLOCK) ON M.UdcMasterId=D.UdcMasterId AND M.MasterId=D.MasterId 
	AND M.ColumnName='TIN Number' AND M.MasterId IN (SELECT DISTINCT MasterId FROM UdcHD (NOLOCK) WHERE MasterName='Supplier Master')
	RIGHT OUTER JOIN Supplier S ON S.SpmId=D.MasterRecordId	
--Parle-GR005-CR002	
*/	 
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
--SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
--	EXEC Proc_GRNListing @Pi_UsrId
	SELECT PurRcptId,PurRcptRefNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpInvNo,InvDate,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,
		   ShrtBaseQty,ExsBaseQty,RefuseSale,PrdUnitLSP,PrdGrossAmount,Slno,RefCode,FieldDesc ,LineBaseQtyAmount,
		   PrdNetAmount,status,GoodsRcvdDate,LessScheme,OtherChgAddition,OtherChgDeduction,TotalAddition,TotalDeduction,GrossAmount,NetPayable,
		   DifferenceAmount,PaidAmount,TotalTCSTaxAmt,NetAmount,CmpId,CmpName,UsrId
	INTO #TempGrnListing FROM 
		(
			Select PR.PurRcptId,PurRcptRefNo,PRP.PrdId,PrdDCode,PrdName,PRP.PrdBatId,PrdBatCode,CmpInvNo,InvDate,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,
			ShrtBaseQty,ExsBaseQty,RefuseSale,PrdUnitLSP,PrdGrossAmount,Slno,PRL.RefCode,FieldDesc ,LineBaseQtyAmount,
			PrdNetAmount,PR.status,GoodsRcvdDate,LessScheme,
			--Modified By Alphonse J on 2013-05-10 ICRSTPAR0033
			--CASE PRC.Effect WHEN 0 THEN ISNULL(PRC.Amount,0) ELSE 0 END AS OtherChgAddition,
			--CASE PRC.Effect WHEN 1 THEN ISNULL(PRC.Amount,0) ELSE 0 END AS OtherChgDeduction,
			ISNULL(PRC.Amount,0) AS OtherChgAddition,
			ISNULL(PRC1.Amount,0) AS OtherChgDeduction,
			TotalAddition,TotalDeduction,GrossAmount,NetPayable,DifferenceAmount,PaidAmount,
			TotalTCSTaxAmt,NetAmount,@Pi_UsrId AS UsrId,PR.CmpId,CmpName
			FROM PurchaseReceipt PR
			INNER JOIN PurchaseReceiptProduct PRP ON PR.PurRcptId = PRP.PurRcptId
			INNER JOIN PurchasereceiptLineAmount PRL ON PR.PurRcptId = PRL.PurRcptId
			and PRL.PrdSlNo = PRP.PrdSlNo
			INNER JOIN PurchaseSequenceMaster PS ON PR.PurSeqId = PS.PurSeqId
			INNER JOIN PurchaseSequenceDetail PD ON PD.PurSeqId = PS.PurSeqId and PRL.RefCode = PD.RefCode
			INNER JOIN Company C ON C.CmpId = PR.CmpId
			INNER JOIN Supplier S ON S.SpmId = PR.SpmId
			INNER JOIN Transporter T ON T.TransporterId = PR.TransporterId
			INNER JOIN Location L ON L.LcnId = PR.LcnId
			INNER JOIN Product P ON P.PrdId = PRP.PrdId
			INNER JOIN ProductBatch  PB ON PB.PrdId = PRP.PrdId  and PB.PrdBatId = PRP.PrdBatId
			LEFT OUTER JOIN PurchaseReceiptOtherCharges PRC ON PR.PurRcptId = PRC.PurRcptId AND PRC.Effect=0
			LEFT OUTER JOIN PurchaseReceiptOtherCharges PRC1 ON PR.PurRcptId = PRC1.PurRcptId AND PRC1.Effect=1
			WHERE PR.Status=1 AND PR.GoodsRcvdDate BETWEEN @FromDate AND @ToDate AND
			( C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
						C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
					AND ( PR.PurRcptId = (CASE @PurRcptID WHEN 0 THEN PR.PurRcptId ELSE 0 END) OR
						PR.PurRcptId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,197,@Pi_UsrId)))
					and PRP.PrdSlNo > 0 
			UNION ALL
			Select PR.PurRcptId,PurRcptRefNo,
			0 as PrdId,'' as PrdDCode,'' as PrdName,0 as PrdBatId,'' as PrdBatCode,Pr.CmpInvNo,InvDate,0 as InvBaseQty,0 as RcvdGoodBaseQty,
			0 as UnSalBaseQty,0 as ShrtBaseQty,0 as ExsBaseQty,0 AS RefuseSale,0 as PrdUnitLSP,
			0 as PrdGrossAmount,0 as Slno,'' as RefCode,'Free' as FieldDesc ,0 as LineBaseQtyAmount,--ILCRSTPAR3657
			0 as PrdNetAmount,PR.status,GoodsRcvdDate,
			LessScheme,
			--CASE PRC.Effect WHEN 0 THEN ISNULL(PRC.Amount,0) ELSE 0 END AS OtherChgAddition,
			--CASE PRC.Effect WHEN 1 THEN ISNULL(PRC.Amount,0) ELSE 0 END AS OtherChgDeduction,
			ISNULL(PRC.Amount,0) AS OtherChgAddition,
			ISNULL(PRC1.Amount,0) AS OtherChgDeduction,
			TotalAddition,TotalDeduction,GrossAmount,NetPayable,DifferenceAmount,PaidAmount,TotalTCSTaxAmt,NetAmount,@Pi_UsrId AS UsrId,PR.CmpId,CmpName
			from purchasereceipt PR
			Inner join purchasereceiptclaimScheme PRCS on PRCS.PurRcptId = PR.PurRcptId
			INNER JOIN Company C ON C.CmpId = PR.CmpId
			INNER JOIN Supplier S ON S.SpmId = PR.SpmId
			INNER JOIN Transporter T ON T.TransporterId = PR.TransporterId
			INNER JOIN Location L ON L.LcnId = PR.LcnId
			INNER JOIN StockType ST ON ST.StockTypeId = PRCS.StockTypeId
			LEFT OUTER JOIN PurchaseReceiptOtherCharges PRC ON PR.PurRcptId = PRC.PurRcptId AND PRC.Effect=0
			LEFT OUTER JOIN PurchaseReceiptOtherCharges PRC1 ON PR.PurRcptId = PRC1.PurRcptId AND PRC1.Effect=1
			LEFT OUTER JOIN Product P ON P.PrdId = PRCS.PrdId
			LEFT OUTER JOIN ProductBatch  PB ON PB.PrdId =PRCS.PrdId  and PB.PrdBatId = PRCS.PrdBatId
			WHERE PR.Status=1 AND PR.GoodsRcvdDate BETWEEN @FromDate AND @ToDate AND
			( C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
						C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
					AND ( PR.PurRcptId = (CASE @PurRcptID WHEN 0 THEN PR.PurRcptId ELSE 0 END) OR
						PR.PurRcptId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,197,@Pi_UsrId)))
		) AS A
		
		
		
		
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
		 ,LessScheme,OtherChgAddition,OtherChgDeduction,TCSTaxAmt,NetAmount,CmpInvNo,CmpInvDate)
		SELECT DISTINCT CmpId,CmpName,PurRcptId,PurRcptRefno,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,
		dbo.Fn_ConvertCurrency(sum(LineBaseQtyAmount),@Pi_CurrencyId) as LineBaseQtyAmount,
		dbo.Fn_ConvertCurrency(LessScheme,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(OtherChgAddition,@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(OtherChgDeduction,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(TotalTCSTaxAmt,@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(NetAmount,@Pi_CurrencyId),CmpInvNo,CmpInvdate
		From ( SELECT  cmpid,cmpname,purrcptid,purrcptrefno,GoodsRcvdDate AS InvDate,GrossAmount,slno,
		RefCode,FieldDesc,LineBaseQtyAmount,LessScheme,OtherChgAddition,OtherChgDeduction,TotalTCSTaxAmt,NetAmount,CmpInvNo, InvDate AS CmpInvDate,UsrId	
		FROM #TempGrnListing) x
		Group by
		cmpid,cmpname,purrcptid,purrcptrefno,InvDate,GrossAmount,slno,RefCode,FieldDesc,
		LessScheme,OtherChgAddition,OtherChgDeduction,TotalTCSTaxAmt,NetAmount,CmpInvNo,CmpInvDate,usrid	
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select DISTINCT Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,(Select max(SLNO) + 1 From PurchaseSequenceDetail) as SlNo,'AAA' as RefCode,'Net Amt.' as FieldDesc,
	NetAmount as LineBaseQtyAmount,LessScheme,0,0,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase Where  Slno in (Select MAX(slno) AS SLNO From #RptCmpWisePurchase)
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,-1 as SlNo,'BBB' as RefCode,'Other Charges Addition' as FieldDesc,
	OtherChgAddition as LineBaseQtyAmount,LessScheme,OtherChgAddition,0,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase Where  Slno in (Select min(slno) AS SLNO From #RptCmpWisePurchase)
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select DISTINCT Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,-2 as SlNo,'CCC' as RefCode,'Scheme Disc.' as FieldDesc,
	LessScheme as LineBaseQtyAmount,LessScheme,0,0,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase Where  Slno in (Select min(slno) AS SLNO From #RptCmpWisePurchase)
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select DISTINCT Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,-3 as SlNo,'DDD' as RefCode,'Gross Amount' as FieldDesc,
	GrossAmount  as LineBaseQtyAmount,LessScheme,0,0,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase --Where  Slno in (Select min(slno) AS SLNO  From #RptCmpWisePurchase)--ILCRSTPAR3657
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,-1.5 as SlNo,'EEE' as RefCode,'Other Charges Dedection' as FieldDesc,
	OtherChgDeduction as LineBaseQtyAmount,LessScheme,0,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase Where  Slno in (Select min(slno) AS SLNO From #RptCmpWisePurchase WHERE OtherChgDeduction>0)-- AND OtherChgDeduction>0
	
	INSERT INTO #RptCmpWisePurchase (CmpId,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount
	,LessScheme,OtherChgAddition,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt)
	Select Cmpid,CmpName,PurRcptId,PurRcptRefNo,InvDate,GrossAmount,-1.7 as SlNo,'FFF' as RefCode,'TCS Tax' as FieldDesc,
	TCSTaxAmt as LineBaseQtyAmount,LessScheme,0,OtherChgDeduction,NetAmount,CmpinvNo,CmpInvdate,TCSTaxAmt
	From #RptCmpWisePurchase Where  Slno in (Select min(slno) AS SLNO From #RptCmpWisePurchase)-- AND OtherChgDeduction>0
	
	
	
	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptCmpWisePurchase ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +
			' CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
			+' (PurRcptId = (CASE ' + CAST(@PurRcptID AS nVarchar(10)) + ' WHEN 0 THEN PurRcptId ELSE 0 END) OR ' +
			' PurRcptId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',197,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
			+ ' ( INVDATE Between ''' + @FromDate + ''' AND ''' + @ToDate + '''' + ' and UsrId = ' + CAST(@Pi_UsrId AS nVarChar(10)) + ') and (Slno > 0)  '
		EXEC (@SSQL)
		PRINT 'Retrived Data From Purged Table'
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptCmpWisePurchase'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	   END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	PRINT @ErrNo
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptCmpWisePurchase ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		--SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	   END
END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptCmpWisePurchase
	--Parle-GR005-CR002
	--select * from #RptCmpWisePurchase
	SELECT Rpt.*,RP.SpmId [SpmId],S.SpmName [SpmName],ISNULL(S.SpmTinNo,'') [SpmTINNo] 
	INTO #RptCmpWisePurchaseWtSpmTINNo
	FROM #RptCmpWisePurchase Rpt 
	INNER JOIN PurchaseReceipt RP (nolock) ON RPT.PurRcptId=RP.PurRcptId
	INNER JOIN Supplier S ON RP.SpmId=S.SpmId
	SELECT * FROM #RptCmpWisePurchaseWtSpmTINNo
	--Parle-GR005-CR002
	
	SELECT @EXLFlag=Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId
	IF @EXLFlag=1
	BEGIN
		--EXEC Proc_RptCmpWisePurchase 23,1,0,'CoreStocky',0,0,1
		/******************************************************************************************************/
		--Create Table in Dynamic Cols
		--Cursors
		DECLARE  @Values NUMERIC(38,6)
		DECLARE  @Desc VARCHAR(80)
		DECLARE  @InvDate DATETIME	
		DECLARE  @cCmpId INT
		DECLARE  @cPurRcptId INT
		DECLARE  @CmpInvNo NVARCHAR(100)	
		DECLARE  @SlNo INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		DECLARE  @iCnt INT
		DECLARE  @Name NVARCHAR(100)
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptCmpWisePurchase_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE [RptCmpWisePurchase_Excel]
		DELETE FROM RptExcelHeaders Where RptId=23 AND SlNo>11--Parle-GR005-CR002 -- SlNo>8
		CREATE TABLE RptCmpWisePurchase_Excel (CmpId BIGINT,CmpName NVARCHAR(100),
		SpmId	INT,SpmName VARCHAR(50),SpmTinNo NVARCHAR(50),--Parle-GR005-CR002
		PurRcptId BIGINT,PurRcptRefNo NVARCHAR(100),InvDate DATETIME,
						 		CmpInvNo NVARCHAR(100),CmpInvDate DateTime,UsrId INT)
		SET @iCnt=12--Parle-GR005-CR002 --SET @iCnt=9
		DECLARE Crosstab_Cur CURSOR FOR
		SELECT DISTINCT(Fielddesc),SlNo FROM #RptCmpWisePurchase ORDER BY SLNo
		OPEN Crosstab_Cur
			   FETCH NEXT FROM Crosstab_Cur INTO @Column,@SlNo
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='ALTER TABLE RptCmpWisePurchase_Excel ADD ['+ @Column +'] NUMERIC(38,6)'
					EXEC (@C_SSQL)
					
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
					EXEC (@C_SSQL)
					SET @iCnt=@iCnt+1
					FETCH NEXT FROM Crosstab_Cur INTO @Column,@SLNo
				END
		CLOSE Crosstab_Cur
		DEALLOCATE Crosstab_Cur
		--Insert table values
		DELETE FROM RptCmpWisePurchase_Excel
		INSERT INTO RptCmpWisePurchase_Excel (CmpId ,CmpName ,SpmId,SpmName,SpmTinNo,PurRcptId ,PurRcptRefNo ,
		InvDate ,CmpInvNo ,CmpInvDate ,UsrId)
		SELECT DISTINCT CmpId ,CmpName ,SpmId,SpmName,SpmTinNo,PurRcptId ,PurRcptRefNo ,InvDate ,CmpInvNo ,CmpInvDate,@Pi_UsrId
				--FROM #RptCmpWisePurchase
				FROM #RptCmpWisePurchaseWtSpmTINNo ORDER BY CmpId,SpmId--Parle-GR005-CR002
				
		DECLARE Values_Cur CURSOR FOR
		SELECT DISTINCT  CmpId,PurRcptId,InvDate,CmpInvNo,FieldDesc,LineBaseQtyAmount FROM #RptCmpWisePurchase
		OPEN Values_Cur
			   FETCH NEXT FROM Values_Cur INTO @cCmpId,@cPurRcptId,@InvDate,@CmpInvNo,@Desc,@Values
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptCmpWisePurchase_Excel SET ['+ @Desc +']= '+ CAST(ISNULL(@Values,0) AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE CmpId='+ CAST(@cCmpId AS VARCHAR(1000)) + ' AND PurRcptId=' + CAST(@cPurRcptId AS VARCHAR(1000)) + '
					AND InvDate=''' + CAST(@InvDate AS VARCHAR(1000))+''' AND CmpInvNo=''' + CAST(@CmpInvNo As VARCHAR(1000)) + ''' AND UsrId=' + CAST(@Pi_UsrId AS VARCHAR(10))+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM Values_Cur INTO @cCmpId,@cPurRcptId,@InvDate,@CmpInvNo,@Desc,@Values
				END
		CLOSE Values_Cur
		DEALLOCATE Values_Cur
		-- To Update the Null Value as 0
		DECLARE NullCursor_Cur CURSOR FOR
		SELECT Name FROM dbo.sysColumns where id = object_id(N'[RptCmpWisePurchase_Excel]')
		OPEN NullCursor_Cur
			   FETCH NEXT FROM NullCursor_Cur INTO @Name
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptCmpWisePurchase_Excel SET ['+ @Name +']= '+ CAST(0 AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE '+'['+ @Name +']'+'IS NULL'+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM NullCursor_Cur INTO @Name
				END
		CLOSE NullCursor_Cur
		DEALLOCATE NullCursor_Cur
		/******************************************************************************************************/
	END
RETURN
END--Aravindh Till Here
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='RptBillWiseSalesReportParle_Excel' AND xtype='U')
DROP TABLE RptBillWiseSalesReportParle_Excel
GO
CREATE TABLE RptBillWiseSalesReportParle_Excel(
	[Bill Number] [nvarchar](50) NULL,
	[Order Ref No] [varchar](50) NULL,
	[Bill Type] [nvarchar](25) NULL,
	[Bill Mode] [nvarchar](25) NULL,
	[Bill Date] [datetime] NULL,
	[Retailer Type] [varchar](50) NULL,
	[Retailer Code] [nvarchar](50) NULL,
	[Retailer Name] [nvarchar](150) NULL,
	[Gross Amount] [numeric](38, 6) NULL,
	[Scheme Disc] [numeric](38, 6) NULL,
	[Sales Return] [numeric](38, 6) NULL,
	[Replacement] [numeric](38, 6) NULL,
	[Discount] [numeric](38, 6) NULL,
	[Tax Amount] [numeric](38, 6) NULL,
	[WindowDisplayAmount] [numeric](38, 6) NULL,
	[Credit Adjustmant] [numeric](38, 6) NULL,
	[Debit Adjustment] [numeric](38, 6) NULL,
	[TCS Tax Amount] [numeric](38, 6) NULL,
	[Net Amount] [numeric](38, 6) NULL,
	[DlvStatus] [int] NULL
) ON [PRIMARY]
GO
DELETE FROM RptExcelHeaders WHERE RptId=285 AND SlNo>17
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
SELECT 285,18,'TCS Tax Amount','TCS Tax Amount',1,1 UNION
SELECT 285,19,'Net Amount','Net Amount',1,1 UNION
SELECT 285,20,'DlvStatus','DlvStatus',0,1 
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_RptBillWiseSalesReportParle' AND xtype='P')
DROP PROCEDURE Proc_RptBillWiseSalesReportParle
GO
---EXEC Proc_RptBillWiseSalesReportParle 285,1,0,'PARLE',0,0,1
CREATE PROCEDURE [Proc_RptBillWiseSalesReportParle]  
(  
 @Pi_RptId  INT,  
 @Pi_UsrId  INT,  
 @Pi_SnapId  INT,  
 @Pi_DbName  nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
/****************************************************************************  
* PROCEDURE  : Proc_RptBillWiseSalesReportParle  
* PURPOSE    : To Generate Sales Bill Wise  
* CREATED BY : Boopathy.P  
* CREATED ON : 30/07/2007  
* MODIFICATION  
*****************************************************************************  
* DATE        AUTHOR      CR\BUR			USER STORY ID					DESCRIPTION  
07/12/2007  MURUGAN.R														Adding Retailer Category  
01-07-2014  Jai Ganesh R													Order By Billdate, Bll Number added in the Final Output
08/05/2020	MURUGAN.R		CR				PARCS202100016					Bill Doc No and Retailer Type added
*****************************************************************************/  
SET NOCOUNT ON  
BEGIN  
DECLARE @NewSnapId  AS INT  
DECLARE @DBNAME  AS  nvarchar(50)  
DECLARE @TblName  AS nvarchar(500)  
DECLARE @TblStruct  AS nVarchar(4000)  
DECLARE @TblFields  AS nVarchar(4000)  
DECLARE @sSql  AS  nVarChar(4000)  
DECLARE @ErrNo   AS INT  
DECLARE @PurDBName AS nVarChar(50)  
--Filter Variable  
DECLARE @FromDate AS DATETIME  
DECLARE @ToDate   AS DATETIME  
DECLARE @FromBillNo AS  BIGINT  
DECLARE @TOBillNo   AS  BIGINT  
DECLARE @CmpId      AS  INT  
DECLARE @LcnId      AS  INT  
DECLARE @SMId   AS INT  
DECLARE @RMId   AS INT  
DECLARE @RtrId   AS INT  
DECLARE @BillType    AS INT  
DECLARE @BillMode    AS INT  
DECLARE @CtgLevelId AS  INT  
DECLARE @RtrClassId AS  INT  
DECLARE @CtgMainId  AS  INT  
DECLARE @BillStatus AS INT  
DECLARE @CancelValue AS INT 
DECLARE @SalId AS BIGINT 
--Till Here  
--Assgin Value for the Filter Variable  
SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))  
SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))  
SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))  
SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))  
SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))  
SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
SET @LcnId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))  
SET @SalId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)) 
SET @BillType =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId))  
SET @BillMode =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId))  
SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))  
SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))  
SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))  
SET @BillStatus =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId))  
SET @CancelValue =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,193,@Pi_UsrId))  
--Till Here  
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)  
--Till Here  
CREATE TABLE #RptBillWiseSalesReportParle  
(  
  [Bill Number]         NVARCHAR(50),  
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,  
  [Retailer Name]       NVARCHAR(50),  
  [Gross Amount]        NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6),  
  [Net Amount]          NUMERIC (38,6),  
  [DlvStatus]           INT  
)  
SET @TblName = 'RptBillWiseSalesReportParle'  
SET @TblStruct = '     
  [Bill Number]         NVARCHAR(50),  
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,  
  [Retailer Name]       NVARCHAR(50),  
  [Gross Amount]        NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6),  
  [Net Amount]          NUMERIC (38,6),  
  [DlvStatus]           INT'  
SET @TblFields = '[Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
  [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
  [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[Net Amount],[DlvStatus]'  
IF @Pi_GetFromSnap = 1  
   BEGIN  
 Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId  
 SET @DBNAME =  @DBNAME  
   END  
ELSE  
   BEGIN  
 Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3  
 SET @DBNAME = @PI_DBNAME + @DBNAME  
   END  
IF @Pi_GetFromSnap = 0  --To Generate For New Report Data  
   BEGIN  
 PRINT @CtgLevelId   
 IF @FromBillNo <> 0 AND @TOBillNo <> 0  
 BEGIN  
  IF @CtgLevelId=1  
  BEGIN   
   IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TempRetailerCategory')  
    BEGIN       
     DROP TABLE TempRetailerCategory  
    END   
    SELECT * INTO TempRetailerCategory FROM RetailerCategory   
     WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgLevelId IN (SELECT CtgLevelId FROM RetailerCategoryLevel   
      WHERE CtgLevelId=1) AND CtgMainId=(CASE @CtgMainId WHEN 0 THEN CtgMainId ELSE 0 END) OR  
       CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   INSERT INTO #RptBillWiseSalesReportParle([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],[Net Amount],[DlvSts]  
    FROM view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,TempRetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
--   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
--   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
--   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
--   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId    
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))
     AND (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR
					SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))
					  
     AND (DlvSts=(CASE @BillStatus WHEN 0 THEN DlvSts ELSE @BillStatus END))   
     AND ([Bill Date] BETWEEN @FromDate and @ToDate)  
  END  
        ELSE  
        BEGIN   
   INSERT INTO #RptBillWiseSalesReportParle([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],[Net Amount],[DlvSts]  
    FROM view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId    
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId))) 
     AND (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR
					SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))
					   
     AND (DlvSts=(CASE @BillStatus WHEN 0 THEN DlvSts ELSE @BillStatus END))   
     AND ([Bill Date] Between @FromDate and @ToDate)  
  END   
 END  
 ELSE  
 BEGIN  
  IF @CtgLevelId=1  
  BEGIN   
   IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TempRetailerCategory')  
    BEGIN       
     DROP TABLE TempRetailerCategory  
    END   
    SELECT * INTO TempRetailerCategory FROM RetailerCategory   
     WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgLevelId IN (SELECT CtgLevelId FROM RetailerCategoryLevel   
      WHERE CtgLevelId=1) AND CtgMainId=(CASE @CtgMainId WHEN 0 THEN CtgMainId ELSE 0 END) OR  
       CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   INSERT INTO #RptBillWiseSalesReportParle([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],[Net Amount],[DlvSts]  
     from view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,TempRetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
--   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
--   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
--   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
--   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId   
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId))) 
     AND (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR
					SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))
										   
     AND ([DlvSts]=(CASE @BillStatus WHEN 0 THEN [DlvSts] ELSE 0 END) OR  
       [DlvSts] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId)))  
     AND ([Bill Date] Between @FromDate and @ToDate)  
  END   
  ELSE  
  BEGIN   
   INSERT INTO #RptBillWiseSalesReportParle([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
    [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
    [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[Net Amount],[DlvStatus])  
   SELECT [Bill Number],[Bill Type],[Bill Mode],[Bill Date],  
      [Retailer Name],[Gross Amount],[Scheme Disc]  
     ,[Sales Return], [Replacement],[Discount],[Tax Amount],[Credit Adjustment]  
     ,[Debit Adjustment],[Net Amount],[DlvSts]  
     from view_SalesBillWise A  
   INNER JOIN (  
   SELECT DISTINCT R.Rtrid FROM Retailer R WITH (NOLOCK),RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK)  
   ,RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL  
   WHere  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
   AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
   AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
   RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))  
   AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
   RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))  
   AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR  
   RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))  
   AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR  
   RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
     )X On  X.Rtrid=A.RTRId   
     WHERE (A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR  
       A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))  
     AND (RMId=(CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR  
       RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))  
    AND (LcnId=(CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR  
       LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))  
     AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR  
       SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))  
     AND ([BillTypeId] =(CASE @BillType WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
       [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,17,@Pi_UsrId)))  
     AND ([BillModeId]=(CASE @BillMode WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
       [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,33,@Pi_UsrId)))  
     AND (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR
					SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))
					  
     AND ([DlvSts]=(CASE @BillStatus WHEN 0 THEN [DlvSts] ELSE 0 END) OR  
       [DlvSts] in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,192,@Pi_UsrId)))  
     AND ([Bill Date] Between @FromDate and @ToDate)  
  END    
 END  
 /*  
  For ProductCategory Value and Product Filter  
  R.PrdId = (CASE @fPrdCatPrdId WHEN 0 THEN R.PrdId Else 0 END) OR  
  R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))  
  AND R.PrdId = (CASE @fPrdId WHEN 0 THEN R.PrdId Else 0 END) OR  
  R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))  
 */  
 IF LEN(@PurDBName) > 0  
 BEGIN  
  EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT  
  SET @SSQL = 'INSERT INTO ##RptBillWiseSalesReportParle ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +  
   'WHERE (RtrId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN RtrId ELSE 0 END) OR  
     RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',3,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND (RMId=(CASE ' + CAST(@RMId AS INTEGER) + ' WHEN 0 THEN RMId ELSE 0 END) OR  
     RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',2,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND (SMId=(CASE '+ CAST(@SMId AS INTEGER) + 'WHEN 0 THEN SMId ELSE 0 END) OR  
     SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',1,' + CAST(@Pi_UsrId as INTEGER) + ')))  
    AND (LcnId=(CASE '+ CAST(@LcnId AS INTEGER) + 'WHEN 0 THEN LcnId ELSE 0 END) OR  
     LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',22,' + CAST(@Pi_UsrId as INTEGER) + ')))  
            AND ([BillTypeId] =(CASE ' + CAST(@BillType AS INTEGER) + ' WHEN 0 THEN [BillTypeId] ELSE 0 END) OR  
     [BillTypeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',17,' + CAST(@Pi_UsrId as INTEGER) +')))  
            AND ([BillModeId]=(CASE ' + CAST(@BillMode AS INTEGER) + 'WHEN 0 THEN [BillModeId] ELSE 0 END) OR  
     [BillModeId] in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',33,' + CAST(@Pi_UsrId as INTEGER) + ')))  
            AND ([Bill Date] Between ' + @FromDate +' and ' + @ToDate + ')  
            AND (SalId Between ' + @FromBillNo +' and ' + @TOBillNo +')'  
  EXEC (@SSQL)  
  PRINT 'Retrived Data From Purged Table'  
 END  
 IF @Pi_SnapRequired = 1  
    BEGIN  
  SELECT @NewSnapId = @Pi_SnapId  
  EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
  IF @ErrNo = 0  
     BEGIN  
   SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +  
    '(SnapId,UserId,RptId,' + @TblFields + ')' +  
    ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptBillWiseSalesReportParle'  
   EXEC (@SSQL)  
   PRINT 'Saved Data Into SnapShot Table'  
     END  
    END  
   END  
ELSE    --To Retrieve Data From Snap Data  
   BEGIN  
 EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
 PRINT @ErrNo  
 IF @ErrNo = 0  
    BEGIN  
  SET @SSQL = 'INSERT INTO #RptBillWiseSalesReportParle ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +  
   ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +  
   ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
   ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))  
  EXEC (@SSQL)  
  PRINT 'Retrived Data From Snap Shot Table'  
    END  
 ELSE  
    BEGIN  
  PRINT 'DataBase or Table not Found'  
    END  
   END  
--Check for Report Data  
Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId  
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptBillWiseSalesReportParle  
-- Till Here  
 IF (@BillStatus=3 AND  @CancelValue=1) OR (@BillStatus=0 AND  @CancelValue=1)  
 BEGIN  
  UPDATE #RptBillWiseSalesReportParle SET [Gross Amount]=0,[Scheme Disc]=0,[Sales Return]=0,[Replacement]=0,[Discount]=0,  
    [Tax Amount]=0,[Credit Adjustmant]=0,[Debit Adjustment]=0,[Net Amount]=0  
    WHERE [DlvStatus]=3  
 END  
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID = @Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
 BEGIN  
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptBillWiseSalesReportParle_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  
  DROP TABLE RptBillWiseSalesReportParle_Excel  
  CREATE TABLE RptBillWiseSalesReportParle_Excel  
  (  
  [Bill Number]         NVARCHAR(50), 
  [Order Ref No]		Varchar(50), 
  [Bill Type]           NVARCHAR(25),  
  [Bill Mode]           NVARCHAR(25),  
  [Bill Date]           DATETIME,
  [Retailer Type]		Varchar(50), 
  [Retailer Code]       NVARCHAR(50),  
  [Retailer Name]       NVARCHAR(150),  
  [Gross Amount]        NUMERIC (38,6),  
  [Scheme Disc]         NUMERIC (38,6),  
  [Sales Return]        NUMERIC (38,6),  
  [Replacement]         NUMERIC (38,6),  
  [Discount]            NUMERIC (38,6),  
  [Tax Amount]          NUMERIC (38,6),  
  [WindowDisplayAmount] NUMERIC (38,6),  
  [Credit Adjustmant]   NUMERIC (38,6),  
  [Debit Adjustment]    NUMERIC (38,6),   
  [TCS Tax Amount] [numeric](38, 6) NULL, 
  [Net Amount]          NUMERIC (38,6),  
  [DlvStatus]           INT  
  )  
  INSERT INTO RptBillWiseSalesReportParle_Excel ([Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
  [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
  [Tax Amount],[Credit Adjustmant],[Debit Adjustment],[TCS Tax Amount],[Net Amount],[DlvStatus])  
   SELECT  [Bill Number],[Bill Type],[Bill Mode],[Bill Date],[Retailer Name],  
   [Gross Amount],[Scheme Disc],[Sales Return],[Replacement],[Discount],  
   [Tax Amount],[Credit Adjustmant],[Debit Adjustment],0 [TCS Tax Amount],[Net Amount],[DlvStatus] 
   FROM #RptBillWiseSalesReportParle  Order by [Bill Date],[Bill Number]
   
   UPDATE RPT SET RPT.[Retailer Code]=R.RtrCode ,
   [Retailer Type]=CASE R.RtrType WHEN 1 THEN 'Retailer'
			    WHEN 2 THEN 'Sub Stockiest'
				WHEN 3 THEN 'Consumer' END ,	  
   [Order Ref No]=SalInvRef
   FROM RptBillWiseSalesReportParle_Excel RPT (NOLOCK),Retailer R (NOLOCK),SalesINvoice SI (NOLOCK)
   WHERE RPT.[Retailer Name]=R.RtrName AND SI.SalInvNo=RPT.[Bill NUmber] AND R.RtrId=SI.RtrId
     
   UPDATE RPT SET RPT.[WindowDisplayAmount]=R.[WindowDisplayAmount] 
   FROM RptBillWiseSalesReportParle_Excel RPT (NOLOCK),
   SalesInvoice R (NOLOCK) WHERE RPT.[Bill Number]=R.SalInvNo  
   
    UPDATE RPT SET RPT.[WindowDisplayAmount]=R.[WindowDisplayAmount],RPT.[TCS Tax Amount]=R.SalTCSTaxAmount FROM RptBillWiseSalesReportParle_Excel RPT (NOLOCK),
   SalesInvoice R (NOLOCK) WHERE RPT.[Bill Number]=R.SalInvNo  
   
 END   
    DELETE FROM #RptBillWiseSalesReportParle WHERE [Gross Amount]=0 AND [Scheme Disc]=0 AND [Sales Return]=0 AND [Replacement]=0 AND [Discount]=0 AND   
    [Tax Amount]=0 AND [Credit Adjustmant]=0 AND [Debit Adjustment]=0 AND [Net Amount]=0  
 SELECT * FROM #RptBillWiseSalesReportParle  Order by [Bill Date],[Bill Number]
 RETURN  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptSRNTemplateLineNo' AND TYPE='P')
DROP PROCEDURE Proc_RptSRNTemplateLineNo
GO
CREATE PROCEDURE Proc_RptSRNTemplateLineNo (@Pi_Type INT) 
AS 
/***********************************************************
*06-10-2020		MOHANA		BZ		PMCS/1020/008		SALES RETURN INVOICE- PRODUCT ISSUE.
************************************************************/
Begin      
DECLARE @ReturnCode varchar(25)      
DECLARE @Prdcnt int      
DECLARE @PrdAva int 
DECLARE @prdChk int      
DECLARE @PrdLine int 
DECLARE @FromReturnId AS  VARCHAR(25)  
DECLARE @ToReturnId   AS  VARCHAR(25)
DECLARE @TempReturnId TABLE (ReturnId INT) 
DECLARE @TmpReturn TABLE (ReturnId INT)
SET @Prdline = (Select LineNumber from BillTemplateHD where PrintType =2 AND UsrId=1 and tempName ='SALESRETURN') 
IF @Prdline = 1         
	SET @Prdline = 15      
ELSE
    SET @Prdline = 10 
IF @Pi_Type=1 
BEGIN   
	INSERT INTO @TmpReturn 
	SELECT SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 32 
End
ELSE   
BEGIN 
	SELECT @FromReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 14 
	SELECT @ToReturnId=SelValue FROM ReportFilterDt Where RptId = 16 And SelId = 15 
END
IF @Pi_Type=1 
BEGIN  
	INSERT INTO @TempReturnId(ReturnId) 
	SELECT DISTINCT ReturnId FROM RptSRNSALESRETURN with (nolock) WHERE usrid = 3 
	AND ReturnId IN( SELECT ReturnId FROM @TmpReturn) 
END 
ELSE 
BEGIN 
	INSERT INTO @TempReturnId(ReturnId) 
	SELECT DISTINCT ReturnId FROM RptSRNSALESRETURN with (nolock) 
	WHERE usrid = 3 AND ReturnId Between @FromReturnId AND @ToReturnId  
END 
DECLARE Cur_Salno Cursor 
FOR 
SELECT DISTINCT A.ReturnId FROM RptSRNSALESRETURN A with (nolock) INNER JOIN @TempReturnId B ON A.ReturnId= B.ReturnId
WHERE usrid = 3    
OPEN Cur_Salno 
FETCH NEXT FROM Cur_Salno INTO @ReturnCode 
WHILE @@FETCH_STATUS =0 
Begin     
	SELECT @prdcnt = count(DISTINCT [Product Short Code]) from RptSRNSALESRETURN A with (nolock) WHERE usrid = 3 and  [ReturnId] = @ReturnCode 
	SET @prdChk =  @prdcnt/@Prdline 
IF @prdchk = 0         
	SET @PrdAva = @Prdline - @prdcnt      
ELSE 
	BEGIN 
		SET @PrdAva =  @prdcnt - (@prdChk*@Prdline) 
		SET @PrdAva =  @Prdline - @PrdAva     
	END		
IF @prdAva = @Prdline    
	SET @PrdAva = 0 
WHILE @prdAva > 0 
BEGIN 
		INSERT INTO RptSRNSALESRETURN( [Distributor Code],
		[Distributor Name],
		[Distributor Address1],
		[Distributor Address2],
		[Distributor Address3],
		[PinCode],
		[PhoneNo],
		[Tax Type],
		[TIN Number],
		[Deposit Amount],
		[CST Number],
		[LST Number],
		[Licence Number],
		[Drug Licence Number 1],
		[Drug1 Expiry Date],
		[Drug Licence Number 2],
		[Drug2 Expiry Date],
		[Pesticide Licence Number],
		[Pesticide Expiry Date],
		[SalId],
		[Invoice Number],
		[Invoice Date],
		[ReturnId],
		[Sales Return Number],
		[Sales Return Date],
		[Sales Man],
		[Route],
		[Retailer Code],
		[Retailer Name],
		[Retailer Phone Number],
		[Retailer CST Number],
		[Retailer Drug Lic  Number],
		[Retailer Lic Number],
		[Retailer Tin Number],
		[Retailer Address],
		[Product Company Code],
		[Product Company Name],
		[Product Short Code],
		[Product Short Name],
		[Product Name],
		[Stock Type],
		[Return Quantity],
		[Selling Rate],
		[Gross Amount],
		[Special Discount],
		[Scheme Discount],
		[Distributor Discount],
		[Cash Discount],
		[Tax Percentage],
		[Tax Amount Line Level],
		[Line level Net Amount],
		[Reason],
		[Type],
		[Mode],
		[Total Gross Amount],
		[Total Special Discount],
		[Total Scheme Discount],
		[Total Distributor Discount],
		[Total Cash Discount],
		[Total Tax Amount],
		[Total Net Amount],
		[Total Discount],
		[RtrId],
		[RMID],
		[SMID],
		[MRP],
		[Credit Note/Replacement Reference No],
		[Credit Note Reference No],		UsrId ,Visibility,
		TCSLineleveltax, --LIVE TCS ISSUE
		TCSHeadleveltax,
		Irn,
		SignedInvoice,
		SignedQRCode )
		select TOP 1 [Distributor Code],
		[Distributor Name],
		[Distributor Address1],
		[Distributor Address2],
		[Distributor Address3],
		[PinCode],
		[PhoneNo],
		[Tax Type],
		[TIN Number],
		[Deposit Amount],
		[CST Number],
		[LST Number],
		[Licence Number],
		[Drug Licence Number 1],
		[Drug1 Expiry Date],
		[Drug Licence Number 2],
		[Drug2 Expiry Date],
		[Pesticide Licence Number],
		[Pesticide Expiry Date],
		[SalId],
		[Invoice Number],
		[Invoice Date],
		[ReturnId],
		[Sales Return Number],
		[Sales Return Date],
		[Sales Man],
		[Route],
		[Retailer Code],
		[Retailer Name],
		[Retailer Phone Number],
		[Retailer CST Number],
		[Retailer Drug Lic  Number],
		[Retailer Lic Number],
		[Retailer Tin Number],
		[Retailer Address],
		[Product Company Code],
		[Product Company Name],
		[Product Short Code],
		[Product Short Name],
		[Product Name],
		[Stock Type],
		[Return Quantity],
		[Selling Rate],
		[Gross Amount],
		[Special Discount],
		[Scheme Discount],
		[Distributor Discount],
		[Cash Discount],
		[Tax Percentage],
		[Tax Amount Line Level],
		[Line level Net Amount],
		[Reason],
		[Type],
		[Mode],
		[Total Gross Amount],
		[Total Special Discount],
		[Total Scheme Discount],
		[Total Distributor Discount],
		[Total Cash Discount],
		[Total Tax Amount],
		[Total Net Amount],
		[Total Discount],
		[RtrId],
		[RMID],
		[SMID],
		[MRP],
		[Credit Note/Replacement Reference No],
		[Credit Note Reference No],		3,1,
		TCSLineleveltax, --LIVE TCS ISSUE
		TCSHeadleveltax,
		Irn,
		SignedInvoice,
		SignedQRCode FROM RptSRNSALESRETURN		
		WHERE [ReturnId] = @ReturnCode and usrid = 3
SET @prdAva = @prdAva - 1     
End 
FETCH NEXT FROM Cur_Salno into @ReturnCode 
END 
CLOSE Cur_Salno 
DEALLOCATE Cur_Salno 
END
GO
IF NOT EXISTS(SELECT * FROM ETLMaster WHERE Module='Retailer TCS Info')
BEGIN
	INSERT INTO ETLMaster([SlNo],[SeqNo],[Module],[Screen],[ExportFnName],[ImportProcName],[ParkTable],[ValidateProcName],[TranType],[MandatoryFile]) 
	SELECT MAX(SlNo)+1,1,'Retailer TCS Info','Retailer TCS Info','Fn_ExportRetailerTCSInfo','Proc_ImportRetailerTCSInfo','ETL_Prk_RetailerTCSInfo','Proc_ValidateRetailerTCSInfo','Master',1 from ETLMaster
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Fn_ExportRetailerTCSInfo' AND xtype='FN')
DROP FUNCTION Fn_ExportRetailerTCSInfo
GO
--Select dbo.Fn_ExportRetailerTCSInfo()
CREATE FUNCTION Fn_ExportRetailerTCSInfo ()
RETURNS NVARCHAR(4000)
AS
/*********************************
* FUNCTION: Fn_ExportRetailerTCSInfo
* PURPOSE: Return Retailer Master TCS Information
* NOTES:
* CREATED: S.Moorthi
* MODIFIED : 30/09/2020
* DATE      AUTHOR     DESCRIPTION
----------------------------------------------------------------------------------------------------------------------------------

************************************************************************************************************************************/
BEGIN

DECLARE @sSql NVARCHAR(MAX)
SET @sSql  = 'SELECT DISTINCT A.RtrCode AS [Retailer Code],A.RtrName AS [Retailer Name],
			isnull(E.PANNumber,'''')  AS PanNumber,
			isnull(I.TCSApplicable,'''') AS TCSApplicable,isnull(j.Aadhaar,'''')  as Aadhaar INTO #TEMP 
			From Retailer A WITH (NOLOCK) 
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as PANNumber FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'') E
			ON E.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as TCSApplicable FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''TCS Applicable'') I
			ON I.RtrId=A.RtrId
			left JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue as Aadhaar FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
			INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Aadhaar'') J
			ON J.RtrId=A.RtrId
			 Order by A.RtrCode
		  SELECT * FROM #TEMP'
RETURN (@sSql)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='ETL_Prk_RetailerTCSInfo' AND xtype='U')
DROP TABLE ETL_Prk_RetailerTCSInfo
GO
CREATE TABLE ETL_Prk_RetailerTCSInfo(
	[Retailer Code] [nvarchar](100) NULL,
	[Retailer Name] [nvarchar](100) NULL,
	[PanNumber] [nvarchar](100) NULL,
	[TCSApplicable] [nvarchar](100) NULL,
	[Aadhaar] [nvarchar](100) NULL
) ON [PRIMARY]
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='Proc_ValidateRetailerTCSInfo' AND xtype='P')
DROP PROCEDURE Proc_ValidateRetailerTCSInfo
GO
/*
 BEGIN TRAN
 Delete  FROM ERRORLOG
 update retailer set taxgroupid=0 where RtrCode='CDP1134'
 EXEC Proc_ValidateRetailerTCSInfo 0
 SELECT * FROM UdcDetails where masterid=2 AND MasterRecordId=1129
 Select * from Retailer where RtrCode='CDP1134'
 ROLLBACK TRAN
 */
CREATE PROCEDURE Proc_ValidateRetailerTCSInfo
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateRetailerTCSInfo
* PURPOSE		: To validate the Retailer TCS details through ETL Process
* CREATED		: S.Moorthi
* CREATED DATE	: 30/09/2020
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
******************************************************************************************************
* DATE         AUTHOR            CR/BZ  USER STORY ID      DESCRIPTION                         
*******************************************************************************************************
*********************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @RtrId AS INT
	DECLARE @TCSAPP AS VARCHAR(100)  ---MARCS202100060
	DECLARE @Aadhaar AS VARCHAR(100)
	DECLARE @ColCode99 as varchar(100)
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #ETL_Prk_RetailerTCSInfo
	(
		RtrCode			[Varchar](50),
		RtrName			[Varchar](150),
		PanNumber		[Varchar](15),
		TCSApplicable[nvarchar](100),
		Aadhaar[nvarchar](100)
	)
	

	DELETE FROM ErrorLog WHERE TableName='Retailer TCS Info'
	
	INSERT INTO #ETL_Prk_RetailerTCSInfo
	SELECT ISNULL([Retailer Code],''),ISNULL([Retailer Name],''),ISNULL([PanNumber],''),
	isnull([TCSApplicable],''),ISNULL([Aadhaar],'')
	from ETL_Prk_RetailerTCSInfo
	
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer TCS','Retailer Code','Retailer TCS Details Should not be empty' 
	FROM #ETL_Prk_RetailerTCSInfo
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(TCSApplicable,'')))='')
	
	DELETE A FROM #ETL_Prk_RetailerTCSInfo A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(TCSApplicable,'')))='')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #ETL_Prk_RetailerTCSInfo
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  1,'RetailerTCSInfo','Retailer','Retailer TCS Details Not allow more than 1-'+RtrCode FROM #ETL_Prk_RetailerTCSInfo
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode) 
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 2,'RetailerTCSInfo','RetailerCode','Retailer Code not Available-'+RtrCode FROM #ETL_Prk_RetailerTCSInfo  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT RtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.RtrCode)
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerTCSInfo 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'Retailer TCS','TCSApplicable','TCSApplicable Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerTCSInfo CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(TCSApplicable,'')))) NOT IN ('YES','NO')---MARCS202100060
		
	DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1
	
	
	
	DECLARE Cur_RetailerTCSInfo CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([RtrCode])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([TCSApplicable])),''),ISNULL(LTRIM(RTRIM([Aadhaar])),'')
	FROM #ETL_Prk_RetailerTCSInfo WHERE --[DownLoadFlag] ='D' AND
	RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerTCSInfo
	FETCH NEXT FROM Cur_RetailerTCSInfo INTO @RtrCode,@PanNumber,@TCSApp,@Aadhaar
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
		
			SET @Rtrid=''
			SELECT @Rtrid=Rtrid FROM Retailer(NOLOCK ) WHERE RtrCode =@RtrCode
			
		
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer TCS','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer TCS','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END	
			END
			
		    IF RTRIM(LTRIM(UPPER(ISNULL(@Aadhaar,''))))<>''
				BEGIN
					IF (SELECT DBO.Fn_ISAadhaar(@Aadhaar))=1
					BEGIN
						INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
						SELECT DISTINCT 1,'Retailer TCS','Aadhaar','Invalid Aadhaar Number'
						SET @Po_ErrNo =1
					END
				END
									
			IF @Po_ErrNo=0
			BEGIN
					
				DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master' and ColumnName='PAN/Aadhaar Available'
					
			
				INSERT INTO ETL_Prk_UDCRetailerGST (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','TCS Applicable',@RtrCode,@TCSApp,0 UNION ALL---MARCS202100060
				SELECT DISTINCT 'Retailer Master','Aadhaar',@RtrCode,@Aadhaar,0--MARCS202100060
				
				IF EXISTS(SELECT * FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master')
				BEGIN
					EXEC Proc_ETLValidate_UdcDetailsGST 0
				END
				
			END
							
		FETCH NEXT FROM Cur_RetailerTCSInfo INTO @RtrCode,@PanNumber,@TCSApp,@Aadhaar
	END
	CLOSE Cur_RetailerTCSInfo
	DEALLOCATE Cur_RetailerTCSInfo
	
		---Added by Gopi at 05-09-2020 to Capture PAN/Aadhar availability column Capture MARCS202100060
		DECLARE Cur_UdcDt1 CURSOR   
		FOR SELECT DISTINCT ISNULL(LTRIM(RTRIM([RtrCode])),'')
		FROM #ETL_Prk_RetailerTCSInfo WHERE 
		RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
		OPEN Cur_UdcDt1  
		FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
		WHILE @@FETCH_STATUS=0  
		BEGIN  
			EXEC Proc_Validate_RetailerPANAAdharAvailable  @ColCode99,0
		FETCH NEXT FROM Cur_UdcDt1 INTO @ColCode99 
		END  
		CLOSE Cur_UdcDt1  
		DEALLOCATE Cur_UdcDt1
		
	RETURN
END
GO
---Added by Mohana.S
DELETE FROM HotSearchEditorHd WHERE Formid =548
INSERT INTO HotSearchEditorHd 
SELECT 548,'Billing','Unselect Display with Route Coverage Plan and without attached Salesman','SELECT','SELECT  RMId,
RMCode,RMName FROM (SELECT A.RMId,A.RMCode,A.RMName FROM RouteMaster A (NOLOCK) INNER JOIN 
SalesmanMarket B (NOLOCK) ON A.RMId= B.RMId and B.SMId=vFParam WHERE RMSRouteType=1 AND RMStatus=1 AND RMCode <>''SRDummy01''
AND  (A.CmpId = (Case vSParam When 0 Then A.CmpId Else vSParam END) OR A.CmpId = 0)) a '
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME ='PDFGenerate' AND ID = OBJECT_ID('DebitNoteTopSheetClaimHD'))
BEGIN
	ALTER TABLE DebitNoteTopSheetClaimHD ADD PDFGenerate INT DEFAULT 0
END
GO
UPDATE A SET PDFGenerate =0 FROM DebitNoteTopSheetClaimHD A WHERE DNDocNo NOT IN (SELECT DNDocNo FROM DebitNoteBinaryFileDt )
GO
UPDATE A SET PDFGenerate =1 FROM DebitNoteTopSheetClaimHD A WHERE DNDocNo IN (SELECT DNDocNo FROM DebitNoteBinaryFileDt )
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Export_CS2WS_HHTMasterDetails' AND TYPE='P')
DROP PROCEDURE Proc_Export_CS2WS_HHTMasterDetails
GO
/*
BEGIN TRAN
Exec Proc_Export_CS2WS_HHTMasterDetails '1,2'
select * from Export_CS2WS_HHTMasterDetails
SELECT * FROM WSMasterExportUploadTrack
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Export_CS2WS_HHTMasterDetails
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_HHTMasterDetails
* PURPOSE		: To Export HHT Device details to the PDA Intermediate Database
* CREATED		: Amuthakumar P            CR:  CRCRSTAPAR0016
* CREATED DATE	: 06/08/2018 
* MODIFIED		:
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 06/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export HHT Device details
* 23-09-2020   MOHANA S				PARCS202100063		  CR	 UPDATED  DistributorCode+'-'+SMCode  INSTEAD OF NULL VALUE 
*********************************************************************************************************************/
BEGIN
	 DELETE FROM Export_CS2WS_HHTMasterDetails WHERE UploadFlag='Y'

	 UPDATE A SET HHTDeviceSerialNumber = DistributorCode+'-'+SMCode FROM Salesman A Cross Join Distributor B 
	 WHERE ISNULL(HHTDeviceSerialNumber,'') =''
	 
	 INSERT INTO Export_CS2WS_HHTMasterDetails(TenantCode,LocationCode,HHTName,HHTDeviceSerialNumber,UploadFlag)
	 SELECT DistributorCode,DistributorCode, DistributorCode+'-'+SMCode,HHTDeviceSerialNumber,'N' AS UploadFlag 
	 FROM SalesMan S CROSS JOIN Distributor D 
	 --WHERE --Status = 1 AND 
	 --NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = S.HHTDeviceSerialNumber AND M.ProcessName='HHTMaster Details') 
	 
	 INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	 SELECT 'HHTMaster Details',HHTDeviceSerialNumber,HHTName,GETDATE(),0,LocationCode,'','',0 FROM Export_CS2WS_HHTMasterDetails WHERE UploadFlag='N'
	 
	 UPDATE Export_CS2WS_HHTMasterDetails SET HHTDeviceSerialNumber=REPLACE(HHTName,'-','') WHERE ISNULL(HHTDeviceSerialNumber,'')=''
	 
	 SELECT DISTINCT 
		TenantCode,
		LocationCode,
		HHTName,
		HHTDeviceSerialNumber
	FROM Export_CS2WS_HHTMasterDetails WITH (NOLOCK)
	
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_RailwayDiscountReconsolidation_Temp' AND TYPE='U')
BEGIN
	SELECT * INTO Cs2Cn_Prk_RailwayDiscountReconsolidation_Temp FROM Cs2Cn_Prk_RailwayDiscountReconsolidation WHERE UploadFlag ='N'
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_RailwayDiscountReconsolidation' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_RailwayDiscountReconsolidation
GO
CREATE TABLE Cs2Cn_Prk_RailwayDiscountReconsolidation
(
	[SlNo]	[numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[TransDate] [datetime] NULL,
	[CmpRtrCode] [nvarchar](50) NULL,
	[PrdCCode] [nvarchar](100) NULL,
	[TotalPCS] [numeric](18, 0) NULL,
	[MRP] [numeric](18, 6) NULL,
	[LCTR] [numeric](18, 6) NULL,
	[IRCTCMargin] [numeric](18, 2) NULL,
	[MarkUpDown] [nvarchar](50) NULL,
	[IRCTCRate] [numeric](18, 6) NULL,
	[TotalMRP] [numeric](18, 6) NULL,
	[TotalLCTR] [numeric](18, 6) NULL,
	[IRCTCTotal] [numeric](18, 6) NULL,
	[ClmAmount] [numeric](18, 6) NULL,
	[LibOnMRP] [numeric](18, 2) NULL,
	[LibOnLCTR] [numeric](18, 2) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL,
	[ChannelName] [nvarchar](100) NULL,  
	[RtrName]	  [nvarchar](100) NULL
) 
GO
IF EXISTS (SELECT * FROM Cs2Cn_Prk_RailwayDiscountReconsolidation_Temp)
BEGIN
	
	INSERT INTO Cs2Cn_Prk_RailwayDiscountReconsolidation(DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,
	MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,LibOnLCTR,UploadFlag,SyncId,ServerDate)
	SELECT DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,
	ClmAmount,LibOnMRP,LibOnLCTR,UploadFlag,SyncId,ServerDate FROM Cs2Cn_Prk_RailwayDiscountReconsolidation_Temp

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax' AND TYPE='P')
DROP PROCEDURE  Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax
GO
/*  
Begin transaction
truncate table Cs2Cn_Prk_RailwayDiscountReconsolidation   
exec Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax 0,'2018-07-11'  
select * from Cs2Cn_Prk_RailwayDiscountReconsolidation -- for xml AUTO --where PrdCCode ='100301301079070190PKT10010N'  
Rollback Transaction  
*/  
CREATE PROCEDURE Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax
(  
@Po_ErrNo INT OUTPUT,  
@ServerDate DATETIME  
)  
AS  
/***********************************************************************************************************************
* PROCEDURE  : Proc_Cs2Cn_RailwayDiscountReconsolidation_withTax   
* PURPOSE  :   
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :  
* MODIFIED  
************************************************************************************************************************
* DATE        AUTHOR		CR/BZ			USER STORY ID       DESCRIPTION   
* 27-03-2018   S.MOhana		CR				CCRSTPAR0188		Included reports changes in upload
* 11-07-2018   Lakshman M	BZ				ILCRSTPAR1325       negative values division validation added from core stocky.
* 17-09-2018   Amuthakumar	CR				CRCRSTPAR0021       Promotion claim should be calculating with tax
* 30-03-2020   MOHANA S     CR				PARCS202100002		Contract Pricing Optimization	
* 04-08-2020   MOHANA S		SR				PILOT ISSUE 443		OPTIMIZATION DONE	
* 23-09-2020   MOHANA S		CR				PARCS202100061		Included RtrName & ChannelName 
************************************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
	SET @Po_ErrNo=0  
	DECLARE @DistCode   As NVARCHAR(50)  
	
	DELETE FROM Cs2Cn_Prk_RailwayDiscountReconsolidation WHERE UploadFlag = 'Y'  
	
	TRUNCATE TABLE UploadingReportTransaction  
	INSERT INTO UploadingReportTransaction (TransType,TransId,TransNo,TransDate)  
	SELECT 1,SalId,SalInvNo,SalInvDate FROM SalesInvoice (NOLOCK) WHERE DlvSts > 3 AND RptUpload = 0  
	UNION ALL  
	SELECT 2,ReturnID,ReturnCode,ReturnDate FROM ReturnHeader (NOLOCK) WHERE Status = 0 AND RptUpload = 0  
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))  
	BEGIN  
	RETURN  
	END  
	
	DECLARE @FromDate DATETIME  
	DECLARE @ToDate DATETIME  
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction (NOLOCK)  
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)   
	
	--To Filter Retailers  
	SELECT DISTINCT R.RtrId,RtrName,RC.CtgCode,RC.CtgMainId,CmpRtrCode 
	INTO #FilterRetailer1  
	FROM Retailer R (NOLOCK),  
	RetailerValueClassMap RVCM (NOLOCK),  
	RetailerValueClass RVC (NOLOCK),  
	RetailerCategory RC (NOLOCK),  
	RetailerCategoryLevel RCL (NOLOCK)  
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  AND
	RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT') 

	SELECT R.RtrId,RtrName,R.CtgCode,C.CtgName AS ChannelName ,CmpRtrCode
	INTO #FilterRetailer 
	FROM #FilterRetailer1 R 
	INNER JOIN RetailerCategory B ON R.CtgMainID = B.CtgMainID
	INNER JOIN RetailerCategory C ON B.CtglinkId = C.CtgMainID

	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	--- Till Here
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,(SP.PrdSchDiscAmount/SP.BaseQty) SchDisc  
	INTO #BillingDetails  
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
	WHERE SalInvDate between @FromDate AND @ToDate 
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	AND S.DlvSts > 3  
	-- SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
	--CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,(SP.PrdSchDisAmt/SP.BaseQty) SchDisc  
	-- INTO #ReturnDetails  
	-- FROM ReturnHeader S (NOLOCK)  
	-- INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1) 
	-- WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)  
	-- AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	-- AND S.[Status] = 0  
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
	WHERE 
	ReturnDate    between @FromDate AND @ToDate 
	AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	
	INSERT INTO #ReturnDetails
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
	CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc 
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE  ReturnDate  between  @FromDate AND @ToDate  AND   S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
	AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,CAST(0 AS NUMERIC(18,6))[SellRate],  
	CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) IRCTCRate,SchDisc
	INTO #RailwaySalesDetails  
	FROM   
	(  
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #BillingDetails  
	UNION ALL  
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,SchDisc FROM #ReturnDetails  
	) Consolidated  

	SELECT DISTINCT PRDID INTO #TempPrd FROM #RailwaySalesDetails


	SELECT DISTINCT Rtrid INTO #TempRtr FROM #RailwaySalesDetails
	
	DECLARE @SlNo AS INT  
	
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
	
	UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  
	FROM #RailwaySalesDetails R (NOLOCK),  
	ProductBatch B (NOLOCK),  
	ProductBatchDetails D (NOLOCK)  
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo   
	
	--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
	--INTO #ExistingSpecialPrice
	--FROM #RailwaySalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	--SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
	--INTO #SpecialPrice
	--FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
	--#FilterRetailer R,
	--Product P (NOLOCK), ProductBatch B (NOLOCK)
	--WHERE S.RtrCtgValueCode = R.CtgCode AND
	--S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	
	
	
	--SELECT S.* 
	--INTO #LatesSpecialPrice
	--FROM #SpecialPrice S,
	--(
	--SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
	--FROM #SpecialPrice  
	--GROUP BY RtrId,PrdId,PrdBatId
	--) L
	--WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	
	SELECT DISTINCT A.contractid,E.PrdId,Discount,ApplyOn [Type]  INTO #ContractProduct
	FROM contractpricingmaster A(NOLOCK)
	INNER JOIN ContractPricingDetails B(NOLOCK) ON A.ContractId=b.ContractId AND PRdbatid = 0
	INNER JOIN ProductCategoryValue C(NOLOCK) ON  C.PrdCtgValMainId=B.PrdId 
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE CAST(c.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN  Product  E On D.PrdCtgValMainId = E.PrdCtgValMainId AND Status=1
	INNER JOIN #TempPrd T ON T.Prdid =E.Prdid -- Pilot Issue
	 
	SELECT  MAX(CP.ContractId) ContractId,R.RtrId ,cpd.Prdid,CPD.Discount,[Type] INTO #LatesSpecialPrice
	FROM ContractPricingMaster CP INNER JOIN ContractPricingAttributes CA ON CP.ContractId=CA.ContractId AND ATTRTYPE=1 
	INNER JOIN #ContractProduct CPD ON CP.ContractId= CPD.ContractId -- Pilot Issue
	INNER JOIN RetailerCategory RC ON RC.CtgMainId=CASE CA.Attrid WHEN 0 THEN RC.CtgMainId ELSE CA.Attrid END 
	INNER JOIN RetailerCategory RC1 ON RC1.CtgLinkCode LIKE CAST(RC.CtgLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN RetailerValueClass RVC ON RVC.CtgMainId=RC1.CtgMainId 
	INNER JOIN RetailerValueClassMap RVCM ON RVCM.RtrValueClassId=RVC.RtrClassId AND RVCM.RtrValueClassId=CASE CP.RtrClassId WHEN 0 THEN RVCM.RtrValueClassId ELSE CP.RtrClassId END
	INNER JOIN #TempRtr  R ON R.RtrId=RVCM.RtrId	
	GROUP BY R.RtrId ,cpd.Prdid,CPD.Discount ,[Type]
	
	UPDATE R SET R.IRCTCMargin = S.Discount,R.[Type] = S.[TYPE]
	FROM #RailwaySalesDetails R (NOLOCK),
	#LatesSpecialPrice S (NOLOCK)
	WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid  
	--- Added by Amuthakumar on 17-09-2018  CRCRSTPAR0021
	UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
	FROM #RailwaySalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	--UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
	--- Till Here CRCRSTPAR0021
	
	--SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
	--(
	--SELECT D.PriceId,D.PrdBatDetailValue 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--ProductBatchDetails D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	--AND PriceCode LIKE '%-Spl Rate-%'   
	--UNION 
	--SELECT D.PriceId,D.PrdBatDetailValue 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--ProductBatchDetails D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	--AND PriceCode LIKE '%SplRate%'  
	--)A
	--UPDATE M SET M.IRCTCRATE = D.PrdBatDetailValue-SchDisc 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--#SpecialPrice_New D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId 
	SELECT A.SalId ,A.PrdId,A.PrdBatid,A.TransType,A.Slno,SplRate INTO #Sales  FROM #RailwaySalesDetails A  
	INNER JOIN SalesInvoiceProduct B ON A.Salid = B.Salid AND A.Prdid =B.PrdId AND A.PrdBatid = B.PrdBatId AND A.Slno = B.SlNo AND TransType = 1
	AND SplRate>0
	SELECT  A.SalId ,A.PrdId,A.PrdBatid,A.TransType,A.Slno,SplRate INTO #Return FROM #RailwaySalesDetails A  
	INNER JOIN ReturnHeader B ON A.SalId = B.ReturnID AND TransType = 2 
	INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID 
	INNER JOIN SalesInvoiceProduct D ON B.Salid = D.Salid AND D.Prdid =C.PrdId AND D.PrdBatid = C.PrdBatId AND D.SLNO = C.ActSalRowId  AND SplRate>0
	 
	--UPDATE M SET M.IRCTCRATE = D.PrdBatDetailValue + (D.PrdBatDetailValue*(T.TaxPerc/100)) - SchDisc 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--#SpecialPrice_New D (NOLOCK), 
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno	AND M.PriceId = D.PriceId   
	
	UPDATE M SET M.IRCTCRATE = D.SplRate + (D.SplRate*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#Sales D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno AND M.PrdId = D.PrdId AND M.TransType = D.TransType 
	AND D.slno = T.PrdSlno AND D.salid = T.Salid AND T.TransId = D.TransType 
	
	UPDATE M SET M.IRCTCRATE = D.SplRate + (D.SplRate*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#Return D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE  M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno AND M.PrdId = D.PrdId AND M.TransType = D.TransType 
	AND D.slno = T.PrdSlno	  AND D.salid = T.Salid  AND T.TransId  = D.TransType  
	UPDATE R SET R.IRCTCRATE = R.[SellRate] - Schdisc 	FROM #RailwaySalesDetails R (NOLOCK)  WHERE IRCTCRATE=0
	--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,  
	--LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
	--IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
	--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
	--CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
	--INTO #RailwayDiscount  
	--FROM #RailwaySalesDetails S (NOLOCK)  
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
	--GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate
	SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,(TotalPCS) AS TotalPCS,MRP,  
	LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
	IRCTCRate,  CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
	CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
	CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
	INTO #RailwayDiscount1  
	FROM #RailwaySalesDetails S (NOLOCK)  
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId   
	-- GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type] ,IRCTCRate,TotalPCS 
	--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
	UPDATE R SET TotalMRP  = TotalPCS * MRP, 
	TotalLCTR = TotalPCS * LCTR
	FROM #RailwayDiscount1 R (NOLOCK)
	UPDATE R SET R.IRCTCTotal = TotalPCS * IRCTCRate  
	FROM #RailwayDiscount1 R (NOLOCK)  
	UPDATE R SET R.ClmAmount = TotalLCTR - IRCTCTotal  
	FROM #RailwayDiscount1 R (NOLOCK)  
	UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalMRP <> 0
	UPDATE R SET LibOnMRP = -1* LibOnMRP
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalLCTR <> 0	
	UPDATE R SET LibOnLCTR = -1* LibOnLCTR
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	------------ Till Here ---------------
	INSERT INTO Cs2Cn_Prk_RailwayDiscountReconsolidation (DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,  
	LibOnLCTR,UploadFlag,SyncId,ServerDate,ChannelName,RtrName)  
	SELECT @DistCode,TransDate,R.CmpRtrCode,PrdCCode,sum(TotalPCS) AS TotalPCS ,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,sum(TotalMRP) AS TotalMRP,CAST ((sum(TotalLCTR))  AS NUMERIC(18,2)) TotalLCTR,CAST (ROUND(sum(IRCTCTotal),2) AS NUMERIC(18,2)) IRCTCTotal
	,CAST(sum(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(sum(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (sum(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR,'N' UploadFlag,NULL,@ServerDate ,
	ChannelName,RtrName FROM #RailwayDiscount1 RD,  
	#FilterRetailer R (NOLOCK)  
	WHERE RD.RtrId = R.RtrId  GROUP BY TransDate,R.CmpRtrCode,PrdCCode,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,ChannelName,RtrName
RETURN     
END
GO
IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptRailwayDiscountReconsolidation_Excel')
DROP TABLE RptRailwayDiscountReconsolidation_Excel	
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptRailwayDiscountReconsolidation_withTax' AND TYPE='P')
DROP PROCEDURE  Proc_RptRailwayDiscountReconsolidation_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptRailwayDiscountReconsolidation_withTax 288,1,0,'Parle',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptRailwayDiscountReconsolidation_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*****************************************************************************************************************************
* PROCEDURE	: Proc_RptRailwayDiscountReconsolidation_withTax
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
******************************************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. IRCTC rate should display the net rate in billing screen   
 14-12-2017   S.Mohana    CR			ICRSTPAR7049	    Corrected Excel Column values.
 26-12-2017	  S.MOHANA	  SR			ICRSTPAR7809		1.Changed Column Name (IRCTC --> Chain And LCTR --> Normal rate)
															2.REMOVED TAX CALCULATION
															3.ADDED RATE-SCHEMEDISCOUNT 
 11-07-2018   Lakshman M  BZ            ILCRSTPAR1325       Negative values division validation added from core stocky.
 17-09-2018   Amuthakumar CR            CRCRSTPAR0021       Promotion claim should be calculating with tax
 11-05-2020	  MOHANA S	  CR			PARCS202100013		CATEGORY TAKEN BASED ON TRANSACTION		
 30-03-2020	  MOHANA S    CR            PARCS202100002      Contract Pricing Optimization	
 23-09-2020   MOHANA S	  CR			PARCS202100061		Included RtrName & ChannelName
******************************************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	 
	--To Filter Retailers
	--SELECT DISTINCT R.RtrId,RC.CtgCode,RC.CtgName
	--INTO #FilterRetailer
	--FROM Retailer R (NOLOCK),
	--RetailerValueClassMap RVCM (NOLOCK),
	--RetailerValueClass RVC (NOLOCK),
	--RetailerCategory RC (NOLOCK),
	--RetailerCategoryLevel RCL (NOLOCK)	
	--WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	--AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	--AND RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT')
	--AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	--RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	--AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	--RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	--AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	--RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers


	SELECT DISTINCT R.RtrId,RC.CtgCode,RC.CtgMainId,RC.CtgName,RtrValueClassId,RtrName
	INTO #FilterRetailer1
	FROM Retailer R (NOLOCK) ,
	Salesinvoice S (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = S.RtrId AND S.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND SalInvDate BETWEEN @FromDate AND @ToDate AND DlvSts>3
	AND RC.CtgLinkId NOT IN (SELECT CtgMainId FROM RetailerCategory WHERE CtgCode='GT')
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))

	SELECT R.RtrId,RtrName,R.CtgCode,C.CtgName AS ChannelName,R.CtgName,RtrValueClassId
	INTO #FilterRetailer 
	FROM #FilterRetailer1 R 
	INNER JOIN RetailerCategory B ON R.CtgMainID = B.CtgMainID
	INNER JOIN RetailerCategory C ON B.CtglinkId = C.CtgMainID

	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	-- Added by Amuthakumar on 17/09/2018 CRCRSTPAR0021
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	--- Till Here
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdUom1EditedSelRate,
	CAST(CAST(SP.PrdUom1NetRate AS NUMERIC(18,4))/Uom1ConvFact AS NUMERIC(18,4)) PrdUnitNetRate,
	CAST((SP.PrdSchDiscAmount/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc,RtrValueClassId
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN  @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.SlNo,SP.PrdEditSelRte,
	CAST(SIP.PrdUom1NetRate AS NUMERIC(18,4))/SIP.Uom1ConvFact PrdUnitNetRate,
	CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6))SchDisc,S.RtrValueClassId
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	INSERT INTO #ReturnDetails
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS  Priceid,SP.SlNo,SP.PrdEditSelRte,
	CAST((PrdGrossAmt-(PrdSplDisAmt+PrdSchDisamt+PrdCDDisAmt)+PrdTaxAmt)/CAST(BaseQty AS NUMERIC(18,6)) AS NUMERIC(18,4))  AS PrdUnitNetRate,
	CAST((SP.PrdSchDisAmt/SP.BaseQty)  AS NUMERIC(18,6)) SchDisc ,S.RtrValueClassId
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
	AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	--SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	--SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	--INTO #ReturnDetails
	--FROM ReturnHeader S (NOLOCK)
	--INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	--WHERE ReturnDate BETWEEN  @FromDate AND @ToDate AND S.Status = 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc,CAST(0 AS NUMERIC(18,6))[SellRate],
	CAST(0 AS NUMERIC(18,6)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,6)) AS LCTR,CAST(0 AS NUMERIC(18,6)) ChainRate,RtrValueClassId
	INTO #RailwaySalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc,RtrValueClassId FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo,SchDisc,RtrValueClassId FROM #ReturnDetails
	
	) Consolidated
	
	DECLARE @SlNo AS INT
	
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'

	SELECT DISTINCT PRdid INTO #TempPrd1 FROM #RailwaySalesDetails
	
	SELECT DISTINCT Rtrid INTO #TempRtr FROM #RailwaySalesDetails

	UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  + (D.PrdBatDetailValue *(T.TaxPerc/100)),
	R.SchDisc =  R.SchDisc  + (R.SchDisc *(T.TaxPerc/100))   
	FROM #RailwaySalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK),
	 #ParleOutputTaxPercentage T 
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	AND R.TransType = T.TRANSID AND R.SALID =T.SALID AND R.SLNO=T.PRDSLNO
	
	
	
	--SELECT R.PriceId,C.DiscountPerc,C.[TYPE],C.SplSelRate
	--INTO #ExistingSpecialPrice
	--FROM #RailwaySalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	
	--SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate,S.DiscountPerc,Type
	--INTO #SpecialPrice
	--FROM SpecialRateAftDownLoad_Calc S (NOLOCK),
	--#FilterRetailer R,
	--Product P (NOLOCK), ProductBatch B (NOLOCK)
	--WHERE S.RtrCtgValueCode = R.CtgCode AND
	--S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	--AND EXISTS (SELECT 'C' FROM #FilterProduct N (NOLOCK) WHERE P.PrdId = N.Prdid)	
	
	SELECT DISTINCT * INTO #Product FROM Product WHERE Prdid IN ( SELECT PrdId FROM #TempPrd1 N (NOLOCK))	

	SELECT DISTINCT A.contractid,E.PrdId,Discount,ApplyOn [Type]  INTO #ContractProduct
	FROM contractpricingmaster A(NOLOCK)
	INNER JOIN ContractPricingDetails B(NOLOCK) ON A.ContractId=b.ContractId AND Status =1
	INNER JOIN ProductCategoryValue C(NOLOCK) ON  C.PrdCtgValMainId=B.PrdId 
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE CAST(c.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN  #Product  E On D.PrdCtgValMainId = E.PrdCtgValMainId 


	SELECT  MAX(CP.ContractId) ContractId,R.RtrId ,cpd.Prdid,CPD.Discount,[Type] INTO #LatesSpecialPrice
	FROM ContractPricingMaster CP INNER JOIN ContractPricingAttributes CA ON CP.ContractId=CA.ContractId AND ATTRTYPE=1
	INNER JOIN RetailerCategory RC ON RC.CtgMainId=CASE CA.Attrid WHEN 0 THEN RC.CtgMainId ELSE CA.Attrid END 
	INNER JOIN RetailerCategory RC1 ON RC1.CtgLinkCode LIKE CAST(RC.CtgLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN RetailerValueClass RVC ON RVC.CtgMainId=RC1.CtgMainId 
	INNER JOIN RetailerValueClassMap RVCM ON RVCM.RtrValueClassId=RVC.RtrClassId AND RVCM.RtrValueClassId=CASE CP.RtrClassId WHEN 0 THEN RVCM.RtrValueClassId ELSE CP.RtrClassId END
	INNER JOIN #TempRtr R ON R.RtrId=RVCM.RtrId
	INNER JOIN #ContractProduct CPD ON CP.ContractId= CPD.ContractId 
	GROUP BY R.RtrId ,cpd.Prdid,CPD.Discount ,[Type]
	
	--SELECT S.* 
	--INTO #LatesSpecialPrice
	--FROM #SpecialPrice S,
	--(
	--	SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
	--	FROM #SpecialPrice  WHERE Prdid in (SELECT PrdId FROM #FilterProduct)
	--	GROUP BY RtrId,PrdId,PrdBatId
	--) L
	--WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	
	UPDATE R SET R.IRCTCMargin = S.Discount,R.[Type] = S.[TYPE]
	FROM #RailwaySalesDetails R (NOLOCK),
	#LatesSpecialPrice S (NOLOCK)
	WHERE R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid 
	
	--- Added by Amuthakumar on 17-09-2018  CRCRSTPAR0021
--	UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
--	FROM #RailwaySalesDetails R (NOLOCK),
--	#ParleOutputTaxPercentage T (NOLOCK)
--	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	--UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
	--- Till Here CRCRSTPAR0021
	
	UPDATE R SET R.LCTR = R.[SellRate] 	FROM #RailwaySalesDetails R (NOLOCK)  
		
	--UPDATE R SET R.ChainRate = SplSelRate-SchDisc 	FROM #RailwaySalesDetails R (NOLOCK) INNER JOIN #LatesSpecialPrice S (NOLOCK)
	--ON R.Prdid = S.Prdid AND R.Rtrid = S.Rtrid AND R.Prdbatid = S.Prdbatid
	
	--SELECT DISTINCT Priceid,PrdBatDetailValue  INTO #SpecialPrice_New FROM
	--(
	--SELECT D.PriceId,D.PrdBatDetailValue 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--ProductBatchDetails D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	--AND PriceCode LIKE '%-Spl Rate-%'   
	--UNION 
	--SELECT D.PriceId,D.PrdBatDetailValue 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--ProductBatchDetails D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	--AND PriceCode LIKE '%SplRate%'  
	--)A
	
	SELECT A.SalId ,A.PrdId,A.PrdBatid,A.TransType,A.Slno,SplRate INTO #Sales  FROM #RailwaySalesDetails A  
	INNER JOIN SalesInvoiceProduct B ON A.Salid = B.Salid AND A.Prdid =B.PrdId AND A.PrdBatid = B.PrdBatId AND A.Slno = B.SlNo AND TransType = 1
	SELECT  A.SalId ,A.PrdId,A.PrdBatid,A.TransType,A.Slno,SplRate INTO #Return FROM #RailwaySalesDetails A  
	INNER JOIN ReturnHeader B ON A.SalId = B.ReturnID AND TransType = 2 
	INNER JOIN ReturnProduct C ON C.ReturnID = B.ReturnID 
	INNER JOIN SalesInvoiceProduct D ON B.Salid = D.Salid AND D.Prdid =C.PrdId AND D.PrdBatid = C.PrdBatId AND D.SLNO = C.ActSalRowId 
	UPDATE M SET M.ChainRate = D.SplRate + (D.SplRate*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#Sales D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno AND M.PrdId = D.PrdId AND M.TransType = D.TransType 
	AND D.slno = T.PrdSlno AND D.salid = T.Salid AND T.TransId = D.TransType 
	
	UPDATE M SET M.ChainRate = D.SplRate + (D.SplRate*(T.TaxPerc/100)) - SchDisc 
	FROM #RailwaySalesDetails M (NOLOCK),
	#Return D (NOLOCK), 
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE  M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno AND M.PrdId = D.PrdId AND M.TransType = D.TransType 
	AND D.slno = T.PrdSlno	  AND D.salid = T.Salid  AND T.TransId  = D.TransType  
	
	--UPDATE M SET M.ChainRate = D.PrdBatDetailValue-SchDisc 
	--FROM #RailwaySalesDetails M (NOLOCK),
	--#SpecialPrice_New D (NOLOCK) 
	--WHERE M.PriceId = D.PriceId  
	  
	 
	UPDATE R SET R.ChainRate = (R.[SellRate]-SchDisc) --ROUND((R.[SellRate]-SchDisc),2,1) 
	FROM #RailwaySalesDetails R (NOLOCK)  WHERE ChainRate=0
	 	
	--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,
	
	--SELECT Ctgname,P.PrdId,P.PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	--LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	--ChainRate,
	--CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	--CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	--CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	--INTO #RailwayDiscount
	--FROM #RailwaySalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid
	--GROUP BY Ctgname,P.PrdId,P.PrdName,MRP,LCTR,IRCTCMargin,S.[Type],PrdUnitNetRate,ChainRate
		
	---------------
	SELECT ChannelName,RtrName,Ctgname,P.PrdId,P.PrdName,(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	LCTR As NormalRate,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	ChainRate,
	CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	CAST(0 AS NUMERIC(18,6)) LibOnMRP,CAST(0 AS NUMERIC(18,6)) LibOnLCTR
	INTO #RailwayDiscount1
	FROM #RailwaySalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN #FilterRetailer F ON F.Rtrid = S.Rtrid AND S.RtrValueClassId = F.RtrValueClassId 
	-----
	--UPDATE R SET R.IRCTCRate = MRP - (MRP * IRCTCMargin / 100.00), 
	--UPDATE R SET R.IRCTCRate = PrdUnitNetRate, 
	UPDATE R SET TotalMRP  = TotalPCS * MRP, 
	TotalLCTR = TotalPCS * NormalRate
	FROM #RailwayDiscount1 R (NOLOCK)
	--------------- added by Lakshman M on 11-07-2018 PMS ID: ILCRSTPAR1325----------
	
	UPDATE R SET R.IRCTCTotal = TotalPCS * ChainRate
	FROM #RailwayDiscount1 R (NOLOCK)
	 
	
	UPDATE R SET R.ClmAmount = ROUND((TotalLCTR - IRCTCTotal),2)
	FROM #RailwayDiscount1 R (NOLOCK)
	
	UPDATE R SET R.LibOnMRP = (ClmAmount / TotalMRP)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalMRP <> 0
	
	UPDATE R SET LibOnMRP = -1* LibOnMRP
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	
	UPDATE R SET R.LibOnLCTR = (ClmAmount / TotalLCTR)*100
	FROM #RailwayDiscount1 R (NOLOCK)
	WHERE R.TotalLCTR <> 0	
	
	UPDATE R SET LibOnLCTR = -1* LibOnLCTR
	FROM #RailwayDiscount1 R (NOLOCK) WHERE TotalPCS <0
	 
------------ Till Here ---------------
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptRailwayDiscountReconsolidation_Excel')
	DROP TABLE RptRailwayDiscountReconsolidation_Excel	
	
	SELECT ChannelName,RtrName,Ctgname,PrdId,PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,CAST(NormalRate  AS NUMERIC(18,2)) NormalRate,IRCTCMargin As ChainMargin,MarkUpDown,
	CAST(ChainRate  AS NUMERIC(18,2)) ChainRate,--- Sum off validation removed after changing in with tax report By lakshman M : Amuthakumar PMS : CRCRSTPAR0021
	SUM(TotalMRP) TotalMRP,CAST (SUM(TotalLCTR)  AS NUMERIC(18,2)) TotalLCTR,CAST((ROUND(SUM(IRCTCTotal),2)) AS NUMERIC(18,2)) IRCTCTotal 
	,CAST(SUM(ClmAmount)  AS NUMERIC(18,2)) ClmAmount,CAST(SUM(LibOnMRP)  AS NUMERIC(18,2)) LibOnMRP,	CAST (SUM(LibOnLCTR)  AS NUMERIC(18,2)) LibOnLCTR
	INTO RptRailwayDiscountReconsolidation_Excel
	FROM #RailwayDiscount1 (NOLOCK) 
	GROUP BY ChannelName,RtrName,Ctgname,PrdId,PrdName,PrdUnitNetRate,MRP,NormalRate,IRCTCMargin,ChainRate,MarkUpDown 
	ORDER BY PrdName
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptRailwayDiscountReconsolidation_Excel
	
	SELECT * FROM RptRailwayDiscountReconsolidation_Excel ORDER BY PrdName,MarkUpDown
	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'Channel Name','Channel Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'RtrName','Retailer Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'TotalPCS','Total PCS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdUnitNetrate','PrdUnitNetrate',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'Normal Rate','Normal Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'IRCTCMargin','Chain Margin',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'MarkUpDown','MarkUp /Mark Down',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'Chain Rate','Chain Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'TotalMRP','Parle Total MRP Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'TotalLCTR','Parle Total Normal Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'IRCTCTotal','Chain Total Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'ClmAmount','Claim Amount',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,17,'LibOnMRP','% Lib On MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,18,'LibOnLCTR','% Lib On Total NormalRate',1,1)
	RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_ProductBatch' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_ProductBatch
GO
/*   
	BEGIN TRANSACTION  
	delete FROM Errorlog
  
	EXEC Proc_Cn2Cs_ProductBatch 0  
	SELECT * FROM productbatch WHERE PrdBatcode='544.793333-720.000000' AND Prdid = 2033
	select * from productbatchdetails where prdbatid =1258
	select *from errorlog  
	ROLLBACK TRANSACTION  
*/  
CREATE PROCEDURE Proc_Cn2Cs_ProductBatch
(  
       @Po_ErrNo INT OUTPUT  
)  
AS  
/***************************************************************************************************  
* PROCEDURE  : Proc_Cn2Cs_ProductBatch  
* PURPOSE  : To Insert and Update records in the Tables ProductBatch and ProductBatchDetails  
* CREATED BY : Nandakumar R.G  
* CREATED DATE : 12/04/2010  
* MODIFIED      : Sathishkumar Veeramani  
* PURPOSE  : New Product Batch - Special Rate Created  
* MODIFIED DATE : 13/09/2012  
* MODIFIED      : Murugan.R  
* PURPOSE  : Batch Optimization  and Akzonabal Price change  
* MODIFIED DATE : 13/09/2012  
* DATE      AUTHOR     DESCRIPTION  
-----------------------------------------------------------------------------------------------------  
* 06-06-2019  MOHANA       CR   CRCRSTPAR0058   INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE  
* 13-08-2019  Lakshman M   BZ   ILCRSTPAR5522   While downlaod new product specail discount create validation missing in core stocky.
* 18-09-2019  Lakshman M   BZ   ILCRSTPAR5989   while download contarct pricing taking time script level validation optimised script has been changed. 
* 05-12-2019  Deepan       CR   CRCRSTPAR0083   LCTR Amount Included 
* 23-03-2020  MOHANA S     CR   PARCS202100002  Contract Pricing Optimization
* 14-09-2020  MOHANA S	   CR	PARCS202100060	DUPLICATE DEFAULT PRICE UPDATION-CORRECTION 	
************* ****************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
 SET @Po_ErrNo =0  
 IF NOT EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE DownLoadFlag='D') RETURN  
 --Product batch configuration  For Aznoble Client  
 IF EXISTS(SELECT Status FROM Configuration where ModuleId='GENCONFIG33' and Status=1)  
  BEGIN  
   DELETE FROM ProductBatchEeffectiveDate WHERE UpdateFlag='Y'  
   INSERT INTO ProductBatchEeffectiveDate(PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,  
   EffectiveDate,MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,  
   AddRate3,AddRate4,AddRate5,AddRate6,UpdateFlag)      
   SELECT PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,  
   MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,  
   AddRate4,AddRate5,AddRate6,'N'   
   FROM Cn2Cs_Prk_ProductBatch(nolock) WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)  
   ORDER BY ManufacturingDate ASC --Muthuvel  
   DELETE FROM Cn2Cs_Prk_ProductBatch  WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)  
   --Product Batch and Price Insert For Aznoble Client  
   EXEC Proc_ValidateBatchLDEeffectiveDate  
   RETURN  
  END  
 IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatToAvoid' AND XTYPE = 'U')  
 BEGIN  
  DROP TABLE PrdBatToAvoid   
 END  
 CREATE TABLE PrdBatToAvoid  
 (  
  PrdCCode NVARCHAR(200),  
  PrdBatCode NVARCHAR(200)  
 )  
 DECLARE @ExistingBatchDetails TABLE  
 (  
  PrdId  NUMERIC(18,0),  
  PrdCCode VARCHAR(100),  
  PrdBatCode VARCHAR(100),  
  PriceCode VARCHAR(500),  
  OldLSP  NUMERIC(18,0),  
  PrdBatId NUMERIC(18,0),  
  PriceId  NUMERIC(18,0)  
 )  
 DECLARE @ProductBatchWithCounter TABLE  
 (  
  Slno   NUMERIC(18,0) IDENTITY(1,1),  
  TransNo   NUMERIC(18,0),  
  PrdId   NUMERIC(18,0),  
  PrdCCode  VARCHAR(100),  
  PrdBatCode  VARCHAR(100),  
  MnfDate   DATETIME,  
  ExpDate   DATETIME    
 )   
 DECLARE @ProductBatchPriceWithCounter TABLE  
 (  
  Slno   NUMERIC(18,0) IDENTITY(1,1),  
  TransNo   NUMERIC(18,0),  
  PrdId   NUMERIC(18,0),  
  PrdBatId  NUMERIC(18,0),  
  PriceCode  NVARCHAR(1000),  
  MRP    NUMERIC(18,6),  
  ListPrice  NUMERIC(18,6),  
  SellingRate  NUMERIC(18,6),  
  ClaimRate  NUMERIC(18,6),  
  AddRate1  NUMERIC(18,6)  
 )  
 DECLARE @ContractPrice TABLE  
 (  
    PrdId NUMERIC(18,0),  
    PrdBatId NUMERIC(18,0)  
 )  
 DECLARE @ContractBatchPrice TABLE  
    (  
    ContractId       NUMERIC(18,0),  
    CtgMainId        NUMERIC(18,0),  
    PrdId            NUMERIC(18,0),  
    PrdBatId         NUMERIC(18,0),  
    PriceId          NUMERIC(18,0),  
    PriceCode        NVARCHAR(500)  
    )  
    DECLARE @ProductBatchDetails TABLE  
 (  
    PrdId                NUMERIC(18,0),  
    PrdBatId      NUMERIC(18,0),  
    PriceId              NUMERIC(18,0),  
    PriceCode            NVARCHAR(500),  
    NewBatchId           NUMERIC(18,0),  
    Slno                 INT,  
    PrdBatDetailValue    NUMERIC(36,4),  
    NewPriceId           NUMERIC(18,0)  
 )  
 --Added By Sathishkumar Veeramani 2015/01/08  
 DECLARE @ExistingSellingPriceDetails TABLE  
 (  
     PrdId        NUMERIC(18,0),  
     PrdBatId     NUMERIC(18,0),  
     PriceId      NUMERIC(18,0)  
 )  
 DECLARE @ExistingListPriceDetails TABLE  
 (  
     PrdId        NUMERIC(18,0),  
     PrdBatId     NUMERIC(18,0),  
     PriceId      NUMERIC(18,0)  
 )  
 --Till Here    
 DECLARE @BatSeqId   AS INT  
 DECLARE @ValDiffRefNo  AS VARCHAR(100)  
 DECLARE @ExistPrdBatMaxId AS  INT  
 DECLARE @NewPrdBatMaxId  AS  INT   
 DECLARE @ContPriceId  AS  NUMERIC(18,0)  
 DECLARE @OldPriceIdExt   AS  NUMERIC(18,0)  
 DECLARE @OldPriceId   AS  NUMERIC(18,0)  
 DECLARE @NewPriceId   AS  INT  
 DECLARE @ContPrdId          AS  INT  
 DECLARE @ContPrdBatId       AS  INT  
 DECLARE @ContPriceId1       AS  INT  
 DECLARE @PriceId            AS  INT   
 DECLARE @PriceBatch         AS  INT  
 DECLARE @BatchTransfer  AS INT  
 DECLARE @Po_BatchTransfer AS INT  

 SELECT @OldPriceId=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails WITH (NOLOCK) 
    
 SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)  

 SELECT @ExistPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch WITH (NOLOCK) 
  
 SET @Po_ErrNo =0  

 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D')  
 BEGIN  
  INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)  
  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'  

  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Product Batch','PrdCCode','Product :'+PrdCCode+' not available'  FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) 
  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK))    AND DownLoadFlag='D'  

  --->Added By Nanda on 05/05/2010  
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)  
  SELECT DISTINCT DistCode,'Product Batch',PrdBatCode,'Product',PrdCCode,'','N' FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)   
  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'  
  --->Till Here      

 END  
 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
 WHERE LEN(ISNULL(PrdBatCode,''))=0  AND DownLoadFlag='D')  
 BEGIN  
	  INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)  
	  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  

	  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
	  SELECT DISTINCT 1,'Product Batch','PrdBatCode','Batch Code should not be empty for Product:'+PrdCCode  FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  

 END  

 INSERT INTO @ExistingBatchDetails (PrdId,PrdCCode,PrdBatCode,PriceCode,OldLSP,PrdBatId,PriceId)  
 SELECT DISTINCT B.PrdId,B.PrdCCode,A.PrdBatCode,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+  
 CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,  
 ISNULL(D.PrdBatDetailValue,0) AS OldLSP,C.PrdBatId,D.PrdBatId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode  
 INNER JOIN ProductBatch C (NOLOCK)ON A.PrdBatCode=C.PrdBatCode AND B.PrdId=C.PrdId  
 INNER JOIN ProductBatchDetails D (NOLOCK) ON  D.PrdBatId=C.PrdBatId AND D.DefaultPrice=1 AND D.SlNo=2  
 WHERE A.PrdBatCode NOT IN (SELECT PrdBatCode FROM PrdBatToAvoid) AND DownLoadFlag='D'  
 --Added By Sathishkumar Veeramani 2015/01/08 
  
 --Selling Rate Validation  
 INSERT INTO @ExistingSellingPriceDetails (PrdId,PrdBatId,PriceId)  
 SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode  
 INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.SellingRate = C.PrdBatDetailValue  
 WHERE C.SLNo = 3  

 --List Price Validation  
 INSERT INTO @ExistingListPriceDetails (PrdId,PrdBatId,PriceId)  
 SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode  
 INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.ListPrice = C.PrdBatDetailValue  
 WHERE C.SLNo = 2  

 SELECT DISTINCT A.PrdId,A.PrdBatId,MAX(A.PriceId) AS PriceId INTO #ExistinPriceCloning   
 FROM @ExistingSellingPriceDetails A   
 INNER JOIN @ExistingListPriceDetails B ON A.PrdId = B.PrdId  
 AND A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId GROUP BY A.PrdId,A.PrdBatId 
  
 IF EXISTS (SELECT DISTINCT PrdId,PrdBatId,PriceId FROM #ExistinPriceCloning)  
 BEGIN  
     UPDATE A SET A.DefaultPrice = 0 FROM ProductBatchDetails A (NOLOCK)   
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId  
     UPDATE A SET A.DefaultPrice = 1 FROM ProductBatchDetails A (NOLOCK)  
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
     UPDATE A SET A.DefaultPriceId = B.PriceId FROM ProductBatch A (NOLOCK)   
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId  
	 
     IF EXISTS (SELECT PriceId ,Count(Priceid) Cnt  FROM ProductBatchDetails group by PriceId HAVING COUNT(Priceid)>5  )
	 BEGIN 
		SELECT Prdbatid,PriceId ,Count(Priceid) Cnt
		INTO #PrdBatch
		FROM ProductBatchDetails 
		group by Prdbatid,PriceId HAVING COUNT(Priceid)>5
		  
		SELECT  DISTINCT A.PrdBatid,B.Priceid  INTO #Price  FROM ProductBatch  A INNER JOIN PRODUCTBATCHDETAILS B ON A.PrdBatId = B.PrdBatid AND A.LastModDate = B.LastModDate 
		and b.PrdBatId IN (select Prdbatid FROM #PrdBatch)
		and PriceCode NOT LIKE '%Splrate%'  
		
		UPDATE A SET DefaultPriceId=B.PriceId FROM ProductBatch  A INNER JOIN PRODUCTBATCHDETAILS B ON A.PrdBatId = B.PrdBatid AND A.LastModDate = B.LastModDate 
		and  PriceCode NOT LIKE '%Splrate%'  and b.PrdBatId IN (select Prdbatid FROM #PrdBatch)

		UPDATE PRODUCTBATCHDETAILS SET DefaultPrice =1 WHERE Priceid in (select priceid FROM #Price)  and PrdBatId IN (select Prdbatid FROM #PrdBatch)

		UPDATE PRODUCTBATCHDETAILS SET DefaultPrice =0 WHERE Priceid NOt in (select priceid FROM #Price) 
		and  PrdBatId IN (select Prdbatid FROM #PrdBatch)

	END  
 END  

 --Till Here  
 --Added By Sathishkumar Veeramani 2015/01/08  
 --Batch Cloning Details  
 DECLARE @BatchPriceId AS NUMERIC(18,0)  
 SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK) 
  
 SELECT DISTINCT CAST(DENSE_RANK() OVER (ORDER BY MAX(PrdBatId),MRP,ListPrice,SellingRate,ClaimRate) AS NUMERIC(18,0))+@BatchPriceId AS PriceId,  
 MAX(PrdBatId) AS PrdBatId,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+CAST(SellingRate AS NVARCHAR(25))+'-'+  
 CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,MRP,ListPrice,  
 SellingRate,ClaimRate,AddRate1 as LCTRAmount INTO #BatchCloningDetails FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)  
 INNER JOIN Product B (NOLOCK) ON A.PrdCCode = B.PrdCCode   
 INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId AND A.PrdBatCode = C.PrdBatCode WHERE DownloadFlag = 'D'  
 AND NOT EXISTS (SELECT DISTINCT PrdId,PrdBatId FROM #ExistinPriceCloning D WHERE C.PrdId = D.PrdId AND C.PrdBatId = D.PrdBatId)   
 GROUP BY A.PrdBatCode,MRP,ListPrice,SellingRate,ClaimRate,AddRate1 
  
 IF EXISTS (SELECT DISTINCT PrdBatId FROM #BatchCloningDetails)  
 BEGIN  
 	UPDATE A SET DefaultPrice = 0 FROM ProductBatchDetails A WITH(NOLOCK)   
 	INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId  
 	--CRCRSTPAR0083
 
 	INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,  
 	Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)  
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,1,SlNo,Rate,1,1,1,1,GETDATE(),1,GETDATE(),0 FROM(  
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,1 AS SlNo,MRP AS Rate FROM #BatchCloningDetails UNION  
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,2 AS SlNo,ListPrice AS Rate FROM #BatchCloningDetails UNION  
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,3 AS SlNo,SellingRate AS Rate FROM #BatchCloningDetails UNION  
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,4 AS SlNo,ClaimRate AS Rate FROM #BatchCloningDetails UNION
 	SELECT DISTINCT PriceId,PrdBatId,PriceCode,5 AS SlNo,LCTRAmount AS Rate FROM #BatchCloningDetails)Qry ORDER BY PrdBatId  
 	SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK)  
 
 	UPDATE Counters SET CurrValue = @BatchPriceId WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'  
 
 	UPDATE A SET DefaultPriceId = B.PriceId FROM ProductBatch A WITH(NOLOCK) INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId 
 
 END  
 --Till Here  

 IF EXISTS (SELECT * FROM @ExistingBatchDetails)  
 BEGIN  
	  UPDATE A SET MnfDate=C.ManufacturingDate,ExpDate=ExpiryDate  
	  FROM ProductBatch A (NOLOCK) INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId  
	  INNER JOIN Cn2Cs_Prk_ProductBatch C (NOLOCK) ON A.PrdBatCode=C.PrdBatCode  AND B.PrdCCode=C.PrdCCode  
	  WHERE C.DownLoadFlag='D'  

	  UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y'   
	  WHERE PrdCCode+'~'+PrdBatCode IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ExistingBatchDetails) AND DownLoadFlag='D'   
 END  

 DECLARE @Count1 NUMERIC(18,0)  
 DECLARE @Count2 NUMERIC(18,0)  
 SELECT @Count1=COUNT(*) FROM Cn2Cs_Prk_ProductBatch  
 SELECT @Count2=COUNT(*) FROM @ExistingBatchDetails  

 IF @Count1<>@Count2  
  BEGIN  
	 
	 ---New ProductBatch    
	  INSERT INTO @ProductBatchWithCounter  
	  SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatch' AND FldName='PrdBatId'),  
	  B.PrdId,A.PrdCCode,A.PrdBatCode,ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
	  INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C (NOLOCK)   
	  WHERE C.PrdBatCode=A.PrdBatCode AND B.PrdId=C.PrdId)AND   
	  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'  
	  ORDER BY ManufacturingDate ASC --Muthuvel  
	  UPDATE @ProductBatchWithCounter SET TransNo=TransNo+Slno  

	 --Existing ProductBatch   
	   INSERT INTO @ProductBatchWithCounter  
	   SELECT DISTINCT C.PrdBatId,B.PrdId,A.PrdCCode,A.PrdBatCode,  
	   ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode  
	   INNER JOIN ProductBatch C ON B.PrdId = C.PrdId AND C.PrdBatCode = A.PrdBatCode WHERE   
	   NOT EXISTS (SELECT PrdBatId FROM ProductBatchDetails D(NOLOCK) WHERE D.PrdBatId = C.PrdBatId AND D.PriceId = C.DefaultPriceId)   
	   AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'  
	   AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ProductBatchWithCounter)  

	  --Product Batch     

	  INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,Status,  
	  TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
	  SELECT DISTINCT A.PrdId,TransNo,PrdBatCode,PrdBatCode,MnfDate,ExpDate,1,B.TaxGroupId,@BatSeqId,  
	  6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchWithCounter A   
	  INNER JOIN Product B ON A.PrdId=B.PrdId WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C WHERE A.PrdId = C.PrdId   
	  AND A.PrdBatCode = C.PrdBatCode)  
		  
  END 
   
 IF EXISTS (SELECT * FROM @ProductBatchWithCounter)   
 BEGIN  
	UPDATE Counters SET CurrValue = (SELECT MAX(PrdBatId) FROM ProductBatch) WHERE TabName = 'ProductBatch' AND FldName = 'prdbatid'  

	INSERT INTO @ProductBatchPriceWithCounter  
	SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'),A.PrdId,A.TransNo,  
	A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+  
	CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)),MRP,ListPrice,  
	SellingRate,ClaimRate,AddRate1 FROM @ProductBatchWithCounter A INNER JOIN Cn2Cs_Prk_ProductBatch B WITH (NOLOCK)  
	ON A.PrdCCode=B.PrdCCode AND A.PrdBatCode=B.PrdBatCode WHERE B.DownLoadFlag='D'  

	UPDATE @ProductBatchPriceWithCounter SET TransNo=TransNo+Slno  

	UPDATE A SET A.DefaultPrice=0 FROM ProductBatchDetails A WITH (NOLOCK),@ProductBatchPriceWithCounter B WHERE A.PrdBatId = B.PrdBatId  
 END     

 IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
 BEGIN  
 --CRCRSTPAR0083
  INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,  
  DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
 END  
 ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
 BEGIN  
  INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,  
  DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
 END   

 UPDATE A SET DefaultPriceId=C.TransNo FROM ProductBatch A INNER JOIN (SELECT PrdId,PrdBatId,Max(TransNo) TransNo FROM @ProductBatchPriceWithCounter GROUP BY  PrdId,PrdBatId )C
 ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId   

 UPDATE C SET DefaultPrice = 0 FROM ProductBatch A INNER JOIN @ProductBatchPriceWithCounter B ON B.PrdBatId=A.PrdBatId AND A.PrdId=B.PrdId  
 INNER JOIN ProductBatchDetails C ON B.TransNo=C.priceid AND B.Prdbatid = C.PrdBatid AND A.PrdBatId =C.PrdBatId 

  UPDATE C SET DefaultPrice = 1 FROM ProductBatch A INNER JOIN @ProductBatchPriceWithCounter B ON B.PrdBatId=A.PrdBatId AND A.PrdId=B.PrdId  
 INNER JOIN ProductBatchDetails C ON B.TransNo=C.priceid AND B.Prdbatid = C.PrdBatid AND A.PrdBatId =C.PrdBatId AND A.DefaultPriceId = C.PriceId 


 IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter)   
 BEGIN  
  UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails)  WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'   
 END  

 --Batch Cloning Price Details  
 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeRateForOldBatch' AND ModuleName='Botree Product Batch Download' AND Status=1)  
 BEGIN  
	IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter A INNER JOIN @ExistingBatchDetails B ON A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId  
	WHERE (B.OldLSP-A.ListPrice)<>0 AND Slno=2)  
	BEGIN  
		SELECT @ValDiffRefNo = dbo.Fn_GetPrimaryKeyString('ValueDifferenceClaim','ValDiffRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))  
		INSERT INTO ValueDifferenceClaim(ValDiffRefNo,Date,PrdId,PrdBatId,OldPriceId,NewPriceId,OldPrice,NewPrice,Qty,  
		ValueDiff,ClaimAmt,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
		SELECT @ValDiffRefNo,GETDATE(),A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice,  
		ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0),B.OldLsp-C.ListPrice,  
		ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0)*(B.OldLsp-C.ListPrice),  
		1,1,GETDATE(),1,GETDATE() FROM ProductBatchLocation A INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatID=B.PrdBatId   
		INNER JOIN @ProductBatchPriceWithCounter C ON A.PrdBatId=C.PrdBatId AND A.PrdId=C.PrdId  
		WHERE C.Slno=2 GROUP BY A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice  

		UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'ValueDifferenceClaim' AND FldName = 'ValDiffRefNo'  
	END  
 END  

 UPDATE ProductBatch SET ProductBatch.DefaultPriceId=PBD.PriceId,ProductBatch.BatchSeqId=PBD.BatchSeqId  
 FROM ProductBatchDetails PBD WITH (NOLOCK) WHERE ProductBatch.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1  

 UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN  
 (  
  SELECT PrdBatId FROM ProductBatchDetails WITH (NOLOCK) GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)  
 ) 
  
 SELECT PrdBatId INTO #ZeroBatches FROM ProductBatchDetails WITH (NOLOCK)  GROUP BY PrdBatId HAVING SUM(DefaultPrice)=0  

 SELECT B.PrdId,B.PrdBatId,MAX(PriceId) As PriceId INTO #ZeroMaxPrices FROM ProductBatchDetails A INNER JOIN ProductBatch B ON A.PrdBatId=B.PrdBatId  
 INNER JOIN #ZeroBatches C ON A.PrdBatId=C.PrdBatId  WHERE A.DefaultPrice=0 AND NOT EXISTS  
 (SELECT DISTINCT PriceId FROM #BatchCloningDetails D WHERE A.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId)  
 AND NOT EXISTS (SELECT DISTINCT PriceId FROM #ExistinPriceCloning E WHERE A.PrdBatId = E.PrdBatId AND A.PriceId = E.PriceId)  
 GROUP BY B.PrdId,B.PrdBatId   

 UPDATE ProductBatch Set DefaultPriceId=B.PriceId FROM ProductBatch A,#ZeroMaxPrices B WHERE A.PrdBatId=B.PrdbatId and A.PrdId=B.PrdId   

 UPDATE ProductBatchDetails Set DefaultPrice=1 FROM #ZeroMaxPrices A  WHERE ProductBatchDetails.PrdbatId=A.PrdBatId AND ProductBatchDetails.PriceId=A.PriceId  
 
 SET @Po_ErrNo=0  
 
 SELECT @OldPriceIdExt=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails
   
 --IF @ExistPrdBatMaxId>0  
 --BEGIN  
 -- SELECT @NewPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch  
 -- IF @NewPrdBatMaxId>@ExistPrdBatMaxId  
 -- BEGIN  
 --     --Existing Contract Pricing Percentage Updated to New Batch Download  
 --     --Modified by Rajesh  
 --     --    SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate INTO #SpecialRateCreatedDate  
 --     --FROM SpecialRateAftDownload WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode  
 --  SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate  INTO #SpecialRateCreatedDate1    
 --  FROM SpecialRateAftDownload_calc WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode  
 --  SELECT DISTINCT A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.CreatedDate ,A.ApplyOn,A.TYPE INTO #SpecialRateCreatedDate  
 --  FROM SpecialRateAftDownload_calc A WITH(NOLOCK) INNER JOIN  #SpecialRateCreatedDate1 B (NOLOCK)   
 --  ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode  = B.RtrCtgValueCode AND A.RtrCode= B.RtrCode AND A.PrdCCode= B.PrdCCode  
 --  AND A.CreatedDate = B.CreatedDate AND A.ApplyOn is not null  
 --  --SELECT DISTINCT C.PrdId,E.PrdBatId,TransNo AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,  
 --  --D.PrdBatCode,DiscountPerc,(MRP-(MRP*(DiscountPerc/100))) AS SplRate INTO #SpecialRateDetails   
 --  --FROM SpecialRateAftDownload A WITH(NOLOCK)  
 --  --INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode   
 --  --AND A.RtrCode = B.RtrCode AND A.PrdCCode = B.PrdCCode AND A.CreatedDate = B.CreatedDate  
 --  --INNER JOIN Product C WITH(NOLOCK) ON A.PrdCCode = C.PrdCCode     
 --  --INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId  
 --  --INNER JOIN @ProductBatchPriceWithCounter E ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId  
 --  --ORDER BY A.PrdCCode  
 --    SELECT DISTINCT C.PrdId,E.PrdBatId,TransNo AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,    
 --    D.PrdBatCode,DiscountPerc,B.ApplyOn,B.Type,  
 --    (CASE B.ApplyOn WHEN 1 THEN   
 --    (CASE B.[Type] WHEN 1 THEN (MRP*100/(100+DiscountPerc)) WHEN 2 THEN MRP-(MRP*(DiscountPerc/100))  
 --    ELSE SellingRate-(SellingRate*(DiscountPerc/100))  END)    
 --    ELSE SellingRate-(SellingRate*(DiscountPerc/100)) END) AS SplRate  
 --    INTO #SpecialRateDetails     
 --    FROM SpecialRateAftDownload_calc A WITH(NOLOCK)    
 --    INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode     
 --    AND A.RtrCode = B.RtrCode AND A.PrdCCode = B.PrdCCode AND A.CreatedDate = B.CreatedDate    
 --    INNER JOIN Product C WITH(NOLOCK) ON A.PrdCCode = C.PrdCCode       
 --    INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId    
 --    INNER JOIN @ProductBatchPriceWithCounter E ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId    
 --    ORDER BY A.PrdCCode   
 --  --Till Here     
 --  SELECT DISTINCT MAX(E.ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,E.CtgValMainId   
 --  INTO #SpecialContractDetails FROM #SpecialRateDetails A WITH(NOLOCK)   
 --  INNER JOIN RetailerCategoryLevel B WITH(NOLOCK) ON A.RtrCtgCode = B.CtgLevelName   
 --  INNER JOIN RetailerCategory C WITH(NOLOCK) ON A.RtrCtgValueCode = C.CtgCode AND B.CtgLevelId = C.CtgLevelId  
 --  INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId   
 --  INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId AND A.PrdId = E.PrdId  AND CtgValMainId=0
 --  GROUP BY A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,CtgValMainId  
 --  ---Tax Calculation  
 --  DECLARE @PrdIdTax as BIGINT  
 --  DECLARE @PrdbatIdTax AS BIGINT  
 --  DECLARE Cur_Tax CURSOR  
 --  FOR   
 --  SELECT DISTINCT PrdId,PrdbatId FROM #SpecialContractDetails    
 --  OPEN Cur_Tax   
 --  FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax  
 --  WHILE @@FETCH_STATUS=0  
 --  BEGIN   
 --    EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax  
 --  FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax    
 --  END    
 --  CLOSE Cur_Tax  
 --  DEALLOCATE Cur_Tax   
 --  --Modified by Rajesh  
 --  SELECT DISTINCT A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,RtrCtgValueCode)+ @OldPriceIdExt AS NewPriceId,  
 --  --CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSelRate   
 --  CASE A.ApplyOn WHEN 1 THEN   
 --         (CASE [Type] WHEN 1 THEN (SplRate*100)/(100+TaxPercentage)  
 --          WHEN 2 THEN (SplRate*100)/(100+TaxPercentage) END)  
 --  ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSelRate  
 --  INTO #SplProductBatchDetails  
 --  FROM #SpecialContractDetails A WITH(NOLOCK) INNER JOIN ProductBatchTaxPercent B WITH(NOLOCK) ON A.PrdId = B.PrdId  
 --  AND A.PrdBatId = B.PrdBatId ORDER BY A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode  
 --  --Product Batch Details Value Added     
	--INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,  
 --   Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)   
 --   SELECT DISTINCT NewPriceId,A.PrdBatId,PriceCode+'SplRate'+CONVERT(NVARCHAR(200),B.NewSelRate)+CONVERT(NVARCHAR(10),GETDATE(),121),  
 --   A.BatchSeqId,A.SLNo,(CASE SelRte WHEN 1 THEN B.NewSelRate ELSE PrdBatDetailValue END),0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,  
 --   CONVERT(NVARCHAR(10),GETDATE(),121),0  
 --   FROM ProductBatchDetails A WITH(NOLOCK)   
 --   INNER JOIN #SplProductBatchDetails B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
 --   INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId  
 --   INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo ORDER BY A.PrdBatId,NewPriceId   
 --   UPDATE Counters SET CurrValue =(SELECT MAX(PriceId) FROM ProductBatchDetails) WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'  
 --   --Contract Pricing Details Added  
 --   INSERT INTO ContractPricingDetails (ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,LastModDate,AuthId,  
 --   AuthDate,CtgValMainId,ClaimablePercOnMRP)              
 --   SELECT DISTINCT ContractId,A.PrdId,A.PrdBatId,B.NewPriceId,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),CtgValMainId,0  
 --   FROM #SpecialContractDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdID AND A.PrdBatId = B.PrdBatId AND A.RtrCtgValueCode=B.RtrCtgValueCode  
 --   WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE A.ContractId = C.ContractId   
 --   AND A.PrdId = C.PrdID AND A.PrdBatId = C.PrdBatId) ORDER BY ContractId,A.PrdId,A.PrdBatId,B.NewPriceId  
 --   --Special Rate Updated  
 --   INSERT INTO SpecialRateAftDownload (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,  
 --   ContractPriceIds,DiscountPerc,SplrateId)  
 --   SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),  
 --   '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0  
 --   FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
 --   and A.RtrCtgValueCode=B.RtrCtgValueCode  
 --   ORDER BY PrdCCode,PrdBatCode  
 --   --Added By Rajesh  
 --   INSERT INTO SpecialRateAftDownload_calc (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,  
 --   ContractPriceIds,DiscountPerc,SplrateId,ApplyOn,TYPE)  
 --   SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),  
 --   '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0,A.ApplyOn,A.TYPE  
 --   FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
 --   and A.RtrCtgValueCode=B.RtrCtgValueCode  
 --   ORDER BY PrdCCode,PrdBatCode  
 --   --Till Here  
 -- --SELECT * INTO #PrdBatch  FROM CONTRACTPRICINGDETAILS A WHERE NOT EXISTS (SELECT PRDID FROM ProductBatch B WHERE  A.PRDID = B.PRDID )  
 --  --TRUNCATE TABLE ProductBatchPriceWithCounter  
 --  --IF EXISTS (SELECT *FROM #PrdBatch)  
 --  --BEGIN 
 --    TRUNCATE TABLE ProductBatchPriceWithCounter
 --   INSERT INTO  ProductBatchPriceWithCounter  
 --   SELECT *  FROM @ProductBatchPriceWithCounter  
 --   EXEC Proc_InsertContractPricingForNewProduct  
 --  --END 
 --  --SELECT PrdId,PrdBatId,TransNo, FROM @ProductBatchPriceWithCounter INNER JOIN   
 --     --SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId INTO #ContractPrice FROM ProductBatch A (NOLOCK),@ProductBatchWithCounter B  
 --  --WHERE  A.PrdId = B.PrdId AND A.PrdBatId < @ExistPrdBatMaxId AND EXISTS  
 --  --(SELECT CPD.PrdBatId FROM ContractPricingDetails CPD (NOLOCK)  
 --  --INNER JOIN ProductBatch PB1 (NOLOCK) ON CPD.PrdId=PB1.PrdId AND CPD.PrdBatId=PB1.PrdBatId AND A.PrdBatId=CPD.PrdBatId  
 --  --AND CPD.PrdID IN (SELECT DISTINCT PrdId FROM @ProductBatchWithCounter))GROUP BY A.PrdId   
 -- -- INSERT INTO @ContractPrice (PrdId,PrdBatId)  
 -- -- SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK),  
 -- -- ContractPricingDetails B (NOLOCK),@ProductBatchWithCounter C  
 -- --          WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId AND A.PrdId = C.Prdid AND B.PrdId = C.Prdid   
 -- --          GROUP BY A.PrdId ORDER BY A.PrdId  
 -- -- IF EXISTS(SELECT * FROM @ContractPrice)  
 -- -- BEGIN  
 -- --  SELECT DISTINCT PrdbatId,PriceId,Max(PriceCode) as PriceCode INTO #ProductBatchDetails   
 -- --  FROM ProductBatchDetails  
 -- --  GROUP BY PrdbatId,PriceId  
 -- --  INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode)   
 -- --  SELECT Max(C.ContractId) as ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,  
 -- --  --CAST('' AS NVARCHAR(4000)) AS PriceCode  
 -- --  PriceCode  
 -- --  FROM  ContractPricingMaster D (NOLOCK)   
 -- --  INNER JOIN  ContractPricingDetails C (NOLOCK)   ON C.ContractId = D.ContractId  
 -- --  INNER JOIN  #ProductBatchDetails A (NOLOCK) ON A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId  
 -- --  INNER JOIN @ContractPrice E  ON E.PrdBatId = C.PrdBatId AND E.PrdId = C.PrdId   
 -- --  GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId ,PriceCode  
 -- --     --INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode)  
 -- --     --SELECT DISTINCT MAX(D.ContractId) AS ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,  
 -- --     --CAST('' AS NVARCHAR(4000)) AS PriceCode FROM ProductBatchDetails A (NOLOCK),  
 -- --     --ContractPricingDetails C (NOLOCK),ContractPricingMaster D (NOLOCK),@ContractPrice E   
 -- --     --WHERE A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId AND C.ContractId = D.ContractId AND E.PrdId = C.PrdId   
 -- --     --AND E.PrdBatId = C.PrdBatId GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId      
 -- --     --UPDATE A SET A.PriceCode = D.PriceCode FROM @ContractBatchPrice A,ContractPricingDetails B WITH(NOLOCK),  
 -- --     --ContractPricingMaster C WITH(NOLOCK),ProductBatchDetails D WITH(NOLOCK) WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
 -- --     --AND A.CtgMainId = C.CtgMainId AND D.PrdBatId = A.PrdBatId AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId   
 -- --     --UPDATE A SET A.PriceCode = D.PriceCode  
 -- --     --FROM @ContractBatchPrice A   
 -- --     --INNER JOIN ContractPricingDetails B WITH(NOLOCK) ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
 -- --     --INNER JOIN ContractPricingMaster C WITH(NOLOCK) ON   A.CtgMainId = C.CtgMainId  AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId and A.ContractId=B.ContractId  
 -- --     --INNER JOIN #ProductBatchDetails D WITH(NOLOCK) ON D.PrdBatId = A.PrdBatId   
 -- --     --select 'Botree',* from @ProductBatchPriceWithCounter  
 -- --     --select 'Software',* from @ContractBatchPrice  
 -- --  SELECT DISTINCT SlNo INTO #BatchCreation FROM BatchCreation A (NOLOCK)  
 -- --  INNER JOIN (SELECT MAX(BatchseqId)  as BatchseqId FROM BatchCreationMaster (NOLOCK))X  
 -- --  ON A.BatchSeqId=X.BatchSeqId  
 -- --     INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PriceCode,NewBatchId,Slno,PrdBatDetailValue,NewPriceId)   
 -- --  SELECT DISTINCT A.PrdId,A.PrdBatId,A.PriceId,A.PriceCode,B.PrdBatId AS NewBatchId,PBD.Slno,PrdBatDetailValue,  
 -- --  DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,B.PrdBatId)+ @OldPriceId AS NewPriceId   
 -- --  FROM @ContractBatchPrice A INNER JOIN @ProductBatchPriceWithCounter B   
 -- --  ON A.PrdId = B.PrdId  
 -- --  INNER JOIN ProductBatchDetails PBD WITH(NOLOCK) ON PBD.PrdBatId=A.PrdBatId and PBD.PriceId=A.PriceId   
 -- --  INNER JOIN #BatchCreation C WITH(NOLOCK) ON C.SlNo=PBD.Slno  
 -- --  ORDER BY A.PrdId,A.PrdBatId,A.PriceId,B.PrdBatId  
 -- --  IF(SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4  
 -- --  BEGIN  
 -- --   INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,  
 -- --      PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
 -- --   SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,  
 -- --   1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)   
 -- --   FROM @ProductBatchDetails  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4   
 -- --  END  
 -- --  ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
 -- --  BEGIN  
 -- --   INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,  
 -- --   PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
 -- --   SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,  
 -- --   1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)   
 -- --                  FROM @ProductBatchDetails  
 -- --                  UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4  
 -- --   UPDATE A SET A.PrdBatDetailValue = B.AddRate1 FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
 -- --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 5  
 -- --  END   
 -- --      IF EXISTS (SELECT * FROM @ProductBatchDetails)  
 -- --      BEGIN  
 -- --    INSERT INTO ContractPricingDetails(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,  
 -- --    Availability,LastModBy,LastModDate,AuthId,AuthDate,CtgValMainId)  
 -- --    SELECT DISTINCT ContractId,A.PrdId,NewBatchId,NewPriceId,Discount,FlatAmtDisc,  
 -- --    Availability,LastModBy,GETDATE(),AuthId,GETDATE(),CtgValMainId  
 -- --    FROM ContractPricingDetails A,@ProductBatchDetails B WHERE A.PrdId = B.PrdId   
 -- --    AND A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
 -- --   END   
 --     --UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails)   
 --     --WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'       
 -- -- END  
 -- END  
 --END  
	SELECT @NewPriceId=CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'     
	IF @NewPriceId>@OldPriceId  
	BEGIN  
		IF EXISTS(SELECT * FROM Configuration(NOLOCK) WHERE ModuleId='BotreeRateForOldBatch'  
		AND ModuleName='Botree Product Batch Download' AND Status=1)  
		BEGIN  
			EXEC Proc_DefaultPriceUpdation @ExistPrdBatMaxId,@OldPriceId,1  
		END  
	END  
	IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@OldPriceId)  
	BEGIN  
		EXEC Proc_DefaultPriceHistory 0,0,@NewPriceId,2,1  
	END  
	
	---MOORTHI  START  
	IF @ExistPrdBatMaxId>0  
	BEGIN    
	SET @BatchTransfer=0  
		SELECT @BatchTransfer=Status FROM Configuration WHERE ModuleId='BotreeAutoBatchTransfer'  
		IF @BatchTransfer=1  
		BEGIN  
			EXEC Proc_AutoBatchTransfer @ExistPrdBatMaxId,@Po_ErrNo = @Po_BatchTransfer OUTPUT  
			IF @Po_BatchTransfer=1  
			BEGIN  
				INSERT INTO Errorlog VALUES (1,'Cn2Cs_Prk_BLProductBatch','Product Batch-Auto Batch Transfer',  
				'Auto Batch Transfer is not done properly')              
				SET @Po_ErrNo=1      
			END  
		END  
	END   
 --END  

 UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y' WHERE PrdCCode+'~'+PrdBatCode IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)   

 RETURN    
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_GSTUserLogInValidation' AND XTYPE='P')
DROP PROCEDURE Proc_GSTUserLogInValidation
GO
CREATE PROCEDURE [dbo].[Proc_GSTUserLogInValidation](@ServerDate AS DATETIME)
AS
/*********************************
* PROCEDURE		: Proc_UserLogInValidation
* PURPOSE		: To Validate User Log in Proc_UserLogInValidation
* CREATED		: S.Moorthi
* CREATED DATE	: 17-04-2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
**************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		Target uploaded is not reflecting in Report
 27-08-2020   Raja C      CR                                Old Bulleting Messages should not show 
****************************************************************************************/
SET NOCOUNT ON
BEGIN
DECLARE @GstEnabled AS INT
SET @GstEnabled=0
	IF EXISTS(SELECT * FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 AND 
	AcknowledgeStatus=1 and ConsoleAckStatus=1 AND ModuleId='GSTCONFIG' )
	BEGIN
		SET @GstEnabled=1
	END
	
	UPDATE B SET B.Status=1 FROM BroadCast B (NOLOCK) WHERE DownloadedDate<CONVERT(VARCHAR(10),GETDATE()-15,121) -->Added by Raja C on 27/08/2020
	
	DECLARE @SpmId AS INT
	SET @SpmId=0
	IF NOT EXISTS(SELECT '*' FROM Supplier (NOLOCK) WHERE SpmDefault=1)
	BEGIN
		SELECT @SpmId=MAX(ISNULL(SpmId,0)) FROM Supplier (NOLOCK)
		UPDATE Supplier SET SpmDefault=1 WHERE SpmId=@SpmId
	END
	
	DECLARE @VatTaxGroupId AS INT
	SET @VatTaxGroupId=0
	IF EXISTS(SELECT * FROM VATDefaultSupplierGST (NOLOCK))
	BEGIN		
		DECLARE @CmpId AS INT
		SET @CmpId=0
		SELECT @CmpId=CmpId FROM COMPANY WHERE DefaultCompany=1
		SELECT @VatTaxGroupId=MAX(ISNULL(TaxGroupId,0)) FROM VATDefaultSupplierGST (NOLOCK)
		UPDATE Supplier SET VATTaxGroupId=@VatTaxGroupId --WHERE ISNULL(VATTaxGroupId,0)=0
		UPDATE Supplier SET CmpId=@CmpId WHERE ISNULL(CmpId,0)=0
	END
	IF @GstEnabled=0
	BEGIN
		---NESTLE EDITABLE=1
		UPDATE A SET A.Editable=0,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='PRODUCT MASTER' AND ColumnName IN ('HSN Code','HSN Description')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='RETAILER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Retailer Type','Composition','Related Party')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='SUPPLIER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','Status')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='DISTRIBUTOR INFO MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Distributor Type')
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='COMPANY MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number')
		
	END
	ELSE
	BEGIN
	
		UPDATE A SET A.Editable=0,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='PRODUCT MASTER' AND ColumnName IN ('HSN Code','HSN Description')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='RETAILER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Retailer Type','Composition','Related Party')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='SUPPLIER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','Status')
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='COMPANY MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='DISTRIBUTOR INFO MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Distributor Type')
		IF NOT EXISTS(SELECT * FROM Gst_FieldLevelConfiguration WHERE Transid=2)
		BEGIN
			INSERT INTO Gst_FieldLevelConfiguration
			SELECT 2,1,'fxtInvDisc',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,2,'fxtInvDiscAmt',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			--SELECT 2,3,'fxtWindowDisplayAmount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,4,'chkInvoiceDisc',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,5,'fxtOnAccountAmount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,6,'btnOperation',12,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,7,'btnOperation',9,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,8,'btnOperation',8,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,9,'btnOperation',10,1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,10,'btnOperation',11,1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,11,'chkOnAccount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) --UNION
			--SELECT 2,12,'chkWindowDisplay',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
		END
		----Retailer Taxgroup Update Post GST Migrate
		UPDATE  B SET B.TaxGroupId=C.TaxGroupId 
		FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=1 and A.UpdateFlag=0
		UPDATE  D SET D.TaxGroupId=C.TaxGroupId 
		FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode
		INNER JOIN RetailerShipAdd D ON D.RtrId=B.RtrId
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=1 and A.UpdateFlag=0 and RtrShipDefaultAdd=1
		DELETE A FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode 
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup  and B.TaxGroupId=C.TaxGroupId
		WHERE C.TaxGroup=1 and A.UpdateFlag=0
		--DECLARE @VatTaxGroupId AS INT
		SET @VatTaxGroupId=0
		IF EXISTS(SELECT * FROM VATDefaultSupplier (NOLOCK))
		BEGIN
			SELECT @VatTaxGroupId=MAX(ISNULL(TaxGroupId,0)) FROM VATDefaultSupplier (NOLOCK)
			UPDATE Supplier SET VATTaxGroupId=@VatTaxGroupId WHERE ISNULL(VATTaxGroupId,0)=0
		END
		
		----Supplier TaxGroup Update Post GST Migrate
		UPDATE  B SET B.TaxGroupId=C.TaxGroupId 
		FROM SupplierGSTTaxGroupUpdate A 
		INNER JOIN Supplier B ON A.SpmCode=B.SpmCode
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=3 and A.UpdateFlag=0
		
		DELETE A FROM SupplierGSTTaxGroupUpdate A 
		INNER JOIN Supplier B ON A.SpmCode=B.SpmCode 
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup  and B.TaxGroupId=C.TaxGroupId
		WHERE C.TaxGroup=3 and A.UpdateFlag=0
		
	END
	
RETURN
END
GO
---Till Here Mohana.S
----Live Script Updater starts
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_InStBaseDiscountClaim' AND TYPE='P' )
DROP PROCEDURE Proc_InStBaseDiscountClaim
GO
CREATE PROCEDURE Proc_InStBaseDiscountClaim
(   
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_UsrId	INT,
	@Pi_Transid	INT
)  
AS  
/*******************************************************************************************************************
* PROCEDURE	: Proc_SchUtilization_DNClaim  (COPIED FROM REPORT PROCEDURE)
* PURPOSE	: TO GET THE SCHEME UTILIZATION DETAILS IN GIVEN PERIOD
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 15-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************
* DATE			RESOURCE			CR/BZ				USERSTORYID					DESCRIPTION
* 18-12-2019	MOHANA S			CR					CRCRSTPAR0095				RESTIRCTED INSTITUTIONAL SCHEME IN TRADE SCHEME DOWNLOAD
* 05-02-2020	MOHANA S			SR					ILCRSTPAR7731				AS PER CLIENT REQUEST, THE MONTARGET AND L2SALES LOGIC CHANGED
* 28-02-2020	MOHANA S			SR					ILCRSTPAR8062				Validation included to take only defined retailers from schemertrvalidation
* 07-07-2020	MOHANA S	     	SR					UAT CHANGES					INSTEAD OF GROSS AMOUNT, NET AMOUNT HAS BEEN CHANGED
* 07-08-2020	MOHANA S			SR					PARLESECS/0820/014			To restirct the wrong date scheme
**********************************************************************************************************************/
BEGIN  
SET NOCOUNT ON  
			 
	DECLARE @Pi_FromDate  DATETIME
	DECLARE @Pi_Todate	   DATETIME
			
	DECLARE @InsFromDate AS DATETIME       
	DECLARE @InsToDate  AS DATETIME   
		  
	SELECT @Pi_FromDate= DATEADD(MONTH, (@Pi_Month)-1, CONVERT(VARCHAR(10),@Pi_Year))
	SELECT @Pi_Todate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,CONVERT(VARCHAR(10),@Pi_Year)))	
			 
	DELETE FROM TempInsTargetClaimDetails WHERE SchType<>0
			
	SELECT * INTO #SchemeMaster  FROM SchemeMaster WHERE ClmRefId  IN (SELECT ClmgrpId FROM ClaimGroupMaster WHERE ClmGrpCode ='CG10004') --CRCRSTPAR0095
		    
	SELECT DISTINCT  A.CmpSchcode,CircularNo,CircularDate,SchemeBudget INTO #Schemecirculardetails 
	FROM Schemecirculardetails A INNER JOIN #SchemeMaster B ON A.CmpSchcode=B.CmpSchcode

		    
	SELECT DISTINCT B.* INTO #SalesInvoiceSchemeLineWise FROM SalesInvoice A (NOLOCK)
	INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SALID =B.SALID AND  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3  
	INNER JOIN #SchemeMaster C ON C.Schid = B.Schid
	INNER JOIN (SELECT DISTINCT Schid,Rtrid FROM SchemeRtrLevelValidation) S ON A.RtrId = S.RtrId AND B.SchId = S.SchId AND S.SchId = C.SchId --ILCRSTPAR8062 
	
	SELECT Distinct A.SchId into #SchemeID FROM #SalesInvoiceSchemeLineWise A (NOLOCK) INNER JOIN #SchemeMaster B ON A.Schid = B.Schid 
		  
	SELECT  DISTINCT RSF.* INTO #ReturnSchemelinedt FROM ReturnHeader RH (NOLOCK)  
	INNER JOIN ReturnSchemelinedt RSF(NOLOCK) ON  RH.ReturnId = RSF.ReturnId  AND
	ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0 
	INNER JOIN #SchemeMaster C ON C.Schid = RSF.Schid
	INNER JOIN (SELECT DISTINCT Schid,Rtrid FROM SchemeRtrLevelValidation) S ON RH.RtrId = S.RtrId AND RSF.SchId = S.SchId AND S.SchId = C.SchId --ILCRSTPAR8062 
	
	IF @Pi_FromDate ='2020-07-01'
	BEGIN
		SELECT Schid INTO #SchDelete FROM SchemeMaster WHERE CmpSchCode IN ('SCH38527','SCH38528','SCH38529','SCH38530','SCH38531','SCH38532','SCH38533')

		DELETE A FROM #SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.Salid = B.salid
		INNER JOIN #SchDelete C ON A.SchId = C.SchId 				
		AND SalInvdate<'2020-08-01' 
		
		DELETE A FROM #ReturnSchemelinedt A INNER JOIN ReturnHeader B ON A.Returnid = B.Returnid
		INNER JOIN #SchDelete C ON A.SchId = C.SchId 				
		AND REturnDate<'2020-08-01' 				
	END
	
			
	SELECT DISTINCT Rtrid,RtrValueClassid INTO #RtrCnt FROM
	(
	SELECT DISTINCT RtrID,RtrValueClassId  FROM Salesinvoice A  INNER JOIN #SalesInvoiceSchemeLineWise B ON A.SalId = b.SalId
	WHERE SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND Dlvsts >3 
	UNION
	SELECT DISTINCT RtrID,RtrValueClassId  FROM REturnHeader A INNER JOIN #ReturnSchemelinedt B ON A.ReturnID = b.ReturnID 
	Where ReturnDate Between   @Pi_FromDate AND @Pi_Todate AND Status = 0
	)A
	SELECT 	A.CtgMainId,CtgLinkId As ChnId,RtrClassId as RtrValueClassId,Rtrid INTO #FilterRetailer FROM (
	SELECT DISTINCT D.CtgMainId,D.CtgLinkId,B.Rtrid
	FROM SalesInvoice A INNER JOIN insTargetDetailsTrans b on a.rtrid = b.RtrId 
	AND Salinvdate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.DlvSts > 3  
	inner join RetailerValueClass C ON A.RtrValueClassId = C.RtrClassId 
	INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 
	WHERE UserId = @Pi_UsrId and B.CtgName <>'' 
	UNION
	SELECT DISTINCT D.CtgMainId ,D.CtgLinkId,B.Rtrid
	FROM ReturnHeader  A INNER JOIN insTargetDetailsTrans b on a.rtrid = b.RtrId 
	AND ReturnDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND  Status = 0   
	inner join RetailerValueClass C ON A.RtrValueClassId = C.RtrClassId 
	INNER JOIN RetailerCategory D ON C.CtgMainId = D.CtgMainId 
	WHERE UserId = @Pi_UsrId and B.CtgName <>'' )A INNER JOIN RetailerValueClass B ON A.CtgMainId = B.CtgMainId 
		 
	SELECT Distinct CtgmainId,RtrId INTO #Rtr FROM (
	SELECT  CtgmainId,R.RtrId  FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN   @Pi_FromDate AND @Pi_Todate AND S.DlvSts > 3      
	AND   S.RtrValueClassId = R.RtrValueClassId AND R.Rtrid = S.RtrId 		  
	UNION ALL      
	SELECT   CtgmainId,F.Rtrid  FROM ReturnHeader R (NOLOCK),      
	#FilterRetailer F      
	WHERE R.ReturnDate BETWEEN   @Pi_FromDate AND @Pi_Todate AND R.Status = 0      
	AND  F.RtrValueClassId = R.RtrValueClassId    AND F.Rtrid = R.RtrId  
	)A  

	SELECT A.CtgMainId,Sum(Target) Target INTO #Target FROM InsTargetDetailsTrans A INNER JOIN #Rtr B ON A.RtrId = B.RtrId AND Userid = @Pi_UsrId 
	AND Ctgname <>'' AND A.CtgmainId=B.CtgMainId 
	GROUP BY A.CtgMainId
			  
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RtrValueClassId,CtgName,CtgCode    
	INTO #FilterRetailer1      
	FROM Retailer R (NOLOCK),      
	#RtrCnt RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId    
	
	
	 
	SELECT R.Rtrid,Schid,Prdid,CtgMainId,CtgName,CtgCode,CircularNo,SUM(ClmAmt) ClmAmt,CAST(0 AS NUMERIC(18,2))   CurMSales,
	CAST(0 AS NUMERIC(18,2))   L2MSales,0 Outlet ,CAST(0 AS NUMERIC(18,2))   MonTarget
	INTO #InstDiscount	
	FROM 
	(
	SELECT B.Rtrid,C.SchId,PrdId,CircularNo,SUM(DiscountPerAMount+FlatAmount) ClmAmt FROM #SalesInvoiceSchemeLineWise A 
	INNER JOIN Salesinvoice B ON A.SalId = B.SalId 
	INNER JOIN SchemeMaster C  ON C.Schid = A.Schid 
	INNER JOIN #Schemecirculardetails D ON C.CmpSchcode=D.CmpSchcode 
	INNER JOIN #FilterRetailer1 R ON B.RtrId = R.Rtrid AND B.RtrValueClassId = R.RtrValueClassId 
	GROUP BY B.RtrId ,CircularNo,C.SchId,PrdId
	UNION 
	SELECT RH.Rtrid,C.SchId,PrdId,CircularNo,-1*SUM(ReturnDiscountPerAmount+ReturnFlatAmount)ClmAmt  FROM #ReturnSchemelinedt RSF 
	INNER JOIN  ReturnHeader RH ON RH.ReturnId = RSF.ReturnId
	INNER JOIN SchemeMaster C  ON C.Schid = RSF.Schid 
	INNER JOIN #Schemecirculardetails D ON C.CmpSchcode=D.CmpSchcode 
	INNER JOIN #FilterRetailer1 R ON RH.RtrId = R.Rtrid AND RH.RtrValueClassId = R.RtrValueClassId 
	GROUP BY RH.RtrId,CircularNo ,C.SchId,PrdId
	)A INNER JOIN #FilterRetailer1 R ON A.RtrId = R.Rtrid
	GROUP BY R.Rtrid,Schid,Prdid,CtgMainId,CtgName,CtgCode ,CircularNo
	
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
	INTO #CurrentSales1      
	FROM       
	(      
	SELECT R.CtgMainId,SUM(PrdNetAmount) Sales FROM SalesInvoice S (NOLOCK)
	INNER JOIN 	SalesInvoiceProduct SIP ON S.SalId = SIP.SalId 
	INNER JOIN  #FilterRetailer1 R  ON S.SalInvDate BETWEEN @Pi_FromDate AND @Pi_Todate AND S.DlvSts > 3      
	AND S.RtrId = R.RtrId AND S.RtrValueClassId = R.RtrValueClassId 
	INNER JOIN (SELECT DISTINCT Salid FROM #SalesInvoiceSchemeLineWise) SI ON S.SalId = SI.SalId AND SI.SalId=SIP.SalId
	GROUP BY R.CtgMainId      
	UNION ALL      
	SELECT F.CtgMainId,-1 * SUM(PrdNetAmt) FROM ReturnHeader R (NOLOCK) 
	INNER JOIN   ReturnProduct RP ON  R.ReturnID = RP.ReturnID      
	INNER JOIN #FilterRetailer1 F ON ReturnDate BETWEEN @Pi_FromDate AND @Pi_Todate AND R.Status = 0      
	AND F.RtrId = R.RtrId   AND R.RtrValueClassId = R.RtrValueClassId  
	INNER JOIN (SELECT DISTINCT ReturnId FROM #ReturnSchemelinedt) SI ON R.ReturnId = SI.ReturnId  and RP.ReturnId = SI.ReturnId   
	GROUP BY F.CtgMainId      
	) AS S GROUP BY S.CtgMainId   
	
	
	SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet      
	INTO #NoOfOutlet1      
	FROM SalesInvoice S (NOLOCK),      
	#FilterRetailer1 R      
	WHERE S.SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND S.DlvSts > 3      
	AND S.RtrId = R.RtrId      
	GROUP BY R.CtgMainId  
		  
	--Last Two Month Sales      
	SELECT @InsToDate = DATEADD (D,-1,@Pi_FromDate)       
	SELECT @InsFromDate = DATEADD (MONTH,-2,@Pi_FromDate)
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
	INTO #L2MSales1      
	FROM       
	(      
		SELECT R.CtgMainId,SUM(PrdNetAmount) Sales FROM SalesInvoice S (NOLOCK) 
		INNER JOIN 	SalesInvoiceProduct SI ON S.SalId = SI.SalId 
		INNER JOIN #FilterRetailer1 R ON S.SalInvDate BETWEEN  @InsFromDate AND @InsToDate AND S.DlvSts > 3      
		AND S.RtrId = R.RtrId      
		GROUP BY R.CtgMainId      
		UNION ALL      
		SELECT F.CtgMainId,-1 * SUM(PrdNetAmt) FROM ReturnHeader R (NOLOCK)
		INNER JOIN  ReturnProduct RP    ON  R.ReturnID = RP.ReturnID  
		INNER JOIN #FilterRetailer1 F      
		ON R.ReturnDate BETWEEN  @InsFromDate AND @InsToDate AND R.Status = 0      
		AND F.RtrId = R.RtrId    
		GROUP BY F.CtgMainId      
	) AS S GROUP BY S.CtgMainId 
	
		  
	UPDATE I SET I.CurMSales = C.Sales FROM #InstDiscount I (NOLOCK), #CurrentSales1 C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId 
		 
	UPDATE I SET I.L2MSales = C.Sales / 2  FROM #InstDiscount I (NOLOCK),#L2MSales1 C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId      
	UPDATE I SET I.Outlet = C.Outlet FROM #InstDiscount I (NOLOCK),#NoOfOutlet1 C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId   
	--SELECT DISTINCT B.RtrCtgMainId CtgMainid,SUM(Target) Target INTO #InsTarget FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.InsId = B.InsId 
	--WHERE TargetYear = @Pi_Year AND TargetMonth = @Pi_Month and Status = 1 GROUP BY RtrCtgMainId
	UPDATE A SET MonTarget = Target FROM #InstDiscount A INNER JOIN #Target B ON A.CtgMainid = B.CtgMainid
			 
	INSERT INTO TempInsTargetClaimDetails
	SELECT CtgName,@Pi_FromDate,@Pi_Todate,CircularNO,MonTarget,L2MSales,CurMSales,Outlet ,SUM(ClmAmt) ClmAmt,@Pi_UsrId,@Pi_Transid,1 FROM #InstDiscount
	GROUP BY CtgName,CircularNO,L2MSales,CurMSales,Outlet,MonTarget

	INSERT INTO TempInstTargetClaim_PrdWise
	SELECT Rtrid,Schid,Prdid,CtgMainId,ClmAmt,@Pi_UsrId,@Pi_Transid FROM #InstDiscount
	--SELECT * FROM TempInsTargetClaimDetails
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetDistributorData' AND TYPE='Fn')
DROP FUNCTION Fn_GetDistributorData
GO
--SELECT DBO.Fn_GetDistributorData (1)
CREATE FUNCTION Fn_GetDistributorData (@Type INT)
RETURNS VARCHAR(100)
AS
/*********************************
* PROCEDURE		: Fn_GetDistributorData
* PURPOSE		: Get Distributor Status From Console And allow ETL
* CREATED		: S.MOHANA
* CREATED DATE	: 06-05-2020
* PMS NO		: PARCS202100011
*********************************************************************************/
BEGIN
DECLARE @Msg VARCHAR(100)

DECLARE @DistributorStatus TABLE
(
	Status VARCHAR(50),
	DownloadedDate DATETIME
) 


INSERT INTO @DistributorStatus
SELECT Status,DownloadedDate FROM DistributorStatus WHERE CreatedDate IN 
(SELECT  MAX(CreatedDate )FROM DistributorStatus )

SET @Msg =''

	IF @Msg  = '' 
	BEGIN
		IF NOT EXISTS (SELECT * FROM @DistributorStatus)
		BEGIN
			SET @Msg = 'Distributor Status Not downloaded.' + CHAR(13) +  'Hence ETL import Cannot happen for Salesman, Route and Retailer.'
		END
	END

	IF @Msg  = '' 
	BEGIN
		IF EXISTS (SELECT * FROM @DistributorStatus WHERE UPPER(Status) = 'NEW')
		BEGIN
			IF @Type = 1 
			BEGIN
				IF EXISTS (SELECT * FROM Salesman WHERE SMName NOT LIKE '%DUMMY%' AND SMName NOT LIKE '%Online Aggregator%' )
				BEGIN
					SET @Msg = 'Salesman Already available.' + CHAR(13) +  'Hence ETL import Blocked for Salesman Creation'
				END
			END

			IF @Type = 2 
			BEGIN
				IF EXISTS (SELECT * FROM RouteMaster  WHERE RMName NOT LIKE '%DUMMY%' AND RMName NOT LIKE '%Online Aggregator%')
				BEGIN
					SET @Msg = 'Route Already available.' + CHAR(13) +  'Hence ETL import Blocked For Route Creation'
				END
			END

			IF @Type = 3 
			BEGIN
				IF EXISTS (SELECT * FROM Retailer  WHERE RtrCode NOT LIKE '%DUMMY%' AND RtrCode NOT IN ('SWR001','ZMR001','DZD001') )
				BEGIN
					SET @Msg = 'Retailer Already available.' + CHAR(13) +  'Hence ETL import Blocked For Retailer Creation'
				END
			END
			
		END
	END

	IF @Msg  = '' 
	BEGIN
		IF EXISTS (SELECT * FROM @DistributorStatus WHERE UPPER(Status) = 'EXISTING')
		BEGIN
			 SET @Msg = 'Salesman,Route & Retailer Not allowed to Create for existing Distributor'
				 
		END
	END

RETURN @Msg
END
GO
IF EXISTS (SELECT * FROM SYS.foreign_keys   WHERE TYPE='F' AND NAME='FK_ContractPricingDetails_PrdId')
BEGIN
	ALTER TABLE [dbo].[ContractPricingDetails] DROP CONSTRAINT [FK_ContractPricingDetails_PrdId]
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='PROC_Validate_WS2CS_NewCustomerRequest' AND TYPE='P')
DROP PROCEDURE PROC_Validate_WS2CS_NewCustomerRequest
GO
/*
BEGIN TRAN
DELETE FROM PDA_NewRetailer
Exec PROC_Validate_WS2CS_NewCustomerRequest  0
SELECT * FROM Import_WS2CS_NewCustomerRequest
SELECT * FROM PDA_NewRetailer
SELECT * FROM PDAlog
ROLLBACK TRAN
*/
CREATE PROCEDURE PROC_Validate_WS2CS_NewCustomerRequest
(      
@SalRpCode varchar(50)      
)      
AS
/*******************************************************************************************
* PROCEDURE		: PROC_Validate_WS2CS_NewCustomerRequest
* PURPOSE		: To Validate and Insert New Customer details From PDA Intermediate Database
* CREATED		: Amuthakumar P
* CREATED DATE	: 28/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR			CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
28/08/2018   Amuthakumar P		CR			CRCRSTPAR0019		Parle SFA integration to Vxceed server(Phase 2&3)
05-04-2019   Lakshman M			BZ			ILCRSTPAR3989		while importing retailer from SFA to Core stocky retailer default Active status validation included. 
28-05-2020   MOHANA S			BZ			PARCS202100026		RETAILER CODE ISSUE FIX
22-06-2020   MOHANA S			BZ			UAT ISSUE			RETAILER CODE ISSUE FIX
11-08-2020	 MOHANA S			BZ			PARLECS/0820/081	RETAILER CODE ISSUE FIX
********************************************************************************************/     
DECLARE @CustomerCode AS varchar(200) 
DECLARE @CustomerName AS varchar(200)
DECLARE @CategoryCode1 AS varchar(100)
DECLARE @CategoryCode2 AS varchar(100)
DECLARE @lError AS int
DECLARE @CtgName AS nvarchar(200)
DECLARE @ValueClassName AS nvarchar(200)
DECLARE @RtrClassid int
DECLARE @CtgMainid int
DECLARE @CtgLinkid int 
DECLARE @CtgLevelId int
DECLARE @CtgLinkCode AS nvarchar(200)
DECLARE @CtgLevelName AS nvarchar(200)
DECLARE @Cmpid int 
DECLARE @CmpName AS nvarchar(200)
BEGIN      
 BEGIN TRANSACTION T1      
 DELETE FROM Import_WS2CS_NewCustomerRequest WHERE DownloadFlag='Y' 
 	DELETE FROM Import_WS2CS_NewCustomerRequest_Track WHERE CONVERT(VARCHAR(10),CreatedDate,121)<=DATEADD(M,-3,CONVERT(VARCHAR(10),GETDATE(),121))
	INSERT INTO Import_WS2CS_NewCustomerRequest_Track(RequestID,TenantCode,LocationCode,RouteCode,SalesmanCode,PostingDate,CustomerName,Address1,
			 Address2,Address3,City,State,Zip,Phone,Fax,Email,ContactPerson,Notes,GeoCodeX,GeoCodeY,CategoryCode1,CategoryCode2,CategoryCode3,
			 HierarchyCode,DateofBirth,IDNumber,DocumentType,DocumentPrefix,DocumentNumber,DownloadFlag,CreatedDate)
	SELECT RequestID,TenantCode,LocationCode,RouteCode,SalesmanCode,PostingDate,CustomerName,Address1,Address2,Address3,City,State,Zip,Phone,Fax,
			 Email,ContactPerson,Notes,GeoCodeX,GeoCodeY,CategoryCode1,CategoryCode2,CategoryCode3,HierarchyCode,DateofBirth,IDNumber,DocumentType,
			 DocumentPrefix,DocumentNumber,DownloadFlag,CreatedDate
	FROM Import_WS2CS_NewCustomerRequest
	WHERE downloadflag='N'
	
	UPDATE Import_WS2CS_NewCustomerRequest SET DOWNLOADFLAG='D' WHERE DOWNLOADFLAG='N'
	
	SELECT CustomerName,MAX(CREATEDDATE)CREATEDDATE INTO #MAXDATE FROM Import_WS2CS_NewCustomerRequest GROUP BY CustomerName
	
	CREATE TABLE #Import_WS2CS_NewCustomerRequest 
	(
	CustomerCode	NVARCHAR(100),
	CustomerName	NVARCHAR(100),
	CategoryCode1	NVARCHAR(100),
	CategoryCode2	NVARCHAR(100),
	CreatedDate		DATETIME
	)
	
	--Included to avoid Duplicate cus Code
	DECLARE @Id INT

	--DECLARE @Id Varchar(0)
	--SELECT @Id = ISNULL(MAX(Customercode),0) FROM PDA_NewRetailer where CustomerCode not like 'SM%'   --PARLECS/0820/081

	SELECT  @Id = ISNULL(Count(*),0) FROM PDA_NewRetailer     --PARLECS/0820/081	 
	 
	SELECT DISTINCT    DENSE_RANK() OVER (		ORDER BY A.CustomerName	) 
	  CustomerCode , A.CustomerName,CategoryCode1,CategoryCode2,A.CreatedDate 
	INTO #NewRtrCode 
	FROM Import_WS2CS_NewCustomerRequest A INNER JOIN #MAXDATE B ON A.CustomerName = B.CustomerName AND A.CreatedDate =  B.CREATEDDATE
	WHERE DownloadFlag='D' AND DocumentPrefix  =''

	UPDATE #NewRtrCode SET CustomerCode = CustomerCode+@Id

	INSERT INTO #Import_WS2CS_NewCustomerRequest
	SELECT CAST (CustomerCode as varchar(50)) ,CustomerName ,CategoryCode1,CategoryCode2,CreatedDate  FROM #NewRtrCode  
	UNION ALL
	SELECT DISTINCT  (DocumentPrefix+CAST(DocumentNumber AS VARCHAR(50))) CustomerCode , A.CustomerName,CategoryCode1,CategoryCode2,A.CreatedDate 
	--INTO #Import_WS2CS_NewCustomerRequest 
	FROM Import_WS2CS_NewCustomerRequest A INNER JOIN #MAXDATE B ON A.CustomerName = B.CustomerName AND A.CreatedDate =  B.CREATEDDATE
	WHERE DownloadFlag='D' AND DocumentPrefix  <>''

 
	
 DECLARE CUR_ImportRetailer Cursor For  
 --SELECT DISTINCT '' CustomerCode, CustomerName,CategoryCode1,CategoryCode2 
	--	From Import_WS2CS_NewCustomerRequest WHERE DownloadFlag='D'   
	 SELECT DISTINCT CustomerCode, CustomerName,CategoryCode1,CategoryCode2 
		From #Import_WS2CS_NewCustomerRequest   
 OPEN CUR_ImportRetailer      
 FETCH NEXT FROM CUR_ImportRetailer INTO  @CustomerCode,@CustomerName,@CategoryCode1,@CategoryCode2
 While @@Fetch_Status = 0      
 BEGIN      
  SET @lError = 0
    	
  IF NOT EXISTS (SELECT RtrName FROM Retailer WHERE RtrName = @CustomerName )      
   BEGIN   
		--IF NOT EXISTS(SELECT * FROM RetailerCategory WHERE CtgCode=@CategoryCode1)
		--BEGIN
		--	SET @lError = 1      
		--	INSERT INTO PDALog(SrpCde,DataPoint,[Name],Description)      
		--	SELECT '' + @CategoryCode1 + '','New Retailer',@CustomerName,'Reatailer Category1 does not exists'  
		--END
		--IF NOT EXISTS(SELECT * FROM RetailerValueClass WHERE ValueClassCode=@CategoryCode2)
		--BEGIN
		--	SET @lError = 1      
		--	INSERT INTO PDALog(SrpCde,DataPoint,[Name],Description)      
		--	SELECT '' + @CategoryCode2 + '','New Retailer',@CustomerName,'Reatailer Category2 does not exists'  
		--END
	IF @lError=0 
	 BEGIN
		Select @RtrClassid=A.RtrClassId,
			   @ValueClassName=A.ValueClassName,
			   @CtgMainid=B.CtgMainId,
			   @CtgLinkid=B.CtgLinkId,
			   @CtgLevelId=B.CtgLevelId,
			   @CtgLinkCode=B.CtgLinkCode,
			   @CtgName=B.CtgName,
			   @CtgLevelName=C.CtgLevelName,
			   @Cmpid=C.CmpId,
			   @CmpName=D.CmpName 
			FROM RetailerValueClass A,RetailerCategory B,RetailerCategoryLevel C,Company D 
			WHERE A.CtgMainId=B.CtgMainId And B.CtgLevelId=C.CtgLevelId And C.CmpId=D.CmpId
			AND CtgCode=@CategoryCode1 AND a.ValueClassCode=@CategoryCode2
	 
	 END 		
	IF @lError=0 
		BEGIN
		  IF NOT EXISTS (SELECT * FROM PDA_NewRetailer WHERE CustomerName=@CustomerName)
			   BEGIN 
					INSERT INTO PDA_NewRetailer(CustomerCode,CustomerName,Address1,Address2,Address3,City,State,Zip,Phone,Fax,Email,
					RtrTINNo,ContactPerson,Notes,CustomerStatus,CtgCode,CtgName,ValueClassCode,ValueClassName,RtrClassid,CtgMainid,
					CtgLinkid,CtgLevelId,CtgLinkCode,CtgLevelName,Cmpid,CmpName,CrBills,RtrTaxable,RouteId,GeoMainId,GeoLevelName,
					GeoLevel,Longitude,Latitude,RtrMobileNo,DateOfBirth,PDAFlag) 
					SELECT  CustomerCode,A.CustomerName,isnull(Address1,'')Address1,isnull(Address2,'')Address2,
					isnull(Address3,'')Address3,isnull(City,'')City,isnull(State,'')State,isnull(Zip,'')Zip,isnull(Phone,'')Phone,isnull(Fax,'')Fax,isnull(Email,'')Email,
					'' RtrTINNo,isnull(ContactPerson,'')ContactPerson,isnull(Notes,'')Notes,'1' AS CustomerStatus, ----------- Added by lakshman M Dated ON 05-04-2019 PMS ID: ILCRSTPAR3989
					isnull(A.CategoryCode1,'')CategoryCode1,isnull(@CtgName,''),isnull(A.CategoryCode2,'')CategoryCode2,isnull(@ValueClassName,''),
					ISNULL(@RtrClassid,0),ISNULL(@CtgMainid,0),ISNULL(@CtgLinkid,0),ISNULL(@CtgLevelId,0),ISNULL(@CtgLinkCode,''),ISNULL(@CtgLevelName,''),
					ISNULL(@Cmpid,0),ISNULL(@CmpName,''),0,'' RtrTaxable,0,0,'' GeoLevelName,
					'' GeoLevel,isnull(GeoCodeX,'')GeoCodeX,isnull(GeoCodeY,'')GeoCodeY,''RtrMobileNo,ISNULL(CONVERT(VARCHAR(10),DateOfBirth,121),'') DateOfBirth,'WS' PDAFlag
					FROM Import_WS2CS_NewCustomerRequest A INNER JOIN #Import_WS2CS_NewCustomerRequest B ON A.CustomerName=B.CustomerName 
					AND A.CREATEDDATE = B.CREATEDDATE
					WHERE A.CustomerName=@CustomerName
			   END 	
				UPDATE Import_WS2CS_NewCustomerRequest SET DownloadFlag='Y' WHERE CustomerName=@CustomerName
		 END 
	 END      
  ELSE      
    BEGIN      
	   INSERT INTO PDALog(SrpCde,DataPoint,[Name],Description)      
	   SELECT '' + @CustomerCode + '','New Retailer',@CustomerName,'Retailer Code Already exists'      
    END       
FETCH NEXT FROM CUR_ImportRetailer INTO @CustomerCode,@CustomerName,@CategoryCode1,@CategoryCode2
END      
CLOSE CUR_ImportRetailer      
DEALLOCATE CUR_ImportRetailer     
 IF @@ERROR = 0      
 BEGIN      
	COMMIT TRANSACTION T1      
 END      
 ELSE      
 BEGIN      
	ROLLBACK TRANSACTION T1      
 END      
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptBTBillTemplate' AND TYPE='P')
DROP PROCEDURE Proc_RptBTBillTemplate
GO
--select * from Rptbilltemplatefinal
--Exec Proc_RptBTBillTemplate 1,1,2
CREATE PROCEDURE Proc_RptBTBillTemplate
(
	@Pi_UsrId Int = 1,
	@Pi_Type INT,
	@Pi_InvDC INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptBTBillTemplate
* PURPOSE		: To Get the Bill Details 
* CREATED		: Nandakumar R.G
* CREATED DATE	: 29/03/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* UserId and Distinct added to avoid doubling value in Bill Print. by Boopathy and Shyam on 24-08-2011
* optimize the bill print generation by Boopathy on 02-11-2011
* 08-08-2020	MOHANA S	 PARLESECS/0820/034  BZ		DUE TO CP LOGIC CHANGES IN BILLING, THE ORIGINAL AMOUNT SHOWING IN BILL PRINT
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @FROMBillId AS  VARCHAR(25)
	DECLARE @ToBillId   AS  VARCHAR(25)
	DECLARE @Cnt AS INT
	--->Added By Nanda on 2011/09/19
	DECLARE @FromDate	AS DATETIME
	DECLARE @ToDate		AS DATETIME
	SELECT @FromDate=FilterDate FROM ReportFilterDt (NOLOCK) WHERE SelId=10 AND UsrId=@Pi_UsrId AND RptId=16
	SELECT @ToDate=FilterDate FROM ReportFilterDt (NOLOCK) WHERE SelId=11 AND UsrId=@Pi_UsrId AND RptId=16
	--->Till Here
	DECLARE @TempSalId TABLE
	(
		SalId	INT,
		UsrId	INT
	)
	DECLARE  @RptBillTemplate Table
	(
		[Base Qty] numeric(38,0),
		[Batch Code] nvarchar(50),
		[Batch Expiry Date] datetime,
		[Batch Manufacturing Date] datetime,
		[Batch MRP] numeric(38,2),
		[Batch Selling Rate] numeric(38,2),
		[Bill Date] datetime,
		[Bill Doc Ref. Number] nvarchar(50),
		[Bill Mode] tinyint,
		[Bill Type] tinyint,
		[CD Disc Base Qty Amount] numeric(38,2),
		[CD Disc Effect Amount] numeric(38,2),
		[CD Disc Header Amount] numeric(38,2),
		[CD Disc LineUnit Amount] numeric(38,2),
		[CD Disc Qty Percentage] numeric(38,2),
		[CD Disc Unit Percentage] numeric(38,2),
		[CD Disc UOM Amount] numeric(38,2),
		[CD Disc UOM Percentage] numeric(38,2),
		[Company Address1] nvarchar(50),
		[Company Address2] nvarchar(50),
		[Company Address3] nvarchar(50),
		[Company Code] nvarchar(20),
		[Company Contact Person] nvarchar(100),
		[Company EmailId] nvarchar(50),
		[Company Fax Number] nvarchar(50),
		[Company Name] nvarchar(100),
		[Company Phone Number] nvarchar(50),
		[Contact Person] nvarchar(50),
		[CST Number] nvarchar(50),
		[DB Disc Base Qty Amount] numeric(38,2),
		[DB Disc Effect Amount] numeric(38,2),
		[DB Disc Header Amount] numeric(38,2),
		[DB Disc LineUnit Amount] numeric(38,2),
		[DB Disc Qty Percentage] numeric(38,2),
		[DB Disc Unit Percentage] numeric(38,2),
		[DB Disc UOM Amount] numeric(38,2),
		[DB Disc UOM Percentage] numeric(38,2),
		[DC DATE] DATETIME,
		[DC NUMBER] nvarchar(100),
		[Delivery Boy] nvarchar(50),
		[Delivery Date] datetime,
		[Deposit Amount] numeric(38,2),
		[Distributor Address1] nvarchar(50),
		[Distributor Address2] nvarchar(50),
		[Distributor Address3] nvarchar(50),
		[Distributor Code] nvarchar(20),
		[Distributor Name] nvarchar(50),
		[Drug Batch Description] nvarchar(50),
		[Drug Licence Number 1] nvarchar(50),
		[Drug Licence Number 2] nvarchar(50),
		[Drug1 Expiry Date] DateTime,
		[Drug2 Expiry Date] DateTime,
		[EAN Code] varchar(50),
		[EmailID] nvarchar(50),
		[Geo Level] nvarchar(50),
		[Interim Sales] tinyint,
		[Licence Number] nvarchar(50),
		[Line Base Qty Amount] numeric(38,2),
		[Line Base Qty Percentage] numeric(38,2),
		[Line Effect Amount] numeric(38,2),
		[Line Unit Amount] numeric(38,2),
		[Line Unit Percentage] numeric(38,2),
		[Line UOM1 Amount] numeric(38,2),
		[Line UOM1 Percentage] numeric(38,2),
		[LST Number] nvarchar(50),
		[Manual Free Qty] int,
		[Order Date] datetime,
		[Order Number] nvarchar(50),
		[Pesticide Expiry Date] DateTime,
		[Pesticide Licence Number] nvarchar(50),
		[PhoneNo] nvarchar(50),
		[PinCode] int,
		[Product Code] nvarchar(50),
		[Product Name] nvarchar(200),
		[Product Short Name] nvarchar(100),
		[Product SL No] Int,
		[Product Type] int,
		[Remarks] nvarchar(200),
		[Retailer Address1] nvarchar(100),
		[Retailer Address2] nvarchar(100),
		[Retailer Address3] nvarchar(100),
		[Retailer Code] nvarchar(50),
		[Retailer ContactPerson] nvarchar(100),
		[Retailer Coverage Mode] tinyint,
		[Retailer Credit Bills] int,
		[Retailer Credit Days] int,
		[Retailer Credit Limit] numeric(38,2),
		[Retailer CSTNo] nvarchar(50),
		[Retailer Deposit Amount] numeric(38,2),
		[Retailer Drug ExpiryDate] datetime,
		[Retailer Drug License No] nvarchar(50),
		[Retailer EmailId] nvarchar(100),
		[Retailer GeoLevel] nvarchar(50),
		[Retailer License ExpiryDate] datetime,
		[Retailer License No] nvarchar(50),
		[Retailer Name] nvarchar(150),
		[Retailer OffPhone1] nvarchar(50),
		[Retailer OffPhone2] nvarchar(50),
		[Retailer OnAccount] numeric(38,2),
		[Retailer Pestcide ExpiryDate] datetime,
		[Retailer Pestcide LicNo] nvarchar(50),
		[Retailer PhoneNo] nvarchar(50),
		[Retailer Pin Code] nvarchar(50),
		[Retailer ResPhone1] nvarchar(50),
		[Retailer ResPhone2] nvarchar(50),
		[Retailer Ship Address1] nvarchar(100),
		[Retailer Ship Address2] nvarchar(100),
		[Retailer Ship Address3] nvarchar(100),
		[Retailer ShipId] int,
		[Retailer TaxType] tinyint,
		[Retailer TINNo] nvarchar(50),
		[Retailer Village] nvarchar(100),
		[Route Code] nvarchar(50),
		[Route Name] nvarchar(50),
		[Sales Invoice Number] nvarchar(50),
		[SalesInvoice ActNetRateAmount] numeric(38,2),
		[SalesInvoice CDPer] numeric(9,6),
		[SalesInvoice CRAdjAmount] numeric(38,2),
		[SalesInvoice DBAdjAmount] numeric(38,2),
		[SalesInvoice GrossAmount] numeric(38,2),
		[SalesInvoice Line Gross Amount] numeric(38,2),
		[SalesInvoice Line Net Amount] numeric(38,2),
		[SalesInvoice MarketRetAmount] numeric(38,2),
		[SalesInvoice NetAmount] numeric(38,2),
		[SalesInvoice NetRateDiffAmount] numeric(38,2),
		[SalesInvoice OnAccountAmount] numeric(38,2),
		[SalesInvoice OtherCharges] numeric(38,2),
		[SalesInvoice RateDiffAmount] numeric(38,2),
		[SalesInvoice ReplacementDiffAmount] numeric(38,2),
		[SalesInvoice RoundOffAmt] numeric(38,2),
		[SalesInvoice TotalAddition] numeric(38,2),
		[SalesInvoice TotalDeduction] numeric(38,2),
		[SalesInvoice WindowDisplayAmount] numeric(38,2),
		[SalesMan Code] nvarchar(50),
		[SalesMan Name] nvarchar(50),
		[SalId] int,
		[Sch Disc Base Qty Amount] numeric(38,2),
		[Sch Disc Effect Amount] numeric(38,2),
		[Sch Disc Header Amount] numeric(38,2),
		[Sch Disc LineUnit Amount] numeric(38,2),
		[Sch Disc Qty Percentage] numeric(38,2),
		[Sch Disc Unit Percentage] numeric(38,2),
		[Sch Disc UOM Amount] numeric(38,2),
		[Sch Disc UOM Percentage] numeric(38,2),
		[Scheme Points] numeric(38,2),
		[Spl. Disc Base Qty Amount] numeric(38,2),
		[Spl. Disc Effect Amount] numeric(38,2),
		[Spl. Disc Header Amount] numeric(38,2),
		[Spl. Disc LineUnit Amount] numeric(38,2),
		[Spl. Disc Qty Percentage] numeric(38,2),
		[Spl. Disc Unit Percentage] numeric(38,2),
		[Spl. Disc UOM Amount] numeric(38,2),
		[Spl. Disc UOM Percentage] numeric(38,2),
		[Tax 1] numeric(38,2),
		[Tax 2] numeric(38,2),
		[Tax 3] numeric(38,2),
		[Tax 4] numeric(38,2),
		[Tax Amount1] numeric(38,2),
		[Tax Amount2] numeric(38,2),
		[Tax Amount3] numeric(38,2),
		[Tax Amount4] numeric(38,2),
		[Tax Amt Base Qty Amount] numeric(38,2),
		[Tax Amt Effect Amount] numeric(38,2),
		[Tax Amt Header Amount] numeric(38,2),
		[Tax Amt LineUnit Amount] numeric(38,2),
		[Tax Amt Qty Percentage] numeric(38,2),
		[Tax Amt Unit Percentage] numeric(38,2),
		[Tax Amt UOM Amount] numeric(38,2),
		[Tax Amt UOM Percentage] numeric(38,2),
		[Tax Type] tinyint,
		[TIN Number] nvarchar(50),
		[Uom 1 Desc] nvarchar(50),
		[Uom 1 Qty] int,
		[Uom 2 Desc] nvarchar(50),
		[Uom 2 Qty] int,
		[Vehicle Name] nvarchar(50),
		UsrId int,
		Visibility tinyint,
		[Distributor Product Code] nvarchar(50),
		[Allotment No] nvarchar(50),
		[Bx Selling Rate] numeric(18,2)
	)
	IF EXISTS (SELECT * FROM dbo.SysObjects WHERE Id = Object_Id(N'[RptBillTemplate]') AND OBJECTPROPERTY(Id, N'IsUserTable') = 1)
	DROP TABLE [RptBillTemplate]
	DELETE FROM RptSELECTedBills WHERE UsrId=@Pi_UsrId
	IF @Pi_Type=1
	BEGIN
		--->Modified By Nanda on 2011/09/19
		INSERT INTO @TempSalId
		/* Added Distinct Shyam-Boopathy 24082011 16:*/
		--SELECT Distinct SelValue,UsrId FROM ReportFilterDt WHERE RptId = 16 AND SelId = 34 AND UsrId=@Pi_UsrId
		SELECT DISTINCT R.SelValue,UsrId FROM ReportFilterDt R (NOLOCK),SalesInvoice SI (NOLOCK)
		WHERE RptId = 16 AND SelId = 34  AND UsrId=@Pi_UsrId AND R.SelValue=Si.SalId AND SI.SalInvDate BETWEEN @FromDate AND @ToDate
		--->Till Here
		INSERT INTO RptSELECTedBills
		SELECT SalId,UsrId FROM @TempSalId
	END
	ELSE
	BEGIN
		IF @Pi_InvDC=1
		BEGIN
			DECLARE @FROMId INT
			DECLARE @ToId INT
			DECLARE @FROMSeq INT
			DECLARE @ToSeq INT
			SELECT @FROMId=SelValue FROM ReportFilterDt (NOLOCK) WHERE RptId=16 AND SelId=14 AND UsrId=@Pi_UsrId
			SELECT @ToId=SelValue FROM ReportFilterDt (NOLOCK) WHERE RptId=16 AND SelId=15 AND UsrId=@Pi_UsrId
			SELECT @FROMSeq=SeqNo FROM SalInvoiceDeliveryChallan (NOLOCK) WHERE SalId=@FROMId
			SELECT @ToSeq=SeqNo FROM SalInvoiceDeliveryChallan (NOLOCK) WHERE SalId=@ToId
			
			INSERT INTO RptSELECTedBills
/* Added Distinct Shyam-Boopathy 24082011 16:*/
			SELECT Distinct SalId,@Pi_UsrId FROM SalInvoiceDeliveryChallan (NOLOCK) WHERE SeqNo BETWEEN @FROMSeq AND @ToSeq
		END
		ELSE
		BEGIN
			SELECT @FROMBillId=SelValue FROM ReportFilterDt (NOLOCK) WHERE RptId = 16 AND SelId = 14 AND UsrId=@Pi_UsrId
			SELECT @ToBillId=SelValue FROM ReportFilterDt (NOLOCK) WHERE RptId = 16 AND SelId = 15 AND UsrId=@Pi_UsrId
			INSERT INTO RptSELECTedBills
/* Added Distinct Shyam-Boopathy 24082011 16:*/
			SELECT Distinct SalId,@Pi_UsrId FROM SalesINvoice (NOLOCK) WHERE SalId BETWEEN @FROMBillId AND @ToBillId
		END
	END
	
	IF @Pi_Type=1
	BEGIN
		INSERT INTO @RptBillTemplate
		SELECT DISTINCT BaseQty,PrdBatCode,ExpDate,MnfDate,MRP,[Selling Rate],SalInvDate,SalInvRef,BillMode,BillType,
		[CD Disc_Amount_Dt],[CD Disc_EffectAmt_Dt],[CD Disc_HD],[CD Disc_UnitAmt_Dt],[CD Disc_QtyPerc_Dt],[CD Disc_UnitPerc_Dt],[CD Disc_UomAmt_Dt],
		[CD Disc_UomPerc_Dt],Address1,Address2,Address3,CmpCode,ContactPerson,EmailId,FaxNumber,CmpName,PhoneNumber,D_ContactPerson,CSTNo,
		[DB Disc_Amount_Dt],[DB Disc_EffectAmt_Dt],[DB Disc_HD],[DB Disc_UnitAmt_Dt],[DB Disc_QtyPerc_Dt],[DB Disc_UnitPerc_Dt],[DB Disc_UomAmt_Dt],
		[DB Disc_UomPerc_Dt],DCDate,DCNo,DlvBoyName,SalDlvDate,DepositAmt,DistributorAdd1,DistributorAdd2,DistributorAdd3,DistributorCode,
		DistributorName,DrugBatchDesc,DrugLicNo1,DrugLicNo2,Drug1ExpiryDate,Drug2ExpiryDate,EANCode,D_EmailID,D_GeoLevelName,InterimSales,LicNo,
		LineBaseQtyAmount,LineBaseQtyPerc,LineEffectAmount,LineUnitamount,LineUnitPerc,LineUom1Amount,LineUom1Perc,LSTNo,SalManFreeQty,OrderDate,
		OrderKeyNo,PestExpiryDate,PestLicNo,PhoneNo,PinCode,PrdCCode,PrdName,PrdShrtName,SLNo,PrdType,Remarks,RtrAdd1,RtrAdd2,RtrAdd3,RtrCode,
		RtrContactPerson,RtrCovMode,RtrCrBills,RtrCrDays,RtrCrLimit,RtrCSTNo,RtrDepositAmt,RtrDrugExpiryDate,RtrDrugLicNo,RtrEmailId,
		GeoLevelName,RtrLicExpiryDate,RtrLicNo,RtrName,RtrOffPhone1,RtrOffPhone2,RtrOnAcc,RtrPestExpiryDate,RtrPestLicNo,RtrPhoneNo,RtrPinNo,
		RtrResPhone1,RtrResPhone2,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipId,RtrTaxType,RtrTINNo,VillageName,RMCode,RMName,SalInvNo,
		SalActNetRateAmount,SalCDPer,CRAdjAmount,DBAdjAmount,SalGrossAmount,PrdGrossAmountAftEdit,PrdNetAmount,MarketRetAmount,SalNetAmt,
		SalNetRateDiffAmount,OnAccountAmount,OtherCharges,SalRateDiffAmount,ReplacementDiffAmount,SalRoundOffAmt,TotalAddition,TotalDeduction,
		WindowDisplayamount,SMCode,SMName,SalId,[Sch Disc_Amount_Dt],[Sch Disc_EffectAmt_Dt],[Sch Disc_HD],[Sch Disc_UnitAmt_Dt],[Sch Disc_QtyPerc_Dt],
		[Sch Disc_UnitPerc_Dt],[Sch Disc_UomAmt_Dt],[Sch Disc_UomPerc_Dt],Points,[Spl. Disc_Amount_Dt],[Spl. Disc_EffectAmt_Dt],[Spl. Disc_HD],
		[Spl. Disc_UnitAmt_Dt],[Spl. Disc_QtyPerc_Dt],[Spl. Disc_UnitPerc_Dt],[Spl. Disc_UomAmt_Dt],[Spl. Disc_UomPerc_Dt],
		Tax1Perc,Tax2Perc,Tax3Perc,Tax4Perc,Tax1Amount,Tax2Amount,Tax3Amount,Tax4Amount,[Tax Amt_Amount_Dt],[Tax Amt_EffectAmt_Dt],[Tax Amt_HD],
		[Tax Amt_UnitAmt_Dt],[Tax Amt_QtyPerc_Dt],[Tax Amt_UnitPerc_Dt],[Tax Amt_UomAmt_Dt],[Tax Amt_UomPerc_Dt],TaxType,TINNo,
		Uom1Id,Uom1Qty,Uom2Id,Uom2Qty,VehicleCode,@Pi_UsrId,1 Visibility,PrdDcode,'',0
		FROM
		(
			SELECT DisDt.*,RepAll.*
			FROM
			(
				SELECT D.DistributorCode,D.DistributorName,D.DistributorAdd1,D.DistributorAdd2,D.DistributorAdd3, D.PinCode,D.PhoneNo,
				D.ContactPerson D_ContactPerson,D.EmailID D_EmailID,D.TaxType,D.TINNo,D.DepositAmt,GL.GeoLevelName D_GeoLevelName,
				D.CSTNo,D.LSTNo,D.LicNo,D.DrugLicNo1,D.Drug1ExpiryDate,D.DrugLicNo2,D.Drug2ExpiryDate,D.PestLicNo , D.PestExpiryDate
				FROM Distributor D WITH (NOLOCK)
				LEFT OUTER JOIN Geography G WITH (NOLOCK) ON D.GeoMainId = G.GeoMainId
				LEFT OUTER JOIN GeographyLevel GL WITH (NOLOCK) ON G.GeoLevelId = GL.GeoLevelId
			) DisDt ,
			(
				SELECT RepHD.*,RepDt.* FROM
				(
					SELECT SalesInv.* , RtrDt.*, HDAmt.* FROM
					(
						SELECT SI.SalId SalIdHD,SalInvNo,SalInvDate,SalDlvDate,SalInvRef,SM.SMID,SM.SMCode,SDC.DCDATE,SDC.DCNO,SM.SMName,
						RM.RMID,RM.RMCode,RM.RMName,RtrId,InterimSales,OrderKeyNo,OrderDate,billtype,billmode,remarks,SalGrossAmount,
						SalRateDiffAmount,SalCDPer,DBAdjAmount,CRAdjAmount,Marketretamount,OtherCharges,Windowdisplayamount,onaccountamount,
						Replacementdiffamount,TotalAddition,TotalDeduction,SalActNetRateAmount,SalNetRateDiffAmount,SalNetAmt,
						SalRoundOffAmt,V.VehicleId,V.VehicleCode,D.DlvBoyId , D.DlvBoyName FROM SalesInvoice SI WITH (NOLOCK)
						LEFT OUTER JOIN SalInvoiceDeliveryChallan SDC ON SI.SALID=SDC.SALID
						LEFT OUTER JOIN Salesman SM WITH (NOLOCK) ON SI.SMId = SM.SMId
						LEFT OUTER JOIN RouteMaster RM WITH (NOLOCK) ON SI.RMId = RM.RMId
						LEFT OUTER JOIN Vehicle V WITH (NOLOCK) ON SI.VehicleId = V.VehicleId
						LEFT OUTER JOIN DeliveryBoy D WITH (NOLOCK) ON SI.DlvBoyId = D.DlvBoyId
						WHERE SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
					) SalesInv
					LEFT OUTER JOIN
					(
						SELECT R.RtrId RtrId1,R.RtrCode,R.RtrName,R.RtrAdd1,R.RtrAdd2,R.RtrAdd3,R.RtrPinNo,R.RtrPhoneNo,
						R.RtrEmailId,R.RtrContactPerson,R.RtrCovMode,R.RtrTaxType,R.RtrTINNo,R.RtrCSTNo,R.RtrDepositAmt,R.RtrCrBills,
						R.RtrCrLimit,R.RtrCrDays,R.RtrLicNo,R.RtrLicExpiryDate,R.RtrDrugLicNo,R.RtrDrugExpiryDate,R.RtrPestLicNo,R.RtrPestExpiryDate,
						GL.GeoLevelName,RV.VillageName,R.RtrShipId,RS.RtrShipAdd1,RS.RtrShipAdd2,RS.RtrShipAdd3,R.RtrResPhone1,
						R.RtrResPhone2 , R.RtrOffPhone1, R.RtrOffPhone2, R.RtrOnAcc FROM Retailer R WITH (NOLOCK)
						INNER JOIN  SalesInvoice SI WITH (NOLOCK) ON R.RtrId=SI.RtrId
						LEFT OUTER JOIN RouteVillage RV WITH (NOLOCK) ON R.VillageId = RV.VillageId
						LEFT OUTER JOIN RetailerShipAdd RS WITH (NOLOCK) ON R.RtrShipId = RS.RtrShipId,
						Geography G WITH (NOLOCK),
						GeographyLevel GL WITH (NOLOCK) WHERE R.GeoMainId = G.GeoMainId
						AND G.GeoLevelId = GL.GeoLevelId AND SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
					) RtrDt ON SalesInv.RtrId = RtrDt.RtrId1
					LEFT OUTER JOIN
					(
						SELECT SI.SalId,  ISNULL(D.Amount,0) AS [Spl. Disc_HD], ISNULL(E.Amount,0) AS [Sch Disc_HD], ISNULL(F.Amount,0) AS [DB Disc_HD],
						ISNULL(G.Amount,0) AS [CD Disc_HD], ISNULL(H.Amount,0) AS [Tax Amt_HD]
						FROM SalesInvoice SI
						INNER JOIN (SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='D') D ON SI.SalId = D.SalId
						INNER JOIN (SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='E') E ON SI.SalId = E.SalId
						INNER JOIN (SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='F') F ON SI.SalId = F.SalId
						INNER JOIN (SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='G') G ON SI.SalId = G.SalId
						INNER JOIN (SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='H') H ON SI.SalId = H.SalId
						WHERE SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
					)HDAmt ON SalesInv.SalIdHD = HDAmt.SalId
				) RepHD
				LEFT OUTER JOIN
				(
					SELECT SalesInvPrd.*,LiAmt.*,LNUOM.*,BATPRC.MRP,BATPRC.[Selling Rate]
					FROM
					(
						SELECT SPR.*,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,C.EmailId,C.ContactPerson
						FROM
						(
							SELECT SIP.PrdGrossAmountAftEdit,SIP.PrdNetAmount,SIP.SalId SalIdDt,SIP.SlNo,SIP.PrdId,P.PrdCCode,PrdDcode,P.PrdName,P.PrdShrtName,
							P.CmpId,P.PrdType,SIP.PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,P.EANCode,
							U1.UomDescription Uom1Id,SIP.Uom1Qty,U2.UomDescription Uom2Id,SIP.Uom2Qty,SIP.BaseQty,
							SIP.DrugBatchDesc,SIP.SalManFreeQty,ISNULL(SPO.Points,0) Points,SIP.PriceId,BPT.Tax1Perc,BPT.Tax2Perc,BPT.Tax3Perc,
							BPT.Tax4Perc,BPT.Tax5Perc,BPT.Tax1Amount,BPT.Tax2Amount,BPT.Tax3Amount,BPT.Tax4Amount,BPT.Tax5Amount
							FROM SalesInvoiceProduct SIP WITH (NOLOCK)
							LEFT OUTER JOIN BillPrintTaxTemp BPT WITH (NOLOCK) ON SIP.SalId=BPT.SalID AND SIP.PrdId=BPT.PrdId AND SIP.PrdBatId=BPT.PrdBatId AND BPT.UsrId=@Pi_UsrId
							INNER JOIN  SalesInvoice SI WITH (NOLOCK) ON SIP.SalId=SI.SalId
							INNER JOIN Product P WITH (NOLOCK) ON SIP.PRdID = P.PrdId INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.PrdBatId = PB.PrdBatId
							INNER JOIN UomMaster U1 WITH (NOLOCK) ON SIP.Uom1Id = U1.UomId
							LEFT OUTER JOIN UomMaster U2 WITH (NOLOCK) ON SIP.Uom2Id = U2.UomId
							LEFT OUTER JOIN
							(
								SELECT LW.SalId,LW.RowId,LW.SchId,LW.slabId,LW.PrdId, LW.PrdBatId, PO.Points
								FROM SalesInvoiceSchemeLineWise LW WITH (NOLOCK)
								LEFT OUTER JOIN SalesInvoiceSchemeDtpoints PO WITH (NOLOCK) ON LW.SalId = PO.SalId AND LW.SchId = PO.SchId AND
								--LW.SlabId = PO.SlabId
								LW.SlabId = PO.SlabId AND LW.PrdId=PO.PrdId AND LW.PrdBatId=PO.PrdBatId 
								WHERE LW.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
							) SPO ON SIP.SalId = SPO.SalId AND SIP.SlNo = SPO.RowId AND
							SIP.PrdId = SPO.PrdId AND SIP.PrdBatId = SPO.PrdBatId
							WHERE SIP.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId) 
						) SPR
						INNER JOIN Company C WITH (NOLOCK) ON SPR.CmpId = C.CmpId
						UNION ALL
						SELECT SPR.*,0 Points,0 Tax1Perc,0 Tax2Perc,0 Tax3Perc,0 Tax4Perc,0 Tax5Perc,0 Tax1Amount,0 Tax2Amount,0 Tax3Amount,0 Tax4Amount,
						0 Tax5Amount,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,C.EmailId,C.ContactPerson
						FROM
						(
--							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.FreePrdId PrdId,P.PrdCCode,P.PrdName,P.PrdShrtName,
--							P.CmpId,P.PrdType,SIP.FreePrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,'0' UOM1,'0' Uom1Qty,
--							'0' UOM2,'0' Uom2Qty,SIP.FreeQty BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.FreePriceId AS PriceId
--							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
--							INNER JOIN Product P WITH (NOLOCK) ON SIP.FreePRdID = P.PrdId
--							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.FreePrdBatId = PB.PrdBatId
--							WHERE SIP.SalId IN (SELECT SalId FROM RptSELECTedBills)
							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.FreePrdId PrdId,P.PrdCCode,PrdDcode,P.PrdName,P.PrdShrtName,
							P.CmpId,P.PrdType,SIP.FreePrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,'0' UOM1,'0' Uom1Qty,
							'0' UOM2,'0' Uom2Qty,SUM(SIP.FreeQty) BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.FreePriceId AS PriceId
							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
							INNER JOIN Product P WITH (NOLOCK) ON SIP.FreePRdID = P.PrdId
							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.FreePrdBatId = PB.PrdBatId
							WHERE SIP.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
							GROUP BY SIP.SalId,SIP.FreePrdId,P.PrdCCode,PrdDcode,P.PrdName,P.PrdShrtName,
							P.CmpId,P.PrdType,SIP.FreePrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,SIP.FreePriceId
						) SPR INNER JOIN Company C WITH (NOLOCK) ON SPR.CmpId = C.CmpId
						UNION ALL
						SELECT SPR.*,0 AS Points,0 Tax1Perc,0 Tax2Perc,0 Tax3Perc,0 Tax4Perc,0 Tax5Perc,0 Tax1Amount,0 Tax2Amount,0 Tax3Amount,
						0 Tax4Amount,0 Tax5Amount,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,C.EmailId,C.ContactPerson
						FROM
						(
--							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.GiftPrdId PrdId,P.PrdCCode,P.PrdName,P.PrdShrtName,
--							P.CmpId,P.PrdType,SIP.GiftPrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,
--							'0' UOM1,'0' Uom1Qty,'0' UOM2,'0' Uom2Qty,SIP.GiftQty BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.GiftPriceId AS PriceId
--							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
--							INNER JOIN Product P WITH (NOLOCK) ON SIP.GiftPRdID = P.PrdId
--							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.GiftPrdBatId = PB.PrdBatId
--							WHERE SIP.SalId IN (SELECT SalId FROM RptSELECTedBills)
							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.GiftPrdId PrdId,P.PrdCCode,PrdDcode,P.PrdName,P.PrdShrtName,
							P.CmpId,P.PrdType,SIP.GiftPrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,
							'0' UOM1,'0' Uom1Qty,'0' UOM2,'0' Uom2Qty,SUM(SIP.GiftQty) AS BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.GiftPriceId AS PriceId
							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
							INNER JOIN Product P WITH (NOLOCK) ON SIP.GiftPRdID = P.PrdId
							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.GiftPrdBatId = PB.PrdBatId
							WHERE SIP.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
							GROUP BY SIP.SalId,SIP.GiftPrdId,P.PrdCCode,PrdDcode,P.PrdName,P.PrdShrtName,
							P.CmpId,P.PrdType,SIP.GiftPrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,SIP.GiftPriceId
						) SPR INNER JOIN Company C ON SPR.CmpId = C.CmpId
					)SalesInvPrd
					LEFT OUTER JOIN
					(
						SELECT SI.SalId SalId1,ISNULL(SI.SlNo,0) SlNo1,SI.PRdId PrdId1,SI.PRdBatId PRdBatId1,
						ISNULL(D.LineUnitAmount,0) AS [Spl. Disc_UnitAmt_Dt], ISNULL(D.Amount,0) AS [Spl. Disc_Amount_Dt],
						ISNULL(D.LineUom1Amount,0) AS [Spl. Disc_UomAmt_Dt], ISNULL(D.LineUnitPerc,0) AS [Spl. Disc_UnitPerc_Dt],
						ISNULL(D.LineBaseQtyPerc,0) AS [Spl. Disc_QtyPerc_Dt], ISNULL(D.LineUom1Perc,0) AS [Spl. Disc_UomPerc_Dt],
						ISNULL(D.LineEffectAmount,0) AS [Spl. Disc_EffectAmt_Dt], ISNULL(E.LineUnitAmount,0) AS [Sch Disc_UnitAmt_Dt],
						ISNULL(E.Amount,0) AS [Sch Disc_Amount_Dt], ISNULL(E.LineUom1Amount,0) AS [Sch Disc_UomAmt_Dt],
						ISNULL(E.LineUnitPerc,0) AS [Sch Disc_UnitPerc_Dt], ISNULL(E.LineBaseQtyPerc,0) AS [Sch Disc_QtyPerc_Dt],
						ISNULL(E.LineUom1Perc,0) AS [Sch Disc_UomPerc_Dt], ISNULL(E.LineEffectAmount,0) AS [Sch Disc_EffectAmt_Dt],
						ISNULL(F.LineUnitAmount,0) AS [DB Disc_UnitAmt_Dt], ISNULL(F.Amount,0) AS [DB Disc_Amount_Dt],
						ISNULL(F.LineUom1Amount,0) AS [DB Disc_UomAmt_Dt], ISNULL(F.LineUnitPerc,0) AS [DB Disc_UnitPerc_Dt],
						ISNULL(F.LineBaseQtyPerc,0) AS [DB Disc_QtyPerc_Dt], ISNULL(F.LineUom1Perc,0) AS [DB Disc_UomPerc_Dt],
						ISNULL(F.LineEffectAmount,0) AS [DB Disc_EffectAmt_Dt], ISNULL(G.LineUnitAmount,0) AS [CD Disc_UnitAmt_Dt],
						ISNULL(G.Amount,0) AS [CD Disc_Amount_Dt], ISNULL(G.LineUom1Amount,0) AS [CD Disc_UomAmt_Dt],
						ISNULL(G.LineUnitPerc,0) AS [CD Disc_UnitPerc_Dt], ISNULL(G.LineBaseQtyPerc,0) AS [CD Disc_QtyPerc_Dt],
						ISNULL(G.LineUom1Perc,0) AS [CD Disc_UomPerc_Dt], ISNULL(G.LineEffectAmount,0) AS [CD Disc_EffectAmt_Dt],
						ISNULL(H.LineUnitAmount,0) AS [Tax Amt_UnitAmt_Dt], ISNULL(H.Amount,0) AS [Tax Amt_Amount_Dt],
						ISNULL(H.LineUom1Amount,0) AS [Tax Amt_UomAmt_Dt], ISNULL(H.LineUnitPerc,0) AS [Tax Amt_UnitPerc_Dt],
						ISNULL(H.LineBaseQtyPerc,0) AS [Tax Amt_QtyPerc_Dt], ISNULL(H.LineUom1Perc,0) AS [Tax Amt_UomPerc_Dt],
						ISNULL(H.LineEffectAmount,0) AS [Tax Amt_EffectAmt_Dt] 
						FROM SalesInvoiceProduct SI WITH (NOLOCK)
						INNER JOIN
						(
							SELECT DISTINCT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,
							LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,LineEffectAmount
							FROM View_SalInvLineAmt WHERE RefCode='D'
						) D ON SI.SalId = D.SalId AND SI.SlNo = D.PrdSlNo
						INNER JOIN
						(
							SELECT DISTINCT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,
							LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,LineEffectAmount
							FROM View_SalInvLineAmt WHERE RefCode='E'
						) E ON SI.SalId = E.SalId AND SI.SlNo = E.PrdSlNo
						INNER JOIN
						(
							SELECT DISTINCT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,
							LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,LineEffectAmount
							FROM View_SalInvLineAmt WHERE RefCode='F'
						) F ON SI.SalId = F.SalId AND SI.SlNo = F.PrdSlNo
						INNER JOIN
						(
							SELECT DISTINCT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,
							LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,LineEffectAmount
							FROM View_SalInvLineAmt WHERE RefCode='G'
						) G ON SI.SalId = G.SalId AND SI.SlNo = G.PrdSlNo
						INNER JOIN
						(
							SELECT DISTINCT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,
							LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,LineEffectAmount
							FROM View_SalInvLineAmt WHERE RefCode='H'
						) H ON SI.SalId = H.SalId AND SI.SlNo = H.PrdSlNo
						WHERE SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
					) LiAmt  ON SalesInvPrd.SalIdDt = LiAmt.SalId1 AND SalesInvPrd.PrdId = LiAmt.PrdId1
					AND SalesInvPrd.PrdBatId = LiAmt.PRdBatId1 AND SalesInvPrd.SlNo = LiAmt.SlNo1
					LEFT OUTER JOIN
					(
						SELECT DISTINCT SalId SalId2,SlNo PrdSlNo2,0 LineUnitPerc,0 AS LineBaseQtyPerc,0 LineUom1Perc,Prduom1selrate LineUnitAmount,
						(Prduom1selrate * BaseQty)  LineBaseQtyAmount,PrdUom1EditedSelRate LineUom1Amount, 0 LineEffectAmount
						FROM SalesInvoiceProduct WITH (NOLOCK)
					) LNUOM  ON SalesInvPrd.SalIdDt = LNUOM.SalId2 AND SalesInvPrd.SlNo = LNUOM.PrdSlNo2
					LEFT OUTER JOIN
					(
						SELECT DISTINCT MRP.PrdId,MRP.PrdBatId,MRP.BatchSeqId,MRP.MRP,SelRtr.[Selling Rate],MRP.PriceId
						FROM
						(
							SELECT PB.PrdId,PB.PrdBatId,PBV.BatchSeqId, PBV.PrdBatDetailValue 'MRP',PBV.PriceId
							FROM ProductBatch PB WITH (NOLOCK),BatchCreation BC WITH (NOLOCK), ProductBatchDetails PBV WITH (NOLOCK)
							WHERE PBV.BatchSeqId = BC.BatchSeqId AND PBV.PrdBatId = PB.PrdBatId AND PBV.SLNo = BC.SlNo AND (MRP = 1 )
						) MRP
						LEFT OUTER JOIN
						(
						SELECT PB.PrdId,PB.PrdBatId,PBV.BatchSeqId, PBV.PrdBatDetailValue 'Selling Rate',PBV.PriceId
						FROM ProductBatch PB  WITH (NOLOCK), BatchCreation BC WITH (NOLOCK), ProductBatchDetails PBV WITH (NOLOCK)
						WHERE PBV.BatchSeqId = BC.BatchSeqId AND PBV.PrdBatId = PB.PrdBatId AND PBV.SLNo = BC.SlNo AND (SelRte= 1 )
						) SelRtr ON MRP.PrdId = SelRtr.PrdId AND MRP.PrdBatId = SelRtr.PrdBatId AND MRP.BatchSeqId = SelRtr.BatchSeqId
						AND MRP.PriceId=SelRtr.PriceId
					) BATPRC ON SalesInvPrd.PrdId = BATPRC.PrdId AND SalesInvPrd.PrdBatId = BATPRC.PrdBatId AND BATPRC.PriceId=SalesInvPrd.PriceId
				) RepDt ON RepHd.SalIdHd = RepDt.SalIdDt
			) RepAll
		) FinalSI  WHERE SalId IN (SELECT SalId FROM @TempSalId)
		
	END
	ELSE
	BEGIN
	
		SELECT SI.* INTO #SalesInvoiceProduct FROM SalesInvoiceProduct SI WITH (NOLOCK) 
		INNER JOIN  RptSELECTedBills B ON SI.SALID=B.SalId WHERE B.UsrId=@Pi_UsrId
		 
		INSERT INTO @RptBillTemplate
		SELECT DISTINCT BaseQty,PrdBatCode,ExpDate,MnfDate,MRP,[Selling Rate],SalInvDate,SalInvRef,BillMode,BillType,[CD Disc_Amount_Dt],
		[CD Disc_EffectAmt_Dt],[CD Disc_HD],[CD Disc_UnitAmt_Dt],[CD Disc_QtyPerc_Dt],[CD Disc_UnitPerc_Dt],[CD Disc_UomAmt_Dt],[CD Disc_UomPerc_Dt],
		Address1,Address2,Address3,CmpCode,ContactPerson,EmailId,FaxNumber,CmpName,PhoneNumber,D_ContactPerson,CSTNo,[DB Disc_Amount_Dt],
		[DB Disc_EffectAmt_Dt],[DB Disc_HD],[DB Disc_UnitAmt_Dt],[DB Disc_QtyPerc_Dt],[DB Disc_UnitPerc_Dt],[DB Disc_UomAmt_Dt],[DB Disc_UomPerc_Dt],
		DCDate,DCNo,DlvBoyName,SalDlvDate,DepositAmt,DistributorAdd1,DistributorAdd2,DistributorAdd3,DistributorCode,DistributorName,DrugBatchDesc,
		DrugLicNo1,DrugLicNo2,Drug1ExpiryDate,Drug2ExpiryDate,EANCode,D_EmailID,D_GeoLevelName,InterimSales,LicNo,LineBaseQtyAmount,LineBaseQtyPerc,
		LineEffectAmount,LineUnitamount,LineUnitPerc,LineUom1Amount,LineUom1Perc,LSTNo,SalManFreeQty,OrderDate,OrderKeyNo,PestExpiryDate,PestLicNo,
		PhoneNo,PinCode,PrdCCode,PrdName,PrdShrtName,SLNo,PrdType,Remarks,RtrAdd1,RtrAdd2,RtrAdd3,RtrCode,RtrContactPerson,RtrCovMode,
		RtrCrBills,RtrCrDays,RtrCrLimit,RtrCSTNo,RtrDepositAmt,RtrDrugExpiryDate,RtrDrugLicNo,RtrEmailId,GeoLevelName,RtrLicExpiryDate,RtrLicNo,
		RtrName,RtrOffPhone1,RtrOffPhone2,RtrOnAcc,RtrPestExpiryDate,RtrPestLicNo,RtrPhoneNo,RtrPinNo,RtrResPhone1,RtrResPhone2,
		RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipId,RtrTaxType,RtrTINNo,VillageName,RMCode,RMName,SalInvNo,SalActNetRateAmount,SalCDPer,
		CRAdjAmount,DBAdjAmount,SalGrossAmount,PrdGrossAmountAftEdit,PrdNetAmount,MarketRetAmount,SalNetAmt,SalNetRateDiffAmount,OnAccountAmount,
		OtherCharges,SalRateDiffAmount,ReplacementDiffAmount,SalRoundOffAmt,TotalAddition,TotalDeduction,WindowDisplayamount,SMCode,SMName,B.SalId,
		[Sch Disc_Amount_Dt],[Sch Disc_EffectAmt_Dt],[Sch Disc_HD],[Sch Disc_UnitAmt_Dt],[Sch Disc_QtyPerc_Dt],[Sch Disc_UnitPerc_Dt],[Sch Disc_UomAmt_Dt],
		[Sch Disc_UomPerc_Dt],Points,[Spl. Disc_Amount_Dt],[Spl. Disc_EffectAmt_Dt],[Spl. Disc_HD],[Spl. Disc_UnitAmt_Dt],[Spl. Disc_QtyPerc_Dt],
		[Spl. Disc_UnitPerc_Dt],[Spl. Disc_UomAmt_Dt],[Spl. Disc_UomPerc_Dt],Tax1Perc,Tax2Perc,Tax3Perc,Tax4Perc,Tax1Amount,Tax2Amount,Tax3Amount,
		Tax4Amount,[Tax Amt_Amount_Dt],[Tax Amt_EffectAmt_Dt],[Tax Amt_HD],[Tax Amt_UnitAmt_Dt],[Tax Amt_QtyPerc_Dt],[Tax Amt_UnitPerc_Dt],
		[Tax Amt_UomAmt_Dt],[Tax Amt_UomPerc_Dt],TaxType,TINNo,Uom1Id,Uom1Qty,Uom2Id,Uom2Qty,VehicleCode,@Pi_UsrId,1 Visibility,PrdDcode,'',0
		FROM
		(
			SELECT DisDt.*,RepAll.*
			FROM
			(
				SELECT D.DistributorCode,D.DistributorName,D.DistributorAdd1,D.DistributorAdd2,D.DistributorAdd3, D.PinCode,D.PhoneNo,
				D.ContactPerson D_ContactPerson,D.EmailID D_EmailID,D.TaxType,D.TINNo,D.DepositAmt,GL.GeoLevelName D_GeoLevelName,
				D.CSTNo,D.LSTNo,D.LicNo,D.DrugLicNo1,D.Drug1ExpiryDate,D.DrugLicNo2,D.Drug2ExpiryDate,D.PestLicNo , D.PestExpiryDate
				FROM Distributor D WITH (NOLOCK)
				LEFT OUTER JOIN Geography G WITH (NOLOCK) ON D.GeoMainId = G.GeoMainId
				LEFT OUTER JOIN GeographyLevel GL WITH (NOLOCK) ON G.GeoLevelId = GL.GeoLevelId
			) DisDt ,
			(
				SELECT RepHD.*,RepDt.* FROM
				(
					SELECT DISTINCT SalesInv.* , RtrDt.*,HDAmt.* FROM
					(
						SELECT SI.SalId SalIdHD,SalInvNo,SalInvDate,SalDlvDate,SalInvRef,SM.SMID,SM.SMCode,SDC.DCDATE,SDC.DCNO,SM.SMName,
						RM.RMID,RM.RMCode,RM.RMName,RtrId,InterimSales,OrderKeyNo,OrderDate,billtype,billmode,remarks,SalGrossAmount,SalRateDiffAmount,
						SalCDPer,DBAdjAmount,CRAdjAmount,Marketretamount,OtherCharges,Windowdisplayamount,onaccountamount,Replacementdiffamount,
						TotalAddition,TotalDeduction,SalActNetRateAmount,SalNetRateDiffAmount,SalNetAmt,SalRoundOffAmt,V.VehicleId,V.VehicleCode,
						D.DlvBoyId,D.DlvBoyName
						FROM SalesInvoice SI WITH (NOLOCK)
						LEFT OUTER JOIN SalInvoiceDeliveryChallan SDC ON SI.SALID=SDC.SALID
						LEFT OUTER JOIN Salesman SM WITH (NOLOCK) ON SI.SMId = SM.SMId
						LEFT OUTER JOIN RouteMaster RM WITH (NOLOCK) ON SI.RMId = RM.RMId
						LEFT OUTER JOIN Vehicle V WITH (NOLOCK) ON SI.VehicleId = V.VehicleId
						LEFT OUTER JOIN DeliveryBoy D WITH (NOLOCK) ON SI.DlvBoyId = D.DlvBoyId
						INNER JOIN RptSELECTedBills E (NOLOCK) ON SI.SalId=E.SalId
						WHERE E.UsrId=@Pi_UsrId 
					) SalesInv
					INNER JOIN
					(
						SELECT R.RtrId RtrId1,R.RtrCode,R.RtrName,R.RtrAdd1,R.RtrAdd2,R.RtrAdd3,R.RtrPinNo,R.RtrPhoneNo,
						R.RtrEmailId,R.RtrContactPerson,R.RtrCovMode,R.RtrTaxType,R.RtrTINNo,R.RtrCSTNo,R.RtrDepositAmt,R.RtrCrBills,R.RtrCrLimit,
						R.RtrCrDays,R.RtrLicNo,R.RtrLicExpiryDate,R.RtrDrugLicNo,R.RtrDrugExpiryDate,R.RtrPestLicNo,R.RtrPestExpiryDate,GL.GeoLevelName,
						RV.VillageName,R.RtrShipId,RS.RtrShipAdd1,RS.RtrShipAdd2,RS.RtrShipAdd3,R.RtrResPhone1,
						R.RtrResPhone2,R.RtrOffPhone1,R.RtrOffPhone2,R.RtrOnAcc
						FROM Retailer R WITH (NOLOCK)
						INNER JOIN  SalesInvoice SI WITH (NOLOCK) ON R.RtrId=SI.RtrId
						INNER JOIN RptSELECTedBills E (NOLOCK) ON SI.SalId=E.SalId
						LEFT OUTER JOIN RouteVillage RV WITH (NOLOCK) ON R.VillageId = RV.VillageId
						LEFT OUTER JOIN RetailerShipAdd RS WITH (NOLOCK) ON R.RtrShipId = RS.RtrShipId,
						Geography G WITH (NOLOCK),
						GeographyLevel GL WITH (NOLOCK)
						WHERE R.GeoMainId = G.GeoMainId
						AND G.GeoLevelId = GL.GeoLevelId AND E.UsrId=@Pi_UsrId --SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
					) RtrDt ON SalesInv.RtrId = RtrDt.RtrId1
					INNER JOIN
					(   -- Comment by Boopathy on 02-11-2011 for taking long time to generate
						--SELECT SI.SalId,  ISNULL(D.Amount,0) AS [Spl. Disc_HD], ISNULL(E.Amount,0) AS [Sch Disc_HD], ISNULL(F.Amount,0) AS [DB Disc_HD],
						--ISNULL(G.Amount,0) AS [CD Disc_HD], ISNULL(H.Amount,0) AS [Tax Amt_HD]
						--FROM SalesInvoice SI (NOLOCK)
						--INNER JOIN
						--(
						--	SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='D' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) D ON SI.SalId = D.SalId
						--INNER JOIN
						--(
						--	SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='E' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) E ON SI.SalId = E.SalId
						--INNER JOIN
						--(
						--	SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='F' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) F ON SI.SalId = F.SalId
						--INNER JOIN
						--(
						--	SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='G' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) G ON SI.SalId = G.SalId
						--INNER JOIN
						--(
						--	SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='H' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) H ON SI.SalId = H.SalId
						--WHERE SI.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						
						
						SELECT DISTINCT D.SalId,  ISNULL(D.Amount,0) AS [Spl. Disc_HD], ISNULL(E.Amount,0) AS [Sch Disc_HD], ISNULL(F.Amount,0) AS [DB Disc_HD],
						ISNULL(G.Amount,0) AS [CD Disc_HD], ISNULL(H.Amount,0) AS [Tax Amt_HD]
						FROM 
						(
							SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='D' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) D, --ON SI.SalId = D.SalId
						--INNER JOIN
						(
							SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='E' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) E, --ON SI.SalId = E.SalId
						--INNER JOIN
						(
							SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='F' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) F, --ON SI.SalId = F.SalId
						--INNER JOIN
						(
							SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='G' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) G, --ON SI.SalId = G.SalId
						--INNER JOIN
						(
							SELECT SalId,BaseQtyAmount AS Amount FROM View_SalInvHDAmt WHERE RefCode='H' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) H --ON SI.SalId = H.SalId
						WHERE D.SalId =E.SalId AND E.SalId=F.SalId AND F.SalId=G.SalId AND G.SalId=H.SalId
												
					)HDAmt ON SalesInv.SalIdHD = HDAmt.SalId
				) RepHD
				LEFT OUTER JOIN
				(
					SELECT SalesInvPrd.*,LiAmt.*,LNUOM.*,BATPRC.MRP,BATPRC.[Selling Rate]
					FROM
					(
						SELECT SPR.*,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,
						C.EmailId,C.ContactPerson
						FROM
						(
							SELECT SIP.PrdGrossAmountAftEdit,SIP.PrdNetAmount,SIP.SalId SalIdDt,SIP.SlNo,SIP.PrdId,P.PrdCCode,PrdDcode,
							P.PrdName,P.PrdShrtName,P.CmpId,P.PrdType,SIP.PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,P.EANCode,
							U1.UomDescription Uom1Id,SIP.Uom1Qty,U2.UomDescription Uom2Id,SIP.Uom2Qty,SIP.BaseQty,
							SIP.DrugBatchDesc,SIP.SalManFreeQty,ISNULL(SPO.Points,0) Points,SIP.PriceId,BPT.Tax1Perc,BPT.Tax2Perc,
							BPT.Tax3Perc,BPT.Tax4Perc,BPT.Tax5Perc,BPT.Tax1Amount,BPT.Tax2Amount,BPT.Tax3Amount,BPT.Tax4Amount,BPT.Tax5Amount
							FROM #SalesInvoiceProduct SIP WITH (NOLOCK)
							LEFT OUTER JOIN BillPrintTaxTemp BPT WITH (NOLOCK) ON SIP.SalId=BPT.SalID AND SIP.PrdId=BPT.PrdId AND SIP.PrdBatId=BPT.PrdBatId AND BPT.UsrId=@Pi_UsrId
							INNER JOIN  RptSELECTedBills E WITH (NOLOCK) ON SIP.SalId=E.SalId
							INNER JOIN Product P WITH (NOLOCK) ON SIP.PRdID = P.PrdId
							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.PrdBatId = PB.PrdBatId
							INNER JOIN UomMaster U1 WITH (NOLOCK) ON SIP.Uom1Id = U1.UomId
							LEFT OUTER JOIN UomMaster U2 WITH (NOLOCK) ON SIP.Uom2Id = U2.UomId
							LEFT OUTER JOIN
							(
								SELECT LW.SalId,LW.RowId,LW.SchId,LW.slabId,LW.PrdId, LW.PrdBatId, PO.Points
								FROM SalesInvoiceSchemeLineWise LW WITH (NOLOCK)
								INNER JOIN  RptSELECTedBills E WITH (NOLOCK) ON LW.SalId=E.SalId
								LEFT OUTER JOIN SalesInvoiceSchemeDtpoints PO WITH (NOLOCK) ON LW.SalId = PO.SalId
								AND LW.SchId = PO.SchId AND LW.SlabId = PO.SlabId
								WHERE E.UsrId=@Pi_UsrId
							) SPO ON SIP.SalId = SPO.SalId AND SIP.SlNo = SPO.RowId AND
							SIP.PrdId = SPO.PrdId AND SIP.PrdBatId = SPO.PrdBatId
							WHERE E.UsrId=@Pi_UsrId --.SalId IN (SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId) 
						) SPR
						INNER JOIN Company C WITH (NOLOCK) ON SPR.CmpId = C.CmpId
						UNION ALL
						SELECT SPR.*,0 Points,0 Tax1Perc,0 Tax2Perc,0 Tax3Perc,0 Tax4Perc,0 Tax5Perc,0 Tax1Amount,0 Tax2Amount,0 Tax3Amount,0 Tax@Pi_UsrIdAmount,
						0 Tax5Amount,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,C.EmailId,C.ContactPerson
						FROM
						(
							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.FreePrdId PrdId,P.PrdCCode,PrdDcode,P.PrdName,
							P.PrdShrtName,P.CmpId,P.PrdType,SIP.FreePrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,
							'0' UOM1,'0' Uom1Qty,'0' UOM2,'0' Uom2Qty,SIP.FreeQty BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.FreePriceId AS PriceId
							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
							INNER JOIN  RptSELECTedBills E WITH (NOLOCK) ON SIP.SalId=E.SalId
							INNER JOIN Product P WITH (NOLOCK) ON SIP.FreePRdID = P.PrdId
							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.FreePrdBatId = PB.PrdBatId
							WHERE E.UsrId=@Pi_UsrId
						) SPR INNER JOIN Company C WITH (NOLOCK) ON SPR.CmpId = C.CmpId
						UNION ALL
						SELECT SPR.*,0 AS Points,0 Tax1Perc,0 Tax2Perc,0 Tax3Perc,0 Tax4Perc,0 Tax5Perc,0 Tax1Amount,0 Tax2Amount,0 Tax3Amount,
						0 Tax@Pi_UsrIdAmount,0 Tax5Amount,C.CmpCode,C.CmpName,C.Address1,C.Address2,C.Address3,C.PhoneNumber,C.FaxNumber,C.EmailId,C.ContactPerson
						FROM
						(
							SELECT 0 PrdGrossAmountAftEdit,0 PrdNetAmount,SIP.SalId SalIdDt,0 SlNo,SIP.GiftPrdId PrdId,P.PrdCCode,PrdDcode,P.PrdName,
							P.PrdShrtName,P.CmpId,P.PrdType,SIP.GiftPrdBatId PrdBatId,PB.PrdBatCode,PB.MnfDate,PB.ExpDate,'' AS EANCode,
							'0' UOM1,'0' Uom1Qty,'0' UOM2,'0' Uom2Qty,SIP.GiftQty BaseQty,'0' DrugBatchDesc,'0' SalManFreeQty,SIP.GiftPriceId AS PriceId
							FROM SalesInvoiceSchemeDtFreePrd SIP WITH (NOLOCK)
							INNER JOIN  RptSELECTedBills E WITH (NOLOCK) ON SIP.SalId=E.SalId
							INNER JOIN Product P WITH (NOLOCK) ON SIP.GiftPRdID = P.PrdId
							INNER JOIN ProductBatch PB WITH (NOLOCK) ON SIP.GiftPrdBatId = PB.PrdBatId
							WHERE E.UsrId=@Pi_UsrId
						) SPR INNER JOIN Company C ON SPR.CmpId = C.CmpId
					)SalesInvPrd
					LEFT OUTER JOIN
					(
						SELECT DISTINCT SI.SalId SalId1,ISNULL(SI.SlNo,0) SlNo1,SI.PRdId PrdId1,SI.PRdBatId PRdBatId1,
						ISNULL(D.LineUnitAmount,0) AS [Spl. Disc_UnitAmt_Dt], ISNULL(D.Amount,0) AS [Spl. Disc_Amount_Dt],
						ISNULL(D.LineUom1Amount,0) AS [Spl. Disc_UomAmt_Dt], ISNULL(D.LineUnitPerc,0) AS [Spl. Disc_UnitPerc_Dt],
						ISNULL(D.LineBaseQtyPerc,0) AS [Spl. Disc_QtyPerc_Dt], ISNULL(D.LineUom1Perc,0) AS [Spl. Disc_UomPerc_Dt],
						ISNULL(D.LineEffectAmount,0) AS [Spl. Disc_EffectAmt_Dt], ISNULL(E.LineUnitAmount,0) AS [Sch Disc_UnitAmt_Dt],
						ISNULL(E.Amount,0) AS [Sch Disc_Amount_Dt], ISNULL(E.LineUom1Amount,0) AS [Sch Disc_UomAmt_Dt],
						ISNULL(E.LineUnitPerc,0) AS [Sch Disc_UnitPerc_Dt], ISNULL(E.LineBaseQtyPerc,0) AS [Sch Disc_QtyPerc_Dt],
						ISNULL(E.LineUom1Perc,0) AS [Sch Disc_UomPerc_Dt], ISNULL(E.LineEffectAmount,0) AS [Sch Disc_EffectAmt_Dt],
						ISNULL(F.LineUnitAmount,0) AS [DB Disc_UnitAmt_Dt], ISNULL(F.Amount,0) AS [DB Disc_Amount_Dt],
						ISNULL(F.LineUom1Amount,0) AS [DB Disc_UomAmt_Dt], ISNULL(F.LineUnitPerc,0) AS [DB Disc_UnitPerc_Dt],
						ISNULL(F.LineBaseQtyPerc,0) AS [DB Disc_QtyPerc_Dt], ISNULL(F.LineUom1Perc,0) AS [DB Disc_UomPerc_Dt],
						ISNULL(F.LineEffectAmount,0) AS [DB Disc_EffectAmt_Dt], ISNULL(G.LineUnitAmount,0) AS [CD Disc_UnitAmt_Dt],
						ISNULL(G.Amount,0) AS [CD Disc_Amount_Dt], ISNULL(G.LineUom1Amount,0) AS [CD Disc_UomAmt_Dt],
						ISNULL(G.LineUnitPerc,0) AS [CD Disc_UnitPerc_Dt], ISNULL(G.LineBaseQtyPerc,0) AS [CD Disc_QtyPerc_Dt],
						ISNULL(G.LineUom1Perc,0) AS [CD Disc_UomPerc_Dt], ISNULL(G.LineEffectAmount,0) AS [CD Disc_EffectAmt_Dt],
						ISNULL(H.LineUnitAmount,0) AS [Tax Amt_UnitAmt_Dt], ISNULL(H.Amount,0) AS [Tax Amt_Amount_Dt],
						ISNULL(H.LineUom1Amount,0) AS [Tax Amt_UomAmt_Dt], ISNULL(H.LineUnitPerc,0) AS [Tax Amt_UnitPerc_Dt],
						ISNULL(H.LineBaseQtyPerc,0) AS [Tax Amt_QtyPerc_Dt], ISNULL(H.LineUom1Perc,0) AS [Tax Amt_UomPerc_Dt],
						ISNULL(H.LineEffectAmount,0) AS [Tax Amt_EffectAmt_Dt]
						FROM #SalesInvoiceProduct SI WITH (NOLOCK)
						INNER JOIN  RptSELECTedBills E1 WITH (NOLOCK) ON SI.SalId=E1.SalId,
						--INNER JOIN -- Comment by Boopathy on 02-11-2011 for taking long time to generate
						--(
						--	SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
						--	LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='D' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) D ON SI.SalId = D.SalId AND SI.SlNo = D.PrdSlNo
						--INNER JOIN
						--(
						--	SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
						--	LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='E' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) E ON SI.SalId = E.SalId AND SI.SlNo = E.PrdSlNo
						--INNER JOIN
						--(
						--	SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
						--	LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='F' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) F ON SI.SalId = F.SalId AND SI.SlNo = F.PrdSlNo
						--INNER JOIN
						--(
						--	SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
						--	LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='G' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) G ON SI.SalId = G.SalId AND SI.SlNo = G.PrdSlNo
						--INNER JOIN
						--(
						--	SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
						--	LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='H'AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						--) H ON SI.SalId = H.SalId AND SI.SlNo = H.PrdSlNo
						--INNER JOIN
						(
							SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
							LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='D' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) D,-- ON SI.SalId = D.SalId AND SI.SlNo = D.PrdSlNo
						--INNER JOIN
						(
							SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
							LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='E' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) E ,--ON SI.SalId = E.SalId AND SI.SlNo = E.PrdSlNo
						--INNER JOIN
						(
							SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
							LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='F' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) F ,--ON SI.SalId = F.SalId AND SI.SlNo = F.PrdSlNo
						--INNER JOIN
						(
							SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
							LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='G' AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) G ,--ON SI.SalId = G.SalId AND SI.SlNo = G.PrdSlNo
						--INNER JOIN
						(
							SELECT SalId,PrdSlNo,LineUnitAmount,LineBaseQtyAmount AS Amount,LineUom1Amount,LineUnitPerc,LineBaseQtyPerc,LineUom1Perc,
							LineEffectAmount FROM View_SalInvLineAmt WHERE RefCode='H'AND SalId IN(SELECT SalId FROM RptSELECTedBills (NOLOCK) WHERE UsrId=@Pi_UsrId)
						) H --ON SI.SalId = H.SalId AND SI.SlNo = H.PrdSlNo						
						WHERE SI.SalId=D.SalId AND E1.UsrId=@Pi_UsrId AND D.SalId =E.SalId AND E.SalId=F.SalId AND F.SalId=G.SalId AND G.SalId=H.SalId
						AND SI.SlNo = D.PrdSlNo AND D.PrdSlNo=E.PrdSlNo AND E.PrdSlNo=F.PrdSlNo AND F.PrdSlNo=G.PrdSlNo AND G.PrdSlNo=H.PrdSlNo
						
					) LiAmt  ON SalesInvPrd.SalIdDt = LiAmt.SalId1 AND SalesInvPrd.PrdId = LiAmt.PrdId1 AND
					SalesInvPrd.PrdBatId = LiAmt.PRdBatId1 AND SalesInvPrd.SlNo = LiAmt.SlNo1
					LEFT OUTER JOIN
					(
						SELECT E1.SalId SalId2,SlNo PrdSlNo2,0 LineUnitPerc,0 AS LineBaseQtyPerc,0 LineUom1Perc,Prduom1selrate LineUnitAmount,
						(Prduom1selrate * BaseQty)  LineBaseQtyAmount,PrdUom1EditedSelRate LineUom1Amount, 0 LineEffectAmount
						FROM #SalesInvoiceProduct WITH (NOLOCK) INNER JOIN  RptSELECTedBills E1 WITH (NOLOCK) ON #SalesInvoiceProduct.SalId=E1.SalId
						WHERE E1.UsrId=@Pi_UsrId
					) LNUOM  ON SalesInvPrd.SalIdDt = LNUOM.SalId2 AND SalesInvPrd.SlNo = LNUOM.PrdSlNo2
					LEFT OUTER JOIN
					(
						SELECT DISTINCT MRP.PrdId,MRP.PrdBatId,MRP.BatchSeqId,MRP.MRP,SelRtr.[Selling Rate],MRP.PriceId
						FROM
						(
							SELECT E1.SalId,PB.PrdId,PB.PrdBatId,PBV.BatchSeqId, PBV.PrdBatDetailValue 'MRP',PBV.PriceId
							FROM 
							#SalesInvoiceProduct SI WITH (NOLOCK) INNER JOIN  RptSELECTedBills E1 WITH (NOLOCK) ON SI.SalId=E1.SalId,
							ProductBatch PB WITH (NOLOCK),BatchCreation BC WITH (NOLOCK), ProductBatchDetails PBV WITH (NOLOCK)
							WHERE PBV.BatchSeqId = BC.BatchSeqId AND PBV.PrdBatId = PB.PrdBatId AND PBV.SLNo = BC.SlNo AND (MRP = 1 )
							AND SI.PrdId=PB.PrdId AND SI.PrdBatId=PB.PrdBatId AND SI.PriceId=PBV.PriceId AND E1.UsrId=@Pi_UsrId
						) MRP
						INNER JOIN
						(
							SELECT E1.SalId,PB.PrdId,PB.PrdBatId,PBV.BatchSeqId, PBV.PrdBatDetailValue 'Selling Rate',PBV.PriceId
							FROM 
							#SalesInvoiceProduct SI WITH (NOLOCK) INNER JOIN  RptSELECTedBills E1 WITH (NOLOCK) ON SI.SalId=E1.SalId,
							ProductBatch PB  WITH (NOLOCK), BatchCreation BC WITH (NOLOCK), ProductBatchDetails PBV WITH (NOLOCK)
							WHERE PBV.BatchSeqId = BC.BatchSeqId AND PBV.PrdBatId = PB.PrdBatId AND PBV.SLNo = BC.SlNo AND (SelRte= 1 )
							AND SI.PrdId=PB.PrdId AND SI.PrdBatId=PB.PrdBatId AND SI.PriceId=PBV.PriceId AND E1.UsrId=@Pi_UsrId
						) SelRtr ON MRP.PrdId = SelRtr.PrdId AND SelRtr.SalId=MRP.SalId
						AND MRP.PrdBatId = SelRtr.PrdBatId AND MRP.BatchSeqId = SelRtr.BatchSeqId AND MRP.PriceId=SelRtr.PriceId
					) BATPRC ON SalesInvPrd.PrdId = BATPRC.PrdId AND SalesInvPrd.PrdBatId = BATPRC.PrdBatId AND BATPRC.PriceId=SalesInvPrd.PriceId
				) RepDt ON RepHd.SalIdHd = RepDt.SalIdDt
			) RepAll
		) FinalSI  INNER JOIN RptSELECTedBills B (NOLOCK) ON B.SalId=FinalSI.SalId WHERE UsrId=@Pi_UsrId
	END
	
	
	UPDATE @RptBillTemplate set [Allotment No]=V.AllotmentNumber from @RptBillTemplate R inner join VehicleAllocationDetails V on R.[Sales Invoice Number]=V.SaleInvNo

	-- CP Changes
	UPDATE A Set [Batch Selling Rate] =[Line Unit Amount]
    FROM @RptBillTemplate A INNER JOIN Salesinvoice B ON A.Salid =B.SAlid
	INNER JOIN SalesInvoiceProduct C ON A.Salid =C.Salid AND B.Salid =C.Salid
	INNER JOIN Product P ON A.[Product Code] =P.PrdCCode AND P.Prdid =C.Prdid
	INNER JOIN ProductBatch PB ON PB.PrdBatCode =A.[batch Code] AND C.Prdbatid = PB.Prdbatid AND C.Prdid = PB.PrdId AND P.Prdid =PB.Prdid
	AND Splrate>0
	--CP Changes
	
	UPDATE @RptBillTemplate set [Bx Selling Rate]=PrdBatDetailValue*ConversionFactor from @RptBillTemplate R inner join 
	(SELECT PrdCCode,pb.PrdBatCode,PBD.PrdBatDetailValue,uG.ConversionFactor from Product P inner join ProductBatch PB on P.PrdId=PB.PrdId
	INNER JOIN ProductBatchDetails PBD on PBD.PrdBatId=PB.PrdBatId and PBD.DefaultPrice=1 and SLNo=3
	INNER JOIN UomGroup UG on P.UomGroupId=UG.UomGroupId and UOMId=1)A	
	on R.[Batch Code]=A.PrdBatCode AND R.[Product Code]=PrdCCode
	
	IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id(N'[RptBTBillTemplate]')
	AND OBJECTPROPERTY(id, N'IsUserTable') = 1)
--	DROP TABLE [RptBTBillTemplate]
	BEGIN
		DELETE FROM RptBTBillTemplate WHERE UsrId=@Pi_UsrId
		INSERT INTO RptBTBillTemplate
		SELECT DISTINCT *  FROM @RptBillTemplate WHERE UsrId=@Pi_UsrId
	END
	ELSE
	BEGIN
		SELECT DISTINCT * INTO RptBTBillTemplate FROM @RptBillTemplate WHERE UsrId=@Pi_UsrId
	END
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_GR_BillWISESales' AND TYPE='P')
DROP PROCEDURE Proc_GR_BillWISESales
GO
--EXEC Proc_GR_BillWISESales 'Bill Wise Retailer Sales','2020-08-01','2020-08-20','','','','','',''
CREATE PROCEDURE Proc_GR_BillWISESales
(
	@Pi_RptName		NVARCHAR(100),
	@Pi_FromDate	DATETIME,
	@Pi_ToDate		DATETIME,
	@Pi_Filter1		NVARCHAR(100),
	@Pi_Filter2		NVARCHAR(100),
	@Pi_Filter3		NVARCHAR(100),
	@Pi_Filter4		NVARCHAR(100),
	@Pi_Filter5		NVARCHAR(100),
	@Pi_Filter6		NVARCHAR(100)
)
AS 
/*****************************************************************************************************************************
 DATE          AUTHOR       CR/BZ USER     STORY ID           DESCRIPTION                             
*************************************************************************************************************************************    
23-05-2020	  Mohana S			BZ			PARCS202100013		Category taken based on Transaction	
13-08-2020	  MOHANA S			BZ			PARLESECS/0820/074  TOTAL NET AMOUNT SHOWING HAS BEEN CORRECTED
*************************************************************************************************************************************/
BEGIN
		SELECT 0 flag ,CAST('' AS VARCHAR(20)) AS dlvsts INTO #TEMP 
		TRUNCATE TABLE #TEMP
		INSERT INTO #TEMP SELECT 1,'Saved'
		INSERT INTO #TEMP SELECT 2,'Vehicle Allocated'
		INSERT INTO #TEMP SELECT 3,'Cancelled'
		INSERT INTO #TEMP SELECT 4,'Delivered'
		INSERT INTO #TEMP SELECT 5,'Fully Settled'
--EXEC Proc_GR_BillWISESales 'Bill Wise Retailer Sales','2011-12-12','2011-12-12','','','','','','can'
		SET @Pi_FILTER1='%'+ISNULL(@Pi_FILTER1,'')+'%'        
		SET @Pi_FILTER2='%'+ISNULL(@Pi_FILTER2,'')+'%'        
		SET @Pi_FILTER3='%'+ISNULL(@Pi_FILTER3,'')+'%'        
		SET @Pi_FILTER4='%'+ISNULL(@Pi_FILTER4,'')+'%'        
		SET @Pi_FILTER5='%'+ISNULL(@Pi_FILTER5,'')+'%'  
		SET @Pi_FILTER6='%'+ISNULL(@Pi_FILTER6,'')+'%'
	
		
	SELECT Salid,RtrId,RtrValueClassId INTO #SalesinvoiceRtr  FROM Salesinvoice WHERE SALINVDATE BETWEEN @PI_fROMDATE AND @PI_TODATE 
	and DLVSTS in (select flag from #temp where dlvsts like @pi_filter6)
	SELECT Salid,RtrId,RtrValueClassId ,L3,L2,L1,L1+L2+L3 HashProducts INTO #SalesRetailer FROM (
	
	
	SELECT Salid,RtrId,RtrValueClassId,D.CtgCode+ ':' + D.CtgName L3, C.CtgCode+ ':' + C.CtgName L2,B.ValueClassCode+ ':' + B.ValueClassName L1
	FROM #SalesinvoiceRtr A INNER JOIN RetailerValueClass B ON A.RtrvalueClassId = B.RtrCLassid
	INNER JOIN RetailerCategory C ON B.CtgMainID = C.CtgMainId
	INNER JOIN RetailerCategory D ON D.CtgMainId = C.CtgLinkId AND A.RtrvalueClassId>0
	UNION ALL
	SELECT Salid,A.RtrId,RtrValueClassId,HIERARCHY3CAP L3,HIERARCHY2CAP L2 ,HIERARCHY1CAP L1  FROM #SalesinvoiceRtr A 
	INNER JOIN TBL_GR_BUILD_RH B ON A.Rtrid = B.Rtrid AND A.RtrvalueClassId=0
	)A
		 
		 
		
		SELECT a.*,L1 HIERARCHY1CAP, L2 HIERARCHY2CAP, L3 HIERARCHY3CAP 
		INTO #SALINV
		FROM SALESINVOICE A,ROUTEMASTER B, SALESMAN C, RETAILER D  ,#SalesRetailer E
		WHERE SALINVDATE BETWEEN @PI_fROMDATE AND @PI_TODATE AND A.RMID=B.RMID AND B.RMNAME LIKE @PI_FILTER5 and E.RTRID=A.RTRID AND 
		A.RtrValueClassId = E.RtrValueClassId AND DLVSTS in (select flag from #temp where dlvsts like @pi_filter6) and
		C.SMID=A.SMID AND C.SMNAME LIKE @PI_FILTER1 AND A.SALINVNO LIKE @PI_FILTER3 
		AND A.RTRID=D.RTRID AND D.RTRNAME LIKE @PI_FILTER4 AND E.HASHPRODUCTS LIKE @PI_FILTER2 AND E.SalId  =A.SalId  
		
		SELECT     'Billwise ',#SALINV.SalInvNo AS [Bill Number], CONVERT(VARCHAR(10),#SALINV.SalInvDate,121) AS [Bill Date], 
		CASE BillType WHEN 1 THEN 'Order Booking'  WHEN 2 THEN 'Ready Stock' WHEN 3 THEN 'Van Sales' END AS [Bill Type],
		CASE BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END AS [Bill Mode],
		CASE #SALINV.DlvSts  when 1 then 'Saved' when 2 then 'Vehicle Allocated' when 3 then 'Cancelled' when 4 then 'Delivered' when 5 then 'Fully Settled' end AS [Delivery Status], 
		Salesman.SMName AS Salesman,RouteMaster.RMName [Route],#SALINV.HIERARCHY3CAP [Retailer Hierarchy 1],#SALINV.HIERARCHY2CAP [Retailer Hierarchy 2],
		#SALINV.HIERARCHY1CAP [Retailer Hierarchy 3],Retailer.RtrCode [Retailer Code], Retailer.RtrName AS [Retailer Name], 
		#SALINV.SalGrossAmount AS [Gross Amount], #SALINV.SalSchDiscAmount AS [Scheme Disc], #SALINV.MarketRetAmount AS [Sales Return], 
		#SALINV.ReplacementDiffAmount AS Replacement, #SALINV.SalDBDiscAmount AS [Distributor Discount], #SALINV.SalCDAmount AS [Cash Discount],
		#SALINV.WINDOWDISPLAYAMOUNT [Window Display],#SALINV.SalTaxAmount AS [Tax Amount], #SALINV.DBAdjAmount AS [Debit Adjustment],
		#SALINV.CRAdjAmount AS [Credit Adjustment], #SALINV.SalNetAmt AS [Net Amount]
		FROM  #SALINV  
		INNER JOIN Retailer ON #SALINV.RtrId = Retailer.RtrId 
		INNER JOIN Salesman ON #SALINV.SMId = Salesman.SMId 
		INNER JOIN RouteMaster ON #SALINV.RMId = RouteMaster.RMId 
		INNER JOIN TBL_GR_BUILD_RH ON Retailer.RtrId = TBL_GR_BUILD_RH.RTRID 						
		UNION
		SELECT     ' Billwise','Totals ' AS [Bill Number],'', '','','', '','','','','','','',
		sum(#SALINV.SalGrossAmount) AS [Gross Amount],SUM( #SALINV.SalSchDiscAmount) AS [Scheme Disc], SUM(#SALINV.MarketRetAmount) AS [Sales Return], 
		SUM(#SALINV.ReplacementDiffAmount) AS Replacement,SUM( #SALINV.SalDBDiscAmount) AS [Distributor Discount], SUM(#SALINV.SalCDAmount) AS [Cash Discount],
		sum(#salinv.WindowDisplayAmount),SUM(#SALINV.SalTaxAmount) AS [Tax Amount],SUM( #SALINV.DBAdjAmount) AS [Debit Adjustment],
		SUM( #SALINV.CRAdjAmount) AS [Credit Adjustment],SUM( #SALINV.SalNetAmt) AS [Net Amount]
		FROM  #SALINV  
		INNER JOIN Retailer ON #SALINV.RtrId = Retailer.RtrId 
		INNER JOIN Salesman ON #SALINV.SMId = Salesman.SMId 
		INNER JOIN RouteMaster ON #SALINV.RMId = RouteMaster.RMId 
		INNER JOIN TBL_GR_BUILD_RH ON Retailer.RtrId = TBL_GR_BUILD_RH.RTRID
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME='Proc_Export_CS2WS_Customer' AND TYPE='P')
DROP PROCEDURE Proc_Export_CS2WS_Customer
GO
/*
BEGIN TRAN
DELETE FROM WSMasterExportUploadTrack
DELETE FROM Export_CS2WS_Customer
Exec Proc_Export_CS2WS_Customer '1'
select * from Export_CS2WS_Customer 
--select * from WSMasterExportUploadTrack
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Export_CS2WS_Customer
(
   @SalRpCode varchar(100)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_Customer 
* PURPOSE		: To Export Customer details to the PDA Intermediate Database
* CREATED		: AMUTHA KUMAR P
* CREATED DATE	: 16-08-2018
* MODIFIED		: 
* DATE			AUTHOR				USERSTORYID			CR/BZ      DESCRIPTION
--------------------------------------------------------------------------------------------------------------------
* 16/08/2018   Amuthakumar P        CRCRSTAPAR0016        CR     To Export Customer details
* 29/11/2018   S.Moorthi		    ILCRSTPAR2692		  SR	 0 price moved to SFA Application from Sehyog .
* 14-08-2020   S.Mohana				PARLESECS/0820/085	  BZ	 Allowed GT Category for DUmmy retailer
*********************************************************************************************************************/
BEGIN

	IF NOT EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
	BEGIN
		DELETE FROM ETL_Prk_Retailer
		DELETE FROM ETL_Prk_RetailerShippingAddress
		DELETE FROM ETL_Prk_RetailerRoute
		DELETE FROM ETL_Prk_RetailerValueClassMap

		INSERT INTO ETL_Prk_Retailer([Retailer Code],[Retailer Name],[Address1],[Address2],[Address3],[Pin Code],[Phone No],[EmailId],[Key Account],[Coverage Mode],[Registration Date],[Day Off],[Status],[Taxable],[Tax Type],[TIN Number],[CST Number],[Tax Group],[Credit Bills],[Credit Limit],[Credit Days],[Cash Discount Percentage],[Cash Discount Condition],[Cash Discount Limit Value],[License Number],[License Number Expiry Date],[Drug License Number],[Drug License Number Expiry Date],[Pesticide License Number],
		[Pesticide License Number Expiry Date],[Geography Hierarchy Value],[Delivery Route Code],[Village Code],[Residence Phone No],[Office Phone No],[Deposit Amount],[Potential Class Code],[Retailer Type],[Retailer Frequency],[Credit Days Alert],[Credit Bills Alert],[Credit Limit Alert]) 
		VALUES ('Dummy','Dummy','Dummy','','','0','1201301401','','NO','Order Booking',CONVERT(varchar(10),GETDATE(),121),'Sunday','Active','Yes','NON VAT','','','RTRINTRA','0','0.00','0','0.00','>=','0.00','',NULL,'',NULL,'',NULL,'','',NULL,'','','0.00',NULL,'Retailer','Weekly','None','None','None')

		UPDATE ETL_Prk_Retailer SET [Delivery Route Code]=(
		SELECT TOP 1 RMCode FROM RouteMaster WHERE RMSRouteType=2 Order by RMId DESC)
		UPDATE ETL_Prk_Retailer SET [Geography Hierarchy Value]=(
		SELECT TOP 1 GeoCode FROM Geography Order by GeoMainId DESC)

		INSERT INTO ETL_Prk_RetailerShippingAddress([Retailer Code],[Address1],[Address2],[Address3],[Retailer Shipping Pin Code],[Retailer Shipping Phone No],[Default Shipping Address])
		VALUES ('Dummy','Dummy','0','0','0','0','YES')
		
		INSERT INTO ETL_Prk_RetailerRoute([Retailer Code],[Route Code],[Selection Type])
		SELECT TOP 1 'Dummy',RMCode,'ADD' FROM RouteMaster WHERE RMSRouteType=1 
		AND RMId IN (SELECT MAX(RMID) AS RMID FROM SalesmanMarket GROUP BY SMId)
		
		INSERT INTO ETL_Prk_RetailerValueClassMap([Retailer Code],[Value Class Code],[Category Level Value],[Selection Type])
		SELECT TOP 1 'Dummy',A.ValueClassCode,B.CtgCode,'ADD' FROM RetailerValueClass A (NOLOCK)
		INNER JOIN RetailerCategory B (NOLOCK) ON A.CtgMainId=B.CtgMainId 
		INNER JOIN RetailerCategory C (NOLOCK) ON B.CtgLinkId = C.CtgMainId AND C.CtgCode ='GT' --PARLESECS/0820/085
		ORDER BY RtrClassId DESC

		EXEC Proc_ValidateRetailerMaster 0
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy')
		BEGIN
			EXEC Proc_ValidateRetailerValueClassMap 0
			EXEC Proc_ValidateRetailerRoute 0
			EXEC Proc_ValidateRetailerShippingAddress 0 
		END
		
		IF EXISTS(SELECT * FROM Retailer WHERE RtrCode='Dummy' AND ISNULL(CmpRtrCode,'')<>'Dummy')
		BEGIN
			UPDATE Retailer SET CmpRtrCode='Dummy' WHERE RtrCode='Dummy'
			UPDATE CompanyCounters SET CurrValue = CurrValue-1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
		END  
	END

	DECLARE @Smid AS int
	DECLARE @Sql AS varchar(3000)
	DECLARE @Date AS datetime
	DECLARE @Week AS int
	DECLARE @WCal AS int
	DECLARE @StartDate AS datetime
	DECLARE @EndDate AS datetime
	SELECT @StartDate=JcmSdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @EndDate = JcmEdt FROM JCMonth WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcmSdt AND JcmEdt
	SELECT @Week=jcwwk FROM JCWeek WHERE CONVERT(varchar(10),getdate(),121) BETWEEN JcwSdt AND JcwEdt
	
	SELECT @date=CONVERT(varchar(10),getdate(),121)
	DELETE FROM Export_CS2WS_Customer WHERE UploadFlag='Y'
	
	IF EXISTS (SELECT * FROM sysobjects WHERE NAME='TempRetailer' and xtype='U')
	BEGIN
		DROP TABLE TempRetailer
	END
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=6)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=6 END 
	IF @Week=2	BEGIN SET @WCal=5 END 
	IF @Week=3	BEGIN SET @WCal=4 END 
	IF @Week=4	BEGIN SET @WCal=3 END
	IF @Week=5	BEGIN SET @WCal=2 END
	IF @Week=6	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=5)
 BEGIN
	IF @Week=1 	BEGIN SET @WCal=5 END 
	IF @Week=2	BEGIN SET @WCal=4 END 
	IF @Week=3	BEGIN SET @WCal=3 END 
	IF @Week=4	BEGIN SET @WCal=2 END
	IF @Week=5	BEGIN SET @WCal=1 END
 END 
IF EXISTS (SELECT count(DISTINCT jcwwk) FROM JCWeek WHERE JcmJc=month(getdate()) HAVING count(DISTINCT jcwwk)=4)
BEGIN 
	IF @Week=1	BEGIN SET @WCal=4 END 
	IF @Week=2	BEGIN SET @WCal=3 END 
	IF @Week=3	BEGIN SET @WCal=2 END 
	IF @Week=4	BEGIN SET @WCal=1 END 
END 

SET @Sql ='SELECT distinct  DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
	RtrRemark1,RC1.CtgCode AS ChannelCode,RC.CtgCode as GroupCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,CAST('''' AS VARCHAR(100)) AS CustomerPricingKey,0 RmId,RtrCrLimit,0 AS TotalBalanceDue,
	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
	FROM Retailer R 
	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	CROSS JOIN Distributor D WHERE RtrStatus in(1)'
	EXEC (@Sql)

--SET @Sql ='SELECT DistributorCode,R.RtrID,R.CmpRtrCode,R.RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,GeoName,GeoName as State,RtrPinNo,Left(RtrPhoneNo,30)RtrPhoneNo,RtrEmailId,RtrContactPerson,
--	RtrRemark1,CtgCode,ValueClassCode,RtrStatus AS CustomerStatus,1 As SalesMode,1 AS PaymentType,0 AS CustomerPricingKey,RM.RmId,RtrCrLimit,0 AS TotalBalanceDue,
--	1 as IsTaxable, 0 as TaxId,0 as SurveyKey,RtrDOB as DateofBirth, RtrTinNo as RtrTinNO INTO TempRetailer
--	FROM Retailer R 
--	INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
--	INNER JOIN RetailerValueClassMap RVM ON R.RtrID = RVM.RtrID 
--	INNER JOIN RetailerValueClass RV ON RVM.RtrValueClassId = RV.RtrClassId
--	INNER JOIN RetailerCategory RC ON RC.CtgMainId = RV.CtgMainId 
--	INNER JOIN RetailerMarket RM ON RM.RtrId=R.RtrId
--	INNER JOIN SalesmanMarket SM ON sm.RMId=RM.RMId
--	CROSS JOIN Distributor D WHERE RtrStatus in(1) AND
--	sm.SMId in('+ CAST(@SalRpCode AS VARCHAR(100)) +')'
--	EXEC (@Sql)
		
	SELECT DISTINCT B.ColumnName,A.ColumnValue,MasterRecordId INTO #TEMPUDCROUTE1
	FROM UdcDetails A,UdcMaster B, UdcHD C WHERE  A.UdcMasterId=B.UdcMasterId
	AND A.MasterId=B.MasterId AND ColumnName='State Name' AND MasterName='Retailer Master'
	
		
	UPDATE T SET [State]=R.ColumnValue FROM TempRetailer T INNER JOIN #TEMPUDCROUTE1 R ON T.rtrid=R.MasterRecordId 
	
	SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	
	
	CREATE TABLE #PricingKey
	(
		CustomerCode	VARCHAR(100),
		CtgCode			VARCHAR(100)
	)
	
		
	SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	GROUP BY PBL.PrdId,PBL.PrdBatId
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT R.CmpRtrCode,R.CmpRtrCode AS CmpRtrCode1 FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.RtrId<>0

	
	UPDATE A SET A.CustomerPricingKey=B.CustomerCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	
	delete from #PricingKey
	
	INSERT INTO #PricingKey(CustomerCode,CtgCode)
	SELECT DISTINCT T.CmpRtrCode,R.CtgCode
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.CtgMainId<>0
	
	UPDATE A SET A.CustomerPricingKey=B.CtgCode FROM TempRetailer A INNER JOIN #PricingKey B ON A.CmpRtrCode=B.CustomerCode
	WHERE ISNULL(CustomerPricingKey,'')=''
	
	INSERT INTO Export_CS2WS_Customer(TenantCode,LocationCode,CustomerCode,CustomerName,Address1,Address2,Address3,Address4,City,State,Zip,Phone,Fax,Email,ContactPerson,
	Notes,CategoryCode1,CategoryCode2,CategoryCode3,CustomerStatus,SalesMode,PaymentType,CustomerPricingKey,TotalCreditLimit,TotalBalanceDue,
	IsTaxable,TaxID,HierarchyCode,TerritoryHierarchy,SurveyKey,DateofBirth,IDNumber,TINNumber,UploadFlag)
	SELECT DISTINCT  DistributorCode,DistributorCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,'' as Address4,GeoName,State,RtrPinNo,RtrPhoneNo,'' as Fax,RtrEmailId,RtrContactPerson,
	RtrRemark1,ChannelCode,GroupCode,ValueClassCode,CustomerStatus,SalesMode,PaymentType,ISNULL(CustomerPricingKey,''),RtrCrLimit,TotalBalanceDue,IsTaxable,TaxID,GroupCode,'',SurveyKey,DateofBirth,'',RtrTinNo,
	'N' AS UploadFlag FROM TempRetailer R 
	WHERE NOT EXISTS(SELECT * FROM WSMasterExportUploadTrack M WHERE M.MasterCode = R.CmpRtrCode AND R.CustomerPricingKey=M.Reference2 AND M.ProcessName='Customer') 
	
	INSERT INTO WSMasterExportUploadTrack(ProcessName,MasterCode,MasterName,ExportTime,Status,Reference1,Reference2,Reference3,Ref4Value)
	SELECT 'Customer',CustomerCode,CustomerName,GETDATE(),0,LocationCode,CustomerPricingKey,CategoryCode2,0 FROM Export_CS2WS_Customer WHERE UploadFlag='N'
	 
	
	UPDATE R SET R.WSUpload='Y' FROM WSMasterExportUploadTrack A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.MasterCode=R.CmpRtrCode
	WHERE ISNULL(R.WSUpload,'N')='N' AND ProcessName='Customer'
		
	SELECT	DISTINCT 
			TenantCode,
			LocationCode,
			CustomerCode,
			CustomerName,
			Address1,
			Address2,
			Address3,
			Address4,
			City,
			State,
			Zip,
			Phone,
			Fax,
			Email,
			ContactPerson,
			Notes,
			CategoryCode1,
			CategoryCode2,
			CategoryCode3,
			CustomerStatus,
			SalesMode,
			PaymentType,
			CustomerPricingKey,
			TotalCreditLimit,
			TotalBalanceDue,
			IsTaxable,
			TaxID,
			HierarchyCode,
			TerritoryHierarchy,
			SurveyKey,
			DateofBirth,
			IDNumber,
			TINNumber 
	FROM Export_CS2WS_Customer WITH (NOLOCK)
	
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME ='Proc_Export_CS2WS_PricingPlan' AND TYPE='P')
DROP PROC Proc_Export_CS2WS_PricingPlan
GO
--EXEC Proc_Export_CS2WS_PricingPlan '1'
CREATE PROCEDURE [dbo].[Proc_Export_CS2WS_PricingPlan]
(
	@SalRpCode varchar(50)
)
AS
/*******************************************************************************************
* PROCEDURE		: Proc_Export_CS2WS_PricingPlan
* PURPOSE		: To Export Product Price details to the PDA Intermediate Database
* CREATED		: S.Moorthi
* CREATED DATE	: 07/08/2018
* MODIFIED		:
* DATE      AUTHOR     DESCRIPTION
*****************************************************************************************************
* DATE         AUTHOR       CR/BZ	   USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
* 04/08/2018   S.Moorthi    CR         CRCRSTPAR0017   SFA-Upload-Download Integration --Product
* 29/11/2018   S.Moorthi    SR         ILCRSTPAR2692   0 price moved to SFA Application from Sehyog .
* 06-01-2020   S.Mohana		SR		   ILCRSTPAR7270   Date not considered in upload (As per Discussion With Awinash & Nilesh)
********************************************************************************************/
BEGIN
DECLARE @DistCode NVARCHAR(40)
DECLARE @Prdid AS int
DECLARE @Prdbatid AS int
	
	DELETE FROM Export_CS2WS_PricingPlan 
	
	SELECT @DistCode = DistributorCode FROM Distributor
	
	CREATE TABLE #Export_CS2WS_PricingPlan
	(
		PrdID				[Bigint],
		TenantCode   [nvarchar](25) COLLATE DATABASE_DEFAULT,  
		PricingCode   [nvarchar](25)COLLATE DATABASE_DEFAULT,  
		PricingDescription [nvarchar](25)COLLATE DATABASE_DEFAULT,  
		StartDate   [Datetime],  
		EndDate    [Datetime],  
		ItemCode   [nvarchar](100)COLLATE DATABASE_DEFAULT,  
		UnitsOfMeasure  [nvarchar](20)COLLATE DATABASE_DEFAULT,   
		DebitPrice   [Float],  
		CreditPrice			[Float],
		DamagePrice			[Float],
		PriceId				[BIGINT]
	)
	
	SELECT R.RtrId,R.CmpRtrCode,RC.CtgCode as GroupCode,RC.CtgMainId AS GroupId,
	RC1.CtgCode AS ChannelCode,RC1.CtgMainId AS ChannelId into #temp1 FROM Retailer R (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM (NOLOCK) ON R.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC (NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC (NOLOCK) ON RC.CtgMainId=RVC.CtgMainId
	INNER JOIN RetailerCategory RC1 (NOLOCK) ON RC1.CtgMainId=RC.CtgLinkId 
	
	SELECT PBL.PrdId,PBL.PrdBatId INTO #TempPriceDt FROM Product A (NOLOCK) 
	INNER JOIN Fn_SFAProductToSend() B ON A.PrdId=B.PrdId
	INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId and PBL.PrdId=B.PrdId
	WHERE PBL.PrdBatLcnSih-PBL.PrdBatLcnRessih>0
	GROUP BY PBL.PrdId,PBL.PrdBatId
	
	INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	SELECT P.PrdId,@DistCode,R.CmpRtrCode,R.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	P.PrdCCode,UM.UomCode,0,0,0,MAX(B.PriceId) as PriceId
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN Retailer R (NOLOCK) ON A.RtrId=R.RtrId  
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId 
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.RtrId<>0
	GROUP BY P.PrdId,R.CmpRtrCode,R.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	P.PrdCCode,UM.UomCode
	
	SELECT DISTINCT PricingCode into #PricingCode from #Export_CS2WS_PricingPlan
	
	INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	SELECT P.PrdId,@DistCode,T.CmpRtrCode,T.CmpRtrCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	P.PrdCCode,UM.UomCode,0,0,0,MAX(b.PriceId) as PriceId
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	inner JOIN #temp1 T (NOLOCK) ON (T.ChannelId=R.CtgMainId OR T.GroupId=R.CtgMainId)
	inner join #PricingCode E (NOLOCK) ON E.PricingCode=T.CmpRtrCode	
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId  AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.CtgMainId<>0 AND 
	NOT EXISTS(SELECT * FROM #Export_CS2WS_PricingPlan EB INNER JOIN Product P (nolock) ON P.PrdCCode=EB.ItemCode 
	WHERE EB.PricingCode=T.CmpRtrCode AND EB.Prdid=P.PrdId AND EB.Prdid=FP.PrdId AND EB.Prdid=B.PrdId 
	AND EB.PricingCode=E.PricingCode)
	GROUP BY P.PrdId,T.CmpRtrCode,T.CmpRtrCode,--A.ValidFromDate,A.ValidTillDate,  
	P.PrdCCode,UM.UomCode
	
	INSERT INTO #Export_CS2WS_PricingPlan(Prdid,TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,PriceId)
	SELECT P.PrdId,@DistCode,R.CtgCode,R.CtgCode,max(A.ValidFromDate) AS ValidFromDate ,max(A.ValidTillDate) AS ValidTillDate,  
	P.PrdCCode,UM.UomCode,0,0,0,MAX(PriceId) As PriceId
	FROM ContractPricingMaster A (NOLOCK)
	INNER JOIN RetailerCategory R (NOLOCK) ON A.CtgMainId=R.CtgMainId  
	INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId=B.ContractId 
	INNER JOIN #TempPriceDt TP ON TP.PrdId=B.PrdId AND TP.PrdBatID=B.PrdBatId
	INNER JOIN Product P (NOLOCK) ON B.PrdId=P.PrdId   AND TP.PrdId=P.PrdId 
	INNER JOIN Fn_SFAProductToSend() FP ON P.PrdId=FP.PrdId AND  B.PrdId=FP.PrdId AND TP.PrdId=FP.PrdId 
	INNER JOIN UomGroup UG (NOLOCK) ON UG.UomGroupId=P.UomGroupId AND UG.BaseUom='Y'
	INNER JOIN UomMaster UM (NOLOCK) ON UM.UomId=UG.UomId
	INNER JOIN TaxGroupSetting TG ON P.TaxGroupId = TG.TaxGroupId AND PrdStatus = 1 
	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN  A.ValidFromDate AND A.ValidTillDate 
	AND A.[Status]=1 AND A.CtgMainId<>0 --and PrdCCode ='100301301041444012144PKT005N' and CtgCode  ='IRCTC WZ'
	GROUP BY P.PrdId,R.CtgCode,R.CtgCode,--A.ValidFromDate,A.ValidTillDate,  
	P.PrdCCode,UM.UomCode
	
	
	--SELECT A.PrdID,Max(PB.PrdBatId) AS PrdBatId	INTO #TempProductBatch FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdID=PB.PRDID
	--WHERE  PrdBatCode <> 'Sample Batch' GROUP BY A.PrdID
	--SELECT DISTINCT P.PrdID,PB.PrdBatId,B1.PrdBatDetailValue as SellRate 
	--INTO #TempPriceDt
	--FROM Product P (NOLOCK)
	--INNER JOIN ProductBatch PB(NOLOCK) ON P.PrdID = PB.PrdID	
	--INNER JOIN #TempProductBatch PB1(NOLOCK) ON P.PrdID = PB1.PrdID AND PB.PrdBatId=PB1.PrdBatId AND PB.PrdID = PB1.PrdID
	--INNER JOIN ProductBatchDetails B1 (NOLOCK) ON PB.PrdBatId = B1.PrdBatID AND B1.DefaultPrice=1
	--INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = PB.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	--ORDER BY P.PrdId
	
	
	UPDATE PP SET PP.DebitPrice=B1.PrdBatDetailValue,PP.CreditPrice=B1.PrdBatDetailValue,PP.DamagePrice=B1.PrdBatDetailValue
	FROM Product P (NOLOCK)
	INNER JOIN #Export_CS2WS_PricingPlan PP ON P.PrdId=PP.PrdID 
	INNER JOIN ProductBatchDetails B1 (NOLOCK) ON B1.PriceId=PP.PriceId
	INNER JOIN BatchCreation C1 (NOLOCK) ON C1.BatchSeqId = B1.BatchSeqId AND B1.SlNo = C1.SlNo AND C1.SelRte = 1 
	
	--As discussed Mr. Awanish to remove duplicate based on Max start date
	SELECT PricingCode,ItemCode INTO #TempDuplicate FROM #Export_CS2WS_PricingPlan 
	GROUP BY PricingCode,ItemCode HAVING COUNT(ItemCode)>1
	SELECT A.PricingCode,A.ItemCode,MAX(A.StartDate) AS StartDate INTO #TempMaxStartDate FROM #Export_CS2WS_PricingPlan A 
	INNER JOIN #TempDuplicate B ON A.PricingCode=B.PricingCode AND A.ItemCode=B.ItemCode 
	GROUP BY A.PricingCode,A.ItemCode
	
	DELETE A FROM #Export_CS2WS_PricingPlan A (NOLOCK)
	INNER JOIN #TempMaxStartDate B ON A.ItemCode=B.ItemCode AND A.PricingCode=B.PricingCode 
	WHERE NOT EXISTS(SELECT * FROM #TempMaxStartDate M WHERE M.PricingCode=A.PricingCode AND M.ItemCode=A.ItemCode AND 
	M.StartDate=A.StartDate)
		
	--UPDATE A SET A.DebitPrice=B.SellRate,A.CreditPrice=B.SellRate,A.DamagePrice=B.SellRate 
	--FROM #Export_CS2WS_PricingPlan A 
	--INNER JOIN #TempPriceDt B ON A.PrdID=B.PrdId and A.PricingCode=
	
	INSERT INTO Export_CS2WS_PricingPlan(TenantCode,PricingCode,PricingDescription,StartDate,EndDate,
	ItemCode,UnitsOfMeasure,DebitPrice,CreditPrice,DamagePrice,UploadFlag)
	SELECT DISTINCT TenantCode,PricingCode,PricingDescription,''StartDate,''EndDate,ItemCode,UnitsOfMeasure, --ILCRSTPAR7270
	DebitPrice,CreditPrice,DamagePrice,'N' UploadFlag FROM #Export_CS2WS_PricingPlan ORDER BY ItemCode
	
	SELECT  Distinct
			TenantCode,
			PricingCode,
			PricingDescription,
			--CONVERT(VARCHAR(10),StartDate,103) AS StartDate,
			--CONVERT(VARCHAR(10),EndDate,103) AS EndDate,
			ItemCode,
			UnitsOfMeasure,
			DebitPrice,
			CreditPrice,
			DamagePrice
		FROM Export_CS2WS_PricingPlan WITH (NOLOCK) 
	
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_ValidateRetailerMaster' AND type='P')
DROP PROC Proc_ValidateRetailerMaster
GO
CREATE PROCEDURE Proc_ValidateRetailerMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateRetailerMaster
* PURPOSE		: To Insert and Update records  from xml file in the Table Retailer
* CREATED		: MarySubashini.S
* CREATED DATE	: 13/09/2007
* MODIFIED
  * DATE         AUTHOR				CR/BZ	   USER STORY ID	DESCRIPTION                         
*****************************************************************************************************
  2013/10/10   Sathishkumar V		CR								Junk Characters Removed  
  10/05/2018   S.Moorthi			CR         CRCRSTPAR0001		Retailer Approval process - Manual
  24-06-2019   S.Mohana				CR		   CRCRSTPAR0064		Include validation procedure 
  26/06/2019   S.Moorthi			CR		  CRCRSTPAR0071			Salesman and Route master access level changes in user login
  19/07/2020   Murugan				CR		  PARCS202100043		RetailerCode Auto Generate
  20-08-2020   Deepak Philip        BZ		  PARLECS/0820/189      Validation added for Dummy Retailer code
*****************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @RetailerCode AS NVARCHAR(100)
	DECLARE @RetailerName AS NVARCHAR(100)
	DECLARE	@Address1 AS NVARCHAR(100)
	DECLARE	@Address2 AS NVARCHAR(100)
	DECLARE	@Address3 AS NVARCHAR(100)
	DECLARE	@PinCode AS NVARCHAR(100)
	DECLARE	@PhoneNo AS NVARCHAR(100)
	DECLARE	@EmailId AS NVARCHAR(100)
	DECLARE	@KeyAccount AS NVARCHAR(100)
	DECLARE	@CoverageMode AS NVARCHAR(100)
	DECLARE	@RegistrationDate AS DATETIME
	DECLARE	@DayOff	AS NVARCHAR(100)
	DECLARE	@Status	AS NVARCHAR(100)
	DECLARE	@Taxable AS NVARCHAR(100)
	DECLARE	@TaxType AS NVARCHAR(100)
	DECLARE	@TINNumber AS NVARCHAR(100)
	DECLARE @CSTNumber AS NVARCHAR(100)
	DECLARE	@TaxGroup AS NVARCHAR(100)
	DECLARE	@CreditBills AS NVARCHAR(100)
	DECLARE	@CreditLimit AS NVARCHAR(100)
	DECLARE	@CreditDays AS NVARCHAR(100)
	DECLARE	@CashDiscountPercentage AS NVARCHAR(100)
	DECLARE	@CashDiscountCondition AS NVARCHAR(100)
	DECLARE	@CashDiscountLimitValue AS NVARCHAR(100)
	DECLARE	@LicenseNumber AS NVARCHAR(100)
	DECLARE	@LicNumberExDate AS NVARCHAR(10)
	DECLARE	@DrugLicNumber AS NVARCHAR(100)
	DECLARE	@DrugLicExDate AS NVARCHAR(10)
	DECLARE	@PestLicNumber	AS NVARCHAR(100)
	DECLARE	@PestLicExDate AS NVARCHAR(10)
	DECLARE	@GeographyHierarchyValue AS NVARCHAR(100)
	DECLARE	@DeliveryRoute	AS NVARCHAR(100)
	DECLARE	@ResidencePhoneNo AS NVARCHAR(100)
	DECLARE	@OfficePhoneNo 	AS NVARCHAR(100)
	DECLARE	@DepositAmount 	AS NVARCHAR(100)
	DECLARE	@VillageCode 	AS NVARCHAR(100)
	DECLARE	@PotentialClassCode AS NVARCHAR(100)
	DECLARE	@RetailerType AS NVARCHAR(100)
	DECLARE	@RetailerFrequency AS NVARCHAR(100)
	DECLARE	@RtrCrDaysAlert AS NVARCHAR(100)
	DECLARE	@RtrCrBillAlert AS NVARCHAR(100)
	DECLARE	@RtrCrLimitAlert AS NVARCHAR(100)
	DECLARE @GeoMainId AS INT
	DECLARE @RMId AS INT
	DECLARE @VillageId AS INT
	DECLARE @RtrId AS INT
	DECLARE @TaxGroupId AS INT
	DECLARE @RtrClassId AS INT
	DECLARE @Taction AS INT
	DECLARE @Tabname AS NVARCHAR(100)
	DECLARE @CntTabname AS NVARCHAR(100)
	DECLARE @Fldname AS NVARCHAR(100)
	DECLARE @ErrDesc AS NVARCHAR(1000)
	DECLARE @sSql AS NVARCHAR(4000)
	DECLARE @CoaId AS INT
	DECLARE @AcCode AS NVARCHAR(1000)
	DECLARE @CmpRtrCode AS NVARCHAR(200)	
	
	--RtrCode Auto Generate--PARCS202100043
	DECLARE @AutoRtrCode AS NVARCHAR(200)
	DECLARE @RtrCodeUserInput AS NVARCHAR(200)
	DECLARE @AutoRtrCodeConfig AS TINYINT
	SET @AutoRtrCodeConfig=0
	IF EXISTS(SELECT 'X' FROM Configuration (NOLOCK) where ModuleId='RET26' and Status=1)
	BEGIN
		SET @AutoRtrCodeConfig=1
	END
	--Till Here--PARCS202100043
	
	EXEC Proc_Validate_ETLRetailerDetails --added by Mohana 
	SET @CntTabname='Retailer'
	SET @Fldname='RtrId'
	SET @Tabname = 'ETL_Prk_Retailer'
	SET @Taction=0
	SET @Po_ErrNo=0
	SET @VillageId=0
	DECLARE Cur_Retailer CURSOR
	FOR SELECT dbo.Fn_Removejunk(ISNULL([Retailer Code],'')),dbo.Fn_Removejunk(ISNULL([Retailer Name],'')),dbo.Fn_Removejunk(ISNULL([Address1],'')),
		dbo.Fn_Removejunk(ISNULL([Address2],'')),dbo.Fn_Removejunk(ISNULL([Address3],'')),
		ISNULL([Pin Code],'0'),ISNULL([Phone No],'0'),dbo.Fn_Removejunk(ISNULL(EmailId,'')),ISNULL([Key Account],''),
		ISNULL([Coverage Mode],''),CAST([Registration Date] AS DATETIME) AS [Registration Date],ISNULL([Day Off],''),
		ISNULL([Status],''),ISNULL([Taxable],''),ISNULL([Tax Type],''),ISNULL([TIN Number],''),
		ISNULL([CST Number],''),ISNULL([Tax Group],''),ISNULL([Credit Bills],'0'),ISNULL([Credit Limit],'0'),
		ISNULL([Credit Days],'0'),ISNULL([Cash Discount Percentage],'0'),ISNULL([Cash Discount Condition],''),
		ISNULL([Cash Discount Limit Value],'0'),ISNULL([License Number],''),
		ISNULL([License Number Expiry Date],NULL),
		ISNULL([Drug License Number],''),ISNULL([Drug License Number Expiry Date],NULL),
		ISNULL([Pesticide License Number],''),ISNULL([Pesticide License Number Expiry Date],NULL),
		ISNULL([Geography Hierarchy Value],''),ISNULL([Delivery Route Code],''),ISNULL([Village Code],''),
		ISNULL([Residence Phone No],''),ISNULL([Office Phone No],''),ISNULL([Deposit Amount],'0'),
		ISNULL([Potential Class Code],''),
		ISNULL([Retailer Type],'') ,
		ISNULL([Retailer Frequency],''),ISNULL([Credit Days Alert],'') ,
		ISNULL([Credit Bills Alert],'') ,ISNULL([Credit Limit Alert],'')
	FROM ETL_Prk_Retailer WITH(NOLOCK) ORDER BY [Retailer Code]
	OPEN Cur_Retailer
	FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
	@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
	@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
	@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
	@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
	@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	WHILE @@FETCH_STATUS=0		
	BEGIN
		
		SET @RtrId=0
		
		---Start--PARCS202100043
		SET @RtrCodeUserInput=''
		SET @AutoRtrCode=''		
		SET @RtrCodeUserInput=@RetailerCode

		
	IF @RetailerCode <>'DUMMY'--PARLECS/0820/189
	BEGIN	
		IF (@AutoRtrCodeConfig=1)
		BEGIN		
			SELECT  @AutoRtrCode=CASE Len(CurrValue+1)  
			WHEN 1 THEN Prefix + '0000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar)
			WHEN 2 THEN Prefix + '000' + Cast(Isnull(CurrValue,0) + 1 AS Varchar) 
			WHEN 3 THEN Prefix + '00' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 4 THEN Prefix + '0' + Cast(Isnull(CurrValue,0) + 1  AS Varchar) 
			WHEN 5 THEN Prefix + Cast(Isnull(CurrValue,0) + 1 AS Varchar) END
			FROM Counters (NOLOCK) WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'		
			
		
			IF LEN(ISNULL(@AutoRtrCode,''))>0
			BEGIN
				SET @RetailerCode=@AutoRtrCode				
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Auto Retailer Code not generated '  		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END
				RETURN
			END
	 END		
			
			IF EXISTS(SELECT 'X' FROM Retailer (NOLOCK) WHERE RtrCode=@RetailerCode)
			BEGIN
				SET @Po_ErrNo=1 
				SET @Taction=0
				SET @ErrDesc = 'Auto generate retailer code already exists,Increase counters value ' +@AutoRtrCode 		
				INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)			
				IF (SELECT CURSOR_STATUS('global','Cur_Retailer')) >= -1
				BEGIN
					DEALLOCATE Cur_Retailer
				END					
				RETURN
			END
							
		END
		--END --PARCS202100043
		IF NOT EXISTS  (SELECT * FROM Geography WHERE GeoCode = @GeographyHierarchyValue )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Geogrpahy Code: ' + @GeographyHierarchyValue + ' is not available'  		
			INSERT INTO Errorlog VALUES (1,@Tabname,'GeographyHierarchyValue',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoCode = @GeographyHierarchyValue
		END
		IF NOT EXISTS  (SELECT * FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )
  		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'  		
			INSERT INTO Errorlog VALUES (2,@Tabname,'DeliveryRoute',@ErrDesc)
		END
		ELSE
		BEGIN		
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute
		END
		IF LTRIM(RTRIM(@PotentialClassCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode )
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Potential Class Code ' + @PotentialClassCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (3,@Tabname,'PotentialClassCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @RtrClassId =RtrClassId FROM RetailerPotentialClass WHERE PotentialClassCode = @PotentialClassCode
			END
		END
		SELECT @TaxGroupId = 0
		IF LTRIM(RTRIM(@TaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @TaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (4,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @TaxGroup
			END
		END
		IF LTRIM(RTRIM(@VillageCode)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT * FROM RouteVillage WHERE VillageCode = @VillageCode)
	  		BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Village Code ' + @VillageCode + ' is not available'  		
				INSERT INTO Errorlog VALUES (5,@Tabname,'VillageCode',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @VillageId =VillageId FROM RouteVillage WHERE VillageCode = @VillageCode
			END
		END
		IF (LTRIM(RTRIM(@RetailerCode))<>'' AND LTRIM(RTRIM(@RtrCodeUserInput))<>'')
		BEGIN
			IF EXISTS  (SELECT * FROM Retailer WHERE 
			(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput
				))
			BEGIN
				SET @Taction=2
				SELECT @RtrId=RtrId from Retailer WHERE 
				(RtrCode = @RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
				OR RtrCode =@RtrCodeUserInput)
			END
			ELSE
			BEGIN
				SET @Taction=1
			END
		END
		ELSE
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Code should not be empty '  		
			INSERT INTO Errorlog VALUES (6,@Tabname,'RetailerCode',@ErrDesc)
		END
		
			
		IF LTRIM(RTRIM(@RetailerName))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Name should not be empty'		
			INSERT INTO Errorlog VALUES (7,@Tabname,'RetailerName',@ErrDesc)
		END	
		IF LTRIM(RTRIM(@Address1))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Address  should not be empty'		
			INSERT INTO Errorlog VALUES (8,@Tabname,'Address',@ErrDesc)
		END
		IF LEN(@PinCode)<>0
		BEGIN
			IF ISNUMERIC(@PinCode)=0
			BEGIN
				SET @Po_ErrNo=1	
				SET @Taction=0
				SET @ErrDesc = 'PinCode is not in correct format'		
				INSERT INTO Errorlog VALUES (9,@Tabname,'PinCode',@ErrDesc)
			END	
		END					
				
		IF LTRIM(RTRIM(@KeyAccount))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'KeyAccount should not be empty'		
			INSERT INTO Errorlog VALUES (10,@Tabname,'KeyAccount',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@KeyAccount))='Yes' OR LTRIM(RTRIM(@KeyAccount))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Key Account Type '+@KeyAccount+ ' is not available'		
				INSERT INTO Errorlog VALUES (11,@Tabname,'KeyAccount',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CoverageMode))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Coverage Mode should not be empty'		
			INSERT INTO Errorlog VALUES (12,@Tabname,'CoverageMode',@ErrDesc)
		END
		ELSE
			BEGIN
			IF LTRIM(RTRIM(@CoverageMode))='Order Booking' OR LTRIM(RTRIM(@CoverageMode))='Van Sales' OR LTRIM(RTRIM(@CoverageMode))='Counter Sales'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Coverage Mode Type '+@CoverageMode+ ' does not exists'		
				INSERT INTO Errorlog VALUES (13,@Tabname,'CoverageMode',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RegistrationDate))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Registration Date should not be empty'		
			INSERT INTO Errorlog VALUES (14,@Tabname,'RegistrationDate',@ErrDesc)
		END
		ELSE
		BEGIN
			IF ISDATE(@RegistrationDate)=0
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Registration Date '+@RegistrationDate+ ' not in date format'		
				INSERT INTO Errorlog VALUES (15,@Tabname,'RegistrationDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF @RegistrationDate > (CONVERT(NVARCHAR(11),GETDATE(),121))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Invalid Registration Date'		
					INSERT INTO Errorlog VALUES (16,@Tabname,'RegistrationDate',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@DayOff))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Day Off should not be empty'		
			INSERT INTO Errorlog VALUES (17,@Tabname,'DayOff',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@DayOff))='Sunday' OR LTRIM(RTRIM(@DayOff))='Monday' OR LTRIM(RTRIM(@DayOff))='Tuesday' OR
			LTRIM(RTRIM(@DayOff))='Wednesday' OR LTRIM(RTRIM(@DayOff))='Thursday' OR LTRIM(RTRIM(@DayOff))='Friday' OR
			LTRIM(RTRIM(@DayOff))='Saturday'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Day Off Type '+@DayOff+ ' is not available'		
				INSERT INTO Errorlog VALUES (18,@Tabname,'DayOff',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Status))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Status should not be empty'		
			INSERT INTO Errorlog VALUES (19,@Tabname,'Status',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Status))='Active' OR LTRIM(RTRIM(@Status))='Inactive'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Status Type '+@Status+ ' is not available'		
				INSERT INTO Errorlog VALUES (20,@Tabname,'Status',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@Taxable))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Taxable should not be empty'		
			INSERT INTO Errorlog VALUES (21,@Tabname,'Taxable',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@Taxable))='Yes' OR LTRIM(RTRIM(@Taxable))='No'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Taxable Type '+@Taxable+ ' is not available'		
				INSERT INTO Errorlog VALUES (22,@Tabname,'Taxable',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (23,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (24,@Tabname,'TaxType',@ErrDesc)
			END
		END
		IF @TaxType='VAT'
		BEGIN
			IF LTRIM(RTRIM(@TINNumber))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'TIN Number should not be empty'		
				INSERT INTO Errorlog VALUES (25,@Tabname,'TINNumber',@ErrDesc)
			END
			ELSE
			BEGIN
				IF LEN(@TINNumber)>11
				BEGIN
					SET @Po_ErrNo=1
					SET @Taction=0
					SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
					INSERT INTO Errorlog VALUES (26,@Tabname,'TINNumber',@ErrDesc)
				END
			END
		END
		IF LTRIM(RTRIM(@CreditBills))<>''
		BEGIN
			IF ISNUMERIC(@CreditBills)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Bills value Should be Number'		
				INSERT INTO Errorlog VALUES (27,@Tabname,'CreditBills',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditLimit))<>''
		BEGIN
			IF ISNUMERIC(@CreditLimit)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit value Should be Number'		
				INSERT INTO Errorlog VALUES (28,@Tabname,'CreditLimit',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CreditDays))<>''
		BEGIN
			IF ISNUMERIC(@CreditDays)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Credit Days value Should be Number'		
				INSERT INTO Errorlog VALUES (29,@Tabname,'CreditDays',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (30,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@CashDiscountPercentage))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountPercentage)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'		
				INSERT INTO Errorlog VALUES (31,@Tabname,'CashDiscountPercentage',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@CashDiscountCondition))<>''
		BEGIN
			IF LTRIM(RTRIM(@CashDiscountCondition))='>=' OR LTRIM(RTRIM(@CashDiscountCondition))='<='
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Condition Type '+@CashDiscountCondition+ ' is not available'		
				INSERT INTO Errorlog VALUES (32,@Tabname,'CashDiscountCondition',@ErrDesc)
			END
		END
			
	
		IF LTRIM(RTRIM(@CashDiscountLimitValue))<>''
		BEGIN
			IF ISNUMERIC(@CashDiscountLimitValue)=0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Cash Discount Limit Value value Should be Number'		
				INSERT INTO Errorlog VALUES (33,@Tabname,'CashDiscountLimitValue',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@LicenseNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@LicNumberExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (34,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@LicNumberExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'License Number Expiry Date '+@LicNumberExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (35,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF  (CONVERT(NVARCHAR(10),@LicNumberExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (36,@Tabname,'LicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@DrugLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@DrugLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Drug License Number Expiry Date  should not be empty'		
				INSERT INTO Errorlog VALUES (37,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@DrugLicExDate,121))=0
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Drug License Number Expiry Date '+@DrugLicExDate+ 'not in date format'		
					INSERT INTO Errorlog VALUES (38,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
				END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@DrugLicExDate,121))< CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Drug License Number Expiry Date'		
						INSERT INTO Errorlog VALUES (39,@Tabname,'DrugLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@PestLicNumber))<>''
		BEGIN
			IF LTRIM(RTRIM(@PestLicExDate))=''
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Pesticide License Number Expiry Date  was not given'		
				INSERT INTO Errorlog VALUES (40,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
			END
			ELSE
			BEGIN
				IF ISDATE(CONVERT(NVARCHAR(10),@PestLicExDate,121))=0
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Pesticide License Number Expiry Date '+@PestLicExDate+ 'not in date format'		
						INSERT INTO Errorlog VALUES (41,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				ELSE
				BEGIN
					IF (CONVERT(NVARCHAR(10),@PestLicExDate,121)) < CONVERT(NVARCHAR(10),GETDATE(),121)
					BEGIN
						SET @Po_ErrNo=1		
						SET @Taction=0
						SET @ErrDesc = 'Invalid Pesticide License Number Expiry Date '		
						INSERT INTO Errorlog VALUES (42,@Tabname,'PesticideLicenseNumberExpiryDate',@ErrDesc)
					END
				END
			END
		END
		IF LTRIM(RTRIM(@RetailerType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Type should not be empty'		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Retailer Type',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerType))='Retailer' OR LTRIM(RTRIM(@RetailerType))='Sub Stockist'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Type '+@RetailerType+ ' is not available'		
				INSERT INTO Errorlog VALUES (44,@Tabname,'Retailer Type',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RetailerFrequency))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency should not be empty'		
			INSERT INTO Errorlog VALUES (45,@Tabname,'Retailer Frequency',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RetailerFrequency))='Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Bi-Weekly' OR LTRIM(RTRIM(@RetailerFrequency))='Fort Nightly' OR LTRIM(RTRIM(@RetailerFrequency))='Monthly' OR LTRIM(RTRIM(@RetailerFrequency))='Daily'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Frequency '+@RetailerFrequency+ ' is not available'		
				INSERT INTO Errorlog VALUES (46,@Tabname,'Retailer Frequency',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrDaysAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Days Alert should not be empty'		
			INSERT INTO Errorlog VALUES (47,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrDaysAlert))='None' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrDaysAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrDaysAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (48,@Tabname,'Credit Days Alert',@ErrDesc)
			END
		END
		
		IF LTRIM(RTRIM(@RtrCrBillAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Bills Alert should not be empty'		
			INSERT INTO Errorlog VALUES (49,@Tabname,'Credit Bills Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrBillAlert))='None' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrBillAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Days Alert '+@RtrCrBillAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (50,@Tabname,'Credit Bills Alert',@ErrDesc)
			END
		END
		IF LTRIM(RTRIM(@RtrCrLimitAlert))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Credit Limit Alert should not be empty'		
			INSERT INTO Errorlog VALUES (51,@Tabname,'Credit Days Alert',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@RtrCrLimitAlert))='None' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Allow' OR LTRIM(RTRIM(@RtrCrLimitAlert))='Alert & Stop'
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Credit Limit Alert '+@RtrCrLimitAlert+ ' is not available'		
				INSERT INTO Errorlog VALUES (52,@Tabname,'Credit Limit Alert',@ErrDesc)
			END
		END
		
		IF @Taction=1
		BEGIN
			SET @CmpRtrCode=''
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger(@CntTabname,@FldName,CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')	
			
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1
			BEGIN			
				IF NOT EXISTS(SELECT * FROM Retailer)
				BEGIN
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'	
				END
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))			
			END
			ELSE
			BEGIN
				SET @CmpRtrCode=@RetailerCode
			END
			
			SELECT @CmpRtrCode=@RetailerCode where @RetailerCode='DUMMY'--PARLECS/0820/189

			IF @CmpRtrCode=''
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Company Retailer Code should not be empty'		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
			END
		END
		
		
		
		IF @RtrId=0
		BEGIN
			SET @Po_ErrNo=1		
			SET @Taction=0
			SET @ErrDesc = 'Reset the Counter Year Value '		
			INSERT INTO Errorlog VALUES (43,@Tabname,'Counter Value',@ErrDesc)
		END
		
		IF EXISTS (SELECT '*' FROM Configuration WHERE ModuleId = 'GENCONFIG30' AND ModuleName = 'General Configuration' AND Status = 1)
		BEGIN
			IF LTRIM(RTRIM(@PhoneNo))=''
			BEGIN
				--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtdId NOT IN (@RetailerCode))
				IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
				(RtrCode NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
				OR RtrCode NOT IN (@RtrCodeUserInput)))
				BEGIN
					SET @Po_ErrNo=1		
					SET @Taction=0
					SET @ErrDesc = 'Retailer Phone Number not be Empty '		
					INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
				END				
			END			
		END
		
		IF LTRIM(RTRIM(@PhoneNo))<>''
		BEGIN
			--IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND RtrId  NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrPhoneNo from Retailer (Nolock) where RtrPhoneNo = @PhoneNo AND 
			(RtrCode  NOT IN (@RetailerCode) OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Phone Number should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'Phone Number',@ErrDesc)
			END			
		END
		IF LTRIM(RTRIM(@TINNumber))<>''
		BEGIN
			--IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND RtrId NOT IN (@RetailerCode))
			IF EXISTS (SELECT RtrTINNo from Retailer (Nolock) where RtrTINNo = @TINNumber AND 
			(RtrCode NOT IN (@RetailerCode)OR RtrCodeUserInput NOT IN(@RtrCodeUserInput)
			OR RtrCode NOT IN (@RtrCodeUserInput)))
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tin Number Should be unique '		
				INSERT INTO Errorlog VALUES (43,@Tabname,'TiN Number',@ErrDesc)
			END			
		END
		
		IF @Po_ErrNo=0
		BEGIN		
			DECLARE @MSG AS VARCHAR(100)
			SET @MSG=''
			SELECT @MSG=DBO.Fn_RetailerApprovalStatus(@RtrId)
			IF ISNULL(@MSG,'')<>''
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
				SELECT DISTINCT 5,'Retailer ApprovalStatus','ApprovalStatus',@MSG 
				SET @Po_ErrNo =1 
			END
		END
		
					
		IF  @Taction=1 AND @Po_ErrNo=0
		BEGIN	
			INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,RtrDrugLicNo,RtrDrugExpiryDate,
			RtrPestLicNo,RtrPestExpiryDate,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,Approved,XmlUpload,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrUniqueCode,RtrCodeUserInput)--Gopi at 08/11/2016
			VALUES(@RtrId,@RetailerCode,@CmpRtrCode,@RetailerName,@Address1,@Address2,@Address3,CAST(@PinCode AS INT),@PhoneNo,@EmailId,
			(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END),
			@RegistrationDate,
			(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),@TINNumber,@CSTNumber,@TaxGroupId,CAST(@CreditBills AS INT),CAST(@CreditLimit AS NUMERIC(18,2)),CAST(@CreditDays AS INT),
			(CAST(@CashDiscountPercentage AS NUMERIC(18,2))),(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),CAST(@CashDiscountLimitValue AS NUMERIC (18,2)),
			@LicenseNumber,CONVERT(NVARCHAR(10),@LicNumberExDate,121),@DrugLicNumber,CONVERT(NVARCHAR(10),@DrugLicExDate,121),
			@PestLicNumber,CONVERT(NVARCHAR(10),@PestLicExDate,121),@GeoMainId,@RMId,@VillageId,@ResidencePhoneNo,@OfficePhoneNo,
			CAST(@DepositAmount AS NUMERIC(18,2)),CONVERT(NVARCHAR(10),GETDATE(),121),CONVERT(NVARCHAR(10),GETDATE(),121),@CoaId,0,0,
			(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			'N',0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'',@RtrCodeUserInput)
			
			UPDATE CompanyCounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'
			--RtrCode Auto Generate
			IF @AutoRtrCodeConfig=1
			BEGIN
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'Retailer'  AND FldName = 'RtrCode'
				
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''RtrCode'''
				INSERT INTO Translog(strSql1) VALUES (@sSql) 
				
			END
			--Till Here
			
			
			SET @sSql='UPDATE CompanyCounters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =''Retailer'' AND Fldname =''CmpRtrCode'''
			INSERT INTO Translog(strSql1) VALUES (@sSql) 		
			SET @sSql='INSERT INTO Retailer(RtrId,RtrCode,CmpRtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,RtrCovMode,
			RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,TaxGroupId,RtrCrBills,RtrCrLimit,RtrCrDays,RtrCashDiscPerc,
			RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrDrugLicNo,RtrPestLicNo,GeoMainId,RMId,VillageId,RtrResPhone1,RtrOffPhone1,RtrDepositAmt,RtrAnniversary,RtrDOB,CoaId,RtrOnAcc,
			RtrShipId,RtrType,RtrFrequency,RtrCrDaysAlert,RtrCrBillsAlert,RtrCrLimitAlert,Upload,XmlUpload,Availability,LastModBy,LastModDate,AuthId,AuthDate,RtrLicExpiryDate,RtrDrugExpiryDate,RtrPestExpiryDate,Approved,RtrCodeUserInput)
			VALUES('+CAST(@RtrId AS VARCHAR(10))+','''+@RetailerCode+''','''+@CmpRtrCode+''','''+@RetailerName+''','''+@Address1+''','''+@Address2+''','''+@Address3+''','+CAST(CAST(@PinCode AS INT)AS VARCHAR(10))+','''+@PhoneNo+''','''+@EmailId+''',
			'+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+',
			'''+CAST(@RegistrationDate AS VARCHAR(12))+''',
			'+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			'+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			'+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+','''+@TINNumber+''','''+@CSTNumber+''','+CAST(@TaxGroupId AS VARCHAR(10))+','+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+','+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20)
)+','+CAST(CAST(@CreditDays AS INT) AS VARCHAR(10))+',
			'+CAST((CAST(@CashDiscountPercentage AS NUMERIC(18,2)))AS VARCHAR(20))+','+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+','+CAST(CAST(@CashDiscountLimitValue AS NUMERIC (18,2))AS VARCHAR(20))+',
			'''+@LicenseNumber+''','''+@DrugLicNumber+''',
			'''+@PestLicNumber+''','+CAST(@GeoMainId AS VARCHAR(10))+','+CAST(@RMId AS VARCHAR(10))+','+CAST(@VillageId AS VARCHAR(10))+','''+@ResidencePhoneNo+''','''+@OfficePhoneNo+''',
			'+CAST(CAST(@DepositAmount AS NUMERIC(18,2))AS VARCHAR(20))+','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','''+CONVERT(NVARCHAR(10),GETDATE(),121)+''','+CAST(@CoaId AS VARCHAR(10))+',0,0
			,'+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,'+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+'
			,''N'',0,0,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',0'
			
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ','''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			--RtrCode Auto Generate
			SET @sSql=@sSql + ','''+ISNULL(@RtrCodeUserInput,'')+''')'
			---Till Here
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  @CntTabname AND Fldname = @FldName
			SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname ='''+@CntTabname+''' AND Fldname ='''+@FldName+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			IF EXISTS (SELECT * FROM Retailer WHERE RtrId=@RtrId)
			BEGIN
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RetailerName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VeLUES ('+CAST(@CoaId AS VARCHAR(10))+','''+@AcCode+''','''+@RetailerName+''',4,2,2,1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				IF @PotentialClassCode<>''
				BEGIN
					DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
					SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
					INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate) VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
					SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				END
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'
				SET @sSql='UPDATE Counters SET CurrValue =CurrValue'+'+1'+' WHERE Tabname =  ''CoaMaster'' AND Fldname = ''CoaId'''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END			
		END		
		IF  @Taction=2 AND @Po_ErrNo=0
		BEGIN
			--CRCRSTPAR0070
			IF @Taction=2
			BEGIN
				
				----PARCS202100043 OR condition added RtrCodeUserInput
				DECLARE @ReturnMsg AS VARCHAR(100)
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrName',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
					BEGIN
					SET @RetailerName=(SELECT RtrName FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'RtrStatus',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @Status=(SELECT CASE RTRSTATUS WHEN 1 THEN 'Active' ELSE 'InActive' END FROM Retailer 
					WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))					
				END
				
				SET @ReturnMsg=''
				SET @ReturnMsg=(SELECT DBO.Fn_ReturnToBloackRetailerColumns(79,@RtrId,'Geography',@Taction,1000))
				IF RTRIM(LTRIM(@ReturnMsg))<>''
				BEGIN
					SET @GeoMainId=(SELECT GeoMainId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput
					OR  RtrCode =@RtrCodeUserInput))
				END
			END
			
			--Added By S.Moorthi CRCRSTPAR0001
				IF EXISTS (SELECT '*' FROM Retailer (NOLOCK) WHERE RTRID = @RtrId and (RtrName<>@RetailerName
				or RtrStatus<>(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) or ISNULL(GeoMainId,0)<>ISNULL(@GeoMainId,0)))
				BEGIN
					IF NOT EXISTS (SELECT DISTINCT RtrId FROM RetailerApprovalStatus WHERE RtrId = @RtrId)
					BEGIN
						INSERT INTO RetailerApprovalStatus(RtrId,RtrCtgId,RtrClassId,RtrStatus,
						Rtrname,Geoid,Upload,Mode,ModDate)
						SELECT @RtrId,0,0,
						CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) END,
						CASE WHEN RtrName=@RetailerName THEN '' ELSE @RetailerName END,
						CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END,
						0,2,GETDATE() FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					END
								  
					UPDATE A SET RtrName = CASE WHEN RTRIM(LTRIM(B.RtrName))=RTRIM(LTRIM(@RetailerName)) THEN '' ELSE @RetailerName END,
					RtrStatus=CASE WHEN B.RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN 2 ELSE (CASE @Status WHEN 'Active' THEN 1 ELSE 0 ENd) END,
					GeoId=CASE WHEN GeoMainId=@GeoMainId THEN 0 ELSE @GeoMainId END FROM RetailerApprovalStatus A INNER JOIN Retailer B ON A.RtrId=B.RtrId
					WHERE A.RtrId = @RtrId 
					SELECT @RetailerName=CASE WHEN RtrName=@RetailerName THEN @RetailerName ELSE RtrName END,
					@GeoMainId=CASE WHEN GeoMainId=@GeoMainId THEN @GeoMainId ELSE GeoMainId END,	
					@Status= CASE WHEN RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) THEN (CASE @Status WHEN 'Active' THEN 1 ELSE 0 END) ELSE RtrStatus END 
					FROM Retailer (NOLOCK) WHERE RtrId = @RtrId
					UPDATE R SET R.Upload='N' FROM RetailerApprovalStatus A(NOLOCK)     
					INNER JOIN  RETAILER R (NOLOCK) ON A.RTRID=R.RTRID    
					WHERE A.Upload=0 AND R.RtrId=@RtrId    
						
				END
			--Till Here
					
			UPDATE Retailer SET  RtrName=@RetailerName,RtrAdd1=@Address1,RtrAdd2=@Address2,RtrAdd3=@Address3,
			RtrPinNo=CAST (@PinCode AS INT),RtrPhoneNo=@PhoneNo,
			RtrEmailId=@EmailId,
			RtrKeyAcc=(CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrCovMode=(CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)
			,RtrRegDate=CONVERT(NVARCHAR(10),@RegistrationDate,121),
			RtrDayOff=(CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END),
			RtrStatus=(CASE @Status WHEN 'Active' THEN 1 ELSE 0 END),
			RtrTaxable=(CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END),
			RtrTaxType=(CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END),
			RtrTINNo=@TINNumber,
			RtrCSTNo=@CSTNumber,TaxGroupId=@TaxGroupId,RtrCrBills=CAST(@CreditBills AS INT),RtrCrLimit=CAST(@CreditLimit AS NUMERIC(18,2)),RtrCrDays=CAST(@CreditDays AS INT),
			RtrCashDiscPerc=CAST(@CashDiscountPercentage AS NUMERIC(18,2)),
			RtrCashDiscCond=(CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END),RtrCashDiscAmt=CAST(@CashDiscountLimitValue AS NUMERIC(18,2)),
			RtrLicNo=@LicenseNumber,RtrLicExpiryDate=CONVERT(NVARCHAR(10),@LicNumberExDate,121),RtrDrugLicNo=@DrugLicNumber,
			RtrDrugExpiryDate=CONVERT(NVARCHAR(10),@DrugLicExDate,121),RtrPestLicNo=@PestLicNumber,
			RtrPestExpiryDate=CONVERT(NVARCHAR(10),@PestLicExDate,121),GeoMainId=@GeoMainId,
			RMId=@RMId,VillageId=@VillageId,RtrResPhone1=@ResidencePhoneNo,RtrOffPhone1=@OfficePhoneNo,RtrDepositAmt=CAST(@DepositAmount AS NUMERIC(18,2)), 
			RtrType=(CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END),
			RtrFrequency=(CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END),
			RtrCrDaysAlert=(CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrBillsAlert=(CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END),
			RtrCrLimitAlert=(CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)
			WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput =@RtrCodeUserInput OR RtrCode=@RtrCodeUserInput)
				
			SET @sSql='UPDATE Retailer SET  RtrName='''+@RetailerName+''',RtrAdd1='''+@Address1+''',RtrAdd2='''+@Address2+''',RtrAdd3='''+@Address3+''',
			RtrPinNo='+CAST(CAST(@PinCode AS INT) AS VARCHAR(20))+',RtrPhoneNo='''+@PhoneNo+''',
			RtrEmailId='''+@EmailId+''',
			RtrKeyAcc='+CAST((CASE @KeyAccount WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrCovMode='+CAST((CASE @CoverageMode WHEN 'Order Booking' THEN 1 WHEN 'Counter Sales' THEN 2 WHEN 'Van Sales' THEN 3 END)AS VARCHAR(10))+'
			,RtrRegDate='''+CONVERT(NVARCHAR(10),@RegistrationDate,121)+''',
			RtrDayOff='+CAST((CASE @DayOff WHEN 'Sunday' THEN 0 WHEN 'Monday' THEN 1 WHEN 'Tuesday' THEN 2 WHEN 'Wednesday' THEN 3 WHEN 'Thursday' THEN 4 WHEN 'Friday' THEN 5 WHEN 'Saturday' THEN 6 END)AS VARCHAR(10))+',
			RtrStatus='+CAST((CASE @Status WHEN 'Active' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxable='+CAST((CASE @Taxable WHEN 'Yes' THEN 1 ELSE 0 END)AS VARCHAR(10))+',
			RtrTaxType='+CAST((CASE @TaxType WHEN 'VAT' THEN 0 ELSE 1 END)AS VARCHAR(10))+',
			RtrTINNo='''+@TINNumber+''',
			RtrCSTNo='''+@CSTNumber+''',TaxGroupId='+CAST(@TaxGroupId AS VARCHAR(10))+',RtrCrBills='+CAST(CAST(@CreditBills AS INT) AS VARCHAR(10))+',RtrCrLimit='+CAST(CAST(@CreditLimit AS NUMERIC(18,2)) AS VARCHAR(20))+',RtrCrDays='+CAST(CAST(@CreditDays AS INT) AS VARCHAR(10))+',
			RtrCashDiscPerc='+CAST(CAST(@CashDiscountPercentage AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrCashDiscCond='+CAST((CASE @CashDiscountCondition WHEN '>=' THEN 1 ELSE 0 END)AS VARCHAR(10))+',RtrCashDiscAmt='+CAST(CAST(@CashDiscountLimitValue AS NUMERIC(18,2)) AS VARCHAR(20))+',
			RtrLicNo='''+@LicenseNumber+''',RtrDrugLicNo='''+@DrugLicNumber+''',RtrPestLicNo='''+@PestLicNumber+''',GeoMainId='+CAST(@GeoMainId AS VARCHAR(10))+',
			RMId='+CAST(@RMId AS VARCHAR(20))+',VillageId='+CAST(@VillageId AS VARCHAR(20))+',RtrResPhone1='''+@ResidencePhoneNo+''',RtrOffPhone1='''+@OfficePhoneNo+''',RtrDepositAmt='+CAST(CAST(@DepositAmount AS NUMERIC(18,2)) AS VARCHAR(20))+''
					
			IF LTRIM(RTRIM(@LicNumberExDate)) IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrLicExpiryDate='''+CONVERT(NVARCHAR(10),@LicNumberExDate,121)+''''
			END
			IF LTRIM(RTRIM(@DrugLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrDrugExpiryDate='''+CONVERT(NVARCHAR(10),@DrugLicExDate,121)+''''
			END
			IF LTRIM(RTRIM(@PestLicExDate))IS NULL
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate=Null'
			END
			ELSE
			BEGIN
				SET @sSql=@sSql + ',RtrPestExpiryDate='''+CONVERT(NVARCHAR(10),@PestLicExDate,121)+''''
			END
			SET @sSql=@sSql + ',RtrType='+CAST((CASE @RetailerType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN 2 END) AS VARCHAR(10))+'
			,RtrFrequency='+CAST((CASE @RetailerFrequency WHEN 'Weekly' THEN 0 WHEN 'Bi-Weekly' THEN 1 WHEN 'Fort Nightly' THEN 2 WHEN 'Monthly' THEN 3 WHEN 'Daily' THEN 4 END) AS VARCHAR(10))+'
			,RtrCrDaysAlert='+CAST((CASE @RtrCrDaysAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrBillsAlert='+CAST((CASE @RtrCrBillAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END) AS VARCHAR(10))+'
			,RtrCrLimitAlert='+CAST((CASE @RtrCrLimitAlert WHEN 'None' THEN 0 WHEN 'Alert & Allow' THEN 1 WHEN 'Alert & Stop' THEN 2 END)AS VARCHAR(10))+''
			SET @sSql=@sSql +' WHERE RtrCode='''+@RetailerCode+''''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @CoaId=CoaId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			UPDATE CoaMAster SET AcName=@RetailerName WHERE CoaId=@CoaId
			SET @sSql='UPDATE CoaMaster SET AcName='''+@RetailerName+''' WHERE CoaId='+CAST(@CoaId AS VARCHAR(10))+''
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			SELECT @RtrId=RtrId FROM Retailer WHERE (RtrCode=@RetailerCode OR RtrCodeUserInput=@RtrCodeUserInput OR  RtrCode =@RtrCodeUserInput)
			IF @PotentialClassCode<>''
			BEGIN
				DELETE FROM RetailerPotentialClassMap WHERE RtrId=@RtrId
				SET @sSql='DELETE FROM RetailerPotentialClassMap WHERE RtrId='+CAST(@RtrId AS VARCHAR(10))+''
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121))
				SET @sSql='INSERT INTO RetailerPotentialClassMap (RtrId,RtrPotentialClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES('+CAST(@RtrId AS VARCHAR(10))+','+CAST(@RtrClassId AS VARCHAR(10))+',1,1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''',1,'''+CONVERT(NVARCHAR(10),GETDATE(),121)+''')'
				INSERT INTO Translog(strSql1) VALUES (@sSql)
			END
		END
		FETCH NEXT FROM Cur_Retailer INTO @RetailerCode,@RetailerName,@Address1,@Address2,@Address3,@PinCode,@PhoneNo,@EmailId,@KeyAccount,@CoverageMode,@RegistrationDate,@DayOff,
		@Status,@Taxable,@TaxType,@TINNumber,@CSTNumber,@TaxGroup,@CreditBills,@CreditLimit,@CreditDays,
		@CashDiscountPercentage,@CashDiscountCondition,@CashDiscountLimitValue,@LicenseNumber,
		@LicNumberExDate,@DrugLicNumber,@DrugLicExDate,@PestLicNumber,@PestLicExDate,@GeographyHierarchyValue,
		@DeliveryRoute,@VillageCode,@ResidencePhoneNo,@OfficePhoneNo,@DepositAmount,@PotentialClassCode,
		@RetailerType,@RetailerFrequency,@RtrCrDaysAlert,@RtrCrBillAlert,@RtrCrLimitAlert
	END
	CLOSE Cur_Retailer
	DEALLOCATE Cur_Retailer
	RETURN
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_TOTClaimDetails_NEW' AND TYPE='P')
DROP PROCEDURE Proc_TOTClaimDetails_NEW
GO
--EXEC Proc_TOTClaimDetails 2020,1,0,0
CREATE PROCEDURE Proc_TOTClaimDetails_NEW
(
	@Pi_Year	INT,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_TOTClaimDetails
* PURPOSE	:  TO LOAD TOT CLAIM DETAILS
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
**********************************************************************************************************************
* 24-03-2020	MOHANA S     CR   PARCS202100002	Contract Pricing Optimization
* 31-08-2020	MOHANA S	 SR	  PARLECS/0820/331	Removed GT & SUBWS
**********************************************************************************************************************/
BEGIN
SET NOCOUNT ON
	CREATE Table #TotClaimFinal       
	(      
	CtgName		NVARCHAR(100),
	Rtrid		INT,
	Prdid		INT,      
	Fromdate	DATETIME,      
	Todate		DATETIME,      
	NrmlRate	NUMERIC (18,2),      
	SecSalesTot NUMERIC (18,2),      
	DiffClaims	NUMERIC (18,2)       
	)
	DELETE FROM  TempTOTClaimDetails  
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
			 
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate 
			     
	SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)    
			
	--SELECT PRDBATID INTO #PRDBATID FROM (
	--SELECT PrdBatid FROM SalesInvoice S (NOLOCK) INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	--UNION
	--SELECT PrdBatid FROM ReturnHeader S (NOLOCK) INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0
	--)A
	--SELECT * INTO #ProductBatchDetails FROM ProductBatchDetails WHERE PrdBatid in (SELECT * FROM #PrdBatid) and slno=3
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.SplRate END As  SalSplRate,         
	SP.OrgSelRate AS ActualSelRate,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate ,RtrValueClassId        
	INTO #BillingDetails1          
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3  
			
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SIP.SplRate END As  SalSplRate,         
	SIP.OrgSelRate AS ActualSelRate,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,RtrValueClassId         
	INTO #ReturnDetails1          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)  
	INNER JOIN SalesInvoiceProduct SIP ON S.SAlid = SIP.SalId AND SP.PrdId = SIP.PrdId AND SP.PrdBatId = SIP.PrdBatId AND SIP.SLno = SP.ActSalRowId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0  
			
	SELECT DISTINCT R.RtrId,RC.CtgMainId,CtgCode,RC.CtgName,RtrValueClassId       
	INTO #Retailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId 	     
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
			
	SELECT tranid,Refid,Rtrid,CtgName,RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate, ActualSelRate SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno      
	INTO #TotClaim FROM(      
	SELECT 1 tranid,Salid Refid,A.Rtrid,CtgName,Salinvdate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid  --and A.RtrValueClassId = B.RtrValueClassId 
	UNION       
	SELECT 2 Transid,ReturnID Refid,A.Rtrid,CtgName,ReturnDate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid    --and A.RtrValueClassId = B.RtrValueClassId     
	)A   
 
	--SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM      
	--(      
	--SELECT D.PriceId,D.PrdBatDetailValue       
	--FROM #TotClaim M (NOLOCK),      
	--#ProductBatchDetails D (NOLOCK)       
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	--AND PriceCode LIKE '%-Spl Rate-%'         
	--UNION       
	--SELECT D.PriceId,D.PrdBatDetailValue       
	--FROM #TotClaim M (NOLOCK),      
	--#ProductBatchDetails D (NOLOCK)       
	--WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	--AND PriceCode LIKE '%SplRate%'        
	--)A 
	UPDATE A SET A.SplRate = (BaseQty*((A.SalSplRate)+(A.SalSplRate*(p.TaxPerc/100)))) FROM  #TotClaim A 
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate <>0  
	UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate =0
	UPDATE A SET A.NrmlRate = (BaseQty*(( ActualSelRate)+(ActualSelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid 
	UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim A    
			
	SELECT DISTINCT  B.CtgName,AttrCode ,MAX(CREATEDDATE) CREATEDDATE INTO #MAXDATE FROM SchemeClaimCircular A --WHERE  
	INNER JOIN RetailerCategory B ON A.AttrCode = B.CtgCode AND A.AttrType<>'Class'
	INNER JOIN #Retailer R ON B.CtgCode=R.CtgCode AND A.AttrCode = R.CtgCode
	AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
		WHERE ClaimType='TOT Claim' GROUP BY B.CtgName,AttrCode
	SELECT CtgName,CircularNo INTO #CIRCULAR FROM SchemeClaimCircular A INNER JOIN #MAXDATE B ON A.AttrCode = B.AttrCode AND A.CreatedDate =B.CREATEDDATE 
			  
	 

	SELECT B.CtgName INTO #Remove FROM RetailerCategory A INNER JOIN RetailerCategory B ON A.CtgMainId = B.CtgLinkID
	AND A.CtgCode IN ('GT','SUBWS') AND B.CtglevelId=2
	 
	DELETE FROM #TotClaim WHERE CtgName IN (SELECT CtgName FROM #Remove) 

 

	INSERT INTO #TotClaimFinal(CtgName,Rtrid,Prdid,NrmlRate,SecSalesTot,DiffClaims)      
	SELECT CtgName,Rtrid,Prdid,SUM(NrmlRate),SUM(SplRate),SUM(Diff) FROM #TotClaim      
	GROUP BY Ctgname,Rtrid,Prdid
			
	UPDATE A SET Fromdate = B.Frmdt ,Todate = B.todt FROM #TotClaimFinal A  
	INNER JOIN (SELECT Ctgname,MIn(RefDate) Frmdt,Max(RefDate) todt FROM #TotClaim GROUP BY CtgName) B ON A.CtgName = B.Ctgname    
			
	INSERT INTO TempTOTClaimDetails       
	SELECT CtgName,Rtrid,Prdid,Fromdate,Todate,'',SUM(NrmlRate),SUM(SecSalesTot),SUM(DiffClaims),@Pi_Usrid,@Pi_Transid
	FROM #TotClaimFinal
	WHERE DiffClaims > 0   -- SHOWING ONLY +VE VALUE AS PER AWINASH REQUEST ON 19-12-2019
	GROUP BY CtgName,Rtrid,Prdid,Fromdate,Todate
	UPDATE A SET A.CirNO = ISNULL(CircularNo,'') FROM TempTOTClaimDetails A  
	INNER JOIN #CIRCULAR B ON A.CtgName = B.CTGNAME
			
	DELETE FROM TempTOTClaimDetails WHERE ISNULL(CirNo,'')=''

	SELECT CtgName,Fromdate,Todate,SUM(NrmlAmt),SUM(TOTAmt),SUM(DiffAmt) FROM TempTOTClaimDetails
	GROUP BY CtgName,Fromdate,Todate
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_CN2CS_RouteMaster' AND TYPE='P')
DROP PROCEDURE Proc_CN2CS_RouteMaster
GO
CREATE PROCEDURE Proc_CN2CS_RouteMaster
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_CN2CS_SalesManMaster
* PURPOSE		: To Download the Route Details from Console to Core Stocky
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 08-09-2020  Deepk Philip BZ    PARLECS/0920/089    To avoid duplicate routes.
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @ErrStatus			INT
	DECLARE @sSql				NVARCHAR(2000)
	DECLARE @ErrDesc  			NVARCHAR(1000)
	DECLARE @Tabname  			NVARCHAR(50)
	DECLARE @DistCode			[nvarchar](100)
	DECLARE @Exists				INT
	DECLARE @RmId				INT
	DECLARE @CmpId AS	 INT
	
	SET @ErrStatus=1
	SET @Po_ErrNo=0
	SET @CmpId=0
	SET @Tabname = 'Cn2Cs_Prk_RouteMaster'
	
	DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_RouteMaster'
	
	SELECT @CmpId=CmpId FROM Company WHERE DefaultCompany=1
		
	CREATE TABLE #ToAvoidRoute
	( 
	  RouteCode		 NVARCHAR(200),
	  GeoLevel       NVARCHAR(200),
	  GeoCode        NVARCHAR(200)
	)
	--
	SELECT DISTINCT * INTO #Cn2Cs_Prk_RouteMaster from Cn2Cs_Prk_RouteMaster
	Delete A From Cn2Cs_Prk_RouteMaster A (nolock)
	INSERT INTO Cn2Cs_Prk_RouteMaster
	SELECT * FROM #Cn2Cs_Prk_RouteMaster

	
	SELECT PR.RMCode INTO #ParkingDuplicateRetailers FROM Cn2Cs_Prk_RouteMaster PR (NOLOCK)
	WHERE DownloadFlag = 'D' GROUP BY PR.RMCode
	HAVING COUNT(7)>1
	
	INSERT INTO #ToAvoidRoute(RouteCode)
	SELECT DISTINCT RMCODE FROM #ParkingDuplicateRetailers
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteName','Duplicate Route Code Available-'+RMCode  
	FROM #ParkingDuplicateRetailers WITH(NOLOCK) 
	
	INSERT INTO #ToAvoidRoute(RouteCode)
	SELECT DISTINCT RMCode FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK)
	WHERE ISNULL(RMCODE,'')='' OR ISNULL(RMNAME,'')='' AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteName','Route Code/Name can not be Empty-'+RMCode+'+'+RMName  
	FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE ISNULL(RMCODE,'')='' OR ISNULL(RMNAME,'')='' AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode)
	SELECT DISTINCT A.RMCode FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN ROUTEMASTER B (NOLOCK) ON A.RMCODE=B.RMCODE
	WHERE DownloadFlag = 'D'
	
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','RouteCode','Route Code Already Available-'+A.RMCode
	FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN ROUTEMASTER B (NOLOCK) ON A.RMCODE=B.RMCODE
	WHERE DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoLevel)
	SELECT DISTINCT RMCode,GeoLevel FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) WHERE GeoLevel NOT IN 
	(SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoLevelName','Route Geography Level Not Available-'+GeoLevel 
	FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE GeoLevel NOT IN (SELECT GeoLevelName FROM GeographyLevel (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoCode)
	SELECT DISTINCT RMCode,GeoValue FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) WHERE GeoValue NOT IN 
	(SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoCode','Route Geography Not Available-'+RMCode+'-'+GeoValue FROM Cn2Cs_Prk_RouteMaster WITH(NOLOCK) 
	WHERE GeoValue NOT IN (SELECT GeoCode FROM Geography (NOLOCK)) AND DownloadFlag = 'D'
	
	INSERT INTO #ToAvoidRoute(RouteCode,GeoCode)
	SELECT DISTINCT RMCODE,GeoValue FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) WHERE NOT EXISTS 
	(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId
	WHERE A.GeoLevel = B.GeoLevelName AND A.GeoValue = C.GeoCode)AND DownloadFlag = 'D'
	 
	INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)	
	SELECT DISTINCT 1,'Cn2Cs_Prk_RouteMaster','GeoCode','Route Geography Wrongly Mapped-'+RMCode+'-'+GeoLevel+'-'+GeoValue 
	FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) WHERE NOT EXISTS 
		(SELECT DISTINCT GeoLevelName,GeoCode FROM GeographyLevel B (NOLOCK) 
		INNER JOIN Geography C (NOLOCK) ON B.GeoLevelId = C.GeoLevelId 
		WHERE A.GeoLevel = B.GeoLevelName AND A.GeoValue = C.GeoCode)AND DownloadFlag = 'D'
	
	--To Insert the Sales Route Details 
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	SET @RmId=ISNULL(@RmId,0)
	
	INSERT INTO RouteMasterTrack(RMCode,RMName,Distance,RMPopulation,VanRoute,RouteType,LocalUpCountry,GeoLevel,GeoValue,Status,
						MonDay,TuesDay,WednesDay,ThursDay,FriDay,SaturDay,SunDay,CreatedDate)
	SELECT RMCode,RMName,Distance,RMPopulation,VanRoute,RouteType,LocalUpCountry,GeoLevel,GeoValue,Status,
	MonDay,TuesDay,WednesDay,ThursDay,FriDay,SaturDay,SunDay,GETDATE() FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
	INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
	WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND DownloadFlag='D'
	AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND DownloadFlag = 'D'
	
	INSERT INTO RouteMaster (RMId,RMCode,RMName,CmpId,RMDistance,RMPopulation,GeoMainId,RMVanRoute,
	RMSRouteType,RMLocalUpcountry,RMMon,RMTue,RMWed,RMThu,RMFri,RMSat,RMSun,RMstatus,UpLoad,
	Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
	SELECT DISTINCT @RmId + ROW_NUMBER() OVER (ORDER BY RMCODE,RMName) AS RmId,RMCODE,RMNAME,@CmpId,ISNULL(Distance,0),ISNULL(RMPopulation,0),GeoMainId,
	ISNULL(VanRoute,0),RouteType,ISNULL(LocalUpCountry,1),(CASE UPPER(ISNULL(MonDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS Monday,
	(CASE UPPER(ISNULL(TuesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS TuesDay,
	(CASE UPPER(ISNULL(WednesDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS WednesDay,
	(CASE UPPER(ISNULL(ThursDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS ThursDay,
	(CASE UPPER(ISNULL(FriDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS FriDay,
	(CASE UPPER(ISNULL(SaturDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS SaturDay,
	(CASE UPPER(ISNULL(SunDay,'YES')) WHEN 'YES' THEN 1 ELSE 0 END) AS SunDay,
	(CASE UPPER(ISNULL(Status,'ACTIVE')) WHEN 'ACTIVE' THEN 1 ELSE 0 END) AS RMStatus,
	'N',1,1,GETDATE(),1,GETDATE(),0
	FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
	INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
	WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND DownloadFlag='D'
	AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND DownloadFlag = 'D'
	
	SELECT @RmId = ISNULL(MAX(RMId),0) FROM RouteMaster (NOLOCK)
	UPDATE Counters SET CurrValue = @RmId WHERE TabName = 'RouteMaster' AND FldName = 'RMId'
	
	UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_RouteMaster A (NOLOCK) 
	INNER JOIN Geography B (NOLOCK) ON B.GeoCode = A.GeoValue 
	INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId 
	WHERE NOT EXISTS(SELECT RouteCode,GeoLevel,GeoCode FROM #ToAvoidRoute D WHERE D.RouteCode=A.RMCODE) AND DownloadFlag='D'
	AND ISNULL(A.RMCODE,'')<>'' AND ISNULL(A.RMName,'')<>'' AND DownloadFlag = 'D'
	
	RETURN
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE Name='Proc_Cn2Cs_RetailerMasterUpdate' AND Type='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
GO
CREATE PROCEDURE Proc_Cn2Cs_RetailerMasterUpdate
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMasterUpdate
* PURPOSE		: To Validate Retailer Master data update from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 25/06/2019
* MODIFIED
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON	  | USER STORY ID  |  CR/BZ |   REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  441		 25/06/2019	    S.Moorthi		CRCRSTPAR0069	 CR		   Need to block the edit option in Sehyog and the group, channel and status should be allowed to edit in console end and this will download and update in 
																		Sehyog end. Excel upload facility require in Console    
  443		 12-09-2020     Deepak Philip   PARLECS/0920/138 BZ        To avaoid duplicate Retailer Master Download.
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	CREATE TABLE #ToAvoidRetailer
	(
		RtrCode [nvarchar](50)
	)
	CREATE TABLE #Cn2CS_Prk_RetailerMasterUpdate(
	[RtrCode]			[nvarchar](50),
	[RetailerName]		[nvarchar](100),
	[RetailerChannal]	[nvarchar](50),
	[RetailerGroup]		[nvarchar](50),
	[RetailerClass]		[nvarchar](50),
	[RetailerStatus]	[nvarchar](50)
	)
	
	--PARLECS/0920/138
	SELECT DISTINCT * INTO #RetailerUpdate FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK)
	DELETE A FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK)
	INSERT INTO Cn2CS_Prk_RetailerMasterUpdate
	SELECT * FROM #RetailerUpdate
	
	DELETE FROM Cn2CS_Prk_RetailerMasterUpdate WHERE DownLoadFlag='Y'
	SELECT RtrCode,MAX(CreatedDate) as CreatedDate
	INTO #PrgMaxDate
	FROM Cn2CS_Prk_RetailerMasterUpdate (NOLOCK) 
	WHERE DownLoadFlag='D' GROUP BY RtrCode
	
	INSERT INTO #Cn2CS_Prk_RetailerMasterUpdate
	([RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus])
	SELECT DISTINCT A.[RtrCode],[RetailerName],[RetailerChannal],[RetailerGroup],[RetailerClass],[RetailerStatus]
	FROM Cn2CS_Prk_RetailerMasterUpdate A (NOLOCK) 
	INNER JOIN #PrgMaxDate B ON A.RtrCode=B.RtrCode and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status shoud be Active/InActive '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE RetailerStatus NOT IN ('Active','InActive')
		
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Code Not Available '+ M.RtrCode 
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(SELECT * FROM RETAILER R WHERE R.CmpRtrCode=M.RtrCode)
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')='')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Status/Name/Channel/Group/Class can not be blank '+ RtrCode
	FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE 
	(ISNULL(RetailerStatus,'')='' OR ISNULL([RetailerChannal],'')='' OR ISNULL([RetailerGroup],'')='' 
	 OR ISNULL([RetailerName],'')='' OR ISNULL([RetailerClass],'')='')
	
	
	INSERT INTO #ToAvoidRetailer(RtrCode)
	SELECT DISTINCT RtrCode FROM #Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'RetailerMasterUpdate','RtrCode','Retailer Channel/Group/Value Class details not available '+ M.RtrCode FROM
	#Cn2CS_Prk_RetailerMasterUpdate M WHERE NOT EXISTS(
	SELECT A.CtgCode,A.CtgLevelId,B.CtgCode,B.CtgLevelId,ValueClassCode  FROM RetailerCategory A 
	INNER JOIN RetailerCategory B ON B.CtgLinkId=A.CtgMainId  
	INNER JOIN RetailerValueClass C ON C.CtgMainId=B.CtgMainId 
	WHERE M.RetailerChannal=A.CtgCode AND M.RetailerGroup=B.CtgCode AND M.RetailerClass=C.ValueClassCode) 
	
	INSERT INTO RetailerMasterUpdateTrack(RtrCode,RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,OldRetailerName,OldRetailerGroup,OldRetailerClass,OldRetailerStatus,CreatedDate)	
	SELECT B.RtrCode,B.RetailerName,RetailerChannal,RetailerGroup,RetailerClass,
	RetailerStatus,A.RtrName,RC.CtgCode,RVC.ValueClassCode,A.RtrStatus,GETDATE() 
	FROM Retailer A (NOLOCK)
	INNER JOIN RetailerValueClassMap RVCM(NOLOCK) ON A.RtrId=RVCM.RtrId 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.RtrClassId=RVCM.RtrValueClassId 
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgMainId=RVC.CtgMainId 	
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)  
	
	UPDATE A SET A.RtrName=B.RetailerName,A.RtrStatus=(CASE WHEN B.RetailerStatus='Active' THEN 1 ELSE 0 END) FROM Retailer A 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate B ON A.CmpRtrCode=B.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE A.CmpRtrCode=N.RtrCode AND B.RtrCode=N.RtrCode)
	
	UPDATE A SET A.RtrValueClassId=RVC.RtrClassId FROM RetailerValueClassMap A 
	INNER JOIN Retailer B ON A.RtrId=B.RtrId
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=B.CmpRtrCode 
	INNER JOIN RetailerValueClass RVC(NOLOCK) ON RVC.ValueClassCode=M.RetailerClass
	INNER JOIN RetailerCategory RC(NOLOCK) ON RC.CtgCode=M.RetailerGroup AND RC.CtgMainId=RVC.CtgMainId 
	INNER JOIN RetailerCategory RC1(NOLOCK) ON RC1.CtgCode=M.RetailerChannal AND RC1.CtgMainId=RC.CtgLinkId  
	
	
	UPDATE C SET DownloadFlag='Y' FROM  Cn2CS_Prk_RetailerMasterUpdate C 
	INNER JOIN #Cn2CS_Prk_RetailerMasterUpdate M ON M.RtrCode=C.RtrCode 
	WHERE NOT EXISTS(SELECT * FROM #ToAvoidRetailer N  WHERE C.RtrCode=N.RtrCode) 
	
RETURN 
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_Validate_Product' AND TYPE='P')
DROP PROCEDURE Proc_Validate_Product
GO
--EXEC Proc_Validate_Product 0
CREATE PROCEDURE [dbo].[Proc_Validate_Product]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Validate_Product
* PURPOSE		: To Insert and Update records in the Table Product
* CREATED		: Nandakumar R.G
* CREATED DATE	: 17/09/2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
18-09-2020  PARLECS/0920/  Deepak Philip    To removve the wrong contract pricing detail validation.
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist     AS  INT
	DECLARE @Tabname    AS  NVARCHAR(100)
	DECLARE @DestTabname   AS  NVARCHAR(100)
	DECLARE @Fldname    AS  NVARCHAR(100)
	DECLARE @PrdDCode    AS NVARCHAR(100)
	DECLARE @PrdName   AS NVARCHAR(100)
	DECLARE @PrdShortName  AS NVARCHAR(100)
	DECLARE @PrdCCode   AS NVARCHAR(100)
	DECLARE @PrdCtgValCode  AS NVARCHAR(100)
	DECLARE @StkCoverDays  AS NVARCHAR(100)
	DECLARE @UnitPerSKU   AS NVARCHAR(100)
	DECLARE @TaxGroupCode  AS NVARCHAR(100)
	DECLARE @Weight    AS NVARCHAR(100)
	DECLARE @UnitCode   AS NVARCHAR(100)
	DECLARE @UOMGroupCode  AS NVARCHAR(100)
	DECLARE @PrdType   AS NVARCHAR(100)
	DECLARE @EffectiveFromDate AS NVARCHAR(100)
	DECLARE @EffectiveToDate AS NVARCHAR(100)
	DECLARE @ShelfLife   AS NVARCHAR(100)
	DECLARE @Status    AS NVARCHAR(100)
	DECLARE @Vending   AS NVARCHAR(100)
	DECLARE @PrdVending   AS INT
	DECLARE @EANCode  AS NVARCHAR(100)
	DECLARE @CmpId   AS  INT
	DECLARE @PrdId   AS  INT
	DECLARE @CmpPrdCtgId  AS  INT
	DECLARE @PrdCtgMainId  AS  INT
	DECLARE @SpmId   AS  INT
	DECLARE @PrdUnitId AS  INT
	DECLARE @TaxGroupId AS  INT
	DECLARE @UOMGroupId AS  INT
	DECLARE @PrdTypeId AS  INT
	DECLARE @PrdStatus AS  INT
	SET @Po_ErrNo=0
	SET @Exist=0
	SET @DestTabname='Product'
	SET @Fldname='PrdId'
	SET @Tabname = 'ETL_Prk_Product'
	SET @Exist=0
	SELECT @SpmId=SpmId FROM Supplier WITH (NOLOCK) WHERE SpmDefault=1
	DECLARE Cur_Product CURSOR
	FOR SELECT ISNULL([Product Distributor Code],''),ISNULL([Product Name],''),ISNULL([Product Short Name],''),ISNULL([Product Company Code],''),
	ISNULL([Product Hierarchy Level Value Code],''),ISNULL([Stock Cover Days],0),ISNULL([Unit Per SKU],1),
	ISNULL([Tax Group Code],''),ISNULL([Weight],0),[Unit Code],[UOM Group Code],[Product Type],CONVERT(NVARCHAR(12),[Effective From Date],121),
	CONVERT(NVARCHAR(12),[Effective To Date],121),ISNULL([Shelf Life],0),ISNULL([Status],'ACTIVE'),ISNULL([EAN Code],''),ISNULL([Vending],'NO')
	FROM ETL_Prk_Product
	OPEN Cur_Product
	FETCH NEXT FROM Cur_Product INTO @PrdDCode,@PrdName,@PrdShortName,@PrdCCode,@PrdCtgValCode,
	@StkCoverDays,@UnitPerSKU,@TaxGroupCode,@Weight,@UnitCode,@UOMGroupCode,@PrdType,@EffectiveFromDate,
	@EffectiveToDate,@ShelfLife,@Status,@EANCode,@Vending
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @Po_ErrNo=0
		SET @Exist=0
		IF NOT EXISTS(SELECT * FROM ProductCategoryValue WITH (NOLOCK) WHERE PrdCtgValCode=@PrdCtgValCode)
		BEGIN
			INSERT INTO Errorlog VALUES (1,@TabName,'Product Category Level',
			'Product Category Level:'+@PrdCtgValCode+' is not available for the Product Code: '+@PrdDCode)
			SET @Po_ErrNo=1
		END
		ELSE
		BEGIN
			SELECT @CmpId=PCL.CmpId FROM ProductCategoryLevel PCL WITH (NOLOCK),
			ProductCategoryValue PCV WITH (NOLOCK)
			WHERE PCV.PrdCtgValCode=@PrdCtgValCode AND PCV.CmpPrdCtgId=PCL.CmpPrdCtgId
			IF(SELECT ISNULL(PC.LevelName,'') FROM ProductCategoryValue PCV
			WITH (NOLOCK),ProductCategoryLevel PC WITH (NOLOCK)
			WHERE PCV.PrdCtgValCode=@PrdCtgValCode AND PC.CmpPrdCtgId=PCV.CmpPrdCtgId)<>
			(SELECT TOP 1 PC.LevelName FROM ProductCategoryLevel PC
			WHERE CmpId=@CmpId AND CmpPrdCtgId NOT IN (SELECT MAX(CmpPrdCtgId) FROM  ProductCategoryLevel PC WHERE CmpId=@CmpId)
			ORDER BY PC.CmpPrdCtgId DESC)
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Product Category Level',
				'Product Category Level:'+@PrdCtgValCode+' is not last level in the hierarchy')
				SET @Po_ErrNo=1
			END
			ELSE
			BEGIN
				SELECT @PrdCtgMainId=PrdCtgValMainId FROM ProductCategoryValue WITH (NOLOCK)
				WHERE PrdCtgValCode=@PrdCtgValCode
			END
		END
	
--		IF @Po_ErrNo=0
--		BEGIN
--			IF @TaxGroupCode<>''
--			BEGIN
--				IF NOT EXISTS(SELECT * FROM TaxGroupSetting WITH (NOLOCK)
--				WHERE PrdGroup=@TaxGroupCode)
--				BEGIN
--					INSERT INTO Errorlog VALUES (1,@TabName,'Tax Group',
--					'Tax Group:'+@TaxGroupCode+' is not available for the Product Code: '+@PrdDCode)
--					SET @Po_ErrNo=1
--				END
--				ELSE
--				BEGIN
--					SELECT @TaxGroupId=TaxGroupId FROM TaxGroupSetting WITH (NOLOCK)
--					WHERE PrdGroup=@TaxGroupCode
--				END
--			END
--			ELSE
--			BEGIN
				SET @TaxGroupId=0
--			END
--		END
	
		IF @Po_ErrNo=0
		BEGIN
			IF NOT EXISTS(SELECT * FROM UOMGroup WITH (NOLOCK) WHERE UOMGroupCode=@UOMGroupCode)
				BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'UOM Group',
				'UOM Group:'+@UOMGroupCode+' is not available for the Product Code: '+@PrdDCode)
				SET @Po_ErrNo=1
			END
			ELSE
			BEGIN
				SELECT @UOMGroupId=UOMGroupId FROM UOMGroup WITH (NOLOCK) WHERE UOMGroupCode=@UOMGroupCode
			END
		END
		IF @Po_ErrNo=0
		BEGIN
			IF @PrdType='Normal'
			BEGIN
				SET @PrdTypeId=1
			END
			ELSE IF @PrdType='Pesticide'
			BEGIN
				SET @PrdTypeId=2
			END
			ELSE IF @PrdType='Kit Product'
			BEGIN
				SET @PrdTypeId=3
			END
			ELSE IF @PrdType='Gift'
			BEGIN
				SET @PrdTypeId=4
			END
			ELSE IF @PrdType='Drug'
			BEGIN
				SET @PrdTypeId=5
			END
			ELSE IF @PrdType='Food'
			BEGIN
				SET @PrdTypeId=6
			END
			ELSE
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Product Type',
				'Product Type'+@PrdType+' is not available for the Product Code: '+@PrdDCode)
				SET @Po_ErrNo=1
			END
		END
		IF @Po_ErrNo=0
		BEGIN
			IF @PrdTypeId=3 OR @PrdTypeId=5
			BEGIN
				IF ISDATE(@EffectiveFromDate)=1 AND ISDATE(@EffectiveToDate)=1
				BEGIN
					IF DATEDIFF(DD,@EffectiveFromDate,@EffectiveToDate)<0 OR DATEDIFF(DD,GETDATE(),@EffectiveToDate)<0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Effective From Date:' + @EffectiveFromDate + 'should be less than Effective To Date:' +@EffectiveToDate +' for the Product Code: '+@PrdDCode)
						SET @Po_ErrNo=1
					END
				END
				ELSE
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Date',
					'Effective From or To Date is wrong for the Product Code: '+@PrdDCode)
					SET @Po_ErrNo=1
				END
			END
			ELSE
			BEGIN
				IF NOT ISDATE(@EffectiveFromDate)=1
				BEGIN
					SET @EffectiveFromDate=CONVERT(NVARCHAR(10),GETDATE(),121)
				END
	
				IF NOT ISDATE(@EffectiveFromDate)=1
				BEGIN
					SET @EffectiveToDate=CONVERT(NVARCHAR(10),GETDATE(),121)
				END
			END
		END
	
		IF @PrdTypeId=3
		BEGIN
			SET @EffectiveToDate=DATEADD(yy,3,@EffectiveFromDate)
		END
		
		IF @Po_ErrNo=0
		BEGIN
			IF NOT EXISTS(SELECT * FROM ProductUnit WITH (NOLOCK)
			WHERE PrdUnitCode=@UnitCode)
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Product Unit',
				'Product Unit'+@UnitCode+' is not available for the Product Code: '+@PrdDCode)
				SET @Po_ErrNo=1
			END
			ELSE
			BEGIN
				SELECT @PrdUnitId=PrdUnitId FROM ProductUnit WITH (NOLOCK)
				WHERE PrdUnitCode=@UnitCode
			END
		END
	
		IF @Po_ErrNo=0
		BEGIN
			IF UPPER(@Status)='ACTIVE' OR @Status='1'
			BEGIN
				SET @PrdStatus=1
			END
			ELSE
			BEGIN
			   SET @PrdStatus=2
			END
		END	
		IF @Po_ErrNo=0
		BEGIN
			IF UPPER(@Vending)='YES'
			BEGIN
				SET @PrdVending=1
			END
			ELSE IF UPPER(@Vending)='NO'
			BEGIN
				SET @PrdVending=0
			END
		END
		
		IF @Po_ErrNo=0
		BEGIN
			IF NOT EXISTS(SELECT * FROM Product WITH (NOLOCK) WHERE PrdCCode=@PrdCCode)
			BEGIN
				SET @Exist=0
			END
			ELSE
			BEGIN
				SET @Exist=1
				SELECT @PrdId=PrdId FROM Product WITH (NOLOCK) WHERE PrdCCode=@PrdCCode
				
				--Added By S.Moorthi 19-02-2016 PMS No.: CCRSTPAR0128
				IF EXISTS(SELECT A.PrdId FROM Product A (NOLOCK) INNER JOIN ProductBatchLocation B (NOLOCK) ON A.PrdId=B.PrdId 
				WHERE A.PrdCCode=@PrdCCode AND B.PrdBatLcnSih+B.PrdBatLcnUih+B.PrdBatLcnFre+B.PrdBatLcnRessih+B.PrdBatLcnResUih+B.PrdBatLcnResFre>0)
				BEGIN
					SET @PrdStatus=1
				END
				--Till Here			
			END
		END
		
		IF @Po_ErrNo=0
		BEGIN
			IF @Exist=0
			BEGIN
				SELECT @PrdId=dbo.Fn_GetPrimaryKeyInteger(@DestTabname,@FldName,
				CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
				
				IF @PrdId>(SELECT ISNULL(MAX(PrdId),0) FROM Product(NOLOCK))
				BEGIN
					INSERT INTO Product(PrdId,PrdName,PrdShrtName,PrdDCode,PrdCCode,SpmId,StkCovDays,PrdUpSKU,
					PrdWgt,PrdUnitId,UomGroupId,TaxGroupId,PrdType,EffectiveFrom,EffectiveTo,PrdShelfLife,PrdStatus,
					CmpId,PrdCtgValMainId,Availability,LastModBy,LastModDate,AuthId,AuthDate,
					IMEIEnabled,IMEILength,EANCode,Vending,XmlUpload)
					VALUES(@PrdId,@PrdName,@PrdShortName,@PrdDCode,@PrdCCode,@SpmId,@StkCoverDays,@UnitPerSKU,@Weight,
					@PrdUnitId,@UOMGroupId,@TaxGroupId,@PrdTypeId,@EffectiveFromDate,@EffectiveToDate,@ShelfLife,
					@PrdStatus,@CmpId,@PrdCtgMainId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),
					GETDATE(),121),0,0,@EANCode,ISNULL(@PrdVending,0),0)
					UPDATE Counters SET CurrValue=@PrdId WHERE TabName=@DestTabname AND FldName=@FldName
					
					--Added By Sathishkumar Veeramani 2014/07/14 ContractPricing Details Updated
					------DELETE A FROM ContractPricingDetails A (NOLOCK) INNER JOIN ContractPricingMaster B (NOLOCK) ON A.ContractId = B.ContractId
					------WHERE B.DisplayMode = 1 AND A.PrdId = @PrdId
					
					------INSERT INTO ContractPricingDetails (ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,
					------LastModBy,LastModDate,AuthId,AuthDate,CtgValMainId,ClaimablePercOnMRP)
					------SELECT DISTINCT ContractId,PrdId,0 AS PrdBatId,0 AS PriceId,Discount,FlatAmtDisc,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),
					------1,CONVERT(NVARCHAR(10),GETDATE(),121),CtgValMainId,0 AS ClaimablePercOnMRP FROM (
					------SELECT DISTINCT MAX(A.ContractId) AS ContractId,CtgLevelId,CtgMainId,RtrClassId,E.PrdId,Discount,
					------FlatAmtDisc,B.CtgValMainId FROM ContractPricingMaster A (NOLOCK) 
					------INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId = B.ContractId
					------INNER JOIN ProductCategoryValue C (NOLOCK) ON A.CmpPrdCtgId = C.CmpPrdCtgId AND B.CtgValMainId = C.PrdCtgValMainId
					------INNER JOIN ProductCategoryValue D (NOLOCK) ON D.PrdCtgValLinkCode LIKE C.PrdCtgValLinkCode+'%'
					------INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
					------WHERE A.DisplayMode = 1 AND E.PrdId = @PrdId GROUP BY CtgLevelId,CtgMainId,RtrClassId,E.PrdId,Discount,FlatAmtDisc,B.CtgValMainId)Qry
					--Added By Sathishkumar Veeramani 2014/07/14 Till Here
				END
				ELSE
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'System Date',
					'System is showing Date as :'+GETDATE()+'. Please change the System Date/Reset the Counters')
					SET @Po_ErrNo=1
				END
			END
			ELSE
			BEGIN
				EXEC Proc_DependencyCheck 'Product',@PrdId
				IF (SELECT COUNT(*) FROM TempDepCheck)>0
				BEGIN				
					UPDATE Product SET  SpmId=@SpmId,StkCovDays=@StkCoverDays,PrdUpSKU=@UnitPerSKU,
					EffectiveFrom=@EffectiveFromDate,EffectiveTo=@EffectiveToDate,PrdShelfLife=@ShelfLife,
					PrdStatus=@PrdStatus,EanCode=@EANCode,Vending=ISNULL(@PrdVending,0),PrdCtgValMainId=@PrdCtgMainId
					WHERE PrdId=@PrdId
					/*UPDATE Product SET SpmId=@SpmId,StkCovDays=@StkCoverDays,PrdUpSKU=@UnitPerSKU,
					EffectiveFrom=@EffectiveFromDate,EffectiveTo=@EffectiveToDate,PrdShelfLife=@ShelfLife,
					PrdStatus=@PrdStatus,EanCode=@EANCode,Vending=ISNULL(@PrdVending,0),PrdCtgValMainId=@PrdCtgMainId
					WHERE PrdId=@PrdId
					*/
				END
				ELSE
				BEGIN
					UPDATE Product SET  SpmId=@SpmId,StkCovDays=@StkCoverDays,PrdUpSKU=@UnitPerSKU,
					UOMGroupId=@UOMGroupId,PrdType=@PrdTypeId,
					EffectiveFrom=@EffectiveFromDate,EffectiveTo=@EffectiveToDate,
					PrdShelfLife=@ShelfLife,PrdStatus=@PrdStatus,EanCode=@EANcode,Vending=ISNULL(@PrdVending,0),PrdCtgValMainId=@PrdCtgMainId
					WHERE PrdId=@PrdId
				END
			END
		END
	
		FETCH NEXT FROM Cur_Product INTO @PrdDCode,@PrdName,@PrdShortName,@PrdCCode,@PrdCtgValCode,
		@StkCoverDays,@UnitPerSKU,@TaxGroupCode,@Weight,@UnitCode,@UOMGroupCode,@PrdType,@EffectiveFromDate,
		@EffectiveToDate,@ShelfLife,@Status,@EANCode,@Vending
	END
	CLOSE Cur_Product
	DEALLOCATE Cur_Product
	SET @Po_ErrNo=0
	RETURN
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_TaxSetting' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_TaxSetting
GO
/*
BEGIN TRANSACTION
EXEC Proc_CN2CS_TaxSetting 0
--SELECT * FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
--SELECT * FROM TaxSettingEffectiveDate
--SELECT * FROM ErrorLog
SELECT * FROM TaxSettingMaster
--SELECT * FROM TaxSettingDetail
--SElect * from Etl_Prk_TaxSetting
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_TaxSetting
(
	@Po_ErrNo INT OUTPUT
)
AS
/*************************************************************************************************************
* PROCEDURE	: Proc_CN2CS_TaxSetting
* PURPOSE	: To Store TaxGroup Setting records  from xml file in the Table TaxGroupSetting
* CREATED	: Mahalakshmi.A
* CREATED DATE	: 20/08/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------------------
* {date}		{developer}		{brief modification description}
* 07/09/2009    Nandakumar R.G  Change the validations for Tax on Tax and other basic validations
* 09.09.2009    Panneer			Update the Download Flag in Parking Table
* 19/08/2010    Nandakumar R.G  Discount Validation Changes
* 28/04/2011    Nandakumar R.G  Discount Validation Changes
* 25/04/2017    Murugan.R		GST Migration (Taxtype,EffectiveFrom,Status)
* 28-05-2019	MOHANA S		ILCRSTPAR4626			TO VALIDATE KERALA DISTRIBUTORS
* 19-09-2020	MOHANA S		PARLESECS/0720/130		KERALA TAX ISSUE FIX
**************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @TaxGroupCode	 AS NVARCHAR(200)
	DECLARE @Type			 AS NVARCHAR(200)
	DECLARE @PrdTaxGroupCode AS NVARCHAR(200)
	DECLARE @TaxCode		 AS NVARCHAR(200)
	DECLARE @Percentage	     AS NUMERIC(38,6)
	DECLARE @ApplyOn		 AS NVARCHAR(100)
	DECLARE @Discount		 AS NVARCHAR(100)
	DECLARE @Tabname		 AS NVARCHAR(100)
	DECLARE @ErrDesc		 AS NVARCHAR(1000)
	DECLARE @sSql			 AS NVARCHAR(4000)
	DECLARE @ErrStatus		 AS INT
	DECLARE @Taction		 AS INT
	DECLARE @TaxSeqId	 AS INT
	DECLARE @RtrId		 AS INT
	DECLARE @PrdId		 AS INT
	DECLARE @BillSeqId	 AS INT
	DECLARE @Slno		 AS INT
	DECLARE @ColNo		 AS INT
	DECLARE @iCntColNo	 AS INT
	DECLARE @iColType	 AS INT
	DECLARE @ColValue	 AS INT
	DECLARE @RowId		 AS INT
	DECLARE @TaxId		 AS INT
	DECLARE @iApplyOn	 AS INT
	DECLARE @iDiscount	 AS INT
	DECLARE @DColNo		 AS INT
	DECLARE @FieldDesc	 AS NVARCHAR(100)
	DECLARE @SColNo		 AS INT
	DECLARE @ColId		 AS INT
	DECLARE @SlNo1		 AS INT
	DECLARE @SlNo2		 AS INT
	DECLARE @BillSeqId_Temp	AS	INT
	DECLARE @EffetOnTax		AS	INT
	DECLARE @SchDiscount		 AS NVARCHAR(100)
	DECLARE @DBDiscount		 AS NVARCHAR(100)
	DECLARE @CDDiscount		 AS NVARCHAR(100)
	DECLARE @FreightCharge   AS NVARCHAR(100)
	DECLARE @TaxType	 AS NVARCHAR(20)
	DECLARE @EffectiveFrom			 AS DATETIME
	DECLARE @ActivationFlag			 AS TinyInt
	/*
		SET @iColType=1   For TaxPercentage Value Column
		SET @iColType=2	  For MRP,SellingRate,PurchaseRate , Bill Column Sequence Value and Purchase Column Sequence
		SET @iColType=3   For Tax Configuration TaxCode Column Value
		SET @ColValue=0	  For "NONE"
		SET @ColValue=1   For "ADD"
		SET @ColValue=2   For "REDUCE"		
	*/
	
	--FOR KERALA TAX ISSUE. PARLESECS/0720/130:
	EXEC Proc_Cn2Cs_DistributorInfo @Po_ErrNo

	DECLARE @Prdid1 INT
	SELECT @Prdid1 = ISNULL(TaxGroupId,0)  FROM TaxGroupSetting WHERE   prdgroup='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0'
	UPDATE A SET EffectiveFrom ='2017-07-01'  FROM TaxSettingMaster A  WHERE PrdId = @Prdid
	Update A set EffectiveFrom ='2017-07-01' from Etl_Prk_TaxSetting A where PrdTaxGroupCode ='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0' 
	
	SET @Tabname = 'Etl_Prk_TaxSetting'
	SET @Po_ErrNo=0
	SET @iCntColNo=0
	DECLARE @TblColNo TABLE
	(
		ColNo			INT IDENTITY(0,1) NOT NULL,
		SlNo1			INT,
		SlNo2			INT,
		FieldDesc		NVARCHAR(50)
	)
	DECLARE @T1 TABLE
	(
		SlNo			INT,
		FieldDesc		NVARCHAR(50)
	)
	DELETE FROM Etl_Prk_TaxSetting WHERE DownLoadFlag='Y'
	SET @ActivationFlag=0
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate and ModuleId='GSTConfig')
	BEGIN
		SELECT @ActivationFlag=1
	END
	
		
	--ADDED BY MOHANA ILCRSTPAR4626
	DECLARE @GSTIN AS NVARCHAR(100)
	DECLARE @SCode AS NVARCHAR(100)
	DECLARE @DSName  AS NVARCHAR(100)
	SELECT @GSTIN = C.ColumnValue  FROM UdcHD A(NOLOCK) 
	INNER JOIN UdcMaster B(NOLOCK) ON A.Masterid = B.Masterid AND A.MasterName='Distributor Info Master' 
	INNER JOIN UdcDetails C(NOLOCK) ON A.Masterid = C.Masterid AND B.UdcMasterId = C.UdcMasterId AND B.ColumnName ='GSTIN'
	SELECT  @DSName = C.ColumnValue FROM UdcHD A(NOLOCK) 
	INNER JOIN UdcMaster B(NOLOCK) ON A.Masterid = B.Masterid AND A.MasterName='Distributor Info Master' 
	INNER JOIN UdcDetails C(NOLOCK) ON A.Masterid = C.Masterid AND B.UdcMasterId = C.UdcMasterId AND B.ColumnName ='STATE NAME'
	SELECT @SCode = STATECODE FROM StateMaster(NOLOCK) WHERE StateName  ='KERALA'
	IF (LEFT(ISNULL(@GSTIN,''),2)<>@Scode) AND (UPPER(ISNULL(@DSName,''))<>'KERALA')
	BEGIN
			INSERT INTO Etl_Prk_TaxSetting_CESS 
			SELECT * FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D' 
			DELETE FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D' AND TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS',
			'SGSTCESS','OutputGSTCESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS',
			'InputCGSTCESS','InputSGSTCESS','InputGSTCESS','CESS', 'INputIGSTCESS','INputUTGSTCESS')
	END
	--TILL HERE ILCRSTPAR4626
	SELECT DISTINCT ISNULL(TaxGroupCode,'') as TaxGroupCode,ISNULL(Type,'') as Type,ISNULL(PrdTaxGroupCode,'') as PrdTaxGroupCode,
	ISNULL(TaxType,'VAT') as TaxType,
	MAX(ISNULL(EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))) as EffectiveFrom
	INTO #EtlTaxSettings
	FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
	GROUP BY ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),ISNULL(TaxType,'VAT')
	
	
	DELETE A FROM Etl_Prk_TaxSetting A (NOLOCK)	
	INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))<>ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	
	
	SELECT DISTINCT DistCode,A.TaxGroupCode,A.Type,A.PrdTaxGroupCode,A.TaxCode,
	Percentage,ApplyOn,Discount,SchDiscount,DBDiscount,CDDiscount,ApplyTax,
	DownloadFlag,CreatedDate,A.TaxType,A.EffectiveFrom,FreightCharge
	INTO #Etl_Prk_Tax
	FROM Etl_Prk_TaxSetting A (NOLOCK) INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))=ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	DECLARE Cur_TaxSettingMaster CURSOR		--TaxSettingMaster Cursor
	FOR SELECT DISTINCT ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),TaxType,EffectiveFrom
	FROM #EtlTaxSettings
	-- WHERE DownloadFlag='D'
	OPEN Cur_TaxSettingMaster
	FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	WHILE @@FETCH_STATUS=0
	BEGIN
		--Check the Empty Values for TaxSetting Master
		SET @iCntColNo=6
		IF @TaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Tax Group Code: ' + @TaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Group code',@ErrDesc)
		END
		IF @Type=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Type ' + @Type + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		IF @PrdTaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Product Tax Group Code ' + @PrdTaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		--Till Here
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE RtrGroup = @TaxGroupCode) --Get the Retailer/Supplier TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'TaxGroupCode ' + @TaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @RtrId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup= @TaxGroupCode
		END
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE PrdGroup = @PrdTaxGroupCode) --Get the Product TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'Product TaxGroupCode ' + @PrdTaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Product Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @PrdId=TaxGroupId FROM TaxGroupSetting WHERE PrdGroup= @PrdTaxGroupCode
		END
		
		DELETE FROM @T1
		IF UPPER(@Type)='RETAILER'
		BEGIN
			SELECT DISTINCT @BillSeqId=BillSeqId FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			SELECT @iCntColNo=@iCntColNo+COUNT(BillSeqId) FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc
			FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo <
			(SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) Order By SlNo
		END
		ELSE IF UPPER(@Type)='SUPPLIER'
		BEGIN
			SELECT DISTINCT @BillSeqId=PurSeqId FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			
			SELECT @iCntColNo=@iCntColNo+COUNT(PurSeqId) FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))
			and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster) Order By SlNo
		END
		SELECT @iCntColNo=@iCntColNo+(COUNT(TaxId)) FROM TaxConfiguration
		SELECT @TaxSeqId= dbo.Fn_GetPrimaryKeyInteger('TaxSettingMaster','TaxSeqId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
		IF  @Po_ErrNo=0
		BEGIN	
			INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxType,EffectiveFrom,Status)
			VALUES(@TaxSeqId,@RtrId,@PrdID,CONVERT(NVARCHAR(11),GETDATE(),121),1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121),@TaxType,@EffectiveFrom,
			CASE @TaxType WHEN  'VAT' THEN 1 
									  ELSE 
										  CASE @ActivationFlag 
										  WHEN 1 THEN 1							
										  ELSE 0 
										  END  
									  END)
			SET @sSql= 'INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@TaxSeqId AS NVARCHAR(100)) + ',' + CAST(@RtrId AS NVARCHAR(100)) +','+ CAST(@PrdId AS NVARCHAR(100))+ ','''
						+ CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,1,''' + CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,'''+ CONVERT(NVARCHAR(11),GETDATE(),121)+ ''')'
						
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE	Tabname = 'TaxSettingMaster' AND Fldname = 'TaxSeqId'
			
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSettingMaster'' AND Fldname = ''TaxSeqId'''
			
			INSERT INTO Translog(strSql1) Values (@sSQL)
		END
		
		DECLARE @TaxSettingTable TABLE
		(
			TaxId			INT,
			TaxGrpCode		NVARCHAR(200),
			Type			NVARCHAR(200),
			TaxPrdGrpCode	NVARCHAR(200),
			TaxCode			NVARCHAR(200),
			Percentage		NUMERIC(38,6),
			Applyon			NVARCHAR(200),
			Discount		NVARCHAR(200),
			SchDiscount		NVARCHAR(200),
			DBDiscount		NVARCHAR(200),
			CDDiscount		NVARCHAR(200),
			FreightCharge   NVARCHAR(200)
		)
		DELETE FROM @TaxSettingTable
		INSERT INTO @TaxSettingTable (TaxId,TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,
		SchDiscount,DBDiscount,CDDiscount,FreightCharge)
		SELECT DISTINCT TC.TaxId, ISNULL(ETL1.TaxGroupCode,''),ISNULL(ETL1.Type,''),
		ISNULL(ETL1.PrdTaxGroupCode,''),ISNULL(TC.TaxCode,''),ISNULL(ETL1.Percentage,0),
		ISNULL(ETL1.ApplyOn,'None'),ISNULL(ETL1.Discount,'None'),ISNULL(ETL1.SchDiscount,'None'),
		ISNULL(ETL1.DBDiscount,'None'),ISNULL(ETL1.CDDiscount,'None'),ISNULL(ETL1.FreightCharge,'None') 
		FROM
		(SELECT ISNULL(ETL.TaxGroupCode,'') AS TaxGroupCode,ISNULL(ETL.Type,'') AS Type,ISNULL(ETL.TaxCode,'') AS TaxCode,
		ISNULL(ETL.PrdTaxGroupCode,'') AS PrdTaxGroupCode,ISNULL(ETL.Percentage,0) AS Percentage,ISNULL(ETL.ApplyOn,'') AS ApplyOn,
		ISNULL(ETL.Discount,'') AS Discount,ISNULL(ETL.SchDiscount,'') AS SchDiscount,ISNULL(ETL.DBDiscount,'') AS DBDiscount,
		ISNULL(ETL.CDDiscount,'') AS CDDiscount,ISNULL(ETL.FreightCharge,'') AS FreightCharge
		FROM Etl_Prk_TaxSetting ETL
		WHERE DownloadFlag='D' AND TaxGroupCode=@TaxGroupCode AND PrdTaxGroupCode=@PrdTaxGroupCode) ETL1
		RIGHT OUTER JOIN TaxConfiguration TC ON TC.TaxCode=ETL1.TaxCode
		SET @RowId=0
		DECLARE Cur_TaxSettingDetail CURSOR		--TaxSettingDetail Cursor
		FOR SELECT TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,SchDiscount,DBDiscount,CDDiscount,FreightCharge
		FROM @TaxSettingTable Order By TaxId
		OPEN Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
		@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @RowId=@RowId+1
			--Nanda
			--SELECT @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount
			
			IF @TaxCode=''	--Check Empty Values For TaxSetting Details
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Tax Code' + @TaxCode + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			
			IF @Percentage<0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Percentage' + CAST(@Percentage AS NVARCHAR(20)) + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Percentage',@ErrDesc)
			END
			IF @Applyon=''
			BEGIN
				SET @iApplyOn=0
			END
			ELSE IF UPPER(@ApplyOn)='SELLINGRATE' OR UPPER(@ApplyOn)='MRP' OR UPPER(@ApplyOn)='PURCHASERATE'
			BEGIN
				SET @iApplyOn=1
			END
			ELSE
			BEGIN
				SET @iApplyOn=2
			END
			IF @Discount='ADD'
			BEGIN
				SET @iDiscount=1
			END
			ELSE IF UPPER(@Discount)='REDUCE'
			BEGIN
				SET @iDiscount=2
			END
			ELSE
			BEGIN
				SET @iDiscount=0
			END		
			--Till Here
			IF NOT EXISTS  (SELECT * FROM TaxConfiguration WHERE TaxCode = @TaxCode )
			BEGIN
				SET @Po_ErrNo=1
				SET @ErrDesc = 'Tax Code: ' + @TaxCode + ' is not available' 		
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxId=TaxId FROM TaxConfiguration WHERE TaxCode=@TaxCode	
			END
			DELETE FROM @TblColNo
			INSERT INTO @TblColNo(SlNo1,SlNo2,FieldDesc)
			SELECT 1,1,'TaxID' AS FieldDesc
			UNION
			SELECT 2,1,'Tax Name' AS FieldDesc
			UNION
			SELECT 3,1,'Tax%' AS FieldDesc
			UNION
			SELECT 4,1,'MRP' AS FieldDesc
			UNION
			SELECT 5,1,'SELLING RATE' AS FieldDesc
			UNION
			SELECT 6,1,'PURCHASE RATE' AS FieldDesc
			UNION
			SELECT 7,Slno,FieldDesc FROM @T1
			UNION
			SELECT 8,TaxId,TaxName FROM TaxConfiguration
			
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,1,@SlNo,@BillSeqId,@TaxSeqId,1,@TaxId,@TaxId,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
			
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',1,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,' + CAST(@TaxId AS NVARCHAR(100)) + ',' +CAST(@TaxId AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,3,@SlNo,@BillSeqId,@TaxSeqId,1,0,@Percentage,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',3,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,0,' +CAST(@Percentage AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SET @sColNo=4
			
			--------TaxSetting1-->Price Settings---------------------
			DECLARE Cur_TaxSetting1 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,FieldDesc FROM @TblColNo WHERE SlNo1>3 AND SlNo1<7
			OPEN Cur_TaxSetting1
			FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			WHILE @@FETCH_STATUS=0
			BEGIN
				IF @sColNo=4 AND UPPER(@ApplyOn)='MRP'
				BEGIN
					--SET MRP as 1 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=5 AND UPPER(@ApplyOn)='SELLINGRATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Selling Rate Value as 1
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',5,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=6 AND UPPER(@ApplyOn)='PURCHASERATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 1						
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF EXISTS(SELECT TaxCode FROM TaxConfiguration WHERE TaxCode=@ApplyOn) OR UPPER(@ApplyOn)='NONE'
				BEGIN					
					IF @sColNo=4
					BEGIN
						--SET MRP as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					END
					ELSE IF @sColNo=5
					BEGIN
						--SET Sellling Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
						
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @sColNo=6
					BEGIN
						--SET Purchase Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
												
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END	
--				--Nanda
--				SELECT * FROM TaxSettingDetail WHERE TaxSeqId=@TaxSeqId AND RowId=@RowId
				SET @sColNo=@sColNo+1
	
				FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			END
			CLOSE Cur_TaxSetting1
			DEALLOCATE Cur_TaxSetting1
			-----TaxSetting1--------------------------------
			----------------TaxSetting2-->Bill/Purchase Column Sequnce Settings---------------------
			SET @sColNo=7
			SET @ColId=4
			--Nanda
			--SELECT ColNo,SlNo1,FieldDesc FROM @TblColNo WHERE SlNo1=7
			DECLARE Cur_TaxSetting2 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR
				SELECT ColNo,SlNo1,FieldDesc,SlNo2  FROM @TblColNo WHERE SlNo1=7
			OPEN Cur_TaxSetting2
			FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				
				SET @EffetOnTax=0
				IF UPPER(@Type)='RETAILER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(BillSeqId) FROM dbo.BillSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.BillSequenceDetail WHERE BillSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					--->Added By Nanda on 28/04/2011										
					IF @FieldDesc='Spl. Disc' 
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='Sch Disc' 
					BEGIN
						IF UPPER(@SchDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@SchDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='DB Disc' 
					BEGIN
						IF UPPER(@DBDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@DBDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='CD Disc'
					BEGIN
						IF UPPER(@CDDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@CDDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					--->Till Here
				END
				ELSE IF UPPER(@Type)='SUPPLIER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(PurSeqId) FROM dbo.PurchaseSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.PurchaseSequenceDetail WHERE PurSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					
					IF UPPER(@FieldDesc)='FREIGHTCHARGES' 
					BEGIN
						IF UPPER(@FreightCharge)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@FreightCharge)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
				     END
				     ELSE IF UPPER(@FieldDesc) = 'DISC'
					 BEGIN
					    IF UPPER(@Discount)='ADD'
					    BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END
					 END
					 ELSE
					 BEGIN
					     SET @iDiscount=0
					 END
				END			        		 
									
				IF @iApplyOn=2
				BEGIN
					SET @EffetOnTax=0
				END				
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
				ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				--VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@EffetOnTax,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@iDiscount,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,'+ CAST(@ColId AS NVARCHAR(100))+ ',' +CAST(@EffetOnTax AS NVARCHAR(100))+',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
				INSERT INTO Translog(strSql1) Values (@sSQL)					
				SET @sColNo=@sColNo+1
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting2
			DEALLOCATE Cur_TaxSetting2
			------TaxSetting2-----------------------
			-------TaxSetting3-->Tax On Tax Settings-----------------------
			SET @sColNo=@sColNo
			SET @ColId=1
			
			DECLARE Cur_TaxSetting3 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,SlNo1,FieldDesc,SlNo2 FROM @TblColNo WHERE SlNo1=8 AND SlNo2<>@TaxId
			OPEN Cur_TaxSetting3
			FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				IF @iApplyOn<>2
				BEGIN
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
					CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT * FROM TaxConfiguration WHERE TaxCode=@Applyon AND TaxId=@SlNo2)
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,@SlNo2,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @iApplyOn=1
					END
					ELSE
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					END
				END
				SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',3,'+ CAST(@TaxId AS NVARCHAR(100))+ ',0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting3
			DEALLOCATE Cur_TaxSetting3
			UPDATE Etl_Prk_TaxSetting  SET DownloadFlag = 'Y'
			WHERE TaxGroupCode = @TaxGroupCode AND TaxCode = @TaxCode AND Percentage = @Percentage
			AND Type = @Type AND PrdTaxGroupCode = @PrdTaxGroupCode
			FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
			@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		END
		CLOSE Cur_TaxSettingDetail
		DEALLOCATE Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	END
	CLOSE Cur_TaxSettingMaster
	DEALLOCATE Cur_TaxSettingMaster	
	UPDATE TaxSettingDetail SET ColVal=0 WHERE ColId=1 AND ColType=2 AND CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10))
	NOT IN (SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId IN(SELECT TaxId FROM TaxConfiguration WHERE TaxCode='VAT'))
	AND  CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) IN (
	SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId=0 AND ColVal=0)
	
	----Retailer Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Retailer' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @RtrTaxGroupId AS NUMERIC(18,0)
	--	SET @RtrTaxGroupId = 0
	--	SELECT @RtrTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 1
	--	IF @RtrTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Retailer SET TaxGroupId = @RtrTaxGroupId
	--	END
	--END
	----Till Here
	----Supplier Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Supplier' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @SupTaxGroupId AS NUMERIC(18,0)
	--	SET @SupTaxGroupId = 0
	--	SELECT @SupTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 3
	--	IF @SupTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Supplier SET TaxGroupId = @SupTaxGroupId
	--	END
	--END
	----Till Here
	
	RETURN
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_CostCenterNotAvailable' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_CostCenterNotAvailable
GO
CREATE PROCEDURE Proc_Cs2Cn_CostCenterNotAvailable
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_ClaimMismatchDetails
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM IF Claim NOT Upload 
* DATE		:  21-12-2019
* CREATED	:  MOHANA S	
* PMS NO	:  ILCRSTPAR7092
******************************************************************************
* 17-02-2020	MOHANA S		BZ			ILCRSTPAR7916			Insert 0 as Cost Centre if CC not available
* 06-07-2020    Deepak Philip   BZ          PARLESECS/0720/027      Upload blocked.
* 11-09-2020	MOHANA S		SR			PARLESECS/0920/047		Data not available in New Site
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	
	SELECT @DistCode = DistributorCode FROM Distributor
	
	DELETE FROM Cs2Cn_Prk_CostCenterNotAvailable  WHERE UploadFlag ='Y'
	--RETURN

	EXEC Proc_GR_Build_PH --PARLESECS/0920/047
	 
	DECLARE @CmpPrdCtgId INT
	SELECT @CmpPrdCtgId = CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName ='BRAND'
	
	
	--INSERT INTO Cs2Cn_Prk_CostCenterNotAvailable (DistCode,BrandCode,UploadFlag,ServerDate)
	--SELECT @DistCode,PrdCtgValCode,'N',@ServerDate FROM ProductCategoryValue WHERE CmpPrdCtgId =@CmpPrdCtgId 
	--		AND  PrdCtgValCode NOT IN (SELECT DISTINCT BrandCode  FROM CostCentreDetails) 
	
	--ILCRSTPAR7916
	DECLARE @Brand TABLE
	(
	BrandCode NVARCHAR(100)
	)
	INSERT INTO @Brand
	SELECT DISTINCT Brand_Code  FROM Stockledger A (NOLOCK) 
	INNER JOIN TBL_GR_BUILD_PH B (NOLOCK) ON A.PrdId = B.PrdId 
	INNER JOIN Product P(NOLOCK) ON B.PrdId = P.PrdId AND A.Prdid = P.Prdid AND P.PrdStatus = 1 AND Category_Code NOT IN ('C00','K') 
	--WHERE Transdate>=CONVERT(VARCHAR(10),  DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE())-3, 0) ,121) AND Category_Code NOT IN ('C00','K') 
	
	INSERT INTO CostCentreDetails (BrandCode,Flavour,PKTMRP,CostCenter,CostCenterDesc,DownloadedDate)
	SELECT DISTINCT  PrdCtgValCode,'','',0,'',GETDATE() FROM ProductCategoryValue A (NOLOCK) INNER JOIN @Brand C ON A.PrdCtgValCode = C.BrandCode
	WHERE A.CmpPrdCtgId =@CmpPrdCtgId AND  A.PrdCtgValCode NOT IN (SELECT DISTINCT BrandCode  FROM CostCentreDetails(NOLOCK))
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_BackupUploadDailyOnceFlag' AND XTYPE='P')
DROP PROCEDURE Proc_BackupUploadDailyOnceFlag
GO
CREATE PROCEDURE Proc_BackupUploadDailyOnceFlag(@Pi_ErrNo INT OUTPUT)
/************************
* PROCEDURE		: Proc_OneTimeUpload
* PURPOSE		: Proc_OneTimeUpload
* CREATED		: S.Moorthi
* CREATED DATE	: 2020-07-13
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
* CR NO :CCRSTJNJ0272
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
11-09-2020   S.MOORTHI			BZ      PARLECS/0920/062		same date multiple backup showing in AWS
***************************/
AS
BEGIN
SET @Pi_ErrNo=0
	IF EXISTS(SELECT * FROM DatabaseBackupDetails WHERE FileUploaded=0)
	BEGIN
	
		SELECT Convert(VARCHAR(10),DBBacupDate,121) AS BackUpDate,MAX(Slno) AS Slno INTO #TempToFlag 
		FROM DatabaseBackupDetails WHERE FileUploaded=0 GROUP BY COnvert(VARCHAR(10),DBBacupDate,121)
		
		SELECT DISTINCT COnvert(VARCHAR(10),DBBacupDate,121) AS BackUpDate INTO #Temp1 FROM 
		DatabaseBackupDetails WHERE FileUploaded=1 and ServerUploadFlag<>2
		
		SELECT TOP 2 * INTO #TempToUploadLast2Backup FROM #TempToFlag ORDER BY Slno DESC ---PARLECS/0920/062
		

		IF EXISTS(SELECT * FROM #Temp1)
		BEGIN
			UPDATE  A SET  A.FileUploaded=1,ServerUploadFlag=1 from DatabaseBackupDetails A 
			INNER JOIN #Temp1 B ON  B.BackUpDate=COnvert(VARCHAR(10),A.DBBacupDate,121)
			WHERE ServerUploadFlag=0 and 
			ZipFileName not in (SELECT sFileName FROM DB_Backup_ErrorLog where ErrDescription='Successfully uploaded')
		END
		
		IF EXISTS(SELECT * FROM #TempToFlag)
		BEGIN
			UPDATE B SET B.FileUploaded=1,ServerUploadFlag=1 FROM #TempToFlag A 
			INNER JOIN DatabaseBackupDetails B ON A.BackUpDate=COnvert(VARCHAR(10),B.DBBacupDate,121)
			WHERE FileUploaded=0 and ServerUploadFlag=0 --AND A.Slno<>B.Slno
			and B.Slno NOT IN (SELECT SlNo From #TempToUploadLast2Backup)
		END
		
	--	IF EXISTS(SELECT *  FROM MANUALCONFIGURATION WHERE MODULEID='S3BACKUP3' AND Status=1 AND ISNULL(ConfigValue,0)>1)
	--	BEGIN
	--		DECLARE @Cnt AS INT
	--		DECLARE @TotCnt AS INT
	--		SELECT @Cnt=ISNULL(ConfigValue,0)  FROM MANUALCONFIGURATION WHERE MODULEID='S3BACKUP3' AND Status=1 
	--		IF @Cnt<>0
	--		BEGIN
				
	--			SELECT ROW_NUMBER() OVER(ORDER BY SLNO) AS RowNo,B.Slno,B.ZipFileName INTO #TempToDelete FROM DB_Backup_ErrorLog A 
	--			INNER JOIN DatabaseBackupDetails B ON A.sFileName=B.ZipFileName
	--			WHERE ErrDescription='Successfully uploaded'
	--			AND ZipFileName NOT IN (SELECT sFileName FROM DB_Backup_AWSDeleteLog WHERE ErrDescription='Delete Successfuly')
	--			ORDER BY Slno DESC
				
	--			SELECT @TotCnt=MAX(ISNULL(RowNo,0)) FROM #TempToDelete
				
	--			--SET @Cnt=@Cnt-1
				
	--			IF EXISTS(SELECT * FROM #TempToDelete)
	--			BEGIN
	--				IF @TotCnt>=@Cnt
	--				BEGIN
						
	--					UPDATE A SET A.BucketFileDelFlag=2 FROM DatabaseBackupDetails A 
	--					INNER JOIN #TempToDelete B ON A.ZipFileName=b.ZipFileName  and A.Slno=B.Slno
	--					WHERE RowNo<=@TotCnt-@Cnt AND A.ZipFileName NOT IN (SELECT sFileName FROM DB_Backup_AWSDeleteLog  WHERE ErrDescription='Delete Successfuly')
	--					 and A.ZipFileName in (SELECT sFileName FROM DB_Backup_ErrorLog where ErrDescription='Successfully uploaded')
						
	--				END
	--			END
	--		END
		
	--	END
	END
	
RETURN
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Console2CS_Consolidated_WFHCS' AND XTYPE ='U')
BEGIN
	SELECT * INTO Console2CS_Consolidated_WFHCS FROM Console2CS_Consolidated 
	TRUNCATE TABLE Console2CS_Consolidated 
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Console2CS_ConsolidatedDownload]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Console2CS_ConsolidatedDownload
GO
CREATE PROCEDURE Proc_Console2CS_ConsolidatedDownload
As  
/*
**************************************************************************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
**************************************************************************************************
23/01/2018  Gowsalya S   Issue          ICONSWIP1888            SyncStatus has been updated as 1 for incomplete sync
20-08-2019  Lakshman M   SR             ILCRSTPAR5587           script has been prepared to avoid the Special discount process while moving data from consolidated to parking table.  
10/09/2020  Kamal        Issue			WFHCSBotree20200818		Old data moving to CS						
*/
Begin  
BEGIN TRY    
SET XACT_ABORT ON    
BEGIN TRANSACTION
Declare @Lvar Int  
Declare @MaxId Int  
Declare @SqlStr Varchar(8000)  
Declare @Process Varchar(100)  
Declare @colcount Int  
Declare @Col Varchar(5000)  
Declare @Tablename Varchar(100)  
Declare @Sequenceno Int  
 Create Table #Col (ColId int)  
 CREATE TABLE #Console2CS_Consolidated  
 (  
  [SlNo] [numeric](38, 0) NULL, [DistCode] [VARCHAR](200) COLLATE Database_Default NULL, [SyncId] [numeric](38, 0) NULL,  
  [ProcessName] [VARCHAR](200) COLLATE Database_Default NULL, [ProcessDate] [datetime] NULL, 
  [Column1] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column2] [VARCHAR](200) COLLATE Database_Default NULL, [Column3] [VARCHAR](200) COLLATE Database_Default NULL, [Column4] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column5] [VARCHAR](200) COLLATE Database_Default NULL, [Column6] [VARCHAR](200) COLLATE Database_Default NULL, [Column7] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column8] [VARCHAR](200) COLLATE Database_Default NULL, [Column9] [VARCHAR](200) COLLATE Database_Default NULL, [Column10] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column11] [VARCHAR](200) COLLATE Database_Default NULL, [Column12] [VARCHAR](200) COLLATE Database_Default NULL, [Column13] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column14] [VARCHAR](200) COLLATE Database_Default NULL, [Column15] [VARCHAR](200) COLLATE Database_Default NULL, [Column16] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column17] [VARCHAR](200) COLLATE Database_Default NULL, [Column18] [VARCHAR](200) COLLATE Database_Default NULL, [Column19] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column20] [VARCHAR](200) COLLATE Database_Default NULL, [Column21] [VARCHAR](200) COLLATE Database_Default NULL, [Column22] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column23] [VARCHAR](200) COLLATE Database_Default NULL, [Column24] [VARCHAR](200) COLLATE Database_Default NULL, [Column25] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column26] [VARCHAR](200) COLLATE Database_Default NULL, [Column27] [VARCHAR](200) COLLATE Database_Default NULL, [Column28] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column29] [VARCHAR](200) COLLATE Database_Default NULL, [Column30] [VARCHAR](200) COLLATE Database_Default NULL, [Column31] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column32] [VARCHAR](200) COLLATE Database_Default NULL, [Column33] [VARCHAR](200) COLLATE Database_Default NULL, [Column34] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column35] [VARCHAR](200) COLLATE Database_Default NULL, [Column36] [VARCHAR](200) COLLATE Database_Default NULL, [Column37] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column38] [VARCHAR](200) COLLATE Database_Default NULL, [Column39] [VARCHAR](200) COLLATE Database_Default NULL, [Column40] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column41] [VARCHAR](200) COLLATE Database_Default NULL, [Column42] [VARCHAR](200) COLLATE Database_Default NULL, [Column43] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column44] [VARCHAR](200) COLLATE Database_Default NULL, [Column45] [VARCHAR](200) COLLATE Database_Default NULL, [Column46] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column47] [VARCHAR](200) COLLATE Database_Default NULL, [Column48] [VARCHAR](200) COLLATE Database_Default NULL, [Column49] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column50] [VARCHAR](200) COLLATE Database_Default NULL, [Column51] [VARCHAR](200) COLLATE Database_Default NULL, [Column52] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column53] [VARCHAR](200) COLLATE Database_Default NULL, [Column54] [VARCHAR](200) COLLATE Database_Default NULL, [Column55] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column56] [VARCHAR](200) COLLATE Database_Default NULL, [Column57] [VARCHAR](200) COLLATE Database_Default NULL, [Column58] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column59] [VARCHAR](200) COLLATE Database_Default NULL, [Column60] [VARCHAR](200) COLLATE Database_Default NULL, [Column61] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column62] [VARCHAR](200) COLLATE Database_Default NULL, [Column63] [VARCHAR](200) COLLATE Database_Default NULL, [Column64] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column65] [VARCHAR](200) COLLATE Database_Default NULL, [Column66] [VARCHAR](200) COLLATE Database_Default NULL, [Column67] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column68] [VARCHAR](200) COLLATE Database_Default NULL, [Column69] [VARCHAR](200) COLLATE Database_Default NULL, [Column70] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column71] [VARCHAR](200) COLLATE Database_Default NULL, [Column72] [VARCHAR](200) COLLATE Database_Default NULL, [Column73] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column74] [VARCHAR](200) COLLATE Database_Default NULL, [Column75] [VARCHAR](200) COLLATE Database_Default NULL, [Column76] [VARCHAR](200) COLLATE Database_Default NULL,   
  [Column77] [VARCHAR](200) COLLATE Database_Default NULL, [Column78] [VARCHAR](200) COLLATE Database_Default NULL, [Column79] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column80] [VARCHAR](200) COLLATE Database_Default NULL, [Column81] [VARCHAR](200) COLLATE Database_Default NULL, [Column82] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column83] [VARCHAR](200) COLLATE Database_Default NULL, [Column84] [VARCHAR](200) COLLATE Database_Default NULL, [Column85] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column86] [VARCHAR](200) COLLATE Database_Default NULL, [Column87] [VARCHAR](200) COLLATE Database_Default NULL, [Column88] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column89] [VARCHAR](200) COLLATE Database_Default NULL, [Column90] [VARCHAR](200) COLLATE Database_Default NULL, [Column91] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column92] [VARCHAR](200) COLLATE Database_Default NULL, [Column93] [VARCHAR](200) COLLATE Database_Default NULL, [Column94] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column95] [VARCHAR](200) COLLATE Database_Default NULL, [Column96] [VARCHAR](200) COLLATE Database_Default NULL, [Column97] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column98] [VARCHAR](200) COLLATE Database_Default NULL, [Column99] [VARCHAR](200) COLLATE Database_Default NULL, [Column100] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Remarks1] [VARCHAR](200) COLLATE Database_Default NULL, [Remarks2] [VARCHAR](200) COLLATE Database_Default NULL, [DownloadFlag] [VARCHAR](1) COLLATE Database_Default NULL,  
  DWNStatus INT
 )   
 INSERT INTO Console2CS_Consolidated_Trace 
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y'
 DELETE FROM Console2CS_Consolidated_Trace where CONVERT (DATETIME,[Downloaded Date],121)<=Convert(DATETIME,GETDATE()-15,121)
 Delete A From Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y' 
 ---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Console2CS_Consolidated'
	And A.system_type_id = C.system_type_id And C.name='varchar'
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ----------------------------------
	
	SELECT Distinct DistCode, SyncId Into #IncompleteSync  FROM Console2CS_Consolidated (NOLOCK) WHERE DownloadFlag='N'  
	
	Select A.DistCode , A.SyncId , MAX(CreatedDate) CreatedDate Into #MaxDate
	 from SyncStatus_Download_Archieve A(Nolock), #IncompleteSync B
	Where A.DistCode = B.DistCode And A.SyncId = B.SyncId 
	Group by  A.DistCode , A.SyncId
	
	Update A Set SyncStatus =1 From
	SyncStatus_Download_Archieve A (Nolock) , 
	#MaxDate B
	Where A.DistCode = B.DistCode And A.Syncid = B.Syncid And A.CreatedDate = B.CreatedDate 
 ------------------------------------
 
 
 ----------------------------WFHCSBotree20200818------------------------------------------------------  
 
 
 Select Distinct A.DistCode ,A.SyncId,Count(A.SyncStatus) As Cnt into #Temp_DataMove
 from SyncStatus_Download_Archieve A (Nolock),SyncStatus_Download B (Nolock)
 Where A.DistCode = B.DistCode And B.SyncId > A.SyncId And A.SyncStatus = 0
 Group by A.DistCode ,A.SyncId
 having Count(A.SyncStatus) > 1
 
 Select Distinct B.DistCode ,B.SyncId, MAX(B.CreatedDate) As CrDate into #Temp_DataUpdate
 from #Temp_DataMove A,SyncStatus_Download_Archieve B(Nolock)
 Where A.DistCode = B.DistCode And A.SyncId = B.SyncId
 Group by B.DistCode ,B.SyncId
 
 Update A Set A.SyncStatus = 1 From SyncStatus_Download_Archieve A(Nolock) , #Temp_DataUpdate B
 Where A.DistCode = B.DistCode And A.SyncId = B.SyncId And A.CreatedDate = B.CrDate 
 And A.SyncStatus = 0
 
 ------------------------------------------------------------------------------------------------
	
 Insert Into #Console2CS_Consolidated  
 Select *,0 as DWNStatus from Console2CS_Consolidated (Nolock) Where DownloadFlag In ('D','N')
   Update A Set A.DWNStatus = 1  
   From  
    #Console2CS_Consolidated A (NOLOCK),  
    (  
     SELECT   
     DistCode,SyncId   
     FROM   
     SyncStatus_Download (NOLOCK)  
     WHERE       
     SyncStatus = 1 AND SyncId > 0  
     UNION  
     SELECT   
     DistCode,SyncId  
     FROM   
     SyncStatus_Download_Archieve (NOLOCK)  
     WHERE  
     SyncStatus = 1 AND SyncId > 0  
    ) B  
   Where   
    A.DistCode = B.DistCode AND   
    A.SyncId = B.SyncId   
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
 -- Purchase Trace Ends here
 Delete A From #Console2CS_Consolidated A (Nolock) Where DWNStatus = 0 
 Create Table #Process(ProcessName Varchar(100),PrkTableName Varchar(100), id Int Identity(1,1) )  
 Insert Into #Process(ProcessName , PrkTableName)   
 Select Distinct A.ProcessName , A.PrkTableName From Tbl_DownloadIntegration A,#Console2CS_Consolidated B   
 Where A.ProcessName = B.ProcessName And A.SequenceNo not in(100000) AND A.Processname NOT IN('SpecialDiscount')  --Order By Sequenceno   -- Added by lakshman M Dated ON PMS : ILCRSTPAR5587
  Set @Lvar = 1  
  Select @MaxId = Max(id) From #Process  
  While @Lvar <= @MaxId  
   Begin  
    Select @Tablename = PrkTableName , @Process = ProcessName From #Process Where id  = @Lvar  
    Select @colcount = Count(Column_ID) From sys.columns Where object_id = (select object_id From sys.objects Where name = @Tablename)  
    Set @SqlStr = ''  
    Set @SqlStr = @SqlStr + ' Insert Into ' + @Tablename + ' '  
    Set @Col = ''  
    select @Col = @Col + '[' +name + '],' From sys.columns   
    where object_id = ( select object_id From sys.objects Where name = @Tablename) Order by Column_Id  
    Truncate Table #Col      
    Insert Into #Col     
    Select  a.column_id + 5 As ColId  
    From sys.columns a,sys.types b where a.user_type_id = b.user_type_id  
    and a.object_id = ( Select object_id From sys.objects Where name = @Tablename)  
    and b.name = 'datetime' --and a.name <> 'CreatedDate'  
    Set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ') '  
    Set @Col = ''  
    Select @Col = @Col + (Case when column_id In (Select ColId From #Col) then 'Convert(Datetime,'+name + ',121)' else name end) + ','   
    From sys.columns Where object_id = ( Select object_id From sys.objects Where name = 'Console2CS_Consolidated ')  
    and column_id  between 6 and 5 + @colcount 
    Order by column_id
    Set @SqlStr = @SqlStr + ' Select '+ left(@Col,len(@Col)-1)  + ' From #Console2CS_Consolidated (nolock) '  
    Set @SqlStr = @SqlStr + ' Where ProcessName = '''+ @Process +''' And DWNStatus = 1 '      
--    Print (@SqlStr) 
    Exec (@SqlStr)  
    Set @Lvar = @Lvar + 1  
   End  
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
  -- Purchase Trace Ends here
  Update A Set A.DownloadFlag = 'Y'   
   From   
    Console2CS_Consolidated A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
   Update A Set A.SyncFlag = 1  
   From   
    Syncstatus_Download A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
	DELETE FROM Console2CS_Consolidated WHERE Processname IN('SpecialDiscount') AND downloadflag in('D','N')  ---- Added by lakshman M Dated ON20-08-2019 PMS : ILCRSTPAR5587
COMMIT TRANSACTION    
 END TRY    
 BEGIN CATCH    
  ROLLBACK TRANSACTION    
  INSERT INTO XML2CSPT_ErrorLog VALUES ('Proc_Console2CS_ConsolidatedDownload', ERROR_MESSAGE(), GETDATE())    
 END CATCH    
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_SyncValidation' AND TYPE='P')
DROP PROCEDURE Proc_SyncValidation
GO
CREATE PROCEDURE Proc_SyncValidation  
(          
@TypeId Int,          
@Code Varchar(100) = '', -- IP Address in Sync Attempt, DistCode in SyncStatus,          
@Val1 Numeric(18)=0, -- SubTypeId in SyncStatus,          
@Val2 Numeric(18)=0, -- SyncId in SyncStatus,          
@Val3 Numeric(18)=0, -- RecCnt in SyncStatus,          
@Val4 Varchar(100)='',          
@Val5 Varchar(100)='',          
@Val6 Varchar(100)='' ,
@Val7 Varchar(100)=''          
)          
As 
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
04/10/2017  Gowsalya S   CR          CCONSAML1012            Added HotFixMsg Validation 
07/12/2017  Gowsalya S   CR          CCONSPAR0178            Checking ScriptUpdaterfixid between CS and Console 
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
14/12/2017  Gowsalya S   CR          ISTOCWIP1835            For displaying Syncversion number on Sync exe UI
09/01/2018  Gowsalya S   BZ          ICONSWIP1878            Validation added to check distinct Slno Count  
09/11/2018	Gowsalya S	 CR			 CRCONSPAR0035			CSTimer Settings added.
30/12/2019  Lakshman M   SR          ILCRSTPAR7202          New Sync Exe changes
24-09-2020  Deepak Philip BZ         PARLECS/0920/163       Purge Details table validation removed.
*/           
Begin          
--Added By Lakshman M dated on 12-02-2018
BEGIN TRY        
BEGIN TRANSACTION
--Till Here  
 Delete A From SyncErrorDetails A (Nolock) Where (Convert(Varchar(10),CreatedDate,121)) <= (Convert(Varchar(10),GETDATE()- 30,121))
	
 Declare @Sql Varchar(Max)        
 Declare @IntRetVal Int      
 IF @TypeId = 1 -- Distributor Code, Proc_SyncValidation  piTypeId          
 Begin          
  SELECT DistributorCode FROM Distributor WHERE Distributorid=1           
 End          
 IF @TypeId = 2 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 Begin          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER45') AND ModuleName='DataTransfer' Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId     
 End           
 IF @TypeId = 3 -- Sync Attempt Validation  Proc_SyncValidation  @TypeId,@Code          
 Begin          
  Declare @RetTemp Int      
  SET @RetTemp = 1      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
 --SET @RetTemp = 0      
 IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
 Begin      
  SET @RetTemp = 0      
 End       
  End      
  IF (@RetTemp = 0)      
  Begin      
 Select 0      
 RETURN      
  End      
  IF Not Exists (Select * From CSyncStatus Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 1)      
 Begin      
  Truncate table CSyncStatus      
  Insert into CSyncStatus Select GETDATE(),0      
 End      
  Set @Code = (Select Top 1 HostName From Sys.sysprocesses where  status='RUNNABLE' Order By login_time desc)          
  IF ((SELECT Count(*) From SyncAttempt) < 1)          
   BEGIN          
    INSERT INTO SyncAttempt          
    SELECT @Code,1,Getdate()          
    SELECT 1          
   END           
  ELSE          
   BEGIN          
    IF (SELECT Status From SyncAttempt) = 0          
     BEGIN          
      UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
      SELECT 1          
     END          
    ELSE 
     BEGIN          
      IF ((SELECT DatedIFf(hh,StartTime,Getdate()) From SyncAttempt) > 1)          
       BEGIN          
          UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
          SELECT 1          
       END          
      ELSE          
        IF ((SELECT Count(*) From SyncAttempt WHERE IPAddress = @Code) = 1 )          
         BEGIN          
          UPDATE SyncAttempt SET Status = 1,StartTime = Getdate()           
          SELECT 1          
         END          
        ELSE          
         BEGIN          
          SELECT 0                   
         END          
     END          
   END            
 End          
 IF @TypeId = 4 -- Remove from Redownloadrequest,  Proc_SyncValidation   @TypeId          
 Begin          
  TRUNCATE TABLE ReDownLoadRequest          
 End          
 IF @TypeId = 5 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
   IF @Val1 = 1           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess='SyncProcess0' ORDER BY SyncProcess          
   End          
   IF @Val1 = 2           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess<>'SyncProcess0' ORDER BY SyncProcess          
   End          
 End          
 IF @TypeId = 6 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1           
   Begin          
    SELECT DISTINCT SlNo,SlNo AS SeqNo,Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count           
    FROM Customupdownload  ORDER BY  UpDownload Desc ,SlNo        
   End          
  IF @Val1 = 2           
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Upload'          
End          
  IF @Val1 = 3          
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Download'          
   End          
 End          
 IF @TypeId = 7 -- Sync Status Validation,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3          
 Begin          
  IF Exists(Select * from SyncStatus Where DistCode = @Code and SyncId = @Val2)              
   Begin          
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin       
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End          
       Else if @Val3 = 2-- Added on 2016-07-22  
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End       
     End             
   End              
  Else              
   Begin              
    Delete From SyncStatus Where DistCode = @Code and SyncStatus = 1        
    IF Not Exists (Select * From  SyncStatus (Nolock))      
    Begin        
  Insert into SyncStatus Select @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'      
    End              
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin              
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End       
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End         
     End             
   End            
 End          
 IF @TypeId = 8 -- Select Current SyncId,  Proc_SyncValidation   @TypeId          
 Begin          
	--Select IsNull(MAX(SyncId),0) From Sync_Master-- SyncStatus    
		Select Isnull(Syncid,0) From SyncStatus (Nolock)
 End           
 IF @TypeId = 9 -- Select Syncstatus for this SyncId,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin          
  Select IsNull(Max(SyncStatus),0) From SyncStatus where DistCode = @Code And syncid = @Val1 And SyncStatus = 1          
 End            
 IF @TypeId = 10 -- DB Restoration Concept,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
   Begin          
    Select Count(*) From DefendRestore          
   End           
  IF @Val1 = 2          
   Begin          
    update DefendRestore Set DbStatus = 1,ReqId = 1,CCLockStatus = 1          
   End             
  IF @Val1 = 3          
   Begin          
    Insert into DefendRestore (AccessCode,LastModDate,DbStatus,ReqId,CCLockStatus)      
    Values('',GETDATE(),1,1,1)          
   End           
 End             
 IF @TypeId = 11 -- AAD & Configuration Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId='BotreeSyncCheck'          
  End           
  IF @Val1 = 2          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId LIKE 'BotreeSyncErrLog'          
  End             
  IF @Val1 = 3          
  Begin          
   Select IsNull(Max(FixID),0) from Hotfixlog (NOLOCK)          
  End             
 End             
 IF @TypeId = 12 -- System Date is less than the Last Transaction Date Validation,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT ISNULL(MAX(TransDate),GETDATE()-1) AS TransDate FROM StockLedger          
 End           
 IF @TypeId = 13 -- DayEnd Process Updation,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  UPDATE DayEndProcess SET NextUpDate=@Code WHERE ProcId=13          
 End           
 IF @TypeId = 14 -- Update Sync Attempt Status ,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  Select @Code =  HostName From Sys.sysprocesses where  status='RUNNABLE'          
  Update SyncAttempt Set Status=0 where IPAddress = @Code          
 End            
 IF @TypeId = 15 -- Latest SyncId from Sync_Master ,  Proc_SyncValidation   @TypeId          
 Begin          
  --Select ISNull(Max(SyncId),0) From Sync_Master           
  IF Exists(Select * From SyncStatus (Nolock) Where SyncStatus = 1)      
  Begin      
   Select ISNull(Max(SyncId),0) From Sync_Master (Nolock)      
  End      
  Else      
  Begin      
   Select ISNull(Max(SyncId),0) From SyncStatus (Nolock)      
  End              
 End           
 IF @TypeId = 16 -- Update the Flag as Y for all lesser than the latest Serial No ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF ((Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N') > 0)              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo >=         
    (Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N')               
   End              
   Else              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val1 And SlNo <= @Val2       
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo > @Val2          
   End       
 End            
 IF @TypeId = 17 -- Record Count ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF @Val1 = 1           
  Begin          
   Select Count(*) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2 and UploadFlag = 'N'          
  End          
  IF @Val1 = 2           
  Begin          
   Select Count(Distinct Slno) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
  End             
  IF @Val1 = 3           
  Begin          
   --Select IsNull(Count(*),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
   Select IsNull(Count(Distinct Syncid),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
  End          
 End            
 IF @TypeId = 18 -- Datapreperation Process and Split each 1000 rows for xml file ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin        
 IF @Val1 = 1           
  Begin          
   SELECT * FROM  CustomUpDownload  WHERE SlNo=@Val2  AND UpDownload='Upload' ORDER BY UpDownLoad,SlNo,SeqNo          
  End          
  IF @Val1 = 2           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 3          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM  ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End              
  IF @Val1 = 4          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT * FROM  ' + Convert(Varchar(100),@Code) + ' WHERE  SlNo= ' + Convert(Varchar(100),@Val2) + '  ORDER BY UpDownLoad,SlNo,SeqNo '          
   Exec (@Sql)          
  End             
  IF @Val1 = 5          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + '  '          
   Exec (@Sql)          
  End           
  IF @Val1 = 6          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' DELETE  FROM   ' + Convert(Varchar(100),@Code) + ' WHERE Downloadflag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 7          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) FROM   ' + Convert(Varchar(100),@Code) + ' WHERE DownloadFlag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 8          
  Begin          
   Set @Sql = ''          
  Set @Sql = @Sql + ' SELECT TRowCount FROM Tbl_DownloadIntegration_Process WHERE PrkTableName =''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 9          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = 0  WHERE ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 10          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = ' + Convert(Varchar(100),@Val2) + ' where ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 11           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MAX(SlNo),0) AS Cnt FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 12           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End            
  IF @Val1 = 13           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 14           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Upload'' '          
   Exec (@Sql)          
  End               
  IF @Val1 = 15           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS DownloadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Download'' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 16           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''' And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 17           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus_Download (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''''-- And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 18      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
  Select @Sql      
 End       
  IF @Val1 = 19      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''X'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 20      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''Y'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 21      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''N'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End         
  IF @Val1 = 22      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE UploadFlag=''Y'' And  SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    --Exec (@Sql)        
    --SET @Sql = ''          
    SET @Sql = @Sql + 'UNION ALL SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    Exec (@Sql)           
 End         
  IF @Val1 = 23      
 Begin      
    SET @Sql = ''    
    --Added on 2018-01-09        
    --SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' ' 
    SET @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '         
    Exec (@Sql)           
 End        
 IF @Val1 = 24      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(DistCode) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' '      
    Exec (@Sql)           
 End       
 End            
 IF @TypeId = 19 -- View Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT * FROM ErrorLog WITH (NOLOCK)          
 End          
 IF @TypeId = 20 -- Remove Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  DELETE FROM ErrorLog           
 End           
 IF @TypeId = 21 -- Download Notification Details Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM  CustomUpDownloadCount WHERE UpDownload='Download' ORDER BY SlNo          
 End           
 IF @TypeId = 22 -- Download Details to xml file ,  Proc_SyncValidation   @TypeId          
Begin           
  SELECT * FROM Cs2Cn_Prk_DownloadedDetails WHERE UploadFlag='N'          
 End           
 IF @TypeId = 23 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_DownloadIntegration_Process ORDER BY SequenceNo          
End           
 IF @TypeId = 24 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_DownloadIntegration_Process SET TRowCount=0          
 End            
 IF @TypeId = 25 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_DownloadIntegration_Process WHERE ProcessName = @Code          
 End            
 IF @TypeId = 26 -- Upload Consolidated Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_UploadIntegration_Process ORDER BY SequenceNo          
 End            
 IF @TypeId = 27 -- Download Details   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT DISTINCT Module,DownloadedCount FROM CustomUpDownloadCount WHERE UpDownload='Download' AND DownloadedCount>0          
 End            
 IF @TypeId = 28 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeReDownload'          
 End           
 IF @TypeId = 29 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM ReDownLoadRequest         
 End           
 IF @TypeId = 30 -- Showboard    ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeBBOardOnSync' AND Status=1          
 End           
 IF @TypeId = 31 -- Update sync status if disconnect    ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin           
  IF Not Exists (Select * From CS2Console_Consolidated (nolock) Where DistCode = @Code And Syncid = @Val1 And UploadFlag='N')          
  Begin          
   Update Syncstatus Set Syncstatus = 1 Where DistCode = @Code And Syncid = @Val1          
   Select IsNull(Max(SyncStatus),0) From SyncStatus (nolock) Where DistCode = @Code And Syncid = @Val1          
  End          
 End           
 IF @TypeId = 32 -- Update sync status if disconnect,Proc_SyncValidation @TypeId,@Code,@Val1          
 Begin           
  Declare @RETVAL Varchar(Max)          
  Set @RETVAL = ''          
  IF EXISTS (Select * From Chk_MainSalesIMEIUploadCnt (NOLOCK))          
  Begin            
  Select @RETVAL = Cast(COALESCE(@RETVAL + ', ', '') + Convert(Varchar(40),MainTblBillNo) as ntext) From Chk_MainSalesIMEIUploadCnt             
  Select @RETVAL          
  End          
 End          
 IF @TypeId = 33 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select 'Request given for approval so please approve from Central Help Desk.'            
 End            
 IF @TypeId = 34 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select IsNull(LTrim(RTrim(CmpCode)),'') From Company (Nolock) Where DefaultCompany = 1            
 End            
 IF @TypeId = 35 -- Select Download Sync status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin             
  Select IsNull(SyncStatus,0) from Syncstatus_Download (nolock) Where Distcode = @Code and Syncid = @Val1          
 End            
 IF @TypeId = 36 -- Select Max(Syncid) in Download Sync Status  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SyncId),0) From SyncStatus_Download (Nolock)          
 End            
 IF @TypeId = 37 -- Select Max(SlNo) in Console2CS_Consolidated  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SlNo),0) From Console2CS_Consolidated (Nolock) Where Distcode = @Code and Syncid = @Val1          
 End             
 IF @TypeId = 38 -- Syncstatus  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
 Declare @RetState Int          
 Update CSyncStatus Set SyncStatus = 1 Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 0      
 IF Exists (Select * From SyncStatus (Nolock) where DistCode = @Code And syncid = @Val1 And SyncStatus = 1)          
  Begin          
 If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
  IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 1 -- Upload and Download Completed Successfully              
   End          
  Else          
   Begin          
    Set @RetState = 2 -- Upload Completed, Download Incomplete           
   End          
  End      
 Else      
  Begin      
  Set @RetState = 1 -- Upload and Download Completed Successfully       
  End      
  End          
  Else          
  Begin          
   If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
    IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully                
   End          
  Else          
   Begin          
    Set @RetState = 4 -- Upload and Download Incomplete!!!                 
   End          
  End      
 Else      
  Begin      
  Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully       
  End      
  End          
  Select @RetState          
 End             
 IF @TypeId = 39 -- Update Download Sync Status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3            
 Begin             
 -------          
  IF Exists(SELECT * FROM SyncStatus_Download WHERE DistCode = @Code and SyncId = @Val2)                      
   Begin          
    IF @Val1 = 1                      
    Begin                    
    If Exists (Select * from SyncStatus_Download(Nolock)  Where DistCode = @Code and SyncId = @Val2 And SyncStatus =1 And SyncFlag =0) --Added on 2016-10-04             
    Begin    
     IF Exists(SELECT * FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag Not in ('N','D'))  --Added on 2016-07-25             
     Begin              
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag ='Y'              
     End     
   End            
   else     
   Begin    
  DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2        
   End       
     --Update SyncStatus_Download Set SyncStatus=0,SyncFlag=0 Where DistCode = @Code and SyncId = @Val2   -- Added to Parameter S             
     UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
     --IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)                
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin                
        If @Val3 > 0 -- Added on 2016-07-25      
  Begin            
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2         
  End                 
      End              
     End                   
   End                      
  Else                      
   Begin                      
    INSERT INTO SyncStatus_Download_Archieve  SELECT *,Getdate() FROM SyncStatus_Download WHERE DistCode = @Code                 
    DELETE FROM SyncStatus_Download WHERE DistCode = @Code        
  --  INSERT INTO SyncStatus_Download SELECT @Code,@Val2,Getdate(),Getdate(),0,0      
    -----------Added on 2016-07-25-------------      
 if  @Val3 = 0      
 Begin      
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),1,1                      
 End      
 Else      
 Begin                  
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),0,0                      
 End        
 -----------Added on 2016-07-25-------------        
    INSERT INTO SyncStatus_Download_Archieve SELECT @Code,@Val2,Getdate(),Getdate(),0,0,GETDATE()                       
    IF @Val1 = 1                      
    Begin                      
    UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
--     IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)      
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin       
       IF @Val3 > 0 -- Added on 2016-07-25      
  BEGIN                
   DELETE A FROM Console2CS_Consolidated A (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2                   
  END       
      End               
     End                   
   End            
 ------          
 END      
  IF @TypeId = 40 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_Customdownloadintegration ORDER BY SequenceNo          
 End           
 IF @TypeId = 41 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_Customdownloadintegration SET TRowCount=0          
 End       
 IF @TypeId = 42 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_Downloadintegration WHERE ProcessName = @Code          
 End       
 IF @TypeId = 43 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT TRowCount FROM Tbl_Customdownloadintegration WHERE PrkTableName = @Code          
 End       
 IF @TypeId = 44 -- Download Process   ,  Proc_SyncValidation   @TypeId   
 Begin           
  Update Tbl_Customdownloadintegration Set TRowCount = @Val1 WHERE ProcessName = @Code          
 End       
 IF @TypeId = 45 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId        
 Begin         
 Set @IntRetVal = 0        
 IF @Val1 = 1      
 Begin      
  If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')        
   Begin        
    IF Exists (Select * from UtilityProcess where ProcId = 3)        
    Begin        
     IF ((Select Convert(Varchar(100),VersionId) from UtilityProcess where ProcId = 3) <> @Code)        
     Begin        
   Set @IntRetVal = 1            
     End           
    End        
   End        
 End         
 IF @Val1 = 2      
 Begin      
  If Not Exists (Select * From AppTitle (Nolock) Where  SynVersion = @Code)        
   Begin        
   Set @IntRetVal = 1      
   End      
 End      
 Select @IntRetVal       
 End         
 IF @TypeId = 46 -- Data Purge  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 --IF Exists (Select * From Sys.objects Where name = 'DataPurgeDetails' and TYPE='U')      
 --Begin      
 -- IF EXISTS (Select * From DataPurgeDetails)      
 -- Begin      
 --  Set @IntRetVal = 0      
 -- End      
 --End      
 Select @IntRetVal       
 End      
 IF @TypeId = 47 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 --IF Exists (Select * From Sys.objects Where name = 'Distributor' and TYPE='U')      
 --Begin      
 -- Update Distributor Set DistStatus = 0 Where DistributorCode = @Code      
 --End      
 End      
 IF @TypeId = 48 -- Unregistered Database  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0      
 IF Not Exists (Select * From SyncStatus (Nolock))      
 Begin      
  Set @IntRetVal = 1 -- Unregistered Database      
 End      
 Else      
 Begin      
  IF Exists (Select * From SyncStatus (Nolock) Where DistCode Is Null or DistCode = '')      
  Begin      
   Set @IntRetVal = 2 -- Distributor Code is not found      
  End      
 End      
 IF (@IntRetVal > 0)      
 Begin      
  Select @IntRetVal      
  RETURN      
 End      
 IF Not Exists (Select * from SyncStatus (Nolock) where SyncId = 0)      
 Begin      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
   IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
   Begin      
    SET @IntRetVal = 3        
   End      
  End      
 End      
 Else      
 Begin      
  SET @IntRetVal = 4      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 49 -- DB Restoration  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0       
 --If Exists (Select * From Cs2Cn_Prk_DBUnlockDetails (Nolock) Where DistCode = @Code And DBUnlockStatus > 0)      
 --Begin      
 -- Set @IntRetVal = 1      
 --End      
 If Exists (Select * From DefendRestore (Nolock) Where ReqId > 0)      
 Begin      
  Set @IntRetVal = 1      
 End       
 Select @IntRetVal      
 End       
 IF @TypeId = 50 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 BEGIN          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER47') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId         
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45','DATATRANSFER48') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer'  And Description ='Upload Path' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  And Description ='Download Path' 
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId 
 END       
 IF @TypeId = 51 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_UploadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End      
 IF @TypeId = 52 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @Sql = ''      
 Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
 Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
 Print (@Sql)      
 Exec (@Sql)      
 End       
 IF @TypeId = 53 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin      
 Select * From Tbl_DownloadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End       
 IF @TypeId = 54   -- Added on 2016-07-23 for Partial data upload         
 Begin                
 IF @Val1 = 1                   
 Begin                  
  Select Count(1) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
 End                  
 IF @Val1 = 2          
 Begin                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End     
  IF @Val1 = 3          
 Begin            
 Update SyncStatus Set SyncStatus = 0, SyncFlag ='N' where DistCode = @Code and SyncId = @Val2                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End           
 End        
 IF @TypeId = 55   -- Added on 2016-08-31 for Auto Quick Sync       
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'AutoQuickSync'      
 End      
 IF @TypeId = 56   -- Added on 2016-08-31 for SyncExe Minimized Mode        
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncExeMinimized'      
 End      
 IF @TypeId = 57   -- Added on 2016-08-31 for SuccessMsgShow      
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SuccessMsgShow'      
 End      
  IF @TypeId = 58    
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PartialUploadDataDelete'      
 End      
 IF @TypeId = 59     
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterAfterDeploy'      
 End  
 IF @TypeId = 60         
 Begin              
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'HotFixMsg'          
 End  
  IF @TypeId = 61          
 Begin              
	Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterHotfixId'          
 End
IF @TypeId = 62            
	Begin              
		Select Isnull(Max(fixid),0) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog)      
	End
IF @TypeId = 63          
	Begin   
		IF @Val1 = 1 
		Begin            
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncVersionInUI'     
		End
		IF @Val1 = 2
		Begin          
			If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')            
			Begin 
				IF Exists (Select * from UtilityProcess where ProcId = 3)            
				Begin            
					Select ISNULL(Versionid,'') from UtilityProcess where ProcId = 3
				End
			End
		End           
	End
 --Added By Lakshman M dated on 12-02-2018
IF @TypeId = 64  
Begin  
 Insert into SyncErrorDetails    
 (  
  Module, 	
  ProcessName,  
  ErrorMsg,  
  CreatedDate,  
  ServerDate  
 )   
 Values   
 (  
  @Val4,  
  @Val5, 
  @Val6, 
  GetDate(),  
  CONVERT(DateTime, @Val7, 121)  
 )  
End  
------------------Added by lakshman M dated ON 30-12-2019 PMS ID:  ILCRSTPAR7202
IF @TypeId = 65             
Begin              
	IF @Val1 = 1               
	Begin              
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'WriteAutoDeploymentStatus'         
	End    
	IF @Val1 = 2
	Begin  
			IF NOT EXISTS (SELECT '*' FROM MandatoryDeployment WHERE HFixID = @Val2)
			BEGIN
				Insert into MandatoryDeployment    
				(  
					HFixID,
					ManualStatus,
					MantatoryStatus, 
					FileDownloaded,
					DeploymentSatus,
					CreateDate     
				)   
				Values   
				(  
					@Val2,  
					0, 
					1, 
					0,  
					0,
					getdate() 
				) 
			END	
		END 
	END 
	IF @TypeId = 66         
	BEGIN    
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'LoginOCXReg'
	END  
	IF @TypeId = 67    
	BEGIN       
		IF @Val1 = 1     
		BEGIN      
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSAutoNClose'         
		END    
		IF @Val1 = 2    
		BEGIN    
			Select Substring(ProcessName,0,CHARINDEX('.Exe',ProcessName))  from UtilityProcess (Nolock) Where ProcId = 1
		END        
	END  
	IF @TypeId = 68    
	BEGIN       
		IF @Val1 = 1     
		BEGIN      
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSTimer Enable'         
		END  
		IF @Val1 = 2     
		BEGIN      
			Select isNull(syncID,0) From syncStatus (Nolock) Where DistCode = @Code        
		END    
		IF @Val1 = 3     
		BEGIN      
			Select convert(varchar(25),GETDATE(),121)     
		END    
	END 
	IF @TypeId = 69
	BEGIN  
		IF @Val1 = 1  
		BEGIN
			If Exists (select * from SyncStatus (Nolock))
			BEGIN
				Insert into tbl_SyncDetails  
				(
					[UploadSyncID],
					[SyncStartTime],
					SyncENDTime,
					Remarks,
					SyncStatusRemarks,
					SFlag,
					UploadFlag
				)
				Select 
					SyncId,
					GETDATE(),
					GETDATE(),
					Case @Val2  When 0 Then 'Internet Connectivity Issue' Else '' END As Remarks,
					Case @Val2 When 0 then 'InComplete' When 1 Then 'Complete' END As SyncStatusRemarks ,
					0, 
					'N'
				from 
					SyncStatus (Nolock)
			END
		END	
		IF @Val1 = 2
		BEGIN
			Update tbl_SyncDetails Set 	SyncENDTime = GETDATE(), SFlag = 1 Where SFlag = 0
		END
	END
	IF @TypeId = 70
	BEGIN  
		If @Val1 = 1
		Begin
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PDAExecuteAfterSync'   
		End
		If @Val1 = 2
		Begin
			--Select Distinct ProcessName  from UtilityProcess (Nolock) Where ProcessName like 'PDA%'
			  Select Distinct ProcessName  from UtilityProcess (Nolock) Where ProcessName ='Parle_SFAIntegration.Exe'
		End
	END
	IF @TypeId = 71
	BEGIN  
		If @Val1 = 1
		BEGIN  
			Select ISNULL (SyncId,0) As SyncId, ISNULL (SyncStatus,0) As SyncStatus from SyncStatus (Nolock)
		END	
		If @Val1 = 2
		BEGIN  
			Truncate table DefENDRestore
		END	
	END 
	IF @TypeId = 72  -- ILCONSAML4923
	BEGIN  
		Declare @HostName As Varchar(50)
		If @Val1 = 1
		BEGIN  
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ClrSyncAttempt'   
		END	
		If @Val1 = 2
		BEGIN  
			Set @HostName = (Select Distinct  Top 1 HostName From Sys.sysprocesses Where LTrim(PROGRAM_NAME) ='.Net SqlClient Data Provider')
			If Exists (Select * from SyncAttempt Where IPAddress = @Code And IPAddress = @HostName)
			BEGIN 
				Select 0
			END
			Else
			BEGIN
				Insert into SyncAttempt_Archieve
				Select *, GETDATE() from SyncAttempt
				Delete from SyncAttempt--  Where IPAddress = @Code
				INSERT INTO SyncAttempt    
				SELECT @HostName,1,Getdate()    
				Select 1
			END
		END	
	END 
	IF @TypeId = 73    -- ILCONSAML4924
	BEGIN       
		IF @Val1 = 1     
		BEGIN   
			SELECT DISTINCT Setting FROM Tbl_syncConfiguration WHERE Processname = 'ValidationTrace'         
		END  
		IF @Val1 = 2     
		BEGIN      
			IF NOT EXISTS (SELECT * FROM SyncValidation_Summary(NOLOCK) WHERE  UploadSyncid = @Val3)
			BEGIN
				INSERT INTO SyncValidation_Summary 
				SELECT @Code, @Val2, GETDATE(),GETDATE(),@Val3,GETDATE(),'D'
			END	
			ELSE
			BEGIN
				UPDATE A SET VENDTime = GETDATE (), UploadFlag ='N' FROM SyncValidation_Summary A (NOLOCK) WHERE UploadSyncid = @Val3
				IF NOT EXISTS (SELECT * FROM SyncValidation_Details(NOLOCK) WHERE  UploadSyncid = @Val3 AND Processname  = @Val4)
				BEGIN
					INSERT INTO SyncValidation_Details
					SELECT @Code , @Val2 ,@Val4, GETDATE(),GETDATE (),@Val3,@Val5,GetDate()
				END
				ELSE
				BEGIN
					UPDATE A SET VENDTime = GETDATE () FROM SyncValidation_Details A (NOLOCK) WHERE UploadSyncid = @Val3 And Processname = @Val4
				END	
			END
		END    
		IF @Val1 = 3
		BEGIN   
			SELECT ISNULL(MAX(Syncid),0) FROM SyncStatus (Nolock)
			SELECT ISNULL(MAX(Syncid),0) FROM SyncStatus_Download (Nolock)
			Set @Sql = ''    
			Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + ' (NOLOCK) WHERE DownloadFlag IN (''N'',''D'')  '    
			Print(@Sql) 
			Exec (@Sql)    
		END  
	END 
COMMIT TRANSACTION          
END TRY          
BEGIN CATCH          
ROLLBACK TRANSACTION       
INSERT INTO Sync_ErrorLog VALUES ('Proc_SyncValidation', ERROR_MESSAGE(), GETDATE())             
END CATCH          
--till Here  
----------Additional Validation----------              
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DNTSClaimBrandWise' AND TYPE='p')
DROP PROCEDURE Proc_Cs2Cn_DNTSClaimBrandWise
GO
CREATE PROCEDURE Proc_Cs2Cn_DNTSClaimBrandWise
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/**********************************************************************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_DNTSClaimBrandWise
* PURPOSE	:  TO UPLOAD SAVED DEBITNOTETOPSHEET CLAIM IN BRAND AND COST CENTRE WISE
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
************************************************************************************************************************************
* DATE      |	  PERSON			  | USER STORY ID  |	  CR/BZ		|       REMARKS                      
************************************************************************************************************************************
* 09-01-2020		MOHANA S			ILCRSTPAR7358 		    SR			Changed the claim Logic based on Sch Budget & LiabPer
* 16-01-2020		MOHANA S			ILCRSTPAR7420			BZ			Institutional Changes
* 06-03-2020		MOHANA S			ILCRSTPAR8160			CR			Channel Wise Upload for Trade Claim
* 12-05-2020		MOHANA S		    PARCS202100018			SR			Utilization split up Channel, Group, Product: Brand, PriceSlot, Flavor level
* 07-07-2020		S.Moorthi		    PARCS202100019			SR			Claim upload for Target Achievement
* 19-09-2020	    MOHANA S			PARLESECS/0920/091		BZ			Sales Return Not UPloaded in TRADE
*************************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise  WHERE UploadFlag ='Y'
			 
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
		RETURN
	END
			
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @Month INT
	DECLARE @Year  INT
	DECLARE @SecSales NUMERIC(38,2)
	SELECT  DISTINCT MonthiD, ClmYear INTO #Clmdate FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'
	--SELECT @FromDate= DATEADD(MONTH, (@Month)-1,DATEADD(YEAR, @Year - 1900, 0))
	--SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Month,DATEADD(YEAR, @Year - 1900, 0)))
	--SELECT @SecSales = SecSales FROM (
	--SELECT ISNULL(SUM(SalNetAmt),0) SecSales FROM Salesinvoice WHERE SalInvDate BETWEEN @FromDate AND @ToDate 
	--UNION
	--SELECT ISNULL(-1*SUM(RtnNetamt),0) SecSales FROM Returnheader  WHERE REturnDate BETWEEN @FromDate AND @ToDate  
	--)A
		
	DECLARE Cur_Date Cursor
	FOR SELECT MonthiD, ClmYear FROM #Clmdate
	OPEN Cur_Date
	FETCH NEXT FROM Cur_Date INTO @Month,@Year	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	EXEC Proc_ProductTaxPercentage_DNClaim  @Year,@Month  ,0,0  
	FETCH NEXT FROM Cur_Date INTO @Month,@Year	
	END
	CLOSE Cur_Date
	DEALLOCATE Cur_Date  
	SELECT DISTINCT CirNo INTO #CirNO FROM (
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_SMInc		UNION    
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_DistInc	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Manual		UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_TOTDiff	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_InstTarget UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Sampling
	)A INNER JOIN   DebitNoteTopSheetClaimHd B ON A.DNRefId = B.DNRefId WHERE UPLOAD = 'N'
	
	SELECT DISTINCT CircularNo,ClaimType,AttrCode ,Max(CreatedDate) CreatedDate
	INTO #MaxDate
	FROM SchemeCLaimCircular WHERE CircularNo IN (SELECT CirNO FROM #CirNO)
	GROUP BY CircularNo,AttrCode,ClaimType
	SELECT DISTINCT ConRefNo,A.ClaimType,AttrType,A.AttrCode,A.CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular1
	FROM SchemeCLaimCircular A INNER JOIN #MaxDate B ON A.AttrCode =B.AttrCode AND A.CreatedDate =B.CreatedDate AND A.ClaimType=B.ClaimType
	AND A.CircularNo = B.CircularNo
	WHERE A.CircularNo IN (SELECT CirNO FROM #CirNO)
	SELECT DISTINCT ConRefNo,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget 
	INTO #SchemeCLaimCircular
	FROM #SchemeCLaimCircular1
			
	SELECT DISTINCT  A.CmpSchcode,CircularNo,CircularDate,SchemeBudget INTO #Schemecirculardetails 
	FROM Schemecirculardetails A 
	--SAMPLING
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
					CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,PriceSlotCode,FlavourCode)
	SELECT @DistCode,DNDocNo,ClmDate,FromDate ,ToDate,'Sampling Claim',ConRefNo,BrandCode,CostCenter,CirNo ,Circulardate,CircularBudget,0,
	SUM(FD.TotalAmt),'N',@ServerDate,PriceSlot_Code,Flavor_Code  from DebitNoteTopSheetClaim_Sampling A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN FreeIssueHd F (NOLOCK) ON DATENAME(Month,F.IssueDate)=B.ClmMonth AND YEAR (F.IssueDate)=B.ClmYear  --F.IssueDate BETWEEN A.FromDate AND A.Todate REGIONAL SETTING ISSUE
	INNER JOIN FreeissueDt FD(NOLOCK) ON F.IssueId = FD.IssueId 
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON T.Prdid = FD.PrdId 
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.Brand_Code 
	INNER JOIN #SchemeClaimCircular S(NOLOCK) ON S.CircularNo=A.CirNo AND S.ClaimType = 'Sampling Claim'
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,ConRefNo,BrandCode,CostCenter,CirNo ,Circulardate,CircularBudget,PriceSlot_Code,Flavor_Code
			
	--TRADE Commented For Calculation change -Final from AMARENDRA
	--SELECT SchId, SUM(OrgClmAmt/CalClmAmt) AS ClmPer  INTO #TradePer FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)  
	--ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND ApplyCapVal IN (2,12,1)    AND CALCLMAMT<>0
	--GROUP BY SchId 
			
	--SELECT DISTINCT A.Schid,DNDocNo,ClmDate,FrmDate,ToDate,S.CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget,
	--CASE ISNULL(CalClmAmt,'') WHEN 0 THEN 0 ELSE
	--CASE ApplyCapVal 
	--	WHEN 0 THEN 
	--			CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax) ELSE SUM(DiscountPer)  END
	--	WHEN 2 THEN
	--			CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax/ ClmPer ) ELSE SUM(DiscountPer/ ClmPer )  END
	--	WHEN 1 THEN 
	--			CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax/ ClmPer ) ELSE SUM(DiscountPer/ ClmPer ) END
	--	WHEN 12 THEN 
	--			CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax/ ClmPer ) ELSE SUM(DiscountPer/ ClmPer ) END
	--END END AS ClmAmt,SecSales 
	--INTO #TradeClaimBrandWise
	--FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B (NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	--INNER JOIN DebitNoteTopSheetClaim_Trade_PrdWise  D(NOLOCK) ON A.Schid =D.Schid 	 
	--INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON D.Prdid =T.PrdiD
	--INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.Brand_Code 
	--INNER JOIN Schememaster S(NOLOCK) ON S.Schid=A.Schid AND D.SchId = S.SchId 
	--INNER JOIN SchemeCircularDetails SC(NOLOCK) ON S.CmpSchCode=SC.CmpSchCode
	--LEFT OUTER JOIN #TradePer TS(NOLOCK) ON A.SchId =TS.SchId AND D.SchId = Ts.SchId AND S.schid = Ts.Schid
	--GROUP BY A.Schid,DNDocNo,ClmDate,FrmDate ,ToDate,S.CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate ,Schbudget,ApplyCapVal,ClmPer,
	--CalClmAmt,ApplyTaxForClaim,SecSales
			 
	--PARLESECS/0920/091 
	SELECT DISTINCT Salid,linetype,D.DnRefId  INTO #SalDet FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B (NOLOCK) 
	ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' 
	INNER JOIN DebitNoteTopSheetClaim_Trade_PrdWise  D(NOLOCK) ON A.Schid =D.Schid 	 AND A.DNRefId = D.DnRefId AND B.DNRefId = D.DnRefId 
			
	SELECT DISTINCT A.Salid,R.CtgCode as ChnCode,RC.CtgCode As GrpCode,DnRefId,Linetype  INTO #RtrCtgDet FROM SalesInvoice A INNER JOIN #SalDet B ON A.SalId = B.Salid   
	INNER JOIN RetailervalueClass RV ON A.RtrvalueClassiD = RV.Rtrclassid
	INNER JOIN RetailerCategory RC ON RV.CtgMainId = RC.CtgMainId
	INNER JOIN RetailerCategory R ON RC.CtgLinkId = R.CtgMainId And Linetype =1 

	INSERT INTO #RtrCtgDet
	SELECT DISTINCT B.Salid,R.CtgCode as ChnCode,RC.CtgCode As GrpCode,DnRefId,Linetype    FROM ReturnHeader  A INNER JOIN #SalDet B ON A.ReturnID  = B.Salid   
	INNER JOIN RetailervalueClass RV ON A.RtrvalueClassiD = RV.Rtrclassid
	INNER JOIN RetailerCategory RC ON RV.CtgMainId = RC.CtgMainId
	INNER JOIN RetailerCategory R ON RC.CtgLinkId = R.CtgMainId And Linetype =2
--PARLESECS/0920/091
	--TRADE
	SELECT A.DNRefId,SchId, SUM(OrgClmAmt/CalClmAmt) AS ClmPer  INTO #TradePer FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)  
	ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND ApplyCapVal = 1   AND CALCLMAMT<>0
	GROUP BY SchId,A.DNRefId 
	SELECT DISTINCT A.Schid,DNDocNo,ClmDate,FrmDate,ToDate,S.CmpSchCode,BrandCode,PriceSlot_Code ,Flavor_Code,CostCenter,CirNo,CircularDate,Schbudget,
	CASE ISNULL(CalClmAmt,'') WHEN 0 THEN 0 ELSE
	CASE ApplyCapVal WHEN 1 THEN  CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax/ ClmPer ) ELSE SUM((DiscountPer+FlatAmount) / ClmPer ) END
	ELSE
	CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax) ELSE SUM(DiscountPer+FlatAmount )  END END END AS ClmAmt,SecSales,R.ChnCode,R.GrpCode  
	INTO #TradeClaimBrandWise
	FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B (NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN DebitNoteTopSheetClaim_Trade_PrdWise  D(NOLOCK) ON A.Schid =D.Schid 	 AND A.DNRefId = D.DnRefId AND B.DNRefId = D.DnRefId  
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON D.Prdid =T.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.Brand_Code 
	INNER JOIN Schememaster S(NOLOCK) ON S.Schid=A.Schid AND D.SchId = S.SchId 
	INNER JOIN #SchemeCircularDetails SC(NOLOCK) ON S.CmpSchCode=SC.CmpSchCode
	INNER JOIN #RtrCtgDet R ON R.SalId = D.Salid AND D.DnrefId = R.DNRefiD AND A.DnrefId = R.DNRefiD
	AND B.DnrefId = R.DNRefiD AND D.Linetype=R.Linetype
	LEFT OUTER JOIN #TradePer TS(NOLOCK) ON A.SchId =TS.SchId AND D.SchId = Ts.SchId AND S.schid = Ts.Schid
    AND TS.DNRefId = B.DNRefId AND Ts.DNRefId = A.DNRefId AND D.DnRefId = Ts.DNRefId 
	GROUP BY A.Schid,DNDocNo,ClmDate,FrmDate ,ToDate,S.CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate ,Schbudget,ApplyCapVal,ClmPer,
	CalClmAmt,ApplyTaxForClaim,SecSales,R.ChnCode,R.GrpCode ,PriceSlot_Code ,Flavor_Code
				 
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,ChannelCode,GrpCode,PriceSlotCode,FlavourCode)
	SELECT  @DistCode,DNDocNo,ClmDate,FrmDate,ToDate,'Trade Scheme Claim',CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget,SecSales,
	round(casT(sum(ClmAmt) AS NUMERIC(38,4)),4),'N',@Serverdate,ChnCode,GrpCode,PriceSlot_Code ,Flavor_Code
	FROM #TradeClaimBrandWise GROUP BY DNDocNo,ClmDate,FrmDate,ToDate,CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget,SecSales,ChnCode,GrpCode,PriceSlot_Code ,Flavor_Code	 
	--TOT
		SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgCode,RC.CtgName,RtrValueClassId,RC1.CtgCode As ChnCode
		INTO #Retailer1      
		FROM Retailer R (NOLOCK),      
		RetailerValueClassMap_BackUp_Tbl RVCM (NOLOCK),      
		RetailerValueClass RVC (NOLOCK),      
		RetailerCategory RC (NOLOCK),  
		RetailerCategory RC1
		WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
		AND  RVC.CtgMainId=RC.CtgMainId AND  RC1.CtgMainId=RC.CtgLinkId 

		SELECT  DNDocNo,ClmDate,FromDate ,ToDate,'TOT Claim' Clmtype,ConRefNo,ChnCode,R.CtgCode,R.CtgName,BrandCode,PriceSlot_Code ,Flavor_Code,CostCenter,CircularNO,
		CircularDate,CircularBudget,NrmlAmt,SUM(T.Diff) ClmAmt
		INTO #TotFinal1
		FROM DebitNoteTopSheetClaim_TOTDiff A(NOLOCK) 
		INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND Clmmonth='April' AND ClmYear='2020'
		INNER JOIN DebitNoteTopSheetClaim_TOT_PrdWise T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID 
		INNER JOIN TBL_GR_BUILD_PH TH (NOLOCK) ON T.Prdid =TH.PrdiD
		INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = TH.Brand_Code
		INNER JOIN #Retailer1 R(NOLOCK) ON T.Rtrid = R.RtrId AND A.CtgName = R.CtgName    
		INNER JOIN #SchemeCLaimCircular S ON S.AttrCode = R.CtgCode AND 
		--((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) AND
		ClaimTYpe='TOT Claim'  AND A.CirNo = S.CircularNo 
		GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,BrandCode,CostCenter,R.CtgCode,R.CtgName,ConRefNo,CircularNO,PriceSlot_Code ,Flavor_Code,ChnCode,
		CircularDate,CircularBudget,NrmlAmt
				
		INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
		CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,ChannelCode,GrpCode,PriceSlotCode,FlavourCode)
		SELECT @DistCode,DNDocNo,ClmDate,FromDate,ToDate,Clmtype,ConRefNo,BrandCode,CostCenter,CircularNO,CircularDate,CircularBudget,NrmlAmt,ClmAmt,
		'N',@ServerDate,ChnCode,CtgCode,PriceSlot_Code ,Flavor_Code	 
		FROM #TotFinal1 
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgCode,RC.CtgName,RtrValueClassId,RC1.CtgCode As ChnCode
	INTO #Retailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),  
    RetailerCategory RC1
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
	AND  RVC.CtgMainId=RC.CtgMainId AND  RC1.CtgMainId=RC.CtgLinkId 
			 
	SELECT  DNDocNo,ClmDate,FromDate ,ToDate,'TOT Claim' Clmtype,ConRefNo,ChnCode,R.CtgCode,R.CtgName,BrandCode,PriceSlot_Code ,Flavor_Code,CostCenter,CircularNO,
	CircularDate,CircularBudget,NrmlAmt,SUM(T.Diff) ClmAmt
	INTO #TotFinal
	FROM DebitNoteTopSheetClaim_TOTDiff A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	AND B.DNDocNo NOT IN (SELECT DNDocNo FROM #TotFinal1)
	INNER JOIN DebitNoteTopSheetClaim_TOT_PrdWise T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID 
	INNER JOIN TBL_GR_BUILD_PH TH (NOLOCK) ON T.Prdid =TH.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = TH.Brand_Code
	INNER JOIN #Retailer R(NOLOCK) ON T.Rtrid = R.RtrId AND A.CtgName = R.CtgName    
	INNER JOIN #SchemeCLaimCircular S ON S.AttrCode = R.CtgCode AND 
	--((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) AND
	ClaimTYpe='TOT Claim'  AND A.CirNo = S.CircularNo 
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,BrandCode,CostCenter,R.CtgCode,R.CtgName,ConRefNo,CircularNO,PriceSlot_Code ,Flavor_Code,ChnCode,
	CircularDate,CircularBudget,NrmlAmt
			
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,ChannelCode,GrpCode,PriceSlotCode,FlavourCode)
	SELECT @DistCode,DNDocNo,ClmDate,FromDate,ToDate,Clmtype,ConRefNo,BrandCode,CostCenter,CircularNO,CircularDate,CircularBudget,NrmlAmt,ClmAmt,
	'N',@ServerDate,ChnCode,CtgCode,PriceSlot_Code ,Flavor_Code	 
	FROM #TotFinal 
	--MANUAL
	SELECT ManualClmDesc,ValidFrom,ValidTo,CircularNo,COUNT(CostCentreCde) CntCC INTO #ManualClaimCostCentre FROM ManualClaimCostCentre(NOLOCK)
	GROUP BY ManualClmDesc,ValidFrom,ValidTo,CircularNo
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,CostCentreCde,CirNo,CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate,FromDate,Todate ,'Manual Claim','' ConRefNo,CostCentreCde,CirNo,CircularDate,0 CircularBudget,SecSales,ClmAmt/CntCC,'N',@ServerDate  
	FROM DebitNoteTopSheetClaim_Manual A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN ManualClaimDescription S(NOLOCK) ON  ((S.ValidFromDate BETWEEN A.FromDate AND A.ToDate) 
	OR (S.ValidToDate  BETWEEN A.FromDate AND ToDate) OR  (A.FromDate BETWEEN S.ValidFromDate AND S.ValidToDate) OR (A.ToDate BETWEEN S.ValidFromDate AND S.ValidToDate )) AND A.SCHDESC = S.MANUALCLMDESC AND A.CIRNO = S.CIRCULARNO
	INNER JOIN ManualClaimCostCentre M(NOLOCK) ON  M.MANUALCLMDESC = S.MANUALCLMDESC AND M.CircularNo = S.CircularNo AND  A.SchDesc = M.MANUALCLMDESC
	AND A.CIRNO = M.CircularNo AND M.ValidFrom = S.ValidFromDate OR M.ValidTo = S.ValidToDate 
	INNER JOIN #ManualClaimCostCentre N(NOLOCK) ON  N.MANUALCLMDESC = S.MANUALCLMDESC AND N.CircularNo = S.CircularNo AND  A.SchDesc = N.MANUALCLMDESC
	AND A.CIRNO = N.CircularNo AND M.ValidFrom = N.ValidFrom  AND M.ValidTo = N.ValidTo AND M.MANUALCLMDESC = N.MANUALCLMDESC AND M.CircularNo = N.CircularNo
	--DIST INCENTIVE
	SELECT DISTINCT DistIRefno,IncFromDate,IncToDate INTO #DistributorIncentiveMaster FROM DistributorIncentiveMaster A   
	INNER JOIN DebitnoteTopSheetClaim_Distinc E(NOLOCK) ON E.RefNo = A.DistIRefno  
	INNER JOIN DebitNoteTopSheetClaimHd H(NOLOCK) ON h.DNRefId = e.DNRefId AND H.Upload ='N' 
	SELECT DistIRefno,SMId,PrdId,SUM(Sales) Sales  
	INTO #DistSales
	FROM (
	SELECT DIM.DistIRefno,SS.SMId,SIP.PrdId,
	ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2) Sales 
	FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) ON SS.SalId=SIP.SalId 
	INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1 AND PBD.SLNo=3
	INNER JOIN TaxPercentage_DNClaim  PO (NOLOCK) ON PO.SalId=SS.SalId AND PO.SalId=SIP.SalId AND PO.PrdSlno=SIP.SlNo and PO.TransId=1
	AND PO.UsrId = 0 AND PO.tranId = 0
	INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
	WHERE SS.Dlvsts>3  
	GROUP  BY DIM.DistIRefno,SS.SMId,SIP.PrdId 
	UNION ALL
	SELECT DIM.DistIRefno,SS.SMId,SIP.PrdId,
	-1*ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2)  Sales 
	FROM Returnheader SS (NOLOCK) INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid 
	INNER JOIN STOCKTYPE ST (NOLOCK) ON ST.StockTypeId=SIP.StockTypeId AND ST.SystemStockType=1
	INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1  AND PBD.SLNo=3
	INNER JOIN  TaxPercentage_DNClaim PO (NOLOCK) ON PO.SalId=SS.ReturnID AND PO.SalId=SIP.ReturnID AND PO.PrdSlno=SIP.SlNo and PO.TransId=2
	INNER JOIN  #DistributorIncentiveMaster DIM ON SS.ReturnDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
	AND PO.UsrId = 0 AND PO.tranId = 0
	WHERE SS.Status=0  GROUP  BY DIM.DistIRefno,SS.SMId,SIP.PrdId
	) A
	GROUP BY DistIRefno,SMId,PrdId  
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,PriceSlotCode,FlavourCode)
	SELECT @DistCode,DNDocNo,ClmDate,IncFromDate,IncToDate ,'Distributor Incentive Claim',ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget,TotAchSales,
	SUM(ROUND(((Sales*C.IncPerc)/100),2)),'N',@ServerDate,PriceSlot_Code,Flavor_Code
	FROM #DistSales A(NOLOCK) INNER JOIN TBL_GR_BUILD_PH B(NOLOCK) ON A.Prdid = B.Prdid
	INNER JOIN DistributorIncentiveAchDetail C(NOLOCK) ON C.SMid=A.SMID  AND  A.DistIRefno=C.DistIRefno
	INNER JOIN #DistributorIncentiveMaster D(NOLOCK) ON C.DistIRefno=D.DistIRefno AND    A.DistIRefno=D.DistIRefno
	INNER JOIN DebitnoteTopSheetClaim_Distinc E(NOLOCK) ON E.RefNo = C.DistIRefno AND E.RefNo =D.DistIRefno AND  A.DistIRefno=E.RefNo
	INNER JOIN DebitNoteTopSheetClaimHd H(NOLOCK) ON h.DNRefId = e.DNRefId AND H.Upload ='N'
	INNER JOIN CostCentreDetails CC(NOLOCK) ON CC.BrandCode = B.Brand_Code
	INNER JOIN  #SchemeCLaimCircular S(NOLOCK) ON 
	--((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) AND
		S.ClaimType ='Distributor Incentive Claim'  AND E.CirNo = S.CircularNO
	GROUP BY   DNDocNo,ClmDate,ConRefNo,CirNo,CircularDate,CircularBudget,BrandCode,CostCenter,TotAchSales,IncFromDate ,IncToDate ,PriceSlot_Code,Flavor_Code
			
	SELECT DISTINCT  Prdid,SMIRefno,ClmYear,Monthid  INTO  #IncentiveProducts
	FROM (
		SELECT DISTINCT E.Prdid ,B.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B(NOLOCK)
		INNER JOIN SalesManIncentiveMaster SS(NOLOCK) ON SS.SMIRefno=B.Smirefno 
		INNER JOIN ProductCateGOryValue C (Nolock) ON B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCateGOryValue D (Nolock) ON D.PrdCtgValLinkCode  LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E  (Nolock) On	D.PrdCtgValMainId = E.PrdCtgValMainId  
		WHERE-- SS.IncMonth= DateName(mm,DATEADD(mm,@Month,-1))   AND Incyear=@Year
			B.ActStatus=1 AND SMIRefStatus = 1
		UNION
		SELECT DISTINCT E.Prdid,SS.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B(NOLOCK)
		INNER JOIN SalesManIncentiveMaster SS(NOLOCK) ON SS.SMIRefno=B.Smirefno 
		INNER JOIN Product E  (Nolock) On	E.Prdid = B.Prdid
		WHERE-- SS.IncMonth=DateName(mm,DATEADD(mm,@Month,-1))  AND Incyear=@Year
			B.ActStatus=1 AND SMIRefStatus = 1		
	) A	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo  
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND upload='N'
	SELECT DISTINCT SMIrefno,SMID,Prdid into #SMIncentive1
	FROM (
		SELECT IP.SMIRefno,SS.SMID,SIP.Prdid,Sum(Sip.prdnetamount)  Sales FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) 
		ON SS.Salid=Sip.Salid
		INNER JOIN #IncentiveProducts IP (NOLOCK)  ON   IP.Prdid=Sip.prdid 
		WHERE SS.Dlvsts>3 AND DATENAME(MM,(SS.SalInvDate))=DateName(mm,DATEADD(mm,Monthid,-1)) AND Year(SS.Salinvdate)=ClmYear --ILCRSTPAR5199
		GROUP  by SS.SMID,IP.SMIRefno,SIP.Prdid
		UNION ALL
		SELECT IP.SMIrefno,SS.SMID,SIP.Prdid,-Sum(Sip.prdnetamt)  Sales FROM Returnheader SS (NOLOCK)
		INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1) 
		INNER JOIN  #IncentiveProducts  IP (NOLOCK)  ON   SIP.Prdid=Sip.prdid   
		WHERE SS.Status=0 AND DATENAME(MM,(SS.Returndate))=DateName(mm,DATEADD(mm,Monthid,-1))  AND Year(SS.Returndate)=ClmYear --ILCRSTPAR5199
		GROUP  by SS.SMID,IP.SMIRefno,SIP.Prdid
	) A
	GROUP BY SMID,SMIRefno,Prdid
			 
	SELECT  distinct A.SMIRefno,BrandCode,PriceSlot_Code,Flavor_Code,CostCenter,A.smid into #CostCentre
	FROM #SMIncentive1 A (NOLOCK)
	INNER JOIN SalesManincentiveDetail S (NOLOCK) ON A.SMIRefno = S.SMIRefno AND A.SMID =S.SMID 
	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo AND A.SMId = B.SmID and S.SMIRefno = B.RefNo  AND S.SMId = B.SmID 
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND C.UPLOAD='N'
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON A.Prdid = T.PrdId 
	INNER JOIN CostCentreDetails CC(NOLOCK) ON CC.BrandCode = T.Brand_Code
	SELECT DISTINCT SMIRefno,Smid,count(Flavor_Code) Cnt into #Cnt FROM #CostCentre(NOLOCK) group by  SMIRefno,smid	
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,PriceSlotCode,FlavourCode)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate,DATEADD(MONTH, (Monthid)-1,DATEADD(YEAR, ClmYear - 1900, 0)) ,DATEADD(dd, -1, DATEADD(MONTH, Monthid,DATEADD(YEAR, ClmYear - 1900, 0))),
	'SalesMan Incentive Claim',ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget,TotAchSales,
	SUM((B.IncAmount/CAST(Cnt AS NUMERIC(38,6)))),'N',@ServerDate,PriceSlot_Code,Flavor_Code 
	FROM #CostCentre A(NOLOCK) 
	INNER JOIN SalesManincentiveDetail S(NOLOCK) ON A.SMIRefno = S.SMIRefno AND A.SMID =S.SMID 
	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo AND A.SMId = B.SmID and S.SMIRefno = B.RefNo  AND S.SMId = B.SmID 
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND C.UPLOAD='N'
	INNER JOIN #Cnt N(NOLOCK) ON  A.SMIRefno = N.SMIRefno AND A.SMId = N.SmID and S.SMIRefno = N.SMIRefno  AND S.SMId = N.SmID
	INNER JOIN  #SchemeCLaimCircular SS(NOLOCK) ON 
	--( SS.SchValidFrom BETWEEN @FromDate  AND @ToDate OR SS.SchValidTill BETWEEN @FromDate  AND @ToDate )   AND
	SS.ClaimType ='SalesMan Incentive Claim'
	AND B.CirNo = SS.CircularNO 
	GROUP BY DNDocNo,ClmDate,ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget,TotAchSales ,MonthId ,ClmYear,PriceSlot_Code,Flavor_Code  
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,ChannelCode,GrpCode,PriceSlotCode,FlavourCode)
	SELECT  @DistCode,DNDocNo,ClmDate,FromDate ,ToDate,'INSTITUTIONAL CLAIM' Clmtype,S.CMPSCHCODE,BrandCode,CostCenter,CircularNO,
	CircularDate,sCHEMEBudget,CurMonth,SUM(T.ClmAmt) ClmAmt,'N',@ServerDate,R1.CtgCode,R.CtgCode,TH.PriceSlot_Code,TH.Flavor_Code 
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND SCHTYPE=1
	INNER JOIN RetailerCategory R ON R.CtgName = A.CtgName 
	INNER JOIN RetailerCategory R1 ON R.CtgLinkId = R1.CtgMainId 
	INNER JOIN DebitNoteTopSheetClaim_Inst_PrdWise T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID AND R.CtgMainId = T.CTGMAINID
	INNER JOIN SchemeMaster S ON S.SchId = T.SCHID
	INNER JOIN TBL_GR_BUILD_PH TH (NOLOCK) ON T.Prdid =TH.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = TH.Brand_Code
	INNER JOIN #SchemeCircularDetails SC ON S.CMPSCHCODE = SC.CMPSCHCODE AND A.CIRNO = SC.CIRCULARNO
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,BrandCode,CostCenter,A.CtgName,S.CMPSCHCODE,CircularNO,
	CircularDate,sCHEMEBudget,CurMonth,R1.CtgCode,R.CtgCode,TH.PriceSlot_Code,TH.Flavor_Code 
		 
	
	SELECT C.DNRefId,A.TargetYear,A.TargetMonth,A.InsId,B.ChnId,A.GrpId,RC.CtgCode as GroupCode,RC1.CtgCode As ChannelCode,
	A.BrandCode,A.FlavorCode,A.PriceSlot,SUM(PrdAchievement) AS Sales,SUM(Isnull(ClmAmount,0)) as ClmAmount 
	INTO #ProductLevelAch
	FROM InsTargetDetailsProductLevelAch A 
	INNER JOIN InsTargetHD B ON A.InsId=B.InsId
	INNER JOIN RetailerCategory RC ON RC.CtgMainId = A.GrpId
	INNER JOIN RetailerCategory RC1 ON RC1.CtgMainId = B.ChnId
	INNER JOIN DebitNoteTopSheetClaimHd C ON C.ClmYear=B.TargetYear and C.MonthId=B.TargetMonth
	WHERE C.Upload='N' AND B.Confirm=1
	GROUP BY C.DNRefId,A.TargetYear,A.TargetMonth,A.InsId,B.ChnId,A.GrpId,RC.CtgCode,RC1.CtgCode,
	A.BrandCode,A.FlavorCode,A.PriceSlot -- HAVING SUM(Isnull(ClmAmount,0))>0
	SELECT DISTINCT DNRefId,FromDate,ToDate,CirNo INTO #DebitNoteTopSheetClaim_InstTarget 
	FROM DebitNoteTopSheetClaim_InstTarget A WHERE DNRefId IN (SELECT DNRefId FROM #ProductLevelAch) and SCHTYPE=0
			
	SELECT DNRefId,A.TargetYear,A.TargetMonth,GrpId,SUM(Sales) as Sales INTO #Sales FROM #ProductLevelAch A
	GROUP BY DNRefId,A.TargetYear,A.TargetMonth,GrpId
	
	UPDATE A SET A.Sales=B.Sales FROM #ProductLevelAch A INNER JOIN #Sales B ON A.DNRefId=B.DNRefId 
	AND A.TargetYear=B.TargetYear AND A.TargetMonth=B.TargetMonth AND A.GrpId=B.GrpId
	
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate,ChannelCode,GrpCode,PriceSlotCode,FlavourCode)
	SELECT @DistCode,DNDocNo,ClmDate,FromDate,ToDate,'INSTITUTIONAL CLAIM' Clmtype,SC.ConRefNo,T.BrandCode,CostCenter,CircularNO,
	CircularDate,CirCularBudget,Sales AS Sales,SUM(T.ClmAmount) ClmAmt,'N',@ServerDate,ChannelCode,GroupCode,PriceSlot,FlavorCode 
	FROM #DebitNoteTopSheetClaim_InstTarget A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' --AND SCHTYPE=0
	INNER JOIN #ProductLevelAch T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID 
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.BrandCode
	INNER JOIN #SchemeClaimCircular SC ON A.CIRNO = SC.CIRCULARNO  AND ATTRCODE=T.GroupCode 
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,T.BrandCode,CostCenter,SC.ConRefNo,CircularNO,
	CircularDate,CirCularBudget,Sales,GroupCode,ChannelCode,PriceSlot,FlavorCode 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DebitNoteTopSheetClaimDt' AND TYPE='p')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
GO
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_DebitNoteTopSheetClaimDt
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM DATA IN DETAIL
* DATE		:  14-11-2019
* CREATED	:  MOHANA S	
* PMS NO	:  CRCRSTPAR0079
******************************************************************************
16-01-2020	 MOHANA S		BZ	ILCRSTPAR7420		validation for Institutional
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt  WHERE UploadFlag ='Y'
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
		RETURN
	END
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @Month INT
	DECLARE @Year  INT
	DECLARE @SecSales NUMERIC(38,2)
	--SELECT TOP 1  @Month = MonthiD,@Year = ClmYear FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'
	--SELECT @FromDate= DATEADD(MONTH, (@Month)-1,DATEADD(YEAR, @Year - 1900, 0))
	--SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Month,DATEADD(YEAR, @Year - 1900, 0)))
	
	SELECT DISTINCT CirNo INTO #CirNO FROM (
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_SMInc		UNION    
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_DistInc	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Manual		UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_TOTDiff	UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_InstTarget UNION 
	SELECT Dnrefid,CirNo FROM DebitNoteTopSheetClaim_Sampling
	)A INNER JOIN   DebitNoteTopSheetClaimHd B ON A.DNRefId = B.DNRefId WHERE UPLOAD = 'N'
	
	SELECT DISTINCT CircularNo,ClaimType,AttrCode ,Max(CreatedDate) CreatedDate
	INTO #MaxDate
	FROM SchemeCLaimCircular WHERE CircularNo IN (SELECT CirNO FROM #CirNO)
	GROUP BY CircularNo,AttrCode,ClaimType
	
	SELECT DISTINCT ConRefNo,A.ClaimType,AttrType,A.AttrCode,A.CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular1
	FROM SchemeCLaimCircular A INNER JOIN #MaxDate B ON A.AttrCode =B.AttrCode AND A.CreatedDate =B.CreatedDate AND A.ClaimType=B.ClaimType
	AND A.CircularNo = B.CircularNo
	WHERE A.CircularNo IN (SELECT CirNO FROM #CirNO)
	
	SELECT DISTINCT ConRefNo,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular
	FROM #SchemeCLaimCircular1 
			 
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CirRefNO,CirNo,SancDate,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Sampling Claim',FromDate ,ToDate,ConRefNo,CirNo ,SancDate,SamAmt,'N',@ServerDate  from DebitNoteTopSheetClaim_Sampling A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Sampling Claim'
	-- AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,
	Wk4PriVal,SchPrimary,OrgClmAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Trade Scheme Claim',FrmDate,ToDate,SchDesc,S.CmpSchCode,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,Wk4PriVal,SchPrimary,OrgClmAmt,CalClmAmt,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN SchemeMaster S(NOLOCK) ON A.Schid =  S.Schid
	INNER JOIN SchemeCircularDetails C(NOLOCK) ON S.CmpSchCode=C.CmpSchCode  AND A.CirNo = C.CircularNo
	--AND ((SchValidFrom BETWEEN FrmDate AND ToDate) OR (SchValidTill BETWEEN FrmDate AND ToDate ))
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,Lst2MntSAl,MonTarget,CurMonth,OutletCnt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Institutional Claim',fromDate,ToDate,CtgCode,ConRefNo,CirNo,Lst2MntSAl,MonTarget ,CurMonth,OutletCnt,TotDiscount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Institutional Claim' AND AttrCode = R.CtgCode 
	--AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
	WHERE B.UPLOAD='N' AND A.SchType=0
			
	--INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,NrmlAmt,TOTAmt,ClmAmt,UploadFlag,ServerDate)
	--SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'TOT cLAIM',FromDate,TODate,CtgCode,ConRefNo,CirNo,NrmlAmt,TOTAmt,DiffAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_TOTDiff A 
	--INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)ON A.DNRefId = B.DNRefId
	--INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName 
	--INNER JOIN #SchemeCLaimCircular C (NOLOCK) ON A.CirNo=C.CircularNO AND R.CtgCode =C.AttrCode AND ClaimType ='TOT cLAIM'
	--AND ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	--WHERE B.UPLOAD='N'
			 
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,Lst2MntSAl,MonTarget,CurMonth,OutletCnt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Institutional Claim',fromDate,ToDate,CtgCode,S.CmpSchcode,CirNo,Lst2MntSAl,MonTarget ,CurMonth,OutletCnt,TotDiscount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN (SELECT DISTINCT CtgMainId,DnrefId,Schid FROM DebitNoteTopSheetClaim_Inst_prdwise) CD ON A.DNRefId = CD.DNRefId AND CD.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName AND R.CtgMainId = CD.CtgMainId 
	INNER JOIN SchemeMaster S ON S.SchId = CD.Schid 
	INNER JOIN SchemeCircularDetails C(NOLOCK) ON A.CirNo=C.CircularNO AND S.CmpSchCode =C.CmpSchcode 
	WHERE B.UPLOAD='N' AND A.SchType=1 
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,NrmlAmt,TOTAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'TOT CLAIM',FromDate,TODate,CtgCode,ConRefNo,CirNo,NrmlAmt,TOTAmt,DiffAmt,'N',@ServerDate 
	FROM DebitNoteTopSheetClaim_TOTDiff A 	 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)ON A.DNRefId = B.DNRefId
	INNER JOIN (SELECT DISTINCT DNRefId FROM  DebitNoteTopSheetClaim_TOT_PrdWise) DD ON A.DNRefId = DD.DNRefId AND  B.DNRefId = DD.DNRefId
	--INNER JOIN RetailerValueClassMap RC ON DD.Rtrid = RC.RtrId 
	--INNER JOIN RetailerValueClass RV ON RC.RtrValueClassId = RV.RtrClassId 
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName --AND R.CtgMainId = RV.CtgMainId 
	INNER JOIN #SchemeCLaimCircular C (NOLOCK) ON A.CirNo=C.CircularNO AND R.CtgCode =C.AttrCode AND ClaimType ='TOT cLAIM'
	--AND ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	WHERE B.UPLOAD='N'

	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,SecSales,LaibPer,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT  @DistCode,DNDocNo,ClmDate ,'Manual Claim',FromDate,Todate,SchDesc,''ConRefNo,CirNo,SchBudget ,SecSales ,LiabPerc,ClmAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_Manual A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,RefNo,CirRefNO,CirNo,SMCnt,TotAchSales,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'Distributor Incentive Claim',IncfromDate,InctODate,RefNo,ConRefNo,CirNO,SMCnt,TotAchSales,IncAmt,'N',@ServerDate 
	FROM DebitNoteTopSheetClaim_DistInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Distributor Incentive Claim'
	INNER JOIN DistributorIncentiveMaster D(NOLOCK) ON A.RefNo = D.DistIRefno --AND IncMonth =  DateName(mm,DATEADD(mm,@Month,-1)) AND IncYear=@Year
	--AND ((IncfromDate BETWEEN @FromDate AND @ToDate) OR (IncToDate BETWEEN @FromDate AND @ToDate )) 
	WHERE B.UPLOAD='N'
			
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,RefNo,CirRefNO, CirNo,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate ,'SalesMan Incentive Claim',RefNo,ConRefNo ,CirNO,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,A.IncAmount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_SMInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='SalesMan Incentive Claim'
	INNER JOIN SalesManincentiveDetail D(NOLOCK) ON A.RefNo = D.SMIRefno AND A.SMID =D. SMID 
	--AND INCMONTH =DateName(mm,DATEADD(mm,@Month,-1)) AND INCYEAr = @Year  
	WHERE B.UPLOAD='N'
	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET  SancDate='1900-01-01' WHERE SancDate IS NULL
	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET FromDate='1900-01-01',ToDate ='1900-01-01' WHERE FromDate IS NULL OR TODATE IS NULL
END
GO
IF EXISTS(SELECT * FROM SYS.OBJECTS  WHERE Name='Proc_RptGRNListing' And Type='P')
DROP PROC Proc_RptGRNListing
GO
--Exec Proc_RptGRNListing 8,1,0,'PmProduct',0,0,0,0
CREATE  PROCEDURE Proc_RptGRNListing
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/*
***********************************************
* DATE       AUTHOR       CR/BZ    USER STORY ID           DESCRIPTION                         
*************************************************
29-09-2020  Deepak Philip  BZ       PARLESECS/0920/205       validation added for same product different Uom type.
*/   
BEGIN
SET NOCOUNT ON
DECLARE @NewSnapId 	AS	INT
DECLARE @DBNAME		AS 	nvarchar(50)
DECLARE @TblName 	AS	nvarchar(500)
DECLARE @TblStruct 	AS	nVarchar(4000)
DECLARE @TblFields 	AS	nVarchar(4000)
DECLARE @sSql		AS 	nVarChar(4000)
DECLARE @ErrNo	 	AS	INT
DECLARE @PurDBName	AS	nVarChar(50)
DECLARE @FromDate	AS	DATETIME
DECLARE @ToDate		AS	DATETIME
DECLARE @CmpId	 	AS	INT
DECLARE @CmpInvNo 	AS	NVARCHAR(100)
DECLARE @ExcelFlag 	AS	INT
--select * from reportfilterdt
SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @CmpInvNo = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,194,@Pi_UsrId))
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
PRINT @CmpInvNo
--Create TABLE #RptPendingBillsDetails
Create TABLE #RptGRNListing
(
		PurRcptId 		BIGINT,
		PurRcptRefNo 		NVARCHAR(50),
		PrdId  			INT,
		PrdDCode 		NVARCHAR(100),
		PrdName 		NVARCHAR(100),
		PrdBatId 		INT,
		PrdBatCode 		NVARCHAR(50),
		InvBaseQty 		INT,
		RcvdGoodBaseQty 	INT,
		UnSalBaseQty 		INT,
		ShrtBaseQty 		INT,
		ExsBaseQty 		INT,
		RefuseSale 		TINYINT,
		PrdUnitLSP 		NUMERIC(38,6),
		PrdGrossAmount 		NUMERIC(38,6),
		SlNo 			INT,
		RefCode 		NVARCHAR(25),
		FieldDesc 		NVARCHAR(100),
		LineBaseQtyAmount 	NUMERIC(38,6),
		PrdNetAmount 		NUMERIC(38,6),
		Status 			TINYINT,
		InvDate 		DATETIME,
		LessScheme 		NUMERIC(38,6),
		OtherCharges 		NUMERIC(38,6),
		TotalAddition 		NUMERIC(38,6),
		TotalDeduction 		NUMERIC(38,6),
		GrossAmount 		NUMERIC(38,6),
		NetPayable 		NUMERIC(38,6),
		DifferenceAmount 	NUMERIC(38,6),
		PaidAmount 		NUMERIC(38,6),
		NetAmount 		NUMERIC(38,6),
		SpmId 			INT,
		SpmName  		NVARCHAR(50),
		LcnId 			INT,
		LcnName  		NVARCHAR(50),
		TransporterId 		INT,
		TransporterName  	NVARCHAR(50),
		CmpId 			INT,
		CmpName  		NVARCHAR(50),
		UsrId 			INT,
		CmpInvNo 		NVARCHAR(50)
	)
SET @TblName = 'RptGRNListing'
SET @TblStruct = 'PurRcptId 		BIGINT,
		PurRcptRefNo 		NVARCHAR(50),
		PrdId  			INT,
		PrdDCode 		NVARCHAR(100),
		PrdName 		NVARCHAR(100),
		PrdBatId 		INT,
		PrdBatCode 		NVARCHAR(50),
		InvBaseQty 		INT,
		RcvdGoodBaseQty 	INT,
		UnSalBaseQty 		INT,
		ShrtBaseQty 		INT,
		ExsBaseQty 		INT,
		RefuseSale 		TINYINT,
		PrdUnitLSP 		NUMERIC(38,6),
		PrdGrossAmount 		NUMERIC(38,6),
		SlNo 			INT,
		RefCode 		NVARCHAR(25),
		FieldDesc 		NVARCHAR(100),
		LineBaseQtyAmount 	NUMERIC(38,6),
		PrdNetAmount 		NUMERIC(38,6),
		Status 			TINYINT,
		InvDate 		DATETIME,
		LessScheme 		NUMERIC(38,6),
		OtherCharges 		NUMERIC(38,6),
		TotalAddition 		NUMERIC(38,6),
		TotalDeduction 		NUMERIC(38,6),
		GrossAmount 		NUMERIC(38,6),
		NetPayable 		NUMERIC(38,6),
		DifferenceAmount 	NUMERIC(38,6),
		PaidAmount 		NUMERIC(38,6),
		NetAmount 		NUMERIC(38,6),
		SpmId 			INT,
		SpmName  		NVARCHAR(50),
		LcnId 			INT,
		LcnName  		NVARCHAR(50),
		TransporterId 		INT,
		TransporterName  	NVARCHAR(50),
		CmpId 			INT,
		CmpName  		NVARCHAR(50),
		UsrId 			INT,
		CmpInvNo 		NVARCHAR(50)'
			
SET @TblFields = 'PurRcptId,PurRcptRefNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,
		ShrtBaseQty,ExsBaseQty,RefuseSale,PrdUnitLSP,PrdGrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount,
		PrdNetAmount,Status,InvDate,LessScheme,OtherCharges,TotalAddition,TotalDeduction,GrossAmount,
		NetPayable ,DifferenceAmount,PaidAmount,NetAmount,SpmId,SpmName,LcnId,LcnName,TransporterId,TransporterName,
		CmpId,CmpName,UsrId,CmpInvNo'
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
	
	EXEC Proc_GRNListing @Pi_UsrId
	INSERT INTO #RptGRNListing (PurRcptId,
		PurRcptRefNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,
		ShrtBaseQty,ExsBaseQty,PrdUnitLSP,PrdGrossAmount,SlNo,RefCode,FieldDesc,LineBaseQtyAmount,
		PrdNetAmount,Status,InvDate,LessScheme,OtherCharges,TotalAddition,TotalDeduction,GrossAmount,
		NetPayable ,DifferenceAmount,PaidAmount,NetAmount,SpmId,SpmName,LcnId,LcnName,TransporterId,TransporterName,
		CmpId,CmpName,UsrId,CmpInvNo)
		SELECT PurRcptId,
		PurRcptRefNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,SUM(InvBaseQty),SUM(RcvdGoodBaseQty),SUM(UnSalBaseQty),
		SUM(ShrtBaseQty),SUM(ExsBaseQty),dbo.Fn_ConvertCurrency(PrdUnitLSP,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(SUM(PrdGrossAmount),@Pi_CurrencyId)
		,SlNo,RefCode,FieldDesc,dbo.Fn_ConvertCurrency(SUM(LineBaseQtyAmount),@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(SUM(PrdNetAmount),@Pi_CurrencyId),Status,InvDate,dbo.Fn_ConvertCurrency(LessScheme,@Pi_CurrencyId)
		,dbo.Fn_ConvertCurrency(OtherCharges,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(TotalAddition,@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(TotalDeduction,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(GrossAmount,@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(NetPayable,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(DifferenceAmount,@Pi_CurrencyId),
		dbo.Fn_ConvertCurrency(PaidAmount,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(NetAmount,@Pi_CurrencyId),
		SpmId,SpmName,LcnId,LcnName,TransporterId,TransporterName,CmpId,CmpName,UsrId,CmpInvNo
	
		FROM TempGrnListing 
				
			WHERE ( CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR
					CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND
				( PurRcptId = (CASE @CmpInvNo WHEN 0 THEN PurRcptId ELSE 0 END) OR
	 					PurRcptId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,194,@Pi_UsrId)))
				AND
				( INVDATE between @FromDate and @ToDate and Usrid = @Pi_UsrId)
				AND ( PrdId > 0 )
		GROUP BY PurRcptId,
		PurRcptRefNo,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode
		,PrdUnitLSP,SlNo,RefCode,FieldDesc,
		Status,InvDate,LessScheme,OtherCharges,TotalAddition,TotalDeduction,GrossAmount,
		NetPayable ,DifferenceAmount,PaidAmount,NetAmount,SpmId,SpmName,LcnId,LcnName,TransporterId,TransporterName,
		CmpId,CmpName,UsrId,CmpInvNo	
--select * from rptdetails
	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptGRNListing ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +
			' CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
			+ ' (PurRcptId = (CASE ' + CAST(@CmpInvNo AS nVarchar(10)) + ' WHEN 0 THEN PurRcptId ELSE 0 END) OR ' +
			' PurRcptId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',194,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
			+ ' ( INVDATE Between ''' + @FromDate + ''' AND ''' + @ToDate + '''' + ' and UsrId = ' + CAST(@Pi_UsrId AS nVarChar(10)) + ') AND ( PrdId > 0 )'
		EXEC (@SSQL)
		PRINT 'Retrived Data From Purged Table'
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptGRNListing'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	   END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	PRINT @ErrNo
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptGRNListing ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE	
BEGIN
		SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found' 
		RETURN
	   END
END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptGRNListing
SELECT * FROM #RptGRNListing order by purrcptid
SELECT @ExcelFlag=Flag FROM RptExcelFlag WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId
		/***************************************************************************************************************************/
		--Create Table in Dynamic Cols
		--Cursors
		DECLARE  @PurRcptId BIGINT
		DECLARE  @PurRcptRefNo NVARCHAR(50)
		DECLARE  @PrdId INT
		DECLARE  @PrdBatId INT
		DECLARE  @FieldDesc NVARCHAR(100)
		DECLARE	 @LineBaseQtyAmount NUMERIC(38,6)
		DECLARE  @SlNo INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		DECLARE  @iCnt INT
		DECLARE  @Name NVARCHAR(100)
		DECLARE  @invbaseqty NVARCHAR(100)--PARLESECS/0920/205
		--DROP TABLE RptGRNListing_Excel
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptGRNListing_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE [RptGRNListing_Excel]
		DELETE FROM RptExcelHeaders Where RptId=8 AND SlNo>22 --18
		CREATE TABLE RptGRNListing_Excel (PurRcptId BIGINT,PurRcptRefNo NVARCHAR(50),CmpInvNo NVARCHAR(1000),InvDate DATETIME ,PrdId INT,PrdDCode NVARCHAR(100),PrdName NVARCHAR(100),
--				PrdBatId INT,PrdBatCode NVARCHAR(100),InvBaseQty INT,RcvdGoodBaseQty INT,UnSalBaseQty INT,ShrtBaseQty INT,ExsBaseQty INT,RefuseSale TINYINT,
				PrdBatId INT,PrdBatCode NVARCHAR(50),InvBaseQty INT,RcvdGoodBaseQty INT,Uom1 INT,Uom2 INT,Uom3 INT,Uom4 INT,				
				UnSalBaseQty INT,ShrtBaseQty INT,ExsBaseQty INT,RefuseSale TINYINT,
				PrdUnitLSP NUMERIC(38,6),PrdGrossAmount NUMERIC(38,6),UsrId INT)
		SET @iCnt=23 --19
		DECLARE Column_Cur CURSOR FOR
		SELECT DISTINCT(FieldDesc),SlNo FROM #RptGRNListing ORDER BY SlNo
		OPEN Column_Cur
			   FETCH NEXT FROM Column_Cur INTO @Column,@SlNo
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='ALTER TABLE RptGRNListing_Excel  ADD ['+ @Column +'] NUMERIC(38,6)'
					EXEC (@C_SSQL)
					
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
					
					PRINT @C_SSQL
					EXEC (@C_SSQL)
				SET @iCnt=@iCnt+1
					FETCH NEXT FROM Column_Cur INTO @Column,@SlNo
				END
		CLOSE Column_Cur
		DEALLOCATE Column_Cur
		--Insert table values
		DELETE FROM RptGRNListing_Excel
		INSERT INTO RptGRNListing_Excel(PurRcptId,PurRcptRefNo,CmpInvNo,InvDate,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,ShrtBaseQty,ExsBaseQty,RefuseSale,
									PrdUnitLSP,PrdGrossAmount,UsrId)
		SELECT DISTINCT PurRcptId,PurRcptRefNo,CmpInvNo,InvDate,PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,InvBaseQty,RcvdGoodBaseQty,UnSalBaseQty,ShrtBaseQty,ExsBaseQty,RefuseSale,PrdUnitLSP,PrdGrossAmount,@Pi_UsrId
				FROM #RptGRNListing

						select * from #RptGRNListing where prdid=53

						

		DECLARE Values_Cur CURSOR FOR
		SELECT DISTINCT PurRcptId,PurRcptRefNo,PrdId,PrdBatId,FieldDesc,LineBaseQtyAmount,invbaseqty FROM #RptGRNListing
		OPEN Values_Cur
			   FETCH NEXT FROM Values_Cur INTO @PurRcptId,@PurRcptRefNo,@PrdId,@PrdBatId,@FieldDesc,@LineBaseQtyAmount,@invbaseqty
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptGRNListing_Excel  SET ['+ @FieldDesc +']= '+ CAST(@LineBaseQtyAmount AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL+ ' WHERE PurRcptId=' + CAST(@PurRcptId AS VARCHAR(1000))
					+' AND PurRcptRefNo=''' + CAST(@PurRcptRefNo AS VARCHAR(1000))+''' AND  PrdId=' + CAST(@PrdId As VARCHAR(1000))
					+' AND PrdBatId=' + CAST(@PrdBatId AS VARCHAR(1000))+ +' AND invbaseqty=' + CAST(@invbaseqty AS VARCHAR(1000))+' AND UsrId=' + CAST(@Pi_UsrId AS Varchar(10)) +''--PARLESECS/0920/205
					EXEC (@C_SSQL)
					--PRINT @C_SSQL
					FETCH NEXT FROM Values_Cur INTO @PurRcptId,@PurRcptRefNo,@PrdId,@PrdBatId,@FieldDesc,@LineBaseQtyAmount,@invbaseqty
				END
		CLOSE Values_Cur
		DEALLOCATE Values_Cur
		-- To Update the Null Value as 0
		DECLARE NullCursor_Cur CURSOR FOR
		SELECT Name FROM dbo.sysColumns where id = object_id(N'[RptGRNListing_Excel]')
		OPEN NullCursor_Cur
			   FETCH NEXT FROM NullCursor_Cur INTO @Name
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptGRNListing_Excel SET ['+ @Name +']= '+ CAST(0 AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE '+'['+ @Name +']'+'IS NULL'+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM NullCursor_Cur INTO @Name
				END
		CLOSE NullCursor_Cur
		DEALLOCATE NullCursor_Cur
		/***************************************************************************************************************************/
--	END
/*  ADDED BY Panneer 09.07.2009  */
			UPDATE A SET Uom1 = CASE WHEN ConverisonFactor2>0 THEN Case When CAST(RcvdGoodBaseQty AS INT)>=nullif(ConverisonFactor2,0) Then CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0) Else 0 End ELSE 0 END,
			 Uom2 = CASE WHEN (ConverisonFactor2>0 AND ConverisonFactor3>0) THEN Case When (CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))>=nullif(ConverisonFactor3,0) Then isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(a.InvBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0) Else 0 End ELSE 0 END,
			 Uom3 = CASE WHEN (ConverisonFactor2>0 AND ConverisonFactor3>0 AND ConverisonFactor4>0) THEN Case When (CAST(RcvdGoodBaseQty AS INT)-((CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0))*nullif(ConverisonFactor2,0) + isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0)*nullif(Converisonfactor3,0)))>=nullif(ConverisonFactor4,0) Then
					      (CAST(RcvdGoodBaseQty AS INT)-((CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0))*nullif(ConverisonFactor2,0) + isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/Isnull(ConverisonFactor2,0)*Isnull(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0)*ISNULL(Converisonfactor3,0)))/nullif(ConverisonFactor4,0) Else 0 End ELSE 0 END
			FROM RptGRNListing_Excel A, View_ProdUOMDetails B ,ProductBatch C
			WHERE a.prdid=b.prdid AND A.Prdid = C.PrdId AND B.PrdId = C.PrdId
			SELECT A.PrdId,PrdBatId,CASE WHEN ConverisonFactor3>0 and ConverisonFactor4>0 THEN
					CASE 
						WHEN (ConverisonFactor2>0 AND ConverisonFactor3>0 AND ConverisonFactor4>0 AND ConversionFactor1>0) THEN 
							Case When 
									CAST(RcvdGoodBaseQty AS INT)-(((CAST(RcvdGoodBaseQty AS INT)/Isnull(ConverisonFactor2,0))*ISNULL(ConverisonFactor2,0)) + ((isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/isnull(ConverisonFactor3,0)),0))*nullif(ConverisonFactor3,0))+
					(((CAST(RcvdGoodBaseQty AS INT)-((CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0))*nullif(ConverisonFactor2,0) + isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0)*nullif(Converisonfactor3,0)))/nullif(ConverisonFactor4,0)) *nullif(ConverisonFactor4,0)))>=ISNULL(ConversionFactor1,0) Then
					CAST(RcvdGoodBaseQty AS INT)-(((CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0))*nullif(ConverisonFactor2,0)) + ((isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0))*nullif(ConverisonFactor3,0))+
					(((CAST(RcvdGoodBaseQty AS INT)-((CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0))*nullif(ConverisonFactor2,0) + isnull(((CAST(RcvdGoodBaseQty AS INT)-(CAST(RcvdGoodBaseQty AS INT)/nullif(ConverisonFactor2,0)*nullif(ConverisonFactor2,0)))/nullif(ConverisonFactor3,0)),0)*nullif(Converisonfactor3,0)))/nullif(ConverisonFactor4,0)) *nullif(ConverisonFactor4,0)))/ISNULL(ConversionFactor1,0) Else 0 End ELSE 0 END
					ELSE
						CASE 
							WHEN ConverisonFactor2>0 AND ConverisonFactor3=0 THEN
								Case
									When CAST(Sum(RcvdGoodBaseQty) AS INT)>=Isnull(ConverisonFactor2,0) Then
										CAST(Sum(RcvdGoodBaseQty) AS INT)%nullif(ConverisonFactor2,0)
									Else CAST(Sum(RcvdGoodBaseQty) AS INT) End
							WHEN ConverisonFactor2>0 AND ConverisonFactor3>0 AND ConverisonFactor4=0 THEN
								Case
									When CAST(Sum(RcvdGoodBaseQty) AS INT)>=Isnull(ConverisonFactor3,0) Then
										CAST(Sum(RcvdGoodBaseQty) AS INT)%nullif(ConverisonFactor3,0)
									Else CAST(Sum(RcvdGoodBaseQty) AS INT) End			
						ELSE CAST(Sum(RcvdGoodBaseQty) AS INT) END
					END  AS GRNUOM4 INTO #TEMPGRNUOM
FROM
		RptGRNListing_Excel A, View_ProdUOMDetails B 
WHERE 
		a.prdid=b.prdid
GROUP BY
		A.PrdId,ConverisonFactor4,ConverisonFactor3,ConverisonFactor2,
		RcvdGoodBaseQty,ConversionFactor1,PrdBatId
UPDATE A  SET UOM4 = GRNUOM4
FROM RptGRNListing_Excel A, #TEMPGRNUOM B WHERE a.prdid=b.prdid AND A.PrdBatId = B.PrdBatId
/*   END HERE  */
	SELECT * INTO #TempRptGRNListingSpread FROM RptGRNListing_Excel
	DELETE FROM RptColValues WHERE RptId=@Pi_RptId AND Usrid=@Pi_UsrId
	INSERT INTO RptColValues(C1,C2,C3,C4,C5,C6,C7,C8,C9,C10,C11,C12,C13,C14,C15,
							 C16,C17,C18,Rptid,Usrid)
	SELECT PurRcptRefNo,CmpInvNo,InvDate,PrdDCode,PrdName,
		PrdBatCode,InvBaseQty,RcvdGoodBaseQty,
		Uom1,Uom2,Uom3,Uom4,
		UnSalBaseQty,ShrtBaseQty,ExsBaseQty,RefuseSale,
		PrdUnitLSP,PrdGrossAmount,
		@Pi_RptId,@Pi_UsrId
	FROM #TempRptGRNListingSpread
RETURN
END
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='SpecialRateDifference'
GO
INSERT INTO Tbl_UploadIntegration(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT 85,'SpecialRateDifference','SpecialRateDifference','Cs2Cn_Prk_SpecialRateDifference',GETDATE()
GO
DELETE FROM CustomUpDownload WHERE Module ='SpecialRateDifference' and updownload='Upload'
GO
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 186,1,'SpecialRateDifference','SpecialRateDifference','Proc_Cs2Cn_SpecialRateDifference','','Cs2Cn_Prk_SpecialRateDifference','','Transaction','Upload',1
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Cs2Cn_Prk_SpecialRateDifference]') AND type in (N'U'))
DROP TABLE [Cs2Cn_Prk_SpecialRateDifference]
GO
CREATE TABLE [Cs2Cn_Prk_SpecialRateDifference](
	[Slno] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[CircularNo] [nvarchar](100) NULL,
	[InvoiceType] [nvarchar](50) NULL,
	[InvoiceNumber] [nvarchar](50) NULL,
	[InvoiceDate] [datetime] NULL,
	[CompanyRetailerCode] [nvarchar](50) NULL,
	[RetailerName] [nvarchar](50) NULL,
	[BrandCode] [nvarchar](100) NULL,
	[BrandName] [nvarchar](100) NULL,
	[PriceSlotCode] [nvarchar](100) NULL,
	[PriceSlotName] [nvarchar](100) NULL,
	[ProductCode] [nvarchar](100) NULL,
	[ProductName] [nvarchar](100) NULL,
	[Qty] [int] NULL,
	[DefaultUnitprice] [numeric](38, 2) NULL,
	[SpecialUnitPrice] [numeric](38, 2) NULL,
	[ActualGross] [numeric](38, 2) NULL,
	[SplGross] [numeric](38, 2) NULL,
	[RateDifferenceAmount] [numeric](38, 2) NULL,
	[ChannelCode] [nvarchar](100) NULL,
	[ChannelName] [nvarchar](100) NULL,
	[GroupCode] [nvarchar](100) NULL,
	[GroupName] [nvarchar](100) NULL,
	[CurrentChannelCode] [nvarchar](100) NULL,
	[CurrentChannelName] [nvarchar](100) NULL,
	[CurrentGroupCode] [nvarchar](100) NULL,
	[CurrentGroupName] [nvarchar](100) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[SpecialRateDifference]') AND type in (N'U'))
CREATE TABLE [SpecialRateDifference](
	[InvoiceNumber] [nvarchar](50) NULL,
	[InvoiceDate] [datetime] NULL,
	[CompanyRetailerCode] [nvarchar](50) NULL,
	[RetailerName] [nvarchar](50) NULL,
	[BrandCode] [nvarchar](100) NULL,
	[BrandName] [nvarchar](100) NULL,
	[PriceSlotCode] [nvarchar](100) NULL,
	[PriceSlotName] [nvarchar](100) NULL,
	[ProductCode] [nvarchar](100) NULL,
	[ProductName] [nvarchar](100) NULL,
	[Qty] [int] NULL,
	[DefaultUnitprice] [numeric](38, 2) NULL,
	[SpecialUnitPrice] [numeric](38, 2) NULL,
	[ActualGross] [numeric](38, 2) NULL,
	[SplGross] [numeric](38, 2) NULL,
	[RateDifferenceAmount] [numeric](38, 2) NULL,
	[ChannelCode] [nvarchar](100) NULL,
	[ChannelName] [nvarchar](100) NULL,
	[GroupCode] [nvarchar](100) NULL,
	[GroupName] [nvarchar](100) NULL,
	[CurrentChannelCode] [nvarchar](100) NULL,
	[CurrentChannelName] [nvarchar](100) NULL,
	[CurrentGroupCode] [nvarchar](100) NULL,
	[CurrentGroupName] [nvarchar](100) NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[ParleOutputTaxPercentageNew]') AND type in (N'U'))
DROP TABLE [ParleOutputTaxPercentageNew]
GO
CREATE TABLE [ParleOutputTaxPercentageNew](
	[TransId] [tinyint] NULL,
	[SalId] [numeric](36, 0) NULL,
	[PrdSlno] [int] NULL,
	[TaxPerc] [numeric](36, 4) NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_ReturnSalesProductTaxPercentageNew]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_ReturnSalesProductTaxPercentageNew]
GO
/*
begin tran
delete from ParleOutputTaxPercentage
EXEC Proc_ReturnSalesProductTaxPercentage '2019-04-01 ','2019-04-30 '
SELECT * FROM ParleOutputTaxPercentage where salid =  1713
rollback tran
*/
CREATE PROCEDURE [Proc_ReturnSalesProductTaxPercentageNew]
(
@Pi_Date AS DATETIME

)
AS
/******************************************************************************************************************
* PROCEDURE	: Proc_ReturnSalesProductTaxPercentage
* PURPOSE	: To Return Sales Product Taxpercent
* CREATED	: Deepan
* CREATED DATE	: 14/08/2020
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* [DATE]		[DEVELOPER]			[USER_STORY_ID]   [CR/BUG]			[DESCRIPTION]       
* 
*****************************************************************************************************************/
BEGIN
	SET NOCOUNT ON
	
	TRUNCATE TABLE ParleOutputTaxPercentageNew
	
	CREATE TABLE #SalesTax
	(
		SalId NUMERIC(36,0),
		PrdSlno INT,
		TaxPerc NUMERIC(36,4),
		TaxableAmount NUMERIC(36,4)
	)
		
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmount 
	FROM SalesInvoiceProductTax S (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
	WHERE  TaxableAmount>0 and DlvSts > 3
	AND SI.SalInvDate >=@Pi_Date
	GROUP BY S.Salid,PrdSlno,TaxableAmount
	----------- Added By lakshman M Dated ON 1-04-2019 PMS ID: ILCRSTPAR4014 
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT A.SALID,SLNO,0 AS TAXPERC,0 TAXABLEAMOUNT
	FROM SALESINVOICE A INNER JOIN SALESINVOICEPRODUCT B ON A.SALID =B.SALID  
	--INNER JOIN SALESINVOICESCHEMELINEWISE C ON C.SALID =A.SALID AND C.SALID =B.SALID AND B.PRDBATID =C.PRDBATID AND B.PRDID =C.PRDID
	WHERE SALINVDATE >=@Pi_Date AND  DLVSTS >3 AND B.SALID NOT IN (SELECT SALID FROM SALESINVOICEPRODUCTTAX)
	-------- Till Here ----------------------
	SELECT Salid,PrdSlno Into #TaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1 FROM #SalesTax TT
	INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #MaxTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #MinTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
			
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentageNew(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 1,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
	
	DELETE FROM #SalesTax
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmt 
	FROM ReturnProductTax S INNER JOIN ReturnHeader SI ON S.ReturnId=SI.ReturnId
	WHERE  TaxableAmt>0 and SI.Status=0
	AND SI.ReturnDate >= @Pi_Date
	GROUP BY S.ReturnId,PrdSlno,TaxableAmt ORDER BY PrdSlno

	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT a.ReturnId,slno,0 as TaxPerc,0 TaxableAmount
	from ReturnHeader a inner join Returnproduct B On A.ReturnId =b.ReturnId  
	--inner join salesinvoiceschemelinewise C ON c.salid =a.salid and c.salid =b.salid and b.prdbatid =c.prdbatid and b.prdid =c.prdid
	where Returndate >= @Pi_Date and A.Status=0 AND a.ReturnId not in (select Returnid from ReturnProductTax )
	
	SELECT Salid,PrdSlno Into #ReturnTaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1 
	FROM #SalesTax TT
	INNER JOIN #ReturnTaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #ReturnTaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #RetMaxTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #RetMinTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentageNew(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 2,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_SpecialRateDifference]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_SpecialRateDifference]
GO
--EXEC Proc_Cs2Cn_SpecialRateDifference 0,'2020-08-17'
CREATE PROCEDURE [Proc_Cs2Cn_SpecialRateDifference]
(    
@Po_ErrNo INT OUTPUT,    
@ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_SpecialRateDifference    
* PURPOSE  : To Extract Rate Difference   from CoreStocky to upload to Console    
* CREATED BY : Deepan
* CREATED DATE : 14/08/2020    
* NOTE   :    
* MODIFIED BY : 
* MODIFIED DATE : 
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************    
14-08-2020  Deepan       CR								Rate Difference
***************************************************************************************************/    
SET NOCOUNT ON    
BEGIN    
	DECLARE @DistCode As nVarchar(50)    
	DECLARE @CutoffDate DATETIME
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	DECLARE @GroupCode NVARCHAR(50)
	SET @Po_ErrNo=0    
	DELETE FROM Cs2Cn_Prk_SpecialRateDifference WHERE UploadFlag = 'Y'    
	SELECT @DistCode = DistributorCode FROM Distributor     
	SET @CutoffDate='2020-04-01'
	
	EXEC Proc_ReturnSalesProductTaxPercentageNew @CutoffDate

	SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentageNew (NOLOCK)  
	
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.SplRate END As  SalSplRate,         
	SP.OrgSelRate AS ActualSelRate,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate ,RtrValueClassId        
	INTO #BillingDetails1          
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
	WHERE SalInvDate>=@CutoffDate  AND S.DlvSts > 3  
  
			
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SIP.SplRate END As  SalSplRate,         
	SIP.OrgSelRate AS ActualSelRate,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,RtrValueClassId         
	INTO #ReturnDetails1          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)  
	INNER JOIN SalesInvoiceProduct SIP ON S.SAlid = SIP.SalId AND SP.PrdId = SIP.PrdId AND SP.PrdBatId = SIP.PrdBatId AND SIP.SLno = SP.ActSalRowId
	WHERE ReturnDate >=@CutoffDate  AND S.[Status] = 0  
	
	
	SELECT DISTINCT A.RtrId,A.CmpRtrCode,RCY.CtgCode AS ChannelCode,RCY.CtgName AS ChannelName,RY.CtgCode AS GroupCode,RY.CtgName AS GroupName 
	INTO #Retailer FROM Retailer A 
	INNER JOIN RetailerValueClassMap RM (NOLOCK) ON A.RtrId=RM.RtrId
	INNER JOIN RetailerValueClass RC(NOLOCK) ON RM.RtrValueClassId =RC.RtrClassId
	INNER JOIN RetailerCategory RY(NOLOCK)  ON RC.CtgMainId = RY.CtgMainId
	INNER JOIN RetailerCategoryLevel RCL(NOLOCK)  ON RY.CtgLevelId = RCL.CtgLevelId
	INNER JOIN RetailerCategory RCY(NOLOCK)  ON  RY.CtgLinkId=RCY.CtgMainId
 
	SELECT tranid,Refid,Rtrid,RtrValueClassId,InvoiceType,GroupName,RefNo,RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate, ActualSelRate SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno      
	INTO #TotClaim FROM(      
	SELECT 1 tranid,Salid Refid,A.Rtrid,A.RtrValueClassId,'Sales' InvoiceType,GroupName,SalInvNo RefNo, Salinvdate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid  --and A.RtrValueClassId = B.RtrValueClassId 
	UNION       
	SELECT 2 Transid,ReturnID Refid,A.Rtrid,A.RtrValueClassId,'Return' InvoiceType,GroupName,Returncode RefNo, ReturnDate RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate,Slno  
	FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid    --and A.RtrValueClassId = B.RtrValueClassId     
	)A  

	SELECT '1900-01-01' FromDate,'1900-01-01' ToDate,MONTH(RefDate) AS RefMonth,Year(RefDate) AS RefYear,tranid,Refid,Rtrid,RtrValueClassId,InvoiceType,GroupName,RefNo,RefDate,Prdid,Prdbatid,BaseQty,SalSplRate,ActualSelRate, SelRate,Nrmlrate,SplRate,Diff,Slno INTO #TotClaim1 FROM #TotClaim
	
	UPDATE #TotClaim1 SET FromDate= CONVERT(CHAR(10),DATEADD(MONTH, (RefMonth)-1,DATEADD(YEAR, RefYear - 1900, 0)),121), ToDate=CONVERT(CHAR(10),DATEADD(dd, -1, DATEADD(MONTH, RefMonth,DATEADD(YEAR, RefYear - 1900, 0))),121)
	
	

	
	SELECT DISTINCT B.Refid,B.RefNo,R.CtgCode as ChnCode,R.CtgName AS ChnName,RC.CtgCode As GrpCode,RC.CtgName AS GrpName
	INTO #RtrCtgDet FROM #TotClaim B 
	INNER JOIN RetailervalueClass RV ON B.RtrvalueClassiD = RV.Rtrclassid
	INNER JOIN RetailerCategory RC ON RV.CtgMainId = RC.CtgMainId
	INNER JOIN RetailerCategory R ON RC.CtgLinkId = R.CtgMainId 

	
	UPDATE A SET A.SplRate = (BaseQty*((A.SalSplRate)+(A.SalSplRate*(p.TaxPerc/100)))) FROM  #TotClaim1 A 
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate <>0  

	UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim1 A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.SalSplRate =0

	UPDATE A SET A.NrmlRate = (BaseQty*(( ActualSelRate)+(ActualSelRate*(P.TaxPerc/100)))) FROM  #TotClaim1 A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid 

	UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim1 A 


	

	
	INSERT INTO Cs2Cn_Prk_SpecialRateDifference(DistCode,InvoiceType,InvoiceNumber,InvoiceDate,CompanyRetailerCode,RetailerName,
	BrandCode,BrandName,PriceSlotCode,PriceSlotName,ProductCode,ProductName,Qty,DefaultUnitprice,SpecialUnitPrice,ActualGross,SplGross,RateDifferenceAmount,UploadFlag)
	SELECT @DistCode,InvoiceType,RefNo,RefDate,R.CmpRtrCode,R.RtrName,TG.Brand_Code,TG.Brand_Caption,TG.PriceSlot_Code,TG.PriceSlot_Caption, 
	P.PrdCCode,P.PrdName,b.BaseQty,B.ActualSelRate, B.SalSplRate, B.NrmlRate, B.SplRate,B.Diff,'N' AS  UploadFlag
	FROM #TotClaim1 B INNER JOIN Retailer R(NOLOCK) ON B.RtrId =R.RtrId 
	INNER JOIN TBL_GR_BUILD_PH TG(NOLOCK) ON B.PrdId=TG.PrdId
	INNER JOIN Product P(NOLOCK) ON P.PrdId =B.PrdId  WHERE B.Diff >0 AND RefNo NOT IN(SELECT InvoiceNumber FROM SpecialRateDifference)

	UPDATE Cs2Cn_Prk_SpecialRateDifference SET CurrentChannelCode=R.ChannelCode,CurrentChannelName =R.ChannelName,CurrentGroupCode =R.GroupCode,CurrentGroupName =R.GroupName 
	FROM Cs2Cn_Prk_SpecialRateDifference C INNER JOIN #Retailer R ON C.CompanyRetailerCode=R.CmpRtrCode


	UPDATE Cs2Cn_Prk_SpecialRateDifference SET ChannelCode=R.ChnCode,ChannelName=R.ChnName,GroupCode=R.GrpCode,GroupName=R.GrpName
	FROM Cs2Cn_Prk_SpecialRateDifference C INNER JOIN #RtrCtgDet R ON C.InvoiceNumber=R.RefNo 
	
	DECLARE Cur_Circular CURSOR
	FOR
		SELECT DISTINCT T.FromDate,T.ToDate,C.CurrentGroupCode FROM #TotClaim1 T INNER JOIN Cs2Cn_Prk_SpecialRateDifference C ON T.RefNo=InvoiceNumber
	OPEN Cur_Circular
	FETCH NEXT FROM Cur_Circular INTO @FromDate,@ToDate,@GroupCode
	WHILE @@FETCH_STATUS = 0
	BEGIN
	
	IF OBJECT_ID('tempdb..#MAXDATE') IS NOT NULL
	DROP TABLE #MAXDATE
	
	IF OBJECT_ID('tempdb..#CIRCULAR') IS NOT NULL
	DROP TABLE #CIRCULAR
	
	SELECT DISTINCT  B.CtgName,AttrCode ,MAX(CREATEDDATE) CREATEDDATE INTO #MAXDATE FROM SchemeClaimCircular A --WHERE  
	INNER JOIN RetailerCategory B ON A.AttrCode = B.CtgCode AND A.AttrType<>'Class'
	INNER JOIN #Retailer R ON B.CtgCode=R.GroupCode AND A.AttrCode = R.GroupCode
	AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
	WHERE ClaimType='TOT Claim' AND A.AttrCode=@GroupCode GROUP BY B.CtgName,AttrCode
	
	SELECT CtgName,CircularNo,B.AttrCode INTO #CIRCULAR FROM SchemeClaimCircular A INNER JOIN #MAXDATE B ON A.AttrCode = B.AttrCode AND A.CreatedDate =B.CREATEDDATE 
	WHERE A.AttrCode=@GroupCode


	UPDATE Cs2Cn_Prk_SpecialRateDifference SET CircularNo =CI.CircularNo  FROM Cs2Cn_Prk_SpecialRateDifference C INNER JOIN #CIRCULAR CI ON C.CurrentGroupName =CI.CtgName
	INNER JOIN #TotClaim1 T ON C.InvoiceNumber=T.RefNo 
	WHERE C.CircularNo IS NULL AND T.FromDate=@FromDate AND T.ToDate=@ToDate AND C.CurrentGroupCode=@GroupCode
	
	FETCH NEXT FROM Cur_Circular INTO @FromDate,@ToDate,@GroupCode
	END
	CLOSE Cur_Circular
	DEALLOCATE Cur_Circular

	

	INSERT INTO SpecialRateDifference(InvoiceNumber,InvoiceDate,CompanyRetailerCode,RetailerName,BrandCode,BrandName,PriceSlotCode,PriceSlotName,ProductCode,ProductName,Qty,DefaultUnitprice,SpecialUnitPrice,
	ActualGross,SplGross,RateDifferenceAmount,ChannelCode,ChannelName,GroupCode,GroupName,CurrentChannelCode,CurrentChannelName,CurrentGroupCode,CurrentGroupName)
	SELECT InvoiceNumber,InvoiceDate,CompanyRetailerCode,RetailerName,BrandCode,BrandName,PriceSlotCode,PriceSlotName,ProductCode,ProductName,Qty,DefaultUnitprice,SpecialUnitPrice,
	ActualGross,SplGross,RateDifferenceAmount,ChannelCode,ChannelName,GroupCode,GroupName,CurrentChannelCode,CurrentChannelName,CurrentGroupCode,CurrentGroupName FROM
	Cs2Cn_Prk_SpecialRateDifference WHERE InvoiceNumber NOT IN(SELECT InvoiceNumber FROM SpecialRateDifference)
	
	UPDATE Cs2Cn_Prk_SpecialRateDifference SET ServerDate=@ServerDate   
END
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName='SamplingDetails'
INSERT INTO Tbl_UploadIntegration
SELECT 86,'SamplingDetails','SamplingDetails','Cs2Cn_Prk_SamplingDetails',GETDATE() 
GO
DELETE FROM CustomUpDownload WHERE UPDOWNLOAD='Upload' AND MODULE='SamplingDetails'
INSERT INTO CustomUpDownload
SELECT 187,1,'SamplingDetails','SamplingDetails','Proc_Cs2Cn_SamplingDetails','','Cs2Cn_Prk_SamplingDetails','','Transaction','Upload',1 
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Cs2Cn_Prk_SamplingDetails' AND TYPE='U')
BEGIN
CREATE TABLE Cs2Cn_Prk_SamplingDetails
(
	SlNo			NUMERIC(38, 0) IDENTITY(1,1) NOT NULL,
	DistCode		NVARCHAR(50) NULL,
	IssueRefNo		NVARCHAR(150) NULL,
	IssueDate		DATETIME NULL,
	RtrCode			NVARCHAR(150) NULL,
	RtrName			NVARCHAR(150) NULL,
	ProductCode		NVARCHAR(150) NULL,
	Brand_Code		NVARCHAR(150) NULL,
	Flavor_Code		NVARCHAR(150) NULL,
	PriceSlot_Code	NVARCHAR(150) NULL,
	IssueBaseQty	INT NULL,
	LSP				NUMERIC(38,6) NULL,
	TaxableAmt		NUMERIC(38,6) NULL,
	TaxAmt			NUMERIC(38,6) NULL,
	TotalAmt		NUMERIC(38,6) NULL,
	UploadFlag		NVARCHAR(10) NULL,
	SyncId			NUMERIC(38, 0) NULL,
	ServerDate		DATETIME NULL
)
END
GO
IF NOT EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME='Sampling_Track' AND TYPE='U')
BEGIN
	CREATE TABLE Sampling_Track
	(
		IssueRefNo		NVARCHAR(100),
		UploadedDate	DATETIME
	)

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_SamplingDetails' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_SamplingDetails
GO
/*
BEGIN TRAN
TRUNCATE TABLE Cs2Cn_Prk_SamplingDetails
EXEC Proc_Cs2Cn_SamplingDetails 0,'2020-05-01' 
SELECT *FROM Sampling_Track
SELECT *FROM Cs2Cn_Prk_SamplingDetails
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cs2Cn_SamplingDetails
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME 
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_SamplingDetails
* PURPOSE		: To Extract Sampling details to console
* CREATED BY	: MOHANA S
* CREATED DATE	: 2020-09-08
* PMS NO		: PARCS202100067
* MODIFIED
*********************************/
SET NOCOUNT ON
BEGIN	
    SET @Po_ErrNo= 0
	DECLARE @DistCode	As nVarchar(50)
	SELECT @DistCode = DistributorCode FROM Distributor	(NOLOCK)	
	DELETE FROM Cs2Cn_Prk_SamplingDetails WHERE UploadFlag='Y'

	EXEC Proc_GR_Build_PH

	INSERT INTO Cs2Cn_Prk_SamplingDetails(DistCode,IssueRefNo,IssueDate,RtrCode,RtrName,ProductCode,Brand_Code,Flavor_Code,PriceSlot_Code,
	IssueBaseQty,LSP,TaxableAmt,TaxAmt,TotalAmt,UploadFlag,ServerDate)
	SELECT @DistCode,IssueRefNo,IssueDate,RtrCode,RtrName,ProductCode,Brand_Code,Flavor_Code,PriceSlot_Code,IssueBaseQty,PrdBatDetailValue,SUM(TaxableAmt) TaxableAmt,Sum(TaxAmt) TaxAmt,Sum(TotalAmt) TotalAmt,
	'N',@ServerDate 
	FROM FreeIssueHD A INNER JOIN FreeIssueDT B ON A.IssueId = B.IssueId AND Status = 1 AND IssueDate >='2020-04-01'
	INNER JOIN Tbl_GR_Build_PH C ON B.PrdId = C.PrdId 
	INNER JOIN Retailer R ON R.Rtrid = A.Rtrid
	INNER JOIN ProductBatchDetails P ON B.PriceId = P.Priceid  AND Slno=2
	WHERE IssueRefNo NOT IN (SELECT IssueRefNo FROM Sampling_Track )
	GROUP BY IssueRefNo,IssueDate,ProductCode,Brand_Code,Flavor_Code,PriceSlot_Code,IssueBaseQty,PrdBatDetailValue,RtrCode,RtrName

	INSERT INTO Sampling_Track(IssueRefNo,UploadedDate)
	SELECT DISTINCT IssueRefNo,GETDATE() FROM Cs2Cn_Prk_SamplingDetails

END
GO
--DELETE FROM CustomCaptions WHERE TransId=2 and CtrlId=1000 and SubCtrlId=269 
--INSERT INTO CustomCaptions(TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,
--Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,
--Visibility,Enabled)
--SELECT 2,1000,269,'Msgbox-2-1000-269','','','Price (Or) Tax mismatch found ,Please select the batch again for the mentioned rows ,kinldy delete the product and re-generated the invoice :',1,
--1,1,'2020-10-07',1,'2020-10-07','','','Price (Or) Tax mismatch found ,Please select the batch again for the mentioned rows ,kinldy delete the product and re-generated the invoice. :',1,1
--GO
DELETE FROM CustomCaptions WHERE TransId=2 and CtrlId=1000 and SubCtrlId=266 
INSERT INTO CustomCaptions(TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,
Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,
Visibility,Enabled)
SELECT 2,1000,266,'Msgbox-2-1000-266','','','Price (Or) Tax mismatch found ,Please select the batch again for the mentioned rows ,kinldy delete the product and re-generated the invoice :',1,
1,1,'2020-10-07',1,'2020-10-07','','','Price (Or) Tax mismatch found ,Please select the batch again for the mentioned rows ,kinldy delete the product and re-generated the invoice. :',1,1
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_TaxNotAppliedProduct]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_TaxNotAppliedProduct]
GO
--SELECT * FROM DBO.Fn_TaxNotAppliedProduct(60799)
CREATE FUNCTION [Fn_TaxNotAppliedProduct](@Salid AS BIGINT)
RETURNS @NonTaxProduct TABLE (Salid BIGINT ,Slno INT)
/*********************************
* FUNCTION : Fn_TaxNotAppliedProduct
* PURPOSE   : Validate Salesinvoice tax and Salesinvoice Product table data
* CREATED   : Murugan.R
* CREATED DATE    : 05/05/2020
* NOTE            : 
* MODIFIED
* DATE			 AUTHOR			CR\BUG		USER STORY ID						DESCRIPTION
------------------------------------------------
* 05/05/2020	Murugan.R		BUG			PARCS202100017(PARLESECS/0520/013) 	Validate Salesinvoice product table data.
* 07/10/2020	Govindaraj.P		ILCRSNES523		  Bug		Some Product got missed..
*********************************/
AS
BEGIN
	INSERT INTO @NonTaxProduct(Salid,Slno)
	SELECT Salid,Slno-1 FROM SalesInvoiceProduct A (Nolock) 
	WHERE 
	NOT EXISTS(SELECT Salid,Prdslno FROM SalesInvoiceProductTax B (Nolock) where A.Salid=B.Salid and A.Slno=B.Prdslno)
	AND SalId=@Salid
	----Record not exists in SalesInvoiceProduct table post save the invoice  , validation added
	IF NOT EXISTS(SELECT 'X' FROM SalesInvoiceProduct (NOLOCK) WHERE  SalId=@Salid)
	BEGIN
		INSERT INTO @NonTaxProduct(Salid,Slno)
		SELECT @Salid,2
	END

	INSERT INTO @NonTaxProduct(Salid,Slno)
	SELECT DISTINCT A.Salid,A.Slno-1 
      FROM SalesInvoiceProduct A (Nolock)
      WHERE Salid=@Salid AND NOT EXISTS(SELECT * FROM ProductBatch B (NOLOCK)  
      INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId=B.BatchSeqId
      INNER JOIN Productbatchdetails C (NOLOCK) ON C.PrdbatId=B.PrdbatId and BC.Slno=C.Slno  
      AND BC.BatchSeqId=C.BatchSeqId  AND A.PriceId=C.PriceId AND A.PrdBatId=B.PrdBatId AND A.Prdid=B.Prdid
      WHERE RefCode='C')
      
	--SELECT A.Salid,A.Slno-1 
	--FROM SalesInvoiceProduct A (Nolock) 
	--INNER JOIN ProductBatch B (NOLOCK) ON A.Prdid=B.Prdid AND A.PrdBatId=B.PrdBatId 
	--INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId=B.BatchSeqId
	--INNER JOIN Productbatchdetails C (NOLOCK) ON C.PrdbatId=B.PrdbatId and BC.Slno=C.Slno  
	--AND BC.BatchSeqId=C.BatchSeqId
	--AND A.PriceId<>C.PriceId 
	--WHERE RefCode='C'
	--AND Salid=@Salid
      
      
	RETURN
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TransactionWiseGrnTracking]') AND type in (N'U'))
BEGIN 
	ALTER TABLE  TransactionwiseGRNTracking ALTER COLUMN  GrnPrdSlNo  INT NOT NULL
	DECLARE @SQL VARCHAR(4000)
	SET @SQL = 'ALTER TABLE dbo.TransactionwiseGRNTracking DROP CONSTRAINT |ConstraintName| '
	SET @SQL = REPLACE(@SQL, '|ConstraintName|', ( SELECT name FROM sysobjects WHERE xtype = 'PK'AND parent_obj =OBJECT_ID('TransactionwiseGRNTracking')))
	--PRINT @SQL
	EXEC (@SQL)
	ALTER TABLE  TransactionwiseGRNTracking ADD CONSTRAINT PK_TRwiseGRNTracking 
	PRIMARY KEY CLUSTERED (RefNo, Refdate, Prdid, PrdBatid, Slno, GrnQty, PurRcptRefNo,GrnPrdSlNo)
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Pincode' and MasterName='Company Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Company Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Pincode','Varchar',20,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Pincode' and MasterName='Supplier Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Supplier Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Pincode','Varchar',20,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='PAN Number' and MasterName='Vehicle Maintenance')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Vehicle Maintenance'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'PAN Number','Varchar',10,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='GSTIN' and MasterName='Vehicle Maintenance')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Vehicle Maintenance'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'GSTIN','Varchar',20,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Vehicle Name' and MasterName='Vehicle Maintenance')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Vehicle Maintenance'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Vehicle Name','Varchar',100,0,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Distance level Km' and MasterName='Retailer Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Retailer Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Distance level Km','Numeric',10,2,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DECLARE @MasterId AS INT
DECLARE @UdcMasterId AS INT
IF NOT EXISTS(SELECT 'X' FROM UdcMaster A (NOLOCK) INNER JOIN UdcHd B(NOLOCK)  ON A.MasterId=B.MasterId
				 WHERE ColumnName='Distance level Km' and MasterName='Supplier Master')
BEGIN				 
	SELECT @MasterId=MasterId FROM UdcHd with (nolock) WHERE MasterName='Supplier Master'
	IF @MasterId>0
	BEGIN
		SELECT @UdcMasterId=ISNULL(MAX(UdcMasterId),1) FROM UdcMaster (NOLOCK)
		SET @UdcMasterId=ISNULL(@UdcMasterId,1)
		IF @UdcMasterId>0
		BEGIN
			INSERT INTO UdcMaster(UdcMasterId,MasterId,ColumnName,ColumnDataType,ColumnSize,
			ColumnPrecision,ColumnMandatory,PickFromDefault,Availability,LastModBy,LastModDate,AuthId,
			AuthDate,Editable)
			SELECT @UdcMasterId+1,@MasterId,'Distance level Km','Numeric',10,2,0,0,1,1,Getdate(),1,GETDATE(),1
			
			UPDATE Counters Set CurrValue=@UdcMasterId+1 where TabName='UdcMaster' and FldName='UdcMasterId'
		END
	END
END
GO
DELETE FROM TBL_DOWNLOADINTEGRATION WHERE ProcessName ='DiscountHeader_NP'
INSERT INTO Tbl_DownloadIntegration 
SELECT 94,'DiscountHeader_NP','Cn2Cs_Prk_ContractPricing_Header_NP','Proc_Import_ContractPricing',0,500,GETDATE()
GO
DELETE FROM TBL_DOWNLOADINTEGRATION WHERE  ProcessName ='DiscountDetail_NP'
INSERT INTO Tbl_DownloadIntegration 
SELECT 95,'DiscountDetail_NP','Cn2Cs_Prk_ContractPricing_Detail_NP','Proc_Import_ContractPricing',0,500,GETDATE()
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND Module='DiscountHeader_NP'
INSERT INTO CustomUpDownload
SELECT 283,1,'DiscountHeader_NP','DiscountHeader_NP','','Proc_Import_ContractPricing','Cn2Cs_Prk_ContractPricing_Header_NP','Proc_Cn2Cs_Dummy','Master','Download',1
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND Module='DiscountDetail_NP'
INSERT INTO CustomUpDownload
SELECT 284,1,'DiscountDetail_NP','DiscountDetail_NP','','Proc_Import_ContractPricing','Cn2Cs_Prk_ContractPricing_Detail_NP','Proc_Cn2Cs_DiscountMaster_NP','Master','Download',1
GO
DELETE FROM CustomUpDownload WHERE Module='GST Invoice Correction'
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,
ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 162,1,'GST Invoice Correction','GST Invoice Correction','Proc_Cs2Cn_GSTInvoiceNumberCorrection','','Cs2Cn_Prk_GSTInvoiceNumberCorrection','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName='GST Invoice Correction'
INSERT INTO Tbl_UploadIntegration(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT 62,'GST Invoice Correction','GST Invoice Correction','Cs2Cn_Prk_GSTInvoiceNumberCorrection',GETDATE()
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='DebitnoteTopsheetClaimHd' AND TYPE ='U')
BEGIN
	IF NOT EXISTS (SELECT * FROM DebitnoteTopsheetClaimHd WHERE MonthId = 0)
	BEGIN
		IF NOT EXISTS(SELECT * FROM Sys.check_constraints WHERE Name ='CK_MonthId>0'  AND Parent_object_id = object_id ('DebitnoteTopsheetClaimHd'))
		BEGIN
		ALTER TABLE  DebitnoteTopsheetClaimHd ADD CONSTRAINT  [CK_MonthId>0] CHECK ([Monthid] > 0)
		END
	 
		IF NOT EXISTS(SELECT * FROM Sys.check_constraints WHERE Name ='CK_ClmYear>0' AND Parent_object_id = object_id ('DebitnoteTopsheetClaimHd') )
		BEGIN
		ALTER TABLE  DebitnoteTopsheetClaimHd ADD CONSTRAINT  [CK_ClmYear>0] CHECK (ClmYear > 0)
		END

	END
END
GO
IF EXISTS (SELECT * FROM Tbl_Generic_Reports A WHERE RptName ='Distributor Incentive Master Report')
BEGIN
UPDATE A SET RptName ='STO Incentive Report' FROM Tbl_Generic_Reports A WHERE RptName ='Distributor Incentive Master Report'
END
GO
IF EXISTS (SELECT * FROM Tbl_Generic_Reports A WHERE RptName = 'SalesManIncentiveMasterReport')
BEGIN
UPDATE A SET RptName ='Unit ROI Incentive Report' FROM Tbl_Generic_Reports A WHERE RptName ='SalesManIncentiveMasterReport'
END
GO
IF EXISTS (SELECT * FROM Tbl_Generic_Reports_Filters A WHERE RptName ='Distributor Incentive Master Report')
BEGIN
UPDATE A SET RptName ='STO Incentive Report' FROM Tbl_Generic_Reports_Filters A WHERE RptName ='Distributor Incentive Master Report'
END
GO
IF EXISTS (SELECT * FROM Tbl_Generic_Reports_Filters A WHERE RptName = 'SalesManIncentiveMasterReport')
BEGIN
UPDATE A SET RptName ='Unit ROI Incentive Report' FROM Tbl_Generic_Reports_Filters A WHERE RptName ='SalesManIncentiveMasterReport'
END
GO
----Live Script Updater Ends
UPDATE UtilityProcess SET VersionId = '3.1.0.22' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.22',444
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 444)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(444,'D','2020-10-10',GETDATE(),1,'Core Stocky Service Pack 444')
GO