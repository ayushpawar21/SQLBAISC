--[Stocky HotFix Version]=408
DELETE FROM Versioncontrol WHERE Hotfixid='408'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone) 
VALUES('408','3.1.0.0','D','2013-09-13','2013-09-13','2013-09-13',CONVERT(VARCHAR(11),GETDATE()),'PARLE-Major: Product Release August CR')
GO
UPDATE Supplier SET SpmTinNo = '0' WHERE SpmTinNo IS NULL
GO
DELETE FROM HotSearchEditorHd WHERE FormId = 10055
INSERT INTO HotSearchEditorHd SELECT 10055,'Mass Update Tool','SMRoute','Select','SELECT RMId,RMCode,RMName FROM (SELECT RM.RMId,RM.RMCode,RM.RMName FROM RouteMaster RM LEFT OUTER JOIN SalesManMarket SM (NOLOCK) ON SM.RMId=RM.RMId WHERE SM.SMId=vFParam AND RM.RMId NOT IN(vSParam))a'
GO
DELETE FROM HotSearchEditorHd WHERE FormId = 10056
INSERT INTO HotSearchEditorHd SELECT 10056,'Mass Update Tool','AllSMRoute','Select','SELECT RMId,RMCode,RMName FROM RouteMaster (NOLOCK) WHERE RMId NOT IN (vFParam)'
GO
IF NOT EXISTS(SELECT * FROM Sysobjects WHERE name = 'LogisticMaterialMaster' AND XType = 'U')
BEGIN	
	CREATE TABLE LogisticMaterialMaster
	(
		MaterialId INT NULL,
		MaterialCode NVARCHAR(200) NULL,
		MaterialName NVARCHAR(200) NULL,
		Availability INT,
		LastModBy INT,
		LastModDate DATETIME,
		AuthID INT,
		AuthDate DATETIME
	) 
END
GO
IF EXISTS(SELECT * FROM Sysobjects WHERE name = 'Etl_LogisticMaterialStock' AND XType = 'U')
DROP TABLE Etl_LogisticMaterialStock
GO
CREATE TABLE Etl_LogisticMaterialStock
(
	InvoiceNumber	NVARCHAR(200) NULL,
	MaterialCode NVARCHAR(200) NULL,
	QtyReceived INTEGER,
	Status Tinyint	
) 
GO
IF NOT EXISTS(SELECT * FROM Sysobjects WHERE name = 'PurchaseLogisticMaterialStock' AND XType = 'U')
IF NOT EXISTS(SELECT * FROM Sysobjects WHERE name = 'PurchaseLogisticMaterialStock' AND XType = 'U')
BEGIN
CREATE TABLE PurchaseLogisticMaterialStock
(
	PurRcptId	BIGINT NOT NULL,
	MaterialId INT NOT NULL,
	VehicleNo  NVARCHAR(200) NULL,  
	QtyReceived INTEGER,
	QtyReturned INTEGER,
	QtyBalance INTEGER,
	Availability TinyINT,
	LastModBy TinyINT,
	LastModDate DateTime,
	AuthId TinyINT,
	AuthDate DateTime,
	UploadFlag TinyINT,
	CONSTRAINT PK_PurRcptId_MaterialId PRIMARY KEY CLUSTERED
	(
		PurRcptId,
		MaterialId
	)	
	
)
END
GO
IF  NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='PurchaseOrderProductTax' and XTYPE='U')
BEGIN
	CREATE TABLE PurchaseOrderProductTax
	(
		PurorderRefNo nvarchar(25) NOT NULL,
		PrdSlNo int NOT NULL,
		TaxId int NOT NULL,
		TaxPerc numeric(10, 6) NOT NULL,
		TaxableAmount numeric(18, 6) NOT NULL,
		TaxAmount numeric(18, 6) NOT NULL,
		Availability tinyint NOT NULL,
		LastModBy tinyint NOT NULL,
		LastModDate datetime NOT NULL,
		AuthId tinyint NOT NULL,
		AuthDate datetime NOT NULL,
	 CONSTRAINT PK_PurchaseOrderProductTax_PurorderRefNo_PrdSlNo_TaxId PRIMARY KEY CLUSTERED 
	(
		PurorderRefNo ASC,
		PrdSlNo ASC,
		TaxId ASC
	) ,
	CONSTRAINT FK_PurchaseOrderProductTax_PurorderRefNo FOREIGN KEY(PurorderRefNo)
	REFERENCES PurchaseOrderMaster (PurorderRefNo),
	CONSTRAINT FK_PurchaseOrderProductTax_TaxId FOREIGN KEY(TaxId)
	REFERENCES TaxConfiguration (TaxId)
)
END
GO
If not exists (Select * from SysColumns SC Inner Join SysObjects SO ON SC.id=SO.id and SC.Name in('PrdTaxAmount','NetAmount','ConversionFactor','PrdSlNo') and SO.name='PurchaseOrderDetails')
Alter table PurchaseOrderDetails Add PrdTaxAmount Numeric(18,6),NetAmount Numeric(38,6),ConversionFactor Int,PrdSlNo Int
GO
If not exists (Select * from SysColumns SC Inner Join SysObjects SO ON SC.id=SO.id and SC.Name in('TaxAmount','NetAmount') and SO.name='PurchaseOrderMaster')
Alter table PurchaseOrderMaster Add TaxAmount Numeric(18,6),NetAmount Numeric(38,6)
GO
If not exists (Select * from SysColumns SC Inner Join SysObjects SO ON SC.id=SO.id and SC.Name in('SyncId','ServerDate') and SO.name='Cs2Cn_Prk_PurchaseOrder')
Alter table Cs2Cn_Prk_PurchaseOrder Add SyncId Numeric(38,0),ServerDate DateTime
GO
Update RptGroup Set VISIBILITY=1 where RptId=121
GO
If not Exists (Select * from RptFormula Where RptId=121 and SlNo in(17,18,19))
Insert Into RptFormula
Select 121,17,'Disp_Tax','Tax',1,0 
Union
Select 121,18,'Disp_NetAmount','Net Amount',1,0 
Union
Select 121,19,'Disp_Uom','UOM',1,0 
GO
If not Exists (Select * from RptExcelHeaders Where RptId=121 and SlNo in(10,11,12))
Insert Into RptExcelHeaders
Select 121,10,'UOM','UOM',1,1
Union
Select 121,11,'Tax','Tax',1,1
Union
Select 121,12,'NetAmount','Net Amount',1,1
GO
If not Exists (Select * from CustomCaptions Where TransId=26 and CtrlId=5 and SubCtrlId in(16,17))
Insert Into CustomCaptions 
Select 26,5,16,'SprPrdDetails-26-5-16','Tax','','',1,1,1,CONVERT(Varchar,GETDATE(),121),1,CONVERT(Varchar,GETDATE(),121),'Tax','','',1,1
Union
Select 26,5,17,'SprPrdDetails-26-5-17','Net Amount','','',1,1,1,CONVERT(Varchar,GETDATE(),121),1,CONVERT(Varchar,GETDATE(),121),'Net Amount','','',1,1
GO
IF  EXISTS (SELECT * FROM SysObjects WHERE Name='View_PurchaseOrder' and XTYPE='V')
DROP VIEW View_PurchaseOrder
GO
--Select * from View_PurchaseOrder
CREATE View View_PurchaseOrder
/************************************************************
* VIEW	: View_PurchaseOrder
* PURPOSE	: To get the Purchase Order details
* CREATED BY	: Mahalakshmi.A
* CREATED DATE	: 05/06/2008
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
  5/Aug/2013  Sathish.P  Tax and Net Amount Column Added.	
*************************************************************/
AS
	SELECT DISTINCT A.CmpId,A.SpmId,B.PrdId,A.PurOrderRefNo,A.PurOrderDate,C.PrdDCode,C.PrdName,B.SysGenQty,B.OrdQty,U.UomDescription,B.PrdTaxAmount,B.Amount+B.PrdTaxAmount As NetAmount
		FROM PurchaseOrderMaster A
		INNER JOIN PurchaseOrderDetails B ON A.PurOrderRefNo=B.PurOrderRefNo
		INNER JOIN UomMaster U ON B.OrdUomId=U.UomId 
		INNER JOIN Product C ON B.PrdID=C.PrdID 
		INNER JOIN Company D ON A.CmpId=D.CmpId 
		LEFT OUTER JOIN Supplier E ON E.SpmID=A.SpmID
GO
IF EXISTS (SELECT * FROM sysobjects WHERE Name = 'Proc_RptPurchaseOrder' AND Xtype ='P')
DROP PROCEDURE Proc_RptPurchaseOrder
GO
--EXEC Proc_RptPurchaseOrder 121,1,0,'',0,0,1,0
CREATE PROCEDURE Proc_RptPurchaseOrder
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/************************************************
* PROCEDURE  : Proc_RptPurchaseOrder
* PURPOSE    : To Generate Purchase Order Report
* CREATED BY : Mahalakshmi.A
* CREATED ON : 05/06/2008  
* MODIFICATION 
*************************************************   
* DATE       AUTHOR      DESCRIPTION    
5/Aug/2013  Sathish.P  Tax and Net Amount Column Added.	
*************************************************/       
BEGIN
SET NOCOUNT ON
DECLARE @NewSnapId 			AS	INT
DECLARE @DBNAME				AS 	NVARCHAR(50)
DECLARE @TblName 			AS	NVARCHAR(500)
DECLARE @TblStruct 			AS	NVARCHAR(4000)
DECLARE @TblFields 			AS	NVARCHAR(4000)
DECLARE @sSql				AS 	NVARCHAR(4000)
DECLARE @ErrNo	 			AS	INT
DECLARE @PurDBName			AS	NVARCHAR(50)

--Filter Variable
DECLARE @FromDate	        	AS	DATETIME
DECLARE @ToDate		 	        AS	DATETIME
DECLARE @CmpId				AS INT
DECLARE @SpmId				AS INT
DECLARE @PurRefNo			AS NVARCHAR(50)



--Till Here
--Assgin Value for the Filter Variable
SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @SpmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId))
SET @PurRefNo = (SELECT  TOP 1 sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,161,@Pi_UsrId))
--Till Here
PRINT @FromDate
PRINT @ToDate
PRINT @CmpId
PRINT @SpmId
PRINT @PurRefNo
Create TABLE #RptPurchaseOrder
(
		CmpId				INT,
		SpmId				INT,
		PrdId				INT,
		PurOrderRefNo		NVARCHAR(50),
		PurOrderDate		DATETIME,
		PrdCode				NVARCHAR(50),
		PrdName				NVARCHAR(50),
		SystemQty 			INT,
		OrderQty 			INT,
		UOM					VARCHAR(50),
		Tax					NUMERIC(18,6),
		NetAmount			NUMERIC(38,6)
)
SET @TblName = 'RptPurchaseOrder'

SET @TblStruct ='CmpId				INT,
		SpmId				INT,
		PrdId				INT,
		PurOrderRefNo			NVARCHAR(50),
		PurOrderDate			DATETIME,
		PrdCode				NVARCHAR(50),
		PrdName				NVARCHAR(50),
		SystemQty 			INT,
		OrderQty 			INT,
		UOM					VARCHAR(50),		
		Tax					NUMERIC(18,6),
		NetAmount			NUMERIC(38,6)'

SET @TblFields = 'CmpId,SpmId,PrdId,PurOrderRefNo,PurOrderDate,PrdCode,PrdName,SystemQty,OrderQty,UOM,Tax,NetAmount'
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
	INSERT INTO #RptPurchaseOrder 
		(CmpId,SpmId,PrdId,PurOrderRefNo,PurOrderDate,PrdCode,PrdName,SystemQty,OrderQty,UOM,Tax,NetAmount)
	
		SELECT * FROM View_PurchaseOrder WITH (NOLOCK)   
		WHERE 	(SpmId = (CASE @SpmId WHEN 0 THEN SpmId ELSE 0 END) OR
				SpmId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId)))
			AND
				(CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR
				CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
			AND
				(PurOrderRefNo = (CASE @PurRefNo WHEN '' THEN PurOrderRefNo ELSE '' END) OR
				PurOrderRefNo IN (SELECT sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,161,@Pi_UsrId)))

			AND PurOrderDate BETWEEN @FromDate AND @ToDate 


   	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptPurchaseOrder ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE RptId=' + CAST(@Pi_RptId AS nVarchar(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + '' 
			+ 'AND 	(PurOrderRefNo = (CASE ' + CAST(@PurRefNo AS nVarchar(50)) + ' WHEN '''' THEN PurOrderRefNo ELSE '''' END) OR '
			+ 'PurOrderRefNo in (SELECT sCountid FROM Fn_ReturnRptFilterString(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',161,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
			+ 'AND (SpmId = (CASE ' + CAST(@SpmId AS nVarchar(10)) + ' WHEN 0 THEN SpmId ELSE 0 END) OR '
			+ 'SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',9,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '
			+ 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND PurOrderDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''
			
		EXEC (@SSQL)
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptPurchaseOrder'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	    END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptPurchaseOrder ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))

		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	   END
END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptPurchaseOrder

PRINT 'Data Executed'
SELECT * FROM #RptPurchaseOrder 

RETURN
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE Name = 'Proc_Cs2Cn_PurchaseOrder' AND Xtype ='P')
DROP PROCEDURE Proc_Cs2Cn_PurchaseOrder
GO
/*
BEGIN TRANSACTION
Exec Proc_Cs2Cn_PurchaseOrder 0,'2013-08-05'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2Cn_PurchaseOrder
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS 

SET NOCOUNT ON
BEGIN
/*********************************
* PROCEDURE	: Proc_Cs2Cn_PurchaseOrder
* PURPOSE	: Extract Purchase Order details from CoreStocky to Console
* NOTES		:
* CREATED	: MarySubashini.S 08-12-2008
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*
*********************************/

	DECLARE @CmpID 		AS INTEGER
	DECLARE @DistCode	AS NVARCHAR(50)
	DECLARE @ChkDate	AS DATETIME

	DELETE FROM Cs2Cn_Prk_PurchaseOrder WHERE UploadFlag='Y' 

	SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor
	SELECT @ChkDate = NextUpDate FROM DayEndProcess	WHERE ProcId = 6
	SET @Po_ErrNo=0

	INSERT INTO Cs2Cn_Prk_PurchaseOrder 
	(	
		[DistCode]		,
		[PONumber]		,
		[CompanyPONumber]	,
		[PODate]		,
		[POConfirmDate]		,
		[ProductHierarchyLevel]	,
		[ProductHierarchyValue]	,
		[ProductCode]	 	,
		[Quantity]		,
		[POType]  		,
		[POExpiryDate]  	,
		[SiteCode]	,
		[UploadFlag]
	)
	SELECT @DistCode,PM.PurOrderRefNo,
	(CASE PM.DownLoad WHEN 1 THEN PM.CmpPoNo ELSE '' END) AS CompanyPONumber,
	PM.PurOrderDate,PM.PurOrderDate,PCL1.CmpPrdCtgName,PCV1.PrdCtgValCode,
	P.PrdDCode,(PD.OrdQty*UG.ConversionFactor) AS Quantity,
	(CASE PM.DownLoad WHEN 0 THEN 'Manual' ELSE 'Automatic' END ) AS POType,
	(CASE PM.DownLoad WHEN 0 THEN PM.PurOrderExpiryDate ELSE '' END ) AS POExpiryDate,
	ISNULL(SCM.SiteCode,''),'N'
	FROM PurchaseOrderDetails PD  WITH (NOLOCK) 
	LEFT OUTER JOIN PurchaseOrderMaster PM WITH (NOLOCK)  ON PM.PurOrderRefNo=PD.PurOrderRefNo
	LEFT OUTER JOIN Product P WITH (NOLOCK)  ON P.PrdId=PD.PrdId
	LEFT OUTER JOIN UomGroup UG WITH (NOLOCK)  ON UG.UomGroupId=P.UomGroupId AND UG.UomId=PD.OrdUomId
	LEFT OUTER JOIN ProductCateGOryValue PCV WITH (NOLOCK)  ON PCV.PrdCtgValMainId=PM.PrdCtgValMainId 
	LEFT OUTER JOIN ProductCateGOryValue PCV1 WITH (NOLOCK)  ON PCV1.PrdCtgValLinkCode=LEFT(PCV.PrdCtgValLInkCode,6) 
	LEFT OUTER JOIN ProductCateGOryLevel PCL1 WITH (NOLOCK)  ON PCL1.CmpPrdCtgId=PCV1.CmpPrdCtgId 
	LEFT OUTER JOIN SiteCodeMaster SCM WITH (NOLOCK) ON PM.SiteId=SCM.SiteId 
	WHERE PM.ConfirmSts=1 AND PM.Upload=0

	UPDATE PurchaseOrderMaster SET Upload=1 WHERE Upload=0 AND ConfirmSts=1
	AND PurOrderRefNo IN (SELECT PONumber FROM Cs2Cn_Prk_PurchaseOrder)	
	
	UPDATE Cs2Cn_Prk_PurchaseOrder SET ServerDate=@ServerDate
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE Name= 'Proc_ComputeTax' AND Xtype ='P')
DROP PROCEDURE Proc_ComputeTax
GO
/*
BEGIN  TRANSACTION
EXEC Proc_ComputeTax 1,26,1
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ComputeTax      
(      
 @Pi_RowId  INT,      
 @Pi_CalledFrom  INT,        
 @Pi_UserId  INT      
)      
AS      
/*********************************      
* PROCEDURE : Proc_ComputeTax      
* PURPOSE : To Calculate the Line Level Tax      
* CREATED : Thrinath      
* CREATED DATE : 22/03/2007      
* MODIFIED
* DATE      AUTHOR     DESCRIPTION 
24/05/2009	MURUGAN	   OID CalCulation For Nestle	
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
------------------------------------------------      
* {date} {developer}  {brief modification description}            
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
*********************************/       
SET NOCOUNT ON      
BEGIN      
	DECLARE @PrdBatTaxGrp   INT      
	DECLARE @RtrTaxGrp   INT      
	DECLARE @TaxSlab  INT      
	DECLARE @MRP   NUMERIC(28,10)      
	DECLARE @SellingRate  NUMERIC(28,10)      
	DECLARE @PurchaseRate  NUMERIC(28,10)      
	DECLARE @TaxableAmount  NUMERIC(28,10)    
	DECLARE @TotalDedAmt  NUMERIC(28,10)  
	DECLARE @ParTaxableAmount NUMERIC(28,10)      
	DECLARE @TaxPer   NUMERIC(38,6)      
	DECLARE @TaxId   INT      
	DECLARE	@ApplyOn INT
	DECLARE @TaxSetting TABLE       
	(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,6)      
	)      
	--To Take the Batch TaxGroup Id      
	SELECT @PrdBatTaxGrp = TaxGroupId FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	--To Take the Batch MRP      
	SELECT @MRP = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	INNER JOIN ProductBatchDetails C (NOLOCK)      
	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
	INNER JOIN BatchCreation D (NOLOCK)      
	ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
	AND D.MRP = 1       
	--To Take the Batch Selling Rate      
	IF @Pi_CalledFrom = 2 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 23      
	BEGIN      
		SELECT @SellingRate = ColValue FROM BilledPrddtForTax WHERE TransId = @Pi_CalledFrom       
		AND UsrId = @Pi_UserId AND RowId = @Pi_RowId AND ColId = -2      
	END      
	ELSE      
	BEGIN      
		IF @Pi_CalledFrom = 20
		BEGIN 
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT max(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
		ELSE      
		BEGIN      
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
	END 
	--To Take the Batch List Price 
	--Added by Murugan For OID Calculation
	IF (@Pi_CalledFrom = 5 OR @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)
	BEGIN   
		IF  EXISTS(SELECT Status FROM Configuration WHERE ModuleId = 'PURCHASERECEIPT16' and Status=1)   
		BEGIN  
			SELECT  @PurchaseRate = Isnull(ColValue,0) FROM BilledPrdDtForTax B  
			WHERE  B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 
			and COLID=3	   
		END  
		ELSE  
		BEGIN 
			SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.ListPrice = 1     
		END  
		--->Added By Nanda on 2011/05/12
		IF @Pi_CalledFrom = 37
		BEGIN
			IF EXISTS(SELECT * FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			BEGIN
				SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
				BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
				AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
				INNER JOIN ProductBatchDetails C (NOLOCK)      
				ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
				INNER JOIN BatchCreation D (NOLOCK)      
				ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
				AND LTRIM(RTRIM(D.RefCode)) IN (SELECT LEFT(Condition,1) FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			END
		END
		--->Till Here
	END
	ELSE
	BEGIN
		SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
		INNER JOIN BatchCreation D (NOLOCK)      
		ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1  
	END
	IF (@Pi_CalledFrom = 2 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 20 OR @Pi_CalledFrom = 23 OR       
	@Pi_CalledFrom = 24 OR @Pi_CalledFrom = 25)      
	BEGIN      
		--To Take the Retailer TaxGroup Id      
		SELECT @RtrTaxGrp = TaxGroupId FROM Retailer A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
		AND B.TransId = @Pi_CalledFrom      
	END      
	IF (@Pi_CalledFrom = 5 OR  @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)      
	BEGIN      
		--To Take the Supplier TaxGroup Id      
		SELECT @RtrTaxGrp = TaxGroupId FROM Supplier A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.SpmId = B.RtrId      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId      
		AND B.TransId = @Pi_CalledFrom      
	END      
	--Store the Tax Setting for the Corresponding Retailer and Batch      
	INSERT INTO @TaxSetting (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
	SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
	FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
	TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
	INNER JOIN BilledPrdHdForTax C (NOLOCK) ON C.BillSeqId = B.BillSeqId      
	WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp AND C.UsrId = @Pi_UserId      
	AND C.RowId = @Pi_RowId AND C.TransId = @Pi_CalledFrom      
	AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
	RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp)    
	--Delete the OLD Details From the BilledPrdDtCalculatedTax For the Row and User      
	DELETE FROM BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId       
	AND TransId = @Pi_CalledFrom      
	--Cursor For Taking Each Slab and Calculate Tax      
	DECLARE  CurTax CURSOR FOR      
	SELECT DISTINCT TaxSlab FROM @TaxSetting      
	OPEN CurTax        
	FETCH NEXT FROM CurTax INTO @TaxSlab      
	WHILE @@FETCH_STATUS = 0        
	BEGIN      
		SET @TaxableAmount = 0      
		--To Filter the Records Which Has Tax Percentage (>=0)      
		IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0 and ColVal >= 0)      
		BEGIN
			--To Get the Tax Percentage for the selected slab      
			SELECT @TaxPer = ColVal FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId = 0      
			--To Get the TaxId for the selected slab      
			SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId > 0      
	         
			--To Get the Adjustable amount from Other Columns      
			SELECT @TaxableAmount = ISNULL(SUM(ColValue),0) FROM       
			(SELECT CASE B.ColVal WHEN 1 THEN A.ColValue WHEN 2 THEN -1 * A.ColValue END       
			AS ColValue FROM BilledPrdDtForTax A INNER JOIN @TaxSetting B      
			ON A.ColId = B.ColId AND A.RowId =  @Pi_RowId AND A.UsrId = @Pi_UserId       
			AND A.TransId = @Pi_CalledFrom      
			WHERE TaxSlab = @TaxSlab AND B.ColType = 2 and B.ColId>3      
			And B.ColVal >0) as C      
			SET @ApplyOn=0
			SET @TotalDedAmt=@TaxableAmount
			--To add MRP to Taxable Amount if MRP Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP      
				SET @ApplyOn=1 
			END
			--To add Selling Rate to Taxable Amount if Selling Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 2 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @SellingRate      
	      
			--To add Purchase Rate to Taxable Amount if Purchase Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 3 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @PurchaseRate      
			--To Get the Parent Taxable Amount for the Tax Slab      
			SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM BilledPrdDtCalculatedTax A      
			INNER JOIN @TaxSetting B ON A.TaxId = B.ColVal AND A.RowId = @Pi_RowId      
			AND A.UsrId = @Pi_UserId AND B.ColType = 3 AND B.TaxSlab = @TaxSlab      
			AND A.TransId = @Pi_CalledFrom     
			Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount      
	      
			--Insert the New Tax Amounts        
			INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
			TaxableAmount,TaxAmount,Usrid,TransId)      
			SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@TaxId,@TaxSlab,@TaxPer,      
		    @TaxableAmount, CASE @ApplyOn 
			WHEN 0 THEN	cast(@TaxableAmount * (@TaxPer / 100 ) AS NUMERIC(38,6))
			WHEN 1 THEN cast(@TaxableAmount * (@TaxPer / (100 +@TaxPer)) AS NUMERIC(38,6)) END,      
			@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
			B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom     
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount =  @TotalDedAmt+ @SellingRate
				UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=@TaxableAmount
				WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId AND TransId = @Pi_CalledFrom 
			END 
		END      
		FETCH NEXT FROM CurTax INTO @TaxSlab      
	END        
	CLOSE CurTax        
	DEALLOCATE CurTax           
END
GO
--IDT START
--Tax Group Setting Screen
DELETE FROM CustomCaptions WHERE TransId=75 AND CtrlId=15 AND SubCtrlId=1
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (75,15,1,'OptIDTGroup','IDT Group','','',1,1,1,GetDate(),1,
GetDate(),'IDT Group ','','',1,1)
GO
DELETE FROM ScreenDefaultValues WHERE transId = 75 and CtrlId = 5 and CtrlValue = 4
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(75,5,4,'IDT',4,1,1,1,GETDATE(),1,GETDATE(),'IDT ')
GO
-- Tax Setting
DELETE From CustomCaptions Where TransId  = 166 and CtrlId = 1000 and SubCtrlId = 17
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (166,1000,17,'Msgbox-166-1000-17','','','No more setting in IDT sequence. Cant set Tax setting',1,1,1,GetDate(),1,
GetDate(),'','','No more setting in IDT sequence. Cant set Tax setting ',1,1)
GO
---Supplier Master --IDT TaxGroup
DELETE FROM HotSearchEditorHD WHERE FormId=10081
INSERT INTO HotSearchEditorHD(FormId,FormName,ControlName,SltString,RemainsltString)
VALUES (10081,'Supplier Master','IDTTaxGroup','select','Select TaxGroupId,
TaxGroupName,RtrGroup From TaxGroupSetting with (nolock) WHERE Taxgroup = 4 and Availability=1')
GO
DELETE FROM HotSearchEditorDT WHERE FormId=10081
INSERT INTO HotSearchEditorDT (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
SELECT 1,10081,'IDTTaxGroup','TaxGroup Name','TaxGroupName',2000,0,'HotSch-69-2000-5',69 UNION ALL
SELECT 2,10081,'IDTTaxGroup','TaxGroup Code','RtrGroup',2500,0,'HotSch-69-2000-6',69
GO

IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE ID=(SELECT ID FROM SYSOBJECTS 
						WHERE NAME='Supplier' AND xtype='U') AND NAME='SpmSupplier')
BEGIN
    ALTER TABLE Supplier ADD SpmSupplier INT DEFAULT 1 WITH VALUES
END
GO
IF NOT EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'[IDTMaster]') AND type in (N'U'))
BEGIN
CREATE TABLE IDTMaster
(
	[SpmId] [int] NOT NULL,
	[SpmCode] [varchar](20)   NOT NULL,
	[SpmName] [varchar](50)   NOT NULL,
	[SpmAdd1] [varchar](50)   NOT NULL,
	[SpmAdd2] [varchar](50)   NULL,
	[SpmAdd3] [varchar](50)   NULL,
	[SpmPhone] [varchar](50)   NOT NULL,
	[SpmFax] [varchar](50)   NULL,
	[SpmEmail] [varchar](50)   NOT NULL,
	[SpmContact] [varchar](50)   NULL,
	[SpmDefault] [tinyint] NOT NULL,
	[CoaId] [int] NULL,
	[CmpId] [int] NOT NULL,
	[TaxGroupId] [int] NOT NULL,
	[SpmOnAcc] [numeric](38, 6) NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL,
	[SpmTinNo]	INT,
	[SpmSupplier] [int] NULL,
 CONSTRAINT [PK_IDTMaster_SpmId] PRIMARY KEY CLUSTERED 
(
	[SpmId] ASC
)   ON [PRIMARY]
) ON [PRIMARY]
END
GO
IF NOT EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'IDTSequenceMaster') AND type in (N'U'))
BEGIN
CREATE TABLE IDTSequenceMaster
(
			[IDTSeqId] [int] NOT NULL,
			[SequenceDate] [datetime] NOT NULL,
			[Availability] [tinyint] NOT NULL,
			[LastModBy] [tinyint] NOT NULL,
			[LastModDate] [datetime] NOT NULL,
			[AuthId] [tinyint] NOT NULL,
			[AuthDate] [datetime] NOT NULL,
	 CONSTRAINT [PK_IDTSequenceMaster_IDTSeqId] PRIMARY KEY CLUSTERED 
	(
		[IDTSeqId] ASC
	) ON [PRIMARY]
) ON [PRIMARY]
END
GO
IF NOT EXISTS (select * from sysobjects where id = object_id(N'IDTSequenceDetail') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTSequenceDetail
(
	[IDTSeqId] [int] NOT NULL ,
	[SlNo] [int] NOT NULL ,
	[RefCode] [nvarchar] (25)  NOT NULL ,
	[ColumnName] [nvarchar] (25)  NOT NULL ,
	[FieldDesc] [nvarchar] (100) NOT NULL ,
	[Calculation] [nvarchar] (200)  NOT NULL ,
	[MasterID] [int] NOT NULL ,
	[BatchSeqId] [int] NOT NULL ,
	[DefaultValue] [int] NOT NULL ,
	[DisplayIn] [int] NOT NULL ,
	[Editable] [int] NOT NULL ,
	[EffectInNetAmount] [int] NOT NULL ,
	[Visibility] [int] NOT NULL ,
	[CoaId] [int] NOT NULL ,
	[Availability] [tinyint] NULL ,
	[LastModBy] [tinyint] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [tinyint] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [PK_IDTSequenceDetail_IDTSeqId_SlNo] PRIMARY KEY  CLUSTERED 
	(
		[IDTSeqId],
		[SlNo]
	)  ON [PRIMARY] ,
	CONSTRAINT [FK_IDTSequenceDetail_IDTSeqId] FOREIGN KEY 
	(
		[IDTSeqId]
	) REFERENCES [IDTSequenceMaster] (
		[IDTSeqId]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (select * from sysobjects where id = object_id(N'IDTManagement') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTManagement 
(
	[IDTMngRefNo] [nvarchar] (50)  NOT NULL ,
	[IDTMngDate] [datetime] NULL ,
	[LcnId] [int] NULL ,
	[StkMgmtTypeId] [int] NULL ,
	[SpmId] [int] NULL ,
	[DocRefNo] [nvarchar] (50)  NULL ,
	[LRNo] [nvarchar] (50)  NULL ,
	[LRDate] [datetime] NULL ,
	[Remarks] [nvarchar] (500)  NULL ,
	[DecPoints] [int] NULL ,
	[Status] [int] NULL ,
	[IDTSeqId] [int] NULL ,
	[IDTGrossAmt] [numeric](38, 6) NULL,
	[IDTTaxAmt] [numeric](38, 6) NULL,
	[IDTNetAmt] [numeric](38, 6) NULL,
	[IDTPaidAmt] [numeric](38, 6) NULL,
	[IDTStatus] [Int] NULL,
	[FromSpmId] [Int],
	[ToSpmId]	[INT],
	[Upload] [nvarchar] (1)  NULL ,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [PK_IDTManagement_IDTMngRefNo] PRIMARY KEY  CLUSTERED 
	(
		[IDTMngRefNo]
	)  ON [PRIMARY] ,
	CONSTRAINT [FK_IDTManagement_SpmId] FOREIGN KEY 
	(
		[SpmId]
	) REFERENCES [IDTMaster] (
		[SpmId]
	),
	CONSTRAINT [FK_IDTManagement_IDTSeqId] FOREIGN KEY 
	(
		[IDTSeqId]
	) REFERENCES [IDTSequenceMaster] (
		[IDTSeqId]
	),
	CONSTRAINT [FK_IDTManagement_LcnId] FOREIGN KEY 
	(
		[LcnId]
	) REFERENCES [Location] (
		[LcnId]
	),
	CONSTRAINT [FK_IDTManagement_StkMgmtTypeId] FOREIGN KEY 
	(
		[StkMgmtTypeId]
	) REFERENCES [StockManagementType] (
		[StkMgmtTypeId]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (select * from sysobjects where id = object_id(N'IDTManagementProduct') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTManagementProduct 
(
	[IDTMngRefNo] [nvarchar] (50) NULL ,
	[PrdId] [int] NULL ,
	[PrdBatId] [int] NULL ,
	[Qty] [int] NULL ,
	[PrdMRPRate] [numeric](38, 6) NULL ,
	[PrdUnitRate] [numeric](38, 6) NULL ,
	[PrdGrossAmount] [numeric](38, 6) NULL ,
	[PrdTaxAmount] [numeric](38, 6) NULL ,
	[PrdNetAmount] [numeric](38, 6) NULL ,
	[PriceId] [bigint] NULL ,
	[PrdSlNo] [int] NULL ,
	[StockTypeId] [INT] NULL,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [FK_IDTManagementProduct_IDTMngRefNo] FOREIGN KEY 
	(
		[IDTMngRefNo]
	) REFERENCES [IDTManagement] (
		[IDTMngRefNo]
	),
	CONSTRAINT [FK_IDtManagementProduct_PrdBatId] FOREIGN KEY 
	(
		[PrdId],
		[PrdBatId]
	) REFERENCES [ProductBatch] (
		[PrdId],
		[PrdBatId]
	),
	CONSTRAINT [FK_IDTManagementProduct_PrdId] FOREIGN KEY 
	(
		[PrdId]
	) REFERENCES [Product] (
		[PrdId]
	),
	CONSTRAINT [CK_Qty>0] CHECK ([Qty] > 0)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (select * from sysobjects where id = object_id(N'IDTManagementLineAmount') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTManagementLineAmount 
(
	[IDTMngRefNo] [nvarchar] (50)  NOT NULL ,
	[PrdSlNo] [int] NULL ,
	[RefCode] [nvarchar] (50)  NOT NULL ,
	[LineDefValue] [tinyint] NULL ,
	[LineUnitAmount] [numeric](18, 6) NOT NULL ,
	[LineBaseQtyAmount] [numeric](18, 6) NOT NULL ,
	[LineEffectAmount] [numeric](18, 6) NOT NULL ,
	[Availability] [tinyint] NULL ,
	[LastModBy] [tinyint] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [tinyint] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [FK_IDTManagementLineAmount_IDTMngRefNo] FOREIGN KEY 
	(
		[IDTMngRefNo]
	) REFERENCES [IDTManagement] (
		[IDTMngRefNo]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (select * from sysobjects where id = object_id(N'IDTManagementProductTax') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTManagementProductTax
(
	[IDTMngRefNo] [nvarchar] (50)  NULL ,
	[PrdId] [int] NULL ,
	[PrdBatId] [int] NULL ,
	[PrdSlNo] [int] NULL ,
	[TaxId] [int] NULL ,
	[TaxPerc] [numeric](38, 6) NULL ,
	[TaxableAmount] [numeric](38, 6) NULL ,
	[TaxAmount] [numeric](38, 6) NULL ,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [FK_IDTManagementProductTax_IDTMngRefNo] FOREIGN KEY 
	(
		[IDTMngRefNo]
	) REFERENCES [IDTManagement] (
		[IDTMngRefNo]
	),
	CONSTRAINT [FK_IDtManagementProductTax_PrdBatId] FOREIGN KEY 
	(
		[PrdId],
		[PrdBatId]
	) REFERENCES [ProductBatch] (
		[PrdId],
		[PrdBatId]
	),
	CONSTRAINT [FK_IDTManagementProductTax_PrdId] FOREIGN KEY 
	(
		[PrdId]
	) REFERENCES [Product] (
		[PrdId]
	),
	CONSTRAINT [FK_IDTManagementProductTax_TaxId] FOREIGN KEY 
	(
		[TaxId]
	) REFERENCES [TaxConfiguration] (
		[TaxId]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE id = object_id(N'IDTReceipt') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTReceipt
(
	[IDTRcpNo] [nvarchar] (100)  NOT NULL ,
	[IDTCollectionDate] [datetime] NULL ,
	[IDTCollectedDate] [datetime] NULL ,
	[IDTRcpAmt] [numeric](38, 6) NULL ,
	[TransType] [int] NULL ,
	[Status] [int] NULL ,
	[UploadFlag] [nvarchar] (1)  NULL ,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [PK_IDTReceipt_IDTRcpNo] PRIMARY KEY  CLUSTERED 
	(
		[IDTRcpNo]
	)  ON [PRIMARY] 
) ON [PRIMARY]
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE Id = object_id(N'IDTReceiptInvoice') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTReceiptInvoice
(
	[IDTRcpNo] [nvarchar] (100)  NOT NULL ,
	[IDTMngRefNo] [nvarchar] (100)  NOT NULL ,
	[DocRefNo] [nvarchar] (100)  NULL ,
	[SpmId] [int] NULL ,
	[StkMgmtTypeId] [int] NULL ,
	[IDTInvAmount] [numeric](38, 6) NULL ,
	[IDTPaidAmount] [numeric](38, 6) NULL ,
	[IDTPendingAmt] [numeric](38, 6) NULL ,
	[IDTCashDiscAmt] [numeric](38, 6) NULL ,
	[IDTCollectedAmt] [numeric](38, 6) NULL ,
	[UploadFlag] [nvarchar] (1)  NULL ,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [FK_IDTReceiptInvoice_IDTRcpNo] FOREIGN KEY 
	(
		[IDTRcpNo]
	) REFERENCES [IDTReceipt] (
		[IDTRcpNo]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE Id = object_id(N'IDTReceiptInvoiceDetails') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE IDTReceiptInvoiceDetails
 (
	[IDTRcpNo] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL ,
	[IDTMngRefNo] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL ,
	[CollTypeId] [int] NULL ,
	[InstrumentNo] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
	[BankId] [int] NULL ,
	[BankBranchId] [int] NULL ,
	[CollectionDate] [datetime] NULL ,
	[IDTCollectedAmt] [numeric](38, 6) NULL ,
	[Availability] [int] NULL ,
	[LastModBy] [int] NULL ,
	[LastModDate] [datetime] NULL ,
	[AuthId] [int] NULL ,
	[AuthDate] [datetime] NULL ,
	CONSTRAINT [FK_IDTReceiptInvoiceDetails_IDTRcpNo] FOREIGN KEY 
	(
		[IDTRcpNo]
	) REFERENCES [IDTReceipt] (
		[IDTRcpNo]
	)
) ON [PRIMARY]
END
GO
IF NOT EXISTS(SELECT * FROM Counters WHERE TabName='IDTMaster' AND FldName='SpmId')
BEGIN
	INSERT INTO Counters
	SELECT 'IDTMaster',FldName,Prefix,Zpad,CmpId,1000,ModuleName,
	DisplayFlag,CurYear,Availability,LastModBy,
	LastModDate,AuthId,AuthDate FROM Counters WHERE TabName='Supplier' AND FldName='SpmId'
END
GO
DELETE FROM Counters WHERE TabName = 'IDTSequenceMaster'
INSERT INTO Counters (TabName,FldName,Prefix,Zpad,CmpId,CurrValue,ModuleName,DisplayFlag,CurYear,
Availability,LastModBy,LastModDate,AuthId,AuthDate)
Values('IDTSequenceMaster','IDTSeqId',NULL,0,1,1,'IDT Sequence Master',0,2011,1,1,GETDATE(),1,GETDATE())
GO
IF NOT EXISTS(SELECT * FROM Counters Where TabName = 'IDTManagement')
BEGIN
	INSERT INTO Counters (TabName,FldName,Prefix,Zpad,CmpId,CurrValue,ModuleName,DisplayFlag,CurYear,
							Availability,LastModBy,LastModDate,AuthId,AuthDate)
	Values('IDTManagement','IDTMngRefNo','IDT',5,1,0,'IDT Management',1,2011,1,1,GETDATE(),1,GETDATE())
END
GO
IF NOT EXISTS(SELECT * FROM Counters WHERE TabName = 'IDTReceipt')
BEGIN 
	INSERT INTO Counters (TabName,FldName,Prefix,Zpad,CmpId,CurrValue,ModuleName,DisplayFlag,CurYear,
							Availability,LastModBy,LastModDate,AuthId,AuthDate)
	VALUES('IDTReceipt','IDTRcpNo','IDR',5,1,0,'IDT Receipt',1,2011,1,1,GETDATE(),1,GETDATE())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceMaster)
BEGIN
	INSERT INTO IDTSequenceMaster(IDTSeqId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,Convert(Varchar(10),GetDate(),121),1,1,GetDate(),1,GetDate())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceDetail WHERE SlNo = 1 )
BEGIN
	INSERT INTO IDTSequenceDetail(IDTSeqId,SlNo,RefCode,ColumnName,FieldDesc,Calculation,MasterID,BatchSeqId,
							DefaultValue,DisplayIn,Editable,EffectInNetAmount,Visibility,CoaId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,1,'A','Default','MRP','',-1,0,0,1,0,0,0,0,1,1,GetDate(),1,GetDate())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceDetail WHERE SlNo = 2 )
BEGIN
	INSERT INTO IDTSequenceDetail(IDTSeqId,SlNo,RefCode,ColumnName,FieldDesc,Calculation,MasterID,BatchSeqId,
							DefaultValue,DisplayIn,Editable,EffectInNetAmount,Visibility,CoaId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,2,'B','Default','Rate','',-1,0,0,1,0,0,1,0,1,1,GetDate(),1,GetDate())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceDetail WHERE SlNo = 3 )
BEGIN
	INSERT INTO IDTSequenceDetail(IDTSeqId,SlNo,RefCode,ColumnName,FieldDesc,Calculation,MasterID,BatchSeqId,
							DefaultValue,DisplayIn,Editable,EffectInNetAmount,Visibility,CoaId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,3,'C','Default','Gross','',-1,0,0,1,0,0,1,0,1,1,GetDate(),1,GetDate())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceDetail WHERE SlNo = 4 )
BEGIN
	INSERT INTO IDTSequenceDetail(IDTSeqId,SlNo,RefCode,ColumnName,FieldDesc,Calculation,MasterID,BatchSeqId,
							DefaultValue,DisplayIn,Editable,EffectInNetAmount,Visibility,CoaId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,4,'D','Default','Tax Amount','',-1,0,0,1,0,1,1,0,1,1,GetDate(),1,GetDate())
END
GO
IF NOT EXISTS(SELECT * FROM IDTSequenceDetail WHERE SlNo = 5 )
BEGIN
	INSERT INTO IDTSequenceDetail(IDTSeqId,SlNo,RefCode,ColumnName,FieldDesc,Calculation,MasterID,BatchSeqId,
							DefaultValue,DisplayIn,Editable,EffectInNetAmount,Visibility,CoaId,Availability,
							LastModBy,LastModDate,AuthId,AuthDate)
	VALUES(1,5,'E','Default','IDT Charges','',-1,0,0,1,0,0,1,0,1,1,GetDate(),1,GetDate())
END
GO
-----To Insert RptSelectionHd
DELETE FROM RptSelectionHd WHERE SelcId = 279
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(279,'Sel_IDTDistId','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 280
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(280,'Sel_IDTRefId','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 281
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(281,'Sel_IDTType','IDTManagement',1)
GO
DELETE  FROM RptSelectionHd WHERE SelcId = 282
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(282,'Sel_IDTFDist','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 283
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(283,'Sel_IDTTDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 284
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(284,'IDTFromDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 285
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(285,'IDTToDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 286
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(286,'IDTRefNumber','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 287
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(287,'IDTFromRefNumber','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 288
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(288,'IDTToRefNumber','IDTManagement',0)
GO
-----To Insert MenuDefinition And ProfileDt For IDT Column Sequence
DELETE FROM MenuDef WHERE SrlNo = 179 AND MenuId='mCmp17'
INSERT INTO MenuDef(SrlNo,MenuId,MenuName,ParentId,Caption,MenuStatus,FormName,DefaultCaption)
VALUES(179,'mCmp17','MnuIDTSeq','mCmp','IDT Column Sequence',0,'FrmIDTSequence','IDT Column Sequence ')
GO
DELETE FROM ProfileDt Where MenuId = 'mCmp17'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,
LastModBy,LastModDate,AuthId,AuthDate)
SELECT PrfId,'mCmp17',0,'New',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp17',1,'Edit',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp17',2,'Save',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp17',6,'Print',1,1,1,GetDate(),1,GetDate()FROM ProfileHD
GO
--- To Insert TransactionMaster For Idt Column Sequence
DELETE FROM TransactionMaster WHERE TransactionId=269
INSERT INTO TransactionMaster(TransactionId,TransactionCode,TransactionDescription,StockChangeType,
		UomReq,RtrSeqReq,PrdSeqReq,PurSalSeqReq,Availability,LastModBy,LastModDate,AuthId,AuthDate)
VALUES(269,'IDT','IDT Column Sequence',0,1,1,1,1,1,1,GetDate(),1,GetDate())
GO
--- To Insert CustomCaptions For Idt Column Sequence
DELETE FROM CustomCaptions where TransId  = 269
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,0,'btnOperation','&New','','',1,1,1,GetDate(),1,
GetDate(),'&New','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,1,'btnOperation','&Edit','','',1,1,1,GetDate(),1,
GetDate(),'&Edit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,2,'btnOperation','&Save','','',1,1,1,GetDate(),1,
GetDate(),'&Save','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,3,'btnOperation','&Delete','','',1,1,1,GetDate(),1,
GetDate(),'&Delete','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,4,'btnOperation','&Cancel','','',1,1,1,GetDate(),1,
GetDate(),'&Cancel','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,5,'btnOperation','E&xit','','',1,1,1,GetDate(),1,
GetDate(),'E&xit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1,6,'btnOperation','&Print','','',1,1,1,GetDate(),1,
GetDate(),'&Print','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2,1,'CoreHeaderTool','IDT Column Sequence','','',1,1,1,
GetDate(),1,GetDate(),'IDT Column Sequence','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2,2,'CoreHeaderTool','Stocky','','',1,1,1,GetDate(),1,
GetDate(),'Stocky','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,1,'sprIDT-269-3-1','Code','','',1,1,1,GetDate(),1,
GetDate(),'Code','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,3,'sprIDT-269-3-3','Column Code','','',1,1,1,GetDate(),1,
GetDate(),'Column Code','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,4,'sprIDT-269-3-4','Description','','',1,1,1,GetDate(),1,
GetDate(),'Description','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,5,'sprIDT-269-3-5','Calculation','','',1,1,1,GetDate(),1,
GetDate(),'Calculation','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,6,'sprIDT-269-3-6','Default Value & UDC*...','','',1,1,1,GetDate(),1,GetDate(),
'Default Value & UDC*...','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,9,'sprIDT-269-3-9','Display In(+)','','',1,1,1,GetDate(),1,GetDate(),'Display In(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,10,'sprIDT-269-3-10','Editable (+)','','',1,1,1,GetDate(),1,GetDate(),'Editable (+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,11,'sprIDT-269-3-11','Effect On Net Amount(+)','','',1,1,1,GetDate(),1,
GetDate(),'Effect On Net Amount(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,12,'sprIDT-269-3-12','Visibility(+)','','',1,1,1,GetDate(),1,
GetDate(),'Visibility(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,3,13,'sprIDT-269-3-13','Account*...','','',1,1,1,GetDate(),1,
GetDate(),'Account*...','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,1,'Msgbox-269-1000-1','','','Default Value cannot be set for this row',1,1,1,
GetDate(),1,GetDate(),'','','Default Value cannot be set for this row',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,2,'Msgbox-269-1000-2','','','Default rows cannot be Deleted',1,1,1,
GetDate(),1,GetDate(),'','','Default rows cannot be Deleted',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,3,'Msgbox-269-1000-3','','','Failed to Lock Record',1,1,1,GetDate(),1,
GetDate(),'','','Failed to Lock Record',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,4,'Msgbox-269-1000-4','','','Column Code already Attached',1,1,1,
GetDate(),1,GetDate(),'','','Column Code already Attached',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,5,'Msgbox-269-1000-5','','','Description already Available',1,1,1,
GetDate(),1,GetDate(),'','','Description already Available',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,6,'Msgbox-269-1000-6','','','Set Tax Configuration for the New IDT Sequence',1,1,1,
GetDate(),1,GetDate(),'','','Set Tax Configuration for the New IDT Sequence',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,7,'Msgbox-269-1000-7','','','Set Tax Configuration for the New IDT Sequence',1,1,1,
GetDate(),1,GetDate(),'','','Set Tax Configuration for the New IDT Sequence',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,8,'Msgbox-269-1000-8','','','Calculation should not end with Operators',1,1,1,
GetDate(),1,GetDate(),'','','Calculation should not end with Operators',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,9,'Msgbox-269-1000-9','','',
'IDT Receipts are already Available for todays date,IDT Sequence cannot be set',1,1,1,
GetDate(),1,GetDate(),'','',
'IDT Receipts are already Available for todays date, IDT Sequence cannot be set',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,10,'Msgbox-269-1000-10','','','InValid Formula In the IDT Sequence Row',1,1,1,
GetDate(),1,GetDate(),'','','InValid Formula In the IDT Sequence Row',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,11,'Msgbox-269-1000-11','','','does not exists',1,1,1,GetDate(),1,
GetDate(),'','','does not exists',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,12,'PnlMsg-269-1000-12','','Default value cannot be set For Calculated Column','',1,1,1,
GetDate(),1,GetDate(),'','Default value cannot be set For Calculated Column','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,13,'PnlMsg-269-1000-13','','Read Only Field','',1,1,1,GetDate(),1,
GetDate(),'','Read Only Field','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,14,'PnlMsg-269-1000-14','','Enter Column Code','',1,1,1,GetDate(),1,
GetDate(),'','Enter Column Code','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,15,'PnlMsg-269-1000-15','','Enter Description','',1,1,1,GetDate(),1,
GetDate(),'','Enter Description','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,16,'PnlMsg-269-1000-16','','Enter Formula. Use {} to refer column Code Eg. {A} - {B}','',
1,1,1,GetDate(),1,GetDate(),'','Enter Formula. Use {} to refer column Code Eg. {A} - {B}',
'',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,17,'PnlMsg-269-1000-17','','Press F4 / Double Click to Select the Default Value','',1,1,1,
GetDate(),1,GetDate(),'','Press F4 / Double Click to Select the Default Value','',1,1)
GO
 INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,18,'PnlMsg-269-1000-18','','Press SpaceBar / Double Click to Set Display In','',1,1,1,
GetDate(),1,GetDate(),'','Press SpaceBar / Double Click to Set Display In','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,19,'PnlMsg-269-1000-19','','Press SpaceBar / Double Click to Set Editable','',1,1,1,
GetDate(),1,GetDate(),'','Press SpaceBar / Double Click to Set Editable','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,20,'PnlMsg-269-1000-20','','Press SpaceBar / Double Click to Set Effect on Net Amount','',1,1,1,
GetDate(),1,GetDate(),'','Press SpaceBar / Double Click to Set Effect on Net Amount','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,
LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,21,'PnlMsg-269-1000-21','','Press SpaceBar / Double Click to Set Visibility','',1,1,1,
GetDate(),1,GetDate(),'','Press SpaceBar / Double Click to Set Visibility','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,22,'PnlMsg-269-1000-22','','Press F4 / Double Click to Select Account','',1,1,1,
GetDate(),1,GetDate(),'','Press F4 / Double Click to Select Account','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,23,'PnlMsg-269-1000-23','','Calculation cannot be given for Default value column','',1,1,1,
GetDate(),1,GetDate(),'','Calculation cannot be given for Default value column','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,24,'PnlMsg-269-1000-24','','Calculation cannot be given for Editable Yes1 Row','',1,1,1,
GetDate(),1,GetDate(),'','Calculation cannot be given for Editable Yes1 Row','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,25,'PnlMsg-269-1000-25','','Default Value cannot be given for Calculation column','',1,1,1,
GetDate(),1,GetDate(),'','Default Value cannot be given for Calculation column','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,26,'PnlMsg-269-1000-26','','Enter the Field Description','',1,1,1,
GetDate(),1,GetDate(),'','Enter the Field Description','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,27,'PnlMsg-269-1000-27','','Either Calculation (or) Default Value is Mandatory','',1,1,1,
GetDate(),1,GetDate(),'','Either Calculation (or) Default Value is Mandatory','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,28,'PnlMsg-269-1000-28','',
'Either Calculation (or) Default Value should be blank if Editable is Yes and Display In is Value','',
1,1,1,GetDate(),1,GetDate(),'',
'Either Calculation (or) Default Value should be blank if Editable is Yes and Display In is Value','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,1000,29,'PnlMsg-269-1000-29','','Account Code is mandatory for the columns which effects the net amount',
'',1,1,1,GetDate(),1,GetDate(),'','Account Code is mandatory for the columns which effects the net amount','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,1,'HotSch-269-2000-1','Master Name','','',1,1,1,GetDate(),1,
GetDate(),'Master Name','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,2,'HotSch-269-2000-2','Column  Name','','',1,1,1,GetDate(),1,
GetDate(),'Column  Name','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,3,'HotSch-269-2000-3','Account Code','','',1,1,1,GetDate(),1,
GetDate(),'Account Code','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,4,'HotSch-269-2000-4','Account Name','','',1,1,1,GetDate(),1,
GetDate(),'Account Name','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,5,'HotSch-269-2000-5','Account Code','','',1,1,1,GetDate(),1,
GetDate(),'Account Code','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,2000,6,'HotSch-269-2000-6','Account Name','','',1,1,1,GetDate(),1,
GetDate(),'Account Name','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
 VALUES (269,100000,3,'sprIDT-269-3','Column Code','','',1,1,1,GetDate(),1,
GetDate(),'Column Code','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100001,4,'sprIDT-269-4','Description','','',1,1,1,GetDate(),1,
GetDate(),'Description','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100002,5,'sprIDT-269-5','Calculation','','',1,1,1,GetDate(),1,
GetDate(),'Calculation','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100003,6,'sprIDT-269-6','Default Value & UDC*...','','',1,1,1,GetDate(),1,
GetDate(),'Default Value & UDC*...','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100004,9,'sprIDT-269-9','Display In(+)','','',1,1,1,GetDate(),1,
GetDate(),'Display In(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100005,10,'sprIDT-269-10','Editable (+)','','',1,1,1,GetDate(),1,
GetDate(),'Editable (+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100006,11,'sprIDT-269-11','Effect On Net Amount(+)','','',1,1,1,GetDate(),1,
GetDate(),'Effect On Net Amount(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100007,12,'sprIDT-269-12','Visibility(+)','','',1,1,1,GetDate(),1,
GetDate(),'Visibility(+)','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (269,100008,13,'sprIDT-269-13','Account*...','','',1,1,1,GetDate(),1,
GetDate(),'Account*...','','',1,1)
GO
-- To Insert ScreenDefaultValues For Idt Column Sequence
DELETE FROM ScreenDefaultValues WHERE TransId=269
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,1,1,'Value',1,1,1,1,GetDate(),1,GetDate(),'Value ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,1,2,'Percentage',2,1,1,1,GetDate(),1,GetDate(),'Percentage ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,2,1,'Yes',1,1,1,1,GetDate(),1,GetDate(),'Yes ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,2,0,'No',2,1,1,1,GetDate(),1,GetDate(),'No ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,3,1,'Add',1,1,1,1,GetDate(),1,GetDate(),'Add ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,3,2,'Reduce',2,1,1,1,GetDate(),1,GetDate(),'Reduce ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
Values(269,3,0,'Nil',3,1,1,1,GetDate(),1,GetDate(),'Nil ')
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_TransSequencing') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_TransSequencing
GO
--SELECT * FROM RptTransSequencing
--EXEC Proc_TransSequencing 228,1
CREATE PROCEDURE Proc_TransSequencing
(
	@Pi_ModuleId  		INT,	
	@Pi_UsrId 		INT
)
AS
/*********************************
* PROCEDURE	: Proc_TransSequencing
* PURPOSE	:  To Display the Bill/Purchase Sequenceing Details
* CREATED	: MarySubashini.S
* CREATED DATE	: 10/06/2008
* NOTE		: General SP for Returning the the Bill/Purchase Sequenceing Details
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	DELETE FROM RptTransSequencing WHERE UsrId IN(@Pi_UsrId,0)
	
	IF @Pi_ModuleId=5
	BEGIN
		INSERT INTO RptTransSequencing (SeqId,SequenceDate,SlNo,RefCode,ColumnName,
			FiledDesc,Calculation,DefaultId,DefaultValue,DisplayId,
			DisplayIn,EditableId, Editable,EffectInNetAmountId,EffectInNetAmount,
			VisibilityId,Visibility,CoaId,AcName,UsrId )
		SELECT B.PurSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,ISNULL(C.MasterName,'') + ' - ' + ISNULL(D.ColumnName,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM PurchaseSequenceDetail A
			INNER JOIN PurchaseSequenceMaster B ON A.PurSeqId = B.PurSeqId
			LEFT OUTER JOIN UDCHD C ON C.MasterId = A.MasterID
			LEFT OUTER JOIN UDCMaster D ON D.UDCMAsterID = A.DefaultValue AND C.MasterId = D.MasterID
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID<>0
		UNION
		SELECT B.PurSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'Batch Creation'  + ' - ' + ISNULL(C.FieldDesc,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM PurchaseSequenceDetail A
			INNER JOIN PurchaseSequenceMaster B ON A.PurSeqId = B.PurSeqId
			LEFT OUTER JOIN BatchCreation C ON A.DefaultValue = C.Slno  AND A.BatchSeqId = C.BatchSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			LEFT OUTER JOIN BatchCreationMaster F ON F.BatchSeqId = C.BatchSeqId
			WHERE A.MasterID=0 AND A.BatchSeqId>0
		UNION
		SELECT B.PurSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'-' AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM PurchaseSequenceDetail A
			INNER JOIN PurchaseSequenceMaster B ON A.PurSeqId = B.PurSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID=0 AND A.BatchSeqId=0 ORDER BY A.Slno	
	END	
	IF @Pi_ModuleId=2
	BEGIN
		INSERT INTO RptTransSequencing (SeqId,SequenceDate,SlNo,RefCode,ColumnName,
			FiledDesc,Calculation,DefaultId,DefaultValue,DisplayId,
			DisplayIn,EditableId, Editable,EffectInNetAmountId,EffectInNetAmount,
			VisibilityId,Visibility,CoaId,AcName,UsrId )
		SELECT B.BillSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,ISNULL(C.MasterName,'') + ' - ' + ISNULL(D.ColumnName,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM BillSequenceDetail A
			INNER JOIN BillSequenceMaster B ON A.BillSeqId = B.BillSeqId
			LEFT OUTER JOIN UDCHD C ON C.MasterId = A.MasterID
			LEFT OUTER JOIN UDCMaster D ON D.UDCMAsterID = A.DefaultValue AND C.MasterId = D.MasterID
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID<>0
		UNION
		SELECT B.BillSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'Batch Creation'  + ' - ' + ISNULL(C.FieldDesc,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM BillSequenceDetail A
			INNER JOIN BillSequenceMaster B ON A.BillSeqId = B.BillSeqId
			LEFT OUTER JOIN BatchCreation C ON A.DefaultValue = C.Slno  AND A.BatchSeqId = C.BatchSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			LEFT OUTER JOIN BatchCreationMaster F ON F.BatchSeqId = C.BatchSeqId
			WHERE A.MasterID=0 AND A.BatchSeqId>0
		UNION
		SELECT B.BillSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'' AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM BillSequenceDetail A
			INNER JOIN BillSequenceMaster B ON A.BillSeqId = B.BillSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID=0 AND A.BatchSeqId=0 ORDER BY A.Slno
	END		
	IF @Pi_ModuleId=269
	BEGIN
		INSERT INTO RptTransSequencing (SeqId,SequenceDate,SlNo,RefCode,ColumnName,
					FiledDesc,Calculation,DefaultId,DefaultValue,DisplayId,
					DisplayIn,EditableId, Editable,EffectInNetAmountId,EffectInNetAmount,
					VisibilityId,Visibility,CoaId,AcName,UsrId )
		SELECT DISTINCT B.IDTSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,ISNULL(C.MasterName,'') + ' - ' + ISNULL(D.ColumnName,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM IDTSequenceDetail A
			INNER JOIN IDTSequenceMaster B ON A.IDTSeqId = B.IDTSeqId
			LEFT OUTER JOIN UDCHD C ON C.MasterId = A.MasterID
			LEFT OUTER JOIN UDCMaster D ON D.UDCMAsterID = A.DefaultValue AND C.MasterId = D.MasterID
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID<>0
		UNION
		SELECT DISTINCT  B.IDTSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'Batch Creation'  + ' - ' + ISNULL(C.FieldDesc,'') AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM IDTSequenceDetail A
			INNER JOIN IDTSequenceMaster B ON A.IDTSeqId = B.IDTSeqId
			LEFT OUTER JOIN BatchCreation C ON A.DefaultValue = C.Slno  AND A.BatchSeqId = C.BatchSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			LEFT OUTER JOIN BatchCreationMaster F ON F.BatchSeqId = C.BatchSeqId
			WHERE A.MasterID=0 AND A.BatchSeqId>0
		UNION
		SELECT DISTINCT  B.IDTSeqId,B.SequenceDate,A.SlNo,A.RefCode,A.ColumnName,A.FieldDesc,A.Calculation,
			A.DefaultValue,'' AS DefaultValue,
			A.DisplayIn,
			(CASE A.DisplayIn WHEN 1 THEN 'Value' ELSE 'Percentage' END)AS DisplayIn,
			A.Editable,
			(CASE A.Editable WHEN 1 THEN 'Yes' ELSE 'No' END)AS Editable,
			A.EffectInNetAmount,
			(CASE A.EffectInNetAmount WHEN 1 THEN 'Add' WHEN 2 THEN 'Reduce' ELSE 'Nil' END)AS EffectInNetAmount,
			A.Visibility,
			(CASE A.Visibility WHEN 1 THEN 'Yes' ELSE 'No' END)AS Visibility,
			A.CoaId,ISNULL(E.Acname,'') AS Acname ,@Pi_UsrId
			FROM IDTSequenceDetail A
			INNER JOIN IDTSequenceMaster B ON A.IDTSeqId = B.IDTSeqId
			LEFT OUTER JOIN CoaMaster E ON E.CoaId= A.CoaID
			WHERE A.MasterID=0 AND A.BatchSeqId=0 ORDER BY A.Slno
	END
END
GO
-----To Insert MenuDefinition And ProfileDt For IDT Management
DELETE FROM MenuDef WHERE SrlNo = 180 and MenuId='mCmp18'
GO
INSERT INTO MenuDef(SrlNo,MenuId,MenuName,ParentId,Caption,MenuStatus,FormName,DefaultCaption)
VALUES(180,'mCmp18','MnuIDTManagement','mCmp','IDT Management',0,'FrmIDTManagement','IDT Management ')
GO
DELETE FROM ProfileDt Where MenuId = 'mCmp18'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,
LastModBy,LastModDate,AuthId,AuthDate)
SELECT PrfId,'mCmp18',0,'New',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp18',1,'Edit',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp18',2,'Save',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp18',3,'Delete',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp18',6,'Print',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
GO
-- TO INSERT Transaction Master For IDT Management
DELETE FROM TransactionMaster Where TransactionId = 270
INSERT INTO TransactionMaster(TransactionId,TransactionCode,TransactionDescription,StockChangeType,
		UomReq,RtrSeqReq,PrdSeqReq,PurSalSeqReq,Availability,LastModBy,LastModDate,AuthId,AuthDate)
Values(270,'IDT MGMT','IDT Management',0,1,1,1,1,1,1,GetDate(),1,GetDate()) 
GO
-- To Insert CustomCaptions For IDT Management
DELETE FROM CustomCaptions where TransId  = 270
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,0,'btnOperation','&New','','',1,1,1,GetDate(),1,
GetDate(),'&New','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,1,'btnOperation','&Edit','','',1,1,1,GetDate(),1,
GetDate(),'&Edit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,2,'btnOperation','&Save','','',1,1,1,GetDate(),1,
GetDate(),'&Save','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,3,'btnOperation','&Delete','','',1,1,1,GetDate(),1,
GetDate(),'&Delete','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,4,'btnOperation','&Cancel','','',1,1,1,GetDate(),1,
GetDate(),'&Cancel','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,5,'btnOperation','E&xit','','',1,1,1,GetDate(),1,
GetDate(),'E&xit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1,6,'btnOperation','&Print','','',1,1,1,GetDate(),1,
GetDate(),'&Print','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2,1,'CoreHeaderTool','Inter Distributor Transfer','','',1,1,1,
GetDate(),1,GetDate(),'Inter Distributor Transfer','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2,2,'CoreHeaderTool','Stocky','','',1,1,1,GetDate(),1,
GetDate(),'Stocky','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,1,'lblRefNo','Reference No ...','','',1,1,1,GetDate(),1,
GetDate(),'Reference No ... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,2,'lblRefDate','Reference Date','','',1,1,1,GetDate(),1,
GetDate(),'Reference Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,3,'lblLocation','Location Name*...','','',1,1,1,GetDate(),1,
GetDate(),'Location Name*... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,4,'lblTransType','Transaction Type*...','','',1,1,1,GetDate(),1,
GetDate(),'Transaction Type*... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,5,'lblDistibutor','Distributor *...','','',1,1,1,GetDate(),1,
GetDate(),'Distributor *... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,6,'lblDocRefNo','Doc Ref No','','',1,1,1,GetDate(),1,
GetDate(),'Doc Ref No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,7,'lblLRNo','LR No','','',1,1,1,GetDate(),1,
GetDate(),'LR No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,8,'lblLRDate','Date','','',1,1,1,GetDate(),1,
GetDate(),'Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,9,9,'lblRemarks','Remarks','','',1,1,1,GetDate(),1,
GetDate(),'Remarks ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,1,'fxtRefNumber','','Press F4/Double Click to Select Reference No','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Reference No ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,2,'dtpRefDate','','Select Date','',1,1,1,GetDate(),1,
GetDate(),'','Select Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,3,'FxtLocation','','Press F4/Double Click to Select Location Name','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Location Name ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,4,'FxtDistributor','','Press F4/Double Click to Select Distributor','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Distributor ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,5,'FxtTransType','','Press F4/Double Click to Select Transaction Type','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Transaction Type ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,6,'FxtDocRefNo','','Enter Document Reference Number','',1,1,1,GetDate(),1,
GetDate(),'','Enter Document Reference Number ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,7,'FxtLRNo','','Enter LR Number','',1,1,1,GetDate(),1,
GetDate(),'','Enter LR Number ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,8,'dtpLRDate','','Select LR Date','',1,1,1,GetDate(),1,
GetDate(),'','Select LR Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,9,'RtfRemarks','','Enter Remarks','',1,1,1,GetDate(),1,
GetDate(),'','Enter Remarks ','',1,1)
GO
---  HotSearch 
--- Location
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,1,'HotSch-270-2000-1','Code','','',1,1,1,GetDate(),1,
GetDate(),'Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,2,'HotSch-270-2000-2','Name','','',1,1,1,GetDate(),1,
GetDate(),'Name ','','',1,1)
GO
DELETE FROM HotSearchEditorHD WHERE FormId = 10074
INSERT INTO HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10074,'IDTManagement','Location','Select','SELECT LcnId,LcnCode,LcnName FROM Location 
WHERE LcnId NOT IN (SELECT LcnId FROM Vehicle)')
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 10074
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
VALUES(1,10074,'Location','Code','LcnCode',2000,0,'HotSch-270-2000-1',270)
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
Values(2,10074,'Location','Name','LcnName',2500,0,'HotSch-270-2000-2',270)
GO
---  Transaction Type
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,3,'HotSch-270-2000-3','Transaction','','',1,1,1,GetDate(),1,
GetDate(),'Transaction ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,4,'HotSch-270-2000-4','Description','','',1,1,1,GetDate(),1,
GetDate(),'Description ','','',1,1)
GO
DELETE FROM HotSearchEditorHD WHERE FormId = 10075
Insert Into HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
Values(10075,'IDTManagement','TransactionType','select','SELECT StkMgmtTypeId,
TransactionType,Description,ApplyOn,UpdateInventory FROM  (SELECT StkMgmtTypeId,Description, 
CASE TransactionType WHEN 0 THEN ''Add To Stock''  WHEN 1 THEN ''Reduce From Stock'' END as TransactionType,
ApplyOn,UpdateInventory FROM StockManagementType) MainSql')
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 10075
INSERT INTO HotSearchEditorDt (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
VALUES(1,10075,'TransactionType','Transaction','TransactionType',2000,0,'HotSch-270-2000-3',270)
GO
INSERT INTO HotSearchEditorDt(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
VALUES(2,10075,'TransactionType','Description','Description',2500,0,'HotSch-270-2000-4',270)
GO
 --- Distributor
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,5,'HotSch-270-2000-5','Code','','',1,1,1,GetDate(),1,GetDate(),'Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,6,'HotSch-270-2000-6','Name','','',1,1,1,GetDate(),1,GetDate(),'Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,1,'PnlMsg-270-1000-1','Select Transaction Type','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Transaction Type','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,2,'PnlMsg-270-1000-2','Select Distributor','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Distributor','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,3,'PnlMsg-270-1000-3','Select Product','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Product','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,4,'PnlMsg-270-1000-4','Select Product','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Product','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,5,'PnlMsg-270-1000-5','Select Batch','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Batch','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,6,'PnlMsg-270-1000-6','Select Qty','','',1,1,1,GetDate(),1,GetDate(),'',
		'Select Qty','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,7,'MsgBox-270-1000-7','','','Failed to Lock Record',1,1,1,GetDate(),1,GetDate(),'',
		'','Failed to Lock Record ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,8,'MsgBox-270-1000-8','','','Back Dated Transaction Not Allowed',1,1,1,GetDate(),1,GetDate(),'',
		'','Back Dated Transaction Not Allowed ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,10,'MsgBox-270-1000-10','','',' does not Exists',1,1,1,GetDate(),1,GetDate(),'',
		'',' does not Exists ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,11,'MsgBox-270-1000-11','','','Stock Management Type',1,1,1,GetDate(),1,GetDate(),'',
		'','Stock Management Type',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,1000,13,'MsgBox-270-1000-13','','','with Reference',1,1,1,GetDate(),1,GetDate(),'',
		'','with Reference ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,7,'HotSch-270-2000-7','Reference Number','','',1,1,1,GetDate(),1,
GetDate(),'Reference Number ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,8,'HotSch-270-2000-8','Date','','',1,1,1,GetDate(),1,
GetDate(),'Date ','','',1,1)
GO
DELETE FROM HotSearchEditorHD WHERE FormId = 10073
INSERT INTO HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10073,'IDTManagement','RefNumber','select','Select IDTMngRefNo,IDTMngDate From IDTManagement')
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 10073
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
VALUES(1,10073,'RefNumber','Reference Number','IDTMngRefNo',2000,0,'HotSch-270-2000-7',270)
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,SortedType,HotSearchName,TransId)
VALUES(2,10073,'RefNumber','Date','IDTMngDate',2500,0,'HotSch-270-2000-8',270)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,9,'HotSch-270-2000-9','Batch Code','','',1,1,1,GetDate(),1,
GetDate(),'Batch Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,10,'HotSch-270-2000-10','MRP','','',1,1,1,GetDate(),1,
GetDate(),'MRP ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,11,'HotSch-270-2000-11','Purchase Rate','','',1,1,1,GetDate(),1,
GetDate(),'Purchase Rate ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,12,'HotSch-270-2000-12','Selling Rate','','',1,1,1,GetDate(),1,
GetDate(),'Selling Rate ','','',1,1)
GO
DELETE FROM HOTSEARCHEDITORHD  WHERE Formid  =  10079
INSERT INTO HOTSEARCHEDITORHD(FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10079,'IDT Managemnet','ProductBatch','Select','SELECT PrdBatID,PrdBatCode,
MRP,PurchaseRate,SellRate,PriceId FROM 
(SELECT A.PrdBatID,A.PrdBatCode,  F.PrdBatDetailValue AS SellRate, B.PrdBatDetailValue AS MRP,
D.PrdBatDetailValue AS PurchaseRate,B.PriceId  FROM  ProductBatch A (NOLOCK)   
INNER JOIN ProductBatchDetails B  (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1  
INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId   AND B.SlNo = C.SlNo AND C.MRP = 1 
INNER JOIN ProductBatchDetails D  (NOLOCK)  ON A.PrdBatId = D.PrdBatID   AND D.DefaultPrice=1   
INNER JOIN BatchCreation E (NOLOCK)    ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1    
INNER JOIN ProductBatchDetails F (NOLOCK)  ON A.PrdBatId = F.PrdBatID AND F.DefaultPrice=1  
INNER JOIN BatchCreation G (NOLOCK)  ON G.BatchSeqId = A.BatchSeqId   AND F.SlNo = G.SlNo  AND G.SelRte = 1  
INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId 
AND A.PrdBatId=PBL.PrdBatId AND (PBL.PrdBatLcnSih-PBL.PrdbatLcnResSih)>0
WHERE  A.PrdId=vFParam  AND A.Status = 1
) MainQry order by PrdBatId ASC')
GO
DELETE FROM HOTSEARCHEDITORDT  WHERE Formid  =  10079
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(1,10079,'ProductBatch','Batch Code','PrdBatCode',1000,0,'HotSch-270-2000-9',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(2,10079,'ProductBatch','MRP','MRP',1000,0,'HotSch-270-200-10',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(3,10079,'ProductBatch','Purchase Rate','PurchaseRate',1000,0,'HotSch-270-2000-11',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(4,10079,'ProductBatch','Selling Rate','SellRate',1000,0,'HotSch-270-2000-12',270)
GO
DELETE FROM HOTSEARCHEDITORHD  WHERE Formid  =  10077
INSERT INTO HOTSEARCHEDITORHD(FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10077,'IDT Managemnet','Product','Select','SELECT PrdId,PrdSeqDtId,
PrdDCode,PrdCcode,PrdName,PrdShrtName,MRP,PrdType FROM (SELECT DISTINCT A.PrdId,C.PrdSeqDtId,
A.PrdDcode,A.PrdCcode,A.PrdName,A.PrdShrtName,PBD.PrdBatDetailValue AS MRP,
A.PrdType FROM Product A WITH (NOLOCK),   ProductSequence B WITH (NOLOCK), 
ProductSeqDetails C WITH (NOLOCK),  ProductBatchDetails PBD WITH (NOLOCK),    
BatchCreation BC WITH (NOLOCK),  ProductBatchLocation D WITH (NOLOCK),  
ProductBatch E WITH (NOLOCK)      WHERE B.TransactionId = 270 AND A.PrdStatus=1 
AND B.PrdSeqId = C.PrdSeqId  AND A.PrdId = C.PrdId     AND A.PrdId=D.PrdId 
AND (D.PrdBatLcnSih-D.PrdBatLcnResSih)>0  AND PrdType <> 4 AND D.LcnId=vFParam   
AND D.PrdBatId = E.PrdBatId AND  E.Status = 1 AND E.PrdId = A.PrdId    
AND D.PrdBatId=PBD.PrdBatId   AND PBD.DefaultPrice=1 AND PBD.SlNo=BC.SlNo AND BC.MRP=1   
AND  PBD.BatchSeqId=BC.BatchSeqId    Union    
SELECT DISTINCT A.PrdId,100000 AS PrdSeqDtId,A.PrdDcode,A.PrdCcode,  
A.PrdName,A.PrdShrtName,PBD.PrdBatDetailValue AS MRP,A.PrdType    
FROM  Product A WITH (NOLOCK),ProductBatchLocation D WITH (NOLOCK), ProductBatch E WITH (NOLOCK),
ProductBatchDetails PBD WITH (NOLOCK),  BatchCreation BC WITH (NOLOCK)  WHERE PrdStatus = 1  
AND A.PrdId=D.PrdId   AND (D.PrdBatLcnSih-D.PrdBatLcnResSih)>0   AND PrdType <> 4  
AND D.LcnId=vFParam    AND    A.PrdId NOT IN ( SELECT PrdId FROM ProductSequence B WITH (NOLOCK), 
ProductSeqDetails C WITH (NOLOCK)      WHERE B.TransactionId=270 AND B.PrdSeqId=C.PrdSeqId)    
AND D.PrdBatId = E.PrdBatId AND  E.Status = 1    AND E.PrdId = A.PrdId    
and D.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1 AND PBD.SlNo=BC.SlNo     
AND BC.MRP=1 AND  PBD.BatchSeqId=BC.BatchSeqId )  a ORDER BY PrdSeqDtId')
GO
DELETE FROM HOTSEARCHEDITORDT  WHERE Formid  =  10077
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(1,10077,'Product','Seq No','PrdSeqDtId',1000,0,'HotSch-270-2000-13',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(2,10077,'Product','Dist Code','PrdDCode',1000,0,'HotSch-270-2000-14',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(3,10077,'Product','Comp Code','PrdCCode',1000,0,'HotSch-270-2000-15',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(4,10077,'Product','Name','PrdName',1500,0,'HotSch-270-2000-16',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(5,10077,'Product','Short Name','PrdShrtName',1250,0,'HotSch-270-2000-17',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(6,10077,'Product','MRP','MRP',1000,0,'HotSch-270-2000-18',270)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,13,'HotSch-270-2000-13','Seq No','','',1,1,1,GetDate(),1,GetDate(),'Seq No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,14,'HotSch-270-2000-14','Dist Code','','',1,1,1,GetDate(),1,GetDate(),'Dist Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,15,'HotSch-270-2000-15','Comp Code','','',1,1,1,GetDate(),1,GetDate(),'Comp Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,16,'HotSch-270-2000-16','Name','','',1,1,1,GetDate(),1,GetDate(),'Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,17,'HotSch-270-2000-17','Short Name','','',1,1,1,GetDate(),1,GetDate(),'Short Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,18,'HotSch-270-2000-18','MRP','','',1,1,1,GetDate(),1,GetDate(),'MRP','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,19,'PnlMsg-270-2000-19','Entered Qty','','',1,1,1,GetDate(),1,GetDate(),'Entered Qty','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,20,'PnlMsg-270-2000-20','Select Product','','',1,1,1,GetDate(),1,
GetDate(),'Select Product','','',1,1)
GO
Delete From HotSearchEditorHD Where FormId = 10076
GO
Insert Into HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
Values(10076,'IDTManagement','Distributor','select','Select SPMId,
SPMCode,SPMName From IDTMaster')
GO
Delete From HotSearchEditorDt Where FormId = 10076
GO
Insert Into HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
Values(1,10076,'Distributor','Code','SPMCode',2000,0,'HotSch-270-2000-5',270)
GO
Insert Into HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
Values(2,10076,'Distributor','Name','SPMName',2500,0,'HotSch-270-2000-6',270)
GO
Delete FROm CustomCaptions Where TransId = 69 and CtrlId = 2000 and SubCtrlId = 5
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (69,2000,5,'HotSch-69-2000-5','TaxGroup Name','','',1,1,1,GetDate(),1,
GetDate(),'TaxGroup Name ','','',1,1)
GO
Delete FROm CustomCaptions Where TransId = 69 and CtrlId = 2000 and SubCtrlId = 6
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (69,2000,6,'HotSch-69-2000-6','TaxGroup Code','','',1,1,1,GetDate(),1,
GetDate(),'TaxGroup Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,1,'MsgBox-270-5000-1','','','Unable  to Execute Compute IDT Tax SP',1,1,1,GetDate(),1,
GetDate(),'','','Unable  to Execute Compute IDT Tax SP',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,2,'MsgBox-270-5000-2','','','Total Quantity less than Available Quantity',1,1,1,GetDate(),1,
GetDate(),'','','Total Quantity less than Available Quantity ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,3,'MsgBox-270-5000-3','','','While Updating IDTManagement ProductTax',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDTManagement ProductTax ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,4,'MsgBox-270-5000-4','','','While Updating IDTManagement Product',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDTManagement Product ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,5,'MsgBox-270-5000-5','','','While Updating IDTManagement Line Amount',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDTManagement Line Amount ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,6,'MsgBox-270-5000-6','','','While Updating IDTManagement',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDTManagement ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,1,'PnlMsg-270-6000-1','','Enter Qty','',1,1,1,GetDate(),1,
GetDate(),'','','Enter Qty ',1,1)
GO
DELETE FROM HOTSEARCHEDITORHD  WHERE Formid  =  10079
GO
INSERT INTO HOTSEARCHEDITORHD(FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10079,'IDT Managemnet','ProductBatch','Select','SELECT PrdBatID,PrdBatCode,
MRP,PurchaseRate,SellRate,PriceId,AvailStock FROM 
(SELECT A.PrdBatID,A.PrdBatCode,  F.PrdBatDetailValue AS SellRate, B.PrdBatDetailValue AS MRP,
D.PrdBatDetailValue AS PurchaseRate,B.PriceId,
(PBL.PrdBatLcnSih-PBL.PrdbatLcnResSih) as AvailStock  FROM  ProductBatch A (NOLOCK)   
INNER JOIN ProductBatchDetails B  (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1  
INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId   AND B.SlNo = C.SlNo AND C.MRP = 1 
INNER JOIN ProductBatchDetails D  (NOLOCK)  ON A.PrdBatId = D.PrdBatID   AND D.DefaultPrice=1   
INNER JOIN BatchCreation E (NOLOCK)    ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1    
INNER JOIN ProductBatchDetails F (NOLOCK)  ON A.PrdBatId = F.PrdBatID AND F.DefaultPrice=1  
INNER JOIN BatchCreation G (NOLOCK)  ON G.BatchSeqId = A.BatchSeqId   AND F.SlNo = G.SlNo  AND G.SelRte = 1  
INNER JOIN ProductBatchLocation PBL (NOLOCK) ON A.PrdId=PBL.PrdId 
AND A.PrdBatId=PBL.PrdBatId AND (PBL.PrdBatLcnSih-PBL.PrdbatLcnResSih)>0
WHERE  A.PrdId=vFParam  AND A.Status = 1
) MainQry order by PrdBatId ASC')
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,15,'lblStockOnHand','','Stock on Hand','',1,1,1,GetDate(),1,
GetDate(),'','Stock on Hand','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,10,16,'lblAvailQty','','0','',1,1,1,GetDate(),1,
GetDate(),'','0','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,7,'MsgBox-270-5000-7','','','Location',1,1,1,GetDate(),1,
GetDate(),'','','Location ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,8,'MsgBox-270-5000-8','','','Distributor',1,1,1,GetDate(),1,
GetDate(),'','','Distributor ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,2,'PnlMsg-270-6000-2','','Press F4/Double Click to Select Product Name','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Product Name ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,3,'PnlMsg-270-6000-3','','Press F4/Double Click to Select Product Name','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Product Name ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,4,'PnlMsg-270-6000-4','','Press F4/Double Click to Select Product Batch','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Product Batch ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,5,'PnlMsg-270-6000-5','','Enter Quantity','',1,1,1,GetDate(),1,
GetDate(),'','Enter Quantity ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,9,'MsgBox-270-5000-9','','','Duplicate Row Not Allowed',1,1,1,GetDate(),1,
GetDate(),'','','Duplicate Row Not Allowed ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,10,'MsgBox-270-5000-10','','','in Voucher Posting',1,1,1,GetDate(),1,
GetDate(),'','','in Voucher Posting ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,10,'PnlMsg-270-6000-10','Gross Amount','','',1,1,1,GetDate(),1,
GetDate(),'Gross Amount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,11,'PnlMsg-270-6000-11','Enter LR Date','','',1,1,1,GetDate(),1,
GetDate(),'Enter LR Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,12,'PnlMsg-270-6000-12','Enter Remarks','','',1,1,1,GetDate(),1,
GetDate(),'Enter Remarks ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,5000,11,'MsgBox-270-5000-11','','','Product Details Available Clear and Proceed',1,1,1,GetDate(),1,
GetDate(),'','','Product Details Available Clear and Proceed ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,13,'PnlMsg-270-6000-13',
'IDT Receipts are already Available for todays date, IDT Sequence cannot be set','','',1,1,1,GetDate(),1,
GetDate(),'IDT Receipts are already Available for todays date, IDT Sequence cannot be set ','','',1,1)
GO
DELETE FROM CustomCaptions Where TransId = 270 and CtrlId = 3
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,1,'DGCommon-270-3-1','PrdId','','',1,1,1,GetDate(),1,
GetDate(),'PrdId ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,2,'DGCommon-270-3-2','Product Code *...','','',1,1,1,GetDate(),1,
GetDate(),'Product Code*... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,3,'DGCommon-270-3-3','Product Name*...','','',1,1,1,GetDate(),1,
GetDate(),'Product Name*... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,4,'DGCommon-270-3-4','BatchId','','',1,1,1,GetDate(),1,
GetDate(),'BatchId ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,5,'DGCommon-270-3-5','Batch No*...','','',1,1,1,GetDate(),1,
GetDate(),'Batch No*... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,
DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled)
VALUES (270,3,6,'DGCommon-270-3-6','User Stock Type','','',1,1,1,GETDATE(),1,GETDATE(),'User Stock Type','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,7,'DGCommon-270-3-7','StockType','','',1,1,1,GETDATE(),1,GETDATE(),'StockType','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,8,'DGCommon-270-3-8','Qty','','',1,1,1,GETDATE(),1,GETDATE(),'Qty','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,9,'DGCommon-270-3-9','Avail Qty','','',1,1,1,GETDATE(),1,GETDATE(),'Avail Qty','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,10,'DGCommon-270-3-10','Duplicate','','',1,1,1,GETDATE(),1,GETDATE(),'Duplicate','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,11,'DGCommon-270-3-11','PriceId','','',1,1,1,GETDATE(),1,GETDATE(),'PriceId','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,12,'DGCommon-270-3-12','Rate','','',1,1,1,GETDATE(),1,GETDATE(),'Rate','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,13,'DGCommon-270-3-13','MRP','','',1,1,1,GETDATE(),1,GETDATE(),'MRP','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,14,'DGCommon-270-3-14','Gross Amount','','',1,1,1,GETDATE(),1,GETDATE(),'Gross Amount','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,3,15,'DGCommon-270-3-15','Net Amount','','',1,1,1,GETDATE(),1,GETDATE(),'Net Amount','','',1,1)
GO
DELETE FROM CustomCaptions where TransId = 270 and CtrlId = 6000 and SubCtrlId = 14
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,6000,14,'PnlMsg-270-6000-14','','Net Amount cannot be less than Zero','',1,1,1,GetDate(),1,
GetDate(),'','','Net Amount cannot be less than Zero ',1,1)
GO
DELETE FROM HotSearchEditorHd WHERE Formid  = 10078 AND ControlName = 'IDT In Product'
GO
INSERT INTO HotSearchEditorHd (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10078,'IDT Managemnet','IDT In Product','Select','SELECT distinct PrdId,PrdSeqDtId,PrdDcode,PrdCcode,
PrdName,PrdShrtName,MRP,PrdType FROM (SELECT distinct A.PrdId,C.PrdSeqDtId,A.PrdDcode,A.PrdCcode,A.PrdName,
A.PrdShrtName,PBD.PrdBatDetailValue AS MRP ,A.PrdType FROM Product A WITH(NOLOCK),  
ProductSequence B WITH (NOLOCK),  ProductSeqDetails C WITH (NOLOCK),ProductBatch PB WITH (NOLOCK),  
ProductBatchDetails PBD WITH (NOLOCK),  BatchCreation BC WITH (NOLOCK) WHERE B.TransactionId=270
AND A.PrdStatus=1 AND PB.PrdBatId=PBD.PrdBatId    AND PBD.DefaultPrice=1 AND PBD.SlNo=BC.SlNo AND BC.MRP=1 
AND PBD.BatchSeqId=BC.BatchSeqId AND A.PrdId = PB.PrdId   AND A.PrdType <> 3  AND B.PrdSeqId = C.PrdSeqId 
AND A.PrdId = C.PrdId UNION SELECT distinct A.PrdId,100000 AS PrdSeqDtId,A.PrdDcode,PrdCcode,PrdName,PrdShrtName,
PBD.PrdBatDetailValue AS MRP,A.PrdType FROM Product A WITH (NOLOCK), ProductBatch PB WITH (NOLOCK),
ProductBatchDetails PBD WITH (NOLOCK), BatchCreation BC WITH (NOLOCK)   
WHERE PrdStatus = 1 AND PrdType <> 3 and A.PrdId NOT IN ( SELECT PrdId FROM ProductSequence B WITH (NOLOCK),  
ProductSeqDetails C WITH (NOLOCK) WHERE B.TransactionId=270 AND B.PrdSeqId=C.PrdSeqId)   
AND PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1   AND PBD.SlNo=BC.SlNo AND BC.MRP=1    
AND PBD.BatchSeqId=BC.BatchSeqId AND A.PrdId = PB.PrdId) MainSql ORDER BY PrdSeqDtId')
GO
DELETE FROM HOTSEARCHEDITORDT  WHERE Formid  =  10078
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(1,10078,'IDT In Product','Seq No','PrdSeqDtId',1000,0,'HotSch-270-2000-37',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(2,10078,'IDT In Product','Dist Code','PrdDCode',1000,0,'HotSch-270-2000-38',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(3,10078,'IDT In Product','Comp Code','PrdCCode',1000,0,'HotSch-270-2000-39',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(4,10078,'IDT In Product','Name','PrdName',1500,0,'HotSch-270-2000-40',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(5,10078,'IDT In Product','Short Name','PrdShrtName',1250,0,'HotSch-270-2000-41',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(6,10078,'IDT In Product','MRP','MRP',1000,0,'HotSch-270-2000-42',270)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,37,'HotSch-270-2000-37','Seq No','','',1,1,1,GetDate(),1,
GetDate(),'Seq No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,38,'HotSch-270-2000-38','Dist Code','','',1,1,1,GetDate(),1,
GetDate(),'Dist Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,39,'HotSch-270-2000-39','Comp Code','','',1,1,1,GetDate(),1,
GetDate(),'Comp Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,40,'HotSch-270-2000-40','Name','','',1,1,1,GetDate(),1,
GetDate(),'Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,41,'HotSch-270-2000-41','Short Name','','',1,1,1,GetDate(),1,
GetDate(),'Short Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,42,'HotSch-270-2000-42','MRP','','',1,1,1,GetDate(),1,
GetDate(),'MRP','','',1,1)
GO
DELETE FROM HotSearchEditorHd  WHERE Formid  = 10080 AND ControlName = 'IDT In Product Batch'
GO
INSERT INTO HotSearchEditorHd (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10080,'IDT Managemnet','IDT In Product Batch','Select','SELECT PrdBatID,PrdBatCode,
MRP,PurchaseRate,SellRate,PriceId,AvailStock FROM (SELECT A.PrdBatID,A.PrdBatCode,F.PrdBatDetailValue AS SellRate, 
B.PrdBatDetailValue AS MRP,  D.PrdBatDetailValue AS PurchaseRate,B.PriceId,  
0 as AvailStock  FROM  ProductBatch A (NOLOCK)     
INNER JOIN ProductBatchDetails B  (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1    
INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId   AND B.SlNo = C.SlNo AND C.MRP = 1   
INNER JOIN ProductBatchDetails D  (NOLOCK)  ON A.PrdBatId = D.PrdBatID   AND D.DefaultPrice=1     
INNER JOIN BatchCreation E (NOLOCK)    ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1      
INNER JOIN ProductBatchDetails F (NOLOCK)  ON A.PrdBatId = F.PrdBatID AND F.DefaultPrice=1    
INNER JOIN BatchCreation G (NOLOCK)  ON G.BatchSeqId = A.BatchSeqId   AND F.SlNo = G.SlNo  
AND G.SelRte = 1    WHERE  A.PrdId=vFParam  AND A.Status = 1  ) MainQry order by PrdBatId ASC')
GO
DELETE FROM HOTSEARCHEDITORDT  WHERE Formid  =  10080
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(1,10080,'IDT In Product Batch','Batch Code','PrdBatCode',1000,0,'HotSch-270-2000-43',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(2,10080,'IDT In Product Batch','MRP','MRP',1000,0,'HotSch-270-2000-44',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(3,10080,'IDT In Product Batch','Purchase Rate','PurchaseRate',1000,0,'HotSch-270-2000-45',270)
GO
INSERT INTO HOTSEARCHEDITORDT(Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
SortedType,HotSearchName,TransId)
VALUES(4,10080,'IDT In Product Batch','Selling Rate','SellRate',1000,0,'HotSch-270-2000-46',270)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,43,'HotSch-270-2000-43','Batch Code','','',1,1,1,GetDate(),1,
GetDate(),'Batch Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,44,'HotSch-270-2000-44','MRP','','',1,1,1,GetDate(),1,
GetDate(),'MRP ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,45,'HotSch-270-2000-45','Purchase Rate','','',1,1,1,GetDate(),1,
GetDate(),'Purchase Rate ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (270,2000,46,'HotSch-270-2000-46','Selling Rate','','',1,1,1,GetDate(),1,
GetDate(),'Selling Rate ','','',1,1)
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'[Proc_ComputeIDTTax]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_ComputeIDTTax
GO
--  EXEC [Proc_ComputeIDTTax] 2,253,1
CREATE PROCEDURE Proc_ComputeIDTTax
(
	@Pi_RowId  INT,
	@Pi_CalledFrom  INT,
	@Pi_UserId  INT
)
AS
/*****************************************************************************************************
* PROCEDURE : Proc_ComputeIDTTax
* PURPOSE	: To Calculate the Line Level Tax
* CREATED	: Panneerselvam.K
* CREATED DATE  : 22/03/2007
* MODIFIED Purpose : To Calculate Tax for Inter Distributor's
* DATE      AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------------------------------
* {date} {developer}  {brief modification description}
*******************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @PrdBatTaxGrp   INT
	DECLARE @RtrTaxGrp   INT
	DECLARE @TaxSlab  INT
	DECLARE @MRP   NUMERIC(28,10)
	DECLARE @SellingRate  NUMERIC(28,10)
	DECLARE @PurchaseRate  NUMERIC(28,10)
	DECLARE @TaxableAmount  NUMERIC(28,10)
	DECLARE @ParTaxableAmount NUMERIC(28,10)
	DECLARE @TaxPer   NUMERIC(38,2)
	DECLARE @TaxId   INT

	DECLARE @TaxSetting TABLE
	(
		TaxSlab   INT,
		ColNo   INT,
		SlNo   INT,
		BillSeqId  INT,
		TaxSeqId  INT,
		ColType   INT,
		ColId   INT,
		ColVal   NUMERIC(38,2)
	)

	--To Take the Batch TaxGroup Id
	SELECT @PrdBatTaxGrp = TaxGroupId
	FROM ProductBatch A (NOLOCK)  
				INNER JOIN	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID
				AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom

	--To Take the Batch List Price
	IF (@Pi_CalledFrom = 270 )
	BEGIN
			SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) 
			FROM ProductBatch A (NOLOCK) 
				 INNER JOIN	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID
				 AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom
				 INNER JOIN ProductBatchDetails C (NOLOCK) ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId
				 INNER JOIN BatchCreation D (NOLOCK) ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo
				 AND D.ListPrice = 1
	END

	--To Take the Batch MRP
	IF (@Pi_CalledFrom = 270 )
	BEGIN
			SELECT @MRP = ISNULL((C.PrdBatDetailValue * BaseQty),0) 
			FROM ProductBatch A (NOLOCK) 
				INNER JOIN BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID
					AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom
					INNER JOIN ProductBatchDetails C (NOLOCK) 	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId
					INNER JOIN BatchCreation D (NOLOCK)		ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo
					AND D.MRP = 1
	END

	--To Take the Batch Selling Rate
	IF (@Pi_CalledFrom = 270 )
	BEGIN
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) 
			FROM ProductBatch A (NOLOCK) 
			INNER JOIN	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID
						AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom
			INNER JOIN ProductBatchDetails C (NOLOCK)	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId
			INNER JOIN BatchCreation D (NOLOCK)	    	ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo
			AND D.SelRte = 1
	END


	IF (@Pi_CalledFrom = 270)
	BEGIN
			--To Take the IDT TaxGroup Id
			SELECT DISTINCT @RtrTaxGrp = TaxGroupId 
			FROM IDTMaster A (NOLOCK) INNER JOIN BilledPrdHdForTax B (NOLOCK) On A.SPMId = B.RtrId
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId
			AND B.TransId = @Pi_CalledFrom
	END


	--Store the Tax Setting for the Corresponding Retailer and Batch
	INSERT INTO @TaxSetting (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)
	SELECT 
			B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal
	FROM 
			TaxSettingMaster A (NOLOCK) 
			INNER JOIN	TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId
			INNER JOIN BilledPrdHdForTax C (NOLOCK) ON C.BillSeqId = B.BillSeqId
	WHERE 
			A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp AND C.UsrId = @Pi_UserId
			AND C.RowId = @Pi_RowId AND C.TransId = @Pi_CalledFrom
			AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE
								RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp)

	DELETE FROM BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId
	AND TransId = @Pi_CalledFrom

	--Cursor For Taking Each Slab and Calculate Tax
	DECLARE  CurTax CURSOR FOR
	SELECT DISTINCT TaxSlab FROM @TaxSetting

	OPEN CurTax
	FETCH NEXT FROM CurTax INTO @TaxSlab
		WHILE @@FETCH_STATUS = 0
		BEGIN

			SET @TaxableAmount = 0
			--To Filter the Records Which Has Tax Percentage (>=0)
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1
			AND ColId = 0 and ColVal >= 0)
			BEGIN
				--To Get the Tax Percentage for the selected slab
				SELECT @TaxPer = ColVal FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1
				AND ColId = 0

				--To Get the TaxId for the selected slab
				SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1
				AND ColId > 0

				--To Get the Adjustable amount from Other Columns
				SELECT @TaxableAmount = ISNULL(SUM(ColValue),0) FROM
				(SELECT CASE B.ColVal WHEN 1 THEN A.ColValue WHEN 2 THEN -1 * A.ColValue END AS ColValue 
				 FROM BilledPrdDtForTax A 
					  INNER JOIN @TaxSetting B ON A.ColId = B.ColId AND A.RowId =  @Pi_RowId 
					  AND A.UsrId = @Pi_UserId AND A.TransId = @Pi_CalledFrom
				WHERE TaxSlab = @TaxSlab AND B.ColType = 2 and B.ColId>3
				And B.ColVal >0  ) as C

				--To add MRP to Taxable Amount if MRP Is Selected for the Slab
				IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2
													 AND ColId = 1 and ColVal > 0)
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP

				--To add Selling Rate to Taxable Amount if Selling Rate Is Selected for the Slab
				IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2
													 AND ColId = 2 and ColVal > 0)
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @SellingRate

				--To add Purchase Rate to Taxable Amount if Purchase Rate Is Selected for the Slab
				IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2
				AND ColId = 3 and ColVal > 0)
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @PurchaseRate

				--To Get the Parent Taxable Amount for the Tax Slab
				SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM BilledPrdDtCalculatedTax A
				INNER JOIN @TaxSetting B ON A.TaxId = B.ColVal AND A.RowId = @Pi_RowId
				AND A.UsrId = @Pi_UserId AND B.ColType = 3 AND B.TaxSlab = @TaxSlab
				AND A.TransId = @Pi_CalledFrom

				Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount
				--Insert the New Tax Amounts
				INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,
													 TaxableAmount,TaxAmount,Usrid,TransId)
				SELECT 
					@Pi_RowId,B.PrdId,B.PrdBatId,@TaxId,@TaxSlab,@TaxPer,
					@TaxableAmount,cast(@TaxableAmount * (@TaxPer / 100 ) AS NUMERIC(28,10)),
					@Pi_UserId,@Pi_CalledFrom 
				FROM BilledPrdHdForTax B (NOLOCK) WHERE
				B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom
			END
		FETCH NEXT FROM CurTax INTO @TaxSlab
	END
	CLOSE CurTax
	DEALLOCATE CurTax
END
GO
-----To Insert MenuDefinition And ProfileDt For IDT Collection
DELETE FROM MenuDef WHERE SrlNo = 181 AND MenuId='mCmp19'
INSERT INTO MenuDef(SrlNo,MenuId,MenuName,ParentId,Caption,MenuStatus,FormName,DefaultCaption)
VALUES(181,'mCmp19','MnuIDTCollection','mCmp','IDT Collection',0,'FrmIDTCollection','IDT Collection ')
GO
DELETE FROM ProfileDt Where MenuId = 'mCmp19'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,
LastModBy,LastModDate,AuthId,AuthDate)
SELECT PrfId,'mCmp19',0,'New',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp19',1,'Edit',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp19',2,'Save',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
UNION ALL
SELECT PrfId,'mCmp19',6,'Print',1,1,1,GetDate(),1,GetDate() FROM ProfileHD
GO
-- To Insert Transaction For IDT Collection
DELETE FROM TransactionMaster Where TransactionId = 271
GO
INSERT INTO TransactionMaster(TransactionId,TransactionCode,TransactionDescription,StockChangeType,
		UomReq,RtrSeqReq,PrdSeqReq,PurSalSeqReq,Availability,LastModBy,LastModDate,AuthId,AuthDate)
VALUES(271,'IDT Coll','IDT Collection',0,0,1,0,0,1,1,GetDate(),1,GetDate()) 
GO
-- To Insert CustomCaptions For IDT Collection
DELETE FROM CustomCaptions where TransId  = 271
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,1,1,'CoreHeaderTool','IDT Receipt','','',1,1,1,
GetDate(),1,GetDate(),'IDT Receipt ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,1,2,'CoreHeaderTool','Stocky','','',1,1,1,GetDate(),1,
GetDate(),'Stocky','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,0,'btnOperation','&New','','',1,1,1,GetDate(),1,
GetDate(),'&New','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,1,'btnOperation','&Edit','','',1,1,1,GetDate(),1,
GetDate(),'&Edit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,2,'btnOperation','&Save','','',1,1,1,GetDate(),1,
GetDate(),'&Save','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,3,'btnOperation','&Delete','','',1,1,1,GetDate(),1,
GetDate(),'&Delete','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,4,'btnOperation','&Cancel','','',1,1,1,GetDate(),1,
GetDate(),'&Cancel','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,5,'btnOperation','E&xit','','',1,1,1,GetDate(),1,
GetDate(),'E&xit','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,2,6,'btnOperation','&Print','','',1,1,1,GetDate(),1,
GetDate(),'&Print','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,1,'lblRefNo','Reference No ...','','',1,1,1,GetDate(),1,
GetDate(),'Reference No ... ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,2,'lblFromDate','From Date','','',1,1,1,GetDate(),1,
GetDate(),'From Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,3,'lblToDate','To Date','','',1,1,1,GetDate(),1,
GetDate(),'To Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,4,'lblType','Type (+)','','',1,1,1,GetDate(),1,
GetDate(),'Type (+) ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,5,'lblCollDate','Collection Date','','',1,1,1,GetDate(),1,
GetDate(),'Collection Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,6,'lblCollectedDate','Collected Date','','',1,1,1,GetDate(),1,
GetDate(),'Collected Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,3,7,'lblIDT','Inter Distributors','','',1,1,1,GetDate(),1,
GetDate(),'Inter Distributors ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,1,'fxtRefNumber','','Press F4/Double Click to Select Reference No','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/Double Click to Select Reference No ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,2,'dtpFromDate','','Enter From Date','',1,1,1,GetDate(),1,
GetDate(),'','Enter From Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,3,'dtpToDate','','Enter To Date','',1,1,1,GetDate(),1,
GetDate(),'','Enter To Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,4,'FxtType','','Press Space Bar/Dbl Click to Select Collection Type','',1,1,1,GetDate(),1,
GetDate(),'','Press Space Bar/Dbl Click to Select Collection Type ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,5,'dtpCollDate','','Enter Collection Date','',1,1,1,GetDate(),1,
GetDate(),'','Enter Collection Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,6,'DtpCollectedDate','','Enter Collected Date','',1,1,1,GetDate(),1,
GetDate(),'','Enter Collected Date ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4,7,'LstIDT','','Select Inter Distributor','',1,1,1,GetDate(),1,
GetDate(),'','Select Inter Distributor ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,1,'DGCommon-271-5-1','IDT Ref.No','','',1,1,1,GetDate(),1,
GetDate(),'IDT Ref.No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,2,'DGCommon-271-5-2','Doc Ref No','','',1,1,1,GetDate(),1,
GetDate(),'Doc Ref No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,3,'DGCommon-271-5-3','Distributor Name','','',1,1,1,GetDate(),1,
GetDate(),'Distributor Name','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,4,'DGCommon-271-5-4','Invoice Amount','','',1,1,1,GetDate(),1,
GetDate(),'Invoice Amount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,5,'DGCommon-271-5-5','Received Amount','','',1,1,1,GetDate(),1,
GetDate(),'Received Amount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,6,'DGCommon-271-5-6','Pending Amount','','',1,1,1,GetDate(),1,
GetDate(),'Pending Amount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,7,'DGCommon-271-5-7','Cash Discount','','',1,1,1,GetDate(),1,
GetDate(),'Cash Discount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,8,'DGCommon-271-5-8','Collected Amount','','',1,1,1,GetDate(),1,
GetDate(),'Collected Amount ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,9,'DGCommon-271-5-9','Transaction Type','','',1,1,1,GetDate(),1,
GetDate(),'Transaction Type ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,10,'DGCommon-271-5-10','IDTID','','',1,1,1,GetDate(),1,
GetDate(),'IDTID ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,1,'PnlMsg-271-6000-1','','Enter From Date','',1,1,1,GetDate(),1,
GetDate(),'','','Enter From Date ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,2,'PnlMsg-271-6000-2','','Enter To Date','',1,1,1,GetDate(),1,
GetDate(),'','','Enter To Date ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,3,'PnlMsg-271-6000-3','','Enter Cash Discount Amount','',1,1,1,GetDate(),1,
GetDate(),'','','Enter Cash Discount Amount ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,4,'PnlMsg-271-6000-4','','Press Insert Key to Invoke Receipt Details','',1,1,1,GetDate(),1,
GetDate(),'','','Press Insert Key to Invoke Receipt Details ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,1,'MsgBox-271-5000-1','','','To Date should be greater than From Date',1,1,1,GetDate(),1,
GetDate(),'','','To Date should be greater than From Date ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,2,'MsgBox-271-5000-2','','','Total Pending Amount less than Equal to Collected Amount',1,1,1,GetDate(),1,
GetDate(),'','','Total Pending Amount less than Equal to Collected Amount ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,3,'MsgBox-271-5000-3','','','Back Dated Transaction Not Allowed',1,1,1,GetDate(),1,
GetDate(),'','','Back Dated Transaction Not Allowed ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,4,'MsgBox-271-5000-4','','','While Updating IDT Receipt Invoice',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDT Receipt Invoice ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,5,'MsgBox-271-5000-5','','','While Updating IDT Receipt Invoice Details',1,1,1,GetDate(),1,
GetDate(),'','','While Updating IDT Receipt Invoice Details ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,6,'MsgBox-271-5000-6','','','Collected Amount Cannot be Zero',1,1,1,GetDate(),1,
GetDate(),'','','Collected Amount Cannot be Zero ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,7,'MsgBox-271-5000-7','','',' With Reference',1,1,1,GetDate(),1,
GetDate(),'','',' With Reference ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4000,1,'HotSch-271-4000-1','Reference Number','','',1,1,1,GetDate(),1,
GetDate(),'Reference Number ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,15,'PnlMsg-271-6000-15','','IDT Document Reference Number','',1,1,1,GetDate(),1,
GetDate(),'','IDT Document Reference Number ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,16,'PnlMsg-271-6000-16','','IDT Distributor Name','',1,1,1,GetDate(),1,
GetDate(),'','IDT Distributor Name ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,17,'PnlMsg-271-6000-17','','Invoice Amount','',1,1,1,GetDate(),1,
GetDate(),'','Invoice Amount ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,18,'PnlMsg-271-6000-18','','Paid Amount','',1,1,1,GetDate(),1,
GetDate(),'','Paid Amount ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,19,'PnlMsg-271-6000-19','','Pending Amount','',1,1,1,GetDate(),1,
GetDate(),'','Pending Amount ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5000,9,'MsgBox-271-5000-9','','','in Voucher Posting',1,1,1,GetDate(),1,
GetDate(),'','','in Voucher Posting ',1,1)
GO
---- To Insert HotSearchEditorHD
DELETE FROM HotSearchEditorHD WHERE FormId = 10082
GO
INSERT INTO HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10082,'IDTReceiptPayment','ReferenceNo','select','Select Distinct IDTRcpNo,IDTCollectionDate From IDtReceipt')
GO
---- To Insert HotSearchEditorDt
DELETE FROM HotSearchEditorDt WHERE FormId = 10082
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
VALUES(1,10082,'ReferenceNo','Reference Number','IDTRcpNo',2500,0,'HotSch-271-4000-1',271)
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
VALUES(2,10082,'ReferenceNo','Date','IDTCollectionDate',1700,0,'HotSch-271-4000-2',271)
GO
-- To Insert ScreenDefaultValues
DELETE FROM ScreenDefaultValues Where TransId = 271
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,Availability,LastModBy,
LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
VALUES(271,1,0,'Receipt',1,1,1,1,GetDate(),1,GetDate(),'Receipt ')
GO
INSERT INTO ScreenDefaultValues(TransId,CtrlId,CtrlValue,CtrlDesc,SeqId,LngId,Availability,LastModBy,
LastModDate,AuthId,AuthDate,DefaultCtrlDesc)
VALUES(271,1,1,'Payment',2,1,1,1,GetDate(),1,GetDate(),'Payment ')
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 5 and SubCtrlId = 50 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,50,'DGCommon-271-5-50','Paid Amount','','',1,1,1,GetDate(),1,
GetDate(),'','','Paid Amount ',1,1)
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 5 and SubCtrlId = 51 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,51,'DGCommon-271-5-51','Pending Amount','','',1,1,1,GetDate(),1,
GetDate(),'','','Pending Amount ',1,1)
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 5 and SubCtrlId = 52
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,5,52,'DGCommon-271-5-52','Payment Amount','','',1,1,1,GetDate(),1,
GetDate(),'','','Payment Amount ',1,1)
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 6000 and SubCtrlId = 14 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,14,'PnlMsg-271-6000-14','','IDT Reference Number','',1,1,1,GetDate(),1,
GetDate(),'','IDT Reference Number ','',1,1)
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 6000 and SubCtrlId = 21 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,21,'PnlMsg-271-6000-21','','Press Insert Key to Invoke Payment Details','',1,1,1,GetDate(),1,
GetDate(),'','Press Insert Key to Invoke Payment Details ','',1,1)
GO
DELETE From  CustomCaptions  where transid  = 271  and CtrlId = 6000 and SubCtrlId = 20
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,20,'PnlMsg-271-6000-20','','Collected Amount Cannot be Zero','',1,1,1,GetDate(),1,
GetDate(),'','Collected Amount Cannot be Zero ','',1,1)
GO
DELETE FROM CustomCaptions WHERE TransId = 271  AND  CtrlId = 6000 AND SubCtrlId = 22 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,22,'PnlMsg-271-6000-22','','Received Amount','',1,1,1,GetDate(),1,
GetDate(),'','Received Amount ','',1,1)
GO
DELETE FROM CustomCaptions where TransId = 271  and  CtrlId = 6000 and SubCtrlId = 23 
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,6000,23,'PnlMsg-271-6000-23','','Paid Amount','',1,1,1,GetDate(),1,
GetDate(),'','Paid Amount ','',1,1)
GO
DELETE FROM CustomCaptions WHERE TransId = 271  and CtrlId = 4000 and SubCtrlId =  2
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (271,4000,2,'HotSch-271-4000-2','Date','','',1,1,1,GetDate(),1,
GetDate(),'Date ','','',1,1)
GO
-- To Insert CustomCaptions For IDT Receipt
DELETE FROM CustomCaptions where TransId  = 272
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1,1,'CoreHeaderTool','Receipt/Payment Details','','',1,1,1,
GetDate(),1,GetDate(),'Receipt/Payment Details ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1,2,'CoreHeaderTool','Stocky','','',1,1,1,GetDate(),1,
GetDate(),'Stocky','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,3,1,'FpIDTDet-272-3-1','Cash','','',1,1,1,GetDate(),1,
GetDate(),'Cash ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,3,2,'FpIDTDet-272-3-2','Cheque','','',1,1,1,GetDate(),1,
GetDate(),'Cheque ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,3,3,'FpIDTDet-272-3-3','DD','','',1,1,1,GetDate(),1,
GetDate(),'DD ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,3,4,'FpIDTDet-272-3-4','RTGS','','',1,1,1,GetDate(),1,
GetDate(),'RTGS ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,1,'FpIDTDet-272-4-1','Type','','',1,1,1,GetDate(),1,
GetDate(),'Type ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,2,'FpIDTDet-272-4-2','Instrument No','','',1,1,1,GetDate(),1,
GetDate(),'Instrument No ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,3,'FpIDTDet-272-4-3','BankId','','',1,1,1,GetDate(),1,
GetDate(),'BankId ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,4,'FpIDTDet-272-4-4','Bank Name','','',1,1,1,GetDate(),1,
GetDate(),'Bank Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,5,'FpIDTDet-272-4-5','BranchID','','',1,1,1,GetDate(),1,
GetDate(),'BranchID ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,6,'FpIDTDet-272-4-6','Branch Name','','',1,1,1,GetDate(),1,
GetDate(),'Branch Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,7,'FpIDTDet-272-4-7','Date','','',1,1,1,GetDate(),1,
GetDate(),'Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,8,'FpIDTDet-272-4-8','Amount','','',1,1,1,GetDate(),1,
GetDate(),'Date ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,4,9,'FpIDTDet-272-4-9','IDTRcpNo','','',1,1,1,GetDate(),1,
GetDate(),'IDTRcpNo ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,2000,1,'HotSch-272-2000-1','Bank Code','','',1,1,1,GetDate(),1,
GetDate(),'Bank Code ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,2000,2,'HotSch-272-2000-2','Bank Name','','',1,1,1,GetDate(),1,
GetDate(),'Bank Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,2000,3,'HotSch-272-2000-3','Branch Name','','',1,1,1,GetDate(),1,
GetDate(),'Branch Name ','','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1000,1,'PnlMsg-272-1000-1','','Enter Cheque/DD Number','',1,1,1,GetDate(),1,
GetDate(),'','Enter Cheque/DD Number ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1000,2,'PnlMsg-272-1000-2','','Press F4/DblClick to Select Bank Name','',1,1,1,GetDate(),1,
GetDate(),'','Press F4/DblClick to Select Bank Name ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1000,3,'PnlMsg-272-1000-3','','Enter/Select Cheque or DD Date (dd/MM/yyyy)','',1,1,1,GetDate(),1,
GetDate(),'','Enter Cheque or DD Date (dd/MM/yyyy) ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,1000,4,'PnlMsg-272-1000-4','','Enter Collected Amount','',1,1,1,GetDate(),1,
GetDate(),'','Enter Collected Amount ','',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,5000,1,'MsgBox-272-5000-1','','','Duplicate Instrument Not Allowed',1,1,1,GetDate(),1,
GetDate(),'','','Duplicate Instrument Not Allowed ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,6000,10,'PnlMsg-272-6000-10','','Enter Collection Date','',1,1,1,GetDate(),1,
GetDate(),'','','Enter Collection Date ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,6000,11,'PnlMsg-272-6000-11','','Press Spacebar/Click/Right click to select Distributors','',1,1,1,GetDate(),1,
GetDate(),'','','Press Spacebar/Click/Right click to select Distributors ',1,1)
GO
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (272,6000,6,'PnlMsg-272-6000-6','','Duplicate Instrument Number Not Allowed','',1,1,1,GetDate(),1,
GetDate(),'','Duplicate Instrument Number Not Allowed ','',1,1)
GO
DELETE FROM HotSearchEditorHD WHERE FormId = 10083
GO
INSERT INTO HotSearchEditorHD (FormId,FormName,ControlName,SltString,RemainsltString)
VALUES(10083,'IDTReceiptPayment','BankName','select','SELECT Bnkid,BnkCode,BnkName,BnkBrId,
BnkBrName FROM (SELECT B.Bnkid,BnkCode,BnkName,BnkBrId,BnkBrName    FROM Bank B with(nolock), 
BankBranch BB with(nolock) WHERE B.BnkId = BB.BnkId) MainSql')
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 10083
GO
INSERT INTO HotSearchEditorDt (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
VALUES(1,10083,'BankName','Bank Code','BnkCode',1000,0,'HotSch-272-2000-1',272)
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
VALUES(2,10083,'BankName','Bank Name','BnkName',1500,0,'HotSch-272-2000-2',272)
GO
INSERT INTO HotSearchEditorDt  (Slno,FormId,FieldName,AliasName,SrchFieldNm,Colwidth,
								SortedType,HotSearchName,TransId)
VALUES(3,10083,'BankName','Branch Code','BnkBrName',1500,0,'HotSch-272-2000-3',272)
GO
---- Bill Print
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'RptIDTToPrint') AND type in (N'U'))
DROP TABLE RptIDTToPrint
GO
CREATE TABLE RptIDTToPrint
(
	IDTRefNumber nvarchar(100)  NULL,
	StockType int NULL,
	UsrId int NULL
) 
GO
--To Insert BillTemplateHD
DELETE FROM BillTemplateHD WHere TempName = 'IDT Bill Template'
INSERT INTO BillTemplateHD (TempName,BillSeqId,BillSeqDt,MarketRet,Replacement,OtherCharges,CrDbAdj,TaxDt,
							LineNumber,UsrId,Scheme,PrintType,SampleIssue)
Values('IDT Bill Template',1,Convert(VarChar(10),GetDate(),121),0,0,0,0,0,15,2,0,9,0)
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_IDTBillPrint') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_IDTBillPrint
GO
CREATE Procedure Proc_IDTBillPrint
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Pi_BTTblName   	NVARCHAR(50)
)
AS
/****************************************************************************************
* PROCEDURE	: Proc_IDTBillPrint
* PURPOSE	: General Procedure
* NOTES		:
* CREATED	:  
* MODIFIED
* DATE			AUTHOR		  DESCRIPTION
------------------------------------------------------------------------------------------
****************************************************************************************/
SET NOCOUNT ON

DECLARE @FromDate		DateTime
DECLARE @ToDate			DateTime
DECLARE @LcnId			INT
DECLARE @FromDistId		INT
DECLARE @ToDistId		INT
DECLARE @IDTRefNo nVarchar(100)
DECLARE @StockTypeId		INT

SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
SET @ToDate = (SELECT   TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
set @StockTypeId = (Select Distinct StockType From RptIDTToPrint where UsrId = @Pi_UsrId)
BEGIN
						/* Stock In  - 1  Stock Out  - 2 */

	DELETE FROM IDTBillPrint Where UserId = @Pi_UsrId
	IF @StockTypeId = 1
	BEGIN
		INSERT INTO IDTBillPrint([IDT Reference No],[IDT Reference Date],LcnId,Location,StkMgmtTypeId,
								[StockManagement Type],
								DocRefNo,[LR No],[LR Date],Remarks,[IDTHeader GrossAmt],[IDHeader TaxAmt],
								[IDTHeader NetAmt],[IDT PaidAmt],[From Distributor Id],[From Distributor Code],
								[From Distributor Name],[From Distributor Address1],
								[From Distributor Address2],[From Distributor Address3],[From Distributor Phone],
								[From Distributor Contact],[From Distributor Email],[To Distributor Id],
								[To Distributor Code],[To Distributor Name],[To Distributor Address1],
								[To Distributor Address2],[To Distributor Address3],[To Distributor Phone],
								[To Distributor Contact],[To Distributor Email],PrdId,[Prroduct Distributor Code],
								Qty,[Product Company Code],[Product Name],[Product Short Name],
								PrdBatId,[Product Batch Code],MRP,ListPrice,[Line GrossAmount],[Line TaxAmount],
								[Line NetAmount],PrdSlNo,PriceId,
								[IDT Charges],[Tax Percent],[Tax Amount],[Taxable Amount],[Add TaxPercent],
								[Add TaxAmount],UserId)
		SELECT  DISTINCT
				A.IDTMngRefNo,IDTMngDate,A.LcnId,LcnName,
				StkMgmtTypeId,Case StkMgmtTypeId When 1 Then 'IDT IN' ELSE 'IDT OUT' END AS StockManagementType,
				Isnull(DocRefNo,'') DocRefNo,Isnull(LRNo,'') LRNo,LRDate,Isnull(Remarks,'') Remarks,
				IDTGrossAmt IDTHeaderGrossAmt,IDTTaxAmt  IDHeaderTaxAmt,
				IDTNetAmt	IDTHeaderNetAmt,  IDTPaidAmt IDTPaidAmt,
				A.FromSpmId FromDistId,C.SpmCode FromDistCode,
				C.SpmName FromDistName,C.SpmAdd1 FromDistAddress1,C.SpmAdd2 FromDistAddress2,
				C.SpmAdd3 FromDistAddress3,C.SpmPhone FromDistPhone,
				C.SpmContact FromDistContact,C.SpmEmail FromDistEmail, 
				DistributorId ToDistId,DistributorCode ToDistCode,DistributorName ToDistName,
				DistributorAdd1 ToDistAddress1,DistributorAdd2 ToDistAddress2,DistributorAdd3 ToDistAddress3,			
				PhoneNo ToDistPhine,ContactPerson ToDistContact,EmailId ToDistEmail,
				E.PrdId,PrdDCode PrdDistCode,Qty,PrdCcode PrdComCode,PrdName,PrdShrtName,
				E.PrdBatId,	PrdBatCode,PrdMRPRate MRP,PrdUnitRate ListPrice,
				PrdGrossAmount LineGrossAmount,PrdTaxAmount LineTaxAmount,
				PrdNetAmount LineNetAmount,E.PrdSlNo,PriceId,
				LineBaseQtyAmount IDTCharges,
				IDTTax.TaxPerc,IDTTax.TaxAmount,IDTTax.TaxableAmount,
				IDTTax.AddTaxPer,IDTTax.AddTaxAmt,
				@Pi_UsrId UserId
		FROM 
				IDTManagement A (Nolock)
					INNER JOIN Location B (Nolock) ON  A.LcnId = B.LcnId
					LEFT OUTER JOIN  IDTMaster C (Nolock) ON A.FromSpmId = C.SpmId
					LEFT OUTER JOIN  Distributor D (Nolock) ON A.ToSpmId = D.DistributorId
					INNER JOIN IDTManagementProduct E (Nolock) ON A.IDTMngRefNo = E.IDTMngRefNo
					INNER JOIN Product P (Nolock) ON E.PrdId = P.PrdId
					INNER JOIN ProductBatch PB (Nolock) ON E.PrdBatId = PB.PrdBatId 
												  and E.PrdId = PB.PrdId and P.PrdId = PB.PrdId
					INNER JOIN IDTManagementLineAmount F (Nolock) ON A.IDTMngRefNo = F.IDTMngRefNo and  E.PrdSlNo = F.PrdSlNo
															AND RefCode = 'E'
					INNER JOIN (SELECT	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.TaxPerc Taxperc,A.TaxAmount,A.TaxableAmount ,
											ISNULL(B.TaxPerc,0) AddTaxPer ,ISNULL(B.TaxAmount,0) AddTaxAmt
									FROM(
										(	Select	TT.IDTMngRefNo,TT.PrdId,TT.PrdBatId,TT.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax TT  (Nolock)
													INNER JOIN IDTManagementProduct T (Nolock) ON T.IDTMngRefNo=TT.IDTMngRefNo		
													and T.PrdId	= TT.PrdId  and T.PrdBatId = TT.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId = 1 
										 ) A 
									LEFT OUTER JOIN 
										(	Select	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax A (Nolock)
													INNER JOIN IDTManagementProduct B (Nolock) ON A.IDTMngRefNo=B.IDTMngRefNo		
													and B.PrdId	= A.PrdId  and A.PrdBatId = B.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId > 1					
										)B  
										ON A.IDTMngRefNo=B.IDTMngRefNo and A.PrdId=B.PrdId and A.PrdBatId = B.PrdbatId)
									)  as IDTTax ON A.IDTMngRefNo = IDTTax.IDTMngRefNo and IDTTax.PrdId = E.PrdId
									   AND IDTTax.PrdBatId = E.PrdBatId		
					INNER JOIN RptIDTToPrint R ON A.IDTMngRefNo = R.IDTRefNumber and UsrId = @Pi_UsrId
		WHERE 
				StkMgmtTypeId = 1   
		ORDER BY A.IDTMngRefNo

	END 
	ELSE
	BEGIN		
			INSERT INTO IDTBillPrint([IDT Reference No],[IDT Reference Date],LcnId,Location,StkMgmtTypeId,
								[StockManagement Type],
								DocRefNo,[LR No],[LR Date],Remarks,[IDTHeader GrossAmt],[IDHeader TaxAmt],
								[IDTHeader NetAmt],[IDT PaidAmt],[From Distributor Id],[From Distributor Code],
								[From Distributor Name],[From Distributor Address1],
								[From Distributor Address2],[From Distributor Address3],[From Distributor Phone],
								[From Distributor Contact],[From Distributor Email],[To Distributor Id],
								[To Distributor Code],[To Distributor Name],[To Distributor Address1],
								[To Distributor Address2],[To Distributor Address3],[To Distributor Phone],
								[To Distributor Contact],[To Distributor Email],PrdId,[Prroduct Distributor Code],
								Qty,[Product Company Code],[Product Name],[Product Short Name],
								PrdBatId,[Product Batch Code],MRP,ListPrice,[Line GrossAmount],[Line TaxAmount],
								[Line NetAmount],PrdSlNo,PriceId,
								[IDT Charges],[Tax Percent],[Tax Amount],[Taxable Amount],[Add TaxPercent],
								[Add TaxAmount],UserId)
			SELECT  DISTINCT
					A.IDTMngRefNo,IDTMngDate,A.LcnId,LcnName,
					StkMgmtTypeId,Case StkMgmtTypeId When 1 Then 'IDT IN' ELSE 'IDT OUT' END AS StockManagementType,
					Isnull(DocRefNo,'') DocRefNo,Isnull(LRNo,'') LRNo,LRDate,Isnull(Remarks,'') Remarks,
					IDTGrossAmt IDTHeaderGrossAmt,IDTTaxAmt  IDHeaderTaxAmt,
					IDTNetAmt	IDTHeaderNetAmt,  IDTPaidAmt IDTPaidAmt,
					DistributorId FromDistId,DistributorCode FromDistCode,DistributorName FromDistName,
					DistributorAdd1 FromDistAddress1,	DistributorAdd2 FromDistAddress2,DistributorAdd3 FromDistAddress3,
					PhoneNo FromDistPhone,ContactPerson FromDistContact,EmailId FromDistEmail,
					A.FromSpmId ToDistId,C.SpmCode ToDistCode,
					C.SpmName ToDistName,C.SpmAdd1 ToDistAddress1,C.SpmAdd2 ToDistAddress2,
					C.SpmAdd3 ToDistAddress3,	C.SpmPhone ToDistPhone,
					C.SpmContact ToDistContact,C.SpmEmail ToDistEmail,			 
					E.PrdId,PrdDCode PrdDistCode,Qty,PrdCcode PrdComCode,PrdName,PrdShrtName,
					E.PrdBatId,	PrdBatCode,PrdMRPRate MRP,PrdUnitRate ListPrice,
					PrdGrossAmount LineGrossAmount,PrdTaxAmount LineTaxAmount,
					PrdNetAmount LineNetAmount,E.PrdSlNo,PriceId,
					LineBaseQtyAmount IDTCharges,
					IDTTax.TaxPerc,IDTTax.TaxAmount,IDTTax.TaxableAmount,
					IDTTax.AddTaxPer,IDTTax.AddTaxAmt,
					@Pi_UsrId UserId
			FROM 
					IDTManagement A (Nolock)
						INNER JOIN Location B (Nolock) ON  A.LcnId = B.LcnId
						LEFT OUTER JOIN  IDTMaster C (Nolock) ON A.ToSpmId = C.SpmId
						LEFT OUTER JOIN  Distributor D (Nolock) ON A.FromSpmId = D.DistributorId
						INNER JOIN IDTManagementProduct E (Nolock) ON A.IDTMngRefNo = E.IDTMngRefNo
						INNER JOIN Product P (Nolock) ON E.PrdId = P.PrdId
						INNER JOIN ProductBatch PB (Nolock) ON E.PrdBatId = PB.PrdBatId 
													  and E.PrdId = PB.PrdId and P.PrdId = PB.PrdId
						INNER JOIN IDTManagementLineAmount F (Nolock) ON A.IDTMngRefNo = F.IDTMngRefNo and  E.PrdSlNo = F.PrdSlNo
																AND RefCode = 'E'
						INNER JOIN (SELECT	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.TaxPerc Taxperc,A.TaxAmount,A.TaxableAmount ,
											ISNULL(B.TaxPerc,0) AddTaxPer ,ISNULL(B.TaxAmount,0) AddTaxAmt
									FROM(
										(	Select	TT.IDTMngRefNo,TT.PrdId,TT.PrdBatId,TT.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax TT (Nolock)
													INNER JOIN IDTManagementProduct T (Nolock) ON T.IDTMngRefNo=TT.IDTMngRefNo		
													and T.PrdId	= TT.PrdId  and T.PrdBatId = TT.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId = 1 
										 ) A 
									LEFT OUTER JOIN 
										(	Select	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax A  (Nolock)
													INNER JOIN IDTManagementProduct B (Nolock) ON A.IDTMngRefNo=B.IDTMngRefNo		
													and B.PrdId	= A.PrdId  and A.PrdBatId = B.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId > 1					
										)B  
										ON A.IDTMngRefNo=B.IDTMngRefNo and A.PrdId=B.PrdId and A.PrdBatId = B.PrdbatId)
									)  as IDTTax ON A.IDTMngRefNo = IDTTax.IDTMngRefNo and IDTTax.PrdId = E.PrdId
									   AND IDTTax.PrdBatId = E.PrdBatId	
							INNER JOIN RptIDTToPrint R ON A.IDTMngRefNo = R.IDTRefNumber and UsrId = @Pi_UsrId			
			WHERE 
				StkMgmtTypeId = 2 
			ORDER BY A.IDTMngRefNo
	END 
END
GO
-- To Insert CustomCaptions
DELETE FROM CustomCaptions where TransId = 138  and CtrlId = 2000 and SubCtrlId = 10
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (138,2000,10,'HotSch-138-2000-10','Distributors','','',1,1,1,GetDate(),1,
GetDate(),'Distributors ','','',1,1)
GO
--- Location
DELETE FROM CustomCaptions where TransId = 138  and CtrlId = 2000 and SubCtrlId = 11
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (138,2000,11,'HotSch-138-2000-11','Location','','',1,1,1,GetDate(),1,
GetDate(),'Location ','','',1,1)
GO
--- IDT Reference Number
DELETE FROM CustomCaptions where TransId = 138  and CtrlId = 2000 and SubCtrlId = 12
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (138,2000,12,'HotSch-138-2000-12','IDT Reference Number','','',1,1,1,GetDate(),1,
GetDate(),'IDT Reference Number ','','',1,1)
GO
DELETE FROM CustomCaptions where TransId = 138  and  CtrlId = 1000 and SubCtrlId = 17 
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (138,1000,17,'MsgBox-138-1000-17','','','Error in Generate IDT Refereence Number',1,1,1,GetDate(),1,
GetDate(),'','','Error in Generate IDT Refereence Number ',1,1)
GO
DELETE FROM CustomCaptions where TransId = 138  and  CtrlId = 1000 and SubCtrlId = 18 
INSERT INTO CustomCaptions (TransId,CtrlId,SubCtrlId,CtrlName,Caption,PnlMsg,MsgBox,LngId,Availability,
			LastModBy,LastModDate,AuthId,AuthDate,DefaultCaption,DefaultPnlMsg,DefaultMsgBox,Visibility,Enabled) 
VALUES (138,1000,18,'MsgBox-138-1000-18','','','Final IDT Template SP Error',1,1,1,GetDate(),1,
GetDate(),'','','Final IDT Template SP Error',1,1)
GO

----IDT Report
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'IDTBillPrint') AND type in (N'U'))
DROP TABLE IDTBillPrint
GO
CREATE TABLE IDTBillPrint
(
	[IDT Reference No] [nvarchar](100)   NULL,
	[IDT Reference Date] [datetime] NULL,
	[LcnId] [int] NULL,
	[Location] [nvarchar](100)   NULL,
	[StkMgmtTypeId] [int] NULL,
	[StockManagement Type] [varchar](100)   NULL,
	[DocRefNo] [nvarchar](100)   NULL,
	[LR No] [nvarchar](100)   NULL,
	[LR Date] [datetime] NULL,
	[Remarks] [nvarchar](100)   NULL,
	[IDTHeader GrossAmt] [numeric](38, 2) NULL,
	[IDHeader TaxAmt] [numeric](38, 2) NULL,
	[IDTHeader NetAmt] [numeric](38, 2) NULL,
	[IDT PaidAmt] [numeric](38, 2) NULL,
	[From Distributor Id] [int] NULL,
	[From Distributor Code] [nvarchar](100)   NULL,
	[From Distributor Name] [nvarchar](100)   NULL,
	[From Distributor Address1] [nvarchar](100)   NULL,
	[From Distributor Address2] [nvarchar](100)   NULL,
	[From Distributor Address3] [nvarchar](100)   NULL,
	[From Distributor Phone] [nvarchar](100)   NULL,
	[From Distributor Contact] [nvarchar](100)   NULL,
	[From Distributor Email] [nvarchar](100)   NULL,
	[To Distributor Id] [int] NULL,
	[To Distributor Code] [varchar](100)   NULL,
	[To Distributor Name] [varchar](100)   NULL,
	[To Distributor Address1] [varchar](100)   NULL,
	[To Distributor Address2] [varchar](100)   NULL,
	[To Distributor Address3] [varchar](100)   NULL,
	[To Distributor Phone] [varchar](100)   NULL,
	[To Distributor Contact] [varchar](100)   NULL,
	[To Distributor Email] [varchar](100)   NULL,
	[PrdId] [int] NULL,
	[Prroduct Distributor Code] [nvarchar](100)   NULL,
	[Qty] [int] NULL,
	[Product Company Code] [nvarchar](100)   NULL,
	[Product Name] [nvarchar](100)   NULL,
	[Product Short Name] [nvarchar](100)   NULL,
	[PrdBatId] [int] NULL,
	[Product Batch Code] [nvarchar](100)   NULL,
	[MRP] [numeric](38, 2) NULL,
	[ListPrice] [numeric](38, 2) NULL,
	[Line GrossAmount] [numeric](38, 2) NULL,
	[Line TaxAmount] [numeric](38, 2) NULL,
	[Line NetAmount] [numeric](38, 2) NULL,
	[PrdSlNo] [int] NULL,
	[PriceId] [bigint] NULL,
	[IDT Charges] [numeric](38, 2) NULL,	
	[Tax Percent] [numeric](38, 2) NULL,
	[Tax Amount] [numeric](38, 2) NULL,
	[Taxable Amount] [numeric](38, 2) NULL,
	[Add TaxPercent] [numeric](38, 2) NULL,
	[Add TaxAmount] [numeric](38, 2) NULL,
	[AmountInWord]  [Varchar](3000) NULL,
	[UserId] [int] NULL
) 
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPostingIDTManagement') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPostingIDTManagement
GO
---- EXEC Proc_VoucherPostingIDTManagement 253,0,'IDT1000028',5,0,2,'2010-05-08',0
CREATE   Procedure Proc_VoucherPostingIDTManagement
	(
		@Pi_TransId		Int,
		@Pi_SubTransId	Int,
		@Pi_ReferNo		nVarChar(100),
		@Pi_VocType		INT,
		@Pi_SubVocType	INT,	
		@Pi_UserId		Int,
		@Pi_VocDate		DateTime,
		@Po_PurErrNo	Int OutPut
	)
AS
/*****************************************************************************************
* PROCEDURE	: Proc_VoucherPostingIDTManagement
* PURPOSE	: General SP for posting Purchase Voucher
* CREATED	: Panneerselvam.K
* CREATED DATE	: 21/04/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
----------------------------------------------------------------------------------------
* {date}		{developer}  {brief modification description}	
* 30.04.2010	Panneer      Round off account Function Added NEW
*****************************************************************************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @DCoaId		INT
DECLARE @CCoaId		INT
DECLARE @DiffAmt	Numeric(25,6)
DECLARE @sSql           VARCHAR(4000)
SET @Po_PurErrNo = 1
				/*  IDT Stock IN */
IF @Pi_TransId = 270 AND @Pi_SubTransId = 0
BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
					WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
							CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
				/* --- For Posting Purchase Header Voucher  ---  */
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
								 LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry)
		VALUES	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Stock In ' + @Pi_ReferNo +
					' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
					Convert(varchar(10),Getdate(),121),@Pi_UserId,
					Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'

			/* --- For Posting Purchase Account in Details Table on Debit (IDT IN - Gross Amount) ---  */

		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4110001')
		BEGIN
			SET @Po_PurErrNo = -2
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4110001'
		SELECT @Amt = IDTGrossAmt FROM IDTManagement WHERE IDTMngRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		VALUES	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				 @Pi_UserId,Convert(varchar(10),Getdate(),121))

			/* ----  For Posting Purchase Tax Account in Details Table on Debit  --- */

		SELECT  @VocRefNo AS VocRefNo,C.InputTaxId,1 AS DebitCredit,
				ISNULL(SUM(B.TaxAmount),0) AS Amount,1 AS Availability,
				@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,
				@Pi_UserId AS AuthId, Convert(varchar(10),Getdate(),121) AS AuthDate  INTO #PurTaxForDiff
		FROM   IDTManagement A
			   INNER JOIN IDTManagementProductTax B ON 	A.IDTMngRefNo = B.IDTMngRefNo
			   INNER JOIN TaxConfiguration C ON		B.TaxId = C.TaxId
		WHERE A.IDTMngRefNo = B.IDTMngRefNo and A.IDTMngRefNo = @Pi_ReferNo
		Group By C.InputTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0

		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT * FROM #PurTaxForDiff
		
			/*  ----  For Posting IDT Charges in Details Table to Debit  --- */
	
	If Exists(Select * From IDTSequenceDetail  WHere SlNo > 4 and CoaId > 0 )
	BEGIN

		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT  @VocRefNo,D.CoaId,1,Sum(B.LineBaseQtyAmount),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM	IDTManagement A
				INNER JOIN IDTManagementLineAmount B ON A.IDTMngRefNo = B.IDTMngRefNo
				INNER JOIN IDTSequenceMaster C ON 	A.IDTSeqId = C.IDTSeqId
				INNER JOIN IDTSequenceDetail D ON	C.IDTSeqId = D.IDTSeqId AND B.RefCode = D.RefCode
		WHERE	A.IDTMngRefNo = @Pi_ReferNo AND  D.RefCode <> 'D'
				AND  EffectInNetAmount = 1 AND B.LineBaseQtyAmount > 0
		Group By D.CoaId


		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT  @VocRefNo,D.CoaId,2,Sum(B.LineBaseQtyAmount),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM	IDTManagement A
				INNER JOIN IDTManagementLineAmount B ON A.IDTMngRefNo = B.IDTMngRefNo
				INNER JOIN IDTSequenceMaster C ON 	A.IDTSeqId = C.IDTSeqId
				INNER JOIN IDTSequenceDetail D ON	C.IDTSeqId = D.IDTSeqId AND B.RefCode = D.RefCode
		WHERE A.IDTMngRefNo = @Pi_ReferNo AND  D.RefCode <> 'D' and
					  EffectInNetAmount = 2 AND B.LineBaseQtyAmount > 0
		Group By D.CoaId
		
	END

			/* --- For Posting Didtributor Account in Details Table to Credit  --- */

		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN IDTMaster B ON
							  A.CoaId = B.CoaId INNER JOIN IDTManagement C ON B.SpmId = C.SpmId
						WHERE C.IDTMngRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN IDTMaster B ON
						A.CoaId = B.CoaId INNER JOIN IDTManagement C ON B.SpmId = C.SpmId
		WHERE C.IDTMngRefNo = @Pi_ReferNo

		SELECT @Amt = IDTNetAmt FROM IDTManagement WHERE IDTMngRefNo = @Pi_ReferNo
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		VALUES		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/* --- Validate Credit amount is Equal to Debit
			   For Posting Round Off Account Add in Details Table to Debit  ---  */

	SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
	IF @sSql='-4'
	BEGIN
		SET @Po_PurErrNo = -4
		Return
	END
	ELSE IF @sSql='-5'
	BEGIN
		SET @Po_PurErrNo = -5
		Return
	END
	ELSE IF @sSql<>'0'
	BEGIN
		EXEC(@sSql)
	END

		/* ---  Validate Credit amount is Equal to Debit ---  */

	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
	/*  IDT Stock Out */
IF @Pi_TransId = 270 AND @Pi_SubTransId = 1	--  Purchase Return (IDT Stock Out)
BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PurchaseVoc',
													  CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END

				/* --- For Posting Purchase Return Header Voucher --- */

		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
								 LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry)
		VALUES	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Stock Out ' + @Pi_ReferNo +
				' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PurchaseVoc'

				/* --- For Posting Purchase Return Account in Details Table on Credit --- */
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4110002')
		BEGIN
			SET @Po_PurErrNo = -22
			Return
		END	
				/* --- For Posting Distributor Account in Details Table to Debit ---  */
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN IDTMaster B ON
							  A.CoaId = B.CoaId INNER JOIN IDTManagement C ON B.SpmId = C.SpmId
					 WHERE C.IDTMngRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN IDTMaster B ON
				A.CoaId = B.CoaId INNER JOIN IDTManagement C ON B.SpmId = C.SpmId
			WHERE C.IDTMngRefNo = @Pi_ReferNo
		SELECT @Amt = (IDTNetAmt) FROM IDTManagement WHERE IDTMngRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		VALUES	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))

				/* --- For Posting Purchase Return Tax Account in Details Table on Credit --- */

		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4110002'
		SELECT @Amt = (IDTGrossAmt) FROM IDTManagement WHERE IDTMngRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		VALUES (@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
							@Pi_UserId,Convert(varchar(10),Getdate(),121))

				/* --- For Posting Purchase Return Tax Account in Details Table on Credit --- */

		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT
				@VocRefNo,C.InPutTaxId,2,ISNULL(SUM(B.TaxAmount),0),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM	IDTManagement A
				INNER JOIN IDTManagementProductTax B ON	A.IDTMngRefNo = B.IDTMngRefNo
				INNER JOIN TaxConfiguration C ON		B.TaxId = C.TaxId
		WHERE  A.IDTMngRefNo = B.IDTMngRefNo and A.IDTMngRefNo = @Pi_ReferNo
		Group By C.InPutTaxId
		HAVING ISNULL(SUM(B.TaxAmount),0) > 0	

			  /* --- For Posting IDT Charges in Details Table to Credit	 ---  */

	If Exists(Select * From IDTSequenceDetail  WHere SLNo > 4 and CoaId > 0)
	BEGIN
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT  @VocRefNo,D.CoaId,2,Sum(B.LineBaseQtyAmount),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM	IDTManagement A
				INNER JOIN IDTManagementLineAmount B ON A.IDTMngRefNo = B.IDTMngRefNo
				INNER JOIN IDTSequenceMaster C ON 	A.IDTSeqId = C.IDTSeqId
				INNER JOIN IDTSequenceDetail D ON	C.IDTSeqId = D.IDTSeqId AND B.RefCode = D.RefCode
		WHERE A.IDTMngRefNo = @Pi_ReferNo AND  B.RefCode <> 'D'
					 AND EffectInNetAmount = 1 AND B.LineBaseQtyAmount > 0
		Group By D.CoaId

		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								  LastModDate,AuthId,AuthDate)
		SELECT  @VocRefNo,D.CoaId,1,Sum(B.LineBaseQtyAmount),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM	IDTManagement A
				INNER JOIN IDTManagementLineAmount B ON A.IDTMngRefNo = B.IDTMngRefNo
				INNER JOIN IDTSequenceMaster C ON 	A.IDTSeqId = C.IDTSeqId
				INNER JOIN IDTSequenceDetail D ON	C.IDTSeqId = D.IDTSeqId AND B.RefCode = D.RefCode
		WHERE A.IDTMngRefNo = @Pi_ReferNo AND  B.RefCode <> 'D'
					 AND EffectInNetAmount = 2 AND B.LineBaseQtyAmount > 0
		Group By D.CoaId		
	END  		
		/* --- Validate Credit amount is Equal to Debit
			   For Posting Round Off Account Add in Details Table to Debit  --- */
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
			/* --- Validate Credit amount is Equal to Debit --- */
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
END 		
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
RETURN
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPostingBankPay') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPostingBankPay
GO
--EXEC Proc_VoucherPostingBankPay 250,1,'25',3,2,1,'2009-03-26',0
CREATE PROCEDURE Proc_VoucherPostingBankPay
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Pi_ChqNo		NVARCHAR(500)='0',
	@Po_PurErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingBankPay
* PURPOSE	: General SP for posting Bank Payment
* CREATED	: Boopathy
* CREATED DATE	: 26/12/2007
* MODIFIED
* DATE				AUTHOR				DESCRIPTION
* 30/07/2009		MarySubashini.S		HQ-Payment Posting
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	NVARCHAR(100)
DECLARE @sStr		NVARCHAR(4000)
DECLARE @Amt		NUMERIC(25,6)
DECLARE @sSql		VARCHAR(4000)
DECLARE @SuppCoaId 	INT
DECLARE @RtrCoaId 	INT
DECLARE @PayInsAmt 	NUMERIC(38,2)
DECLARE @PayMode	INT	
DECLARE @BnkId	 	INT
DECLARE @BnkBrId	INT
DECLARE @PayAdvNo 	NVARCHAR(50)
DECLARE @ChqDisRefNo NVARCHAR(50)
DECLARE @Amount 	NUMERIC(38,2)
DECLARE @ChqNo		NVARCHAR(250)
DECLARE @ChqDate	DATETIME
DECLARE @DistCode	NVARCHAR(250)
DECLARE @MDistCode 	NVARCHAR(250)
DECLARE @SalInvNo nVarchar(50)
SET @Po_PurErrNo = 1
SELECT @MDistCode=DistributorCode FROM Distributor 
IF @Pi_TransId = 10 AND @Pi_SubTransId = 2	--Cheque Bounce Bank Charges
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Purchase Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From ChequePayment ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From ChequePayment ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210003')
	BEGIN
		SET @Po_PurErrNo = -18
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210003'
	SELECT @Amt = Penality FROM ChequePayment WHERE ChequePayId = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	
	--For Posting Bank Account in Details Table to Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT DISTINCT @VocRefNo,B.CoaId,2,A.Penality,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice E,ReceiptInvoice D
		INNER JOIN BankBranch B ON
			D.DisBnkBrId = B.BnkBrId
		INNER JOIN Bank C ON
			D.DisBnkId = C.BnkId
		INNER JOIN ChequePayment A ON
			D.InvInsNo=CAST(A.ChequeNo AS NVARCHAR(200))
		WHERE A.ChequePayId = @Pi_ReferNo AND
			A.Penality > 0 AND C.BnkId=B.BnkId AND
			E.SalId=D.SalId AND E.RtrId=A.RtrId AND A.Status=4
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT DISTINCT ''' + @VocRefNo + ''',B.CoaId,2,A.Penality,1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM SalesInvoice E,ReceiptInvoice D
		INNER JOIN BankBranch B ON
			D.DisBnkBrId = B.BnkBrId
		INNER JOIN Bank C ON
			D.DisBnkId = C.BnkId
		INNER JOIN ChequePayment A ON
			D.InvInsNo=A.ChequeNod
		WHERE A.ChequePayId = ''' + @Pi_ReferNo + ''' AND
			Penality > 0 AND C.BnkId=B.BnkId AND
			E.SalId=D.SalId AND E.RtrId=A.RtrId AND A.Status=4'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(ISNULL(Amount,0)) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(ISNULL(Amount,0))
			ELSE -1 * Sum(ISNULL(Amount,0)) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(ISNULL(Amount,0)) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
--IF @Pi_TransId = 10 AND @Pi_SubTransId = 4	--Cheque Bounce Bank Charges (Debit Invoice)
--BEGIN
--	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
--	BEGIN
--		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
--			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
--	END
--	ELSE
--	BEGIN
--		SET @Po_PurErrNo = 0
--		Return
--	END
--	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
--		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
--	IF LTRIM(RTRIM(@VocRefNo)) = ''
--	BEGIN
--		SET @Po_PurErrNo = -1
--		Return
--	END
--	--For Posting Purchase Header Voucher
--	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
--		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
--	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From ChequePayment ' + @Pi_ReferNo +
--		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
--		Convert(varchar(10),Getdate(),121),@Pi_UserId,
--		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
--	--INSERT INTO Translog(strSql1) Values (@sstr)
--	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
--	--INSERT INTO Translog(strSql1) Values (@sstr)
--	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210003')
--	BEGIN
--		SET @Po_PurErrNo = -18
--		Return
--	END
--	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210003'
--	SELECT @Amt = Penality FROM ChequePayment WHERE ChequePayId = @Pi_ReferNo
--	
--	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
--		LastModDate,AuthId,AuthDate) VALUES
--	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
--		@Pi_UserId,Convert(varchar(10),Getdate(),121))
--	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
--		LastModDate,AuthId,AuthDate) VALUES
--	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
--		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
--		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
--		Convert(nvarchar(10),Getdate(),121) + ''')'
--	--INSERT INTO Translog(strSql1) Values (@sstr)
--	
--	--For Posting Bank Account in Details Table to Credit
--	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
--		LastModDate,AuthId,AuthDate)
--	SELECT DISTINCT @VocRefNo,B.CoaId,2,A.Penality,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
--		@Pi_UserId,Convert(varchar(10),Getdate(),121)
--		FROM DebitNoteRetailer E,DebitInvoice D
--		INNER JOIN BankBranch B ON
--			D.DisBnkBrId = B.BnkBrId
--		INNER JOIN Bank C ON
--			D.DisBnkId = C.BnkId
--		INNER JOIN ChequePayment A ON
--			D.InvInsNo=CAST(A.ChequeNo AS NVARCHAR(200))
--		WHERE A.ChequePayId = @Pi_ReferNo AND
--			A.Penality > 0 AND C.BnkId=B.BnkId AND
--			E.DbNoteNumber=D.DbNoteNumber AND E.RtrId=A.RtrId AND A.Status=4
--	--INSERT INTO Translog(strSql1) Values (@sstr)
--	--For Posting Round Off Account Add in Details Table to Debit
--		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
--		IF @sSql='-4'
--		BEGIN
--			SET @Po_PurErrNo = -4
--			Return
--		END
--		ELSE IF @sSql='-5'
--		BEGIN
--			SET @Po_PurErrNo = -5
--			Return
--		END
--		ELSE IF @sSql<>'0'
--		BEGIN
--			EXEC(@sSql)
--		END
--	--Validate Credit amount is Equal to Debit
--	IF NOT EXISTS (SELECT SUM(ISNULL(Amount,0)) FROM(
--		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(ISNULL(Amount,0))
--			ELSE -1 * Sum(ISNULL(Amount,0)) END as Amount FROM StdVocDetails
--			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
--		Having SUM(ISNULL(Amount,0)) = 0)
--	BEGIN
--		SET @Po_PurErrNo = -6
--		Return
--	END
--END
IF @Pi_TransId = 22 AND @Pi_SubTransId = 2	--Purchase Bank Payment(Cheque)
BEGIN
	SELECT @PayAdvNo=PayAdvNo,@PayInsAmt=PayInsAmt,@PayMode=PayMode,@BnkId=BnkId,
		@BnkBrId=BnkBrId,@ChqNo=PayInsNo,@ChqDate=PayInsDate  FROM
		PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo  AND PayInsNo=@Pi_ChqNo AND PayMode IN (2)
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
			
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For Cheque No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Payment Register ' + @Pi_ReferNo + ' For Cheque No: ' + @ChqNo +
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121) +
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT Exists (Select DISTINCT A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And PayAdvNo=@PayAdvNo )
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END
	IF NOT Exists (	Select A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
			Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
			And PayAdvNo=@Pi_ReferNo AND C.PayMode=2 AND C.PayInsNo=@Pi_ChqNo
		       )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	Select DISTINCT @SuppCoaId=A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		And PayAdvNo=@PayAdvNo
	Select @CoaId=A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
		And PayAdvNo=@Pi_ReferNo AND C.PayMode=2 AND C.PayInsNo=@Pi_ChqNo
			
	--For Posting Supplier Account details on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@SuppCoaId as nVarChar(10)) + ',1,' + CAST(@PayInsAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount Account details On Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@PayInsAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 22 AND @Pi_SubTransId = 3	--Purchase Bank Payment(DD)
BEGIN
	SELECT @PayAdvNo=PayAdvNo,@PayInsAmt=PayInsAmt,@PayMode=PayMode,@BnkId=BnkId,
		@BnkBrId=BnkBrId,@ChqNo=PayInsNo,@ChqDate=PayInsDate  FROM
		PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo  AND PayInsNo=@Pi_ChqNo And PayMode IN (3)
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
			
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For DD No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Payment Register ' + @Pi_ReferNo + ' For DD No: ' + @ChqNo +
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121) +
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT Exists (Select DISTINCT A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And PayAdvNo=@PayAdvNo)
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END
	IF NOT Exists (	Select A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
			Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
			And PayAdvNo=@Pi_ReferNo AND C.PayInsNo=@Pi_ChqNo AND C.PayMode=3
		       )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	Select DISTINCT @SuppCoaId=A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		And PayAdvNo=@PayAdvNo
	Select @CoaId=A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
		And PayAdvNo=@Pi_ReferNo AND C.PayMode=3 AND C.PayInsNo=@Pi_ChqNo
			
	--For Posting Supplier Account details on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@SuppCoaId as nVarChar(10)) + ',1,' + CAST(@PayInsAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount Account details On Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@PayInsAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 22 AND @Pi_SubTransId = 5	--Purchase Bank Payment(RTGS)
BEGIN
	SELECT @PayAdvNo=PayAdvNo,@PayInsAmt=PayInsAmt,@PayMode=PayMode,@BnkId=BnkId,
		@BnkBrId=BnkBrId,@ChqNo=PayInsNo,@ChqDate=PayInsDate  FROM
		PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo  AND PayInsNo=@Pi_ChqNo And PayMode IN (5)
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
			
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For RTGS No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Payment Register ' + @Pi_ReferNo + ' For DD No: ' + @ChqNo +
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121) +
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT Exists (Select DISTINCT A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And PayAdvNo=@PayAdvNo)
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END
	IF NOT Exists (	Select A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
			Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
			And PayAdvNo=@Pi_ReferNo AND C.PayInsNo=@Pi_ChqNo AND C.PayMode=5
		       )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	Select DISTINCT @SuppCoaId=A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		And PayAdvNo=@PayAdvNo
	Select @CoaId=A.CoaId From BankBranch A,CoaMaster B,PurchasePaymentDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
		And PayAdvNo=@Pi_ReferNo AND C.PayMode=5 AND C.PayInsNo=@Pi_ChqNo
			
	--For Posting Supplier Account details on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@SuppCoaId as nVarChar(10)) + ',1,' + CAST(@PayInsAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount Account details On Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@PayInsAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 34
BEGIN
	IF @Pi_SubTransId=2
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Retailer OnAccount Bank Payment ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Retailer OnAccount Bank Payment ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
				'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
		
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Bank Account in Details Table on Debit			
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -20
			Return
		END
		
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON
		A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
		WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END	
END
IF @Pi_TransId = 34         --Supplier On Account
BEGIN
	IF @Pi_SubTransId=6
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Supplier OnAccount Bank Payment ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Supplier OnAccount Bank Payment ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
				'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
		
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Bank Account in Details Table on Debit			
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -20
			Return
		END
		
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON
		A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
		WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END	
END
IF @Pi_TransId = 36 AND @Pi_SubTransId = 2
BEGIN
	
	SELECT @ChqDisRefNo=ChqDisRefNo,@Amount=Amount,@BnkId=BnkId,@BnkBrId=BnkBrId,
		@ChqNo=ChequeNo,@ChqDate=ChequeDate  FROM ChequeDisbursalDetails WHERE ChqDisRefNo=@Pi_ReferNo
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
			
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Cheque Disbursal ' + @Pi_ReferNo +
		' For Cheque No : ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Cheque Disbursal ' + @Pi_ReferNo + ' For Cheque No : ' + @ChqNo +
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121) +
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT Exists (Select DISTINCT A.CoaId From Retailer A,CoaMaster B ,ChequeDisbursalDetails C
		Where A.availability=1 and A.RtrId=C.RtrId and A.CoaId=B.CoaId
		And ChqDisRefNo=@ChqDisRefNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (	Select A.CoaId From BankBranch A,CoaMaster B,ChequeDisbursalDetails C
			Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
			And ChqDisRefNo=@Pi_ReferNo)	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	Select DISTINCT @RtrCoaId=A.CoaId From Retailer A,CoaMaster B ,ChequeDisbursalDetails C
		Where A.availability=1 and A.RtrId=C.RtrId and A.CoaId=B.CoaId
		And ChqDisRefNo=@ChqDisRefNo
	Select @CoaId=A.CoaId From BankBranch A,CoaMaster B,ChequeDisbursalDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId And ChqDisRefNo=@Pi_ReferNo
		
	--For Posting Supplier Account details on Credit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@Amount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@Amount As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount Account details On Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amount As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 36 AND @Pi_SubTransId = 3	--Cheque Disbursal for Credit Note Adjustment
BEGIN
	SELECT @ChqDisRefNo=ChqDisRefNo,@Amount=Amount,@BnkId=BnkId,@BnkBrId=BnkBrId,
		@ChqNo=ChequeNo,@ChqDate=ChequeDate  FROM ChequeDisbursalDetails WHERE ChqDisRefNo=@Pi_ReferNo
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Cheque Disbursal Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Credit Note Cheque Disbursal ' + @Pi_ReferNo +
		' For Cheque No : ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Credit Note Cheque Disbursal ' + @Pi_ReferNo +
		' For Cheque No : ' + @ChqNo + ' Dated ' +
		CONVERT(nVarChar(10),@ChqDate,121) + ''',1,' + CAST(@Pi_UserId as nVarChar(10)) +
		',''' + Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' +
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table on Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A with (nolock) INNER JOIN Retailer B with (nolock) ON
		A.CoaId = B.CoaId  INNER JOIN CreditnoteRetailer C with (nolock) ON B.RtrId = C.RtrId
		INNER JOIN ChequeDisbursalDetails D with (nolock) ON C.CrNoteNumber = D.CrNoteNumber
		AND C.RtrId = D.RtrId WHERE D.ChqDisRefNo = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
-- 	SELECT @RtrCoaId = A.CoaId FROM CoaMaster A with (nolock) INNER JOIN Retailer B with (nolock) ON
-- 		A.CoaId = B.CoaId  INNER JOIN CreditnoteRetailer C with (nolock) ON B.RtrId = C.RtrId
-- 		INNER JOIN ChequeDisbursalDetails D with (nolock) ON C.CrNoteNumber = D.CrNoteNumber
-- 		INNER JOIN ChequeDisbursalMaster E with (nolock) ON E.ChqDisRefNo = D.ChqDisRefNo AND
-- 		B.RtrId = E.TransId AND C.RtrId = E.TransId
-- 		WHERE E.ChqDisRefNo = @Pi_ReferNo
	SELECT @RtrCoaId = A.CoaId FROM CoaMaster A with (nolock) INNER JOIN Retailer B with (nolock) ON
		A.CoaId = B.CoaId  INNER JOIN CreditnoteRetailer C with (nolock) ON B.RtrId = C.RtrId
		INNER JOIN ChequeDisbursalDetails D with (nolock) ON C.CrNoteNumber = D.CrNoteNumber
		AND C.RtrId = D.RtrId
		WHERE D.ChqDisRefNo = @Pi_ReferNo
	SELECT @Amt = Amount FROM CreditnoteRetailer WHERE CrNoteNumber = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@RtrCoaId,2,@Amount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@Amount As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount Details On Debit
	IF NOT Exists (	Select A.CoaId From BankBranch A,CoaMaster B,ChequeDisbursalDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId
		And ChqDisRefNo=@Pi_ReferNo )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	
	Select @CoaId=A.CoaId From BankBranch A,CoaMaster B,ChequeDisbursalDetails C
		Where A.Bnkid=C.BnkId and A.BnkBrId=C.BnkBrId and A.CoaId=B.CoaId And ChqDisRefNo=@Pi_ReferNo
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amount,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amount As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE CreditNoteRetailer SET CoaId = @CoaId WHERE CrNoteNumber = @Pi_ReferNo
	SET @sStr = 'UPDATE CreditNoteRetailer SET CoaId = ' + CAST(@CoaId as nVarChar(10))+
		' WHERE CrNoteNumber = ''' + @Pi_ReferNo + ''''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 250 AND @Pi_SubTransId = 1	--HQ Purchase Bank Payment(Cheque/DD/RTGS)
BEGIN
	SELECT @PayAdvNo=PayRcpNo,@PayInsAmt=PayAmount,@PayMode=PayMode,@BnkId=BnkId,
		@BnkBrId=BnkBrId,@ChqNo=InvInsNo,@ChqDate=InvInsDate,@DistCode=BranchCode  FROM
		HQPaymentDetails WHERE PayRcpSNo=@Pi_ReferNo  AND InvInsNo=@Pi_ChqNo 
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		RETURN
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		RETURN
	END
			
	--For Posting Receipt Header Voucher
	IF @PayMode=3 
	BEGIN
		INSERT INTO HQStdVocMaster(DistCode,VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
			(@MDistCode,@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @PayAdvNo +
			' For Cheque No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @PayMode=4  
	BEGIN
		INSERT INTO HQStdVocMaster(DistCode,VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
			(@MDistCode,@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @PayAdvNo +
			' For DD No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @PayMode=8  
	BEGIN
		INSERT INTO HQStdVocMaster(DistCode,VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
			(@MDistCode,@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @PayAdvNo +
			' For RTGS No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	IF NOT EXISTS (SELECT DISTINCT A.CoaId FROM BranchMaster A,HQCoaMaster B ,HQPaymentDetails C
		WHERE A.Availability=1 AND A.BranchCode=C.BranchCode AND A.CoaId=B.CoaId
			AND C.PayRcpSNo=@Pi_ReferNo )
	BEGIN
		SET @Po_PurErrNo = -3
		RETURN
	END
	IF NOT EXISTS (	SELECT A.CoaId FROM BankBranch A,HQCoaMaster B,HQPaymentDetails C
			WHERE A.BnkId=C.BnkId AND A.BnkBrId=C.BnkBrId AND A.CoaId=B.CoaId
			AND PayRcpNo=@PayAdvNo AND C.PayMode=@PayMode AND C.InvInsNo=@Pi_ChqNo
		       )	
	BEGIN
		SET @Po_PurErrNo = -20
		RETURN
	END	
	SELECT DISTINCT @SuppCoaId=A.CoaId FROM BranchMaster A,HQCoaMaster B ,HQPaymentDetails C
		WHERE  A.BranchCode=C.BranchCode AND A.CoaId=B.CoaId AND C.PayRcpSNo=@Pi_ReferNo
	SELECT @CoaId=A.CoaId FROM BankBranch A,HQCoaMaster B,HQPaymentDetails C
		WHERE A.Bnkid=C.BnkId AND A.BnkBrId=C.BnkBrId AND A.CoaId=B.CoaId
		And PayRcpNo=@PayAdvNo AND C.PayMode=@PayMode AND C.InvInsNo=@Pi_ChqNo
			
	--For Posting Supplier Account details on Debit
	INSERT INTO HQStdVocDetails(DistCode,VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@MDistCode,@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	--For BankAccount Account details On Credit
	INSERT INTO HQStdVocDetails(DistCode,VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@MDistCode,@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM HQStdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 2	--Purchase Bank Payment(Cheque/dd)
BEGIN
			/* --- CHEQUE --- */
	DECLARE VoucherReceiptBankCheq_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(2) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankCheq_cursor

	FETCH NEXT FROM VoucherReceiptBankCheq_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 

	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For Cheque No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
 	IF NOT Exists (Select DISTINCT A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And IDTMngRefNo=@SalInvNo )
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END

	IF NOT Exists (Select distinct B.coaid from BankBranch B  Where DistBank = 1 )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	

	Select DISTINCT @SuppCoaId=A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
	Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		  And IDTMngRefNo=@SalInvNo 
	Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
			
			/*	--- For Posting Supplier Account details on Debit --- */

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/*  --- For BankAccount Account details On Credit  --- */

	INSERT INTO StdVocDetails(	VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								LastModDate,AuthId,AuthDate) 
	VALUES (@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/* --- For Posting Round Off Account Add in Details Table to Debit  --- */

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		
			/* ---  Validate Credit amount is Equal to Debit  --- */
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END

	FETCH NEXT FROM VoucherReceiptBankCheq_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankCheq_cursor
	DEALLOCATE VoucherReceiptBankCheq_cursor

				/* --- DD ---*/

	DECLARE VoucherReceiptBankDD_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(3) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankDD_cursor

	FETCH NEXT FROM VoucherReceiptBankDD_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 

	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For DD No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
 	IF NOT Exists (Select DISTINCT A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And IDTMngRefNo=@SalInvNo )
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END

	IF NOT Exists (Select distinct B.coaid from BankBranch B  Where DistBank = 1 )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	

	Select DISTINCT @SuppCoaId=A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
	Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		  And IDTMngRefNo=@SalInvNo 
	Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
			
			/*	--- For Posting Supplier Account details on Debit --- */

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/*  --- For BankAccount Account details On Credit  --- */

	INSERT INTO StdVocDetails(	VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								LastModDate,AuthId,AuthDate) 
	VALUES (@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/* --- For Posting Round Off Account Add in Details Table to Debit  --- */

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		
			/* ---  Validate Credit amount is Equal to Debit  --- */
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END

	FETCH NEXT FROM VoucherReceiptBankDD_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankDD_cursor
	DEALLOCATE VoucherReceiptBankDD_cursor

			/* --- RTGS  --- */

	DECLARE VoucherReceiptBankRTGS_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(4) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankRTGS_cursor

	FETCH NEXT FROM VoucherReceiptBankRTGS_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 

	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' For RTGS No: ' + @ChqNo + ' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
 	IF NOT Exists (Select DISTINCT A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
			And IDTMngRefNo=@SalInvNo )
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END

	IF NOT Exists (Select distinct B.coaid from BankBranch B  Where DistBank = 1 )	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	

	Select DISTINCT @SuppCoaId=A.CoaId From IDTMaster A,CoaMaster B ,IDTManagement C
	Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId
		  And IDTMngRefNo=@SalInvNo 
	Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
			
			/*	--- For Posting Supplier Account details on Debit --- */

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/*  --- For BankAccount Account details On Credit  --- */

	INSERT INTO StdVocDetails(	VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
								LastModDate,AuthId,AuthDate) 
	VALUES (@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))

		/* --- For Posting Round Off Account Add in Details Table to Debit  --- */

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		
			/* ---  Validate Credit amount is Equal to Debit  --- */
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END

	FETCH NEXT FROM VoucherReceiptBankRTGS_cursor INTO  @PayAdvNo,@SalInvNo,@PayInsAmt,@BnkId,@BnkBrId,@ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankRTGS_cursor
	DEALLOCATE VoucherReceiptBankRTGS_cursor

END

IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPosting') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPosting
GO
--EXEC Proc_VoucherPosting 250,1,'HQP0900023',1,1,1,'2009-07-31',0
CREATE PROCEDURE Proc_VoucherPosting
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_ErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPosting
* PURPOSE	: General SP for posting Voucher
* CREATED	: Thrinath
* CREATED DATE	: 25/08/2007
* MODIFIED
* DATE				AUTHOR				DESCRIPTION
* 29/07/2009		MarySubashini.S		Cheque Disbursal Cash Payment
* 30/07/2009		MarySubashini.S		HQ-Payment Posting
------------------------------------------------
* {date} {developer}  {brief modification description}
iTrans_OrderBooking = 1
iTrans_Billing = 2
iTrans_SalesReturn = 3
iTrans_LocationTransfer = 4
iTrans_Purchase = 5
iTrans_VanLoadUnload = 6
iTrans_PurchaseReturn = 7
iTrans_DebitMemo = 8
iTrans_Collection = 9
iTrans_CheuqeBounce = 10
iTrans_ChequePayment = 11
iTrans_CashBounce = 12
iTrans_StockManagement = 13
iTrans_BatchTransfer = 14
iTrans_PaymentReversal = 15
iTrans_ClaimSettlement = 16
iTrans_IRA = 17
iTrans_CreditNoteRetailer = 18
iTrans_DebitNoteRetailer = 19
iTrans_Replacement = 20
iTrans_Salvage = 21
iTrans_PaymentRegister = 22
iTrans_MarketReturn = 23
iTrans_ReturnandReplacement = 24
iTrans_SalesPanel = 25
iTrans_PurchaseOrder = 26
iTrans_SchemeMonitor = 27
iTrans_VehicleAllocation = 28
iTrans_DeliveryProcess = 29
iTrans_CreditNoteReplace = 30
iTrans_ResellDamage = 31
iTrans_CreditNoteSupplier = 32
iTrans_DebitNoteSupplier = 33
iTrans_RetailerOnAccount = 34
iTrans_CreditDebitAdjust = 35
iTrans_ChequeDisbursal = 36
iTrans_ReturnToCompany = 37
iTrans_StockJournal = 38
iTrans_StdVoucher = 39
iTrans_RouteCovPlan = 40
iTrans_RetailerShipAdd = 41
iTrans_ContPriceMaster = 42
iTrans_CollDiscMaster = 43
iTrans_ChqInvRetiler = 44
iTrans_SchemeMaster = 45
iTrans_TargetAnalysis = 46
iTrans_UOM = 47
iTrans_KitPrdMaster = 48
iTrans_PrdSalBundle = 49
iTrans_PurOrdNormMap = 50
iTrans_TargetNormMap = 51
iTrans_InventoryConsole = 52
iTrans_ChequeInventorySupp = 53
iTrans_PointRedemptionRule = 54
iTrans_PointRedemptionScreen = 55
iTrans_RspPunchingWindow = 56
iTrans_SubStockistEntry = 57
iTrans_LaunchProduct = 58
iTrans_CouponDefinition = 59
iTrans_CouponDenomination = 60
iTrans_CouponCollection = 61
iTrans_CouponRedemption = 62
iTrans_CouponMonitor = 63
iTrans_Attendance = 64
iTrans_FocusBrand = 65
iTrans_SalesmanIncCalc = 66
iTrans_ManualClaim = 104
iTrans_SplDiscountClaim = 143
iTrans_SalesmanSalaryAndDAClaim = 96
iTrans_DeliveryBoyClaim = 217
iTrans_TransporterClaim = 136
iTrans_RateDifferenceClaim = 97
iTrans_PurchaseShortageClaim = 99
iTrans_PurchaseExcessClaim = 105
iTrans_SpentReceived = 173
iTrans_VanSubsidyClaim = 178
iTrans_HQPaymentRegister = 250
*********************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @ErrStatus		INT
DECLARE	@InvRcpSno		INT
DECLARE @ReplaceNo		nVarChar(100)
DECLARE @PayMode 		INT
DECLARE @ChqNo 			NVARCHAR(500)
Declare @IDTRcpNo       nVarchar(50)
DECLARE @AcmId			INT
SET @ErrStatus = 1
	--Claim
	SELECT @AcmId=ACM.AcmId FROM AcMaster ACM,AcPeriod ACP
	WHERE ACM.AcmId=ACP.AcmId AND @Pi_VocDate BETWEEN AcmSdt AND AcmEdt
	IF EXISTS(SELECT * FROM YearEnd WHERE AcmId=@AcmId)
	BEGIN
		SET @ErrStatus=-29
	END
	ELSE
	BEGIN
		IF @Pi_TransId= 153 OR  @Pi_TransId=178 OR @Pi_TransId=173 OR @Pi_TransId=96 OR @Pi_TransId=217
			OR @Pi_TransId=104 OR @Pi_TransId= 16 OR  @Pi_TransId= 66	-- Sales
		BEGIN
			IF @Pi_TransId = 16
			BEGIN
				IF (SELECT ISNULL(SUM(A.RecommendedAmount),0) FROM ClaimSheetDetail A INNER JOIN ClaimSheetHD B
				ON A.ClmId=B.ClmId WHERE B.ClmCode = @Pi_ReferNo AND A.SelectMode=1 AND A.CrDbStatus=0)>0
				BEGIN
					EXEC Proc_VoucherPostingClaim @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			ELSE
			BEGIN
				EXEC Proc_VoucherPostingClaim @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=3		-- Sales
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
	
		END
		IF @Pi_TransId = 5
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				IF EXISTS (SELECT * FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo AND
					HandlingCharges > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 3
			BEGIN
				IF EXISTS (SELECT ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
					INNER JOIN PurchaseReceiptOtherCharges B ON A.PurRcptId = B.PurRcptId
						WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 1
					HAVING ISNULL(SUM(B.Amount),0) > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 4
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 5
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 6
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 8
				BEGIN
					IF EXISTS (SELECT ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
						INNER JOIN PurchaseReceiptOtherCharges B ON A.PurRcptId = B.PurRcptId
							WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
							HAVING ISNULL(SUM(B.Amount),0) > 0)
					BEGIN
						IF EXISTS(SELECT B.CoaID FROM COAMaster A
							INNER JOIN PurchaseReceiptOtherCharges B on A.CoaId=B.CoaId Where A.AcCode Like '4%')	--ExpenseAccount
						BEGIN	
							EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
								@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
						END
						IF EXISTS(SELECT B.CoaID FROM COAMaster A
							INNER JOIN PurchaseReceiptOtherCharges B on A.CoaId=B.CoaId Where A.AcCode Like '3%')	--IncomeAccount
						BEGIN
							EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,3,
								@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
						END
					END
				END
			
		END
		IF @Pi_TransId = 7		--Purchase Return
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 9		--Collection Register
		BEGIN
			IF @Pi_SubTransId = 1 -- (Bill Invoice)
			BEGIN
				---Cash Account Receipt	
				DECLARE VoucherReceiptModeCash_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode=1
				     )
				OPEN VoucherReceiptModeCash_cursor
				FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCash_cursor
				DEALLOCATE VoucherReceiptModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4,8) AND PostChequeVoucher=1
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
		
				---Cash Discount Account Receipt
				DECLARE VoucherReceiptModeCashDisc_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpNo=@Pi_ReferNo and
						CanCelStatus=1 and InvRcpMode=2
				     )
				OPEN VoucherReceiptModeCashDisc_cursor
				FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCashDisc_cursor
				DEALLOCATE VoucherReceiptModeCashDisc_cursor
			END
			IF @Pi_SubTransId = 5  -- (Debit Invoice)
			BEGIN
				---Cash Account Receipt	
				DECLARE VoucherReceiptModeCash_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode=1
				     )
				OPEN VoucherReceiptModeCash_cursor
				FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCash_cursor
				DEALLOCATE VoucherReceiptModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4,8) AND PostChequeVoucher=1
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
		
				---Cash Discount Account Receipt
				DECLARE VoucherReceiptModeCashDisc_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpNo=@Pi_ReferNo and
						CanCelStatus=1 and InvRcpMode=2
				     )
				OPEN VoucherReceiptModeCashDisc_cursor
				FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeCashDisc_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeCashDisc_cursor
				DEALLOCATE VoucherReceiptModeCashDisc_cursor
			END
			IF @Pi_SubTransId = 0 --(Bill Invoice)
			BEGIN
				---Cash Account ReceiptCancel	
				If Exists(SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=1)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=1
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
				
				---Cash Discount Account Receipt
				If EXISTS(SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=2)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM ReceiptInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=2
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END	
			END
			IF @Pi_SubTransId = 6 --(Debit Invoice)
			BEGIN
				---Cash Account ReceiptCancel	
				If Exists(SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=1)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=1
					EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
				
				---Cash Discount Account Receipt
				If EXISTS(SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0 and InvRcpMode=2)
				BEGIN
					SELECT @InvRcpSno=InvRcpSno FROM DebitInvoice WHERE InvRcpSno=@Pi_ReferNo and
						CanCelStatus=0 and InvRcpMode=2
					EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@InvRcpSno,2,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END	
			END
			IF @Pi_SubTransId = 2  --(Bill Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=2 
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,1,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			IF @Pi_SubTransId = 7  --(Debit Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=2
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,5,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			IF @Pi_SubTransId = 3  --(Bill Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM ReceiptInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=3
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,1,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END	
			IF @Pi_SubTransId = 8  --(Debit Invoice)
			BEGIN
				---Cheque Bank Account Receipt	
				DECLARE VoucherReceiptModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT InvRcpSno FROM DebitInvoice WHERE InvRcpSNo=@Pi_ReferNo and CanCelStatus=1
						and InvRcpMode In(3,4) AND PostChequeVoucher=3
					
				     )
				OPEN VoucherReceiptModeChqDD_cursor
				FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,5,@InvRcpSno,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherReceiptModeChqDD_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherReceiptModeChqDD_cursor
				DEALLOCATE VoucherReceiptModeChqDD_cursor
			END		
			
		END
		IF @Pi_TransId=10	--Cheque Bouncing
		BEGIN
			IF @Pi_SubTransId = 1 OR @Pi_SubTransId = 3		--Debit Note for Retailer
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,1,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END

			IF @Pi_SubTransId = 2 OR @Pi_SubTransId = 4		--Bank Charges paid to the Bank
			BEGIN
				IF EXISTS (SELECT Penality FROM ChequePayment WHERE ChequePayId = @Pi_ReferNo
					AND Penality > 0 )
				BEGIN
					EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,1,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
		END
		
		IF @Pi_TransId = 13
		BEGIN
			IF @Pi_SubTransId = 1 OR @Pi_SubTransId=0
			BEGIN
				EXEC Proc_VoucherPostingPurchase @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,0,
				@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
	-- 		IF @Pi_SubTransId = 0
	-- 		BEGIN
	-- 			EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,0,
	-- 			@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
	-- 		END
		END
		IF @Pi_TransId = 18  OR @Pi_TransId = 32
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId = 19  OR @Pi_TransId = 33
		BEGIN
			EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
			@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		
		IF @Pi_TransId = 22	--Payment Register
		BEGIN
			IF @Pi_SubTransId = 1 	--Cash Payment
			BEGIN
				IF EXISTS(SELECT PayAdvNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo And PayMode = 1)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
		 	END
			IF @Pi_SubTransId = 2 	--Bank Payment
			BEGIN
				IF EXISTS(SELECT PayAdvNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo And PayMode IN (2,3,5))
				BEGIN
					DECLARE VoucherPaymentModeChqDD_cursor CURSOR
					FOR  (
					 	SELECT PayMode,PayInsNo FROM PurchasePaymentDetails WHERE PayAdvNo=@Pi_ReferNo
						And PayMode in (2,3,5)
						
					     )
					OPEN VoucherPaymentModeChqDD_cursor
					FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO @PayMode,@ChqNo
					WHILE @@FETCH_STATUS = 0
					BEGIN	 		
						EXEC Proc_VoucherPostingBankPay @Pi_TransId,@PayMode,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@ChqNo,@Po_PurErrNo = @ErrStatus OUTPUT
	
						FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO  @PayMode,@ChqNo
					END
					CLOSE VoucherPaymentModeChqDD_cursor
					DEALLOCATE VoucherPaymentModeChqDD_cursor
				END
	
			END
		END
		IF @Pi_TransId = 24
		BEGIN
			EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId = 29 	--Billing
		BEGIN
			IF @Pi_SubTransId = 1	--  Billing Voucher
			BEGIN
				EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2	-- Other Charges Add Expeneses Billing
			BEGIN
				IF EXISTS (SELECT ISNULL(SUM(B.AdjAmt),0)FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
						A.SalId = B.SalId INNER JOIN PurSalAccConfig C
						ON C.AccDescId = B.AccDescId AND C.TransactionId=2
					WHERE A.SalInvno = @Pi_ReferNo AND C.Effect = 0
					HAVING ISNULL(SUM(B.AdjAmt),0) > 0)
				BEGIN
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 3	--Market Return
			BEGIN
				IF EXISTS (SELECT MarketRetAmount FROM SalesInvoice Where MarketRetAmount >0
					AND SalInvno = @Pi_ReferNo)
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 4	--Replacement sales
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 5	--Repalcement Sales Return
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
			IF @Pi_SubTransId = 6	--Cash Sales
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7	--Repalcement Debit Entry
			BEGIN
				SET @ReplaceNo = ''
				SELECT @ReplaceNo = RepRefNo from ReplacementHd A INNER JOIN SalesInvoice B
					ON A.SalId = B.SalId AND B.SalInvNo = @Pi_ReferNo
				IF LTRIM(RTRIM(@ReplaceNo)) <> ''
				BEGIN
					EXEC Proc_VoucherPostingSales @Pi_TransId,@Pi_SubTransId,@ReplaceNo,@Pi_VocType,
						@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
				END
			END
		END
		
		IF @Pi_TransId = 34
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 3
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 4
			BEGIN
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 5
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 6
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 7
			BEGIN
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 8
			BEGIN
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=36
		BEGIN
			IF @Pi_SubTransId=1
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=2
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=3
			BEGIN
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId=4
			BEGIN
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 38
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId = 14
		BEGIN
			IF @Pi_SubTransId = 1
			BEGIN
				EXEC Proc_VoucherPostingDebitNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
			IF @Pi_SubTransId = 2
			BEGIN
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
					@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
			END
		END
		IF @Pi_TransId=55 AND @Pi_SubTransId=1
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		IF @Pi_TransId=62 AND @Pi_SubTransId=1
		BEGIN
			EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END
		
		IF @Pi_TransId = 250	--HQ Payment Register
		BEGIN
			IF @Pi_SubTransId = 1 
			BEGIN
				---Cash Account Payment	
				DECLARE VoucherPaymentModeCash_cursor CURSOR
				FOR  (
				 	SELECT PayRcpSno FROM HQPaymentDetails WHERE PayRcpNo=@Pi_ReferNo 
						AND PayMode=1
				     )
				OPEN VoucherPaymentModeCash_cursor
				FETCH NEXT FROM VoucherPaymentModeCash_cursor INTO @InvRcpSno
				WHILE @@FETCH_STATUS = 0
				BEGIN	 	
					EXEC Proc_VoucherPostingCashPay @Pi_TransId,@Pi_SubTransId,@InvRcpSno,@Pi_VocType,
						1,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherPaymentModeCash_cursor INTO  @InvRcpSno
				END
				CLOSE VoucherPaymentModeCash_cursor
				DEALLOCATE VoucherPaymentModeCash_cursor
				---Bank Account Receipt	
				DECLARE VoucherPaymentModeChqDD_cursor CURSOR
				FOR  (
				 	SELECT PayRcpSno,InvInsNo FROM HQPaymentDetails WHERE PayRcpNo=@Pi_ReferNo 
						AND PayMode IN(3,4,8) 
				     )
				OPEN VoucherPaymentModeChqDD_cursor
				FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO @InvRcpSno,@ChqNo
				WHILE @@FETCH_STATUS = 0
				BEGIN	 		
					EXEC Proc_VoucherPostingBankPay @Pi_TransId,1,@InvRcpSno,@Pi_VocType,
						2,@Pi_UserId,@Pi_VocDate,@ChqNo,@Po_PurErrNo = @ErrStatus OUTPUT
					FETCH NEXT FROM VoucherPaymentModeChqDD_cursor INTO  @InvRcpSno,@ChqNo 
				END
				CLOSE VoucherPaymentModeChqDD_cursor
				DEALLOCATE VoucherPaymentModeChqDD_cursor
			END
		END
		IF @Pi_TransId=270     ----   IDT Management
		BEGIN
			EXEC Proc_VoucherPostingIDTManagement @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,
				@Pi_SubVocType,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
		END

		IF @Pi_TransId=271     ----   IDT Collection
		BEGIN
							/* Stock Out --  Receipt*/
			IF @Pi_SubTransId= 1		
			BEGIN
							/* Sub Voucher - 3 Cash */
				EXEC Proc_VoucherPostingCashReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,3,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher -  4 Bank*/
				EXEC Proc_VoucherPostingBankReceipt @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,4,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 6 Cash Discount*/
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,@Pi_SubTransId,@Pi_ReferNo,@Pi_VocType,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT 
			END
							/* Stock IN --  Payment*/
			IF @Pi_SubTransId= 2		
			BEGIN
							/* Sub Voucher - 1 Cash */
				EXEC Proc_VoucherPostingCashPay @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,
						1,@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 2 Bank*/
				EXEC Proc_VoucherPostingBankPay @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,
						2,@Pi_UserId,@Pi_VocDate,0,@Po_PurErrNo = @ErrStatus OUTPUT
							/* Sub Voucher - 6 Cash Discount*/
				EXEC Proc_VoucherPostingCreditNote @Pi_TransId,2,@Pi_ReferNo,@Pi_VocType,6,
						@Pi_UserId,@Pi_VocDate,@Po_PurErrNo = @ErrStatus OUTPUT 
			END
		END
	END
	SET @Po_ErrNo = @ErrStatus
RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_VoucherPostingCashReceipt')
DROP PROCEDURE Proc_VoucherPostingCashReceipt
GO
----  Exec Proc_VoucherPostingCashReceipt 254,1,'IDR1000005',2,0,2,'2010-04-28',0
CREATE PROCEDURE Proc_VoucherPostingCashReceipt
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingCashReceipt
* PURPOSE	: General SP for posting CASH Collection
* CREATED	: Murugan
* CREATED DATE	: 26/12/2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @RtrCoaId 	INT
DECLARE @DisCoaId 	INT
DECLARE @SalInvNo	Varchar(50)
DECLARE @InvRcpSno	INT
DECLARE @SalId		BIGINT
DECLARE @SalInvAmt 	NUMERIC(38,2)
DECLARE @InvRcpMode	INT	
DECLARE @DisBnkId	INT
DECLARE @DisBnkBrId	INT
DECLARE @InvRcpNo 	NVARCHAR(50)
DECLARE @PurRcptId	INT
DECLARE @PurRcptRefNo	Varchar(50)
DECLARE @PurRcptAmt NUMERIC(38,2)
DECLARE @sSql           VARCHAR(4000)
DECLARE @DbRefNo AS NVARCHAR(100)
DECLARE @IDTMngtNo	Varchar(50)
SET @Po_PurErrNo = 1
--Cash REceipt (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 1
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice WHERE
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId  )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
--Cash Receipt (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 5
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@DbRefNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice WHERE 
		InvRcpSno=@Pi_ReferNo AND CanCelStatus=1  
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Debit Note No: '+ @DbRefNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' AND FldName ='ReceiptVoc'
	IF NOT EXISTS (SELECT DISTINCT R.Coaid FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		WHERE R.Availability=1 AND R.RtrId=Si.Rtrid AND R.CoaId=C.CoaId AND SI.DbNoteNumber=@DbRefNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT EXISTS (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	SELECT DISTINCT @RtrCoaId=R.CoaId FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		WHERE R.Availability=1 AND R.RtrId=SI.Rtrid AND R.CoaId=C.CoaId 
		AND SI.DbNoteNumber=@DbRefNo
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit 
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END		
IF @Pi_TransId = 5 AND @Pi_SubTransId = 8	----Add Income Receipt
BEGIN
	
	SELECT @PurRcptRefNo=PurRcptRefNo,@PurRcptId=PurRcptId,@PurRcptAmt=OtherCharges  FROM PurchaseReceipt WHERE
		PurRcptRefNo=@Pi_ReferNo
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	SELECT @PurRcptRefNo=PurRcptRefNo From PurchaseReceipt Where purrcptid=@PurRcptId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Debit Note: '+ @Pi_ReferNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	--For Posting Other Charges Add in Details Table For Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT @VocRefNo,B.CoaId,2,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT ''' + @VocRefNo + ''',B.CoaId,1,ISNULL(SUM(B.Amount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = ''' + @Pi_ReferNo + ''' AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0'
	
----
	--For Posting Main Cash Account in Details Table To Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	SELECT @Amt = 0
	SELECT @Amt = ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A
		INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
----
	
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
------
----Cash Account Receipt Cancel (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 0
BEGIN
		
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cancellation '
		+ @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Debit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
----Cash Account Receipt Cancel (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 6
BEGIN
		
	SELECT @InvRcpNo=InvRcpNo,@DbRefNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice 
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0  
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cancellation ' 
		+ @InvRcpNo + '(Debit Note No: '+ @DbRefNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI where 
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and DbNoteNumber=@DbRefNo )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId 
		and DbNoteNumber=@DbRefNo
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Debit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit 
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
IF @Pi_TransId = 29 AND @Pi_SubTransId = 6
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice WHERE
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId  )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'
		
	--For Retailer Account Credit	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
			
END
IF @Pi_TransId=34	--Retailer OnAccount
BEGIN
	IF @Pi_SubTransId=3		--Cash Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Retailer OnAccount Cash Receipt ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		--For Posting Cash Account in Details Table on Credit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=34	--Supplier OnAccount
BEGIN
	IF @Pi_SubTransId=7		--Cash Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Supplier OnAccount Cash Receipt ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		--For Posting Cash Account in Details Table on Credit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 1
BEGIN


	DECLARE VoucherReceiptModeCash_cursor CURSOR
	FOR  (
			SELECT IDTRcpNo,IDTMngRefNo,IDTCollectedAmt  FROM IDTReceiptInvoicedetails
			WHERE IDTRcpNo=@Pi_ReferNo  and CollTypeId = 1 and IDTCollectedAmt>0
		 )
	OPEN VoucherReceiptModeCash_cursor


	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @InvRcpNo,@IDTMngtNo,@SalInvAmt
	WHILE @@FETCH_STATUS = 0
	BEGIN	 	
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END

			SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
						CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
			IF LTRIM(RTRIM(@VocRefNo)) = '' 
			BEGIN
				SET @Po_PurErrNo = -1
				Return
			END

			--For Posting Receipt Header Voucher
			INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
									 LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) 
			VALUES 
				(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt : ' + @InvRcpNo + '(IDT No: '+ @IDTMngtNo +')'+
				' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
				
				UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'

			IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
							where R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngtNo  )
			BEGIN
				SET @Po_PurErrNo = -13
  				Return
			END
			IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
			BEGIN
				SET @Po_PurErrNo = -8
				Return
			END
			SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
				where R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngtNo
		 
	
			SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'

	
		--For IDT Dist Account Credit	
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
				(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))

			--For MainCash Account details On Debit
				
			INSERT INTO StdVocDetails(	VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
										LastModDate,AuthId,AuthDate) 
			VALUES (@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))
			
				SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
				IF @sSql='-4'
				BEGIN
					SET @Po_PurErrNo = -4
					Return
				END
				ELSE IF @sSql='-5'
				BEGIN
					SET @Po_PurErrNo = -5
					Return
				END
				ELSE IF @sSql<>'0'
				BEGIN
					EXEC(@sSql)
				END

		--Validate Credit amount is Equal to Debit 
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
					SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
									ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
					Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			RETURN
		END

	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO   @InvRcpNo,@IDTMngtNo,@SalInvAmt
	END		
	CLOSE VoucherReceiptModeCash_cursor
	DEALLOCATE VoucherReceiptModeCash_cursor

END
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPostingBankReceipt') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPostingBankReceipt
GO
----  Exec Proc_VoucherPostingBankReceipt 254,1,'IDR1000005',2,1,2,'2010-04-26',0
CREATE PROCEDURE Proc_VoucherPostingBankReceipt
(
	@Pi_TransId		Int,
	@Pi_SubTransId	Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType	INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo	Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingBankReceipt
* PURPOSE	: General SP for posting Collection
* CREATED	: Murugan 
* CREATED DATE	: 26/12/2007
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}      
	
*********************************/ 
SET NOCOUNT ON
BEGIN
	 
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @RtrCoaId 	INT
DECLARE @DisCoaId 	INT
DECLARE @SalInvNo	Varchar(50)
DECLARE @InvRcpSno	INT
DECLARE @SalId		BIGINT
DECLARE @SalInvAmt 	NUMERIC(38,2)
DECLARE @InvRcpMode	INT	
DECLARE @DisBnkId	INT
DECLARE @DisBnkBrId	INT
DECLARE @InvRcpNo 	NVARCHAR(50)
DECLARE @DebitNo	NVARCHAR(50)
DECLARE @ChqNo		NVARCHAR(250)
DECLARE @ChqDate	DateTime
DECLARE @sSql           VARCHAR(4000)

SET @Po_PurErrNo = 1

IF @Pi_TransId = 9 AND @Pi_SubTransId = 1		--Bank Collection (Bill Invoice)
BEGIN
 	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt,@DisBnkId=DisBnkId,
		@DisBnkBrId=DisBnkBrId,@ChqNo=InvInsNo,@ChqDate=InvInsDate,@InvRcpMode=InvRcpMode FROM ReceiptInvoice 
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=1  

	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	IF @InvRcpMode=3
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
			+ '(Bill No: '+ @SalInvNo +') ' + ' (Cheque No ' + @ChqNo + 
			' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @InvRcpMode=4
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
			+ '(Bill No: '+ @SalInvNo +') ' + ' (DD No ' + @ChqNo + 
			' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @InvRcpMode=8
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
			+ '(Bill No: '+ @SalInvNo +') ' + ' (RTGS No ' + @ChqNo + 
			' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
		
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'

	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI 
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId 
		and SalId=@SalId)
	BEGIN
		SET @Po_PurErrNo = -13

		Return
	END

	IF NOT Exists (	Select B.coaid from BankBranch B,CoaMaster C,RECEIPTINVOICE RI 
		where B.Bnkid=Ri.DisBnkid and B.BnkBrId=Ri.DisBnkBrId and B.CoaId=C.CoaId
		And InvRcpSno=@Pi_ReferNo ANd SalId=@SalId)	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	

	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI 
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId

	Select @CoaId=B.coaid from BankBranch B,CoaMaster C,RECEIPTINVOICE RI where 
		B.Bnkid=Ri.DisBnkid and B.BnkBrId=Ri.DisBnkBrId and B.CoaId=C.CoaId
		And InvRcpSno=@Pi_ReferNo ANd SalId=@SalId

	--For Posting Retailer Account details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For BankAccount or MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 
	
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
IF @Pi_TransId = 9 AND @Pi_SubTransId = 5		--Bank Collection (Debit Invoice)
BEGIN
 	SELECT @InvRcpNo=InvRcpNo,@DebitNo=DbNoteNumber,@SalInvAmt=DebitAmt,@DisBnkId=DisBnkId,
		@DisBnkBrId=DisBnkBrId,@ChqNo=InvInsNo,@ChqDate=InvInsDate,@InvRcpMode=InvRcpMode FROM DebitInvoice (NOLOCK) 
		WHERE InvRcpSno=@Pi_ReferNo AND CancelStatus=1  
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Receipt Header Voucher
	
	IF @InvRcpMode=3
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
		+ '(Debit Note No: '+ @DebitNo +') ' + ' (Cheque No ' + @ChqNo + 
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @InvRcpMode=4
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
		+ '(Debit Note No: '+ @DebitNo +') ' + ' (DD No ' + @ChqNo + 
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 
	ELSE IF @InvRcpMode=8
	BEGIN
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt ' + @InvRcpNo 
		+ '(Debit Note No: '+ @DebitNo +') ' + ' (RTGS No ' + @ChqNo + 
		' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	END 

	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''ReceiptVoc'''
	  
	--INSERT INTO Translog(strSql1) Values (@sstr)
	IF NOT EXISTS (	SELECT DISTINCT R.Coaid FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
			WHERE R.RtrId=Si.Rtrid AND R.CoaId=C.CoaId 
			AND SI.DbNoteNumber=@DebitNo)
	BEGIN
		SET @Po_PurErrNo = -13		Return
	END
	IF NOT EXISTS (	SELECT B.coaid FROM BankBranch B,CoaMaster C,DebitInvoice RI 
		WHERE B.Bnkid=Ri.DisBnkid AND B.BnkBrId=Ri.DisBnkBrId and B.CoaId=C.CoaId
		AND InvRcpSno=@Pi_ReferNo AND RI.DbNoteNumber=@DebitNo)	
	BEGIN
		SET @Po_PurErrNo = -20
		Return
	END	
	SELECT DISTINCT @RtrCoaId=R.coaid FROM Retailer R,CoaMaster c ,DebitNoteRetailer SI 
		where R.Availability=1 AND R.RtrId=Si.Rtrid AND R.CoaId=C.CoaId AND SI.DbNoteNumber=@DebitNo

	SELECT @CoaId=B.coaid FROM BankBranch B,CoaMaster C,DebitInvoice RI WHERE 
		B.Bnkid=Ri.DisBnkid AND B.BnkBrId=Ri.DisBnkBrId AND B.CoaId=C.CoaId
		AND InvRcpSno=@Pi_ReferNo AND RI.DbNoteNumber=@DebitNo
	--For Posting Retailer Account details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For BankAccount or MainCash Account details On Debit
		
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'
	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit 
	
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END

IF @Pi_TransId = 34 		--Retailer OnAccount
BEGIN
	IF @Pi_SubTransId=4	--Bank Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END

		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = '' 
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Retailer OnAccount Bank Receipt ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,

			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Retailer OnAccount Bank Receipt ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) + 
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
				'''StdVocMaster''' + ' and fldname = ' + '''ReceiptVoc'''
		  
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Debit Account in Details Table on Credit			
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -20
			Return
		END
		
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON 
		A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
		WHERE C.RtrAccRefNo = @Pi_ReferNo

	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit 
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

		--Validate Credit amount is Equal to Debit 

		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END	
END

IF @Pi_TransId = 34 		--Supplier OnAccount
BEGIN
	IF @Pi_SubTransId=8	--Bank Receipt
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END

		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = '' 
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting DbNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Supplier OnAccount Bank Receipt ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Supplier OnAccount Bank Receipt ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) + 
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
				'''StdVocMaster''' + ' and fldname = ' + '''ReceiptVoc'''
		  
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Debit Account in Details Table on Credit			
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -20
			Return
		END
		
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN BankBranch B ON 
		A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.BnkBrId = C.BnkBrId
		WHERE C.RtrAccRefNo = @Pi_ReferNo

	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Debit 
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
		--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

		--Validate Credit amount is Equal to Debit 

		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END	
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 1		--Bank Collection
BEGIN
			/* ---  CHEQUE  ---  */
	DECLARE VoucherReceiptBankCheq_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(2) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankCheq_cursor
	FETCH NEXT FROM VoucherReceiptBankCheq_cursor INTO  @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END

			IF @SalInvAmt > 0
			BEGIN
					SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
						CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
					IF LTRIM(RTRIM(@VocRefNo)) = '' 
					BEGIN
						SET @Po_PurErrNo = -1
						Return
					END
					
					  /* ---  For Posting Receipt Header Voucher  --- */
					INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
						LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
					(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt ' + @InvRcpNo 
						+ '(IDT No : '+ @SalInvNo +') ' + ' Cheque No : ' + @ChqNo + 
						' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
					
						UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
						IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
							where R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId 
							and IDTMngRefNo=@SalInvNo)
						BEGIN
							SET @Po_PurErrNo = -13 	
							Return
					END

					IF NOT Exists (	Select distinct B.coaid from BankBranch B  Where DistBank = 1)	
					BEGIN
						SET @Po_PurErrNo = -20
					Return
					END	

					SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
					WHERE R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId and  IDTMngRefNo=@SalInvNo
					Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
					
					/*  ---  For Posting Supplier Account details on Credit --- */
			
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))

					/*  ---  For BankAccount or MainCash Account details On Debit  --- */
						
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))
			  END

					/* --- For Posting Round Off Account Add in Details Table to Debit ---*/

				SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
				IF @sSql='-4'
				BEGIN
					SET @Po_PurErrNo = -4
					Return
				END
				ELSE IF @sSql='-5'
				BEGIN
					SET @Po_PurErrNo = -5
					Return
				END
				ELSE IF @sSql<>'0'
				BEGIN
					EXEC(@sSql)
				END
			
			  /*  ---  Validate Credit amount is Equal to Debit  --- */
			
			IF NOT EXISTS (SELECT SUM(Amount) FROM(
				SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
					ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
				Having SUM(Amount) = 0)
			BEGIN
				SET @Po_PurErrNo = -6
				RETURN
			END

	FETCH NEXT FROM VoucherReceiptBankCheq_cursor INTO   @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														@ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankCheq_cursor
	DEALLOCATE VoucherReceiptBankCheq_cursor

			/*  --- DD  --- */
	DECLARE VoucherReceiptBankDD_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(3) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankDD_cursor
	FETCH NEXT FROM VoucherReceiptBankDD_cursor INTO  @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END

			IF @SalInvAmt > 0
			BEGIN
					SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
						CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
					IF LTRIM(RTRIM(@VocRefNo)) = '' 
					BEGIN
						SET @Po_PurErrNo = -1
						Return
					END
					
					  /* ---  For Posting Receipt Header Voucher  --- */
					INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
						LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
					(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt ' + @InvRcpNo 
						+ '(IDT No : '+ @SalInvNo +') ' + ' DD No : ' + @ChqNo + 
						' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
					
						UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
						IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
							where R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId 
							and IDTMngRefNo=@SalInvNo)
						BEGIN
							SET @Po_PurErrNo = -13 	
							Return
					END

					IF NOT Exists (	Select distinct B.coaid from BankBranch B  Where DistBank = 1)	
					BEGIN
						SET @Po_PurErrNo = -20
					Return
					END	

					SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
					WHERE R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId and  IDTMngRefNo=@SalInvNo
					Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
					
					/*  ---  For Posting Supplier Account details on Credit --- */
			
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))

					/*  ---  For BankAccount or MainCash Account details On Debit  --- */
						
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))
			  END

					/* --- For Posting Round Off Account Add in Details Table to Debit ---*/

				SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
				IF @sSql='-4'
				BEGIN
					SET @Po_PurErrNo = -4
					Return
				END
				ELSE IF @sSql='-5'
				BEGIN
					SET @Po_PurErrNo = -5
					Return
				END
				ELSE IF @sSql<>'0'
				BEGIN
					EXEC(@sSql)
				END
			
			  /*  ---  Validate Credit amount is Equal to Debit  --- */
			
			IF NOT EXISTS (SELECT SUM(Amount) FROM(
				SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
					ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
				Having SUM(Amount) = 0)
			BEGIN
				SET @Po_PurErrNo = -6
				RETURN
			END

	FETCH NEXT FROM VoucherReceiptBankDD_cursor INTO   @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														@ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankDD_cursor
	DEALLOCATE VoucherReceiptBankDD_cursor

				/*  --- RTGS  --- */
	DECLARE VoucherReceiptBankRTGS_cursor CURSOR
	FOR  (
			SELECT	IDTRcpNo,IDTMngRefNo,IDTCollectedAmt,BankId,
					BankBranchId,InstrumentNo,CollectionDate 
			FROM	IDTReceiptInvoiceDetails 
			WHERE IDTRcpNo=@Pi_ReferNo   and CollTypeId in(4) and IDTCollectedAmt > 0
			
		 )
	OPEN VoucherReceiptBankRTGS_cursor
	FETCH NEXT FROM VoucherReceiptBankRTGS_cursor INTO  @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														@ChqNo,@ChqDate
	WHILE @@FETCH_STATUS = 0
	BEGIN	 
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END

			IF @SalInvAmt > 0
			BEGIN
					SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
						CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
					IF LTRIM(RTRIM(@VocRefNo)) = '' 
					BEGIN
						SET @Po_PurErrNo = -1
						Return
					END
					
					  /* ---  For Posting Receipt Header Voucher  --- */
					INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
						LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
					(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt ' + @InvRcpNo 
						+ '(IDT No : '+ @SalInvNo +') ' + ' RTGS No : ' + @ChqNo + 
						' Dated ' + CONVERT(nVarChar(10),@ChqDate,121),1,@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_UserId,
						Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
					
						UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
						IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
							where R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId 
							and IDTMngRefNo=@SalInvNo)
						BEGIN
							SET @Po_PurErrNo = -13 	
							Return
					END

					IF NOT Exists (	Select distinct B.coaid from BankBranch B  Where DistBank = 1)	
					BEGIN
						SET @Po_PurErrNo = -20
					Return
					END	

					SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
					WHERE R.availability=1 and R.SPmId=Si.SPmId and R.CoaId=C.CoaId and  IDTMngRefNo=@SalInvNo
					Select distinct @CoaId = B.coaid from BankBranch B  Where DistBank = 1
					
					/*  ---  For Posting Supplier Account details on Credit --- */
			
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))

					/*  ---  For BankAccount or MainCash Account details On Debit  --- */
						
					INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) VALUES
						(@VocRefNo,@CoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))
			  END

					/* --- For Posting Round Off Account Add in Details Table to Debit ---*/

				SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
				IF @sSql='-4'
				BEGIN
					SET @Po_PurErrNo = -4
					Return
				END
				ELSE IF @sSql='-5'
				BEGIN
					SET @Po_PurErrNo = -5
					Return
				END
				ELSE IF @sSql<>'0'
				BEGIN
					EXEC(@sSql)
				END
			
			  /*  ---  Validate Credit amount is Equal to Debit  --- */
			
			IF NOT EXISTS (SELECT SUM(Amount) FROM(
				SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
					ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
				Having SUM(Amount) = 0)
			BEGIN
				SET @Po_PurErrNo = -6
				RETURN
			END

	FETCH NEXT FROM VoucherReceiptBankRTGS_cursor INTO   @InvRcpNo,@SalInvNo,@SalInvAmt,@DisBnkId,@DisBnkBrId,
														 @ChqNo,@ChqDate
	END		
	CLOSE VoucherReceiptBankRTGS_cursor
	DEALLOCATE VoucherReceiptBankRTGS_cursor
END
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPostingCashPay') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPostingCashPay
GO
CREATE PROCEDURE Proc_VoucherPostingCashPay
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingCashPay
* PURPOSE	: General SP for posting Cash Payment 
* CREATED	: Thrinath 
* CREATED DATE	: 25/12/2007
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}      
	
*********************************/ 
SET NOCOUNT ON
BEGIN
	 
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @sSql           VARCHAR(4000)

DECLARE @PayInsAmt 	NUMERIC(38,2)
DECLARE @PayMode	INT	
DECLARE @BnkId		INT
DECLARE @SuppCoaId	INT
DECLARE @BnkBrId	INT
DECLARE @PayAdvNo 	NVARCHAR(50)
DECLARE @IDTMngNo 	NVARCHAR(50)
DECLARE @RtrCoaId	int

SET @Po_PurErrNo = 1

IF @Pi_TransId = 5 AND @Pi_SubTransId = 2	--Handling Charges Expenses
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END

	--For Posting Purchase Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From GRN ' + @Pi_ReferNo + 
		' For Handling Charges Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)

	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From GRN ' + @Pi_ReferNo + '  For Handling Charges Dated ' + 
		CONVERT(nVarChar(10),@Pi_VocDate,121) + ''',1,' + CAST(@Pi_UserId as nVarChar(10)) + 
		',''' + Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'

	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
  
	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Handling Charges Account in Details Table on Debit

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4210002')
	BEGIN
		SET @Po_PurErrNo = -7
		Return
	END

	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4210002'

	SELECT @Amt = HandlingCharges FROM PurchaseReceipt WHERE PurRcptRefNo = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Main Cash Account in Details Table To Credit

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END

	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 

	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END

IF @Pi_TransId = 5 AND @Pi_SubTransId = 3	-- Other Charges Reduce Expeneses
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END

	--For Posting Purchase Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From GRN ' + @Pi_ReferNo + 
		' For Other Charges Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)

	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From GRN ' + @Pi_ReferNo + ' For Other Charges Dated ' 
		+ CONVERT(nVarChar(10),@Pi_VocDate,121) + ''',1,' + CAST(@Pi_UserId as nVarChar(10)) + 
		',''' + Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'

	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
  
	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Other Charges Reduce Account in Details Table on Debit

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT @VocRefNo,B.CoaId,1,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 1
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT ''' + @VocRefNo + ''',B.CoaId,1,ISNULL(SUM(B.Amount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = ''' + @Pi_ReferNo + ''' AND Effect = 1
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0'

	--For Posting Main Cash Account in Details Table To Credit

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END

	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'

	SELECT @Amt = 0

	SELECT @Amt = ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A 
		INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 1

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 

	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 5 AND @Pi_SubTransId = 8	-- Other Charges Nil Expeneses
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END

	--For Posting Purchase Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From GRN ' + @Pi_ReferNo + 
		' For Other Charges Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)

	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From GRN ' + @Pi_ReferNo + ' For Other Charges Dated ' 
		+ CONVERT(nVarChar(10),@Pi_VocDate,121) + ''',1,' + CAST(@Pi_UserId as nVarChar(10)) + 
		',''' + Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'

	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
  
	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Other Charges Nil Account in Details Table on Debit

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT @VocRefNo,B.CoaId,1,ISNULL(SUM(B.Amount),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT ''' + @VocRefNo + ''',B.CoaId,1,ISNULL(SUM(B.Amount),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM PurchaseReceipt A INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = ''' + @Pi_ReferNo + ''' AND Effect = 2
		Group By B.CoaId
		HAVING ISNULL(SUM(B.Amount),0) > 0'

	--For Posting Main Cash Account in Details Table To Credit

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END

	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'

	SELECT @Amt = 0

	SELECT @Amt = ISNULL(SUM(B.Amount),0)FROM PurchaseReceipt A 
		INNER JOIN PurchaseReceiptOtherCharges B ON
			A.PurRcptId = B.PurRcptId 
		WHERE A.PurRcptRefNo = @Pi_ReferNo AND Effect = 2

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 
 	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 22 AND @Pi_SubTransId = 1	--Purchase Cash Payment
BEGIN

	SELECT @PayAdvNo=PayAdvNo,@PayInsAmt=PayInsAmt,@PayMode=PayMode  FROM PurchasePaymentDetails 
		WHERE PayAdvNo=@Pi_ReferNo And PayMode = 1

	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Payment Register ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)

	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Payment Register ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) + 
		''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'

	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
		  
	--INSERT INTO Translog(strSql1) Values (@sstr)

	IF NOT Exists (Select DISTINCT A.CoaId From Supplier A,CoaMaster B ,PurchasePayment C 
		Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId 
		And PayAdvNo=@Pi_ReferNo )
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END

	Select DISTINCT @SuppCoaId=A.CoaId From Supplier A,
		CoaMaster B ,PurchasePayment C Where A.availability=1 and A.SpmId=C.SpmId and A.CoaId=B.CoaId 
		And PayAdvNo=@Pi_ReferNo

	SELECT @CoaId=CoaId FROM CoaMaster Where AcCode = '2120002'		

	--For Posting Supplier Account details on Debit

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@SuppCoaId,1,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@SuppCoaId as nVarChar(10)) + ',1,' + CAST(@PayInsAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For MainCash Account details On Credit

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@PayInsAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@PayInsAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 

	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END


IF @Pi_TransId = 29 AND @Pi_SubTransId = 2	-- Other Charges Add Expeneses Billing
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END

	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))

	IF LTRIM(RTRIM(@VocRefNo)) = '' 
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END

	--For Posting Sales Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Billing ' + @Pi_ReferNo + 
		' For Other Charges Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)

	SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
	(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
		',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
		''',''Posted From Billing ' + @Pi_ReferNo + ' For Other Charges Dated ' 
		+ CONVERT(nVarChar(10),@Pi_VocDate,121) + ''',1,' + CAST(@Pi_UserId as nVarChar(10)) + 
		',''' + Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'

	SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
			'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
  
	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Other Charges Add Account in Details Table on Debit

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT @VocRefNo,C.CoaId,1,ISNULL(SUM(B.AdjAmt),0),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121)
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2
		WHERE A.SalInvno = @Pi_ReferNo AND C.Effect = 0
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) 
	SELECT ''' + @VocRefNo + ''',C.CoaId,1,ISNULL(SUM(B.AdjAmt),0),1,' +
		CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + '''
		FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
			A.SalId = B.SalId INNER JOIN PurSalAccConfig C
			ON C.AccDescId = B.AccDescId AND C.TransactionId=2 
		WHERE A.SalInvno = ''' + @Pi_ReferNo + ''' AND C.Effect = 0
		Group By C.CoaId
		HAVING ISNULL(SUM(B.AdjAmt),0) > 0'

	--INSERT INTO Translog(strSql1) Values (@sstr)

	--For Posting Main Cash Account in Details Table To Credit

	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
	BEGIN
		SET @Po_PurErrNo = -8
		Return
	END

	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'

	SELECT @Amt = 0

	SELECT @Amt = ISNULL(SUM(B.AdjAmt),0)FROM SalesInvoice A INNER JOIN SalInvOtherAdj B ON
		A.SalId = B.SalId INNER JOIN PurSalAccConfig C
		ON C.AccDescId = B.AccDescId AND C.TransactionId=2
	WHERE A.SalInvno = @Pi_ReferNo AND C.Effect = 0

	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))

	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
		Convert(nvarchar(10),Getdate(),121) + ''')'

	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

	--Validate Credit amount is Equal to Debit 

	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END

IF @Pi_TransId=34
BEGIN
	IF @Pi_SubTransId=1
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END

		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = '' 
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting Retailer On Account Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Retailer On Account Cash Payment ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Retailer On Account Cash Payment ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) + 
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
				'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
		  
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Cash Account in Details Table on Debit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'

	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Credit 
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.RtrId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)

		--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit 

		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=34  --Supplier On Account
BEGIN
	IF @Pi_SubTransId=5
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END

		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = '' 
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting Retailer On Account Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Supplier On Account Cash Payment ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		SET @sStr = 'INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES 
		(''' + @VocRefNo + ''',' + CAST(@AcmId As nVarChar(10)) + ',' + CAST(@AcpId As nVarChar(10)) +
			',' + CAST(@Pi_VocType As nVarChar(10)) + ',''' + CONVERT(nVarChar(10),@Pi_VocDate,121) +
			''',''Posted From Supplier On Account Cash Payment ' + @Pi_ReferNo + 
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121) + 
			''',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''',' + CAST(@Pi_SubVocType as nVarChar(10)) + ',1,0)'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
	
		SET @sStr = 'UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = ' + 
				'''StdVocMaster''' + ' and fldname = ' + '''PaymentVoc'''
		  
		--INSERT INTO Translog(strSql1) Values (@sstr)
	
	
		--For Posting Cash Account in Details Table on Debit			
	
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'

	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)					
	
		--For Posting Retailer Account in Details Table to Credit 
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON 
			A.CoaId = B.CoaId INNER JOIN RetailerOnAccount C ON B.SpmId = C.RtrId
			WHERE C.RtrAccRefNo = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM RetailerOnAccount WHERE RtrAccRefNo = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' + 
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)

		--For Posting Round Off Account Add in Details Table to Debit

		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)

		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit 

		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 2	-- Cash Payment
BEGIN
	DECLARE VoucherReceiptModeCash_cursor CURSOR
	FOR  (
			SELECT IDTRcpNo,IDTMngRefNo,IDTCollectedAmt  FROM IDTReceiptInvoicedetails (Nolock)
			WHERE IDTRcpNo=@Pi_ReferNo  and CollTypeId = 1 and IDTCollectedAmt>0
		 )
	OPEN VoucherReceiptModeCash_cursor
	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @Pi_ReferNo,@IDTMngNo,@Amt
	WHILE @@FETCH_STATUS = 0
	BEGIN	
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock) 
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = '' 
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	--For Posting Purchase Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
					LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) 
		VALUES   	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT ' + @Pi_ReferNo + 
					' For IDT Receipt Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
					Convert(varchar(10),Getdate(),121),@Pi_UserId,
					Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
			
		--For Posting Handling Charges Account in Details Table on Debit
			IF NOT Exists (	SELECT DISTINCT R.coaid FROM IDTMaster R (Nolock),CoaMaster c (Nolock),
							IDTManagement SI  (Nolock)
							WHERE R.availability=1 and R.SPMId=Si.SPMId 
							and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngNo  )
			BEGIN
				SET @Po_PurErrNo = -13
  				Return
			END
			SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI 
				where R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo=@IDTMngNo
	
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) 
			VALUES		(@VocRefNo,@RtrCoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
						@Pi_UserId,Convert(varchar(10),Getdate(),121))
		
		--For Posting Main Cash Account in Details Table To Credit
		IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '2120002')
		BEGIN
			SET @Po_PurErrNo = -8
			Return
		END
		SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '2120002'
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) 
		VALUES
			(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
			
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END

		--Validate Credit amount is Equal to Debit 
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails 
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	FETCH NEXT FROM VoucherReceiptModeCash_cursor INTO @Pi_ReferNo,@IDTMngNo,@Amt
	END		
	CLOSE VoucherReceiptModeCash_cursor
	DEALLOCATE VoucherReceiptModeCash_cursor
END

IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_VoucherPostingCreditNote') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_VoucherPostingCreditNote
GO
-- EXEC PROC_VOUCHERPOSTINGCREDITNOTE 18,1,'CRN1000062',3,6,1,'2011-01-11',0
CREATE PROCEDURE Proc_VoucherPostingCreditNote
(
	@Pi_TransId		Int,
	@Pi_SubTransId		Int,
	@Pi_ReferNo		nVarChar(100),
	@Pi_VocType		INT,
	@Pi_SubVocType		INT,	
	@Pi_UserId		Int,
	@Pi_VocDate		DateTime,
	@Po_PurErrNo		Int OutPut
)
AS
/*********************************
* PROCEDURE	: Proc_VoucherPostingCreditNote
* PURPOSE	: General SP for posting Credit Note
* CREATED	: Thrinath
* CREATED DATE	: 26/12/2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	 
DECLARE @AcmId 		INT
DECLARE @AcpId		INT
DECLARE @CoaId		INT
DECLARE @VocRefNo	nVarChar(100)
DECLARE @sStr		nVarChar(4000)
DECLARE @Amt		Numeric(25,6)
DECLARE @RtrCoaId 	INT
DECLARE @DisCoaId	INT
DECLARE @SalInvNo	Varchar(50)
DECLARE @InvRcpSno	INT
DECLARE @SalId		BIGINT
DECLARE @SalInvAmt 	NUMERIC(38,2)
DECLARE @InvRcpNo 	NVARCHAR(50)
DECLARE @sSql           VARCHAR(4000)
DECLARE @PurRcptNo 	NVARCHAR(50)
DECLARE @CrNoteNo 	NVARCHAR(50)
DECLARE @DebitNo	NVARCHAR(100)
DECLARE @TaxAmt		Numeric(25,6)
DECLARE @DiffAmt	Numeric(25,6)
DECLARE @ConfigRemarks INT
DECLARE @IDTMngtNo 	NVARCHAR(50)
DECLARE @Remarks    NVARCHAR(4000)
SET @Po_PurErrNo = 1
IF @Pi_TransId = 5 AND @Pi_SubTransId = 7	--Excess without Refusale
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	SELECT @PurRcptNo=SUBSTRING(@Pi_ReferNo,CHARINDEX('/',@Pi_ReferNo)+1,LEN(@Pi_ReferNo))
	SELECT @CrNoteNo=SUBSTRING(@Pi_ReferNo,1,CHARINDEX('/',@Pi_ReferNo)-1)
	--For Posting Purchase Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Credit Note Supplier ' + @CrNoteNo +
		' For Excess Without Refusale Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	
	--For Posting Supplier Account in Details Table on Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
		A.CoaId = B.CoaId INNER JOIN CreditnoteSupplier C ON B.SpmId = C.SpmId
		WHERE C.CrNoteNumber = @CrNoteNo)
	BEGIN
		SET @Po_PurErrNo = -3
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
		A.CoaId = B.CoaId INNER JOIN PurchaseReceipt C ON B.SpmId = C.SpmId
		WHERE C.PurRcptRefNo = @PurRcptNo
-- 	SELECT @TaxAmt=ISNULL(SUM(T.TaxAmount),0)
-- 	FROM
-- 	(
-- 		SELECT C.InputTaxId,(B.TaxAmount/D.InvBaseQty)*D.ExsBaseQty AS TaxAmount
-- 	        FROM PurchaseReceipt A INNER JOIN PurchaseReceiptProductTax B ON A.PurRcptId = B.PurRcptId
-- 		INNER JOIN TaxConfiguration C ON B.TaxId = C.TaxId
-- 		INNER JOIN PurchaseReceiptProduct D ON A.PurRcptId=D.PurRcptId AND B.PrdSlNo=D.PrdSlNo
-- 		WHERE A.PurRcptRefNo = @PurRcptNo
-- 	) AS T		
	SELECT @VocRefNo AS VocRefNo,T.InputTaxId,1 AS DebitCredit,ISNULL(SUM(T.TaxAmount),0) AS Amount,
	1 AS Availability,@Pi_UserId AS LastModBy,Convert(varchar(10),Getdate(),121) AS LastModDate,
	@Pi_UserId AS AuthId,Convert(varchar(10),Getdate(),121) AS AuthDate
	INTO #DiffPurTax
	FROM
	(
	SELECT C.InputTaxId,(B.TaxAmount/D.InvBaseQty)*D.ExsBaseQty AS TaxAmount
	        FROM PurchaseReceipt A INNER JOIN PurchaseReceiptProductTax B ON
				A.PurRcptId = B.PurRcptId
			INNER JOIN TaxConfiguration C ON
				B.TaxId = C.TaxId
			INNER JOIN PurchaseReceiptProduct D ON
			      A.PurRcptId=D.PurRcptId AND B.PrdSlNo=D.PrdSlNo
			WHERE A.PurRcptRefNo = @PurRcptNo
	) AS T		
	Group By T.InputTaxId
	SELECT @TaxAmt=ISNULL(SUM(Amount),0) FROM #DiffPurTax
	SELECT @Amt=Prd.NetAmt-@TaxAmt
	FROM
	(
		SELECT SUM(d.PrdNetAmount/D.InvBaseQty*D.ExsBaseQty) AS NetAmt
		FROM PurchaseReceipt A
		INNER JOIN PurchaseReceiptProduct D ON
		      A.PurRcptId=D.PurRcptId
		WHERE A.PurRcptRefNo = @PurRcptNo
	) AS Prd
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt+@TaxAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @DiffAmt=(ROUND((@TaxAmt+@Amt),2)-(ROUND(@Amt,2)+ROUND(@TaxAmt,2)))
	
	UPDATE #DiffPurTax SET Amount=Amount+@DiffAmt
	WHERE InputTaxId IN (SELECT MIN(InputTaxId) FROM #DiffPurTax)
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate)
	SELECT * FROM #DiffPurTax
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt+@TaxAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Purchase Excess with Refusale Account in Details Table On Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4110005')
	BEGIN
		SET @Po_PurErrNo = -12
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4110005'
	
	--SELECT @Amt = Amount FROM CreditnoteSupplier WHERE CrNoteNumber = @CrNoteNo
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	UPDATE CreditnoteSupplier SET CoaId = @CoaId WHERE CrNoteNumber = @CrNoteNo
	SET @sStr = 'UPDATE CreditnoteSupplier SET CoaId = ' + CAST(@CoaId as nVarChar(10))+
		' WHERE CrNoteNumber = ''' + @Pi_ReferNo + ''''
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
--Cash Discount (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 1
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice WHERE
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cash Discount '
		+ @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
	BEGIN
		SET @Po_PurErrNo = -21
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220004'
		
	
	--For Posting Retailer Account details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Cash discount Details on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@DisCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@DisCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
--Cash Discount (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 5
BEGIN
	
	SELECT @InvRcpNo=InvRcpNo,@DebitNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice WHERE
		InvRcpSno=@Pi_ReferNo and CanCelStatus=1
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cash Discount '
		+ @InvRcpNo + '(Debit Note No: '+ @DebitNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and DbNoteNumber=@DebitNo )
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
	BEGIN
		SET @Po_PurErrNo = -21
		Return
	END
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI where
		R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and DbNoteNumber=@DebitNo
	SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220004'
		
	
	--For Posting Retailer Account details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Cash discount Details on Debit
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@DisCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@DisCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
--Cash Discount Cancel (Bill Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 0
BEGIN
	SELECT @InvRcpNo=InvRcpNo,@SalId=SalId,@SalInvAmt=SalInvAmt  FROM ReceiptInvoice
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	SELECT @SalInvNo =SalInvNo From SalesInvoice Where Salid=@SalId
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cash Discount Reversal '
		+ @InvRcpNo + '(Bill No: '+ @SalInvNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and SalId=@SalId)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
	BEGIN
		SET @Po_PurErrNo = -21
		Return
	END
			
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,SalesInVoice SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and SalId=@SalId
	SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220004'
	--For Posting Retailer Account details on Debit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Cash discount Details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@DisCoaId,2,@SalInvAmt,2,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@DisCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
--Cash Discount Cancel (Debit Invoice)
IF @Pi_TransId = 9 AND @Pi_SubTransId = 6
BEGIN
	SELECT @InvRcpNo=InvRcpNo,@DebitNo=DbNoteNumber,@SalInvAmt=DebitAmt  FROM DebitInvoice
		WHERE InvRcpSno=@Pi_ReferNo and CanCelStatus=0
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
		WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Receipt Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Receipt Cash Discount Reversal '
		+ @InvRcpNo + '(Debit Note No: '+ @DebitNo +')'+
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
	
	IF NOT Exists (	select distinct R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId and DbNoteNumber=@DebitNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
	BEGIN
		SET @Po_PurErrNo = -21
		Return
	END
			
	select distinct @RtrCoaId=R.coaid from Retailer R,CoaMaster c ,DebitNoteRetailer SI
		where R.availability=1 and R.RtrId=Si.Rtrid and R.CoaId=C.CoaId
		and DbNoteNumber=@DebitNo
	SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220004'
	--For Posting Retailer Account details on Debit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@RtrCoaId as nVarChar(10)) + ',1,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Cash discount Details on Credit
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@DisCoaId,2,@SalInvAmt,2,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@DisCoaId as nVarChar(10)) + ',2,' + CAST(@SalInvAmt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		RETURN
	END
END
IF @Pi_TransId=18	--Credit Note Retailer
BEGIN
	IF @Pi_SubTransId=1
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--Added By Maha on 25-08-2009
   		--Set Remarks as Configuration wise Creditnote Retailer
        SELECT @ConfigRemarks=Status FROM Configuration WHERE ModuleId='DBCRNOTE13'
        IF @ConfigRemarks=1 
		BEGIN
			SELECT  @Remarks=Remarks FROM CreditNoteRetailer WHERE CrNoteNumber=@Pi_ReferNo
		END
		ELSE
		BEGIN
			SET @Remarks='Posted From Credit Note Retailer ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121)
		END
		--Till Here	
		--For Posting CrNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,@Remarks,1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
		
	
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	
		--For Posting Credit Account in Details Table on Debit				
		SELECT @CoaId = CoaId FROM CreditNoteRetailer WHERE CrNoteNumber = @Pi_ReferNo
		IF NOT EXISTS (SELECT * FROM CrDbNoteTaxBreakup WHERE RefNo = @Pi_ReferNo AND
				TransId = @Pi_TransId)
		BEGIN
			SELECT @Amt = Amount FROM CreditNoteRetailer WHERE CrNoteNumber = @Pi_ReferNo
			
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
				',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''')'
		
			--INSERT INTO Translog(strSql1) Values (@sstr)				
		END
		ELSE
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,OutPutTaxId,1,TaxAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121) FROM CrDbNoteTaxBreakup A
			INNER JOIN TaxConfiguration B ON A.TaxId = B.TaxId AND RefNo = @Pi_ReferNo AND
				TransId = @Pi_TransId
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) SELECT
			''' + @VocRefNo + ''',OutPutTaxId,2,TaxAmt,1,' + CAST(@Pi_UserId as nVarChar(10)) +
				',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''' FROM CrDbNoteTaxBreakup(nolock) A
				INNER JOIN TaxConfiguration B ON A.TaxId = B.TaxId AND RefNo =''' + @Pi_ReferNo
				+ ''' TransId = ' + CAST(@Pi_TransId as nVarChar(10))
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,@CoaId,1,SUM(GrossAmt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121) FROM CrDbNoteTaxBreakup A
			WHERE RefNo = @Pi_ReferNo AND TransId = @Pi_TransId
		END
		--For Posting Retailer Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
			WHERE C.CrNoteNumber = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -13
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
			WHERE C.CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteRetailer WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)	
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=32
BEGIN
	IF @Pi_SubTransId=1
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
		
		--Added By Maha on 25-08-2009
   		--Set Remarks as Configuration wise Creditnote Supplier
        SELECT @ConfigRemarks=Status FROM Configuration WHERE ModuleId='DBCRNOTE11'
        IF @ConfigRemarks=1 
		BEGIN
			SELECT  @Remarks=Remarks FROM CreditNoteSupplier WHERE CrNoteNumber=@Pi_ReferNo
		END
		ELSE
		BEGIN
			SET @Remarks='Posted From Credit Note Supplier ' + @Pi_ReferNo + ' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121)
		END
		--Till Here	
		--For Posting CrNote Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,@Remarks,1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
			
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	
		--For Posting Credit Account in Details Table on Debit		
		SELECT @CoaId = CoaId FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		IF NOT EXISTS (SELECT * FROM CrDbNoteTaxBreakup WHERE RefNo = @Pi_ReferNo AND
				TransId = @Pi_TransId)
		BEGIN
			SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
			
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
		
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
			(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
				',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''')'
		
			--INSERT INTO Translog(strSql1) Values (@sstr)				
		END
		ELSE
		BEGIN
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,InputTaxId,1,TaxAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121) FROM CrDbNoteTaxBreakup A
			INNER JOIN TaxConfiguration B ON A.TaxId = B.TaxId AND RefNo = @Pi_ReferNo AND
				TransId = @Pi_TransId
			SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) SELECT
			''' + @VocRefNo + ''',InputTaxId,1,TaxAmt,1,' + CAST(@Pi_UserId as nVarChar(10)) +
				',''' + Convert(nvarchar(10),Getdate(),121) + ''','
				+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
				Convert(nvarchar(10),Getdate(),121) + ''' FROM CrDbNoteTaxBreakup(nolock) A
				INNER JOIN TaxConfiguration B ON A.TaxId = B.TaxId AND RefNo =''' + @Pi_ReferNo
				+ ''' TransId = ' + CAST(@Pi_TransId as nVarChar(10))
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
			SELECT @VocRefNo,@CoaId,1,SUM(GrossAmt),1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121) FROM CrDbNoteTaxBreakup A
			WHERE RefNo = @Pi_ReferNo AND TransId = @Pi_TransId
			
		END
		--For Posting Supplier Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)	
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=36 AND @Pi_SubTransId=1
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	--For Posting Credit Note Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Cheque Disbursal ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	--For Posting Window Display Account in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220005')
	BEGIN
		SET @Po_PurErrNo = -14
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220005'
	SELECT @Amt = Amount FROM ChequeDisbursalDetails WHERE ChqDisRefNo = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN Chequedisbursaldetails C (nolock) ON B.RtrId = C.RtrId
		WHERE C.ChqDisRefNo = @Pi_ReferNo)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN Chequedisbursaldetails C (nolock) ON B.RtrId = C.RtrId
		WHERE C.ChqDisRefNo = @Pi_ReferNo
	SELECT @Amt = Amount FROM ChequeDisbursalDetails WHERE ChqDisRefNo = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId=38	--Stock Journal
BEGIN
	IF @Pi_SubTransId=2
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting Stock Journal Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Stock Journal - Credit Note ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
		
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	
		--For Posting Credit Account in Details Table on Debit		
		SELECT @CoaId = CoaId FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)				
		
		--For Posting Supplier Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)	
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=14	--Batch Transfer
BEGIN
	IF @Pi_SubTransId=2
	BEGIN
		IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
		BEGIN
			SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
		END
		ELSE
		BEGIN
			SET @Po_PurErrNo = 0
			Return
		END
		SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	
		IF LTRIM(RTRIM(@VocRefNo)) = ''
		BEGIN
			SET @Po_PurErrNo = -1
			Return
		END
	
		--For Posting Batch Transfer Header Voucher
		INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
			LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
		(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Batch Transfer - Credit Note ' + @Pi_ReferNo +
			' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_UserId,
			Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
			
		UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	
		--For Posting Credit Account in Details Table on Debit			
		SELECT @CoaId = CoaId FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)				
		
		--For Posting Supplier Account in Details Table to Credit
	
		IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo)
		BEGIN
			SET @Po_PurErrNo = -3
			Return
		END
	
		SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Supplier B ON
			A.CoaId = B.CoaId INNER JOIN CreditNoteSupplier C ON B.SpmId = C.SpmId
			WHERE C.CrNoteNumber = @Pi_ReferNo
	
		SELECT @Amt = Amount FROM CreditNoteSupplier WHERE CrNoteNumber = @Pi_ReferNo
		
		INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
			@Pi_UserId,Convert(varchar(10),Getdate(),121))
	
		SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
			LastModDate,AuthId,AuthDate) VALUES
		(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
			',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
			+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
			Convert(nvarchar(10),Getdate(),121) + ''')'
	
		--INSERT INTO Translog(strSql1) Values (@sstr)	
		--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
		--Validate Credit amount is Equal to Debit
		IF NOT EXISTS (SELECT SUM(Amount) FROM(
			SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
				ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
				WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
			Having SUM(Amount) = 0)
		BEGIN
			SET @Po_PurErrNo = -6
			Return
		END
	END
END
IF @Pi_TransId=55 AND @Pi_SubTransId=1
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Sale Point Redemption Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Point Redemption ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	--For Posting Points Redemption Account in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220008')
	BEGIN
		SET @Po_PurErrNo = -25
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220008'
	SELECT @Amt = SUM(Amount) FROM CreditNoteRetailer B
	WHERE B.CrNoteNumber = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
		WHERE C.CrNoteNumber = @Pi_ReferNo AND C.Amount >0)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
		WHERE C.CrNoteNumber = @Pi_ReferNo AND C.Amount >0
	SELECT @Amt = SUM(Amount) FROM CreditNoteRetailer B
	WHERE B.CrNoteNumber = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId=62 AND @Pi_SubTransId=1
BEGIN
	IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
	BEGIN
		SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
			WHERE @Pi_VocDate between AcmSdt  and AcmEdt
	END
	ELSE
	BEGIN
		SET @Po_PurErrNo = 0
		Return
	END
	SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','JournalVoc',
		CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
	IF LTRIM(RTRIM(@VocRefNo)) = ''
	BEGIN
		SET @Po_PurErrNo = -1
		Return
	END
	
	--For Posting Coupon Redemption Header Voucher
	INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
		LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
	(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From Coupon Redemption ' + @Pi_ReferNo +
		' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_UserId,
		Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
	
	UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='JournalVoc'
	--For Posting Coupon Redemption Discount Allowed Account in Details Table on Debit
	IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220009')
	BEGIN
		SET @Po_PurErrNo = -24
		Return
	END
	SELECT @CoaId = CoaId FROM CoaMaster Where AcCode = '4220009'
-- 	SELECT @Amt = SUM(CrAmt) FROM CouponRedHd A INNER JOIN CouponRedOtherDt B
-- 	ON A.CpnRefId=B.CpnRefId WHERE A.CpnRedCode = @Pi_ReferNo
	SELECT @Amt = SUM(Amount) FROM CreditNoteRetailer B
	WHERE B.CrNoteNumber = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,1,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',1,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Retailer Account in Details Table to Credit
	IF NOT Exists (SELECT A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
		A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
		WHERE C.CrNoteNumber = @Pi_ReferNo AND C.Amount >0)
	BEGIN
		SET @Po_PurErrNo = -13
		Return
	END
	SELECT @CoaId = A.CoaId FROM CoaMaster A INNER JOIN Retailer B ON
	A.CoaId = B.CoaId INNER JOIN CreditNoteRetailer C ON B.RtrId = C.RtrId
	WHERE C.CrNoteNumber = @Pi_ReferNo AND C.Amount >0
	SELECT @Amt = SUM(Amount) FROM CreditNoteRetailer B
	WHERE B.CrNoteNumber = @Pi_ReferNo
	
	INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(@VocRefNo,@CoaId,2,@Amt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
		@Pi_UserId,Convert(varchar(10),Getdate(),121))
	SET @sStr = 'INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
		LastModDate,AuthId,AuthDate) VALUES
	(''' + @VocRefNo + ''',' + CAST(@CoaId as nVarChar(10)) + ',2,' + CAST(@Amt As nVarChar(25)) +
		',1,' + CAST(@Pi_UserId as nVarChar(10)) + ',''' + Convert(nvarchar(10),Getdate(),121) + ''','
		+ CAST(@Pi_UserId as nVarChar(10)) + ',''' +
		Convert(nvarchar(10),Getdate(),121) + ''')'
	--INSERT INTO Translog(strSql1) Values (@sstr)
	--For Posting Round Off Account Add in Details Table to Debit
		SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
		IF @sSql='-4'
		BEGIN
			SET @Po_PurErrNo = -4
			Return
		END
		ELSE IF @sSql='-5'
		BEGIN
			SET @Po_PurErrNo = -5
			Return
		END
		ELSE IF @sSql<>'0'
		BEGIN
			EXEC(@sSql)
		END
	--Validate Credit amount is Equal to Debit
	IF NOT EXISTS (SELECT SUM(Amount) FROM(
		SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
			ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
			WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
		Having SUM(Amount) = 0)
	BEGIN
		SET @Po_PurErrNo = -6
		Return
	END
END
IF @Pi_TransId = 271 AND @Pi_SubTransId = 1
BEGIN
	
	DECLARE VoucherReceiptCashDiscount_cursor CURSOR
	FOR  (
			SELECT IDTRcpno,IDTMngRefNo,IDTCashDiscAmt  FROM IDTReceiptInvoice WHERE
			IDTRcpno=@Pi_ReferNo  and IDTCashDiscAmt > 0
		 )
	OPEN VoucherReceiptCashDiscount_cursor
	FETCH NEXT FROM VoucherReceiptCashDiscount_cursor INTO @InvRcpNo,@IDTMngtNo,@SalInvAmt
	WHILE @@FETCH_STATUS = 0
	BEGIN	
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END
			SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','ReceiptVoc',
				CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
			IF LTRIM(RTRIM(@VocRefNo)) = ''
			BEGIN
				SET @Po_PurErrNo = -1
				Return
			END	
		
			--For Posting Receipt Header Voucher
			INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
				LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
				(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Receipt Cash Discount '
				+ @InvRcpNo + '(IDT  No: '+ @IDTMngtNo +')'+
				' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
			
			UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='ReceiptVoc'
			
			IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI where
							R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo =@IDTMngtNo )
			BEGIN
				SET @Po_PurErrNo = -13
				Return
			END
			IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
			BEGIN
				SET @Po_PurErrNo = -21
				Return
			END
			SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI where
				R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo = @IDTMngtNo
			--For Posting Retailer Account details on Credit
			
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
				(@VocRefNo,@RtrCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
			SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220004'
			--For Cash discount Details on Debit
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) 
			VALUES( @VocRefNo,@DisCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))

			--For Posting Round Off Account Add in Details Table to Debit
			SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
			IF @sSql='-4'
			BEGIN
				SET @Po_PurErrNo = -4
				Return
			END
			ELSE IF @sSql='-5'
			BEGIN
				SET @Po_PurErrNo = -5
				Return
			END
			ELSE IF @sSql<>'0'
			BEGIN
				EXEC(@sSql)
			END
			
			--Validate Credit amount is Equal to Debit
			IF NOT EXISTS (SELECT SUM(Amount) FROM(
				SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
					ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
				Having SUM(Amount) = 0)
			BEGIN
				SET @Po_PurErrNo = -6
				RETURN
			END
	FETCH NEXT FROM VoucherReceiptCashDiscount_cursor INTO   @InvRcpNo,@IDTMngtNo,@SalInvAmt
	END		
	CLOSE VoucherReceiptCashDiscount_cursor
	DEALLOCATE VoucherReceiptCashDiscount_cursor
END
		/*  Stock In */
IF @Pi_TransId = 271 AND @Pi_SubTransId = 2
BEGIN	
	DECLARE VoucherReceiptCashDiscountPay_cursor CURSOR
	FOR  (
			SELECT IDTRcpno,IDTMngRefNo,IDTCashDiscAmt  FROM IDTReceiptInvoice WHERE
			IDTRcpno=@Pi_ReferNo  and IDTCashDiscAmt > 0
		 )
	OPEN VoucherReceiptCashDiscountPay_cursor
	FETCH NEXT FROM VoucherReceiptCashDiscountPay_cursor INTO @InvRcpNo,@IDTMngtNo,@SalInvAmt
	WHILE @@FETCH_STATUS = 0
	BEGIN	
			IF EXISTS (SELECT AcpId from AcPeriod with (nolock) WHERE @Pi_VocDate between AcmSdt and AcmEdt)
			BEGIN
				SELECT @AcmId = AcmId ,@AcpId = AcpId from AcPeriod with (nolock)
				WHERE @Pi_VocDate between AcmSdt  and AcmEdt
			END
			ELSE
			BEGIN
				SET @Po_PurErrNo = 0
				Return
			END
			SELECT @VocRefNo = dbo.Fn_GetPrimaryKeyString('StdVocMaster','PaymentVoc',
			CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
			IF LTRIM(RTRIM(@VocRefNo)) = ''
			BEGIN
				SET @Po_PurErrNo = -1
				Return
			END	
		
			--For Posting Receipt Header Voucher
			INSERT INTO StdVocMaster(VocRefNo,AcmId,AcpId,VocType,VocDate,Remarks,Availability,LastModBy,
				LastModDate,AuthId,AuthDate,VocSubType,AutoGen,YEEntry) VALUES
				(@VocRefNo,@AcmId,@AcpId,@Pi_VocType,@Pi_VocDate,'Posted From IDT Payment Cash Discount '
				+ @InvRcpNo + '(IDT  No: '+ @IDTMngtNo +')'+
				' Dated ' + CONVERT(nVarChar(10),@Pi_VocDate,121),1,@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_UserId,
				Convert(varchar(10),Getdate(),121),@Pi_SubVocType,1,0)
			
			UPDATE Counters SET currvalue = currvalue + 1 WHERE Tabname = 'StdVocMaster' and fldname ='PaymentVoc'
			
			IF NOT Exists (	select distinct R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI where
							R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo =@IDTMngtNo )
			BEGIN
				SET @Po_PurErrNo = -13
				Return
			END
			IF NOT Exists (SELECT CoaId FROM CoaMaster Where AcCode = '4220004')
			BEGIN
				SET @Po_PurErrNo = -21
				Return
			END
			SELECT DISTINCT @RtrCoaId=R.coaid from IDTMaster R,CoaMaster c ,IDTManagement SI where
				R.availability=1 and R.SPMId=Si.SPMId and R.CoaId=C.CoaId and IDTMngRefNo = @IDTMngtNo
			--For Posting Retailer Account details on Credit
			
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
				LastModDate,AuthId,AuthDate) VALUES
				(@VocRefNo,@RtrCoaId,1,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
				@Pi_UserId,Convert(varchar(10),Getdate(),121))
			SELECT @DisCoaId=CoaId FROM CoaMaster Where AcCode = '4220003'
			--For Cash discount Details on Debit
			INSERT INTO StdVocDetails(VocRefNo,CoaId,DebitCredit,Amount,Availability,LastModBy,
						LastModDate,AuthId,AuthDate) 
			VALUES( @VocRefNo,@DisCoaId,2,@SalInvAmt,1,@Pi_UserId,Convert(varchar(10),Getdate(),121),
					@Pi_UserId,Convert(varchar(10),Getdate(),121))
			
			--For Posting Round Off Account Add in Details Table to Debit
			SELECT @sSql=dbo.Fn_PostRoundOff(@VocRefNo,@Pi_UserId)
			IF @sSql='-4'
			BEGIN
				SET @Po_PurErrNo = -4
				Return
			END
			ELSE IF @sSql='-5'
			BEGIN
				SET @Po_PurErrNo = -5
				Return
			END
			ELSE IF @sSql<>'0'
			BEGIN
				EXEC(@sSql)
			END

			--Validate Credit amount is Equal to Debit
			IF NOT EXISTS (SELECT SUM(Amount) FROM(
				SELECT DebitCredit,CASE DebitCredit WHEN 1 then Sum(Amount)
					ELSE -1 * Sum(Amount) END as Amount FROM StdVocDetails
					WHERE VocRefNo = @VocRefNo Group by DebitCredit) as a
				Having SUM(Amount) = 0)
			BEGIN
				SET @Po_PurErrNo = -6
				RETURN
			END
	FETCH NEXT FROM VoucherReceiptCashDiscountPay_cursor INTO   @InvRcpNo,@IDTMngtNo,@SalInvAmt
	END		
	CLOSE VoucherReceiptCashDiscountPay_cursor
	DEALLOCATE VoucherReceiptCashDiscountPay_cursor
END
IF @Po_PurErrNo=1
BEGIN
		EXEC Proc_PostStdDetails @Pi_VocDate,@VocRefNo,1
END
Return
END
GO
-----IDTMaster Report
DELETE FROM RptGroup WHERE RptId = 238
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName)
VALUES('MasterReports',238,'IDTReport','Inter Stock Foresight')
GO
DELETE FROM RptHeader WHERE RptId = 238
INSERT INTO RptHeader (GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
VALUES('IDTReport','Inter Stock Foresight',238,'Inter Stock Foresight','Proc_RptIDTReport',
'RptIDTReport','RptIDTReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId = 238
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(238,1,'Fromdate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(238,2,'Todate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(238,3,'IDTMaster',-1,NULL,'SpmId,SpmCode,SpmName','Distributors ...',NULL,1,NULL,279,1,0,
'Press F4/Double Click to Select Distributors',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(238,4,'IDTManagement',-1,NULL,'IDTMngRefNo,IDTMngRefNo,IDTMngRefNo','Reference No ...',NULL,1,0,280,1,0,
'Press F4/Double Click to Select Distributors',0)
GO
--To Insert RptExcelHeaders
DELETE FROM RptExcelHeaders WHERE RptId = 238
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,1,'PrdId','PrdId',0,1)
GO
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,2,'prod_code','prod_code',1,1)
GO
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,3,'prod_desc','prod_desc',1,1)
GO
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,4,'stock_units','stock_units',1,1)
GO
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,5,'MRP','MRP',1,1)
GO
INSERT INTO RptExcelHeaders(RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
VALUES(238,6,'IDTMngRefNo','IDTMngRefNo',0,1)
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'RPTIDTReport') AND type in (N'U'))
DROP TABLE RPTIDTReport
GO
CREATE TABLE RPTIDTReport
(
	[IDTMngRefNo] [nvarchar](50)  NULL,
	[PrdId] [int] NULL,
	[PrdCCode] [nvarchar](50)  NULL,
	[PrdName] [nvarchar](50)  NULL,
	[stock_units] [int] NULL,
	[MRP] [numeric](18, 2) NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_RptIDTReport') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_RptIDTReport
GO
--  EXEC Proc_RptIDTReport 249,2,0,'IDTREPORT',0,0,1
CREATE PROCEDURE Proc_RptIDTReport
( 
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT, 
	@Pi_DbName			Nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/****************************************************************************************************************
* PROCEDURE  : Proc_RptIDTReport
* PURPOSE    : To Generate IDT Details Report 
* CREATED BY : Panneerselvam.k
* CREATED ON : 03/05/2010
* MODIFICATION 
*****************************************************************************************************************   
* DATE			AUTHOR      DESCRIPTION   
*****************************************************************************************************************/ 
BEGIN
SET NOCOUNT ON

DECLARE @FromDate DateTime
DECLARE @ToDate DateTime
DECLARE @IDTRefNo nVarchar(50)
DECLARE @IDTSPmID INT 
DECLARE @ErrNo INT

SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate   = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @IDTSpmID =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,279,@Pi_UsrId))
SET @IDTRefNo =(SELECT  TOP 1 sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,280,@Pi_UsrId))

	DELETE FROM RPTIDTReport
	INSERT INTO  RPTIDTReport
	SELECT 
			A.IDTMngRefNo,B.PrdId,PrdCCode prod_code,
			PrdName prod_desc,Sum(Qty) stock_units,PrdMRPRate MRP
	FROM 
			IDTManagement A (nolock),IDTManagementProduct B (nolock),
			Product C (nolock),ProductBatch D (nolock)
	WHERE
			A.IDTMngRefNo	= B.IDTMngRefNo AND B.PrdId = C.PrdId
			AND B.PrdId		= D.PrdId AND B.PrdBatId = D.PrdBatId AND C.PrdId = D.PrdId
			AND A.IDTMngDate BETWEEN @FromDate AND @ToDate
			AND A.IDTMngRefNo	=  (CASE @IDTRefNo WHEN '0' THEN A.IDTMngRefNo ELSE @IDTRefNo END )  
			AND A.SpmId			=  (CASE @IDTSpmID WHEN 0 THEN A.SpmId ELSE @IDTSpmID END )
			AND A.Status = 1
	GROUP BY 
			A.IDTMngRefNo,B.PrdId,PrdCCode,PrdName,PrdMRPRate
	ORDER BY 
			A.IDTMngRefNo,PrdCCode

	--Check for Report Data
		Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RPTIDTReport
	-- Till Here
	Select PrdId,PrdCCode,PrdName,stock_units,MRP,IDTMngRefNo
	From RPTIDTReport Order by IDTMngRefNo,PrdCCode
END 
GO
DELETE FROM RptGroup WHERE RptId = 239
GO
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName)
VALUES('MasterReports',239,'IDTManagementReport','IDT Management Report')
GO
DELETE FROM RptHeader WHERE RptId = 239
GO
INSERT INTO RptHeader (GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
VALUES('IDTManagementReport','IDT Management Report',239,'IDT Management Report','Proc_RptIDTManagementReport',
'RptIDTManagementReport','RptIDTManagementReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId = 239
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,1,'Fromdate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,2,'Todate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,3,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','IDT Type* ...',NULL,1,NULL,281,1,1,
'Press F4/Double Click to Select IDT Type',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,4,'IDTMaster',-1,NULL,'SpmId,SpmCode,SpmName','From Distributor ...',NULL,1,NULL,282,1,0,
'Press F4/Double Click to Select Distributors',0)
GO

INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,5,'Distributor',-1,NULL,'DistributorId,DistributorCode,DistributorName','To Distributor ...',
NULL,1,0,283,1,0,'Press F4/Double Click to Select Distributors',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,6,'Location',-1,NULL,'LcnId,LcnCode,LcnName','Location ...',NULL,1,0,22,1,0,
'Press F4/Double Click to Select Location',0)
GO
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,
CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange)
VALUES(239,7,'IDTManagement',-1,NULL,'IDTMngRefNo,IDTMngRefNo,IDTMngRefNo','Reference No ...',NULL,1,0,280,1,0,
'Press F4/Double Click to Select Distributors',0)
GO
DELETE From RptFilter WHERe RptId = 239
GO
INSERT INTO RptFilter (RptId,SelcId,FilterId,FilterDesc)
Values(239,281,1,'IDT IN')
GO
INSERT INTO RptFilter (RptId,SelcId,FilterId,FilterDesc)
Values(239,281,2,'IDT OUT')
GO
Delete From RptFormula Where RptId = 239
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,1,'Disp_FromDate','From Date',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,2,'Fill_FromDate','From Date',1,10)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,3,'Disp_ToDate','To Date',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,4,'Fill_ToDate','To Date',1,11)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,5,'Disp_IDTType','IDT Type',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,6,'Fill_IDTType','IDT Type',1,281)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,7,'Disp_FDist','From Distributor',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,8,'Fill_FDist','FromDistributor',1,282)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,9,'Disp_TDist','To Distributor',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,10,'Fill_TDist','To Distributor',1,283)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,11,'Disp_Location','Location',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,12,'Fill_Location','Location',1,22)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,13,'Disp_RefNo','Reference Number',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,14,'Fill_RefNo','ReferenceNumber',1,280)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,15,'Disp_Date','Date',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,16,'Disp_PCode','Product Code',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,17,'Disp_PName','Product Name',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,18,'Disp_Batch','Batch',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,19,'Disp_Rate','Rate',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,20,'Disp_Qty','Qty',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,21,'Disp_Gross','Gross Amount',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,22,'Disp_Tax','Tax Amount',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,23,'Disp_IDTCharges','IDT Charges',1,0)
GO
INSERT INTO RptFormula(RptId,SlNo,Formula,FormulaValue,LcId,SelcId)
VALUES(239,24,'Disp_NetAmount','Net Amount',1,0)
GO
IF NOT EXISTS (SELECT * FROM DependencyTable WHERE PrimaryTable='IDTMaster' AND RelatedTable='IDTManagement')
BEGIN
INSERT INTO DependencyTable 
SELECT 'IDTMaster','IDTManagement','SpmId'
END
GO
Delete From RptExcelHeaders Where RptId = 239
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,1,'IDTMngRefNo','Reference Number',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,2,'IDTMngDate','Date',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,3,'PrdId','PrdId',0,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,4,'PrdDCode','Product Code',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,5,'PrdName','Product Name',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,6,'PrdBatId','PrdBatId',0,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,7,'PrdbatCode','Batch',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,8,'MRP','MRP',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,9,'ListPrice','List Price',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,10,'Qty','Qty',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,11,'PrdGrossAmount','Gross Amount',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,12,'PrdTaxAmount','Tax Amount',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,13,'IDTCharges','IDT Charges',1,0)
GO
INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)
Values(239,14,'PrdNetAmount','Net Amount',1,0)
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_RptIDTManagementReport') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_RptIDTManagementReport
GO
-- EXEC Proc_RptIDTManagementReport 250,2,0,'LR',0,0,1
CREATE PROCEDURE Proc_RptIDTManagementReport
( 
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT, 
	@Pi_DbName			Nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/****************************************************************************************************************
* PROCEDURE  : Proc_RptIDTManagementReport
* PURPOSE    : To Generate IDT Details Report 
* CREATED BY : Panneerselvam.k
* CREATED ON : 12/05/2010
* MODIFICATION 
*****************************************************************************************************************   
* DATE			AUTHOR      DESCRIPTION   
*****************************************************************************************************************/ 
BEGIN
SET NOCOUNT ON

DECLARE @NewSnapId 	AS	INT
DECLARE @DBNAME		AS 	nvarchar(50)
DECLARE @TblName 	AS	nvarchar(500)
DECLARE @TblStruct 	AS	nVarchar(4000)
DECLARE @TblFields 	AS	nVarchar(4000)
DECLARE @sSql		AS 	nVarChar(4000)
DECLARE @ErrNo	 	AS	INT
DECLARE @PurDBName	AS	nVarChar(50)

DECLARE @FromDate DateTime
DECLARE @ToDate DateTime
DECLARE @IDTStockTypeId INT
DECLARE @IDTFromDistId INT
DECLARE @IDTToDistId INT
DECLARE @LocationId INT
DECLARE @IDTRefNo nVarchar(50)
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)


SELECT @FromDate	= dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate		= dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @IDTStockTypeId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,281,@Pi_UsrId))
SET @IDTFromDistId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,282,@Pi_UsrId))
SET @IDTToDistId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,283,@Pi_UsrId))
SET @LocationId		=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
SET @IDTRefNo		=(SELECT  TOP 1 sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,280,@Pi_UsrId))

IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END

	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN

		CReate Table #TempIDTManagement(IDTMngRefNo Varchar(100),IDTMngDate Datetime,PrdId INT,PrdDCode Varchar(100),
					PrdName Varchar(100),PrdBatId INT, PrdbatCode varchar(100),MRP Numeric(18,2), ListPrice Numeric(18,2),
					Qty INT,PrdGrossAmount Numeric(18,2),PrdTaxAmount Numeric(18,2),
					IDTCharges Numeric(18,2),PrdNetAmount Numeric(18,2))

		DELETE FROM #TempIDTManagement    
		IF @IDTStockTypeId = 1
		BEGIN
				INSERT INTO #TempIDTManagement
				SELECT DISTINCT 
						A.IDTMngRefNo,IDTMngDate,B.PrdId,PrdDCode,PrdName,B.PrdBatId,PrdbatCode,
						PrdMRPRate MRP,PrdUnitRate ListPrice,Qty,PrdGrossAmount,PrdTaxAmount,
						LineBaseQtyAmount IDTCharges,PrdNetAmount				
				FROM 
						IDTManagement A,IDTManagementProduct B,IDTManagementLineAmount C,
						Product P,ProductBatch PB,IDTMaster I,Distributor D				
				WHERE	A.IDTMngRefNo = B.IDTMngRefNo and A.IDTMngRefNo = C.IDTMngRefNo 
						AND B.IDTMngRefNo = C.IDTMngRefNo and  B.PrdId = P.PrdId   
						AND B.PrdBatId = PB.PrdBatId      and  B.PrdId = PB.PrdId
						AND RefCode = 'E' and StkMgmtTypeId = 1 AND B.PrdSlNo = C.PrdSlNo
						AND A.FromSpmId = I.SpmId  and D.DistributorId = A.ToSpmId
						AND A.IDTMngDate BETWEEN @FromDate AND @ToDate
						AND A.IDTMngRefNo		=  (CASE @IDTRefNo WHEN '0' THEN A.IDTMngRefNo ELSE @IDTRefNo END )  
						AND A.FromSpmId			=  (CASE @IDTFromDistId WHEN 0 THEN A.FromSpmId ELSE @IDTFromDistId END )
						AND A.ToSpmId			=  (CASE @IDTToDistId   WHEN 0 THEN A.ToSpmId ELSE @IDTToDistId END )
						AND A.LcnId				=  (CASE @LocationId   WHEN 0 THEN A.LcnId ELSE @LocationId END )
						AND A.Status = 1
		END

		IF @IDTStockTypeId = 2
		BEGIN
				INSERT INTO #TempIDTManagement
				SELECT DISTINCT 
						A.IDTMngRefNo,IDTMngDate,B.PrdId,PrdDCode,PrdName,B.PrdBatId,PrdbatCode,
						PrdMRPRate MRP,PrdUnitRate ListPrice,Qty,PrdGrossAmount,PrdTaxAmount,
						LineBaseQtyAmount IDTCharges,PrdNetAmount			
				FROM 
						IDTManagement A,IDTManagementProduct B,IDTManagementLineAmount C,
						Product P,ProductBatch PB,IDTMaster I,Distributor D				
				WHERE	A.IDTMngRefNo = B.IDTMngRefNo and A.IDTMngRefNo = C.IDTMngRefNo 
						AND B.IDTMngRefNo = C.IDTMngRefNo and  B.PrdId = P.PrdId   
						AND B.PrdBatId = PB.PrdBatId      and  B.PrdId = PB.PrdId
						AND RefCode = 'E' and StkMgmtTypeId = 2 AND B.PrdSlNo = C.PrdSlNo
						AND A.FromSpmId = D.DistributorId  and I.SpmId = A.ToSpmId
						AND A.IDTMngDate BETWEEN @FromDate AND @ToDate
						AND A.IDTMngRefNo		=  (CASE @IDTRefNo WHEN '0' THEN A.IDTMngRefNo ELSE @IDTRefNo END )  
						AND A.FromSpmId			=  (CASE @IDTFromDistId WHEN 0 THEN A.FromSpmId ELSE @IDTFromDistId END )
						AND A.ToSpmId			=  (CASE @IDTToDistId   WHEN 0 THEN A.ToSpmId ELSE @IDTToDistId END )
						AND A.LcnId				=  (CASE @LocationId   WHEN 0 THEN A.LcnId ELSE @LocationId END )
						AND A.Status = 1
		END

		--Check for Report Data
		Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #TempIDTManagement
		-- Till Here

		Select * from #TempIDTManagement order by IDTMngRefNo
	END
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_ProductTrackDetails') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_ProductTrackDetails
GO
---Exec Proc_ProductTrackDetails 2,'2011-03-19','2011-03-19' 
CREATE PROCEDURE Proc_ProductTrackDetails
(
	 @Pi_UsrId INT,
	 @Pi_FromDate DATETIME,
	 @Pi_ToDate DATETIME
)
AS
/*********************************
* PROCEDURE	: Proc_ProductTrackDetails
* PURPOSE	: To Return the Product transaction details
* CREATED	: MarySubashini.S
* CREATED DATE	: 01/08/2008
* NOTE		: General SP Returning the Product transaction details
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}     {developer}  {brief modification description}
* 03/02/2009 Nanda	  Added Sample management
*********************************/
SET NOCOUNT ON
BEGIN
	SELECT TransDate,PrdId,PrdBatId,ISNULL(LcnId,0) AS LcnId,SUM(SalOpenStock) SalOpenStock,
	SUM(UnSalOpenStock) UnSalOpenStock,SUM(OfferOpenStock) OfferOpenStock INTO #OpenStk FROM StockLedger
	WHERE TransDate in (SELECT MAX(TransDate) FROM StockLedger WHERE TransDate <= @Pi_FromDate)
	GROUP BY TransDate,PrdId,PrdBatId,LcnId
		
	SELECT TransDate,PrdId,PrdBatId,LcnId,SUM(SalClsStock) SalClsStock,SUM(UnSalClsStock) UnSalClsStock,
	SUM(OfferClsStock) OfferClsStock INTO #CloseStk FROM StockLedger
	WHERE TransDate in (SELECT MAX(TransDate) FROM StockLedger WHERE TransDate <= @Pi_ToDate)
	GROUP BY TransDate,PrdId,PrdBatId,LcnId
	
	DELETE FROM RptProductTrack WHERE UsrId IN(0,@Pi_UsrId)
	INSERT INTO RptProductTrack(LevelValId,LevelValName,LevelId,LevelName,CmpId,CmpName,PrdId,
	PrdName,PrdBatId,PrdBatCode,SalQty,UnSalQty,OfferQty,TransactionType,
	TransactionNumber,TransactionDate,UsrId,SlNo,LcnId)
	--Opening Stock
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		ISNULL(O.SalOpenStock,0),ISNULL(O.UnSalOpenStock,0),
		ISNULL(O.OfferOpenStock,0),
		'Opening Stock' ,'',@Pi_FromDate ,@Pi_UsrId,1,ISNULL(O.LcnId,0)
		FROM
		PrdHirarchy PH
		LEFT OUTER JOIN #OpenStk O ON PH.PrdId = O.PrdId AND PH.PrdBatId = O.PrdBatId
	UNION ALL
	--Stock Mng (In)		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.TotalQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.TotalQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.TotalQty ELSE 0 END ) AS OfferStock,
		'Stock Management  Add',M.StkMngRefNo,M.StkMngDate,@Pi_UsrId,2,S.LcnId
		FROM
		StockManagement M
		INNER JOIN StockManagementProduct D ON M.StkMngRefNo = D.StkMngRefNo
--		INNER JOIN StockManagementType SMT ON SMT.StkMgmtTypeId=M.StkMgmtTypeId AND SMT.TransactionType=0
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.Status=1 AND M.StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		and D.StkMgmtTypeId = 1
	UNION ALL
	--Stock Mng (Out)	
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*D.TotalQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*D.TotalQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*D.TotalQty ELSE 0 END ) AS OfferStock,
		'Stock Management  Reduce' ,M.StkMngRefNo,M.StkMngDate,@Pi_UsrId,3,S.LcnId
		FROM
		StockManagement M
		INNER JOIN StockManagementProduct D ON M.StkMngRefNo = D.StkMngRefNo
------		INNER JOIN StockManagementType SMT ON SMT.StkMgmtTypeId=M.StkMgmtTypeId AND SMT.TransactionType=1
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.Status=1 AND  M.StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		and D.StkMgmtTypeId = 2
	UNION ALL
	--Lcn Trans
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*D.TransferQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*D.TransferQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*D.TransferQty ELSE 0 END ) AS OfferStock,
		'Location Transfer Out' ,M.LcnRefNo,M.LcnTrfDate,@Pi_UsrId,4,M.FromLcnId
		FROM
		LocationTransferMaster M
		INNER JOIN LocationTransferDetails D ON M.LcnRefNo = D.LcnRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.LcnTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Lcn Trans
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.TransferQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.TransferQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.TransferQty ELSE 0 END ) AS OfferStock,
		'Location Transfer In' ,M.LcnRefNo,M.LcnTrfDate,@Pi_UsrId,5,M.ToLcnId
		FROM
		LocationTransferMaster M
		INNER JOIN LocationTransferDetails D ON M.LcnRefNo = D.LcnRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.LcnTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	-- Bat Tran (In)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*T.TrfQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*T.TrfQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*T.TrfQty ELSE 0 END ) AS OfferStock,
		'Batch Transfer Out',T.BatRefNo,T.BatTrfDate,@Pi_UsrId,6,S.LcnId
		FROM
		BatchTransfer T INNER JOIN StockType S On T.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH On T.PrdId = PH.PrdId AND T.FromBatId = PH.PrdBatId
		WHERE T.BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	-- Bat Tran (Out)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN T.TrfQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN T.TrfQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN T.TrfQty ELSE 0 END ) AS OfferStock,
		'Batch Transfer In',T.BatRefNo,T.BatTrfDate,@Pi_UsrId,7,S.LcnId
		FROM
		BatchTransfer T INNER JOIN StockType S On T.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH On T.PrdId = PH.PrdId AND T.ToBatId = PH.PrdBatId
		WHERE T.BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Salvage
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*D.SalvageQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*D.SalvageQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*D.SalvageQty ELSE 0 END ) AS OfferStock,
		'Salvage' TransType ,M.SalvageRefNo,M.SalvageDate,@Pi_UsrId,8,S.LcnId
		FROM
		Salvage M
		INNER JOIN SalvageProduct D ON M.SalvageRefNo = D.SalvageRefNo
		INNER JOIN StockType S ON M.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.Status=1 AND M.SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Stock journal (Out)		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*D.StkTransferQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*D.StkTransferQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*D.StkTransferQty ELSE 0 END ) AS OfferStock,
		'Stock Journal' TransType ,M.StkJournalRefNo,M.StkJournalDate,@Pi_UsrId,9,S.LcnId
		FROM
		StockJournal M
		INNER JOIN StockJournalDt D ON M.StkJournalRefNo = D.StkJournalRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON M.PrdId = PH.PrdId AND M.PrdBatId = PH.PrdBatId
		WHERE M.StkJournalDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Stock journal(In)		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.StkTransferQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.StkTransferQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.StkTransferQty ELSE 0 END ) AS OfferStock,
		'Stock Journal' TransType ,M.StkJournalRefNo,M.StkJournalDate,@Pi_UsrId,10,S.LcnId
		FROM
		StockJournal M
		INNER JOIN StockJournalDt D ON M.StkJournalRefNo = D.StkJournalRefNo
		INNER JOIN StockType S ON D.TransferStkTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON M.PrdId = PH.PrdId AND M.PrdBatId = PH.PrdBatId
		WHERE M.StkJournalDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Ret to cmp
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN CAST((-1)*D.RtnQty AS INT) ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN CAST((-1)*D.RtnQty AS INT) ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN CAST((-1)*D.RtnQty AS INT) ELSE 0 END ) AS OfferStock,
		'Return To Company' TransType ,
		M.RtnCmpRefNo TransNo,M.RtnCmpDate TransDate,@Pi_UsrId,11,S.LcnId
		FROM
		ReturnToCompany M
		INNER JOIN ReturnToCompanyDt D ON M.RtnCmpRefNo = D.RtnCmpRefNo
		INNER JOIN StockType S ON M.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	--Ret and replacement
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.RtnQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.RtnQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.RtnQty ELSE 0 END ) AS OfferStock,
		'Return and Replacement  Return',M.RepRefNo,M.RepDate,@Pi_UsrId,12,S.LcnId
		FROM
		ReplacementHd M
		INNER JOIN ReplacementIn D ON M.RepRefNo = D.RepRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.RepDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Ret and replacement(Out)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*D.RepQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN (-1)*D.RepQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN (-1)*D.RepQty ELSE 0 END ) AS OfferStock,
		'Return and Replacement  Replacement',M.RepRefNo,M.RepDate,@Pi_UsrId,13,S.LcnId
		FROM
		ReplacementHd M
		INNER JOIN ReplacementOut D ON M.RepRefNo = D.RepRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.RepDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--Resell Damage Goods
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,(-1)*D.Quantity,0,
		'Resell Damage Goods',M.ReDamRefNo,M.ReSellDate,@Pi_UsrId,14,M.LcnId
		FROM
		ReSellDamageMaster M
		INNER JOIN ReSellDamageDetails D ON M.ReDamRefNo = D.ReDamRefNo
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	--VanLoad&Unload
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.TransQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.TransQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.TransQty ELSE 0 END ) AS OfferStock,
		'Van Load',M.VanLoadRefNo,M.TransferDate,@Pi_UsrId,15,S.LcnId
		FROM
		VanLoadUnloadMaster M
		INNER JOIN VanLoadUnloadDetails D ON M.VanLoadRefNo = D.VanLoadRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.VanLoadUnload = 0 AND M.TransferDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	--VanLoad&Unload (Unload)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN D.TransQty ELSE 0 END ) AS SalStock,
		(CASE S.SystemStockType WHEN 2 THEN D.TransQty ELSE 0 END ) AS UnSalStock,
		(CASE S.SystemStockType WHEN 3 THEN D.TransQty ELSE 0 END ) AS OfferStock,
		'Van Unload',M.VanLoadRefNo,M.TransferDate,@Pi_UsrId,16,S.LcnId
		FROM
		VanLoadUnloadMaster M
		INNER JOIN VanLoadUnloadDetails D ON M.VanLoadRefNo = D.VanLoadRefNo
		INNER JOIN StockType S ON D.StockTypeId = S.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.VanLoadUnload = 1 AND M.TransferDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	UNION ALL
	-- Sales		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(-1)*D.BaseQty,0,0,
		'Sales',M.SalInvNo,M.SalInvDate,@Pi_UsrId,17,M.LcnId
		FROM
		SalesInvoice M
		INNER JOIN  SalesInvoiceProduct D ON M.SalId = D.SalId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
		WHERE M.SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.DlvSts IN (4,5)
	UNION ALL
	-- Free
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,(-1)*D.FreeQty,
		'Sales Free',M.SalInvNo,M.SalInvDate,@Pi_UsrId,18,M.LcnId
		FROM
		SalesInvoice M
		INNER JOIN SalesInvoiceSchemeDtFreePrd D ON M.SalId = D.SalId
		INNER JOIN PrdHirarchy PH ON D.FreePrdId = PH.PrdId AND D.FreePrdBatId = PH.PrdBatId
		WHERE M.SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.DlvSts IN (4,5)
	UNION ALL
	-- Free
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,(-1)*D.SalManFreeQty,
		'Sales Free',M.SalInvNo,M.SalInvDate,@Pi_UsrId,19,M.LcnId
		FROM
		SalesInvoice M
		INNER JOIN  SalesInvoiceProduct D ON M.SalId = D.SalId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
		WHERE M.SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.DlvSts IN (4,5)
	UNION ALL
	-- Gift
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,(-1)*D.GiftQty,
		'Sales Gift',M.SalInvNo,M.SalInvDate,@Pi_UsrId,20,M.LcnId
		FROM
		SalesInvoice M
		INNER JOIN SalesInvoiceSchemeDtFreePrd D ON M.SalId = D.SalId
		INNER JOIN PrdHirarchy PH ON D.GiftPrdId = PH.PrdId AND D.GiftPrdBatId = PH.PrdBatId
		WHERE M.SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.DlvSts IN (4,5)
	UNION ALL
	--Pur (sal)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		D.RcvdGoodBaseQty,0,0,
		'Purchase',M.PurRcptRefNo,M.GoodsRcvdDate,@Pi_UsrId,21,M.LcnId
		FROM
		PurchaseReceipt M
		INNER JOIN PurchaseReceiptProduct D ON M.PurRcptId = D.PurRcptId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	--Pur (unsal)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,E.BaseQty,0,
		'Purchase',M.PurRcptRefNo,M.GoodsRcvdDate,@Pi_UsrId,22,S.LcnId
		FROM
		PurchaseReceipt M
		INNER JOIN PurchaseReceiptProduct D ON M.PurRcptId = D.PurRcptId
		INNER JOIN PurchaseReceiptBreakup E ON E.PurRcptId = D.PurRcptId
		AND D.PrdSlNo=E.PrdSlNo AND E.BreakUpType=1
		INNER JOIN StockType S ON S.StockTypeId = E.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE  M.GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	--Pur (Excess)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE S.SystemStockType WHEN 1 THEN (-1)*E.BaseQty ELSE 0 END),
		(CASE S.SystemStockType WHEN 2 THEN (-1)*E.BaseQty ELSE 0 END),0,
		'Purchase',M.PurRcptRefNo,M.GoodsRcvdDate,@Pi_UsrId,23,S.LcnId
		FROM
		PurchaseReceipt M
		INNER JOIN PurchaseReceiptProduct D ON M.PurRcptId = D.PurRcptId
		INNER JOIN PurchaseReceiptBreakup E ON E.PurRcptId = D.PurRcptId
		AND D.PrdSlNo=E.PrdSlNo AND E.BreakUpType=2
		INNER JOIN StockType S ON S.StockTypeId = E.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE  M.GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1 AND D.RefuseSale=1
	UNION ALL
	-- pur Free
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,D.Quantity,
		'Purchase Free',M.PurRcptRefNo,M.GoodsRcvdDate,@Pi_UsrId,24,M.LcnId
		FROM
		PurchaseReceipt M
		INNER JOIN PurchaseReceiptClaimScheme D ON M.PurRcptId = D.PurRcptId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND D.TypeId=2 AND M.Status=1
	UNION ALL
	-- Pur ret (sal)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(-1)*D.RetSalBaseQty,0,0,
		'Purchase Return',M.PurRetRefNo,M.PurRetDate,@Pi_UsrId,25,M.LcnId
		FROM PurchaseReturn M INNER JOIN PurchaseReturnProduct D ON M.PurRetId = D.PurRetId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	-- Pur ret (unsal)
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,(-1)*E.ReturnBsQty,0,
		'Purchase Return',M.PurRetRefNo,M.PurRetDate,@Pi_UsrId,26,S.LcnId
		FROM
		PurchaseReturn M
		INNER JOIN PurchaseReturnProduct D ON M.PurRetId = D.PurRetId
		INNER JOIN PurchaseReturnBreakup E ON E.PurRetId = D.PurRetId
		AND D.PrdSlNo=E.PrdSlNo AND E.BreakUpType=1
		INNER JOIN StockType S ON S.StockTypeId = E.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE  M.PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	-- Pur Ret Free
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,(-1)*D.RetQty,
		'Purchase Return Free',M.PurRetRefNo,M.PurRetDate,@Pi_UsrId,27,M.LcnId
		FROM
		PurchaseReturn M
		INNER JOIN PurchaseReturnClaimScheme D ON M.PurRetId = D.PurRetId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND D.TypeId=2 AND M.Status=1		
	UNION ALL
	-- Sales Ret
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		(CASE ST.SystemStockType WHEN 1 THEN D.BaseQty ELSE 0 END ) AS SalStock,
		(CASE ST.SystemStockType WHEN 2 THEN D.BaseQty ELSE 0 END ) AS UnSalStock,
		(CASE ST.SystemStockType WHEN 3 THEN D.BaseQty ELSE 0 END ) AS OfferStock,
		'Sales Return',M.ReturnCode,M.ReturnDate,@Pi_UsrId,28,ST.LcnId
		FROM ReturnHeader M
		INNER JOIN ReturnProduct D ON M.Returnid = D.ReturnId
		INNER JOIN StockType ST ON D.StockTypeId = ST.StockTypeId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=0
	UNION ALL
	--Sample Receipt
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,D.RcvdGoodBaseQty,
		'Sample Receipt',M.PurRcptRefNo,M.GoodsRcvdDate,@Pi_UsrId,29,M.LcnId
		FROM
		SamplePurchaseReceipt M
		INNER JOIN SamplePurchaseReceiptProduct D ON M.PurRcptId = D.PurRcptId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId AND D.PrdBatId = PH.PrdBatId
		WHERE M.GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	UNION ALL
	--Sample Issue		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,(-1)*D.IssueBaseQty,
		'Sample Issue',M.IssueRefNo,M.IssueDate,@Pi_UsrId,30,M.LcnId
		FROM
		SampleIssueHd M
		INNER JOIN  SampleIssueDt D ON M.IssueId = D.IssueId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
		WHERE M.IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1
	
	UNION ALL
		SELECT
			PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
			PH.CmpPrdCtgName,
			PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
			0,0,(-1)*D.IssueBaseQty,
			'Sample Issue',M.IssueRefNo,M.IssueDate,@Pi_UsrId,30,M.LcnId
		FROM 
			FreeIssueHd M 
			INNER JOIN FreeIssueDt D ON M.IssueId = D.IssueId
			INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
		WHERE 
			M.IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
			AND M.Status=1 and StockType = 0
	----Sample Issue Saleable	
		UNION ALL
			SELECT
				PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
				PH.CmpPrdCtgName,
				PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
				(-1)*D.IssueBaseQty,0,0,
				'Sample Issue',M.IssueRefNo,M.IssueDate,@Pi_UsrId,30,M.LcnId
			FROM 
				FreeIssueHd M 
				INNER JOIN FreeIssueDt D ON M.IssueId = D.IssueId
				INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
			WHERE 
				M.IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
				AND M.Status=1 and StockType = 1
	
		UNION ALL
	--Sample Return		
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		0,0,D.ReturnBaseQty,
		'Sample Return',M.ReturnRefNo,M.ReturnDate,@Pi_UsrId,31,M.LcnId
		FROM
		SampleReturnHd M
		INNER JOIN  SampleReturnDt D ON M.ReturnId = D.ReturnId
		INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
		WHERE M.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
		AND M.Status=1	
--IDT IN
		UNION ALL
		SELECT
				PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
				PH.CmpPrdCtgName,
				PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
				D.Qty,0,0,
				'IDT',M.IDTMngRefNo,M.IDTMngDate,@Pi_UsrId,32,M.LcnId
			FROM 
				IDTManagement M 
				INNER JOIN IDTManagementProduct D ON M.IDTMngRefNo = D.IDTMngRefNo
				INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
			WHERE 
				M.IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
				AND M.Status=1 and StkMgmtTypeId = 1

		----IDT OUT 
		UNION ALL
		SELECT
				PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
				PH.CmpPrdCtgName,
				PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
				(-1) * D.Qty,0,0,
				'IDT',M.IDTMngRefNo,M.IDTMngDate,@Pi_UsrId,32,M.LcnId
			FROM 
				IDTManagement M 
				INNER JOIN IDTManagementProduct D ON M.IDTMngRefNo = D.IDTMngRefNo
				INNER JOIN PrdHirarchy PH ON D.PrdId = PH.PrdId and D.PrdBatId = PH.PrdBatId
			WHERE 
				M.IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
				AND M.Status=1 and StkMgmtTypeId = 2
	UNION ALL --Closing Stock
	SELECT
		PH.PrdCtgValMainId ,PH.PrdCtgValName ,PH.CmpPrdCtgId ,
		PH.CmpPrdCtgName,
		PH.CmpId,PH.CmpName,PH.PrdId,PH.PrdName,PH.PrdBatId,PH.PrdBatCode,
		ISNULL(C.SalClsStock,0),
		ISNULL(C.UnSalClsStock,0),ISNULL(C.OfferClsStock,0),
		'Closing Stock' ,'',@Pi_ToDate ,@Pi_UsrId,32,ISNULL(C.LcnId,0)
		FROM
		PrdHirarchy PH
		LEFT OUTER JOIN #CloseStk C ON PH.PrdId = C.PrdId AND PH.PrdBatId = C.PrdBatId
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_RptProductTrackDetails') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_RptProductTrackDetails
GO
--EXEC Proc_RptProductTrackDetails 41,2,0,'Loreal',0,0,1
CREATE PROCEDURE Proc_RptProductTrackDetails
(
	@Pi_RptId  INT,
	@Pi_UsrId  INT,
	@Pi_SnapId  INT,
	@Pi_DbName  nvarchar(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap  INT,
	@Pi_CurrencyId  INT
)
AS
/***************************************************************************************************
* PROCEDURE : Proc_RptProductTrackDetails
* PURPOSE : To Return the Product transaction details
* CREATED : MarySubashini.S
* CREATED DATE : 01/08/2008
* NOTE  : General SP Returning the Product transaction details
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
---------------------------------------------------------------------------------------------------
* {date}     {developer}  {brief modification description}
* 06.11.2009 Aarthi       Added TransactionDate to Asc Format
***************************************************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  nvarchar(50)
	DECLARE @TblName  AS nvarchar(500)
	DECLARE @TblStruct  AS nVarchar(4000)
	DECLARE @TblFields  AS nVarchar(4000)
	DECLARE @sSql  AS  nVarChar(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS nVarChar(50)
	--Filter Variable
	DECLARE @FromDate			AS DATETIME
	DECLARE @ToDate				AS DATETIME
	DECLARE @CmpId				AS Int
	DECLARE @CmpPrdCtgId		AS Int
	DECLARE @PrdCtgMainId		AS Int
	DECLARE @PrdId				AS INT
	DECLARE @PrdCatPrdId        AS  INT
	DECLARE @LcnId				AS INT
	DECLARE @SupZeroStock		AS INT
	DECLARE @ZeroStockRecCount  AS INT
	--Till Here
	--Assgin Value for the Filter Variable
	SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId  
	SET @PrdCatPrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))  

	SET @PrdId = (SELECT  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @SupZeroStock = (SELECT  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))
	EXEC Proc_ProductTrackDetails @Pi_UsrId,@FromDate,@ToDate
	CREATE TABLE #RptProductTrackDetails
	(
		TransactionDate  DATETIME,
		TransactionType  NVARCHAR(300),
		TransactionNumber  NVARCHAR(100),
		SalQty     NUMERIC(38,0),
		UnSalQty   NUMERIC(38,0),
		OfferQty   NUMERIC(38,0),
		SlNo    INT ,
		PrdId Int
	)
	SET @TblName = 'RptProductTrackDetails'
	SET @TblStruct = '	TransactionDate  DATETIME,
						TransactionType  NVARCHAR(300),
						TransactionNumber  NVARCHAR(100),
						SalQty   NUMERIC(38,0),
						UnSalQty   NUMERIC(38,0),
						OfferQty   NUMERIC(38,0),
						SlNo    INT,
						PrdId INT'
	SET @TblFields = 'TransactionDate,TransactionType,TransactionNumber,SalQty,UnSalQty,OfferQty,SlNo,PrdId'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	--SET @Po_Errno = 0
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
			  INSERT INTO #RptProductTrackDetails ( TransactionDate,TransactionType,TransactionNumber,
										   SalQty,UnSalQty,OfferQty,SlNo,PrdId)
			  SELECT 
					TransactionDate,TransactionType,TransactionNumber,
					SUM(SalQty),SUM(UnSalQty),SUM(OfferQty),SlNo,PrdId
			  FROM 
					RptProductTrack 
			  WHERE 
					(CmpId=  (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END ) OR
							CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
										
					AND (LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
							LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) )
					AND (PrdId = (CASE @PrdCatPrdId WHEN 0 THEN PrdId ELSE 0 END) OR  
                        PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)) )  
					 AND (PrdId = (CASE @PrdId WHEN 0 THEN PrdId ELSE 0 END) OR
							PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) )
					AND  TransactionDate BETWEEN @FromDate AND  @ToDate AND UsrId=@Pi_UsrId
			  GROUP BY 
					TransactionDate,TransactionType,TransactionNumber,SlNo,PrdId
			  ORDER BY 
					TransactionDate,SlNo
		IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptProductTrackDetails ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+'  WHERE (CmpId=  (CASE '+CAST(@CmpId AS NVARCHAR(10))+' WHEN 0 THEN CmpId ELSE 0 END ) OR
				CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+', 4, '+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND (LcnId = (CASE '+CAST(@LcnId AS NVARCHAR(10))+' WHEN 0 THEN LcnId ELSE 0 END) OR
				LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',22,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (LevelId =  (CASE '+CAST(@CmpPrdCtgId AS NVARCHAR(10))+' WHEN 0 THEN LevelId ELSE 0 END ) OR
				LevelId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',21,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (LevelValId = (CASE '+CAST(@PrdCtgMainId AS NVARCHAR(10))+' WHEN 0 THEN LevelValId Else 0 END) OR
				LevelValId IN (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',16,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (PrdId = (CASE '+CAST(@PrdId AS NVARCHAR(10))+' WHEN 0 THEN PrdId Else 0 END) OR
				PrdId in (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',5,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND TransactionDate Between '''+CAST(@FromDate AS NVARCHAR(10))+''' and '''+ CAST(@FromDate AS NVARCHAR(10))+''''
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptProductTrackDetails'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		PRINT @Pi_DbName
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptProductTrackDetails ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			PRINT @SSQL
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
	ELSE
	BEGIN
		--  SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	END
	END
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId  
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptProductTrackDetails  

	IF @SupZeroStock = 1
	BEGIN
	  SELECT @ZeroStockRecCount = RecCount FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	  IF @ZeroStockRecCount = 2 
	  BEGIN
			UPDATE RptDataCount SET RecCount = 0  WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	  END	

	END 
	ELSE
	BEGIN
	  SELECT @ZeroStockRecCount = RecCount FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	  IF @ZeroStockRecCount = 2 
	  BEGIN
			UPDATE RptDataCount SET RecCount = 0  WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	  END	

	END 
	PRINT 'Data Executed'  
	IF @SupZeroStock=1 
	BEGIN
		SELECT * FROM #RptProductTrackDetails 
		WHERE (SalQty+UnSalQty+OfferQty)<>0 ORDER BY TransactionDate,SlNo ASC --Modified By Aarthi on 06/11/2009. Added TransactionDate to Asc Format
	END
	ELSE
	BEGIN
		SELECT * FROM #RptProductTrackDetails ORDER BY TransactionDate,SlNo ASC --Modified By Aarthi on 06/11/2009. Added TransactionDate to Asc Format
	END
  
--	IF @SupZeroStock=1
--	BEGIN
--		DELETE FROM #RptProductTrackDetails WHERE (SalQty+UnSalQty+OfferQty)=0 AND 
--		TransactionType NOT IN ('Opening Stock','Closing Stock') 
--	END
--	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
--	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
--	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptProductTrackDetails
--	PRINT 'Data Executed'
--	SELECT * FROM #RptProductTrackDetails ORDER BY TransactionDate,SlNo ASC 
	RETURN
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_IOTaxSummary') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_IOTaxSummary
GO
CREATE PROCEDURE Proc_IOTaxSummary 
(  
 @Pi_UserId  INT  
)  
/************************************************************  
* VIEW : SP_RptIOTaxSummary  
* PURPOSE : To get the Tax Summary details  
* CREATED BY : Jisha Mathew  
* CREATED DATE : 03/08/2007  
* NOTE  :  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* {date}        {developer}  {brief modification description}  
* 06/02/2008   Nanda        Added Return and Replacement details  
*************************************************************/  
AS  
BEGIN  
 Delete from TmpRptIOTaxSummary where UserId in (0,@Pi_UserId)
	--Taxable Amount for IDT IN
	Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,
									PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,
									IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)
	Select DISTINCT 
		'' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,
		S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,
		PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,
		Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,
		'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(TaxableAmount) as TaxableAmount,
		'IDT IN' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId
	From 
		IDTManagement PR WITH (NOLOCK)
		INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo
		INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo 
		AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId
		AND PRP.PrdBatId = PT.PrdBatId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId 
		AND PB.PrdId = P.PrdId
		INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId	
	WHERE	PR.Status = 1 and StkMgmtTypeId = 1
			--AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate
	Group By 
			TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,
			S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId
	Having Sum(TaxableAmount) >= 0

	--Tax Amount for IDT IN
	Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,
									PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,
									IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)
	SELECT DISTINCT 
		'' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,
		S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,
		SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,
		Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,
		'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(PT.TaxAmount) as TaxableAmount,
		'IDT IN' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId
	From IDTManagement PR WITH (NOLOCK)
		INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo
		INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo 
		AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId
		AND PT.PrdBatId = PRP.PrdBatId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId 
									AND PB.PrdId = P.PrdId
		INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId	
	WHERE	PR.Status = 1   and StkMgmtTypeId = 1	
			--AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate
	Group By TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,
		S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId
	Having Sum(PT.TaxAmount) >= 0


--Taxable Amount for IDT OUT
	Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,
									PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,
									IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)
	Select DISTINCT 
		'' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,
		S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,
		PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,
		(-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,
		'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,
		(-1) * Sum(TaxableAmount) as TaxableAmount,
		'IDT OUT' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId
	From 
		IDTManagement PR WITH (NOLOCK)
		INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo
		INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo 
		AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId
		AND PRP.PrdBatId = PT.PrdBatId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId 
		AND PB.PrdId = P.PrdId
		INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId	
	WHERE	PR.Status = 1	 and StkMgmtTypeId = 2	
			--AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate
	Group By 
			TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,
			S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId
	Having Sum(TaxableAmount) >= 0

	--Tax Amount for IDT Out
	Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,
									PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,
									IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)
	SELECT DISTINCT 
		'' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,
		S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,
		SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,
		(-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,
		'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,(-1) * Sum(PT.TaxAmount) as TaxableAmount,
		'IDT OUT' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId
	From IDTManagement PR WITH (NOLOCK)
		INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo
		INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo 
		AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId
		AND PT.PrdBatId = PRP.PrdBatId
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId 
									AND PB.PrdId = P.PrdId
		INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId	
	WHERE	PR.Status = 1   and StkMgmtTypeId = 2	
			--AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate
	Group By TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,
		S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId
	Having Sum(PT.TaxAmount) >= 0  
 --Taxable Amount for Purchase  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,  
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,  
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(TaxableAmount) as TaxableAmount,  
 'Purchase' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId  
 From PurchaseReceipt PR WITH (NOLOCK)  --Select * from PurchaseReceipt
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId  
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId  
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE PR.Status = 1    
 Group By TaxPerc,PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,  
 S.SpmId,PRP.PrdBatId,PRP.PrdLSP,PT.TaxId  
 Having Sum(TaxableAmount) >= 0  
 --Tax Amount for Purchase  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,  
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,  
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(PT.TaxAmount) as TaxableAmount,  
 'Purchase' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId  
 From PurchaseReceipt PR WITH (NOLOCK)  
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId  
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId  
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE PR.Status = 1    
 Group By TaxPerc,PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,  
  S.SpmId,PRP.PrdBatId,PRP.PrdLSP,PT.TaxId  
 Having Sum(PT.TaxAmount) >= 0  
 --Taxable Amount for Purchase Return  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,  
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,  
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmount) as TaxableAmount,  
 'PurchaseReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId  
 From PurchaseReturn PR WITH (NOLOCK) 
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId  
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId  
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE PR.Status = 1  
 Group By TaxPerc,PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,  
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,PT.TaxId  
 Having Sum(TaxableAmount) >= 0  
 --Tax Amount for Purchase Return  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,  
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,  
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(PT.TaxAmount) as TaxableAmount,  
 'PurchaseReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId  
 From PurchaseReturn PR WITH (NOLOCK)  
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId  
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId  
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE PR.Status = 1  
 Group By TaxPerc,PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,  
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,PT.TaxId  
 Having Sum(PT.TaxAmount) >= 0  
 --Taxable Amount for Sales  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,  
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty  
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,Sum(TaxableAmount) as TaxableAmount,  
 'Sales' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,@Pi_UserId AS UserId  
 From SalesInvoice SI WITH (NOLOCK)  
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId   
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId   
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId    
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE SI.DlvSts in (4,5)  
 Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,  
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId,SPT.TaxId  
 Having Sum(TaxableAmount) >= 0  
 --Tax Amount for Sales  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,  
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty  
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,  
 'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,Sum(SPT.TaxAmount) as TaxableAmount,  
 'Sales' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,@Pi_UserId AS UserId  
 From SalesInvoice SI WITH (NOLOCK)  
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId    
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId   
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId   
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE SI.DlvSts in (4,5)  
 Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,  
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId,SPT.TaxId  
 Having Sum(SPT.TaxAmount) >= 0  
 --Taxable Amount for SalesReturn  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM (  
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,  
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,  
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,  
  'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmt) as TaxableAmount,  
  'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId  
  From ReturnHeader RH WITH (NOLOCK)  
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1  
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId   
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
  WHERE RH.Status = 0   
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,  
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId  
  Having Sum(TaxableAmt) >= 0  
 UNION  
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,  
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,  
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,  
  'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmt) as TaxableAmount,  
  'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId  
  From ReturnHeader RH WITH (NOLOCK)  
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1  
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId   
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
  WHERE RH.Status = 0   
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,  
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId  
  Having Sum(TaxableAmt) >= 0  
 ) A  
 --Tax Amount for SalesReturn  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,  
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM  (  
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,  
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,  
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,  
  'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(RPT.TaxAmt) as TaxableAmount,  
  'SalesReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId  
  From ReturnHeader RH WITH (NOLOCK)  
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1  
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId   
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId   
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId   
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
  WHERE RH.Status = 0   
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,  
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId  
  Having Sum(RPT.TaxAmt) >= 0  
 UNION  
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,  
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,  
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,  
  'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(RPT.TaxAmt) as TaxableAmount,  
  'SalesReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId  
  From ReturnHeader RH WITH (NOLOCK)  
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1  
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId   
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId   
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId   
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
  WHERE RH.Status = 0   
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,  
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId  
  Having Sum(RPT.TaxAmt) >= 0  
 ) A  
 SELECT RepRefNo   
 INTO #NotDelivered  
 FROM ReplacementHd RH (NOLOCK),SalesInvoice SI (NOLOCK)  
 WHERE RH.SalId>0 AND RH.SalId=SI.SalId AND SI.DlvSts NOT IN (4,5)   
 --Taxable Amount for Return & Replacement (Return)  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,  
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,  
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,  
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,  
 'Taxable Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*SUM(TaxableAmount) AS TaxableAmount,  
 'SalesReturn' AS IOTaxType,0 AS TaxFlag,TaxPerc AS TaxPercent,RIT.TaxId,@Pi_UserId AS UserId  
 FROM ReplacementHd RH WITH (NOLOCK)  
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0  
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo  
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId  
   FROM Retailer B  
   INNER JOIN  
   (SELECT RH.RtrId,R.RMId,S.SMId  
   FROM ReplacementHd RH WITH (NOLOCK)  
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId  
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId  
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId  
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId  
   ) AS A  
   ON A.RtrId=B.RtrId  
   GROUP BY A.RtrId  
      ) AS Rtr ON Rtr.RtrId=RH.RtrId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)  
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxPerc,RIT.TaxId  
 HAVING SUM(RIT.TaxableAmount) >= 0  
 --Tax Amount for Return & Replacement (Return)  
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,  
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,  
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,  
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,  
 'Tax Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*SUM(TaxAmount) AS TaxableAmount,  
 'SalesReturn' AS IOTaxType,1 AS TaxFlag,TaxPerc AS TaxPercent,RIT.TaxId,@Pi_UserId AS UserId  
 FROM ReplacementHd RH WITH (NOLOCK)  
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0  
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo  
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId  
   FROM Retailer B  
   INNER JOIN  
   (SELECT RH.RtrId,R.RMId,S.SMId  
   FROM ReplacementHd RH WITH (NOLOCK)  
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId  
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId  
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId  
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId  
   ) AS A  
   ON A.RtrId=B.RtrId  
   GROUP BY A.RtrId  
      ) AS Rtr ON Rtr.RtrId=RH.RtrId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)  
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxPerc,RIT.TaxId  
 HAVING SUM(RIT.TaxAmount) >= 0  
 --Taxable Amount for Return & Replacement (Replacement)  
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,  
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,  
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,  
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,  
 'Taxable Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,SUM(TaxableAmount) AS TaxableAmount,  
 'Sales' AS IOTaxType,0 AS TaxFlag,TaxPerc AS TaxPercent,ROT.TaxId,@Pi_UserId AS UserId  
 FROM ReplacementHd RH WITH (NOLOCK)  
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo  
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo  
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId  
   FROM Retailer B  
   INNER JOIN  
   (SELECT RH.RtrId,R.RMId,S.SMId  
   FROM ReplacementHd RH WITH (NOLOCK)  
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId  
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId  
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId  
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId  
   ) AS A  
   ON A.RtrId=B.RtrId  
   GROUP BY A.RtrId  
      ) AS Rtr ON Rtr.RtrId=RH.RtrId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)  
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxPerc,ROT.TaxId  
 HAVING SUM(ROT.TaxableAmount) >= 0  
 --Tax Amount for Return & Replacement (Replacement)  
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,  
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)  
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,  
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,  
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,  
 'Tax Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,SUM(TaxAmount) AS TaxableAmount,  
 'Sales' AS IOTaxType,1 AS TaxFlag,TaxPerc AS TaxPercent,ROT.TaxId,@Pi_UserId AS UserId  
 FROM ReplacementHd RH WITH (NOLOCK)  
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo  
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo  
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId  
   FROM Retailer B  
   INNER JOIN  
   (SELECT RH.RtrId,R.RMId,S.SMId  
   FROM ReplacementHd RH WITH (NOLOCK)  
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId  
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId  
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId  
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId  
   ) AS A  
   ON A.RtrId=B.RtrId  
   GROUP BY A.RtrId  
      ) AS Rtr ON Rtr.RtrId=RH.RtrId  
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId    
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId  
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)  
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxPerc,ROT.TaxId  
 HAVING SUM(ROT.TaxAmount) >= 0  
--select * from TmpRptIOTaxSummary where InvDate='2008-02-05'  
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_RptINPUTVATSummary') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_RptINPUTVATSummary
GO
--Select Flag from RptExcelFlag WITH (NOLOCK) WHERE RptID=28
--EXEC Proc_RptINPUTVATSummary 28,1,0,'CoreStocky',0,0,1
CREATE PROCEDURE Proc_RptINPUTVATSummary
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	--@Po_Errno		INT OUTPUT
)
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate		AS	DATETIME
	DECLARE @CmpId	 	AS	INT
	DECLARE @SpmId	 	AS	INT
	DECLARE @TransNo	AS	NVARCHAR(100)
	DECLARE @EXLFlag	AS 	INT
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @SpmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId))
	SET @TransNo =(SELECT TOP 1 SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,201,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	Create TABLE #RptINPUTVATSummary
	(
		InvId 			BIGINT,
		RefNo	  		NVARCHAR(100),		
		InvDate 		DATETIME,		
		PrdId 			INT,
		PrdDCode 		NVARCHAR(20),
		PrdName			NVARCHAR(100),
		IOTaxType 		NVARCHAR(100),
		TaxPerc 		NVARCHAR(50),
		TaxableAmount 		NUMERIC(38,6),		
		TaxFlag 		INT,
		TaxPercent 		NUMERIC(38,6),
		CmpInvNo 		NVARCHAR(100)
	)
	
	SET @TblName = 'RptINPUTVATSummary'
	SET @TblStruct = 'InvId 			BIGINT,
			RefNo	  		NVARCHAR(100),		
			InvDate 		DATETIME,		
			PrdId 			INT,
			PrdDCode 		NVARCHAR(20),
			PrdName			NVARCHAR(100),
			IOTaxType 		NVARCHAR(100),
			TaxPerc 		NVARCHAR(50),
			TaxableAmount 		NUMERIC(38,6),		
			TaxFlag 		INT,
			TaxPercent 		NUMERIC(38,6),
			CmpInvNo 		NVARCHAR(100)'
			
	SET @TblFields = 'InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,TaxPerc,TaxableAmount,TaxFlag
	,TaxPercent,CmpInvNo'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME =  @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		Exec Proc_IOTaxSummary  @Pi_UsrId		
		
		
		INSERT INTO #RptINPUTVATSummary (InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,TaxPerc,
		TaxableAmount,TaxFlag,TaxPercent,CmpInvNo)
	
		Select InvId,RefNo,InvDate,T.PrdId,PrdDCode,PrdName,IOTaxType,TaxPerc,
		case IOTaxType when 'Purchase' then TaxableAmount when 'PurchaseReturn' then TaxableAmount
		end as TaxableAmount ,TaxFlag,TaxPerCent,CmpInvNo From TmpRptIOTaxSummary T,Product P,Company C,
		Supplier S where T.PrdId = P.PrdId and S.SpmId = T.SpmId and C.CmpId = T.CmpId and
		IOTaxType in ('Purchase','PurchaseReturn') and t.spmid > 0
		and ( T.CmpId = (CASE @CmpId WHEN 0 THEN T.CmpId ELSE 0 END) OR
		T.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND
		( T.SpmId = (CASE @SpmId WHEN 0 THEN T.SpmId ELSE 0 END) OR
		T.SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId)))
	
		AND  (RefNo = (CASE @TransNo WHEN '0' THEN RefNo ELSE '' END) OR
		RefNo in (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,201,@Pi_UsrId)))
		AND
		( INVDATE between @FromDate and @ToDate and Userid = @Pi_UsrId)

		INSERT INTO #RptINPUTVATSummary (InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,TaxPerc,
								 TaxableAmount,TaxFlag,TaxPercent,CmpInvNo)	
		SELECT 
			InvId,RefNo,InvDate,T.PrdId,PrdDCode,PrdName,IOTaxType,TaxPerc,
			case IOTaxType 	when 'IDT IN' then TaxableAmount 
							when 'IDT OUT' then TaxableAmount End as TaxableAmount ,
			TaxFlag,TaxPerCent,CmpInvNo 
		From 
			TmpRptIOTaxSummary T,Product P,Company C,
			IDTMaster S 
		where T.PrdId = P.PrdId and S.SpmId = T.SpmId and C.CmpId = T.CmpId and
			  IOTaxType in ('IDT IN','IDT OUT') and t.spmid > 0
		and ( T.CmpId = (CASE @CmpId WHEN 0 THEN T.CmpId ELSE 0 END) OR
		T.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND
		( T.SpmId = (CASE @SpmId WHEN 0 THEN T.SpmId ELSE 0 END) OR
		T.SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId)))
	
		AND  (RefNo = (CASE @TransNo WHEN '0' THEN RefNo ELSE '' END) OR
				RefNo in (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,201,@Pi_UsrId)))
		AND
		( INVDATE between @FromDate and @ToDate and Userid = @Pi_UsrId) 
		
	
		IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptINPUTVATSummary ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ ' WHERE (T.CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN T.CmpId ELSE 0 END) OR ' +
				' T.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
				+ ' ( INVDATE Between ''' + @FromDate + ''' AND ''' + @ToDate + '''' + ' and UsrId = ' + CAST(@Pi_UsrId AS nVarChar(10)) + ') AND '
				+ ' WHERE (T.SpmId = (CASE ' + CAST(@SpmId AS nVarchar(10)) + ' WHEN 0 THEN T.SpmId ELSE 0 END) OR ' +
				' T.SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',9,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) '
	
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
	
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptINPUTVATSummary'
			
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptINPUTVATSummary' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			
			
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			--SET @Po_Errno = 1
			PRINT 'DataBase or Table not Found'
			RETURN
		END
	END
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptINPUTVATSummary
	
	INSERT INTO #RptINPUTVATSummary
	SELECT InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,
	'Total Taxable Amount',SUM(TaxableAmount),0,1000.000000,CmpInvNo
	FROM #RptINPUTVATSummary
	WHERE TaxFlag=0
	GROUP BY InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,CmpInvNo
	
	INSERT INTO #RptINPUTVATSummary
	SELECT InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,
	'Total Tax Amount',SUM(TaxableAmount),1,1000.000000,CmpInvNo
	FROM #RptINPUTVATSummary
	WHERE TaxFlag=1
	GROUP BY InvId,RefNo,InvDate,PrdId,PrdDCode,PrdName,IOTaxType,CmpInvNo
	SELECT * FROM #RptINPUTVATSummary

	SELECT @EXLFlag=Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId
	
	IF @EXLFlag=1
	BEGIN
		--SELECT DISTINCT(TaxPerc),TaxPercent,TaxFlag FROM #RptINPUTVATSummary ORDER BY TaxPercent ,TaxFlag
		--EXEC Proc_RptINPUTVATSummary 28,1,0,'CoreStocky',0,0,1
		/******************************************************************************************************/
		--Create Table in Dynamic Cols
		--Cursors
		DECLARE  @Values NUMERIC(38,6)
		DECLARE  @Desc VARCHAR(80)
		DECLARE  @PrdId BIGINT
		DECLARE  @InvId BIGINT
		DECLARE  @IOTaxType NVARCHAR(100)	
		DECLARE  @TaxFlag INT
		DECLARE  @TaxPercent INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		DECLARE  @iCnt INT
		DECLARE  @Name NVARCHAR(100)
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptINPUTVATSummary_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE [RptINPUTVATSummary_Excel]
		DELETE FROM RptExcelHeaders Where RptId=28 AND SlNo>9
		CREATE TABLE RptINPUTVATSummary_Excel (InvId BIGINT,RefNo NVARCHAR(100),InvDate DATETIME,CmpInvNo NVARCHAR(100),PrdId BIGINT,
						PrdCode NVARCHAR(100),PrdName NVARCHAR(500),IOTaxType NVARCHAR(100),UsrId INT)
		SET @iCnt=10
		DECLARE Crosstab_Cur CURSOR FOR
			SELECT DISTINCT(TaxPerc),TaxPercent,TaxFlag FROM #RptINPUTVATSummary ORDER BY TaxPercent ,TaxFlag
		OPEN Crosstab_Cur
			   FETCH NEXT FROM Crosstab_Cur INTO @Column,@TaxPercent,@TaxFlag
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='ALTER TABLE RptINPUTVATSummary_Excel ADD ['+ @Column +'] NUMERIC(38,6)'
					EXEC (@C_SSQL)
					
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
					EXEC (@C_SSQL)
					SET @iCnt=@iCnt+1
					FETCH NEXT FROM Crosstab_Cur INTO @Column,@TaxPercent,@TaxFlag
				END
		CLOSE Crosstab_Cur
		DEALLOCATE Crosstab_Cur
		--Insert table values
		DELETE FROM RptINPUTVATSummary_Excel
		--Select Column_Name sp_Columns RptINPUTVATSummary_Excel
		INSERT INTO RptINPUTVATSummary_Excel (InvId ,RefNo ,InvDate ,CmpInvNo,PrdId ,PrdCode,PrdName,IOTaxType,UsrId)
		SELECT DISTINCT InvId ,RefNo ,InvDate ,CmpInvNo,PrdId,PrdDCode,PrdName,IOTaxType,@Pi_UsrId
				FROM #RptINPUTVATSummary
		DECLARE Values_Cur CURSOR FOR
		SELECT DISTINCT  InvId,PrdId,IOTaxType,TaxPerc,TaxableAmount FROM #RptINPUTVATSummary
		OPEN Values_Cur
			   FETCH NEXT FROM Values_Cur INTO @InvId,@PrdId,@IOTaxType,@Desc,@Values
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptINPUTVATSummary_Excel SET ['+ @Desc +']= '+ CAST(ISNULL(@Values,0) AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE InvId='+ CAST(@InvId AS VARCHAR(1000)) + ' AND PrdId=' + CAST(@PrdId AS VARCHAR(1000)) + '
					AND IOTaxType=''' + CAST(@IOTaxType AS VARCHAR(1000))+''' AND UsrId=' + CAST(@Pi_UsrId AS VARCHAR(10))+ ''
					EXEC (@C_SSQL)
					--PRINT @C_SSQL
					FETCH NEXT FROM Values_Cur INTO @InvId,@PrdId,@IOTaxType,@Desc,@Values
				END
		CLOSE Values_Cur
		DEALLOCATE Values_Cur
		-- To Update the Null Value as 0
		DECLARE NullCursor_Cur CURSOR FOR
		SELECT Name FROM dbo.sysColumns where id = object_id(N'[RptINPUTVATSummary_Excel]')
		OPEN NullCursor_Cur
			   FETCH NEXT FROM NullCursor_Cur INTO @Name
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptINPUTVATSummary_Excel SET ['+ @Name +']= '+ CAST(0 AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE '+'['+ @Name +']'+'IS NULL'+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM NullCursor_Cur INTO @Name
				END
		CLOSE NullCursor_Cur
		DEALLOCATE NullCursor_Cur
	END
RETURN
END
GO
IF  EXISTS (SELECT * FROM sysobjects WHERE id = OBJECT_ID(N'Proc_RptIOTaxSummary') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_RptIOTaxSummary
GO
--EXEC Proc_RptIOTaxSummary 11,1,0,'Corestocky',0,0,1,0
CREATE PROCEDURE Proc_RptIOTaxSummary
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
BEGIN
SET NOCOUNT ON
/*********************************
* PROCEDURE: Proc_RptIOTaxSummary
* PURPOSE: General Procedure
* NOTES:
* CREATED: Jisha Mathew	30-07-2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*
*********************************/
DECLARE @NewSnapId	 	AS	INT
DECLARE @DBNAME			AS 	nvarchar(50)
DECLARE @TblName	 	AS	nvarchar(500)
DECLARE @TblStruct 		AS	nVarchar(4000)
DECLARE @TblFields	 	AS	nVarchar(4000)
DECLARE @sSql			AS 	nVarChar(4000)
DECLARE @ErrNo	 		AS	INT
DECLARE @PurDBName		AS	nVarChar(50)
DECLARE @FromDate		AS	DATETIME
DECLARE @ToDate			AS	DATETIME
DECLARE @CmpId			AS	INT
DECLARE @fPrdCatPrdId		AS	Int
DECLARE @fprdId 		AS	INT
DECLARE @EXLFlag		AS	INT

SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
--If Product Category Filter is available
EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
SET @fPrdCatPrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
SET @fPrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
--Till Here
Create TABLE #RptIOTaxSummary
(
	InvDate		DateTime,
	CmpId			INT,
	Prdid			INT,
	TaxPerc			nVarchar(50),
	TaxableAmount		NUMERIC (38,6),
	IOTaxType		nVarchar(100),
	TaxFlag			INT,
	TaxPercent 		Numeric (38,6)
)
Create TABLE #RptIOTaxSummaryFinal
(
	InvDate		DateTime,
	CmpId			INT,
	Prdid			INT,
	TaxPerc			nVarchar(50),
	TaxableAmount		NUMERIC (38,6),
	IOTaxType		nVarchar(100),
	TaxFlag			INT,
	TaxPercent 		Numeric (38,6)
)
SET @TblName = 'RptIOTaxSummary'
SET @TblStruct = 'InvDate		DateTime,
		CmpId			INT,
		Prdid			INT,
		TaxPerc			nVarchar(50),
		TaxableAmount		NUMERIC (38,6),
		IOTaxType		nVarchar(100),
		TaxFlag			INT,
		TaxPercent 		Numeric (38,6)'
SET @TblFields = 'InvDate,CmpId,Prdid,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent'
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME =  @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
--	print @SMId
	EXEC Proc_IOTaxSummary @Pi_UsrId
	INSERT INTO #RptIOTaxSummary (TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent)
	SELECT 	TaxPerc,dbo.Fn_ConvertCurrency(SUM(TaxableAmount),@Pi_CurrencyId),IOTaxType,TaxFlag,TaxPercent
	FROM TmpRptIOTaxSummary
	WHERE (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR
		CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND (PrdId = (CASE @fPrdCatPrdId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))		
		AND (PrdId = (CASE @fPrdId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		AND InvDate BETWEEN @FromDate AND @ToDate
	Group By TaxPerc,IOTaxType,TaxFlag,TaxPercent
	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptIOTaxSummary ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +
			' CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
			+ '( PrdId = (CASE ' + CAST(@fPrdCatPrdId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +
			' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND '
			+ ' (PrdId = (CASE ' + CAST(@fPrdId AS nVarChar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +
			' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS  nVarchar(10)) + ',5,' +  CAST(@Pi_UsrId AS nVarchar(10)) + ' )))
			AND InvDate BETWEEN @FromDate AND @ToDate
			Group By TaxPerc,IOTaxType,TaxFlag,TaxPercent'
		EXEC (@SSQL)
		PRINT 'Retrived Data From Purged Table'
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptIOTaxSummary'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	   END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	PRINT @ErrNo
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptIOTaxSummary ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	   END
END
Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptIOTaxSummary
INSERT INTO #RptIOTaxSummaryFinal
SELECT * FROM #RptIOTaxSummary
--SELECT * FROM #RptIOTaxSummaryFinal
INSERT INTO #RptIOTaxSummary(TaxPerc,TaxableAmount,IOTaxType)
SELECT TaxPerc,SUM(Purchase+SalesReturn+Sales+PurchaseReturn+IDT) AS Total,'Total'
FROM
(
SELECT TaxPerc,IOTaxType,SUM(Purchase) AS Purchase,SUM(Sales) AS Sales,SUM(SalesReturn) AS SalesReturn,
SUM(PurchaseReturn) AS PurchaseReturn,
SUM(IDTIN - IDTOUT) as IDT
FROM
(
SELECT TaxPerc,IOTaxType,
(CASE IOTaxType WHEN 'IDT IN' THEN ABS(TaxableAmount) ELSE 0 END) AS IDTIN,
(CASE IOTaxType WHEN 'IDT OUT' THEN (ABS(TaxableAmount)) ELSE 0 END) AS IDTOUT,
(CASE IOTaxType WHEN 'Purchase' THEN ABS(TaxableAmount) ELSE 0 END) AS Purchase,
(CASE IOTaxType WHEN 'SalesReturn' THEN (-1*ABS(TaxableAmount)) ELSE 0  END) AS SalesReturn,
(CASE IOTaxType WHEN 'Sales' THEN ABS(TaxableAmount)  ELSE 0 END) AS Sales,
(CASE IOTaxType WHEN 'PurchaseReturn' THEN (-1*ABS(TaxableAmount))  ELSE 0 END) AS [PurchaseReturn]
FROM #RptIOTaxSummaryFinal
GROUP BY TaxPerc,IOTaxType,TaxableAmount
) AS B GROUP BY TaxPerc,IOTaxType
) A
GROUP BY TaxPerc
UPDATE #RptIOTaxSummary
SET #RptIOTaxSummary.TaxFlag=#RptIOTaxSummaryFinal.TaxFlag,
#RptIOTaxSummary.TaxPercent=#RptIOTaxSummaryFinal.TaxPercent
FROM #RptIOTaxSummaryFinal
WHERE #RptIOTaxSummary.TaxPerc=#RptIOTaxSummaryFinal.TaxPerc
AND #RptIOTaxSummary.IOTaxType='Total'
SELECT * FROM #RptIOTaxSummary

	SELECT @EXLFlag=Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId

	IF @EXLFlag=1
	BEGIN
		--EXEC Proc_RptIOTaxSummary 11,1,0,'Corestocky',0,0,1
		/***************************************************************************************************************************/
		--Create Table in Dynamic Cols
		--Cursors
		DECLARE	 @TaxPerc 		NVARCHAR(100)
		DECLARE	 @TaxableAmount NUMERIC(38,6)
		DECLARE  @IOTaxType    NVARCHAR(100)
		DECLARE  @SlNo INT		
		DECLARE	 @TaxFlag      INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		DECLARE  @iCnt INT
		DECLARE  @TaxPercent Numeric (38,6)
		DECLARE  @Name    NVARCHAR(100)
		--DROP TABLE RptIOTaxSummary_Excel
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptIOTaxSummary_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE [RptIOTaxSummary_Excel]
		DELETE FROM RptExcelHeaders Where RptId=11 AND SlNo>2
		CREATE TABLE RptIOTaxSummary_Excel (IOTaxType nVarchar(100),UsrId INT)
		SET @iCnt=3
		DECLARE Column_Cur CURSOR FOR
		SELECT DISTINCT(TaxPerc),TaxPercent,TaxFlag FROM #RptIOTaxSummary ORDER BY TaxPercent ,TaxFlag
		OPEN Column_Cur
			   FETCH NEXT FROM Column_Cur INTO @Column,@TaxPercent,@TaxFlag
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='ALTER TABLE RptIOTaxSummary_Excel  ADD ['+ @Column +'] NUMERIC(38,6)'
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
					PRINT @C_SSQL
					EXEC (@C_SSQL)
				SET @iCnt=@iCnt+1
					FETCH NEXT FROM Column_Cur INTO @Column,@TaxPercent,@TaxFlag
				END
		CLOSE Column_Cur
		DEALLOCATE Column_Cur
		--Insert table values
		DELETE FROM RptIOTaxSummary_Excel
		INSERT INTO RptIOTaxSummary_Excel(IOTaxType,UsrId)
		SELECT DISTINCT IOTaxType,@Pi_UsrId
				FROM #RptIOTaxSummary
		DECLARE Values_Cur CURSOR FOR
		SELECT DISTINCT (TaxPerc),TaxableAmount,IOTaxType FROM #RptIOTaxSummary
		OPEN Values_Cur
			   FETCH NEXT FROM Values_Cur INTO @TaxPerc,@TaxableAmount,@IOTaxType--,@TaxFlag
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptIOTaxSummary_Excel  SET ['+ @TaxPerc +']= '+ CAST(@TaxableAmount AS VARCHAR(1000))
					PRINT @C_SSQL
					SET @C_SSQL=@C_SSQL+ ' WHERE IOTaxType=''' + CAST(@IOTaxType AS VARCHAR(1000))
					+''''--' AND TaxFlag =' + CAST(@TaxFlag AS VARCHAR(1000)) +''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM Values_Cur INTO @TaxPerc,@TaxableAmount,@IOTaxType--,@TaxFlag
				END
		CLOSE Values_Cur
		DEALLOCATE Values_Cur
		-- To Update the Null Value as 0
		DECLARE NullCursor_Cur CURSOR FOR
		SELECT Name FROM dbo.sysColumns where id = object_id(N'[RptIOTaxSummary_Excel]')
		OPEN NullCursor_Cur
			   FETCH NEXT FROM NullCursor_Cur INTO @Name
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptIOTaxSummary_Excel SET ['+ @Name +']= '+ CAST(0 AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE '+'['+ @Name +']'+'IS NULL'+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM NullCursor_Cur INTO @Name
				END
		CLOSE NullCursor_Cur
		DEALLOCATE NullCursor_Cur
		/***************************************************************************************************************************/
	END
RETURN
END
GO
--IDT END
DELETE FROM PurSalAccConfig WHERE TransactionId = 5 AND Coaid = 250
DECLARE @AccDescId AS BIGINT
SELECT @AccDescId = ISNULL(MAX(AccDescId)+1,1) FROM PurSalAccConfig WITH (NOLOCK)
INSERT INTO PurSalAccConfig (TransactionId,AccDescId,Description,CoaId,Effect,AccMode,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
SELECT 5,@AccDescId,'Cash Discounts',250,0,0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)
UPDATE Counters SET CurrValue = @AccDescId WHERE TabName = 'PurSalAccConfig' AND FldName = 'AccDescId'
GO
IF EXISTS (SELECT * FROM SysColumns A WITH (NOLOCK),Sysobjects B WITH (NOLOCK) WHERE A.id = B.id AND A.name ='Amt' 
AND B.Xtype = 'U' AND B.Name = 'ETLTempPurchaseReceiptOtherCharges')
BEGIN
    ALTER TABLE ETLTempPurchaseReceiptOtherCharges ALTER COLUMN Amt NUMERIC(18,6)
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'P' AND name = 'Proc_Validate_PurchaseReceiptOtherCharges')
DROP PROCEDURE Proc_Validate_PurchaseReceiptOtherCharges
GO
/*
BEGIN TRANSACTION
Exec Proc_Validate_PurchaseReceiptOtherCharges 0
--SELECT * FROM ETLTempPurchaseReceiptOtherCharges
--SELECT * FROM ETL_Prk_PurchaseReceiptOtherCharges
SELECT * FROM ErrorLog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Validate_PurchaseReceiptOtherCharges
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Validate_PurchaseReceiptOtherCharges
* PURPOSE		: To Insert and Update records in the Table PurchaseReceiptOtherCharges
* CREATED		: Nandakumar R.G
* CREATED DATE	: 17/12/2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}

*********************************/
SET NOCOUNT ON
BEGIN
	
	DECLARE @Exist 		AS 	INT
	DECLARE @Tabname 	AS     	NVARCHAR(100)
	DECLARE @DestTabname 	AS 	NVARCHAR(100)
	DECLARE @Fldname 	AS     	NVARCHAR(100)
	
	DECLARE @CmpInvNo	AS 	NVARCHAR(100)	
	DECLARE @OCDesc		AS 	NVARCHAR(100)
	DECLARE @Amt		AS 	NVARCHAR(100)	
	
			
	DECLARE @TransStr 	AS 	NVARCHAR(4000)


	SET @Po_ErrNo=0
	SET @Exist=0
	
	SET @DestTabname='ETLTempPurchaseReceiptOtherCharges'
	SET @Fldname='CmpInvNo'
	SET @Tabname = 'ETL_Prk_PurchaseReceiptOtherCharges'
	SET @Exist=0
	
	DECLARE Cur_PurchaseReceiptOtherCharges CURSOR
	FOR SELECT DISTINCT ISNULL([Company Invoice No],''),ISNULL([OC Description],''),ISNULL([Amount],0)
	FROM ETL_Prk_PurchaseReceiptOtherCharges WITH (NOLOCK)
	OPEN Cur_PurchaseReceiptOtherCharges
	FETCH NEXT FROM Cur_PurchaseReceiptOtherCharges INTO @CmpInvNo,@OCDesc,@Amt
	WHILE @@FETCH_STATUS=0
	BEGIN
		
		SET @Po_ErrNo=0

		SET @Exist=0

		IF NOT EXISTS(SELECT * FROM ETLTempPurchaseReceipt WITH (NOLOCK) WHERE CmpInvNo=@CmpInvNo)
		BEGIN
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Invoice No',
			'Company Invoice No:'+@CmpInvNo+' is not available')  
         	
			SET @Po_ErrNo=1
		END		
		
		IF @Po_ErrNo=0
		BEGIN
			IF NOT EXISTS(SELECT * FROM PurSalAccConfig WITH (NOLOCK) WHERE [Description]=@OCDesc AND
			TransactionId=5)
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Other Charge Description',
				'Other Charge Description:'+@OCDesc+' is not available in Company Invoice No:'+@CmpInvNo)  
	         	
				SET @Po_ErrNo=1
			END	
		END		

		IF @Po_ErrNo=0
		BEGIN
			IF NOT ISNUMERIC(@Amt)=1
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Amount',
				'Amount:'+@Amt+' should be in numeric in Company Invoice No:'+@CmpInvNo) 

				SET @Po_ErrNo=1
			END			
		END
		
		IF @Po_ErrNo=0
		BEGIN
			INSERT INTO ETLTempPurchaseReceiptOtherCharges (CmpInvNo,OCDesc,Amt)
			VALUES(@CmpInvNo,@OCDesc,@Amt)
		END
			
		IF @Po_ErrNo<>0
		BEGIN
			CLOSE Cur_PurchaseReceiptOtherCharges
			DEALLOCATE Cur_PurchaseReceiptOtherCharges
			RETURN
		END

		FETCH NEXT FROM Cur_PurchaseReceiptOtherCharges INTO @CmpInvNo,@OCDesc,@Amt

	END
	CLOSE Cur_PurchaseReceiptOtherCharges
	DEALLOCATE Cur_PurchaseReceiptOtherCharges

END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'P' AND name = 'Proc_Cn2Cs_PurchaseReceipt')
DROP PROCEDURE Proc_Cn2Cs_PurchaseReceipt
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_PurchaseReceipt 0
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_PurchaseReceipt
(
	@Po_ErrNo INT OUTPUT
)
AS
/***********************************************************
* PROCEDURE	: Proc_Cn2Cs_PurchaseReceipt
* PURPOSE	: To Insert the records FROM Console into Temp Tables
* SCREEN	: Console Integration-PurchaseReceipt
* CREATED BY: Nandakumar R.G On 03-05-2010
* MODIFIED	:
* DATE      AUTHOR     DESCRIPTION
14/08/2013 Murugan.R	Logistic Material Management
* {date} {developer}  {brief modIFication description}
*************************************************************/
SET NOCOUNT ON
BEGIN
	-- For Clearing the Prking/Temp Table -----	
	DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)
	DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)	
	DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)
	DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)
    DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)	
	DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN 
	(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)
	DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1
	TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt
	TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim
	TRUNCATE TABLE ETL_Prk_PurchaseReceipt
    TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt
    TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt
    TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges
	--------------------------------------
	DECLARE @ErrStatus			INT
	DECLARE @BatchNo			NVARCHAR(30)
	DECLARE @ProductCode		NVARCHAR(30)
	DECLARE @ListPrice			NUMERIC(38,6)
	DECLARE @FreeSchemeFlag		NVARCHAR(5)
	DECLARE @CompInvNo			NVARCHAR(25)
	DECLARE @UOMCode			NVARCHAR(25)
	DECLARE @Qty				INT
	DECLARE @PurchaseDiscount	NUMERIC(38,6)
	DECLARE @VATTaxValue		NUMERIC(38,6)
	DECLARE @SchemeRefrNo		NVARCHAR(25)
	DECLARE @SupplierCode		NVARCHAR(30)
	DECLARE @TransporterCode	NVARCHAR(30)
	DECLARE @POUOM				INT
	DECLARE @RowId				INT
	DECLARE @LineLvlAmt			NUMERIC(38,6)
	DECLARE @QtyInKg			NUMERIC(38,6)
	DECLARE @ExistCompInvNo		NVARCHAR(25)
	DECLARE @FreightCharges		NUMERIC(38,6)
	SET @RowId=1
	
	--->Added By Nanda on 17/09/2009
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE InvToAvoid	
	END
	CREATE TABLE InvToAvoid
	(
		CmpInvNo NVARCHAR(50)
	)
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)
	END
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)
	END
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)
		--->Added By Nanda on 05/05/2010
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)
		SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)
		--->Till Here				
	END
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE ProductCode+'~'+BatchNo
	NOT IN
	(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode+'~'+BatchNo
		NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode+'~'+BatchNo
		NOT IN
		(SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)
		--->Added By Nanda on 05/05/2010
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)
		SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE ProductCode+'~'+BatchNo
		NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)
		--->Till Here
	END
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE CompInvDate>GETDATE())	
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvDate>GETDATE()
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE CompInvDate>GETDATE()
	END
	IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
	WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))	
	BEGIN
		INSERT INTO InvToAvoid(CmpInvNo)
		SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt
		WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))
	END		
	--->Till Here
	SET @ExistCompInvNo=0
	DECLARE Cur_Purchase CURSOR
	FOR
	SELECT ProductCode,BatchNo,ListPriceNSP,
	FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,
	ISNULL(FreightCharges,0) AS FreightCharges
	FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)
	ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,
	FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges
	OPEN Cur_Purchase
	FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,
	@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,
	@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges	
	WHILE @@FETCH_STATUS = 0
	BEGIN
--		IF @ExistCompInvNo<>@CompInvNo
--		BEGIN
--			SET @ExistCompInvNo=@CompInvNo
--			SET @RowId=2
--		END
		--To insert into ETL_Prk_PurchaseReceiptPrdDt
		IF(@FreeSchemeFlag='0')
		BEGIN
			INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],
			[PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges)
			VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,
			@PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges)
			INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])
			VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)
			INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])
			VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)
--			INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])
--			VALUES(@CompInvNo,@RowId,'E',@QtyInKg)
		END
		--To insert into ETL_Prk_PurchaseReceiptClaim
		IF(@FreeSchemeFlag='1')
		BEGIN
			INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],
			[Batch Code],[Qty],[Stock Type],[Amount])
			VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0)
		END
--		SET @RowId=@RowId+1
		FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,
		@FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,
		@PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges
	END
	CLOSE Cur_Purchase
	DEALLOCATE Cur_Purchase
	--To insert into ETL_Prk_PurchaseReceipt
	SELECT @SupplierCode=SpmCode FROM Supplier WHERE SpmDefault=1
	SELECT @TransporterCode=TransporterCode FROM Transporter
	WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter)
	
	IF @TransporterCode=''
	BEGIN
		INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter',
		'Transporter not available')
	END
	INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],
	[Invoice Date],[Transporter Code],[NetPayable Amount])
	SELECT DISTINCT C.CmpCode,@SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue
	FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P
	WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)
	
	--Added By Sathishkumar Veeramani 2013/08/13
	INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)
	SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)
	WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'
	
	EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT
	IF @ErrStatus =0
	BEGIN
		EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT
		IF @ErrStatus =0
		BEGIN
			EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT
			IF @ErrStatus =0
			BEGIN
				EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT
				IF @ErrStatus =0
				BEGIN
				   EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT
				   IF @ErrStatus =0
				   BEGIN
					   SET @ErrStatus=@ErrStatus
				   END	   
				END
			END
		END
	END
	--->Added By Nanda on 17/09/2009
	DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN
	(SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)
	UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'
	WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)
	--->Till Here
	SET @Po_ErrNo= @ErrStatus
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_IDTBillPrint')
DROP PROCEDURE Proc_IDTBillPrint
GO
CREATE PROCEDURE Proc_IDTBillPrint
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Pi_BTTblName   	NVARCHAR(50)
)
AS
/****************************************************************************************
* PROCEDURE	: Proc_IDTBillPrint
* PURPOSE	: General Procedure
* NOTES		:
* CREATED	:  
* MODIFIED
* DATE			AUTHOR		  DESCRIPTION
------------------------------------------------------------------------------------------
* 2013-05-31    Alphonse J    Incorrect join updated ICRSTJNJ0113
****************************************************************************************/
SET NOCOUNT ON
DECLARE @FromDate		DateTime
DECLARE @ToDate			DateTime
DECLARE @LcnId			INT
DECLARE @FromDistId		INT
DECLARE @ToDistId		INT
DECLARE @IDTRefNo nVarchar(100)
DECLARE @StockTypeId		INT
SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
SET @ToDate = (SELECT   TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
set @StockTypeId = (Select Distinct StockType From RptIDTToPrint where UsrId = @Pi_UsrId)
BEGIN
						/* Stock In  - 1  Stock Out  - 2 */
DELETE FROM IDTBillPrint Where UserId = @Pi_UsrId
	IF @StockTypeId = 1
	BEGIN
		INSERT INTO IDTBillPrint([IDT Reference No],[IDT Reference Date],LcnId,Location,StkMgmtTypeId,
								[StockManagement Type],
								DocRefNo,[LR No],[LR Date],Remarks,[IDTHeader GrossAmt],[IDHeader TaxAmt],
								[IDTHeader NetAmt],[IDT PaidAmt],[From Distributor Id],[From Distributor Code],
								[From Distributor Name],[From Distributor Address1],
								[From Distributor Address2],[From Distributor Address3],[From Distributor Phone],
								[From Distributor Contact],[From Distributor Email],[To Distributor Id],
								[To Distributor Code],[To Distributor Name],[To Distributor Address1],
								[To Distributor Address2],[To Distributor Address3],[To Distributor Phone],
								[To Distributor Contact],[To Distributor Email],PrdId,[Prroduct Distributor Code],
								Qty,[Product Company Code],[Product Name],[Product Short Name],
								PrdBatId,[Product Batch Code],MRP,ListPrice,[Line GrossAmount],[Line TaxAmount],
								[Line NetAmount],PrdSlNo,PriceId,
								[IDT Charges],[Tax Percent],[Tax Amount],[Taxable Amount],[Add TaxPercent],
								[Add TaxAmount],UserId)
		SELECT  DISTINCT
				A.IDTMngRefNo,IDTMngDate,A.LcnId,LcnName,
				StkMgmtTypeId,Case StkMgmtTypeId When 1 Then 'IDT IN' ELSE 'IDT OUT' END AS StockManagementType,
				Isnull(DocRefNo,'') DocRefNo,Isnull(LRNo,'') LRNo,LRDate,Isnull(Remarks,'') Remarks,
				IDTGrossAmt IDTHeaderGrossAmt,IDTTaxAmt  IDHeaderTaxAmt,
				IDTNetAmt	IDTHeaderNetAmt,  IDTPaidAmt IDTPaidAmt,
				A.FromSpmId FromDistId,C.SpmCode FromDistCode,
				C.SpmName FromDistName,C.SpmAdd1 FromDistAddress1,C.SpmAdd2 FromDistAddress2,
				C.SpmAdd3 FromDistAddress3,C.SpmPhone FromDistPhone,
				C.SpmContact FromDistContact,C.SpmEmail FromDistEmail, 
				DistributorId ToDistId,DistributorCode ToDistCode,DistributorName ToDistName,
				DistributorAdd1 ToDistAddress1,DistributorAdd2 ToDistAddress2,DistributorAdd3 ToDistAddress3,			
				PhoneNo ToDistPhine,ContactPerson ToDistContact,EmailId ToDistEmail,
				E.PrdId,PrdDCode PrdDistCode,Qty,PrdCcode PrdComCode,PrdName,PrdShrtName,
				E.PrdBatId,	PrdBatCode,PrdMRPRate MRP,PrdUnitRate ListPrice,
				PrdGrossAmount LineGrossAmount,PrdTaxAmount LineTaxAmount,
				PrdNetAmount LineNetAmount,E.PrdSlNo,PriceId,
				LineBaseQtyAmount IDTCharges,
				IDTTax.TaxPerc,IDTTax.TaxAmount,IDTTax.TaxableAmount,
				IDTTax.AddTaxPer,IDTTax.AddTaxAmt,
				@Pi_UsrId UserId
		FROM 
				IDTManagement A (Nolock)
					INNER JOIN Location B (Nolock) ON  A.LcnId = B.LcnId
					LEFT OUTER JOIN  IDTMaster C (Nolock) ON A.FromSpmId = C.SpmId
					LEFT OUTER JOIN  Distributor D (Nolock) ON A.ToSpmId = D.DistributorId
					INNER JOIN IDTManagementProduct E (Nolock) ON A.IDTMngRefNo = E.IDTMngRefNo
					INNER JOIN Product P (Nolock) ON E.PrdId = P.PrdId
					INNER JOIN ProductBatch PB (Nolock) ON E.PrdBatId = PB.PrdBatId 
												  and E.PrdId = PB.PrdId and P.PrdId = PB.PrdId
					INNER JOIN IDTManagementLineAmount F (Nolock) ON A.IDTMngRefNo = F.IDTMngRefNo and  E.PrdSlNo = F.PrdSlNo
															AND RefCode = 'E'
					LEFT OUTER JOIN (SELECT	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.TaxPerc Taxperc,A.TaxAmount,A.TaxableAmount ,  --ICRSTJNJ0113
											ISNULL(B.TaxPerc,0) AddTaxPer ,ISNULL(B.TaxAmount,0) AddTaxAmt
									FROM(
										(	Select	TT.IDTMngRefNo,TT.PrdId,TT.PrdBatId,TT.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax TT  (Nolock)
													INNER JOIN IDTManagementProduct T (Nolock) ON T.IDTMngRefNo=TT.IDTMngRefNo		
													and T.PrdId	= TT.PrdId  and T.PrdBatId = TT.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId = 1 
										 ) A 
									LEFT OUTER JOIN 
										(	Select	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax A (Nolock)
													INNER JOIN IDTManagementProduct B (Nolock) ON A.IDTMngRefNo=B.IDTMngRefNo		
													and B.PrdId	= A.PrdId  and A.PrdBatId = B.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId > 1					
										)B  
										ON A.IDTMngRefNo=B.IDTMngRefNo and A.PrdId=B.PrdId and A.PrdBatId = B.PrdbatId)
									)  as IDTTax ON A.IDTMngRefNo = IDTTax.IDTMngRefNo and IDTTax.PrdId = E.PrdId
									   AND IDTTax.PrdBatId = E.PrdBatId		
					INNER JOIN RptIDTToPrint R ON A.IDTMngRefNo = R.IDTRefNumber and UsrId = @Pi_UsrId
		WHERE 
				StkMgmtTypeId = 1   
		ORDER BY A.IDTMngRefNo
	END 
	ELSE
	BEGIN		
			INSERT INTO IDTBillPrint([IDT Reference No],[IDT Reference Date],LcnId,Location,StkMgmtTypeId,
								[StockManagement Type],
								DocRefNo,[LR No],[LR Date],Remarks,[IDTHeader GrossAmt],[IDHeader TaxAmt],
								[IDTHeader NetAmt],[IDT PaidAmt],[From Distributor Id],[From Distributor Code],
								[From Distributor Name],[From Distributor Address1],
								[From Distributor Address2],[From Distributor Address3],[From Distributor Phone],
								[From Distributor Contact],[From Distributor Email],[To Distributor Id],
								[To Distributor Code],[To Distributor Name],[To Distributor Address1],
								[To Distributor Address2],[To Distributor Address3],[To Distributor Phone],
								[To Distributor Contact],[To Distributor Email],PrdId,[Prroduct Distributor Code],
								Qty,[Product Company Code],[Product Name],[Product Short Name],
								PrdBatId,[Product Batch Code],MRP,ListPrice,[Line GrossAmount],[Line TaxAmount],
								[Line NetAmount],PrdSlNo,PriceId,
								[IDT Charges],[Tax Percent],[Tax Amount],[Taxable Amount],[Add TaxPercent],
								[Add TaxAmount],UserId)
			SELECT  DISTINCT
					A.IDTMngRefNo,IDTMngDate,A.LcnId,LcnName,
					StkMgmtTypeId,Case StkMgmtTypeId When 1 Then 'IDT IN' ELSE 'IDT OUT' END AS StockManagementType,
					Isnull(DocRefNo,'') DocRefNo,Isnull(LRNo,'') LRNo,LRDate,Isnull(Remarks,'') Remarks,
					IDTGrossAmt IDTHeaderGrossAmt,IDTTaxAmt  IDHeaderTaxAmt,
					IDTNetAmt	IDTHeaderNetAmt,  IDTPaidAmt IDTPaidAmt,
					DistributorId FromDistId,DistributorCode FromDistCode,DistributorName FromDistName,
					DistributorAdd1 FromDistAddress1,	DistributorAdd2 FromDistAddress2,DistributorAdd3 FromDistAddress3,
					PhoneNo FromDistPhone,ContactPerson FromDistContact,EmailId FromDistEmail,
					A.FromSpmId ToDistId,C.SpmCode ToDistCode,
					C.SpmName ToDistName,C.SpmAdd1 ToDistAddress1,C.SpmAdd2 ToDistAddress2,
					C.SpmAdd3 ToDistAddress3,	C.SpmPhone ToDistPhone,
					C.SpmContact ToDistContact,C.SpmEmail ToDistEmail,			 
					E.PrdId,PrdDCode PrdDistCode,Qty,PrdCcode PrdComCode,PrdName,PrdShrtName,
					E.PrdBatId,	PrdBatCode,PrdMRPRate MRP,PrdUnitRate ListPrice,
					PrdGrossAmount LineGrossAmount,PrdTaxAmount LineTaxAmount,
					PrdNetAmount LineNetAmount,E.PrdSlNo,PriceId,
					LineBaseQtyAmount IDTCharges,
					IDTTax.TaxPerc,IDTTax.TaxAmount,IDTTax.TaxableAmount,
					IDTTax.AddTaxPer,IDTTax.AddTaxAmt,
					@Pi_UsrId UserId
			FROM 
					IDTManagement A (Nolock)
						INNER JOIN Location B (Nolock) ON  A.LcnId = B.LcnId
						LEFT OUTER JOIN  IDTMaster C (Nolock) ON A.ToSpmId = C.SpmId
						LEFT OUTER JOIN  Distributor D (Nolock) ON A.FromSpmId = D.DistributorId
						INNER JOIN IDTManagementProduct E (Nolock) ON A.IDTMngRefNo = E.IDTMngRefNo
						INNER JOIN Product P (Nolock) ON E.PrdId = P.PrdId
						INNER JOIN ProductBatch PB (Nolock) ON E.PrdBatId = PB.PrdBatId 
													  and E.PrdId = PB.PrdId and P.PrdId = PB.PrdId
						INNER JOIN IDTManagementLineAmount F (Nolock) ON A.IDTMngRefNo = F.IDTMngRefNo and  E.PrdSlNo = F.PrdSlNo
																AND RefCode = 'E'
						LEFT OUTER JOIN (SELECT	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.TaxPerc Taxperc,A.TaxAmount,A.TaxableAmount ,  --ICRSTJNJ0113
											ISNULL(B.TaxPerc,0) AddTaxPer ,ISNULL(B.TaxAmount,0) AddTaxAmt
									FROM(
										(	Select	TT.IDTMngRefNo,TT.PrdId,TT.PrdBatId,TT.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax TT (Nolock)
													INNER JOIN IDTManagementProduct T (Nolock) ON T.IDTMngRefNo=TT.IDTMngRefNo		
													and T.PrdId	= TT.PrdId  and T.PrdBatId = TT.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId = 1 
										 ) A 
									LEFT OUTER JOIN 
										(	Select	A.IDTMngRefNo,A.PrdId,A.PrdBatId,A.PrdSlNo,TaxPerc,
													TaxAmount,TaxableAmount
											FROM    IDTManagementProductTax A  (Nolock)
													INNER JOIN IDTManagementProduct B (Nolock) ON A.IDTMngRefNo=B.IDTMngRefNo		
													and B.PrdId	= A.PrdId  and A.PrdBatId = B.PrdBatId 
											WHERE TaxableAmount > 0 and TaxId > 1					
										)B  
										ON A.IDTMngRefNo=B.IDTMngRefNo and A.PrdId=B.PrdId and A.PrdBatId = B.PrdbatId)
									)  as IDTTax ON A.IDTMngRefNo = IDTTax.IDTMngRefNo and IDTTax.PrdId = E.PrdId
									   AND IDTTax.PrdBatId = E.PrdBatId	
							INNER JOIN RptIDTToPrint R ON A.IDTMngRefNo = R.IDTRefNumber and UsrId = @Pi_UsrId			
			WHERE 
				StkMgmtTypeId = 2 
			ORDER BY A.IDTMngRefNo
	END 
END
GO
--Percentagewise Scheme Free Products CR
DELETE FROM ScreenDefaultValues WHERE TransId = 45 AND CtrlId  =32 AND CtrlValue = 5
INSERT INTO ScreenDefaultValues
SELECT 45,32,5,'Percentagewise Free Product',5,1,1,1,GETDATE(),1,GETDATE(),'Percentagewise Free Product'
DELETE FROM ScreenDefaultValues WHERE TransId = 45 AND CtrlId  = 93
INSERT INTO ScreenDefaultValues
SELECT 45,93,0,'Gross Amount',0,1,1,1,GETDATE(),1,GETDATE(),'Gross Amount' UNION
SELECT 45,93,1,'Net Amount',1,1,1,1,GETDATE(),1,GETDATE(),'Net Amount'
GO
IF NOT EXISTS (SELECT * FROM SysColumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE Name = 'SchemeMaster' AND Xtype = 'U') AND name = 'AllowPFB')
BEGIN
   ALTER TABLE SchemeMaster ADD AllowPFB TINYINT DEFAULT 0 WITH VALUES
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE Xtype IN ('TF','FN') AND Name = 'Fn_ReturnSlabSchemeDetails')
DROP FUNCTION Fn_ReturnSlabSchemeDetails
GO
CREATE FUNCTION Fn_ReturnSlabSchemeDetails(@Pi_SchType INT,@Pi_SchId INT)
RETURNS @ReturnSlabDetailes TABLE
(
SlabId INT,
PurQty NUMERIC(36,0),
FROMQty NUMERIC(36,0),
PurUomId INT,
PurUom NVARCHAR(50),
FrmConFact NUMERIC(36,0),
ToQty NUMERIC(36,0),
PurToUomId INT,
PurToUom NVARCHAR(50),
ToConFact NUMERIC(36,0),
ForEveryQty NUMERIC(36,0),
PurofUomId INT,
PurofUom NVARCHAR(50),
PurofConFact NUMERIC(36,0),
DiscPer NUMERIC(36,4),
FlatAmt NUMERIC(36,4),
FlxDisc TINYINT,
FlxValueDisc TINYINT,
FlxFreePrd TINYINT,
FlxGiftPrd TINYINT,
FlxPoints TINYINT,
Points NUMERIC(36,4)
)
AS
BEGIN
/***********************************************************
Funcation Name   : Fn_ReturnSlabSchemeDetails
Added Date       : 2012/07/24
Added By         : Sathishkumar Veeramani
************************************************************/
IF @Pi_SchType = 3 ---Weight based scheme type
BEGIN
        INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
        DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points)
        SELECT DISTINCT SlabId,PurQty,FROMQty,SS.UomId AS PurUomId,Fp.PrdUnitCode AS PurUom,ToQty,ToUomId AS PurToUomId,Tp.PrdUnitCode AS PurToUom,
        ForEveryQty,ForEveryUomId AS PurofUomId,Ep.PrdUnitCode AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points 
        FROM SchemeSlabs SS WITH (NOLOCK),Productunit FP  WITH (NOLOCK),Productunit TP  WITH (NOLOCK),Productunit EP  WITH (NOLOCK)
        WHERE TP.Prdunitid = SS.Uomid AND EP.Prdunitid = SS.Uomid AND FP.prdunitid = SS.Uomid AND 
        SS.SchId = @Pi_SchId ORDER BY Slabid    
END
IF (@Pi_SchType = 1 OR @Pi_SchType = 5) --Quantity based scheme type
BEGIN
		INSERT INTO @ReturnSlabDetailes
		SELECT DISTINCT SlabId,PurQty,FROMQty,PurUomId,PurUom,FrmConFact,ToQty,
		ToUomId AS PurToUomId,PurToUom,ToConFact,ForEveryQty,ForEveryUomId AS PurofUomId,
		PurofUom,PurofConFact,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points
		FROM SchemeSlabs Z WITH(Nolock)INNER JOIN
		(SELECT UOMId AS PurUomId,UomCode AS PurUom,MAX(ConversionFactor) AS FrmConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)A 
		ON Z.UomId = A.PurUomId INNER JOIN
		(SELECT UOMId,UomCode AS PurToUom,MAX(ConversionFactor) AS ToConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)B
		ON Z.UomId = B.UOMId INNER JOIN
		(SELECT UOMId,UomCode AS PurofUom,MAX(ConversionFactor) AS PurofConFact FROM Fn_UomDetails()GROUP BY UOMId,UomCode)C
		ON Z.UomId = C.UOMId WHERE Z.SchId = @Pi_SchId ORDER BY SlabId
END      
ELSE IF @Pi_SchType <> 1 AND @Pi_SchType <> 3        
BEGIN
       INSERT INTO @ReturnSlabDetailes (SlabId,PurQty,FROMQty,PurUomId,PurUom,ToQty,PurToUomId,PurToUom,ForEveryQty,PurofUomId,PurofUom,
       DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,Points)
       SELECT DISTINCT SlabId,PurQty,FROMQty,UomId AS PurUomId,'' AS PurUom,ToQty,ToUomId AS PurToUomId,'' AS PurToUom,
       ForEveryQty,forEveryUomId AS PurofUomId,'' AS PurofUom,DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd, 
       FlxPoints,Points FROM SchemeSlabs SS WITH (NOLOCK) WHERE SS.SchId = @Pi_SchId ORDER BY Slabid
END
RETURN
END
GO
DELETE FROM CustomCaptions WHERE TransId = 274
INSERT INTO CustomCaptions
SELECT 274,1,1,'CoreHeaderTool','Apply Percentagewise Schemes','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Apply Percentagewise Schemes','','',1,1 UNION
SELECT 274,1,2,'CoreHeaderTool','Stocky','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Stocky','','',1,1 UNION
SELECT 274,2,1,'btnOperation','&OK','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'&OK','','',1,1 UNION
SELECT 274,2,2,'btnOperation','&Cancel','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'&Cancel','','',1,1 UNION
SELECT 274,3,1,'DgCommon-274-3-1','Selected','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Selected','','',1,1 UNION
SELECT 274,3,2,'DgCommon-274-3-2','Scheme Id','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Scheme Id','','',1,1 UNION
SELECT 274,3,3,'DgCommon-274-3-3','Scheme Code','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Scheme Code','','',1,1 UNION
SELECT 274,3,4,'DgCommon-274-3-4','Scheme Description','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Scheme Description','','',1,1 UNION
SELECT 274,3,5,'DgCommon-274-3-5','Percentage','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Percentage','','',1,1 UNION
SELECT 274,3,6,'DgCommon-274-3-6','Free Products','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Free Products','','',1,1 UNION
SELECT 274,4,1,'Msgbox-274-4-1','','','Enter the Free Products Details or Uncheck the Scheme',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Enter the Free Products Details or Uncheck the Scheme',1,1 UNION
SELECT 274,4,2,'Msgbox-274-4-2','','','Do you want Save the Data',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Do you want Save the Data',1,1 UNION
SELECT 274,5,1,'PnlMsg-274-5-1','','Press Insert Key to select the Free Products','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','Press Insert Key to select the Free Products','',1,1 UNION
SELECT 274,5,2,'PnlMsg-274-5-2','','Check the Scheme & Press Insert Key to Select the Free Products','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','Check the Scheme & Press Insert Key to Select the Free Products','',1,1
GO
DELETE FROM CustomCaptions WHERE TransId = 275
INSERT INTO CustomCaptions
SELECT 275,1,1,'CoreHeaderTool','Percentagewise Scheme Free Products','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Percentagewise Scheme Free Products','','',1,1 UNION
SELECT 275,1,2,'CoreHeaderTool','Stocky','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Stocky','','',1,1 UNION
SELECT 275,2,1,'btnOperation','&OK','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'&OK','','',1,1 UNION
SELECT 275,2,2,'btnOperation','&Cancel','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'&Cancel','','',1,1 UNION
SELECT 275,3,1,'DgCommon-275-3-1','Product Id','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Product Id','','',1,1 UNION
SELECT 275,3,2,'DgCommon-275-3-2','Product Code*...','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Product Code*...','','',1,1 UNION
SELECT 275,3,3,'DgCommon-275-3-3','Product Name*...','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Product Name*...','','',1,1 UNION
SELECT 275,3,4,'DgCommon-275-3-4','Batch Id','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Batch Id','','',1,1 UNION
SELECT 275,3,5,'DgCommon-275-3-5','UOM','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'UOM','','',1,1 UNION
SELECT 275,3,6,'DgCommon-275-3-6','UOM Conversion','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'UOM Conversion','','',1,1 UNION
SELECT 275,3,7,'DgCommon-275-3-7','Qty','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Qty','','',1,1 UNION
SELECT 275,3,8,'DgCommon-275-3-8','Selling Rate','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Selling Rate','','',1,1 UNION
SELECT 275,3,9,'DgCommon-275-3-9','Tax Amount','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Tax Amount','','',1,1 UNION
SELECT 275,3,10,'DgCommon-275-3-10','Amount','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Amount','','',1,1 UNION
SELECT 275,3,11,'DgCommon-275-3-11','Current Balance','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'Current Balance','','',1,1 UNION
SELECT 275,2000,1,'HotSch-275-2000-1','ProductCode','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'ProductCode','','',1,1 UNION
SELECT 275,2000,2,'HotSch-275-2000-2','ProductName','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'ProductName','','',1,1 UNION
SELECT 275,2000,3,'HotSch-275-2000-3','BatchCode','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'BatchCode','','',1,1 UNION
SELECT 275,2000,4,'HotSch-275-2000-4','SaleableStock','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'SaleableStock','','',1,1 UNION
SELECT 275,2000,5,'HotSch-275-2000-5','OfferStock','','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'OfferStock','','',1,1 UNION
SELECT 275,1000,1,'Msgbox-275-1000-1','','','Duplicate Product not Allowed',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Duplicate Product not Allowed',1,1 UNION
SELECT 275,1000,2,'Msgbox-275-1000-2','','','Free Product Amount Should not be greater than Scheme Amount',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Free Product Amount Should not be greater than Scheme Amount',1,1 UNION
SELECT 275,1000,3,'Msgbox-275-1000-3','','','Stock Not Available-Available Stock :',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Stock Not Available-Available Stock :',1,1 UNION
SELECT 275,1000,4,'Msgbox-275-1000-4','','','Qty Should be greater than Zero',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Qty Should be greater than Zero',1,1 UNION
SELECT 275,1000,5,'Msgbox-275-1000-5','','','Amount Should be greater than Zero',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Amount Should be greater than Zero',1,1 UNION
SELECT 275,1000,6,'Msgbox-275-1000-6','','','Current Scheme Amount Should not Less than Zero',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Current Scheme Amount Should not Less than Zero',1,1 UNION
SELECT 275,1000,7,'Msgbox-275-1000-7','','','Product Code Should not Empty',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Product Code Should not Empty',1,1 UNION
SELECT 275,3000,1,'PnlMsg-275-3000-1','','Press F4/Double Click to Select the Product','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','Press F4/Double Click to Select the Product','',1,1 UNION
SELECT 275,3000,2,'PnlMsg-275-3000-2','','Enter the QTY','',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','Enter the QTY','',1,1
GO
DELETE FROM CustomCaptions WHERE TransId = 2 AND CtrlId = 1000 AND SubCtrlId = 271
INSERT INTO CustomCaptions
SELECT 2,1000,271,'MsgBox-2-1000-271','','','Pending Transactions are Available for the Selected Retailer,BillNumber: ',1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),'','','Pending Transactions are Available for the Selected Retailer,BillNumber: ',1,1
GO
DELETE FROM HotSearchEditorHd WHERE FormId = 10088
INSERT INTO HotSearchEditorHd
SELECT 10088,'BILLING','Product','Select','SELECT DISTINCT A.PrdId,PrdDCode,PrdName,(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih)) AS SalableStock,
(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre)) AS OfferStock   FROM Product A WITH (NOLOCK)INNER JOIN ProductBatchLocation B WITH (NOLOCK) ON A.PrdId = B.PrdId
INNER JOIN UomGroup C WITH (NOLOCK) ON  A.UomGroupId = C.UomGroupId INNER JOIN UomMaster D WITH (NOLOCK) ON C.UomId = D.UomId     
WHERE A.PrdStatus = 1 AND D.UomCode = ''UnitCase'' GROUP BY A.PrdId,PrdDCode,PrdName 
HAVING ((SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))+(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre))) > 0'
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 10088
INSERT INTO HotSearchEditorDt
SELECT 1,'10088','Product','ProductCode','PrdDCode','1500',0,'HotSch-275-2000-1',275 UNION
SELECT 2,'10088','Product','ProductName','PrdName','2500',0,'HotSch-275-2000-2',275 UNION
--SELECT 3,'10088','Product','BatchCode','PrdBatCode','1500',0,'HotSch-275-2000-3',275 UNION
SELECT 3,'10088','Product','SalableStock','SalableStock','1500',0,'HotSch-275-2000-4',275 UNION
SELECT 4,'10088','Product','OfferStock','OfferStock','1500',0,'HotSch-275-2000-5',275
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'U' AND Name = 'BillAppliedSchemePerSchFreePrd')
DROP TABLE BillAppliedSchemePerSchFreePrd
GO
CREATE TABLE BillAppliedSchemePerSchFreePrd
(
 SchId        BIGINT,
 SchCode      NVARCHAR(100),
 SchDesc      NVARCHAR(200),
 SchSlabPerc  NUMERIC(18,2),
 BillAmt      NUMERIC(18,2),
 UsrId        NUMERIC(18,0)  
)
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType='P' AND name='Proc_PercentageSchemeTaxCalCulation')
DROP PROCEDURE Proc_PercentageSchemeTaxCalCulation
GO
--Exec Proc_SpecialRateTaxCalCulation 2,35
CREATE PROCEDURE Proc_PercentageSchemeTaxCalCulation
(
	@Prdid AS INT,
	@Prdbatid AS INT
	
)
AS
BEGIN
		DECLARE @TaxSettingDet TABLE       
		(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,2)      
		) 
		DECLARE @PrdBatTaxGrp AS INT
		DECLARE @PurSeqId AS INT
		DECLARE @BillSeqId AS INT
		DECLARE @RtrTaxGrp AS INT		 
		DECLARE @TaxSlab  INT  
		DECLARE @MRP INT    
		DECLARE @TaxableAmount  NUMERIC(28,10)      
		DECLARE @ParTaxableAmount NUMERIC(28,10)      
		DECLARE @TaxPer   NUMERIC(38,2)     
		DECLARE @TaxPercentage   NUMERIC(38,5)   
		DECLARE @TaxId   INT    
		--To Take the Batch TaxGroup Id      
		SELECT @PrdBatTaxGrp = TaxGroupId FROM ProductBatch A (NOLOCK) WHERE Prdid=@Prdid and  Prdbatid=@Prdbatid
		SELECT @BillSeqId = MAX(BillSeqId)  FROM BillSequenceMaster (NOLOCK)
		--SELECT @RtrTaxGrp=MIN(Distinct RtriD) FROM TaxSettingMaster (NOLOCK)
		--Added By Sathishkumar Veeramani 2013/07/10
		SELECT @RtrTaxGrp=MIN(DISTINCT RtriD) FROM TaxSettingMaster (NOLOCK) WHERE PrdId = @PrdBatTaxGrp
		--Till Here
		INSERT INTO @TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
		SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
		FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
		TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
		AND B.BillSeqId=@BillSeqId  and Coltype IN(1,3)    
		WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp     
		AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
		RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp)  
	
		SET @MRP=1
		TRUNCATE TABLE TempProductTax
		DECLARE  CurTax CURSOR FOR      
			SELECT DISTINCT TaxSlab FROM @TaxSettingDet      
		OPEN CurTax        
		FETCH NEXT FROM CurTax INTO @TaxSlab      
		WHILE @@FETCH_STATUS = 0        
		BEGIN      
		SET @TaxableAmount = 0      
		--To Filter the Records Which Has Tax Percentage (>=0)      
		IF EXISTS (SELECT * FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0 and ColVal >= 0)      
		BEGIN      
		--To Get the Tax Percentage for the selected slab      
		SELECT @TaxPer = ColVal FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0      
		--To Get the TaxId for the selected slab      
		SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId > 0      
		SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP 
		--To Get the Parent Taxable Amount for the Tax Slab      
		SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM TempProductTax A      
		INNER JOIN @TaxSettingDet B ON A.TaxId = B.ColVal and  
		B.ColType = 3 AND B.TaxSlab = @TaxSlab 
		If @ParTaxableAmount>0
		BEGIN
			Set @TaxableAmount=@ParTaxableAmount
		END 
		ELSE
		BEGIN
			Set @TaxableAmount = @TaxableAmount
		END    
		    
		--Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount      
		--Insert the New Tax Amounts  
		
		
		INSERT INTO TempProductTax (PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
		TaxAmount)      
		SELECT @Prdid,@Prdbatid,@TaxId,@TaxSlab,@TaxPer,      
		cast(@TaxableAmount*(@TaxPer / 100 ) AS NUMERIC(28,10))      
		 
		  
		END      
		FETCH NEXT FROM CurTax INTO @TaxSlab      
		END        
		CLOSE CurTax        
		DEALLOCATE CurTax      
		SELECT @TaxPercentage=Cast(ISNULL(SUM(TaxAmount)*100,0) as Numeric(18,5))
		FROM TempProductTax WHERE Prdid=@Prdid and Prdbatid=@Prdbatid
		--PRINT @TaxPercentage
		IF EXISTS(SELECT * FROM ProductBatchTaxPercent WHERE Prdid=@Prdid and Prdbatid=@Prdbatid)
		BEGIN			
			UPDATE ProductBatchTaxPercent  SET TaxPercentage=@TaxPercentage
			WHERE Prdid=@Prdid and Prdbatid=@Prdbatid
		END	
		ELSE
		BEGIN			
			INSERT INTO ProductBatchTaxPercent(Prdid,Prdbatid,TaxPercentage)
			SELECT @Prdid,@Prdbatid,@TaxPercentage
		END	
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_StockVerification')
DROP FUNCTION Fn_StockVerification
GO
CREATE FUNCTION Fn_StockVerification(@Pi_PrdId AS BIGINT,@Pi_PrdBatId AS BIGINT,@Pi_LcnId AS BIGINT)        
RETURNS @StockVerification TABLE         
 (        
   PrdId BIGINT,        
   TotalStock NUMERIC(18,0)         
 )        
AS         
BEGIN
/*********************************
* FUNCTION: Fn_StockVerification
* PURPOSE: Stock Verification
* NOTES:
* CREATED: Sathishkumar Veeramani 21/08/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*********************************/        
 INSERT INTO @StockVerification(PrdId,TotalStock) 
 SELECT DISTINCT PrdId,(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))+(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre)) AS TotalStock
 FROM ProductBatchLocation WITH (NOLOCK) WHERE PrdId = @Pi_PrdId AND LcnId = @Pi_LcnId GROUP BY PrdId 
 HAVING ((SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))+(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre))) > 0          
RETURN        
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_PercentageWiseSchemeBatchDetails')
DROP FUNCTION Fn_PercentageWiseSchemeBatchDetails
GO
CREATE FUNCTION Fn_PercentageWiseSchemeBatchDetails(@Pi_PrdId BIGINT)        
RETURNS @PercentagewiseSchemeBatchDetails TABLE         
 (    
   SlNo  NUMERIC(18,0) IDENTITY,    
   PrdId NUMERIC(18,0),        
   PrdBatId NUMERIC(18,0),
   PriceId NUMERIC(18,0),
   SelRate NUMERIC(18,6),
   OfferStock NUMERIC(18,0),
   SalableStock NUMERIC(18,0)         
 )        
AS         
BEGIN
/*********************************
* FUNCTION: Fn_PercentageWiseSchemeBatchDetails
* PURPOSE: Percentagewise Scheme Product Batch Details
* NOTES:
* CREATED: Sathishkumar Veeramani 21/08/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*********************************/ 
DECLARE @ProductBatchPerScheme TABLE
 ( 
   SlNo  NUMERIC(18,0) IDENTITY,         
   PrdId NUMERIC(18,0),        
   PrdBatId NUMERIC(18,0),
   PriceId NUMERIC(18,0),
   SelRate NUMERIC(18,6),
   OfferStock NUMERIC(18,0),
   SalableStock NUMERIC(18,0)         
 )  
    INSERT INTO @ProductBatchPerScheme(PrdId,PrdBatId,PriceId,SelRate,OfferStock,SalableStock)
    SELECT DISTINCT PrdId,PrdBatId,PriceId,SelRate,OfferStock,SalableStock FROM (
	SELECT DISTINCT A.PrdId,A.PrdBatId,C.PriceId,C.PrdBatDetailValue AS SelRate,(SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre)) AS OfferStock,
	(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih)) AS SalableStock  FROM ProductBatch A WITH (NOLOCK) 
	INNER JOIN ProductBatchLocation B WITH (NOLOCK) ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatID
	INNER JOIN ProductBatchDetails C WITH (NOLOCK) ON A.PrdBatId = C.PrdBatId AND A.DefaultPriceId = C.PriceId
	INNER JOIN BatchCreation BC WITH (NOLOCK) ON A.BatchSeqId = BC.BatchSeqId AND C.SLNo = BC.SlNo
	--INNER JOIN (SELECT DISTINCT PrdBatId,MAX(PriceId) AS PriceId FROM ProductBatchDetails WITH (NOLOCK) GROUP BY PrdBatId) D 
	--ON A.PrdBatId = D.PrdBatId  AND C.PriceId = D.PriceId
	WHERE A.[Status] = 1 AND BC.SelRte = 1 AND A.PrdId = @Pi_PrdId
	GROUP BY A.PrdId,A.PrdBatId,C.PriceId,C.PrdBatDetailValue 
	HAVING ((SUM(PrdBatLcnFre)-SUM(PrdBatLcnResFre))+(SUM(PrdBatLcnSih)-SUM(PrdBatLcnRessih))) > 0)Qry ORDER BY PrdId,OfferStock DESC
	
	    
	INSERT INTO @PercentagewiseSchemeBatchDetails(PrdId,PrdBatId,PriceId,SelRate,OfferStock,SalableStock) 
    SELECT PrdId,PrdBatId,PriceId,SelRate,OfferStock,SalableStock FROM @ProductBatchPerScheme ORDER BY SlNo    
 RETURN        
END
GO
IF NOT EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'U' AND Name = 'PercentageWiseSchemeFreeProducts')
BEGIN
--DROP TABLE PercentageWiseSchemeFreeProducts
CREATE TABLE PercentageWiseSchemeFreeProducts
(
	 SalId            NUMERIC(18,0),
	 RtrId            NUMERIC(18,0),
	 SchId            NUMERIC(18,0),      
	 PrdId            NUMERIC(18,0),
	 PrdBatId         NUMERIC(18,0),
	 UomId            NUMERIC(18,0),
	 Qty              NUMERIC(18,0),
	 SellRate         NUMERIC(18,6),
	 TaxAmount        NUMERIC(18,2),
	 PrdAmount        NUMERIC(18,2),
	 PrdSchBalAmt     NUMERIC(18,2),
	 UsrId            BIGINT  
)
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_PercentageWiseSchemeProductDetails')
DROP FUNCTION Fn_PercentageWiseSchemeProductDetails
GO
CREATE FUNCTION Fn_PercentageWiseSchemeProductDetails(@Pi_SalId NUMERIC(18,0),@Pi_SchId NUMERIC(18,0),@Pi_RtrId NUMERIC(18,0)) 
RETURNS @PercentagewiseSchemeProductDetails TABLE
 (    
	 SalId            NUMERIC(18,0),
	 RtrId            NUMERIC(18,0),
	 SchId            NUMERIC(18,0),  
	 PrdId            NUMERIC(18,0),
	 PrdCCode         NVARCHAR(200),
	 PrdName          NVARCHAR(200),
	 PrdBatId         NUMERIC(18,0),
	 UomId            NUMERIC(18,0),
	 Qty              NUMERIC(18,0),
	 SellRate         NUMERIC(18,6),
	 TaxAmount        NUMERIC(18,2),
	 PrdAmount        NUMERIC(18,2),
	 PrdSchBalAmt     NUMERIC(18,2)  
 )
AS
BEGIN
/*********************************
* FUNCTION: Fn_PercentageWiseSchemeProductDetails
* PURPOSE: Percentagewise Scheme Load Product Batch Details
* NOTES:
* CREATED: Sathishkumar Veeramani 21/08/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*********************************/
 
    INSERT INTO @PercentagewiseSchemeProductDetails(SalId,RtrId,SchId,PrdId,PrdCCode,PrdName,PrdBatId,
    UomId,Qty,SellRate,TaxAmount,PrdAmount,PrdSchBalAmt)
    SELECT DISTINCT SalId,RtrId,SchId,A.PrdId,PrdCCode,PrdName,PrdBatId,UomId,Qty,SellRate,TaxAmount,PrdAmount,PrdSchBalAmt
    FROM PercentageWiseSchemeFreeProducts A WITH (NOLOCK)
    INNER JOIN Product B WITH (NOLOCK) ON A.PrdId = B.PrdId WHERE SalId = @Pi_SalId AND SchId = @Pi_SchId AND RtrId = @Pi_RtrId

RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_ReturnBillSchemeDetails')
DROP FUNCTION Fn_ReturnBillSchemeDetails
GO
CREATE FUNCTION Fn_ReturnBillSchemeDetails (@Pi_UserId AS INT,@Pi_TransId AS INT)
RETURNS @ReturnBillSchemeDetails TABLE
	(
		SchId			INT,
		SchCode			VARCHAR(50),
		FlexiSch		INT,
		FlexiSchType	INT,
		SlabId			INT,
        SchemeAmount	NUMERIC(18,6),
		SchemeDiscount	NUMERIC(18,2),
		Points			INT,
		FlxDisc			INT,
        FlxValueDisc	INT,
		FlxFreePrd		INT,
		FlxGiftPrd		INT,
		FreePrdId		INT,
		FreePrdBatId	INT,
        FreeToBeGiven	INT,
		EditScheme		INT,
		NoOfTimes		NUMERIC(18,6),
		Usrid			INT,
		FlxPoints		INT,
        GiftPrdId		INT,
		GiftPrdBatId	INT,
		GiftToBeGiven	INT,
		SchType			INT
	)
AS
/*********************************
* FUNCTION: Fn_ReturnBillSchemeDetails
* PURPOSE: Return Billed Scheme Details
* NOTES:
* CREATED: Boopathy.P 0n 14/07/2011
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 06-08-2011 Boopathy.P Wrongly added prdbatid in Group by
*********************************/
BEGIN
		INSERT INTO @ReturnBillSchemeDetails
		SELECT DISTINCT A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,A.SlabId, 
		SUM(A.SchemeAmount) AS SchemeAmount, CASE A.SchType WHEN 0 THEN A.SchemeDiscount 
		WHEN 1 THEN SUM(A.SchemeDiscount) END AS SchemeDiscount,A.Points AS Points,A.FlxDisc,
		A.FlxValueDisc,A.FlxFreePrd,A.FlxGiftPrd,A.FreePrdId,A.FreePrdBatId, 
		SUM(A.FreeToBeGiven) AS FreeToBeGiven,B.EditScheme, A.NoOfTimes,A.Usrid,A.FlxPoints,
		A.GiftPrdId,A.GiftPrdBatId,SUM(A.GiftToBeGiven) AS GiftToBeGiven,A.SchType  
		FROM BillAppliedSchemeHd A INNER JOIN SchemeMaster B ON A.SchId = B.SchId WHERE 
		Usrid=@Pi_UserId AND TransId = @Pi_TransId AND B.CombiSch=1 AND B.SchType <> 5 GROUP BY A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,
		A.SlabId,A.FlxDisc,A.FlxValueDisc,A.FlxFreePrd, A.FlxGiftPrd,A.FreePrdId,
		A.FreePrdBatId,A.NoOfTimes,A.Points,A.Usrid,A.FlxPoints,A.GiftPrdId ,
		A.GiftPrdBatId,B.EditScheme,A.SchType,A.SchemeDiscount --ORDER BY A.SchId Asc,A.SlabId Asc
		UNION
		SELECT DISTINCT  A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,A.SlabId, 
		SUM(A.SchemeAmount) AS SchemeAmount, CASE A.SchType WHEN 0 THEN A.SchemeDiscount 
		WHEN 1 THEN SUM(A.SchemeDiscount) END AS SchemeDiscount,A.Points AS Points,A.FlxDisc,
		A.FlxValueDisc,A.FlxFreePrd,A.FlxGiftPrd,A.FreePrdId,A.FreePrdBatId, 
		SUM(A.FreeToBeGiven) AS FreeToBeGiven,B.EditScheme, A.NoOfTimes,A.Usrid,A.FlxPoints,
		A.GiftPrdId,A.GiftPrdBatId,SUM(A.GiftToBeGiven) AS GiftToBeGiven,A.SchType  
		FROM BillAppliedSchemeHd A INNER JOIN SchemeMaster B ON A.SchId = B.SchId WHERE B.SchType <> 5 AND
		Usrid=@Pi_UserId AND TransId = @Pi_TransId AND (B.FlexiSch+B.Range+B.QPS+B.QPSReset)=0 
		AND B.CombiSch=0 GROUP BY A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,
		A.SlabId,A.FlxDisc,A.FlxValueDisc,A.FlxFreePrd, A.FlxGiftPrd,A.FreePrdId,
		A.FreePrdBatId,A.NoOfTimes,A.Points,A.Usrid,A.FlxPoints,A.GiftPrdId ,
		A.GiftPrdBatId,B.EditScheme,A.SchType,A.SchemeDiscount--,A.PrdId --ORDER BY A.SchId Asc,A.SlabId Asc
		UNION
		SELECT DISTINCT  A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,A.SlabId, 
		SUM(A.SchemeAmount) AS SchemeAmount, CASE A.SchType WHEN 0 THEN A.SchemeDiscount 
		WHEN 1 THEN SUM(A.SchemeDiscount) END AS SchemeDiscount,A.Points AS Points,A.FlxDisc,
		A.FlxValueDisc,A.FlxFreePrd,A.FlxGiftPrd,A.FreePrdId,A.FreePrdBatId, 
		SUM(A.FreeToBeGiven) AS FreeToBeGiven,B.EditScheme, A.NoOfTimes,A.Usrid,A.FlxPoints,
		A.GiftPrdId,A.GiftPrdBatId,SUM(A.GiftToBeGiven) AS GiftToBeGiven,A.SchType  
		FROM BillAppliedSchemeHd A INNER JOIN SchemeMaster B ON A.SchId = B.SchId WHERE B.SchType <> 5 AND
		Usrid=@Pi_UserId AND TransId = @Pi_TransId AND B.CombiSch=0 AND (B.FlexiSch+B.Range+B.QPS+B.QPSReset) >0 GROUP BY A.SchId,A.SchCode,A.FlexiSch,A.FlexiSchType,
		A.SlabId,A.FlxDisc,A.FlxValueDisc,A.FlxFreePrd, A.FlxGiftPrd,A.FreePrdId,
		A.FreePrdBatId,A.NoOfTimes,A.Points,A.Usrid,A.FlxPoints,A.GiftPrdId ,
		A.GiftPrdBatId,B.EditScheme,A.SchType,A.SchemeDiscount,A.PrdId,A.PrdBatId ORDER BY A.SchId Asc,A.SlabId Asc
RETURN
END
GO
IF NOT EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'U' AND Name = 'PercentageWiseSchemeHD')
BEGIN
--drop table PercentageWiseSchemeHD
CREATE TABLE PercentageWiseSchemeHD
(
	 SalId            NUMERIC(18,0),
	 RtrId            NUMERIC(18,0),
	 SchId            NUMERIC(18,0),
	 SchCode          NVARCHAR(100),
	 SchDesc          NVARCHAR(200),
	 Selected         INT,        
	 SchSlabPerc      NUMERIC(18,2),
	 SchFreePrds      NVARCHAR(200),
	 PrevBalAmt       NUMERIC(18,2),
	 CurSchAmt        NUMERIC(18,2),
	 TotalSchAmt      NUMERIC(18,2),
	 TotalSchUtlzAmt  NUMERIC(18,2),
	 TotalSchBalAmt   NUMERIC(18,2),
	 ReturnSalId      NUMERIC(18,0),
	 ReturnAmt        NUMERIC(18,2),
	 NextBillRtnAmt   NUMERIC(18,2),
	 ReturnAdjStatus  INT,
	 [Upload]         INT,
	 UsrId            BIGINT  
)
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_ReturnBilledProductDt')
DROP FUNCTION Fn_ReturnBilledProductDt
GO
CREATE FUNCTION Fn_ReturnBilledProductDt(@Pi_SchId INT,@Pi_SlabId INT,@Pi_SchType INT,@Pi_UserId INT,@Pi_TransId INT)
RETURNS @BilledProduct TABLE
	(
		PrdDcode 	nVarChar(40),
		PrdBatCode 	nVarChar(100),
		SchemeOnQty	Numeric(38,0),
		SchemeOnAmount	Numeric(38,2),
		SchemeOnKg	Numeric(38,2),
		SchemeOnLitre	Numeric(38,2),
		PrdId		Int,
		PrdBatId	Int
	)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnBilledProduct
* PURPOSE: Returns the Billed Product Details for the Selected Scheme
* NOTES:
* CREATED: Thrinath Kola	24-04-2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*
*********************************/
IF @Pi_SchType=0 OR @Pi_SchType=5
BEGIN
	INSERT INTO @BilledProduct (PrdDcode,PrdBatCode,SchemeOnQty,SchemeOnAmount,SchemeOnKg,SchemeOnLitre,PrdId,PrdBatId)
	SELECT c.PrdDcode,E.PrdBatCode,ISNULL(SUM(A.BaseQty),0) AS SchemeOnQty,ISNULL(SUM(A.BaseQty * A.SelRate),0) AS SchemeOnAmount,
		ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 3 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnKg,
		ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 5 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnLitre,
		C.PrdId,A.PrdBatId
		FROM BilledPrdHdForScheme A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@Pi_SchId) B ON
		A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		INNER JOIN ProductBatch E ON E.PrdId = C.PrdId AND E.PrdBatId = A.PrdBatId
		WHERE A.Usrid = @Pi_UserId AND A.TransId = @Pi_TransId
		GROUP BY C.PrdDcode,E.PrdBatCode,D.PrdUnitId,C.PrdId,A.PrdBatId
END
ELSE IF @Pi_SchType=1 
BEGIN
	INSERT INTO @BilledProduct (PrdDcode,PrdBatCode,SchemeOnQty,SchemeOnAmount,SchemeOnKg,SchemeOnLitre,PrdId,PrdBatId)
	SELECT c.PrdDcode,E.PrdBatCode,ISNULL(SUM(A.BaseQty),0) AS SchemeOnQty,ISNULL(SUM(A.BaseQty * A.SelRate),0) AS SchemeOnAmount,
		ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 3 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnKg,
		ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000
		WHEN 5 THEN ISNULL(SUM(PrdWgt * A.BaseQty),0) END,0) AS SchemeOnLitre,
		C.PrdId,A.PrdBatId
		FROM BilledPrdHdForScheme A (NOLOCK) INNER JOIN Fn_ReturnSchemeAnotherProduct(@Pi_SchId,@Pi_SlabId) B ON
		A.PrdId = B.PrdId --AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
		INNER JOIN Product C ON A.PrdId = C.PrdId
		INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
		INNER JOIN ProductBatch E ON E.PrdId = C.PrdId AND E.PrdBatId = A.PrdBatId
		WHERE A.Usrid = @Pi_UserId AND A.TransId = @Pi_TransId
		GROUP BY C.PrdDcode,E.PrdBatCode,D.PrdUnitId,C.PrdId,A.PrdBatId
END

RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_ReturnApplicableSchemeProductSlab')
DROP FUNCTION Fn_ReturnApplicableSchemeProductSlab
GO
--SELECT DISTINCT * FROM Fn_ReturnApplicableSchemeProductSlab ('2013-08-30',2,1)
CREATE FUNCTION Fn_ReturnApplicableSchemeProductSlab(@Pi_BillDate AS VARCHAR(10),@Pi_TransId AS INT,@Pi_UsrId AS INT)
RETURNS @ApplicableSlab TABLE
	(
	    SchId    NUMERIC(18,0),
        AllowPFB INT
	)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnApplicableSchemeProductSlab
* PURPOSE: Returns the Percentage Wise Scheme Slabs which are applicable for the Selected Scheme
* NOTES: 
* CREATED: Thrinath Kola	30-08-2013
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 
*********************************/
DECLARE @SchemeReturnSlabs TABLE
(
  SchId NUMERIC(18,0),
  AllowPFB INT,
  PrdId NUMERIC(18,0),
  SlabQty NUMERIC(18,0),
  BaseQty NUMERIC(18,0)
)
    
    INSERT INTO @SchemeReturnSlabs (SchId,AllowPFB,PrdId,SlabQty,BaseQty)
    SELECT DISTINCT B.SchId,C.AllowPFB,A.PrdId,(F.ConversionFactor * CAST(PurQty AS NUMERIC(18,0))) AS SlabQty,BaseQty  
    FROM BilledPrdHdForScheme A WITH (NOLOCK)
    INNER JOIN Fn_ReturnApplicableProduct(@Pi_BillDate) B ON A.PrdId = B.PrdId 
    INNER JOIN SchemeMaster C WITH (NOLOCK) ON C.SchId = B.SchId 
    INNER JOIN SchemeSlabs D WITH (NOLOCK)  ON B.SchId = D.SchId AND C.SchId = D.SchId
    INNER JOIN Product E WITH (NOLOCK) ON A.PrdId = E.PrdId AND B.PrdId = E.PrdId
    INNER JOIN UomGroup F WITH (NOLOCK) ON E.UomGroupId = F.UomGroupId AND D.UomId = F.UomId
    WHERE C.SchStatus=1 AND C.SchType = 5 AND A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId AND  C.SchValidTill >= @Pi_BillDate 
   
    INSERT INTO @ApplicableSlab (SchId,AllowPFB)
    SELECT DISTINCT SchId,AllowPFB FROM @SchemeReturnSlabs WHERE  BaseQty >=SlabQty

   
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XTYPE = 'P' AND name = 'Proc_ReturnPercentageWiseSchemeFreeProducts')
DROP PROCEDURE Proc_ReturnPercentageWiseSchemeFreeProducts
GO
--EXEC Proc_ReturnPercentageWiseSchemeFreeProducts 2,850,206,0,0
CREATE PROCEDURE Proc_ReturnPercentageWiseSchemeFreeProducts
(
    @Pi_RtnType   INT,
	@Pi_SalId     BIGINT,
	@Pi_RtrId	  BIGINT,
	@Pi_SchId     BIGINT,
	@Pi_ReturnAmt NUMERIC(18,2)
)
AS
/****************************************************************************
* PROCEDURE: Proc_ReturnPercentageWiseSchemeFreeProducts
* PURPOSE: Return Percentage Wise Scheme Values 
* NOTES:
* CREATED: Sathhishkumar Veeramani 2013/08/31
* MODIFIED
* DATE         AUTHOR     DESCRIPTION
------------------------------------------------------------------------------
*****************************************************************************/
SET NOCOUNT ON
BEGIN
    IF @Pi_RtnType = 1 --Partial Return
    BEGIN
        UPDATE PercentagewiseSchemeHd SET ReturnSalId = @Pi_SalId,ReturnAmt = (ReturnAmt + @Pi_ReturnAmt),ReturnAdjStatus = 1 
        WHERE SalId = @Pi_SalId AND RtrId = @Pi_RtrId AND SchId = @Pi_SchId
        
        --Delivery Bill
	    UPDATE A SET A.NextBillRtnAmt = (A.NextBillRtnAmt + @Pi_ReturnAmt) FROM PercentagewiseSchemeHd A WITH (NOLOCK) INNER JOIN
	    (SELECT DISTINCT A.RtrId,SchId,MAX(A.SalId) AS SalId FROM PercentagewiseSchemeHd A WITH (NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND Dlvsts > 3 AND A.RtrId = @Pi_RtrId AND SchId = @Pi_SchId GROUP BY A.RtrId,SchId) B 
	    ON A.SalId = B.SalId AND A.RtrId = B.RtrId AND A.SchId = B.SchId INNER JOIN (SELECT DISTINCT RtrId,SchId,ReturnAmt 
	    FROM PercentagewiseSchemeHd WITH (NOLOCK) WHERE SalId = @Pi_SalId AND RtrId = @Pi_RtrId AND SchId = @Pi_SchId) C 
	    ON A.RtrId = C.RtrId AND A.SchId = C.SchId WHERE A.RtrId = @Pi_RtrId AND A.SchId = @Pi_SchId
	    
	    --Pending Bill
	    UPDATE A SET A.NextBillRtnAmt = (A.NextBillRtnAmt + @Pi_ReturnAmt) FROM PercentagewiseSchemeHd A WITH (NOLOCK) INNER JOIN
	    (SELECT DISTINCT A.RtrId,SchId,MAX(A.SalId) AS SalId FROM PercentagewiseSchemeHd A WITH (NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND Dlvsts < 3 AND A.RtrId = @Pi_RtrId AND SchId = @Pi_SchId GROUP BY A.RtrId,SchId) B 
	    ON A.SalId = B.SalId AND A.RtrId = B.RtrId AND A.SchId = B.SchId INNER JOIN (SELECT DISTINCT RtrId,SchId,ReturnAmt 
	    FROM PercentagewiseSchemeHd WITH (NOLOCK) WHERE SalId = @Pi_SalId AND RtrId = @Pi_RtrId AND SchId = @Pi_SchId) C 
	    ON A.RtrId = C.RtrId AND A.SchId = C.SchId WHERE A.RtrId = @Pi_RtrId AND A.SchId = @Pi_SchId
	    
	    UPDATE PercentagewiseSchemeHd SET ReturnAdjStatus = 1 WHERE RtrId = @Pi_RtrId AND SalId = @Pi_SalId AND SchId = @Pi_SchId
	    
    END
    ELSE IF @Pi_RtnType = 2 --Full Return
    BEGIN
		UPDATE PercentagewiseSchemeHd SET ReturnSalId = @Pi_SalId,ReturnAmt = (TotalSchBalAmt-PrevBalAmt),ReturnAdjStatus = 0
	    WHERE SalId = @Pi_SalId AND RtrId = @Pi_RtrId
	    
	    --Delivery Bill
	    UPDATE A SET A.NextBillRtnAmt = (A.NextBillRtnAmt + C.ReturnAmt) FROM PercentagewiseSchemeHd A WITH (NOLOCK) INNER JOIN
	    (SELECT DISTINCT A.RtrId,SchId,MAX(A.SalId) AS SalId FROM PercentagewiseSchemeHd A WITH (NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND Dlvsts > 3 AND A.RtrId = @Pi_RtrId GROUP BY A.RtrId,SchId) B ON A.SalId = B.SalId AND A.RtrId = B.RtrId 
	    AND A.SchId = B.SchId INNER JOIN (SELECT DISTINCT RtrId,SchId,ReturnAmt FROM PercentagewiseSchemeHd WITH (NOLOCK) WHERE SalId = @Pi_SalId
	    AND RtrId = @Pi_RtrId) C ON A.RtrId = C.RtrId AND A.SchId = C.SchId WHERE A.RtrId = @Pi_RtrId
	    
	    --Pending Bill
	    UPDATE A SET A.NextBillRtnAmt = (A.NextBillRtnAmt + C.ReturnAmt) FROM PercentagewiseSchemeHd A WITH (NOLOCK) INNER JOIN
	    (SELECT DISTINCT A.RtrId,SchId,MAX(A.SalId) AS SalId FROM PercentagewiseSchemeHd A WITH (NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND Dlvsts < 3 AND A.RtrId = @Pi_RtrId GROUP BY A.RtrId,SchId) B ON A.SalId = B.SalId AND A.RtrId = B.RtrId 
	    AND A.SchId = B.SchId INNER JOIN (SELECT DISTINCT RtrId,SchId,ReturnAmt FROM PercentagewiseSchemeHd WITH (NOLOCK) WHERE SalId = @Pi_SalId
	    AND RtrId = @Pi_RtrId) C ON A.RtrId = C.RtrId AND A.SchId = C.SchId	WHERE A.RtrId = @Pi_RtrId 
	    
	    UPDATE PercentagewiseSchemeHd SET ReturnAdjStatus = 1 WHERE RtrId = @Pi_RtrId AND SalId = @Pi_SalId   
	    
    END
END
GO
DELETE FROM HotSearcheditorHd WHERE FormId = 569
INSERT INTO HotSearcheditorHd
SELECT 569,'Purchase Order','Product with Supplier','select',
'SELECT DISTINCT PrdSeqDtId,PrdId,PrdDCode,PrdCCode,PrdName,PrdShrtName,UomId,UomDescription,SysQty,UomId2,UomDescription2,OrderQty FROM
(SELECT Distinct C.PrdSeqDtId, P.PrdId,P.PrdDCode,P.PrdCCode,P.PrdName,P.PrdShrtName,U.UomId,U.UomDescription,0 as SysQty,
U.UomId UomId2,U.UomDescription UomDescription2,0 as OrderQty FROM Product P,UomMaster U ,UomGroup UG,ProductSequence B WITH (NOLOCK),
ProductSeqDetails C WITH (NOLOCK),ProductCategoryValue PCV (NOLOCK)WHERE P.UomGroupId = UG.UomGroupId  and UG.UomId = U.UomId 
AND CmpId = vFParam AND SpmId =vSParam AND B.TransactionId = 26 AND P.PrdStatus=1 AND P.PrdType <> 3 AND B.PrdSeqId = C.PrdSeqId     
AND P.PrdId = C.PrdId  AND P.PrdCtgValMainId=PCV.PrdCtgValMainId AND PCV.PrdCtgValLinkCode LIKE ''vTParam%''     
UNION SELECT DISTINCT 100000 AS PrdSeqDtId,P.PrdId,P.PrdDCode,P.PrdCCode,P.PrdName,P.PrdShrtName,U.UomId,U.UomDescription,0 as SysQty,
U.UomId UomId2,U.UomDescription UomDescription2,0 as OrderQty FROM Product P,UomMaster U,UomGroup UG,ProductCategoryValue PCV (NOLOCK)
WHERE P.UomGroupId = UG.UomGroupId AND UG.UomId = U.UomId AND UomCode = ''UnitCase'' AND CmpId = vFParam and SpmId =vSParam AND PrdStatus = 1 AND PrdType<> 3 
AND PrdId NOT IN (SELECT PrdId FROM ProductSequence B WITH (NOLOCK),ProductSeqDetails C WITH (NOLOCK) WHERE B.TransactionId=26 AND B.PrdSeqId=C.PrdSeqId)
AND P.PrdCtgValMainId=PCV.PrdCtgValMainId   AND PCV.PrdCtgValLinkCode LIKE ''vTParam%'') A  ORDER BY PrdSeqDtId'
GO
DELETE FROM HotSearcheditorHd WHERE FormId = 812
INSERT INTO HotSearcheditorHd
SELECT 812,'Purchase Order','Product Batch','Select',
'SELECT PB.PrdBatId,PB.PrdBatCode,PBD.PrdBatDetailValue AS ListPrice,PBD.PriceId FROM ProductBatch PB,ProductBatchDetails PBD,BatchCreation BC 
WHERE PB.PrdBatId=PBD.PrdBatId AND BC.BatchSeqId=PBD.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.ListPrice=1 
AND PB.PrdId= vFParam AND PB.Defaultpriceid=PBD.Priceid'
GO
IF EXISTS(SELECT * FROM Sysobjects WHERE name = 'Proc_ReturnSchemeClaims' AND XType = 'P')
DROP PROCEDURE Proc_ReturnSchemeClaims
GO
--EXEC Proc_ReturnSchemeClaims 17,0,1,'2009-05-01','2009-05-31',1,16
CREATE PROCEDURE Proc_ReturnSchemeClaims
(
	@Pi_ClmGroupId 		INT,
	@Pi_ClmId		INT,
	@Pi_CmpId		INT,
	@Pi_FromDate		DATETIME,
	@Pi_ToDate		DATETIME,
	@Pi_SettleType	INT,
	@Pi_UsrId 		INT,
	@Pi_TransId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_ReturnSchemeClaims
* PURPOSE	: To Return Scheme Claims
* CREATED	: Thrinath
* CREATED DATE	: 04/12/2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
Begin
DECLARE @SchMst Table
(
	SchId 	INT,
	SchCode	nVarchar(100),
	SchDesc	nVarChar(100),
	SchType INT
)
DECLARE @SchemeDetails TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SchCode			nVarchar(100),
	SchDesc			nVarChar(100),
	SlabId			INT,
	DiscountAmt		Numeric(38,6),
	FreeAmt			Numeric(38,6),
	GiftAmt			Numeric(38,6),
	Type			INT
)
DECLARE @SchemePrd 	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	Combi			nVarChar(100)
)
DECLARE @PriScheme	TABLE
(
	SalInvNo		nVarChar(100),
	SchId			INT,
	SlabId			INT, 
	PrdId			INT,
	PrdBatId		INT,
	PriAmt			Numeric(38,6)
)
DECLARE @Claimable	Numeric(38,6)
DECLARE @RefCode	nVarChar(100)
	SELECT @Claimable = Claimable FROM ClaimNormDefinition 
		WHERE CmpID=@Pi_CmpId AND ClmGrpId=@Pi_ClmGroupId
	SET @Claimable = ISNULL(@Claimable,0)
	INSERT INTO @SchMst(SchId,SchCode,SchDesc,SchType) 
	SELECT SchId,SchCode,SchDsc,SchType FROM SchemeMaster WITH (NOLOCK)
	WHERE CmpId = @Pi_CmpId AND	Claimable = 1 AND ClmRefId = @Pi_ClmGroupId 
	AND SettlementType = (CASE @Pi_SettleType WHEN 0 THEN SettlementType ELSE @Pi_SettleType END)
	IF EXISTS (SELECT Status FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 )
	BEGIN
		SELECT @RefCode = Condition FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 
		INSERT INTO @SchemePrd (SalInvNo,SchId,SlabId,PrdId,PrdBatId,Combi)
		SELECT B.SalInvno,MIN(A.SchId),E.SlabId,A.PrdId,A.PrdBatId,
			CAST(MIN(A.SchId) as nVarChar(15)) + ' - ' + CAST(E.SlabId as nVarChar(15))
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN (SELECT Y.SalInvno,X.SchId,X.PrdId,X.PrdBatId,MIN(SlabId) as SlabId 
				FROM SalesInvoiceSchemeLineWise X 
				INNER JOIN SalesInvoice Y ON X.SalId = Y.SalId 
				INNER JOIN @SchMst Z ON X.SchId = Z.SchId
				WHERE Y.DlvSts in (4,5) AND X.SchClmId in (0,@Pi_ClmId) AND Z.SchType <> 5
				AND Y.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
				GROUP BY Y.SalInvno,X.SchId,X.PrdId,X.PrdBatId) AS E ON
			E.SalInvNo = B.SalInvNo AND E.PrdId = A.PrdId AND E.PrdBatId = A.PrdBatId
			AND E.SchId = A.SchId
			WHERE B.DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,E.SlabId,A.PrdId,A.PrdBatId		
		
		INSERT INTO  @PriScheme	(SalInvNo,SchId,SlabId,PrdId,PrdBatId,PriAmt)
		SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,
			C.PrdGrossAmount - (C.PrdGrossAmount /(1 +(D.PrdBatDetailValue)/100)) 		
		FROM @SchemePrd B INNER JOIN SalesInvoice A ON A.SalInvNo collate database_default= B.SalInvno collate database_default
			INNER JOIN SalesInvoiceProduct C ON A.SalId = C.SalId
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
	   		
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.SalInvno,A.SchId,A.SlabId,ISNULL(SUM(FlatAmount),0) +  ISNULL(SUM(DiscountPerAmount),0),
			0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc

		-- Credit Note Adjustement ---
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.SalInvno,A.SchId,0 AS SlabId,ISNULL(SUM(CrNoteAmount),0) ,
			0 as FreeAmt,0 as GiftAmt,S.SchCode,S.SchDesc,1
			FROM SalesInvoiceQPSSchemeAdj A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) 
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate AND S.SchType <> 5
		GROUP BY B.SalInvno,A.SchId,S.SchCode,S.SchDesc
        -- End here 

		UPDATE @SchemeDetails SET DiscountAmt = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(PriAmt) as PriAmt
				FROM @PriScheme GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
	END
	ELSE
	BEGIN
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.SalInvno,A.SchId,A.SlabId,ISNULL(SUM(FlatAmount),0) +  ISNULL(SUM(DiscountPerAmount),0),
			0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1
			FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc

		-- Credit note adjustment ---
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.SalInvno,A.SchId,0 AS SlabId,ISNULL(SUM(CrNoteAmount),0),
			0 as FreeAmt,0 as GiftAmt,S.SchCode,S.SchDesc,1
			FROM SalesInvoiceQPSSchemeAdj A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE DlvSts in (4,5) AND S.SchType <> 5
			AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.SalInvno,A.SchId,S.SchCode,S.SchDesc
       -- End here --
	END
	
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(FreeQty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,1
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	
	--Added by Sathishkumar Veeramani 2013/09/06
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(PrdAmount),0),0 AS GiftAmt,SchCode,SchDesc,1
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
        INNER JOIN PercentageWiseSchemeFreeProducts C WITH (NOLOCK) ON B.SalId = C.SalId
        AND A.FreePrdId = C.PrdId 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType = 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate 
		AND C.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE Status = 0 AND InvoiceType = 1 AND ReturnMode = 1)
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	--Till Here
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.SalInvno,A.SchId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(GiftQty * D.PrdBatDetailValue),0),SchCode,SchDesc,1
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,A.SlabId,SchCode,SchDesc
	IF EXISTS (SELECT Status FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 )
	BEGIN
		SELECT @RefCode = Condition FROM Configuration WHERE ModuleId = 'SCHEMESTNG14' AND Status = 1 
		DELETE FROM @SchemePrd
		DELETE FROM @PriScheme
		INSERT INTO @SchemePrd (SalInvNo,SchId,SlabId,PrdId,PrdBatId,Combi)
		SELECT B.ReturnCode,MIN(A.SchId),E.SlabId,A.PrdId,A.PrdBatId,
			CAST(MIN(A.SchId) as nVarChar(15)) + ' - ' + CAST(E.SlabId as nVarChar(15))
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId  
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			INNER JOIN (SELECT Y.ReturnCode,X.SchId,X.PrdId,X.PrdBatId,MIN(SlabId) as SlabId 
				FROM ReturnSchemeLineDt X 
				INNER JOIN ReturnHeader Y ON X.ReturnId = Y.ReturnId 
				INNER JOIN @SchMst Z ON X.SchId = Z.SchId
				WHERE Y.Status = 0 AND X.SchClmId in (0,@Pi_ClmId) AND Z.SchType <> 5
				AND Y.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
				GROUP BY Y.ReturnCode,X.SchId,X.PrdId,X.PrdBatId) AS E ON
			E.ReturnCode = B.ReturnCode AND E.PrdId = A.PrdId AND E.PrdBatId = A.PrdBatId
			AND E.SchId = A.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,E.SlabId,A.PrdId,A.PrdBatId		
		INSERT INTO  @PriScheme	(SalInvNo,SchId,SlabId,PrdId,PrdBatId,PriAmt)
		SELECT DISTINCT B.SalInvNo,B.SchId,B.SlabId,B.PrdId,B.PrdBatId,
			C.PrdActualGross - (C.PrdActualGross /(1 +(D.PrdBatDetailValue)/100)) 		
		FROM @SchemePrd B INNER JOIN ReturnHeader A ON A.ReturnCode collate database_default= B.SalInvno collate database_default
			INNER JOIN ReturnProduct C ON A.ReturnId = C.ReturnId 
			AND B.PrdId = C.PrdId AND B.PrdBatId = C.PrdBatId
			INNER JOIN ProductBatchDetails D ON D.PrdBatId = C.PrdBatId 
			AND D.DefaultPrice=1 INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId
	   		AND E.Slno = D.Slno AND E.RefCode = @RefCode
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.ReturnCode,A.SchId,A.SlabId,((ISNULL(SUM(ReturnFlatAmount),0) + 
			ISNULL(SUM(ReturnDiscountPerAmount),0)))*(-1),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
		UPDATE @SchemeDetails SET DiscountAmt = DiscountAmt - (B.PriAmt) FROM 
			@SchemeDetails A INNER JOIN (SELECT SalInvno,SchId,SlabId,SUM(PriAmt) as PriAmt
				FROM @PriScheme GROUP BY SalInvno,SchId,SlabId) B ON
			A.SalInvNo collate database_default= B.SalInvNo collate database_default AND A.SchId = B.SchId AND
			A.SlabId = B.SlabId 
	END
	ELSE
	BEGIN
		INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
		SELECT B.ReturnCode,A.SchId,A.SlabId,((ISNULL(SUM(ReturnFlatAmount),0) + 
			ISNULL(SUM(ReturnDiscountPerAmount),0)))*(-1),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,1
			FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
			INNER JOIN @SchMst S ON A.SchId = S.SchId
			WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
			AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
		GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	END
			--select DiscountAmt from @SchemeDetails	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.ReturnCode,A.SchId,A.SlabId,0 as DiscountAmt,
		ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)*(-1),0 as GiftAmt,SchCode,SchDesc,1
		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.ReturnCode,A.SchId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)*(-1),SchCode,SchDesc,1
		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId 
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE B.Status = 0 AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.ReturnDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.ReturnCode,A.SchId,A.SlabId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.SalInvno,A.SchId,1 as SlabId,ISNULL(SUM(AdjAmt),0),0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,2
		FROM SalesInvoiceWindowDisplay A 
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
		INNER JOIN @SchMst S ON A.SchId = S.SchId
		WHERE DlvSts in (4,5) AND A.SchClmId in (0,@Pi_ClmId) AND S.SchType <> 5
		AND B.SalInvDate Between @Pi_FromDate AND @Pi_ToDate
	GROUP BY B.SalInvno,A.SchId,SchCode,SchDesc
	
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.ChqDisRefNo,A.TransId,1 as SlaId,ISNULL(SUM(Amount),0),
		0 as FreeAmt,0 as GiftAmt,SchCode,SchDesc,3 
		FROM ChequeDisbursalMaster A 
		INNER JOIN ChequeDisbursalDetails B ON A.ChqDisRefNo = B.ChqDisRefNo 
		INNER JOIN @SchMst S ON A.TransId = S.SchId
		WHERE TransType = 1 AND S.SchType <> 5 AND A.ChqDisDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.ChqDisRefNo,A.TransId,SchCode,SchDesc
-- FOR Point Based Schemes
	DELETE FROM @SchMst
	INSERT INTO @SchMst(SchId,SchCode,SchDesc) 
	SELECT PntRedSchId,PntRedSchCode,[Description]
 		FROM PointRedemptionMaster WHERE CmpId = @Pi_CmpId AND
		Claimable = 1 AND ClmRefId = @Pi_ClmGroupId
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,ISNULL(SUM(CrAmt),0),0 as FreeAmt,0 As GiftAmt,
		SchCode,SchDesc,4
		FROM PntRetSchemeHD A INNER JOIN PntRetSchemeDt B
		ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN @SchMst S ON A.PntRedSchId = S.SchId
		WHERE A.Status = 1 AND A.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt>0 AND B.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,0 as DiscountAmt,ISNULL(SUM(Qty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,4
		FROM PntRetSchemeDt A INNER JOIN PntRetSchemeHD B ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.PntRedSchId = S.SchId
		WHERE B.Status = 1 AND B.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt=0 AND A.Type=1 AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT A.PntRedRefNo,PntRedSchId,SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(Qty * D.PrdBatDetailValue),0) as GiftAmt,SchCode,SchDesc,4
		FROM PntRetSchemeDt A INNER JOIN PntRetSchemeHD B ON A.PntRedRefNo = B.PntRedRefNo
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.PntRedSchId = S.SchId
		WHERE B.Status = 1 AND B.TransDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt=0 AND A.Type=2 AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.PntRedRefNo,PntRedSchId,SlabId,SchCode,SchDesc
--For Coupon Scheme
	DELETE FROM @SchMst
	INSERT INTO @SchMst(SchId,SchCode,SchDesc) 
	SELECT B.CouponDenomId,B.CouponDenomRefNo,A.CouponDefDescription
 		FROM CouponDefinitionHd A INNER JOIN CouponDenomHd B ON
		A.CouponDefId = B.CouponDefId WHERE A.CmpId = @Pi_CmpId AND 
		A.CouponDefClaimable = 1 AND A.CouponDefClaimGroupID = @Pi_ClmGroupId
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT A.CpnRedCode,A.CouponDenomId,B.SlabId,ISNULL(SUM(CrAmt),0),0 as FreeAmt,0 As GiftAmt,
		SchCode,SchDesc,5
		FROM CouponRedHd A INNER JOIN CouponRedOtherDt B
		ON A.CpnRefId = B.CpnRefId
		INNER JOIN @SchMst S ON A.CouponDenomId = S.SchId
		WHERE A.Status = 1 AND A.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND CrAmt>0 AND B.SchClmId in (0,@Pi_ClmId)
	GROUP BY A.CpnRedCode,A.CouponDenomId,B.SlabId,SchCode,SchDesc
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.CpnRedCode,B.CouponDenomId,A.SlabId,0 as DiscountAmt,ISNULL(SUM(Qty * D.PrdBatDetailValue),0),
		0 as GiftAmt,SchCode,SchDesc,5
		FROM CouponRedProducts A INNER JOIN CouponRedHd B ON A.CpnRefId = B.CpnRefId
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.CouponDenomId = S.SchId
		INNER JOIN Product P ON P.PrdId = A.PrdId AND P.PrdId = C.PrdId AND PrdType <> 4
		WHERE B.Status = 1 AND B.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.CpnRedCode,B.CouponDenomId,A.SlabId,SchCode,SchDesc
	INSERT INTO @SchemeDetails (SalInvNo,SchId,SlabId,DiscountAmt,FreeAmt,GiftAmt,SchCode,SchDesc,Type)
	SELECT B.CpnRedCode,B.CouponDenomId,A.SlabId,0 as DiscountAmt,0 as FreeAmt,
		ISNULL(SUM(Qty * D.PrdBatDetailValue),0) as GiftAmt,SchCode,SchDesc,5
		FROM CouponRedProducts A INNER JOIN CouponRedHd B ON A.CpnRefId = B.CpnRefId
		INNER JOIN ProductBatch C (NOLOCK) ON A.PrdId = C.PrdId AND 
		A.PrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
	        ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		INNER JOIN @SchMst S ON B.CouponDenomId = S.SchId
		INNER JOIN Product P ON P.PrdId = A.PrdId AND P.PrdId = C.PrdId AND PrdType =4
		WHERE B.Status = 1 AND B.CpnRedDate Between @Pi_FromDate AND @Pi_ToDate
		AND A.SchClmId in (0,@Pi_ClmId)
	GROUP BY B.CpnRedCode,B.CouponDenomId,A.SlabId,SchCode,SchDesc
	DELETE FROM TempSchemeClaimDetails WHERE Usrid = @Pi_UsrId AND TransID = @Pi_TransId
--	INSERT INTO TempSchemeClaimDetails (SalInvNo,SchId,SchCode,SchDesc,SlabId,Selected,DiscountAmt,
--		FreeAmt,GiftAmt,TotSpent,Claimable,ClaimableAmt,RecomAmount,RecAmount,DBCRSelection,
--		StatusDesc,Type,Usrid,TransID)
--	SELECT SalInvNo,SchId,SchCode,SchDesc,SlabId,0 as Selected,
--		Convert(Numeric(38,2),Sum(DiscountAmt)) ,
--		Convert(Numeric(38,2),sum(FreeAmt)) ,
--		Convert(Numeric(38,2),Sum(GiftAmt)), 
--		Convert(Numeric(38,2),Sum((DiscountAmt + FreeAmt + GiftAmt))) ,
--		ISNULL(@Claimable,0) , 0.00 , 0 , 0  , 0 ,'Cancelled', Type, @Pi_UsrId,@Pi_TransId
--		FROM @SchemeDetails
--	GROUP BY SalInvNo,SchId,SchCode,SchDesc,SlabId,Type
	INSERT INTO TempSchemeClaimDetails (SalInvNo,SchId,SchCode,CmpSchCode,SchDesc,SlabId,Selected,DiscountAmt,
		FreeAmt,GiftAmt,TotSpent,Claimable,ClaimableAmt,RecomAmount,RecAmount,DBCRSelection,
		StatusDesc,Type,Usrid,TransID)
	SELECT SD.SalInvNo,SD.SchId,SD.SchCode,SM.CmpSchCode,SD.SchDesc,SD.SlabId,0 as Selected,
		Convert(Numeric(38,2),Sum(DiscountAmt)) ,
		Convert(Numeric(38,2),sum(FreeAmt)) ,
		Convert(Numeric(38,2),Sum(GiftAmt)), 
		Convert(Numeric(38,2),Sum((DiscountAmt + FreeAmt + GiftAmt))) ,
		ISNULL(@Claimable,0) , 0.00 , 0 , 0  , 0 ,'Cancelled', Type, @Pi_UsrId,@Pi_TransId
		FROM @SchemeDetails SD,SchemeMaster SM
	WHERE SD.SchId=SM.SchId 
	GROUP BY SD.SalInvNo,SD.SchId,SD.SchCode,SM.CmpSchCode,SD.SchDesc,SD.SlabId,Type	
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType IN ('TF','FN') AND name='Fn_ReturnBudgetUtilized')
DROP FUNCTION Fn_ReturnBudgetUtilized
GO
--SELECT dbo.Fn_ReturnBudgetUtilized(8) AS Amt
CREATE FUNCTION Fn_ReturnBudgetUtilized
(
	@Pi_SchId INT
)
RETURNS NUMERIC(38,6)
AS
/***********************************************
* FUNCTION: Fn_ReturnBudgetUtilized
* PURPOSE: Returns the Budget Utilized for the Selected Scheme
* NOTES:
* CREATED: Thrinath Kola	11-06-2007
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
------------------------------------------------
* 22/04/2010	Nanda	   Added FBM Scheme	
************************************************/
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	SET @Points=0
	SET @RetPoints=0
	--Added by Sathishkumar Veeramani 2013/03/14
	DECLARE @ProductBatchDetails TABLE 
	(
	  PrdId NUMERIC(18,0),
	  PrdBatId NUMERIC(18,0),
	  PriceId NUMERIC(18,0),
	  PrdBatDetailValue NUMERIC(18,6)
	)	
	INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PrdBatDetailValue) 
	SELECT DISTINCT A.PrdId,A.PrdBatId,B.PriceId,B.PrdBatDetailValue 
	FROM ProductBatch A WITH (NOLOCK),ProductBatchDetails B WITH (NOLOCK),BatchCreation C WITH (NOLOCK) 
	WHERE A.PrdBatId = B.PrdBatId AND A.BatchSeqId = C.BatchSeqId AND B.SLNo = C.SLNo AND C.ClmRte = 1
	--Till Here
	
	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0)) FROM
		(SELECT A.SalId,A.SchId,A.FlatAmount,A.ReturnFlatAmount,A.DiscountPerAmount,A.ReturnDiscountPerAmount FROM 
		SalesInvoiceSchemeLineWise A (NOLOCK)INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND A.SchId = @Pi_SchId AND B.Dlvsts<> 3)A1
		INNER JOIN SchemeMaster S (NOLOCK) ON A1.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
	--SELECT @FreeValue = ISNULL(SUM((FreeQty - ReturnFreeQty) * D.PrdBatDetailValue),0)
	--	FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
	--	INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND A.FreePrdBatId = C.PrdBatId
	--	INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId
	--	INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	--	INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
	--	WHERE A.SchId = @Pi_SchId AND DlvSts <> 3
	SELECT  @FreeValue =ISNULL(SUM((FreeQty - ReturnFreeQty) * C.PrdBatDetailValue),0)
		FROM 
		(SELECT A.SchId,A.FreePrdId,A.FreePrdBatId,A.FreePriceId,A.FreeQty,A.ReturnFreeQty FROM 
		SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND B.DlvSts <> 3) A2
		INNER JOIN @ProductBatchDetails C ON A2.FreePrdId = C.PrdId AND A2.FreePrdBatId = C.PrdBatId AND A2.FreePriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A2.FreePriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A2.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A2.SchId = @Pi_SchId 		
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * C.PrdBatDetailValue),0) FROM
	    (SELECT A.SchId,A.GiftPrdId,A.GiftPrdBatId,A.GiftPriceId,A.GiftQty,A.ReturnGiftQty FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)	
         INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND DlvSts <> 3 )A3
		INNER JOIN @ProductBatchDetails C ON A3.GiftPrdId = C.PrdId AND A3.GiftPrdBatId = C.PrdBatId AND A3.GiftPriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A3.GiftPriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A3.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A3.SchId = @Pi_SchId 
--	 SELECT @Points = ISNULL(SUM(Points - ReturnPoints),0) FROM SalesInvoiceSchemeDtPoints A
-- 		INNER JOIN SalesInvoice B ON A.SalId = B.SalId WHERE SchId = @Pi_SchId
-- 		AND DlvSts <> 3
--	 SELECT @RetSchemeAmt = (ISNULL(SUM(ReturnFlatAmount),0) +
-- 		ISNULL(SUM(ReturnDiscountPerAmount),0))
-- 		FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		WHERE SchId = @Pi_SchId AND Status = 0
--
--	 SELECT @RetFreeValue = ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
-- 		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--
--	 SELECT @RetGiftValue = ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
-- 		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--	 SELECT @RetPoints = ISNULL(SUM(ReturnPoints),0) FROM ReturnSchemePointsDt A
-- 		INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId WHERE SchId = @Pi_SchId
-- 		AND Status = 0
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A (NOLOCK)
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		WHERE SchId = @Pi_SchId AND DlvSts <> 3
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A (NOLOCK)
		INNER JOIN ChequeDisbursalDetails B (NOLOCK) ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=1)
	--->Added By Nanda on 27/10/2010
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ (NOLOCK)
	INNER JOIN SalesInvoice SI (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=0)
	SET @BudgetUtilized = (@SchemeAmt + @FreeValue + @GiftValue + @Points + @WindowAmt+ @FBMSchAmt+@QPSSchAmt)
	-- 	- (@RetSchemeAmt + @RetFreeValue + @RetGiftValue + @RetPoints)
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	
	--Added By Sathishkumar Veeramani 2013/09/04
	IF EXISTS (SELECT * FROM SchemeMaster WHERE SchId = @Pi_SchId AND SchType = 5)
	BEGIN
	    SET @BudgetUtilized = 0
	    SELECT @BudgetUtilized = ISNULL(SUM(SchemeUtlzAmt),0) FROM (
	    SELECT DISTINCT A.SalId,SchId,CurSchAmt AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH(NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND DlvSts <> 3 AND SchId = @Pi_SchId AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK)
	    WHERE InvoiceType = 1 AND ReturnMode = 1)UNION
	    SELECT DISTINCT A.SalId,SchId,-1*(ReturnAmt) AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH (NOLOCK),
	    ReturnHeader B WITH (NOLOCK) WHERE A.SalId = B.SalId AND SchId = @Pi_SchId AND ReturnAmt <> 0 AND InvoiceType = 1 AND ReturnMode = 2
	    AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 1)) Qry
	END	
	--Till Here
	
	RETURN(@BudgetUtilized)
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE XType = 'P' AND name='Proc_ApplyReturnScheme')
DROP PROCEDURE Proc_ApplyReturnScheme
GO
/*
BEGIN TRANSACTION
EXEC Proc_ApplyReturnScheme 1183,1,3
SELECT * FROM UserFetchReturnScheme 
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ApplyReturnScheme
(
	@Pi_SalId INT,
	@Pi_Usrid AS INT,
	@Pi_TransId AS INT,
	@Pi_ReturnMode AS INT
)
/******************************************************************************************
* PROCEDURE	: Proc_ApplyReturnScheme
* PURPOSE	: To Apply the Return Scheme and Get the Scheme Details for the Selected Scheme
* CREATED	: Boopathy
* CREATED DATE	: 01/06/2007
* NOTE		: General SP for Returning the Scheme Details for the all type of Schemes
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------------------
* {date}		{developer}			{brief modification description}	
* 25/07/2009	Panneerselvam.k		Solve the Divied  By Zero Error
******************************************************************************************/
AS
BEGIN
	SET NOCOUNT ON
	DECLARE @Config		INT
	SET @Config=-1
	IF EXISTS (SELECT * FROM Configuration WHERE ModuleId='SALESRTN18' AND Status=1)
	BEGIN
		SET @Config=0 
	END
	ELSE IF EXISTS (SELECT * FROM Configuration WHERE ModuleId='SALESRTN19' AND Status=1)
	BEGIN
		SET @Config=1
	END
	ELSE
	BEGIN
		SET @Config=-1
	END
	
	DECLARE @SchId			INT
	DECLARE @SlabId			INT
	DECLARE @PurOfEveryReq	INT
	DECLARE @NoOfTimes		NUMERIC(38,6)
	DECLARE @SchType		INT
	DECLARE @ProRata		INT
	DECLARE @RtrId			INT
	DECLARE @CurSlabId		INT
	DECLARE @PrdId			INT
	DECLARE @PrdbatId		INT
	DECLARE @RowId			INT
	DECLARE @Combi			INT
	DECLARE @SchCode		VARCHAR(100)
	DECLARE @FlexiSch		INT
	DECLARE @FlexiSchType	INT
	DECLARE @SchemeBudget	NUMERIC(18,6)
	DECLARE @SchLevelId			INT
	DECLARE @SchemeLvlMode		INT
	DECLARE @TempHier TABLE
	(
		PrdId			INT,
		PrdBatId		INT,
		PrdCtgValMainId		INT
	)
	DECLARE @TempBilledAchCombi TABLE
	(
		PrdId			INT,
		PrdBatId		INT,
		PrdCtgValMainId		INT,
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT
	)
	DECLARE @SchEligiable TABLE
	(
		ManType			INT,
		Cnt				INT,
		PrdId			INT,
		PrdBatId		INT,
		PrdCtgValMainId	INT,
		FrmSchAch 		NUMERIC(38,6),
		NoOfTimes		NUMERIC(38,6),
		SchId			INT,
		SlabId			INT
	)
	DECLARE @TempBilled TABLE
	(
		PrdId			INT,
		PrdBatId		INT,
		SchemeOnQty 		NUMERIC(38,0),
		SchemeOnAmount		NUMERIC(38,6),
		SchemeOnKG		NUMERIC(38,6),
		SchemeOnLitre		NUMERIC(38,6),
		SchId 			INT
	)
	DECLARE @TempBilledAch TABLE
	(
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		ToSchAch		NUMERIC(38,6),
		ToUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT,
		ToQty			NUMERIC(38,6),
		ToUomId			INT
	)
	DECLARE @TempBilledCombiAch TABLE
	(
		PrdId			INT,
		PrdBatId		INT,
		PrdCtgValMainId		INT,
		FrmSchAch		NUMERIC(38,6),
		FrmUomAch		INT,
		SlabId			INT,
		FromQty			NUMERIC(38,6),
		UomId			INT
	)
	DECLARE @TempSchSlabAmt TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		DiscPer			NUMERIC(38,6),
		FlatAmt			NUMERIC(38,6),
		Points			INT,
		FlxDisc			TINYINT,
		FlxValueDisc		TINYINT,
		FlxFreePrd		TINYINT,
		FlxGiftPrd		TINYINT,
		FlxPoints		TINYINT
	)
	DECLARE @TempSchSlabFree TABLE
	(
		SchId			INT,
		SlabId			INT,
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		FreePrdId		INT,
		FreeQty			INT
	)
	DECLARE @TempSchSlabGift TABLE
	(
		ForEveryQty		NUMERIC(38,6),
		ForEveryUomId		INT,
		GiftPrdId		INT,
		GiftQty			INT
	)
	DECLARE @FreePrdDt TABLE
	(
		SalId			INT,
		SchId			INT,
		SlabId			INT,
		FreeQty			INT,
		FreePrdId		INT,
		FreePrdBatId	INT,
		FreePriceId		INT,
		GiftQty			INT,
		GiftPrdId		INT,
		GiftPrdBatId	INT,
		GiftPriceId		INT,
		PrdId			INT,
		PrdBatId		INT,
		RowId			INT
		
	)
	DECLARE @ReturnPrdHdForScheme TABLE
	(
		RowId		int,
		RtrId		int,
		PrdId		int,
		PrdBatId	int,
		SelRate		numeric(18,6),
		BaseQty		int,
		GrossAmount	numeric(18,6),
		TransId		tinyint,
		Usrid		int,
		SalId		bigint,
		RealQty		int,
		MRP			numeric(18,6)
	)
	DECLARE @t1 TABLE
	(
		SalId		INT,
		SchId		INT,
		PrdId		INT,
		PrdBatId	INT,
		FlatAmt		NUMERIC(38,6),
		DiscPer		NUMERIC(38,6),
		Points		INT,
		NoofTimes	INT
	)
	DECLARE @TempSch1 Table
	(
		SalId		INT,
		RowId		INT,
		PrdId		INT,
		PrdBatId	INT,
		BaseQty		NUMERIC(38,6),
		Selrate		NUMERIC(38,6),
		Grossvalue	NUMERIC(38,6),
		Schid		INT,
		Slabid		INT,
		Discper		NUMERIC(38,6),
		Flatamt		NUMERIC(38,6),
		Points		NUMERIC(38,6),
		NoofTimes	NUMERIC(38,6)
	)
	DECLARE @TempSch2 Table
	(
		SalId			INT,
		RowId			INT,
		PrdId			INT,
		PrdBatId		INT,
		Schid			INT,
		Slabid			INT,
		SchemeAmount	NUMERIC(38,6),
		SchemeDiscount	NUMERIC(38,6),
		Points			NUMERIC(38,6),
		Contri			NUMERIC(38,6),
		NoofTimes		NUMERIC(38,6)
	)
	DECLARE @MaxSchDt TABLE
	(
		SalId		INT,
		SchId		INT,
		SlabId		INT,
		RowId		INT,
		PrdId		INT,
		PrdBatId	INT,
		SchAmt		NUMERIC(38,6)
	)
	DECLARE @SchGross TABLE
	(
		SchId	INT,
		Amt		NUMERIC(38,6)
	)
	--Apportion scheme amt prd wise
	DECLARE @DiscPer	NUMERIC(38,6)
	DECLARE @FlatAmt	NUMERIC(38,6)
	DECLARE @Points		INT
	DECLARE @SumValue	NUMERIC(38,6)
	DECLARE @FreePrd	INT
	DECLARE @GiftPrd	INT
	DECLARE @MaxPrdId	INT
	DECLARE @SalId		INT
	DECLARE @RefCode	VARCHAR(2)
	DECLARE @CombiSch	INT
	DECLARE @QPS		INT
	DECLARE @BillCnt	INT
	DECLARE @SchCnt		INT
	DECLARE @TempSlabId	INT
	DECLARE @Cnt1	AS	INT
	DECLARE @Cnt2	AS	INT
	DECLARE @FlatChk1 AS INT
	DECLARE @FlatChk2 AS INT
	DELETE FROM SalesReturnDbNoteAlert WHERE SalId=@Pi_SalId
	IF @Config=0
	BEGIN
		DELETE FROM UserFetchReturnScheme WHERE SalId=@Pi_SalId AND Usrid=@Pi_Usrid AND TransId=@Pi_TransId
		INSERT INTO UserFetchReturnScheme(SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,FreeQty,
		FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,RowId,FreePriceId,GiftPriceId)
		SELECT SalId,PrdId,PRdBatId,SchId,SlabId,SUM(Discamt),SUM(Flatamt),SUM(Points),FreeQty,
		FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,RowId,FreePriceId,GiftPriceId FROM 
		(
			SELECT SI.SalId,RPS.PrdId,RPS.PRdBatId,SIL.SchId,SIL.SlabId,
			CAST(((SIL.DiscountPerAmount-SIL.PrimarySchemeAmt-SIL.ReturnDiscountPerAmount)/(SIP.BaseQty-SIP.ReturnedQty)) AS NUMERIC(18,6))*(RPS.RealQty) AS Discamt,
			CAST(((SIL.FlatAmount-SIL.ReturnFlatAmount)/(SIP.BaseQty-SIP.ReturnedQty))AS NUMERIC(18,6))*(RPS.RealQty) AS Flatamt,0 AS Points,
			0 AS FreeQty,0 AS FreePrdId,0 AS FreePrdBatId,0 AS GiftQty,0 AS GiftPrdId,0 AS GiftPrdBatId,
			0 AS NoofTimes,@Pi_Usrid AS Usrid,@Pi_TransId AS TransId,RPS.RowId,0 AS FreePriceId,0 AS GiftPriceId
			FROM SalesInvoice SI INNER JOIN SalesInvoiceProduct SIP ON SI.SalId=SIP.SalId
			INNER JOIN SalesInvoiceSchemeLineWise SIL ON SIL.SalId=SIP.SalId AND SIP.PrdId=SIL.PrdId 
			AND SIP.PrdBatId=SIL.PrdBatId AND SIP.Slno=SIL.RowId INNER JOIN
			ReturnPrdHdForScheme RPS ON RPS.PrdId=SIP.PrdId AND RPS.PrdBatId=SIP.PrdBatId AND RPS.SalId=SI.SalId AND RPS.RtrId=SI.RtrId 
			WHERE SI.SalId=@Pi_SalId AND usrid = @Pi_Usrid AND TransId = @Pi_TransId
			UNION 
			SELECT SI.SalId,RPS.PrdId,RPS.PRdBatId,SIL.SchId,SIL.SlabId,
			0 AS Discamt,0 AS Flatamt,CAST(((SIL.Points-SIL.ReturnPoints)/(SIP.BaseQty-SIP.ReturnedQty))AS NUMERIC(18,6))*(RPS.RealQty) AS Points,
			0 AS FreeQty,0 AS FreePrdId,0 AS FreePrdBatId,0 AS GiftQty,0 AS GiftPrdId,0 AS GiftPrdBatId,
			0 AS NoofTimes,@Pi_Usrid AS Usrid,@Pi_TransId AS TransId,RPS.RowId,0 AS FreePriceId,0 AS GiftPriceId
			FROM SalesInvoice SI INNER JOIN SalesInvoiceProduct SIP ON SI.SalId=SIP.SalId
			INNER JOIN SalesInvoiceSchemeDtPoints SIL ON SIL.SalId=SIP.SalId AND SIP.PrdId=SIL.PrdId 
			AND SIP.PrdBatId=SIL.PrdBatId INNER JOIN
			ReturnPrdHdForScheme RPS ON RPS.PrdId=SIP.PrdId AND RPS.PrdBatId=SIP.PrdBatId AND RPS.SalId=SI.SalId AND RPS.RtrId=SI.RtrId 
			WHERE SI.SalId=@Pi_SalId AND usrid = @Pi_Usrid AND TransId = @Pi_TransId
		) A 
		---Nanda
		WHERE PrdId IS NOT NULL AND A.SchId NOT IN (SELECT  DISTINCT SchID FROM SchemeMaster WHERE Qps=1 AND ApyQPSSch=1)
		GROUP BY SalId,PrdId,PRdBatId,SchId,SlabId,FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,RowId,FreePriceId,GiftPriceId
		DELETE FROM UserFetchReturnScheme WHERE SchId IN (SELECT  SchId FROM SchemeMaster WHERE CombiType=1)
		
		SELECT @RtrId=RtrId FROM SalesInvoice WHERE SalId=@Pi_SalId
		DECLARE SchemeFreeCur CURSOR FOR
		SELECT DISTINCT a.SchId,a.SlabId FROM SalesInvoiceSchemeDtFreePrd a INNER JOIN SchemeMaster B On A.SchId=B.SchId
		WHERE a.SalId=@Pi_SalId AND B.CombiType=0 AND B.SchId NOT IN (SELECT  DISTINCT SchID FROM SchemeMaster WHERE Qps=1 AND ApyQPSSch=1)
		OPEN SchemeFreeCur
		FETCH NEXT FROM SchemeFreeCur INTO @SchId,@CurSlabId
		WHILE @@fetch_status= 0
		BEGIN		
			SELECT @SchCode = SchCode,@SchType=SchType,@Combi=CombiSch,@SchemeBudget = Budget,@ProRata=ProRata,
			@FlexiSch = FlexiSch,@FlexiSchType = FlexiSchType,@PurOfEveryReq=PurofEvery,@SchLevelId = SchLevelId,
			@SchemeLvlMode = SchemeLvlMode FROM SchemeMaster WHERE SchId=@SchId
			SELECT @RowId=MIN(B.RowId) FROM ReturnPrdHdForScheme B  
			INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) C ON
			C.PrdId = B.PrdId AND B.PrdBatId = CASE C.PrdBatId WHEN 0 THEN B.PrdBatId ELSE C.PrdBatId End
			WHERE TransId=@Pi_TransId AND UsrId=@Pi_Usrid AND SalId=@Pi_SalId
			
			INSERT INTO ReturnPrdHdForScheme
			SELECT A.Slno,@RtrId,A.Prdid,A.PrdBatId,A.PrdUnitSelRate,A.BaseQty-A.ReturnedQty,
			(A.BaseQty-A.ReturnedQty)*A.PrdUnitSelRate,@Pi_TransId,@Pi_UsrId,@Pi_SalId,0,A.PrdUnitMRP
			FROM SalesInvoiceProduct A (NOLOCK) INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) B ON
			A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
			WHERE A.SalId=@Pi_SalId AND A.PrdId NOT IN (SELECT Distinct PrdId FROM ReturnPrdHdForScheme
			WHERE usrid = @Pi_Usrid AND TransId = @Pi_TransId AND SalId = @Pi_SalId )
			
			SELECT @PrdBatId=(PrdBatId),@PrdId=PrdId FROM ReturnPrdHdForScheme WHERE  
			TransId=@Pi_TransId AND UsrId=@Pi_Usrid AND SalId=@Pi_SalId AND RowId=@RowId
			
			--Added By Sathishkumar Veeramani 2013/09/07
			IF @Pi_ReturnMode = 1
			BEGIN
				INSERT INTO @FreePrdDt (SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,FreeQty,
				GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,PrdId,PrdBatId,RowId)
				SELECT A.SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,
				(CASE A.BaseQty WHEN 0 THEN 0 ELSE CEILING((FreeQty/A.BaseQty)*SUM(B.RealQty)) END),
				0 AS GiftQty,0 AS GiftPrdId,0 AS GiftPrdBatId,0 AS GiftPriceId,@PrdId,@PrdBatId,@RowId FROM
				(SELECT A.SalId,A.SchId,A.SlabId,A.FreePrdId,A.FreePrdBatId,(A.FreeQty-A.ReturnFreeQty) AS FreeQty,A.FreePriceId,
				SUM((B.BaseQty-B.ReturnedQty)) AS BaseQty FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN 
				SalesInvoiceProduct B ON A.SalId=B.SalId INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) C 
				ON B.PrdId=C.PrdId AND B.PrdBatId = CASE C.PrdBatId WHEN 0 THEN B.PrdBatId ELSE C.PrdBatId End 
				WHERE A.SchId=@SchId AND A.SlabId=@CurSlabId AND A.SalId=@Pi_SalId AND SchType = 5
				GROUP BY A.SalId,A.SchId,A.SlabId,A.FreePrdId,A.FreePrdBatId,A.FreeQty,A.ReturnFreeQty,A.FreePriceId) AS A
				INNER JOIN ReturnPrdHdForScheme B ON A.SalId=B.SalId
				INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) C ON
				C.PrdId = B.PrdId AND B.PrdBatId = CASE C.PrdBatId WHEN 0 THEN B.PrdBatId ELSE C.PrdBatId End
				WHERE usrid = @Pi_Usrid AND TransId = @Pi_TransId AND A.SalId=@Pi_SalId
				GROUP BY A.SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,FreeQty,A.BaseQty
		   END
		   BEGIN
		        INSERT INTO @FreePrdDt (SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,FreeQty,
				GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,PrdId,PrdBatId,RowId)
				SELECT A.SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,
				(CASE A.BaseQty WHEN 0 THEN 0 ELSE CEILING((FreeQty/A.BaseQty)*SUM(B.RealQty)) END),
				0 AS GiftQty,0 AS GiftPrdId,0 AS GiftPrdBatId,0 AS GiftPriceId,@PrdId,@PrdBatId,@RowId FROM
				(SELECT A.SalId,A.SchId,A.SlabId,A.FreePrdId,A.FreePrdBatId,(A.FreeQty-A.ReturnFreeQty) AS FreeQty,A.FreePriceId,
				SUM((B.BaseQty-B.ReturnedQty)) AS BaseQty FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN 
				SalesInvoiceProduct B ON A.SalId=B.SalId INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) C 
				ON B.PrdId=C.PrdId AND B.PrdBatId = CASE C.PrdBatId WHEN 0 THEN B.PrdBatId ELSE C.PrdBatId End 
				WHERE A.SchId=@SchId AND A.SlabId=@CurSlabId AND A.SalId=@Pi_SalId AND SchType <> 5 
				GROUP BY A.SalId,A.SchId,A.SlabId,A.FreePrdId,A.FreePrdBatId,A.FreeQty,A.ReturnFreeQty,A.FreePriceId) AS A
				INNER JOIN ReturnPrdHdForScheme B ON A.SalId=B.SalId
				INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) C ON
				C.PrdId = B.PrdId AND B.PrdBatId = CASE C.PrdBatId WHEN 0 THEN B.PrdBatId ELSE C.PrdBatId End
				WHERE usrid = @Pi_Usrid AND TransId = @Pi_TransId AND A.SalId=@Pi_SalId
				GROUP BY A.SalId,SchId,SlabId,FreePrdId,FreePrdBatId,FreePriceId,FreeQty,A.BaseQty
		   END		
		   --Till Here
			FETCH NEXT FROM SchemeFreeCur INTO @schid,@CurSlabId
		END
		CLOSE SchemeFreeCur
		DEALLOCATE SchemeFreeCur
		--DELETE FROM UserFetchReturnScheme WHERE (DiscAmt+FlatAmt+Points+FreeQty+GiftQty)<=0
		IF EXISTS(SELECT * FROM @FreePrdDt)
		BEGIN
			IF EXISTS (SELECT * FROM UserFetchReturnScheme WHERE SalID=@Pi_SalId AND TransId=@Pi_TransId AND UsrId=@Pi_Usrid)
			BEGIN --Added By Sathishkumar Veeramani 2013/03/28
			    IF NOT EXISTS (SELECT * FROM UserFetchReturnScheme A WITH (NOLOCK),@FreePrdDt B WHERE A.SalID = B.SalId AND A.SchId = B.SchId 
			                   AND A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId AND TransId = @Pi_TransId AND Usrid = @Pi_Usrid)
				--IF NOT EXISTS (SELECT * FROM UserFetchReturnScheme WHERE SalID=@Pi_SalId AND TransId=@Pi_TransId 
				--				AND PrdId=@PrdId AND PrdBatId=@PrdBatId AND UsrId=@Pi_Usrid)
				BEGIN
					INSERT INTO UserFetchReturnScheme (SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,
								FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,
								RowId,FreePriceId,GiftPriceId)
					SELECT DISTINCT SalId,PrdId,PrdBatId,SchId,SlabId,0,0,0,
								FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,0,@Pi_Usrid,@Pi_TransId,
								RowId,FreePriceId,GiftPriceId FROM @FreePrdDt 
								WHERE SchId NOT IN (SELECT SchId FROM UserFetchReturnScheme WHERE SalID=@Pi_SalId AND TransId=@Pi_TransId AND UsrId=@Pi_Usrid)
								AND PrdId IS NOT NULL
				END --Till Here
				ELSE
				BEGIN
					INSERT INTO UserFetchReturnScheme (SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,
								FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,
								RowId,FreePriceId,GiftPriceId)
								SELECT DISTINCT A.SalID,A.PrdId,A.PrdBatId,A.SchId,A.SlabId,0,0,0,B.FreeQty,B.FreePrdId,B.FreePrdBatId,
								B.GiftQty,B.GiftPrdId,B.GiftPrdBatId,0,@Pi_Usrid,@Pi_TransId,
								B.RowId,B.FreePriceId,B.GiftPriceId FROM UserFetchReturnScheme A INNER JOIN @FreePrdDt B
								ON A.SalId=B.SalId AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.SchId=B.SchId --AND A.SlabId=B.SlabId
								WHERE A.PrdId=@PrdId  AND B.PrdBatId=@PrdBatId AND A.SalID=@Pi_SalId AND TransId=@Pi_TransId AND UsrId=@Pi_Usrid
								AND A.PrdId IS NOT NULL
	
				END	
			END
			ELSE
			BEGIN
				INSERT INTO UserFetchReturnScheme (SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,
							RowId,FreePriceId,GiftPriceId)
				SELECT DISTINCT SalId,PrdId,PrdBatId,SchId,SlabId,0,0,0,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,0,@Pi_Usrid,@Pi_TransId,
							RowId,FreePriceId,GiftPriceId FROM @FreePrdDt 	
							WHERE PrdId IS NOT NULL
			END
			DELETE FROM UserFetchReturnScheme WHERE (DiscAmt+FlatAmt+Points+FreeQty+GiftQty)=0
		END	
	END
	ELSE IF @Config=1
	BEGIN
		Declare SchemeCur Cursor for
		SELECT distinct C.SchId,C.CombiSch,C.QPS FROM SalesInvoiceSchemeLineWise a 
		INNER JOIN SchemeMaster C ON C.SchId = a.SchId WHERE A.SalId=@Pi_SalId
		UNION
		SELECT distinct C.SchId,C.CombiSch,C.QPS FROM SalesInvoiceSchemeDtPoints a 
		INNER JOIN SchemeMaster C ON C.SchId = a.SchId WHERE A.SalId=@Pi_SalId
		open SchemeCur
		fetch next FROM SchemeCur into @SchId,@CombiSch,@QPS 
		while @@fetch_status= 0
		begin
			SELECT @SchCode = SchCode,@SchType=SchType,@Combi=CombiSch,@SchemeBudget = Budget,@ProRata=ProRata,
			@FlexiSch = FlexiSch,@FlexiSchType = FlexiSchType,@PurOfEveryReq=PurofEvery,@SchLevelId = SchLevelId,
			@SchemeLvlMode = SchemeLvlMode FROM SchemeMaster WHERE SchId=@SchId
			DELETE FROM @TempBilled
			DELETE FROM @TempBilledAch
			DELETE FROM @TempBilledAchCombi				
			DELETE FROM @TempBilledCombiAch
			SET @SlabId=0
			UPDATE A SET A.BASEQTY=(B.BaseQty-B.ReturnedQty)-A.RealQty FROM ReturnPrdHdForScheme A INNER JOIN 
			SalesInvoiceProduct B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdbatId
			WHERE B.SalId=@Pi_SalId  AND A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId AND A.BaseQty=0
			SELECT @Cnt1=COUNT(A.PrdId) FROM ReturnPrdHdForScheme A 
			INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) c ON A.PrdId=C.PrdId 
			AND A.PrdBatId= CASE C.PrdBatId WHEN 0 THEN A.PrdBatId ELSE C.PrdBatId END 
			WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId AND A.SalId=@Pi_SalId
			SELECT @Cnt2=COUNT(PrdId) FROM SalesInvoiceSchemeLineWise WHERE SalId=@Pi_SalId AND SchId=@SchId
			SELECT -1 As Mode,PrdId,PrdBatId,SUM(B.BaseQty-B.ReturnedQty) AS BaseQty INTO #tempBilledPrd 
			FROM SalesInvoiceProduct B WHERE SalId = @Pi_SalId GROUP BY PrdId,PrdBatId
			-- To Get the Scheme Products - Billed Qty, Billed Value, Billed Weight in KG and Litre
			INSERT INTO @TempBilled(PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKG,SchemeOnLitre,SchId)		
			SELECT A.PrdId,A.PrdBatId,CASE E.Mode WHEN 0 THEN 0 ELSE ISNULL(SUM(A.BaseQty),0) END AS SchemeOnQty,
				CASE E.Mode 
				WHEN 0 THEN 0 ELSE ISNULL(SUM(A.BaseQty * A.SelRate),0) END AS SchemeOnAmount,
				ISNULL
				(
					(CASE D.PrdUnitId 
					WHEN 2 THEN 
						(CASE E.Mode 
						WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000 END)
					WHEN 3 THEN 
						(CASE E.Mode WHEN 0 THEN 0 ELSE (ISNULL(SUM(PrdWgt * A.BaseQty),0)) END) 
				 END),0)					
					AS SchemeOnKg,
				ISNULL
				(
					(CASE D.PrdUnitId 
						WHEN 4 THEN 
							(CASE E.Mode 
									WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000 END)
						WHEN 5 THEN 
							(CASE E.Mode WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0) END)
				 END),0) AS SchemeOnLitre,@SchId
				FROM ReturnPrdHdForScheme A INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) B ON
				A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
				INNER JOIN Product C ON A.PrdId = C.PrdId
				INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
				INNER JOIN #tempBilledPrd E ON A.PrdId=E.PrdId AND A.PrdbatId=E.PrdBatId
				WHERE A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId AND A.BASEQTY>0
				GROUP BY A.PrdId,A.PrdBatId,D.PrdUnitId	,E.Mode	
			UNION
				SELECT PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKg,SchemeOnLitre,SchId FROM 
				(SELECT DISTINCT E.PrdId,E.PrdBatId,ISNULL(SUM(E.BaseQty-E.ReturnedQty),0) AS SchemeOnQty,
					ISNULL(SUM(E.BaseQty * E.PrdUnitSelRate),0) AS SchemeOnAmount,
					ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0)/1000
					WHEN 3 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0) END,0) AS SchemeOnKg,
					ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0)/1000
					WHEN 5 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0) END,0) AS SchemeOnLitre,@SchId As SchId
					FROM SalesInvoiceProduct E INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) B ON B.PrdId=E.PrdId AND E.SalId=@Pi_SalId
					AND E.PrdBatId = CASE B.PrdBatId WHEN 0 THEN E.PrdBatId ELSE B.PrdBatId End
					INNER JOIN Product C ON E.PrdId = C.PrdId
					INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId 
					GROUP BY E.PrdId,E.PrdBatId,D.PrdUnitId) A WHERE NOT EXISTS (SELECT PrdId,PrdBatId FROM ReturnPrdHdForScheme B
					WHERE A.PrdId=B.Prdid AND A.PrdbatId=B.PrdBatId)
				--To Get the Sum of Quantity, Value or Weight Billed for the Scheme In From and To Uom Conversion - Slab Wise
				INSERT INTO @TempBilledAch(FrmSchAch,FrmUomAch,ToSchAch,ToUomAch,SlabId,FromQty,UomId,ToQty,ToUomId)
				SELECT ISNULL(CASE @SchType
					WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6)))
				-- 	WHEN 1 THEN SUM(CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
					WHEN 2 THEN SUM(SchemeOnAmount)
					WHEN 3 THEN (CASE A.UomId
							WHEN 2 THEN SUM(SchemeOnKg) * 1000
							WHEN 3 THEN SUM(SchemeOnKg)
							WHEN 4 THEN SUM(SchemeOnLitre) * 1000
							WHEN 5 THEN SUM(SchemeOnLitre)	END)
						END,0) AS FrmSchAch,A.UomId AS FrmUomAch,
					ISNULL(CASE @SchType
					WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6)))
				-- 	WHEN 1 THEN SUM(CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
					WHEN 2 THEN SUM(SchemeOnAmount)
					WHEN 3 THEN (CASE A.ToUomId
							WHEN 2 THEN SUM(SchemeOnKg) * 1000
							WHEN 3 THEN SUM(SchemeOnKg)
							WHEN 4 THEN SUM(SchemeOnLitre) * 1000
							WHEN 5 THEN SUM(SchemeOnLitre)	END)
						END,0) AS ToSchAch,A.ToUomId AS ToUomAch,
					A.Slabid,(A.PurQty + A.FromQty) as FromQty,A.UomId,A.ToQty,A.ToUomId
					FROM SchemeSlabs A
					INNER JOIN @TempBilled B ON A.SchId = B.SchId
					INNER JOIN Product C ON B.PrdId = C.PrdId
					LEFT OUTER JOIN UomGroup D ON D.UomGroupId = C.UomGroupId AND D.UomId = A.UomId
					LEFT OUTER JOIN UomGroup E ON E.UomGroupId = C.UomGroupId AND E.UomId = A.UomId
					GROUP BY A.UomId,A.Slabid,A.PurQty,A.FromQty,A.UomId,A.ToQty,A.ToUomId	
					SELECT @SlabId = SlabId FROM (SELECT TOP 1 A.SlabId FROM @TempBilledAch A
						INNER JOIN @TempBilledAch B ON A.SlabId = B.SlabId
						WHERE
					A.FrmSchAch >= B.FromQty AND
					A.ToSchAch <= (CASE B.ToQty WHEN 0 THEN A.ToSchAch ELSE B.ToQty END)
						ORDER BY A.SlabId DESC) As SlabId
		
			SET @SlabId= ISNULL(@SlabId,0)
				--Store the Slab Amount Details into a temp table
				INSERT INTO @TempSchSlabAmt (ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,
					FlxFreePrd,FlxGiftPrd,FlxPoints)
				SELECT ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints
					FROM SchemeSlabs WHERE Schid = @SchId And SlabId = @SlabId
				
				IF @SlabId> 0 
				BEGIN
					--To Get the Number of Times the Scheme should apply
					IF @PurOfEveryReq = 0
					BEGIN
						SET @NoOfTimes = 1
					END
					ELSE
					BEGIN
					
						SELECT @NoOfTimes = A.FrmSchAch / (CASE B.ForEveryQty WHEN 0 THEN 1 ELSE B.ForEveryQty END) FROM
								@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
						
						IF @ProRata = 0
						BEGIN
							SET @NoOfTimes = FLOOR(@NoOfTimes)	
						END
						IF @ProRata = 1
						BEGIN
							SET @NoOfTimes = ROUND(@NoOfTimes,0)
						END
						IF @ProRata = 2
						BEGIN	
							SET @NoOfTimes = ROUND(@NoOfTimes,6)
						END
					END
				END
				ELSE
				BEGIN
					SET @NoOfTimes =1
				END
				INSERT INTO @TempSch1 (SalId,RowId,PrdId,PrdBatId,BaseQty,Selrate,Grossvalue,Schid,Slabid,
    			Discper,Flatamt,Points,NoofTimes)
	   			SELECT DISTINCT a.SalId,a.RowId,C.PrdId,a.PrdBatId,
				CASE A1.BaseQty WHEN 0 THEN A1.RealQty ELSE A1.BaseQty END,a1.SelRate,--A1.BaseQty*a1.SelRate,
				CASE A1.BaseQty WHEN 0 THEN a1.RealQty ELSE A1.BaseQty END *a1.SelRate,
				@SchId,D.SlabId,(d.DiscPer+d.FlxDisc),(d.FlatAmt-d.FlxValueDisc),
				D.Points+D.FlxPoints,@NoOfTimes FROM SalesInvoiceSchemeLineWise A 
				INNER JOIN ReturnPrdHdForScheme a1 ON A.PrdId=a1.PrdId AND a.PrdBatId=a1.PrdbatId 
				AND A.SalId=a1.SalId and a1.Usrid = @Pi_Usrid AND a1.TransId = @Pi_TransId 
				INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) c ON A.PrdId=C.PrdId AND A.PrdBatId= CASE C.PrdBatId WHEN 0 THEN A.PrdBatId ELSE C.PrdBatId END
				INNER JOIN SchemeSlabs d ON d.SchId=A.SchId AND D.SchId=@SchId AND D.SlabId=@SlabId
				INNER JOIN SalesInvoiceProduct G ON A.PrdId=G.PrdId AND A.PrdBatId=G.PrdBatId AND G.SalId=a.SalId
				WHERE a.SalId= @Pi_SalId
				IF @SlabId>0 
				BEGIN
					SELECT @DiscPer = (SELECT ROUND(ISNULL(SUM(b.DiscountPerAmount-b.ReturnDiscountPerAmount),0),5) FROM SalesInvoiceSchemeLineWise b WHERE
						b.SalId = @Pi_SalId AND b.SchId = @SchId AND (b.DiscountPerAmount-b.ReturnDiscountPerAmount)>0)
					
					SELECT @FlatAmt = (SELECT ROUND(ISNULL(SUM(b.FlatAmount-b.ReturnFlatAmount),0),5) FROM SalesInvoiceSchemeLineWise b WHERE
						b.SalId = @Pi_SalId AND b.SchId = @SchId AND (b.FlatAmount-b.ReturnFlatAmount)>0) 
					
					SELECT @Points = (SELECT ISNULL(Sum(b.Points-b.ReturnPoints),0) FROM dbo.SalesInvoiceSchemeDtPoints b WHERE
						b.SalId = @Pi_SalId AND b.SchId = @SchId AND (b.Points-b.ReturnPoints)>0)
					SELECT @SumValue = (SELECT Sum(Grossvalue) FROM @TempSch1 WHERE SalId = @Pi_SalId AND SchId = @SchId)
	
					IF @DiscPer>0 
					BEGIN
						IF @Cnt1=@Cnt2 
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeLineWise WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount,
								((A.Grossvalue*A.Discper)/100)*@NoOfTimes as SchemeDiscount,
								0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
							END
							ELSE
							BEGIN
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount,
								(C.DiscountPerAmount-C.ReturnDiscountPerAmount)-(((A.Grossvalue*A.Discper)/100)*@NoOfTimes) as SchemeDiscount,
								0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
							END
						END
						ELSE
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeLineWise WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount,0 as SchemeDiscount,
								0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
							END
							ELSE
							BEGIN
								SELECT @SumValue=SUM(((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)) 
								FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON 
								A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
								WHERE A.SalId=@Pi_SalId
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount,
								CASE WHEN (C.DiscountPerAmount-C.ReturnDiscountPerAmount)-((A.Grossvalue*A.Discper)/100) <0 
								THEN (C.DiscountPerAmount-C.ReturnDiscountPerAmount)*@NoOfTimes
								ELSE (C.DiscountPerAmount-C.ReturnDiscountPerAmount)-(((A.Grossvalue*A.Discper)/100)*@NoOfTimes) END	as SchemeDiscount,
								0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								IF EXISTS(SELECT A.* FROM @TempSch2 A INNER JOIN 
								 (SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
									(C.DiscountPerAmount-C.ReturnDiscountPerAmount) - (A.SchemeDiscount*@NoOfTimes) AS SchemeDiscount FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,0 AS SchemeAmount,
									((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)*C.Discper)/100) As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId)B ON A.SalId=B.SalId 
								AND A.SchId=B.SchId And A.SlabId=B.SlabId INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
								WHERE (C.Grossvalue)>B.SchemeDiscount)
								BEGIN
									SET ROWCOUNT 1
									UPDATE A SET A.SchemeDiscount=A.SchemeDiscount+B.SchemeDiscount
									FROM @TempSch2 A
									INNER JOIN 
									(SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
									(C.DiscountPerAmount-C.ReturnDiscountPerAmount) - (A.SchemeDiscount*@NoOfTimes) AS SchemeDiscount FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,0 AS SchemeAmount,
									((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)*C.Discper)/100) As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId) B ON A.SalId=B.SalId 
									AND A.SchId=B.SchId And A.SlabId=B.SlabId 
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId 
									WHERE (C.Grossvalue)>B.SchemeDiscount
									SET ROWCOUNT 0
								END
								ELSE
								BEGIN							
									INSERT INTO SalesReturnDbNoteAlert (SalId,SchId,SlabId,PrdId,PrdBatId,RowId,
									SchDiscAmt,SchFlatAmt,SchPoints,AlertMode,Usrid,TransId)
									SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
									(C.DiscountPerAmount-C.ReturnDiscountPerAmount) - (A.SchemeDiscount*@NoOfTimes) AS SchemeDiscount,0,0,0,@Pi_UsrId,@Pi_TransId FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,0 AS SchemeAmount,
									((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)*C.Discper)/100) As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId
								END
							END
						END
					END
			
					IF @FlatAmt>0
					BEGIN
						SELECT @FlatChk1=SUM(B.BaseQty-B.ReturnedQty) FROM SalesInvoiceProduct B WHERE SalId = @Pi_SalId
						SELECT @FlatChk2=ISNULL(SUM(B.BaseQty),0) FROM @TempSch1 B WHERE SalId = @Pi_SalId AND SchId=@SchId
						IF @Cnt1=@Cnt2 
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeLineWise WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								IF @FlatChk1=@FlatChk2
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									((CAST((A.Grossvalue/@SumValue) AS NUMERIC(38,6))*A.Flatamt)*@NoofTimes) as SchemeAmount,
									0,0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId 
									And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId AND A.SlabId=@SlabId
									SELECT SalId,SchId,SlabId,SUM(SchemeAmount) AS SchemeAmount INTO #temp_Flat1
									FROM @TempSch2 WHERE SchemeAmount<0 GROUP BY SalId,SchId,SlabId
									DELETE FROM @TempSch2 WHERE SchemeAmount<0 
									UPDATE A SET A.SchemeAmount=A.SchemeAmount+B.SchemeAmount
									FROM (SELECT SalId,RowId,MAX(PrdId) AS PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes FROM @TempSch2 WHERE SchemeAmount>0
									GROUP BY SalId,RowId,PrdBatId,Schid,Slabid,SchemeAmount,SchemeDiscount,Points,Contri,NoofTimes) A INNER JOIN 
									#temp_Flat1 B ON A.SalId=B.SalId AND A.SchId=B.SchId And A.SlabId=B.SlabId
								END
								ELSE
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									(C.FlatAmount-C.ReturnFlatAmount)-((CAST((A.Grossvalue/@SumValue) AS NUMERIC(38,6))*A.Flatamt)*@NoofTimes),
									0 as SchemeDiscount,
									0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId 
									And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId AND A.SlabId=@SlabId
									SELECT SalId,SchId,SlabId,SUM(SchemeAmount) AS SchemeAmount INTO #temp_Flat3
									FROM @TempSch2 WHERE SchemeAmount<0 GROUP BY SalId,SchId,SlabId
									DELETE FROM @TempSch2 WHERE SchemeAmount<0 
									UPDATE A SET A.SchemeAmount=A.SchemeAmount+B.SchemeAmount
									FROM (SELECT SalId,RowId,MAX(PrdId) AS PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes FROM @TempSch2 WHERE SchemeAmount>0
									GROUP BY SalId,RowId,PrdBatId,Schid,Slabid,SchemeAmount,SchemeDiscount,Points,Contri,NoofTimes) A INNER JOIN 
									#temp_Flat3 B ON A.SalId=B.SalId AND A.SchId=B.SchId And A.SlabId=B.SlabId
								END
							END
							ELSE
							BEGIN
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								(C.FlatAmount-C.ReturnFlatAmount)-((CAST((A.Grossvalue/@SumValue) AS NUMERIC(38,6))*A.Flatamt)*@NoofTimes) as SchemeAmount,
								0 as SchemeDiscount,0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId 
								And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								SELECT SalId,SchId,SlabId,SUM(SchemeAmount) AS SchemeAmount INTO #temp_Flat2 
								FROM @TempSch2 WHERE SchemeAmount<0 GROUP BY SalId,SchId,SlabId
								DELETE FROM @TempSch2 WHERE SchemeAmount<0 
								UPDATE A SET A.SchemeAmount=A.SchemeAmount+B.SchemeAmount
								FROM (SELECT SalId,RowId,MAX(PrdId) AS PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes FROM @TempSch2 WHERE SchemeAmount>0
									GROUP BY SalId,RowId,PrdBatId,Schid,Slabid,SchemeAmount,SchemeDiscount,Points,Contri,NoofTimes) A INNER JOIN 
								#temp_Flat2 B ON A.SalId=B.SalId AND A.SchId=B.SchId And A.SlabId=B.SlabId
			
							END
						END
						ELSE
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeLineWise WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								IF @FlatChk1=@FlatChk2
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									0 as SchemeAmount,0 as SchemeDiscount,
									0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId 
									And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								END
								ELSE
								BEGIN
									SELECT @SumValue=SUM(((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)) 
									FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON 
									A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									WHERE A.SalId=@Pi_SalId
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									(C.FlatAmount-C.ReturnFlatAmount)-((CAST((((B.BaseQty-B.ReturnedQty))*A.SelRate/@SumValue) AS NUMERIC(38,6))*A.Flatamt)*@NoofTimes) as SchemeAmount,
									0 AS SchemeDiscount,0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
									AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
									INNER JOIN SalesInvoiceProduct B ON 
									A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId AND C.RowId=B.Slno
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId
									IF EXISTS(SELECT A.* FROM @TempSch2 A INNER JOIN 
									(SELECT A.SalId,A.Schid,A.SlabId,
									CASE WHEN SUM(A.SchemeAmount)<0 THEN SUM(A.SchemeAmount)*-1 ELSE SUM(A.SchemeAmount) END AS SchemeAmount FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
									(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
									0 As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId GROUP BY A.SalId,A.Schid,A.SlabId) B ON A.SalId=B.SalId 
									AND A.SchId=B.SchId And A.SlabId=B.SlabId 
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
									WHERE (C.Grossvalue>B.SchemeAmount))
									BEGIN
										SET ROWCOUNT 1
										UPDATE A SET A.SchemeAmount=A.SchemeAmount+B.SchemeAmount
										FROM @TempSch2 A INNER JOIN 
										(SELECT A.SalId,A.Schid,A.SlabId,
										CASE WHEN SUM(A.SchemeAmount)<0 THEN SUM(A.SchemeAmount)*-1 ELSE SUM(A.SchemeAmount) END AS SchemeAmount FROM
										(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
										SchemeDiscount,Points,Contri,NoOfTimes FROM
										(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
										(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
										0 As SchemeDiscount,0 As Points,
										(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
										FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
										AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
										INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
										WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
										(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
										A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
										SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
										A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId GROUP BY A.SalId,A.Schid,A.SlabId) B ON A.SalId=B.SalId 
										AND A.SchId=B.SchId And A.SlabId=B.SlabId 
										INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId 
										WHERE (C.Grossvalue>B.SchemeAmount)
										SET ROWCOUNT 0
									END
									ELSE
									BEGIN
										INSERT INTO SalesReturnDbNoteAlert (SalId,SchId,SlabId,PrdId,PrdBatId,RowId,
										SchDiscAmt,SchFlatAmt,SchPoints,AlertMode,Usrid,TransId)
										SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
										0, CASE WHEN A.SchemeAmount<0 THEN A.SchemeAmount*-1 ELSE A.SchemeAmount END ,0,0,@Pi_UsrId,@Pi_TransId FROM
										(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
										SchemeDiscount,Points,Contri,NoOfTimes FROM
										(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
										(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
										0 As SchemeDiscount,0 As Points,
										(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
										FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
										AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
										INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
										WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
										(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
										A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
										SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
										A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId
									END
								END
							END
							ELSE
							BEGIN								
								SELECT @SumValue=SUM(((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)) 
								FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON 
								A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
								WHERE A.SalId=@Pi_SalId 
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								(C.FlatAmount-C.ReturnFlatAmount)-((CAST((((B.BaseQty-B.ReturnedQty))*A.SelRate/@SumValue) AS NUMERIC(38,6))*A.Flatamt)*@NoofTimes) as SchemeAmount,
								0 AS SchemeDiscount,0 as Points,((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
								INNER JOIN SalesInvoiceProduct B ON 
								A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId AND C.RowId=B.Slno
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId
								IF EXISTS(SELECT A.* FROM @TempSch2 A INNER JOIN 
								(SELECT A.SalId,A.Schid,A.SlabId,
								CASE WHEN SUM(A.SchemeAmount)<0 THEN SUM(A.SchemeAmount)*-1 ELSE SUM(A.SchemeAmount) END AS SchemeAmount FROM
								(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
								SchemeDiscount,Points,Contri,NoOfTimes FROM
								(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
								(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
								0 As SchemeDiscount,0 As Points,
								(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
								FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
								AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
								INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
								(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
								A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
								SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
								A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId GROUP BY A.SalId,A.Schid,A.SlabId) B ON A.SalId=B.SalId 
								AND A.SchId=B.SchId And A.SlabId=B.SlabId 
								INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
								WHERE (C.Grossvalue>B.SchemeAmount))
								BEGIN				
									SET ROWCOUNT 1					
									UPDATE A SET A.SchemeAmount=A.SchemeAmount+B.SchemeAmount
									FROM @TempSch2 A INNER JOIN 
									(SELECT A.SalId,A.Schid,A.SlabId,
									CASE WHEN SUM(A.SchemeAmount)<0 THEN SUM(A.SchemeAmount)*-1 ELSE SUM(A.SchemeAmount) END AS SchemeAmount FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
									(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
									0 As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId GROUP BY A.SalId,A.Schid,A.SlabId) B ON A.SalId=B.SalId 
									AND A.SchId=B.SchId And A.SlabId=B.SlabId
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
									WHERE (C.Grossvalue>B.SchemeAmount)
									SET ROWCOUNT 0
								END
								ELSE
								BEGIN
									INSERT INTO SalesReturnDbNoteAlert (SalId,SchId,SlabId,PrdId,PrdBatId,RowId,
									SchDiscAmt,SchFlatAmt,SchPoints,AlertMode,Usrid,TransId)
									SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
									0, CASE WHEN A.SchemeAmount<0 THEN A.SchemeAmount*-1 ELSE A.SchemeAmount END ,0,0,@Pi_UsrId,@Pi_TransId FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
									(A.FlatAmount-A.ReturnFlatAmount)-((CAST(((((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)/@SumValue)) AS NUMERIC(38,6))*C.Flatamt)*@NoofTimes) AS SchemeAmount,
									0 As SchemeDiscount,0 As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId AND A.RowId=B.Slno
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeLineWise C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.RowId=C.RowId
								END
							END
						END
					END
					IF @Points>0
					BEGIN
						SELECT @FlatChk1=SUM(B.BaseQty-B.ReturnedQty) FROM SalesInvoiceProduct B WHERE SalId = @Pi_SalId
						SELECT @FlatChk2=SUM(B.BaseQty) FROM @TempSch1 B WHERE SalId = @Pi_SalId AND SchId=@SchId
						IF @Cnt1=@Cnt2 
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeDtPoints WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								IF @FlatChk1=@FlatChk2
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									0 as SchemeAmount, 0 as SchemeDiscount,
									(CAST(((A.BaseQty*A.SelRate/@SumValue)) AS NUMERIC(38,6))*A.Points)*@NoOfTimes as Points,
									((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								END
								ELSE
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									0 as SchemeAmount, 0 as SchemeDiscount,
									((C.Points-C.ReturnPoints)-(CAST(((A.BaseQty*A.SelRate/@SumValue)) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) as Points,
									((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								END
							END
							ELSE
							BEGIN
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount, 0 as SchemeDiscount,
								(C.Points-C.ReturnPoints)-((CAST((A.BaseQty*A.SelRate/@SumValue) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) as Points,
								((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId And A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
							END
						END
						ELSE
						BEGIN
							IF EXISTS (SELECT SalId FROM SalesInvoiceSchemeDtPoints WHERE SalId = @Pi_SalId AND SchId = @SchId AND SlabId=@SlabId)
							BEGIN
								IF @FlatChk1=@FlatChk2
								BEGIN
									INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
									SchemeDiscount,Points,Contri,NoofTimes)
									SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
									0 as SchemeAmount, 0 as SchemeDiscount,0 as Points,
									((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
									FROM @TempSch1 A 
									INNER JOIN SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId And A.PrdId=C.PrdId 
									AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId AND A.SlabId=C.SlabId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId 
								END
							END
							ELSE
							BEGIN
								
								SELECT @SumValue=SUM(((B.BaseQty-B.ReturnedQty) *B.PrdUom1SelRate)) 
								FROM SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON 
								A.SalId=B.SalId AND A.PrdId =B.PrdId AND A.PrdBatId=B.PrdBatId 
								WHERE A.SalId=@Pi_SalId 
								INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
								SchemeDiscount,Points,Contri,NoofTimes)
								SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
								0 as SchemeAmount,0 AS SchemeDiscount,
								(C.Points-C.ReturnPoints)-((CAST((A.BaseQty*A.SelRate/@SumValue) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) as Points,
								((A.Grossvalue/@SumValue)*100) as Contri,A.NoofTimes
								FROM @TempSch1 A 
								INNER JOIN SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId And A.PrdId=C.PrdId AND A.SchId=C.SchId
								AND A.PrdBatId=C.PrdBatId AND A.SchId=C.SchId WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId
								IF EXISTS(SELECT A.* FROM @TempSch2 A INNER JOIN 
								(SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId
								,ROUND(A.Points,0)*@NoOfTimes AS Points FROM
								(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
								SchemeDiscount,Points,Contri,NoOfTimes FROM
								(SELECT Distinct A.SalId,B.Slno AS RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
								0 AS SchemeAmount,0 As SchemeDiscount,
								(A.Points-A.ReturnPoints)-((CAST((((B.BaseQty-B.ReturnedQty)*B.PrdUom1SelRate/@SumValue)) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) As Points,
								(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
								FROM  SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
								AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
								WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
								(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
								A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
								SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
								A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId) B ON A.SalId=B.SalId 
								AND A.SchId=B.SchId And A.SlabId=B.SlabId 
								INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
								WHERE (C.Grossvalue)>B.Points)
								BEGIN			
									SET ROWCOUNT 1						
									UPDATE A SET A.Points=A.Points+B.Points
									FROM @TempSch2 A INNER JOIN 
									(SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId
									,ROUND(A.Points,0)*@NoOfTimes AS Points FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,B.Slno AS RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
									0 AS SchemeAmount,0 As SchemeDiscount,
									(A.Points-A.ReturnPoints)-((CAST((((B.BaseQty-B.ReturnedQty)*B.PrdUom1SelRate/@SumValue)) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId) B ON A.SalId=B.SalId 
									AND A.SchId=B.SchId And A.SlabId=B.SlabId
									INNER JOIN @TempSch1 C ON A.SalId=C.SalId AND A.SchId=C.SchId And A.SlabId=C.SlabId  
									WHERE (C.Grossvalue>B.Points)
									SET ROWCOUNT 0
								END
								ELSE
								BEGIN
									INSERT INTO SalesReturnDbNoteAlert (SalId,SchId,SlabId,PrdId,PrdBatId,RowId,
									SchDiscAmt,SchFlatAmt,SchPoints,AlertMode,Usrid,TransId)
									SELECT A.SalId,A.Schid,A.SlabId,A.PrdId,A.PrdBatId,A.RowId,
									0,0,ROUND(A.Points,0)*@NoOfTimes,0,@Pi_UsrId,@Pi_TransId FROM
									(SELECT A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.SlabId,SchemeAmount,
									SchemeDiscount,Points,Contri,NoOfTimes FROM
									(SELECT Distinct A.SalId,B.Slno AS RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
									0 AS SchemeAmount,0 As SchemeDiscount,
									(A.Points-A.ReturnPoints)-((CAST((((B.BaseQty-B.ReturnedQty)*B.PrdUom1SelRate/@SumValue)) AS NUMERIC(38,6))*A.Points)*@NoOfTimes) As Points,
									(((B.BaseQty *B.PrdUom1SelRate)/@SumValue)*100) As Contri,@NoOfTimes AS NoOfTimes
									FROM  SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
									AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
									WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A WHERE NOT EXISTS 
									(SELECT PrdId,PrdBatId,SalId,SchId,RowId FROM @TempSch2 B WHERE A.SalId=B.SalId AND 
									A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId AND A.RowId=B.RowId AND A.SchId=B.SchId)) A INNER JOIN 
									SalesInvoiceSchemeDtPoints C ON A.SalId=C.SalId AND A.SchId=C.SchId AND 
									A.PrdId=C.PrdId AND A.PrdBatId=C.PrdBatId 
								END
							END
						END
					END
				END		
				ELSE
				BEGIN
					INSERT INTO @TempSch2 (SalId,RowId,PrdId,PrdBatId,Schid,Slabid,SchemeAmount,
					SchemeDiscount,Points,Contri,NoofTimes)
					SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
					(A.FlatAmount-A.ReturnFlatAmount)*@NoOfTimes as SchemeAmount,
					(A.DiscountPerAmount-A.ReturnDiscountPerAmount) *@NoOfTimes AS SchemeDiscount,0 as Points,100 as Contri,1
					FROM SalesInvoiceSchemeLineWise A WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId
					UNION
					SELECT Distinct A.SalId,B.Slno AS RowId,A.PrdId,A.PrdBatId,A.Schid,@SlabId AS SlabId,
					0 AS SchemeAmount,0 As SchemeDiscount,(A.Points-A.ReturnPoints)*@NoOfTimes As Points,
					100 As Contri,1 AS NoOfTimes
					FROM  SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
					AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId 
					WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId
				
					INSERT INTO SalesReturnDbNoteAlert (SalId,SchId,SlabId,PrdId,PrdBatId,RowId,
					SchDiscAmt,SchFlatAmt,SchPoints,AlertMode,Usrid,TransId)
						SELECT SalId,Schid,Slabid,PrdId,PrdBatId,RowId,
						SchemeDiscount,SchemeAmount,Points,0,@Pi_UsrId,@Pi_TransId FROM
						(SELECT Distinct A.SalId,A.RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid,
						(A.FlatAmount-A.ReturnFlatAmount)*@NoOfTimes as SchemeAmount,
						(A.DiscountPerAmount-A.ReturnDiscountPerAmount) *@NoOfTimes AS SchemeDiscount,0 as Points,100 as Contri,1 AS NoTimes 
						FROM SalesInvoiceSchemeLineWise A WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A
						WHERE NOT EXISTS (
						SELECT PrdId,PrdBatId,SalId FROM
						(SELECT A.PrdId,A.PrdBatId,A.SalId FROM ReturnPrdHdForScheme A 
						INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) c ON A.PrdId=C.PrdId 
						AND A.PrdBatId= CASE C.PrdBatId WHEN 0 THEN A.PrdBatId ELSE C.PrdBatId END 
						WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId AND A.SalId=@Pi_SalId) X WHERE A.SalId=X.SalId AND 
						A.PrdId=X.PrdId AND A.PrdBatId=X.PrdBatId)
						UNION
						SELECT SalId,Schid,Slabid,PrdId,PrdBatId,RowId,
						SchemeDiscount,SchemeAmount,Points*@NoOfTimes,0,@Pi_UsrId,@Pi_TransId FROM
						(SELECT Distinct A.SalId,B.Slno AS RowId,A.PrdId,A.PrdBatId,A.Schid,A.Slabid AS SlabId,
						0 AS SchemeAmount,0 As SchemeDiscount,(A.Points-A.ReturnPoints) As Points
						FROM  SalesInvoiceSchemeDtPoints A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
						AND A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId 
						WHERE A.SalId = @Pi_SalId AND A.SchId = @SchId) A
						WHERE NOT EXISTS (
							SELECT PrdId,PrdBatId,SalId FROM
							(SELECT A.PrdId,A.PrdBatId,A.SalId FROM ReturnPrdHdForScheme A 
							INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) c ON A.PrdId=C.PrdId 
							AND A.PrdBatId= CASE C.PrdBatId WHEN 0 THEN A.PrdBatId ELSE C.PrdBatId END 
							WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId AND A.SalId=@Pi_SalId) X WHERE A.SalId=X.SalId AND 
							A.PrdId=X.PrdId AND A.PrdBatId=X.PrdBatId)
				END
			--Nanda
			DROP TABLE #tempBilledPrd
			FETCH NEXT FROM SchemeCur INTO @schid ,@CombiSch,@QPS
		END
		CLOSE SchemeCur
		DEALLOCATE SchemeCur
		DELETE FROM SalesReturnDbNoteAlert WHERE (SchDiscAmt+SchFlatAmt+SchPoints)=0
		SELECT SalId,SchId,SlabId,SUM(CAST(SchemeAmount AS NUMERIC(18,6))) AS SchAmt,SUM(SchemeDiscount) AS SchDisc,
		SUM(Points) AS SchPoints INTO #Test1 FROM @TempSch2
		GROUP BY SalId,SchId,SlabId 
		DELETE A FROM  @TempSch2 A INNER JOIN #Test1 B ON A.SalId=B.SalId AND A.SchId=B.SchId
		AND A.SlabId=B.SlabId WHERE B.SchAmt=0 AND B.SchDisc=0 AND B.SchPoints=0
		INSERT INTO UserFetchReturnScheme(SalId,RowId,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,FreeQty,
		FreePrdId,FreePrdBatId,FreePriceId,GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,NoofTimes,Usrid,TransId)
		SELECT a.SalId,a.RowId,a.PrdId,a.PrdBatId,b.SchId,b.SlabId,b.SchemeDiscount,b.SchemeAmount,
			b.Points,0,0,0,0,0,0,0,0,b.NoofTimes,@Pi_Usrid,@Pi_TransId
		FROM ReturnPrdHdForScheme a INNER JOIN @TempSch2 b ON
		a.SalId=b.SalId AND a.PrdId = b.PrdId AND a.PrdBatId=b.PrdBatId --AND a.RowId=B.RowId
		WHERE a.usrid = @Pi_Usrid AND a.TransId = @Pi_TransId AND a.SalId = @Pi_SalId
		ORDER BY a.RowId
		DECLARE SchUpdateCur CURSOR FOR
		SELECT DISTINCT SalId,SchId,SlabId FROM UserFetchReturnScheme WHERE Usrid=@Pi_Usrid AND TransId=@Pi_TransId
		OPEN SchUpdateCur
		FETCH NEXT FROM SchUpdateCur INTO @SalId,@SchId,@SlabId
		WHILE @@fetch_status= 0
		BEGIN
		
		   SELECT @MaxPrdId = (SELECT MAX(a.PrdId) FROM UserFetchReturnScheme a WHERE
		   a.usrid = @Pi_Usrid AND a.TransId = @Pi_TransId AND a.SalId=@Pi_SalId AND a.FreeQty<>0
		   AND a.SchId =@SchId AND a.SlabId = @SlabId HAVING COUNT(a.SchId) >1)
		   SELECT @PrdBatId = (SELECT DISTINCT MAX(a.PrdbatId) FROM UserFetchReturnScheme a WHERE
		   a.usrid = @Pi_Usrid AND a.TransId = @Pi_TransId AND a.SalId=@Pi_SalId AND
		   a.PrdId=@MaxPrdId)
		   UPDATE UserFetchReturnScheme SET FreeQty = 0,GiftQty=0 FROM
		   UserFetchReturnScheme a WHERE a.SalId = @Pi_SalId AND a.Usrid = @Pi_Usrid AND a.TransId = @Pi_TransId
		   AND  a.PrdBatId <> @PrdBatId AND a.SchId = @SchId AND a.SlabId = @SlabId
		   DELETE FROM UserFetchReturnScheme WHERE FreePrdId = 0 AND FreePrdBatId=0 AND Flatamt =0 AND
		   DiscAmt=0 AND Points=0 AND GiftPrdId=0 AND GiftPrdBatId=0 AND SalId=@Pi_SalId
		   AND Schid = @SchId AND SlabId = @SlabId
		   DELETE FROM UserFetchReturnScheme WHERE FreePrdId <> 0 AND FreePrdBatId=0 AND SalId=@Pi_SalId
		   AND Schid = @SchId AND SlabId = @SlabId
		   DELETE FROM UserFetchReturnScheme WHERE GiftPrdId <> 0 AND GiftPrdBatId=0 AND SalId=@Pi_SalId
		   AND Schid = @SchId AND SlabId = @SlabId
		   DELETE FROM UserFetchReturnScheme WHERE FreePrdId <> 0 AND FreePrdBatId<>0 AND Flatamt =0 AND
		   DiscAmt=0 AND Points=0 AND GiftPrdId=0 AND GiftPrdBatId=0 AND FreeQty=0 AND SalId=@Pi_SalId
		   AND Schid = @SchId AND SlabId = @SlabId
		   DELETE FROM UserFetchReturnScheme WHERE FreePrdId = 0 AND FreePrdBatId=0 AND Flatamt =0 AND
		   DiscAmt=0 AND Points=0 AND GiftPrdId<>0 AND GiftPrdBatId<>0 AND GiftQty=0 AND SalId=@Pi_SalId
		   AND Schid = @SchId AND SlabId = @SlabId
		
		   FETCH NEXT FROM SchUpdateCur INTO @SalId,@SchId,@SlabId
		END
		CLOSE SchUpdateCur
		DEALLOCATE SchUpdateCur
		SELECT @RtrId=RtrId FROM SalesInvoice WHERE SalId=@SalId
		SELECT @RefCode=ISNULL(PrimaryRefCode,'XX') FROM SalesInvoice WHERE SalId=@SalId
		IF @RefCode <> 'XX'
		BEGIN
			SELECT DISTINCT PrdId,PrdBatId,SchId AS SchId ,SlabId,RowId INTO #TmpPrdDt 
			FROM UserFetchReturnScheme WHERE DiscAmt > 0
			UPDATE UserFetchReturnScheme SET DiscAmt = CASE WHEN (DiscAmt - tmp.Prim)>0 THEN (DiscAmt - tmp.Prim) ELSE 0 END FROM
			(SELECT F.SchId,F.SlabId,B.PrdId,B.PrdBatId,B.RowID,B.GrossAmount - (B.GrossAmount /(1 +( CASE dbo.Fn_ReturnPrimarySchRetCategory(@RtrId,@SalId)
			WHEN 1 THEN   D.PrdBatDetailValue ELSE 0 END)/100)) AS Prim FROM BilledPrdHdForScheme B INNER JOIN ProductBatchDetails D ON D.PrdBatId = B.PrdBatId  AND D.DefaultPrice=1
			INNER JOIN BatchCreation E ON D.BatchSeqId = E.BatchSeqId AND E.Slno = D.Slno AND E.RefCode = @RefCode
			INNER JOIN #TmpPrdDt F ON B.PrdId=F.PrdId AND F.PrdBatId=B.PrdBatId AND B.RowId=F.RowId
			WHERE B.usrid = @Pi_Usrid And B.transid = @Pi_TransId) tmp,UserFetchReturnScheme A
			WHERE A.usrid = @Pi_Usrid And A.transid = @Pi_TransId AND A.SchId=tmp.schId AND A.SlabId=tmp.SlabId
			AND A.PrdId=tmp.PrdId AND A.PrdBatId=tmp.PrdBatId AND A.RowId=tmp.RowId AND A.DiscAmt >0
		END
		SELECT DISTINCT * INTO #UserFetchReturnScheme FROM UserFetchReturnScheme WHERE Usrid=@Pi_Usrid AND TransId=@Pi_TransId
		DELETE FROM UserFetchReturnScheme WHERE Usrid=@Pi_Usrid AND TransId=@Pi_TransId
		INSERT INTO UserFetchReturnScheme SELECT  * FROM #UserFetchReturnScheme
		DECLARE SchemeFreeCur CURSOR FOR
		SELECT DISTINCT a.SchId FROM BillAppliedSchemeHd a WHERE a.TransId=@Pi_TransId AND a.UsrId=@Pi_Usrid 
		AND (a.FreeToBeGiven + a.GiftToBeGiven+a.FlxFreePrd+a.FlxGiftPrd)>0 AND a.IsSelected=1
		UNION 
		SELECT SchId FROM dbo.SalesInvoiceSchemeDtFreePrd WHERE SalId=@Pi_SalId
		OPEN SchemeFreeCur
		FETCH NEXT FROM SchemeFreeCur INTO @SchId
		WHILE @@fetch_status= 0
		BEGIN		
			SELECT @SchCode = SchCode,@SchType=SchType,@Combi=CombiSch,@SchemeBudget = Budget,@ProRata=ProRata,
			@FlexiSch = FlexiSch,@FlexiSchType = FlexiSchType,@PurOfEveryReq=PurofEvery FROM SchemeMaster WHERE SchId=@SchId
			DELETE FROM @TempBilled
			DELETE FROM @TempBilledAch
			SET @SlabId=0
			UPDATE A SET A.BASEQTY=(B.BaseQty-B.ReturnedQty)-A.RealQty FROM ReturnPrdHdForScheme A INNER JOIN 
			SalesInvoiceProduct B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdbatId
			WHERE B.SalId=@Pi_SalId  AND A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId AND A.BaseQty=0
			SELECT @Cnt1=COUNT(A.PrdId) FROM ReturnPrdHdForScheme A 
			INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) c ON A.PrdId=C.PrdId 
			AND A.PrdBatId= CASE C.PrdBatId WHEN 0 THEN A.PrdBatId ELSE C.PrdBatId END 
			WHERE TransId=@Pi_TransId AND UsrId=@Pi_UsrId AND A.SalId=@Pi_SalId
			SELECT @Cnt2=COUNT(PrdId) FROM SalesInvoiceSchemeLineWise WHERE SalId=@Pi_SalId AND SchId=@SchId
			SELECT -1 As Mode,PrdId,PrdBatId,SUM(B.BaseQty-B.ReturnedQty) AS BaseQty INTO #tempBilledPrd1
			FROM SalesInvoiceProduct B WHERE SalId = @Pi_SalId GROUP BY PrdId,PrdBatId
			-- To Get the Scheme Products - Billed Qty, Billed Value, Billed Weight in KG and Litre
			INSERT INTO @TempBilled(PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKG,SchemeOnLitre,SchId)		
			SELECT A.PrdId,A.PrdBatId,CASE E.Mode WHEN 0 THEN 0 ELSE ISNULL(SUM(A.BaseQty),0) END AS SchemeOnQty,
				CASE E.Mode 
				WHEN 0 THEN 0 ELSE ISNULL(SUM(A.BaseQty * A.SelRate),0) END AS SchemeOnAmount,
				ISNULL
				(
					(CASE D.PrdUnitId 
					WHEN 2 THEN 
						(CASE E.Mode 
						WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000 END)
					WHEN 3 THEN 
						(CASE E.Mode WHEN 0 THEN 0 ELSE (ISNULL(SUM(PrdWgt * A.BaseQty),0)) END) 
				 END),0)					
					AS SchemeOnKg,
				ISNULL
				(
					(CASE D.PrdUnitId 
						WHEN 4 THEN 
							(CASE E.Mode 
									WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0)/1000 END)
						WHEN 5 THEN 
							(CASE E.Mode WHEN 0 THEN 0 ELSE ISNULL(SUM(PrdWgt * A.BaseQty),0) END)
				 END),0) AS SchemeOnLitre,@SchId
				FROM ReturnPrdHdForScheme A INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) B ON
				A.PrdId = B.PrdId AND A.PrdBatId = CASE B.PrdBatId WHEN 0 THEN A.PrdBatId ELSE B.PrdBatId End
				INNER JOIN Product C ON A.PrdId = C.PrdId
				INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId
				INNER JOIN #tempBilledPrd1 E ON A.PrdId=E.PrdId AND A.PrdbatId=E.PrdBatId
				WHERE A.Usrid = @Pi_UsrId AND A.TransId = @Pi_TransId 
				GROUP BY A.PrdId,A.PrdBatId,D.PrdUnitId	,E.Mode	
			UNION
				SELECT PrdId,PrdBatId,SchemeOnQty,SchemeOnAmount,SchemeOnKg,SchemeOnLitre,SchId FROM 
				(SELECT DISTINCT E.PrdId,E.PrdBatId,ISNULL(SUM(E.BaseQty-E.ReturnedQty),0) AS SchemeOnQty,
					ISNULL(SUM(E.BaseQty * E.PrdUnitSelRate),0) AS SchemeOnAmount,
					ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0)/1000
					WHEN 3 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0) END,0) AS SchemeOnKg,
					ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0)/1000
					WHEN 5 THEN ISNULL(SUM(PrdWgt * E.BaseQty-E.ReturnedQty),0) END,0) AS SchemeOnLitre,@SchId As SchId
					FROM SalesInvoiceProduct E INNER JOIN Fn_ReturnSchemeProductBatch(@SchId) B ON B.PrdId=E.PrdId AND E.SalId=@Pi_SalId
					AND E.PrdBatId = CASE B.PrdBatId WHEN 0 THEN E.PrdBatId ELSE B.PrdBatId End
					INNER JOIN Product C ON E.PrdId = C.PrdId
					INNER JOIN ProductUnit D ON C.PrdUnitId = D.PrdUnitId 
					GROUP BY E.PrdId,E.PrdBatId,D.PrdUnitId) A WHERE NOT EXISTS (SELECT PrdId,PrdBatId FROM ReturnPrdHdForScheme B
					WHERE A.PrdId=B.Prdid AND A.PrdbatId=B.PrdBatId)
			--To Get the Sum of Quantity, Value or Weight Billed for the Scheme In From and To Uom Conversion - Slab Wise
			INSERT INTO @TempBilledAch(FrmSchAch,FrmUomAch,ToSchAch,ToUomAch,SlabId,FromQty,UomId,ToQty,ToUomId)
			SELECT ISNULL(CASE @SchType
				WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6)))
			-- 	WHEN 1 THEN SUM(CAST(ISNULL(D.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
				WHEN 2 THEN SUM(SchemeOnAmount)
				WHEN 3 THEN (CASE A.UomId
						WHEN 2 THEN SUM(SchemeOnKg) * 1000
						WHEN 3 THEN SUM(SchemeOnKg)
						WHEN 4 THEN SUM(SchemeOnLitre) * 1000
						WHEN 5 THEN SUM(SchemeOnLitre)	END)
					END,0) AS FrmSchAch,A.UomId AS FrmUomAch,
				ISNULL(CASE @SchType
				WHEN 1 THEN SUM(SchemeOnQty / CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6)))
			-- 	WHEN 1 THEN SUM(CAST(ISNULL(E.ConversionFactor,1) AS NUMERIC(38,6))/SchemeOnQty)
				WHEN 2 THEN SUM(SchemeOnAmount)
				WHEN 3 THEN (CASE A.ToUomId
						WHEN 2 THEN SUM(SchemeOnKg) * 1000
						WHEN 3 THEN SUM(SchemeOnKg)
						WHEN 4 THEN SUM(SchemeOnLitre) * 1000
						WHEN 5 THEN SUM(SchemeOnLitre)	END)
					END,0) AS ToSchAch,A.ToUomId AS ToUomAch,
				A.Slabid,(A.PurQty + A.FromQty) as FromQty,A.UomId,A.ToQty,A.ToUomId
				FROM SchemeSlabs A
				INNER JOIN @TempBilled B ON A.SchId = B.SchId
				INNER JOIN Product C ON B.PrdId = C.PrdId
				LEFT OUTER JOIN UomGroup D ON D.UomGroupId = C.UomGroupId AND D.UomId = A.UomId
				LEFT OUTER JOIN UomGroup E ON E.UomGroupId = C.UomGroupId AND E.UomId = A.UomId
				GROUP BY A.UomId,A.Slabid,A.PurQty,A.FromQty,A.UomId,A.ToQty,A.ToUomId	
				SELECT @SlabId = SlabId FROM (SELECT TOP 1 A.SlabId FROM @TempBilledAch A
					INNER JOIN @TempBilledAch B ON A.SlabId = B.SlabId
					WHERE
				A.FrmSchAch >= B.FromQty AND
				A.ToSchAch <= (CASE B.ToQty WHEN 0 THEN A.ToSchAch ELSE B.ToQty END)
					ORDER BY A.SlabId DESC) As SlabId
				SET @SlabId= ISNULL(@SlabId,0)
				--Store the Slab Amount Details into a temp table
				INSERT INTO @TempSchSlabAmt (ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,
					FlxFreePrd,FlxGiftPrd,FlxPoints)
				SELECT ForEveryQty,ForEveryUomId,DiscPer,FlatAmt,Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints
					FROM SchemeSlabs WHERE Schid = @SchId And SlabId = @SlabId
				--Store the Slab Free Product Details into a temp table
				INSERT INTO @TempSchSlabFree(ForEveryQty,ForEveryUomId,FreePrdId,FreeQty)
				SELECT A.ForEveryQty,A.ForEveryUomId,B.PrdId,B.FreeQty From
					SchemeSlabs A INNER JOIN SchemeSlabFrePrds B ON A.Schid = B.Schid
					AND A.SlabId = B.SlabId INNER JOIN Product C ON B.PrdId = C.PrdId
					WHERE A.Schid = @SchId And A.SlabId = @SlabId AND C.PrdType <> 4
				--To Get the Number of Times the Scheme should apply
				IF @PurOfEveryReq = 0
				BEGIN
					SET @NoOfTimes = 1
				END
				ELSE
				BEGIN
					SELECT @NoOfTimes = A.FrmSchAch / (CASE B.ForEveryQty WHEN 0 THEN 1 ELSE B.ForEveryQty END) FROM
						@TempBilledAch A INNER JOIN @TempSchSlabAmt B ON A.SlabId = @SlabId
					IF @ProRata = 0
					BEGIN
						SET @NoOfTimes = FLOOR(@NoOfTimes)	
					END
					IF @ProRata = 1
					BEGIN
						SET @NoOfTimes = ROUND(@NoOfTimes,0)
					END
					IF @ProRata = 2
					BEGIN	
						SET @NoOfTimes = ROUND(@NoOfTimes,6)
					END
				END
				IF @SlabId>0
				BEGIN
				DELETE FROM BillAppliedSchemeHd WHERE TransId=@Pi_TransId AND UsrId=@Pi_Usrid  AND SchId=@SchId
				INSERT INTO BillAppliedSchemeHd(SchId,SchCode,FlexiSch,FlexiSchType,SlabId,SchemeAmount,SchemeDiscount,
				Points,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,FreePrdId,
				FreePrdBatId,FreeToBeGiven,GiftPrdId,GiftPrdBatId,GiftToBeGiven,NoOfTimes,IsSelected,SchBudget,
				BudgetUtilized,TransId,Usrid,PrdId,PrdBatId,SchType)
				SELECT DISTINCT @SchId as Schid,@SchCode as SchCode,@FlexiSch as FlexiSch,@FlexiSchType as FlexiSchType,
					@SlabId as SlabId,0 as SchAmount,0 as SchDisc,0 as Points,0 as FlxDisc,0 as FlxValueDisc,
					0 as FlxFreePrd,0 as FlxGiftPrd,0 as FlxPoints,FreePrdId,0 as FreePrdBatId,
					CASE @SchType 
						WHEN 1 THEN 
							CASE  WHEN SUM(SchemeOnQty)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END 
						WHEN 2 THEN 
							CASE  WHEN SUM(SchemeOnAmount)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END
						WHEN 3 THEN
							CASE  WHEN SUM(SchemeOnKG+SchemeOnLitre)>=ForEveryQty THEN (CASE @ProRata WHEN 2 THEN FreeQty*FLOOR(@NoOfTimes) ELSE ROUND((FreeQty*@NoOfTimes),0) END) ELSE FreeQty END
					END
					 as FreeToBeGiven,0 as GiftPrdId,0 as GiftPrdBatId,
					0 as GiftToBeGiven,@NoOfTimes as NoOfTimes,1 as IsSelected,@SchemeBudget as SchBudget,
					0 as BudgetUtilized,@Pi_TransId,@Pi_UsrId as UsrId,MAX(PrdId) AS PrdId,MAX(PrdBatId) AS PrdBatId,0
					FROM @TempBilled , @TempSchSlabFree
					GROUP BY FreePrdId,FreeQty,ForEveryQty
					SELECT @RowId=MIN(RowId)  FROM ReturnPrdHdForScheme WHERE  
					TransId=@Pi_TransId AND UsrId=@Pi_Usrid AND SalId=@Pi_SalId
					INSERT INTO @FreePrdDt (SalId,SchId,SlabId,FreeQty,FreePrdId,FreePrdBatId,FreePriceId,
					GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,PrdId,PrdBatId,RowId)
					SELECT DISTINCT @Pi_SalId,@SchId,@SlabId,(E.FreeQty-E.ReturnFreeQty)-B.FreeToBeGiven AS FreeQty,
					E.FreePrdId,E.FreePrdBatId,E.FreePriceId AS FreePriceId,
					0 AS GiftQty,0,0,0 AS GiftPriceId,
					B.PrdId,B.PrdBatId,@RowId AS RowId FROM	BillAppliedSchemeHd B 
					INNER JOIN SalesInvoiceSchemeDtFreePrd E ON  B.SchId=E.SchId AND B.FreePrdId=E.FreePrdId
					WHERE  B.TransId=@Pi_TransId AND B.UsrId=@Pi_Usrid AND B.SchId=@SchId
					AND B.IsSelected=1 AND E.SalId=@Pi_SalId
				END
				ELSE IF @SlabId=0
				BEGIN
					IF EXISTS (SELECT * FROM BillAppliedSchemeHd B WHERE B.TransId=@Pi_TransId AND B.UsrId=@Pi_Usrid 
							AND (B.FreeToBeGiven + B.GiftToBeGiven+B.FlxFreePrd+B.FlxGiftPrd)>0 AND B.IsSelected=1 AND SchId=@SchId )
					BEGIN
						INSERT INTO @FreePrdDt (SalId,SchId,SlabId,FreeQty,FreePrdId,FreePrdBatId,FreePriceId,
						GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,PrdId,PrdBatId,RowId)
						SELECT @Pi_SalId,@SchId,B.SlabId,(E.FreeQty-E.ReturnFreeQty) AS FreeQty,
						E.FreePrdId,E.FreePrdBatId,FreePriceId AS FreePriceId,
						0 AS GiftQty,0,0,0 AS GiftPriceId,B.PrdId,B.PrdBatId,C.RowId FROM	BillAppliedSchemeHd B 
						INNER JOIN SalesInvoiceSchemeDtFreePrd E ON B.SchId=E.SchId AND B.SlabId=E.SlabId
						INNER JOIN @ReturnPrdHdForScheme C ON B.PrdId=C.PrdId AND B.PrdbatId=C.PrdbatId
						WHERE  B.TransId=@Pi_TransId AND B.UsrId=@Pi_Usrid AND B.SchId=@SchId 
						AND B.IsSelected=1 AND E.SalId=@Pi_SalId
					END
					ELSE
					BEGIN
						SELECT @RowId=MIN(RowId)  FROM ReturnPrdHdForScheme WHERE  
						TransId=@Pi_TransId AND UsrId=@Pi_Usrid AND SalId=@Pi_SalId
						SELECT @PrdBatId=(PrdBatId),@PrdId=PrdId FROM ReturnPrdHdForScheme WHERE  
						TransId=@Pi_TransId AND UsrId=@Pi_Usrid AND SalId=@Pi_SalId AND RowId=@RowId
						INSERT INTO @FreePrdDt (SalId,SchId,SlabId,FreeQty,FreePrdId,FreePrdBatId,FreePriceId,
						GiftQty,GiftPrdId,GiftPrdBatId,GiftPriceId,PrdId,PrdBatId,RowId)
						SELECT @Pi_SalId,@SchId,E.SlabId,(E.FreeQty-E.ReturnFreeQty) AS FreeQty,
						E.FreePrdId,E.FreePrdBatId,0 AS FreePriceId,
						0 AS GiftQty,0,0,0 AS GiftPriceId,@PrdId,@PrdBatId,@RowId FROM	
						SalesInvoiceSchemeDtFreePrd E WHERE E.SchId=@SchId AND E.SalId=@Pi_SalId
					END
				END
			FETCH NEXT FROM SchemeFreeCur INTO @schid
		END
		CLOSE SchemeFreeCur
		DEALLOCATE SchemeFreeCur	
		IF EXISTS(SELECT * FROM @FreePrdDt)
		BEGIN
			IF EXISTS (SELECT * FROM UserFetchReturnScheme WHERE SalID=@Pi_SalId AND TransId=@Pi_TransId AND UsrId=@Pi_Usrid)
			BEGIN
				INSERT INTO UserFetchReturnScheme (SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,
							RowId,FreePriceId,GiftPriceId)
				SELECT SalId,PrdId,PrdBatId,SchId,SlabId,0,0,0,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,0,@Pi_Usrid,@Pi_TransId,
							RowId,FreePriceId,GiftPriceId FROM @FreePrdDt 
							WHERE SchId NOT IN (SELECT SchId FROM UserFetchReturnScheme WHERE SalID=@Pi_SalId AND TransId=@Pi_TransId AND UsrId=@Pi_Usrid)
			END
			ELSE
			BEGIN
				INSERT INTO UserFetchReturnScheme (SalID,PrdId,PrdBatId,SchId,SlabId,Discamt,Flatamt,Points,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,NoofTimes,Usrid,TransId,
							RowId,FreePriceId,GiftPriceId)
				SELECT SalId,PrdId,PrdBatId,SchId,SlabId,0,0,0,
							FreeQty,FreePrdId,FreePrdBatId,GiftQty,GiftPrdId,GiftPrdBatId,0,@Pi_Usrid,@Pi_TransId,
							RowId,FreePriceId,GiftPriceId FROM @FreePrdDt 						
			END
			UPDATE A Set FreeQty=B.FreeQty ,FreePrdId=B.FreePrdId ,FreePrdBatId=B.FreePrdBatId,
					GiftQty=B.GiftQty ,GiftPrdId=B.GiftPrdId,GiftPrdBatId=B.GiftPrdBatId,
					FreePriceId=B.FreePriceId ,GiftPriceId=B.GiftPriceId FROM UserFetchReturnScheme A
					INNER JOIN @FreePrdDt B ON A.SalId=B.SalId AND A.SchId=B.SchId AND A.SlabId=B.SlabId AND A.RowId=B.RowId
					AND A.FreePrdId=B.FreePrdId
					WHERE A.SalId=@Pi_SalId
			DELETE FROM UserFetchReturnScheme WHERE DiscAmt+FlatAmt+Points+FreeQty+GiftQty=0
		END	
	END
END
GO
DELETE FROM HotSearcheditorHD WHERE FormId IN (211,212)
INSERT INTO HotSearcheditorHD
SELECT 211,'Sales Return','Bill No','select',
'SELECT DISTINCT SalId,SalInvNo,SalInvDate,BillSeqId,SalRoundOff,SalRoundOffAmt,RtrName,ReturnSalId FROM 
(SELECT DISTINCT A.SalId,SalInvNo,SalInvDate,BillSeqId,SalRoundOff,SalRoundOffAmt,RtrName,ISNULL(ReturnSalId,0) AS ReturnSalId
FROM SalesInvoice A (NOLOCK) INNER JOIN Retailer B (NOLOCK) ON A.RtrId = B.RtrId  INNER JOIN SalesInvoiceProduct C (NOLOCK) ON A.SalId=C.SalId
LEFT OUTER JOIN PercentageWiseSchemeHD D WITH (NOLOCK) ON A.SalId = D.SalId 
AND D.SalId IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 2) 
WHERE A.DlvSts in (4,5) AND(C.BaseQty-C.ReturnedQty)>0) MainSql' UNION
SELECT 212,'Sales Return','Bill No','select',
'SELECT DISTINCT SalId,SalInvNo,SalInvDate,RtrId,RtrName,BillSeqId,SalRoundOff,SalRoundOffAmt,ReturnSalId FROM 
(SELECT S.SalId,S.SalInvNo,S.SalInvDate,R.RtrId,R.RtrName,S.BillSeqId,S.SalRoundOff,S.SalRoundOffAmt,ISNULL(ReturnSalId,0) AS ReturnSalId   
FROM SalesInvoice S (NOLOCK) 
INNER JOIN Retailer R (NOLOCK) ON R.RtrId=S.RtrId
LEFT OUTER JOIN PercentageWiseSchemeHD D WITH (NOLOCK) ON S.SalId = D.SalId 
AND D.SalId IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 2)  
WHERE S.SMId=''vFParam'' AND S.RMId= ''vSParam'' AND (S.DlvSts=4 OR S.DlvSts=5)) MianSql'
GO
DELETE FROM HotsearchEditorHd WHERE FormId = 190
INSERT INTO HotsearchEditorHd
SELECT 190,'Market Return','Bill No','select',
'SELECT DISTINCT SalId,SalInvNo,LcnId,SalInvDate,RtrId,RtrName,BillSeqId,SalRoundOff,SalRoundOffAmt,0 AS ReturnSalId FROM 
(SELECT DISTINCT A.SalId,A.SalinvNo,A.LcnId,A.SalInvDate,B.RtrId,B.RtrName,A.BillSeqId,A.SalRoundOff,A.SalRoundOffAmt FROM SalesInvoice A (NOLOCK) 
INNER JOIN Retailer B (NOLOCK) ON A.RtrId = B.RtrId INNER JOIN SalesInvoiceProduct C (NOLOCK) ON A.SalId=C.SalId 
WHERE A.RtrId =''vFParam'' AND A.RMId=''vSParam'' AND A.SMId=''vTParam'' AND A.CmpId = CASE vFOParam WHEN 0 THEN A.CmpId ELSE vFOParam END   
AND A.DlvSts in (4,5) AND (C.BaseQty-C.ReturnedQty)>0 AND A.SalId NOT IN (SELECT SalId FROM PercentageWiseSchemeFreeProducts WITH (NOLOCK))
) MainSql'
GO
DELETE FROM Configuration WHERE ModuleId = 'PO1'
INSERT INTO Configuration
SELECT 'PO1','Purchase Order','Auto generates purchase order qty based on norm settings by populating all products automatically based on product sequencing screen settings',0,'0',0.00,1
GO
IF NOT EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='MenuDefToAvoid' AND XTYPE='U')
BEGIN
CREATE TABLE MenuDefToAvoid
(
	Slno INT ,
	MenuId VARCHAR(50),
	MenuName VARCHAR(100),
	ParentId VARCHAR(20),
	Caption VARCHAR(100),
	Status INT	
)
END
GO
DELETE FROM MenuDefToAvoid
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (1,'mStk11','mnuWebSite','mStk','Web Site',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (2,'mCus3','mnuRetailerPotentialClass','mCus','Retailer Potential Class',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (3,'mSal3','mnuProductSalesBundle','mSal','Product Sales Bundle',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (4,'mLog3','mnuvehicleSubsidyMaster','mLog','Vehicle Subsidy Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (5,'mClm10','mnuPurExcessRefusalClaim','mClm','Purchase Excess Refusal Claim',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (6,'mStk6','mnuUserKeys','mStk','User Key Mapping',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (7,'mCmp6','mnuChequeInventorySupplier','mCmp','Cheque Inventory (Supplier)',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (8,'mCus37','mnuFBMSwitching','mCus','FBM Switching',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (9,'mCmp17','MnuIDTSeq','mCmp','IDT Column Sequence',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (10,'mCus30','mnuRtrStkNrm','mCus','Retailer Stock Norm',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (11,'mLog4','mnuVanLoadGuide','mLog','Van Load Guide Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (12,'mCus7','mnuChequeInventoryRetailer','mCus','Cheque Inventory (Retailer)',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (13,'mCus6','mnuRetailerSequencing','mCus','Retailer Sequencing',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (14,'mSal7','mnuSubStockistStkNSales','mSal','Sub-Stockist Stock And Sales',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (15,'mSal6','mnuRspPunchWindow','mSal','RSP Punching Window',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (16,'mStk16','mnuAttendanceReg','mStk','Attendance Register',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (17,'mCmp3','mTransporter','mCmp','Transporter Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (18,'mCus23','mnuResellDamageGoods','mCus','Resell Damage Goods',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (19,'mCus12','mnuBillColumnSequence','mCus','Bill Column Sequencing',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (20,'mCmp4','mnuPurchaseRcptSequence','mCmp','Purchase Receipt Sequencing Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (21,'mPrd5','mnuProductSequencing','mPrd','Product Sequencing',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (22,'mRot3','mRouteVillageMap','mRot','Route Village Mapping',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (23,'mCus8','mnuCollectionDiscountMaster','mCus','Collection Discount Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (24,'mStk21','mnuUpload','mStk','DayEnd Export',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (25,'mStk22','mnuDownload','mStk','DayEnd Import',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (26,'mStk28','mnuFTPUpload','mStk','FTP Upload',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (27,'mStk25','mnuClusterMaster','mStk','Cluster Master',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (28,'mStk26','mnuClusterGroup','mStk','Cluster Group',0)
INSERT INTO MenuDefToAvoid([Slno],[MenuId],[MenuName],[ParentId],[Caption],[Status]) VALUES (29,'mStk27','mnuClusterAssign','mStk','Cluster Assign',0)
GO
IF NOT EXISTS (SELECT * FROM RptGroup WHERE GrpName='Other transaction Reports')
BEGIN
INSERT INTO RptGroup 
SELECT 'CORESTOCKY',0,'Other transaction Reports','Other transaction Reports',1
END
GO
DELETE FROM RptGroup WHERE Rptid IN (82,85,84,81,96,97,98,99,102,103,105,107,106,131,132,113,213,146)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',82,'RetailerDebitNoteReport','Retailer Debit Note Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',85,'DbNoteSupplierReport','Supplier Debit Note Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',84,'SupplierCreditNote','Supplier Credit Note Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',81,'RetailerCreditNoteReport','Retailer Credit Note Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',96,'SMSalaryDAMasterReport','Salesman Salary And DA Claim Details Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',97,'DlvBoySalaryDAMasterReport','Delivery Boy Salary And DA Claim Details Master  Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',98,'TransporterClaimMasterReport','Transporter Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',99,'PurShortageClaimMasterReport','Purchase Shortage Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',102,'SpecialDiscClaimMasterReport','Special Discount Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',103,'VanSubsidycClaimMasterReport','Van Subsidy Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',105,'ManualClaimMasterReport','Manual Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',107,'ClaimTopSheet','Claim Top Sheet Details Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',106,'SMIncentiveClaimReport','Salesman Incentive Claim Detail Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',131,'ReturnToCompanyDetails','Return To Company Details Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',132,'ReturnToCompanySummary','Return To Company Summary Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',113,'ResellDamageGOodsReport','Resell Damage GOods Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',213,'ModernTradeClaim','Modern Trade Claim Master Report',1)
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Other transaction Reports',146,'SalesmanIncentive','Salesman Incentive',1)
GO
UPDATE RptGroup SET VISIBILITY=0 WHERE RptId=123
GO
DELETE FROM Configuration WHERE ModuleId = 'DISTAXCOLL10'
INSERT INTO Configuration(ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo) 
VALUES('DISTAXCOLL10','Discount & Tax Collection','DB Discount based on the UOM Based Qty','0','','0.00','11')
GO
DELETE FROM Configuration WHERE ModuleId = 'GENCONFIG33'
INSERT INTO Configuration (ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo) 
VALUES('GENCONFIG33','General Configuration','Batch download based on the effective date','0','','0.00','33')
GO
DELETE FROM Configuration WHERE ModuleId = 'GENCONFIG34'
INSERT INTO Configuration (ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo) 
VALUES('GENCONFIG34','General Configuration','Acknowledge Date confirm in user login','0','','0.00','34')
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='ProductBatchEeffectiveDate')
BEGIN
	CREATE TABLE [ProductBatchEeffectiveDate](
	[PrdCCode] [nvarchar](200) NULL,
	[PrdBatCode] [nvarchar](200) NULL,
	[ManufacturingDate] [datetime] NULL,
	[ExpiryDate] [datetime] NULL,
	[EffectiveDate] [datetime] NULL,
	[MRP] [numeric](38, 6) NULL,
	[ListPrice] [numeric](38, 6) NULL,
	[SellingRate] [numeric](38, 6) NULL,
	[ClaimRate] [numeric](38, 6) NULL,
	[AddRate1] [numeric](38, 6) NULL,
	[AddRate2] [numeric](38, 6) NULL,
	[AddRate3] [numeric](38, 6) NULL,
	[AddRate4] [numeric](38, 6) NULL,
	[AddRate5] [numeric](38, 6) NULL,
	[AddRate6] [numeric](38, 6) NULL,
	[UpdateFlag] [nvarchar](10) NULL
)	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_DefaultPriceHistory')
DROP PROCEDURE Proc_DefaultPriceHistory
GO
/*
BEGIN TRANSACTION
EXEC Proc_DefaultPriceHistory 0,0,248,2,1
SELECT * FROM DefaultPriceHistory WHERE PrdBatId IN (SELECT PrdBatId FROM ProductBatch WHERE PrdBatCode ='YY13333360')
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_DefaultPriceHistory]
(
	@Pi_PrdId			INT,	
	@Pi_PrdBatId	    INT,
	@Pi_PriceId			INT,
	@Pi_Mode			INT,
	@Pi_UserId			INT
)
AS
/*********************************
* PROCEDURE		: Proc_DefaultPriceHistory
* PURPOSE		: To Store the Default Price History
* CREATED		: Nandakumar R.G
* CREATED DATE	: 02/10/2009
* MODIFIED      : Sathishkumar Veeramani
* PURPOSE		: New Product Batch - Current Stock Report
* MODIFIED DATE : 13/09/2012
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/

/*
	@Pi_Mode=1 ---> Through Front End
	@Pi_Mode=2 ---> Changes Through ETL/Download
*/
SET NOCOUNT ON
BEGIN

	DECLARE @PrdId		INT
	DECLARE @PrdBatId	INT
	DECLARE @PriceId	INT
	
	
	SELECT DISTINCT P.Prdid,X.PrdbatId,PriceId,ISNULL(SUM(MRP),0) as MRP ,
	ISNULL(SUM(ListPrice),0) as ListPrice,ISNULL(SUM(SellRate),0) as SellRate
	INTO #ProductBatchMaster
	FROM(
		SELECT P.Prdid,P.PrdbatId ,PriceId,PrdBatDetailValue as MRP,0 as ListPrice,0 as SellRate,0 as ClaimRate  
		FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
		INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
		and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and MRP=1
		UNION ALL
		SELECT P.Prdid,P.PrdbatId ,PriceId,0 as MRP,PrdBatDetailValue as ListPrice,0 as SellRate,0 as ClaimRate  
		FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
		INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
		and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and ListPrice=1
		UNION ALL
		SELECT P.Prdid,P.PrdbatId ,PriceId,0 as MRP,0 as ListPrice,PrdBatDetailValue as SellRate,0 as ClaimRate  
		FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
		INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
		and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and SelRte=1 
	) X
	INNER JOIN Product P ON X.PrdId=P.PrdId
	GROUP BY P.Prdid,X.PrdbatId,X.PriceId
	
	IF @Pi_Mode=1
	BEGIN
		IF NOT EXISTS(SELECT * FROM DefaultPriceHistory WHERE PrdId=@Pi_PrdId AND PrdBatId=@Pi_PrdBatId 
		AND PriceId=@Pi_PriceId AND ToDate='1900-01-01')
		BEGIN
			
			-->To Set the To Date for old default price
			UPDATE DefaultPriceHistory SET ToDate=GETDATE()
			WHERE PrdId=@Pi_PrdId AND PrdBatId=@Pi_PrdBatId AND CurrentDefault=1

			-->To update the old prices as non defaults
			UPDATE DefaultPriceHistory SET CurrentDefault=0
			WHERE PrdId=@Pi_PrdId AND PrdBatId=@Pi_PrdBatId
		
			-->To insert the new defaults
			INSERT INTO DefaultPriceHistory(PrdId,PrdBatId,PriceId,SellingRate,PurchaseRate,MRP,FromDate,ToDate,CurrentDefault,
			Availability,LastModBy,LastModDate,AuthId,AuthDate) 	
			SELECT PB.PrdId,PB.PrdBatId,PB.PriceId,SellRate,ListPrice,MRP,GETDATE(),'1900-01-01',1, 
			1,@Pi_UserId,GETDATE(),1,GETDATE() 
			FROM #ProductBatchMaster PB WHERE PB.PriceId=@Pi_PriceId and PB.PrdId=@Pi_PrdId and  PB.PrdbatId=@Pi_PrdBatId
		END
	END
	ELSE IF @Pi_Mode=2
	BEGIN
		DECLARE @ProductBatchPrice TABLE
		(
			PrdId			NUMERIC(18,0),
			PrdBatId		NUMERIC(18,0),
			PriceId		NUMERIC(18,6)
		)		
		
		INSERT INTO @ProductBatchPrice
        SELECT PB.PrdId,PB.PrdBatId,PBD.PriceId FROM ProductBatch PB(NOLOCK),ProductBatchDetails PBD(NOLOCK)
		WHERE PB.PrdBatId=PBD.PrdBatId AND PBD.PriceId<=@Pi_PriceId AND PBD.SlNo=1 AND PBD.DefaultPrice=1
		AND PriceId NOT IN (SELECT PriceId FROM DefaultPriceHistory)
		ORDER BY PB.PrdId,PB.PrdBatId,PBD.PriceId
					
		IF NOT EXISTS(SELECT * FROM DefaultPriceHistory A INNER JOIN @ProductBatchPrice B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
		AND A.PriceId=B.PriceId AND ToDate='1900-01-01')
		BEGIN

			-->To Set the To Date for old default price
			UPDATE A SET ToDate=GETDATE() FROM DefaultPriceHistory A INNER JOIN @ProductBatchPrice B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId 
			AND A.PriceId=B.PriceId AND CurrentDefault=1

			-->To update the old prices as non defaults
			UPDATE A SET  CurrentDefault=0 FROM DefaultPriceHistory A INNER JOIN @ProductBatchPrice B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId 
			AND A.PriceId=B.PriceId
					
			-->To insert the new defaults
			INSERT INTO DefaultPriceHistory(PrdId,PrdBatId,PriceId,SellingRate,PurchaseRate,MRP,FromDate,ToDate,CurrentDefault,
			Availability,LastModBy,LastModDate,AuthId,AuthDate) 			
			SELECT PB.PrdId,PB.PrdBatId,PB.PriceId,SellRate,ListPrice,MRP,GETDATE(),'1900-01-01',1, 
			1,@Pi_UserId,GETDATE(),1,GETDATE() 
			FROM #ProductBatchMaster PB ,@ProductBatchPrice Final
			WHERE Final.PrdId=PB.PrdId AND Final.PrdBatId=PB.PrdBatId 
			AND PB.PriceId=Final.PriceId
		
		END
	END
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_ValidateBatchLDEeffectiveDate')
DROP PROCEDURE Proc_ValidateBatchLDEeffectiveDate
GO
/* 
   BEGIN TRANSACTION
	SELECT COUNT(*) FROM ProductBatch
	SELECT COUNT(*) FROM Productbatchdetails
	EXEC Proc_ValidateBatchLDEeffectiveDate
	SELECT * FROM ProductBatchEeffectiveDate
	SELECT COUNT(*) FROM ProductBatch
	SELECT COUNT(*) FROM Productbatchdetails
	Select COUNT(*) FROM Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='Y'
   ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_ValidateBatchLDEeffectiveDate]
AS
/*********************************
* PROCEDURE		: Proc_ValidateBatchLDEeffectiveDate
* PURPOSE		: To Insert and Update records in the Tables ProductBatch and ProductBatchDetails
* CREATED BY	: Murugan.R
* CREATED DATE	: 2013-09-01
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	
	BEGIN TRY	
	DELETE FROM Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(	SELECT DISTINCT  PrdCCode FROM  Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='D'
	AND EffectiveDate<=CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121))
	BEGIN
		RETURN
	END
	
	DECLARE @Prdbatid AS NUMERIC(36,0)
	DECLARE @PriceId AS NUMERIC(36,0)
	DECLARE @BatSeqId AS INT
	
	SELECT @Prdbatid=ISNULL(MAX(PrdbatId),0) FROM ProductBatch (NOLOCK)
	SELECT @PriceId=ISNULL(MAX(PriceId),0) FROM Productbatchdetails (NOLOCK)
	SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)
	
	CREATE TABLE #Cn2Cs_Prk_ProductbatchTemp(
	[PrdCCode] [nvarchar](200) COLLATE DATABASE_DEFAULT NULL ,
	[PrdBatCode] [nvarchar](200)   COLLATE DATABASE_DEFAULT NULL,
	[ManufacturingDate] [datetime] NULL,
	[ExpiryDate] [datetime] NULL,
	[EffectiveDate] [datetime] NULL,
	[MRP] [numeric](38, 6) NULL,
	[ListPrice] [numeric](38, 6) NULL,
	[SellingRate] [numeric](38, 6) NULL,
	[ClaimRate] [numeric](38, 6) NULL,
	[AddRate1] [numeric](38, 6) NULL,
	[AddRate2] [numeric](38, 6) NULL,
	[AddRate3] [numeric](38, 6) NULL,
	[AddRate4] [numeric](38, 6) NULL,
	[AddRate5] [numeric](38, 6) NULL,
	[AddRate6] [numeric](38, 6) NULL	
	)
	CREATE TABLE #PrdBatToAvoid
	(
		PrdCCode NVARCHAR(200)  COLLATE DATABASE_DEFAULT,
		PrdBatCode NVARCHAR(200)  COLLATE DATABASE_DEFAULT,
		ErrorID	TinyInt
	)
	INSERT INTO #Cn2Cs_Prk_ProductbatchTemp(PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,
	AddRate5,AddRate6)
	SELECT DISTINCT  PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,
	AddRate5,AddRate6 FROM  Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='D'
	AND EffectiveDate<=CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)
	
	--Product  Code Validation
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_ProductBatch','PrdCCode',Prdccode+ ' : Product Code does not exists' FROM #Cn2Cs_Prk_ProductbatchTemp PE
	WHERE NOT EXISTS(SELECT P.PrdCCode FROM Product P (NOLOCK) WHERE P.PrdCCode=PE.Prdccode)
	
	INSERT INTO #PrdBatToAvoid(PrdCCode,PrdBatCode,ErrorID)
	SELECT Prdccode,'',1 FROM #Cn2Cs_Prk_ProductbatchTemp PE
	WHERE NOT EXISTS(SELECT P.PrdCCode FROM Product P (NOLOCK) WHERE P.PrdCCode=PE.Prdccode)
	
	DELETE A FROM #Cn2Cs_Prk_ProductbatchTemp A INNER JOIN #PrdBatToAvoid B ON A.Prdccode=B.Prdccode
	
	--Mandatory Field Validation
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 2,'Cn2Cs_Prk_ProductBatch','SellingRate,PrdBatCode','Mandatory field con not be empty' 
	FROM #Cn2Cs_Prk_ProductbatchTemp WHERE (LEN(LTRIM(RTRIM(PrdBatCode)))=0 OR SellingRate<0)
	
	
	INSERT INTO #PrdBatToAvoid(PrdCCode,PrdBatCode,ErrorID)
	SELECT Prdccode,'',2 
	FROM #Cn2Cs_Prk_ProductbatchTemp WHERE (LEN(LTRIM(RTRIM(PrdBatCode)))=0 OR SellingRate<0)
	
	DELETE A FROM #Cn2Cs_Prk_ProductbatchTemp A INNER JOIN #PrdBatToAvoid B ON A.Prdccode=B.Prdccode
	
	
	--Product batch code and Price Validation
	SELECT DISTINCT P.PrdCCode,PrdBatCode,ISNULL(SUM(MRP+ListPrice+SellRate+ClaimRate),0) as PriceValue
	INTO #ProductBatch
	FROM(
	SELECT P.Prdid,P.PrdBatCode ,PrdBatDetailValue as MRP,0 as ListPrice,0 as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and MRP=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,PrdBatDetailValue as ListPrice,0 as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and ListPrice=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,0 as ListPrice,PrdBatDetailValue as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and SelRte=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,0 as ListPrice,0 as SellRate,PrdBatDetailValue as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and ClmRte=1) X
	INNER JOIN Product P ON X.PrdId=P.PrdId
	GROUP BY PrdBatCode ,P.PrdCCode
	
	SELECT DISTINCT PE.Prdccode,PE.PrdBatCode,
	(MRP+ListPrice+SellingRate+ClaimRate)-(PriceValue) as PriceValue
	INTO #Removebatch
	FROM #Cn2Cs_Prk_ProductbatchTemp PE
	INNER JOIN #ProductBatch P ON PE.PrdCCode=P.PrdCCode AND PE.PrdBatCode =P.PrdBatCode
	
	--EXISTING BATCH VALIDATION
	SELECT DISTINCT PrdId,PrdbatId INTO #StockLedger FROM StockLedger (NOLOCK)
	
	--TRANSACTION EXISTS BATCH
	UPDATE PB SET MnfDate=ManufacturingDate,ExpDate= ExpiryDate
	FROM #Cn2Cs_Prk_ProductbatchTemp P 
	INNER JOIN 	ProductBatch PB ON PB.PrdBatCode=P.PrdBatCode
	INNER JOIN  Product PC ON P.PrdCCode=PC.PrdCCode and PC.Prdid=PB.PrdId
	INNER JOIN #StockLedger D ON PC.Prdid=D.PrdId and PB.PrdBatId=D.PrdBatId and PB.PrdId=D.PrdId
	
	---UPDATE PRODUCTBATCH TABLE WITH OUT TRANSACTION
	UPDATE PB SET MnfDate=ManufacturingDate,ExpDate= ExpiryDate,	
	PrdBatCode=P.PrdBatCode,CmpBatCode=P.PrdBatCode,TaxGroupId=PC.TaxGroupId,
	Status=1,BatchSeqId=@BatSeqId
	FROM #Cn2Cs_Prk_ProductbatchTemp P 
	INNER JOIN 	ProductBatch PB ON PB.PrdBatCode=P.PrdBatCode
	INNER JOIN  Product PC ON P.PrdCCode=PC.PrdCCode and PC.Prdid=PB.PrdId
	WHERE NOT EXISTS (SELECT Prdid,Prdbatid  FROM #StockLedger D 
	WHERE PC.Prdid=D.PrdId and PB.PrdBatId=D.PrdBatId and PB.PrdId=D.PrdId)
	
	
	UPDATE C SET DownLoadFlag='Y' FROM Cn2Cs_Prk_ProductBatch C 
	INNER JOIN #Cn2Cs_Prk_ProductbatchTemp A ON A.Prdccode=C.Prdccode
	and A.PrdBatCode=C.PrdBatCode
	INNER JOIN  #Removebatch B ON A.Prdccode=B.Prdccode
	and A.PrdBatCode=B.PrdBatCode  AND 
	C.Prdccode=B.Prdccode
	and C.PrdBatCode=B.PrdBatCode
	WHERE PriceValue Between -0.05 and 0.05
	
	--DELETE THE BATCH WITH SAME PRICE VALUE
	DELETE A FROM #Cn2Cs_Prk_ProductbatchTemp A INNER JOIN  #Removebatch B ON A.Prdccode=B.Prdccode
	and A.PrdBatCode=B.PrdBatCode WHERE PriceValue Between -0.05 and 0.05
	IF NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_ProductbatchTemp)
		BEGIN
			RETURN
		END
	
	INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,
	Status,TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,
	LastModBy,LastModDate,AuthId,AuthDate)
	SELECT DISTINCT P.Prdid,@Prdbatid+ROW_NUMBER() OVER(Order by PE.Prdccode,PE.PrdBatCode,SellingRate),
	PrdBatCode,PrdBatCode,ManufacturingDate,ExpiryDate,1,P.TaxGroupId,@BatSeqId,
	6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)	
	FROM #Cn2Cs_Prk_ProductbatchTemp PE 
	INNER JOIN Product P ON PE.PrdCCode=P.PrdCCode
	WHERE NOT EXISTS(SELECT Prdccode,PrdbatCode FROM #ProductBatch A WHERE A.PrdCCode=PE.PrdCCode and A.PrdBatCode=Pe.PrdBatCode)
	
	
	SELECT DISTINCT PE.Prdccode,PE.PrdBatCode,P.Prdid,@PriceId+ROW_NUMBER() OVER(Order by PE.Prdccode,PE.PrdBatCode,SellingRate) as PriceId,
	Prdbatid,PE.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
	CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,
	@BatSeqId as BatSeqId,
	1 as DefaultPrice,1 as PriceStatus,1 as Availability,1 as LastModBy,CONVERT(NVARCHAR(10),GETDATE(),121) as LastModDate,
	1 as AuthId,CONVERT(NVARCHAR(10),GETDATE(),121) AuthDate,
	[MRP],[ListPrice],[SellingRate],[ClaimRate],[AddRate1]
	INTO #ProductbatchDetailsTemp
	FROM   #Cn2Cs_Prk_ProductbatchTemp PE 
	INNER JOIN Product P ON PE.PrdCCode=P.PrdCCode
	INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId and PB.PrdBatCode=PE.PrdBatCode
	
	IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,1,MRP,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,2,ListPrice,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,3,SellingRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,4,ClaimRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
	END
	ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,1,MRP,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,2,ListPrice,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,3,SellingRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,4,ClaimRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,5,AddRate1,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetailsTemp
	END
	
		
	
		SELECT MAX(PriceId) as PriceId,PrdbatId,PrdId INTO #TempPrice FROM #ProductbatchDetailsTemp GROUP BY PrdbatId,PrdId
			
		UPDATE A SET DefaultPriceId=C.PriceId FROM ProductBatch A INNER JOIN #TempPrice C ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId
		UPDATE A SET DefaultPrice=0	FROM ProductBatchDetails A		
		INNER JOIN #TempPrice B ON B.PrdbatiD=A.prdbatid and A.PriceId<>B.PriceId	
				
		UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN
		(
			SELECT PrdBatId FROM ProductBatchDetails GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)
		)
		
		Update Counters Set CurrValue=(SELECT MAX(PrdbatiD) FROM ProductBatch (NOLOCK)) WHERE TabName='ProductBatch' and FldName='PrdBatId'
		Update Counters Set CurrValue=(SELECT MAX(PriceId) FROM ProductBatchdetails  (NOLOCK)) WHERE TabName='ProductBatchDetails' and FldName='PriceId'
	IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@PriceId)
	BEGIN
		EXEC Proc_DefaultPriceHistory 0,0,@PriceId,2,1
	END
	
	
	UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y' 
	FROM Cn2Cs_Prk_ProductBatch A INNER JOIN #ProductbatchDetailsTemp B
	ON A.PrdBatCode=B.PrdBatCode and A.PrdCCode=B.PrdCCode
	
		
	END TRY
	BEGIN CATCH		
		Select ERROR_MESSAGE()
	END CATCH	
	RETURN		
	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cn2Cs_ProductBatch')
DROP PROCEDURE Proc_Cn2Cs_ProductBatch
GO
/* 
   BEGIN TRANSACTION
	SELECT COUNT(*) FROM ProductBatch
	SELECT COUNT(*) FROM Productbatchdetails
	EXEC Proc_Cn2Cs_ProductBatch 0
	SELECT * FROM ProductBatchEeffectiveDate
	 SELECT COUNT(*) FROM ProductBatch
	SELECT COUNT(*) FROM Productbatchdetails
	Select COUNT(*) FROM Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='Y'
   ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cn2Cs_ProductBatch]
(
       @Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_ProductBatch
* PURPOSE		: To Insert and Update records in the Tables ProductBatch and ProductBatchDetails
* CREATED BY	: Nandakumar R.G
* CREATED DATE	: 12/04/2010
* MODIFIED      : Sathishkumar Veeramani
* PURPOSE		: New Product Batch - Special Rate Created
* MODIFIED DATE : 13/09/2012
* MODIFIED      : Murugan.R
* PURPOSE		: Batch Optimization  and Akzonabal Price change
* MODIFIED DATE : 13/09/2012
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN

	SET @Po_ErrNo =0
	IF NOT EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE DownLoadFlag='D') RETURN
	
	--Product batch configuration  For Aznoble Client
	IF EXISTS(SELECT Status FROM Configuration where ModuleId='GENCONFIG33' and Status=1)
		BEGIN
			DELETE FROM ProductBatchEeffectiveDate WHERE UpdateFlag='Y'
			
			INSERT INTO ProductBatchEeffectiveDate(PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,
			EffectiveDate,MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,
			AddRate3,AddRate4,AddRate5,AddRate6,UpdateFlag)			 
			SELECT PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,
			MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,
			AddRate4,AddRate5,AddRate6,'N' 
			FROM Cn2Cs_Prk_ProductBatch WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)
			DELETE FROM Cn2Cs_Prk_ProductBatch  WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)
			--Product Batch and Price Insert For Aznoble Client
			EXEC Proc_ValidateBatchLDEeffectiveDate
			
			RETURN
			
		END
	
	IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatToAvoid' AND XTYPE = 'U')
	BEGIN
		DROP TABLE PrdBatToAvoid	
	END
	CREATE TABLE PrdBatToAvoid
	(
		PrdCCode NVARCHAR(200),
		PrdBatCode NVARCHAR(200)
	)
	DECLARE @ExistingBatchDetails	TABLE
	(
		PrdId		NUMERIC(18,0),
		PrdCCode	VARCHAR(100),
		PrdBatCode	VARCHAR(100),
		PriceCode	VARCHAR(500),
		OldLSP		NUMERIC(18,0),
		PrdBatId	NUMERIC(18,0),
		PriceId		NUMERIC(18,0)
	)
	DECLARE @ProductBatchWithCounter TABLE
	(
		Slno			NUMERIC(18,0) IDENTITY(1,1),
		TransNo			NUMERIC(18,0),
		PrdId			NUMERIC(18,0),
		PrdCCode		VARCHAR(100),
		PrdBatCode		VARCHAR(100),
		MnfDate			DATETIME,
		ExpDate			DATETIME		
	)	
	DECLARE @ProductBatchPriceWithCounter TABLE
	(
		Slno			NUMERIC(18,0) IDENTITY(1,1),
		TransNo			NUMERIC(18,0),
		PrdId			NUMERIC(18,0),
		PrdBatId		NUMERIC(18,0),
		PriceCode		NVARCHAR(1000),
		MRP				NUMERIC(18,6),
		ListPrice		NUMERIC(18,6),
		SellingRate		NUMERIC(18,6),
		ClaimRate		NUMERIC(18,6),
		AddRate1		NUMERIC(18,6)
	)
	DECLARE @ContractPrice TABLE
	(
	   PrdId NUMERIC(18,0),
	   PrdBatId NUMERIC(18,0)
	)
	
	DECLARE @ContractBatchPrice TABLE
    (
	   ContractId       NUMERIC(18,0),
	   CtgMainId        NUMERIC(18,0),
	   PrdId            NUMERIC(18,0),
	   PrdBatId         NUMERIC(18,0),
	   PriceId          NUMERIC(18,0),
	   PriceCode        NVARCHAR(500)
    )
    DECLARE @ProductBatchDetails TABLE
	(
	   PrdId                NUMERIC(18,0),
	   PrdBatId             NUMERIC(18,0),
	   PriceId              NUMERIC(18,0),
	   PriceCode            NVARCHAR(500),
	   NewBatchId           NUMERIC(18,0),
	   Slno                 INT,
	   PrdBatDetailValue    NUMERIC(36,4),
	   NewPriceId           NUMERIC(18,0)
	)  
	
	DECLARE @BatSeqId			AS	INT
	DECLARE @ValDiffRefNo		AS	VARCHAR(100)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT	
	DECLARE @ContPriceId		AS 	NUMERIC(18,0)	
	DECLARE @OldPriceId 		AS 	INT
	DECLARE @NewPriceId			AS  INT
	DECLARE @ContPrdId          AS  INT
    DECLARE @ContPrdBatId       AS  INT
    DECLARE @ContPriceId1       AS  INT
    DECLARE @PriceId            AS  INT 
    DECLARE @PriceBatch         AS  INT
	SELECT @OldPriceId=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails WITH (NOLOCK)		
	SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)
	SELECT @ExistPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch WITH (NOLOCK)
	SET @Po_ErrNo =0
	IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)
	WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D')
	BEGIN
		INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)
		SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)
		WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Product Batch','PrdCCode','Product :'+PrdCCode+' not available'
		FROM Cn2Cs_Prk_ProductBatch	WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) 
		AND DownLoadFlag='D'
		
		--->Added By Nanda on 05/05/2010
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)
		SELECT DISTINCT DistCode,'Product Batch',PrdBatCode,'Product',PrdCCode,'','N' FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) 
		WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'
		--->Till Here				
	END
	IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)
	WHERE LEN(ISNULL(PrdBatCode,''))=0  AND DownLoadFlag='D')
	BEGIN
		INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)
		SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)
		WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Product Batch','PrdBatCode','Batch Code should not be empty for Product:'+PrdCCode
		FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)
		WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'
	END
		
	INSERT INTO @ExistingBatchDetails
	SELECT DISTINCT B.PrdId,B.PrdCCode,A.PrdBatCode,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
	CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,
	ISNULL(D.PrdBatDetailValue,0) AS OldLSP,C.PrdBatId,D.PrdBatId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK) 
	INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode
	INNER JOIN ProductBatch C (NOLOCK)ON A.PrdBatCode=C.PrdBatCode AND B.PrdId=C.PrdId
	INNER JOIN ProductBatchDetails D (NOLOCK) ON  D.PrdBatId=C.PrdBatId AND D.DefaultPrice=1 AND D.SlNo=2
	WHERE A.PrdBatCode NOT IN (SELECT PrdBatCode FROM PrdBatToAvoid) AND DownLoadFlag='D'
	
	IF EXISTS (SELECT * FROM @ExistingBatchDetails)
	BEGIN
		UPDATE A SET MnfDate=C.ManufacturingDate,ExpDate=ExpiryDate
		FROM ProductBatch A (NOLOCK) INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
		INNER JOIN Cn2Cs_Prk_ProductBatch C (NOLOCK) ON A.PrdBatCode=C.PrdBatCode  AND B.PrdCCode=C.PrdCCode
		WHERE C.DownLoadFlag='D'
	
		UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y' 
		WHERE PrdCCode+'~'+PrdBatCode IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ExistingBatchDetails) AND DownLoadFlag='D' 
	
	
	END
	DECLARE @Count1	NUMERIC(18,0)
	DECLARE @Count2	NUMERIC(18,0)
	SELECT @Count1=COUNT(*) FROM Cn2Cs_Prk_ProductBatch
	SELECT @Count2=COUNT(*) FROM @ExistingBatchDetails

	IF @Count1<>@Count2
		BEGIN
	--IF NOT EXISTS (SELECT * FROM @ExistingBatchDetails)
	--BEGIN
	---New ProductBatch		
		INSERT INTO @ProductBatchWithCounter
		SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatch' AND FldName='PrdBatId'),
		B.PrdId,A.PrdCCode,A.PrdBatCode,ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK) 
		INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C (NOLOCK) 
		WHERE C.PrdBatCode=A.PrdBatCode AND B.PrdId=C.PrdId)AND 
		A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'
			
		UPDATE @ProductBatchWithCounter SET TransNo=TransNo+Slno
	--Existing ProductBatch 
			INSERT INTO @ProductBatchWithCounter
			SELECT DISTINCT C.PrdBatId,B.PrdId,A.PrdCCode,A.PrdBatCode,
			ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode
			INNER JOIN ProductBatch C ON B.PrdId = C.PrdId AND C.PrdBatCode = A.PrdBatCode WHERE 
			NOT EXISTS (SELECT PrdBatId FROM ProductBatchDetails D(NOLOCK) WHERE D.PrdBatId = C.PrdBatId AND D.PriceId = C.DefaultPriceId)	
			AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'
			AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ProductBatchWithCounter)
	
	 --Product Batch   
		INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,Status,
		TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT A.PrdId,TransNo,PrdBatCode,PrdBatCode,MnfDate,ExpDate,1,B.TaxGroupId,@BatSeqId,
		6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchWithCounter A 
		INNER JOIN Product B ON A.PrdId=B.PrdId WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C WHERE A.PrdId = C.PrdId 
		AND A.PrdBatCode = C.PrdBatCode)
    --END 
		END

	IF EXISTS (SELECT * FROM @ProductBatchWithCounter) 
	BEGIN
		UPDATE Counters SET CurrValue = (SELECT MAX(PrdBatId) FROM ProductBatch) WHERE TabName = 'ProductBatch' AND FldName = 'prdbatid'
	
		INSERT INTO @ProductBatchPriceWithCounter
		SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'),A.PrdId,A.TransNo,
		A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
		CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)),MRP,ListPrice,
		SellingRate,ClaimRate,AddRate1 FROM @ProductBatchWithCounter A INNER JOIN Cn2Cs_Prk_ProductBatch B WITH (NOLOCK)
		ON A.PrdCCode=B.PrdCCode AND A.PrdBatCode=B.PrdBatCode WHERE B.DownLoadFlag='D'
		
		UPDATE @ProductBatchPriceWithCounter SET TransNo=TransNo+Slno
				
		UPDATE A SET A.DefaultPrice=0 FROM ProductBatchDetails A WITH (NOLOCK),@ProductBatchPriceWithCounter B  
	    WHERE A.PrdBatId = B.PrdBatId
		
	END
	
	IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
	END
	ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
	END	
	UPDATE A SET DefaultPriceId=C.TransNo FROM ProductBatch A INNER JOIN @ProductBatchPriceWithCounter C ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId
	
	IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter) 
	BEGIN
		UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails) 	WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'	
	END
	
	IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeRateForOldBatch' AND ModuleName='Botree Product Batch Download' AND Status=1)
	BEGIN
		IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter A INNER JOIN @ExistingBatchDetails B ON A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId
		WHERE (B.OldLSP-A.ListPrice)<>0 AND Slno=2)
		BEGIN
			SELECT @ValDiffRefNo = dbo.Fn_GetPrimaryKeyString('ValueDifferenceClaim','ValDiffRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			INSERT INTO ValueDifferenceClaim(ValDiffRefNo,Date,PrdId,PrdBatId,OldPriceId,NewPriceId,OldPrice,NewPrice,Qty,
			ValueDiff,ClaimAmt,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			
			SELECT @ValDiffRefNo,GETDATE(),A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice,
			ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0),B.OldLsp-C.ListPrice,
			ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0)*(B.OldLsp-C.ListPrice),
			1,1,GETDATE(),1,GETDATE() FROM ProductBatchLocation A INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatID=B.PrdBatId 
			INNER JOIN @ProductBatchPriceWithCounter C ON A.PrdBatId=C.PrdBatId AND A.PrdId=C.PrdId
			WHERE C.Slno=2	GROUP BY A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice
			
			UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'ValueDifferenceClaim' AND FldName = 'ValDiffRefNo'
		END
	END
	UPDATE ProductBatch SET ProductBatch.DefaultPriceId=PBD.PriceId,ProductBatch.BatchSeqId=PBD.BatchSeqId
	FROM ProductBatchDetails PBD WITH (NOLOCK) WHERE ProductBatch.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1
	
	UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN
	(
	 SELECT PrdBatId FROM ProductBatchDetails WITH (NOLOCK) GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)
	)
	
	SELECT PrdBatId INTO #ZeroBatches FROM ProductBatchDetails WITH (NOLOCK)
	GROUP BY PrdBatId HAVING SUM(DefaultPrice)=0
	
	SELECT B.PrdId,B.PrdBatId,MAX(PriceId) As PriceId INTO #ZeroMaxPrices
	FROM ProductBatchDetails A INNER JOIN ProductBatch B ON A.PrdBatId=B.PrdBatId
	INNER JOIN #ZeroBatches C ON A.PrdBatId=C.PrdBatId
	WHERE A.DefaultPrice=0 GROUP BY B.PrdId,B.PrdBatId
	
	UPDATE ProductBatch Set DefaultPriceId=B.PriceId FROM ProductBatch A,#ZeroMaxPrices B
	WHERE A.PrdBatId=B.PrdbatId and A.PrdId=B.PrdId
	
	UPDATE ProductBatchDetails Set DefaultPrice=1 FROM #ZeroMaxPrices A
	WHERE ProductBatchDetails.PrdbatId=A.PrdBatId AND ProductBatchDetails.PriceId=A.PriceId
	
	SET @Po_ErrNo=0
	SELECT @OldPriceId=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails
	IF @ExistPrdBatMaxId>0
	BEGIN
		SELECT @NewPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch
		IF @NewPrdBatMaxId>@ExistPrdBatMaxId
		BEGIN
			--SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId INTO #ContractPrice FROM ProductBatch A (NOLOCK),@ProductBatchWithCounter B
			--WHERE  A.PrdId = B.PrdId AND A.PrdBatId < @ExistPrdBatMaxId AND EXISTS
			--(SELECT CPD.PrdBatId FROM ContractPricingDetails CPD (NOLOCK)
			--INNER JOIN ProductBatch PB1 (NOLOCK) ON CPD.PrdId=PB1.PrdId AND CPD.PrdBatId=PB1.PrdBatId AND A.PrdBatId=CPD.PrdBatId
			--AND CPD.PrdID IN (SELECT DISTINCT PrdId FROM @ProductBatchWithCounter))GROUP BY A.PrdId 
			INSERT INTO @ContractPrice (PrdId,PrdBatId)
			SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK),
			ContractPricingDetails B (NOLOCK),@ProductBatchWithCounter C
            WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId AND A.PrdId = C.Prdid AND B.PrdId = C.Prdid 
            GROUP BY A.PrdId ORDER BY A.PrdId
			        
			IF EXISTS(SELECT * FROM @ContractPrice)
			BEGIN
			
				SELECT DISTINCT PrdbatId,PriceId,Max(PriceCode) as PriceCode INTO #ProductBatchDetails 
				FROM ProductBatchDetails
				GROUP BY PrdbatId,PriceId
				INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode) 
				SELECT Max(C.ContractId) as ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,
				--CAST('' AS NVARCHAR(4000)) AS PriceCode
				PriceCode
				FROM  ContractPricingMaster D (NOLOCK) 
				INNER JOIN  ContractPricingDetails C (NOLOCK)   ON C.ContractId = D.ContractId
				INNER JOIN  #ProductBatchDetails A (NOLOCK) ON A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId
				INNER JOIN @ContractPrice E  ON E.PrdBatId = C.PrdBatId AND E.PrdId = C.PrdId 
				GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId ,PriceCode
			
			    --INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode)
			    --SELECT DISTINCT MAX(D.ContractId) AS ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,
			    --CAST('' AS NVARCHAR(4000)) AS PriceCode FROM ProductBatchDetails A (NOLOCK),
			    --ContractPricingDetails C (NOLOCK),ContractPricingMaster D (NOLOCK),@ContractPrice E 
			    --WHERE A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId AND C.ContractId = D.ContractId AND E.PrdId = C.PrdId 
			    --AND E.PrdBatId = C.PrdBatId GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId    
			
			    --UPDATE A SET A.PriceCode = D.PriceCode FROM @ContractBatchPrice A,ContractPricingDetails B WITH(NOLOCK),
			    --ContractPricingMaster C WITH(NOLOCK),ProductBatchDetails D WITH(NOLOCK) WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
			    --AND A.CtgMainId = C.CtgMainId AND D.PrdBatId = A.PrdBatId AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId 
			    --UPDATE A SET A.PriceCode = D.PriceCode
			    --FROM @ContractBatchPrice A 
			    --INNER JOIN ContractPricingDetails B WITH(NOLOCK) ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
			    --INNER JOIN ContractPricingMaster C WITH(NOLOCK) ON   A.CtgMainId = C.CtgMainId  AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId and A.ContractId=B.ContractId
			    --INNER JOIN #ProductBatchDetails D WITH(NOLOCK) ON D.PrdBatId = A.PrdBatId 
			    
				SELECT DISTINCT SlNo INTO #BatchCreation FROM BatchCreation A (NOLOCK)
				INNER JOIN (SELECT MAX(BatchseqId)  as BatchseqId FROM BatchCreationMaster (NOLOCK))X
				ON A.BatchSeqId=X.BatchSeqId
			
			    INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PriceCode,NewBatchId,Slno,PrdBatDetailValue,NewPriceId) 
				SELECT DISTINCT A.PrdId,A.PrdBatId,A.PriceId,A.PriceCode,B.PrdBatId AS NewBatchId,PBD.Slno,PrdBatDetailValue,
				DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,B.PrdBatId)+ @OldPriceId AS NewPriceId 
				FROM @ContractBatchPrice A INNER JOIN @ProductBatchPriceWithCounter B 
				ON A.PrdId = B.PrdId
				INNER JOIN ProductBatchDetails PBD WITH(NOLOCK) ON PBD.PrdBatId=A.PrdBatId and PBD.PriceId=A.PriceId 
				INNER JOIN #BatchCreation C WITH(NOLOCK) ON C.SlNo=PBD.Slno
				ORDER BY A.PrdId,A.PrdBatId,A.PriceId,B.PrdBatId
															            
				IF(SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4
				BEGIN
					INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,
				    PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,
					1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) 
					FROM @ProductBatchDetails
					
					UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1
					
					UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2
					
					UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4 
				END
				ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
				BEGIN
					INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,
					PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,
					1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) 
                    FROM @ProductBatchDetails
                    UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1
					
					UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2
					
					UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4
					
					UPDATE A SET A.PrdBatDetailValue = B.AddRate1 FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B
					WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 5
					
				END	
				    IF EXISTS (SELECT * FROM @ProductBatchDetails)
				    BEGIN
						INSERT INTO ContractPricingDetails(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,
						Availability,LastModBy,LastModDate,AuthId,AuthDate,CtgValMainId)
						SELECT DISTINCT ContractId,A.PrdId,NewBatchId,NewPriceId,Discount,FlatAmtDisc,
						Availability,LastModBy,GETDATE(),AuthId,GETDATE(),CtgValMainId
						FROM ContractPricingDetails	A,@ProductBatchDetails B WHERE A.PrdId = B.PrdId 
						AND A.PrdBatId = B.PrdBatId	AND A.PriceId = B.PriceId
					END	
						UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails) 
						WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'				 
			END
		END
	END
	SELECT @NewPriceId=CurrValue FROM Counters (NOLOCK)	WHERE TabName='ProductBatchDetails' AND FldName='PriceId' 		
	IF @NewPriceId>@OldPriceId
	BEGIN
		IF EXISTS(SELECT * FROM Configuration(NOLOCK) WHERE ModuleId='BotreeRateForOldBatch'
		AND ModuleName='Botree Product Batch Download' AND Status=1)
		BEGIN
			EXEC Proc_DefaultPriceUpdation @ExistPrdBatMaxId,@OldPriceId,1
		END
	END
	IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@OldPriceId)
	BEGIN
		EXEC Proc_DefaultPriceHistory 0,0,@OldPriceId,2,1
	END
	UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y' 
	WHERE PrdCCode+'~'+PrdBatCode IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode
	FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)
	
	RETURN		
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND name='Proc_ValidateBatchWithEeffectiveDate')
DROP PROCEDURE Proc_ValidateBatchWithEeffectiveDate
GO
/* 
   BEGIN TRANSACTION
   SELECT COUNT(*) FROM ProductBatch
   SELECT COUNT(*) FROM Productbatchdetails
   EXEC Proc_ValidateBatchWithEeffectiveDate
   SELECT * FROM ProductBatchEeffectiveDate
     SELECT COUNT(*) FROM ProductBatch
   SELECT COUNT(*) FROM Productbatchdetails
   --SELECT * FROM Errorlog
   ----SELECT * FROM ProductBatchDetails(nolock) WHERE PrdBatId IN (SELECT PrdBatid FROM ProductBatch(Nolock) 
   ----WHERE PrdBatCode IN('YY13333360'))order By priceid
   ----SELECT * FROM DefaultPriceHistory WHERE PrdBatId IN (SELECT PrdBatId FROM ProductBatch 
   ----WHERE PrdBatCode IN('YY13333360'))order By priceid
   ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_ValidateBatchWithEeffectiveDate]
AS
/*********************************
* PROCEDURE		: Proc_ValidateBatchWithEeffectiveDate
* PURPOSE		: To Insert and Update records in the Tables ProductBatch and ProductBatchDetails
* CREATED BY	: Murugan.R
* CREATED DATE	: 2013-09-01
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	
	BEGIN TRY	
	DELETE FROM ProductBatchEeffectiveDate WHERE UpdateFlag='Y'
	
	IF NOT EXISTS(	SELECT DISTINCT  PrdCCode FROM  ProductBatchEeffectiveDate WHERE UpdateFlag='N'
	AND EffectiveDate<=CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121))
	BEGIN
		RETURN
	END
	
	DECLARE @Prdbatid AS NUMERIC(36,0)
	DECLARE @PriceId AS NUMERIC(36,0)
	DECLARE @BatSeqId AS INT
	
	SELECT @Prdbatid=ISNULL(MAX(PrdbatId),0) FROM ProductBatch (NOLOCK)
	SELECT @PriceId=ISNULL(MAX(PriceId),0) FROM Productbatchdetails (NOLOCK)
	SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)
	
	CREATE TABLE #ProductBatchEeffectiveDate(
	[PrdCCode] [nvarchar](200) COLLATE DATABASE_DEFAULT NULL ,
	[PrdBatCode] [nvarchar](200)   COLLATE DATABASE_DEFAULT NULL,
	[ManufacturingDate] [datetime] NULL,
	[ExpiryDate] [datetime] NULL,
	[EffectiveDate] [datetime] NULL,
	[MRP] [numeric](38, 6) NULL,
	[ListPrice] [numeric](38, 6) NULL,
	[SellingRate] [numeric](38, 6) NULL,
	[ClaimRate] [numeric](38, 6) NULL,
	[AddRate1] [numeric](38, 6) NULL,
	[AddRate2] [numeric](38, 6) NULL,
	[AddRate3] [numeric](38, 6) NULL,
	[AddRate4] [numeric](38, 6) NULL,
	[AddRate5] [numeric](38, 6) NULL,
	[AddRate6] [numeric](38, 6) NULL	
	)
	CREATE TABLE #PrdBatToAvoid
	(
		PrdCCode NVARCHAR(200)  COLLATE DATABASE_DEFAULT,
		PrdBatCode NVARCHAR(200)  COLLATE DATABASE_DEFAULT,
		ErrorID	TinyInt
	)
	INSERT INTO #ProductBatchEeffectiveDate(PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,
	AddRate5,AddRate6)
	SELECT DISTINCT  PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,
	AddRate5,AddRate6 FROM  ProductBatchEeffectiveDate WHERE UpdateFlag='N'
	AND EffectiveDate<=CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)
	
	--Product  Code Validation
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'ProductBatchEeffectiveDate','PrdCCode',Prdccode+ ' : Product Code does not exists' FROM #ProductBatchEeffectiveDate PE
	WHERE NOT EXISTS(SELECT P.PrdCCode FROM Product P (NOLOCK) WHERE P.PrdCCode=PE.Prdccode)
	
	INSERT INTO #PrdBatToAvoid(PrdCCode,PrdBatCode,ErrorID)
	SELECT Prdccode,'',1 FROM #ProductBatchEeffectiveDate PE
	WHERE NOT EXISTS(SELECT P.PrdCCode FROM Product P (NOLOCK) WHERE P.PrdCCode=PE.Prdccode)
	
	DELETE A FROM #ProductBatchEeffectiveDate A INNER JOIN #PrdBatToAvoid B ON A.Prdccode=B.Prdccode
	
	--Mandatory Field Validation
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 2,'ProductBatchEeffectiveDate','SellingRate,PrdBatCode','Mandatory field con not be empty' 
	FROM #ProductBatchEeffectiveDate WHERE (LEN(LTRIM(RTRIM(PrdBatCode)))=0 OR SellingRate<0)
	
	
	INSERT INTO #PrdBatToAvoid(PrdCCode,PrdBatCode,ErrorID)
	SELECT Prdccode,'',2 
	FROM #ProductBatchEeffectiveDate WHERE (LEN(LTRIM(RTRIM(PrdBatCode)))=0 OR SellingRate<0)
	
	DELETE A FROM #ProductBatchEeffectiveDate A INNER JOIN #PrdBatToAvoid B ON A.Prdccode=B.Prdccode
	
	
	--Product batch code and Price Validation
	SELECT DISTINCT P.PrdCCode,PrdBatCode,ISNULL(SUM(MRP+ListPrice+SellRate+ClaimRate),0) as PriceValue
	INTO #ProductBatch
	FROM(
	SELECT P.Prdid,P.PrdBatCode ,PrdBatDetailValue as MRP,0 as ListPrice,0 as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and MRP=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,PrdBatDetailValue as ListPrice,0 as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and ListPrice=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,0 as ListPrice,PrdBatDetailValue as SellRate,0 as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and SelRte=1
	UNION ALL
	SELECT P.Prdid,P.PrdBatCode ,0 as MRP,0 as ListPrice,0 as SellRate,PrdBatDetailValue as ClaimRate  
	FROM Productbatch P INNER JOIN Batchcreation B ON P.BatchSeqId=B.BatchSeqId
	INNER JOIN ProductBatchDetails PBD ON PBD.PrdBatId=P.PrdBatId
	and PBD.SLNo=B.SlNo WHERE DefaultPrice=1 and ClmRte=1) X
	INNER JOIN Product P ON X.PrdId=P.PrdId
	GROUP BY PrdBatCode ,P.PrdCCode
	
	SELECT DISTINCT PE.Prdccode,PE.PrdBatCode,
	(MRP+ListPrice+SellingRate+ClaimRate)-(PriceValue) as PriceValue
	INTO #Removebatch
	FROM #ProductBatchEeffectiveDate PE
	INNER JOIN #ProductBatch P ON PE.PrdCCode=P.PrdCCode AND PE.PrdBatCode =P.PrdBatCode
	

	--EXISTING BATCH VALIDATION
	SELECT DISTINCT PrdId,PrdbatId INTO #StockLedger FROM StockLedger (NOLOCK)
	
	--TRANSACTION EXISTS BATCH
	UPDATE PB SET MnfDate=ManufacturingDate,ExpDate= ExpiryDate
	FROM #ProductBatchEeffectiveDate P 
	INNER JOIN 	ProductBatch PB ON PB.PrdBatCode=P.PrdBatCode
	INNER JOIN  Product PC ON P.PrdCCode=PC.PrdCCode and PC.Prdid=PB.PrdId
	INNER JOIN #StockLedger D ON PC.Prdid=D.PrdId and PB.PrdBatId=D.PrdBatId and PB.PrdId=D.PrdId
	
	---UPDATE PRODUCTBATCH TABLE WITH OUT TRANSACTION
	UPDATE PB SET MnfDate=ManufacturingDate,ExpDate= ExpiryDate,	
	PrdBatCode=P.PrdBatCode,CmpBatCode=P.PrdBatCode,TaxGroupId=PC.TaxGroupId,
	Status=1,BatchSeqId=@BatSeqId
	FROM #ProductBatchEeffectiveDate P 
	INNER JOIN 	ProductBatch PB ON PB.PrdBatCode=P.PrdBatCode
	INNER JOIN  Product PC ON P.PrdCCode=PC.PrdCCode and PC.Prdid=PB.PrdId
	WHERE NOT EXISTS (SELECT Prdid,Prdbatid  FROM #StockLedger D 
	WHERE PC.Prdid=D.PrdId and PB.PrdBatId=D.PrdBatId and PB.PrdId=D.PrdId)
	

	
	UPDATE C SET UpdateFlag='Y' FROM ProductBatchEeffectiveDate C 
	INNER JOIN #ProductBatchEeffectiveDate A ON A.Prdccode=C.Prdccode
	and A.PrdBatCode=C.PrdBatCode
	INNER JOIN  #Removebatch B ON A.Prdccode=B.Prdccode
	and A.PrdBatCode=B.PrdBatCode  AND 
	C.Prdccode=B.Prdccode
	and C.PrdBatCode=B.PrdBatCode
	WHERE PriceValue Between -0.05 and 0.05
	
	--DELETE THE BATCH WITH SAME PRICE VALUE
	DELETE A FROM #ProductBatchEeffectiveDate A INNER JOIN  #Removebatch B ON A.Prdccode=B.Prdccode
	and A.PrdBatCode=B.PrdBatCode WHERE PriceValue Between -0.05 and 0.05

	IF NOT EXISTS(SELECT * FROM #ProductBatchEeffectiveDate)
		BEGIN
			RETURN
		END
	
	INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,
	Status,TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,
	LastModBy,LastModDate,AuthId,AuthDate)
	SELECT DISTINCT P.Prdid,@Prdbatid+ROW_NUMBER() OVER(Order by PE.Prdccode,PE.PrdBatCode,SellingRate),
	PrdBatCode,PrdBatCode,ManufacturingDate,ExpiryDate,1,P.TaxGroupId,@BatSeqId,
	6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)	
	FROM #ProductBatchEeffectiveDate PE 
	INNER JOIN Product P ON PE.PrdCCode=P.PrdCCode
	WHERE NOT EXISTS(SELECT Prdccode,PrdbatCode FROM #ProductBatch A WHERE A.PrdCCode=PE.PrdCCode and A.PrdBatCode=Pe.PrdBatCode)
	
	
	SELECT DISTINCT PE.Prdccode,PE.PrdBatCode,P.Prdid,@PriceId+ROW_NUMBER() OVER(Order by PE.Prdccode,PE.PrdBatCode,SellingRate) as PriceId,
	Prdbatid,PE.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
	CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,
	@BatSeqId as BatSeqId,
	1 as DefaultPrice,1 as PriceStatus,1 as Availability,1 as LastModBy,CONVERT(NVARCHAR(10),GETDATE(),121) as LastModDate,
	1 as AuthId,CONVERT(NVARCHAR(10),GETDATE(),121) AuthDate,
	[MRP],[ListPrice],[SellingRate],[ClaimRate],[AddRate1]
	INTO #ProductbatchDetails
	FROM   #ProductBatchEeffectiveDate PE 
	INNER JOIN Product P ON PE.PrdCCode=P.PrdCCode
	INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId and PB.PrdBatCode=PE.PrdBatCode
	
	IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,1,MRP,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,2,ListPrice,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,3,SellingRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,4,ClaimRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
	END
	ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,1,MRP,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,2,ListPrice,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,3,SellingRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,4,ClaimRate,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
		UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,BatSeqId,5,AddRate1,DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate FROM #ProductbatchDetails
	END
	
		
	
		SELECT MAX(PriceId) as PriceId,PrdbatId,PrdId INTO #TempPrice FROM #ProductbatchDetails GROUP BY PrdbatId,PrdId
			
		UPDATE A SET DefaultPriceId=C.PriceId FROM ProductBatch A INNER JOIN #TempPrice C ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId

		UPDATE A SET DefaultPrice=0	FROM ProductBatchDetails A		
		INNER JOIN #TempPrice B ON B.PrdbatiD=A.prdbatid and A.PriceId<>B.PriceId	
				
		UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN
		(
			SELECT PrdBatId FROM ProductBatchDetails GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)
		)
		
		Update Counters Set CurrValue=(SELECT MAX(PrdbatiD) FROM ProductBatch (NOLOCK)) WHERE TabName='ProductBatch' and FldName='PrdBatId'
		Update Counters Set CurrValue=(SELECT MAX(PriceId) FROM ProductBatchdetails  (NOLOCK)) WHERE TabName='ProductBatchDetails' and FldName='PriceId'

	IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@PriceId)
	BEGIN
		EXEC Proc_DefaultPriceHistory 0,0,@PriceId,2,1
	END
	
	
	UPDATE ProductBatchEeffectiveDate SET UpdateFlag='Y' 
	FROM ProductBatchEeffectiveDate A INNER JOIN #ProductbatchDetails B
	ON A.PrdBatCode=B.PrdBatCode and A.PrdCCode=B.PrdCCode
	
		
	END TRY
	BEGIN CATCH		
		Select ERROR_MESSAGE()
	END CATCH	
	RETURN		
	
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' and Name='Proc_Cn2Cs_SpecialDiscount')
DROP PROCEDURE Proc_Cn2Cs_SpecialDiscount
GO
--EXEC Proc_Cn2Cs_SpecialDiscount 0
CREATE PROCEDURE Proc_Cn2Cs_SpecialDiscount
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SpecialDiscount
* PURPOSE		: To insert SpecialRateDetails in Productbatchdetails table
* CREATED		:  Muthukrishnan.G.P
* CREATED DATE	:  31-12-2012
* MODIFIED      :   
* DATE AUTHOR   : DESCRIPTION
------------------------------------------------
* {date}		{developer}		{brief modification description}
* 2013-03-01	Vijendra Kumar	CR(PM)-CCRSTPVM0001
*********************************/
SET NOCOUNT ON
BEGIN
	
	DECLARE @RtrHierLevelCode 		AS  NVARCHAR(100)
	DECLARE @RtrHierLevelValueCode 	AS  NVARCHAR(100)
	DECLARE @RtrCode				AS 	NVARCHAR(100)
	
	DECLARE @PrdCCode				AS 	NVARCHAR(100)
	DECLARE @PrdBatCode				AS 	NVARCHAR(100)
	DECLARE @PrdBatCodeAll			AS 	NVARCHAR(100)
	DECLARE @PriceCode				AS 	NVARCHAR(4000)
	DECLARE @Disperc                AS 	NUMERIC(38,6)
	DECLARE @SplRate				AS 	NUMERIC(38,6)
	DECLARE @PrdCtgValMainId		AS	INT
	DECLARE @CtgLevelId				AS 	INT
	DECLARE @CtgMainId				AS 	INT
	DECLARE @RtrId 					AS 	INT
	DECLARE @PrdId 					AS 	INT
	DECLARE @PrdBatId				AS 	INT
	DECLARE @PriceId				AS 	INT
	DECLARE @ContractReq			AS 	INT
	DECLARE @SRReCalc				AS 	INT
	DECLARE @ReCalculatedSR			AS 	NUMERIC(38,6)
	DECLARE @EffFromDate			AS 	DATETIME
	DECLARE @EffToDate				AS 	DATETIME
	DECLARE @CreatedDate			AS 	DATETIME
	
	DECLARE @MulTaxGrp				AS 	INT
	DECLARE @TaxGroupId				AS	INT
	DECLARE @MulRtrId				AS	INT
	DECLARE @MulTaxGroupId			AS 	INT
	DECLARE @DownldSplRate			AS 	NUMERIC(38,6)
	DECLARE @ContHistExist			AS	INT
	DECLARE @ContractPriceIds		AS	NVARCHAR(1000)
	DECLARE @RefPriceId				AS	INT
	DECLARE @CmpId					AS	INT
	DECLARE @CmpPrdCtgId			AS	INT
	DECLARE @RefRtrId				AS	INT
	DECLARE @ErrStatus				AS	INT
	DECLARE @RtrTaxGrp AS INT
	SET @Po_ErrNo=0
	SET @ErrStatus=0
	SET @RtrTaxGrp=0
	
	EXEC Proc_CalculateSpecialDiscountAftRate
	
    SET @ContractReq=1
	SET @SRReCalc=2
	
    TRUNCATE TABLE ETL_Prk_BLContractPricing	

	CREATE TABLE #SpecialRateToAvoid
	(
		Slno				BIGINT,
		RtrHierLevel		NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		RtrHierValue		NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		RtrCode				NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		PrdCCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		PrdBatCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		EffectiveFromDate	DATETIME
	)
	
		
		SELECT DISTINCT  CtgCode INTO #RetailerCategory FROM RetailerCategory RC 
		INNER JOIN RetailerValueClass RVC ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerValueClassMap RCM ON RCM.RtrValueClassId=RVC.RtrClassId
		
		---Retailer Class Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT T.SlNo,CtgLevelName,T.CtgCode,RtrCode,PrdCCode,PrdBatCode,T.EffectiveFromDate
		FROM TempSpecialRateDiscountProduct T
		WHERE NOT EXISTS(SELECT CtgCode FROM #RetailerCategory R WHERE R.CtgCode=T.CtgCode)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer','Retailer Not Attached to Category:'+RtrHierLevel+' Not Available' FROM #SpecialRateToAvoid
		
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno
		

		---Retailer Category Level Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer Category Level','Retailer Category Level:'+CtgLevelName+' Not Available' FROM TempSpecialRateDiscountProduct
		WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)
		
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno
		----

		---Retailer Category Code Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer Category Level Value','Retailer Category Level Value:'+CtgCode+' Not Available' FROM TempSpecialRateDiscountProduct
		WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)
		
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno
		---

		--Eeffective From Date Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE EffectiveFromDate>GETDATE()
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Effective From Date','Effective Date :'+CAST(EffectiveFromDate AS NVARCHAR(12))+' is greater ' 
		FROM TempSpecialRateDiscountProduct
		WHERE EffectiveFromDate>GETDATE()

		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno
		-- 
		IF NOT EXISTS(SELECT * FROM TempSpecialRateDiscountProduct)
		BEGIN
			RETURN
		END
		
		SELECT @CmpId=ISNULL(CmpId,0) FROM Company C WHERE DefaultCompany=1
		Select @RtrTaxGrp=MIN(Distinct RtriD) FROM TaxSettingMaster (NOLOCK)
		
		SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,
		RtrCode,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,
		ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,
		ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,'2013-12-31') as EffToDate,
		ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,
		ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,
		Prdbatid,PCV.PrdCtgValMainId,CmpPrdCtgId
		INTO #SplPriceDetails
		FROM TempSpecialRateDiscountProduct Prk 
		INNER JOIN Product P ON Prk.PrdCCode=P.PrdCCode 
		INNER JOIN Productbatch PB ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode
		INNER JOIN ProductCategoryValue PCV ON P.PrdCtgValMainId=PCV.PrdCtgValMainId
		INNER JOIN RetailerCategoryLevel RCL ON Prk.CtgLevelName=RCL.CtgLevelName 
		INNER JOIN RetailerCategory RC ON Prk.CtgCode=RC.CtgCode	
		WHERE  Prk.EffectiveFromDate<=GETDATE()	
	
		---Tax Calculation
		DECLARE @PrdIdTax as BIGINT
		DECLARE @PrdbatIdTax AS BIGINT
		DECLARE Cur_Tax CURSOR
		FOR 
		SELECT DISTINCT PrdId,PrdbatId FROM #SplPriceDetails		
		OPEN Cur_Tax	
		FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax
		WHILE @@FETCH_STATUS=0
		BEGIN	
				EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax
		FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax		
		END		
		CLOSE Cur_Tax
		DEALLOCATE Cur_Tax	
	
		DECLARE @MaxPriceId as BIGINT
		SELECT @MaxPriceId=ISNULL(MAX(PriceId),0) from ProductBatchDetails
	
		SELECT A.*,CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSellRate
		,@MaxPriceId+ROW_NUMBER() OVER(Order by A.PrdId,A.PrdBatId,CtgLevelId,CtgMainId,PrdCtgValMainId,CmpPrdCtgId)
		as NewPriceId
		INTO #PriceMaster
		FROM #SplPriceDetails A INNER JOIN ProductBatchTaxPercent B ON A.PrdId=B.PrdId
		AND A.PrdBatId=b.PrdBatId
	
		SELECT PrdbatId,MAX(PriceId) as PriceId 
		INTO #ProductbatchDetails 
		FROM ProductBatchDetails GROUP BY PrdbatId
	
		INSERT INTO ProductBatchDetails(
		PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
		Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
		SELECT DISTINCT 
		NewPriceId,A.PrdBatId,PrdBatCode+'-Spl Rate-'+CAST(NewSellRate AS NVARCHAR(100))
						+CAST(GETDATE() AS NVARCHAR(20)) ,
		
		D.BatchSeqId,D.SlNo,
				(CASE BC.SelRte WHEN 1 THEN NewSellRate ELSE D.PrdBatDetailValue END) AS SelRte,
				0,1,1,1,GETDATE(),1,GETDATE(),0 
		FROM #PriceMaster A 
		INNER JOIN #ProductbatchDetails B ON A.PrdBatId=B.PrdBatId
		INNER JOIN ProductBatchDetails D ON D.PrdBatId=A.PrdBatId and D.PrdBatId=B.PrdBatId and D.PriceId=B.PriceId
		INNER JOIN BatchCreation BC ON BC.BatchSeqId=D.BatchSeqId AND D.SlNo=BC.SlNo
		INNER JOIN ProductBatch C ON C.PrdBatId=A.PrdBatId and C.PrdBatId=B.PrdBatId and C.PrdId=A.PRdId
		and D.PrdBatId=C.PrdBatId
		ORder by NewPriceId,A.PrdBatId,D.SlNo

		
		UPDATE Counters SET CurrValue=(SELECT ISNULL(Max(PriceId),0) FROM ProductBatchDetails) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'
		UPDATE A SET EnableCloning=1 FROM ProductBatch A
		INNER JOIN #PriceMaster B ON B.Prdbatid=A.PrdbatId
		
		--Contract Price Praking Table insert
		INSERT INTO Cn2Cs_Prk_ContractPricing(CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,PrdCtgValMainId,
		RtrId,PrdId,PrdBatId,PriceId,DiscountPerc,FlatAmount,EffectiveDate,ToDate,CreatedDate,RtrTaxGroupId)
		SELECT DISTINCT @CmpId,CtgLevelId,CtgMainId,0,0,0,CASE WHEN RtrCode='ALL' THEN '0' ELSE ISNULL(RtrCode,'') END,
		Prdid,Prdbatid,NewPriceId,0,0,EffFromDate,EffToDate,CreatedDate,@RtrTaxGrp
		FROM #PriceMaster
		
		---Special Rate Screen Table Insert and Update
		INSERT INTO SpecialRateAftDownLoad(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,
		SplSelRate,FromDate,CreatedDate,DownloadedDate,ContractPriceIds,DiscountPerc)		
		SELECT DISTINCT RtrHierLevelCode,RtrHierLevelValueCode,
		RtrCode
		,PrdCCode,PrdBatCodeAll,
		SplRate,EffFromDate,CreatedDate,GETDATE(),'-'+CAST(NewPriceId AS NVARCHAR(10))+'-',Disperc 
		FROM #PriceMaster A
		WHERE NOT EXISTS(		
			SELECT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode, FromDate 
			FROM 
			SpecialRateAftDownLoad B WHERE B.RtrCtgCode=A.RtrHierLevelCode
			and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
			And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll
			and FromDate<=EffFromDate and B.SplSelRate=A.SplRate
						)
		
		UPDATE B  SET SplSelRate=SplRate,ContractPriceIds='-'+CAST(NewPriceId AS NVARCHAR(10))+'-',DiscountPerc=Disperc
		FROM #PriceMaster A INNER JOIN SpecialRateAftDownLoad B ON 
		B.RtrCtgCode=A.RtrHierLevelCode
		and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
		And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll
		WHERE  FromDate<=EffFromDate
		---
	
	
		EXEC Proc_Validate_ContractPricing @Po_ErrNo=@ErrStatus
		SET @Po_ErrNo=@ErrStatus
	
		IF @Po_ErrNo=0
		BEGIN	
			UPDATE Cn2Cs_Prk_SpecialDiscount SET DownLoadFlag='Y' 
			WHERE RetCategoryLevel+'~'+RetCatLevelValue+'~'+CAST(EffFromDate AS NVARCHAR(50)) 
			NOT IN(SELECT RtrHierLevel+'~'+RtrHierValue+'~'+CAST(EffectiveFromDate AS NVARCHAR(50)) FROM #SpecialRateToAvoid)
		END
		RETURN
END
GO
DELETE FROM DependencyTable WHERE RelatedTable = 'DeliveryBoyClaimMaster' AND PrimaryTable = 'DeliveryBoy'
DELETE FROM DependencyTable WHERE RelatedTable = 'SchemeMaster' AND PrimaryTable = 'ProductCategoryLevel'
DELETE FROM DependencyTable WHERE RelatedTable = 'TargetAnalysisDt' AND PrimaryTable = 'RouteMaster'
DELETE FROM DependencyTable WHERE RelatedTable = 'TargetAnalysisDt' AND PrimaryTable = 'Retailer'
DELETE FROM DependencyTable WHERE RelatedTable = 'SalInvDbNoteAdj' AND PrimaryTable = 'CreditNoteRetailer'
DELETE FROM DependencyTable WHERE RelatedTable = 'TaxSetting' AND PrimaryTable = 'TaxConfiguration'
DELETE FROM DependencyTable where PrimaryTable='OrderBooking' and RelatedTable='SalesInvoiceOrderBooking' and FieldName='OrderNo'
INSERT INTO DependencyTable(PrimaryTable,RelatedTable,FieldName)VALUES('OrderBooking','SalesInvoiceOrderBooking','OrderNo')
GO
DELETE FROM HotSearchEditorHd WHERE FormId='10014' AND ControlName='Reference No'
INSERT INTO HotSearchEditorHd(FormId,FormName,ControlName,SltString,RemainsltString) VALUES('10014','Loyalty Program','Reference No','select','SELECT LoyalRefNo,LoyalDesc FROM LoyaltyHeader (NOLOCK)')
GO
DELETE FROM Menudef WHERE MenuId='mPrd11' AND MENUNAME='mnuProductBatch'
INSERT INTO Menudef([SrlNo],[MenuId],[MenuName],[ParentId],[Caption],[MenuStatus],[FormName],[DefaultCaption]) VALUES (177,'mPrd11','mnuProductBatch','mPrd','Product Batch',0,'frmProductBatch','Product Batch')
GO
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='0'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','0','New','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='1'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','1','Edit','0','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='2'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','2','Save','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='3'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','3','Delete','0','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='4'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','4','Cancel','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='5'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','5','Print','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='2' AND MenuId='mPrd11' AND BtnIndex='6'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('2','MPRD11','6','Exit','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='0'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','0','New','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='1'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','1','Edit','0','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='2'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','2','Save','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='3'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','3','Delete','0','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='4'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','4','Cancel','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='5'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','5','Print','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
DELETE FROM ProfileDt WHERE PrfId='1' AND MenuId='mPrd11' AND BtnIndex='6'
INSERT INTO ProfileDt(PrfId,MenuId,BtnIndex,BtnDescription,BtnStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES
('1','MPRD11','6','Exit','1','1','1','2012-04-24 00:00:00.000','1','2012-04-24 00:00:00.000')
GO
IF EXISTS (SELECT * FROM Syscolumns A WITH (NOLOCK),Sysobjects B WITH (NOLOCK) WHERE A.id = B.id AND B.name = 'IDTMaster' 
AND A.name = 'SpmTinNo' AND B.Xtype = 'U')
BEGIN
   ALTER TABLE IDTMaster ALTER COLUMN SpmTinNo NVARCHAR(100)
END
GO
DELETE FROM Configuration WHERE ModuleId = 'PO4'
INSERT INTO Configuration
SELECT 'PO4','Purchase Order','Manually select products and not auto generate Purchase Order Qty',1,'0',0.00,4
GO
DELETE FROM HotSearchEditorHd WHERE FormId = 213
INSERT INTO HotSearchEditorHd
SELECT 213,'Purchase Order - Product Norm Mapping','Set-UOM','select',
'SELECT UomId,UomCode,UomDescription FROM (SELECT DISTINCT UM.UomId,UM.UomCode,UM.UomDescription
FROM UomMaster UM,UomGroup UG WHERE UM.UomId = UG.UomId) Mainsql'
GO
DELETE FROM Configuration WHERE ModuleId IN ('BILLRTEDIT1','BILLRTEDIT2')
INSERT INTO Configuration
SELECT 'BILLRTEDIT1','BillConfig_RateEdit','Allow Editing of Selling Rate in the billing screen',0,'',0.00,1 UNION
SELECT 'BILLRTEDIT2','BillConfig_RateEdit','Allow Editing of Net Rate in the billing screen',0,'',0.00,2
GO
DELETE FROM Configuration WHERE ModuleId = 'RET38'
INSERT INTO Configuration
SELECT 'RET38','Retailer','Retailer Master Shipping Address should not be mandatory',1,'',0.00,38
GO
DELETE FROM Customcaptions WHERE TransId=79 AND CtrlId=1000 AND SubCtrlId=45
INSERT INTO Customcaptions([TransId],[CtrlId],[SubCtrlId],[CtrlName],[Caption],[PnlMsg],[MsgBox],[LngId],[Availability],[LastModBy],
[LastModDate],[AuthId],[AuthDate],[DefaultCaption],[DefaultPnlMsg],[DefaultMsgBox],[Visibility],[Enabled]) 
VALUES (79,1000,45,'MsgBox-79-1000-45','','','Mobile Number Should be in 10 Digits',1,1,1,GETDATE(),1,GETDATE(),'','',
'Mobile Number Should be in 10 Digits',1,1)
GO
IF NOT EXISTS(SELECT * FROM SYSCOLUMNS A WITH (NOLOCK),SYSOBJECTS B WITH (NOLOCK) WHERE A.ID=B.ID AND B.xtype='U' AND B.NAME='PurchaseReceipt' 
AND A.name = 'DownloadStatus')
BEGIN
	ALTER TABLE PurchaseReceipt ADD DownloadStatus INT DEFAULT 0 WITH Values
END
GO
DELETE FROM HotsearchEditorHD WHERE FormId = 405
INSERT INTO HotsearchEditorHD
SELECT 405,'Purchase Receipt','Invoice.Ref.No','select',
'SELECT DISTINCT PurRcptRefNo,InvDate,PurRcptId,DownloadStatus FROM PurchaseReceipt WITH (NOLOCK)'
GO
--Billing Product Selection Hotsearch Editor
DELETE FROM Configuration WHERE ModuleId IN ('BCD18','GENCONFIG21') 
INSERT INTO Configuration
SELECT 'BCD18','BillConfig_Display','Display total saleable quantity in product hotsearch',1,'',0.00,18 UNION
SELECT 'GENCONFIG21','General Configuration','Display MRP in Product Hot Search Screen',0,'',0.00,21 
GO
DELETE FROM HotsearcheditorHD WHERE FormId = 789
INSERT INTO HotsearcheditorHD
SELECT 789,'Billing','Product [Saleable Qty] without Company','select',
'SELECT PrdId,PrdDCode,PrdCcode,PrdName,PrdShrtName,SaleableQty,PrdSeqDtId,PrdType FROM (SELECT PrdId,PrdSeqDtId,PrdDcode,PrdCcode,PrdName,
PrdShrtName,Sum(SaleableQty)as SaleableQty,PrdType FROM (SELECT DISTINCT A.PrdId,C.PrdSeqDtId,A.PrdDcode,A.PrdCcode,A.PrdName,A.PrdShrtName,
(D.PrdBatLcnSih - D.PrdBatLcnRessih) AS SaleableQty,A.PrdType FROM Product A WITH (NOLOCK),ProductSequence B WITH (NOLOCK),
ProductSeqDetails C WITH (NOLOCK),ProductBatchLocation D WITH (NOLOCK),ProductBatch E WITH (NOLOCK) WHERE B.TransactionId=2 AND A.PrdStatus=1 
AND B.PrdSeqId = C.PrdSeqId  AND A.PrdId = C.PrdId AND A.PrdId=D.PrdId AND (D.PrdBatLcnSih-D.PrdBatLcnResSih)>0 
AND PrdType <> 4  AND D.LcnId=vFParam AND D.PrdBatId = E.PrdBatId AND  E.Status = 1 AND E.PrdId = A.PrdId 
Union  SELECT DISTINCT A.PrdId,100000 AS PrdSeqDtId,A.PrdDcode,A.PrdCcode,A.PrdName,A.PrdShrtName,  
(D.PrdBatLcnSih - D.PrdBatLcnRessih) AS SaleableQty,A.PrdType FROM  Product A WITH (NOLOCK),
ProductBatchLocation D WITH (NOLOCK), ProductBatch E WITH (NOLOCK) WHERE PrdStatus = 1  AND A.PrdId=D.PrdId   
AND  (D.PrdBatLcnSih-D.PrdBatLcnResSih)>0 AND PrdType <> 4 AND D.LcnId=vFParam  AND
A.PrdId NOT IN  (SELECT PrdId FROM ProductSequence B WITH (NOLOCK),   ProductSeqDetails C WITH (NOLOCK)  
WHERE B.TransactionId=2  AND B.PrdSeqId=C.PrdSeqId)   AND D.PrdBatId = E.PrdBatId AND  E.Status = 1  AND E.PrdId = A.PrdId )A    
GROUP BY PrdId,PrdSeqDtId,PrdDcode,PrdCcode,PrdName,PrdShrtName,PrdType ) X ORDER BY PrdSeqDtId'
GO
DELETE FROM HotSearchEditorDt WHERE FormId = 789
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (1,789,'Product [Saleable Qty] without Company','Dist Code','PrdDCode',1500,0,'HotSch-2-2000-92',2)
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (2,789,'Product [Saleable Qty] without Company','Comp Code','PrdCcode',1500,0,'HotSch-2-2000-93',2)
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (3,789,'Product [Saleable Qty] without Company','Name','PrdName',1500,0,'HotSch-2-2000-94',2)
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (4,789,'Product [Saleable Qty] without Company','Short Name','PrdShrtName',2500,0,'HotSch-2-2000-95',2)
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (5,789,'Product [Saleable Qty] without Company','Saleable Qty','SaleableQty',2000,0,'HotSch-2-2000-133',2)
INSERT INTO HotsearcheditorDt([Slno],[FormId],[FieldName],[AliasName],[SrchFieldNm],[Colwidth],[SortedType],[HotSearchName],[TransId]) 
VALUES (6,789,'Product [Saleable Qty] without Company','Seq No','PrdSeqDtId',1500,0,'HotSch-2-2000-134',2)
GO
DELETE FROM HotsearcheditorHD WHERE FormId = 56
INSERT INTO HotsearcheditorHD 
SELECT 56,'Batch Transfer','ToBatchSaleable','select',
'SELECT PrdBatId,PrdBatCode,MRP,PurchaseRate,SellingRate,StockAvailable,DefaultPriceId FROM (SELECT PB.PrdBatId,PB.PrdBatCode,
PD1.PrdBatDetailValue AS MRP, PD2.PrdBatDetailValue AS PurchaseRate,PD3.PrdBatDetailValue AS SellingRate,    
(ISNULL(PBL.PrdBatLcnSih,0) - ISNULL(PBL.PrdBatLcnRessih,0) )AS [StockAvailable] ,  PB.DefaultPriceId    
FROM ProductBatch PB,ProductBatchLocation PBL (NOLOCK),ProductbatchDetails PD1 WITH (NOLOCK),  BatchCreation BC1  WITH (NOLOCK),  
ProductbatchDetails PD2 WITH (NOLOCK),BatchCreation BC2 WITH (NOLOCK),
ProductbatchDetails PD3  WITH (NOLOCK),BatchCreation BC3 WITH (NOLOCK)  
WHERE PB.PrdBatId = PBL.PrdBatId   AND PBL.LcnId = vFParam  AND PBL.PrdId = vSParam   
AND PBL.PrdBatId <> vTParam AND PB.Status = 1     AND PB.PrdBatId=PD1.PrdBatId  
AND PD1.DefaultPrice=1  AND PD1.SlNo =BC1.SlNo AND BC1.BatchSeqId=PB.BatchSeqId   AND BC1.MRP=1  
AND PB.PrdBatId=PD2.PrdBatId AND PD2.DefaultPrice=1  AND PD2.SlNo =BC2.SlNo   AND BC2.BatchSeqId=PB.BatchSeqId  
AND BC2.ListPrice=1  AND PB.PrdBatId=PD3.PrdBatId AND PD3.DefaultPrice=1    AND PD3.SlNo =BC3.SlNo  AND BC3.BatchSeqId=PB.BatchSeqId AND BC3.SelRte=1  
UNION ALL 
SELECT PB.PrdBatId,PB.PrdBatCode,PD1.PrdBatDetailValue AS MRP, PD2.PrdBatDetailValue AS PurchaseRate,
PD3.PrdBatDetailValue AS SellingRate,  0  as [StockAvailable],PB.DefaultPriceId  FROM ProductBatch PB,ProductbatchDetails PD1 WITH (NOLOCK),  
BatchCreation BC1 WITH (NOLOCK),ProductbatchDetails PD2 WITH (NOLOCK),BatchCreation BC2 WITH (NOLOCK),ProductbatchDetails PD3 WITH (NOLOCK),
BatchCreation BC3 WITH (NOLOCK) WHERE PB.PrdBatId  NOT IN   (SELECT PrdBatId FROM ProductBAtchLocation 
WHERE LcnId = vFParam AND PrdId = vSParam)    AND PrdId = vSParam AND Status = 1  AND PB.PrdBatId=PD1.PrdBatId AND PD1.DefaultPrice=1  
AND PD1.SlNo =BC1.SlNo    AND BC1.BatchSeqId=PB.BatchSeqId AND BC1.MRP=1  AND PB.PrdBatId=PD2.PrdBatId AND PD2.DefaultPrice=1    
AND PD2.SlNo =BC2.SlNo AND BC2.BatchSeqId=PB.BatchSeqId AND BC2.ListPrice=1  AND PB.PrdBatId=PD3.PrdBatId    
AND PD3.DefaultPrice=1  AND PD3.SlNo =BC3.SlNo AND BC3.BatchSeqId=PB.BatchSeqId AND BC3.SelRte=1) MainSql'
GO
UPDATE ProfileDt SET BtnStatus = 0 WHERE MenuId = 'mCmp2' AND BtnIndex = 3
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE TYPE IN ('TF','FN') AND name='Fn_ReturnPrdBatchDetailsWithStock')
DROP FUNCTION Fn_ReturnPrdBatchDetailsWithStock
GO
CREATE FUNCTION Fn_ReturnPrdBatchDetailsWithStock (@PrdId AS BIGINT,@LcnId	AS	INT,@OrderMode AS INT)
RETURNS @PrdBatchDetailsWithStock TABLE
	(
		PrdId		INT,
		PrdName		Varchar(150),
		PrdCCode	Varchar(50),
		PrdDCode	Varchar(50),
		PrdBatID	INT,
		BatchCode	Varchar(100),
		MRP			NUMERIC(18,6),
		LSP			NUMERIC(18,6),
		SellRate	NUMERIC(18,6),
		StockAvail	NUMERIC(18,0),
		PriceId		INT
	)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnPrdBatchDetailsWithStock
* PURPOSE: Returns the Product details with stock
* NOTES:
* CREATED: Boopathy.P
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*12-09-2013  MOORTHI   MRP =0  CONDITION FAILED 
------------------------------------------------
*
*********************************/
--DATEDIFF(DAY,Convert(Varchar(10),Getdate(),121),DATEADD(Day,PrdShelfLife,A.MnfDate)) as ShelfDay, DATEDIFF(DAY,Convert(Varchar(10),Getdate(),121),A.ExpDate) as ExpiryDay,
	IF @OrderMode=1
	BEGIN
		INSERT INTO @PrdBatchDetailsWithStock
		SELECT @PrdId,G.PrdName,G.PrdCCode,G.PrdDCode,A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue AS MRP, D.PrdBatDetailValue AS PurchaseRate,K.PrdBatDetailValue AS SellRate,
		(F.PrdBatLcnSih - F.PrdBatLcnRessih) as StockAvail, B.PriceId FROM ProductBatch A (NOLOCK) 
		INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1 
		INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1 
		INNER JOIN ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID AND D.DefaultPrice=1 
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1 
		INNER JOIN ProductBatchDetails K (NOLOCK) ON A.PrdBatId = K.PrdBatID AND K.DefaultPrice=1 
		INNER JOIN BatchCreation H (NOLOCK) ON H.BatchSeqId = A.BatchSeqId AND K.SlNo = H.SlNo AND H.SelRte = 1 
		INNER JOIN Product G (NOLOCK) ON G.PrdId = A.PrdId 
		INNER JOIN ProductBatchLocation F (NOLOCK) ON F.PrdBatId = A.PrdBatId WHERE A.Status = 1 
		AND A.PrdId=@PrdId AND F.LcnId = @LcnId And (F.PrdBatLcnSih - F.PrdBatLcnRessih) > 0 -- ORDER BY (F.PrdBatLcnSih - F.PrdBatLcnRessih)DESC
		AND CASE B.PrdBatDetailValue WHEN 0 THEN D.PrdBatDetailValue ELSE B.PrdBatDetailValue END >= D.PrdBatDetailValue ORDER BY (F.PrdBatLcnSih - F.PrdBatLcnRessih)DESC

		--AND B.PrdBatDetailValue >= D.PrdBatDetailValue ORDER BY (F.PrdBatLcnSih - F.PrdBatLcnRessih)DESC
	END
	ELSE
	BEGIN
		INSERT INTO @PrdBatchDetailsWithStock
		SELECT @PrdId,G.PrdName,G.PrdCCode,G.PrdDCode,A.PrdBatID,A.PrdBatCode,B.PrdBatDetailValue AS MRP, D.PrdBatDetailValue AS PurchaseRate,K.PrdBatDetailValue AS SellRate,
		(F.PrdBatLcnSih - F.PrdBatLcnRessih) as StockAvail, B.PriceId FROM ProductBatch A (NOLOCK) 
		INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID AND B.DefaultPrice=1 
		INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = A.BatchSeqId AND B.SlNo = C.SlNo AND C.MRP = 1 
		INNER JOIN ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID AND D.DefaultPrice=1 
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = A.BatchSeqId AND D.SlNo = E.SlNo AND E.ListPrice = 1 
		INNER JOIN ProductBatchDetails K (NOLOCK) ON A.PrdBatId = K.PrdBatID AND K.DefaultPrice=1 
		INNER JOIN BatchCreation H (NOLOCK) ON H.BatchSeqId = A.BatchSeqId AND K.SlNo = H.SlNo AND H.SelRte = 1 
		INNER JOIN Product G (NOLOCK) ON G.PrdId = A.PrdId 
		INNER JOIN ProductBatchLocation F (NOLOCK) ON F.PrdBatId = A.PrdBatId WHERE A.Status = 1 
		AND A.PrdId=@PrdId AND F.LcnId = @LcnId And (F.PrdBatLcnSih - F.PrdBatLcnRessih) > 0 
		AND CASE B.PrdBatDetailValue WHEN 0 THEN D.PrdBatDetailValue ELSE B.PrdBatDetailValue END >= D.PrdBatDetailValue ORDER BY A.PrdBatId DESC
		--AND B.PrdBatDetailValue >= D.PrdBatDetailValue ORDER BY A.PrdBatId DESC
	END
RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE TYPE IN ('TF','FN') AND name='Fn_ReturnTaxCaptionDetails')
DROP FUNCTION Fn_ReturnTaxCaptionDetails
GO
CREATE FUNCTION Fn_ReturnTaxCaptionDetails (@Pi_TaxGroupId AS BIGINT,@Pi_RtrId AS BIGINT,@Pi_TaxGroupValue AS BIGINT)
RETURNS @TaxCaptionDetails TABLE
(
	RowId NVARCHAR(100),
	ColId BIGINT,
	ColName VARCHAR(200),
	RowOrder BIGINT
)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnTaxCaptionDetails
* PURPOSE: Returns the TaxCaptionDetails
* NOTES:
* CREATED: Sathishkumar Veeramani 13/09/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*********************************/
IF @Pi_TaxGroupValue = 1
BEGIN
     INSERT INTO @TaxCaptionDetails(RowId,ColId,ColName,RowOrder)
     SELECT X.* FROM 
     (SELECT Distinct '' RowId,1 AS ColId,'Tax Name' ColName,1 AS RowOrder FROM TaxSettingDetail TSD, TaxConfiguration TC 
     WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) 
     and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in (SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=1 
     Union All 
     SELECT Distinct '' RowId,2 AS ColId,'Tax %' ColName,2 AS RowOrder 
     FROM TaxSettingDetail TSD 
     WHERE TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId = @Pi_TaxGroupId and RtrId=  @Pi_RtrId)) and TSD.ColType=1 and TSD.ColId = 0 
     Union All 
     SELECT 
     Distinct TSD.ColId RowId,3 AS ColId,CASE BSD.Slno WHEN 1 THEN 'MRP' WHEN 2 Then 'Selling Rate' WHEN 3 THEN 'Pur. Rate' ELSE 
     BSD.FieldDesc END ColName,3 AS RowOrder 
     FROM TaxSettingDetail TSD, BillSequenceDetail BSD 
     WHERE BSD.SlNo = TSD.ColId and TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId = @Pi_TaxGroupId and RtrId=  @Pi_RtrId)) and TSD.ColType=2 
     and BSD.BillSeqId in (SELECT Max(BillSeqId) FROM BillSequenceDetail) 
     Union All 
     SELECT Distinct TSD.RowId,6 AS ColId,TC.TaxName ColName,6 AS RowOrder 
     FROM TaxSettingDetail TSD, TaxConfiguration TC 
     WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  )  and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId = @Pi_TaxGroupId and RtrId=  @Pi_RtrId)) and TSD.ColType=3 
     ) X ORDER BY X.RowOrder,X.RowId,X.ColId      
END
ELSE IF @Pi_TaxGroupValue = 3
BEGIN
     INSERT INTO @TaxCaptionDetails(RowId,ColId,ColName,RowOrder)
	 SELECT X.* FROM 
	 (SELECT Distinct '' RowId,1 ColId,'Tax Name' ColName,1 as RowOrder FROM TaxSettingDetail TSD, TaxConfiguration TC 
	 WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) 
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=1 
	 Union All 
	 SELECT Distinct '' RowId,2 ColId,'Tax %' ColName,2 as RowOrder 
	 FROM TaxSettingDetail TSD 
	 WHERE TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=1 and TSD.ColId = 0 
	 Union All SELECT 1 RowId,3 ColId,'MRP' ColName,3 as RowOrder Union All SELECT 2 RowId,4 ColId,'Selling Rate' ColName,4 as RowOrder Union All SELECT 3 RowId,5 ColId,'Pur. Rate' ColName,5 as RowOrder 
	 Union All 
	 SELECT 
	 Distinct TSD.ColId RowId,6 ColId, 
	 BSD.FieldDesc ColName,6 as RowOrder 
	 FROM TaxSettingDetail TSD, PurchaseSequenceDetail BSD 
	 WHERE BSD.SlNo = TSD.ColId and BSD.SlNo not in (1,2) and TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=2 
	 and BSD.PurSeqId in (SELECT Max(PurSeqId) FROM PurchaseSequenceDetail) 
	 Union All 
	 SELECT Distinct TSD.RowId,7 ColId,TC.TaxName ColName,7 as RowOrder 
	 FROM TaxSettingDetail TSD, TaxConfiguration TC 
	 WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  )  and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=3 
	 ) X ORDER BY X.RowOrder,X.RowId,X.ColId     
END
ELSE IF @Pi_TaxGroupValue = 4
BEGIN
     INSERT INTO @TaxCaptionDetails(RowId,ColId,ColName,RowOrder)
     SELECT X.* FROM 
     (SELECT Distinct '' RowId,1 ColId,'Tax Name' ColName,1 as RowOrder FROM TaxSettingDetail TSD, TaxConfiguration TC 
     WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) 
     and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=1 
     Union All 
     SELECT Distinct '' RowId,2 ColId,'Tax %' ColName,2 as RowOrder 
     FROM TaxSettingDetail TSD 
     WHERE TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId  ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=1 and TSD.ColId = 0 
     Union All SELECT 1 RowId,3 ColId,'MRP' ColName,3 as RowOrder Union All SELECT 2 RowId,4 ColId,'Selling Rate' ColName,4 as RowOrder Union All SELECT 3 RowId,5 ColId,'Pur. Rate' ColName,5 as RowOrder 
     Union All 
     SELECT 
     Distinct TSD.ColId RowId,6 ColId, 
     BSD.FieldDesc ColName,6 as RowOrder 
     FROM TaxSettingDetail TSD, IDTSequenceDetail BSD 
     WHERE BSD.SlNo = TSD.ColId and BSD.SlNo not in (1,2,3) and TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId = @Pi_RtrId ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=2 
     and BSD.IDTSeqId in (SELECT Max(IDTSeqId) FROM IDTSequenceDetail) 
     Union All 
     SELECT Distinct TSD.RowId,7 ColId,TC.TaxName ColName,7 as RowOrder 
     FROM TaxSettingDetail TSD, TaxConfiguration TC 
     WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( 
     SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId)  and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId  ) ) and TSD.ColType=3 
     ) X ORDER BY X.RowOrder,X.RowId,X.ColId
END 
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects WHERE TYPE IN ('TF','FN') AND name='Fn_ReturntaxDetails')
DROP FUNCTION Fn_ReturntaxDetails
GO
CREATE FUNCTION Fn_ReturntaxDetails (@Pi_TaxGroupId AS BIGINT,@Pi_RtrId AS BIGINT,@Pi_TaxGroupValue AS BIGINT)
RETURNS @ReturntaxDetails TABLE
(
	RowId NVARCHAR(100),
	ColNo BIGINT,
	ColName VARCHAR(200),
	ColVal VARCHAR(200)
)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnTaxCaptionDetails
* PURPOSE: Returns the TaxDetails
* NOTES:
* CREATED: Sathishkumar Veeramani 13/09/2013
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*********************************/
IF @Pi_TaxGroupValue = 1
BEGIN
     INSERT INTO @ReturntaxDetails(RowId,ColNo,ColName,ColVal)
	 SELECT X.* FROM 
	 (SELECT TSD.RowId,TSD.ColNo,'Tax Name' ColName, TC.TaxName ColVal FROM TaxSettingDetail TSD, TaxConfiguration TC 
	 WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId) 
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId   ) ) and TSD.ColType=1 
	 Union All 
	 SELECT TSD.RowId,TSD.ColNo,'Tax %' ColName, convert(nvarchar,TSD.ColVal ) ColVal 
	 FROM TaxSettingDetail TSD 
	 WHERE TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId   ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId   ) ) and TSD.ColType=1 and TSD.ColId = 0 
	 Union All 
	 SELECT TSD.RowId,TSD.ColNo, 
	 CASE BSD.Slno WHEN 1 THEN 'MRP' WHEN 2 Then 'Selling Rate' WHEN 3 THEN 'Pur. Rate' ELSE 
	 BSD.FieldDesc END ColName , convert(nvarchar,TSD.ColVal ) ColVal 
	 FROM TaxSettingDetail TSD, BillSequenceDetail BSD 
	 WHERE BSD.SlNo = TSD.ColId and TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId   ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId   ) ) and TSD.ColType=2 
	 and BSD.BillSeqId in (SELECT Max(BillSeqId) FROM BillSequenceDetail) 
	 Union All 
	 SELECT TSD.RowId,TSD.ColNo,TC.TaxName ColName, convert(nvarchar,TSD.ColVal ) ColVal 
	 FROM TaxSettingDetail TSD, TaxConfiguration TC 
	 WHERE TC.TaxId = TSD.ColId and TSD.TaxSeqId in ( 
	 SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId   )  and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId   ) ) and TSD.ColType=3 
	 ) X ORDER BY X.Rowid,X.Colno      
END
ELSE IF @Pi_TaxGroupValue = 3
BEGIN
     INSERT INTO @ReturntaxDetails(RowId,ColNo,ColName,ColVal)
	 SELECT X.* FROM  ( SELECT TSD.RowId,TSD.ColNo,'Tax Name' ColName, TC.TaxName ColVal 
	 FROM TaxSettingDetail TSD, TaxConfiguration TC  WHERE TC.TaxId = TSD.ColId
	 and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    )
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail 
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) ) 
	 and TSD.ColType=1   Union All   SELECT TSD.RowId,TSD.ColNo,'Tax %' ColName, convert(nvarchar,TSD.ColVal ) ColVal
	 FROM TaxSettingDetail TSD  WHERE TSD.TaxSeqId in (  SELECT Max(TaxSeqid) FROM TaxSettingMaster
	 WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) )
	 and TSD.ColType=1 and TSD.ColId = 0  Union All SELECT TSD.RowId,TSD.ColNo,
	 CASE BSD.Slno WHEN 1 THEN 'MRP' WHEN 2 Then 'Selling Rate' WHEN 3 THEN 'Pur. Rate' ELSE  BSD.FieldDesc END ColName ,
	 convert(nvarchar,TSD.ColVal ) ColVal  FROM TaxSettingDetail TSD,
	 (SELECT PurSeqId ,SlNo,FieldDesc FROM(  SELECT PurSeqId ,SlNo,FieldDesc FROM PurchaseSequenceDetail where PurSeqId in (SELECT Max(PurSeqId) FROM PurchaseSequenceDetail) and Slno Not in(1,2)
	 Union All  select BillSeqId as PurSeqId ,Slno,FieldDesc from BillSequenceDetail WHERE  BillSeqId in (SELECT Max(BillSeqId) FROM BillSequenceDetail) and Slno  in(1,2,3) )as  X )BSD 
	 WHERE BSD.SlNo = TSD.ColId and TSD.TaxSeqId in (  SELECT Max(TaxSeqId) FROM TaxSettingMaster
	 WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  
	 and RtrId=  @Pi_RtrId    ) ) and TSD.ColType=2 
	 Union All  SELECT TSD.RowId,TSD.ColNo,TC.TaxName ColName, convert(nvarchar,TSD.ColVal ) ColVal
	 FROM TaxSettingDetail TSD, TaxConfiguration TC  WHERE TC.TaxId = TSD.ColId
	 and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    )
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) ) 
	 and TSD.ColType=3  ) X ORDER BY X.Rowid,X.Colno    
END
ELSE IF @Pi_TaxGroupValue = 4
BEGIN
     INSERT INTO @ReturntaxDetails(RowId,ColNo,ColName,ColVal)
	 SELECT DISTINCT X.* FROM  (  SELECT TSD.RowId,TSD.ColNo,'Tax Name' ColName, TC.TaxName ColVal 
	 FROM TaxSettingDetail TSD, TaxConfiguration TC  WHERE TC.TaxId = TSD.ColId
	 and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    )
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail 
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) ) 
	 and TSD.ColType=1   Union All   SELECT TSD.RowId,TSD.ColNo,'Tax %' ColName, convert(nvarchar,TSD.ColVal ) ColVal
	 FROM TaxSettingDetail TSD  WHERE TSD.TaxSeqId in (  SELECT Max(TaxSeqid) FROM TaxSettingMaster
	 WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) )
	 and TSD.ColType=1 and TSD.ColId = 0  Union All SELECT TSD.RowId,TSD.ColNo,
	 CASE BSD.Slno WHEN 1 THEN 'MRP' WHEN 2 Then 'Selling Rate' WHEN 3 THEN 'Pur. Rate' ELSE  BSD.FieldDesc END ColName ,
	 convert(nvarchar,TSD.ColVal ) ColVal  FROM TaxSettingDetail TSD,
	 (SELECT IDTSeqId ,SlNo,FieldDesc FROM(  SELECT IDTSeqId ,SlNo,FieldDesc FROM IDTSequenceDetail where IDTSeqId in (SELECT Max(IDTSeqId) FROM IDTSequenceDetail) and Slno Not in(1,2)
	 Union All  select BillSeqId as PurSeqId ,Slno,FieldDesc from BillSequenceDetail WHERE  BillSeqId in (SELECT Max(BillSeqId) FROM BillSequenceDetail) and Slno  in(1,2,3) )as  X )BSD 
	 WHERE BSD.SlNo = TSD.ColId and TSD.TaxSeqId in (  SELECT Max(TaxSeqId) FROM TaxSettingMaster
	 WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    ) and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  
	 and RtrId=  @Pi_RtrId)) and TSD.ColType=2 
	 Union All  SELECT TSD.RowId,TSD.ColNo,TC.TaxName ColName, convert(nvarchar,TSD.ColVal ) ColVal
	 FROM TaxSettingDetail TSD, TaxConfiguration TC  WHERE TC.TaxId = TSD.ColId
	 and TSD.TaxSeqId in ( SELECT Max(TaxSeqid) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId =  @Pi_RtrId    )
	 and TSD.BillSeqId in (SELECT max(BillSeqId) FROM TaxSettingdetail
	 where TaxSeqId in ( SELECT max(TaxSeqId) FROM TaxSettingMaster WHERE PrdId =  @Pi_TaxGroupId  and RtrId=  @Pi_RtrId    ) ) 
	 and TSD.ColType=3  ) X ORDER BY X.Rowid,X.Colno
END 
	RETURN
END
GO
--Parle Unification Bugs
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptReturnToCompanyDetails' AND XTYPE='P')
DROP PROCEDURE Proc_RptReturnToCompanyDetails
GO
--EXEC Proc_RptReturnToCompanyDetails  131,1,0,'',1,0,1,0
CREATE PROCEDURE Proc_RptReturnToCompanyDetails
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/************************************************
* PROCEDURE  : Proc_RptReturnToCompanyDetails
* PURPOSE    : To Generate Return To Company Details Report
* CREATED BY : Mahalakshmi.A
* CREATED ON : 06/06/2008  
* MODIFICATION 
*************************************************   
* DATE       AUTHOR      DESCRIPTION    

*************************************************/       
BEGIN
SET NOCOUNT ON
DECLARE @NewSnapId 			AS INT
DECLARE @DBNAME				AS NVARCHAR(50)
DECLARE @TblName 			AS NVARCHAR(500)
DECLARE @TblStruct 			AS NVARCHAR(4000)
DECLARE @TblFields 			AS NVARCHAR(4000)
DECLARE @sSql				AS NVARCHAR(4000)
DECLARE @ErrNo	 			AS INT
DECLARE @PurDBName			AS NVARCHAR(50)

--Filter Variable
DECLARE @FromDate	        	AS DATETIME
DECLARE @ToDate		 	        AS DATETIME
DECLARE @LcnId				AS INT
DECLARE @SpmId				AS INT
DECLARE @StkTypeId			AS INT
DECLARE @ReasonId			AS INT
DECLARE @RefNo				AS NVARCHAR(50)

--Till Here
--Assgin Value for the Filter Variable
SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
SET @SpmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId))
SET @ReasonId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,159,@Pi_UsrId))
SET @StkTypeId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,164,@Pi_UsrId))
SET @RefNo = (SELECT  TOP 1 sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,165,@Pi_UsrId))
--Till Here
Create TABLE #RptReturnToCompanyDetails
(
		LcnId				INT,
		SpmId				INT,
		StkTypeId			INT,
		RefNo				NVARCHAR(50),
		ReturnDate			DATETIME,
		LcnName				NVARCHAR(100),
		ReturnTo			NVARCHAR(50),
		StockType			NVARCHAR(100),
		PrdName				NVARCHAR(200),
		Batch				NVARCHAR(100),
		ReturnQty 			NUMERIC(38,2),
		Rate				NUMERIC(38,2),
		Amount				NUMERIC(38,2),
		AmtforClaim			NUMERIC(38,2),
		ReasonId			INT,
		Reason	 			NVARCHAR(100)
		
)
SET @TblName = 'RptReturnToCompanyDetails'

SET @TblStruct ='LcnId				INT,
		SpmId				INT,
		StkTypeId			INT,
		RefNo				NVARCHAR(50),
		ReturnDate			DATETIME,
		LcnName				NVARCHAR(100),
		ReturnTo			NVARCHAR(50),
		StockType			NVARCHAR(100),
		PrdName				NVARCHAR(200),
		Batch				NVARCHAR(100),
		ReturnQty 			NUMERIC(38,2),
		Rate				NUMERIC(38,2),
		Amount				NUMERIC(38,2),
		AmtforClaim			NUMERIC(38,2),
		ReasonId			INT,
		Reason	 			NVARCHAR(100)'

SET @TblFields = 'LcnId,SpmId,StkTypeId,RefNo, ReturnDate,LcnName,ReturnTo,StockType,PrdName,Batch,
			ReturnQty,Rate,Amount,AmtforClaim,ReasonId,Reason'
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME = @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
SET @Po_Errno = 0
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
	INSERT INTO #RptReturnToCompanyDetails 
		(LcnId,SpmId,StkTypeId,RefNo,ReturnDate,LcnName,ReturnTo,StockType,PrdName,Batch,
		  ReturnQty,Rate,Amount,AmtforClaim,ReasonId,Reason)	
		  
		SELECT * FROM View_ReturnToCompanyDetails WITH (NOLOCK)   
		WHERE 	(LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
				LcnId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
			AND
				(SpmId = (CASE @SpmId WHEN 0 THEN SpmId ELSE 0 END) OR
				SpmId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId)))
			AND
				(StockTypeId = (CASE @StkTypeId WHEN 0 THEN StockTypeId ELSE 0 END) OR
				StockTypeId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,164,@Pi_UsrId)))
			AND
				(ReasonId = (CASE @ReasonId WHEN 0 THEN ReasonId ELSE 0 END) OR
				ReasonId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,159,@Pi_UsrId)))
			AND
				(RtnCmpRefNo = (CASE @RefNo WHEN '' THEN RtnCmpRefNo ELSE '' END) OR
				RtnCmpRefNo IN (SELECT sCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,165,@Pi_UsrId)))

			AND RtnCmpDate BETWEEN @FromDate AND @ToDate 

   	IF LEN(@PurDBName) > 0
	BEGIN
		SET @SSQL = 'INSERT INTO #RptReturnToCompanyDetails ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE RptId=' + CAST(@Pi_RptId AS nVarchar(10)) + ' AND UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + '' 
			+ ' AND (RtnCmpRefNo = (CASE ' + CAST(@RefNo AS nVarchar(50)) + ' WHEN '''' THEN RtnCmpRefNo ELSE '''' END) OR '
			+ 'RtnCmpRefNo in (SELECT sCountid FROM Fn_ReturnRptFilterString(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',165,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
			+ 'AND (SpmId = (CASE ' + CAST(@SpmId AS nVarchar(10)) + ' WHEN 0 THEN SpmId ELSE 0 END) OR '
			+ 'SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',9,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (LcnId = (CASE ' + CAST(@LcnId AS nVarchar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR '
			+ 'LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',22,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (ReasonId = (CASE ' + CAST(@ReasonId AS nVarchar(10)) + ' WHEN 0 THEN ReasonId ELSE 0 END) OR '
			+ 'ReasonId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',159,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (StockTypeId = (CASE ' + CAST(@StkTypeId AS nVarchar(10)) + ' WHEN 0 THEN StockTypeId ELSE 0 END) OR '
			+ '@StkTypeId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + 
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',164,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'	
			+ 'AND RtnCmpDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''
			
		EXEC (@SSQL)
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptReturnToCompanyDetails'
		EXEC (@SSQL)
		PRINT 'Saved Data Into SnapShot Table'
	    END
END
ELSE				--To Retrieve Data From Snap Data
BEGIN
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptReturnToCompanyDetails ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))

		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	   END
END
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptReturnToCompanyDetails

PRINT 'Data Executed'
SELECT * FROM #RptReturnToCompanyDetails 


RETURN
END
GO
DELETE FROM RptFilter WHERE RptId IN (241,244) AND SelcId=278
GO
DELETE FROM RptFilter WHERE RptId =241 AND SelcId=275
INSERT INTO RptFilter
SELECT 241,275,0,'Sales'
UNION ALL
SELECT 241,275,1,'Purchase'
GO
DELETE FROM RptFilter WHERE RptId = 244 AND SelcId=275
INSERT INTO RptFilter
SELECT 244,275,0,'Sales'
UNION ALL
SELECT 244,275,1,'Purchase'
GO
DELETE FROM Rptdetails WHERE RptId=241 AND SlNo=3
INSERT INTO Rptdetails
SELECT 241,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Vat Type*...','',1,'',275,1,1,'Press F4/Double Click to Select Type',0
GO
DELETE FROM Rptdetails WHERE RptId=244 AND SlNo=3
INSERT INTO Rptdetails
SELECT 244,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Vat Type*...','',1,'',275,1,1,'Press F4/Double Click to Select Type',0
GO
DELETE FROM RptFormula WHERE RptId=241 AND SlNo=6
INSERT INTO RptFormula
SELECT 241,6,'Fill_InvoiceType','Invoice Type',1,275
GO
DELETE FROM RptFormula WHERE RptId=244 AND SlNo=6
INSERT INTO RptFormula
SELECT 244,6,'Fill_InvoiceType','Invoice Type',1,275
GO
IF  EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptStockandSalesValue_Excel' AND XTYPE='U')
DROP TABLE RptStockandSalesValue_Excel
GO
CREATE TABLE RptStockandSalesValue_Excel(
	[PrdId] [int] NULL,
	[PrdDCode] [nvarchar](100) NULL,
	[PrdName] [nvarchar](200) NULL,
	[PrdBatId] [int] NULL,
	[PrdBatCode] [nvarchar](100) NULL,
	[CmpId] [int] NULL,
	[CmpName] [nvarchar](50) NULL,
	[LcnId] [int] NULL,
	[LcnName] [nvarchar](50) NULL,
	[OpeningStock] [numeric](38, 6) NULL,
	[Purchase] [numeric](38, 6) NULL,
	[Sales] [numeric](38, 6) NULL,
	[AdjustmentIn] [numeric](38, 6) NULL,
	[AdjustmentOut] [numeric](38, 6) NULL,
	[PurchaseReturn] [numeric](38, 6) NULL,
	[SalesReturn] [numeric](38, 6) NULL,
	[ClosingStock] [numeric](38, 6) NULL,
	[RtrTaxGroup] [int] NULL,
	[SupTaxGroup] [int] NULL,
	[DispBatch] [int] NULL
) 
GO
IF  EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptStockandSalesValue' AND XTYPE='P')
DROP PROCEDURE Proc_RptStockandSalesValue
GO
--EXEC Proc_rptStockandSalesValue 7,1,0,'CoreStocky',0,0,1
CREATE PROCEDURE Proc_RptStockandSalesValue
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate		AS	DATETIME
	DECLARE @LcnId 		AS	INT
	DECLARE @PrdCatValId	AS	INT
	DECLARE @PrdId		AS	INT
	DECLARE @CmpId	 	AS	INT
	DECLARE @StockValue 	AS	INT
	DECLARE @PrdStatus 	AS	INT
	DECLARE @BatStatus 	AS	INT
	DECLARE @PPurTaxGroupId AS	INT
	DECLARE @PRtrTaxGroupId AS	INT
	DECLARE @DispBatch	AS	INT
	DECLARE @PrdBatId      	AS	INT
	DECLARE @SupZeroStock	AS INT
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatValId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @StockValue =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,23,@Pi_UsrId))
	SET @PrdStatus =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId))
	SET @BatStatus =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId))
	SET @PPurTaxGroupId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,18,@Pi_UsrId))
	SET @PRtrTaxGroupId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,19,@Pi_UsrId))
	SET @DispBatch = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,28,@Pi_UsrId))
	SET @PrdBatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))
	SET @SupZeroStock = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)

	IF @DispBatch = 1 
	BEGIN
		UPDATE RptExcelHeaders SET DisplayFlag=1 WHERE SlNo=5 AND RptId=@Pi_RptId
	END 
	ELSE
	BEGIN
		UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE SlNo=5 AND RptId=@Pi_RptId
	END

	Create TABLE #RptStockandSalesValue
	(
			PrdId 			INT,
			PrdDCode		NVARCHAR(100),
			PrdName			NVARCHAR(200),
			PrdBatId		INT,
			PrdBatCode		NVARCHAR(100),
			CmpId 			INT,
			CmpName			NVARCHAR(50),
			LcnId         	INT,
			LcnName 		NVARCHAR(50),	
			OpeningStock	NUMERIC(38,6),		
			Purchase 		NUMERIC (38,6),
			Sales 			NUMERIC (38,6),
			AdjustmentIn 	NUMERIC (38,6),
			AdjustmentOut 	NUMERIC (38,6),
			PurchaseReturn	NUMERIC (38,6),
			SalesReturn		NUMERIC (38,6),		
			ClosingStock	NUMERIC (38,6),
			RtrTaxGroup     INT,
			SupTaxGroup     INT,
			DispBatch       INT
	)
	SET @TblName = 'RptStockandSalesValue'
	SET @TblStruct = 'PrdId 			INT,
			PrdDCode		NVARCHAR(100),
			PrdName			NVARCHAR(200),
			PrdBatId		INT,
			PrdBatCode		NVARCHAR(100),
			CmpId 			INT,
			CmpName			NVARCHAR(50),
			LcnId         	INT,
			LcnName 		NVARCHAR(50),	
			OpeningStock	NUMERIC(38,6),
			Purchase 		NUMERIC (38,6),
			Sales 			NUMERIC (38,6),			
			AdjustmentIn 	NUMERIC (38,6),
			AdjustmentOut 	NUMERIC (38,6),
			PurchaseReturn	NUMERIC (38,6),
			SalesReturn		NUMERIC (38,6),			
			ClosingStock	NUMERIC (38,6),
			RtrTaxGroup     INT,
			SupTaxGroup     INT,
			DispBatch       INT'
			
	SET @TblFields = 'PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,
	LcnName,OpeningStock,Purchase,Sales,AdjustmentIn,AdjustmentOut,PurchaseReturn,
	SalesReturn,ClosingStock,RtrTaxGroup,SupTaxGroup,DispBatch'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME =  @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		IF @PPurTaxGroupId>0 OR @PRtrTaxGroupId>0
		BEGIN
			DELETE FROM TaxForReport WHERE UsrId=@Pi_UsrId AND RptId=@Pi_RptId
			EXEC Proc_ReportTaxCalculation @PPurTaxGroupId,@PRtrTaxGroupId,1,20,5,@Pi_UsrId,@Pi_RptId
		END
		EXEC Proc_GetStockNSalesDetails @FromDate,@ToDate,@Pi_UsrId
	
		IF @DispBatch =2 
		BEGIN
			INSERT INTO #RptStockandSalesValue (PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,
			LcnName,OpeningStock,Purchase,Sales,AdjustmentIn,AdjustmentOut,PurchaseReturn,SalesReturn,ClosingStock,RtrTaxGroup,SupTaxGroup,DispBatch)
			SELECT PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,TempRptStockNSales.CmpId, CmpName,0,'',
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(OpnSelRte)		WHEN 2 THEN SUM(OpnPurRte)		WHEN 3 THEN SUM(OpnMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(PurSelRte)		WHEN 2 THEN SUM(PurPurRte)		WHEN 3 THEN SUM(PurMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(SalSelRte)		WHEN 2 THEN SUM(SalPurRte)		WHEN 3 THEN SUM(SalMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(AdjInSelRte)	WHEN 2 THEN SUM(AdjInPurRte)	WHEN 3 THEN SUM(AdjInMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(AdjOutSelRte)	WHEN 2 THEN SUM(AdjOutPurRte)	WHEN 3 THEN SUM(AdjOutMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(PurRetSelRte)	WHEN 2 THEN SUM(PurRetPurRte)	WHEN 3 THEN SUM(PurRetMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(SalRetSelRte)	WHEN 2 THEN SUM(SalRetPurRte)	WHEN 3 THEN SUM(SalRetMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(CASE @stockValue WHEN 1 THEN SUM(CloSelRte)		WHEN 2 THEN SUM(CloPurRte)		WHEN 3 THEN SUM(CloMRPRte) END ,@Pi_CurrencyId),
			@PRtrTaxGroupId,@PPurTaxGroupId,@DispBatch
			FROM TempRptStockNSales
				INNER JOIN COMPANY C ON C.CmpId = TempRptStockNSales.CmpId
			WHERE ( TempRptStockNSales.CmpId = (CASE @CmpId WHEN 0 THEN TempRptStockNSales.CmpId ELSE 0 END) OR
					TempRptStockNSales.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)) )
				AND
				(LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
					LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
				AND
				(PrdStatus = (CASE @PrdStatus WHEN 0 THEN PrdStatus ELSE 0 END) OR
					PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId)))
				AND
				(BatStatus = (CASE @BatStatus WHEN 0 THEN BatStatus ELSE 2 END) OR
					BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId)))
				AND
				(PrdId = (CASE @PrdCatValId WHEN 0 THEN PrdId Else 0 END) OR
					PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND
				(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR
					PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
				AND   (PrdBatId=(CASE @PrdBatId WHEN 0 THEN PrdBatId ELSE 0 END ) OR
					PrdBatId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId)))  
				
				GROUP BY PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,TempRptStockNSales.CmpId,CmpName
		END
		ELSE
		BEGIN	
			INSERT INTO #RptStockandSalesValue (PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,
			LcnName,OpeningStock,Purchase,Sales,AdjustmentIn,AdjustmentOut,PurchaseReturn,SalesReturn,ClosingStock,RtrTaxGroup,SupTaxGroup,DispBatch)
			SELECT PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,TempRptStockNSales.CmpId, CmpName,0,'',
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(OpnSelRte) WHEN 2 THEN SUM(OpnPurRte) WHEN 3 THEN SUM(OpnMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(PurSelRte) WHEN 2 THEN SUM(PurPurRte) WHEN 3 THEN SUM(PurMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(SalSelRte) WHEN 2 THEN SUM(SalPurRte) WHEN 3 THEN SUM(SalMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(AdjInSelRte) WHEN 2 THEN SUM(AdjInPurRte) WHEN 3 THEN SUM(AdjInMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(AdjOutSelRte) WHEN 2 THEN SUM(AdjOutPurRte) WHEN 3 THEN SUM(AdjOutMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(PurRetSelRte) WHEN 2 THEN SUM(PurRetPurRte) WHEN 3 THEN SUM(PurRetMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(SalRetSelRte) WHEN 2 THEN SUM(SalRetPurRte) WHEN 3 THEN SUM(SalRetMRPRte) END ,@Pi_CurrencyId),
			dbo.Fn_ConvertCurrency(case @stockValue WHEN 1 THEN SUM(CloSelRte) WHEN 2 THEN SUM(CloPurRte) WHEN 3 THEN SUM(CloMRPRte) END ,@Pi_CurrencyId),
			@PRtrTaxGroupId,@PPurTaxGroupId,@DispBatch
			FROM TempRptStockNSales
				INNER JOIN COMPANY C ON C.CmpId = TempRptStockNSales.CmpId
			WHERE ( TempRptStockNSales.CmpId = (CASE @CmpId WHEN 0 THEN TempRptStockNSales.CmpId ELSE 0 END) OR
					TempRptStockNSales.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)) )
				AND
				(LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
					LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
				AND
				(PrdStatus = (CASE @PrdStatus WHEN 0 THEN PrdStatus ELSE 0 END) OR
					PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId)))
				AND
				(BatStatus = (CASE @BatStatus WHEN 0 THEN BatStatus ELSE 2 END) OR
					BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId)))
				AND
				(PrdId = (CASE @PrdCatValId WHEN 0 THEN PrdId Else 0 END) OR
					PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND
				(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR
					PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
				AND   (PrdBatId=(CASE @PrdBatId WHEN 0 THEN PrdBatId ELSE 0 END ) OR
					PrdBatId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId)))  
			GROUP BY PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,TempRptStockNSales.CmpId,CmpName
		END 
		IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptStockandSalesValue ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+ ' WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +
				' CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
				+ '( LcnId = (CASE ' + CAST(@LcnId AS nVarChar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR ' +
				' LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',22,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '
				+ '( PrdStatus = (CASE ' + CAST(@PrdStatus AS nVarchar(10)) + ' WHEN 0 THEN PrdStatus ELSE 0 END) OR ' +
				' PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',24,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND '
				+ '( BatStatus = (CASE ' + CAST(@BatStatus AS nVarchar(10)) + ' WHEN 0 THEN BatStatus ELSE 0 END) OR ' +
				' BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',25,' + CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND '
	
				+ '( PrdId = (CASE ' + CAST(@PrdCatValId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +
				' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND '
				+ ' (R.PrdId = (CASE ' + CAST(@PrdId AS nVarChar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +
				' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS  nVarchar(10)) + ',5,' +  CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND TempRptStockNSales.Opening > 0 OR TempRptStockNSales.Closing > 0 '
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptStockandSalesValue'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptStockandSalesValue ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
			RETURN
		END
	END
	IF @SupZeroStock=1 
	BEGIN
		DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptStockandSalesValue 
		WHERE (OpeningStock+Purchase+Sales+AdjustmentIn+AdjustmentOut
				+PurchaseReturn+SalesReturn+ClosingStock)<>0
		
		TRUNCATE TABLE RptStockandSalesValue_Excel
		INSERT INTO RptStockandSalesValue_Excel
		SELECT * FROM #RptStockandSalesValue 
		WHERE (OpeningStock+Purchase+Sales+AdjustmentIn+AdjustmentOut
		+PurchaseReturn+SalesReturn+ClosingStock)<>0
			
		SELECT * FROM #RptStockandSalesValue 
		WHERE (OpeningStock+Purchase+Sales+AdjustmentIn+AdjustmentOut
		+PurchaseReturn+SalesReturn+ClosingStock)<>0
	END
	ELSE
	BEGIN
		DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptStockandSalesValue
		TRUNCATE TABLE RptStockandSalesValue_Excel
		INSERT INTO RptStockandSalesValue_Excel
		SELECT * FROM #RptStockandSalesValue 
			
		SELECT * FROM #RptStockandSalesValue
	END
	RETURN
END
GO
SELECT * INTO #TempProductRptGroup FROM RptGroup WHERE GrpName IN ('Credit Evaluation Report',
'Vehicle Master Report',
'Vehicle Category Master Report',
'Bank Master Report',
'Bank Branch Master Report',
'Transporter Master Report',
'Company Master Report',
'Location Master Report',
'Distributor Info Master Report',
'Supplier Master Report',
'Stock Management Type Master Report',
'User Maintenance',
'Stock Type Report',
'Retailer Shipping Address Master Report',
'Udc Master Report',
'User Profile Master Report',
'DeliveryBoy Master Report',
'Salesman Master Report',
'Tax Configuration Master Report',
'Tax Group Master Report',
'Route Master Report',
'Claim Group Master Report',
'Claim Norm Master Report',
'Value Classification Master Report',
'JC Calendar Master Report',
'User Key Mapping Report',
'Bill Series Settings Report',
'Cheque Payment Report',
'Contract Pricing Report',
'Purchase Order Product Norm Mapping Report',
'Purchase Return Report',
'Purchase Invoice Series Settings Report',
'Target Norm Mapping Report',
'Transaction Sequencing Report',
'Van Load Details Report',
'Van Load Guide Master Report',
'Van Unload Details Report',
'Retailer Summary Report',
'Route Coverage Plan Report',
'DRCP Deviation Report',
'Batch Transfer Report',
'Opening Balance Report',
'Purchase Order Report',
'Retailer Cheque Inventory Report',
'Supplier Cheque and DD Inventory Report',
'Batch Creation',
'Purchase Sales Account',
'Standard Voucher',
'Counters',
'Hot Search Editor Report',
'Vehicle SubSidy Master',
'Retailer Sequencing Report',
'Stock Journal Report',
'Accounts Calendar',
'Product Sequencing',
'Stock Management',
'Village Master Report',
'Potential Classification Master Report',
'Order Booking',
'Retailer Stock Norm Report',
'KIT Product Master Report',
'Product Sales Bundle Report',
'Focus Brand Report',
'BillWise ProductWise Sales Report',
'Fund Management Report',
'Datewise Productwise Sales',
'Purchase Ageing Report',
'Billwise Collection Summary Report',
'Pending Bills Report-Shipping Address wise',
'Stock Ledger Summary Report',
'Input VAT Summary',
'Output VAT Summary',
'Retailer wise Bill wise Net Tax Summary Report',
'Sales Vat Report',
'Price Difference Claim Report',
'Critical Sales Parameter Report',
'RSP Sales Analysis Report',
'RSP Sales Trend Report',
'Sub Stockist JC Closing Review Report',
'Retailer Wise Value Report',
'ASR Report',
'Bench Marking Report',
'Discount Report',
'Focus SKU Report',
'Outletwise Retailing',
'MarketwiseRetailing',
'Launch Product Report',
'DSR wise Report - Target Analysis',
'DSR wise BGR wise Report - Target Anlaysis',
'Brand wise Report - Target Anlaysis')
ORDER BY GrpName ASC
UPDATE RptGroup SET Visibility=0 WHERE RptId IN (SELECT RptId FROM #TempProductRptGroup WHERE Rptid <> 148)
DROP TABLE #TempProductRptGroup
GO
UPDATE ProfileDt SET BtnStatus=0 WHERE MenuId='mCmp18' AND BtnIndex='3'
GO
UPDATE UTILITYPROCESS SET VersionId='3.1.0.0' WHERE ProcId=1 AND ProcessName='Core Stocky.Exe'
GO
--PARLE Mismatch Reports Script - Suganya
DELETE FROM Rptgroup WHERE RptId=169
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('DailyReports',169,'RptRtrWiseBrandWiseSales','Retailer Wise Brand Wise Sales',0)
GO
DELETE FROM RptHeader WHERE RptId=169
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('DRCP New','DRCP New','169','Retailer Wise Brand Wise Sales','Proc_RptRtrWiseBrandWiseSales','RptRtrWiseBrandWiseSales','RptRtrWiseBrandWiseSales.rpt',' ')
GO
DELETE FROM RptDetails WHERE RptId=169
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,1,'FromDate',-1,' ',' ','From Date*...',NULL,1,NULL,10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,2,'ToDate',-1,' ',' ','To Date*...',NULL,1,NULL,11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,3,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company*...',NULL,1,NULL,4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,4,'SalesMan',-1,NULL,'SMId,SMCode,SMName','SalesMan...',NULL,1,NULL,1,0,0,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,5,'RouteMaster',-1,NULL,'RMId,RMCode,RMName','Route...',NULL,1,NULL,2,0,0,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,6,'RetailerCategoryLevel',3,'CmpId','CtgLevelId,CtgLevelName,CtgLevelName','Retailer Category Level...','Company',1,'CmpId',29,1,0,'Press F4/Double Click to select Retailer Category Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,7,'RetailerCategory',6,'CtgLevelId','CtgMainId,CtgName,CtgName','Retailer Category Level Value...','RetailerCategoryLevel',1,'CtgLevelId',30,1,0,'Press F4/Double Click to select Retailer Category Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,8,'RetailerValueClass',7,'CtgMainId','RtrClassId,ValueClassName,ValueClassName','Retailer Value Classification...','RetailerCategory',1,'CtgMainId',31,1,0,'Press F4/Double Click to select Retailer Value Classification',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,9,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer...',NULL,1,NULL,3,0,0,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,10,'ProductCategoryLevel',3,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level*...','Company',1,'CmpId',16,1,1,'Press F4/Double Click to select Product Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (169,11,'ProductCategoryValue',10,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,1,0,'Press F4/Double Click to select Product Hierarchy Level Value',0)
GO
DELETE FROM RptFormula WHERE RptId=169
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,1,'DispFromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,2,'ValFromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,3,'DispToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,4,'ValToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,5,'DispCompany','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,6,'ValCompany','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,7,'DispSalesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,8,'ValSalesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,9,'ValRetailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,10,'ValRoute','Route',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,11,'ValToRtrCatLvl','Retailer CateGOry Level',1,29)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,12,'ValToRtrCatLvlVal','Retailer CateGOry Level Value',1,30)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,13,'ValToValClass','Retailer Value Classification',1,31)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,14,'CapRetailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,15,'CapRoute','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,16,'CapSalesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,17,'Total','Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,18,'CatLevel','Retailer CateGOry Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,19,'CatVal','Retailer CateGOry Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,20,'ValClass','Retailer Value Classification',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,21,'DispPrdHirLvl','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,22,'ValPrdHirLvl','Product Hierarchy Level',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,23,'DispPrdHirLvlVal','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,24,'ValPrdHirLvlVal','Product Hierarchy Level Value',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,25,'SalesmanName','Salesman Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,26,'RouteName','Route Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,27,'RetailerCateGOry','Retailer CateGOry',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,28,'RetailerClassification','Retailer Classification',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,29,'RetailerCode','Retailer Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (169,30,'Retailer Name','Retailer Name',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=169
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,1,'Salesman Name','Salesman Name',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,2,'Route Name','Route Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,3,'Retailer Category','Retailer Category',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,4,'Retailer Classification','Retailer Classification',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,5,'Retailer Code','Retailer Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,6,'Retailer Name','Retailer Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,7,'RtrId','RtrId',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,8,'[N. BEAUTE NAILS]','N. BEAUTE NAILS',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,9,'[N. CREME]','N. CREME',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,10,'[N. DEO]','N. DEO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,11,'[N. SOFT]','N. SOFT',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,12,'[NBC SHOWER]','NBC SHOWER',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,13,'[NBC SOAP]','NBC SOAP',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,14,'[NBO  ESSENTIAL]','NBO  ESSENTIAL',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,15,'[NBO  PERFORMANCE]','NBO  PERFORMANCE',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,16,'[NBO WHITENING]','NBO WHITENING',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,17,'[NFM AFTER SH.]','NFM AFTER SH.',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,18,'[NFM FACE C/CL]','NFM FACE C/CL',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,19,'[NFM SHAVING]','NFM SHAVING',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,20,'[NIVEA LIP CARE]','NIVEA LIP CARE',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,21,'[NVIS  WHITENING]','NVIS  WHITENING',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,22,'[NVIS CARE]','NVIS CARE',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (169,23,'[NVIS CLEANS.]','NVIS CLEANS.',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=201
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('DailyReports',201,'FundManagementReport','Fund Management Report',0)
GO
DELETE FROM RptHeader WHERE RptId=201
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('FundManagementReport','Fund Management Report','201','Fund Management Report','Proc_RptFundManagement','RptFundManagement','RptFundManagement.Rpt','')
GO
DELETE FROM RptDetails WHERE RptId=201
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (201,1,'FromDate',-1,'','','From Date*','',1,'',10,1,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (201,2,'ToDate',-1,'','','To Date*','',1,'',11,1,1,'Enter To Date',0)
GO
DELETE FROM RptFormula WHERE RptId=201
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,2,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,3,'FilDisp_FromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,4,'FilDisp_ToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,5,'PurDate','Recd Ref Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,6,'PurRcptRefNo','Recd Ref Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,7,'RcvdAmt','Received',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,8,'SalInvDate','Spent Ref Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,9,'SalInvNo','Spent Ref Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,10,'RtrName','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,11,'SpentAmt','Spent',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,12,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,13,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (201,14,'Hd_Total','Total',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=201
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,1,'PurRcptId','PurRcptId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,2,'PurRcptDate','Recd Ref Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,3,'PurRcptRefNo','Recd Ref No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,4,'ReceivedAmt','Recd Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,5,'SalId','SalId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,6,'SalInvDate','Spent Ref Date',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,7,'SalInvNo','Spent Ref No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,8,'RtrId','RtrId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,9,'RtrCode','RtrCode',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,10,'RtrName','Retailer',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (201,11,'SpentAmt','Spent Amount',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=212
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('RspReport',212,'OutletwiseRetailing','Outletwise Retailing',0)
GO
DELETE FROM RptHeader WHERE RptId=212
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('RspReport','Outletwise Retailing','212','Outletwise Retailing','Proc_RptOutletwiseRetailing','RPTOUTLETWISERETAILING','RPTOUTLETWISERETAILING.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=212
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (212,1,'JCMast',-1,NULL,'JcmId,JcmYr,JcmYr','JC Year*...',NULL,1,NULL,12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (212,2,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','From JC Month*...','JcMast',1,'JcmId',13,1,1,'Press F4/Double Click to select From JC Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (212,3,'JCMonth',1,'JcmId','JcmJc,JcmEdt,JcmEdt','To JC Month*...','JcMast',1,'JcmId',20,1,1,'Press F4/Double Click to select To JC Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (212,4,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,1,NULL,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (212,5,'RouteMaster',-1,'','RMId,RMCode,RMName','Route...','',1,'',2,NULL,NULL,'Press F4/Double Click to select Routeh',0)
GO
DELETE FROM RptFormula WHERE RptId=212
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,1,'PrdCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,2,'PrdName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,3,'Received','Received',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,4,'Return In (Sales Return)','Return In (Sales Return)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,5,'Return Out (Purchase Return)','Return Out (Purchase Return)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,6,'Spent','Spent',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,7,'Transfer In','Transfer In',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,8,'Transfer Out','Transfer Out',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,9,'Opening Balance','Opening Balance',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,10,'Closing Balance','Closing Balance',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,11,'Cap_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,12,'Cap_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,13,'Cap_Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,14,'Cap_ProductHierarchyLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,15,'Cap_ProductHierarchyValue','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,16,'Cap_Produt','Produt',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,17,'Cap_ProductStatus','Product Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,18,'Dis_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,19,'Dis_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,20,'Dis_Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,21,'Dis_ProductHierarchyLevel','ProductCateGOryLevel',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,22,'Dis_ProductHierarchyValue','ProductCateGOryLevelValue',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,23,'Dis_Produt','BillNumber',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,24,'Dis_ProductStatus','BillNumber',1,24)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,25,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,26,'Cap_UserName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (212,27,'Cap_PrintDate','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=212
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,1,'RtrId','Retailer Id',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,2,'RTRNM','Retailer Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,3,'COVERAGE','Coverage',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,4,'CLASS1','Class',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,5,'CATEGORY','Category',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,6,'WEEK1','Week 1',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,7,'WEEK2','Week 2',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,8,'WEEK3','Week 3',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,9,'WEEK4','Week 4',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,10,'WEEK5','Week 5',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,11,'USRID','Total',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,12,'SRPID','SRPID',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,13,'JCMID','JCMID',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (212,14,'RtrAdd1','RtrAdd1',0,1)
GO
DELETE FROM Rptgroup WHERE RptId=214
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('RspReport',214,'MarketwiseRetailing','MarketwiseRetailing',0)
GO
DELETE FROM RptHeader WHERE RptId=214
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('RspReport','MarketwiseRetailing','214','MarketwiseRetailing','Proc_RptROUTEWISERETAILING','RptRoutewiseretailing','RPTMARKETWISERETAILING.rpt',NULL)
GO
DELETE FROM RptDetails WHERE RptId=214
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (214,1,'Company',-1,'','CmpId,CmpCode,CmpName','Company*...','',1,'',4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (214,2,'RouteMaster',-1,'','RMId,RMCode,RMName','Route...','',1,'',2,NULL,NULL,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (214,3,'JCMast',-1,NULL,'JcmId,JcmYr,JcmYr','JC Year*...',NULL,1,NULL,12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (214,4,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','JC Month*...','JcMast',1,'JcmId',13,1,1,'Press F4/Double Click to select JC Month',0)
GO
DELETE FROM RptFormula WHERE RptId=214
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,1,'Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,2,'Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,3,'Fill_JCYear','JC Year',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,4,'Fill_Month','JC Month',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,5,'Disp_JCYear','JC Year',1,12)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,6,'Disp_Month','JC Month',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,7,'FillBeatDisRtrCount','Count',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (214,8,'FillTotDisRtrCount','Count',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=214
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,1,'mktid','Market Id',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,2,'mktnm','Market Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,3,'rtrcount','Retailer count',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,4,'WEEK1','Week 1',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,5,'WEEK2','Week 2',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,6,'WEEK3','Week 3',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,7,'WEEK4','Week 4',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,8,'WEEK5','Week 5',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,9,'srpid','SRPID',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,10,'srpnm','JCMID',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (214,11,'UsrId','Total',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=215
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('SchemeNClaimReport',215,'RetailerWiseSchemeUtilizationReport','Retailer Wise Scheme Utilization Report',0)
GO
DELETE FROM RptHeader WHERE RptId=215
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('Retailer Wise Scheme Utilization Report','Retailer Wise Scheme Utilization Report','215','Retailer Wise Scheme Utilization Report','Proc_RptRetailerwiseSchemeUtilization','RptRtrWiseSchUtilization','RptRetailerwiseSchemeUtilizationReport.rpt',' ')
GO
DELETE FROM RptDetails WHERE RptId=215
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,1,'SchemeMaster',-1,NULL,'SchId,SchCode,SchDsc','Scheme Number...',NULL,1,NULL,258,1,NULL,'Press F4/Double Click to select Scheme Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,3,'DateDetails',-1,' ','FromDate ','From Date*...',NULL,1,NULL,10,NULL,1,'Press F4/Double Click to select From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,4,'DateDetails',-1,' ','ToDate ','To Date*...',NULL,1,NULL,11,NULL,1,'Press F4/Double Click to select To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,5,'SalesInvoice',-1,' ','SalId,SalInvRef,SalInvNo ','From Bill No...',NULL,1,NULL,14,1,NULL,'Press F4/Double Click to select From Bill',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,6,'SalesInvoice',-1,' ','SalId,SalInvRef,SalInvNo ','To Bill No...',NULL,1,NULL,15,1,NULL,'Press F4/Double Click to select To Bill',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,7,'Salesman',-1,' ','SMId,SMCode,SMName','Salesman...',NULL,1,NULL,1,NULL,NULL,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,8,'RouteMaster',-1,' ','RMId,RMCode,RMName','Route...',NULL,1,NULL,2,NULL,NULL,'Press F4/Double Click to Select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,9,'Company',-1,' ','CmpId,CmpCode,CmpName','Company...',NULL,1,NULL,4,1,NULL,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,14,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer...',NULL,1,NULL,3,NULL,NULL,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (215,15,'Product',-1,NULL,'PrdId,PrdDCode,PrdName','SKU...',NULL,1,NULL,5,NULL,NULL,'Press F4/Double Click to select SKU',0)
GO
DELETE FROM RptFormula WHERE RptId=215
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,1,'Disp_SchNo','Scheme Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,2,'Disp_SchDesc','Scheme Description',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,3,'Fill_SchNo','Scheme Number',1,247)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,4,'Fill_SchDesc','Scheme Description',1,248)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,5,'Disp_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,6,'Disp_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,7,'Disp_FromBillNo','From Bill No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,8,'Fill_FromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,9,'Fill_ToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,10,'Fill_FromBillNo','From Bill No',1,14)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,11,'Disp_ToBillNo','To Bill No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,12,'Fill_ToBillNo','To Bill No',1,15)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,13,'Disp_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,14,'Fill_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,15,'Disp_Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,16,'Fill_Route','Route',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,17,'Disp_RtrCtgLvl','Retailer CateGOry Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,18,'Fill_RtrCtgLvl','Retailer CateGOry Level',1,29)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,19,'Disp_RtrCtgLvlVal','Retailer CateGOry Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,20,'Fill_RtrCtgLvlVal','Retailer CateGOry Level',1,30)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,21,'Disp_RtrValClass','Retailer Value Classification',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,22,'Fill_RtrValClass','Retailer Value Classification',1,31)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,23,'Disp_RtrGroup','Retailer Group',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,24,'Fill_RtrGroup','Retailer Group',1,215)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,25,'Disp_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,26,'Fill_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,27,'Disp_SKU','SKU',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,28,'Fill_SKU','SKU',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,29,'Disp_BillDate','Bill Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,30,'Disp_BillNo','Bill No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,31,'Disp_RetailerCode','Retailer Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,33,'Disp_RetailerName','Retailer Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,34,'Disp_SchemeName','Scheme Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,35,'Disp_SKUCode','SKU Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,36,'Disp_SKUName','SKU Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,37,'Disp_BillQty','Bill Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,38,'Disp_FreeQty','Free Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,39,'Disp_GrossVal','Gross Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,40,'Disp_SchAmt','Scheme Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,41,'Cap UserName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (215,42,'FillDate','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=215
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,1,'SalId','SalId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,2,'SalInvNo','Invoice No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,3,'SalInvDate','Invoice Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,4,'RtrId','RtrId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,5,'RtrCode','RetailerCode',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,6,'RtrName','RetailerName',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,7,'SchId','SchId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,8,'SchDsc','SchemeDescription',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,9,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,10,'PrdDCode','ProductCode',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,11,'PrdName','ProductName',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,12,'BilledQty','BilledQty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,13,'PrdUnitSelRate','SellingRate',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,14,'PrdUnitMRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,15,'Grossvalue','Grossvalue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,16,'FreeQty','FreeQty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,17,'SchemeValue','SchemeValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,18,'FlatAmount','FlatAmount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,19,'DiscountPerAmount','DiscountPerAmount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,20,'PrimarySchemeAmt','PrimarySchemeAmt',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (215,21,'CompSchCode','CompSchCode',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=216
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('DailyReports',216,'NetsalesReport','Netsales Report',0)
GO
DELETE FROM RptHeader WHERE RptId=216
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('NetsalesReport','Netsales Report','216','Netsales Report','Proc_RptNNetSales','RptNNetsales','RptNNetsales.rpt',NULL)
GO
DELETE FROM RptDetails WHERE RptId=216
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,NULL,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,3,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company*...',NULL,1,NULL,4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,4,'ProductCateGOryLevel',3,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,NULL,'Press F4/Double Click to select Product Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,5,'ProductCateGOryValue',4,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCateGOryLevel',1,'CmpPrdCtgId',21,NULL,NULL,'Press F4/Double Click to select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,6,'Product',5,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCateGOryValue',1,'PrdCtgValMainId',5,NULL,NULL,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,7,'Salesman',-1,NULL,'SMId,SMCode,SMName','Salesman...',NULL,1,NULL,1,NULL,NULL,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,8,'RouteMaster',-1,NULL,'RMId,RMCode,RMName','Route...',NULL,1,NULL,2,NULL,NULL,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,9,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer...',NULL,1,NULL,3,NULL,NULL,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (216,10,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Report Based On*...',NULL,1,NULL,259,1,1,'Press F4/Double Click to Select Report Based on',0)
GO
DELETE FROM RptFormula WHERE RptId=216
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,1,'FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,2,'Disp_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,3,'ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,4,'Disp_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,5,'Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,6,'Disp_Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,7,'ProductCateGOryLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,8,'Disp_ProductCateGOryLevel','ProductCateGOryLevel',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,9,'ProductCateGOryValue','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,10,'Disp_ProductCateGOryValue','ProductCateGOryLevelValue',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,11,'Cap_Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,12,'Disp_Product','Product',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,13,'Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,14,'Disp_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,15,'Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,16,'Disp_Route','Route',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,17,'Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,18,'Disp_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,19,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,20,'Cap USER Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (216,21,'Cap PRINT Date','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=216
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,1,'Prdid','Product Id',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,2,'Prdbatid','Prd Bat Id',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,3,'Prdccode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,4,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,5,'CmpBatCode','Batch Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,6,'MRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,7,'SalesBaseQty','Sales Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,8,'SalesValue','Sales Value',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,9,'SalesTaxValue','Sales Tax Value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,10,'SalesSchDiscount','Sales SchemeDiscount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,11,'SalesOthrDiscount','Sales OtherDiscount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,12,'RtnBaseQty','Return Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,13,'RtnSaleValue','Return Sales value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,14,'RtnTaxValue','Return Tax value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,15,'RtnSchDiscount','Return SchemeDiscount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,16,'RtnOthrDiscount','Return OtherDiscount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,17,'NetQty','Net Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,18,'NetSales','Net Sales',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,19,'NetTaxValue','Net Tax value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,20,'SalesCP','SalesCP',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (216,21,'ReturnCP','ReturnCP',0,1)
GO
DELETE FROM RptFilter WHERE RptId=216
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (216,259,1,'Value')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (216,259,2,'Volume')
GO
DELETE FROM Rptgroup WHERE RptId=224
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('TaxReports',224,'RetailerwiseBillwiseNetTaxSummaryReport','Retailer wise Bill wise Net Tax Summary Report',0)
GO
DELETE FROM RptHeader WHERE RptId=224
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('TaxReport','Retailer wise Bill wise Net Tax Summary Report','224','Retailer wise Bill wise Net Tax Summary Report','Proc_RetailerWsBillTaxSummary','RPTBillDetailsRtrLevelTaxSummary','RPTBillDetailsRtrLevelTaxSummary.rpt',NULL)
GO
DELETE FROM RptDetails WHERE RptId=224
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,NULL,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,3,'Salesman',-1,NULL,'SMId,SMCode,SMName','Salesman...',NULL,1,NULL,1,0,NULL,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,4,'RouteMaster',-1,NULL,'RMId,RMCode,RMName','Route...',NULL,1,NULL,2,0,NULL,'Press F4/Double Click to Select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,5,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer...',NULL,1,NULL,3,0,NULL,'Press F4/Double Click to Select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (224,6,'SalesInvoice',-1,NULL,'SalId,SalInvNo,SalInvNo','Bill No...','',1,'',195,0,0,'Press F4/Double Click to Select Transaction Reference No',0)
GO
DELETE FROM RptFormula WHERE RptId=224
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (224,1,'Cap From Date','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (224,2,'From Date','FromDate',1,10)
GO
DELETE FROM RptExcelHeaders WHERE RptId=224
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,1,'[Bill Id]','Bill Id',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,2,'[Bill Number]','Bill Number',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,3,'[Bill Date]','Bill Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,4,'[Retailer Code (Dist)]','Retailer Code (Dist)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,5,'[Retailer Name]','Retailer Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,6,'[Retailer Address 1]','Sales Man',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,7,'[Retailer Address 2]','Route',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,8,'[TIN Number]','TIN Number',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,9,'[Gross Amount]','Gross Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,10,'[Special Discount]','Special Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,11,'[Scheme Discount]','Scheme Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,12,'[Distributor Discount]','Distributor Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,13,'[Cash Discount]','Cash Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,14,'[Taxable Amount 12.5%]','Taxable Amount 12.5%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,15,'[Taxable Amount 0%]','Taxable Amount 0%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,16,'[Tax Amount 12.5%]','Tax Amount 12.5%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,17,'[Tax Amount 0%]','Tax Amount 0%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,18,'[Total Tax]','Total Tax',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,19,'[Display Amount]','Display Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,20,'[Market Return Ref Number]','Market Return Ref Number',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,21,'[Market Return - Gross Amount]','Market Return - Gross Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,22,'[Market Return - Special Discount]','Market Return - Special Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,23,'[Market Return - Scheme Discount]','Market Return - Scheme Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,24,'[Market Return - Distributor Discount]','Market Return - Distributor Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,25,'[Market Return - Cash Discount]','Market Return - Cash Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,26,'[Market Return - Taxable Amount 12.5%]','Market Return - Taxable Amount 12.5%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,27,'[Market Return - Taxable Amount 0%]','Market Return - Taxable Amount 0%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,28,'[Market Return - Tax Amount 12.5%]','Market Return - Tax Amount 12.5%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,29,'[Market Return - Tax Amount 0%]','Market Return - Tax Amount 0%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,30,'[Market Return - Total Tax]','Market Return - Total Tax',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,31,'[Credit Note Adjustment]','Credit Note Adjustment',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,32,'[Debit Note Adjustment]','Debit Note Adjustment',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,33,'[On Account Adjustment]','On Account Adjustment',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,34,'[Other Charges (Add)]','Other Charges (Add)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,35,'[Other Charges (Reduce)]','Other Charges (Reduce)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (224,36,'[Invoice Net Amount]','Invoice Net Amount',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=234
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('RspReport',234,'DSRwiseReport','DSR wise Report - Target Analysis',0)
GO
DELETE FROM RptHeader WHERE RptId=234
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('DSRwiseReport','DSR wise Report - Target Analysis','234','DSR wise Report - Target Analysis','Proc_RptDSRwiseTargetAnalysis','RptDSRwiseTargetAnalysis','RptDSRwiseTargetAnalysis.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=234
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (234,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','JC Year*','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (234,2,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','JC Month','JcMast',1,'JcmId',13,0,0,'Press F4/Double Click to select Jc Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (234,3,'Salesman',-1,'','SMId,SMCode,SMName','Salesman','',1,'',1,0,0,'Press F4/Double Click to select Salesman',0)
GO
DELETE FROM RptFormula WHERE RptId=234
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,1,'Display_JCMonth','JC Month',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,2,'Display_SalesMan','DSR Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,3,'Display_PlBillsCut','Planned Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,4,'Display_BillsCut','Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,5,'Display_PlECO','Planned ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,6,'Display_ECO','ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,7,'Display_PlLineSold','Planned Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,8,'Display_LineSold','Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,9,'Display_SalesPlan','Sales Plan',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,10,'Display_SalesActual','Sales Actual',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,11,'Display_Achievement','Achivement %',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,12,'Display_UName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (234,13,'Display_PDate','Print Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=234
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,1,'[JCMonth]','JC Month',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,2,'[SalesMan]','DSR Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,3,'[Planned BillsCut]','Planned BillsCut',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,4,'[BillsCut]','Bills Cut',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,5,'[Planned ECO]','Planned ECO',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,6,'[ECO]','ECO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,7,'[Planned LineSold]','Planned LineSold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,8,'[LineSold]','Line Sold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,9,'[SalesPlan]','Sales Plan',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,10,'[SalesActual]','Sales Actual',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,11,'[Achievement]','Achivement %',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (234,12,'[UserId]','UserId',0,1)
GO
DELETE FROM Rptgroup WHERE RptId=235
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('RspReport',235,'LaunchProductReport','Launch Product Report',0)
GO
DELETE FROM RptHeader WHERE RptId=235
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('RspReport','Launch Product Report','235','Launch Product Report','Proc_RptLaunchProduct','RptLaunchProduct','RptLaunchProduct.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=235
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (235,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','JC Year...','',1,'',12,1,1,'Press F4/Double Click to Select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (235,2,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','JC Month...','JcMast',1,'JcmId',13,0,0,'Press F4/Double Click to select Jc Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (235,3,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'JcmId',1,0,0,'Press F4/Double Click to select Jc Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (235,4,'LaunchTargetHd',-1,'','SLaunchNo,LaunchRefNo,LaunchRefNo','Reference No...','',1,'JcmJc',278,1,1,'Press F4/Double Click to select Launch Rererence No',0)
GO
DELETE FROM RptFormula WHERE RptId=235
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,1,'Display_UName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,2,'Display_PDate','Print Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,3,'Display_DSRName','DSR Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,4,'Display_LSHU','Launch SKU',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,5,'Display_TOutlets','Total No of Outlets',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,6,'Display_POutlets','Planned Outlets',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,7,'Display_BOutlets','Outlets Billed(ECO)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,8,'Display_Achivements','Achivement%',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,9,'Display_SPlan','Sales Plan',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (235,10,'Display_SActual','Sales Actual',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=235
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,1,'[DSR NAME]','DSR NAME',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,2,'[Launch SKU]','Launch SKU',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,3,'[Total No Of Outlets]','Total No Of Outlets',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,4,'[Planned Outlets]','Planned Outlets',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,5,'[Outlets Billed]','Outlets Billed',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,6,'[Achivement1%]','Achivement%',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,7,'[Sales Plan]','Sales Plan',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,8,'[Sales Actual]','Sales Actual',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (235,9,'[Achivement2%]','Achivement%',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=236
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('RspReport',236,'SalesmanBrandWiseTargetAnlaysisReport','DSR wise BGR wise Report - Target Anlaysis',0)
GO
DELETE FROM RptHeader WHERE RptId=236
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('SalesmanBrandWiseTargetAnlaysisReport','DSR wise BGR wise Report - Target Anlaysis','236','DSR wise BGR wise Report - Target Anlaysis','Proc_RptSalesmanBrandwiseTargetAnalysis','RptSalesmanBrandWsTargetAnalysis','RptSalesmanBrandWsTargetAnalysis.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=236
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (236,1,'JCMast',-1,0,'JcmId,JcmYr,JcmYr','JC Year*','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (236,2,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','JC Month','JcMast',1,'JcmId',13,0,0,'Press F4/Double Click to select Jc Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (236,3,'Salesman',-1,'','SMId,SMCode,SMName','Salesman','',1,'',1,0,0,'Press F4/Double Click to select Salesman',0)
GO
DELETE FROM RptFormula WHERE RptId=236
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,1,'Display_JCMonth','JC Month',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,2,'Display_Salesman','DSR Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,3,'Display_Brand','BGR Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,4,'Display_PlBillsCut','Planned Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,5,'Display_BillsCut','Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,6,'Display_PlECO','Planned ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,7,'Display_ECO','ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,8,'Display_PlLineSold','Planned Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,9,'Display_LineSold','Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,10,'Display_SalesPlan','Sales Plan',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,11,'Display_SalesActual','Sales Actual',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,12,'Display_Achievement','Achivement %',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,13,'Display_UName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (236,14,'Display_PDate','Print Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=236
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,1,'[JCMonth]','JC Month',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,2,'[SMName]','DSR Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,3,'[Brand]','BGR Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,4,'[Planned BillsCut]','Planned Bills Cut',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,5,'[BillsCut]','Bills Cut',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,6,'[Planned ECO]','Planned ECO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,7,'[ECO]','ECO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,8,'[Planned LineSold]','Planned Line Sold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,9,'[LineSold]','Line Sold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,10,'[SalesPlan]','Sales Plan',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,11,'[SalesActual]','Sales Actual',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,12,'[Achievement]','Achivement %',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (236,13,'[UserId]','UserId',0,1)
GO
DELETE FROM RptFilter WHERE RptId=236
GO
DELETE FROM Rptgroup WHERE RptId=237
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('RspReport',237,'BrandWiseTargetAnlaysisReport','Brand wise Report - Target Anlaysis',0)
GO
DELETE FROM RptHeader WHERE RptId=237
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('BrandWiseTargetAnlaysisReport','Brand wise Report - Target Anlaysis','237','Brand wise Report - Target Anlaysis','Proc_RptBGRwiseTargetAnalysis','RptBrandWsTargetAnalysis','RptBGRWsTargetAnalysis.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=237
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (237,1,'JCMast',-1,0,'JcmId,JcmYr,JcmYr','JC Year*','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (237,2,'JCMonth',1,'JcmId','JcmJc,JcmSdt,JcmSdt','JC Month','JcMast',1,'JcmId',13,0,0,'Press F4/Double Click to select Jc Month',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (237,3,'ProductCategoryValue',-1,0,'prdctgvalmainid,prdctgvalname','Brand','',1,'',274,0,0,'Press F4/Double Click to select Brand',0)
GO
DELETE FROM RptFormula WHERE RptId=237
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,1,'Display_JCMonth','JC Month',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,2,'Display_Brand','BGR Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,3,'Display_PlBillsCut','Planned Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,4,'Display_BillsCut','Bills Cut',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,5,'Display_PlECO','Planned ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,6,'Display_ECO','ECO',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,7,'Display_PlLineSold','Planned Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,8,'Display_LineSold','Line Sold',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,9,'Display_SalesPlan','Sales Plan',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,10,'Display_SalesActual','Sales Actual',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,11,'Display_Achievement','Achivement %',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,12,'Display_UName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (237,13,'Display_PDate','Print Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=237
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,1,'[JCMonth]','JC Month',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,2,'[Brand]','BGR Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,3,'[Planned BillsCut]','Planned Bills Cut',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,3,'[BillsCut]','Bills Cut',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,4,'[Planned ECO]','Planned ECO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,4,'[ECO]','ECO',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,5,'[Planned LineSold]','Planned Line Sold',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,5,'[LineSold]','Line Sold',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,6,'[SalesPlan]','Sales Plan',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,7,'[SalesActual]','Sales Actual',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,8,'[Achievement]','Achivement %',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (237,9,'[UserId]','UserId',0,1)
GO
DELETE FROM ReportFilterDt WHERE RptId=237
GO
--Hatsun
DELETE FROM RptSelectionHd WHERE SelcId = 279
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(279,'Sel_IDTDistId','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 280
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(280,'Sel_IDTRefId','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 281
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(281,'Sel_IDTType','IDTManagement',1)
GO
DELETE  FROM RptSelectionHd WHERE SelcId = 282
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(282,'Sel_IDTFDist','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 283
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(283,'Sel_IDTTDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 284
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(284,'IDTFromDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 285
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(285,'IDTToDist','IDTManagement',0)
GO
DELETE From RptSelectionHD  WHERE SelcId = 286
INSERT INTO RptSelectionHD (SelcId,SelcName,TblName,Condition)
Values(286,'IDTRefNumber','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 287
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(287,'IDTFromRefNumber','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId = 288
INSERT INTO RptSelectionHd(SelcId,SelcName,TblName,Condition)
VALUES(288,'IDTToRefNumber','IDTManagement',0)
GO
DELETE FROM Rptgroup WHERE RptId=238
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('MasterReports',238,'IDTReport','Inter Stock Foresight',0)
GO
DELETE FROM RptHeader WHERE RptId=238
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('IDTReport','Inter Stock Foresight','238','Inter Stock Foresight','Proc_RptIDTReport','RptIDTReport','RptIDTReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=238
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (238,1,'Fromdate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (238,2,'Todate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (238,3,'IDTMaster',-1,NULL,'SpmId,SpmCode,SpmName','Distributors ...',NULL,1,NULL,279,1,0,'Press F4/Double Click to Select Distributors',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (238,4,'IDTManagement',-1,NULL,'IDTMngRefNo,IDTMngRefNo,IDTMngRefNo','Reference No ...',NULL,1,0,280,1,0,'Press F4/Double Click to Select Distributors',0)
GO
DELETE FROM RptFormula WHERE RptId=238
GO
DELETE FROM RptExcelHeaders WHERE RptId=238
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,2,'prod_code','prod_code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,3,'prod_desc','prod_desc',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,4,'stock_units','stock_units',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,5,'MRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (238,6,'IDTMngRefNo','IDTMngRefNo',0,1)
GO
DELETE FROM RptFilter WHERE RptId=238
GO
DELETE FROM RptGroup WHERE RptId=239
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('MasterReports',239,'IDTManagementReport','IDT Management Report',0)
GO
DELETE FROM RptHeader WHERE RptId=239
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('IDTManagementReport','IDT Management Report','239','IDT Management Report','Proc_RptIDTManagementReport','RptIDTManagementReport','RptIDTManagementReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=239
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,1,'Fromdate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,2,'Todate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,3,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','IDT Type* ...',NULL,1,NULL,281,1,1,'Press F4/Double Click to Select IDT Type',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,4,'IDTMaster',-1,NULL,'SpmId,SpmCode,SpmName','From Distributor ...',NULL,1,NULL,282,1,0,'Press F4/Double Click to Select Distributors',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,5,'Distributor',-1,NULL,'DistributorId,DistributorCode,DistributorName','To Distributor ...',NULL,1,0,283,1,0,'Press F4/Double Click to Select Distributors',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,6,'Location',-1,NULL,'LcnId,LcnCode,LcnName','Location ...',NULL,1,0,22,1,0,'Press F4/Double Click to Select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (239,7,'IDTManagement',-1,NULL,'IDTMngRefNo,IDTMngRefNo,IDTMngRefNo','Reference No ...',NULL,1,0,280,1,0,'Press F4/Double Click to Select Distributors',0)
GO
DELETE FROM RptFormula WHERE RptId=239
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,1,'Disp_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,2,'Fill_FromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,3,'Disp_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,4,'Fill_ToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,5,'Disp_IDTType','IDT Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,6,'Fill_IDTType','IDT Type',1,281)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,7,'Disp_FDist','From Distributor',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,8,'Fill_FDist','FromDistributor',1,282)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,9,'Disp_TDist','To Distributor',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,10,'Fill_TDist','To Distributor',1,283)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,11,'Disp_Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,12,'Fill_Location','Location',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,13,'Disp_RefNo','Reference Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,14,'Fill_RefNo','ReferenceNumber',1,280)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,15,'Disp_Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,16,'Disp_PCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,17,'Disp_PName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,18,'Disp_Batch','Batch',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,19,'Disp_Rate','Rate',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,20,'Disp_Qty','Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,21,'Disp_Gross','Gross Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,22,'Disp_Tax','Tax Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,23,'Disp_IDTCharges','IDT Charges',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (239,24,'Disp_NetAmount','Net Amount',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=239
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,1,'IDTMngRefNo','Reference Number',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,2,'IDTMngDate','Date',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,3,'PrdId','PrdId',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,4,'PrdDCode','Product Code',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,5,'PrdName','Product Name',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,6,'PrdBatId','PrdBatId',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,7,'PrdbatCode','Batch',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,8,'MRP','MRP',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,9,'ListPrice','List Price',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,10,'Qty','Qty',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,11,'PrdGrossAmount','Gross Amount',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,12,'PrdTaxAmount','Tax Amount',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,13,'IDTCharges','IDT Charges',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (239,14,'PrdNetAmount','Net Amount',1,0)
GO
DELETE FROM RptFilter WHERE RptId=239
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (239,281,1,'IDT IN')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (239,281,2,'IDT OUT')
GO
DELETE FROM RptGroup WHERE RptId=240
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('PurchaseReports',240,'LogisticMaterial','Logistic Material Report',0)
GO
DELETE FROM RptHeader WHERE RptId=240
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('LogisticMaterial','Logistic Material Report','240','Logistic Material Report','Proc_RptLogisticStock','RptLogisticMaterial','RptLogisticMaterial.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=240
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,NULL,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,3,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company...',NULL,1,NULL,4,1,0,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,4,'Supplier',-1,NULL,'SpmId,SpmCode,SpmName','Supplier...',NULL,1,NULL,9,NULL,NULL,'Press F4/Double Click to select Supplier',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,5,'PurchaseReceipt',-1,NULL,'PurRcptRefNo,PurRcptRefNo,PurRcptRefNo','GRN Number...',NULL,1,NULL,173,NULL,NULL,'Press F4/Double Click to select GRN Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (240,6,'PurchaseReceipt',-1,NULL,'CmpInvNo,CmpInvNo,CmpInvNo','Company Inv No...',NULL,1,NULL,174,0,NULL,'Press F4/Double Click to select Company Inv No',0)
GO
DELETE FROM RptFormula WHERE RptId=240
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,2,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,3,'Fil_Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,4,'Fil_Supplier','Supplier',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,5,'Fil_GRNNumber','GRN No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,6,'Fil_CmpInvno','Company Invoice Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,7,'FilDisp_FromDate','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,8,'FilDisp_ToDate','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,9,'FilDisp_Company','ALL',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,10,'FilDisp_Supplier','ALL',1,9)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,11,'FilDisp_GRNNumber','ALL',1,173)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,12,'FillDisp_CmpInvno','ALL',1,174)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,13,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,14,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (240,15,'Cap Print Date','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=240
GO
DELETE FROM RptFilter WHERE RptId=240
GO
--KRPL
DELETE FROM RptGroup WHERE RptId=241
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('LoadingSheetReport 10',241,'BillProductWiseLoadingSheet','BillWise ProductWise Loading Sheet',0)
GO
DELETE FROM RptHeader WHERE RptId=241
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('BillProductWiseLoadingSheet','BillWise ProductWise Loading Sheet','241','BillWise ProductWise Loading Sheet','Proc_RptBillwiseProductwiseLsheet','RptBPWiseLSheet','RptBillProductWiseLSheet.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=241
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,3,'SalesInvoice',-1,'','SalId,SalInvRef,SalInvNo','From Bill No...','',1,'',14,1,0,'Press F4/Double Click to select From Bill',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,4,'SalesInvoice',-1,'','SalId,SalInvRef,SalInvNo','To Bill No...','',1,'',15,1,0,'Press F4/Double Click to select To Bill',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,5,'Vehicle',-1,'','VehicleId,VehicleCode,VehicleRegNo','Vehicle...','',1,'',36,0,0,'Press F4/Double Click to Select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,6,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,0,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,7,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,0,0,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,8,'RouteMaster',-1,'','RMId,RMCode,RMName','Delivery Route...','',1,'',35,0,0,'Press F4/Double Click to Select Delivery Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (241,9,'Retailer',-1,0,'RtrId,RtrCode,RtrName','Retailer...',0,1,0,3,0,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=241
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,2,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,3,'Fil_Vehicle','Vehicle',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,4,'Fil_VehAllNo','Vehicle Allocation No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,5,'Fil_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,6,'Fil_DlvRoute','Delivery Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,7,'Fil_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,8,'FilDisp_FromDate','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,9,'FilDisp_ToDate','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,10,'FilDisp_Vehicle','ALL',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,11,'FilDisp_VehAllNo','ALL',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,12,'FilDisp_Salesman','ALL',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,13,'FilDisp_DlvRoute','ALL',1,35)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,14,'FilDisp_Retailer','ALL',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,15,'Dis_FromBill','From Bill',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,16,'Fill_FromBill','16',1,14)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,17,'Dis_ToBill','To Bill',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,18,'Fill_ToBill','Bill No(s).      :',1,15)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,19,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,20,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (241,21,'Cap Print Date','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=241
GO
DELETE FROM RptFilter WHERE RptId=241
GO
--Parle Exsiting report id changes
DELETE FROM Rptgroup WHERE RptId=242
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('SchemeNClaimReport',242,'SubStockistClaimDetails','Sub Stockist Claim Details',1)
GO
DELETE FROM RptHeader WHERE RptId=242
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('SubStockistClaimDetails','Sub Stockist Claim Details','242','Sub Stockist Claim Details','Proc_RptSubStockistClaimSettlement','RptSubStkClaimDetails','RptSubStkClaimSettlement.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=242
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (242,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,NULL,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (242,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (242,3,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Sub Stockist(Retailer)...',NULL,1,NULL,3,NULL,NULL,'Press F4/Double Click to Select Claim Group',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (242,4,'ClaimGroupMaster',-1,NULL,'ClmGrpId,ClmGrpCode,ClmGrpName','Claim Type...',NULL,1,NULL,42,NULL,NULL,'Press F4/Double Click to Select Claim Type',0)
GO
DELETE FROM RptFormula WHERE RptId=242
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,1,'ClaimDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,2,'CmpRtrCode','Retailer Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,3,'ClaimType','Claim Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,4,'ClaimRefNo','Claim Ref No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,5,'ClaimAmt','Claim Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,6,'CreditNoteNo','Credit Note No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,7,'SettledDate','Settled Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,8,'CrNoteAmt','Settled Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,9,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,10,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,11,'Fil_ClaimType','Claim Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,12,'Fil_Retailer','SubStockist',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,13,'FilDisp_FromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,14,'FilDisp_ToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,15,'FilDisp_ClaimType','Claim Type',1,42)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,16,'FilDisp_Retailer','SubStockist',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,17,'Cap User Name','User',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,18,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (242,19,'Hd_Total','Grand Total',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=242
GO
DELETE FROM Rptgroup WHERE RptId=243
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('DailyReports',243,'BusinessSummaryReport','Business Summary Report',1)
GO
DELETE FROM RptHeader WHERE RptId=243
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('BusinessSummaryReport','Business Summary Report','243','Business Summary Report','Proc_RptSummarryDetail','RptSummaryDet','RptSummaryDet.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=243
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (243,1,'Fromdate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (243,2,'Todate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,1,'Enter To Date',0)
GO
DELETE FROM RptFormula WHERE RptId=243
GO
DELETE FROM RptExcelHeaders WHERE RptId=243
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,1,'Date','Date',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,2,'NoOfPrimInv','NoOfPrimInv',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,3,'NoOfProdinvoice','NoOfProdinvoice',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,4,'TotInvoiceQty','TotInvoiceQty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,5,'TotRecvQty','TotRecvQty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,6,'NoOfGrnInv','NoOfGrnInv',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,7,'NoOfSalInv','NoOfSalInv',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,8,'NoofOLInv','NoofOLInv',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,9,'NoOfProdSold','NoOfProdSold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,10,'TotSalQty','TotSalQty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,11,'TotSalInvVal','TotSalInvVal',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,12,'TotNoLines','TotNoLines',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,13,'AvgNoofBill','AvgNoofBill',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,14,'AvgLinesPerCall','AvgLinesPerCall',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (243,15,'UsrId','UsrId',1,1)
GO
DELETE FROM RptFilter WHERE RptId=243
GO
DELETE FROM Rptgroup WHERE RptId=245
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',245,'StockandSalesReport-VolumeWise','Stock and Sales Report - Volume Wise',1)
GO
DELETE FROM RptHeader WHERE RptId=245
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ParleReports','Stock and Sales Report - Volume Wise','245','Stock and Sales Report - Volume Wise','Proc_RptStockandSalesVolumeParle','RptStockandSalesVolumeParle','RptStockandSalesVolume_Parle.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=245
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,1,'FromDate',-1,'','','From Date*','',1,0,10,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,2,'ToDate',-1,'','','To Date*','',1,0,11,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,0,4,0,0,'Press F4/Double Click to Select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,4,'Location',-1,0,'LcnId,LcnCode,LcnName','Location...','',1,0,22,0,0,'Press F4/Double Click to Select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,5,'ProductCategoryLevel',3,'CmpId','CmpPrdCtgId,LevelName,CmpPrdCtgName','Product Hierarchy Level...','Company',1,'CmpId',16,1,0,'Press F4/Double Click to Select Product Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,6,'ProductCategoryValue',5,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,0,0,'Press F4/Double Click to Select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,7,'Product',6,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,0,0,'Press F4/Double Click to Select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,8,'RptFilter',-1,0,'FilterId,FilterId,FilterDesc','Product Status','',1,0,24,1,0,'Press F4/Double Click to Product Status',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (245,9,'RptFilter',-1,0,'FilterId,FilterDesc,FilterDesc','Closing Stock Value Based On*...','',1,0,23,1,1,'Press F4/Double Click to Select the Stock Value as per',0)
GO
DELETE FROM RptFormula WHERE RptId=245
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,1,'Cap From Date','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,2,'From Date','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,3,'Cap To Date','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,4,'To Date','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,5,'Cap Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,6,'Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,7,'Cap Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,8,'Location','Location',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,9,'Cap Product Hierarchy Level','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,10,'Product Hierarchy Level','Product Hierarchy Level',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,11,'Cap Product Hierarchy Level Value','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,12,'Product Hierarchy Level Value','Product Hierarchy Level Value',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,13,'Cap Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,14,'Product','Product',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,17,'Cap Product Status','Product Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,18,'Product Status','Product Status',1,24)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,36,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,37,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,38,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (245,44,'Fill_Stockasper','Stock Value as per',1,23)
GO
DELETE FROM RptExcelHeaders WHERE RptId=245
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,2,'PrdDCode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,3,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,4,'PrdBatId','PrdBatId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,5,'PrdBatCode','Batch Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,6,'CmpId','CmpId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,7,'CmpName','Company Name',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,8,'LcnId','LcnId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,9,'LcnName','Location Name',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,10,'OpeneningBox','Opening Stock Box',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,11,'OpeneningPack','Opening Stock Pack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,12,'PurchaseBox','Purchase Box',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,13,'PurchasePack','Purchase Pack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,14,'SalesBox','Sales Box',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,15,'SalesPack','Sales Pack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,16,'AdjustmentBox','Adjustment Box',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,17,'AdjustmentPack','Adjustment Pack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,18,'ClosingStockBox','Closing Stock Box',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,19,'ClosingStockPack','Closing Stock Pack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,20,'ClosingStkValue','Closing Stock Value',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,21,'OpenWeight','OpenWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,22,'PurchaseWeight','PurchaseWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,23,'SalesWeight','SalesWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,24,'AdjustmentWeight','AdjustmentWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,25,'ClosingStockWeight','ClosingStockWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,26,'OpeningStkValue','OpeningStkValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,27,'PurchaseStkValue','PurchaseStkValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,28,'SalesStkValue','SalesStkValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,29,'AdjustmentStkValue','AdjustmentStkValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (245,30,'ClosingStockkValue','ClosingStockkValue',0,1)
GO
DELETE FROM RptFilter WHERE RptId=245
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,24,0,'ALL')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,24,1,'Active')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,24,2,'InActive')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,23,1,'Selling Rate')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,23,2,'List Price')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (245,23,3,'MRP')
GO
DELETE FROM Rptgroup WHERE RptId=246
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',246,'SchemeUtilizationReportparle','Scheme Utilization Report',1)
GO
DELETE FROM RptHeader WHERE RptId=246
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ParleReports','Scheme Utilization Report Parle','246','Scheme Utilization Report ','Proc_RptSchemeUtilization_Parle','RptSchemeUtilizationDet_Parle','RptSchemeUtilizationDet_Parle.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=246
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,1,'FromDate',-1,0,'','From Date*','',1,0,10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,2,'ToDate',-1,0,'','To Date*','',1,0,11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,3,'SchemeMaster',-1,0,'SchId,SchCode,SchDsc','Scheme Master...','',1,0,8,0,0,'Press F4/Double Click to select Scheme',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,4,'Salesman',-1,0,'SMId,SMCode,SMName','Salesman...','',1,0,1,0,0,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,5,'RouteMaster',-1,0,'RMId,RMCode,RMName','Route...','',1,0,2,0,0,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,6,'RetailerCategoryLevel',-1,'','CtgLevelId,CtgLevelName,CtgLevelName','Category Level...','',1,'NULL',29,0,0,'Press F4/Double Click to select Category Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,7,'RetailerCategory',6,'CtgLevelId','CtgMainId,CtgCode,CtgName','Category Level Value...','RetailerCategoryLevel',1,'CtgLevelId',30,0,0,'Press F4/Double Click to select Category Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,8,'RetailerValueClass',7,'CtgMainId','RtrClassId,ValueClassCode,ValueClassName','Value Classification...','RetailerCategory',1,'CtgMainId',31,0,0,'Press F4/Double Click to select Value Classification',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (246,9,'Retailer',-1,0,'RtrId,RtrCode,RtrName','Retailer...','',1,0,3,0,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=246
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,1,'Applied','Applied',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,2,'Budget Amount','Budget Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,3,'Budget Utilized','Budget Utilized',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,4,'Discount %','Discount % (Amount)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,5,'Flat Amount Discount','Flat Amount Disc.',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,6,'Free Product','Free Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,7,'Free Product Value','Free Product Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,8,'Free Qty','Free Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,9,'From Date','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,10,'From Date Value','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,11,'Gift Product','Gift Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,12,'Gift Qty','Gift Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,13,'Gift Value','Gift Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,14,'Grand Total','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,15,'No Of Bills','No Of Bills',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,16,'No Of Retailers Billed','No Of Retailers Billed',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,17,'Not Applied','Not',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,18,'Points','Points',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,19,'Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,20,'Retailer Value','',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,21,'Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,22,'Route Value','',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,23,'SalesMan','SalesMan',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,24,'Salesman Value','',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,25,'Scheme','Scheme',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,26,'Scheme Description','Scheme Description',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,27,'Scheme Value','',1,8)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,28,'Slab','Slab',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,29,'To Date','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,30,'To Date Value','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,31,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,32,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,33,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,34,'Fil_CategoryLevel','Category Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,34,'Disp_CategoryLevel','Category Level',1,29)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,35,'Disp_CategoryLevelValue','Category Level Value',1,30)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,35,'Fil_CategoryLevelValue','Category Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,36,'Fil_Value Classification','Value Classification',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (246,36,'Disp_Value Classification','Value Classification',1,31)
GO
DELETE FROM RptExcelHeaders WHERE RptId=246
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,1,'SchId','SchId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,2,'SchCode','SchCode',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,3,'SchDesc','SchDesc',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,4,'CircularNo','CircularNo',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,5,'SlabId','Slab',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,6,'SchemeBudget','Scheme Budget',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,7,'BudgetUtilized','BudgetUtilized',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,8,'NoOfRetailer','NoOfRetailerBilled',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,9,'NoOfBills','NoOfBillsApplied',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,10,'UnSELECTedCnt','NoOfBillsNotApplied',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,11,'BaseQtyBox','BaseQtyBox',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,12,'BaseQtyPack','BaseQtyPack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,13,'DiscountPer','Scheme Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,14,'FreePrdName','Free ProductName',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,15,'FreeQty','Free Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,16,'FreeValue','Free Qty Value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,17,'FlatAmount','FlatAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,18,'Points','Points',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,19,'BaseQty','BaseQty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,20,'GiftPrdName','GiftPrdName',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,21,'GiftQty','GiftQty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,22,'GiftValue','GiftValue',0,1)
GO
DELETE FROM ReportFilterDt WHERE RptId=246
GO
DELETE FROM Rptgroup WHERE RptId=247
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',247,'ProductWiseSalesReportParle','Product Wise Sales Report',1)
GO
DELETE FROM RptHeader WHERE RptId=247
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ProductWiseSalesReportParle','Product Wise Sales Report','247','Product Wise Sales Report','Proc_RptProductWiseSalesParle','RptProductWiseDetailParle','RptProductWiseSalesParle.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=247
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,NULL,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,3,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company...',NULL,1,NULL,4,1,NULL,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,4,'Location',-1,NULL,'LcnId,LcnCode,LcnName','Location...',NULL,1,NULL,22,NULL,NULL,'Press F4/Double Click to select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,5,'Salesman',-1,NULL,'SMId,SMCode,SMName','Salesman...',NULL,1,NULL,1,NULL,NULL,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,6,'RouteMaster',-1,NULL,'RMId,RMCode,RMName','Route...',NULL,1,NULL,2,NULL,NULL,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,7,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer Group...',NULL,1,NULL,215,NULL,NULL,'Press F4/Double Click to select Retailer Group',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,8,'Retailer',-1,NULL,'RtrId,RtrCode,RtrName','Retailer...',NULL,1,NULL,3,NULL,NULL,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,9,'ProductCategoryLevel',3,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,NULL,'Press F4/Double Click to select Product Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,10,'ProductCategoryValue',9,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,NULL,NULL,'Press F4/Double Click to select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,11,'Product',10,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,NULL,NULL,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,12,'ProductBatch',-1,NULL,' PrdBatId,PrdBatCode,PrdBatCode','Batch...',NULL,1,NULL,7,0,NULL,'Press F4/Double Click to select Batch ',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,13,'SalesInvoice',-1,NULL,'SalId,SalInvRef,SalInvNo','Bill No...',NULL,1,NULL,14,NULL,NULL,'Press F4/Double Click to select Bill No',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,14,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc ','Display Cancelled Product Value*...',NULL,1,NULL,193,1,1,'Press F4/Double Click to select Display Cancelled Product Values',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,15,'Vehicle',-1,'','VehicleId,VehicleCode,VehicleRegNo','Vehicle...','',1,'',36,0,0,'Press F4/Double Click to Select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (247,16,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,0,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
GO
DELETE FROM RptFormula WHERE RptId=247
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,1,'ProductCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,2,'ProductName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,3,'BatchNo','Batch Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,4,'MRP','MRP',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,5,'SellingRate','Selling Rate',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,6,'SalesQuantity','Sales Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,7,'FreeQuantity','Free Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,8,'ReplacementQuantity','Rep. Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,9,'SalesValue','Gross Amt',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,10,'FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,11,'ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,12,'Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,13,'Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,14,'Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,15,'Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,16,'ProductCategoryLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,17,'ProductCategoryValue','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,18,'BillNumber','Bill Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,19,'Total','Grand Total ',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,20,'Disp_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,21,'Disp_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,22,'Disp_Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,23,'Disp_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,24,'Disp_Route','Route',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,25,'Disp_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,26,'Disp_ProductCategoryLevel','ProductCategoryLevel',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,27,'Disp_ProductCategoryValue','ProductCategoryLevelValue',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,28,'Disp_BillNumber','BillNumber',1,14)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,29,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,30,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,31,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,32,'Cap_Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,33,'Disp_Product','Product',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,34,'Disp_Cancelled','Display Cancelled Bill Value',1,193)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,35,'Fill_Cancelled','Display Cancelled Product Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,36,'Cap_RetailerGroup','Retailer Group',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,37,'Disp_RetailerGroup','Retailer Group',1,215)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,38,'Cap_Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,39,'Disp_Location','Location',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,40,'Cap_Batch','Batch',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,41,'Disp_Batch','Batch',1,7)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,42,'ReturnQuantity','Ret.Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,43,'Disp_Vehicle','Vehicle',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,44,'Disp_VehicleAlloNumber','Vehicle Allocation No',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,45,'Fill_Vehicle','Vehicle Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,46,'Fill_VehicleAlloNumber','Vehicle Allocation Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (247,47,'SchValue','Sch Amount',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=247
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,2,'PrdDCode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,3,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,4,'PrdBatId','PrdBatId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,5,'PrdBatCode','Batch Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,6,'MrpRate','MRP',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,7,'SellingRate','Selling Rate',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,8,'SalesQty','Sales Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,9,'FreeQty','Free Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,10,'ReplaceQty','Replace Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,11,'ReturnQty','Return Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,12,'SchValue','Scheme Value',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,13,'SalesValue','Sales Value',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,14,'SalesPrdWeight','Sales PrdWeight',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,15,'FreePrdWeight','FreeQty PrdWeight',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,16,'RepPrdWeight','ReplacementQty PrdWeight',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (247,17,'RetPrdWeight','ReturnQty PrdWeight',1,1)
GO
DELETE FROM RptFilter WHERE RptId=247
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (247,193,1,'NO')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (247,193,2,'YES')
GO
DELETE FROM Rptgroup WHERE RptId=248
INSERT INTO Rptgroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',248,'DayEndCollection','Day End Collection Report',1)
GO
DELETE FROM RptHeader WHERE RptId=248
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('DAY End Collection','Day End Collection Report','248','Day End Collection Report','Proc_RptDayEndCollection','RptDayEndCollection','RptDayEndCollection.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=248
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,3,'Vehicle',-1,'','VehicleId,VehicleCode,VehicleRegNo','Vehicle...','',1,'',36,0,0,'Press F4/Double Click to Select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,4,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,0,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,5,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,0,0,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,6,'RouteMaster',-1,'','RMId,RMCode,RMName','Delivery Route...','',1,'',35,0,0,'Press F4/Double Click to Select Delivery Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (248,7,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,0,3,0,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=248
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,2,'FilDisp_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,3,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,4,'FilDisp_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,5,'Fil_Vehicle','Vehicle',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,6,'FilDisp_Vehicle','Vehicle',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,7,'Fil_VehAllNo','Vehicle Allocation No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,8,'FilDisp_VehAllNo','Vehicle Allocation No',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,9,'Fil_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,10,'FilDisp_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,11,'Fil_DlvRoute','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,12,'FilDisp_DlvRoute','Route',1,35)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,13,'Fil_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (248,14,'FilDisp_Retailer','Retailer',1,3)
GO
DELETE FROM RptExcelHeaders WHERE RptId=248
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,1,'vehno','vehno',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,2,'SalId','SalId',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,3,'SalInvNo','Bill Number',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,4,'SalInvDate','Bill Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,5,'SalInvRef','SalInvRef',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,6,'InvRcpNo','InvRcpNo',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,7,'InvRcpDate','Collection Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,8,'RtrId','RtrId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,9,'RtrName','Retailer Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,10,'BillAmount','Bill Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,11,'CurPayAmount','Paid Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,12,'CrAdjAmount','CrAdjAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,13,'DbAdjAmount','DbAdjAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,14,'CashDiscount','Cash Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,15,'CollCashAmt','Cash ',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,16,'CollChqAmt','Cheque',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,17,'CollDDAmt','CollDDAmt',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,18,'CollRTGSAmt','CollRTGSAmt',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,19,'BalanceAmount','Balance Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,20,'CollectedAmount','CollectedAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,21,'PayAmount','PayAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,22,'TotalBillAmount','TotalBillAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,23,'CashBill','CashBill',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,24,'Chequebill','Chequebill',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,25,'DDBill','DDBill',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,26,'RTGSBill','RTGSBill',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,27,'AdjustedAmt','Adjusted Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (248,28,'TotalBills','TotalBills',0,1)
GO
DELETE FROM Rptgroup WHERE RptId=249
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',249,'CurrentStockReportParle','Current Stock Report',1)
GO
DELETE FROM RptHeader WHERE RptId=249
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('CurrentStockReportParle','Current Stock Report','249','Current Stock Report','Proc_RptCurrentStockParle','RptCurrentStockParle','RptCurrentStockParle.rpt',' ')
GO
DELETE FROM RptDetails WHERE RptId=249
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,1,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company...',NULL,1,NULL,4,1,NULL,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,2,'Location',-1,NULL,'LcnId,LcnCode,LcnName','Location...',NULL,1,NULL,22,NULL,NULL,'Press F4/Double Click to select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,3,'ProductCategoryLevel',1,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,NULL,'Press F4/Double Click to select Product Hierarchy Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,4,'ProductCategoryValue',3,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,NULL,NULL,'Press F4/Double Click to select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,5,'Product',4,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,NULL,NULL,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,6,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Stock Value as per*...',NULL,1,NULL,23,1,1,'Press F4/Double Click to select Stock Value',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,7,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Product Status...',NULL,1,NULL,24,1,NULL,'Press F4/Double Click to select Product Status',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,8,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Batch Status...',NULL,1,NULL,25,1,NULL,'Press F4/Double Click to select Batch Status',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,9,'ProductBatch',-1,NULL,'PrdBatId,PrdBatCode,PrdBatCode','Batch...',NULL,1,NULL,7,0,NULL,'Press F4/Double Click to select Batch ',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,10,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Suppress Zero Stock*...',NULL,1,NULL,44,1,1,'Press F4/Double Click to Select the Supress Zero Stock',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (249,11,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Stock Type...',NULL,1,NULL,240,1,0,'Press F4/Double Click to Select Stock Type',0)
GO
DELETE FROM RptFormula WHERE RptId=249
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,1,'Product Code','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,2,'Product Name','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,3,'Batch Code','Batch Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,4,'MRP','MRP',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,5,'Saleable Stock','Saleable Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,6,'Unsaleable Stock','Unsaleable Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,7,'Offer Stock','Offer Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,8,'Sal Stock Value','Salable',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,9,'Unsal Stock Value','UnSalable',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,10,'Tot Stock Value','TotalValue',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,11,'Fil_Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,12,'Fil_Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,13,'Fil_PrdCtgLvl','Product Category Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,14,'Fil_PrdCtgValue','Product Category Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,15,'Fil_Prd','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,16,'Fil_StockValue','Stock Value as per',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,17,'Fil_PrdStatus','Product Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,18,'Fil_BatStatus','Batch Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,19,'FilDisp_Company','ALL',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,20,'FilDisp_Location','ALL',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,21,'FilDisp_PrdCtgLvl','ALL',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,21,'FilDisp_PrdCtgValue','ALL',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,23,'FilDisp_Prd','ALL',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,24,'FilDisp_StockValue','Selling Rate with Tax',1,23)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,25,'FilDisp_PrdStatus','ALL',1,24)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,26,'FilDisp_BatStatus','ALL',1,25)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,27,'DisplayRate','Rate',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,28,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,29,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,30,'Hd_Total','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,31,'Cap_Batch','Batch',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,32,'Disp_Batch','Batch',1,7)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,33,'Disp_SupZeroStock','Suppress Zero Stock',1,44)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,34,'Fill_SupZeroStock','Suppress Zero Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,35,'Disp_StockType','Stock Type',1,240)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (249,36,'Fill_StockType','Stock Type',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=249
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,2,'PrdDcode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,3,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,4,'PrdBatId','PrdBatId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,5,'PrdBatCode','Batch Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,6,'MRP','MRP',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,7,'DisplayRate','Rate',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,8,'SaleableBOX','Saleable BOX',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,9,'SaleablePKT','Saleable PKT',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,10,'UnSaleableBOX','Unsaleable BOX',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,11,'UnSaleablePKT','Unsaleable PKT',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,12,'OfferBOX','Offer BOX',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,13,'OfferPKT','Offer PKT',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,14,'DisplaySalRate','Saleable',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,15,'DisplayUnSalRate','UnSaleable',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,16,'DisplayTotRate','TotaleValue',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (249,17,'StockType','StockType',0,1)
GO
DELETE FROM RptFilter WHERE RptId=249
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,24,0,'ALL')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,24,1,'Active')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,24,2,'InActive')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,25,0,'ALL')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,25,2,'Active')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,25,1,'InActive')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,23,1,'Selling Rate')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,23,2,'List Price')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,23,3,'MRP')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,28,1,'Yes')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,28,2,'No')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,44,1,'Yes')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,44,2,'No')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,240,1,'Saleable')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,240,2,'UnSaleable')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (249,240,3,'Offer')
GO
DELETE FROM Rptgroup WHERE RptId=250
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',250,'VatSummaryReport','Vat Summary Report',1)
GO
DELETE FROM RptHeader WHERE RptId=250
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('Vat Summary','Vat Summary Report','250','Vat Summary Report','Proc_RptVatSummary_Parle','RptVatsummary','RptVatSummary.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=250
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (250,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (250,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (250,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Vat Type*...','',1,'',275,1,1,'Press F4/Double Click to Select Type',0)
GO
DELETE FROM RptFormula WHERE RptId=250
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,1,'Disp_Fromdate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,2,'Fill_Fromdate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,3,'Disp_Todate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,4,'Fill_Todate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,5,'Disp_InvoiceType','Invoice Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (250,6,'Fill_InvoiceType','Invoice Type',1,275)
GO
DELETE FROM RptExcelHeaders WHERE RptId=250
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,1,'InvDate','Invoice Date',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,2,'GrossAmount','GrossAmont',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,3,'Discount','Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,4,'Scheme','Scheme',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,5,'Damage','Damage',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (250,6,'AddLess','AddLess',0,1)
GO
DELETE FROM RptFilter WHERE RptId=250
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (250,275,0,'Sales')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (250,275,1,'Purchase')
GO
DELETE FROM Rptgroup WHERE RptId=251
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',251,'ProductWiseLoadingSheetParle','Loading Sheet Item-Wise',1)
GO
DELETE FROM RptHeader WHERE RptId=251
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ParleReports','Loading Sheet Item-Wise','251','Loading Sheet - Item Wise','Proc_RptLoadSheetItemWiseParle','RptLoadSheetItemWiseParle','RptLoadSheetItemWiseParle.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=251
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,3,'Vehicle',-1,'','VehicleId,VehicleCode,VehicleRegNo','Vehicle...','',1,'',36,0,0,'Press F4/Double Click to Select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,4,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,0,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,5,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,0,0,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,6,'RouteMaster',-1,'','RMId,RMCode,RMName','Delivery Route...','',1,'',35,0,0,'Press F4/Double Click to Select Delivery Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,7,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer Group...','',1,'',215,0,0,'Press F4/Double Click to select Retailer Group',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,8,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,0,0,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,9,'SalesInvoice',-1,'','SalId,SalInvRef,SalInvNo','From Bill No...','',1,'',14,1,0,'Press F4/Double Click to select From Bill No',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (251,10,'SalesInvoice',-1,'','SalId,SalInvRef,SalInvNo','To Bill No...','',1,'',15,1,0,'Press F4/Double Click to select To Bill No',0)
GO
DELETE FROM RptFormula WHERE RptId=251
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,2,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,3,'Fil_Vehicle','Vehicle',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,4,'Fil_VehAllNo','Vehicle Allocation No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,5,'Fil_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,6,'Fil_DlvRoute','Delivery Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,7,'Fil_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,8,'FilDisp_FromDate','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,9,'FilDisp_ToDate','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,10,'FilDisp_Vehicle','ALL',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,11,'FilDisp_VehAllNo','ALL',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,12,'FilDisp_Salesman','ALL',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,13,'FilDisp_DlvRoute','ALL',1,35)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,14,'FilDisp_Retailer','ALL',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,15,'PrdCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,16,'PrdName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,17,'BatCode','Bat Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,18,'BilledQty','Billed Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,19,'FreeQty','Free Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,20,'RtnQty','Return Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,21,'RepQty','Replacement Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,22,'TotQty','Total Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,23,'GrandTotal','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,24,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,25,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,26,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,27,'Fil_DisplayIn','Display In',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,28,'FilDisp_DisplayIn','Display In',1,129)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,29,'Cap_RetailerGroup','Retailer Group',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,30,'Disp_RetailerGroup','Retailer Group',1,215)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,31,'MRP','MRP',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,32,'Fill_FromBill','1',1,14)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,33,'Dis_ToBill','P11035407',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (251,34,'Fill_ToBill','Bill No(s).      :',1,15)
GO
DELETE FROM RptExcelHeaders WHERE RptId=251
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,1,'SalId','SalId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,2,'BillNo','BillNo',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,3,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,4,'PrdBatId','PrdBatId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,5,'Product Code','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,6,'Product Description','Product Description',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,7,'PrdCtgValMainId','PrdCtgValMainId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,8,'CmpPrdCtgId','CmpPrdCtgId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,9,'Batch Number','Batch Number',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,10,'MRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,11,'Selling Rate','Selling Rate',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,12,'BilledQtyBox','BilledQtyBox',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,13,'BilledQtyPouch','BilledQtyPouch',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,14,'BilledQtyPack','BilledQtyPack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,15,'Total Qty','Total Qty(in PKTS)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,16,'TotalQtyBox','TotalQtyBox',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,17,'TotalQtyPouch','TotalQtyPouch',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,18,'TotalQtyPack','TotalQtyPack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,19,'Free Qty','Free Qty in(PKTS)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,20,'Return Qty','Return Qty in(PKTS)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,21,'Replacement Qty','Replacement Qty in(PKTS)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,22,'PrdWeight','PrdWeight',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,23,'Billed Qty','Billed Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,24,'GrossAmount','GrossAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,25,'PrdSchemeDisc','Scheme Discount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,26,'TaxAmount','Tax Amount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,27,'NETAMOUNT','NETAMOUNT',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,28,'TotalBills','TotalBills',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,29,'TotalDiscount','TotalDiscount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,30,'OtherAmt','OtherAmt',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,31,'AddReduce','AddReduce',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (251,32,'Damage','Damage',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=252
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',252,'EFFECTIVECOVERAGEANALYSISREPORTPARLE','Effective Coverage Analysis Report',1)
GO
DELETE FROM RptHeader WHERE RptId=252
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('EFFECTIVECOVERAGEANALYSISREPORTPARLE','Effective Coverage Analysis Report','252','Effective Coverage Analysis Report','Proc_RptECAnalysisReportParle','RptECAnalysisReportParle','RptECAnalysisRouteReportParle.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=252
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company*...','',1,'',4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,4,'SalesMan',-1,'','SMId,SMCode,SMName','SalesMan...','',1,'',1,1,0,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,5,'RouteMaster',-1,'','RMId,RMCode,RMName','Route...','',1,'',2,0,0,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,6,'RetailerCategoryLevel',3,'CmpId','CtgLevelId,CtgLevelName,CtgLevelName','Retailer Category Level...','Company',1,'CmpId',29,1,0,'Press F4/Double Click to Retailer Category Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,7,'RetailerCategory',6,'CtgLevelId','CtgMainId,CtgName,CtgName','Retailer Category Level Value...','RetailerCategoryLevel',1,'CtgLevelId',30,1,NULL,'Press F4/Double Click to Retailer Category Level Value',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,8,'RetailerValueClass',7,'CtgMainId','RtrClassId,ValueClassName,ValueClassName','Retailer Value Classification...','RetailerCategory',1,'CtgMainId',31,1,NULL,'Press F4/Double Click to select Retailer Value Classification',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,9,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer Group...','',1,'',215,0,NULL,'Press F4/Double Click to select Retailer Group',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,10,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,0,NULL,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,11,'ProductCategoryLevel',3,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,NULL,'Press F4/Double Click to select Product Hierarchy Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,12,'ProductCategoryValue',11,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,NULL,NULL,'Press F4/Double Click to select Product Hierarchy Level Value',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,13,'Product',12,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,NULL,NULL,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (252,14,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Display Based On*...','',1,'',246,1,1,'Press F4/Double Click to select Display Based on',1)
GO
DELETE FROM RptFormula WHERE RptId=252
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,1,'FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,2,'ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,3,'Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,4,'Salesman','Salesman Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,5,'Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,6,'CatLevel','Retailer Category Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,7,'CatVal','Retailer Category Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,8,'ValClass','Retailer Value Classification',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,9,'Cap_RetailerGroup','Retailer Group',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,10,'Cap_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,11,'PrdLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,12,'ProductCategoryValue','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,13,'Cap_Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,14,'Dis_FromDate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,15,'Dis_ToDate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,16,'Dis_Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,17,'Dis_SalesMan','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,18,'Dis_Route','Route',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,19,'Disp_CategoryLevel','Retailer Category Level',1,29)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,20,'Disp_CategoryLevelValue','Retailer Category Level Value',1,30)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,21,'Disp_ValueClassification','Retailer Value Classification',1,31)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,22,'Disp_RetailerGroup','Retailer Group',1,215)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,23,'Disp_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,24,'Dis_PrdLevel','Product Hierarchy Level',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,25,'Dis_PrdLvlValue','Product Hierarchy Level Value',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,25,'Fill_BasedOn','Display Based On',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,25,'Dis_BasedOn','Display Based On',1,246)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,26,'Disp_Product','Product',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,27,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (252,28,'Cap Print Date','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=252
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,1,'Code','Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,2,'Name','Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,3,'TotalOutlets','TotalOutlets',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,4,'TotalOutletBilled','TotalOutletBilled',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,5,'SaleableBOX','SaleableBOX',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,6,'SaleablePKT','SaleablePKT',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,7,'SalesValue','SalesValue',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,8,'EC','Effective Coverage',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,9,'TLS','Total Line Sold',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (252,10,'BasedOn','BasedOn',0,1)
GO
DELETE FROM RptFilter WHERE RptId=252
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (252,246,1,'Product')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (252,246,2,'Route')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (252,246,3,'Retailer')
GO
DELETE FROM Rptgroup WHERE RptId=253
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',253,'MonthlyVatSummaryReport','Monthly Vat Summary Report',1)
GO
DELETE FROM RptHeader WHERE RptId=253
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('Monthly Vat Summary','Monthly Vat Summary Report','253','Monthly Vat Summary Report','Proc_RptMonthlyVatSummary_Parle','RptMonthlyVatSummary','RptMonthlyVatSummary.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=253
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (253,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (253,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (253,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Vat Type*...','',1,'',275,1,1,'Press F4/Double Click to Select Type',0)
GO
DELETE FROM RptFormula WHERE RptId=253
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,1,'Disp_Fromdate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,2,'Fill_Fromdate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,3,'Disp_Todate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,4,'Fill_Todate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,5,'Disp_InvoiceType','Invoice Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (253,6,'Fill_InvoiceType','Invoice Type',1,275)
GO
DELETE FROM RptFilter WHERE RptId=253
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (253,275,0,'Sales')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (253,275,1,'Purchase')
GO
DELETE FROM Rptgroup WHERE RptId=254
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',254,'ClosingStockReportParle','Closing Stock Report',1)
GO
DELETE FROM RptHeader WHERE RptId=254
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ClosingStockReportParle','ClosingStockReportParle','254','Closing Stock Report','Proc_RptClosingStockReportParle','RptClosingStockParle','RptClosingStockParle.rpt',NULL)
GO
DELETE FROM RptDetails WHERE RptId=254
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,1,'ToDate',-1,NULL,'','As On Date*',NULL,1,NULL,11,0,0,'Enter the  Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,2,'Company',-1,NULL,'CmpId,CmpCode,CmpName','Company*...',NULL,1,NULL,4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,3,'Location',-1,NULL,'LcnId,LcnCode,LcnName','Location...',NULL,1,NULL,22,1,0,'Press F4/Double Click to select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,4,'ProductCategoryLevel',2,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,0,'Press F4/Double click to select Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,5,'ProductCategoryValue',4,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,0,0,'Press F4/Double Click to select Product Hierarchy Level Value',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,6,'Product',5,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,0,0,'Press F4/Double click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,7,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Stock Value as per*...',NULL,1,NULL,209,1,1,'Press F4/Double Click to select Stock Value as per',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,8,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Product Status...',NULL,1,NULL,210,1,0,'Press F4/Double Click to select Product Status',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,9,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Batch Status...',NULL,1,NULL,211,1,0,'Press F4/Double Click to select Batch Status',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,10,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Suppress Zero Stock*...',NULL,1,NULL,44,1,1,'Press F4/Double Click to Select the Supress Zero Stock',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (254,11,'StockType',3,'LcnId','StockTypeId,UserStockType,UserStockType','Stock Type...','Location',1,'LcnId',291,1,0,'Press F4/Double Click to Select the Stock Type',0)
GO
DELETE FROM RptFormula WHERE RptId=254
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,1,'Disp_ToDate','As On Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,2,'Fill_ToDate','As On Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,3,'Disp_Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,4,'Fill_Company','Company',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,5,'Disp_Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,6,'Fill_Location','Location',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,7,'Disp_ProductCategoryLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,8,'Fill_ProductCategoryLevel','ProductCategoryLevel',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,9,'Disp_ProductCategoryValue','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,10,'Fill_ProductCategoryValue','ProductCategoryLevelValue',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,11,'Disp_Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,12,'Fill_Product','Product',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,13,'Disp_Batch','Stock Value as per',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,14,'Fill_Batch','Stock Value as per',1,209)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,15,'Disp_ProductStatus','Product Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,16,'Fill_ProductStatus','Product Status',1,210)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,17,'Disp_BatchStatus','Batch Status',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,18,'Fill_BatchStatus','Batch Status',1,211)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,19,'Disp_ProductDes','Product Description',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,20,'Disp_BatchT','Batch',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,21,'Disp_MRP','MRP',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,22,'Disp_RATE','Display Rate',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,23,'BOXES','BOXES',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,24,'Disp_StockValues','Gross Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,25,'PKTS','PKTS',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,26,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,27,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,28,'Disp_SupZeroStock','Suppress Zero Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,29,'Fill_SupZeroStock','Suppress Zero Stock',1,44)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,30,'Product Name','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,30,'Disp_Total','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,31,'ProductCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,32,'Disp_StockType','Stock Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (254,33,'Fill_StockType','Stock Type',1,291)
GO
DELETE FROM RptExcelHeaders WHERE RptId=254
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,2,'PrdDCode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,3,'PrdName','Product Description',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,4,'MRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,5,'RATE','RATE',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,6,'BOXES','BOXES',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,7,'PKTS','PKTS',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (254,8,'StockValue','Stock Value',1,1)
GO
DELETE FROM RptFilter WHERE RptId=254
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,209,1,'Selling Rate')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,209,2,'List Price')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,210,0,'ALL')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,210,1,'Active')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,210,2,'InActive')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,211,0,'ALL')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,211,2,'Active')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,211,1,'InActive')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,44,1,'Yes')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (254,44,2,'No')
GO
DELETE FROM Rptgroup WHERE RptId=255
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',255,'SupplierAccountStatement','Supplier Accounts Statement',1)
GO
DELETE FROM RptHeader WHERE RptId=255
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('SupplierAccountStatement','Supplier Accounts Statement','255','Supplier Accounts Statement','Proc_RptSupplierAccountStatement','RptSupplierAccountStatement','RptSupplierAccountStatement.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=255
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (255,1,'FromDate',-1,'','','From Date*','',1,'',10,1,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (255,2,'ToDate',-1,'','','To Date*','',1,'',11,1,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (255,3,'Supplier',-1,'','SpmId,SpmCode,SpmName','Supplier*...','',1,'',9,1,1,'Press F4/Double Click to Select Supplier',0)
GO
DELETE FROM RptFormula WHERE RptId=255
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,1,'SlNo','SlNo',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,2,'RcpDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,3,'DocumentNo','Document No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,4,'Particulars','Particulars',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,5,'ReferenceNo','Reference No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,6,'DebitAmt','Debit Amt',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,7,'CreditAmt','Credit Amt',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,8,'BalanceAmt','Balance Amt',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,9,'SupplierName','Sup Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,10,'SupplierAddress','Sup Address',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,11,'TINNo','TINNo',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,12,'Period','Period',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,13,'Dis_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,14,'Dis_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,15,'Cap_UserName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,16,'Cap_PrintDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,17,'Cap_To','to',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,18,'SupplierCode','Supplier Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (255,19,'PhoneNo','Ph-',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=255
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,1,'SlNo','SlNo',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,2,'SpmId','SpmId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,3,'CoaId','CoaId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,4,'SpmName','Sup Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,5,'SpmAddress','Sup Address',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,6,'TINNo','Sup TIN No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,7,'RcpDate','Date',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,8,'DocumentNo','Document No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,9,'Details','Particulars',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,10,'RefNo','Reference No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,11,'DbAmount','Debit Amt',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,12,'CrAmount','Credit Amt',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (255,13,'BalanceAmount','Balance Amt',1,1)
GO
DELETE FROM Rptgroup WHERE RptId=256
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('ParleReports',256,'VatComputationReport','Vat Computation Report',1)
GO
DELETE FROM RptHeader WHERE RptId=256
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('ParleReports','Vat Computation Report','256','Vat Computation Report','Proc_RptVatComputation','RptVatComputation','RptVatComputation.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=256
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (256,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (256,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (256,3,'ACMaster',-1,'','AcmId,AcmType,AcmYr','F A.','',1,'',149,1,1,'Press F4/Double Click to select Account Year',0)
GO
DELETE FROM RptFormula WHERE RptId=256
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,1,'Display_WsName','Wholesaler Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,2,'Display_WsName1','NK ENTERPRISE',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,3,'Display_WSAdd','Wholesaler Address',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,4,'Display_WsCity','Wholesaler City',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,5,'Display_Period','Period',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,6,'Display_From','From',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,7,'Display_To','To',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,8,'From Date','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,9,'To Date','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,10,'Display_Tin','TIN No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,11,'Display_AY','Assessment Year',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,12,'Display_Det','Details',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,13,'Display_Sal','Sale/Purc.Amt.',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,14,'Display_Tax','Tax',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,15,'Display_Ret','Sale/Pur.Ret.Amount',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,16,'Display_NetAmt','Nett Amt.',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,17,'Display_NetTax','Nett Tax',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,18,'Display_UName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (256,19,'Display_PDate','Print Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=256
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,1,'[Details]','Details',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,2,'[Sale/Purc.Amt.]','Sale/Purc.Amt.',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,3,'[Tax1]','Tax',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,4,'[sale/Pur.Ret.Amount]','Sale/Pur.Ret.Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,5,'[Tax2]','Tax',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,6,'[NettAmt.]','NettAmt.',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,7,'[NettTax]','NettTax',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,8,'[DistName]','DistName',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,9,'[DistAddress]','DistAddress',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,10,'[DistTIN]','DistTIN',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,11,'[DistCity]','DistCity',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (256,12,'[AY]','AY',0,1)
GO
DELETE FROM RptFilter WHERE RptId=256
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (256,278,0,'Sales')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (256,278,1,'Purchase')
GO
--Till here
--PM
DELETE FROM Rptgroup WHERE RptId=244
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('RspReport',244,'SalesmanProductivityReport','Salesman Productivity Report',0)
GO
DELETE FROM RptHeader WHERE RptId=244
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('SalesmanProductivityReport','Salesman Productivity Report','244','Salesman Productivity Report','Proc_RptSalesmanProductivityReport','RptSalesmanProductivityReport','RptSalesmanProductivityReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=244
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (244,1,'FromDate',-1,NULL,'','From Date*',NULL,1,NULL,10,NULL,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (244,2,'ToDate',-1,NULL,'','To Date*',NULL,1,NULL,11,NULL,NULL,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (244,3,'Salesman',-1,NULL,'SMId,SMCode,SMName','Salesman*',NULL,1,NULL,1,0,1,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (244,4,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Report Type*',NULL,1,NULL,69,1,1,'Press F4/Double Click to select Report Type',0)
GO
DELETE FROM RptFormula WHERE RptId=244
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,1,'Disp_Fromdate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,2,'Fill_Fromdate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,3,'Disp_Todate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,4,'Fill_Todate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,5,'Disp_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,6,'Fill_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,7,'Disp_ReportType','Report Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (244,8,'Fill_ReportType','Report Type',1,277)
GO
DELETE FROM RptExcelHeaders WHERE RptId=244
GO
DELETE FROM RptFilter WHERE RptId=244
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (244,69,1,'Summary')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (244,69,2,'Detail')
GO
DELETE FROM Rptgroup WHERE RptId=257
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('PMReports',257,'LoadingSheetProductWiseUOMWise','Loading Sheet - Product Wise UOM Wise',0)
GO
DELETE FROM RptHeader WHERE RptId=257
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('PMReports','LoadingSheetProductWiseUOMWise','257','Loading Sheet - Product Wise UOM Wise','Proc_RptLoadSheetItemWisePM','RptLoadSheetItemWisePM','RptLoadSheetItemWisePM.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=257
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,3,'Vehicle',-1,'','VehicleId,VehicleCode,VehicleRegNo','Vehicle...','',1,'',36,0,0,'Press F4/Double Click to Select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,4,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,0,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,5,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,0,0,'Press F4/Double Click to Select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,6,'RouteMaster',-1,'','RMId,RMCode,RMName','Delivery Route...','',1,'',35,0,0,'Press F4/Double Click to Select Delivery Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,7,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer Group...','',1,'',215,0,0,'Press F4/Double Click to select Retailer Group',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (257,8,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,0,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=257
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,1,'Fil_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,2,'Fil_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,3,'Fil_Vehicle','Vehicle',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,4,'Fil_VehAllNo','Vehicle Allocation No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,5,'Fil_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,6,'Fil_DlvRoute','Delivery Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,7,'Fil_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,8,'FilDisp_FromDate','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,9,'FilDisp_ToDate','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,10,'FilDisp_Vehicle','ALL',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,11,'FilDisp_VehAllNo','ALL',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,12,'FilDisp_Salesman','ALL',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,13,'FilDisp_DlvRoute','ALL',1,35)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,14,'FilDisp_Retailer','ALL',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,15,'PrdCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,16,'PrdName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,17,'BatCode','Bat Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,18,'BilledQty','Billed Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,19,'FreeQty','Free Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,20,'RtnQty','Return Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,21,'RepQty','Replacement Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,22,'TotQty','Total Quantity',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,23,'GrandTotal','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,24,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,25,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,26,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,27,'Fil_DisplayIn','Display In',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,28,'FilDisp_DisplayIn','Display In',1,129)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,29,'Cap_RetailerGroup','Retailer Group',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,30,'Disp_RetailerGroup','Retailer Group',1,215)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (257,31,'MRP','MRP',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=257
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,2,'Product Code','ProductCode',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,3,'Product Description','ProductDescription',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,4,'Batch Number','BatchNumber',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,5,'MRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,6,'Selling Rate','SellingRate',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,7,'SP','SP(SecPack)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,8,'Kg','KG(KiloGram)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,9,'Hg','HG(Hanger)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,10,'St','ST(Stripe)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,11,'EA','EA(Each)',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,12,'TotalKg','ToatlQty in Kg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,13,'Billed Qty','Billed Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,14,'Total Qty','Total Qty in Pieces',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,15,'Return Qty','Return Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,16,'Replacement Qty','Replacement Qty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,17,'GrossAmount','GrossAmount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,18,'TaxAmount','TaxAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,19,'NetAmount','NetAmount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,20,'TotalBills','TotalBills',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (257,21,'Free Qty','Free Qty',0,1)
GO
DELETE FROM Rptgroup WHERE RptId=258
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) 
VALUES ('PMReports',258,'UnLoadingSheetReport','UnLoadingSheetReport',0)
GO
DELETE FROM RptHeader WHERE RptId=258
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) 
VALUES ('UnLoadingSheetReport','UnLoadingSheetReport','258','UnLoadingSheetReport','Proc_RptUnloadingSheetPM','RptUnloadingSheetPM','RptUnloadingSheetPM.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=258
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,1,'FromDate',-1,'','','From Date*','',1,'',10,1,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,2,'ToDate',-1,'','','To Date*','',1,'',11,1,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,3,'Vehicle',-1,'','VehicleID,VehicleCode,VehicleRegNo','Vehicle ...','',1,'',36,1,0,'Press F4/Double Click to select Vehicle',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,4,'VehicleAllocationMaster',-1,'','AllotmentId,AllotmentDate,AllotmentNumber','Vehicle Allocation No...','',1,'',37,1,0,'Press F4/Double Click to Select Vehicle Allocation Number',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,5,'Salesman',-1,'','SMId,SMCode,SMName','Salesman...','',1,'',1,1,0,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,6,'RouteMaster',-1,'','RMId,RMCode,RMName','Delivery Route...','',1,'',35,1,0,'Press F4/Double Click to Select Delivery Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (258,7,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,1,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=258
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,1,'Disp_FromDate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,2,'Fill_FromDate','FromDate',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,3,'Disp_ToDate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,4,'Fill_ToDate','ToDate',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,5,'Disp_Vehicle','Vehicle',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,6,'Fill_Vehicle','Vehicle',1,36)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,7,'Disp_VehicleAlloc','Vehicle Allocation Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,8,'Fill_VehicleAlloc','VehicleAllocationNumber',1,37)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,9,'Disp_Salesman','Salesman',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,10,'Fill_Salesman','Salesman',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,11,'Disp_Route','Route',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,12,'Fill_Route','Route',1,35)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,13,'Disp_Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,14,'Fill_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,15,'Disp_Product','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,16,'Disp_PrdouctName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,17,'Disp_Batch','Batch No',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,18,'Disp_MRP','MRP',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,19,'Disp_Loaded','Loaded Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,20,'Disp_UnLoaded','UnLoaded Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,21,'Disp_BilledQty','Billed',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,22,'Disp_FreeQty','Free',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,23,'Disp_ReplaceQty','Replacement',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,24,'Disp_Saleable','Saleable',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,25,'Disp_UnSaleable','UnSaleable',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,26,'Disp_Offer','Offer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,27,'Cap Page','Page',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,28,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (258,29,'Cap Print Date','Date',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=258
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,1,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,2,'PrdDcode','ProductCode',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,3,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,4,'PrdBatId','PrdBatId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,5,'PrdBatCode','Batch Code',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,6,'PrdUnitMRP','MRP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,7,'PrdUnitSelRate','SellingRate',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,8,'SP','BilledQtySP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,9,'Kg','BilledQtyKg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,10,'Hg','BilledQtyHg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,11,'St','BilledQtySt',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,12,'EA','BilledQtyEach',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,13,'TotalLoadQtyinKg','Toatal LoadingQty in Kg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,14,'LoadBilledQty','Toatal LoadingQty in Pieces',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,15,'LoadReplacementQty','ReplacementQty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,16,'TotalDlvQtyinKg','Toatal DeliveredQty in Kg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,17,'TotalDlvQty','Toatal DeliveredQty in Pieces',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,18,'ReturnSP','ReturnQtySP',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,19,'ReturnKg','ReturnQtyKg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,20,'ReturnHg','ReturnQtyHg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,21,'ReturnSt','ReturnQtySt',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,22,'ReturnEA','ReturnQtyEA',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,23,'TotalReturnQtyinKg','Toatal ReturnQty in Kg',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (258,24,'TotalRetQty','Total ReturnQty in Pieces',1,1)
GO
--Til here
--RptSelectionHD
DELETE FROM RptSelectionHd WHERE SelcId IN (223,224,232,254,256,257,258,259)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (232,'Sel_CreditDays','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (224,'Sel_ProductSeq','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (223,'Sel_ReportType','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (256,'Sel_ReportType','ReportDate Based on',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (257,'Sel_ReportType','Bill No Display  Report',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (254,'Sel_ReportType','Report Type',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (258,'Sel_SchemeDiscr','SchemeMaster',0)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (259,'Sel_ReportType','Report Type',1)
GO
DELETE FROM RptSelectionHd WHERE SelcId IN (240,274,277,278,279)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (240,'Sel_QtyBreakup','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (274,'Sel_PrductCategoryValue','ProductCategoryValue',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (277,'Sel_GroupBy','Rptfilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (278,'Sel_LaunchNo','LaunchTargetHd',0)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (279,'Sel_IDTDistId','IDTManagement',0)
GO
DELETE FROM RptSelectionHd WHERE SelcId IN (292,293,294,295,296)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (292,'Sel_StkType','Stock Type',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (293,'sel_InvoiceType','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (294,'Sel_OrderBy','ReportOrder By Based on',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (295,'Sel_VatType','RptFilter',1)
INSERT INTO RptSelectionHd([SelcId],[SelcName],[TblName],[Condition]) VALUES (296,'Sel_StockType','StockType',0)
GO
--AkzoNobel
DELETE FROM RptGroup WHERE RptId=220
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Akzo Nobel Reports',220,'RetailerandProductWiseSalesVolume','Retailer and Product Wise Sales Volume',0)
GO
DELETE FROM RptHeader WHERE RptId=220
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('RetailerandProductWiseSalesVolume','Retailer and Product Wise Sales Volume','220','Retailer and Product Wise Sales Volume','Proc_RptRtrPrdWiseSales','RptRtrPrdWiseSales','RptRtrPrdWiseSales.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=220
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,'',4,1,0,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,4,'SalesMan',-1,'','SMId,SMCode,SMName','SalesMan...','',1,'',1,1,0,'Press F4/Double Click to select Salesman',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,5,'RouteMaster',-1,'','RMId,RMCode,RMName','Route...','',1,'',2,1,0,'Press F4/Double Click to select Route',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,6,'ProductCategoryLevel',3,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,0,'Press F4/Double Click to select Product Hierarchy Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,7,'ProductCategoryValue',6,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,0,0,'Press F4/Double Click to select Product Hierarchy Level Value',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,8,'Product',7,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,0,0,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,9,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,0,0,'Press F4/Double Click to select Retailer',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (220,10,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Display Level*...','',1,'',260,1,1,'Press F4/Double Click to select Display Level',0)
GO
DELETE FROM RptFormula WHERE RptId=220
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,1,'Rpt_RtrCode','Retailer Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,2,'Rpt_RtrName','Retailer Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,3,'Rpt_PrdCtgLevel','Product Hierarchy Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,4,'Rpt_PrdCtgValue','Product Hierarchy Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,5,'Rpt_PrdCode','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,6,'Rpt_PrdName','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,7,'Rpt_SalesQty','Sales Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,8,'Rpt_SalesVolume','Sales Volume',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,9,'Rpt_SalesValue','Sales Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,10,'Disp_Company','',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,11,'Disp_FromDate','',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,12,'Disp_ToDate','',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,13,'Disp_Salesman','',1,1)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,14,'Disp_Route','',1,2)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,15,'Disp_Retailer','',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,16,'Disp_ProductCategoryLevel','',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,17,'Disp_ProductCategoryValue','',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,18,'Disp_Product','',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,19,'Cap_Display','Display Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,20,'Dis_Display','',1,260)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,21,'CapPrintDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (220,22,'CapUserName','User Name',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=220
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,1,'RtrCode','Retailer Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,2,'RtrName','Retailer Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,3,'CmpPrdCtgName','Product Category Level',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,4,'PrdCtgValName','Product Category Value',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,5,'PrdCCode','Product Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,6,'PrdName','Product Name',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,7,'BaseQty','Sales Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,8,'SalVolume','Sales Volume',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (220,9,'PrdNetAmount','Sales Value',1,1)
GO
DELETE FROM RptFilter WHERE RptId=220
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (220,260,1,'SKU Level')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (220,260,2,'Hierarchy Level')
GO
DELETE FROM RptGroup WHERE RptId=221
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Akzo Nobel Reports',221,'AksoNobalCurrentStock','Akzo Nobel CurrentStock',0)
GO
DELETE FROM RptHeader WHERE RptId=221
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('AksoNobalCurrentStock','AksoNobalCurrentStock','221','Akso Nobal CurrentStock Report','Proc_RptCurrentStockAN','RptCurrentStockAN','RptCurrentStockAN.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=221
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,1,'Company',-1,'','CmpId,CmpCode,CmpName','Company*...','',1,'',4,1,1,'Press F4/Double Click to select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,2,'Location',-1,'','LcnId,LcnCode,LcnName','Location...','',1,'',22,0,0,'Press F4/Double Click to select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,3,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Stock Type...','',1,'',240,1,0,'Press F4/Double Click to Select Stock Type',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,4,'ProductCategoryLevel',1,'CmpId','CmpPrdCtgId,CmpPrdCtgName,LevelName','Product Hierarchy Level...','Company',1,'CmpId',16,1,0,'Press F4/Double Click to select Product Hierarchy Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,5,'ProductCategoryValue',4,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,0,0,'Press F4/Double Click to select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,6,'Product',5,'PrdCtgValMainId','PrdId,PrdDCode,PrdName','Product...','ProductCategoryValue',1,'PrdCtgValMainId',5,0,0,'Press F4/Double Click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,7,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Display Level*...','',1,'',260,1,1,'Press F4/Double Click to select Display Level',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (221,8,'RptFilter',-1,'','FilterId,FilterDesc,FilterDesc','Suppress Zero Stock*...','',1,'',44,1,1,'Press F4/Double Click to Select the Supress Zero Stock',0)
GO
DELETE FROM RptFormula WHERE RptId=221
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,1,'Product Code','Product Code',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,2,'Product Name','Product Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,3,'Saleable Stock','Saleable Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,4,'Unsaleable Stock','Unsaleable Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,5,'Offer Stock','Offer Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,6,'Sal Stock Value','Stock value (Saleable)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,7,'Unsal Stock Value','Stock Value (Unsaleable)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,8,'Tot Stock Value','Stock Value (Total)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,9,'Fil_Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,10,'Fil_Location','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,11,'Fil_PrdCtgLvl','Product Category Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,12,'Fil_PrdCtgValue','Product Category Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,13,'Fil_Prd','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,14,'FilDisp_Company','ALL',1,4)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,15,'FilDisp_Location','ALL',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,16,'FilDisp_PrdCtgLvl','ALL',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,17,'FilDisp_PrdCtgValue','ALL',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,18,'FilDisp_Prd','ALL',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,19,'Cap User Name','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,20,'Cap Print Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,21,'Hd_Total','Grand Total',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,22,'Cap_Batch','Batch',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,23,'Disp_Batch','Batch',1,7)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,24,'Disp_SupZeroStock','Suppress Zero Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,25,'Fill_SupZeroStock','Suppress Zero Stock',1,44)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,26,'Disp_UomBased','Display Uom Based',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,27,'Fill_UomBased','Display Uom Based',1,221)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,28,'Disp_StockType','Stock Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,29,'Fill_StockType','Stock Type',1,240)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,30,'Disp_DisplayLevel','Display Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,31,'Fill_DisplayLevel','Display Level',1,260)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,32,'Product Hierarchy Level Value','Product Hierarchy Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,33,'Description','Description',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,34,'Location Name','Location Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,35,'Stock Type','Stock Type',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,36,'Quantity Packs','Quantity Packs',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,37,'Quantity in Volume(LT/KG/NO)','Quantity in Volume(LT/KG/NO)',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (221,38,'Value','Value',1,0)
GO
DELETE FROM RptFilter WHERE RptId=221
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,260,1,'SKU Level')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,260,2,'Hierarchy Level')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,240,1,'Saleable')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,240,2,'UnSaleable')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,240,3,'Offer')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,44,1,'Yes')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (221,44,2,'No')
GO
DELETE FROM RptGroup WHERE RptId=222
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Akzo Nobel Reports',222,'PartyAccountStatement','Party Account Statement',0)
GO
DELETE FROM RptHeader WHERE RptId=222
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('Akso Nobal Reports','Party Account Statement','222','Party Account Statement','Proc_RptAkzoRetAccStatement','RptAkzoRetAccStatement','RptAkzoRetAccStatement.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=222
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (222,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (222,2,'ToDate',-1,'','','To Date*','',1,'',11,0,1,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (222,3,'Retailer',-1,'','RtrId,RtrCode,RtrName','Retailer...','',1,'',3,1,0,'Press F4/Double Click to select Retailer',0)
GO
DELETE FROM RptFormula WHERE RptId=222
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,1,'Fromdate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,2,'Todate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,3,'Dis_Fromdate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,4,'Dis_Todate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,5,'CapPrintDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,6,'CapUserName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,7,'Retailer','Retailer',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,8,'Dis_Retailer','Retailer',1,3)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,9,'Description','Description',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,10,'DocRefNo','Doc.Ref.Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,11,'Date','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,12,'Debit','Debit',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,13,'Credit','Credit',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,14,'Balance','Balance',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,15,'Remarks','Cheque.No/Ref.No/Trans Details',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (222,16,'CheqDue','Cheque/Due',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=222
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,1,'Description','Description',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,2,'RtrId','RtrId',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,3,'RtrCode','RtrCode',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,4,'RtrName','RtrName',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,5,'DocRefNo','Doc.Ref.Number',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,6,'Date','Date',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,7,'Debit','Debit',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,8,'Credit','Credit',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,9,'Balance','Balance',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,10,'TransactionDet','Cheque.No/Ref.No/Trans Details',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,11,'ChequeorDueDate','Cheque/Due',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,12,'SeqNo','SeqNo',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (222,13,'UserId','UserId',0,0)
GO
DELETE FROM RptGroup WHERE RptId=225
INSERT INTO RptGroup([PId],[RptId],[GrpCode],[GrpName],[VISIBILITY]) VALUES ('Akzo Nobel Reports',225,'StockLedgerReport','Stock Ledger Report',0)
GO
DELETE FROM RptHeader WHERE RptId=225
INSERT INTO RptHeader([GrpCode],[RptCaption],[RptId],[RpCaption],[SPName],[TblName],[RptName],[UserIds]) VALUES ('Akso Nobal Reports','Stock Ledger Report','225','Stock Ledger Report','Proc_RptAkzoStockLedgerReport','RptAkzoStockLedgerReport','RptAkzoStockLedgerReport.rpt','')
GO
DELETE FROM RptDetails WHERE RptId=225
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,3,'Location',-1,'','LcnId,LcnCode,LcnName','Location*...','',1,'',22,0,1,'Press F4/Double Click to Select Location',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,4,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,'',4,1,0,'Press F4/Double Click to Select Company',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,5,'ProductCategoryLevel',4,'CmpId','CmpPrdCtgId,LevelName,CmpPrdCtgName','Product Hierarchy Level...','Company',1,'CmpId',16,1,0,'Press F4/Double click to select Product Hierarchy Level',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,6,'ProductCategoryValue',5,'CmpPrdCtgId','PrdCtgValMainId,PrdCtgValCode,  PrdCtgValName','Product Hierarchy Level Value...','ProductCategoryLevel',1,'CmpPrdCtgId',21,0,0,'Press F4/Double click to select Product Hierarchy Level Value',1)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,7,'Product',6,'PrdCtgValMainId','PrdId,PrdDcode,PrdName','Product*...','ProductCategoryValue',1,'PrdCtgValMainId',5,1,1,'Press F4/Double click to select Product',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (225,8,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Suppress Zero Stock*...',NULL,1,NULL,262,1,1,'Press F4/Double Click to Select the Supress Zero Stock',0)
GO
DELETE FROM RptFormula WHERE RptId=225
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,1,'Fromdate','From Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,2,'Todate','To Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,3,'Dis_Fromdate','From Date',1,10)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,4,'Dis_Todate','To Date',1,11)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,5,'CapPrintDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,6,'CapUserName','User Name',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,7,'Cap_Locaiton','Location',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,8,'Fil_Location','Location',1,22)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,9,'Disp_SupZeroStock','Suppress Zero Stock',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,10,'Fill_SupZeroStock','Suppress Zero Stock',1,262)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,11,'Company','Company',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,12,'CompanyDisp','ALL',1,262)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,13,'PrdLevel','Product Level',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,14,'PrdLevelDisp','ALL',1,21)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,15,'PrdLevelVal','Product Level Value',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,15,'Product','Product',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,16,'ProductDisp','ALL',1,5)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,16,'PrdLevelValDisp','ALL',1,16)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,17,'Dis_TransDate','Date',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,18,'Dis_Transtype','Transaction',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,19,'Dis_TransNo','Transaction Ref.Number',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,20,'SalQty','Salable Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,21,'SalQtyVolume','Salable Qty Volume',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,22,'UnSalQty','UnSalable Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,23,'UnSalQtyVol','UnSalable Qty Volume',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,24,'OfferQty','Offer Qty',1,0)
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) VALUES (225,25,'OfferQtyVol','Offer Qty Volume',1,0)
GO
DELETE FROM RptExcelHeaders WHERE RptId=225
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,1,'TransactionDate','Date',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,2,'TransactionType','Transaction',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,3,'TransactionNumber','Transaction Reference Number',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,4,'SalQty','Salable Qty',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,5,'SalQtyVolume','Salable Qty Volume',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,6,'UnSalQty','UnSalable Qty',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,7,'UnSalQtyVolume','UnSalable Qty Volume',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,8,'OfferQty','Offer Qty',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,9,'OfferQtyVolume','Offer Qty Volume',1,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,10,'SlNo','SlNo',0,0)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (225,11,'PrdId','PrdId',0,0)
GO
DELETE FROM RptFilter WHERE RptId=225
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (225,262,1,'YES')
INSERT INTO RptFilter([RptId],[SelcId],[FilterId],[FilterDesc]) VALUES (225,262,2,'NO')
GO
--Till here
--NiveaReportProcedures
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RetailerWsBillTaxSummary' AND XTYPE='P')
DROP PROCEDURE Proc_RetailerWsBillTaxSummary
GO
--SELECT * FROM RPTBillDetailsRtrLevelTaxSummary
-- select  * from users
-- EXEC Proc_RetailerWsBillTaxSummary 224,2,0,'Deploy',0,0,1,0
CREATE PROCEDURE Proc_RetailerWsBillTaxSummary
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno		INT OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_RetailerWsBillTaxSummary
* PURPOSE	: To Display Net Tax summary report
* CREATED	: 
* CREATED DATE	: 17/03/2011
* NOTE		: General SP for Retailer wise bill details Net Tax 
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @TaxId AS FLOAT 
	DECLARE @TaxName AS NVARCHAR(100)
	DECLARE @SSQL AS VARCHAR(8000)
	DECLARE @Count AS INT 
	DECLARE @SalTaxableName AS NVARCHAR(100)
	DECLARE @SalTaxName AS NVARCHAR(100)
	DECLARE @RtnTaxableName AS NVARCHAR(100)
	DECLARE @RtnTaxName AS NVARCHAR(100)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate		AS	DATETIME
	DECLARE @SMId	 	AS	INT
	DECLARE @RMId	 	AS	INT
	DECLARE @RtrId	 	AS	INT
	DECLARE @TransNo	AS	NVARCHAR(100)
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @RtrId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
 	SET @TransNo =(SELECT TOP 1 SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,195,@Pi_UsrId))
	IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='RPTBillDetailsRtrLevelTaxSummary')
	BEGIN
		DROP TABLE RPTBillDetailsRtrLevelTaxSummary	
	END
	CREATE TABLE [RPTBillDetailsRtrLevelTaxSummary](
		[Bill Id]				BIGINT,
	[Bill Number]			NVARCHAR(50),
	[Bill Date]				DATETIME,	
	[Retailer Company Code]	  NVARCHAR(50),
	[Retailer Code (Dist)]	  NVARCHAR(50),
	[Retailer Name]			NVARCHAR(150),
	[Retailer Address 1]	 NVARCHAR(200),
	[Retailer Address 2]	 NVARCHAR(200),
	[Retailer Address 3]	 NVARCHAR(200),
	[Retailer Tax Group]	 NVARCHAR(100),	
	[Taxable Status]		 NVARCHAR(5),
	[TIN Number]			 NVARCHAR(50),
	[Gross Amount]			 NUMERIC(38,6),
	[Special Discount]		 NUMERIC(38,6),
	[Scheme Discount]		 NUMERIC(38,6),
	[Distributor Discount]	 NUMERIC(38,6),
	[Cash Discount]			 NUMERIC(38,6),
	[Taxable Amount1]		NUMERIC(38,6),
	[Taxable Amount2]		NUMERIC(38,6),
	[Taxable Amount3]		NUMERIC(38,6),
	[Taxable Amount4]		NUMERIC(38,6),
	[Taxable Amount5]		NUMERIC(38,6),
	[Taxable Amount6]		NUMERIC(38,6),
	[Taxable Amount7]		NUMERIC(38,6),
	[Taxable Amount8]		NUMERIC(38,6),
	[Tax Amount1]			NUMERIC(38,6),	 
	[Tax Amount2]			NUMERIC(38,6),	
	[Tax Amount3]			NUMERIC(38,6),	
	[Tax Amount4]			NUMERIC(38,6),	
	[Tax Amount5]			NUMERIC(38,6),	
	[Tax Amount6]			NUMERIC(38,6),	
	[Tax Amount7]			NUMERIC(38,6),	
	[Tax Amount8]			NUMERIC(38,6),	
	[Total Tax]				NUMERIC(38,6),	
	[Display Amount]		NUMERIC(38,6),	
	[Market Return Ref Number]	    NVARCHAR(50),	
	[Market Return - Gross Amount]	NUMERIC(38,6),
	[Market Return - Special Discount]	NUMERIC(38,6),
	[Market Return - Scheme Discount]	NUMERIC(38,6),
	[Market Return - Distributor Discount]	NUMERIC(38,6),
	[Market Return - Cash Discount]	NUMERIC(38,6),
	[Market Return - Taxable Amount1]NUMERIC(38,6),	
	[Market Return - Taxable Amount2]	NUMERIC(38,6),
	[Market Return - Taxable Amount3]	NUMERIC(38,6),
	[Market Return - Taxable Amount4]	NUMERIC(38,6),
	[Market Return - Taxable Amount5]	NUMERIC(38,6),
	[Market Return - Taxable Amount6]	NUMERIC(38,6),
	[Market Return - Taxable Amount7]	NUMERIC(38,6),
	[Market Return - Taxable Amount8]	NUMERIC(38,6),
	[Market Return - Tax Amount1]	NUMERIC(38,6),
	[Market Return - Tax Amount2]	NUMERIC(38,6),
	[Market Return - Tax Amount3]	NUMERIC(38,6),
	[Market Return - Tax Amount4]	NUMERIC(38,6),
	[Market Return - Tax Amount5]	NUMERIC(38,6),
	[Market Return - Tax Amount6]	NUMERIC(38,6),
	[Market Return - Tax Amount7]	NUMERIC(38,6),
	[Market Return - Tax Amount8]	NUMERIC(38,6),
	[Market Return - Total Tax]		NUMERIC(38,6),
	[Credit Note Adjustment]		NUMERIC(38,6),
	[Debit Note Adjustment]			NUMERIC(38,6),
	[On Account Adjustment]			NUMERIC(38,6),
	[Other Charges (Add)]			NUMERIC(38,6),
	[Other Charges (Reduce)]		NUMERIC(38,6),
	[Invoice Net Amount]			NUMERIC(38,6)
	)
	DECLARE  @SalTaxAmt TABLE
	(
		SalId BIGINT ,
		TaxId FLOAT ,
		SalTaxPerc FLOAT,
		SalTaxableAmount NUMERIC(38,6),
		SalTaxAmount NUMERIC(38,6)
	)
	DECLARE  @RtnTaxAmt TABLE
	(
		SalId BIGINT ,
		TaxId FLOAT ,
		RtnTaxPerc FLOAT,
		RtnTaxableAmount NUMERIC(38,6),
		RtnTaxAmount NUMERIC(38,6)
	)	
	DECLARE  @TaxPerName TABLE
	(
		TaxId FLOAT,
		TaxName FLOAT
	)
	TRUNCATE TABLE RPTBillDetailsRtrLevelTaxSummary
	
	INSERT INTO RPTBillDetailsRtrLevelTaxSummary ([Bill Id],[Bill Number],[Bill Date],[Retailer Company Code],[Retailer Code (Dist)],[Retailer Name],
			[Retailer Address 1],[Retailer Address 2],[Retailer Address 3],[Retailer Tax Group],
			[Taxable Status],[TIN Number],[Gross Amount],[Special Discount],
			[Scheme Discount],[Distributor Discount],[Cash Discount],[Total Tax],
			[Display Amount],[Market Return Ref Number],[Market Return - Gross Amount],
			[Market Return - Special Discount],[Market Return - Scheme Discount],
			[Market Return - Distributor Discount],[Market Return - Cash Discount],
			[Market Return - Total Tax],[Credit Note Adjustment],[Debit Note Adjustment],
			[On Account Adjustment],[Other Charges (Add)],[Other Charges (Reduce)],[Invoice Net Amount],
			[Taxable Amount1],[Taxable Amount2],[Taxable Amount3],[Taxable Amount4],
			[Taxable Amount5],[Taxable Amount6],[Taxable Amount7],[Taxable Amount8],
			[Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],
			[Tax Amount5],[Tax Amount6],[Tax Amount7],[Tax Amount8],
			[Market Return - Taxable Amount1],[Market Return - Taxable Amount2],
			[Market Return - Taxable Amount3],[Market Return - Taxable Amount4],
			[Market Return - Taxable Amount5],[Market Return - Taxable Amount6],
			[Market Return - Taxable Amount7],[Market Return - Taxable Amount8],
			[Market Return - Tax Amount1],[Market Return - Tax Amount2],
			[Market Return - Tax Amount3],[Market Return - Tax Amount4],
			[Market Return - Tax Amount5],[Market Return - Tax Amount6],
			[Market Return - Tax Amount7],[Market Return - Tax Amount8])
	
		SELECT  
			SI.SalId,SI.SalInvNo,SI.SalInvDate,R.CmpRtrCode,R.RtrCode,R.RtrName,R.RtrAdd1,R.RtrAdd2,R.RtrAdd3,
			ISNULL(TG.TaxGroupName,'') AS TaxGroupName,(CASE  R.RtrTaxable WHEN 1 THEN 'YES' ELSE 'NO' END) AS RtrTaxable ,
			R.RtrTINNo,SI.SalGrossAmount,SI.SalSplDiscAmount,SI.SalSchDiscAmount,SI.SalDBDiscAmount,
			SI.SalCDAmount,SI.SalTaxAmount,SI.WindowDisplayAmount,ISNULL(RH.ReturnCode,''),
			(-1) * ISNULL(RH.RtnGrossAmt,0), (-1) * ISNULL(RH.RtnSplDisAmt,0),
			(-1) * ISNULL(RH.RtnSchDisAmt,0),(-1) * ISNULL(RH.RtnDBDisAmt,0),
			(-1) * ISNULL(RH.RtnCashDisAmt,0),(-1) * ISNULL(RH.RtnTaxAmt,0),
			SI.CRAdjAmount,SI.DBAdjAmount,SI.OnAccountAmount,SI.OtherCharges,SI.OtherCharges,SI.SalNetAmt,
			0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,
			0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
		FROM 
			SalesInvoice SI (NOLOCK)
			INNER JOIN Retailer R (NOLOCK) ON SI.RtrId=R.RtrId
			LEFT OUTER JOIN TaxGroupSetting TG (NOLOCK) ON TG.TaxGroupId=R.TaxGroupId
			LEFT OUTER JOIN ReturnHeader RH (NOLOCK) ON RH.SalId=SI.SalId AND RH.ReturnType=1 AND RH.Status=0
		WHERE SI.DlvSts IN (4,5) 
			AND (SI.SMId = (CASE @SmId WHEN 0 THEN SI.SMId ELSE 0 END) OR
				SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
			AND (SI.RMId = (CASE @RmId WHEN 0 THEN SI.RMId ELSE 0 END) OR
				SI.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
			AND (SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
				SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
			AND (SalInvNo = (CASE @TransNo WHEN '0' THEN SalInvNo ELSE '' END) OR
				SalInvNo in (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,195,@Pi_UsrId)))  
			AND SI.SalInvDate  BETWEEN @FromDate and @ToDate 
	UNION ALL
		SELECT 
			90000+RP.ReturnId,NULL,NULL,R.CmpRtrCode,R.RtrCode,R.RtrName,R.RtrAdd1,R.RtrAdd2,R.RtrAdd3,TG.TaxGroupName,
			(CASE  R.RtrTaxable WHEN 1 THEN 'YES' ELSE 'NO' END) AS RtrTaxable ,
			R.RtrTINNo,0.00,0.00,0.00,0.00,0.00,0.00,0.00,ISNULL(RP.ReturnCode,'') AS ReturnCode,
			(-1) * ISNULL(RP.PrdGrossAmt,0) AS RtnGrossAmt,(-1) * ISNULL(RP.PrdSplDisAmt,0) AS RtnSplDisAmt,
			(-1) * ISNULL(RP.PrdSchDisAmt,0) AS RtnSchDisAmt,(-1) * ISNULL(RP.PrdDBDisAmt,0) AS RtnDBDisAmt,
			(-1) * ISNULL(RP.PrdCDDisAmt,0) AS RtnCashDisAmt,(-1) * ISNULL(RP.PrdTaxAmt,0) AS RtnTaxAmt,0.00,0.00,0.00,0.00,0.00,(-1) * ISNULL(RP.RtnNetAmt,0),  --- 0.00,  Commented by panneer and added  RtnNetAmt
			0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00		
		FROM Retailer R (NOLOCK)
		LEFT OUTER JOIN TaxGroupSetting TG (NOLOCK) ON TG.TaxGroupId=R.TaxGroupId
		INNER JOIN (SELECT
						B.returnid,B.ReturnCode,B.ReturnDate,B.SmId,B.RtrId,B.RmId,B.ReturnType,
						B.Status,ISNULL(SUM(PrdGrossAmt),0) As PrdGrossAmt,
						ISNULL(SUM(PrdSplDisAmt),0) As PrdSplDisAmt,ISNULL(SUM(PrdSchDisAmt),0) As PrdSchDisAmt,
						ISNULL(SUM(PrdDBDisAmt),0) As PrdDBDisAmt,
						ISNULL(SUM(PrdCDDisAmt),0) As PrdCDDisAmt,ISNULL(SUM(PrdTaxAmt),0) As PrdTaxAmt ,
						ISNULL(SUM(PrdNetAmt),0) RtnNetAmt
					FROM 
						ReturnProduct A (NOLOCK) 
						INNER JOIN ReturnHeader B ON A.ReturnId=B.ReturnId 
					WHERE 
						ReturnType =2 AND B.Status=0 
						AND B.ReturnDate BETWEEN @FromDate and @ToDate 
						AND (B.SMId = (CASE @SmId WHEN 0 THEN B.SMId ELSE 0 END) OR
							B.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
						AND (B.RMId = (CASE @RmId WHEN 0 THEN B.RMId ELSE 0 END) OR
							B.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
						AND (B.RtrId = (CASE @RtrId WHEN 0 THEN B.RtrId ELSE 0 END) OR
								B.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					GROUP BY B.returnid,B.ReturnCode,B.ReturnDate,B.SmId,B.RtrId,B.RmId,B.ReturnType,B.Status) RP ON R.RtrId=RP.RtrId
		WHERE 
			 (RP.SMId = (CASE @SmId WHEN 0 THEN RP.SMId ELSE 0 END) OR
					RP.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
			AND (RP.RMId = (CASE @RmId WHEN 0 THEN RP.RMId ELSE 0 END) OR
				RP.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
			AND (RP.RtrId = (CASE @RtrId WHEN 0 THEN RP.RtrId ELSE 0 END) OR
					RP.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
		AND RP.ReturnDate  BETWEEN @FromDate and @ToDate AND RP.ReturnType =2 AND RP.Status=0 
		Update RPTBillDetailsRtrLevelTaxSummary Set [Invoice Net Amount] = (-1) * RtnNetAmt 
		from RPTBillDetailsRtrLevelTaxSummary a, ReturnHeader
		Where [Market Return Ref Number] = ReturnCode and ReturnType =2 AND  Status=0 
		UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Other Charges (Add)]=Other.AddAmt,[Other Charges (Reduce)]=Other.ReduceAmt
		FROM RPTBillDetailsRtrLevelTaxSummary,
		(SELECT SI.SalId,SO1.AdjAmt AS AddAmt,SO2.AdjAmt  AS ReduceAmt
			FROM  SalesInvoice SI 
			INNER JOIN  SalInvOtherAdj SO1 (NOLOCK) ON SI.SalId=SO1.SalId
			INNER JOIN PurSalAccConfig PS1 (NOLOCK) ON PS1.AccDescId=SO1.AccDescId AND PS1.Effect=1 AND PS1.TransactionId=2 
			INNER JOIN SalInvOtherAdj SO2 (NOLOCK) ON SI.SalId=SO2.SalId
			INNER JOIN PurSalAccConfig PS2 (NOLOCK) ON PS2.AccDescId=SO2.AccDescId AND PS2.TransactionId=2 AND PS2.Effect=0
		) Other  WHERE Other.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id]
		DELETE FROM @SalTaxAmt
		INSERT INTO @SalTaxAmt (SalId,TaxId,SalTaxPerc,SalTaxableAmount,SalTaxAmount)
		SELECT  SI.SalId,SPT.TaxPerc,SPT.TaxPerc AS SalTaxPerc,SUM(SPT.TaxableAmount) AS SalTaxableAmount,SUM(SPT.TaxAmount) AS SalTaxAmount
		 FROM SalesInvoice SI WITH (NOLOCK)  
		 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		 WHERE SI.DlvSts IN (4,5)  AND SI.SalInvDate BETWEEN @FromDate and @ToDate
		 GROUP BY SPT.TaxPerc,SPT.TaxPerc,SI.SalId
		 HAVING SUM(SPT.TaxableAmount) >= 0  
		DELETE FROM @RtnTaxAmt
		INSERT INTO @RtnTaxAmt (SalId,TaxId,RtnTaxPerc,RtnTaxableAmount,RtnTaxAmount)
		SELECT  SI.SalId,RPT.TaxPerc,RPT.TaxPerc AS RtnTaxPerc, SUM(RPT.TaxableAmt) AS RtnTaxableAmount, SUM(RPT.TaxAmt) AS RtnTaxAmount
		FROM SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN ReturnHeader RH WITH (NOLOCK) ON SI.SalId = RH.SalId  
		INNER JOIN ReturnProduct RIP WITH (NOLOCK) ON RH.ReturnId = RIP.ReturnId  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RIP.ReturnId AND RIP.SlNo=RPT.PrdSlNo  
		WHERE SI.DlvSts IN (4,5) AND SI.SalInvDate BETWEEN @FromDate and @ToDate
		AND RH.Status=0 AND RH.ReturnType in (1)
		GROUP BY RPT.TaxPerc,RPT.TaxPerc,SI.SalId HAVING SUM(RPT.TaxableAmt) >= 0 
		UNION ALL
		SELECT  (90000+RH.ReturnId) ,RPT.TaxPerc,RPT.TaxPerc AS RtnTaxPerc,  SUM(RPT.TaxableAmt) AS RtnTaxableAmount, SUM(RPT.TaxAmt) AS RtnTaxAmount
		FROM ReturnHeader RH WITH (NOLOCK)  INNER JOIN ReturnProduct RIP WITH (NOLOCK) ON RH.ReturnId = RIP.ReturnId  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RIP.ReturnId AND RIP.SlNo=RPT.PrdSlNo  
		WHERE   RH.ReturnDate BETWEEN @FromDate and @ToDate
		AND RH.Status=0 AND RH.ReturnType =2
		GROUP BY RH.ReturnId,RPT.TaxPerc,RPT.TaxPerc
		HAVING SUM(RPT.TaxableAmt) >= 0
		INSERT INTO @TaxPerName (TaxId,TaxName)
		SELECT DISTINCT TOP 8 TaxPerc,TaxPerc FROM SalesInvoiceProductTax SIPT INNER JOIN SalesInvoice SI ON SI.SalId = SIPT.SalId  
		WHERE SI.SalInvDate BETWEEN @FromDate and @ToDate ORDER BY TaxPerc DESC
		SET @Count=0
		DECLARE Cur_TaxName CURSOR
		FOR SELECT TaxId,TaxName  FROM @TaxPerName ORDER BY TaxId DESC
		OPEN Cur_TaxName
		FETCH NEXT FROM Cur_TaxName INTO @TaxId,@TaxName 
		WHILE @@FETCH_STATUS=0
		BEGIN
				SET @Count=@Count+1
				IF @Count=1
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount1]=A.SalTaxableAmount,[Tax Amount1]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A  
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary 
					SET [Market Return - Taxable Amount1] = (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount1] = (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=2
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount2]=A.SalTaxableAmount,[Tax Amount2]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount2]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount2] = (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=3
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount3]=A.SalTaxableAmount,[Tax Amount3]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount3]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount3] = (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=4
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount4]=A.SalTaxableAmount,[Tax Amount4]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount4]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount4]= (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=5
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount5]=A.SalTaxableAmount,[Tax Amount5]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount5]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount5]= (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=6
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount6]=A.SalTaxableAmount,[Tax Amount6]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount6]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount6]= (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=7
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount7]=A.SalTaxableAmount,[Tax Amount7]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount7]= (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount7] = (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
				IF @Count=8
				BEGIN
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Taxable Amount8]=A.SalTaxableAmount,[Tax Amount8]=A.SalTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@SalTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
					UPDATE RPTBillDetailsRtrLevelTaxSummary SET [Market Return - Taxable Amount8] = (-1) * A.RtnTaxableAmount,
						[Market Return - Tax Amount8] = (-1) * A.RtnTaxAmount
					FROM RPTBillDetailsRtrLevelTaxSummary,@RtnTaxAmt A 
					WHERE A.SalId=RPTBillDetailsRtrLevelTaxSummary.[Bill Id] AND A.TaxId=@TaxId
				END 
			SET @SSQL='sp_rename ''RPTBillDetailsRtrLevelTaxSummary.[Taxable Amount'+ CAST(@Count AS NVARCHAR(10))+']'',''Taxable Amount '+ CAST(@TaxName AS NVARCHAR(5)) +'%'''+',''COLUMN'''
			EXEC (@SSQL)
			SET @SSQL='sp_rename ''RPTBillDetailsRtrLevelTaxSummary.[Tax Amount'+ CAST(@Count AS NVARCHAR(10))+']'',''Tax Amount '+ CAST(@TaxName AS NVARCHAR(5)) +'%'''+',''COLUMN'''
			EXEC (@SSQL)
			SET @SSQL='sp_rename ''RPTBillDetailsRtrLevelTaxSummary.[Market Return - Taxable Amount'+ CAST(@Count AS NVARCHAR(10))+']'',''Market Return - Taxable Amount '+ CAST(@TaxName AS NVARCHAR(5)) +'%'''+',''COLUMN'''
			EXEC (@SSQL)
			SET @SSQL='sp_rename ''RPTBillDetailsRtrLevelTaxSummary.[Market Return - Tax Amount'+ CAST(@Count AS NVARCHAR(10))+']'',''Market Return - Tax Amount '+ CAST(@TaxName AS NVARCHAR(5)) +'%'''+',''COLUMN'''
			EXEC (@SSQL)
		FETCH NEXT FROM Cur_TaxName INTO @TaxId,@TaxName
		END
		CLOSE Cur_TaxName
		DEALLOCATE Cur_TaxName
		if exists (Select Id,name from Syscolumns where name = 'Retailer Company Code' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
		BEGIN
			ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Retailer Company Code]
		END
		if exists (Select Id,name from Syscolumns where name = 'Retailer Address 3' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
		BEGIN
			ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Retailer Address 3]
		END
		if exists (Select Id,name from Syscolumns where name = 'Retailer Tax Group' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
		BEGIN
			ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Retailer Tax Group]
		END
		if exists (Select Id,name from Syscolumns where name = 'Taxable Status' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
		BEGIN
			ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Status]
		END		
		IF @Count=1
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount2' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount2]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount2' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount2]
			END
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount2' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount2]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount2' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount2]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount3' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
					ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount3' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount3' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount3]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount3' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount4]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount4' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount4]
			END
			--- Added on 09-Nov-2010 as per client request
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount5' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount6' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		ELSE IF @Count=2
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount3' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
					ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount3' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount3' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount3]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount3' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount3]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount4]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount4' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount4]
			END
			
			--- Added on 09-Nov-2010 as per client request
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount5' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount6' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		ELSE IF @Count=3
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount4]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount4' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount4]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount4' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount4]
			END
		
			--- Added on 09-Nov-2010 as per client request
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount5' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount6' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		
		ELSE IF @Count=4
		BEGIN
			--- Added on 09-Nov-2010 as per client request
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount5' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount5]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount5' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount5]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount6' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		ELSE IF @Count=5
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount6' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount6]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount6' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount6]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		ELSE IF @Count=6
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount7' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount7]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount7' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount7]
			END
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
		ELSE IF @Count=7
		BEGIN
			if exists (Select Id,name from Syscolumns where name = 'Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Taxable Amount8]
			END
			if exists (Select Id,name from Syscolumns where name = 'Tax Amount8' and id in (Select id from 
				Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Tax Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Taxable Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Taxable Amount8]
			END 
			if exists (Select Id,name from Syscolumns where name = 'Market Return - Tax Amount8' and id in (Select id from 
			Sysobjects where name ='RPTBillDetailsRtrLevelTaxSummary'))
			BEGIN
				ALTER TABLE RPTBillDetailsRtrLevelTaxSummary DROP COLUMN [Market Return - Tax Amount8]
			END
			--- Ended on 09-Nov-2010 as per client request	
		END 
			UPDATE A SET A.[Retailer Address 1] = SMName,A.[Retailer Address 2] = RMName 
			FROM RPTBillDetailsRtrLevelTaxSummary A,SalesInvoice SI (nolock),  Salesman S (nolock) ,
				 RouteMaster R (nolock)
			WHere A.[Bill Id] = SI.SalId and SI.SmId = S.SMId and SI.RMId  = R.RmId and [Bill Number] is not null
			UPDATE A SET A.[Retailer Address 1] = SMName,A.[Retailer Address 2] = RMName 
			FROM RPTBillDetailsRtrLevelTaxSummary A,ReturnHeader SI (nolock),  Salesman S (nolock) ,
				 RouteMaster R (nolock)
			WHere A.[Market Return Ref Number] = SI.ReturnCode and SI.SmId = S.SMId and SI.RMId  = R.RmId and [Bill Number] is null
		 
   			DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM RPTBillDetailsRtrLevelTaxSummary
			IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='RPTBillDetailsRtrLevelTaxSummary_Excel')
				BEGIN 
					DROP TABLE RPTBillDetailsRtrLevelTaxSummary_Excel
					SELECT * INTO RPTBillDetailsRtrLevelTaxSummary_Excel FROM RPTBillDetailsRtrLevelTaxSummary 
				END 
			ELSE
				BEGIN 
					SELECT * INTO RPTBillDetailsRtrLevelTaxSummary_Excel FROM RPTBillDetailsRtrLevelTaxSummary 
				END 
			DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM RPTBillDetailsRtrLevelTaxSummary_Excel
	
		DELETE FROM RptExcelHeaders WHERE RptId=224
		DECLARE @iCnt AS INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		SET @iCnt=1
		SET @Pi_RptId=224
		DECLARE Column_Cur CURSOR FOR
		SELECT name FROM dbo.sysColumns where id = object_id(N'[RPTBillDetailsRtrLevelTaxSummary]') ORDER BY ColID
		OPEN Column_Cur
			   FETCH NEXT FROM Column_Cur INTO @Column
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
				
					EXEC (@C_SSQL)
				SET @iCnt=@iCnt+1
					FETCH NEXT FROM Column_Cur INTO @Column
				END
		CLOSE Column_Cur
		DEALLOCATE Column_Cur
		UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE RptId=224 AND SlNo=1
        UPDATE RptExcelHeaders SET DisplayName='Sales Man' WHERE RptId=224 AND SlNo=6
		UPDATE RptExcelHeaders SET DisplayName='Route' WHERE RptId=224 AND SlNo=7
		DECLARE @SsqlStr as Varchar(4000)
		SET @SsqlStr=''
		SELECT @SsqlStr=@SsqlStr+'SUM(['+Name+']),' FROM dbo.sysColumns where id = object_id(N'[RPTBillDetailsRtrLevelTaxSummary_Excel]') and Name NOT IN(
		Select TOP 8 Name FROM dbo.sysColumns where id = object_id(N'[RPTBillDetailsRtrLevelTaxSummary_Excel]') ORDER BY ColID) --AND NAME <>'[Market Return Ref Number]'
		SELECT @SsqlStr =substring( @SsqlStr,1,len(@SsqlStr)-1)    
		SET @SsqlStr=REPLACE(@SsqlStr,'SUM([Market Return Ref Number])','[Market Return Ref Number]')
		DECLARE @SsqlFieldStr as Varchar(4000)
        SET @SsqlFieldStr=''
        SELECT @SsqlFieldStr=@SsqlFieldStr+'['+Name+'],' FROM dbo.sysColumns where id = object_id(N'[RPTBillDetailsRtrLevelTaxSummary_Excel]') and Name NOT IN(
		Select TOP 8 Name FROM dbo.sysColumns where id = object_id(N'[RPTBillDetailsRtrLevelTaxSummary_Excel]') ORDER BY ColID) --AND NAME<>'[Market Return Ref Number]'
        SELECT @SsqlFieldStr =substring( @SsqlFieldStr,1,len(@SsqlFieldStr)-1)
		SET @SsqlFieldStr=REPLACE(@SsqlFieldStr,'SUM([Market Return Ref Number])','[Market Return Ref Number]')
		IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TmpRPTBillDetailsRtrLevelTaxSummary_Excel')
			BEGIN 
				DROP TABLE TmpRPTBillDetailsRtrLevelTaxSummary_Excel
				SELECT * INTO TmpRPTBillDetailsRtrLevelTaxSummary_Excel FROM RPTBillDetailsRtrLevelTaxSummary_Excel WHERE 1=2
			END 
		ELSE
			BEGIN 
				SELECT * INTO TmpRPTBillDetailsRtrLevelTaxSummary_Excel FROM RPTBillDetailsRtrLevelTaxSummary_Excel WHERE 1=2
			END 
		SET @SsqlStr=REPLACE(@SsqlStr,'[Market Return Ref Number]','0')
		 SET @sSql='INSERT INTO TmpRPTBillDetailsRtrLevelTaxSummary_Excel ([Bill Id],[TIN Number],' + @SsqlFieldStr + ')
			SELECT 999999,''Total'',' + @SsqlStr + ' FROM RPTBillDetailsRtrLevelTaxSummary_Excel'
        PRINT @sSql
        EXEC (@sSql)
		UPDATE TmpRPTBillDetailsRtrLevelTaxSummary_Excel SET [Market Return Ref Number] ='' WHERE [TIN Number]='Total'
		SET @sSql='INSERT INTO RPTBillDetailsRtrLevelTaxSummary_Excel ([Bill Id],[TIN Number],' + @SsqlFieldStr + ')
			SELECT 999999,''Total'',' + @SsqlFieldStr + ' FROM TmpRPTBillDetailsRtrLevelTaxSummary_Excel'
        EXEC (@sSql)
	
		SELECT * FROM RPTBillDetailsRtrLevelTaxSummary_Excel ORDER BY [Bill Id]
		IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='RPTBillDetailsRtrLevelTaxSummary')
		BEGIN
			DROP TABLE RPTBillDetailsRtrLevelTaxSummary	
		END
		CREATE TABLE [RPTBillDetailsRtrLevelTaxSummary](
			[Bill Id]				BIGINT,
		[Bill Number]			NVARCHAR(50),
		[Bill Date]				DATETIME,	
		[Retailer Company Code]	  NVARCHAR(50),
		[Retailer Code (Dist)]	  NVARCHAR(50),
		[Retailer Name]			NVARCHAR(150),
		[Retailer Address 1]	 NVARCHAR(200),
		[Retailer Address 2]	 NVARCHAR(200),
		[Retailer Address 3]	 NVARCHAR(200),
		[Retailer Tax Group]	 NVARCHAR(100),	
		[Taxable Status]		 NVARCHAR(5),
		[TIN Number]			 NVARCHAR(50),
		[Gross Amount]			 NUMERIC(38,6),
		[Special Discount]		 NUMERIC(38,6),
		[Scheme Discount]		 NUMERIC(38,6),
		[Distributor Discount]	 NUMERIC(38,6),
		[Cash Discount]			 NUMERIC(38,6),
		[Taxable Amount1]		NUMERIC(38,6),
		[Taxable Amount2]		NUMERIC(38,6),
		[Taxable Amount3]		NUMERIC(38,6),
		[Taxable Amount4]		NUMERIC(38,6),
		[Taxable Amount5]		NUMERIC(38,6),
		[Taxable Amount6]		NUMERIC(38,6),
		[Taxable Amount7]		NUMERIC(38,6),
		[Taxable Amount8]		NUMERIC(38,6),
		[Tax Amount1]			NUMERIC(38,6),	 
		[Tax Amount2]			NUMERIC(38,6),	
		[Tax Amount3]			NUMERIC(38,6),	
		[Tax Amount4]			NUMERIC(38,6),	
		[Tax Amount5]			NUMERIC(38,6),	
		[Tax Amount6]			NUMERIC(38,6),	
		[Tax Amount7]			NUMERIC(38,6),	
		[Tax Amount8]			NUMERIC(38,6),	
		[Total Tax]				NUMERIC(38,6),	
		[Display Amount]		NUMERIC(38,6),	
		[Market Return Ref Number]	NVARCHAR(50),	
		[Market Return - Gross Amount]	NUMERIC(38,6),
		[Market Return - Special Discount]	NUMERIC(38,6),
		[Market Return - Scheme Discount]	NUMERIC(38,6),
		[Market Return - Distributor Discount]	NUMERIC(38,6),
		[Market Return - Cash Discount]	NUMERIC(38,6),
		[Market Return - Taxable Amount1]NUMERIC(38,6),	
		[Market Return - Taxable Amount2]	NUMERIC(38,6),
		[Market Return - Taxable Amount3]	NUMERIC(38,6),
		[Market Return - Taxable Amount4]	NUMERIC(38,6),
		[Market Return - Taxable Amount5]	NUMERIC(38,6),
		[Market Return - Taxable Amount6]	NUMERIC(38,6),
		[Market Return - Taxable Amount7]	NUMERIC(38,6),
		[Market Return - Taxable Amount8]	NUMERIC(38,6),
		[Market Return - Tax Amount1]	NUMERIC(38,6),
		[Market Return - Tax Amount2]	NUMERIC(38,6),
		[Market Return - Tax Amount3]	NUMERIC(38,6),
		[Market Return - Tax Amount4]	NUMERIC(38,6),
		[Market Return - Tax Amount5]	NUMERIC(38,6),
		[Market Return - Tax Amount6]	NUMERIC(38,6),
		[Market Return - Tax Amount7]	NUMERIC(38,6),
		[Market Return - Tax Amount8]	NUMERIC(38,6),
		[Market Return - Total Tax]		NUMERIC(38,6),
		[Credit Note Adjustment]		NUMERIC(38,6),
		[Debit Note Adjustment]			NUMERIC(38,6),
		[On Account Adjustment]			NUMERIC(38,6),
		[Other Charges (Add)]			NUMERIC(38,6),
		[Other Charges (Reduce)]		NUMERIC(38,6),
		[Invoice Net Amount]			NUMERIC(38,6)
		)
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptBrandwiseTargetAnalysis' AND XTYPE='U')
DROP TABLE RptBrandwiseTargetAnalysis
GO
CREATE TABLE RptBrandwiseTargetAnalysis(
	[JCMonth] [nvarchar](10) NOT NULL,
	[Brand] [nvarchar](100) NOT NULL,
	[Planned BillsCut] [int] NULL,
	[BillsCut] [int] NULL,
	[Planned ECO] [int] NULL,
	[ECO] [int] NULL,
	[Planned LineSold] [int] NULL,
	[LineSold] [int] NULL,
	[SalesPlan] [numeric](38, 6) NOT NULL,
	[SalesActual] [numeric](38, 6) NULL,
	[Achievement%] [nvarchar](20) NULL,
	[UserId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptBGRwiseTargetAnalysis' AND XTYPE='P')
DROP PROCEDURE Proc_RptBGRwiseTargetAnalysis
GO
--EXEC Proc_RptBGRwiseTargetAnalysis 237,1,0,'',0,0,1
--SELECT * FROM BRANDTARGET WHERE 
CREATE PROCEDURE Proc_RptBGRwiseTargetAnalysis
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************
* VIEW	: Proc_RptBrandwiseTargetAnalysis
* PURPOSE	: Brand wise Report - Target Analysis
* CREATED BY	: Mohana S
* CREATED DATE	: 16.01.2013
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @JcmId	 	AS	INT
	DECLARE @JcMonth	AS	DATETIME
	DECLARE @Brand 		AS	INT
	
	SET @JcmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
	
	SELECT  @JcMonth = ISNULL(dSelected,0) FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)
	
	SET @Brand = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId))
	
	SELECT J.JcmId[JcYear],J.JcmJc[JcMonth],JcmSdt,JcmEdt 
	INTO #JC 
	FROM JcMonth J INNER JOIN TargetAnalysisHd T ON J.JcmId=T.JcmId AND J.JcmJc=T.JcmJc
	WHERE (JcmSdt=(CASE @JcMonth WHEN '1900-01-01' THEN JcmSdt ELSE '1900-01-01' END) OR
	JcmSdt IN (SELECT dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)))
	AND J.JcmId=@JcmId AND T.TargetType=2 AND T.TargetLevel=1
	
	SELECT JcYear,JcMonth,SalId,RtrId 
	INTO #SR
	FROM SalesInvoice S
	INNER JOIN #JC J ON SalInvDate BETWEEN JcmSdt AND JcmEdt
	WHERE S.DlvSts IN (4,5)
	
	SELECT JcYear,JcMonth,SP.SalId,RtrId,SP.PrdId,SUM(SP.PrdGrossAmount) PrdGrossAmount
	INTO #SRP
	FROM SalesInvoiceProduct SP
	INNER JOIN #SR SR ON SP.SalId=SR.SalId
	GROUP BY JcYear,JcMonth,SP.SalId,RtrId,SP.PrdId	
--select  * from #ReturnProduct		
	SELECT JcYear,JcMonth,RH.SalId,RHP.PrdId,SUM(RHP.PrdGrossAmt)[ReturnGross] 
	INTO #ReturnProduct
	FROM ReturnHeader RH
	INNER JOIN ReturnProduct RHP ON RH.ReturnID=RHP.ReturnID
	INNER JOIN #SRP S ON S.SalId = RH.SalId AND S.PrdId = RHP.PrdId
	WHERE RH.Status=0
	GROUP BY JcYear,JcMonth,RH.SalId,RHP.PrdId
		
	SELECT C.PrdCtgValMainId,C.PrdCtgValName,E.PrdId,E.PrdName--,SUM(CURMONTHTARGET) [SalesPlan]
	INTO #ProductBrand
	FROM ProductCategoryValue C  INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE CAST(c.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	AND c.cmpprdctgid in (SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName = 'BrandGroup')
	INNER JOIN Product E ON D.PrdCtgValMainId = E.PrdCtgValMainId	
	--Inner join targetanalysisdt TA WITH  (NOLOCK)on ta.PrdCtgValMainId =C.PrdCtgValMainId 
	WHERE c.prdctgvallinkcode in (SELECT PrdCtgValLinkCode  FROM ProductCategoryValue
	WHERE 
	--PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId)))
	--Group by c.PrdCtgValMainId,E.Prdid,E.PrdName,c.PrdCtgValName
	(PrdCtgValMainId = (CASE @Brand WHEN 0 THEN PrdCtgValMainId ELSE 0 END) OR
	PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId))))
	
	SELECT SP.JcYear,SP.JcMonth,PrdCtgValMainId,PrdCtgValName,COUNT(DISTINCT(SP.SalId))[BillsCut],COUNT(DISTINCT(RtrId))[ECO],
	COUNT(SP.PrdId)[LineSold],
	(ISNULL(SUM(SP.PrdGrossAmount),0)-ISNULL(SUM(ReturnGross),0))[SalesActual]
	INTO #Brand
	FROM #SRP SP
	INNER JOIN #ProductBrand PB ON SP.PrdId=PB.PrdId
	LEFT OUTER JOIN #ReturnProduct RP ON SP.PrdId=RP.PrdId AND SP.SalId=RP.SalId AND SP.JcMonth=RP.JcMonth AND SP.JcYear=SP.JcYear
	GROUP BY SP.JcYear,SP.JcMonth,PrdCtgValMainId,PrdCtgValName
	
	--INSERT INTO RptBrandwiseTargetAnalysis
	SELECT DISTINCT CONVERT(NVARCHAR(10),J.JcmSdt,103)[JCMonth],B.PrdCtgValName[Brand],TD.ProductivityCalls[Planned BillsCut],B.[BillsCut],
	TD.ECO [Planned ECO],B.[ECO],TD.LineSold [Planned LineSold],B.[LineSold],
	(TD.CurMonthPlan)[SalesPlan],
	ROUND([SalesActual],2)[SalesActual],
	CASE (TD.CurMonthPlan) WHEN 0 THEN 0 ELSE CAST(ROUND(ROUND([SalesActual],0)/((TD.CurMonthPlan))*100,2) AS NUMERIC(18,2)) END [Achievement%],
	@Pi_UsrId[UserId]		
	INTO #RptBrandwiseTargetAnalysis
	FROM #Brand B
	INNER JOIN TargetAnalysisHd TH ON B.JcYear=TH.JcmId AND B.JcMonth=TH.JcmJc
	INNER JOIN BrandTarget TD ON TH.TargetAnalysisId=TD.TargetAnalysisId AND TD.PrdCtgValMainId=B.PrdCtgValMainId
	INNER JOIN #JC J ON J.JcYear=TH.JcmId AND J.JcMonth=TH.JcmJc AND B.JcYear=J.JcYear AND B.JcMonth=J.JcMonth
	WHERE TH.TargetType=2
	--GROUP BY J.JcmSdt,B.PrdCtgValMainId,B.PrdCtgValName,TD.ProductivityCalls,[BillsCut],TD.ECO,B.[ECO],TD.LineSold,B.[LineSold],[SalesActual]
	--ORDER BY J.JcmSdt,B.PrdCtgValName
	
	
	DELETE FROM RptBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId
	
	INSERT INTO RptBrandwiseTargetAnalysis
	SELECT [JCMonth],[Brand],[Planned BillsCut],[BillsCut],[Planned ECO],[ECO],
	[Planned LineSold],[LineSold],[SalesPlan],[SalesActual],CAST([Achievement%]AS NVARCHAR(20))+'%' [Achievement%],[UserId]
	FROM #RptBrandwiseTargetAnalysis
	--
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM RptBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId
	
	SELECT * FROM RptBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId	
	ORDER BY [JCMonth],[Brand]
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptDSRwiseTargetAnalysis' AND XTYPE='U')
DROP TABLE RptDSRwiseTargetAnalysis
GO
CREATE TABLE RptDSRwiseTargetAnalysis(
	[JCMonth] [nvarchar](10) NOT NULL,
	[SalesMan] [nvarchar](100) NOT NULL,
	[Planned BillsCut] [int] NULL,
	[BillsCut] [int] NULL,
	[Planned ECO] [int] NULL,
	[ECO] [int] NULL,
	[Planned LineSold] [int] NULL,
	[LineSold] [int] NULL,
	[SalesPlan] [numeric](38, 6) NOT NULL,
	[SalesActual] [numeric](38, 6) NULL,
	[Achievement%] [nvarchar](20) NULL,
	[UserId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptDSRwiseTargetAnalysis' AND XTYPE='P')
DROP PROCEDURE Proc_RptDSRwiseTargetAnalysis
GO
--exec Proc_RptDSRwiseTargetAnalysis 234,1,0,'Nivea',0,0,1
CREATE PROCEDURE Proc_RptDSRwiseTargetAnalysis
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************
* VIEW	: Proc_RptDSRwiseTargetAnalysis
* PURPOSE	: DSR wise Report - Target Analysis
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 15.01.2013
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @JcmId	 	AS	INT
	DECLARE @JcMonth	AS	DATETIME
	DECLARE @SmId 		AS	INT
	
	SET @JcmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
	SELECT  @JcMonth = ISNULL(dSelected,0) FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))	
	--
	SELECT J.JcmId[JcYear],J.JcmJc[JcMonth],JcmSdt,JcmEdt 
	INTO #JC 
	FROM JcMonth J INNER JOIN TargetAnalysisHd T ON J.JcmId=T.JcmId AND J.JcmJc=T.JcmJc
	WHERE (JcmSdt=(CASE @JcMonth WHEN '1900-01-01' THEN JcmSdt ELSE '1900-01-01' END) OR
	JcmSdt IN (SELECT dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)))
	AND J.JcmId=@JcmId AND T.TargetType=2 AND T.TargetLevel=3
	--select  * from #JC
	SELECT JcYear,JcMonth,SMId,SalId,RtrId 
	INTO #SSR
	FROM SalesInvoice S
	INNER JOIN #JC J ON SalInvDate BETWEEN JcmSdt AND JcmEdt
	WHERE S.DlvSts IN (4,5)
	AND (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR
	SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
--select  * from #SSR
	SELECT JcYear,JcMonth,SMId,SP.SalId,RtrId,SP.PrdId,SUM(SP.PrdGrossAmount)PrdGrossAmount
	INTO #SSRP
	FROM SalesInvoiceProduct SP
	INNER JOIN #SSR SR ON SP.SalId=SR.SalId
	GROUP BY JcYear,JcMonth,SMId,SP.SalId,RtrId,SP.PrdId
--select  * from #ReturnProduct	
	SELECT JcYear,JcMonth,RH.SalId,RH.SMId,RHP.PrdId,SUM(RHP.PrdGrossAmt)[ReturnGross] 
	INTO #ReturnProduct
	FROM ReturnHeader RH
	INNER JOIN ReturnProduct RHP ON RH.ReturnID=RHP.ReturnID
	INNER JOIN #JC J ON ReturnDate BETWEEN JcmSdt AND JcmEdt
	GROUP BY JcYear,JcMonth,RH.SalId,RH.SMId,RHP.PrdId
	--WHERE RH.ReturnDate BETWEEN  '2012-01-01' AND '2012-12-01'
	--GROUP BY JcYear,JcMonth,RH.SMId,RHP.PrdId
	
	SELECT SP.JcYear,SP.JcMonth,SP.SMId,SM.SMName,COUNT(DISTINCT(SP.SalId)) AS [BillsCut],COUNT(DISTINCT(RtrId))[ECO],
	COUNT(SP.PrdId)[LineSold],
	(ISNULL(SUM(SP.PrdGrossAmount),0)-ISNULL(SUM(ReturnGross),0))[SalesActual]
	INTO #SALESMAN
	FROM #SSRP SP 
	INNER JOIN Salesman SM ON SP.SMId=SM.SMId
	LEFT OUTER JOIN #ReturnProduct RP ON SP.SMId=RP.SMId AND SP.PrdId=RP.PrdId 
	AND RP.SalId=SP.SalId AND SP.JcMonth=RP.JcMonth AND SP.JcYear=SP.JcYear
	GROUP BY SP.JcYear,SP.JcMonth,SP.SMId,SM.SMName--,LineSold
--select * from #SALESMAN	
	DELETE FROM RptDSRwiseTargetAnalysis WHERE UserId=@Pi_UsrId
		
	--INSERT INTO RptDSRwiseTargetAnalysis
	SELECT DISTINCT CONVERT(NVARCHAR(10),J.JcmSdt,103)[JCMonth],SMName[SalesMan],TD.ProductivityCalls[Planned BillsCut],S.[BillsCut],
	TD.ECO [Planned ECO],S.[ECO],TD.LineSold [Planned LineSold],S.[LineSold],
	(TD.CurMonthPlan)[SalesPlan],
	ROUND([SalesActual],2)[SalesActual],
	CASE (TD.CurMonthPlan) WHEN 0 THEN 0 ELSE CAST(ROUND(ROUND([SalesActual],0)/((TD.CurMonthPlan))*100,2) AS NUMERIC(18,2)) END [Achievement%],
	@Pi_UsrId[UserId]		
	INTO #RptDSRwiseTargetAnalysis
	FROM #SALESMAN S
	INNER JOIN TargetAnalysisHd TH ON S.JcYear=TH.JcmId AND S.JcMonth=TH.JcmJc
	INNER JOIN SalesmanTarget TD ON TH.TargetAnalysisId=TD.TargetAnalysisId AND TD.SmId=S.SMId
	INNER JOIN #JC J ON J.JcYear=TH.JcmId AND J.JcMonth=TH.JcmJc AND S.JcYear=J.JcYear AND S.JcMonth=J.JcMonth
	WHERE TH.TargetType=2
	--GROUP BY J.JcmSdt,S.SMId,SMName,TD.ProductivityCalls,[BillsCut],TD.ECO,S.[ECO],TD.LineSold,S.[LineSold],[SalesActual]
	--ORDER BY J.JcmSdt,SMName
	
	INSERT INTO RptDSRwiseTargetAnalysis
	SELECT [JCMonth],[SalesMan],[Planned BillsCut],[BillsCut],[Planned ECO],[ECO],
	[Planned LineSold],[LineSold],[SalesPlan],[SalesActual],CAST([Achievement%]AS NVARCHAR(20))+'%' [Achievement%],[UserId]
	FROM #RptDSRwiseTargetAnalysis
	--
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM RptDSRwiseTargetAnalysis WHERE UserId=@Pi_UsrId
	
	SELECT * FROM RptDSRwiseTargetAnalysis	WHERE UserId=@Pi_UsrId
	ORDER BY [JCMonth],[SalesMan]
	--
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptFundManagement' AND XTYPE='P')
DROP PROCEDURE Proc_RptFundManagement
GO
--Exec [Proc_RptFundManagement] 201,1,0,'CoreStocky',0,0,1,0
CREATE PROCEDURE Proc_RptFundManagement
(
	@Pi_RptId  INT,
	@Pi_UsrId  INT,
	@Pi_SnapId  INT,
	@Pi_DbName  nvarchar(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap  INT,
	@Pi_CurrencyId  INT,
	@Po_Errno  INT OUTPUT
)
AS
/******************************************************************************************
* PROCEDURE		: Proc_RptFundManagement
* PURPOSE		: To get the Spent and Receive discount details for Report
* CREATED		: Nandakumar R.G
* CREATED DATE	: 30/10/2009
* MODIFIED
* DATE			AUTHOR				DESCRIPTION
--------------------------------------------------------------------------------------------
* {date}        {developer}      {brief modification description}
* 16.11.2009    Kalaichezhian    to get Purchase Return amount as well as Sales return amount
********************************************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  nvarchar(50)
	DECLARE @TblName  AS nvarchar(500)
	DECLARE @TblStruct  AS nVarchar(4000)
	DECLARE @TblFields  AS nVarchar(4000)
	DECLARE @sSql  AS  nVarChar(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS nVarChar(50)
	--Filter Variable
	DECLARE @FromDate AS DATETIME
	DECLARE @ToDate  AS DATETIME
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	--Till Here
	CREATE TABLE #RptFundManagement
	(
		PurRcptId		INT,
		PurRcptDate		DATETIME,
		PurRcptRefNo	NVARCHAR(100),		
		ReceivedAmt		NUMERIC(38,6),
		SalId			INT,
		SalInvDate		DATETIME,
		SalInvNo		NVARCHAR(100),
		RtrId			INT,
		RtrCode			NVARCHAR(200),
		RtrName			NVARCHAR(200),
		SpentAmt		NUMERIC(38,6)		
	)
	SET @TblName = 'RptFundManagement'
	SET @TblStruct = ' PurRcptId		INT,
		PurRcptRefNo	NVARCHAR(100),
		PurRcptDate		DATETIME,
		ReceivedAmt		NUMERIC(38,6),
		SalId			INT,
		SalInvDate		DATETIME,
		SalInvNo		NVARCHAR(100),
		RtrId			INT,
		RtrCode			NVARCHAR(200),
		RtrName			NVARCHAR(200),
		SpentAmt		NUMERIC(38,6)'
	SET @TblFields = 'PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
	RtrId,RtrCode,RtrName,SpentAmt'
	
	IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptFundManagement_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	DROP TABLE [RptFundManagement_Excel]
	CREATE TABLE RptFundManagement_Excel (PurRcptId INT,PurRcptDate varchar(10),PurRcptRefNo	NVARCHAR(100),ReceivedAmt NUMERIC(38,6),SalId INT,SalInvDate Varchar(10),SalInvNo NVARCHAR(100),
		RtrId INT,RtrCode NVARCHAR(200),RtrName NVARCHAR(200),SpentAmt NUMERIC(38,6))
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	SET @Po_Errno = 0
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
		IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TempPurchaseDiscDetail') AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
		DROP TABLE TempPurchaseDiscDetail
		CREATE TABLE TempPurchaseDiscDetail
		(
			SlNo			INT IDENTITY(1,1),
			PurRcptId		INT,
			PurRcptDate		DATETIME,
			PurRcptRefNo	NVARCHAR(100),		
			ReceivedAmt		NUMERIC(38,6)
		)
	
		IF EXISTS (SELECT * FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TempSalInvDiscDetail') AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
		DROP TABLE TempSalInvDiscDetail
		CREATE TABLE TempSalInvDiscDetail
		(
			SlNo			INT IDENTITY(1,1),
			SalId			INT,
			SalInvDate		DATETIME,
			SalInvNo		NVARCHAR(100),
			RtrId			INT,
			RtrCode			NVARCHAR(100),
			RtrName			NVARCHAR(100),
			SpentAmt		NUMERIC(38,6)
		)
		INSERT INTO TempPurchaseDiscDetail
			SELECT PR.PurRcptId,PR.GOodsRcvdDate,PR.CmpInvNo AS PurRcptRefNo,SUM(PRLA.LinebaseQtyAmount) ReceivedAmt
			FROM PurchaseReceiptLineAmount PRLA,PurchaseReceipt PR,PurchaseSequenceDetail PSD
			WHERE PR.PurRcptId=PRLA.PurRcptId AND PSD.PurSeqId=PR.PurSeqId AND PSD.RefCode=PRLA.RefCode
			AND PSD.EffectInNetAmount=2 AND PR.Status=1
			AND PR.GOodsRcvdDate BETWEEN @FromDate AND @ToDate
			GROUP BY PR.PurRcptId,PR.GOodsRcvdDate,PR.CmpInvNo
			HAVING SUM(PRLA.LinebaseQtyAmount)>0
		UNION ALL  		
			SELECT PR.PurRetId AS PurRcptId,PR.PurRetDate AS GOodsRcvdDate,PR.CmpInvNo AS PurRcptRefNo,(-SUM(PRLA.LineBaseQtyAmount)) ReceivedAmt
			FROM PurchaseReturnLineAmount PRLA,PurchaseReturn PR,PurchaseSequenceDetail PSD
			WHERE PR.PurRetId=PRLA.PurRetId AND PSD.PurSeqId=PR.PurSeqId AND PSD.RefCode=PRLA.RefCode
		    AND PR.PurRetDate BETWEEN @FromDate AND @ToDate AND PSD.EffectInNetAmount=2
			GROUP BY PR.PurRetId,PR.PurRetDate,PR.CmpInvNo
			HAVING SUM(PRLA.LinebaseQtyAmount)>0		
		UNION ALL
			SELECT 1000 AS PurRcptId,FundDate AS GOodsRcvdDate,FundSetNo AS PurRcptRefNo,
			Amount AS ReceivedAmt FROM FundSettlement WHERE Amount>0 AND  FundDate BETWEEN @FromDate AND @ToDate
		INSERT INTO TempSalInvDiscDetail
			SELECT SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.RtrId,R.RtrCode,R.RtrName,SUM(SILA.DiscountPerAmount) AS SpentAmt
			FROM SalesInvoiceSchemeLineWise SILA,SalesInvoice SI,Retailer R
			WHERE Si.SalId=SILA.SalId AND SI.RtrId=R.RtrId AND SI.DlvSts>=4
			AND SI.SalInvDate BETWEEN @FromDate AND @ToDate 
			GROUP BY SI.SalId,SI.SalInvDate,SI.SalInvNo,SI.RtrId,R.RtrCode,R.RtrName
			HAVING SUM(SILA.DiscountPerAmount)>0
		UNION ALL
			SELECT RH.ReturnID AS SalId,RH.ReturnDate AS SalInvDate,RH.ReturnCode AS SalInvNo,RH.RtrId,R.RtrCode,R.RtrName,(-SUM(RLA.LineBaseQtyAmt)) AS SpentAmt
			FROM ReturnLineAmount RLA,ReturnHeader RH,BillSequenceDetail BSD,Retailer R
			WHERE RH.ReturnID=RLA.ReturnId AND BSD.BillSeqId=RH.BillSeqId AND BSD.RefCode=RLA.RefCode
			AND RH.RtrId=R.RtrId AND RH.ReturnDate Between @FromDate AND @ToDate AND BSD.RefCode='E' AND BSD.EffectInNetAmount=2
			GROUP BY RH.ReturnID,RH.ReturnDate,RH.ReturnCode,RH.RtrId,R.RtrCode,R.RtrName
			HAVING SUM(RLA.LineBaseQtyAmt)>0	
		UNION ALL
			SELECT 1000 AS PurRcptId,FundDate AS GOodsRcvdDate,FundSetNo AS PurRcptRefNo,'' AS RtrId,'' AS RtrCode,'' AS RtrName,
			-(Amount) AS ReceivedAmt FROM FundSettlement WHERE Amount<0 AND  FundDate BETWEEN @FromDate AND @ToDate	
		
		IF (SELECT COUNT(*) FROM TempPurchaseDiscDetail)>(SELECT COUNT(*) FROM TempSalInvDiscDetail)
		BEGIN
			INSERT INTO #RptFundManagement(PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
			RtrId,RtrCode,RtrName,SpentAmt)
			SELECT ISNULL(PurRcptId,9999),ISNULL(PurRcptDate,GETDATE()),ISNULL(PurRcptRefNo,''),ISNULL(ReceivedAmt,0),
			ISNULL(SalId,0),ISNULL(SalInvDate,GETDATE()),ISNULL(SalInvNo,''),ISNULL(RtrId,0),ISNULL(RtrCode,''),
			ISNULL(RtrName,''),ISNULL(SpentAmt,0)
			FROM TempPurchaseDiscDetail TP
			LEFT OUTER JOIN TempSalInvDiscDetail TS ON TP.SlNo=TS.SlNo			
		END
		ELSE
		BEGIN
			INSERT INTO #RptFundManagement(PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
			RtrId,RtrCode,RtrName,SpentAmt)	
			SELECT ISNULL(PurRcptId,9999),ISNULL(PurRcptDate,GETDATE()),ISNULL(PurRcptRefNo,''),ISNULL(ReceivedAmt,0),
			ISNULL(SalId,0),ISNULL(SalInvDate,GETDATE()),ISNULL(SalInvNo,''),ISNULL(RtrId,0),ISNULL(RtrCode,''),
			ISNULL(RtrName,''),ISNULL(SpentAmt,0)
			FROM TempPurchaseDiscDetail TP
			RIGHT OUTER JOIN TempSalInvDiscDetail TS ON TP.SlNo=TS.SlNo			
		END
				
		IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptFundManagement ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptFundManagement'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptFundManagement ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			SET @Po_Errno = 1
			PRINT 'DataBase or Table not Found'
			RETURN
		END
	END
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptFundManagement
	
		DECLARE @RecCount AS BIGINT 
		SET @RecCount =(SELECT count(*) FROM #RptFundManagement)
    	IF @RecCount > 0
			BEGIN
                IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TMpRptFundManagement')
					BEGIN 
						DROP TABLE TMpRptFundManagement
						SELECT * INTO TMpRptFundManagement FROM RptFundManagement_Excel WHERE 1=2
					END 
				 ELSE
					BEGIN 
						SELECT * INTO TMpRptFundManagement FROM RptFundManagement_Excel WHERE 1=2
					END 
				INSERT INTO TMpRptFundManagement (PurRcptId ,PurRcptRefNo ,ReceivedAmt,SpentAmt)
					SELECT 999999,'Total',sum(ReceivedAmt),sum(SpentAmt)
				FROM 
						#RptFundManagement
				INSERT INTO RptFundManagement_Excel (PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
						RtrId,RtrCode,RtrName,SpentAmt)
                  SELECT PurRcptId,(CONVERT(NVARCHAR(11),PurRcptDate ,103)),PurRcptRefNo,ReceivedAmt,SalId,(CONVERT(NVARCHAR(11),SalInvDate ,103)),SalInvNo,
						RtrId,RtrCode,RtrName,SpentAmt 
					FROM #RptFundManagement
				
				INSERT INTO RptFundManagement_Excel (PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
							RtrId,RtrCode,RtrName,SpentAmt)
				SELECT PurRcptId,PurRcptDate,PurRcptRefNo,ReceivedAmt,SalId,SalInvDate,SalInvNo,
							RtrId,RtrCode,RtrName,SpentAmt
					FROM TMpRptFundManagement ORDER BY PurRcptId
                UPDATE RptFundManagement_Excel SET PurRcptDate='' WHERE  ReceivedAmt=0
                UPDATE RptFundManagement_Excel SET SalInvDate='' WHERE  SpentAmt=0
				UPDATE RptFundManagement_Excel SET ReceivedAmt=null WHERE  ReceivedAmt=0
                UPDATE RptFundManagement_Excel SET SpentAmt=null WHERE  SpentAmt=0
			END	  
	
	SELECT * FROM #RptFundManagement
	PRINT 'Data Executed'
	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptLaunchProduct' AND XTYPE='P')
DROP PROCEDURE Proc_RptLaunchProduct
GO
-- EXEC Proc_RptLaunchProduct 235,1,0,'JNJ_New',0,0,1 
CREATE PROCEDURE Proc_RptLaunchProduct
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptLaunchProduct
* PURPOSE		: To get the New Product Target Analysis DSR Wise
* CREATED		: Alphonse J
* CREATED DATE	: 15/01/2013
* MODIFIED
* DATE			AUTHOR				DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	DECLARE @JcmId		INT
	DECLARE @JcMonth	INT
	DECLARE @SMId		INT
	DECLARE @LaunchNo	INT
	
	SET @JcmId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
	SET @JcMonth =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,13,@Pi_UsrId))
	SET @SMId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @LaunchNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,278,@Pi_UsrId))
	
	CREATE TABLE #LaunchProduct
	(
	[DSR NAME]				NVARCHAR(200),
	[Launch SKU]			NVARCHAR(500),
	[Total No Of Outlets]	BIGINT,
	[Planned Outlets]		BIGINT,
	[Outlets Billed]		BIGINT,
	[Achivement1%]			NVARCHAR(10),
	[Sales Plan]			NUMERIC(36,0),
	[Sales Actual]			NUMERIC(36,0),
	[Achivement2%]			NVARCHAR(10)
	)
	
	CREATE TABLE #SelRate
	(
	SlNo		INT IDENTITY(1,1),
	PrdId		BIGINT,
	SelRate		NUMERIC(18,6)
	)
	SELECT	SM.SMName,P.PrdCtgValMainId,P.PrdCtgValName,SUM(LTD.NoOfRet) NoOfRet,ROUND(SUM(LTMP.PlanNoOfRetSplit),0) PNoOfRet,SUM(LTMP.ActNoOfRet) NoOfRetBilled,
			((SUM(LTMP.ActNoOfRet)/SUM(LTMP.PlanNoOfRetSplit))*100) Achivement1,
			ROUND(SUM(LTMP.PlanNoOfRetSplit*PlanPerRetInVal),0) SalesPlan,ROUND(SUM(LTMP.ActualVal),0) SalesActual,
			CASE (SUM(LTMP.PlanNoOfRetSplit*PlanPerRetInVal)) WHEN 0 THEN 0
			ELSE ROUND((SUM(LTMP.ActualVal)/(SUM(LTMP.PlanNoOfRetSplit*PlanPerRetInVal))),0) END Achivement2 INTO #Temp  
	FROM	LaunchTargetHd							LTH
			INNER JOIN LaunchTargetDt				LTD  ON LTH.SLaunchNo=LTD.SLaunchNo 
			INNER JOIN LaunchTargetMonthPlan		LTMP ON LTH.SLaunchNo=LTMP.SLaunchNo AND LTD.LaunchRowId=LTMP.LaunchRowId
			INNER JOIN Salesman						SM   ON LTD.SMId=SM.SMId 
			INNER JOIN ProductCategoryValue 		P    ON LTMP.PrdId=P.PrdCtgValMainId
			
	WHERE	LTH.JcmId=@JcmId   
			AND	(LTD.SMId= (CASE @SMId WHEN 0 THEN LTD.SMId ELSE 0 END) OR
								LTD.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
			AND	(LTMP.LaunchMonthId= (CASE @JcMonth WHEN 0 THEN LTMP.LaunchMonthId ELSE 0 END) OR
								LTMP.LaunchMonthId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,13,@Pi_UsrId)))
			AND (LTH.SLaunchNo= (CASE @LaunchNo WHEN 0 THEN LTH.SLaunchNo ELSE 0 END) OR
								LTH.SLaunchNo in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,278,@Pi_UsrId)))
	GROUP BY SM.SMName,P.PrdCtgValMainId,P.PrdCtgValName
	INSERT INTO #LaunchProduct
	SELECT	SMName,PrdCtgValName,NoOfRet,PNoOfRet,NoOfRetBilled,CAST(CAST(Achivement1 AS NUMERIC(36,0)) AS NVARCHAR(20))+'%' Achivement1,
			CAST(SalesPlan AS NUMERIC(36,0)) SalesPlan,CAST(SalesActual AS NUMERIC(36,0)) SalesActual,CAST(CAST(Achivement2 AS NUMERIC(18,0)) AS NVARCHAR(20))+'%'  Achivement2 FROM #Temp   
	
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #LaunchProduct
	SELECT * FROM #LaunchProduct
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptNNetSales' AND XTYPE='P')
DROP PROCEDURE Proc_RptNNetSales
GO
--EXEC Proc_RptNNetSales 216,1,0,'corestocky',0,0,1,0
CREATE PROCEDURE Proc_RptNNetSales
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT,
	@Po_Errno  INT OUTPUT
)
AS
/************************************************************
* VIEW	: Proc_RptNNetSales
* PURPOSE	: To get the Product details
* CREATED BY	: Murugan.R
* CREATED DATE	: 07/01/2010
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	NVARCHAR(50)
	DECLARE @TblName 	AS	NVARCHAR(500)
	DECLARE @TblStruct 	AS	NVARCHAR(4000)
	DECLARE @TblFields 	AS	NVARCHAR(4000)
	DECLARE @sSql		AS 	NVARCHAR(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	NVARCHAR(50)
	
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @CmpId 		AS	INT
	DECLARE @LcnId 		AS	INT
	DECLARE @SMId 		AS	INT
	DECLARE @RMId 		AS	INT
	DECLARE @RtrId	 	AS	INT
	DECLARE @PrdCatId	AS	INT
	DECLARE @PrdBatId	AS	INT
	DECLARE @PrdId		AS	INT
	DECLARE @FromBillNo	 	AS	BIGINT
	DECLARE @TOBillNo	 	AS	BIGINT
	DECLARE @CancelValue	AS	INT
	DECLARE @BillStatus	AS	INT
	DECLARE @IncludeSR	AS 	INT
	DECLARE @SRStock	AS 	INT
	DECLARE @RptType AS INT 
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	
    SELECT @RptType = iCountId FROM Fn_ReturnRptFilters(@Pi_RptId,259,@Pi_UsrId) 
	SELECT DISTINCT Prdid,U.Uomgroupid 
	INTO #ProductTemp 
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	GROUP BY Prdid,U.Uomgroupid HAVING Count(U.UomgroupId)>1
	SELECT DISTINCT Prdid,U.Uomgroupid
	INTO #ProductTemp1 
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	GROUP BY Prdid,U.Uomgroupid Having Count(U.UomgroupId)<=1
	CREATE TABLE #RptNNetSales
	(
		Prdid INT,
		Prdbatid INT,
		Prdccode Varchar(100),
		PrdName Varchar(200),
		CmpBatCode Varchar(100),
		MRP Numeric(18,4),
		SalesBaseQty INT,
		SalesValue  Numeric(36,4),
		SalesTaxValue Numeric(36,4),
        SalesSchDiscount Numeric(36,4),
		SalesOthrDiscount Numeric(36,4),
		RtnBaseQty INT,
		RtnSaleValue Numeric(36,4),
		RtnTaxValue Numeric(36,4),
		RtnSchDiscount Numeric(36,4),
		RtnOthrDiscount Numeric(36,4),
		NetSales Numeric(36,4),
		NetTaxValue Numeric(36,4)
	)
		
		CREATE TABLE #RptNNetSalesOUT
	(
		Prdid INT,
		Prdbatid INT,
		Prdccode Varchar(100),
		PrdName Varchar(200),
		CmpBatCode Varchar(100),
		MRP Numeric(18,4),
		SalesBaseQty INT,
		SalesValue  Numeric(36,4),
		SalesTaxValue Numeric(36,4),
		SalesSchDiscount Numeric(36,4),
		SalesOthrDiscount Numeric(36,4),
		RtnBaseQty INT,
		RtnSaleValue Numeric(36,4),
		RtnTaxValue Numeric(36,4),
		RtnSchDiscount Numeric(36,4),
		RtnOthrDiscount Numeric(36,4),
		NetQty INT,
		NetSales Numeric(36,4),
		NetTaxValue Numeric(36,4),
		SalesCP Varchar(50),
		ReturnCP Varchar(50)
	)
		
        IF @RptType=0 
			BEGIN 
				INSERT INTO #RptNNetSales(Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
										RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue) 
				SELECT P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode,DBO.Fn_ReturnProductRate(P.Prdid,PB.Prdbatid,1) as MRP,SUM(BaseQty) as SalBaseQty,SUM(SalesValue) as SalesValue,
				SUM(TaxValue) as TaxValue,sum(SalesSchDiscount),Sum(SalesOthrDiscount),SUM(RtnBaseQty) as RtnBaseQty,SUM(RtnSaleValue) as RtnSaleValue,SUM(RtnTaxValue) as RtnTaxValue, sum(RtnSchDiscount) AS RtnSchDiscount,sum(RtnOthrDiscount) AS RtnOthrDiscount,
				SUM(SalesValue-RtnSaleValue) as NetSales, SUM(TaxValue-RtnTaxValue) as NetTaxValue 
				FROM(
					SELECT Prdid,Prdbatid,Isnull(SUM(BaseQty),0) as BaseQty,SUM(PrdGrossAmount-(PrdSplDiscAmount+PrdSchDiscAmount+PrdDbDiscAmount+PrdCdAmount)) as SalesValue ,ISNULL(SUM(PrdTaxAmount),0) as TaxValue,sum(PrdSchDiscAmount) AS SalesSchDiscount,sum((SplDiscAmount+PrdSplDiscAmount+PrdDBDiscAmount+PrdCDAmount)) AS SalesOthrDiscount,
					0 as RtnBaseQty,0 as RtnSaleValue,0 as RtnTaxValue,0 AS RtnSchDiscount, 0 AS RtnOthrDiscount
					FROM SalesInvoice SI  INNER JOIN SalesInvoiceProduct SIP On SI.Salid=SIP.Salid 
		--			INNER JOIN(
		--			SELECT Prdslno,salid,SUM(LineBaseQtyAmount) as TotalDeduction FROM SalesinvoiceLineAmount WHERE RefCode IN('D','E','F','G','I','K')
		--			GROUP BY Prdslno,salid)X ON X.Salid=Si.Salid and X.Salid=SIP.Salid and SIP.Slno=X.PrdSlno
					WHERE SalInvdate Between @FromDate and @ToDate and Dlvsts>3 AND
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid
				UNION ALL
					SELECT Prdid,Prdbatid,0 as BaseQty,0 as SalesValue,0 as TaxValue,0 AS SalesSchDiscount,0 AS SalesOthrDiscount,
					Isnull(SUM(BaseQty),0) as RtnBaseQty,SUM(PrdGrossAmt-X.TotalDeduction) as RtnSaleValue ,ISNULL(SUM(PrdTaxAmt),0) as RtnTaxValue,sum(PrdSchDisAmt) AS  RtnSchDiscount,sum((PrdSplDisAmt+PrdDBDisAmt+PrdCDDisAmt)) AS RtnOthrDiscount
					FROM ReturnHeader SI  INNER JOIN ReturnProduct SIP On SI.ReturnID=SIP.ReturnID INNER JOIN(
					Select Prdslno,ReturnID,SUM(LineBaseQtyAmt) as TotalDeduction FROM ReturnLineAmount WHERE RefCode IN('D','E','F','G')
					GROUP BY Prdslno,ReturnID)X ON X.ReturnID=Si.ReturnID and X.ReturnID=SIP.ReturnID and SIP.Slno=X.PrdSlno
					WHERE ReturnDate Between @FromDate and @ToDate and Status=0 AND SI.SalId<>0 AND 
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid 
				)M
				INNER JOIN Product P ON M.Prdid=P.Prdid 
				INNER JOIN Productbatch PB ON P.Prdid=Pb.PrdId  and M.Prdid=PB.Prdid and M.Prdbatid=PB.Prdbatid
				INNER JOIN Company C ON C.Cmpid=P.CmpId
				WHERE 
				(C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
						C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdCatId WHEN 0 THEN P.PrdId Else 0 END) OR
						P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdId WHEN 0 THEN P.PrdId Else 0 END) OR
		 			P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))) 			
				GROUP BY P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode  --,PrdbatdetailValue
			END 
		ELSE
		IF @RptType=1 
			BEGIN 
				INSERT INTO #RptNNetSales(Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
										RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue)
				SELECT P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode,DBO.Fn_ReturnProductRate(P.Prdid,PB.Prdbatid,1) as MRP,SUM(BaseQty) as SalBaseQty,SUM(SalesValue) as SalesValue,
				SUM(TaxValue) as TaxValue,sum(SalesSchDiscount),Sum(SalesOthrDiscount),SUM(RtnBaseQty) as RtnBaseQty,SUM(RtnSaleValue) as RtnSaleValue,SUM(RtnTaxValue) as RtnTaxValue, sum(RtnSchDiscount) AS RtnSchDiscount,sum(RtnOthrDiscount) AS RtnOthrDiscount,
				SUM(SalesValue-RtnSaleValue) as NetSales, SUM(TaxValue-RtnTaxValue) as NetTaxValue 
				FROM(
					SELECT Prdid,Prdbatid,Isnull(SUM(BaseQty),0) as BaseQty,SUM(PrdGrossAmount-(PrdSplDiscAmount+PrdSchDiscAmount+PrdDbDiscAmount+PrdCdAmount)) as SalesValue ,ISNULL(SUM(PrdTaxAmount),0) as TaxValue,sum(PrdSchDiscAmount) AS SalesSchDiscount,sum((SplDiscAmount+PrdSplDiscAmount+PrdDBDiscAmount+PrdCDAmount)) AS SalesOthrDiscount,
					0 as RtnBaseQty,0 as RtnSaleValue,0 as RtnTaxValue,0 AS RtnSchDiscount, 0 AS RtnOthrDiscount
					FROM SalesInvoice SI  INNER JOIN SalesInvoiceProduct SIP On SI.Salid=SIP.Salid 
		--			INNER JOIN(
		--			SELECT Prdslno,salid,SUM(LineBaseQtyAmount) as TotalDeduction FROM SalesinvoiceLineAmount WHERE RefCode IN('D','E','F','G','I','K')
		--			GROUP BY Prdslno,salid)X ON X.Salid=Si.Salid and X.Salid=SIP.Salid and SIP.Slno=X.PrdSlno
					WHERE SalInvdate Between @FromDate and @ToDate and Dlvsts>3 AND
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid
				UNION ALL
					SELECT Prdid,Prdbatid,0 as BaseQty,0 as SalesValue,0 as TaxValue,0 AS SalesSchDiscount,0 AS SalesOthrDiscount,
					Isnull(SUM(BaseQty),0) as RtnBaseQty,SUM(PrdGrossAmt-X.TotalDeduction) as RtnSaleValue ,ISNULL(SUM(PrdTaxAmt),0) as RtnTaxValue,sum(PrdSchDisAmt) AS  RtnSchDiscount,sum((PrdSplDisAmt+PrdDBDisAmt+PrdCDDisAmt)) AS RtnOthrDiscount
					FROM ReturnHeader SI  INNER JOIN ReturnProduct SIP On SI.ReturnID=SIP.ReturnID INNER JOIN(
					Select Prdslno,ReturnID,SUM(LineBaseQtyAmt) as TotalDeduction FROM ReturnLineAmount WHERE RefCode IN('D','E','F','G')
					GROUP BY Prdslno,ReturnID)X ON X.ReturnID=Si.ReturnID and X.ReturnID=SIP.ReturnID and SIP.Slno=X.PrdSlno
					WHERE ReturnDate Between @FromDate and @ToDate and Status=0 AND SI.SalId=0 AND 
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid 
				)M
				INNER JOIN Product P ON M.Prdid=P.Prdid 
				INNER JOIN Productbatch PB ON P.Prdid=Pb.PrdId  and M.Prdid=PB.Prdid and M.Prdbatid=PB.Prdbatid
				INNER JOIN Company C ON C.Cmpid=P.CmpId
				WHERE 
				(C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
						C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdCatId WHEN 0 THEN P.PrdId Else 0 END) OR
						P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdId WHEN 0 THEN P.PrdId Else 0 END) OR
		 			P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))) 			
				GROUP BY P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode  --,PrdbatdetailValue
			END 
		ELSE
		IF @RptType=2 
			BEGIN 
				INSERT INTO #RptNNetSales(Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
										RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue)
				SELECT P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode,DBO.Fn_ReturnProductRate(P.Prdid,PB.Prdbatid,1) as MRP,SUM(BaseQty) as SalBaseQty,SUM(SalesValue) as SalesValue,
				SUM(TaxValue) as TaxValue,sum(SalesSchDiscount),Sum(SalesOthrDiscount),SUM(RtnBaseQty) as RtnBaseQty,SUM(RtnSaleValue) as RtnSaleValue,SUM(RtnTaxValue) as RtnTaxValue,sum(RtnSchDiscount) AS RtnSchDiscount,sum(RtnOthrDiscount) AS RtnOthrDiscount,
				SUM(SalesValue-RtnSaleValue) as NetSales, SUM(TaxValue-RtnTaxValue) as NetTaxValue 
				FROM(
					SELECT Prdid,Prdbatid,Isnull(SUM(BaseQty),0) as BaseQty,SUM(PrdGrossAmount-(PrdSplDiscAmount+PrdSchDiscAmount+PrdDbDiscAmount+PrdCdAmount)) as SalesValue ,ISNULL(SUM(PrdTaxAmount),0) as TaxValue,sum(PrdSchDiscAmount) AS SalesSchDiscount,sum((SplDiscAmount+PrdSplDiscAmount+PrdDBDiscAmount+PrdCDAmount)) AS SalesOthrDiscount,
					0 as RtnBaseQty,0 as RtnSaleValue,0 as RtnTaxValue,0 AS RtnSchDiscount, 0 AS RtnOthrDiscount
					FROM SalesInvoice SI  INNER JOIN SalesInvoiceProduct SIP On SI.Salid=SIP.Salid 
		--			INNER JOIN(
		--			SELECT Prdslno,salid,SUM(LineBaseQtyAmount) as TotalDeduction FROM SalesinvoiceLineAmount WHERE RefCode IN('D','E','F','G','I','K')
		--			GROUP BY Prdslno,salid)X ON X.Salid=Si.Salid and X.Salid=SIP.Salid and SIP.Slno=X.PrdSlno
					WHERE SalInvdate Between @FromDate and @ToDate and Dlvsts>3 AND
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid
				UNION ALL
					SELECT Prdid,Prdbatid,0 as BaseQty,0 as SalesValue,0 as TaxValue,0 AS SalesSchDiscount,0 AS SalesOthrDiscount,
					Isnull(SUM(BaseQty),0) as RtnBaseQty,SUM(PrdGrossAmt-X.TotalDeduction) as RtnSaleValue ,ISNULL(SUM(PrdTaxAmt),0) as RtnTaxValue,sum(PrdSchDisAmt) AS  RtnSchDiscount,sum((PrdSplDisAmt+PrdDBDisAmt+PrdCDDisAmt)) AS RtnOthrDiscount
					FROM ReturnHeader SI  INNER JOIN ReturnProduct SIP On SI.ReturnID=SIP.ReturnID INNER JOIN(
					Select Prdslno,ReturnID,SUM(LineBaseQtyAmt) as TotalDeduction FROM ReturnLineAmount WHERE RefCode IN('D','E','F','G')
					GROUP BY Prdslno,ReturnID)X ON X.ReturnID=Si.ReturnID and X.ReturnID=SIP.ReturnID and SIP.Slno=X.PrdSlno
					WHERE ReturnDate Between @FromDate and @ToDate and Status=0 AND 
					(SI.Rtrid = (CASE @RtrId WHEN 0 THEN SI.Rtrid ELSE 0 END) OR
					SI.Rtrid in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
					AND (SI.RMID=(CASE @RMId WHEN 0 THEN SI.RMID ELSE 0 END) OR
					SI.RMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
					AND (SI.SMID=(CASE @SMId WHEN 0 THEN SI.SMID ELSE 0 END) OR
					SI.SMID in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
					GROUP BY Prdid,Prdbatid 
				)M
				INNER JOIN Product P ON M.Prdid=P.Prdid 
				INNER JOIN Productbatch PB ON P.Prdid=Pb.PrdId  and M.Prdid=PB.Prdid and M.Prdbatid=PB.Prdbatid
				INNER JOIN Company C ON C.Cmpid=P.CmpId
				WHERE 
				(C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
						C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdCatId WHEN 0 THEN P.PrdId Else 0 END) OR
						P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND	(P.PrdId = (CASE @PrdId WHEN 0 THEN P.PrdId Else 0 END) OR
		 			P.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))) 			
				GROUP BY P.Prdid,PB.Prdbatid,Prdccode,PrdName,CmpBatCode  --,PrdbatdetailValue
			END 
		
		INSERT INTO #RptNNetSalesOUT(Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
								RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue,SalesCP,ReturnCP)
		SELECT RT.Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
								RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue,
		CAST(CASE WHEN SalesBaseQty<MAX(ConversionFactor) THEN 0 ELSE SalesBaseQty/MAX(ConversionFactor)END  AS VARCHAR(20) ) 
		+'/'+
		CAST(CASE WHEN SalesBaseQty<MAX(ConversionFactor) THEN SalesBaseQty ELSE SalesBaseQty%MAX(ConversionFactor) END AS VARCHAR(20) ) 
		AS SalesCP,
		CAST(CASE WHEN RtnBaseQty<MAX(ConversionFactor) THEN 0 ELSE RtnBaseQty/MAX(ConversionFactor)END  AS VARCHAR(20) ) 
		+'/'+
		CAST(CASE WHEN RtnBaseQty<MAX(ConversionFactor) THEN RtnBaseQty ELSE RtnBaseQty%MAX(ConversionFactor) END AS VARCHAR(20) ) 
		AS ReturnCP
		FROM #RptNNetSales RT INNER JOIN #ProductTemp P ON P.Prdid=RT.Prdid
		INNER JOIN UOMGROUP UG ON P.Uomgroupid=UG.UomGroupId
		GROUP BY RT.Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,
					SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue
		
		
		INSERT INTO #RptNNetSalesOUT(Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
								RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue,SalesCP,ReturnCP)
		SELECT RT.Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,
								RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue,
		CAST(ISNULL(CASE WHEN UM.UOMID=2 THEN SalesBaseQty END, 0) AS VARCHAR(20))
			+'/'+
		CAST(ISNULL(CASE WHEN UM.UOMID=1 THEN SalesBaseQty END,0) AS VARCHAR(20)) AS SalesCP,
		CAST(ISNULL(CASE WHEN UM.UOMID=2 THEN RtnBaseQty END, 0) AS VARCHAR(20))
			+'/'+
		CAST(ISNULL(CASE WHEN UM.UOMID=1 THEN RtnBaseQty END,0) AS VARCHAR(20)) AS ReturnCP
		FROM #RptNNetSales RT INNER JOIN #ProductTemp1 P ON P.Prdid=RT.Prdid
		INNER JOIN UOMGROUP UG ON P.Uomgroupid=UG.UomGroupId
		INNER JOIN UOMMASTER UM ON UM.UOMID=UG.UOMID
		GROUP BY RT.Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,
					SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetSales,NetTaxValue,UM.UomId
		
		--Find Total Stock
		--Don't Change product name 'ZZZZZ' Used in rpt to Supress Last Record
--		IF EXISTS(SELECT * FROM #RptNNetSalesOUT)
--		BEGIN
--			INSERT INTO #RptNNetSalesOUT
--			Select 0,0,'000000000000000000','ZZZZZ','',0,0,0,0,0,0,0,0,0,0,
--			Cast(SUM(Cast(Substring(SalesCP,1,CharIndex('/',SalesCP)-1) as INT)) as Varchar(20)) +'/'+ 
--			Cast(SUM(Cast(Substring(SalesCP,CharIndex('/',SalesCP)+1,Len(SalesCP)) as INT)) as Varchar(20)),
--			Cast(SUM(Cast(Substring(ReturnCP,1,CharIndex('/',ReturnCP)-1) as INT)) as Varchar(20)) +'/'+ 
--			Cast(SUM(Cast(Substring(ReturnCP,CharIndex('/',ReturnCP)+1,Len(ReturnCP)) as INT)) as Varchar(20))	
--			FROM #RptNNetSalesOUT	
--		END
		
		--Check for Report Data
		Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptNNetSalesOUT
		-- Till Here
       UPDATE #RptNNetSalesOUT SET NetQty=SalesBaseQty-RtnBaseQty
		SELECT Prdid,Prdbatid,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty,SalesValue,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty,RtnSaleValue,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,
			NetQty,NetSales,NetTaxValue,SalesCP,ReturnCP FROM #RptNNetSalesOUT Order by Prdid
		DECLARE @RecCount AS BIGINT 
		SET @RecCount =(SELECT count(*) FROM #RptNNetSalesOUT)
    	IF @RecCount > 0
			BEGIN
				IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptNNetsales_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
					DROP TABLE [RptNNetsales_Excel]
					CREATE TABLE RptNNetsales_Excel (Prdid INT,Prdbatid INT,Prdccode Varchar(100),PrdName Varchar(200),CmpBatCode Varchar(100),MRP Numeric(18,4),SalesBaseQty INT,SalesValue  Numeric(36,4),
							SalesTaxValue Numeric(36,4),SalesSchDiscount Numeric(36,4),SalesOthrDiscount Numeric(36,4),RtnBaseQty INT,RtnSaleValue Numeric(36,4),RtnTaxValue Numeric(36,4),RtnSchDiscount Numeric(36,4),RtnOthrDiscount Numeric(36,4),NetQty INT,NetSales Numeric(36,4),
							NetTaxValue Numeric(36,4),SalesCP Varchar(50),ReturnCP Varchar(50))
                IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='TbpRptNNetsalesReport')
					BEGIN 
						DROP TABLE TbpRptNNetsalesReport
						SELECT * INTO TbpRptNNetsalesReport FROM RptNNetsales_Excel WHERE 1=2
					END 
				 ELSE
					BEGIN 
						SELECT * INTO TbpRptNNetsalesReport FROM RptNNetsales_Excel WHERE 1=2
					END 
				INSERT INTO TbpRptNNetsalesReport (Prdid,PrdName,SalesBaseQty ,SalesValue ,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty ,RtnSaleValue ,RtnTaxValue ,RtnSchDiscount,RtnOthrDiscount,NetQty ,NetSales ,NetTaxValue )
					SELECT 999999,'Total',sum(SalesBaseQty) ,sum(SalesValue) ,sum(SalesTaxValue),sum(SalesSchDiscount),sum(SalesOthrDiscount),sum(RtnBaseQty ),sum(RtnSaleValue ),sum(RtnTaxValue),sum(RtnSchDiscount),sum(RtnOthrDiscount),sum(NetQty ),sum(NetSales ),sum(NetTaxValue)
				FROM 
						#RptNNetSalesOUT
				INSERT INTO RptNNetsales_Excel (Prdid,Prdbatid ,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty ,SalesValue  ,
									SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty ,RtnSaleValue ,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetQty ,NetSales ,
									NetTaxValue ,SalesCP,ReturnCP)
					SELECT Prdid,Prdbatid ,Prdccode,PrdName,CmpBatCode,MRP,SalesBaseQty ,SalesValue  ,
									SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty ,RtnSaleValue ,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetQty ,NetSales ,
									NetTaxValue ,SalesCP,ReturnCP
					FROM #RptNNetSalesOUT
				
				INSERT INTO RptNNetsales_Excel (Prdid,PrdName,SalesBaseQty ,SalesValue ,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty,RtnSaleValue ,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount,NetQty ,NetSales ,NetTaxValue)
				SELECT Prdid,PrdName,SalesBaseQty ,SalesValue ,SalesTaxValue,SalesSchDiscount,SalesOthrDiscount,RtnBaseQty ,RtnSaleValue ,RtnTaxValue,RtnSchDiscount,RtnOthrDiscount ,NetQty ,NetSales ,NetTaxValue    
					FROM TbpRptNNetsalesReport 
			END	
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RPTOUTLETWISERETAILING_Excel' AND XTYPE='U')
DROP TABLE RPTOUTLETWISERETAILING_Excel
GO
CREATE TABLE RPTOUTLETWISERETAILING_Excel(
	[RTRID] [int] NULL,
	[RTRNM] [varchar](50) NULL,
	[COVERAGE] [varchar](50) NULL,
	[CLASS1] [varchar](50) NULL,
	[CATEGORY] [varchar](50) NULL,
	[WEEK1] [float] NULL,
	[WEEK2] [float] NULL,
	[WEEK3] [float] NULL,
	[WEEK4] [float] NULL,
	[WEEK5] [float] NULL,
	[USRID] [float] NULL,
	[SRPID] [int] NULL,
	[JCMID] [int] NULL,
	[RtrAdd1] [varchar](50) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptFindClasification' AND XTYPE='U')
DROP TABLE RptFindClasification
GO
CREATE TABLE RptFindClasification(
	[rtrcount] [int] NULL,
	[Calssnm] [varchar](250) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptFindChannel' AND XTYPE='U')
DROP TABLE RptFindChannel
GO
CREATE TABLE RptFindChannel(
	[rtrcount] [int] NULL,
	[Channelnm] [varchar](250) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptOutletwiseRetailing' AND XTYPE='P')
DROP PROCEDURE Proc_RptOutletwiseRetailing
GO
--EXEC Proc_RptOutletwiseRetailing 212,1,0,'',0,0,1,0
CREATE PROCEDURE Proc_RptOutletwiseRetailing
(
@Pi_RptId  INT,
@Pi_UsrId  INT,
@Pi_SnapId  INT,
@Pi_DbName  nvarchar(50),
@Pi_SnapRequired INT,
@Pi_GetFromSnap  INT,
@Pi_CurrencyId  INT,
@Po_Errno  INT OUTPUT
)
AS 
BEGIN 
SET NOCOUNT ON
DECLARE @SSQL VARCHAR(1000)
DECLARE @W1 INT
DECLARE @W2 INT
DECLARE @JM INT
DECLARE @JM1 INT
DECLARE	@JCID INT
DECLARE	@JCMNT INT
DECLARE	@MNFID INT
DECLARE	@SRPID INT
DECLARE	@MKTID INT
DECLARE	@BEATTYPE INT
DECLARE	@JCID1 INT
DECLARE @NewSnapId  AS INT
DECLARE @DBNAME  AS  nvarchar(50)
DECLARE @TblName  AS nvarchar(500)
DECLARE @TblStruct  AS nVarchar(4000)
DECLARE @TblFields  AS nVarchar(4000)
DECLARE @ErrNo   AS INT
DECLARE @PurDBName AS nVarChar(50)
SET @JCID = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
SET @JCMNT = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,13,@Pi_UsrId))
SET @JCID1 = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,20,@Pi_UsrId))
SET @MNFID = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @SRPID = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
SET @MKTID = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
PRINT @JCID
PRINT @JCMNT
PRINT @JCID1
--PRINT @MNFID
PRINT @SRPID
PRINT @MKTID
IF @SRPID = 0
	SET @SRPID = NULL
IF @MKTID=0
	SET @MKTID=NULL
IF @MNFID=0 
	SET @MNFID=NULL
IF EXISTS (SELECT * FROM sysobjects WHERE xtype='U' AND name='RptOutletRetailing')
DROP TABLE  RptOutletRetailing
CREATE TABLE [RptOutletRetailing](
	[RTRID] [int] ,
	[RTRNM] [varchar](50) ,
	[COVERAGE] [varchar](50) ,
	[CLASS1] [varchar](50) ,
	[CATEGORY] [varchar](50) ,
	[WEEK1] [float] ,
	[WEEK2] [float] ,
	[WEEK3] [float] ,
	[WEEK4] [float] ,
	[WEEK5] [float] ,
	[USRID] [int] ,
	[SRPID] [int] ,
	[JCMID] [int] ,
	[RtrAdd1] [varchar](50)
) ON [PRIMARY]
CREATE TABLE #RPTOUTLETWISERETAILING (
	[RTRID] [int] ,
	[RTRNM] [varchar](50) ,
	[COVERAGE] [varchar](50) ,
	[CLASS1] [varchar](50) ,
	[CATEGORY] [varchar](50) ,
	[WEEK1] [float] ,
	[WEEK2] [float] ,
	[WEEK3] [float] ,
	[WEEK4] [float] ,
	[WEEK5] [float] ,
	[USRID] [int] ,
	[SRPID] [int] ,
	[JCMID] [int] ,
	[RtrAdd1] [varchar](50)
) 
SET @BEATTYPE = 0
IF @BEATTYPE = 0
BEGIN
	SET @JM = @JCMNT
	SET @JM1 = @JCID1
	PRINT @JM
	PRINT @JM1
    --PRINT '1'
	WHILE @JM<=@JM1	               
	BEGIN
        --PRINT '2'
		SET @JCMNT = @JM
		IF @SRPID IS NOT NULL
		BEGIN
			INSERT INTO RptOutletRetailing (RTRID,RTRNM,COVERAGE,CLASS1,CATEGORY,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,SRPID,USRID,JCMID,RtrAdd1)
			SELECT DISTINCT R.RTRID,RTRName,CASE RtrFrequency
			WHEN 1 THEN 'WEEKLY'
			WHEN 2 THEN 'FORTNIGHTLY'
			WHEN 3 THEN 'MONTHLY'
			WHEN 4 THEN 'DAILY'
			WHEN 5 THEN 'BI-WEEKLY' END,ValueClassName,CTGName,0,0,0,0,0,S.SMID,@Pi_UsrId,@JCMNT,R.RtrAdd1 FROM RETAILER R,RETAILERMARKET RM,RouteMaster M,SalesmanMarket S,RetailerCateGOry C,
			RetailerValueClass CT,RetailerValueClassMap RVC	WHERE R.RTRID=RM.RTRID AND RM.RMID=M.RMID AND S.RMID=M.RMID AND S.SMID=ISNULL(@SRPID,SMID)
			AND C.CtgMainId = CT.CtgMainId AND CT.RtrClassId=RVC.RtrValueClassId AND R.RtrId = RVC.RtrId AND M.RMID=ISNULL(@MKTID,M.RMID) AND M.RMSRouteType IN (1,2) --CT.MNFID=ISNULL(@MNFID,CT.MNFID) AND 
			--C.MNFID=ISNULL(@MNFID,C.MNFID)
		END
		ELSE
		BEGIN
			INSERT INTO RptOutletRetailing (RTRID,RTRNM,COVERAGE,CLASS1,CATEGORY,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,SRPID,USRID,JCMID,RtrAdd1)
			SELECT DISTINCT R.RTRID,RTRName,CASE RtrFrequency
			WHEN 1 THEN 'WEEKLY'
			WHEN 2 THEN 'FORTNIGHTLY'
			WHEN 3 THEN 'MONTHLY'
			WHEN 4 THEN 'DAILY'
			WHEN 5 THEN 'BI-WEEKLY' END,0,CTGName,0,0,0,0,0,0,@Pi_UsrId,@JCMNT,R.RtrAdd1 FROM RETAILER R,RouteMaster M,RetailerCateGOry C,
			RetailerValueClass CT,RetailerValueClassMap RVC WHERE
			C.CtgMainId = CT.CtgMainId AND CT.RtrClassId=RVC.RtrValueClassId AND R.RtrId = RVC.RtrId AND M.RMID=ISNULL(@MKTID,M.RMID) AND M.RMSRouteType  IN (1,2)
			GROUP BY R.RTRID,RTRName,RtrFrequency,CTGName,RtrAdd1
			UPDATE RptOutletRetailing SET CATEGORY=(SELECT ValueClassName FROM RetailerValueClass CT,RetailerValueClassMap RVC
			WHERE RVC.RTRID=R.RTRID AND CT.RtrClassId=RVC.RtrValueClassId)
			FROM RptOutletRetailing R
		END
		SET @W1 = (SELECT MIN(JCWWK) FROM JCWEEK WHERE JCMID = @JCID AND JCMJC = @JCMNT)
		SET @W2 = (SELECT MAX(JCWWK) FROM JCWEEK WHERE JCMID = @JCID AND JCMJC = @JCMNT)
		WHILE @W1 <= @W2
		BEGIN
			DELETE FROM RPTTEMPRTRWISE
			IF @SRPID IS NOT NULL
			BEGIN
				INSERT INTO RPTTEMPRTRWISE(VVALUE,RTRID,SRPID,JCMID)
				SELECT SUM(baseqty*PrdUom1EditedSelRate),A.RTRID,A.SMID,@JCMNT FROM SALESINVOICE A,SALESINVOICEPRODUCT AS B,
				PRODUCT AS C,JCWEEK F WHERE A.SALID = B.SALID AND B.PRDID =C.PRDID AND
				A.SMID = ISNULL(@SRPID,A.SMID) AND F.JCMID = @JCID AND F.JCMJC = @JCMNT
				AND A.SALINVDATE BETWEEN F.JCWSDT AND F.JCWEDT AND F.JCWWK = @W1 AND A.DLVSTS IN (1,4,5) AND A.RMID=ISNULL(@MKTID,A.RMID) GROUP BY A.RTRID,A.SMID
			END
			ELSE
			BEGIN
				INSERT INTO RPTTEMPRTRWISE(VVALUE,RTRID,SRPID,JCMID)
				SELECT SUM(baseqty*PrdUom1EditedSelRate),A.RTRID,0,@JCMNT FROM SALESINVOICE A,SALESINVOICEPRODUCT AS B,
				PRODUCT AS C,JCWEEK F WHERE A.SALID = B.SALID AND B.PRDID =C.PRDID AND A.RMID=ISNULL(@MKTID,A.RMID) AND 
				F.JCMID = @JCID AND F.JCMJC = @JCMNT
				AND A.SALINVDATE BETWEEN F.JCWSDT AND F.JCWEDT AND F.JCWWK = @W1 AND A.DLVSTS IN (1,4,5) GROUP BY A.RTRID
			END
			IF @W1 <= 4
			BEGIN
				SET @SSQL = 'UPDATE RptOutletRetailing SET'
				SET @SSQL = @SSQL + ' WEEK' + CAST(@W1 AS VARCHAR(10)) + ' = B.VVALUE'
				SET @SSQL = @SSQL + ' FROM RptOutletRetailing A, RPTTEMPRTRWISE B WHERE A.RTRID = B.RTRID AND A.JCMID = B.JCMID'
				IF @SRPID IS NOT NULL SET @SSQL = @SSQL + ' AND A.SRPID=B.SRPID'
				EXEC (@SSQL)
			END
			IF @W1 >=5
			BEGIN
				SET @SSQL = 'UPDATE RptOutletRetailing SET'
				SET @SSQL = @SSQL + ' WEEK5 = WEEK5 + B.VVALUE'
				SET @SSQL = @SSQL + ' FROM RptOutletRetailing A, RPTTEMPRTRWISE B WHERE A.RTRID = B.RTRID AND A.JCMID = B.JCMID'
				IF @SRPID IS NOT NULL SET @SSQL = @SSQL + ' AND A.SRPID=B.SRPID'
				EXEC (@SSQL)
			END
			SET @W1 = @W1 + 1
		END
		SET @JM = @JM + 1
	END
END 
Select Distinct a.RtrId,C.CtgMainId,CT.ValueClassName AS  Class,C.CtgName AS CtgName INTO #Temp12
From Retailer a,RptOutletRetailing b,RetailerCateGOry C,
			RetailerValueClass CT,RetailerValueClassMap RVC
Where A.RtrId = B.RtrId and C.CtgMainId = CT.CtgMainId AND CT.RtrClassId=RVC.RtrValueClassId AND A.RtrId = RVC.RtrId 
Update RptOutletRetailing SET Class1 = Class,CATEGORY=CtgName 
FROM RptOutletRetailing a,#Temp12 B
where a.RtrId = B.RtrId 
UPDATE RptFormula SET Formulavalue=(Select  datename(mm,jcmSdt)+ '-' + CAST(YEAR(jcmSdt) AS varchar) as Nvalue from jcmonth a,ReportFilterDt b 
			where a.jcmjc = b.selvalue and a.jcmid=b.seldate and b.selid = 13 and  Rptid = 212 and usrid = @Pi_UsrId) 
	WHERE RptId=212 AND SlNo=7
UPDATE RptFormula SET Formulavalue=(Select  datename(mm,jcmSdt)+ '-' + CAST(YEAR(jcmSdt) AS varchar) as Nvalue from jcmonth a,ReportFilterDt b 
			where a.jcmjc = b.selvalue and a.jcmid=b.seldate and b.selid = 20 and  Rptid = 212 and usrid = @Pi_UsrId) 
	WHERE RptId=212 AND SlNo=8
--Check for Report Data
Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptOutletRetailing WHERE UsrId=@Pi_UsrId
-- Till Here
	DELETE FROM #RPTOUTLETWISERETAILING
    DELETE FROM RptOutletRetailing WHERE (WEEK1=0 AND WEEK2=0 AND WEEK3=0 AND WEEK4=0 AND WEEK5=0)
    INSERT INTO #RPTOUTLETWISERETAILING SELECT DISTINCT * FROM RptOutletRetailing WHERE UsrId=@Pi_UsrId
	
	/* Excel Report Query */
			TRUNCATE TABLE RPTOUTLETWISERETAILING_Excel
			DECLARE @RecCount as INT
			Select  @RecCount =  Count(*) From #RPTOUTLETWISERETAILING
			
			IF @RecCount > 0
			BEGIN
                INSERT INTO RPTOUTLETWISERETAILING_Excel (RTRID,RTRNM,COVERAGE,CLASS1,CATEGORY,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,USRID,SRPID,JCMID,RtrAdd1)
				SELECT RTRID,RTRNM,COVERAGE,CLASS1,CATEGORY,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,(WEEK1+WEEK2+WEEK3+WEEK4+WEEK5) AS USRID,SRPID,JCMID,RtrAdd1
				FROM #RPTOUTLETWISERETAILING ORDER BY RtrId
				INSERT INTO RPTOUTLETWISERETAILING_Excel(RTRID,CATEGORY,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,USRID)
				SELECT 999999,'Total',SUM(WEEK1) WEEK1, sum(WEEK2) WEEK2,Sum(WEEK3) WEEK3,sum(WEEK4) WEEK4,sum(WEEK5) WEEK5,sum(WEEK1+WEEK2+WEEK3+WEEK4+WEEK5) USRID 
				FROM #RPTOUTLETWISERETAILING
			END
	
		UPDATE RptFormula SET FormulaValue=(SELECT count(DISTINCT rtrid) NoOfRetailer FROM #RPTOUTLETWISERETAILING) WHERE RptId=212 AND SlNo=12
		TRUNCATE TABLE RptFindClasification
		INSERT INTO RptFindClasification
		SELECT DISTINCT count(R.RtrId) RtrCount,ValueClassName FROM RetailerCateGOryLevel rcl iNNER JOIN RetailerCateGOry rc ON rc.CtgLevelId = rcl.CtgLevelId
		INNER JOIN RetailerValueClass rvc ON rvc.CtgMainId = rc.CtgMainId
		INNER JOIN RetailerValueClassMap rvcm ON rvc.RtrClassId=rvcm.RtrValueClassId
		INNER JOIN Retailer r ON r.RtrId = rvcm.RtrId
		WHERE r.RtrId IN (SELECT RtrId FROM #RPTOUTLETWISERETAILING)
		GROUP BY ValueClassName
		TRUNCATE TABLE RptFindChannel
		INSERT INTO RptFindChannel
		SELECT DISTINCT count(R.RtrId) RtrCount,CtgName FROM RetailerCateGOryLevel rcl iNNER JOIN RetailerCateGOry rc ON rc.CtgLevelId = rcl.CtgLevelId
		INNER JOIN RetailerValueClass rvc ON rvc.CtgMainId = rc.CtgMainId
		INNER JOIN RetailerValueClassMap rvcm ON rvc.RtrClassId=rvcm.RtrValueClassId
		INNER JOIN Retailer r ON r.RtrId = rvcm.RtrId
		WHERE r.RtrId IN (SELECT RtrId FROM #RPTOUTLETWISERETAILING)
		GROUP BY CtgName
SELECT * FROM #RPTOUTLETWISERETAILING --ORDER BY mktnm   
RETURN 
END 
DELETE FROM ConfigUsers
INSERT INTO ConfigUsers
SELECT 1,'BOTREE','s',1,1,1,GETDATE(),1,GETDATE()
UNION
SELECT 2,'USER','',2,1,1,GETDATE(),1,GETDATE()
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptRetailerwiseSchemeUtilization' AND XTYPE='P')
DROP PROCEDURE Proc_RptRetailerwiseSchemeUtilization
GO
-----  EXEC [Proc_RptRetailerwiseSchemeUtilization] 215,1,0,'CoreStocky',0,0,1
CREATE PROCEDURE Proc_RptRetailerwiseSchemeUtilization
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(100),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
AS
/****************************************************************************************************************
* PROCEDURE  : Proc_RptRetailerwiseSchemeUtilization
* PURPOSE    : To Generate Retailerwise SchemeUtilization Report 
* CREATED BY : Panneerselvam.k
* CREATED ON : 12/11/2009  
* MODIFICATION 
*****************************************************************************************************************   
* DATE			AUTHOR				DESCRIPTION   
* 18.11.2009	Panneerselvam		ValueMismatch
* 26.11.2009    Panneerselvam.k		ValueMismatch
*****************************************************************************************************************/ 
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
			/*	Filter Variables  */
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @SMId 		AS	INT
	DECLARE @RMId 		AS	INT
	DECLARE @RtrId 		AS	INT
	DECLARE @CtgLevelId	AS 	INT
	DECLARE @RtrClassId	AS 	INT
	DECLARE @CtgMainId 	AS 	INT
	DECLARE @FromBillNo	AS	INT
	DECLARE @ToBillNo	AS	INT
	DECLARE @Status		AS	INT
	DECLARE @CmpId		AS	INT
	DECLARE @PrdId		AS	INT
	DECLARE	@SchNo		AS	INT
			/*	Till Here	*/
			/*  Assgin Value for the Filter Variable  */
	SELECT	@FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT	@ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET	@SMId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @RMId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))	
	SET @RtrId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @CtgMainId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @FromBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))
	SET @TOBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))
	SET @CtgLevelId =0
	SET @RtrClassId =0
	SET @CtgMainId	=0
IF @FromBillNo = 0 
BEGIN
	SET @FromBillNo =(SELECT Min(SalId) FROM SalesInvoice WHERE SalInvDate Between @FromDate AND @ToDate)
	SET @TOBillNo	=(SELECT Max(SalId) FROM SalesInvoice WHERE SalInvDate Between @FromDate AND @ToDate )
END 
	SET @CmpId	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @SchNo	=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdId		= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))	
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
			/*  Table Structure  */
	Create TABLE #RptRtrWiseSchUtilization
	(
				SalId			BigInt,
				SalInvNo		NVARCHAR(100),
				SalInvDate		DATETIME,
				RtrId			INT,
				RtrCode			NVARCHAR(200),
				RtrName			NVARCHAR(200),
				SchId			INT,
				SchDsc			NVARCHAR(200),
				PrdId			INT,
				PrdDCode		NVARCHAR(200),
				PrdName			NVARCHAR(200),
				BilledQty		INT,
				PrdUnitSelRate	NUMERIC(38,2),
				PrdUnitMRP		NUMERIC(38,2),		
				GrossValue      NUMERIC(38,2),
				FreeQty			NUMERIC(38,2),
				SchemeValue		NUMERIC(38,6),
				FlatAmount		NUMERIC(38,6),
				DiscountPerAmount	 NUMERIC(38,6),
				PrimarySchemeAmt	  NUMERIC(38,6)
	)
	SET @TblName = 'RptRtrWiseSchUtilization'
	SET @TblStruct = '	
				SalId			BigInt,
				SalInvNo		NVARCHAR(100),
				SalInvDate		DATETIME,
				RtrId			INT,
				RtrCode			NVARCHAR(200),
				RtrName			NVARCHAR(200),
				SchId			INT,
				SchDsc			NVARCHAR(200),
				PrdId			INT,
				PrdDCode		NVARCHAR(200),
				PrdName			NVARCHAR(200),
				BilledQty		INT,
				PrdUnitSelRate	NUMERIC(38,2),
				PrdUnitMRP		NUMERIC(38,2),		
				GrossValue      NUMERIC(38,2),
				FreeQty			NUMERIC(38,2),
				SchemeValue		NUMERIC(38,6),
				FlatAmount		NUMERIC(38,6),
				DiscountPerAmount	 NUMERIC(38,6),
				PrimarySchemeAmt	  NUMERIC(38,6)'
	SET @TblFields =   'SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchDsc,PrdId,PrdDCode,PrdName,
						BilledQty,PrdUnitSelRate,PrdUnitMRP,GrossValue,FreeQty,SchemeValue,FlatAmount,
						DiscountPerAmount,PrimarySchemeAmt'
			/* Snap Shot Required  */
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
			/* Till Here  */
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
					
						/*	Calculate Free Quantity  */
					INSERT INTO #RptRtrWiseSchUtilization
					SELECT    
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							A.PrdId,PrdCCode,PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							(FreeQty) FreeQty,
							0 AS SchemeValue,
							0 AS FlatAmount,
							0 AS DiscountPerAmount,
							0 AS PrimarySchemeAmt 
							
					FROM 
							SalesInvoice SI WITH (NOLOCK),SchemeMaster SM WITH (NOLOCK),
							Retailer R WITH (NOLOCK),Product P WITH (NOLOCK),ProductBatch PB WITH (NOLOCK),
							SalesInvoiceSchemeDtFreePrd SISDF WITH (NOLOCK),SalesInvoiceSchemeDtBilled A WITH (NOLOCK),
							RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK), 
							RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL WITH (NOLOCK)
					WHERE 
							SI.SalId = SISDF.SalId 		AND SI.SalId  = A.SalId AND A.SchId = SISDF.SchId
							AND P.PrdId = Pb.PrdId		AND PB.PrdId = A.PrdId	AND PB.PrdBatId = A.PrdbatId
							AND SI.RtrId = R.RtrId		AND a.SalId = SI.SalId  AND SISDF.SchId  = SM.SchId
							AND A.PrdId = P.PrdId		AND  R.Rtrid = RVCM.RtrId	
							AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND A.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
														a.SalId = B1.SalId AND a.SchId = B1.SchID AND a.SlabId = B1.SlabId)
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
											RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
											RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
											RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND(SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
											SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
											SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND	(SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
											SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND	(SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
											SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
							AND	(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId ELSE 0 END) OR
											A.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							AND(SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
											SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))
							AND	 SI.SalInvDate Between @FromDate AND @ToDate 		
							AND SI.Dlvsts in(4,5)
							
								/*	Calculate Window Display Scheme Amount  */
					INSERT INTO #RptRtrWiseSchUtilization
					SELECT  Distinct
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							0 PrdId, '' PrdDCode,
							'' PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							0 FreeQty,			 
							WD.AdjAmt AS SchemeValue,
							0	FlatAmount,
							0  DiscountPerAmount,
							0  PrimarySchemeAmt
					FROM 
							SalesInvoice SI WITH (NOLOCK),SalesInvoiceProduct SIP WITH (NOLOCK),
							SalesInvoiceWindowDisplay WD WITH (NOLOCK),
							Product P WITH (NOLOCK),ProductBatch PB WITH (NOLOCK),Retailer R WITH (NOLOCK),
							SchemeMaster SM WITH (NOLOCK),
							RetailerValueClassMap RVCM WITH (NOLOCK),RetailerValueClass RVC WITH (NOLOCK), 
							RetailerCategory RC WITH (NOLOCK),RetailerCategoryLevel RCL WITH (NOLOCK)
					WHERE 
							SI.SalId = WD.SalId	AND SI.SalId = WD.SalId		AND WD.SchId	= SM.SchId		
							AND SI.RtrId	= R.RtrId		AND SI.RtrId	= WD.RtrId													
							AND R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
											RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
											RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
										RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND (SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
										SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND (SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
										SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND (SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
										SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND	(SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
										SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
--							AND	(SIP.PrdId = (CASE @PrdId WHEN 0 THEN SIP.PrdId ELSE 0 END) OR
--										SIP.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))							
							AND(SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
										SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))
							AND SI.SalInvDate Between @FromDate AND @ToDate 		
							AND SI.Dlvsts in(4,5)
								/*	Calculate Free Amount  */
				INSERT INTO #RptRtrWiseSchUtilization
				SELECT  
							SI.SalId,SI.SalInvNo,SI.SalInvDate,
							SI.RtrId,R.RtrCode,R.RtrName,
							SM.SchId,SM.SchDsc,
							SISLW.PrdId,PrdCCode,
							PrdName,
							0 BilledQty,
							0 PrdUnitSelRate, 0 PrdUnitMRP,
							0 GrossValue,
							0 FreeQty,				
							Sum(SISLW.FlatAmount+SISLW.DiscountPerAmount) AS SchemeValue,
							Sum(SISLW.FlatAmount)	FlatAmount,
							Sum(DiscountPerAmount)  DiscountPerAmount,
							SUM(SISLW.PrimarySchemeAmt)   PrimarySchemeAmt
					FROM 
							SalesInvoice SI,SchemeMaster SM,
							Retailer R,Product P,ProductBatch PB,SalesInvoiceSchemeLineWise SISLW,
							RetailerValueClassMap RVCM ,RetailerValueClass RVC, 
							RetailerCategory RC,RetailerCategoryLevel RCL
					WHERE 
							SISLW.SalId = SI.SalId				AND SISLW.SchId = SM.SchId
							AND P.PrdId = SISLW.PrdId			AND PB.PrdId    = SISLW.PrdId		
							AND PB.PrdBatId = SISLW.PrdBatId	AND Si.RtrId = R.RtrId							
							AND  R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
							AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
							AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
												RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
												RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
							AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
												RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND(SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
												SI.RtrId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
							AND(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId  ELSE 0 END) OR
												SI.SMId  IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))	
							AND	(SI.RMId = (CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
												SI.RMId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))	
							AND (SI.SalId Between @FromBillNo and @TOBillNo)							
							AND (SI.CmpId = (CASE @CmpId WHEN 0 THEN SI.CmpId ELSE 0 END) OR
										SI.CmpId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
							AND	(SISLW.PrdId = (CASE @PrdId WHEN 0 THEN SISLW.PrdId ELSE 0 END) OR
										SISLW.PrdId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							AND (SM.SchId = (CASE @SchNo WHEN 0 THEN SM.SchId ELSE 0 END) OR
										SM.SchId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,258,@Pi_UsrId)))		
							AND	SI.SalInvDate Between @FromDate AND @ToDate 	
							AND SI.Dlvsts in(4,5)
					GROUP BY 
							SI.SalId,SI.SalInvNo,SI.SalInvDate,	SI.RtrId,R.RtrCode,R.RtrName,SM.SchId,SM.SchDsc,
							SISLW.PrdId,PrdCCode,PrdName
		IF LEN(@PurDBName) > 0
			BEGIN
				EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
				
				SET @SSQL = 'INSERT INTO #RptRtrWiseSchUtilization ' +
					'(' + @TblFields + ')' +
					' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
					'WHERE (RCL.CtgLevelId = (CASE ' +  CAST(@CtgLevelId AS INTEGER) + ' WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
							RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',29,' + CAST(@Pi_UsrId as INTEGER) +')))
					
						AND (RC.CtgMainId = (CASE ' +  CAST(@CtgMainId AS INTEGER) + ' WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
							RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',30,' + CAST(@Pi_UsrId as INTEGER) +')))
						
						AND (RVC.RtrClassId = (CASE ' +  CAST(@RtrClassId AS INTEGER) + ' WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
							RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',31,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.RtrId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',3,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.SMId = (CASE ' +  CAST(@SMId AS INTEGER) + ' WHEN 0 THEN SI.SMId ELSE 0 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',1,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.RMId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN SI.RMId ELSE 0 END) OR
							SI.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',8,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.CmpId = (CASE ' +  CAST(@CmpId AS INTEGER) + ' WHEN 0 THEN SI.CmpId ELSE 0 END) OR
							SI.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',4,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SIP.PrdId = (CASE ' +  CAST(@PrdId AS INTEGER) + ' WHEN 0 THEN SIP.PrdId ELSE 0 END) OR
							SIP.PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',5,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SM.SchId = (CASE ' +  CAST(@SchNo AS INTEGER) + ' WHEN 0 THEN SM.SchId ELSE 0 END) OR
							SM.SchId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',258,' + CAST(@Pi_UsrId as INTEGER) +')))
						AND (SI.SalInvDate Between ' + @FromDate +' and ' + @ToDate + ')
						AND (SI.SalId Between ' + @FromBillNo +' and ' + @TOBillNo +')'
				EXEC (@SSQL)
				PRINT 'Retrived Data From Purged Table'
			END
			IF @Pi_SnapRequired = 1
			   BEGIN
				SELECT @NewSnapId = @Pi_SnapId
				EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
					@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
				IF @ErrNo = 0
				   BEGIN
					SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
						'(SnapId,UserId,RptId,' + @TblFields + ')' +
						' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
						' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
						' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptRtrWiseSchUtilization'
			
					EXEC (@SSQL)
					PRINT 'Saved Data Into SnapShot Table'
				   END
			   END
		end
		ELSE				--To Retrieve Data From Snap Data
		BEGIN
			EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
					@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			PRINT @ErrNo
			IF @ErrNo = 0
			   BEGIN
				SET @SSQL = 'INSERT INTO #RptRtrWiseSchUtilization ' +
					'(' + @TblFields + ')' +
					' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
					' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
					' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
				EXEC (@SSQL)
				PRINT 'Retrived Data From Snap Shot Table'
			   END
			ELSE
			   BEGIN
				PRINT 'DataBase or Table not Found'
			   END
		END
			--Check for Report Data
			Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptRtrWiseSchUtilization
			-- Till Here
	
				UPDATE #RptRtrWiseSchUtilization SET BilledQty = B.BaseQty,PrdUnitMRP = B.PrdUnitMRP,PrdUnitSelRate = B.PrdUnitSelRate
				FROM #RptRtrWiseSchUtilization a,SalesInvoiceProduct B
				WHERE B.SalId = A.SalId AND B.PrdId = A.PrdId
				SELECT SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,R.SchId,R.SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,
				BilledQty*PrdUnitSelRate AS Grossvalue,
				Sum(FreeQty) FreeQty,Sum(SchemeValue) SchemeValue,
				Sum(FlatAmount) AS FlatAmount,
				Sum(DiscountPerAmount) AS DiscountPerAmount,
				Sum(PrimarySchemeAmt) AS PrimarySchemeAmt,CmpSchCode AS CompSchCode INTO #TmpFinOpShemem
				FROM #RptRtrWiseSchUtilization R INNER JOIN SchemeMaster S ON  R.SchId=S.SchId
				GROUP BY SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,R.SchId,R.SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,CmpSchCode
				ORDER BY SalId
				SELECT DISTINCT D.SalId,D.SchId,D.PrdId,PrdBatDetailValue,
						E.FreePrdId,
						E.FreeQty FreeQty,
						E.FreeQty * PrdBatDetailValue FreeQtyValue INTO #TmpFre1111
						FROM  BatchCreation  A WITH (NOLOCK),ProductBatchDetails B WITH (NOLOCK),
							  ProductBatch C WITH (NOLOCK),
							  #TmpFinOpShemem D,SalesInvoiceSchemeDtFreePrd E WITH (NOLOCK)
						WHERE A.BatchSeqId = B.BatchSeqId AND A.SlNo = B.SLNo
						AND A.SlNo =4  AND A.ClmRte = 1 AND B.PrdBatId = C.PrdBatId AND D.FreeQty > 0
						AND D.SalId = E.SalId AND D.SchId = E.SchId	AND E.FreePrdId = C.PrdId
						AND E.FreePrdBatId = C.PrdBatId
				SELECT SalId,SchId,PrdId,Sum(FreeQty) FreeQty,
						Sum(FreeQtyValue) FreeQtyValue INTO #TmpFinFreeVal
						FROM #TmpFre1111
				GROUP BY SalId,SchId,PrdId
				UPDATE #TmpFinOpShemem  SET SchemeValue = SchemeValue + FreeQtyValue
								FROM #TmpFinOpShemem A,#TmpFinFreeVal  B
								WHERE A.SalId = B.SalId AND A.SchId = B.SchId 
								AND A.PrdId = B.PrdId   
			
				SELECT SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,
				BilledQty*PrdUnitSelRate AS Grossvalue,
				Sum(FreeQty) FreeQty,Sum(SchemeValue) SchemeValue,
				Sum(FlatAmount) AS FlatAmount,
				Sum(DiscountPerAmount) AS DiscountPerAmount,
				Sum(PrimarySchemeAmt) AS PrimarySchemeAmt,CompSchCode 
				FROM #TmpFinOpShemem 
				GROUP BY SalId,SalInvNo,SalInvDate,RtrId,RtrCode,RtrName,SchId,SchDsc,PrdId,PrdDCode,PrdName,
				BilledQty,PrdUnitSelRate,PrdUnitMRP,CompSchCode
				ORDER BY SalId,SalInvNo
RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptRoutewiseretailing_Excel' AND XTYPE='U')
DROP TABLE RptRoutewiseretailing_Excel
GO
CREATE TABLE RptRoutewiseretailing_Excel(
	[mktid] [int] NULL,
	[mktnm] [varchar](50) NULL,
	[rtrcount] [int] NULL,
	[Week1] [float] NULL,
	[Week2] [float] NULL,
	[Week3] [float] NULL,
	[Week4] [float] NULL,
	[Week5] [float] NULL,
	[srpid] [int] NULL,
	[srpnm] [varchar](50) NULL,
	[UsrId] [float] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='rptroutewiseretailing' AND XTYPE='U')
DROP TABLE rptroutewiseretailing
GO
CREATE TABLE rptroutewiseretailing(
	[mktid] [int] NULL,
	[mktnm] [varchar](50) NULL,
	[rtrcount] [int] NULL,
	[Week1] [float] NULL,
	[Week2] [float] NULL,
	[Week3] [float] NULL,
	[Week4] [float] NULL,
	[Week5] [float] NULL,
	[srpid] [int] NULL,
	[srpnm] [varchar](50) NULL,
	[UsrId] [int] NULL,
	[RtrId] [bigint] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptROUTEWISERETAILING' AND XTYPE='P')
DROP PROCEDURE Proc_RptROUTEWISERETAILING
GO
---EXEC Proc_RptROUTEWISERETAILING 214,1,0,'CoreStocky',0,0,1,0
-- select * from rptroutewiseretailing
-- select * from rptroutewiseretailing
-- select * from RptRoutewiseretailing_Excel
CREATE PROCEDURE Proc_RptROUTEWISERETAILING  
(
@Pi_RptId  INT,
@Pi_UsrId  INT,
@Pi_SnapId  INT,
@Pi_DbName  nvarchar(50),
@Pi_SnapRequired INT,
@Pi_GetFromSnap  INT,
@Pi_CurrencyId  INT,
@Po_Errno  INT OUTPUT
)
AS 
BEGIN 
--if @srpid = 0   
--set @srpid = null 
--if @mnfid=0 set @mnfid=null 
DECLARE @jcid AS int    
DECLARE @jcmnt AS  int   
DECLARE @mnfid AS int  
DECLARE @srpid AS int
DECLARE @ErrNo	 	AS	INT  
DECLARE @ssql varchar(1000)  
DECLARE @w1 int  
DECLARE @w2 int  
SET @srpid = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
SET @mnfid =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @jcid	 = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
SET @jcmnt = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,13,@Pi_UsrId))
PRINT @jcid
PRINT @jcmnt
if @srpid = 0   
set @srpid = null 
delete from rptroutewiseretailing --where usrid = @Pi_RptId   
CREATE TABLE #Temprptroutewiseretailing ([mktid] [int] NULL,	[mktnm] [varchar](50) ,	[rtrcount] [int] NULL,[Week1] [float] NULL,[Week2] [float] NULL,[Week3] [float] NULL,[Week4] [float] NULL,
	[Week5] [float] NULL,	[srpid] [int] NULL,[srpnm] [varchar](50),[UsrId] [int] NULL)
CREATE TABLE #TempRtrID (RtrId Int)
insert into rptroutewiseretailing (mktid,mktnm,rtrcount,week1,week2,week3,week4,week5,srpid,srpnm,usrid,RtrId)  
select c.RMId,c.RMName,0,0,0,0,0,0,SM.SMId,sm.SMName,@Pi_UsrId,s.RtrId 
	FROM 
	RouteMaster c,  
	SalesInvoice S,
	SalesMan SM
    WHERE C.RMId=S.RMID AND S.SMId=SM.SMID	AND 	
    C.RMId= isnull(@srpid,C.RMId) 
	group by c.RMId,c.RMName,SM.SMId,SM.SMName,s.RtrId 
	  
select DISTINCT (s.rtrid) ,a.RMId into #tFind FROM RetailerMarket a, RouteMaster b,Retailer c,SalesInvoice S,jcweek f  where   
a.RMId = b.RMId  AND 
a.rtrid=c.rtrid AND c.rtrid=s.rtrid AND s.rmid=b.RMId
AND  f.jcmid = @jcid and f.jcmjc = @jcmnt   
		and s.SalInvDate between f.jcwsdt and f.jcwedt and s.dlvsts in (1,4,5)
order by a.RMId  
select count(rtrid) rtrctr,RMId into #t FROM #tFind
group by RMId  
update rptroutewiseretailing set rtrcount = b.rtrctr from rptroutewiseretailing a,   
#t b where b.RMId = a.MktId
set @w1 = (select min(jcwwk) from jcweek where jcmid = @jcid and jcmjc = @jcmnt)  
set @w2 = (select max(jcwwk) from jcweek where jcmid = @jcid and jcmjc = @jcmnt)  
while @w1 <= @w2  
	begin  
		delete from rpttempmktwise  
		insert into rpttempmktwise(Vvalue,mktid,srpid)  
		select Sum(B.Baseqty*PrdUom1EditedSelRate),a.RMId,a.SMId 
		from 
		salesinvoice a,
		SalesInvoiceProduct AS B,  
		Product AS C,
		jcweek f where a.SalId = b.SalId and b.prdid =c.prdid and a.RMID = isnull(@srpid,a.RMID) 
		and f.jcmid = @jcid and f.jcmjc = @jcmnt   
		and a.SalInvDate between f.jcwsdt and f.jcwedt and f.jcwwk = @w1 and a.dlvsts in (1,4,5) group by a.RMId,a.SMId 
	  
		if @w1 <= 4  
			begin  
				  set @ssql = 'update rptroutewiseretailing set'  
				  set @ssql = @ssql + ' week' + cast(@w1 as varchar(10)) + ' = b.Vvalue'   
				  set @ssql = @ssql + ' from rptroutewiseretailing a, rpttempmktwise b where a.mktid = b.mktid and a.srpid = b.srpid'   
				  exec (@ssql)  
			end  
			   
		if @w1 >=5  
			begin  
			  set @ssql = 'update rptroutewiseretailing set'  
			  set @ssql = @ssql + ' week5 = week5 + b.Vvalue'  
			  set @ssql = @ssql + ' from rptroutewiseretailing a, rpttempmktwise b where a.mktid = b.mktid and a.srpid = b.srpid'   
			  exec (@ssql)  
			end  
		set @w1 = @w1 + 1  
	end  
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM rptroutewiseretailing WHERE UsrId=@Pi_UsrId
	-- Till Here
	UPDATE RptFormula SET Formulavalue=(Select  datename(mm,jcmSdt)+ '-' + CAST(YEAR(jcmSdt) AS varchar) as Nvalue from jcmonth a,ReportFilterDt b 
			where a.jcmjc = b.selvalue and a.jcmid=b.seldate and b.selid = 13 and  Rptid = 214 and usrid = @Pi_UsrId) 
	WHERE RptId=214 AND SlNo=6
	
	DELETE FROM rptroutewiseretailing WHERE (Week1=0 AND Week2=0 AND Week3=0 AND Week4=0 AND Week5=0)
	DELETE FROM #Temprptroutewiseretailing
    INSERT INTO #Temprptroutewiseretailing SELECT DISTINCT mktid,mktnm,rtrcount,week1,week2,week3,week4,week5,srpid,srpnm,usrid FROM rptroutewiseretailing WHERE UsrId=@Pi_UsrId
	/* Excel Report Query */
	TRUNCATE TABLE RptRoutewiseretailing_Excel
	DECLARE @RecCount as INT
	Select  @RecCount =  Count(*) From #Temprptroutewiseretailing
	
	IF @RecCount > 0
	BEGIN
        INSERT INTO RptRoutewiseretailing_Excel (mktid,mktnm,rtrcount,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,SRPID,srpnm,UsrId)
		SELECT mktid,mktnm,rtrcount,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,SRPID,srpnm,(WEEK1+WEEK2+WEEK3+WEEK4+WEEK5) AS USRID
		FROM #Temprptroutewiseretailing ORDER BY mktid
		INSERT INTO RptRoutewiseretailing_Excel(mktid,mktnm,WEEK1,WEEK2,WEEK3,WEEK4,WEEK5,USRID)
		SELECT 999999,'Total',SUM(WEEK1) WEEK1, sum(WEEK2) WEEK2,Sum(WEEK3) WEEK3,sum(WEEK4) WEEK4,sum(WEEK5) WEEK5,sum(WEEK1+WEEK2+WEEK3+WEEK4+WEEK5) USRID 
		FROM #Temprptroutewiseretailing
	END
	
	UPDATE RptFormula SET FormulaValue=(SELECT count(*) NoOfRoute FROM #Temprptroutewiseretailing)  WHERE RptId=214 AND SlNo=7
	
	UPDATE RptFormula SET FormulaValue=(SELECT sum(rtrcount) NoOfRetailer FROM #Temprptroutewiseretailing) WHERE RptId=214 AND SlNo=8
	
	INSERT INTO #TempRtrID
	SELECT rtrid FROM #tFind
	
	TRUNCATE TABLE RptFindClasification
	INSERT INTO RptFindClasification
	SELECT DISTINCT count(R.RtrId) RtrCount,ValueClassName FROM RetailerCategoryLevel rcl iNNER JOIN RetailerCategory rc ON rc.CtgLevelId = rcl.CtgLevelId
	INNER JOIN RetailerValueClass rvc ON rvc.CtgMainId = rc.CtgMainId
	INNER JOIN RetailerValueClassMap rvcm ON rvc.RtrClassId=rvcm.RtrValueClassId
	INNER JOIN Retailer r ON r.RtrId = rvcm.RtrId
	WHERE r.RtrId IN (SELECT RtrId FROM #TempRtrID)
	GROUP BY ValueClassName
	TRUNCATE TABLE RptFindChannel
	INSERT INTO RptFindChannel
	SELECT DISTINCT count(R.RtrId) RtrCount,CtgName FROM RetailerCategoryLevel rcl iNNER JOIN RetailerCategory rc ON rc.CtgLevelId = rcl.CtgLevelId
	INNER JOIN RetailerValueClass rvc ON rvc.CtgMainId = rc.CtgMainId
	INNER JOIN RetailerValueClassMap rvcm ON rvc.RtrClassId=rvcm.RtrValueClassId
	INNER JOIN Retailer r ON r.RtrId = rvcm.RtrId
	WHERE r.RtrId IN (SELECT RtrId FROM #TempRtrID)
	GROUP BY CtgName
	SELECT * FROM #Temprptroutewiseretailing ORDER BY mktid
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptRtrWiseBrandWiseSales' AND XTYPE='P')
DROP PROCEDURE Proc_RptRtrWiseBrandWiseSales
GO
----  EXEC Proc_RptRtrWiseBrandWiseSales 169,1,0,'dabur1',0,0,1
CREATE PROCEDURE Proc_RptRtrWiseBrandWiseSales
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/**********************************************************************************************
* PROCEDURE  : Proc_RptRtrWiseBrandWiseSales
* PURPOSE    : To Generate Retailer Wise Brand Wise Report
* CREATED BY : Aarthi
* CREATED ON : 16/09/2009
* MODIFICATION
************************************************************************************************
* 03.11.2009		Panneer		ExportExcel Value Mismatch
* 21.11.2009		Panneer		Gross Value MisMatch Issue
***********************************************************************************************/
SET NOCOUNT ON
BEGIN
DECLARE @NewSnapId 	AS	INT
DECLARE @DBNAME		AS 	nvarchar(50)
DECLARE @TblName 	AS	nvarchar(500)
DECLARE @TblStruct 	AS	nVarchar(4000)
DECLARE @TblFields 	AS	nVarchar(4000)
DECLARE @sSql		AS 	nVarChar(4000)
DECLARE @ErrNo	 	AS	INT
DECLARE @PurDBName	AS	nVarChar(50)
--Filter Variable
DECLARE @FromDate	AS	DATETIME
DECLARE @ToDate	 	AS	DATETIME
DECLARE @CmpId      AS  INT
DECLARE @SMId 		AS	INT
DECLARE @RMId	 	AS	INT
DECLARE @RtrId	 	AS	INT
DECLARE @CtgLevelId	AS 	INT
DECLARE @RtrClassId	AS 	INT
DECLARE @CtgMainId 	AS 	INT
DECLARE @PDC	AS	INT
DECLARE @PrdCatId	AS	INT
DECLARE @PrdId		AS	INT
DECLARE @HirMainId	AS INT
DECLARE @CtgValue   AS INT
DECLARE	@EXLFlag	AS	INT
--Till Here
--Assgin Value for the Filter Variable
SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
SET @RtrClassId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
SET @HirMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
SET @CtgValue=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
--Till Here
SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
--Till Here'
EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
EXEC Proc_GetProductwiseHierarchy
	SET @PrdCatId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
CREATE TABLE #RptRtrWiseBrandWiseSales
		(
	    [Salesman Name]				NVARCHAR(100),
		[Route Name]				NVARCHAR(100),
		[Retailer Category]			NVARCHAR(100),
		[Retailer Classification]	NVARCHAR(100),
		[Retailer Code]       NVARCHAR(50),
		[Retailer Name]       NVARCHAR(100),
		[RtrId]				  INT,
		[Product Hierarchy]	  NUMERIC(18, 2),
		[Hierarchy]			  NVARCHAR(100)
)
SET @TblName = 'RptRtrWiseBrandWiseSales'
SET @TblStruct = '
		[Salesman Name]				NVARCHAR(100),
		[Route Name]				NVARCHAR(100),
		[Retailer Category]			NVARCHAR(100),
		[Retailer Classification]	NVARCHAR(100),
		[Retailer Code]       NVARCHAR(50),
		[Retailer Name]       NVARCHAR(100),
		[RtrId]				  INT,
		[Product Hierarchy]	  [numeric](18, 2),
		[Hierarchy]			  NVARCHAR(100)'
SET @TblFields = '[Salesman Name],[Route Name],
					[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],
					[RtrId],[Product Hierarchy],[Hierarchy]'
IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME =  @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END
IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN
		SELECT DISTINCT Prdid, C.PrdCtgValName INTO #Tempa 
		FROM 
			ProductCategoryValue C 
			INNER JOIN ProductCategoryValue D ON
			C.PrdCtgValMainId = (CASE @HirMainId WHEN 0 THEN C.PrdCtgValMainId Else 0 END) OR
			C.PrdCtgValMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId)) AND
			D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode as nvarchar(1000)) + '%'
			INNER JOIN Product E On D.PrdCtgValMainId = E.PrdCtgValMainId 
			LEFT OUTER JOIN ProductCategoryLevel PCL ON PCL.CmpPrdCtgId=C.CmpPrdCtgId 
		where  PCL.CmpPrdCtgId IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
				INSERT INTO #RptRtrWiseBrandWiseSales([Salesman Name],[Route Name],
					[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],
					[RtrId],[Product Hierarchy],[Hierarchy])
				SELECT DISTINCT 				
					S.SMName AS [Salesman Name],RM.RMName AS [Route Name],
					RC.CtgName AS [Retailer Category],RVC.ValueClassName AS [Retailer Classification],
					R.RtrCode AS [Retailer Code],R.RtrName AS[Retailer Name],
					SI.[RtrId],0 AS [Product Hierarchy] ,A.PrdCtgValName AS [Hierarchy]
					FROM #Tempa A
						LEFT OUTER JOIN SalesInvoiceProduct SIP ON SIP.PrdId=A.PrdId
						LEFT OUTER JOIN SalesInvoice SI ON SI.SalId=SIP.SalId
						LEFT OUTER JOIN Salesman S ON S.SMId= SI.SMId
						LEFT OUTER JOIN RouteMaster RM ON RM.RMId=SI.RMId
						LEFT OUTER JOIN Retailer R ON R.RtrId=SI.RtrId
						LEFT OUTER JOIN RetailerValueClassMap RVCM WITH (NOLOCK)ON R.Rtrid = RVCM.RtrId 
						LEFT OUTER JOIN RetailerValueClass RVC WITH (NOLOCK) ON RVCM.RtrValueClassId = RVC.RtrClassId
						AND (RVC.RtrClassId=(CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR
						RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))
							AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
						RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
						INNER JOIN RetailerCategory RC WITH (NOLOCK) ON RVC.CtgMainId=RC.CtgMainId
							AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR
						RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
						INNER JOIN RetailerCategoryLevel RCL ON RCL.CtgLevelId=RC.CtgLevelId
						AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR
						RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
					WHERE (SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
									SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))
						 AND (SI.RMId=(CASE @RMId WHEN 0 THEN SI.RMId ELSE 0 END) OR
									SI.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
									
						 AND (SI.SMId=(CASE @SMId WHEN 0 THEN SI.SMId ELSE 0 END) OR
									SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				
						 AND (SI.SalInvDate Between @FromDate and @ToDate) AND SI.DlvSts IN(4,5)
	IF LEN(@PurDBName) > 0
	BEGIN
		EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
		
		SET @SSQL = 'INSERT INTO #RptRtrWiseBrandWiseSales ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
			
			'WHERE (SI.RtrId = (CASE ' +  CAST(@RtrId AS INTEGER) + ' WHEN 0 THEN SI.RtrId ELSE 0 END) OR
					SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',3,' + CAST(@Pi_UsrId as INTEGER) +')))
								
			AND (SI.RMId=(CASE ' + CAST(@RMId AS INTEGER) + ' WHEN 0 THEN SI.RMId ELSE 0 END) OR
								SI.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) + ',2,' + CAST(@Pi_UsrId as INTEGER) +')))
								
			AND (SI.SMId=(CASE '+ CAST(@SMId AS INTEGER) + 'WHEN 0 THEN SI.SMId ELSE 0 END) OR
								SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId as INTEGER) +',1,' + CAST(@Pi_UsrId as INTEGER) + ')))
			AND (SI.SalInvDate Between ' + @FromDate +' and ' + @ToDate +') and SI.DlvSts IN(4,5)'
		EXEC (@SSQL)
		PRINT 'Retrived Data From Purged Table'
	END
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		IF @ErrNo = 0
		   BEGIN
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptRtrWiseBrandWiseSales'
	
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		   END
	   END
END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptRtrWiseBrandWiseSales ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		   BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
--Check for Report Data
Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptRtrWiseBrandWiseSales
-- Till Here
	SELECT @EXLFlag=Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId
	IF @EXLFlag=1
	BEGIN
		
		/***************************************************************************************************************************/
		--Create Table in Dynamic Cols
		--Cursors
		DECLARE  @Salesman  NVARCHAR(100)
		DECLARE  @Route		NVARCHAR(100)
		DECLARE	 @RtrCat	NVARCHAR(100)
		DECLARE	 @RtrClass	NVARCHAR(100)
		DECLARE  @RetailerId BIGINT
		DECLARE  @RtrCode NVARCHAR(100)
		DECLARE  @RtrName NVARCHAR(100)
		DECLARE	 @Hierarchy NVARCHAR(100)
		DECLARE  @PrdHir	NUMERIC(18, 2)
		DECLARE  @SlNo INT
		DECLARE  @Column VARCHAR(80)
		DECLARE  @C_SSQL VARCHAR(4000)
		DECLARE  @iCnt INT
		DECLARE  @Name NVARCHAR(100)
		
		IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptRtrWiseBrandWiseSales_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE [RptRtrWiseBrandWiseSales_Excel]
		DELETE FROM RptExcelHeaders Where RptId=169 AND SlNo>7
		CREATE TABLE RptRtrWiseBrandWiseSales_Excel ([Salesman Name]NVARCHAR(100),[Route Name]NVARCHAR(100) ,[Retailer Category] NVARCHAR(100),[Retailer Classification] NVARCHAR(100),[Retailer Code] NVARCHAR(50),[Retailer Name]NVARCHAR(100),RtrId INT)
		SET @iCnt=8
		DECLARE Column_Cur CURSOR FOR
		SELECT DISTINCT Hierarchy--,SUM([Product Hierarchy])
					FROM #RptRtrWiseBrandWiseSales-- Group BY Hierarchy
		OPEN Column_Cur
			   FETCH NEXT FROM Column_Cur INTO @Column--,@SlNo
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='ALTER TABLE RptRtrWiseBrandWiseSales_Excel  ADD ['+ @Column +'] NUMERIC(38,6)'
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					SET @C_SSQL='INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)'
					SET @C_SSQL=@C_SSQL +' VALUES(' + CAST(@Pi_RptId AS VARCHAR(100))+ ',' + CAST(@iCnt AS VARCHAR(100))
					SET @C_SSQL=@C_SSQL + ',''['+ CAST(@Column AS VARCHAR(100))+']'','''+ CAST(@Column AS VARCHAR(100))+ ''',1,1)'
					
					PRINT @C_SSQL
					EXEC (@C_SSQL)
					SET @iCnt=@iCnt+1
					FETCH NEXT FROM Column_Cur INTO @Column--,@SlNo
				END
		CLOSE Column_Cur
		DEALLOCATE Column_Cur
		--- Added By Panneer 03.11.2009
		--Insert table values
		DECLARE @PrdCtgValue1 nvarchar(100)
		DECLARE @CtgValueName1 nVarchar(100)
		SELECT @CtgValueName1=CmpPrdCtgName FROM ProductCategoryLevel WHERE CmpPrdCtgId=@CtgValue
		SET @sSql='
		UPDATE #RptRtrWiseBrandWiseSales SET [Product Hierarchy]= 0
		FROM (SELECT DISTINCT SI.RtrId,SIP.PrdGrossAmountAftEdit AS ProductHierarchy,PCV.PrdCtgValName 
		FROM SalesInvoiceProduct SIP,ProductWiseHierarchy P,SalesInvoice SI,ProductCategoryValue PCV,
		ProductCategoryLevel PCL,Retailer R
		WHERE SI.Salid=SIP.salid AND SIP.Prdid=P.ProductId AND (SI.SalInvDate Between ''' + cast(@FromDate AS nVarchar(11)) +''' and ''' + cast(@ToDate AS nVarchar(11)) +''') AND SI.DlvSts IN(4,5)
		AND PCV.PrdCtgValName=P.['+ @CtgValueName1 +'] AND SI.RtrId=R.RtrId) A 
		WHERE A.RtrId=#RptRtrWiseBrandWiseSales.RtrId AND A.PrdCtgValName=#RptRtrWiseBrandWiseSales.Hierarchy'
		Exec (@sSql)
		SET @sSql='
		SELECT DISTINCT SI.SalId,SI.SmId,SMName,RMName,SI.RmId,SI.RtrId,SIP.PrdId,
		SIP.PrdGrossAmountAftEdit GrossAmt ,PCV.PrdCtgValName  INTO #Temp5425
		FROM SalesInvoiceProduct SIP,ProductWiseHierarchy P,SalesInvoice SI,ProductCategoryValue PCV,
		ProductCategoryLevel PCL,Retailer R,Product Pr,SalesMan S,RouteMaster RM
		WHERE SI.Salid=SIP.salid AND SIP.Prdid=P.ProductId AND (SI.SalInvDate Between ''' + cast(@FromDate AS nVarchar(11)) +''' and ''' + cast(@ToDate AS nVarchar(11)) +''') AND SI.DlvSts IN(4,5)
		AND PCV.PrdCtgValName=P.['+ @CtgValueName1 +'] AND SI.RtrId=R.RtrId AND SIP.PrdId = Pr.PrdId
		AND S.SmId = SI.SmId and SI.RMId = RM.RMId
		SELECT SmId,SMName,RMId,RMName,RtrId,PrdCtgValName,Sum(GrossAmt) GrossAmt INTO #TFIN
		FROM #Temp5425
		GROUP BY RtrId,PrdCtgValName,SmId,RMId,SMName,RMName
		UPDATE #RptRtrWiseBrandWiseSales  SET [Product Hierarchy] = GrossAmt
		FROM #RptRtrWiseBrandWiseSales a,#TFIN b 
		WHERE A.RtrId = B.RtrId AND A.Hierarchy = B.PrdCtgValName and SMName = [Salesman Name]
		AND RMName = [Route Name]'
		Exec (@sSql)
		---- Till Here
		DELETE FROM RptRtrWiseBrandWiseSales_Excel
		INSERT INTO RptRtrWiseBrandWiseSales_Excel([Salesman Name],[Route Name],[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],RtrId)
		SELECT DISTINCT [Salesman Name],[Route Name],[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],RtrId
				FROM #RptRtrWiseBrandWiseSales
		DECLARE Values_Cur CURSOR FOR
		SELECT  [Salesman Name],[Route Name],[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],RtrId,[Hierarchy],SUM([Product Hierarchy]) FROM #RptRtrWiseBrandWiseSales
				group by [Salesman Name],[Route Name],[Retailer Category],[Retailer Classification],[Retailer Code],[Retailer Name],RtrId,[Hierarchy]
		OPEN Values_Cur
			   FETCH NEXT FROM Values_Cur INTO @Salesman,@Route,@RtrCat,@RtrClass,@RtrCode,@RtrName,@RetailerId,@Hierarchy,@PrdHir
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptRtrWiseBrandWiseSales_Excel  SET ['+ @Hierarchy +']= '+ CAST(@PrdHir AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL+ ' WHERE RtrId=' + CAST(@RetailerId AS VARCHAR(1000))
					+' AND [Retailer Code]=''' + CAST(@RtrCode AS VARCHAR(1000))+''''
					+' AND [Retailer Category]=''' + CAST(@RtrCat AS VARCHAR(1000)) +''''
					+' AND [Salesman Name]=''' + CAST(@Salesman AS VARCHAR(1000)) +''''
					+' AND [Route Name]=''' + CAST(@Route AS VARCHAR(1000)) +''''
					+' AND [Retailer Classification]=''' + CAST(@RtrClass AS VARCHAR(1000)) +''''
					
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM Values_Cur INTO @Salesman,@Route,@RtrCat,@RtrClass,@RtrCode,@RtrName,@RetailerId,@Hierarchy,@PrdHir
				END
		CLOSE Values_Cur
		DEALLOCATE Values_Cur
		-- To Update the Null Value as 0
		DECLARE NullCursor_Cur CURSOR FOR
		SELECT Name FROM dbo.sysColumns where id = object_id(N'[RptRtrWiseBrandWiseSales_Excel]')
		OPEN NullCursor_Cur
			   FETCH NEXT FROM NullCursor_Cur INTO @Name
			   WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @C_SSQL='UPDATE RptRtrWiseBrandWiseSales_Excel SET ['+ @Name +']= '+ CAST(0 AS VARCHAR(1000))
					SET @C_SSQL=@C_SSQL + ' WHERE '+'['+ @Name +']'+'IS NULL'+ ''
					EXEC (@C_SSQL)
					PRINT @C_SSQL
					FETCH NEXT FROM NullCursor_Cur INTO @Name
				END
		CLOSE NullCursor_Cur
		DEALLOCATE NullCursor_Cur
		/***************************************************************************************************************************/
	END
	DECLARE @PrdCtgValue nvarchar(100)
	DECLARE @CtgValueName nVarchar(100)
--DECLARE @sSql nvarchar(4000)
	SELECT @CtgValueName=CmpPrdCtgName FROM ProductCategoryLevel WHERE CmpPrdCtgId=@CtgValue
		SET @sSql='UPDATE #RptRtrWiseBrandWiseSales SET [Product Hierarchy]= 0
		FROM (SELECT DISTINCT SI.RtrId,SIP.PrdGrossAmountAftEdit AS ProductHierarchy,PCV.PrdCtgValName 
		FROM SalesInvoiceProduct SIP,ProductWiseHierarchy P,SalesInvoice SI,ProductCategoryValue PCV,
		ProductCategoryLevel PCL,Retailer R
		WHERE SI.Salid=SIP.salid AND SIP.Prdid=P.ProductId AND (SI.SalInvDate Between ''' + cast(@FromDate AS nVarchar(11)) +''' and ''' + cast(@ToDate AS nVarchar(11)) +''') AND SI.DlvSts IN(4,5)
		AND PCV.PrdCtgValName=P.['+ @CtgValueName +'] AND SI.RtrId=R.RtrId) A 
		WHERE A.RtrId=#RptRtrWiseBrandWiseSales.RtrId AND A.PrdCtgValName=#RptRtrWiseBrandWiseSales.Hierarchy'
		Exec (@sSql)
		SET @sSql='
		SELECT DISTINCT SI.SalId,SI.SmId,SMName,RMName,SI.RmId,SI.RtrId,SIP.PrdId,
		SIP.PrdGrossAmountAftEdit GrossAmt ,PCV.PrdCtgValName  INTO #Temp5425
		FROM SalesInvoiceProduct SIP,ProductWiseHierarchy P,SalesInvoice SI,ProductCategoryValue PCV,
		ProductCategoryLevel PCL,Retailer R,Product Pr,SalesMan S,RouteMaster RM
		WHERE SI.Salid=SIP.salid AND SIP.Prdid=P.ProductId AND (SI.SalInvDate Between ''' + cast(@FromDate AS nVarchar(11)) +''' and ''' + cast(@ToDate AS nVarchar(11)) +''') AND SI.DlvSts IN(4,5)
		AND PCV.PrdCtgValName=P.['+ @CtgValueName +'] AND SI.RtrId=R.RtrId AND SIP.PrdId = Pr.PrdId
		AND S.SmId = SI.SmId and SI.RMId = RM.RMId
		SELECT SmId,SMName,RMId,RMName,RtrId,PrdCtgValName,Sum(GrossAmt) GrossAmt INTO #TFIN
		FROM #Temp5425
		GROUP BY RtrId,PrdCtgValName,SmId,RMId,SMName,RMName
		UPDATE #RptRtrWiseBrandWiseSales  SET [Product Hierarchy] = GrossAmt
		FROM #RptRtrWiseBrandWiseSales a,#TFIN b 
		WHERE A.RtrId = B.RtrId AND A.Hierarchy = B.PrdCtgValName and SMName = [Salesman Name]
		AND RMName = [Route Name]'
		Exec (@sSql)
	SELECT *  FROM #RptRtrWiseBrandWiseSales ORDER BY [Salesman Name],[Route Name],[Retailer Name]
	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptSalesmanBrandwiseTargetAnalysis' AND XTYPE='U')
DROP TABLE RptSalesmanBrandwiseTargetAnalysis
GO
CREATE TABLE RptSalesmanBrandwiseTargetAnalysis(
	[JCMonth] [nvarchar](10) NOT NULL,
	[SMName] [nvarchar](100) NOT NULL,
	[Brand] [nvarchar](100) NOT NULL,
	[Planned BillsCut] [int] NULL,
	[BillsCut] [int] NULL,
	[Planned ECO] [int] NULL,
	[ECO] [int] NULL,
	[Planned LineSold] [int] NULL,
	[LineSold] [int] NULL,
	[SalesPlan] [numeric](38, 6) NOT NULL,
	[SalesActual] [numeric](38, 6) NULL,
	[Achievement%] [nvarchar](20) NULL,
	[UserId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptSalesmanBrandwiseTargetAnalysis' AND XTYPE='P')
DROP PROCEDURE Proc_RptSalesmanBrandwiseTargetAnalysis
GO
--EXEC Proc_RptSalesmanBrandwiseTargetAnalysis 236,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptSalesmanBrandwiseTargetAnalysis
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************
* VIEW	: Proc_RptSalesmanBrandwiseTargetAnalysis
* PURPOSE	: Brand wise Report - Target Analysis
* CREATED BY	: Mohana S
* CREATED DATE	: 16.01.2013
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
BEGIN
SET NOCOUNT ON
	DECLARE @JcmId	 	AS	INT
	DECLARE @JcMonth	AS	DATETIME
	DECLARE @Brand 		AS	INT
	DECLARE @SmId 		AS	INT
		
	SET @JcmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId))
	
	SELECT  @JcMonth = ISNULL(dSelected,0) FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)
	
	--SET @Brand = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId))
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	
	SELECT J.JcmId[JcYear],J.JcmJc[JcMonth],JcmSdt,JcmEdt 
	INTO #JC 
	FROM JcMonth J INNER JOIN TargetAnalysisHd T ON J.JcmId=T.JcmId AND J.JcmJc=T.JcmJc
	WHERE (JcmSdt=(CASE @JcMonth WHEN '1900-01-01' THEN JcmSdt ELSE '1900-01-01' END) OR
	JcmSdt IN (SELECT dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,13,@Pi_UsrId)))
	AND J.JcmId=@JcmId AND T.TargetType=2 AND T.TargetLevel=2
	
	SELECT JcYear,JcMonth,SalId,SMId,RtrId 
	INTO #SR
	FROM SalesInvoice S
	INNER JOIN #JC J ON SalInvDate BETWEEN JcmSdt AND JcmEdt
	WHERE S.DlvSts IN (4,5)
	AND (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR
	SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
	
	SELECT JcYear,JcMonth,SP.SalId,SMId,RtrId,SP.PrdId,SUM(SP.PrdGrossAmount)PrdGrossAmount
	INTO #SRP
	FROM SalesInvoiceProduct SP
	INNER JOIN #SR SR ON SP.SalId=SR.SalId
	GROUP BY JcYear,JcMonth,SP.SalId,SMId,RtrId,SP.PrdId	
--select  * from #ReturnProduct		
	SELECT JcYear,JcMonth,RH.SalId,RH.SMId,RHP.PrdId,SUM(RHP.PrdGrossAmt)[ReturnGross] 
	INTO #ReturnProduct
	FROM ReturnHeader RH
	INNER JOIN ReturnProduct RHP ON RH.ReturnID=RHP.ReturnID
	INNER JOIN #SRP S ON S.SalId = RH.SalId AND S.PrdId = RHP.PrdId AND S.SMId=RH.SMId
	WHERE RH.Status=0
	GROUP BY JcYear,JcMonth,RH.SalId,RH.SMId,RHP.PrdId
		
	SELECT C.PrdCtgValMainId,C.PrdCtgValName,E.PrdId,E.PrdName--,SUM(CURMONTHTARGET) [SalesPlan]
	INTO #ProductBrand
	FROM ProductCategoryValue C  INNER JOIN ProductCategoryValue D ON
	D.PrdCtgValLinkCode LIKE CAST(c.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	AND c.cmpprdctgid in (SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName = 'BrandGroup')
	INNER JOIN Product E ON D.PrdCtgValMainId = E.PrdCtgValMainId	
	WHERE E.PrdStatus=1
	--Inner join targetanalysisdt TA WITH  (NOLOCK)on ta.PrdCtgValMainId =C.PrdCtgValMainId 
	/*WHERE c.prdctgvallinkcode in (SELECT PrdCtgValLinkCode  FROM ProductCategoryValue
	WHERE 
	--PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId)))
	--Group by c.PrdCtgValMainId,E.Prdid,E.PrdName,c.PrdCtgValName
	(PrdCtgValMainId = (CASE @Brand WHEN 0 THEN PrdCtgValMainId ELSE 0 END) OR
	PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,274,@Pi_UsrId))))*/
	
	SELECT SP.JcYear,SP.JcMonth,SP.SMId,S.SMName,PrdCtgValMainId,PrdCtgValName,COUNT(DISTINCT(SP.SalId))[BillsCut],COUNT(DISTINCT(RtrId))[ECO],
	COUNT(SP.PrdId)[LineSold],
	(ISNULL(SUM(SP.PrdGrossAmount),0)-ISNULL(SUM(ReturnGross),0))[SalesActual]
	INTO #Brand
	FROM #SRP SP
	INNER JOIN #ProductBrand PB ON SP.PrdId=PB.PrdId
	INNER JOIN Salesman S ON SP.SMId=S.SMId
	LEFT OUTER JOIN #ReturnProduct RP ON SP.PrdId=RP.PrdId AND SP.SalId=RP.SalId AND SP.JcMonth=RP.JcMonth AND SP.JcYear=SP.JcYear AND SP.SMId=RP.SMId
	GROUP BY SP.JcYear,SP.JcMonth,SP.SMId,S.SMName,PrdCtgValMainId,PrdCtgValName
	
	--INSERT INTO RptSalesmanBrandwiseTargetAnalysis
	SELECT DISTINCT CONVERT(NVARCHAR(10),J.JcmSdt,103)[JCMonth],B.SMName,B.PrdCtgValName[Brand],TD.ProductivityCalls[Planned BillsCut],B.[BillsCut],
	TD.ECO [Planned ECO],B.[ECO],TD.LineSold [Planned LineSold],B.[LineSold],
	(TD.CurMonthPlan)[SalesPlan],
	ROUND([SalesActual],2)[SalesActual],
	CASE (TD.CurMonthPlan) WHEN 0 THEN 0 ELSE CAST(ROUND(ROUND([SalesActual],0)/((TD.CurMonthPlan))*100,2) AS NUMERIC(18,2)) END [Achievement%],
	@Pi_UsrId[UserId]		
	INTO #RptSalesmanBrandwiseTargetAnalysis
	FROM #Brand B
	INNER JOIN TargetAnalysisHd TH ON B.JcYear=TH.JcmId AND B.JcMonth=TH.JcmJc
	INNER JOIN BrandSalesmanTarget TD ON TH.TargetAnalysisId=TD.TargetAnalysisId AND TD.PrdCtgValMainId=B.PrdCtgValMainId AND TD.SMId=B.SMId
	INNER JOIN #JC J ON J.JcYear=TH.JcmId AND J.JcMonth=TH.JcmJc AND B.JcYear=J.JcYear AND B.JcMonth=J.JcMonth
	WHERE TH.TargetType=2
	--GROUP BY J.JcmSdt,B.SMId,B.SMName,B.PrdCtgValMainId,B.PrdCtgValName,TD.ProductivityCalls,[BillsCut],TD.ECO,B.[ECO],TD.LineSold,B.[LineSold],[SalesActual]
	--ORDER BY J.JcmSdt,B.SMName,B.PrdCtgValName
	
	
	DELETE FROM RptSalesmanBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId
	
	INSERT INTO RptSalesmanBrandwiseTargetAnalysis
	SELECT [JCMonth],[SMName],[Brand],[Planned BillsCut],[BillsCut],[Planned ECO],[ECO],
	[Planned LineSold],[LineSold],[SalesPlan],[SalesActual],CAST([Achievement%]AS NVARCHAR(20))+'%' [Achievement%],[UserId]
	FROM #RptSalesmanBrandwiseTargetAnalysis
	--
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM RptSalesmanBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId
	
	SELECT * FROM RptSalesmanBrandwiseTargetAnalysis WHERE UserId=@Pi_UsrId	
	ORDER BY [JCMonth],SMName,[Brand]
END
GO
--Till Here
--KRPLReportProcedures
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptLoadingSheetBillWise' AND XTYPE='U')
DROP TABLE RptLoadingSheetBillWise
GO
CREATE TABLE RptLoadingSheetBillWise(
	[RtrId] [bigint] NULL,
	[Rtrname] [varchar](200) NULL,
	[Salid] [bigint] NULL,
	[InvoiceNo] [varchar](100) NULL,
	[InvoiceDate] [datetime] NULL,
	[SalNetAmount] [numeric](36, 2) NULL,
	[UserId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptBillwiseProductwiseLsheet' AND XTYPE='P')
DROP PROCEDURE Proc_RptBillwiseProductwiseLsheet
GO
CREATE PROCEDURE Proc_RptBillwiseProductwiseLsheet
-----  exec  Proc_RptBillwiseProductwiseLsheet 241,1,0,'gh',0,0,1
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************************
* CREATED BY	: Murugan.R
* CREATED DATE	: 2013-07-23
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------------------------------------
* {date}		{developer}  {brief modification description}
*************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
	--Filter Variable
	DECLARE @FromBillNo	   AS	BIGINT
	DECLARE @ToBillNo	   AS	BIGINT
	DECLARE @FromDate	   AS	DATETIME
	DECLARE @ToDate	 	   AS	DATETIME
	DECLARE @VehicleId     AS  INT
	DECLARE @VehicleAllocId AS	INT
	DECLARE @SMId	 	AS	INT
	DECLARE @DlvRouteId	AS	INT
	DECLARE @RtrId	 	AS	INT
	DECLARE @ErrNo   AS INT
	
	--Assgin Value for the Filter Variable
	SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @VehicleId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId))
	SET @VehicleAllocId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId))
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @DlvRouteId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))
	SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @FromBillNo =(SELECT  MIN(iCountid) FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))
	SET @ToBillNo =(SELECT  MAX(iCountid) FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))
	
	DELETE FROM RptLoadingSheetBillWise WHERE UserId=@Pi_UsrId
	
	CREATE TABLE #RptLoadingSheetProduct
	(
		PrdId INT,
		Prdccode Varchar(50),
		PrdName Varchar(200),
		Boxes BIGINT,
		Nos BIGINT,
		UserId INT
	)
	
	CREATE TABLE #RptLoadingSheetBillWise
	(
		RtrId BIGINT,
		Rtrname Varchar(200),
		Salid BIGINT,
		InvoiceNo Varchar(100),
		InvoiceDate Datetime,
		SalNetAmount Numeric(36,2),
		UserId INT
	)
	--Till Here
	SELECT VM.AllotmentId,VM.AllotmentNumber,VM.VehicleId,SaleInvNo 
	INTO #VehicleMaster
	FROM VehicleAllocationMaster VM,VehicleAllocationDetails VD
	WHERE VM.AllotmentNumber = VD.AllotmentNumber
	AND (VM.VehicleId = (CASE @VehicleId WHEN 0 THEN VM.VehicleId ELSE 0 END) OR
							VM.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )
			
			 AND (VM.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN VM.AllotmentId ELSE 0 END) OR
							VM.AllotmentId in (SELECT CAST(iCountid AS VARCHAR(50)) FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
		
		SELECT SI.Salid,Salinvdate,Salinvno,R.RtrId,RtrName,SMID,SI.DlvRMId,SalNetAmt,P.PrdId,PrdName,Prdccode,BaseQty 
		INTO #LoadingSheetSales
		FROM SalesInvoice SI 
		INNER JOIN SalesInvoiceProduct SIP ON SI.Salid=SIP.Salid
		INNER JOIN Retailer R ON R.RtrId=SI.RtrId
		INNER JOIN Product P ON P.PrdId=SIP.Prdid
		left outer join #VehicleMaster V ON 
		SI.VehicleId  = V.VehicleId and SI.SalInvNo = V.SaleInvNo
		WHERE 
		Salinvdate BETWEEN @FromDate and @ToDate
		AND Dlvsts=2
		AND SI.Salid between 
		CASE WHEN ISNULL(@FromBillNo,0)=0 THEN SI.SalId ELSE @FromBillNo END
		AND CASE WHEN ISNULL(@ToBillNo,0)=0 THEN SI.SalId ELSE @ToBillNo END
		AND (V.VehicleId = (CASE @VehicleId WHEN 0 THEN V.VehicleId ELSE 0 END) OR
								V.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )
				
				 AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
								V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
				
				 AND (SI.SMId=(CASE @SMId WHEN 0 THEN SI.SMId ELSE 0 END) OR
								SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				
				 AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
								SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				
				 AND (SI.RtrId = (CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
								SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )
								
		SELECT Prdid,Prdccode,PrdName,SUM(BaseQty) as BaseQty
		INTO #ProductWise								
		FROM #LoadingSheetSales
		GROUP BY  Prdid,Prdccode,PrdName
		
		SELECT DISTINCT Prdid,U.Uomgroupid 
		INTO #ProductTemp 
		FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
		GROUP BY Prdid,U.Uomgroupid HAVING Count(U.UomgroupId)>1
		SELECT DISTINCT Prdid,U.Uomgroupid
		INTO #ProductTemp1 
		FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
		GROUP BY Prdid,U.Uomgroupid Having Count(U.UomgroupId)<=1
		
	
		
				INSERT INTO #RptLoadingSheetProduct	(PrdId,Prdccode,PrdName,Boxes,Nos,UserId)
				SELECT T.PrdId,T.PrdCcode,T.PrdName,						
				CAST(CASE WHEN BaseQty<MAX(ConversionFactor) THEN 0 ELSE BaseQty/MAX(ConversionFactor)END AS BIGINT)  as  Boxes,
				CAST(CASE WHEN BaseQty<MAX(ConversionFactor) THEN BaseQty ELSE BaseQty%MAX(ConversionFactor) END AS BIGINT )as NOS,
				@Pi_UsrId as UserId
				FROM #ProductTemp P 
				INNER JOIN UOMGROUP UG ON P.Uomgroupid=UG.UomGroupId
				INNER JOIN #ProductWise T ON P.Prdid=T.Prdid
				INNER JOIN UOMMASTER UM ON UM.UOMID=UG.UOMID
				GROUP BY T.PrdId,T.PrdCcode,T.PrdName,BaseQty,UG.Uomgroupid
				UNION ALL
				SELECT T.PrdId,T.PrdCcode,T.PrdName, 
				ISNULL(CASE WHEN Uomcode='BOX' THEN BaseQty	END ,0) AS Boxes,
				ISNULL(CASE WHEN Uomcode='NOS' THEN BaseQty	END ,0) AS NOS,
				@Pi_UsrId as UserId
				FROM #ProductTemp1 P 
				INNER JOIN UOMGROUP UG ON P.Uomgroupid=UG.UomGroupId
				INNER JOIN UomMaster U ON UG.UomId=U.Uomid
				INNER JOIN #ProductWise T ON P.Prdid=T.Prdid
				GROUP BY T.PrdId,T.PrdCcode,T.PrdName,Uomcode,BaseQty,UG.Uomgroupid
				
				INSERT INTO RptLoadingSheetBillWise(RtrId,Rtrname,Salid,InvoiceNo,InvoiceDate,SalNetAmount,UserId)
				SELECT DISTINCT RtrId,RtrName,Salid,Salinvno,Salinvdate,SalNetAmt,@Pi_UsrId as UserId
				FROM #LoadingSheetSales Order by Salinvdate,salid
	
				
				
				SELECT * FROM #RptLoadingSheetProduct Order by Prdname
				Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
				INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
				SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptLoadingSheetProduct
END
GO
--HTNReportProcedures
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptLogisticStock' AND XTYPE='P')
DROP PROCEDURE Proc_RptLogisticStock
GO
---- EXEC Proc_RptLogisticStock 240,1,0,'dfs',0,0,1
CREATE PROCEDURE Proc_RptLogisticStock
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/****************************************************************************
* PROCEDURE  : Proc_RptLogisticStock
* PURPOSE    : To Generate Logistic Stock
* CREATED BY : Murugan.R
* CREATED ON : 2013-08-07
* MODIFICATION
* DATE      AUTHOR     DESCRIPTION
----------------------------------------------------------------
* {date}		{developer}			{brief modification description}
*****************************************************************************/
SET NOCOUNT ON
BEGIN

--Filter Variable


DECLARE @ErrNo	 	AS	INT
DECLARE @FromDate	AS	DATETIME
DECLARE @ToDate		AS	DATETIME
DECLARE @CmpId	 	AS	INT
DECLARE @SpmId	 	AS	INT
DECLARE @GRN		AS	NVARCHAR(100)
DECLARE @CmpInv		AS	NVARCHAR(100)
DECLARE @PurRetId	AS	INT


SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
SET @SpmId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId))
SET @GRN = (SELECT  TOP 1 SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,173,@Pi_UsrId))
SET @CmpInv = (SELECT  TOP 1 SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,174,@Pi_UsrId))



CREATE TABLE #LogisticMaterialstock
	(
		DistributorCode nvarchar(40),
		DistributorName nvarchar(100),
		DistributorAdd1  nvarchar(100),
		DistributorAdd2  nvarchar(100),
		DistributorAdd3	nvarchar(40),
		TransporterName	nvarchar(100),
		PurRcptRefNo	nvarchar(100),
		CmpInvNo		nvarchar(100),
		GoodsRcvdDate	DateTime,
		InvDate			DateTime,
		MaterialCode	nvarchar(200),
		MaterialName	nvarchar(200),
		QtyReceived		INT,
		QtyReturned		INT
		
	)
	INSERT INTO #LogisticMaterialstock(DistributorCode,DistributorName,DistributorAdd1,DistributorAdd2,DistributorAdd3,TransporterName,
	PurRcptRefNo,CmpInvNo,GoodsRcvdDate,InvDate,A.MaterialCode,MaterialName,QtyReceived,QtyReturned)
	SELECT DistributorCode,DistributorName,DistributorAdd1,DistributorAdd2,DistributorAdd3,TransporterName,
	PurRcptRefNo,CmpInvNo,GoodsRcvdDate,InvDate,A.MaterialCode,MaterialName,QtyReceived,QtyReturned 
	FROM LogisticMaterialMaster A 
	INNER JOIN PurchaseLogisticMaterialStock B ON A.MaterialId=B.MaterialId
	INNER JOIN PurchaseReceipt C ON C.PurRcptId=B.PurRcptId
	INNER JOIN Transporter T ON T.TransporterId=C.TransporterId
	INNER JOIN Company E ON C.CmpId=E.CmpId
	CROSS JOIN Distributor D
	WHERE 
		( E.CmpId = (CASE @CmpId WHEN 0 THEN E.CmpId ELSE 0 END) OR
					E.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND
					( C.SpmId = (CASE @SpmId WHEN 0 THEN C.SpmId ELSE 0 END) OR
					C.SpmId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,9,@Pi_UsrId)))
				AND
					(PurRcptRefNo = (CASE @GRN WHEN '0' THEN PurRcptRefNo ELSE '' END) OR
					PurRcptRefNo IN (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,173,@Pi_UsrId)))
				AND
					(CmpInvNo = (CASE @CmpInv WHEN '0' THEN CmpInvNo ELSE '' END) OR
					CmpInvNo IN (SELECT SCountid FROM Fn_ReturnRptFilterString(@Pi_RptId,174,@Pi_UsrId)))
				
		AND GoodsRcvdDate between  @FromDate and  @ToDate
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #LogisticMaterialstock
	
	SELECT DistributorCode,DistributorName,DistributorAdd1,DistributorAdd2,DistributorAdd3,TransporterName,
	PurRcptRefNo,CmpInvNo,GoodsRcvdDate,InvDate,MaterialCode,MaterialName,QtyReceived,QtyReturned
	FROM #LogisticMaterialstock
RETURN
END
GO
--AkzoNobel_ReportProcedures
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptAkzoRetAccStatement' AND XTYPE='P')
DROP PROCEDURE Proc_RptAkzoRetAccStatement
GO
----   exec  Proc_RptAkzoRetAccStatement 222,2,0,'Dabur',0,0,1
CREATE Procedure Proc_RptAkzoRetAccStatement
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
Begin
SET NOCOUNT ON
/****************************************************************************
* PROCEDURE: Proc_RptAkzoRetAccStatement
* PURPOSE: General Procedure
* NOTES:
* CREATED: Panneer	14.03.2011
* MODIFIED
* DATE         AUTHOR     DESCRIPTION
------------------------------------------------------------------------------
* 22.03.2011   Panneer    BugFixing
* 29.03.2011   
*****************************************************************************/

	DECLARE @FromDate			AS DATETIME
	DECLARE @ToDate				AS DATETIME
	DECLARE @NewSnapId 			AS	INT
	DECLARE @DBNAME				AS 	NVARCHAR(50)
	DECLARE @TblName 			AS	NVARCHAR(500)
	DECLARE @TblStruct 			AS	VARCHAR(8000)
	DECLARE @TblFields 			AS	VARCHAR(8000)
	DECLARE @sSql				AS 	VARCHAR(8000)
	DECLARE @ErrNo	 			AS	INT
	DECLARE @PurDBName			AS	NVARCHAR(50)

	DECLARE @SMId				AS	INT
	DECLARE @RMId				AS	INT
	DECLARE @RtrId				AS	INT
	DECLARE @RtrId1				AS	INT

	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)

	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)

	SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @RtrId1 =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))

	CREATE TABLE #RptAkzoRetAccStatement
	(
			[Description]       NVARCHAR(200),
			[RtrId]				INT,
			[RtrCode]           NVARCHAR(200),
			[RtrName]           NVARCHAR(200),
			[DocRefNo]          NVARCHAR(200),
			[Date]				NVARCHAR(10),
			[Debit]				NUMERIC (38,6),
			[Credit]			NUMERIC (38,6),
			[Balance]			NUMERIC (38,6),
			[TransactionDet]    NVARCHAR(200),
			[CheqorDueDate]     NVARCHAR(10),
			[SeqNo]				INT,
			[UserId]			INT
	)

SET @TblName = 'RptAkzoRetAccStatement'
SET @TblStruct = '	[Description]       NVARCHAR(200),
					[RtrId]				INT,
					[RtrCode]           NVARCHAR(200),
					[RtrName]           NVARCHAR(200),
					[DocRefNo]          NVARCHAR(200),
					[Date]				NVARCHAR(10),
					[Debit]				NUMERIC (38,6),
					[Credit]			NUMERIC (38,6),
					[Balance]			NUMERIC (38,6),
					[TransactionDet]    NVARCHAR(200),
					[CheqorDueDate]     NVARCHAR(10),
					[SeqNo]				INT
					[UserId]			INT'
SET @TblFields = '  [Description],[RtrId],[RtrCode],[RtrName],[DocRefNo],[Date],[Debit],[Credit],
					[Balance],[TransactionDet],[CheqorDueDate],[SeqNo],[UserId]'

IF @Pi_GetFromSnap = 1
BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME =  @DBNAME
END
ELSE
BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
END

IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
BEGIN

		IF @RtrId = 0
		BEGIN
			Exec Proc_RetailerAccountStment @FromDate,@ToDate,0
		END
		IF @RtrId <> 0
		BEGIN
			Exec Proc_RetailerAccountStment @FromDate,@ToDate,@RtrId
		END
 
		INSERT INTO #RptAkzoRetAccStatement ([Description],[RtrId],DocRefNo,Date,Debit,Credit,Balance,
											 TransactionDet,CheqorDueDate,SeqNo,UserId)
			/*	Calculate Opening Balance Details  */	
		Select  
				'Opening Balance'   [Description],RtrId, '' DocRefNo, convert(Varchar(10),@FromDate,121) Date,
				 0 as Debit,0 As Credit,BalanceAmount as balance,
				'' as TransactionDet,'' CheqorDueDate,1 SeqNo,@Pi_UsrId
		From 
				TempRetailerAccountStatement  (NoLock) 
		Where	Details = 'Opening Balance'
				
 				 
				/*	Calculate Sales Details  */ 
		UNION ALL 
		Select  
				'Invoice' [Description],B.RtrId,SalInvNo DocRefNo,convert(Varchar(10),SalInvDate,121)  Date,
				DbAmount Debit,0 as Credit,0 Balance,'' as TransactionDet,
				convert(Varchar(10),SalDlvDate,121) CheqorDueDate,2 SeqNo, @Pi_UsrId
		From 
				TempRetailerAccountStatement a (NoLock) ,SalesInvoice B (NoLock)
		WHere
				Details = 'Sales' and A.DocumentNo = B.SalInvNo 
		UNION ALL
		Select  
				'Total Invoice IN' [Description],B.RtrId,'' DocRefNo,'' Date,
				0 Debit,0 as Credit, Isnull(SUM(DbAmount),0) Balance,'' as TransactionDet,
				'' CheqorDueDate,3 SeqNo,@Pi_UsrId
		From 
				TempRetailerAccountStatement a (NoLock) ,SalesInvoice B (NoLock)
		WHere
				Details = 'Sales' and A.DocumentNo = B.SalInvNo 
		GROUP BY B.RtrId
					/*	Calculate Cheque Details  */
		UNION ALL		
		Select  
				'Cheque Received' [Description],SI.RtrId,RI.InvRcpNo DocRefNo,convert(Varchar(10),InvRcpDate,121)  Date,
				0 Debit,Sum(RI.SalInvAmt)  as Credit, 0 Balance,InvInsNo as TransactionDet,
				Isnull(convert(Varchar(10),InvInsDate,121),'') CheqorDueDate,4 SeqNo, @Pi_UsrId
		From 
				ReceiptInvoice RI (NoLock),	TempRetailerAccountStatement T (NoLock) ,
				Receipt  R  (NoLock),		SalesInvoice SI (NoLock)
		Where
				RI.InvRcpNo = T.DocumentNo  AND  RI.InvRcpNo = R.InvRcpNo
				and Details = 'Collection'  AND InvRcpMode IN (1,2,3,4,8)
				And T.RtrId = SI.RtrId		AND SI.SalInvNo = T.Refno AND RI.SALID= SI.SALID
				AND  CancelStatus = 1
		Group By
				SI.RtrId,RI.InvRcpNo,InvRcpDate,InvInsNo,InvInsDate 
		UNION ALL
		Select  
				'Total Receipt Received' [Description],SI.RtrId,'' DocRefNo,'' Date,
				0 Debit,0  as Credit, (-1) * Isnull(Sum(RI.SalInvAmt),0) Balance,'' as TransactionDet,
				'' CheqorDueDate,5 SeqNo,@Pi_UsrId
		From 
				ReceiptInvoice RI (NoLock),	TempRetailerAccountStatement T (NoLock) ,
				Receipt  R  (NoLock),		SalesInvoice SI (NoLock)
		Where
				RI.InvRcpNo = T.DocumentNo  AND  RI.InvRcpNo = R.InvRcpNo
				and Details = 'Collection'  AND InvRcpMode IN (1,2,3,4,8)
				And RI.SalId = SI.SalId 
				And T.RtrId = SI.RtrId		AND SI.SalInvNo = T.Refno 
				AND  CancelStatus = 1
		GROUP BY SI.RtrId

				/*	Calculate Debit Note Details  */
		UNION ALL
		Select 'Debit Note - CD' AS [Description],A.RtrId,DBNoteNumber DocRefNo,convert(Varchar(10),DBNoteDate,121)  Date,
				Isnull(DbAmount,0) Debit,Isnull(CRAmount,0) as Credit, 0 Balance,Isnull(Remarks,'') as TransaonDet,
				'' CheqorDueDate,6 SeqNo,@Pi_UsrId
		From 
				DebitNoteRetailer A (NoLock),TempRetailerAccountStatement T  (NoLock)		
		Where 
				A.DBNoteNumber = T.DocumentNo	AND Details = 'Debit Note Retailer'	
		UNION ALL

  Select 'DEBIT NOTE-ADJ' as [Description],A.RtrId,DBNoteNumber DocRefNo,convert(Varchar(10),DBNoteDate,121)  Date,
				0 Debit,DbAdjAmount as Credit, 0 Balance,Isnull(Remarks,'') as TransaonDet,
				'' CheqorDueDate, 6 SeqNo,@Pi_UsrId
	   	From 
				DebitNoteRetailer A (NoLock),TempRetailerAccountStatement T  (NoLock)		
	   	Where 
				A.DBNoteNumber = T.DocumentNo	AND Details = 'Debit Note Retailer'
          UNION ALL 

		Select 'Total Debit Notes' AS [Description],A.RtrId,'' DocRefNo,'' Date,
				0 Debit,0 as Credit, Isnull(Sum(DbAmount - CRAmount-DbAdjAmount),0) Balance,'' as TransaonDet,
				'' CheqorDueDate,7 SeqNo,@Pi_UsrId
		From 
				DebitNoteRetailer A (NoLock),TempRetailerAccountStatement T  (NoLock)		
		Where 
				A.DBNoteNumber = T.DocumentNo	AND Details = 'Debit Note Retailer'
		GROUP BY A.RtrId
				
				/*  Calculate Return  Details  */
		UNION ALL
		Select  'Credit Invoice',A.RtrId,ReturnCode DocRefNo,convert(Varchar(10),ReturnDate,121)  Date,
				0 as Debit,CrAmount as Credit,0 as  Balance,Isnull(DocRefNo,'') as TransaonDet,
				'' CheqorDueDate,8 SeqNo,@Pi_UsrId
		From
				ReturnHeader  A (Nolock) ,TempRetailerAccountStatement T (Nolock)
		Where	
				Details = 'Sales Return' AND A.ReturnCode = T.DocumentNo
		UNION ALL
		Select  'Total Credit Invoice',A.RtrId,'' DocRefNo,'' Date,
				0 as Debit,0 as Credit,Isnull(Sum(CrAmount),0) * (-1) as  Balance,
				'' as TransaonDet,
				'' CheqorDueDate,9 SeqNo,@Pi_UsrId
		From
				ReturnHeader  A (Nolock) ,TempRetailerAccountStatement T (Nolock)
		Where	
				Details = 'Sales Return' AND A.ReturnCode = T.DocumentNo
		GROUP BY A.RtrId
	
 				/*  Calculate Credit Note  Details  */
		UNION ALL
		Select 'Credit Note' AS [Description],A.RtrId,CRNoteNumber DocRefNo,convert(Varchar(10),CRNoteDate,121)  Date,
				Isnull(DBAmount,0) Debit,Isnull(CRAmount,0) as Credit, 0 Balance,Isnull(Remarks,'') as TransaonDet,
				'' CheqorDueDate,10 SeqNo,@Pi_UsrId
		From 
				CreditNoteRetailer A (NoLock),TempRetailerAccountStatement T  (NoLock)		
		Where 
				A.CRNoteNumber = T.DocumentNo	AND Details = 'Credit Note Retailer'	
		UNION ALL
		Select 'Total Credit Notes' AS [Description],A.RtrId,'' DocRefNo,'' Date,
				0 Debit,0 as Credit,-(1) * Isnull(Sum(CRAmount-DBAmount),0) Balance,'' as TransaonDet,
				'' CheqorDueDate,11 SeqNo,@Pi_UsrId
		From 
				CreditNoteRetailer A (NoLock),TempRetailerAccountStatement T  (NoLock)		
		Where 
				A.CRNoteNumber = T.DocumentNo	AND Details = 'Credit Note Retailer'
		GROUP BY A.RtrId
					/*  Calculate Return & Replacement  Details  */
		Union ALL
		Select 
				'Return & Replacement-Replacement' AS [Description],A.RtrId,RepRefNo DocRefNo,convert(Varchar(10),RepDate,121)   Date,
				DBAmount Debit,0 Credit,0 Balance ,Isnull(DocRefNo,'') DocRefNo,
				'' CheqorDueDate,12 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , ReplacementHd A (Nolock)
		WHERE
				A.RepRefNo = T.DocumentNo AND Details = 'Return & Replacement-Replacement'
		Union ALL
		Select 
				'Total Return & Replacement-Replacement' AS [Description],A.RtrId,'' DocRefNo,''  Date,
				0 Debit,0 Credit,Isnull(Sum(DBAmount),0) Balance , '' DocRefNo,
				'' CheqorDueDate,13 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , ReplacementHd A (Nolock)
		WHERE
				A.RepRefNo = T.DocumentNo AND  Details = 'Return & Replacement-Replacement'
		GROUP BY A.RtrId

					/*  Calculate Return & Replacement  Details  */
		Union ALl
		Select 
				'Return & Replacement-Return' AS [Description],A.RtrId,RepRefNo DocRefNo,convert(Varchar(10),RepDate,121)  Date,
				0 Debit,CRAmount Credit,0 Balance ,Isnull(DocRefNo,'') DocRefNo,
				'' CheqorDueDate,14 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , ReplacementHd A (Nolock)
		WHERE
				A.RepRefNo = T.DocumentNo AND Details = 'Return & Replacement-Return'
		Union ALL
		Select 
				'Total Return & Replacement-Return' AS [Description],A.RtrId,'' DocRefNo,''  Date,
				0 Debit,0 Credit,(-1) * Isnull(Sum(CRAmount),0) Balance , '' DocRefNo,
				'' CheqorDueDate,15 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , ReplacementHd A (Nolock)
		WHERE
				A.RepRefNo = T.DocumentNo AND  Details = 'Return & Replacement-Return'
		GROUP BY A.RtrId
					/*  Calculate Collection-Cheque Bounce Details  */
		Union ALl
		Select 
				'Collection-Cheque Bounce' AS [Description],RtrId,InvRcpNo, convert(Varchar(10),InvRcpDate,121)     Date,
				DbAmount Debit,0 Credit,0 Balance ,'' DocRefNo,
				'' CheqorDueDate,16 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , Receipt A (Nolock)
		WHERE
				A.InvRcpNo = T.DocumentNo AND Details = 'Collection-Cheque Bounce'
--		Union ALL
--		Select 
--				'Total Collection-Cheque Bounce' AS [Description],T.RtrId,'' DocRefNo,''  Date,
--				0 Debit,0 Credit,  Isnull(Sum(DbAmount),0) - Isnull(Sum(B.CrAmount),0) Balance , '' DocRefNo,
--				'' CheqorDueDate,17 SeqNo, @Pi_UsrId
--		From 
--			 	TempRetailerAccountStatement T (Nolock) INNER JOIN 
--				(SELECT T.RtrId,Isnull(Sum(CrAmount),0) AS CrAmount 		From 
--				ReceiptInvoice RI (NoLock),	TempRetailerAccountStatement T (NoLock) ,
--				Receipt  R  (NoLock),		SalesInvoice SI (NoLock)
--		Where
--				RI.InvRcpNo = T.DocumentNo  AND  RI.InvRcpNo = R.InvRcpNo
--				and Details = 'Collection'  AND InvRcpMode IN (1,2,3,4,8)
--				AND T.Rtrid  = CASE @RtrId WHEN 0 THEN T.RtrId ELSE @RtrId END And RI.SalId = SI.SalId 
--				And T.RtrId = SI.RtrId		AND SI.SalInvNo = T.Refno
--				AND  CancelStatus = 1 Group By T.RtrId) B ON T.RtrId=B.RtrId
--		WHERE
--				Details = 'Collection-Cheque Bounce'
--		GROUP BY T.RtrId

		Union ALL
		Select 
				'Total Collection-Cheque Bounce' AS [Description],RtrId,'' DocRefNo,''  Date,
				0 Debit,0 Credit, Isnull(Sum(DbAmount),0) Balance , '' DocRefNo,
				'' CheqorDueDate,17 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) 
		WHERE
				Details = 'Collection-Cheque Bounce'
		GROUP BY T.RtrId
					/*  Calculate Collection-Cheque Bounce Details  */
		Union ALl
		Select 
				'Collection-Cash Cancellation' AS [Description],RtrId,InvRcpNo, convert(Varchar(10),InvRcpDate,121)  Date,
				DbAmount Debit,0 Credit,0 Balance ,'' DocRefNo,
				'' CheqorDueDate,18 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , Receipt A (Nolock)
		WHERE
				A.InvRcpNo = T.DocumentNo AND Details = 'Collection-Cash Cancellation'
		Union ALL
		Select 
				'Total Collection-Cash Cancellation' AS [Description],RtrId,'' DocRefNo,''  Date,
				0 Debit,0 Credit, Isnull(Sum(DbAmount),0) Balance , '' DocRefNo,
				'' CheqorDueDate,19 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) 
		WHERE
				Details = 'Collection-Cash Cancellation'
		GROUP BY RtrId

				/*  Calculate Retailer On Account Details  */
		Union ALl
		Select 
				'Retailer On Account' AS [Description],A.RtrId,RtrAccRefNo,  convert(Varchar(10),ChequeDate,121)   Date,
				DbAmount Debit,0 Credit,0 Balance ,Remarks DocRefNo,
				'' CheqorDueDate,20 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) , RetailerOnAccount A (Nolock)
		WHERE
				A.RtrAccRefNo = T.DocumentNo AND Details = 'Retailer On Account'
		Union ALL
		Select 
				'Total Retailer On Account' AS [Description],RtrId,'' DocRefNo,''  Date,
				0 Debit,0 Credit, (-1) * Isnull(Sum(CRAmount),0) Balance , '' DocRefNo,
				'' CheqorDueDate,21 SeqNo, @Pi_UsrId
		From 
			 	TempRetailerAccountStatement T (Nolock) 
		WHERE
				Details = 'Retailer On Account'
		GROUP BY RtrId

				/*  Calculate Closing Balance Details  */
		UNION ALL
		Select  
				'Closing Balance' [Description],RtrId, '' DocRefNo,convert(Varchar(10),@ToDate,121)  Date,
				0 as Debit,0 Credit, 0  Balance,
				'' as TransactionDet,'' CheqorDueDate,22 SeqNo,@Pi_UsrId
		From 
				TempRetailerAccountStatement 
		Where
				Details = 'Closing Balance'	

--		DECLARE @ClBal Numeric(18,4)
--		Select RtrId,Sum(Balance) AS BalAmt  From  #RptAkzoRetAccStatement 
--		Where SeqNo in (1,3,5,7,9,11,13,15,17,19,21) GROUP BY RtrId
				
		Update A Set Balance = BalAmt FROM #RptAkzoRetAccStatement A INNER JOIN
		(Select RtrId,Sum(Balance) AS BalAmt  From  #RptAkzoRetAccStatement 
		 Where SeqNo in (1,3,5,7,9,11,13,15,17,19,21) GROUP BY RtrId) B
		ON A.RtrId=B.RtrId Where SeqNo = 22


	END

	Delete From #RptAkzoRetAccStatement 
	WHere Balance  = 0 and SeqNo  in (3,5,7,9,11,13,15,17,19,21)

	UPDATE A SET A.RtrCode=B.RtrCode,A.Rtrname=B.RtrName FROM #RptAkzoRetAccStatement A
	INNER JOIN Retailer B ON A.RtrId=B.RtrId

	IF @RtrId1>0
	BEGIN
		DELETE FROM #RptAkzoRetAccStatement WHERE RtrId NOT IN (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) 				
	END

	DELETE FROM #RptAkzoRetAccStatement WHERE RtrId NOT IN
	(SELECT DISTINCT RtrId FROM #RptAkzoRetAccStatement WHERE SeqNo BETWEEN 2 AND 21 AND UserId = @Pi_UsrId)
	
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptAkzoRetAccStatement

	UPDATE #RptAkzoRetAccStatement SET [Date]=convert(Varchar(10),CONVERT(datetime,[Date]),105)
	UPDATE #RptAkzoRetAccStatement SET [Date]='' WHERE [Date]='01-01-1900'

--	IF @RtrId>0
--	BEGIN
		Select * from #RptAkzoRetAccStatement Order by SeqNo,[Description],RtrId
--	END
--	ELSE
--	BEGIN
--		DELETE FROM #RptAkzoRetAccStatement WHERE RtrId NOT IN
--		(SELECT DISTINCT RtrId FROM #RptAkzoRetAccStatement WHERE SeqNo BETWEEN 2 AND 21 AND UserId = @Pi_UsrId)
--		Select * from #RptAkzoRetAccStatement Order by RtrId,SeqNo,[Description]
--	END
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptAkzoStockLedgerReport' AND XTYPE='P')
DROP PROCEDURE Proc_RptAkzoStockLedgerReport
GO
----  Exec [Proc_RptAkzoStockLedgerReport] 225,2,0,'Loreal',0,0,1
---- select *  from RptProductTrack
---- select * from users
CREATE  PROCEDURE Proc_RptAkzoStockLedgerReport
(
	@Pi_RptId  INT,
	@Pi_UsrId  INT,
	@Pi_SnapId  INT,
	@Pi_DbName  nvarchar(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap  INT,
	@Pi_CurrencyId  INT
)
AS
/***************************************************************************************************
* PROCEDURE : Proc_RptAkzoStockLedgerReport
* PURPOSE   : Product transaction details
* CREATED	: Panneer
* CREATED DATE : 16.03.2011
* NOTE		: General SP For Product transaction details
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
---------------------------------------------------------------------------------------------------
* {date}     {developer}  {brief modification description}
***************************************************************************************************/
BEGIN
SET NOCOUNT ON

	DECLARE @NewSnapId   AS INT
	DECLARE @DBNAME		 AS nvarchar(50)
	DECLARE @TblName	 AS nvarchar(500)
	DECLARE @TblStruct   AS nVarchar(4000)
	DECLARE @TblFields   AS nVarchar(4000)
	DECLARE @sSql		 AS nVarChar(4000)
	DECLARE @ErrNo		 AS INT
	DECLARE @PurDBName	 AS nVarChar(50)

	--Filter Variable
	DECLARE @FromDate			AS DATETIME
	DECLARE @ToDate				AS DATETIME
	DECLARE @CmpId				AS Int
	DECLARE @CmpPrdCtgId		AS Int
	DECLARE @PrdCtgMainId		AS Int
	DECLARE @PrdId				AS INT
	DECLARE @PrdCatPrdId        AS  INT
	DECLARE @LcnId				AS INT
	DECLARE @SupZeroStock		AS INT
	DECLARE @ZeroStockRecCount  AS INT
	--Till Here

	--Assgin Value for the Filter Variable
	SET @FromDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate   = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @CmpId    = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId    = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))	
	SET @PrdId    = (SELECT  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @SupZeroStock = (SELECT  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,262,@Pi_UsrId))
 
	EXEC Proc_AkzoProductTrackDetails @Pi_UsrId,@FromDate,@ToDate 

	CREATE TABLE #RptAkzoStockLedgerReport
	(
						TransactionDate		DATETIME,
						TransactionType		NVARCHAR(300),
						TransactionNumber   NVARCHAR(100),
						SalQty				NUMERIC(38,0),
						SalQtyVolume		NUMERIC(38,6),
						UnSalQty			NUMERIC(38,0),
						UnSalQtyVolume		NUMERIC(38,6),
						OfferQty   NUMERIC(38,0),
						OfferQtyVolume   NUMERIC(38,6),
						SlNo    INT,
						PrdId   INT
	)
	SET @TblName = 'RptAkzoStockLedgerReport'
	SET @TblStruct = '	TransactionDate		DATETIME,
						TransactionType		NVARCHAR(300),
						TransactionNumber   NVARCHAR(100),
						SalQty				NUMERIC(38,0),
						SalQtyVolume		NUMERIC(38,6),
						UnSalQty			NUMERIC(38,0),
						UnSalQtyVolume		NUMERIC(38,6),
						OfferQty   NUMERIC(38,0),
						OfferQtyVolume   NUMERIC(38,6),
						SlNo    INT,
						PrdId   INT'

	SET @TblFields = '	TransactionDate,TransactionType,TransactionNumber,SalQty,SalQtyVolume,
						UnSalQty,UnSalQtyVolume,OfferQty,OfferQtyVolume,SlNo,PrdId'

	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END

	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
			  INSERT INTO #RptAkzoStockLedgerReport (	TransactionDate,TransactionType,TransactionNumber,
														SalQty,SalQtyVolume,UnSalQty,UnSalQtyVolume,
														OfferQty,OfferQtyVolume,SlNo,PrdId)
			  SELECT 
					TransactionDate,TransactionType,TransactionNumber,
					SUM(SalQty),SUM(SalQty * PrdWgt) SalQtyVolume,
					SUM(UnSalQty),SUM(UnSalQty * PrdWgt) UnSalQtyVolume,
					SUM(OfferQty),SUM(OfferQty * PrdWgt) OfferQtyVolume,
					SlNo,A.PrdId
			  FROM 
					RptProductTrack A, Product B
			  WHERE 
					A. PrdId = B.Prdid 
					AND (A.CmpId=  (CASE @CmpId WHEN 0 THEN A.CmpId ELSE 0 END ) OR
							A.CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
										
					AND (LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
							LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) )

					 AND (A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId ELSE 0 END) OR
							A.PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) )

					AND  TransactionDate BETWEEN @FromDate AND  @ToDate AND UsrId=@Pi_UsrId

			  GROUP BY 
					TransactionDate,TransactionType,TransactionNumber,SlNo,A.PrdId
			  ORDER BY 
					TransactionDate,SlNo

		IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptAkzoStockLedgerReport ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
				+'  WHERE (CmpId=  (CASE '+CAST(@CmpId AS NVARCHAR(10))+' WHEN 0 THEN CmpId ELSE 0 END ) OR
				CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+', 4, '+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND (LcnId = (CASE '+CAST(@LcnId AS NVARCHAR(10))+' WHEN 0 THEN LcnId ELSE 0 END) OR
				LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',22,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (LevelId =  (CASE '+CAST(@CmpPrdCtgId AS NVARCHAR(10))+' WHEN 0 THEN LevelId ELSE 0 END ) OR
				LevelId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',21,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (LevelValId = (CASE '+CAST(@PrdCtgMainId AS NVARCHAR(10))+' WHEN 0 THEN LevelValId Else 0 END) OR
				LevelValId IN (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',16,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND   (PrdId = (CASE '+CAST(@PrdId AS NVARCHAR(10))+' WHEN 0 THEN PrdId Else 0 END) OR
				PrdId in (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',5,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))'
				+'AND TransactionDate Between '''+CAST(@FromDate AS NVARCHAR(10))+''' and '''+ CAST(@FromDate AS NVARCHAR(10))+''''
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END

		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptAkzoStockLedgerReport'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		PRINT @Pi_DbName
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptAkzoStockLedgerReport ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			PRINT @SSQL
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
	ELSE
	BEGIN
		--  SET @Po_Errno = 1
		PRINT 'DataBase or Table not Found'
		RETURN
	END
	END

	IF @SupZeroStock = 1
	BEGIN
--		DELETE FROM #RptAkzoStockLedgerReport WHERE (Abs(SalQty)+ABS(UnSalQty) + ABS(OfferQty)) = 0
	SELECT * FROM #RptAkzoStockLedgerReport 
			 WHERE (SalQty+UnSalQty+OfferQty)<>0 ORDER BY SlNo
	END

	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)

	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptAkzoStockLedgerReport
	PRINT 'Data Executed'
	SELECT * FROM #RptAkzoStockLedgerReport ORDER BY TransactionDate,SlNo ASC 

	RETURN
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptCurrentStockAN' AND XTYPE='P')
DROP PROCEDURE Proc_RptCurrentStockAN
GO
-- EXEC [Proc_RptCurrentStockAN] 221,2,0,'PARLEFRESHDB',0,0,1,0
CREATE PROC Proc_RptCurrentStockAN
(
	@Pi_RptId  INT,
	@Pi_UsrId  INT,
	@Pi_SnapId  INT,
	@Pi_DbName  nvarchar(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap  INT,
	@Pi_CurrencyId  INT,
	@Po_Errno  INT OUTPUT
)
AS
BEGIN
-- =============================================
-- Author:		R.Vasantharaj
-- Create date: 17/03/2011
-- Description:	Current Stock Report
-- =============================================
SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  nvarchar(50)
	DECLARE @TblName  AS nvarchar(500)
	DECLARE @TblStruct  AS nVarchar(4000)
	DECLARE @TblFields  AS nVarchar(4000)
	DECLARE @sSql  AS  nVarChar(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS nVarChar(50)
	--Filter Variable
	DECLARE @CmpId          AS Int
	DECLARE @LcnId          AS Int
	DECLARE @CmpPrdCtgId  AS Int
	DECLARE @PrdCtgMainId  AS Int
	DECLARE @StockValue      AS Int
	DECLARE @PrdCatId  AS Int
	DECLARE @PrdBatId        AS Int
	DECLARE @CtgValue      AS Int
	DECLARE @PrdCatValId      AS Int
	DECLARE @DisplayLevel       AS Int
	DECLARE @PrdId        AS Int
	DECLARE @SupZeroStock	AS INT
	DECLARE @StockType	AS INT
	            
	--Till Here
	--Assgin Value for the Filter Variable
    SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	SET @StockType = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId))
    SET @CtgValue=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
    SET @PrdCatValId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
--    SET @PrdCatValId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
    SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @DisplayLevel = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,260,@Pi_UsrId))
	SET @SupZeroStock = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))
    --SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(221,260,2)
    EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
--    select @CtgValue,@PrdCatValId 
	CREATE TABLE #RPTCURRENTSTOCKAN
	(
		[CmpPrdCtgId]						INT,
		[Product Hierarchy Level Value]     NVARCHAR(200),
		[PrdCtgValMainId]					INT,
		[PrdCtgValCode]						NVARCHAR(300),
		[Description]						NVARCHAR(300),
		[PrdId]								INT,
		[Product Code]						NVARCHAR(200),
		[Product Name]						NVARCHAR(300),
		[LcnId]								INT,
		[Location Name]						NVARCHAR(300),
		[SystemStockType]					TINYINT,
		[Stock Type]						NVARCHAR(100),
		[Quantity Packs]					INT,
		[PrdUnitId]							INT,
		[Quantity In Volume(Unit)]			NUMERIC(18,2),
		[Quantity In Volume(KG)]            NUMERIC(18,2),
		[Quantity In Volume(Litre)]         NUMERIC(18,2),
		[Value]								NUMERIC(18,2)
	)
	SET @TblName = 'RPTCURRENTSTOCK'
	SET @TblStruct = '  [CmpPrdCtgId]						INT,
						[Product Hierarchy Level Value]     NVARCHAR(200),
						[PrdCtgValMainId]					INT,
						[PrdCtgValCode]						NVARCHAR(300),
						[Description]						NVARCHAR(300),
						[PrdId]								INT,
						[Product Code]						NVARCHAR(200),
						[Product Name]						NVARCHAR(300),
						[LcnId]								INT,
						[Location Name]						NVARCHAR(300),
						[SystemStockType]					TINYINT,
						[Stock Type]						NVARCHAR(100),
						[Quantity Packs]					INT,
						[PrdUnitId]							INT,
						[Quantity In Volume(Unit)]			NUMERIC(18,2),
						[Quantity In Volume(KG)]            NUMERIC(18,2),
						[Quantity In Volume(Litre)]         NUMERIC(18,2),
						[Value]								NUMERIC(18,2)'
	SET @TblFields = '[CmpPrdCtgId],[Product Hierarchy Level Value],[PrdCtgValMainId],[PrdCtgValCode],[Description],[PrdId],[Product Code],
					  [Product Name],[LcnId],[Location Name],[SystemStockType],[Stock Type],[Quantity Packs],[PrdUnitId],
					  [Quantity In Volume(Unit)],[Quantity In Volume(KG)],[Quantity In Volume(Litre)],[Value]'
IF @DisplayLevel=2
BEGIN
	INSERT INTO #RPTCURRENTSTOCKAN ([CmpPrdCtgId],[Product Hierarchy Level Value],[PrdCtgValMainId],[PrdCtgValCode],[Description],
									[LcnId],[Location Name],[SystemStockType],[Stock Type],[Quantity Packs],[PrdUnitId],
									[Quantity In Volume(Unit)],[Quantity In Volume(KG)],[Quantity In Volume(Litre)],[Value])
	SELECT DISTINCT G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
	/*F.PrdId,F.PrdCCode,F.PrdName,*/F.LcnId,F.LcnName,F.SystemStockType,F.UserStockType,sum(BaseQty),PrdUnitId,sum(PrdOnUnit),sum(PrdOnKg),
	sum(PrdOnLitre),sum(SumValue)
		FROM ProductCategoryValue C
		INNER JOIN(Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
				WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)  
				ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END) *5)  as PrdCtgValLinkCode,
				A.Prdid from Product A
		INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
			      (A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
			       A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		INNER JOIN 
	              (SELECT A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,0 AS BaseQty,
	               B.PrdUnitId,0 AS PrdOnUnit,0 AS PrdOnKg,0 AS PrdOnLitre,0 as SumValue
	               FROM ProductBatchLocation A 
		INNER JOIN Product B ON A.PrdId=B.PrdId 

		INNER JOIN Location C ON A.LcnId=C.LcnId
		INNER JOIN ProductBatch D ON A.PrdBatId=D.PrdBatId AND B.PrdId=D.PrdId
		INNER JOIN STOCKTYPE E ON C.LcnId=E.LcnId
		WHERE B.CmpId=@CmpId AND
		(A.LcnId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) WHEN 0 THEN C.LcnId Else 0 END) OR
		A.LcnId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))) AND 
		(E.SystemStockType = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)) WHEN 0 THEN E.SystemStockType Else 0 END) OR
		E.SystemStockType in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)))) F ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 	
		INNER JOIN 
		(SELECT A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,
		CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END AS BaseQty,
		B.PrdUnitId,0 AS PrdOnUnit,
		ISNULL(CASE B.PrdUnitId WHEN 2 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0)/1000
		WHEN 3 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0) END,0) AS PrdOnKg,
		ISNULL(CASE B.PrdUnitId WHEN 4 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0)/1000
		WHEN 5 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0) END,0) AS PrdOnLitre,
		(CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)* G.SellingRate as SumValue
		FROM ProductBatchLocation A 
		INNER JOIN Product B ON A.PrdId=B.PrdId  
		INNER JOIN Location C ON A.LcnId=C.LcnId
		INNER JOIN ProductBatch D ON A.PrdBatId=D.PrdBatId AND B.PrdId=D.PrdId
		INNER JOIN STOCKTYPE E ON C.LcnId=E.LcnId
		INNER JOIN DefaultPriceHistory G ON A.PrdId=G.PrdId AND G.CurrentDefault=1 AND A.PrdBatId=G.PrdbatId

		WHERE B.CmpId=@CmpId AND
		(A.LcnId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) WHEN 0 THEN C.LcnId Else 0 END) OR
		A.LcnId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))) AND 
		(E.SystemStockType = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)) WHEN 0 THEN E.SystemStockType Else 0 END) OR
		E.SystemStockType in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId))) GROUP BY 
		A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,B.PrdUnitId,B.PrdWgt,G.SellingRate) F ON D.PrdId=F.PrdId 
		INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
		WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
		ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
		AND ( F.PrdId = (CASE @PrdCatValId WHEN 0 THEN F.PrdId ELSE @PrdCatValId END) OR
		F.PrdId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))) AND
		(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
		G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	   GROUP BY G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
		/*F.PrdId,F.PrdCCode,F.PrdName,*/F.LcnId,F.LcnName,F.SystemStockType,F.UserStockType,PrdUnitId
END
ELSE
BEGIN
	INSERT INTO #RPTCURRENTSTOCKAN
	SELECT DISTINCT G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
	F.PrdId,F.PrdCCode,F.PrdName,F.LcnId,F.LcnName,F.SystemStockType,F.UserStockType,BaseQty,PrdUnitId,PrdOnUnit,PrdOnKg,
	PrdOnLitre,SumValue
		FROM ProductCategoryValue C
		INNER JOIN(Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
				WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)  
				ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END) *5)  as PrdCtgValLinkCode,
				A.Prdid from Product A
		INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
			      (A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
			      A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		INNER JOIN 
	              (SELECT A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,0 AS BaseQty,
	              B.PrdUnitId,0 AS PrdOnUnit,0 AS PrdOnKg,0 AS PrdOnLitre,0 as SumValue
	              FROM ProductBatchLocation A 
	    INNER JOIN Product B ON A.PrdId=B.PrdId 

		INNER JOIN Location C ON A.LcnId=C.LcnId
		INNER JOIN ProductBatch D ON A.PrdBatId=D.PrdBatId AND B.PrdId=D.PrdId
		INNER JOIN STOCKTYPE E ON C.LcnId=E.LcnId
		WHERE B.CmpId=@CmpId AND
		(A.LcnId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) WHEN 0 THEN C.LcnId Else 0 END) OR
		A.LcnId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))) AND 
		(E.SystemStockType = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)) WHEN 0 THEN E.SystemStockType Else 0 END) OR
		E.SystemStockType in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)))) F ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 	
		INNER JOIN 
		(SELECT A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,
		CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END AS BaseQty,
		B.PrdUnitId,0 AS PrdOnUnit,
		ISNULL(CASE B.PrdUnitId WHEN 2 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0)/1000
		WHEN 3 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0) END,0) AS PrdOnKg,
		ISNULL(CASE B.PrdUnitId WHEN 4 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0)/1000
		WHEN 5 THEN ISNULL((PrdWgt * (CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)),0) END,0) AS PrdOnLitre,
		(CASE E.SystemStockType WHEN 1 THEN SUM(PrdBatLcnSih) WHEN 2 THEN SUM(PrdBatLcnUih) WHEN 3 THEN SUM(PrdBatLcnFre) END)* G.SellingRate as SumValue
		FROM ProductBatchLocation A 
		INNER JOIN Product B ON A.PrdId=B.PrdId  
		INNER JOIN Location C ON A.LcnId=C.LcnId
		INNER JOIN ProductBatch D ON A.PrdBatId=D.PrdBatId AND B.PrdId=D.PrdId
		INNER JOIN STOCKTYPE E ON C.LcnId=E.LcnId
		INNER JOIN DefaultPriceHistory G ON A.PrdId=G.PrdId AND G.CurrentDefault=1 AND A.PrdBatId=G.PrdbatId

		WHERE B.CmpId=@CmpId AND
		(A.LcnId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)) WHEN 0 THEN C.LcnId Else 0 END) OR
		A.LcnId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))) AND 
		(E.SystemStockType = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId)) WHEN 0 THEN E.SystemStockType Else 0 END) OR
		E.SystemStockType in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId))) GROUP BY 
		A.PrdId,B.PrdCCode,B.PrdName,C.LcnId,C.LcnName,E.SystemStockType,E.UserStockType,B.PrdUnitId,B.PrdWgt,G.SellingRate) F ON D.PrdId=F.PrdId 
		INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
		WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
		ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
		AND ( F.PrdId = (CASE @PrdCatValId WHEN 0 THEN F.PrdId ELSE @PrdCatValId END) OR
		F.PrdId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))) AND
		(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
		G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))

END

--      Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId	
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RPTCURRENTSTOCKAN
--	 Till Here

IF @SupZeroStock=1
BEGIN 
	SELECT  * FROM #RPTCURRENTSTOCKAN WHERE [Quantity Packs]<>0 
END
ELSE
	SELECT * FROM #RPTCURRENTSTOCKAN 

END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptRtrPrdWiseSales' AND XTYPE='P')
DROP PROCEDURE Proc_RptRtrPrdWiseSales
GO
--EXEC Proc_RptRtrPrdWiseSales 220,1,0,'ASKO',0,0,1
CREATE PROCEDURE Proc_RptRtrPrdWiseSales
/************************************************************
* PROCEDURE	: Proc_RptRtrPrdWiseSales
* PURPOSE	: Retailer and Product Wise Sales Volume
* CREATED BY	: Boopathy.P
* CREATED DATE	: 14/03/2011
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT	
)
AS
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 		AS	INT
	DECLARE @DBNAME			AS 	nvarchar(50)
	DECLARE @TblName 		AS	nvarchar(500)
	DECLARE @TblStruct 		AS	nVarchar(4000)
	DECLARE @TblFields 		AS	nVarchar(4000)
	DECLARE @SSQL			AS 	VarChar(8000)
	DECLARE @ErrNo	 		AS	INT
	DECLARE @PurDBName		AS	nVarChar(50)
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @RMId			AS	INT
	DECLARE @SMId			AS	INT
	DECLARE @RtrId 			AS 	INT
	DECLARE @CmpId 			AS 	INT
	DECLARE @PrdCatLvlId 	AS 	INT
	DECLARE @PrdCatValId 	AS 	INT
	DECLARE @PrdId 			AS 	INT
	DECLARE @Display		AS 	INT

	CREATE  TABLE #RptRtrPrdWiseSales
		(
			RtrId				INT,
			RtrCode				NVARCHAR(100),
			RtrName				NVARCHAR(200),
			CmpPrdCtgId			INT,
			CmpPrdCtgName		NVARCHAR(200),
			PrdCtgValMainId		INT,
			PrdCtgValCode		NVARCHAR(100),
			PrdCtgValName		NVARCHAR(200),
			PrdId				INT,
			PrdCCode			NVARCHAR(100),
			PrdName				NVARCHAR(200),
			BaseQty				NUMERIC(18,0),
			PrdUnitId			INT,
			PrdOnUnit			NUMERIC(18,0),
			PrdOnKg				NUMERIC(18,6),
			PrdOnLitre			NUMERIC(18,6),
			PrdNetAmount		NUMERIC(18,6),
			DispMode			INT
		)


	SET @SMId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @RMId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @RtrId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @CmpId = (SELECT TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @PrdCatLvlId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCatValId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	SET @Display = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,260,@Pi_UsrId))

	IF @CmpId=0
	BEGIN
		SELECT @CmpId=CmpId FROM Company WHERE DefaultCompany=1
	END
	

	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)

	
	SET @TblName = 'RptRtrPrdWiseSales'
	
	SET @TblStruct ='		
			RtrId				INT,
			RtrCode				NVARCHAR(100),
			RtrName				NVARCHAR(200),
			CmpPrdCtgId			INT,
			CmpPrdCtgName		NVARCHAR(200),
			PrdCtgValMainId		INT,
			PrdCtgValCode		NVARCHAR(100),
			PrdCtgValName		NVARCHAR(200),
			PrdId				INT,
			PrdCCode			NVARCHAR(100),
			PrdName				NVARCHAR(200),
			PrdUnitId			INT,
			PrdOnUnit			NUMERIC(18,0),
			PrdOnKg				NUMERIC(18,6),
			PrdOnLitre			NUMERIC(18,6),
			PrdNetAmount		NUMERIC(18,6),
			DispMode			INT'					
	
	SET @TblFields = 'RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,
			PrdCtgValName,PrdId,PrdCCode,PrdName,PrdUnitId,PrdOnUnit,PrdOnKg,PrdOnLitre,PrdNetAmount,DispMode'
			
	IF @Display=2
	BEGIN
		IF (@PrdCatLvlId=0 AND @PrdCatValId=0 AND @PrdId=0) OR 
			(@PrdCatLvlId>0 AND @PrdCatValId=0 AND @PrdId=0) OR
			(@PrdCatLvlId>0 AND @PrdCatValId>0 AND @PrdId=0)
		BEGIN
			INSERT INTO #RptRtrPrdWiseSales (RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,
					PrdCtgValName,PrdId,PrdCCode,PrdName,PrdUnitId,PrdOnUnit,PrdOnKg,PrdOnLitre,PrdNetAmount,DispMode)
			SELECT RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
				   0,'','',PrdUnitId,SUM(PrdOnUnit),SUM(PrdOnKg),SUM(PrdOnLitre),SUM(PrdNetAmount),@Display FROM 
				(
				SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
				G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
				F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,F.PrdOnUnit,F.PrdOnKg,F.PrdOnLitre,F.PrdNetAmount 
					FROM ProductCategoryValue C
					INNER JOIN 
						( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
							WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)  
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
							A.Prdid from Product A
					INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
						(A.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN A.PrdId Else 0 END) OR
						 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
					INNER JOIN 
							(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
								FROM salesInvoice A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE @CmpId END) OR
									D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
								(D.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN D.PrdId Else 0 END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
							ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
					INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
								FROM salesInvoice A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE @CmpId END) OR
									D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
								(D.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN D.PrdId Else 0 END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
								ON D.PrdId=F.PrdId 
					INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
					WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
					ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
					AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
					C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
					(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
					G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
				UNION
				SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
				G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
				F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,-1*F.PrdOnUnit,-1*F.PrdOnKg,-1*F.PrdOnLitre,-1*F.PrdNetAmount 
					FROM ProductCategoryValue C
					INNER JOIN 
						( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
							WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)  
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
							A.Prdid from Product A
					INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
						(A.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN A.PrdId Else 0 END) OR
						 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
					INNER JOIN 
							(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
								FROM ReturnHeader A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN D.PrdId Else 0 END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
							ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
					INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
								FROM ReturnHeader A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.PrdId = (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)) WHEN 0 THEN D.PrdId Else 0 END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
								ON D.PrdId=F.PrdId 
					INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
					WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)
					ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
					AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
					C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
					(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
					G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))) A
					GROUP BY RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
				    PrdUnitId
		END
		ELSE --IF (@PrdCatLvlId>0 AND @PrdCatValId>0)
		BEGIN
			INSERT INTO #RptRtrPrdWiseSales (RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,
					PrdCtgValName,PrdId,PrdCCode,PrdName,PrdUnitId,PrdOnUnit,PrdOnKg,PrdOnLitre,PrdNetAmount,DispMode)
			SELECT RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
				   PrdId,PrdCCode,Prdname,PrdUnitId,SUM(PrdOnUnit),SUM(PrdOnKg),SUM(PrdOnLitre),SUM(PrdNetAmount),1 FROM 
				(
				SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
				G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
				F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,F.PrdOnUnit,F.PrdOnKg,F.PrdOnLitre,F.PrdNetAmount 
					FROM ProductCategoryValue C
					INNER JOIN 
						( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
							WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
							A.Prdid from Product A
					INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
						(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
						 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
					INNER JOIN 
							(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
								FROM salesInvoice A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE @CmpId END) OR
									D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
								(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
							ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
					INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
								FROM salesInvoice A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE 0 END) OR
									D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
								(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
								ON D.PrdId=F.PrdId 
					INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
					WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
					ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
					AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
					C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
					(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
					G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
				UNION
				SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
				G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
				F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,-1*F.PrdOnUnit,-1*F.PrdOnKg,-1*F.PrdOnLitre,-1*F.PrdNetAmount 
					FROM ProductCategoryValue C
					INNER JOIN 
						( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
							WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)  
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
							A.Prdid from Product A
					INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
						(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
						 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
					INNER JOIN 
							(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
								FROM ReturnHeader A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
							ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
					INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
								C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
								ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
								ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
								WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
								FROM ReturnHeader A 
								INNER JOIN Retailer B ON A.RtrId=B.RtrId
								INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
								INNER JOIN Product D ON D.PrdId=C.PrdId
								WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
								(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
								A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								AND
								(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
								A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
								AND
								(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
								A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
								(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
									D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
								GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
								ON D.PrdId=F.PrdId 
					INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
					WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
					ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
					AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
					C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
					(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
					G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) ) A
					GROUP BY RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
				    PrdId,PrdCCode,Prdname,PrdUnitId
		END
	END
	ELSE
	BEGIN
		INSERT INTO #RptRtrPrdWiseSales (RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,
				PrdCtgValName,PrdId,PrdCCode,PrdName,PrdUnitId,PrdOnUnit,PrdOnKg,PrdOnLitre,PrdNetAmount,DispMode)
		SELECT RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
			   PrdId,PrdCCode,Prdname,PrdUnitId,SUM(PrdOnUnit),SUM(PrdOnKg),SUM(PrdOnLitre),SUM(PrdNetAmount),@Display FROM 
			(
			SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
			G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
			F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,F.PrdOnUnit,F.PrdOnKg,F.PrdOnLitre,F.PrdNetAmount 
				FROM ProductCategoryValue C
				INNER JOIN 
					( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
						WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
						A.Prdid from Product A
				INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
					(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
					 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
				INNER JOIN 
						(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
							C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
							ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
							ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
							FROM salesInvoice A 
							INNER JOIN Retailer B ON A.RtrId=B.RtrId
							INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
							INNER JOIN Product D ON D.PrdId=C.PrdId
							WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
							(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
							A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
							AND
							(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
							A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
							AND
							(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
							A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
							(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE @CmpId END) OR
								D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
							(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
								D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
						ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
				INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
							C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
							ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
							ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmount) AS PrdNetAmount
							FROM salesInvoice A 
							INNER JOIN Retailer B ON A.RtrId=B.RtrId
							INNER JOIN SalesInvoiceProduct C ON A.SalId=C.SalId
							INNER JOIN Product D ON D.PrdId=C.PrdId
							WHERE A.SalInvDate BETWEEN @FromDate AND @ToDate AND A.DlvSts>3 AND
							(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
							A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
							AND
							(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
							A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
							AND
							(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
							A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
							(D.CmpId = (CASE @CmpId WHEN 0 THEN D.CmpId ELSE @CmpId END) OR
								D.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
							(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
								D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
							ON D.PrdId=F.PrdId 
				INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
				WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
				ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
				AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
				C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
				(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
				G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
			UNION
			SELECT DISTINCT F.RtrId,F.RtrCode,F.RtrName,
			G.CmpPrdCtgId,G.CmpPrdCtgName,C.PrdCtgValMainId,C.PrdCtgValCode,C.PrdCtgValName,
			F.PrdId,F.PrdCCode,F.Prdname,F.PrdUnitId,-1*F.PrdOnUnit,-1*F.PrdOnKg,-1*F.PrdOnLitre,-1*F.PrdNetAmount 
				FROM ProductCategoryValue C
				INNER JOIN 
					( Select DISTINCT LEFT(PrdCtgValLinkCode,(CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) 
						WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId) 
							ELSE (SELECT SUBSTRING (LEVELNAME,6,LEN(LEVELNAME)) FROM ProductCategoryLevel 
							WHERE CmpPrdCtgId IN  (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))) END) *5)  as PrdCtgValLinkCode,
						A.Prdid from Product A
				INNER JOIN ProductCategoryValue B On A.PrdCtgValMainId = B.PrdCtgValMainId AND 				
					(A.PrdId = (CASE @PrdId WHEN 0 THEN A.PrdId Else @PrdId END) OR
					 A.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
				INNER JOIN 
						(SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
							C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
							ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
							ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
							FROM ReturnHeader A 
							INNER JOIN Retailer B ON A.RtrId=B.RtrId
							INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
							INNER JOIN Product D ON D.PrdId=C.PrdId
							WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
							(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
							A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
							AND
							(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
							A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
							AND
							(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
							A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
							(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
								D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId)F 
						ON A.PrdId = F.PrdId) AS D ON D.PrdCtgValLinkCode = C.PrdCtgValLinkCode 
				INNER JOIN (SELECT DISTINCT B.RtrId,B.RtrCode,B.RtrName,
							C.PrdId,D.PrdCCode,D.Prdname,D.PrdUnitId,SUM(C.BaseQty) AS PrdOnUnit,
							ISNULL(CASE D.PrdUnitId WHEN 2 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 3 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnKg,
							ISNULL(CASE D.PrdUnitId WHEN 4 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0)/1000
							WHEN 5 THEN ISNULL(SUM(PrdWgt * C.BaseQty),0) END,0) AS PrdOnLitre,SUM(C.PrdNetAmt) AS PrdNetAmount
							FROM ReturnHeader A 
							INNER JOIN Retailer B ON A.RtrId=B.RtrId
							INNER JOIN ReturnProduct C ON A.ReturnId=C.ReturnId
							INNER JOIN Product D ON D.PrdId=C.PrdId
							WHERE A.ReturnDate BETWEEN @FromDate AND @ToDate AND A.Status=0 AND
							(A.SMId = (CASE @SMId WHEN 0 THEN A.SMId ELSE 0 END) OR
							A.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
							AND
							(A.RMId = (CASE @RMId WHEN 0 THEN A.RMId ELSE 0 END) OR
							A.RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))
							AND
							(A.RtrId = (CASE @RtrId WHEN 0 THEN A.RtrId ELSE 0 END) OR
							A.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
							(D.PrdId = (CASE @PrdId WHEN 0 THEN D.PrdId Else @PrdId END) OR
								D.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
							GROUP BY B.RtrId,B.RtrCode,B.RtrName,D.PrdCCode,D.Prdname,C.PrdId,D.PrdUnitId) F 
							ON D.PrdId=F.PrdId 
				INNER JOIN ProductCategoryLevel G ON G.CmpPrdCtgId= (CASE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
				WHEN 0 THEN (SELECT Max(CmpPrdCtgId)-1 FROM ProductCategoryLevel WHERE CmpId=@CmpId)
				ELSE (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)) END)
				AND ( C.PrdCtgValMainId= CASE @PrdCatValId WHEN 0 THEN C.PrdCtgValMainId ELSE @PrdCatValId END OR					
				C.PrdCtgValMainId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))) AND
				(G.CmpId = (CASE @CmpId WHEN 0 THEN G.CmpId ELSE @CmpId END) OR
				G.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) ) A
				GROUP BY RtrId,RtrCode,RtrName,CmpPrdCtgId,CmpPrdCtgName,PrdCtgValMainId,PrdCtgValCode,PrdCtgValName,
			    PrdId,PrdCCode,Prdname,PrdUnitId
	END
	UPDATE #RptRtrPrdWiseSales SET BaseQty=PrdOnUnit
	UPDATE #RptRtrPrdWiseSales SET PrdOnUnit=0 WHERE PrdUnitId>1
	DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptRtrPrdWiseSales
	
	IF @Display = 1
	BEGIN
	   UPDATE RptExcelHeaders SET DisplayFlag = 1 WHERE RptId = @Pi_UsrId
	   DELETE FROM RptRtrPrdWiseSales_Excel
	   INSERT INTO RptRtrPrdWiseSales_Excel
	   SELECT RtrCode,RtrName,CmpPrdCtgName,PrdCtgValName,PrdCCode,Prdname,BaseQty,
	   PrdOnUnit+PrdOnKg+PrdOnLitre,PrdNetAmount FROM #RptRtrPrdWiseSales
	END
	ELSE IF @Display = 2
	BEGIN
	   UPDATE RptExcelHeaders SET DisplayFlag = 0 WHERE SlNo IN (5,6) AND RptId = @Pi_UsrId
	   DELETE FROM RptRtrPrdWiseSales_Excel
	   INSERT INTO RptRtrPrdWiseSales_Excel
	   SELECT RtrCode,RtrName,CmpPrdCtgName,PrdCtgValName,'','',SUM(BaseQty) AS BaseQty,
	   SUM(PrdOnUnit)+SUM(PrdOnKg)+SUM(PrdOnLitre),SUM(PrdNetAmount) FROM #RptRtrPrdWiseSales 
	   GROUP BY RtrCode,RtrName,CmpPrdCtgName,PrdCtgValName  
	END
	SELECT * FROM #RptRtrPrdWiseSales 
RETURN
END
GO
--Till here
--PM_ReportProcedures
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_LoadingUOMBased' AND XTYPE='P')
DROP PROCEDURE Proc_LoadingUOMBased
GO
--Exec Proc_LoadingUOMBased 
CREATE PROCEDURE Proc_LoadingUOMBased
AS
BEGIN
	DECLARE @Prdid AS INT
	DECLARE @PrdCode AS Varchar(50)
	DECLARE @PrdBatchCode AS Varchar(50)
	DECLARE @SalId AS INT
	DECLARE @BaseQty AS INT
	DECLARE @FUOMID AS INT
	DECLARE @FCONVERSIONFACTOR AS INT
	DECLARE @StockOnHand AS INT
	DECLARE @Converted AS INT
	DECLARE @Remainder AS INT
	DECLARE @COLUOM AS VARCHAR(50)
	DECLARE @Sql AS VARCHAR(5000)
	DECLARE @SlNo AS INT
	
	DECLARE CUR_UOMQTY CURSOR
	FOR
		SELECT P.PrdId,[Product Code],[Batch Number],SUM([Billed Qty]) AS [Billed Qty] from RptLoadSheetItemWisePM Rpt WITH (NOLOCK)
		INNER JOIN Product P WITH (NOLOCK) ON  Rpt.PrdId=P.PrdId GROUP BY P.PrdId,[Product Code],[Batch Number]
		
	OPEN CUR_UOMQTY
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	WHILE @@FETCH_STATUS=0
	BEGIN
			SET	@Converted=0
			SET @Remainder=0	
			DECLARE CUR_UOMGROUP CURSOR
			FOR 
			SELECT UOMID,CONVERSIONFACTOR FROM (
			SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID WHERE PRDID=@Prdid 
				AND PrdId NOT IN (SELECT prdid FROM UomProductSkip WITH (NOLOCK))	 
			 UNION
			 	SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID INNER JOIN UOMPRODUCTSKIP WITH (NOLOCK)
				ON UOMPRODUCTSKIP.PRDID=PRODUCT.PRDID WHERE PRODUCT.PRDID=@Prdid 
				and UOMGROUP.UomId NOT IN (SELECT UOMID FROM UomProductSkip WHERE PrdId=@Prdid))A
				ORDER BY CONVERSIONFACTOR DESC
			OPEN CUR_UOMGROUP
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			WHILE @@FETCH_STATUS=0
			BEGIN
			--SELECT * FROM BillTemplateUomBased WITH (NOLOCK) WHERE UOMID=@FUOMID
					SELECT @COLUOM=UOMCODE FROM UomMaster WITH (NOLOCK) WHERE UOMID=@FUOMID
					IF @BaseQty>= @FCONVERSIONFACTOR
					BEGIN
						SET	@Converted=CAST(@BaseQty/@FCONVERSIONFACTOR as INT)
						SET @Remainder=CAST(@BaseQty%@FCONVERSIONFACTOR AS INT)
						SET @BaseQty=@Remainder	
						--Print @Converted
						--Print @Remainder		
						SET @Sql='UPDATE RptLoadSheetItemWisePM  SET [' + @COLUOM +']='+ Cast(Isnull(@Converted,0) as Varchar(25)) +' WHERE [Product Code]='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END	
					ELSE
					BEGIN
						SET @Sql='UPDATE RptLoadSheetItemWisePM SET [' + @COLUOM +']='+ Cast(0 as Varchar(10)) +' WHERE [Product Code] ='+''''+@PrdCode+''''+' and [Batch Number]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END
										
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			END	
			CLOSE CUR_UOMGROUP
			DEALLOCATE CUR_UOMGROUP
			SET @BaseQty=0
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	END	
	CLOSE CUR_UOMQTY
	DEALLOCATE CUR_UOMQTY
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptLoadSheetItemWisePM_Excel' AND XTYPE='U')
DROP TABLE RptLoadSheetItemWisePM_Excel
GO
CREATE TABLE RptLoadSheetItemWisePM_Excel(
	[PrdId] [int] NULL,
	[Product Code] [nvarchar](100) NULL,
	[Product Description] [nvarchar](150) NULL,
	[Batch Number] [nvarchar](50) NULL,
	[MRP] [nvarchar](20) NULL,
	[Selling Rate] [nvarchar](20) NULL,
	[SP] [int] NULL,
	[Kg] [int] NULL,
	[Hg] [int] NULL,
	[St] [int] NULL,
	[EA] [int] NULL,
	[TotalKg] [numeric](38, 2) NULL,
	[Billed Qty] [numeric](38, 0) NULL,
	[Total Qty] [numeric](38, 0) NULL,
	[Return Qty] [numeric](38, 0) NULL,
	[Replacement Qty] [numeric](38, 0) NULL,
	[GrossAmount] [numeric](38, 2) NULL,
	[TaxAmount] [numeric](38, 2) NULL,
	[NetAmount] [numeric](38, 2) NULL,
	[TotalBills] [nvarchar](20) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptLoadSheetItemWisePM' AND XTYPE='U')
DROP TABLE RptLoadSheetItemWisePM
GO
CREATE TABLE RptLoadSheetItemWisePM(
	[SalId] [int] NULL,
	[PrdId] [int] NULL,
	[Product Code] [nvarchar](100) NULL,
	[Product Description] [nvarchar](150) NULL,
	[Batch Number] [nvarchar](50) NULL,
	[MRP] [numeric](38, 2) NULL,
	[Selling Rate] [numeric](38, 6) NULL,
	[Billed Qty] [numeric](38, 0) NULL,
	[Free Qty] [numeric](38, 0) NULL,
	[Return Qty] [numeric](38, 0) NULL,
	[Replacement Qty] [numeric](38, 0) NULL,
	[Total Qty] [numeric](38, 0) NULL,
	[PrdWeight] [numeric](38, 4) NULL,
	[GrossAmount] [numeric](38, 2) NULL,
	[TaxAmount] [numeric](38, 2) NULL,
	[NetAmount] [numeric](38, 2) NULL,
	[TotalBills] [numeric](38, 0) NULL,
	[EA] [int] NULL,
	[Kg] [int] NULL,
	[Hg] [int] NULL,
	[St] [int] NULL,
	[SP] [int] NULL,
	[TotalKg] [numeric](18, 2) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptLoadSheetItemWisePM' AND XTYPE='P')
DROP PROCEDURE Proc_RptLoadSheetItemWisePM
GO
--Exec Proc_RptLoadSheetItemWisePM 247,2,0,'',0,0,1
CREATE PROCEDURE Proc_RptLoadSheetItemWisePM
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************
* CREATED BY	: Gunasekaran
* CREATED DATE	: 18/07/2007
* NOTE		:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	--Filter Variable
	DECLARE @FromDate	   AS	DATETIME
	DECLARE @ToDate	 	   AS	DATETIME
	DECLARE @VehicleId     AS  INT
	DECLARE @VehicleAllocId AS	INT
	DECLARE @SMId	 	AS	INT
	DECLARE @DlvRouteId	AS	INT
	DECLARE @RtrId	 	AS	INT
	DECLARE @UOMId	 	AS	INT
	DECLARE @FromBillNo AS  BIGINT
	DECLARE @ToBillNo   AS  BIGINT
	--Till Here
	
	EXEC Proc_RptItemWise @Pi_RptId ,@Pi_UsrId
	
	--Assgin Value for the Filter Variable
	SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))
	SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))
	SET @VehicleId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId))
	SET @VehicleAllocId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId))
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @DlvRouteId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))
	SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	SET @UOMId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,129,@Pi_UsrId))
	SET @FromBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))
	SET @ToBillNo =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,15,@Pi_UsrId))
	
	Delete From RptLoadSheetItemWisePM
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
IF @Pi_GetFromSnap = 1
	BEGIN
	Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
	SET @DBNAME =  @DBNAME
	END
	ELSE
	BEGIN
	Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
	SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		IF @FromBillNo <> 0 AND @ToBillNo <> 0
		BEGIN
			
			INSERT INTO RptLoadSheetItemWisePM (PrdId,[Product Code],[Product Description],[Batch Number],[MRP],[Selling Rate],
			Kg,Hg,St,EA,SP,TotalKg,[Billed Qty],[Total Qty],[Return Qty],[Replacement Qty],[GrossAmount],[TaxAmount],[NetAmount])
	
			SELECT PrdId,PrdDCode,PrdNAme,PrdBatCode,[MRP],SellingRate,0,0,0,0,0,0,(SUM(BillQty) + SUM(FreeQty)) As BillQty,SUM(TotalQty) AS TotalQty,
            SUM(ReturnQty) AS ReturnQty,SUM(RepalcementQty) AS ReplacementQty,SUM(GrossAmount) AS GrossAmount,
            SUM(TaxAmount) AS TaxAmount,dbo.Fn_ConvertCurrency(SUM([NetAmount]),1) AS NetAmount
            FROM RtrLoadSheetItemWise
	  WHERE
	RptId = @Pi_RptId and UsrId = @Pi_UsrId and
	(VehicleId = (CASE @VehicleId WHEN 0 THEN VehicleId ELSE 0 END) OR
					VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )
	
	 AND (Allotmentnumber = (CASE @VehicleAllocId WHEN 0 THEN Allotmentnumber ELSE 0 END) OR
					Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
	
	 AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR
					SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
	
	 AND (DlvRMId=(CASE @DlvRouteId WHEN 0 THEN DlvRMId ELSE 0 END) OR
					DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
	
	 AND (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR
					RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )
					
	 AND [SalInvDate] Between @FromDate and @ToDate
			 AND (SalId Between @FromBillNo and @ToBillNo)
     GROUP BY PrdId,PrdDCode,PrdNAme,PrdBatCode,[MRP],SellingRate
		END 
		ELSE
		BEGIN
            INSERT INTO RptLoadSheetItemWisePM (PrdId,[Product Code],[Product Description],[Batch Number],[MRP],[Selling Rate],
			Kg,Hg,St,EA,SP,TotalKg,[Billed Qty],[Total Qty],[Return Qty],[Replacement Qty],[GrossAmount],[TaxAmount],[NetAmount] )
			
			SELECT PrdId,PrdDCode,PrdNAme,PrdBatCode,[MRP],SellingRate,0,0,0,0,0,0,(SUM(BillQty) + SUM(FreeQty)) As BillQty,SUM(TotalQty) AS TotalQty,
            SUM(ReturnQty) AS ReturnQty,SUM(RepalcementQty) AS ReplacementQty,SUM(GrossAmount) AS GrossAmount,
            SUM(TaxAmount) AS TaxAmount,dbo.Fn_ConvertCurrency(SUM([NetAmount]),1) AS NetAmount
            FROM RtrLoadSheetItemWise
			WHERE
			RptId = @Pi_RptId and UsrId = @Pi_UsrId and
			(VehicleId = (CASE @VehicleId WHEN 0 THEN VehicleId ELSE 0 END) OR
							VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )
			
			 AND (Allotmentnumber = (CASE @VehicleAllocId WHEN 0 THEN Allotmentnumber ELSE 0 END) OR
							Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
			
			 AND (SMId=(CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR
							SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
			
			 AND (DlvRMId=(CASE @DlvRouteId WHEN 0 THEN DlvRMId ELSE 0 END) OR
							DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
			
			 AND (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR
							RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)) )
							
			 AND [SalInvDate] Between @FromDate and @ToDate
        GROUP BY PrdId,PrdDCode,PrdNAme,PrdBatCode,[MRP],SellingRate
		END 
	
    UPDATE RptLoadSheetItemWisePM SET TotalBills=(SELECT Count(DISTINCT SalId) FROM RtrLoadSheetItemWise)
	/*
		
		For ProductCategory Value and Product Filter
	
		R.PrdId = (CASE @fPrdCatPrdId WHEN 0 THEN R.PrdId Else 0 END) OR
		R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
		AND R.PrdId = (CASE @fPrdId WHEN 0 THEN R.PrdId Else 0 END) OR
		R.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	*/
		
	IF LEN(@PurDBName) > 0
	BEGIN
		
		EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
		
		SET @SSQL = 'INSERT INTO #RptLoadSheetItemWisePM ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			/*
				Add the Filter Clause for the Reprot
			*/
	 + '         WHERE
	 RptId = ' + @Pi_RptId + ' and UsrId = ' + @Pi_UsrId + ' and
	  (VehicleId = (CASE ' + @VehicleId + ' WHEN 0 THEN VehicleId ELSE 0 END) OR
					VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + @Pi_RptId + ',36,' + @Pi_UsrId + ')) )
	
	 AND (Allotmentnumber = (CASE ' + @VehicleAllocId + ' WHEN 0 THEN Allotmentnumber ELSE 0 END) OR
					Allotmentnumber in (SELECT iCountid FROM Fn_ReturnRptFilters(' + @Pi_RptId + ',37,' + @Pi_UsrId + ')) )
	
	 AND (SMId=(CASE ' + @SMId + ' WHEN 0 THEN SMId ELSE 0 END) OR
					SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + @Pi_RptId + ',1,' + @Pi_UsrId + ')))
	
	 AND (DlvRMId=(CASE ' + @DlvRouteId + ' WHEN 0 THEN DlvRMId ELSE 0 END) OR
					DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + @Pi_RptId + ',35,' + @Pi_UsrId + ')) )
	
	 AND (RtrId = (CASE ' + @RtrId + ' WHEN 0 THEN RtrId ELSE 0 END) OR
					RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + @Pi_RptId + ',3,' + @Pi_UsrId + ')))
					
	 AND [SalInvDate] Between ' + @FromDate + ' and ' + @ToDate
	
		EXEC (@SSQL)
		PRINT 'Retrived Data From Purged Table'
	END
	
	IF @Pi_SnapRequired = 1
	   BEGIN
		SELECT @NewSnapId = @Pi_SnapId
	
		EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		IF @ErrNo = 0
		   BEGIN
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptLoadSheetItemWisePM'
	
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		   END
	   END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		
	EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
	PRINT @ErrNo
	IF @ErrNo = 0
	   BEGIN
		SET @SSQL = 'INSERT INTO #RptLoadSheetItemWisePM ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
	
	
		EXEC (@SSQL)
		PRINT 'Retrived Data From Snap Shot Table'
	   END
	ELSE
	   BEGIN
		PRINT 'DataBase or Table not Found'
	   END
	END
		EXEC Proc_LoadingUOMBased
	 UPDATE A SET A.TotalKg = Z.ToatalKg FROM RptLoadSheetItemWisePM A INNER JOIN (
	 SELECT R.PrdId,R.[Batch Number],(SUM(R.[Total Qty])*PrdWgt)/1000 AS ToatalKg 
	 FROM  RptLoadSheetItemWisePM R 
	 INNER JOIN PRODUCT P on R.PrdId=P.PrdId GROUP BY R.PrdId,R.[Batch Number],PrdWgt) Z ON A.PrdId = Z.PrdId AND A.[Batch Number] = Z.[Batch Number] 
--	 UPDATE R set TotalKg=(cast([Total Qty] as numeric(18,2)))/(cast( ConversionFactor as numeric(18,2))) from  RptLoadSheetItemWisePM R 
--	 INNER JOIN product P on R.PrdId=P.prdid 
--	 INNER JOIN uomgroup UG on UG.UomGroupId=P.UomGroupId
--	 where uomid=2
 		
	--Check for Report Data
			Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptLoadSheetItemWisePM
			SELECT [PrdId],[Product Code],[Product Description],[Batch Number],CAST(MRP AS Numeric(36,2)) AS MRP,[Selling Rate],SP,Kg,Hg,St,EA,sum(TotalKg) AS TotalKg,
			SUM([Billed Qty]) AS [Billed Qty],SUM([Total Qty]) As [Total Qty],SUM([Return Qty]) AS [Return Qty],SUM([Replacement Qty]) As [Replacement Qty],
		    SUM([GrossAmount]) AS [GrossAmount],SUM([TaxAmount]) AS [TaxAmount],SUM([NetAmount]) AS [NetAmount],[TotalBills] ,ISNULL(SUM([Free Qty]),0)[Free Qty]
			FROM RptLoadSheetItemWisePM  GROUP BY [PrdId],[Product Code],[Product Description],[Batch Number],MRP,[Selling Rate],[TotalBills],EA,Kg,Hg,St,SP 
			Order By [PrdId]		
-------Export Excel
            /*Commented and added by B.Suganya ON 28.09.2012 PURPOSE:MRP should display with Decimal values in ExportToExcel file*/
            --CAST(MRP AS Numeric(36,2)) AS MRP
		IF EXISTS (SELECT [Name] FROM SysObjects WHERE [Name]='RptLoadSheetItemWisePM_Excel' And XTYPE='U')
		DROP TABLE RptLoadSheetItemWisePM_Excel
            SELECT [PrdId],[Product Code],[Product Description],[Batch Number],MRP,[Selling Rate],SP,Kg,Hg,St,EA,TotalKg,[Billed Qty],[Total Qty],[Return Qty],
            [Replacement Qty],[GrossAmount],[TaxAmount],[NetAmount],[TotalBills] INTO RptLoadSheetItemWisePM_Excel FROM (
            SELECT [PrdId],[Product Code],[Product Description],[Batch Number],
            CAST(MRP AS NVARCHAR(20)) AS MRP,CAST([Selling Rate] AS NVARCHAR(20)) AS [Selling Rate],SP,Kg,Hg,St,EA,SUM(TotalKg) AS TotalKg,
			SUM([Billed Qty]) AS [Billed Qty],SUM([Total Qty]) As [Total Qty],SUM([Return Qty]) AS [Return Qty],SUM([Replacement Qty]) As [Replacement Qty],
		    SUM([GrossAmount]) AS [GrossAmount],SUM([TaxAmount]) AS [TaxAmount],SUM([NetAmount]) AS [NetAmount],CAST([TotalBills] AS NVARCHAR(20)) AS [TotalBills] 
			FROM RptLoadSheetItemWisePM  GROUP BY [PrdId],[Product Code],[Product Description],[Batch Number],MRP,[Selling Rate],[TotalBills],EA,Kg,Hg,St,SP
            UNION ALL
            SELECT 99999,'','TOTAL','','','',SUM(SP) AS SP,SUM(Kg) AS Kg,SUM(Hg) AS Hg,SUM(St)AS St,SUM(EA) AS EA,SUM(TotalKg) AS TotalKg,
            SUM([Billed Qty]) AS [Billed Qty],SUM([Total Qty]) As [Total Qty],SUM([Return Qty]) AS [Return Qty],SUM([Replacement Qty]) As [Replacement Qty],
		    SUM([GrossAmount]) AS [GrossAmount],SUM([TaxAmount]) AS [TaxAmount],SUM([NetAmount]) AS [NetAmount],'' AS [TotalBills] FROM RptLoadSheetItemWisePM )A
            ORDER BY [PrdId]            
		   --Till Here		
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptSalesmanProductivityReport' AND XTYPE='P')
DROP PROCEDURE Proc_RptSalesmanProductivityReport
GO
--EXEC Proc_RptSalesmanProductivityReport 235,1,0,'HamDard',0,0,1
CREATE PROCEDURE Proc_RptSalesmanProductivityReport
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS 
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId 	AS	INT
	DECLARE @ErrNo	 	AS	INT
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @SMId 		AS	INT
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
SELECT [SMID],[Salesman Name],[Total Net Sales],[Total Invoice Count],[Total Net Sales]/[Total Invoice Count] AS [Average Bills Value],
	[Days Worked],[TLS],[TLS]/[Total Invoice Count] AS [TLS Per Bill],[Total Invoice Count]/[Days Worked] AS [Productivity Per Day],
	0 AS [Total Scheduled calls],0 AS [Total Productive Calls],0 AS [% of Productive Calls]
	INTO #SalesmanProductivity 
	FROM
		(
				SELECT [SMID],[Salesman Name],SUM([Net Sales]) [Total Net Sales],SUM([Total Invoice Count]) [Total Invoice Count],
				SUM([Average Bills Value]) [Average Bills Value],SUM([Days Worked]) [Days Worked],
				SUM([TLS]) [TLS],SUM([TLS Per Bill]) [TLS Per Bill],SUM([Productivity Per Day]) [Productivity Per Day]
				FROM 
					(
						SELECT SM.SMID,Sm.SmName [Salesman Name],Sum(PrdNetAmount) [Net Sales],Count(DISTINCT SI.SalId) [Total Invoice Count],0 [Average Bills Value]
						,Count(DISTINCT SalInvDate) [Days Worked],Count(SIP.PrdId) [TLS],0 [TLS Per Bill],0 [Productivity Per Day]
						FROM SalesInvoice SI INNER JOIN SalesMan Sm ON Sm.SMId = SI.SMId
						INNER JOIN SalesInvoiceProduct SIP ON SIP.Salid=SI.SalId
						WHERE (SI.SMId=(CASE @SMId WHEN 0 THEN SI.SMId ELSE 0 END) OR
							  SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
							  AND	SI.DlvSts<>3 AND SI.SalInvDate BETWEEN @FromDate AND @ToDate 
							  GROUP BY Sm.SmName,SM.SMID
					UNION ALL
						SELECT SM.SMID,Sm.SmName [Salesman Name],-1*Sum(PrdNetAmt) [Ret Net sales],0 [Total Invoice Count],0 [Average Bills Value]
						,0  [Days Worked],0 [TLS],0 [TLS Per Bill],0 [Productivity Per Day]
						FROM ReturnHeader RI INNER JOIN SalesMan Sm ON Sm.SMId = RI.SMId
						INNER JOIN ReturnProduct RP ON RI.ReturnID=RP.ReturnID
							WHERE (RI.SMId=(CASE @SMId WHEN 0 THEN RI.SMId ELSE 0 END) OR
								   RI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
								   AND RI.ReturnDate BETWEEN  @FromDate AND @ToDate AND RI.Status=0 
								   GROUP BY Sm.SmName,SM.SMID
					) X
				GROUP BY [SMID],[Salesman Name]
		)Z
---------------------Scheduled calls------------------------------
SELECT A.SMID,A.RMID,MAX(RCPMASTERID) RCPMASTERID  
INTO #STEP1 
FROM ROUTECOVPLANMASTER A,SALESMAN B,ROUTEMASTER C  
WHERE A.SMID=B.SMID AND A.RMID=C.RMID 
GROUP BY A.SMID,A.RMID  
SELECT SMID,RMID,RCPGENERATEDDATES 
INTO #STEP2 
FROM ROUTECOVPLANDETAILS B,#STEP1 A  
WHERE A.RCPMASTERID=B.RCPMASTERID  
SELECT B.RMID,COUNT(DISTINCT B.RTRID) AS SCHEDULEDCALLS INTO #STEP3 FROM RETAILER A WITH (NOLOCK)   
INNER JOIN RETAILERMARKET B WITH (NOLOCK) ON  A.RTRID=B.RTRID   
AND A.RTRSTATUS=1 GROUP BY B.RMID   
SELECT SMID,B.RMID,RCPGENERATEDDATES,SCHEDULEDCALLS INTO #STEP4 FROM #STEP3 A,#STEP2 B WHERE  A.RMID=B.RMID  
SELECT A.SMID,SMNAME,SUM(SCHEDULEDCALLS) SCHEDULEDCALLS INTO #PCALLS FROM #STEP4 A,SALESMAN B,ROUTEMASTER C   
WHERE A.SMID=B.SMID AND A.RMID=C.RMID AND RCPGENERATEDDATES BETWEEN @FromDate AND @ToDate
GROUP BY A.SMID,SMNAME
-------------------------Productive Calls----------------------------
SELECT SMID,SUM(PrdCalls) as PrdCalls INTO #ProductiveCalls
FROM
(
	SELECT SMID,ISNULL(COUNT(Distinct RTRID),0) as PrdCalls 
	FROM SalesInvoice Si 
	WHERE Salinvdate BETWEEN @FromDate AND @ToDate and Dlvsts<>3
	GROUP BY SMID,Salinvdate
)X
GROUP BY SMID
UPDATE S SET [Total Scheduled calls]=P.SCHEDULEDCALLS FROM #SalesmanProductivity S INNER JOIN
#PCALLS P ON P.SMID=S.SMID
UPDATE S SET [Total Productive Calls]=P.PrdCalls FROM #SalesmanProductivity S INNER JOIN
#ProductiveCalls P ON P.SMID=S.SMID
UPDATE #SalesmanProductivity SET 
[% of Productive Calls]=Isnull(Cast([Total Productive Calls] AS Numeric(18,2))/NULLIF(Cast([Total Scheduled calls] AS Numeric(18,2)),0)*100,0)
DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #SalesmanProductivity
SELECT * FROM #SalesmanProductivity Order BY [Salesman Name]
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_UnLoadingReturnQtyUOMBased' AND XTYPE='P')
DROP PROCEDURE Proc_UnLoadingReturnQtyUOMBased
GO
--Exec Proc_UnLoadingReturnQtyUOMBased 
CREATE PROCEDURE Proc_UnLoadingReturnQtyUOMBased
AS
BEGIN
	DECLARE @Prdid AS INT
	DECLARE @PrdCode AS Varchar(50)
	DECLARE @PrdBatchCode AS Varchar(50)
	DECLARE @SalId AS INT
	DECLARE @BaseQty AS INT
	DECLARE @FUOMID AS INT
	DECLARE @FCONVERSIONFACTOR AS INT
	DECLARE @StockOnHand AS INT
	DECLARE @Converted AS INT
	DECLARE @Remainder AS INT
	DECLARE @COLUOM AS VARCHAR(50)
	DECLARE @Sql AS VARCHAR(5000)
	DECLARE @SlNo AS INT
	
	DECLARE CUR_UOMQTY CURSOR --select * from RptUnloadingSheet
	FOR
		SELECT P.PrdId,Rpt.PrdDcode,PrdBatCode,SUM(TotalReturnQty) AS [TotalReturnQty] FROM RptUnloadingReturnQtyPM Rpt WITH (NOLOCK)
		INNER JOIN Product P WITH (NOLOCK) ON  Rpt.PrdId=P.PrdId GROUP BY P.PrdId,Rpt.PrdDCode,PrdBatCode
		
	OPEN CUR_UOMQTY
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	WHILE @@FETCH_STATUS=0
	BEGIN
			SET	@Converted=0
			SET @Remainder=0	
			DECLARE CUR_UOMGROUP CURSOR
			FOR 
			SELECT UOMID,CONVERSIONFACTOR FROM (
			SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID WHERE PRDID=@Prdid 
				AND PrdId NOT IN (SELECT PrdId FROM UomProductSkip WITH (NOLOCK))	 
			 UNION
			 	SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID INNER JOIN UOMPRODUCTSKIP WITH (NOLOCK)
				ON UOMPRODUCTSKIP.PRDID=PRODUCT.PRDID WHERE PRODUCT.PRDID=@Prdid 
				and UOMGROUP.UomId NOT IN (SELECT UOMID FROM UomProductSkip WHERE PrdId=@Prdid))A
				ORDER BY CONVERSIONFACTOR DESC
			OPEN CUR_UOMGROUP
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			WHILE @@FETCH_STATUS=0
			BEGIN
			--SELECT * FROM BillTemplateUomBased WITH (NOLOCK) WHERE UOMID=@FUOMID
					SELECT @COLUOM=UOMCODE FROM UomMaster WITH (NOLOCK) WHERE UOMID=@FUOMID
					IF @BaseQty>= @FCONVERSIONFACTOR
					BEGIN
						SET	@Converted=CAST(@BaseQty/@FCONVERSIONFACTOR as INT)
						SET @Remainder=CAST(@BaseQty%@FCONVERSIONFACTOR AS INT)
						SET @BaseQty=@Remainder	
						--Print @Converted
						--Print @Remainder		
						SET @Sql='UPDATE RptUnloadingReturnQtyPM SET [' + @COLUOM +']='+ Cast(Isnull(@Converted,0) as Varchar(25)) +' WHERE [PrdDCode]='+''''+@PrdCode+''''+' and [PrdBatCode]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END	
					ELSE
					BEGIN
						SET @Sql='UPDATE RptUnloadingReturnQtyPM SET [' + @COLUOM +']='+ Cast(0 as Varchar(10)) +' WHERE [PrdDcode] ='+''''+@PrdCode+''''+' and [PrdBatCode]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END
										
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			END	
			CLOSE CUR_UOMGROUP
			DEALLOCATE CUR_UOMGROUP
			SET @BaseQty=0
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	END	
	CLOSE CUR_UOMQTY
	DEALLOCATE CUR_UOMQTY
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptUnloadingReturnQtyPM' AND XTYPE='U')
DROP TABLE RptUnloadingReturnQtyPM
GO
CREATE TABLE RptUnloadingReturnQtyPM(
	[PrdId] [int] NULL,
	[PrdDcode] [varchar](100) NULL,
	[PrdName] [varchar](100) NULL,
	[PrdBatId] [int] NULL,
	[PrdBatCode] [varchar](100) NULL,
	[PrdUnitMRP] [numeric](38, 2) NULL,
	[PrdUnitSelRate] [numeric](38, 2) NULL,
	[SP] [numeric](36, 0) NULL,
	[Kg] [numeric](36, 0) NULL,
	[Hg] [numeric](36, 0) NULL,
	[St] [numeric](36, 0) NULL,
	[EA] [numeric](36, 0) NULL,
	[TotalRetQtyinKg] [numeric](36, 2) NULL,
	[TotalReturnQty] [bigint] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptUnloadingSheetPM_Excel' AND XTYPE='U')
DROP TABLE RptUnloadingSheetPM_Excel
GO
CREATE TABLE RptUnloadingSheetPM_Excel(
	[PrdId] [int] NULL,
	[PrdDCode] [varchar](100) NULL,
	[PrdName] [varchar](100) NULL,
	[PrdBatId] [int] NULL,
	[PrdBatCode] [varchar](100) NULL,
	[PrdUnitMRP] [nvarchar](20) NULL,
	[PrdUnitSelRate] [nvarchar](20) NULL,
	[SP] [numeric](38, 0) NULL,
	[Kg] [numeric](38, 0) NULL,
	[Hg] [numeric](38, 0) NULL,
	[St] [numeric](38, 0) NULL,
	[EA] [numeric](38, 0) NULL,
	[TotalLoadQtyinKg] [numeric](38, 2) NULL,
	[LoadBilledQty] [bigint] NULL,
	[LoadReplacementQty] [bigint] NULL,
	[TotalDlvQtyinKg] [numeric](38, 2) NULL,
	[TotalDlvQty] [bigint] NULL,
	[ReturnSP] [int] NULL,
	[ReturnKg] [int] NULL,
	[ReturnHg] [int] NULL,
	[ReturnSt] [int] NULL,
	[ReturnEA] [int] NULL,
	[TotalReturnQtyinKg] [numeric](38, 2) NULL,
	[TotalRetQty] [bigint] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_UnLoadingUOMBased' AND XTYPE='P')
DROP PROCEDURE Proc_UnLoadingUOMBased
GO
--Exec Proc_UnLoadingUOMBased 
CREATE PROCEDURE Proc_UnLoadingUOMBased
AS
BEGIN
	DECLARE @Prdid AS INT
	DECLARE @PrdCode AS Varchar(50)
	DECLARE @PrdBatchCode AS Varchar(50)
	DECLARE @SalId AS INT
	DECLARE @BaseQty AS INT
	DECLARE @FUOMID AS INT
	DECLARE @FCONVERSIONFACTOR AS INT
	DECLARE @StockOnHand AS INT
	DECLARE @Converted AS INT
	DECLARE @Remainder AS INT
	DECLARE @COLUOM AS VARCHAR(50)
	DECLARE @Sql AS VARCHAR(5000)
	DECLARE @SlNo AS INT
	
	DECLARE CUR_UOMQTY CURSOR --select * from RptUnloadingSheet
	FOR
		SELECT P.PrdId,Rpt.PrdDcode,PrdBatCode,SUM(LoadBilledQty) AS [Billed Qty] from RptUnloadingSheet Rpt WITH (NOLOCK)
		INNER JOIN Product P WITH (NOLOCK) ON  Rpt.PrdId=P.PrdId GROUP BY P.PrdId,Rpt.PrdDCode,PrdBatCode
		
	OPEN CUR_UOMQTY
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	WHILE @@FETCH_STATUS=0
	BEGIN
			SET	@Converted=0
			SET @Remainder=0	
			DECLARE CUR_UOMGROUP CURSOR
			FOR 
			SELECT UOMID,CONVERSIONFACTOR FROM (
			SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID WHERE PRDID=@Prdid 
				AND PrdId NOT IN (SELECT PrdId FROM UomProductSkip WITH (NOLOCK))	 
			 UNION
			 	SELECT UOMGROUP.UOMID,CONVERSIONFACTOR FROM UOMGROUP WITH (NOLOCK) INNER JOIN PRODUCT WITH (NOLOCK)
				ON PRODUCT.UOMGROUPID=UOMGROUP.UOMGROUPID INNER JOIN UOMPRODUCTSKIP WITH (NOLOCK)
				ON UOMPRODUCTSKIP.PRDID=PRODUCT.PRDID WHERE PRODUCT.PRDID=@Prdid 
				and UOMGROUP.UomId NOT IN (SELECT UOMID FROM UomProductSkip WHERE PrdId=@Prdid))A
				ORDER BY CONVERSIONFACTOR DESC
			OPEN CUR_UOMGROUP
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			WHILE @@FETCH_STATUS=0
			BEGIN
			--SELECT * FROM BillTemplateUomBased WITH (NOLOCK) WHERE UOMID=@FUOMID
					SELECT @COLUOM=UOMCODE FROM UomMaster WITH (NOLOCK) WHERE UOMID=@FUOMID
					IF @BaseQty>= @FCONVERSIONFACTOR
					BEGIN
						SET	@Converted=CAST(@BaseQty/@FCONVERSIONFACTOR as INT)
						SET @Remainder=CAST(@BaseQty%@FCONVERSIONFACTOR AS INT)
						SET @BaseQty=@Remainder	
						--Print @Converted
						--Print @Remainder		
						SET @Sql='UPDATE RptUnloadingSheet  SET [' + @COLUOM +']='+ Cast(Isnull(@Converted,0) as Varchar(25)) +' WHERE [PrdDCode]='+''''+@PrdCode+''''+' and [PrdBatCode]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END	
					ELSE
					BEGIN
						SET @Sql='UPDATE RptUnloadingSheet SET [' + @COLUOM +']='+ Cast(0 as Varchar(10)) +' WHERE [PrdDcode] ='+''''+@PrdCode+''''+' and [PrdBatCode]='+ ''''+@PrdBatchCode+'''' 
						EXEC(@Sql)
					END
										
			FETCH NEXT FROM CUR_UOMGROUP INTO @FUOMID,@FCONVERSIONFACTOR
			END	
			CLOSE CUR_UOMGROUP
			DEALLOCATE CUR_UOMGROUP
			SET @BaseQty=0
	FETCH NEXT FROM CUR_UOMQTY INTO @Prdid,@PrdCode,@PrdBatchCode,@BaseQty
	END	
	CLOSE CUR_UOMQTY
	DEALLOCATE CUR_UOMQTY
END
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='RptUnloadingSheet' AND XTYPE='U')
DROP TABLE RptUnloadingSheet
GO
CREATE TABLE RptUnloadingSheet(
	[PrdId] [int] NULL,
	[PrdDcode] [varchar](100) NULL,
	[PrdName] [varchar](100) NULL,
	[PrdBatId] [int] NULL,
	[PrdBatCode] [varchar](100) NULL,
	[PrdUnitMRP] [numeric](38, 2) NULL,
	[PrdUnitSelRate] [numeric](38, 2) NULL,
	[LoadBilledQty] [bigint] NULL,
	[LoadFreeQty] [bigint] NULL,
	[LoadReplacementQty] [bigint] NULL,
	[UnLoadSalQty] [bigint] NULL,
	[UnLoadUnSalQty] [bigint] NULL,
	[UnLoadFreeQty] [bigint] NULL,
	[UserId] [int] NULL,
	[SP] [numeric](36, 0) NULL,
	[Kg] [numeric](36, 0) NULL,
	[Hg] [numeric](36, 0) NULL,
	[St] [numeric](36, 0) NULL,
	[EA] [numeric](36, 0) NULL,
	[MarketReturn] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_RptUnloadingSheetPM' AND XTYPE='P')
DROP PROCEDURE Proc_RptUnloadingSheetPM
GO
--Exec Proc_RptUnloadingSheetPM 258,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptUnloadingSheetPM
(
	@Pi_RptId		INT,	
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
--Exec Proc_RptUnloadingSheetPM 248,1,0,'oo',0,0,1
/******************************************************************************************************
* CREATED BY	: PanneerSelvam.k
* CREATED DATE	: 05.11.2009 
* NOTE		    :
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------------------------------------------------------------
* {date}		{developer}  {brief modification description}
* 12.11.2009	 	Panneer		 Added Cancel Transaction Details
* 14.11.2009       	Panneer		 Replacement Qty Value Mismatch
* 26.12.2009	 	Panneer		 Cancel Bill Qty Value Mismatch
* 01.02.2010       	Panneer		 Include Dlvsts 5
* 10-Jun-2010		Jayakumar.N	 BillWise RetailerWise is added
* 27.08.2010        Panneer      Shipping Address Duplicate Issue
********************************************************************************************************/
BEGIN
SET NOCOUNT ON
	
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
			/*	Filter Variables  */
	DECLARE @FromDate	AS	DATETIME
	DECLARE @ToDate	 	AS	DATETIME
	DECLARE @VehicleId 			AS	INT
	DECLARE @VehicleAllocId 	AS	INT
	DECLARE @SMId 				AS	INT
	DECLARE @DlvRouteId 		AS	INT
	DECLARE @RtrId 				AS	INT
		/*  Assgin Value for the Filter Variable  */
	SELECT	@FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT	@ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)	
	SET @VehicleId		= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId))	
	SET @VehicleAllocId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId))
	SET	@SMId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @DlvRouteId  	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))	
	SET @RtrId	= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
--	exec PROC_UNLOAD
	Create TABLE #RptUnLoadingSheetReport
	(
				PrdId			INT,
				PrdDcode		NVARCHAR(100),
				PrdName			NVARCHAR(100),
				PrdBatId		INT,
				PrdBatCode		NVARCHAR(100),
				PrdUnitMRP		NUMERIC(38,2),
				PrdUnitSelRate	NUMERIC(38,2),
				LoadBilledQty	NUMERIC(38,2),
				LoadFreeQty 	NUMERIC(38,2),
				LoadReplacementQty NUMERIC(38,2),
				UnLoadSalQty	NUMERIC(38,2),
				UnLoadUnSalQty  NUMERIC(38,2),
				UnLoadFreeQty   NUMERIC(38,2)
	)
	SET @TblName = 'RptUnloadingSheet'
	SET @TblStruct = '	
				PrdId			INT,
				PrdDcode		NVARCHAR(100),
				PrdName			NVARCHAR(100),
				PrdBatId		INT,
				PrdBatCode		NVARCHAR(100),
				PrdUnitMRP		NUMERIC(38,2),
				PrdUnitSelRate	NUMERIC(38,2),
				LoadBilledQty	NUMERIC(38,2),
				LoadFreeQty 	NUMERIC(38,2),
				LoadReplacementQty NUMERIC(38,2),
				UnLoadSalQty	NUMERIC(38,2),
				UnLoadUnSalQty  NUMERIC(38,2),
				UnLoadFreeQty   NUMERIC(38,2)'
	
	SET @TblFields =   'PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,LoadBilledQty,
							LoadFreeQty,LoadReplacementQty,UnLoadSalQty,UnLoadUnSalQty,UnLoadFreeQty,UserId'
				/*  Till Here  */
				/* Snap Shot Required  */
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
			/* Till Here  */
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
	CREATE TABLE #RptUnloadingSheet(SalId INT,PrdId INT,PrdDcode Varchar(100),PrdName Varchar(100),
									PrdBatId INT,PrdBatCode Varchar(100),PrdUnitMRP Numeric(38,2),
									PrdUnitSelRate Numeric(38,2),
									LoadBilledQty BigInt,LoadFreeQty BigInt,LoadReplacementQty BigInt,
									UnLoadSalQty BigInt,UnLoadUnSalQty BigInt,UnLoadOfferQty INT,UserId INT)
				/* ----------  LoadBilledQty  and Saleable Qty  in Temp Table ----------------------------*/
	DELETE FROM RptUnloadingSheet  
	DELETE FROM #RptUnloadingSheet 
	INSERT INTO #RptUnloadingSheet
	SELECT  SalId,PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
			Sum(LoadBilledQty)LoadBilledQty ,Sum(LoadFreeQty) LoadFreeQty ,
			Sum(LoadReplacementQty) LoadReplacementQty,
			0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty, UserId
	FROM (
		SELECT	
				S.SalId,S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,
				PB.PrdBatCode,S.PrdUnitMRP,S.PrdUnitSelRate,
				Max(BaseQty)  LoadBilledQty,0 AS LoadFreeQty,0 AS LoadReplacementQty,
				0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,@Pi_UsrId AS UserId
		FROM 
				SalesInvoiceModificationHistory S,
				SalesInvoice SI,Product P,Productbatch PB,VehicleAllocationMaster V,
				VehicleAllocationDetails VD
		WHERE
				Si.DlvSts IN(2,3,4,5) AND S.VehicleStstus = 1 AND S.AllotmentId <> 0
				AND S.SalID = SI.SalId AND S.PrdId = P.PrdId	
				AND P.PrdId = PB.PrdId AND S.PrdId = PB.PrdId AND S.PrdBatId = PB.PrdBatId
				AND TransactionFlag = 1	
				AND V.AllotmentId = S.AllotmentId AND V.AllotmentNumber = VD.AllotmentNumber
				AND S.SalInvNo = VD.SaleInvNo
				AND SI.SalInvDate Between @FromDate AND @ToDate
				AND	(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId ELSE -1 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
							SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				AND	(SI.RtrId=(CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
				AND (S.VehicleId = (CASE @VehicleId WHEN 0 THEN S.VehicleId ELSE 0 END) OR
							S.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )	
				AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
							V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
		GROUP BY 
				S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,PB.PrdBatCode,S.PrdUnitMRP,
				S.PrdUnitSelRate,S.SalId  ) X
		GROUP BY 
				SalId,PrdId,PrdDcode,PrdName,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,UserId,PrdBatId
		
				/* ----------  Loaded Free Qty  in Temp Table ----------------------------*/
	INSERT INTO #RptUnloadingSheet
	SELECT  SalId,PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
		Sum(LoadBilledQty)LoadBilledQty ,Sum(LoadFreeQty) LoadFreeQty ,
		Sum(LoadReplacementQty) LoadReplacementQty,
		0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,UserId
	FROM (		
					/* Sales Free */
		SELECT	
				S.SalId,S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,
				PB.PrdBatCode,S.PrdUnitMRP,S.PrdUnitSelRate,
				0 LoadBilledQty,Max(BaseQty) AS LoadFreeQty,0 AS LoadReplacementQty,
				0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,@Pi_UsrId AS UserId
		FROM 
				SalesInvoiceModificationHistory S,
				SalesInvoice SI,Product P,Productbatch PB,VehicleAllocationMaster V,
				VehicleAllocationDetails VD
		WHERE
				Si.DlvSts IN(2,3,4,5) AND S.VehicleStstus = 1 AND S.AllotmentId <> 0
				AND S.SalID = SI.SalId AND S.PrdId = P.PrdId	
				AND P.PrdId = PB.PrdId AND S.PrdId = PB.PrdId AND S.PrdBatId = PB.PrdBatId
				AND TransactionFlag = 2
				AND V.AllotmentId = S.AllotmentId AND V.AllotmentNumber = VD.AllotmentNumber
				AND S.SalInvNo = VD.SaleInvNo
				AND SI.SalInvDate Between @FromDate AND @ToDate
				AND	(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId ELSE -1 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
							SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				AND	(SI.RtrId=(CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
				AND (S.VehicleId = (CASE @VehicleId WHEN 0 THEN S.VehicleId ELSE 0 END) OR
							S.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )	
				AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
							V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
		GROUP BY 
				S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,PB.PrdBatCode,S.PrdUnitMRP,
				S.PrdUnitSelRate,S.SalId  
	  ) X
	GROUP BY 
			SalId,PrdId,PrdDcode,PrdName,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,UserId,PrdBatId
		
				/* ----------  Loaded Replacement Qty  in Temp Table ----------------------------*/
		
	INSERT INTO #RptUnloadingSheet
	SELECT  SalId,PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
		Sum(LoadBilledQty)LoadBilledQty ,Sum(LoadFreeQty) LoadFreeQty ,
		MAX(LoadReplacementQty) LoadReplacementQty,
		0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty, @Pi_UsrId UserId
	FROM (		
					
		SELECT	
				S.SalId,S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,
				PB.PrdBatCode,S.PrdUnitMRP,S.PrdUnitSelRate,
				0 LoadBilledQty,0 AS LoadFreeQty,Sum(BaseQty) AS LoadReplacementQty,
				0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,@Pi_UsrId AS UserId,
				VersionNo   
		FROM 
				SalesInvoiceModificationHistory S,
				SalesInvoice SI,Product P,Productbatch PB,VehicleAllocationMaster V,
				VehicleAllocationDetails VD
		WHERE
				Si.DlvSts IN(2,3,4,5) AND S.VehicleStstus = 1 AND S.AllotmentId <> 0
				AND S.SalID = SI.SalId AND S.PrdId = P.PrdId	
				AND P.PrdId = PB.PrdId AND S.PrdId = PB.PrdId AND S.PrdBatId = PB.PrdBatId
				AND TransactionFlag = 4 AND S.StockType = 1
				AND V.AllotmentId = S.AllotmentId AND V.AllotmentNumber = VD.AllotmentNumber
				AND S.SalInvNo = VD.SaleInvNo 
				AND SI.SalInvDate Between @FromDate AND @ToDate
				AND	(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId ELSE -1 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
							SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				AND	(SI.RtrId=(CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
				AND (S.VehicleId = (CASE @VehicleId WHEN 0 THEN S.VehicleId ELSE 0 END) OR
							S.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )	
				AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
							V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
		GROUP BY 
				S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,PB.PrdBatCode,S.PrdUnitMRP,
				S.PrdUnitSelRate,S.SalId ,VersionNo
		UNION ALL
		SELECT	
				S.SalId,S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,
				PB.PrdBatCode,S.PrdUnitMRP,S.PrdUnitSelRate,
				0 LoadBilledQty,0 AS LoadFreeQty,sUM(BaseQty) AS LoadReplacementQty,
				0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,@Pi_UsrId AS UserId,VersionNo
		FROM 
				SalesInvoiceModificationHistory S,
				SalesInvoice SI,Product P,Productbatch PB,VehicleAllocationMaster V,
				VehicleAllocationDetails VD
		WHERE
				Si.DlvSts IN(2,3,4,5) AND S.VehicleStstus = 1 AND S.AllotmentId <> 0
				AND S.SalID = SI.SalId AND S.PrdId = P.PrdId	
				AND P.PrdId = PB.PrdId AND S.PrdId = PB.PrdId AND S.PrdBatId = PB.PrdBatId
				AND TransactionFlag = 4 AND S.StockType = 3
				AND V.AllotmentId = S.AllotmentId AND V.AllotmentNumber = VD.AllotmentNumber
				AND S.SalInvNo = VD.SaleInvNo
				AND SI.SalInvDate Between @FromDate AND @ToDate
				AND	(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId ELSE -1 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
							SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				AND	(SI.RtrId=(CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
				AND (S.VehicleId = (CASE @VehicleId WHEN 0 THEN S.VehicleId ELSE 0 END) OR
							S.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )
				AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
							V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )	
		GROUP BY 
				S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,PB.PrdBatCode,S.PrdUnitMRP,
				S.PrdUnitSelRate,S.SalId ,VersionNo 
	  ) X
	GROUP BY SalId,PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
				LoadBilledQty,LoadFreeQty
					
				/*  Loaded Market Return Qty */
		INSERT INTO #RptUnloadingSheet
		SELECT	DISTINCT
				S.SalId,S.PrdId,P.PrdDcode,P.PrdName,S.PrdBatId,
				PB.PrdBatCode,S.PrdUnitMRP,S.PrdUnitSelRate,
				0 LoadBilledQty,0 AS LoadFreeQty,0 AS LoadReplacementQty,
				0 AS UnLoadSalQty, 0  AS UnLoadUnSalQty, 0 AS UnLoadOfferQty,@Pi_UsrId AS UserId
		FROM 
				SalesInvoiceModificationHistory S,
				SalesInvoice SI,Product P,Productbatch PB,VehicleAllocationMaster V,
				VehicleAllocationDetails VD
		WHERE
				Si.DlvSts IN(2,3,4,5) AND S.VehicleStstus = 1 AND S.AllotmentId <> 0
				AND S.SalID = SI.SalId AND S.PrdId = P.PrdId	
				AND P.PrdId = PB.PrdId AND S.PrdId = PB.PrdId AND S.PrdBatId = PB.PrdBatId
				AND TransactionFlag = 3 
				AND V.AllotmentId = S.AllotmentId AND V.AllotmentNumber = VD.AllotmentNumber
				AND S.SalInvNo = VD.SaleInvNo
				AND SI.SalInvDate Between @FromDate AND @ToDate
				AND	(SI.SMId = (CASE @SMId WHEN 0 THEN SI.SMId ELSE -1 END) OR
							SI.SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))
				AND (SI.DlvRMId=(CASE @DlvRouteId WHEN 0 THEN SI.DlvRMId ELSE 0 END) OR
							SI.DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )
				AND	(SI.RtrId=(CASE @RtrId WHEN 0 THEN SI.RtrId ELSE 0 END) OR
							SI.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))	
				AND (S.VehicleId = (CASE @VehicleId WHEN 0 THEN S.VehicleId ELSE 0 END) OR
							S.VehicleId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,36,@Pi_UsrId)) )	
				AND (V.AllotmentId = (CASE @VehicleAllocId WHEN 0 THEN V.AllotmentId ELSE 0 END) OR
							V.AllotmentId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,37,@Pi_UsrId)) )
	
-- Added on 10-Jun-2010
	--DELETE FROM RptUnloadingSheet_Excel WHERE UserId=@Pi_UsrId
	--INSERT INTO RptUnloadingSheet_Excel
	--SELECT 
	--		A.SalId,SalInvNo,SI.RtrId,RtrCode,RtrName,(RSA.RtrShipAdd1+' --> '+RSA.RtrShipAdd2+' --> '+RSA.RtrShipAdd3),
	--		A.PrdId,PrdDCode,PrdName,A.PrdBatId,PrdBatCode,A.PrdUnitMRP,A.PrdUnitSelRate,
	--		Sum(LoadBilledQty) LoadBilledQty,
	--		SUm(LoadFreeQty) LoadFreeQty,
	--		SUm(LoadReplacementQty) LoadReplacementQty,
	--		Sum(UnLoadSalQty) UnLoadSalQty,
	--		Sum(UnLoadUnSalQty) UnLoadUnSalQty,
	--		Sum(UnLoadOfferQty) UnLoadOfferQty,
	--		'' [Description],UserId
	--FROM 
	--		#RptUnloadingSheet A
	--		INNER JOIN SalesInvoice SI ON A.SalId=SI.SalId 
	--		INNER JOIN Retailer R ON SI.RtrId=R.RtrId
	--		Left Outer JOIN RetailerShipAdd RSA ON R.RtrId=RSA.RtrId 
	--						       and SI.RtrShipId = RSA.RtrShipId
	--WHERE 
	--		UserId = @Pi_UsrId
	--GROUP BY 
	--		A.SalId,SalInvNo,SI.RtrId,RtrCode,RtrName,RSA.RtrShipAdd1,RSA.RtrShipAdd2,RSA.RtrShipAdd3,
	--		A.PrdId,PrdDCode,PrdName,A.PrdBatId,PrdBatCode,A.PrdUnitMRP,A.PrdUnitSelRate,UserId
-- End here
		/*  Final Output Table */
	INSERT INTO RptUnloadingSheet  
	SELECT 
			PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
			(Sum(LoadBilledQty) + SUm(LoadFreeQty)) LoadBilledQty,
			SUm(LoadFreeQty) LoadFreeQty,
			SUm(LoadReplacementQty) LoadReplacementQty,
			Sum(UnLoadSalQty) UnLoadSalQty,
			Sum(UnLoadUnSalQty) UnLoadUnSalQty,
			Sum(UnLoadOfferQty) UnLoadOfferQty,
			UserId,0,0,0,0,0,0
			
	FROM 
			#RptUnloadingSheet
	WHERE 
			UserId = @Pi_UsrId
	GROUP BY 
			PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,UserId
			/* ---------- Update UnLoaded Saleable Qty  in RptUnloadingSheet Table ----------*/
					/*  Latest  Version  */
	SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #Tmp1000
	FROM (
					/* SalesInvoiceProduct table */
			SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty
			FROM SalesInvoiceProduct 
			WHERE SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
				  AND SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY PrdId,PrdBatId,SalId
					/* Replacement table */
			UNION ALL
			SELECT SalId,PrdId,PrdBatId,Sum(RepQty) BaseQty
			FROM ReplacementHd R,ReplacementOut  Ro 
			WHERE  R.RepRefNo = RO.RepRefNo 
				   AND Ro.StockTypeId IN (SELECT DISTINCT StockTypeId FROM StockType WHERE SystemStockType = 1) 
				   AND  SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
				   AND SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY PrdId,PrdBatId	,SalId	)  X 
	GROUP BY PrdId,PrdBatId,SalId
				/*  Base  Version  */
	SELECT SalId,PrdId,PrdBatId,BaseQty INTO #Tmp1001
	FROM (
		SELECT A.SalId,A.PrdId,A.PrdBatId,Max(BaseQty) BaseQty 
		FROM   SalesInvoiceModificationHistory A,#RptUnloadingSheet B
		WHERE  A.SalId = B.SalId AND A.PrdId = B.PrdId AND A.PrdBatId = B.PrdbatId
			   AND UserId  = @Pi_UsrId	AND TransactionFlag = 1 AND A.VehicleStstus > 0
			   AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
		GROUP BY A.SalId,A.PrdId,A.PrdBatId
		UNION ALL
		SELECT SalId,PrdId,PrdBatId,mAX(BaseQty) BaseQty
		FROM (
			SELECT A.SalId,A.PrdId,A.PrdBatId,SUM(BaseQty) BaseQty, VersionNo
			FROM   SalesInvoiceModificationHistory A,#RptUnloadingSheet B
			WHERE  A.SalId = B.SalId AND A.PrdId = B.PrdId AND A.PrdBatId = B.PrdbatId
				   AND UserId  = @Pi_UsrId	AND TransactionFlag = 4 AND A.VehicleStstus > 0
				   AND StockType = 1 
				   AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY A.SalId,A.PrdId,A.PrdBatId,VersionNo ) C
		GROUP BY SalId,PrdId,PrdBatId ) X			  
	GROUP BY SalId,PrdId,PrdBatId,BaseQty
		/*	Compare Base AND Latest Version */
	SELECT PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #FinalUnLoadSal
	FROM (
			SELECT PrdId,PrdBatId,Sum(BaseQty)BaseQty
			FROM #Tmp1000
			GROUP BY PrdId,PrdBatId
			UNION ALL	
			SELECT PrdId,PrdBatId,Sum(-BaseQty) BaseQty
			FROM #Tmp1001
			GROUP BY PrdId,PrdBatId ) X
	GROUP BY PrdId,PrdBatId
-- Added on 10-Jun-2010
	SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #FinalUnLoadSal_New
	FROM (
			SELECT SalId,PrdId,PrdBatId,Sum(BaseQty)BaseQty
			FROM #Tmp1000
			GROUP BY SalId,PrdId,PrdBatId
			UNION ALL	
			SELECT SalId,PrdId,PrdBatId,Sum(-BaseQty) BaseQty
			FROM #Tmp1001
			GROUP BY SalId,PrdId,PrdBatId ) X
	GROUP BY SalId,PrdId,PrdBatId
	--UPDATE A SET UnLoadSalQty =  Abs(BaseQty)
	--FROM  RptUnloadingSheet_Excel A,#FinalUnLoadSal_New B
	--WHERE A.SalId=B.SalId AND A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId
-- End here
	UPDATE RptUnloadingSheet SET UnLoadSalQty =  Abs(BaseQty)
			FROM  RptUnloadingSheet a,#FinalUnLoadSal B
			WHERE A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId -------AND BaseQty >= 0 
	
			/*  Update Market Return Saleable  */
	SELECT DISTINCT SR.SalId,Rp.PrdId,RP.PrdBatId,0 AS BaseQty INTO #Tmp1003
	FROM SalesInvoiceMarketReturn SR,#RptUnloadingSheet A,
	     ReturnHeader RH,ReturnProduct RP
	WHERE A.SalId = SR.SalID AND SR.ReturnId = RH.ReturnID
			AND RH.ReturnID = RP.ReturnID  AND A.PrdId = RP.PrdId AND A.PrdBatId = Rp.PrdBatId
			AND RP.StockTypeId in (SELECT DISTINCT StockTypeId FROM StockType WHERE SystemStockType = 1)
			AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
					WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
	SELECT PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempMRSal
	FROM #Tmp1003
	GROUP BY PrdId,PrdBatId
	UPDATE RptUnloadingSheet SET UnLoadSalQty = UnLoadSalQty + BaseQty
	FROM  RptUnloadingSheet a,#TempMRSal B
	WHERE A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId
-- Added on 10-Jun-2010
	SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempMRSal_New
	FROM #Tmp1003
	GROUP BY SalId,PrdId,PrdBatId
	--UPDATE A SET UnLoadSalQty = UnLoadSalQty + BaseQty
	--FROM RptUnloadingSheet_Excel A,#TempMRSal_New B
	--WHERE A.SalId=B.SalId AND A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId
-- End here
			/*	Till Here  */
		/* ---------- Update UnLoaded UnSaleable Qty in RptUnloadingSheet Table ----------*/
			/*  Update Market Return UnSaleable  */
	SELECT DISTINCT SR.SalId,Rp.PrdId,RP.PrdBatId,0 As BaseQty INTO #Tmp1004
	FROM SalesInvoiceMarketReturn SR,#RptUnloadingSheet A,
			ReturnHeader RH,ReturnProduct RP
	WHERE A.SalId = SR.SalID AND SR.ReturnId = RH.ReturnID
			AND RH.ReturnID = RP.ReturnID  AND A.PrdId = RP.PrdId AND A.PrdBatId = Rp.PrdBatId
			AND RP.StockTypeId in (SELECT DISTINCT StockTypeId FROM StockType WHERE SystemStockType = 2)
			AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
					WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
	SELECT PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempMRUnSal
	FROM #Tmp1004
	GROUP BY PrdId,PrdBatId
	UPDATE RptUnloadingSheet SET UnLoadUnSalQty = UnLoadUnSalQty + BaseQty
	FROM  RptUnloadingSheet a,#TempMRUnSal B
	WHERE A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId
-- Added on 10-Jun-2010
	SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempMRUnSal_New
	FROM #Tmp1004
	GROUP BY SalId,PrdId,PrdBatId
	--UPDATE A SET UnLoadUnSalQty = UnLoadUnSalQty + BaseQty
	--FROM  RptUnloadingSheet_Excel A,#TempMRUnSal_New B
	--WHERE A.SalId=B.SalId AND A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
-- End here
		/*	Till Here  */
		/* ---------- Update UnLoaded Free Qty  in RptUnloadingSheet Table ----------*/
			
						/* SalesInvoiceProduct table Manual Free */
		SELECT SalId,PrdId,PrdbatId,Sum(BaseQty) BaseQty INTO #TempLat1006
		FROM (
			SELECT DISTINCT SalId,PrdId,PrdBatId,Sum(SalManFreeQty) BaseQty
			FROM SalesInvoiceProduct 
			WHERE SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
			AND SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY PrdId,PrdBatId,SalId
			UNION ALL
							/* SalesInvoiceFree table Free */
			SELECT DISTINCT SalId,FreePrdId,FreePrdBatId,Sum(FreeQty)  FreeQty
			FROM SalesInvoiceSchemeDtFreePrd 
			WHERE SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
				  AND SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY FreePrdId,FreePrdBatId,SalId	
			UNION ALL
			--				/* Market Return Table Scheme Free */
			--SELECT DISTINCT SR.SalId,RF.FreePrdId,RF.FreePrdBatId,Sum(RF.ReturnFreeQty) BaseQty
			--FROM 	ReturnSchemeFreePrdDt RF,ReturnHeader RH,SalesInvoiceMarketReturn SR
			--WHERE	SR.SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
			--		AND RH.ReturnID = RF.ReturnId  AND RH.ReturnID = SR.ReturnId
			--		AND SR.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
			--							WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			--GROUP BY SR.SalId,RF.FreePrdId,RF.FreePrdBatId
			--UNION ALL
			--				/* Market Return Offer  */
			--SELECT DISTINCT SR.SalId,RF.PrdId,RF.PrdBatId,Sum(RF.BaseQty) BaseQty
			--FROM 	ReturnProduct RF,ReturnHeader RH,SalesInvoiceMarketReturn SR
			--WHERE	SR.SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
			--		AND RH.ReturnID = RF.ReturnId  AND RH.ReturnID = SR.ReturnId
			--		AND RF.StockTypeId IN (SELECT DISTINCT StockTypeId FROM StockType WHERE SystemStockType = 3)
			--	    AND SR.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
			--							WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			--GROUP BY SR.SalId,RF.PrdId,RF.PrdBatId
			--UNION ALL
							/* Replacement Offer */
			SELECT DISTINCT RH.SalId,Ro.PrdId,Ro.PrdBatId,Sum(Ro.RepQty) BaseQty
			FROM ReplacementHd RH,ReplacementOut RO
			WHERE RH.RepRefNo = RO.RepRefNo
				  AND RH.SalId IN (SELECT DISTINCT SalId FROM #RptUnloadingSheet WHERE UserId  = @Pi_UsrId )
				  AND Ro.StockTypeId IN (SELECT DISTINCT StockTypeId FROM StockType WHERE SystemStockType = 3)
				  AND SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY RH.SalId,Ro.PrdId,Ro.PrdBatId	) y
		GROUP BY SalId,PrdId,PrdBatId		
					/*  Base  Version  */
					/* Scheme */
		SELECT SalId,PrdId,PrdbatId,Sum(BaseQty) BaseQty INTO #Tmpbase1007
		FROM (
			SELECT DISTINCT A.SalId,A.PrdId,A.PrdbatId,Max(BaseQty) BaseQty
			FROM SalesInvoiceModificationHistory  a, #RptUnloadingSheet B
			WHERE TransactionFlag = 2 AND A.SalId = B.SalId AND a.VehicleStstus > 0
				  AND a.PrdId = B.PrdId AND A.PrdBatId = B.PrdbatId
				  AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY A.SalId,A.PrdId,A.PrdbatId		
			UNION All
			SELECT DISTINCT A.SalId,A.PrdId,A.PrdbatId,Max(BaseQty) BaseQty
			FROM SalesInvoiceModificationHistory  a, #RptUnloadingSheet B
			WHERE TransactionFlag = 4 AND A.SalId = B.SalId AND a.VehicleStstus > 0
					AND a.PrdId = B.PrdId AND A.PrdBatId = B.PrdbatId
					AND StockType = 3
					AND A.SalId IN (SELECT A.SalId FROM #RptUnloadingSheet a,SalesInvoice B 
										WHERE A.SalId = B.SalId  AND DlvSts <> 3 )
			GROUP BY A.SalId,A.PrdId,A.PrdbatId		) Z
		GROUP BY SalId,PrdId,PrdbatId	
		/* Update Free in RptUnLoadingSheet Table */
	SELECT PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempUnLFree
	FROM (
		SELECT PrdId,PrdBatId,Sum(BaseQty) BaseQty 
		FROM #TempLat1006
		GROUP BY PrdId,PrdBatId
		UNION All
		SELECT PrdId,PrdBatId,Sum(-BaseQty) BaseQty  
		FROM #Tmpbase1007
		GROUP BY PrdId,PrdBatId ) h
	GROUP BY PrdId,PrdBatId --sathish
	UPDATE RptUnloadingSheet SET UnLoadFreeQty = Abs(B.BaseQty)
			FROM  RptUnloadingSheet a,#TempUnLFree B
			WHERE A.PrdId = B.PrdId AND a.PrdBatId = B.PrdBatId
-- Added on 10-Jun-2010
	SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempUnLFree_New
	FROM (
		SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty 
		FROM #TempLat1006
		GROUP BY SalId,PrdId,PrdBatId
		UNION All
		SELECT SalId,PrdId,PrdBatId,Sum(-BaseQty) BaseQty  
		FROM #Tmpbase1007
		GROUP BY SalId,PrdId,PrdBatId 
	     ) h
	GROUP BY SalId,PrdId,PrdBatId
--	UPDATE A SET A.UnLoadFreeQty = Abs(UnLoadFreeQty) + Abs(BaseQty)
--	FROM  RptUnloadingSheet A,#TempUnLFree_New B
--	WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
-- End here
					/*   Update Cancel Bill Saleable - */
							/* Saleable Qty */
		SELECT PrdId,PrdBatId,Sum(BilledQty) BilledQty INTO #TempCancelBilledQty
		FROM (
			SELECT A.SalId,PrdId,PrdBatId,(LoadBilledQty) AS BilledQty 
			FROM #RptUnloadingSheet a,SalesInvoice  b 
			WHERE A.SalId  = B.SalId AND Dlvsts = 3  AND UserId = @Pi_UsrId) AS a
		GROUP BY  PrdId,PrdBatId
		UPDATE RptUnloadingSheet SET UnLoadSalQty =  UnLoadSalQty + BilledQty
						FROM RptUnloadingSheet a, #TempCancelBilledQty B
						WHERE a.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
						and UserId = @Pi_UsrId
-- Added on 10-Jun-2010
		SELECT SalId,PrdId,PrdBatId,Sum(BilledQty) BilledQty INTO #TempCancelBilledQty_New
		FROM (
			SELECT A.SalId,PrdId,PrdBatId,(LoadBilledQty) AS BilledQty 
			FROM #RptUnloadingSheet a,SalesInvoice  b 
			WHERE A.SalId  = B.SalId AND Dlvsts = 3  AND UserId = @Pi_UsrId) AS a
		GROUP BY SalId,PrdId,PrdBatId
		--UPDATE A SET UnLoadSalQty =  UnLoadSalQty + BilledQty
		--FROM RptUnloadingSheet_Excel A, #TempCancelBilledQty_New B
		--WHERE A.SalId=B.SalId AND a.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
		--and UserId = @Pi_UsrId
-- End here
				/*   Update Cancel Bill Offer - */
							/* Offer Qty */
		SELECT PrdId,PrdBatId,Sum(FreeQty) FreeQty INTO #TempCancelFree
		FROM (
			SELECT A.SalId,PrdId,PrdBatId,(LoadFreeQty) AS FreeQty 
			FROM #RptUnloadingSheet a,SalesInvoice  b 
			WHERE A.SalId  = B.SalId AND Dlvsts = 3  AND UserId = @Pi_UsrId) AS a
		GROUP BY  PrdId,PrdBatId				
		UPDATE RptUnloadingSheet SET UnLoadFreeQty = UnLoadFreeQty + FreeQty
						FROM RptUnloadingSheet a, #TempCancelFree B
						WHERE a.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
						and UserId = @Pi_UsrId
-- Added on 10-Jun-2010
		SELECT SalId,PrdId,PrdBatId,Sum(FreeQty) FreeQty INTO #TempCancelFree_New
		FROM (
			SELECT A.SalId,PrdId,PrdBatId,(LoadFreeQty) AS FreeQty 
			FROM #RptUnloadingSheet a,SalesInvoice  b 
			WHERE A.SalId  = B.SalId AND Dlvsts = 3  AND UserId = @Pi_UsrId) AS a
		GROUP BY SalId,PrdId,PrdBatId	
			
		--UPDATE A SET UnLoadFreeQty = UnLoadFreeQty + FreeQty
		--FROM RptUnloadingSheet_Excel a, #TempCancelFree_New B
		--WHERE A.SalId=B.SalId AND a.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
		--and UserId = @Pi_UsrId
-- Exec [Proc_RptUnloadingSheet] 185,2,0,'TEST',0,0,1
-- End here
						/*   Update Cancel Bill UnSaleable - */
					/*	Canceled Bill -- Market UnSaleable  */
		SELECT SalId,PrdId,PrdBatId,Sum(BaseQty) BaseQty INTO #TempTable
				FROM (	
					SELECT 	B.SalId,D.PrdId,D.PrdBatId,Sum(D.BaseQty) BaseQty  
					FROM	SalesInvoice A ,SalesInvoiceMarketReturn B, #RptUnloadingSheet C,
							ReturnProduct D,ReturnHeader E 
					WHERE	 A.SalId = B.SalId	AND B.SalId = C.SalId And ReturnType = 1 
					         AND (C.LoadBilledQty+C.LoadFreeQty+LoadReplacementQty) = 0
							 AND A.SalId = C.SalId  AND B.ReturnId = E.ReturnID  AND D.ReturnID = E.ReturnID
							 AND D.PrdId = C.PrdId  AND D.PrdBatId = C.PrdBatId AND DlvSts <> 3
							 AND UserId  = @Pi_UsrId 
					GROUP BY D.PrdId,D.PrdBatId,B.SalId 
					) v
				GROUP By PrdId,PrdbatId,Salid
	UPDATE A SET A.MarketReturn = B.BaseQty FROM RptUnloadingSheet A,#TempTable B,#RptUnloadingSheet C
	WHERE A.PrdId = B.PrdId And A.PrdBatId = B.PrdBatId And B.SalId = C.SalId
				/* Update in Calcel Bill Qty UnSaleable */
-- Added on 10-Jun-2010
		/* Update in Calcel Bill Qty UnSaleable */
		--UPDATE A SET UnLoadUnSalQty = 0 ------UnLoadUnSalQty - BaseQty
		--FROM RptUnloadingSheet_Excel A, #TempCancelUnSal_New B
		--WHERE A.SalId=B.SalId AND a.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId
		--and UserId = @Pi_UsrId
		--UPDATE A SET Reason=[Description] FROM RptUnloadingSheet_Excel A,ReturnProduct RP,ReasonMaster R 
		--WHERE A.SalId=RP.SalId AND RP.ReasonId=R.ReasonId AND A.PrdId=RP.PrdId AND A.PrdBatId=RP.PrdBatId
EXEC Proc_UnLoadingUOMBased		
	--IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
	--Begin
	--	If Exists (Select [Name] From SysObjects Where [Name]='RptUnloadingSheet_Excel' And XTYPE='U')
	--	Drop Table RptUnloadingSheet_Excel
	--	Select *--,(LoadBilledQty-UnLoadSalQty) TotalDelQty
	--	 Into RptUnloadingSheet_Excel From RptUnloadingSheet 
	--End	
-- End here  
	----	Check for Report Data Count
		Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId	
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptUnloadingSheet WHERE UserId =  	@Pi_UsrId
	----    Till Here
		SELECT	PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,
		ABS(LoadBilledQty)AS LoadBilledQty,0 LoadFreeQty,
		ABS(LoadReplacementQty)AS LoadReplacementQty,ABS(UnLoadSalQty) UnLoadSalQty,ABS(UnLoadUnSalQty) UnLoadUnSalQty,ABS(UnLoadFreeQty)AS UnLoadFreeQty,UserId,
		SP,Kg,Hg,St,EA,((ABS(LoadBilledQty)-(ABS(UnLoadSalQty)+ABS(UnLoadFreeQty)))+ABS(LoadReplacementQty)) AS TotalDlvQty,
	   ((ABS(LoadBilledQty)+ABS(LoadReplacementQty))-((ABS(LoadBilledQty)-(ABS(UnLoadSalQty)+ABS(UnLoadFreeQty)))+ABS(LoadReplacementQty)))+ ABS(MarketReturn) As TotalRetQty
        INTO #TempRptUnloadingSheet FROM RptUnloadingSheet WHERE UserId = @Pi_UsrId
        SELECT PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,SP,Kg,Hg,St,EA,CAST(0 AS NUMERIC(18,2)) AS TotalLoadQtyinKg,
        LoadBilledQty,LoadReplacementQty,CAST(0 AS NUMERIC(18,2)) AS TotalDlvQtyinKg,TotalDlvQty,0 AS ReturnSP,0 AS ReturnKg,0 AS ReturnHg,
        0 AS ReturnSt,0 AS ReturnEA,CAST(0 AS NUMERIC(18,2)) AS TotalReturnQtyinKg,TotalRetQty INTO #RptUnloadinSheetFinal FROM #TempRptUnloadingSheet
        WHERE (LoadBilledQty+LoadFreeQty+LoadReplacementQty+TotalDlvQty+TotalRetQty) > 0 ORDER BY PrdDCode,PrdName
        DELETE FROM RptUnloadingReturnQtyPM
        INSERT INTO RptUnloadingReturnQtyPM (PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,SP,Kg,
        Hg,St,EA,TotalRetQtyinKg,TotalReturnQty)
        SELECT DISTINCT PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,0,0,0,0,0,0,TotalRetQty FROM #TempRptUnloadingSheet
 --Return Qty Uom Details       
 EXEC Proc_UnLoadingReturnQtyUOMBased       
---Load Qty Weight		
		UPDATE A SET A.TotalLoadQtyinKg = CAST(((LoadBilledQty * PrdWgt)/1000)AS NUMERIC(18,2)) FROM #RptUnloadinSheetFinal A,Product B
		WHERE A.PrdId = B.PrdId
---Delivery Qty Weight		
		UPDATE A SET A.TotalDlvQtyinKg = CAST(((TotalDlvQty * PrdWgt)/1000)AS NUMERIC(18,2)) FROM #RptUnloadinSheetFinal A,Product B
		WHERE A.PrdId = B.PrdId
---ReturnQtyUom Details
        UPDATE A SET A.ReturnSP = B.SP FROM #RptUnloadinSheetFinal A,RptUnloadingReturnQtyPM B 
        WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId --Return SP
        UPDATE A SET A.ReturnKg = B.Kg FROM #RptUnloadinSheetFinal A,RptUnloadingReturnQtyPM B 
        WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId --Return Kg			
        UPDATE A SET A.ReturnHg = B.Hg FROM #RptUnloadinSheetFinal A,RptUnloadingReturnQtyPM B 
        WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId --Return Hg
        UPDATE A SET A.ReturnSt = B.St FROM #RptUnloadinSheetFinal A,RptUnloadingReturnQtyPM B
        WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId --Return St
        UPDATE A SET A.ReturnEA = B.EA FROM #RptUnloadinSheetFinal A,RptUnloadingReturnQtyPM B
        WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId --Return EA
---Return Qty Weight		
		UPDATE A SET A.TotalReturnQtyinKg = CAST(((TotalRetQty * PrdWgt)/1000)AS NUMERIC(18,2)) FROM #RptUnloadinSheetFinal A,Product B
		WHERE A.PrdId = B.PrdId
		
		DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptUnloadinSheetFinal
		
       DECLARE @Record AS NUMERIC (36,0)
       SELECT @Record = COUNT(*) FROM #RptUnloadinSheetFinal
       SELECT * FROM #RptUnloadinSheetFinal ORDER BY PrdDcode,PrdName 
---Sathishkumar Veeramani 2012/07/17
    IF @Record > 0
    BEGIN
			IF EXISTS (SELECT [Name] FROM SysObjects WHERE [Name]='TempUnloadingSheetTotal' And XTYPE='U')
			DROP TABLE TempUnloadingSheetTotal 
			SELECT 99999 AS PrdId,'TOTAL' AS PrdName,SUM(SP) AS SP,SUM(Kg) AS Kg,SUM(Hg) AS Hg,SUM(St) AS St,SUM(EA) AS EA,
			SUM(TotalLoadQtyinKg) AS TotalLoadQtyinKg,SUM(LoadBilledQty) AS LoadBilledQty,SUM(LoadReplacementQty) AS LoadReplacementQty,
			SUM(TotalDlvQtyinKg) AS TotalDlvQtyinKg,SUM(TotalDlvQty) AS TotalDlvQty,SUM(ReturnSP) AS ReturnSP,SUM(ReturnKg) AS ReturnKg,
			SUM(ReturnHg) AS ReturnHg,SUM(ReturnSt) AS ReturnSt,SUM(ReturnEA) AS ReturnEA,
			SUM(TotalReturnQtyinKg) AS TotalReturnQtyinKg,SUM(TotalRetQty) AS TotalRetQty INTO TempUnloadingSheetTotal FROM #RptUnloadinSheetFinal
		    
			IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
			BEGIN
				IF EXISTS (SELECT [Name] FROM SysObjects WHERE [Name]='RptUnloadingSheetPM_Excel' And XTYPE='U')
				DROP TABLE RptUnloadingSheetPM_Excel
				SELECT PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,PrdUnitMRP,PrdUnitSelRate,SP,Kg,Hg,St,EA,TotalLoadQtyinKg,LoadBilledQty,
				LoadReplacementQty,TotalDlvQtyinKg,TotalDlvQty,ReturnSP,ReturnKg,ReturnHg,ReturnSt,ReturnEA,TotalReturnQtyinKg,TotalRetQty 
				INTO RptUnloadingSheetPM_Excel FROM (
				SELECT PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CAST(PrdUnitMRP AS NVARCHAR(20)) AS PrdUnitMRP,
				CAST(PrdUnitSelRate AS NVARCHAR(20)) AS PrdUnitSelRate,SP,Kg,Hg,St,EA,TotalLoadQtyinKg,LoadBilledQty,
				LoadReplacementQty,TotalDlvQtyinKg,TotalDlvQty,ReturnSP,ReturnKg,ReturnHg,ReturnSt,ReturnEA,TotalReturnQtyinKg,TotalRetQty 
				FROM #RptUnloadinSheetFinal UNION ALL
				SELECT PrdId,'' PrdDCode,PrdName,0 PrdBatId,'' PrdBatCode,'' PrdUnitMRP,'' PrdUnitSelRate,SP,Kg,Hg,St,EA,TotalLoadQtyinKg,LoadBilledQty,
				LoadReplacementQty,TotalDlvQtyinKg,TotalDlvQty,ReturnSP,ReturnKg,ReturnHg,ReturnSt,ReturnEA,TotalReturnQtyinKg,TotalRetQty 
				FROM TempUnloadingSheetTotal )Z ORDER BY Z.Prdid,Z.PrdDCode,Z.PrdName
			END
     END	
  END				
END
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.0',408
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 408)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(408,'D','2013-09-13',GETDATE(),1,'Core Stocky Service Pack 408')
GO