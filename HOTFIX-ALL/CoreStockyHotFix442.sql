--[Stocky HotFix Version]=442
DELETE FROM Versioncontrol WHERE Hotfixid='442'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone) 
VALUES('442','3.1.0.20','D','2020-01-02','2020-01-02','2020-01-02',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: Product NOV 2019')
GO
/*
ILCRSTPAR6281 --> Manual claim , claim amount should not greater than proposed lib %* secondary sale amount
ILCRSTPAR6281 --> Duplicate Row as checked for claim Description
ILCRSTPAR6289 --> Included GT Category	
CCRSTPAR0172  --> Template Access control
ILCRSTPAR6197 --> PAN number & GSTIN No Allow duplicate  / VAT Report Hide /YEAR END Process
								
CRCRSTPAR0079 --> 	Debitnotetopsheed Module , Upload and Download	Mohana
CRCRSTPAR0081 --> 	Transaction level Retailer category capture(Billing and Sales Return)	Deepan
CRCRSTPAR0083 --> 	LCTR only download & module change in Batch Master (Impact Special discount download)	Deepan
CRCRSTPAR0089 --> 	Sales invoice, Sales return  new column to be added retailer group, retailer category, retailer value class in upload process.	Deepan
CRCRSTPAR0090 --> 	Debit Note Top sheet PDF Report development	Deepan
CRCRSTPAR0091 --> 	Debit Note Top sheet PDF File Upload	Deepan
CRCRSTPAR0092 --> 	GRN Tracking -Retailer Category upload	Deepan
CRCRSTPAR0094 -->	Retailer Level budget validation
--Scrpit Updater Scrpits
RptDebitNoteTopSheet_Excel3,SyncAttempt,DelEtlTempPurchaseReceipt,Proc_EtlPurchase,SpecialRateAftDownLoad_Calc,SyncTrack,Debitnote_Scheme,
CS2Console_Consolidated_Trace,Proc_PopulateToBeUploaded,Proc_ComputeTax,Proc_RptProductWiseSalesTaxGST,Proc_RptPurchaseTaxGST,
Proc_RptSalesReturnCNTaxGST,Proc_RptOutputSaleTaxGST,Proc_RptInputtaxCreditGST,RptInputOutPutGSTTax,Proc_RptInputOutputProductWiseGSTTax,
Proc_RptFORMGSTR_3B_1_GST,Proc_RptHSNOutPutTaxGST,Proc_RptHSNInputTaxGST,Proc_RptFORMGSTR_3B_2_GST,Proc_RptFORMGSTR_3B_3_GST,Proc_RptGSTR1_B2B,
Proc_RptGSTR1_B2CL,Proc_RptGSTRTRANS1_CDNR,Proc_RptGSTRTRANS1_CDNUR,Proc_RptGSTR1_HSNCODE,Proc_RptGSTR2_B2B,Proc_RptGSTR2_HSNSUM,
Proc_RptGSTR2_CDN,Proc_Cn2Cs_TaxSetting,Proc_RptGSTR1_B2CS,Proc_RptDebitNoteTopSheetNew,RetailerMarketOldRouteTrack,Proc_Cn2Cs_RetailerReDownload,
Cn2Cs_Prk_ContractPricing_Detail_Zero_percent,SpecialDiscountDownload_track,ContractPricingTraceRePush,Proc_ContractPricingTraceRePush,
Proc_Console2CS_ConsolidatedDownload,Proc_NewBatchNCategoryInsert,Cn2Cs_Prk_ContractPricing_Header_NP,Cn2Cs_Prk_ContractPricing_Detail_NP,
Cn2Cs_Prk_SpecialDiscount_NP,Proc_ContractPricingTraceRePush_New,Proc_ValidateDayEndProcess,Proc_Validate_ContractPricing,
Proc_CalculateSpecialDiscountAftRate,Proc_DistributorIncentiveCalculation,PROC_CS2CN_DAILYPRODUCTDETAILS,Proc_Cn2Cs_DiscountMaster,
Proc_Cn2Cs_DiscountMaster_NP,Proc_Cs2Cn_DebitNoteTopSheet2,Fn_ReturnToBloackRetailerColumns,Proc_Cn2Cs_ProductBatch,Proc_InsertContractPricingForNewProduct,
Proc_Cn2Cs_BLSchemeAttributes,Proc_Cn2Cs_SpecialDiscount,Proc_ReturnSplDiscount,CN2Cs_Prk_RetailerMasterDownload,Proc_LoadingInstitutionsTarget,
Proc_RptDebitNoteTopSheet,Proc_Validate_InstitutionsTargetSetting,Cn2Cs_Prk_BLPurchaseReceipt_Trace,Proc_Cn2Cs_PurchaseReceipt,Proc_CN2Cs_RetailerMasterDownload_New
Proc_DatabaseStatusCheck,Proc_Cs2Cn_DBHealthCheck,Proc_TempDistributorIncentiveCalculation
--Remove from updater
Proc_Cs2Cn_SalesReturn,Proc_ReturnSalesProductTaxPercentage,Proc_Cn2Cs_SchemeCircularDetails,ParleOutputTaxPercentage_SR,
Proc_ReturnSalesProductTaxPercentage_SR,PROC_SMIncentiveCalculation
*/
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_DebitnoteTopSheetAccess')
DROP FUNCTION Fn_DebitnoteTopSheetAccess
GO
--SELECT DBO.Fn_DebitnoteTopSheetAccess(3) AS AccCtrl
CREATE FUNCTION Fn_DebitnoteTopSheetAccess(@CtrlId AS TINYINT)    
RETURNS VARCHAR(100) 
AS
/************************************************************************************************************************************        
* FUNCTION : Fn_DebitnoteTopSheetAccess        
* PURPOSE : To Access control       
* CREATED : Murugan.R        
* CREATED DATE : 20/09/2019       
* NOTE  :Debit Note Top Sheet        
* MODIFIED         
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
20/09/2019  Murugan.R   BZ		CCRSTPAR0172			Template Access control        
************************************************************************************************************************************/   
BEGIN    
DECLARE @OutputString AS VARCHAR(100)
SET @OutputString='1'
	IF @CtrlId=1
	BEGIN
		--RptId
		SET @OutputString='292'
	END
	ELSE IF  @CtrlId=2
	BEGIN
		--SP Name
		SET @OutputString='Proc_RptDebitNoteTopSheetNewRtm'
	END
	ELSE IF  @CtrlId=3
	BEGIN
		--Access Control
		SET @OutputString='0'
	END 	
RETURN @OutputString  
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaimHd' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaimHd
(
DNRefId			INT NOT NULL,
DNDocNo			NVARCHAR(100) NOT NULL,
ClmDate			DATETIME NOT NULL,
ClmYear			INT NOT NULL,
MonthId			INT NOT NULL,
ClmMonth		NVARCHAR(50)  NOT NULL,
SampAmt			NUMERIC(38,6) NOT NULL,
TradeSchAmt		NUMERIC(38,6) NOT NULL,	
InstTarAmt		NUMERIC(38,6) NOT NULL,
TOTDiffAmt		NUMERIC(38,6) NOT NULL,
ManualClmAmt	NUMERIC(38,6) NOT NULL,
DistIncAmt		NUMERIC(38,6) NOT NULL,
SMIncAmt		NUMERIC(38,6) NOT NULL,
TotalAmt		NUMERIC(38,6) NOT NULL,
DNStatus		INT  NOT NULL  DEFAULT (0),
Upload			NVARCHAR(1) NOT NULL,
Confirm			INT NOT NULL  DEFAULT (0),
ConDocRefNo		NVARCHAR(100)  NULL,
SAPDocRefNo		NVARCHAR(100)  NULL,
ApprovedAmt		NUMERIC(38,6) NOT NULL  DEFAULT (0)  ,
[Availability]	INT NOT NULL,
LastModBy		INT NOT NULL,
LastModDate		DATETIME NOT NULL,
AuthId			INT NOT NULL,
AuthDate		DATETIME NOT NULL,
CONSTRAINT [PK_DebitNoteTopSheetClaimHd_DNRefId] PRIMARY KEY CLUSTERED 
(
	[DNRefId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY],
 
CONSTRAINT [UK_DNDocNo] UNIQUE NONCLUSTERED 
(
	[DNDocNo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
) 
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_Sampling' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_Sampling
(
	DNRefId			INT NOT NULL,
	Slno			INT NOT NULL,
	SancDate		DATETIME NOT NULL,
	FromDate		DATETIME NOT NULL,
	ToDate			DATETIME NOT NULL,
	CirNo			NVARCHAR(100) NOT NULL,
	SamAmt			NUMERIC(38,6) NOT NULL,
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_Sampling_DNRefId')
BEGIN
ALTER TABLE DebitNoteTopSheetClaim_Sampling  WITH NOCHECK ADD  CONSTRAINT [FK_DebitNoteTopSheetClaim_Sampling_DNRefId] FOREIGN KEY(DNRefId)
REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

ALTER TABLE DebitNoteTopSheetClaim_Sampling CHECK CONSTRAINT [FK_DebitNoteTopSheetClaim_Sampling_DNRefId]

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_Trade' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_Trade
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	SchId			INT NOT NULL,
	SchDesc			NVARCHAR(200) NOT NULL,
	FrmDate			DATETIME,
	ToDate			DATETIME,
	CirNo			NVARCHAR(100) NOT NULL,
	SchBudget		NUMERIC(38,6) NOT NULL,
	Lst2MntSAl		NUMERIC(38,6) NOT NULL,
	Wk4PriVal		NUMERIC(38,6) NOT NULL,
	SchPrimary		NUMERIC(38,6) NOT NULL,
	SecSales		NUMERIC(38,6) NOT NULL,
	LaibPer			NUMERIC(38,6) NOT NULL,
	CalClmAmt		NUMERIC(38,6) NOT NULL,	
	OrgClmAmt		NUMERIC(38,6) NOT NULL,
	ApplyCapVal		INT NOT NULL,
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_Trade_DNRefId')
BEGIN
ALTER TABLE DebitNoteTopSheetClaim_Trade  WITH NOCHECK ADD  CONSTRAINT [FK_DebitNoteTopSheetClaim_Trade_DNRefId] FOREIGN KEY(DNRefId)
REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

ALTER TABLE DebitNoteTopSheetClaim_Trade CHECK CONSTRAINT [FK_DebitNoteTopSheetClaim_Trade_DNRefId]

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_InstTarget' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_InstTarget
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	CtgName			NVARCHAR(100) NOT NULL,
	FromDate		DATETIME  NOT NULL,
	ToDate			DATETIME  NOT NULL,	
	CirNo			NVARCHAR(50) NOT NULL,
	MonTarget		NUMERIC(38,6) NOT NULL,	
	Lst2MntSAl		NUMERIC(38,6) NOT NULL,
	CurMonth		NUMERIC(38,6) NOT NULL,
	OutletCnt		INT,
	TotDiscount		NUMERIC(38,6) NOT NULL,
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME = 'SCHTYPE' AND ID = OBJECT_ID ('DebitNoteTopSheetClaim_InstTarget'))
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_InstTarget ADD SCHTYPE INT DEFAULT (0)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_InstTarget_DNRefId')
BEGIN
ALTER TABLE DebitNoteTopSheetClaim_InstTarget  WITH NOCHECK ADD  CONSTRAINT [FK_DebitNoteTopSheetClaim_InstTarget_DNRefId] FOREIGN KEY(DNRefId)
REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

ALTER TABLE DebitNoteTopSheetClaim_InstTarget CHECK CONSTRAINT [FK_DebitNoteTopSheetClaim_InstTarget_DNRefId]

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_TOTDiff' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_TOTDiff
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	CtgName			NVARCHAR(100) NOT NULL,
	FromDate		DATETIME NOT NULL,
	ToDate			DATETIME NOT NULL,
	CirNo			NVARCHAR(100) NOT NULL,
	NrmlAmt			NUMERIC(18,6) NOT NULL,
	TOTAmt			NUMERIC(18,6) NOT NULL,
	DiffAmt			NUMERIC(18,6) NOT NULL, 
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_TOTDiff_DNRefId')
BEGIN
ALTER TABLE DebitNoteTopSheetClaim_TOTDiff  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_TOTDiff_DNRefId FOREIGN KEY(DNRefId)
REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

ALTER TABLE DebitNoteTopSheetClaim_TOTDiff CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_TOTDiff_DNRefId

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_Manual' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_Manual
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	SchDesc			NVARCHAR(100) NOT NULL,
	FromDate		DATETIME NOT NULL,
	ToDate			DATETIME NOT NULL,
	CirNo			NVARCHAR(100) NOT NULL,
	SchBudget		NUMERIC(18,6) NOT NULL,
	SecSales		NUMERIC(18,6) NOT NULL,
	LiabPerc		NUMERIC(18,6) NOT NULL,
	ClmAmt			NUMERIC(18,6) NOT NULL,
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_Manual_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_Manual  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_Manual_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_Manual CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_Manual_DNRefId
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_DistInc' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_DistInc
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	RefNo			NVARCHAR(100) NOT NULL,
	SMCnt			INT NOT NULL,
	CirNo			NVARCHAR(100) NOT NULL,
	TotAchSales		NUMERIC(18,6) NOT NULL,
	IncAmt			NUMERIC(18,6) NOT NULL, 
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_DistInc_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_DistInc  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_DistInc_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_DistInc CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_DistInc_DNRefId
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_SMInc' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_SMInc
(
	DNRefId			INT,
	Slno			INT NOT NULL,
	RefNo			NVARCHAR(100) NOT NULL,
	SMName			NVARCHAR(100) NOT NULL,
	CirNo			NVARCHAR(100) NOT NULL,
	TotAchSales		NUMERIC(18,6) NOT NULL,
	FrmRange		NUMERIC(18,4) NOT NULL,
	ToRange			NUMERIC(18,4) NOT NULL,
	FixedPay		NUMERIC(18,6) NOT NULL,
	VarPay			NUMERIC(18,6) NOT NULL,
	IncAmount		NUMERIC(18,6) NOT NULL,
	SMID			INT,
	[Availability]  INT NOT NULL,
	LastModBy		INT NOT NULL,
	LastModDate		DATETIME NULL,
	AuthId			INT NOT NULL,
	AuthDate		DATETIME NULL

)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_SMInc_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_SMInc  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_SMInc_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_SMInc CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_SMInc_DNRefId
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_Trade_PrdWise' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_Trade_PrdWise
(
	DnRefId			INT NOT NULL,
	SchId			INT NOT NULL,
	SlabId			INT NULL,
	Salid			INT NULL,	 
	FlatAmount		NUMERIC(38,6) NOT NULL,
	DiscountPer		NUMERIC(38,6) NOT NULL,
	BudgetUtilized	NUMERIC(38,6) NOT NULL,
	Linetype		INT NOT NULL,
	Salinvdate		DATETIME NOT NULL,
	Prdid			INT  NOT NULL,
	TaxPer			NUMERIC(38,2)  NOT NULL,
	SchAmtWithTax	NUMERIC(38,6) NOT NULL,
	CreatedDate		DATETIME
)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_Trade_PrdWise_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_Trade_PrdWise  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_Trade_PrdWise_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_Trade_PrdWise CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_Trade_PrdWise_DNRefId
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_TOT_PrdWise' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_TOT_PrdWise
(
	DnRefId			INT NOT NULL,
	Rtrid			INT NOT NULL,
	Prdid			INT NOT NULL,
	NrmlRate		NUMERIC(38,2) NOT NULL,
	SplRate			NUMERIC(38,2) NOT NULL,
	Diff			NUMERIC(38,2) NOT NULL,
	CreatedDate		DATETIME
)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_TOT_PrdWise_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_TOT_PrdWise  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_TOT_PrdWise_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_TOT_PrdWise CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_TOT_PrdWise_DNRefId
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DebitNoteTopSheetClaim_Inst_PrdWise' AND TYPE='U')
BEGIN
CREATE TABLE DebitNoteTopSheetClaim_Inst_PrdWise
(
	DnRefId			INT NOT NULL,
	Rtrid			INT NOT NULL,
	Schid			INT NULL,
	Prdid			INT NULL,	 
	CtgMainId		INT NULL,
	ClmAmt			NUMERIC(38,6) NOT NULL, 
	CreatedDate		DATETIME
)
END
GO
IF NOT EXISTS (SELECT * FROM SYS.foreign_keys WHERE NAME ='FK_DebitNoteTopSheetClaim_Inst_PrdWise_DNRefId')
BEGIN
	ALTER TABLE DebitNoteTopSheetClaim_Inst_PrdWise  WITH NOCHECK ADD  CONSTRAINT FK_DebitNoteTopSheetClaim_Inst_PrdWise_DNRefId FOREIGN KEY(DNRefId)
	REFERENCES DebitNoteTopSheetClaimHd (DNRefId)

	ALTER TABLE DebitNoteTopSheetClaim_Inst_PrdWise CHECK CONSTRAINT FK_DebitNoteTopSheetClaim_Inst_PrdWise_DNRefId
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='FN' AND NAME='Fn_DebitnoteTopSheetAccess_New')
DROP FUNCTION Fn_DebitnoteTopSheetAccess_New
GO
--SELECT DBO.Fn_DebitnoteTopSheetAccess(3) AS AccCtrl
CREATE FUNCTION Fn_DebitnoteTopSheetAccess_New(@CtrlId AS TINYINT)    
RETURNS VARCHAR(100) 
AS
/************************************************************************************************************************************        
* FUNCTION : Fn_DebitnoteTopSheetAccess        
* PURPOSE : To Access control       
* CREATED : Murugan.R        
* CREATED DATE : 20/09/2019       
* NOTE  :Debit Note Top Sheet        
* MODIFIED         
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
20/09/2019  Murugan.R   BZ		CCRSTPAR0172			Template Access control        
************************************************************************************************************************************/   
BEGIN    
DECLARE @OutputString AS VARCHAR(100)
SET @OutputString='1'
	IF @CtrlId=1
	BEGIN
		--RptId
		SET @OutputString='293'
	END
	ELSE IF  @CtrlId=2
	BEGIN
		--SP Name
		SET @OutputString='Proc_RptDebitNoteTopSheet_Rtm'
	END
	ELSE IF  @CtrlId=3
	BEGIN
		--Access Control
		SET @OutputString='0'
	END 	
RETURN @OutputString  
END
GO
IF EXISTS(SELECT '*' FROM SYSOBJECTS WHERE NAME='RptDebitNoteHeaderColumns' AND xtype='U')
DROP TABLE RptDebitNoteHeaderColumns
GO
CREATE TABLE RptDebitNoteHeaderColumns(
 FromDate VARCHAR(200),
 ToDate VARCHAR(20),
 SamplingAmount VARCHAR(200),
 GrandTotal VARCHAR(200),
 DebitNoteNo VARCHAR(200),
 Town VARCHAR(200),
 WholeSalerName VARCHAR(200),
 WholeSalerCode VARCHAR(200),
 ConsoleDocNO	VARCHAR(100),
 SapDocNO		VARCHAR(100)
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptDebitNoteTopSheetNewRtm' AND TYPE ='P') 
DROP PROCEDURE Proc_RptDebitNoteTopSheetNewRtm
GO
/*    
BEGIN TRAN    
EXEC Proc_RptDebitNoteTopSheetNewRtrm 292,2,0,'',0,0,1        
SELECT * FROM RptDebitNoteTopSheet_Excel1        
SELECT * FROM RptDebitNoteTopSheet_Excel2     
SELECT * FROM RptDebitNoteTopSheet_Excel3     
SELECT * FROM RptDebitNoteTopSheet_Excel6WID    
SELECT * FROM RptDebitNoteTopSheet_Excel_GrandTotal    
ROLLBACK TRAN        
*/    
CREATE PROCEDURE Proc_RptDebitNoteTopSheetNewRtm    
(        
 @Pi_RptId   INT,        
 @Pi_UsrId   INT,        
 @Pi_SnapId   INT,        
 @Pi_DbName   NVARCHAR(50),        
 @Pi_SnapRequired INT,@Pi_GetFromSnap  INT,        
 @Pi_CurrencyId  INT        
)        
AS        
/************************************************************************************************************************************        
* PROCEDURE : Proc_RptDebitNoteTopSheetNew        
* PURPOSE : Debit Note Top Sheet in Crystal format    
* CREATED : S.MOORTHI       
* CREATED DATE :03-05-2019        
* NOTE  : Parle SP for Debit Note Top Sheet        
* MODIFIED         
*************************************************************************************************************************************        
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
03-05-2019  S.MOORTHI    SR      ILCRSTPAR4278       Debit note sheet report (Design in Crystal Reports)    
21-06-2019  S.MOORTHI    CR      CRCRSTPAR0056       STO(Service to Outlet) or Distributor incentive logic to be incorporated and debit note should upload to console    
17-07-2019 S.MOHANA      CR      ILCRSTPAR5199       INCLUDED NEW SUB REPORT -- SMINCENTIVE DETAILS    
10-08-2019  Lakshman M   BZ      ILCRSTPAR5500       Sub reports some table data not available that time report showing no record fiund.    
************************************************************************************************************************************/             
BEGIN        
 SET NOCOUNT ON        
 DECLARE @FromDate   AS DATETIME        
 DECLARE @ToDate    AS DATETIME        
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)        
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)        
 --Report 1        
 DECLARE @CityName AS NVARCHAR(100)        
 DECLARE @DistributorCode AS NVARCHAR(40)        
 DECLARE @DistributorName AS NVARCHAR(100)        
 DECLARE @DBMonth As INT        
 SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,        
 @CityName = G.GeoName        
 FROM Distributor D (NOLOCK),        
 Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId        
 --Added By Mohana         
 --SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate        
 SELECT @DBMonth = CASE MONTH (@ToDate)         
  WHEN 4 THEN 1        
  WHEN 5 THEN 2        
  WHEN 6 THEN 3        
  WHEN 7 THEN 4        
  WHEN 8 THEN 5        
  WHEN 9 THEN 6        
  WHEN 10 THEN 7        
  WHEN 11 THEN 8        
  WHEN 12 THEN 9        
  WHEN 1 THEN 10        
  WHEN 2 THEN 11        
  WHEN 3 THEN 12        
 END         
 --Report 1        
 --Report 2        
 DECLARE @slno AS INT        
 DECLARE @SamplingAmount AS NUMERIC(18,2)        
 SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'        
 --- Change by Amuthakumar P ILCRSTPAR1917        
 SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)        
 FROM FreeIssueHd J (NOLOCK),        
 FreeIssueDt D (NOLOCK),        
 ProductBatchDetails P (NOLOCK)        
 WHERE J.IssueId = D.IssueId         
 AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId         
 AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate        
 --Report 2        
 DELETE FROM REPORTFILTERDT WHERE RPTID=291    
 INSERT INTO REPORTFILTERDT(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)    
 SELECT 291,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate from ReportFilterDt WHERE RptId=@Pi_RptId    
     EXEC Proc_RptDebitNoteTopSheet  @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId    
 ---ILCRSTPAR4278     
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel1WID    
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel2WID    
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel3WID    
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel4WID    
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel5WID    
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel6WID    
 INSERT INTO RptDebitNoteTopSheet_Excel1WID([Scheme Description],[From],[To],[Circular No],    
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],SubLinkId)    
 SELECT [Scheme Description],[From],[To],[Circular No],    
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],@DBMonth FROM RptDebitNoteTopSheet_Excel1(NOLOCK)    
 WHERE [Scheme Description]<>'Total'    
 DELETE FROM RPTFORMULA WHERE RptId=@Pi_RptId    
 INSERT INTO RPTFORMULA([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId])     
 SELECT @Pi_RptId,1,'SamplingAmount','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),1,0 UNION    
 SELECT @Pi_RptId,2,'From','From : ' + CONVERT(VARCHAR(11),@FromDate,105) ,1,0 UNION    
 SELECT @Pi_RptId,3,'To','To : ' + CONVERT(VARCHAR(11),@ToDate,105),1,0 UNION    
 SELECT @Pi_RptId,4,'Heading1','PARLE - DEBIT NOTE / CREDIT NOTE' ,1,0 UNION    
 SELECT @Pi_RptId,5,'WholesalerName','Name of the Wholesaler : ' + ISNULL(@DistributorName,'') ,1,0 UNION    
 SELECT @Pi_RptId,6,'Town','Name of the Town : ' + ISNULL(@CityName,'') ,1,0 UNION    
 SELECT @Pi_RptId,7,'DebitNoteNo','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)  ,1,0 UNION    
 SELECT @Pi_RptId,8,'WholesalerCode','Wholesaler Code : ' + ISNULL(@DistributorCode,'') ,1,0 UNION    
 SELECT @Pi_RptId,9,'ProductSampled','Product Sampled during the period  '  ,1,0  UNION    
 SELECT top 1 @Pi_RptId,10,'GrandTotal',CONVERT(NVARCHAR(10),Column6)  ,1,0 from RptDebitNoteTopSheet_Excel_GrandTotal(NOLOCK)     
 
 DELETE FROM RptDebitNoteHeaderColumns
 INSERT INTO RptDebitNoteHeaderColumns(FromDate,ToDate,SamplingAmount,GrandTotal,DebitNoteNo,Town,
 WholeSalerName,WholeSalerCode)   
 SELECT top 1 'From : ' + CONVERT(VARCHAR(11),@FromDate,105),'To : ' + CONVERT(VARCHAR(11),@ToDate,105),
 'Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),CONVERT(NVARCHAR(10),Column6),
 'Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth),
 'Name of the Town : ' + ISNULL(@CityName,''),
 'Name of the Wholesaler : ' + ISNULL(@DistributorName,''),
 'Wholesaler Code : ' + ISNULL(@DistributorCode,'') from RptDebitNoteTopSheet_Excel_GrandTotal(NOLOCK)      
 
 INSERT INTO RptDebitNoteTopSheet_Excel2WID([Name Of the Category],[From],[TO],[Circular No],[Monthly Target],    
 [Last 2 Mont Avg Sal],[Current Month],[No of Incent Outlets],[Total Discount Amount],SubLinkId)    
 SELECT [Name Of the Category],[From],[TO],[Circular No],[Monthly Target],    
 [Last 2 Mont Avg Sal],[Current Month],[No of Incent Outlets],[Total Discount Amount],@DBMonth FROM RptDebitNoteTopSheet_Excel2(NOLOCK)    
 WHERE [Name Of the Category]<>'Total'    
 INSERT INTO RptDebitNoteTopSheet_Excel3WID([Name Of the Category],[From],[TO],[Total Normal Amount],    
 [Total Normal Sec Sales AS Per TOT],[TOT Diff claims],SubLinkId)    
 SELECT [Name Of the Category],[From],[TO],[Total Normal Amount],    
 [Total Normal Sec Sales AS Per TOT],[TOT Diff claims],@DBMonth FROM RptDebitNoteTopSheet_Excel3(NOLOCK)    
 WHERE [Name Of the Category]<>'Total'    
 INSERT INTO RptDebitNoteTopSheet_Excel4WID([Scheme Description],[From],[TO],[Circular No],[Scheme Budget],    
 [Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],SubLinkId)    
 SELECT [Scheme Description],[From],[TO],[Circular No],[Scheme Budget],[Sec Sales Value],    
 [% Lib on Sec Sales],[Claim Amount],@DBMonth SubLinkId FROM RptDebitNoteTopSheet_Excel4(NOLOCK)    
 WHERE [Scheme Description]<>'Total'    
 INSERT INTO RptDebitNoteTopSheet_Excel5WID([Dist. Incentive Ref. No.],    
 [No of Salesman],[Total Sales Value],[Incentive Amount],SubLinkId)    
 SELECT [Dist. Incentive Ref. No.],[No of Salesman],[Total Sales Value],[Incentive Amount],@DBMonth SubLinkId       
 FROM RptDebitNoteTopSheet_Excel5  (NOLOCK)    
 WHERE [Dist. Incentive Ref. No.]<>'Total'     
 INSERT INTO RptDebitNoteTopSheet_Excel6WID(SMIRefNo,IncMonth,IncYear,SMName,TotalAchSales,[From Range],[To Range],FixedPay,    
 VariablePay,IncPerc,IncAmount,[Total Incentive Amount],SubLinkId )    
 SELECT SMIRefNo,IncMonth,IncYear,SMName,TotalAchSales,[From Range],[To Range],FixedPay,    
 VariablePay,IncPerc,IncAmount,[Total Incentive Amount],@DBMonth SubLinkId    
 FROM RptDebitNoteTopSheet_Excel6 (NOLOCK)    
 WHERE SMIRefNo<>'Total'     
 ---------------- Added  By Lakshman M Dated On 10-08-2019 PMS ID: ILCRSTPAR5448      
 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId      
 IF NOT exists(SELECT * FROM RptDebitNoteTopSheet_Excel1WID)    
 BEGIN    
  SELECT MAX(RecCount ) RecCount INTO #temp  FROM (    
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel1WID(NOLOCK)    
  union all     
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel2WID(NOLOCK)    
  union all     
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel3WID(NOLOCK)    
  union all     
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel4WID(NOLOCK)    
  union all     
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel5WID(NOLOCK)    
  union all     
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel6WID(NOLOCK)    
  ) A  
 END 

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteTopSheet_Excel2WID)
BEGIN 
INSERT INTO RptDebitNoteTopSheet_Excel2WID([Name Of the Category],[From],[TO],[Circular No],[Monthly Target],
[Last 2 Mont Avg Sal],[Current Month],[No of Incent Outlets],[Total Discount Amount],SubLinkId)
SELECT '','','','',0,0,0,0,0,5
END 

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteTopSheet_Excel3WID)
BEGIN 
INSERT INTO RptDebitNoteTopSheet_Excel3WID([Name Of the Category],[From],[TO],
[Total Normal Amount],[Total Normal Sec Sales AS Per TOT],[TOT Diff claims],SubLinkId)
SELECT '','','',0,0,0,5
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteTopSheet_Excel4WID)
BEGIN 
INSERT INTO RptDebitNoteTopSheet_Excel4WID([Scheme Description],
[From],[TO],[Circular No],[Scheme Budget],[Sec Sales Value],[% Lib on Sec Sales],
[Claim Amount],SubLinkId)
SELECT '',convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'',0,0,0,0,5
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteTopSheet_Excel5WID)
BEGIN 
INSERT INTO RptDebitNoteTopSheet_Excel5WID([Dist. Incentive Ref. No.],[No of Salesman],[Total Sales Value],[Incentive Amount],[SubLinkId])
SELECT '',0,0,0,5 
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteTopSheet_Excel6WID)
BEGIN 
INSERT INTO RptDebitNoteTopSheet_Excel6WID(SMIRefNo,IncMonth,IncYear,SMName,TotalAchSales,[From Range],[To Range],FixedPay,VariablePay,
IncPerc,IncAmount,[Total Incentive Amount],SubLinkId)
SELECT '','', 0,'',0,0,0,0,0,
0,0,0,5
END

    
 IF NOT EXISTS(SELECT * FROM RptDebitNoteTopSheet_Excel1WID)    
 BEGIN
	INSERT INTO RptDebitNoteTopSheet_Excel1WID    
	SELECT '','2019-01-01','2019-01-01','','',0.00,0,0.00,0.00,0.00,RecCount FROM #temp 
     
  --INSERT INTO RptDebitNoteTopSheet_Excel1WID    
  --SELECT '','2019-01-01','2019-01-01','','',cast(0 as varchar(10)),'',cast(0 as varchar(10)),cast(0 as varchar(10)),cast(0 as varchar(10)),6 FROM #temp 
  --UNION ALL
  --SELECT 'ABFDDFDCD','','','','',cast(0 as varchar(10)),'',cast(0 as varchar(10)),cast(0 as varchar(10)),cast(0 as varchar(10)),5 FROM #temp   
 END    
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)     
 SELECT  @Pi_RptId, COUNT(*) ,0 ErrNo , @Pi_UsrId FROM RptDebitNoteTopSheet_Excel1WID    
 SELECT * FROM RptDebitNoteTopSheet_Excel1WID    
 ---ILCRSTPAR4278    
 RETURN         
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ValidateSaveUDC' AND XTYPE IN('FN','TN'))
DROP FUNCTION Fn_ValidateSaveUDC
GO
--SELECT dbo.Fn_ValidateSaveUDC(79,446,2,'GSTIN','11GPKPM5222K1G5')
CREATE FUNCTION Fn_ValidateSaveUDC(@TransId as INT,@RtrId as BIGINT,@MasterId AS INT,@ColumnName AS VARCHAR(200),@ColumnValue AS VARCHAR(200))
RETURNS VARCHAR(200)
AS
/*********************************
* PROCEDURE		: Fn_ValidateSaveUDC
* PURPOSE		: To Validate UDC 
* CREATED		: S.Moorthi
* CREATED DATE	: 11-05-2017
* MODIFIED
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
15/10/2019  Lakshman   BZ		ILCRSTPAR6197			PAN number & GSTIN No Allow duplicate
*********************************/
BEGIN
	DECLARE @ValMsg AS VARCHAR(200)
	SET @ValMsg=''
	
	IF NOT EXISTS(SELECT * FROM GSTConfiguration (NOLOCK) 
	WHERE ModuleId='GSTCONFIG' and ActivationStatus=1 and 
	ConsoleAckStatus=1)
	BEGIN
		RETURN @ValMsg
	END 
	
	IF @ColumnValue=''
	BEGIN
		SET @ColumnValue='NULL'
	END
	
	IF @TransId=41
	BEGIN
		IF EXISTS(SELECT b.* FROM Retailer A (NOLOCK)
		INNER JOIN UdcDetails B(NOLOCK) ON A.RtrId=B.MasterRecordId 
		INNER JOIN UdcMaster C(NOLOCK) ON C.MasterId=B.MasterId AND C.UdcMasterId=B.UdcMasterId
		WHERE C.ColumnName='Retailer Type' and UPPER(B.ColumnValue)='REGISTERED' AND C.MasteriD=2)
		BEGIN
			IF @ColumnValue='NULL'
			BEGIN
				SET @ColumnValue=''
			END
		END
	END
	
	IF @TransId in (79,41)
	BEGIN
	
	IF @TransId=41  ----Gopi at 25/06/2017 GST10
	 BEGIN
	  IF EXISTS(SELECT b.* FROM Retailer A (NOLOCK)
		INNER JOIN UdcDetails B(NOLOCK) ON A.RtrId=B.MasterRecordId 
		INNER JOIN UdcMaster C(NOLOCK) ON C.MasterId=B.MasterId AND C.UdcMasterId=B.UdcMasterId
		WHERE A.Rtrid=@Rtrid and C.ColumnName='Retailer Type' and UPPER(B.ColumnValue)='UNREGISTERED' AND C.MasteriD=2)
		BEGIN
		   RETURN @ValMsg
		END
	  END  ---Till Here 
		
		IF UPPER(@ColumnName)='GSTIN'
		BEGIN
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColumnValue,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISGSTINNumber(@ColumnValue))=1
				BEGIN					
					SET @ValMsg='Invalid GST Tin Number'					
				END
			END
		END
		
		IF @ColumnName='PAN Number'
		BEGIN	
			IF RTRIM(LTRIM(UPPER(ISNULL(@ColumnValue,'NULL'))))<>'NULL'
			BEGIN
				IF (SELECT DBO.Fn_ISPanNumber(@ColumnValue))=1
				BEGIN
					SET @ValMsg='Invalid Pan Number'
				END
				
			END
		END
		--IF @ColumnName='GSTIN' or @ColumnName='PAN Number'
		--BEGIN
		--	IF ISNULL(@ColumnValue,'')<>'' AND ISNULL(@ColumnValue,'NULL')<>'NULL'
		--	BEGIN
		--		IF EXISTS(SELECT UD.* FROM UdcHD A (NOLOCK)
		--			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
		--			INNER JOIN UdcDetails UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId 
		--			INNER JOIN Retailer R (NOLOCK) ON R.RtrId=UD.MasterRecordId 
		--			WHERE A.MasterId=@MasterId AND B.ColumnName=@ColumnName and ISNULL(ColumnValue,'')<>''
		--			AND R.RtrId<>@RtrId and ColumnValue=@ColumnValue)
		--		BEGIN
		--			SET @ValMsg='Duplicate '+ @ColumnName +' Not Allow'
		--		END
		--	END
		--END
	END
	
RETURN @ValMsg
END
GO
IF EXISTS(select * from RptGroup where rptid = 206 AND visibility =1)
BEGIN
	update a set visibility =0 from RptGroup A where rptid = 206 
END
GO
IF EXISTS(select * from rptgridview where rptid = 165 AND ExcelView = 0)
BEGIN
	update a set ExcelView = 1 from rptgridview A where rptid = 165
END
GO
DELETE FROM RptExcelHeaders WHERE RptId =165
INSERT INTO RptExcelHeaders
SELECT 165,1,'smid','Smid',0,1 UNION ALL
SELECT 165,2,'SmName','SalesMan Name',1,1 UNION ALL
SELECT 165,3,'Rmid','Rmid',0,1 UNION ALL
SELECT 165,4,'Rmcode','Route code',1,1 UNION ALL
SELECT 165,5,'Rtrid','Rtrid',0,1 UNION ALL
SELECT 165,6,'Rtrcode','Retailer code',1,1 UNION ALL
SELECT 165,7,'RtrName','Retailer Name',1,1 UNION ALL
SELECT 165,8,'RtrShipAdd1','RtrShipAdd1',1,1 UNION ALL
SELECT 165,9,'RtrShipAdd2','RtrShipAdd2',1,1 UNION ALL
SELECT 165,10,'RtrShipAdd3','RtrShipAdd3',1,1 UNION ALL
SELECT 165,11,'SalId','SalId',0,1 UNION ALL
SELECT 165,12,'SalInvNo','SalInvNo',1,1 UNION ALL
SELECT 165,13,'SalInvDate','SalInvDate',1,1 UNION ALL
SELECT 165,14,'SalInvRef','SalInvRef',1,1 UNION ALL
SELECT 165,15,'BillAmount','BillAmount',1,1 UNION ALL
SELECT 165,16,'CollectedAmount','CollectedAmount',1,1 UNION ALL
SELECT 165,17,'BalanceAmount','BalanceAmount',1,1 UNION ALL
SELECT 165,18,'ArDays','ArDays',1,1
GO
IF EXISTS(select * from RptGroup where rptid = 1 AND visibility =1)
BEGIN
	update a set visibility =0 from RptGroup A where rptid = 1
END
GO
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 2
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 25
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 26
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 27
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 28
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 29
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 232
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 250
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 253
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 256
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 276
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 277
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 278
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 279
UPDATE A SET VISIBILITY =0 FROM RPTGROUP A WHERE RPTID = 280
update a set visibility =0 from RptGroup A where rptid = 247
update a set visibility =0 from RptGroup A where rptid = 287
update a set visibility =0 from RptGroup A where rptid = 152
update a set visibility =0 from RptGroup A where rptid = 215
GO
---------- Added by Mohana.S Dated On 12-10-2019. PMS ID: ILCRSTPAR6289
UPDATE Gst_FieldLevelConfiguration SET EnableSts = 1 WHere Ctrlid=7
GO
UPDATE A SET BTNSTATUS =0  FROM PROFILEDT A WHERE MENUID ='mCmp5' AND BtnIndex <>7
GO
UPDATE A SET BTNSTATUS =0  FROM PROFILEDT A WHERE Menuid IN('mClm9','mClm19','mClm169','mClm8')
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_YEGetOpenTrans' AND TYPE ='P')
DROP PROCEDURE Proc_YEGetOpenTrans
GO
--EXEC Proc_YEGetOpenTrans '2008-04-01','2009-03-31'
--SELECT * FROM YearEndOpenTrans
CREATE PROCEDURE Proc_YEGetOpenTrans
(
	@Pi_FromDate 		DATETIME,
	@Pi_ToDate		    DATETIME,
	@Pi_UsrId           INT
)
AS
/*********************************
* PROCEDURE	: Proc_YEGetOpenTrans
* PURPOSE	: To get the Open transactions for Year End
* CREATED	: Nandakumar R.G
* CREATED DATE	: 09/03/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
*************************************************************************************************************************************        
* DATE		AUTHOR		CR/BZ   USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
15/10/2019  Lakshman   BZ		ILCRSTPAR6197			Year End skip Purchase Process
*********************************/
SET NOCOUNT ON
BEGIN
	TRUNCATE TABLE YearEndOpenTrans
	TRUNCATE TABLE YearEndLog
	---------- commented by lakshma M Dated ON 04/10/2019 PMS ID: ILCRSTPAR6197-----------
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 1,'mCmp9','Purchase','PurchaseReceipt',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM PurchaseReceipt
	--WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 1,'Purchase',PurRcptRefNo
	--FROM PurchaseReceipt
	--WHERE Status=0 AND GoodsRcvdDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 2,'mCmp11','Purchase Return','PurchaseReturn',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 2,'Purchase Return',PurRetRefNo
	--FROM PurchaseReturn
	--WHERE Status=0 AND PurRetDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	-----------------Till here ----------------------
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 3,'mCmp12','Return To Company','ReturnToCompany',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 3,'Return To Company',RtnCmpRefNo
	FROM ReturnToCompany
	WHERE Status=0 AND RtnCmpDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 4,'mInv4','Stock Management','StockManagement',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 4,'Stock Management',StkMngRefNo
	FROM StockManagement
	WHERE Status=0 AND StkMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 5,'mInv7','Salvage','Salvage',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 5,'Salvage',SalvageRefNo
	FROM Salvage
	WHERE Status=0 AND SalvageDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 6,'mCus18','Billing','SalesInvoice',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 6,'Billing',SalInvNo
	FROM SalesInvoice
	WHERE DlvSts NOT IN(5,3,4) AND SalInvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--->Added By Nanda on 15/03/2011
--	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
--	SELECT 7,'Sales Return','ReturnHeader',ISNULL(COUNT(*),0),0
--	FROM ReturnHeader
--	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
--	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
--	SELECT 7,'Sales Return',ReturnCode
--	FROM ReturnHeader
--	WHERE Status=1 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 7,'mCus20','Sales Return','Sales Return',A.Counts+B.Counts,@Pi_UsrId
	FROM 
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader
		WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) A	,
	(
		SELECT ISNULL(COUNT(*),0) AS Counts 
		FROM ReturnHeader RH,SalesInvoice SI
		WHERE RH.Status=1 AND RH.ReturnType=1 
		AND RH.SalId=SI.SalId AND SI.DlvSts<3
		AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	) B
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader
	WHERE Status=1 AND ReturnType=2 AND ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 7,'Sales Return',ReturnCode
	FROM ReturnHeader RH,SalesInvoice SI
	WHERE RH.Status=1 AND RH.ReturnType=1 AND RH.SalId=SI.SalId AND SI.DlvSts<3
	AND RH.ReturnDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--->Till Here
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 8,'mCus23','Resell Damage Goods','ResellDamageMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 8,'Resell Damage Goods',ReDamRefNo
	FROM ResellDamageMaster
	WHERE Status=0 AND ReSellDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 9,'mClm6','Salesman Salary And DA Claim','SalesmanClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 9,'Salesman Salary And DA Claim',ScmRefNo
	FROM SalesmanClaimMaster
	WHERE Status=0 AND ScmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 10,'mClm7','Delivery Boy Salary And DA Claim','DeliveryBoyClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 10,'Delivery Boy Salary And DA Claim',DbcRefNo
	FROM DeliveryBoyClaimMaster
	WHERE Status=0 AND DbcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 11,'mClm5','Salesman Incentive Calculator','SMIncentiveCalculatorMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 11,'Salesman Incentive Calculator',SicRefNo
	FROM SMIncentiveCalculatorMaster
	WHERE Status=0 AND SicDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 12,'mClm13','Van Subsidy Claim','VanSubsidyHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 12,'Van Subsidy Claim',RefNo
	FROM VanSubsidyHD
	WHERE [Confirm]=0 AND SubsidyDt BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 13,'mClm11','Transporter Claim','TransporterClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 13,'Transporter Claim',TrcRefNo
	FROM TransporterClaimMaster
	WHERE Status=0 AND TrcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 14,'mClm4','Special Discount Claim','SpecialDiscountMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 14,'Special Discount Claim',SdcRefNo
	FROM SpecialDiscountMaster
	WHERE Status=0 AND SdcDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 15,'mClm8','Rate Difference Claim','RateDifferenceClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 15,'Rate Difference Claim',RefNo
	FROM RateDifferenceClaim
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 16,'mClm9','Purchase Shortage Claim','PurShortageClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 16,'Purchase Shortage Claim',PurShortRefNo
	FROM PurShortageClaim
	WHERE Status=0 AND ClaimDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 17,'mClm10','Purchase Excess Claim','PurchaseExcessClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 17,'Purchase Excess Claim',RefNo
	FROM PurchaseExcessClaimMaster
	WHERE Status=0 AND [Date] BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 18,'mClm3','Manual Claim','ManualClaimMaster',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 18,'Manual Claim',MacRefNo
	FROM ManualClaimMaster
	WHERE Status=0 AND MacDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 19,'mClm16','VAT Claim','VatTaxClaim',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 19,'VAT Claim',SvatNo
	FROM VatTaxClaim
	WHERE Status=0 AND VatDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	--SELECT 20,'Claim Top Sheet','ClaimSheetHD',ISNULL(COUNT(*),0),@Pi_UsrId
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	--INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	--SELECT 20,'Claim Top Sheet',ClmCode
	--FROM ClaimSheetHD
	--WHERE [Confirm]=0 --AND ClmDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 21,'mClm15','Spent and Received','SpentReceivedHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 21,'Spent and Received',SRDRefNo
	FROM SpentReceivedHD
	WHERE Status=0 AND SRDDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 22,'mCus29','Point Redemption Product','PntRetSchemeHD',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 22,'Point Redemption Product',PntRedRefNo
	FROM PntRetSchemeHD
	WHERE Status=0 AND TransDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)	
	SELECT 23,'mCus34','Coupon Redemption','CouponRedHd',ISNULL(COUNT(*),0),@Pi_UsrId
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate
	INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
	SELECT 23,'Coupon Redemption',CpnRedCode
	FROM CouponRedHd
	WHERE Status=0 AND CpnRedDate BETWEEN @Pi_FromDate AND @Pi_ToDate	
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 25,'mCmp18','IDT Management','IDTManagement',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM IDTManagement WITH(NOLOCK) WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate    
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 25,'IDT Management',IDTMngRefNo FROM IDTManagement WITH(NOLOCK) 
    WHERE Status = 0 AND IDTMngDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 26,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SampleIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 26,'Sample Issue',IssueRefNo FROM SampleIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 27,'mCus36','Sample Issue','SampleIssue',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM FreeIssueHd WITH(NOLOCK) WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 27,'Sample Issue',IssueRefNo FROM FreeIssueHd WITH(NOLOCK) 
    WHERE Status = 0 AND IssueDate BETWEEN @Pi_FromDate AND @Pi_ToDate 
    INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	SELECT 28,'mCus36','Sample Receipt','SampleReceipt',ISNULL(COUNT(*),0),@Pi_UsrId
    FROM SamplePurchaseReceipt WITH(NOLOCK) WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
    INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
    SELECT 28,'Sample Receipt',PurRcptRefNo FROM SamplePurchaseReceipt WITH(NOLOCK) 
    WHERE Status = 0 AND InvDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 --   INSERT INTO YearEndOpenTrans(SlNo,MenuId,ScreenName,TabName,OpenTrans,UsrId)
	--SELECT 29,'mInv6','Batch Transfer','BatchTransfer',ISNULL(COUNT(*),0),@Pi_UsrId
 --   FROM BatchTransferHD WITH(NOLOCK) WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate
 --   INSERT INTO YearEndLog(SlNo,ScreenName,RefNo)
 --   SELECT 29,'Batch Transfer',BatRefNo FROM BatchTransferHD WITH(NOLOCK) 
 --   WHERE Status = 0 AND BatTrfDate BETWEEN @Pi_FromDate AND @Pi_ToDate              
END
GO
---------- Added by Mohana.S Dated On 12-10-2019. PMS ID: ILCRSTPAR6289
UPDATE Gst_FieldLevelConfiguration SET EnableSts = 1 WHere Ctrlid=7
GO
UPDATE A SET BTNSTATUS =0  FROM PROFILEDT A WHERE MENUID ='mCmp5' AND BtnIndex <>7
GO
UPDATE A SET BTNSTATUS =0  FROM PROFILEDT A WHERE Menuid IN('mClm9','mClm19','mClm169','mClm8')
GO
SELECT Prdid,Max(Prdbatid) Prdbatid INTO #LatestBatch FROM ProductBatch  GROUP BY prdid 

UPDATE A SET  A.Status = 1  FROM ProductBatch A INNER JOIN #LatestBatch B ON A.Prdbatid  <> B.Prdbatid  AND A.Prdid =B.Prdid 
INNER JOIN ProductBatchLocation C ON A.Prdbatid  = C.Prdbatid  AND A.Prdid =C.Prdid 
AND   C.Prdid =B.Prdid AND (PrdBatLcnSih+PrdBatLcnUih+PrdBatLcnFre+PrdBatLcnRessih+PrdBatLcnResUih+PrdBatLcnResFre)=0
GO
IF EXISTS (SELECT * FROM SysObjects WHERE NAME='Proc_RptChainWiseBillDetails_withTax' AND TYPE='P')
DROP PROCEDURE Proc_RptChainWiseBillDetails_withTax
GO
/*
BEGIN TRAN
EXEC Proc_RptChainWiseBillDetails_withTax 288,1,0,'PARLE_CR',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptChainWiseBillDetails_withTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/***********************************************************************************************************************************
* PROCEDURE	: Proc_RptChainWiseBillDetails_withTax
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE : 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
************************************************************************************************************************************
* DATE        AUTHOR			CR/BZ		USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi			CR			ICRSTPAR7049		1. Chain lending rate should display the net rate in billing screen
																2. Bill number column should be after the party name column 
************************************************************************************************************************************												  
 19-12-2017   S.Mohana			CR			ICRSTPAR7049		3. Added SubTotal in Excel 
************************************************************************************************************************************
 23-12-2017	  S.MOHANA			SR			ICRSTPAR7809		1.INCLUDED SALES RETURN
																2.REMOVED TAX CALCULATION
																3.ADDED RATE-SCHEMEDISCOUNT , GRANDTOTAL
************************************************************************************************************************************
 26-03-2018	  S.MOHANA			 CR			CCRSTPAR0186		Retailer Wise Sub Total Included. 
 12-07-2018   Lakshman M		 BZ         ILCRSTPAR1325       negative values validataion added from core stocky.
 17-09-2018   Amuthakumar P		 CR			CRCRSTPAR0021		Promotion claim should be calculating with tax
 09-10-2018   Mohana S		     BZ		    ILCRSTPAR2313	    TAX CALCULATION CHANGED AS PER CLIENT REQUEST
 14-10-2018	  Mohana S			 SR			ILCRSTPAR6289		Included GT Category
************************************************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @ReportType	AS INT	
	--Added By Mohana
	CREATE TABLE #Chain
	(
		[SalId] [bigint] NOT NULL,
		[BillNo] [nvarchar](50) NOT NULL,
		[BillDate] NVARCHAR(100),
		[RtrId] [int] NOT NULL,
		RtrName NVARCHAR(100),
		Ctgname NVARCHAR(100) NOT NULL,
		[PrdId] [int] NOT NULL,
		PrdName NVARCHAR(100),
		PktWgt [numeric](18, 6),
		[MRP] [numeric](18, 6) NOT NULL,
		QtyInPkt [numeric](38, 0) NULL,		
		[ChainLandRate] [numeric](18, 6) NULL,
		Amount [numeric](38, 6) NULL,
		[GrpName] NVARCHAR(100),
		[Grpid] INT
	)  
	--CHANGED BY MOHANA ILCRSTPAR2313
	CREATE TABLE #ChainSalesDetails
	(
		[TransType] INT NOT NULL,
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL,
		[PRDSLNO] INT NOT NULL
	)
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @ReportType = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,315,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,Ctgname
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId 
	--and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	INSERT INTO #ChainSalesDetails
	SELECT 1 AS TRANSID,S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc,SP.SlNo --ADDED BY MOHANA ILCRSTPAR2313
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid,SP.SlNo
	UNION ALL
	SELECT 2 AS TRANSID,S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc,SP.SlNo  --ADDED BY MOHANA ILCRSTPAR2313
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE S.ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid,SP.SlNo
	
	------------- commented By lakshman M ON 12/07/2018 PMS ID : ILCRSTPAR1325
	--UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	 --ADDED BY MOHANA ILCRSTPAR2313
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	 
	UPDATE #ChainSalesDetails SET SchemeDiscount =abs (SchemeDiscount/TotalPCS)
	UPDATE A SET SchemeDiscount =  SchemeDiscount + (SchemeDiscount *(B.TaxPerc/100)) FROM #ChainSalesDetails a 
	INNER JOIN #ParleOutputTaxPercentage B ON A.TransType=B.TRANSID
	AND A.SalId = B.SALID AND A.PRDSLNO = B.PRDSLNO
	--TILL HERE  ILCRSTPAR2313
	-------------------- Till here ----------------------------
	--ICRSTPAR7049 Till Here
	--SELECT R.PriceId,C.SplSelRate 
	--INTO #ExistingSpecialPrice
	--FROM #ChainSalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	 --ADDED BY MOHANA ILCRSTPAR2313
	
	UPDATE R SET R.ChainLandRate = (S.SplSelRate + (S.SplSelRate *(P.TaxPerc/100))-R.SchemeDiscount) 
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK),
	 #ParleOutputTaxPercentage P 
	WHERE R.PriceId = S.PriceId	and	  R.TransType=P.TRANSID
	AND R.SalId = P.SALID AND R.PRDSLNO = P.PRDSLNO
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = ((B.PrdbatDetailValue + (B.PrdbatDetailValue *(P.TaxPerc/100))) -A.SchemeDiscount) 
	FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID
	INNER JOIN #ParleOutputTaxPercentage P ON  A.TransType=P.TRANSID
	AND A.SalId = P.SALID AND A.PRDSLNO = P.PRDSLNO
	WHERE A.ChainLandRate=0  
	--TILL HERE
	
	INSERT INTO #Chain(SalId,BillNo,BillDate,RtrId,RtrName,Ctgname,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ChainLandRate,Amount)
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,CtgName,P.PrdId,P.PrdName,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) Amount
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	--- Added by Amuthakumar on 17-09-2018 CRCRSTPAR0021
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--Nagarajan on 29.08.2017 as per PMS : ICRSTPAR5917
	SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	INTO #SalesInvoiceProductTax
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	-- ICRSTPAR7049 Bill No Column Change
	--Till here CRCRSTPAR0021
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptChainWiseBillDetails_Excel')
	DROP TABLE RptChainWiseBillDetails_Excel
		 
	
	SELECT SalId,Ctgname,RtrName,BillNo,BillDate,RtrId,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ROUND(ChainLandRate,2,1) ChainLandRate,Amount,Grpid,GrpName
	INTO RptChainWiseBillDetails_Excel
	FROM #Chain (NOLOCK) Order by  Ctgname,RtrName
	
	UPDATE RptChainWiseBillDetails_Excel SET Grpname='Retailer'
	
 	SELECT  Row_numbeR() Over(Order by  Ctgname,Rtrid Asc) as Row ,Rtrid,Rtrname,Ctgname INTO #Excel  from RptChainWiseBillDetails_Excel  GROUP BY Rtrid ,Rtrname,Ctgname
 	UPDATE A SET A.Grpid = B.row from RptChainWiseBillDetails_Excel A INNER JOIN #Excel B ON A.Rtrid = B.Rtrid 
	 	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptChainWiseBillDetails_Excel
	
	SELECT * FROM RptChainWiseBillDetails_Excel Order By Ctgname,BillNo
	
	--INSERT INTO RptChainWiseBillDetails_Excel
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,1000,CtgName  FROM RptChainWiseBillDetails_Excel	
	--group by CtgName
	--UNION  
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,10000,'zzzzzz' FROM RptChainWiseBillDetails_Excel	

	INSERT INTO RptChainWiseBillDetails_Excel
	SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'SubTotal' FROM RptChainWiseBillDetails_Excel 
	group by RtrId
	UNION   
	SELECT 0 SalId,Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'ZSubStotal'  FROM RptChainWiseBillDetails_Excel 
	group by   Ctgname
	UNION  
	SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,1000000,'zzzzzzzzz' FROM RptChainWiseBillDetails_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'SalId','SalId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'RtrName','Party Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'BillNo','BillNo',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'BillDate','BillDate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'RtrId','RtrId',0,1)
 	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'PktWgt','Pkt Wgt',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'ChainLandRate','Chain Landing Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'Amount','Amount',1,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'Grpid','Grpid',0,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'GrpName','GrpName',0,1)	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SysObjects WHERE NAME='Proc_RptChainWiseBillDetails' AND TYPE='P')
DROP PROCEDURE Proc_RptChainWiseBillDetails
GO
/*
BEGIN TRAN
EXEC Proc_RptChainWiseBillDetails 288,2,0,'PARLE_CR',0,0,1
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_RptChainWiseBillDetails
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/***********************************************************************************************************************************
* PROCEDURE	: Proc_RptChainWiseBillDetsils
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
************************************************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. Chain lending rate should display the net rate in billing screen
															2. Bill number column should be after the party name column 
************************************************************************************************************************************
 19-12-2017   S.Mohana    CR			ICRSTPAR7049		3. Added SubTotal in Excel 
************************************************************************************************************************************
 23-12-2017	  S.MOHANA	  SR			ICRSTPAR7809		1.INCLUDED SALES RETURN
															2.REMOVED TAX CALCULATION
															3.ADDED RATE-SCHEMEDISCOUNT , GRANDTOTAL
************************************************************************************************************************************
 26-03-2018	  S.MOHANA	  CR			CCRSTPAR0186		Retailer Wise Sub Total Included. 
 12-07-2018   Lakshman M  BZ            ILCRSTPAR1325       negative values validataion added from core stocky.
 27-09-2018   Amuthakumar CR            CRCRSTPAR0031       Enable Configuration with Tax in Reports				
 14-10-2018	  Mohana S	  SR			ILCRSTPAR6289		Included GT Category										
************************************************************************************************************************************/ 
BEGIN
	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_RptChainWiseBillDetails_withTax @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @ReportType	AS INT	
	--Added By Mohana
	CREATE TABLE #Chain
	(
		[SalId] [bigint] NOT NULL,
		[BillNo] [nvarchar](50) NOT NULL,
		[BillDate] NVARCHAR(100),
		[RtrId] [int] NOT NULL,
		RtrName NVARCHAR(100),
		Ctgname NVARCHAR(100) NOT NULL,
		[PrdId] [int] NOT NULL,
		PrdName NVARCHAR(100),
		PktWgt [numeric](18, 6),
		[MRP] [numeric](18, 6) NOT NULL,
		QtyInPkt [numeric](38, 0) NULL,		
		[ChainLandRate] [numeric](18, 6) NULL,
		Amount [numeric](38, 2) NULL,
		[GrpName] NVARCHAR(100),
		[Grpid] INT
	)  
	
	
	CREATE TABLE #ChainSalesDetails
	(
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL
	)
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @ReportType = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,315,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode,Ctgname
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId 
	--and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	INSERT INTO #ChainSalesDetails
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid
	UNION ALL
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE S.ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid
	
	------------- commented By lakshman M ON 12/07/2018 PMS ID : ILCRSTPAR1325
	--UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	UPDATE #ChainSalesDetails SET SchemeDiscount =abs (SchemeDiscount/TotalPCS)
	-------------------- Till here ----------------------------
	--ICRSTPAR7049 Till Here
	--SELECT R.PriceId,C.SplSelRate 
	--INTO #ExistingSpecialPrice
	--FROM #ChainSalesDetails R (NOLOCK),
	--SpecialRateAftDownLoad_Calc C (NOLOCK)
	--WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	
	UPDATE R SET R.ChainLandRate = (S.SplSelRate-R.SchemeDiscount)
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId		
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = (B.PrdbatDetailValue-A.SchemeDiscount) FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID WHERE A.ChainLandRate=0  
	
	INSERT INTO #Chain(SalId,BillNo,BillDate,RtrId,RtrName,Ctgname,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ChainLandRate,Amount)
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,CtgName,P.PrdId,P.PrdName,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,2)) Amount
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--Nagarajan on 29.08.2017 as per PMS : ICRSTPAR5917
	--SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	--INTO #SalesInvoiceProductTax
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	--Till here
	-- ICRSTPAR7049 Bill No Column Change
	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptChainWiseBillDetails_Excel')
	DROP TABLE RptChainWiseBillDetails_Excel
		 
	
	SELECT SalId,Ctgname,RtrName,BillNo,BillDate,RtrId,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ROUND(ChainLandRate,2,1) ChainLandRate,ROUND(Amount,2,1) Amount,Grpid,GrpName
	INTO RptChainWiseBillDetails_Excel
	FROM #Chain (NOLOCK) Order by  Ctgname,RtrName
	
	UPDATE RptChainWiseBillDetails_Excel SET Grpname='Retailer'
	
 	SELECT  Row_numbeR() Over(Order by  Ctgname,Rtrid Asc) as Row ,Rtrid,Rtrname,Ctgname INTO #Excel  from RptChainWiseBillDetails_Excel  GROUP BY Rtrid ,Rtrname,Ctgname
 	UPDATE A SET A.Grpid = B.row from RptChainWiseBillDetails_Excel A INNER JOIN #Excel B ON A.Rtrid = B.Rtrid 
	 	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptChainWiseBillDetails_Excel
	
	SELECT * FROM RptChainWiseBillDetails_Excel Order By Ctgname,BillNo
	
	--INSERT INTO RptChainWiseBillDetails_Excel
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,1000,CtgName  FROM RptChainWiseBillDetails_Excel	
	--group by CtgName
	--UNION  
	--SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	--SUM(Amount) Amount,10000,'zzzzzz' FROM RptChainWiseBillDetails_Excel	
	INSERT INTO RptChainWiseBillDetails_Excel
	SELECT 0 SalId,'' Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'SubTotal' FROM RptChainWiseBillDetails_Excel 
	group by RtrId
	UNION   
	SELECT 0 SalId,Ctgname,'' RtrName,'TOTAL ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,Max(Grpid),'ZSubStotal'  FROM RptChainWiseBillDetails_Excel 
	group by   Ctgname
	UNION  
	SELECT 0 SalId,'' Ctgname,'' RtrName,'Grand Total ' BillNo,'' BillDate,0 RtrId,0 PrdId, '' PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount,1000000,'zzzzzzzzz' FROM RptChainWiseBillDetails_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'SalId','SalId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'CtgName','Category Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'RtrName','Party Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'BillNo','BillNo',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'BillDate','BillDate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'RtrId','RtrId',0,1)
 	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'PktWgt','Pkt Wgt',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'ChainLandRate','Chain Landing Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'Amount','Amount',1,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'Grpid','Grpid',0,1)	
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'GrpName','GrpName',0,1)	
	RETURN
END
GO
--CRCRSTPAR0079 STATRS DONE BY MOHANA
DELETE FROM Menudef WHERE MENUID = 'mClm22'
INSERT INTO Menudef 
SELECT 204,'mClm22','mnuDebitNoteTopSheet','mClm','Debit Note Top Sheet',0,'frmDebitnotetopsheet','Debit Note Top Sheet'
GO
DELETE FROM ProfileDt WHERE MenuId ='mClm22'
INSERT INTO ProfileDt
SELECT Prfid,'mClm22',0,'New',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',2,'Save',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',3,'Delete',0,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',4,'Cancel',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',5,'Exit',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',6,'Print',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
UNION		  
SELECT Prfid,'mClm22',7,'Populate',1,1,1,GETDATE(),1,GETDATE() FROM ProfileHD 
GO
DELETE FROM CustomCaptions WHERE TransId = 504
INSERT INTO CustomCaptions 
SELECT 504,1,1,'CoreHeaderTool','Debit Note Top Sheet','','',1,1,1,GETDATE (),1,GETDATE (),'Debit Note Top Sheet','','',1,1 UNION 
SELECT 504,1,2,'CoreHeaderTool','Stocky','','',1,1,1,GETDATE (),1,GETDATE (),'Stocky','','',1,1 UNION 
SELECT 504,2,0,'lblDebitNoteNo','Debit Note Doc.No*...','','',1,1,1,GETDATE (),1,GETDATE (),'Debit Note Doc.No*...','','',1,1 UNION 
SELECT 504,3,0,'lblYear','Year*...','','',1,1,1,GETDATE (),1,GETDATE (),'Year*...','','',1,1 UNION 
SELECT 504,4,0,'lblMonth','Month*...','','',1,1,1,GETDATE (),1,GETDATE (),'Month*...','','',1,1 UNION 
SELECT 504,5,0,'lblConDocNo','Console Doc.No','','',1,1,1,GETDATE (),1,GETDATE (),'Console Doc.No','','',1,1 UNION 
SELECT 504,6,0,'lblSAPDocNo','SAP Doc.No','','',1,1,1,GETDATE (),1,GETDATE (),'SAP Doc.No','','',1,1 UNION 
SELECT 504,7,0,'lblStatus','Status','','',1,1,1,GETDATE (),1,GETDATE (),'Status','','',1,1 UNION 
SELECT 504,8,0,'FxtDNDocNo','','','',1,1,1,GETDATE (),1,GETDATE (),'','','',1,1 UNION 
SELECT 504,9,0,'FxtYear','','Press F4/ Double Click to Select Year','',1,1,1,GETDATE (),1,GETDATE (),'','Press F4/ Double Click to Select Year','',1,1 UNION 
SELECT 504,10,0,'FxtMonth','','Press F4/ Double Click to Select Month','',1,1,1,GETDATE (),1,GETDATE (),'','Press F4/ Double Click to Select Month','',1,1 UNION 
SELECT 504,11,0,'FxtConDocNo','','','',1,1,1,GETDATE (),1,GETDATE (),'','','',1,1 UNION 
SELECT 504,12,0,'FxtSAPDocNo','','','',1,1,1,GETDATE (),1,GETDATE (),'','','',1,1 UNION 
SELECT 504,13,0,'FxtStatus','','','',1,1,1,GETDATE (),1,GETDATE (),'','','',1,1 UNION 
SELECT 504,14,0,'btnOperation','&New','','',1,1,1,GETDATE(),1,GETDATE(),'&New','','',1,1  UNION 
SELECT 504,14,1,'btnOperation','&Edit','','',1,1,1,GETDATE(),1,GETDATE(),'&Edit','','',1,1 UNION 
SELECT 504,14,2,'btnOperation','&Save','','',1,1,1,GETDATE(),1,GETDATE(),'&Save','','',1,1 UNION 
SELECT 504,14,3,'btnOperation','&Delete','','',1,1,1,GETDATE(),1,GETDATE(),'&Delete','','',1,1 UNION 
SELECT 504,14,4,'btnOperation','&Cancel','','',1,1,1,GETDATE(),1,GETDATE(),'&Cancel','','',1,1 UNION 
SELECT 504,14,5,'btnOperation','E&xit','','',1,1,1,GETDATE(),1,GETDATE(),'E&xit','','',1,1 UNION 
SELECT 504,14,6,'btnOperation','&Print','','',1,1,1,GETDATE(),1,GETDATE(),'&Print','','',1,1 UNION 
SELECT 504,14,7,'btnOperation','Save && C&onfirm','','',1,1,1,GETDATE(),1,GETDATE(),'Save && C&onfirm','','',1,1 UNION 
SELECT 504,14,8,'btnOperation','&Load','','',1,1,1,GETDATE(),1,GETDATE(),'&Load','','',1,1 UNION 
SELECT 504,14,9,'btnOperation','&Load','','',1,1,1,GETDATE(),1,GETDATE(),'&Load','','',1,1 UNION
SELECT 504,15,1,'FpSampling-504-15-1','DSM Sanction Letter Date','','',1,1,1,GETDATE (),1,GETDATE (),'DSM Sanction Letter Date','','',1,1 UNION 
SELECT 504,15,2,'FpSampling-504-15-2','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 
SELECT 504,15,3,'FpSampling-504-15-3','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 
SELECT 504,15,4,'FpSampling-504-15-4','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,15,5,'FpSampling-504-15-5','Sampling Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Sampling Amount','','',1,1 UNION
SELECT 504,16,2,'FpTrade-504-16-2','Scheme Description','','',1,1,1,GETDATE (),1,GETDATE (),'Scheme Description','','',1,1 UNION 		  
SELECT 504,16,3,'FpTrade-504-16-3','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 		  
SELECT 504,16,4,'FpTrade-504-16-4','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 		  
SELECT 504,16,5,'FpTrade-504-16-5','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION		  
SELECT 504,16,6,'FpTrade-504-16-6','Scheme Budget','','',1,1,1,GETDATE (),1,GETDATE (),'Scheme Budget','','',1,1 UNION 		  
SELECT 504,16,7,'FpTrade-504-16-7','Last 2 Month Primary Value','','',1,1,1,GETDATE (),1,GETDATE (),'Last 2 Month Primary Value','','',1,1 UNION 		  
SELECT 504,16,8,'FpTrade-504-16-8','4th Week Primary Value','','',1,1,1,GETDATE (),1,GETDATE (),'4th Week Primary Value','','',1,1 UNION 
SELECT 504,16,9,'FpTrade-504-16-9','Scheme Period Primary Value','','',1,1,1,GETDATE (),1,GETDATE (),'Scheme Period Primary Value','','',1,1 UNION 
SELECT 504,16,10,'FpTrade-504-16-10','Sec Sales Value','','',1,1,1,GETDATE (),1,GETDATE (),'Sec Sales Value','','',1,1 UNION 
SELECT 504,16,11,'FpTrade-504-16-11','% Liab On Sec Sales','','',1,1,1,GETDATE (),1,GETDATE (),'% Liab On Sec Sales','','',1,1 UNION 
SELECT 504,16,12,'FpTrade-504-16-12','Claim Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Claim Amount','','',1,1 UNION 
SELECT 504,16,13,'FpTrade-504-16-13','Org Claim Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Org Claim Amount','','',1,1 UNION 
SELECT 504,16,14s,'FpTrade-504-16-14','ApplyCapVal','','',1,1,1,GETDATE (),1,GETDATE (),'ApplyCapVal','','',1,1 UNION 
SELECT 504,17,1,'FpInst-504-17-1','Name Of The Category','','',1,1,1,GETDATE (),1,GETDATE (),'Name Of The Category','','',1,1 UNION 
SELECT 504,17,2,'FpInst-504-17-2','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 
SELECT 504,17,3,'FpInst-504-17-3','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 
SELECT 504,17,4,'FpInst-504-17-4','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,17,5,'FpInst-504-17-5','Monthly Target','','',1,1,1,GETDATE (),1,GETDATE (),'Monthly Target','','',1,1 UNION 
SELECT 504,17,6,'FpInst-504-17-6','Last 2 Month Avg Sales','','',1,1,1,GETDATE (),1,GETDATE (),'Last 2 Month Avg Sales','','',1,1 UNION 
SELECT 504,17,7,'FpInst-504-17-7','Current Month','','',1,1,1,GETDATE (),1,GETDATE (),'Current Month','','',1,1 UNION 
SELECT 504,17,8,'FpInst-504-17-8','No of Incentive Outlet','','',1,1,1,GETDATE (),1,GETDATE (),'No of Incentive Outlet','','',1,1 UNION 
SELECT 504,17,9,'FpInst-504-17-9','Total Discount','','',1,1,1,GETDATE (),1,GETDATE (),'Total Discount','','',1,1  UNION 
SELECT 504,18,1,'FpTot-504-18-1','Name Of The Category','','',1,1,1,GETDATE (),1,GETDATE (),'Name Of The Category','','',1,1 UNION 
SELECT 504,18,2,'FpTot-504-18-2','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 
SELECT 504,18,3,'FpTot-504-18-3','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 
SELECT 504,18,4,'FpTot-504-18-4','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,18,5,'FpTot-504-18-5','Total Normal Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Total Normal Amount','','',1,1 UNION 
SELECT 504,18,6,'FpTot-504-18-6','Total Normal Sec Sales As per TOT','','',1,1,1,GETDATE (),1,GETDATE (),'Total Normal Sec Sales As per TOT','','',1,1 UNION 
SELECT 504,18,7,'FpTot-504-18-7','Total Diff Claim','','',1,1,1,GETDATE (),1,GETDATE (),'Total Diff Claim','','',1,1 UNION 
SELECT 504,19,1,'FpManual-504-19-1','Name Of The Category','','',1,1,1,GETDATE (),1,GETDATE (),'Name Of The Category','','',1,1 UNION 
SELECT 504,19,2,'FpManual-504-19-2','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 
SELECT 504,19,3,'FpManual-504-19-3','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 
SELECT 504,19,4,'FpManual-504-19-4','CirCular No','','',1,1,1,GETDATE (),1,GETDATE (),'CirCular No','','',1,1 UNION 
SELECT 504,19,5,'FpManual-504-19-5','Scheme Budget','','',1,1,1,GETDATE (),1,GETDATE (),'Scheme Budget','','',1,1 UNION 
SELECT 504,19,6,'FpManual-504-19-6','Sec Sales Value','','',1,1,1,GETDATE (),1,GETDATE (),'Sec Sales Value','','',1,1 UNION 
SELECT 504,19,7,'FpManual-504-19-7','% Liab On Sec Sales','','',1,1,1,GETDATE (),1,GETDATE (),'% Liab On Sec Sales','','',1,1 UNION 
SELECT 504,19,8,'FpManual-504-19-8','Claim Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Claim Amount','','',1,1 UNION 
SELECT 504,20,1,'FpDistIncn-504-20-1','Reference No','','',1,1,1,GETDATE (),1,GETDATE (),'Reference No','','',1,1 UNION 
SELECT 504,20,2,'FpDistIncn-504-20-2','No. of Salesman','','',1,1,1,GETDATE (),1,GETDATE (),'No. of Salesman','','',1,1 UNION 
SELECT 504,20,3,'FpDistIncn-504-20-3','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,20,4,'FpDistIncn-504-20-4','Total Sales Value','','',1,1,1,GETDATE (),1,GETDATE (),'Total Sales Value','','',1,1  UNION 
SELECT 504,20,5,'FpDistIncn-504-20-5','Total Incentive Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Total Incentive Amount','','',1,1 UNION 
SELECT 504,21,1,'FpSMIncn-504-21-1','SM Reference No','','',1,1,1,GETDATE (),1,GETDATE (),'SM Reference No','','',1,1 UNION 
SELECT 504,21,2,'FpSMIncn-504-21-2','Salesman Name','','',1,1,1,GETDATE (),1,GETDATE (),'Salesman Name','','',1,1 UNION 
SELECT 504,21,4,'FpSMIncn-504-21-4','Total Ach Sales','','',1,1,1,GETDATE (),1,GETDATE (),'Total Sales Value','','',1,1 UNION 
SELECT 504,21,3,'FpSMIncn-504-21-3','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,21,5,'FpSMIncn-504-21-5','From Range','','',1,1,1,GETDATE (),1,GETDATE (),'From Range','','',1,1 UNION 
SELECT 504,21,6,'FpSMIncn-504-21-6','To Range','','',1,1,1,GETDATE (),1,GETDATE (),'To Range','','',1,1 UNION 
SELECT 504,21,7,'FpSMIncn-504-21-7','Fixed Pay','','',1,1,1,GETDATE (),1,GETDATE (),'Fixed Pay','','',1,1 UNION 
SELECT 504,21,8,'FpSMIncn-504-21-8','Variable Pay','','',1,1,1,GETDATE (),1,GETDATE (),'Variable Pay','','',1,1 UNION 
SELECT 504,21,9,'FpSMIncn-504-21-9','Total Incentive Amount','','',1,1,1,GETDATE (),1,GETDATE (),'Total Incentive Amount','','',1,1 UNION 
SELECT 504,22,1,'FpTotal-504-22-1','Sampling','','',1,1,1,GETDATE (),1,GETDATE (),'Sampling','','',1,1 UNION 
SELECT 504,22,2,'FpTotal-504-22-2','Trade Scheme','','',1,1,1,GETDATE (),1,GETDATE (),'Trade Scheme','','',1,1 UNION 
SELECT 504,22,3,'FpTotal-504-22-3','Institution Sales','','',1,1,1,GETDATE (),1,GETDATE (),'Institution Sales','','',1,1 UNION 
SELECT 504,22,4,'FpTotal-504-22-4','Tot Diff Claim','','',1,1,1,GETDATE (),1,GETDATE (),'Tot Diff Claim','','',1,1 UNION 
SELECT 504,22,5,'FpTotal-504-22-5','Manual Claim','','',1,1,1,GETDATE (),1,GETDATE (),'Manual Claim','','',1,1 UNION 
SELECT 504,22,6,'FpTotal-504-22-6','Distributor Incentive','','',1,1,1,GETDATE (),1,GETDATE (),'Distributor Incentive','','',1,1 UNION 
SELECT 504,22,7,'FpTotal-504-22-7','SalesMan Incentive','','',1,1,1,GETDATE (),1,GETDATE (),'SalesMan Incentive','','',1,1 UNION 
SELECT 504,22,8,'FpTotal-504-22-8','Grand Total','','',1,1,1,GETDATE (),1,GETDATE (),'Grand Total','','',1,1 UNION
SELECT 504,23,0,'SSTDebitnote','Sampling','','',1,1,1,GETDATE (),1,GETDATE (),'Sampling','','',1,1 UNION
SELECT 504,23,1,'SSTDebitnote','Trade Scheme','','',1,1,1,GETDATE (),1,GETDATE (),'Trade Scheme','','',1,1 UNION
SELECT 504,23,2,'SSTDebitnote','Institutional Sales','','',1,1,1,GETDATE (),1,GETDATE (),'Institutional Sales','','',1,1 UNION
SELECT 504,23,3,'SSTDebitnote','Total Difference Claim','','',1,1,1,GETDATE (),1,GETDATE (),'TOT Claim','','',1,1 UNION
SELECT 504,23,4,'SSTDebitnote','Manual Claim','','',1,1,1,GETDATE (),1,GETDATE (),'Manual Claim','','',1,1 UNION
SELECT 504,23,5,'SSTDebitnote','Service To Outlet','','',1,1,1,GETDATE (),1,GETDATE (),'Distributor Incentive','','',1,1 UNION
SELECT 504,23,6,'SSTDebitnote','Unit ROI','','',1,1,1,GETDATE (),1,GETDATE (),'SalesMan Incentive','','',1,1 UNION
SELECT 504,2000,1,'HotSch-504-2000-1','Year','','',1,1,1,GETDATE (),1,GETDATE (),'Year','','',1,1 UNION
SELECT 504,2000,2,'HotSch-504-2000-2','Month','','',1,1,1,GETDATE (),1,GETDATE (),'Month','','',1,1 UNION
SELECT 504,2000,3,'HotSch-504-2000-3','Reference No','','',1,1,1,GETDATE (),1,GETDATE (),'Reference No','','',1,1 UNION
SELECT 504,2000,4,'HotSch-504-2000-4','Date','','',1,1,1,GETDATE (),1,GETDATE (),'Date','','',1,1 UNION
SELECT 504,1000,1,'MsgBox-504-1000-1','','','Back Dated Transaction Not Allowed',1,1,1,GETDATE (),1,GETDATE (),'','','Back Dated Transaction Not Allowed',1,1 UNION
SELECT 504,1000,2,'MsgBox-504-1000-2','','','Save Failed While Inserting Debit Note Top Header Header ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Debit Note Top Header Header',1,1 UNION
SELECT 504,1000,3,'MsgBox-504-1000-3','','','Save Failed While Inserting Sampling Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,4,'MsgBox-504-1000-4','','','Save Failed While Inserting Trade Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,5,'MsgBox-504-1000-5','','','Save Failed While Inserting Institutional Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,6,'MsgBox-504-1000-6','','','Save Failed While Inserting Manual Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,7,'MsgBox-504-1000-7','','','Save Failed While Inserting TOT Difference Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,8,'MsgBox-504-1000-8','','','Save Failed While Inserting Distributor Incentive Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 UNION
SELECT 504,1000,9,'MsgBox-504-1000-9','','','Save Failed While Inserting SM Incentive Data ',1,1,1,GETDATE (),1,GETDATE (),'','','Save Failed While Inserting Sampling Data',1,1 
GO
DELETE FROM HotSearchEditorDT WHERE FORMID =10212
INSERT INTO HotSearchEditorDT
SELECT 1,10212,'Year','Year','Year',4000,0,'HotSch-504-2000-1',504
GO
DELETE FROM HotSearchEditorHd WHERE FORMID =10212
INSERT INTO HotSearchEditorHd
SELECT 10212,'Debit Note Top Sheet','Year','SELECT','SELECT JcmYr AS Year FROM JcMast WHERE JcmYr >=year(getdate())-1'
GO
DELETE FROM HotSearchEditorHd WHERE FORMID =10213
INSERT INTO HotSearchEditorHd
SELECT 10213,'Debit Note Top Sheet','Month','SELECT','SELECT ID,Name AS Month FROM Fn_GetMonthForDebitNote() Order By Id'
GO
DELETE FROM HotSearchEditorDT WHERE FORMID =10213
INSERT INTO HotSearchEditorDT
SELECT 1,10213,'ID','ID','ID',500,0,'HotSch-504-2000-5',504
UNION
SELECT 2,10213,'Month','Month','Month',4000,0,'HotSch-504-2000-2',504
GO
DELETE FROM HotSearchEditorDT WHERE FORMID =10214
INSERT INTO HotSearchEditorDT
SELECT 1,10214,'DN.Ref.No','Reference No','DNDocNo',4000,0,'HotSch-504-2000-3',504
UNION
SELECT 2,10214,'DN.Ref.No','Date','ClmDate',4000,0,'HotSch-504-2000-4',504
GO
DELETE FROM HotSearchEditorHd WHERE FORMID =10214
INSERT INTO HotSearchEditorHd
SELECT 10214,'Debit Note Top Sheet','DN.Ref.No','SELECT','SELECT DISTINCT DNDocNo,ClmDate,DNrefid FROM DebitNoteTopSheetClaimHd'
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetMonthForDebitNote' AND TYPE='TF')
DROP FUNCTION Fn_GetMonthForDebitNote
GO
CREATE FUNCTION Fn_GetMonthForDebitNote()
RETURNS @Month TABLE
(
	Id	INT,
	Name VARCHAR(100)
)
AS
BEGIN
/****************************************************************************
* PROCEDURE	:  Fn_GetMonthForDebitNote
* PURPOSE	:  TO GET MONTH ID 
* DATE		:  11-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
INSERT INTO @MOnth
SELECT 1,'January' UNION
SELECT 2,'February' UNION
SELECT 3,'March' UNION 
SELECT 4,'April' UNION
SELECT 5,'May' UNION
SELECT 6,'June' UNION
SELECT 7,'July' UNION
SELECT 8,'August' UNION
SELECT 9,'September' UNION
SELECT 10,'October' UNION
SELECT 11,'November' UNION
SELECT 12,'December' 


RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetDNTopsheetClaimNames' AND TYPE='TF')
DROP FUNCTION Fn_GetDNTopsheetClaimNames
GO
CREATE FUNCTION Fn_GetDNTopsheetClaimNames()
RETURNS @Names Table
(
	Id INT,
	ClmName NVARCHAR(100)
)
AS

/****************************************************************************
* PROCEDURE	:  Fn_GetDNTopsheetClaimNames
* PURPOSE	:  TO GET CLAIM NAMES 
* DATE		:  11-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

INSERT INTO @Names
SELECT 1,'Sampling' UNION
SELECT 2,'Trade Scheme' UNION
SELECT 3,'Institutional Sales'UNION
SELECT 4,'Total Difference Claim'UNION
SELECT 5,'Manual Claim' UNION
SELECT 6,'Distributor Incentive' UNION
SELECT 7,'Salesman Incentive'

RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedSampling' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedSampling
GO
CREATE FUNCTION Fn_GetSavedSampling(@DnRefid INT,@Usrid INT)
RETURNS @Sampling TABLE
(
	 
	SancDate DATETIME ,
	FromDate DATETIME ,
	ToDate	 DATETIME ,
	CirNo	 NVARCHAR(100) ,
	SamAmt	 NUMERIC(38,6) ,
	UsrId	 INT
)
AS

/****************************************************************************
* PROCEDURE	:  Fn_GetSavedSampling
* PURPOSE	:  TO GET SAVED SAMPLING DATA
* DATE		:  11-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

INSERT INTO @Sampling
SELECT SancDate,FromDate,ToDate,CirNo,SamAmt,@Usrid FROM DebitNoteTopSheetClaim_Sampling WHERE DNRefId = @DnRefid

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedTrade' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedTrade
GO
CREATE FUNCTION Fn_GetSavedTrade(@DnRefid INT,@Usrid INT)
RETURNS @Trade TABLE
(

	
	SchId			INT ,
	SchDesc			NVARCHAR(200) ,
	FrmDate			DATETIME,
	ToDate			DATETIME,
	CirNo			NVARCHAR(100) ,
	SchBudget		NUMERIC(38,6) ,
	Lst2MntSAl		NUMERIC(38,6) ,
	Wk4PriVal		NUMERIC(38,6) ,
	SchPrimary		NUMERIC(38,6) ,
	SecSales		NUMERIC(38,6) ,
	LaibPer			NUMERIC(38,6) ,
	CalClmAmt		NUMERIC(38,6) ,
	OrgClmAmt			NUMERIC(38,6) ,
	ApplyCapVal		INT,
	UsrId	 INT
)
AS

/****************************************************************************
* PROCEDURE	:  Fn_GetSavedTrade
* PURPOSE	:  TO GET SAVED TRADE DETAILS
* DATE		:  11-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @Trade
	SELECT SchId,SchDesc,FrmDate,ToDate,CirNo,SchBudget,Lst2MntSAl,Wk4PriVal,SchPrimary,SecSales,LaibPer,CalClmAmt,OrgClmAmt,ApplyCapVal,@Usrid 
	FROM DebitNoteTopSheetClaim_Trade  WHERE DNRefId = @DnRefid  Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Fn_GetSavedInstTarget' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedInstTarget
GO
CREATE FUNCTION Fn_GetSavedInstTarget(@DnRefid INT,@Usrid INT)
RETURNS @InstTarget TABLE
(

	
	CtgName			NVARCHAR(100) ,
	FromDate		DATETIME  ,
	ToDate			DATETIME  ,	
	CirNo			NVARCHAR(50) ,
	Description		NVARCHAR(50) ,
	MonTarget		NUMERIC(38,6) ,	
	Lst2MntSAl		NUMERIC(38,6) ,
	CurMonth		NUMERIC(38,6) ,
	OutletCnt		INT,
	TotDiscount		NUMERIC(38,6) ,
	SchType			INT,
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetSavedInstTarget
* PURPOSE	:  TO GET SAVED INSTITUTIONAL TARGET DETAILS
* DATE		:  12-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @InstTarget
	SELECT CtgName,FromDate,ToDate,CirNo,CASE SCHTYPE WHEN 1 THEN 'Institutional Base Discount' ELSE 'Institutional Target' END as Description,MonTarget,Lst2MntSAl,CurMonth,OutletCnt,TotDiscount,SCHTYPE,@Usrid 
	FROM DebitNoteTopSheetClaim_InstTarget   WHERE DNRefId = @DnRefid  Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedTOT' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedTOT
GO
CREATE FUNCTION Fn_GetSavedTOT(@DnRefid INT,@Usrid INT)
RETURNS @TOT TABLE
(

	
	CtgName			NVARCHAR(100) ,
	FromDate		DATETIME ,
	ToDate			DATETIME ,
	CirNo			NVARCHAR(100) ,
	NrmlAmt			NUMERIC(18,6) ,
	TOTAmt			NUMERIC(18,6) ,
	DiffAmt			NUMERIC(18,6) , 
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetSavedTOT
* PURPOSE	:  TO GET SAVED TOT CLAIM DETAILS
* DATE		:  12-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @TOT
	SELECT CtgName,FromDate,ToDate,CirNo,NrmlAmt,TOTAmt,DiffAmt,@Usrid 
	FROM DebitNoteTopSheetClaim_Totdiff   WHERE DNRefId = @DnRefid Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedManual' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedManual
GO
CREATE FUNCTION Fn_GetSavedManual(@DnRefid INT,@Usrid INT)
RETURNS @Manual TABLE
(

	
	SchDesc			NVARCHAR(100) ,
	FromDate		DATETIME ,
	ToDate			DATETIME ,
	CirNo			NVARCHAR(100) ,
	SchBudget		NUMERIC(18,6) ,
	SecSales		NUMERIC(18,6) ,
	LiabPerc		NUMERIC(18,6) ,
	ClmAmt			NUMERIC(18,6) ,
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetSavedManual
* PURPOSE	:  TO GET SAVED MANUAL CLAIM DETAILS
* DATE		:  12-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @Manual
	SELECT SchDesc,FromDate,ToDate,CirNo,SchBudget,SecSales,LiabPerc,ClmAmt,@Usrid 
	FROM DebitNoteTopSheetClaim_Manual  WHERE DNRefId = @DnRefid Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedDistInc' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedDistInc
GO
--SELECT * From Fn_GetSavedDistInc(1,1)
CREATE FUNCTION Fn_GetSavedDistInc(@DnRefid INT,@Usrid INT)
RETURNS @DistInc TABLE
(

	
	RefNo			NVARCHAR(100) ,
	SMCnt			INT ,
	CirNo			NVARCHAR(100) ,
	TotAchSales		NUMERIC(18,6) ,
	IncAmt			NUMERIC(18,6) , 
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetSavedDistInc
* PURPOSE	:  TO GET SAVED DISTRIBUTOR INCENTIVE CLAIMS
* DATE		:  12-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @DistInc
	SELECT RefNo,SMCnt,CirNo,TotAchSales,IncAmt,@Usrid 
	FROM DebitNoteTopSheetClaim_DistInc   WHERE DNRefId = @DnRefid Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetSavedSMInc' AND TYPE='TF')
DROP FUNCTION Fn_GetSavedSMInc
GO
--SELECT * From Fn_GetSavedSMInc(1,1)
CREATE FUNCTION Fn_GetSavedSMInc(@DnRefid INT,@Usrid INT)
RETURNS @SMInc TABLE
(

	RefNo			NVARCHAR(100) ,
	SMName			NVARCHAR(100) ,
	CirNo			NVARCHAR(100) ,
	TotAchSales		NUMERIC(18,6) ,
	FrmRange		NUMERIC(18,4) ,
	ToRange			NUMERIC(18,4) ,
	FixedPay		NUMERIC(18,6) ,
	VarPay			NUMERIC(18,6) ,
	IncAmount		NUMERIC(18,6) ,
	SMID			INT,
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetSavedSMInc
* PURPOSE	:  TO GET SAVED SALESMAN INCENTIVE CLAIM
* DATE		:  12-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @SMInc
	SELECT  RefNo,SMName,CirNo,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,IncAmount,Smid,@Usrid 
	FROM DebitNoteTopSheetClaim_SmInc  WHERE DNRefId = @DnRefid Order By Slno

RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_DebitNoteHeader' AND TYPE='TF')
DROP FUNCTION Fn_DebitNoteHeader
GO
--SELECT * From Fn_DebitNoteHeader(1,1)
CREATE FUNCTION Fn_DebitNoteHeader(@DnRefid INT,@Usrid INT)
RETURNS @DebitNoteHeader  TABLE
(
	DNRefId			INT ,
	DNDocNo			NVARCHAR(100) ,
	ClmDate			DATETIME ,
	ClmYear			INT , 
	ClmMonth		NVARCHAR(50)  ,
	SampAmt			NUMERIC(38,6) ,
	TradeSchAmt		NUMERIC(38,6) ,	
	InstTarAmt		NUMERIC(38,6) ,
	TOTDiffAmt		NUMERIC(38,6) ,
	ManualClmAmt	NUMERIC(38,6) ,
	DistIncAmt		NUMERIC(38,6) ,
	SMIncAmt		NUMERIC(38,6) ,
	TotalAmt		NUMERIC(38,6) ,
	DNStatus		NVARCHAR(100) , 
	ConDocRefNo		NVARCHAR(100),
	SAPDocRefNo		NVARCHAR(100),
	UsrId			INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_DebitNoteHeader
* PURPOSE	:  TO GET SAVED HEADER DETAILS
* DATE		:  13-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN 
	INSERT INTO @DebitNoteHeader
	SELECT DISTINCT DNRefId,DNDocNo,ClmDate,ClmYear,ClmMonth,SampAmt,TradeSchAmt,InstTarAmt,TOTDiffAmt,ManualClmAmt,
	DistIncAmt,SMIncAmt,TotalAmt,CASE DNStatus WHEN 0 THEN 'PENDING' WHEN 1 THEN 'Waiting For Console No' WHEN 2 THEN 'Waiting For SAP NO' 
	WHEN 3 THEN 'Approved' END AS DNStatus,ConDocRefNo,SAPDocRefNo,@Usrid FROM DebitNoteTopSheetClaimHd  
	WHERE DNRefId = @DnRefid 

RETURN 
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Upload' AND module='DebitNoteTopSheetClaim_Summary'
INSERT INTO CustomUpDownload
SELECT 172,1,'DebitNoteTopSheetClaim_Summary','DebitNoteTopSheetClaim_Summary','Proc_Cs2Cn_Dummy','','Cs2Cn_Prk_DebitNoteTopSheetClaimDt','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='DebitNoteTopSheetClaim_Summary'
INSERT INTO Tbl_UploadIntegration
SELECT 71,'DebitNoteTopSheetClaim_Summary','DebitNoteTopSheetClaim_Summary','Cs2Cn_Prk_DebitNoteTopSheetClaimDt',GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_DebitNoteTopSheetClaimDt' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_DebitNoteTopSheetClaimDt
GO
CREATE TABLE Cs2Cn_Prk_DebitNoteTopSheetClaimDt
(
Slno			NUMERIC (38,0) IDENTITY(1,1),
DistCode		NVARCHAR(100),
DNDocRefNO		NVARCHAR(50) ,
ClmDate			DATETIME	 ,
ClmType			NVARCHAR(100),
FromDate		DATETIME	 ,
ToDate			DATETIME	 ,
SancDate		DATETIME	 ,
SchDesc			NVARCHAR(100),
CtgCode			NVARCHAR(100),
CirRefNO		NVARCHAR(100),
CirNo			NVARCHAR(100),
RefNo			NVARCHAR(100),
SchBudget		NUMERIC(38,6),
OutletCnt		INT			 ,
SMCnt			INT			 ,
SMName			NVARCHAR(100),
Lst2MntSAl		NUMERIC(38,6),
SecSales		NUMERIC(38,6),
LaibPer			NUMERIC(38,6),
TotAchSales		NUMERIC(38,6),
Wk4PriVal		NUMERIC(38,6),
SchPrimary		NUMERIC(38,6),
MonTarget		NUMERIC(38,6),
CurMonth		NUMERIC(38,6), 
NrmlAmt			NUMERIC(38,6),
TOTAmt			NUMERIC(38,6),
FrmRange		NUMERIC(38,6),
ToRange			NUMERIC(38,6),
FixedPay		NUMERIC(38,6),
VarPay			NUMERIC(38,6),
OrgClmAmt		NUMERIC(38,6),
ClmAmt			NUMERIC(38,2),
UploadFlag		NVARCHAR(10),
Syncid			NUMERIC(38,0),
ServerDate		DATETIME
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_DebitNoteTopSheetClaimDt' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
GO
--exec Proc_Cs2Cn_DebitNoteTopSheetClaimDt 0,'2019-09-18'
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimDt
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_DebitNoteTopSheetClaimDt
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM DATA IN DETAIL
* DATE		:  14-11-2019
* CREATED	:  MOHANA S	
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt  WHERE UploadFlag ='Y'
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
		RETURN
	END
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @Month INT
	DECLARE @Year  INT
	DECLARE @SecSales NUMERIC(38,2)
	SELECT TOP 1  @Month = MonthiD,@Year = ClmYear FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'
	SELECT @FromDate= DATEADD(MONTH, (@Month)-1,DATEADD(YEAR, @Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Month,DATEADD(YEAR, @Year - 1900, 0)))

	SELECT DISTINCT ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget,Max(CreatedDate) CreatedDate
	INTO #SchemeCLaimCircular1
	FROM SchemeCLaimCircular WHERE ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	GROUP BY ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget

	SELECT DISTINCT ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget
	INTO #SchemeCLaimCircular
	FROM #SchemeCLaimCircular1 
	 
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CirRefNO,CirNo,SancDate,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'Sampling Claim',FromDate ,ToDate,ConRefNo,CirNo ,SancDate,SamAmt,'N',@ServerDate  from DebitNoteTopSheetClaim_Sampling A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Sampling Claim'
	AND ((SchValidFrom BETWEEN FromDate AND ToDate) OR (SchValidTill BETWEEN FromDate AND ToDate ))
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,
	Wk4PriVal,SchPrimary,OrgClmAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'Trade Scheme Claim',FrmDate,ToDate,SchDesc,S.CmpSchCode,CirNo,SchBudget,Lst2MntSAl,SecSales,LaibPer,Wk4PriVal,SchPrimary,OrgClmAmt,CalClmAmt,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN SchemeMaster S(NOLOCK) ON A.Schid =  S.Schid
	INNER JOIN SchemeCircularDetails C(NOLOCK) ON S.CmpSchCode=C.CmpSchCode
	AND ((SchValidFrom BETWEEN FrmDate AND ToDate) OR (SchValidTill BETWEEN FrmDate AND ToDate ))
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,Lst2MntSAl,MonTarget,CurMonth,OutletCnt,ClmAmt,UploadFlag,ServerDate)
	SELECT  @DistCode,DNDocNo,ClmDate ,'Institutional Claim',fromDate,ToDate,CtgCode,ConRefNo,CirNo,Lst2MntSAl,MonTarget ,CurMonth,OutletCnt,TotDiscount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Institutional Claim'
	AND ((SchValidFrom BETWEEN FromDate AND ToDate) OR (SchValidTill BETWEEN FromDate AND ToDate ))
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,CtgCode,CirRefNO,CirNo,NrmlAmt,TOTAmt,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'TOT cLAIM',FromDate,TODate,CtgCode,ConRefNo,CirNo,NrmlAmt,TOTAmt,DiffAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_TOTDiff A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)ON A.DNRefId = B.DNRefId
	INNER JOIN RetailerCategory R(NOLOCK) ON A.CtgName=R.CtgName 
	INNER JOIN #SchemeCLaimCircular C (NOLOCK) ON A.CirNo=C.CircularNO AND R.CtgCode =C.AttrCode AND ClaimType ='TOT cLAIM'
	AND ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,SchDesc,CirRefNO,CirNo,SchBudget,SecSales,LaibPer,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'Manual Claim',FromDate,Todate,SchDesc,''ConRefNo,CirNo,SchBudget ,SecSales ,LiabPerc,ClmAmt,'N',@ServerDate  FROM DebitNoteTopSheetClaim_Manual A 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,FromDate,ToDate,RefNo,CirRefNO,CirNo,SMCnt,TotAchSales,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'Distributor Incentive Claim',IncfromDate,InctODate,RefNo,ConRefNo,CirNO,SMCnt,TotAchSales,IncAmt,'N',@ServerDate 
	FROM DebitNoteTopSheetClaim_DistInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='Distributor Incentive Claim'
	INNER JOIN DistributorIncentiveMaster D(NOLOCK) ON A.RefNo = D.DistIRefno AND IncMonth =  DateName(mm,DATEADD(mm,@Month,-1)) AND IncYear=@Year
	AND ((IncfromDate BETWEEN @FromDate AND @ToDate) OR (IncToDate BETWEEN @FromDate AND @ToDate )) 
	WHERE B.UPLOAD='N'
	
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimDt(DistCode,DNDocRefNO,ClmDate,ClmType,RefNo,CirRefNO, CirNo,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate ,'SalesMan Incentive Claim',RefNo,ConRefNo ,CirNO,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,A.IncAmount,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_SMInc A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId 
	INNER JOIN #SchemeCLaimCircular C(NOLOCK) ON A.CirNo=C.CircularNO AND ClaimType ='SalesMan Incentive Claim'
	INNER JOIN SalesManincentiveDetail D(NOLOCK) ON A.RefNo = D.SMIRefno AND A.SMID =D. SMID 
	AND INCMONTH =DateName(mm,DATEADD(mm,@Month,-1)) AND INCYEAr = @Year  
	WHERE B.UPLOAD='N'

	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET  SancDate='1900-01-01' WHERE SancDate IS NULL

	UPDATE Cs2Cn_Prk_DebitNoteTopSheetClaimDt SET FromDate='1900-01-01',ToDate ='1900-01-01' WHERE FromDate IS NULL OR TODATE IS NULL
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Upload' AND module='DebitNoteTopSheetClaim_BrandWise'
INSERT INTO CustomUpDownload
SELECT 173,1,'DebitNoteTopSheetClaim_BrandWise','DebitNoteTopSheetClaim_BrandWise','Proc_Cs2Cn_Dummy','','Cs2Cn_Prk_DNTSClaimBrandWise','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='DebitNoteTopSheetClaim_BrandWise'
INSERT INTO Tbl_UploadIntegration
SELECT 72,'DebitNoteTopSheetClaim_BrandWise','DebitNoteTopSheetClaim_BrandWise','Cs2Cn_Prk_DNTSClaimBrandWise',GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_DNTSClaimBrandWise' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_DNTSClaimBrandWise
GO
CREATE TABLE Cs2Cn_Prk_DNTSClaimBrandWise
(
Slno			NUMERIC (38,0) IDENTITY(1,1),
DistCode		NVARCHAR(100),
DNDocRefNO		NVARCHAR(50) ,
ClmDate			DATETIME	 ,
FromDate		DATETIME	 ,
ToDate			DATETIME	 , 
ClmType			NVARCHAR(100),
CirSchCode		NVARCHAR(100),
BrandCode		NVARCHAR(100),
CostCentreCde	NVARCHAR(100),
CirNo			NVARCHAR(100),
CirDate			DATETIME,  
LaibPer			NUMERIC(38,2), --Circular Budget
SecSales		NUMERIC(38,2), 
ClmAmt			NUMERIC(38,2),
UploadFlag		NVARCHAR(10),
Syncid			NUMERIC(38,0),
ServerDate		DATETIME
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_DNTSClaimBrandWise' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_DNTSClaimBrandWise
GO
--exec Proc_Cs2Cn_DNTSClaimBrandWise 0,'2019-09-18'
CREATE PROCEDURE Proc_Cs2Cn_DNTSClaimBrandWise
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_DNTSClaimBrandWise
* PURPOSE	:  TO UPLOAD SAVED DEBITNOTETOPSHEET CLAIM IN BRAND AND COST CENTRE WISE
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @DistCode	AS NVARCHAR(50)
	SELECT @DistCode = DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise  WHERE UploadFlag ='Y'
	 
	IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
	BEGIN
		RETURN
	END
	
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @Month INT
	DECLARE @Year  INT
	DECLARE @SecSales NUMERIC(38,2)

	SELECT TOP 1  @Month = MonthiD,@Year = ClmYear FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'

	SELECT @FromDate= DATEADD(MONTH, (@Month)-1,DATEADD(YEAR, @Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Month,DATEADD(YEAR, @Year - 1900, 0)))

	SELECT @SecSales = SecSales FROM (
	SELECT ISNULL(SUM(SalNetAmt),0) SecSales FROM Salesinvoice WHERE SalInvDate BETWEEN @FromDate AND @ToDate 
	UNION
	SELECT ISNULL(-1*SUM(RtnNetamt),0) SecSales FROM Returnheader  WHERE REturnDate BETWEEN @FromDate AND @ToDate  
	)A
		
	EXEC Proc_ProductTaxPercentage_DNClaim  @Year,@Month  ,0,0  
	
	SELECT DISTINCT ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget,Max(CreatedDate) CreatedDate
	INTO #SchemeCLaimCircular1
	FROM SchemeCLaimCircular WHERE ((SchValidFrom BETWEEN @FromDate AND @ToDate) OR (SchValidTill BETWEEN @FromDate AND @ToDate ))
	GROUP BY ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget

	SELECT DISTINCT ConRefNo,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget 
	INTO #SchemeCLaimCircular
	FROM #SchemeCLaimCircular1
	
	--SAMPLING
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
					CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate,FromDate ,ToDate,'Sampling Claim',ConRefNo,BrandCode,CostCenter,CirNo ,Circulardate,CircularBudget,@SecSales,
	SUM(FD.TotalAmt),'N',@ServerDate  from DebitNoteTopSheetClaim_Sampling A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN FreeIssueHd F (NOLOCK) ON F.IssueDate BETWEEN A.FromDate AND A.Todate
	INNER JOIN FreeissueDt FD(NOLOCK) ON F.IssueId = FD.IssueId 
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON T.Prdid = FD.PrdId 
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.Brand_Code 
	INNER JOIN #SchemeClaimCircular S(NOLOCK) ON S.CircularNo=A.CirNo AND S.ClaimType = 'Sampling Claim'
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,ConRefNo,BrandCode,CostCenter,CirNo ,Circulardate,CircularBudget
	
	--TRADE
	SELECT SchId, SUM(OrgClmAmt/CalClmAmt) AS ClmPer  INTO #TradePer FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK)  
	ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND ApplyCapVal = 1   AND CALCLMAMT<>0
	GROUP BY SchId 

	SELECT DISTINCT A.Schid,DNDocNo,ClmDate,FrmDate,ToDate,S.CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget,
	CASE ISNULL(CalClmAmt,'') WHEN 0 THEN 0 ELSE
	CASE ApplyCapVal WHEN 1 THEN  CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax/ ClmPer ) ELSE SUM(DiscountPer/ ClmPer ) END
	 ELSE
	 CASE ApplyTaxForClaim WHEN 1 THEN SUM(SchAmtWithTax) ELSE SUM(DiscountPer)  END END END AS ClmAmt
	INTO #TradeClaimBrandWise
	FROM DebitNoteTopSheetClaim_Trade A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B (NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN DebitNoteTopSheetClaim_Trade_PrdWise  D(NOLOCK) ON A.Schid =D.Schid 	 
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON D.Prdid =T.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = T.Brand_Code 
	INNER JOIN Schememaster S(NOLOCK) ON S.Schid=A.Schid AND D.SchId = S.SchId 
	INNER JOIN SchemeCircularDetails SC(NOLOCK) ON S.CmpSchCode=SC.CmpSchCode
	LEFT OUTER JOIN #TradePer TS(NOLOCK) ON A.SchId =TS.SchId AND D.SchId = Ts.SchId AND S.schid = Ts.Schid
	GROUP BY A.Schid,DNDocNo,ClmDate,FrmDate ,ToDate,S.CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate ,Schbudget,ApplyCapVal,ClmPer,CalClmAmt,ApplyTaxForClaim
		 
	
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT  @DistCode,DNDocNo,ClmDate,FrmDate,ToDate,'Trade Scheme Claim',CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget,@SecSales,
	round(casT(sum(ClmAmt) AS NUMERIC(38,4)),4),'N',@Serverdate
	FROM #TradeClaimBrandWise GROUP BY DNDocNo,ClmDate,FrmDate,ToDate,CmpSchCode,BrandCode,CostCenter,CirNo,CircularDate,Schbudget
	--TOT
	SELECT DISTINCT R.RtrId,RC.CtgMainId,CtgCode,RC.CtgName,RtrValueClassId       
	INTO #Retailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	 
	SELECT  DNDocNo,ClmDate,FromDate ,ToDate,'TOT Claim' Clmtype,ConRefNo,R.CtgName,BrandCode,CostCenter,CircularNO,
	CircularDate,CircularBudget,SUM(T.Diff) ClmAmt
	INTO #TotFinal
	FROM DebitNoteTopSheetClaim_TOTDiff A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN DebitNoteTopSheetClaim_TOT_PrdWise T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID 
	INNER JOIN TBL_GR_BUILD_PH TH (NOLOCK) ON T.Prdid =TH.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = TH.Brand_Code
	INNER JOIN #Retailer R(NOLOCK) ON T.Rtrid = R.RtrId AND A.CtgName = R.CtgName    
	INNER JOIN #SchemeCLaimCircular S ON S.AttrCode = R.CtgCode AND (S.SchValidFrom BETWEEN @FromDate AND @ToDate 
	OR S.SchValidTill BETWEEN @FromDate AND @ToDate ) AND ClaimTYpe='TOT Claim'  AND A.CirNo = S.CircularNo 
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,BrandCode,CostCenter,R.CtgName,ConRefNo,CircularNO,
	CircularDate,CircularBudget
	
	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate,FromDate,ToDate,Clmtype,ConRefNo,BrandCode,CostCenter,CircularNO,CircularDate,CircularBudget,@SecSales,ClmAmt,
	'N',@ServerDate
	FROM #TotFinal 
	--MANUAL
	SELECT ManualClmDesc,ValidFrom,ValidTo,CircularNo,COUNT(CostCentreCde) CntCC INTO #ManualClaimCostCentre FROM ManualClaimCostCentre(NOLOCK)
	GROUP BY ManualClmDesc,ValidFrom,ValidTo,CircularNo

	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,CostCentreCde,CirNo,CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT DISTINCT @DistCode,DNDocNo,ClmDate,FromDate,Todate ,'Manual Claim','' ConRefNo,CostCentreCde,CirNo,CircularDate,0 CircularBudget,@SecSales,ClmAmt/CntCC,'N',@ServerDate  
	FROM DebitNoteTopSheetClaim_Manual A(NOLOCK) INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N'
	INNER JOIN ManualClaimDescription S(NOLOCK) ON  ((S.ValidFromDate BETWEEN A.FromDate AND A.ToDate) 
	OR (S.ValidToDate  BETWEEN A.FromDate AND ToDate) OR  (A.FromDate BETWEEN S.ValidFromDate AND S.ValidToDate) OR (A.ToDate BETWEEN S.ValidFromDate AND S.ValidToDate )) AND A.SCHDESC = S.MANUALCLMDESC AND A.CIRNO = S.CIRCULARNO
	INNER JOIN ManualClaimCostCentre M(NOLOCK) ON  M.MANUALCLMDESC = S.MANUALCLMDESC AND M.CircularNo = S.CircularNo AND  A.SchDesc = M.MANUALCLMDESC
	AND A.CIRNO = M.CircularNo AND M.ValidFrom = S.ValidFromDate OR M.ValidTo = S.ValidToDate 
	INNER JOIN #ManualClaimCostCentre N(NOLOCK) ON  N.MANUALCLMDESC = S.MANUALCLMDESC AND N.CircularNo = S.CircularNo AND  A.SchDesc = N.MANUALCLMDESC
	AND A.CIRNO = N.CircularNo AND M.ValidFrom = N.ValidFrom  AND M.ValidTo = N.ValidTo AND M.MANUALCLMDESC = N.MANUALCLMDESC AND M.CircularNo = N.CircularNo

	--DIST INCENTIVE
	SELECT DISTINCT DistIRefno,IncFromDate,IncToDate INTO #DistributorIncentiveMaster FROM DistributorIncentiveMaster A   
	WHERE (@FromDate BETWEEN IncFromDate AND IncToDate OR @ToDate BETWEEN IncFromDate AND IncToDate 
	OR IncFromDate BETWEEN @FromDate AND @ToDate OR IncToDate BETWEEN @FromDate AND @ToDate) 	 
	SELECT DistIRefno,SMId,PrdId,SUM(Sales) Sales  
	INTO #DistSales
	FROM (
	SELECT DIM.DistIRefno,SS.SMId,SIP.PrdId,
	ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2) Sales 
	FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) ON SS.SalId=SIP.SalId 
	INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1 AND PBD.SLNo=3
	INNER JOIN TaxPercentage_DNClaim  PO (NOLOCK) ON PO.SalId=SS.SalId AND PO.SalId=SIP.SalId AND PO.PrdSlno=SIP.SlNo and PO.TransId=1
	AND PO.UsrId = 0 AND PO.tranId = 0
	INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
	WHERE SS.Dlvsts>3  
	GROUP  BY DIM.DistIRefno,SS.SMId,SIP.PrdId 
	UNION ALL
	SELECT DIM.DistIRefno,SS.SMId,SIP.PrdId,
	-1*ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2)  Sales 
	FROM Returnheader SS (NOLOCK) INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid 
	INNER JOIN STOCKTYPE ST (NOLOCK) ON ST.StockTypeId=SIP.StockTypeId AND ST.SystemStockType=1
	INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1  AND PBD.SLNo=3
	INNER JOIN  TaxPercentage_DNClaim PO (NOLOCK) ON PO.SalId=SS.ReturnID AND PO.SalId=SIP.ReturnID AND PO.PrdSlno=SIP.SlNo and PO.TransId=2
	INNER JOIN  #DistributorIncentiveMaster DIM ON SS.ReturnDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
	AND PO.UsrId = 0 AND PO.tranId = 0
	WHERE SS.Status=0  GROUP  BY DIM.DistIRefno,SS.SMId,SIP.PrdId
	) A
	GROUP BY DistIRefno,SMId,PrdId  

	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate,@FromDate,@ToDate ,'Distributor Incentive Claim',ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget,@SecSales,
	SUM(ROUND(((Sales*C.IncPerc)/100),2)),'N',@ServerDate 
	FROM #DistSales A(NOLOCK) INNER JOIN TBL_GR_BUILD_PH B(NOLOCK) ON A.Prdid = B.Prdid
	INNER JOIN DistributorIncentiveAchDetail C(NOLOCK) ON C.SMid=A.SMID  AND  A.DistIRefno=C.DistIRefno
	INNER JOIN #DistributorIncentiveMaster D(NOLOCK) ON C.DistIRefno=D.DistIRefno AND    A.DistIRefno=D.DistIRefno
	INNER JOIN DebitnoteTopSheetClaim_Distinc E(NOLOCK) ON E.RefNo = C.DistIRefno AND E.RefNo =D.DistIRefno AND  A.DistIRefno=E.RefNo
	INNER JOIN DebitNoteTopSheetClaimHd H(NOLOCK) ON h.DNRefId = e.DNRefId AND H.Upload ='N'
	INNER JOIN CostCentreDetails CC(NOLOCK) ON CC.BrandCode = B.Brand_Code
	INNER JOIN  #SchemeCLaimCircular S(NOLOCK) ON ( S.SchValidFrom BETWEEN @FromDate  AND @ToDate  
	OR S.SchValidTill BETWEEN @FromDate  AND @ToDate )   AND S.ClaimType ='Distributor Incentive Claim'  AND E.CirNo = S.CircularNO
	GROUP BY   DNDocNo,ClmDate,ConRefNo,CirNo,CircularDate,CircularBudget,BrandCode,CostCenter
	
	SELECT DISTINCT  Prdid,SMIRefno  INTO  #IncentiveProducts
	FROM (
		SELECT DISTINCT E.Prdid ,B.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B(NOLOCK)
		INNER JOIN SalesManIncentiveMaster SS(NOLOCK) ON SS.SMIRefno=B.Smirefno 
		INNER JOIN ProductCateGOryValue C (Nolock) ON B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCateGOryValue D (Nolock) ON D.PrdCtgValLinkCode  LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E  (Nolock) On	D.PrdCtgValMainId = E.PrdCtgValMainId  
		WHERE SS.IncMonth= DateName(mm,DATEADD(mm,@Month,-1))   AND Incyear=@Year AND B.ActStatus=1 AND SMIRefStatus = 1
		UNION
		SELECT DISTINCT E.Prdid,SS.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B(NOLOCK)
		INNER JOIN SalesManIncentiveMaster SS(NOLOCK) ON SS.SMIRefno=B.Smirefno 
		INNER JOIN Product E  (Nolock) On	E.Prdid = B.Prdid
		WHERE SS.IncMonth=DateName(mm,DATEADD(mm,@Month,-1))  AND Incyear=@Year AND B.ActStatus=1 AND SMIRefStatus = 1		
	) A	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo  
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND upload='N'

	SELECT DISTINCT SMIrefno,SMID,Prdid into #SMIncentive1
	FROM (
		SELECT IP.SMIRefno,SS.SMID,SIP.Prdid,Sum(Sip.prdnetamount)  Sales FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) 
		ON SS.Salid=Sip.Salid
		INNER JOIN #IncentiveProducts IP (NOLOCK)  ON   IP.Prdid=Sip.prdid 
		WHERE SS.Dlvsts>3 AND DATENAME(MM,(SS.SalInvDate))=DateName(mm,DATEADD(mm,@Month,-1)) AND Year(SS.Salinvdate)=@Year --ILCRSTPAR5199
		GROUP  by SS.SMID,IP.SMIRefno,SIP.Prdid
		UNION ALL
		SELECT IP.SMIrefno,SS.SMID,SIP.Prdid,-Sum(Sip.prdnetamt)  Sales FROM Returnheader SS (NOLOCK)
		INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1) 
		INNER JOIN  #IncentiveProducts  IP (NOLOCK)  ON   SIP.Prdid=Sip.prdid   
		WHERE SS.Status=0 AND DATENAME(MM,(SS.Returndate))=DateName(mm,DATEADD(mm,@Month,-1))  AND Year(SS.Returndate)=@Year --ILCRSTPAR5199
		GROUP  by SS.SMID,IP.SMIRefno,SIP.Prdid
	) A
	GROUP BY SMID,SMIRefno,Prdid

	 
	SELECT  distinct A.SMIRefno,BrandCode,CostCenter,A.smid into #CostCentre
    FROM #SMIncentive1 A (NOLOCK)
	INNER JOIN SalesManincentiveDetail S (NOLOCK) ON A.SMIRefno = S.SMIRefno AND A.SMID =S.SMID 
	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo AND A.SMId = B.SmID and S.SMIRefno = B.RefNo  AND S.SMId = B.SmID 
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND C.UPLOAD='N'
	INNER JOIN TBL_GR_BUILD_PH T(NOLOCK) ON A.Prdid = T.PrdId 
	INNER JOIN CostCentreDetails CC(NOLOCK) ON CC.BrandCode = T.Brand_Code

	SELECT DISTINCT SMIRefno,Smid,count(CostCenter) Cnt into #Cnt FROM #CostCentre(NOLOCK) group by  SMIRefno,smid	

	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT @DistCode,DNDocNo,ClmDate,@FromDate,@ToDate ,'SalesMan Incentive Claim',ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget,@SecSales,
	SUM((B.IncAmount/CAST(Cnt AS NUMERIC(38,6)))),'N',@ServerDate 
	FROM #CostCentre A(NOLOCK) 
	INNER JOIN SalesManincentiveDetail S(NOLOCK) ON A.SMIRefno = S.SMIRefno AND A.SMID =S.SMID 
	INNER JOIN DebitNoteTopSheetClaim_SMInc B(NOLOCK) ON A.SMIRefno = B.RefNo AND A.SMId = B.SmID and S.SMIRefno = B.RefNo  AND S.SMId = B.SmID 
	INNER JOIN DebitNoteTopSheetClaimHd C(NOLOCK) ON B.DNREFID =C.DnREfid AND C.UPLOAD='N'
	INNER JOIN #Cnt N(NOLOCK) ON  A.SMIRefno = N.SMIRefno AND A.SMId = N.SmID and S.SMIRefno = N.SMIRefno  AND S.SMId = N.SmID
	INNER JOIN  #SchemeCLaimCircular SS(NOLOCK) ON ( SS.SchValidFrom BETWEEN @FromDate  AND @ToDate  
	OR SS.SchValidTill BETWEEN @FromDate  AND @ToDate )   AND SS.ClaimType ='SalesMan Incentive Claim'
	AND B.CirNo = SS.CircularNO 
	GROUP BY DNDocNo,ClmDate,ConRefNo,BrandCode,CostCenter,CirNo,CircularDate,CircularBudget

	INSERT INTO Cs2Cn_Prk_DNTSClaimBrandWise(DistCode,DNDocRefNO,ClmDate,FromDate,ToDate,ClmType,CirSchCode,BrandCode,CostCentreCde,CirNo,
	CirDate,LaibPer,SecSales,ClmAmt,UploadFlag,ServerDate)
	SELECT  @DistCode,DNDocNo,ClmDate,FromDate ,ToDate,'INSTITUTIONAL CLAIM' Clmtype,S.CMPSCHCODE,BrandCode,CostCenter,CircularNO,
	CircularDate,sCHEMEBudget,@SecSales,SUM(T.ClmAmt) ClmAmt,'N',@ServerDate
	FROM DebitNoteTopSheetClaim_InstTarget A(NOLOCK) 
	INNER JOIN DebitNoteTopSheetClaimHd B(NOLOCK) ON A.DNRefId = B.DNRefId AND B.UPLOAD='N' AND SCHTYPE=1
	INNER JOIN RetailerCategory R ON R.CtgName = A.CtgName 
	INNER JOIN DebitNoteTopSheetClaim_Inst_PrdWise T(NOLOCK) ON A.DNREFID = T.DNREFID AND B.DNREFID = T.DNREFID AND R.CtgMainId = T.CTGMAINID
	INNER JOIN SchemeMaster S ON S.SchId = T.SCHID
	INNER JOIN TBL_GR_BUILD_PH TH (NOLOCK) ON T.Prdid =TH.PrdiD
	INNER JOIN CostCentreDetails C(NOLOCK) ON C.BrandCode = TH.Brand_Code
	INNER JOIN SchemeCircularDetails SC ON S.CMPSCHCODE = SC.CMPSCHCODE AND A.CIRNO = SC.CIRCULARNO
	GROUP BY DNDocNo,ClmDate,FromDate ,ToDate,BrandCode,CostCenter,A.CtgName,S.CMPSCHCODE,CircularNO,
	CircularDate,sCHEMEBudget
 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='PROC_SMIncentiveCalculation' AND TYPE='P')
DROP PROCEDURE PROC_SMIncentiveCalculation
GO
/*
BEGIN TRAN
DELETE FROM SalesManincentiveDetail
update SalesManIncentiveMaster set IncentiveGenerated=0
EXEC PROC_SMIncentiveCalculation 2,0 
SELECT * FROM SalesManincentiveDetail
ROLLBACK TRAN
*/
CREATE PROCEDURE PROC_SMIncentiveCalculation
(
@Pi_UserId AS INT,
@Po_ErrNo AS TinyINT OUTPUT
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: PROC_SMIncentiveCalculation
* PURPOSE		: To Validate SalesMan incetive Data and insert into SalesMan incentive master and detail table
* CREATED		: Govindaraj.P
* CREATED DATE	: 02/03/2018
* MODIFIED
**************************************************************************************************************************************************************************************
* DATE      |	  PERSON			  | USER STORY ID  |	  CR/BZ		|       REMARKS                      
**************************************************************************************************************************************************************************************
* 16-05-2019		Govindaraj.P			CRCRSTPAR0054		CR			SalesMan incentive Calculation
* 18-07-2019		MOHANA S				ILCRSTPAR5199		BZ			VALIDATION HAS BEEN INCLUDED TO GET THE MONTH
* 20-12-2019		MOHANA S				ILCRSTPAR7092		BZ			Corrected Month & Year
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN	
 BEGIN TRY
			 
	DECLARE @Month AS  VARCHAR(50) 
	DECLARE @Year AS  INT
	DECLARE @MCnt AS INT
	
	DECLARE @date as DATETIME
	--SET @date=GETDATE()
	--SET @date=GETDATE()
	
	SELECT @date =CONVERT(VARCHAR(10),DATEADD(MONTH,-1,GETDATE()),121)
	 
	SELECT @Month=DATENAME(month,@date)
	SELECT @Year= YEAR(@date) 
 
	SET @Po_ErrNo=0
		IF NOT  EXISTS( SELECT A.JcmId,A.JcmJc,JcmSdt,JcmEdt,JcmYr
			FROM JCMonthEnd A INNER JOIN JcMast B ON A.JcmId=B.JcmId WHERE A.JcmId IN(SELECT JcmId FROM JCMast WHERE JcmYr=@Year)
			and JcmSdt<@date)
		BEGIN
			SET @Po_ErrNo=0
			RETURN
		END
		ELSE
		IF NOT  EXISTS (SELECT * FROM SalesManIncentiveMaster WHERE  SMIRefStatus=1 AND  IncMonth=@Month AND Incyear=@Year)
		BEGIN
			SET @Po_ErrNo=0
			RETURN
		END
		
		INSERT INTO MultiUserTransValidation(UserId,UserName,TransId,TransName,LockedDate)
		SELECT @Pi_UserId,'',174,'SalesMan Incentive',@date
		SELECT  SMIRefno,incmonth,Incyear ,SMID into  #SalesManIncentiveMaster  
		FROM SalesManIncentiveMaster CROSS JOIN SalesMan 
		WHERE SMCODE NOT IN('SMDUMMY01')AND  IncMonth=@Month AND Incyear=@Year
		AND SMIrefStatus=1
		SELECT DISTINCT  Prdid,SMIRefno  INTO  #IncentiveProducts
		 FROM (
			SELECT DISTINCT E.Prdid ,B.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B
			INNER JOIN #SalesManIncentiveMaster SS ON SS.SMIRefno=B.Smirefno 
			INNER JOIN ProductCateGOryValue C (Nolock) ON B.PrdCtgValMainId = C.PrdCtgValMainId 
			INNER JOIN ProductCateGOryValue D (Nolock) ON D.PrdCtgValLinkCode  LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
			INNER JOIN Product E  (Nolock) On	D.PrdCtgValMainId = E.PrdCtgValMainId  
			WHERE SS.IncMonth=@Month  AND Incyear=@Year AND B.ActStatus=1
			UNION
			SELECT DISTINCT E.Prdid,SS.SMIRefno  AS SMIRefno  FROM SMincentiveProducts  B
			INNER JOIN #SalesManIncentiveMaster SS ON SS.SMIRefno=B.Smirefno 
			INNER JOIN Product E  (Nolock) On	E.Prdid = B.Prdid
			WHERE SS.IncMonth=@Month  AND Incyear=@Year AND B.ActStatus=1			
		) A	
		
		CREATE TABLE #SMIncentive(
		SMIrefno		VARCHAR(100),
		SMID			INT,
		Sales			NUMERIC(18,3)
		)
		INSERT INTO #SMIncentive(SMIrefno,SMID,Sales)	
		SELECT DISTINCT A.SMIRefno,A.SMID,0  FROM #SalesManIncentiveMaster A
		CROSS JOIN (Select Smid From Salesman where SMCODE NOT IN('SMDUMMY01') ) B
		SELECT SMIrefno,SMID,SUM(Sales) Sales into #SMIncentive1
		 FROM (
			SELECT IP.SMIRefno,SS.SMID,Sum(Sip.prdnetamount)  Sales FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) 
			ON SS.Salid=Sip.Salid
			INNER JOIN #IncentiveProducts IP (NOLOCK)  ON   IP.Prdid=Sip.prdid 
			WHERE SS.Dlvsts>3 AND DATENAME(MM,(SS.SalInvDate))=@Month AND Year(SS.Salinvdate)=@Year --ILCRSTPAR5199
			GROUP  by SS.SMID,IP.SMIRefno
			UNION ALL
			SELECT IP.SMIrefno,SS.SMID,-Sum(Sip.prdnetamt)  Sales FROM Returnheader SS (NOLOCK)
			 INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1) 
			INNER JOIN #IncentiveProducts IP (NOLOCK)  ON   IP.Prdid=Sip.prdid   
			WHERE SS.Status=0 AND DATENAME(MM,(SS.Returndate))=@Month  AND Year(SS.Returndate)=@Year --ILCRSTPAR5199
			GROUP  by SS.SMID,IP.SMIRefno
		) A
		GROUP BY SMID,SMIRefno
		
		UPDATE A SET A.SALES=B.SALES FROM #SMIncentive A
		INNER JOIN #SMIncentive1 B ON A.SMIrefno=B.SMIRefno AND A.SMID=B.SMID
		
		----Added by S.Moorthi
		SELECT DISTINCT SMID INTO #SMNoSales FROM #SalesManIncentiveMaster A 
		WHERE NOT EXISTS(SELECT * FROM #SMIncentive B WHERE A.SMIRefno=B.SMIRefno AND A.SMID=B.SMID)
		
		INSERT INTO #SMIncentive(SMIrefno,SMID,Sales)
		SELECT DISTINCT A.SMIRefno,B.SMID,0 FROM #SMIncentive A CROSS JOIN #SMNoSales B	
		---S.Moorthi Till Here
			
		
		SELECT S.*,#SMIncentive.Sales,#SMIncentive.SMID AS SMID INTO #SalesmanIncentiveSlabs 
		FROM SalesmanIncentiveSlabs  S (NOLOCK)  
		INNER JOIN #SalesManIncentiveMaster SM (NOLOCK)  ON S.SMIRefno=Sm.SMIRefno 
		CROSS JOIN  #SMIncentive
		
		
		CREATE TABLE #SMincentiveSlabs
		(
		SMID INT,
		SMIRefNo Varchar(50),
		Slab INT,
		FromRange  Numeric(18,6),
		ToRange  Numeric(18,6),
		Eligible	INT
		)
		INSERT INTO #SMincentiveSlabs(SMID,SMIRefNo,Slab,FromRange,ToRange,Eligible)
		SELECT SMID,SMIRefNo, Slab ,FromRange,ToRange,1 AS Eligible
		FROM #SalesmanIncentiveSlabs (NOLOCK) 
		WHERE (Sales >= FromRange AND 	(Sales <= torange or ToRange <= 0))
	
	----Added by S.Moorthi for All Salesman Fixpay should be eligible
		SELECT SMIRefNo,MIN(SLAB) Slab INTO #MinSlab FROM 
		#SalesmanIncentiveSlabs GROUP BY SMIRefNo
		
		INSERT INTO #SMincentiveSlabs(SMID,SMIRefNo,Slab,FromRange,ToRange,Eligible)
		SELECT DISTINCT A.SMID,A.SMIRefNo,A.Slab ,FromRange,ToRange,0 AS Eligible FROM #SalesmanIncentiveSlabs A 
		INNER JOIN #MinSlab B ON A.SMIRefNo=B.SMIRefNo AND A.Slab=B.Slab 
		WHERE NOT EXISTS(SELECT * fROM #SMincentiveSlabs M WHERE A.SMIRefNo=M.SMIRefNo AND A.SMID=M.SMID)
		
	---S.Moorthi Till Here
		
		CREATE TABLE #SalesManincentive
		(
		 SMIRefNo VARCHAR(100),
		 IncMonth VARCHAR(50),
		 IncYear   INT,
		 SMID INT,
		 AchSales Numeric(18,6),
		 FixedPay Numeric(18,6),
		 VariablePay Numeric(18,6),
		 Slab INT,
		 IncPerc Numeric(18,6),
		 IncAmount Numeric(18,6)
		 )
		
		--S.Moorthi added Un Eligible Sales man Fixed Pay
		INSERT INTO  #SalesManincentive(SMIRefNo,IncMonth,IncYear,SMID,AchSales,FixedPay,VariablePay,Slab,IncPerc,IncAmount)
		SELECT S.SMIRefno,S.incmonth,S.Incyear,SS.SMID,SS.Sales,Sm.Fixedpay,
		CASE WHEN Eligible=1 THEN Sm.VariablePay ELSE 0 END,Sl.Slab AS Slab,SIL.SMIncentivePerc,
		CASE WHEN Eligible=1 THEN SM.VariablePay *(SIL.SMIncentivePerc/100.00) ELSE 0 END AS Incentive FROM  #SalesManIncentiveMaster  S INNER JOIN 
		#SMIncentive SS  (NOLOCK)  ON S.SMID=SS.Smid
		INNER JOIN SalesmanIncentiveSlabs SIL (NOLOCK) ON SIL.SMIRefno=S.SMIRefno
		INNER JOIN  #SMincentiveSlabs SL (NOLOCK)  ON SL.SMIRefno=S.SMIRefno AND Sl.Slab=Sil.Slab AND Sl.Smid=SS.SMid
		INNER JOIN SalesManIncentiveMaster  SM  (NOLOCK)  ON SM.SMIRefno=S.SMIRefno  AND SM.incmonth=S.incmonth AND SM.Incyear=S.Incyear
		WHERE SM.IncentiveGenerated=0
	
		
	  BEGIN TRANSACTION	
		INSERT INTO  SalesManincentiveDetail(SMIRefno,IncMonth,Incyear,SMID,AchSales,AchSlab,IncPerc,IncAmount,[TotalIncAmount],Upload,Availability,LastModBy
		,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT SMIRefno,IncMonth,Incyear,SMID,AchSales,Slab,IncPerc,IncAmount,
		Fixedpay+IncAmount as  [TotalIncAmount],
		0 AS upload,1 AS Availability,@Pi_UserId AS LastModBy,GETDATE() 
		AS  LastModDate,
		@Pi_UserId AS AuthId, GETDATE() AuthDate 
		FROM  #SalesManincentive
		
		UPDATE SalesManIncentiveMaster SET IncentiveGenerated=1  FROM  SalesManIncentiveMaster S 
		INNER JOIN SalesManincentiveDetail  SM ON SM.SMIRefno=S.SMIRefno 
		WHERE S.IncentiveGenerated=0 AND SM.UPLOAD=0
		
		DELETE FROM MultiUserTransValidation  WHERE TransId=174
	  COMMIT TRANSACTION
 END TRY
 BEGIN CATCH
	  ROLLBACK TRANSACTION	
	  SET @Po_ErrNo=1
 END CATCH
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ReturnManualClmDesc' AND TYPE ='TF')
DROP FUNCTION Fn_ReturnManualClmDesc
GO
--SELECT * FROM Fn_ReturnManualClmDesc ('2019-12-01','2019-12-31','2020-01-05') 
CREATE FUNCTION Fn_ReturnManualClmDesc(@FromDate AS DATETIME,@ToDate AS DATETIME,@ClmDate AS DATETIME)  
RETURNS @ReturnManualDesc TABLE  
(  
 RefId  INT,  
 ManualClmDesc VARCHAR(200)  
)   
AS  
/************************************************************************************************************************************  
* PROCEDURE  : Fn_ReturnManualClmDesc  
* PURPOSE  : To Validate the description in Manual Claim   
* CREATED BY : S.MOORTHI  
* CREATED DATE : 22/06/2018  
* MODIFIED  
* DATE        AUTHOR   CR/BZ USER STORY ID  DESCRIPTION           
-----------------------------------------------------------------------------------------------------------------------------------------        
 22/06/2018  S.Moorthi   CR  CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim  
 03/10/2018  Amuthakumar P  CR  CRCRSTPAR0029    Manual claim description with the status of activation   
 20/12/2019  Lakshman M   BZ ILCRSTPAR7103       Manual description claim dupliacte validation included.
 ***************************************************************************************************************************************/   
BEGIN  
DECLARE @TempData AS TABLE  
(  
 RefID    INT,  
 ManualClmDesc  VARCHAR(500),  
 EffectiveFromDate DATETIME  
)  
DECLARE @TempData1 AS TABLE  
(  
 RefID    INT, 
 CircularNo  VArchar(50), 
 ManualClmDesc  VARCHAR(500),
 ValidFromDate DATETIME,
 ValidToDate DATETIME
)

 INSERT INTO @TempData (RefID,ManualClmDesc,EffectiveFromDate)  
 SELECT RefID,ManualClmDesc, EffectiveFromDate fROM ManualClaimDescription WHERE EffectiveFromDate<=@ClmDate AND ActiveStatus=0  
 
 ------------ commented by lakshman M dated ON 20/12/2019 ---------------
  INSERT INTO @TempData1 (RefID,CircularNo,ManualClmDesc,ValidFromDate,ValidToDate)
  SELECT distinct A.MacRefId,B.CircularNo,C.ManualClmDesc,C.ValidFromDate,C.ValidToDate from manualclaimmaster A 
  INNER JOIN manualclaimdetails B ON A.macrefno =B.macrefno 
  INNER JOIN ManualClaimDescription C ON c.circularno =b.circularno  and C.[ManualClmDesc]  = B.[Description]
  INNER JOIN jcmonth D ON D.Jcmid =A.JCMid AND A.FromJcmJcId = D.jcmjc AND A.ToJcmJcId = D.jcmjc
  WHERE @FromDate BETWEEN JcmSdt and JcmEdt OR @ToDate BETWEEN JcmSdt and ValidToDate  
  OR JcmSdt BETWEEN @FromDate and @ToDate  or JcmEdt BETWEEN @FromDate and @ToDate 
 
 
 --INSERT INTO @ReturnManualDesc(RefId,ManualClmDesc)  
 --SELECT DISTINCT RefId,ManualClmDesc FROM ManualClaimDescription N(NOLOCK)   
 --WHERE @FromDate BETWEEN ValidFromDate and ValidToDate AND @ToDate BETWEEN ValidFromDate and ValidToDate  
 --OR ValidFromDate BETWEEN @FromDate and @ToDate or ValidToDate BETWEEN @FromDate and @ToDate  
 --AND NOT EXISTS(SELECT * FROM @TempData M WHERE M.RefID=N.RefID) 

  INSERT INTO @ReturnManualDesc(RefId,ManualClmDesc)  
  SELECT DISTINCT A.RefId,A.ManualClmDesc FROM ManualClaimDescription A(NOLOCK) 
  WHERE ManualClmDesc NOT IN(select ManualClmDesc from @TempData1 B )
  AND  @FromDate BETWEEN A.ValidFromDate and A.ValidToDate AND @ToDate BETWEEN A.ValidFromDate and A.ValidToDate
  AND  NOT EXISTS(SELECT * FROM @TempData M WHERE M.RefID=A.RefID)
  -------------- Till  Here -----------------
 --SELECT DISTINCT RefId,ManualClmDesc FROM ManualClaimDescription(NOLOCK)   
 --WHERE (@FromDate BETWEEN ValidFromDate and EffectiveFromDate OR @ToDate BETWEEN ValidFromDate and EffectiveFromDate  
 --OR ValidFromDate BETWEEN @FromDate and @ToDate or EffectiveFromDate BETWEEN @FromDate and @ToDate)  
 -- added by Amuthakumar CRCRSTPAR0029  
RETURN  
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Upload' AND module='DebitNoteTopSheetClaim_Header'
INSERT INTO CustomUpDownload
SELECT 171,1,'DebitNoteTopSheetClaim_Header','DebitNoteTopSheetClaim_Header','Proc_Cs2Cn_DebitNoteTopSheetClaimHd','','Cs2Cn_Prk_DebitNoteTopSheetClaimHd','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='DebitNoteTopSheetClaim_Header'
INSERT INTO Tbl_UploadIntegration
SELECT 70,'DebitNoteTopSheetClaim_Header','DebitNoteTopSheetClaim_Header','Cs2Cn_Prk_DebitNoteTopSheetClaimHd',GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_DebitNoteTopSheetClaimHd' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_DebitNoteTopSheetClaimHd
GO
CREATE TABLE Cs2Cn_Prk_DebitNoteTopSheetClaimHd
(
	[Slno]				[NUMERIC](38,0) IDENTITY(1,1),
	[DistCode]			[NVARCHAR](100),
	[DNDocRefNo]		[NVARCHAR](100) ,
	[DNDate]			[DATETIME] ,
	[ClmYear]			[INT] ,
	[ClmMonth]			[NVARCHAR](50) ,
	[SampAmt]			[NUMERIC](38, 2) ,
	[TradeSchAmt]		[NUMERIC](38, 2) ,
	[InstTarAmt]		[NUMERIC](38, 2) ,
	[TOTDiffAmt]		[NUMERIC](38, 2) ,
	[ManualClmAmt]		[NUMERIC](38, 2) ,
	[DistIncAmt]		[NUMERIC](38, 2) ,
	[SMIncAmt]			[NUMERIC](38, 2) ,
	[TotalAmt]			[NUMERIC](38, 2),
	[UploadFlag]		[NVARCHAR](10),
	[Syncid]			[NUMERIC](38,0),
	[ServerDate]		[DATETIME]
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='DebitNoteClaimMisMatch' AND TYPE='U')
BEGIN
	CREATE TABLE DebitNoteClaimMisMatch
	(
	DnDocRefNo	NVARCHAR(100),
	ClmAmt		NUMERIC(18,6),
	Upload		INT,
	CreatedDate	DATETIME
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_DebitNoteTopSheetClaimHd' AND TYPE='P')
DROP PROCEDURE  Proc_Cs2Cn_DebitNoteTopSheetClaimHd
GO
--exec Proc_Cs2Cn_DebitNoteTopSheetClaimHd 0,'2019-09-18'
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheetClaimHd
(
@Po_ErrNo   INT OUTPUT,
@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE   :  Proc_Cs2Cn_DebitNoteTopSheetClaimHd
* PURPOSE         :  TO UPLOAD SAVED CLAIM DETAILS IN HEADER WISE
* DATE                  :  18-11-2019
* CREATED          :  MOHANA S
* PMS NO           :  CRCRSTPAR0079
*******************************************************************************/
SET NOCOUNT ON
BEGIN
    SET @Po_ErrNo=0
    DECLARE @DistCode      AS NVARCHAR(50)
    SELECT @DistCode = DistributorCode FROM Distributor
    DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd WHERE UploadFlag ='Y'
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt WHERE UploadFlag ='Y'
	DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise WHERE UploadFlag ='Y'

    IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N')
    BEGIN
                    RETURN
    END
    
    INSERT INTO Cs2Cn_Prk_DebitNoteTopSheetClaimHd(DistCode,DNDocRefNo,DNDate,ClmYear,ClmMonth,SampAmt,TradeSchAmt,InstTarAmt,
                                                    TOTDiffAmt,ManualClmAmt,DistIncAmt,SMIncAmt,TotalAmt,UploadFlag,ServerDate )
    SELECT DISTINCT @DistCode,DNDocNo,ClmDate,ClmYear ,ClmMonth,SampAmt,TradeSchAmt,InstTarAmt,TOTDiffAmt,ManualClmAmt,DistIncAmt,
    SMIncAmt,TotalAmt,'N',@ServerDate FROM DebitNoteTopSheetClaimHd WHERE UPLOAD = 'N'               
    
    EXEC Proc_Cs2Cn_DebitNoteTopSheetClaimDt  @Po_ErrNo,@ServerDate
    
    EXEC Proc_Cs2Cn_DNTSClaimBrandWise @Po_ErrNo,@ServerDate 
    
    SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt
    INTO #Header
    FROM (
    SELECT DNDocRefNO,'Sampling Claim' ClmType,SampAmt ClmAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd  UNION
    SELECT DNDocRefNO,'Trade Scheme Claim',TradeSchAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd UNION                
    SELECT DNDocRefNO,'Institutional Claim',InstTarAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd     UNION
    SELECT DNDocRefNO,'TOT CLAIM',TOTDiffAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd UNION
    SELECT DNDocRefNO,'Manual Claim',ManualClmAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd     UNION
    SELECT DNDocRefNO,'Distributor Incentive Claim',DistIncAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd                 UNION
    SELECT DNDocRefNO,'SalesMan Incentive Claim',SMIncAmt FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd )A
    GROUP BY DNDocRefNO

    SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt INTO #SUMMARY   FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt GROUP BY  DNDocRefNO

    SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0))  ClmAmt INTO #BRANDWISE FROM Cs2Cn_Prk_DNTSClaimBrandWise GROUP BY  DNDocRefNO
    
    SELECT A.DNDocRefNO,SUM(ISNULL(A.CLMAMT-C.clmamt,0)) CLMAMT INTO #CALCULATED  FROM #SUMMARY A             
    INNER JOIN #Header C ON A.DNDocRefNO = C.DNDocRefNO                       
    GROUP BY A.DNDocRefNO
    
    INSERT INTO #CALCULATED
    SELECT B.DNDocRefNO,SUM(ISNULL(B.CLMAMT-C.clmamt,0)) CLMAMT  FROM #BRANDWISE B  
    INNER JOIN #Header C ON C.DNDocRefNO = B.DNDocRefNO  
    GROUP BY B.DNDocRefNO

    SELECT DNDocRefNO,SUM(ISNULL(ClmAmt,0)) ClmAmt INTO #CHECK FROM #CALCULATED GROUP BY DNDocRefNO   
	
	IF NOT EXISTS (SELECT * FROM Cs2Cn_Prk_DNTSClaimBrandWise)
	BEGIN
		INSERT INTO DebitNoteClaimMisMatch
		SELECT DNDocRefNO,0,0,GETDATE() FROM #CHECK
		 
		UPDATE DebitNoteTopSheetClaimHd SET UPload ='N',DNStatus = 0 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
		DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd
		DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt
		DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise
    END       
    
    IF EXISTS (SELECT * FROM #CHECK WHERE CLMAMT  BETWEEN -5 AND 5)
    BEGIN
        UPDATE  DebitNoteTopSheetClaimHd SET UPload ='Y',DNStatus = 1 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
        AND UPload = 'N'
    END
    ELSE
    BEGIN
		INSERT INTO DebitNoteClaimMisMatch
		SELECT DNDocRefNO,CLMaMT,0,GETDATE() FROM #CHECK WHERE CLMAMT NOT BETWEEN -5 AND 5
			
		UPDATE DebitNoteTopSheetClaimHd SET UPload ='N',DNStatus = 0 WHERE DNDocNo  IN (SELECT DNDocRefNo FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd)
				
        DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimHd
        DELETE FROM Cs2Cn_Prk_DebitNoteTopSheetClaimDt
        DELETE FROM Cs2Cn_Prk_DNTSClaimBrandWise
    END
	
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempSamplingClaimDetails' AND TYPE='U')
BEGIN
	CREATE TABLE TempSamplingClaimDetails
	(
	SanDate		DATETIME,
	FromDate	DATETIME,
	ToDate		DATETIME,
	CircularNo  NVARCHAR(100),
	SamAmt		NUMERIC(18,2),
	UsrId		INT,
	TransId		INT
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_SamplingClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_SamplingClaimDetails
GO
--EXEC Proc_SamplingClaimDetails 2019,10,1,504
CREATE PROCEDURE Proc_SamplingClaimDetails
(
	@Pi_Year	INT,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_SamplingClaimDetails
* PURPOSE	:  TO LOAD THE FREE ISSUE DETAILS
* DATE		:  05-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
SET NOCOUNT ON
	DELETE FROM  TempSamplingClaimDetails   

	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @CirNo	   NVARCHAR(100)
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))

	DECLARE @slno AS INT      
	DECLARE @SamplingAmount AS NUMERIC(18,2)      
	SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'      
      
	SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0) FROM FreeIssueHd J (NOLOCK),      
	FreeIssueDt D (NOLOCK),      
	ProductBatchDetails P (NOLOCK)      
	WHERE J.IssueId = D.IssueId       
	AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
	AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate  

	SELECT DISTINCT TOP 1 CircularNo ,MAX(CreatedDate ) CREATEDDATE
	INTO #SchemeClaimCircular FROM SchemeClaimCircular WHERE ((SchValidFrom BETWEEN @FromDate  AND @ToDate ) 
	OR ( SchValidTill BETWEEN @FromDate  AND @ToDate)) AND ClaimType='Sampling Claim'
	GROUP BY CircularNo
	
	SELECT @CirNo = CircularNo  FROM #SchemeClaimCircular 

	IF @SamplingAmount>0
	BEGIN
		INSERT INTO TempSamplingClaimDetails
		SELECT CONVERT (VARCHAR(10),GETDATE(),121),@FromDate,@ToDate,@CirNo,@SamplingAmount,@Pi_Usrid,@Pi_Transid		
	END

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempTradeSchemeClaimDetails' AND TYPE='U')
BEGIN
CREATE TABLE TempTradeSchemeClaimDetails
(
	Schid			INT,
	SchDesc			NVARCHAR(100),
	FromDate		DATETIME,
	ToDate			DATETIME,
	CirNo			NVARCHAR(100),
	SchBudget	 	NUMERIC(18, 2), 
	Lst2Avg			NUMERIC(18, 2),
	Wk4PriVal		NUMERIC(18, 2),
	SchPerdPriVal	NUMERIC(18, 2),
	SecSalValue		NUMERIC(18, 2),
	[LibPerc]		NUMERIC(18, 2),
	OrgClmAmt		NUMERIC(18, 2),
	CalClmAmt		NUMERIC(18, 2),
	ApplyCapVal		INT,
	UsrId			INT,
	TransId			INT
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_TradeSchemeClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_TradeSchemeClaimDetails
GO
--Proc_TradeSchemeClaimDetails 2019,12,1,504
CREATE PROCEDURE Proc_TradeSchemeClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_TradeSchemeClaimDetails
* PURPOSE	: TO LOAD SCHEME WISE CLAIM AMOUNT
* DATE		:  07-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
	DELETE FROM  TempTradeSchemeClaimDetails  
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
	 
	--EXEC Proc_SchUtilization_DNClaim @Pi_Year,@Pi_Month,@Pi_Usrid,@Pi_Transid    
	--EXEC Proc_ProductTaxPercentage_DNClaim  @Pi_Year,@Pi_Month,@Pi_Usrid,@Pi_Transid 
	     
	SELECT * INTO #ParleOutputTaxPercentage FROM TaxPercentage_DNClaim (NOLOCK)  WHERE USRID =@Pi_Usrid AND TRANID = @Pi_Transid 
	
	SELECT S.Salid,SalInvNo,SalInvDate,RtrId ,Prdid,PrdBatId ,BaseQty,Slno,PrdTaxAmount,PrdUnitSelRate 
	INTO #SalesInvoice 
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
	WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP,          
	SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,StockTypeId,S.SalId       
	INTO #ReturnHeader          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND
	S.ReturnDate BETWEEN  @FromDate AND @ToDate AND S.[Status] = 0 
	SELECT DISTINCT * INTO #ProductBatchDetails
	FROM(
	SELECT P.* FROM ProductBatchDetails P WHERE EXISTS (SELECT * FROM #SalesInvoice S WHERE S.PRDBATID = P.PRDBATID) AND   DefaultPrice =1 AND SLNo =3  
	UNION 
	SELECT P.* FROM ProductBatchDetails P WHERE EXISTS (SELECT * FROM #SalesInvoice S WHERE S.PRDBATID = P.PRDBATID) AND   DefaultPrice =1 AND SLNo =3 
	)A
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,S.PrdId,S.PrdBatId,S.BaseQty BaseQty,          
	B.DefaultPriceId ActualPriceId,S.SlNo,S.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
	INTO #BillingDetails          
	FROM #SalesInvoice S (NOLOCK)     
	INNER JOIN ProductBatch B (NOLOCK) ON S.PrdBatId = B.PrdBatId       
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId AND DefaultPrice =1        
	AND  PBD.SLNo =3 
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,S.PrdId,S.PrdBatId,-1 * S.BaseQty BaseQty,S.PrdUnitMRP MRP,          
	B.DefaultPriceId,S.SlNo,S.PrdEditSelRte,S.prdtaxamount,S.PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
	INTO #ReturnDetails          
	FROM #RETURNHEADER S (NOLOCK)       
	INNER JOIN ProductBatch B (NOLOCK) ON S.PrdBatId = B.PrdBatId          
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId AND DefaultPrice =1 AND PBD.SLNo =3   
	AND StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)       
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,      
	PrdBatDetailValue as PrdUnitSelRate,Schid,         
	CAST (0 AS NUMERIC(18,6)) AS LCTR      
	INTO #DebitSalesDetails          
	FROM           
	(          
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #BillingDetails(NOLOCK)         
	UNION ALL          
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId ,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #ReturnDetails (NOLOCK)       
	) Consolidated       
	UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)          
	FROM #DebitSalesDetails M (NOLOCK),          
	#ProductBatchDetails D (NOLOCK)           
	WHERE M.ActualPriceId = D.PriceId AND D.SLNo = 3      
	UPDATE R SET R.LCTR = ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2)            
	FROM #DebitSalesDetails R (NOLOCK),          
	#ParleOutputTaxPercentage T (NOLOCK)      
	WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType   
	CREATE TABLE #ApplicableProduct      
	(      
	SchId  INT,      
	PrdId   INT      
	)      
	INSERT INTO #ApplicableProduct(SchId,PrdId)      
	SELECT DISTINCT A.SchId,B.Prdid      
	FROM SchemeMaster A(NOLOCK)      
	INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid  AND A.SchemeLvlMode = 0
	AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme(NOLOCK))    
	INNER JOIN Product C(NOLOCK) On B.Prdid = C.PrdId  AND B.PrdId <> 0    
	UNION ALL      
	SELECT DISTINCT A.SchId,E.Prdid      
	FROM SchemeMaster A (NOLOCK)     
	INNER JOIN SchemeProducts B(NOLOCK) ON A.Schid = B.Schid AND A.SchemeLvlMode = 0  AND B.PrdCtgValMainId <> 0 
	AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme(NOLOCK))
	INNER JOIN ProductCategoryValue C(NOLOCK) ON B.PrdCtgValMainId = C.PrdCtgValMainId       
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
	INNER JOIN Product E(NOLOCK) On D.PrdCtgValMainId = E.PrdCtgValMainId       
	INNER JOIN ProductBatch F(NOLOCK) On F.PrdId = E.Prdid	       
	UNION ALL      
	SELECT DISTINCT S.SchId,B.MasterRecordId      
	FROM SchemeProducts A(NOLOCK)   
	INNER JOIN UdcDetails B(NOLOCK) on B.UDCUniqueId =A.PrdCtgValMainId   AND  A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme)     
	INNER JOIN SchemeMaster S(NOLOCK) ON A.SchId = S.SchId AND  S.SchemeLvlMode = 1     
	INSERT INTO #ApplicableProduct(SchId,PrdId)      
	SELECT Schid ,PrdId FROM SchemeMasterControlHistory A(NOLOCK)
	INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode  AND ChangeType='Remove' 
	AND EXISTS (SELECT SchId FROM SchemeProducts SP(NOLOCK) Where SP.SCHID=B.SCHID AND PrdCtgValMainId = 0 ) 
	AND EXISTS (SELECT SCHID FROM DN_Claim_Scheme D WHERE D.SCHID = B.SCHID)     
	INNER JOIN Product C ON c.PrdCCode = A.FromValue      
	WHERE ChangeType='Remove'   
	INSERT INTO #ApplicableProduct(SchId,PrdId)        
	SELECT DISTINCT A.SchId,E.Prdid      
	FROM SchemeMaster A      
	INNER JOIN SchemeMasterControlHistory B(NOLOCK) ON A.CmpSchCode = B.CmpSchCode  AND ChangeType='Remove' AND A.SchemeLvlMode = 0  
	AND EXISTS (SELECT SchId FROM SchemeProducts SP(NOLOCK) Where SP.SCHID=A.SCHID AND PrdCtgValMainId = 0 ) 
	AND EXISTS (SELECT SCHID FROM DN_Claim_Scheme D WHERE D.SCHID = A.SCHID)      
	INNER JOIN ProductCategoryValue C(NOLOCK) ON B.FromValue = C.PrdCtgValCode      
	INNER JOIN ProductCategoryValue D(NOLOCK) ON D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
	INNER JOIN Product E(NOLOCK) On D.PrdCtgValMainId = E.PrdCtgValMainId       
	INNER JOIN ProductBatch F(NOLOCK) On F.PrdId = E.Prdid  
		 
	SELECT S.Schid,SUM(PrdNetAmount) SchPrimary INTO #PrimaryBasedOnSch FROM PurchaseReceipt A (NOLOCK)
	INNER JOIN PurchaseReceiptProduct B(NOLOCK) ON A.PurRcptId = B.PurRcptId 
	INNER JOIN #ApplicableProduct C(NOLOCK) ON B.Prdid =C.Prdid AND SchId in (SELECT SchId FROM DN_Claim_Scheme(NOLOCK) )
	INNER JOIN Schememaster S ON S.Schid = C.Schid  
	INNER JOIN TradeSchemeFactors T ON S.CmpschCode=T.CmpSchCode AND InvDate BETWEEN T.ClaimDate AND @ToDate
	GROUP BY S.Schid 
	CREATE TABLE #ApplicableScheme      
	(      
	SchId   INT,      
	SchDsc   NVARCHAR(100),      
	SchValidFrom DATETIME,      
	SchValidTill DATETIME,       
	Budget   NUMERIC(18,2),      
	BudgetAllocationNo VARCHAR(100),      
	PrdId   INT      
	)     
	 
	INSERT INTO #ApplicableScheme (SchId,SchDsc,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)         
	SELECT DISTINCT A.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId      
	FROM #ApplicableProduct A (NOLOCK),      
	SchemeMaster S (NOLOCK)      
	WHERE A.SchId = S.SchId AND A.SchId  IN (SELECT SCHID FROM DN_Claim_Scheme)       
	AND S.Claimable = 1  
	SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount     
	INTO #SchemeDebit1      
	FROM #ApplicableScheme S (NOLOCK), 
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM(NOLOCK) 
	LEFT OUTER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode   
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=1 AND      
	(B.Transdate BETWEEN @FromDate AND @ToDate OR B.TransDate BETWEEN @FromDate AND @ToDate)     
	AND SM.CmpSchCode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type IN ('Trade Scheme','General Scheme'))
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate      
	ORDER BY S.SchId      
	INSERT INTO #SchemeDebit1       
	SELECT APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(S.BaseQty) [SecSalesQty],Round(CAST((sum(S.BaseQty*PrdBatDetailValue)+ (sum(S.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,2)),2)  AS  [SecSalesVal],      
	CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
	from #SalesInvoice S (NOLOCK)      
	INNER JOIN SalesInvoiceSchemeLineWise SIL(NOLOCK) ON SIL.Salid=s.Salid   AND SIL.Prdid =S.Prdid AND sil.prdbatid =S.PrdBatId       
	INNER JOIN #DebitSalesDetails DS (NOLOCK)ON DS.Salid =S.Salid   AND DS.Salid =SIl.Salid AND DS.Prdid =S.Prdid AND DS.prdbatid = S.prdbatid 
	AND DS.Prdid =SIL.Prdid AND DS.prdbatid =SIl.prdbatid        
	INNER JOIN #ApplicableScheme APS(NOLOCK) ON APS.schid = SIL.schid AND APS.Prdid =DS.Prdid AND APS.Prdid =SIL.Prdid       
	INNER JOIN SchemeMaster SM(NOLOCK) ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
	INNER JOIN #ParleOutputTaxPercentage T(NOLOCK) ON T.Salid =DS.Salid AND S.Salid =T.Salid AND S.Salid =SIL.Salid AND DS.SlNo =T.PrdSlno AND T.TransId = DS.TransType       
	LEFT OUTER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode     
	INNER JOIN #ProductBatchDetails D(NOLOCK) on D.prdbatid=SIL.prdbatid AND D.prdbatid=S.prdbatid AND D.SlNo=3 AND DefaultPrice=1      
	WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  AND Transtype=1 AND   
	(DS.Transdate BETWEEN @FromDate AND @ToDate      
	OR DS.TransDate BETWEEN @FromDate AND @ToDate)     
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type NOT IN ('Trade Scheme','General Scheme'))      
	GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,S.BaseQty,PrdBatDetailValue,T.TaxPerc      
	ORDER BY APS.SchId      
	INSERT INTO #SchemeDebit1      
	SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	FROM #ApplicableScheme S (NOLOCK),      
	#DebitSalesDetails B (NOLOCK) ,      
	SchemeMaster SM (NOLOCK)
	LEFT OUTER JOIN SchemeCirculardetails SC (NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode     
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=2 AND       
	(B.Transdate BETWEEN @FromDate AND @ToDate      
	OR  B.Transdate  BETWEEN @FromDate AND @ToDate)     
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type  IN ('Trade Scheme','General Scheme'))     
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate       
	ORDER BY S.SchId      
	INSERT INTO #SchemeDebit1      
	SELECT  APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(S.BaseQty) [SecSalesQty],Round(cast((sum(S.BaseQty*PrdBatDetailValue)+ (sum(S.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,6)),2) AS  [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
	from #Returnheader S (NOLOCK)       
	INNER JOIN ReturnSchemeLineDt SIL(NOLOCK) ON SIL.Returnid=s.Returnid  AND SIL.Prdid =S.Prdid AND sil.prdbatid =S.PrdBatId       
	INNER JOIN #DebitSalesDetails DS(NOLOCK) ON DS.Salid =S.Returnid  AND DS.Salid =SIl.Returnid AND DS.Prdid =S.Prdid AND DS.prdbatid = S.prdbatid AND DS.Prdid =SIL.Prdid AND DS.prdbatid =SIl.prdbatid        
	INNER JOIN #ApplicableScheme APS(NOLOCK) ON APS.schid = SIL.schid AND APS.Prdid =DS.Prdid AND APS.Prdid =SIL.Prdid       
	INNER JOIN SchemeMaster SM(NOLOCK) ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
	INNER JOIN #ParleOutputTaxPercentage T(NOLOCK) ON T.Salid =DS.Salid AND S.Returnid =T.Salid AND S.Salid =SIL.Returnid       
	AND DS.slno =T.PrdSlno AND T.TransId = DS.TransType       
	LEFT Outer JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode       
	INNER JOIN #ProductBatchDetails D(NOLOCK) on D.prdbatid=SIL.prdbatid AND D.prdbatid=S.prdbatid AND D.SlNo=3 AND DefaultPrice=1      
	WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  AND Transtype=2 AND      
	(DS.Transdate BETWEEN @FromDate AND @ToDate      
	OR DS.TransDate BETWEEN @FromDate AND @ToDate)    
	AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type not IN ('Trade Scheme','General Scheme'))     
	GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,S.BaseQty,PrdBatDetailValue,T.TaxPerc      
	ORDER BY APS.SchId      
	DELETE FROM #SchemeDebit1 WHERE SchId NOT IN (SELECT Schid FROM DN_Claim_Scheme WHERE Linetype=1)            
	INSERT INTO #SchemeDebit1      
	SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	FROM #ApplicableScheme S (NOLOCK),      
	#DebitSalesDetails B (NOLOCK) ,      
	SchemeMaster SM INNER JOIN SchemeCirculardetails SC(NOLOCK) ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
	,DN_Claim_Scheme D         
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  AND Transtype=2        
	AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid       
	AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)      
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
	ORDER BY S.SchId      
	SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
	SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	INTO #SchemeDebit       
	from #SchemeDebit1 A (NOLOCK)     
	INNER JOIN SCHEMEMASTER B(NOLOCK) ON A.schid=B.schid AND B.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) 
	where Schcategory_type IN ('Trade Scheme','General Scheme') )        --ILCRSTPAR5132
	GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate 
	     
	INSERT  INTO #SchemeDebit      
	SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
	SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
	CAST(0 AS NUMERIC(18,6)) Amount      
	from #SchemeDebit1 A      
	INNER JOIN SCHEMEMASTER B(NOLOCK) ON A.schid=B.schid AND 
	B.cmpschcode in (select Cmpschcode from SchemeCategorydetails(NOLOCK) where Schcategory_type NOT IN ('Trade Scheme','General Scheme') )      --ILCRSTPAR5132  
	GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate      
	SELECT DISTINCT TaxPerc,B.SalId,B.PrdId  INTO #TaxPerc FROM SalesInvoiceProduct B(NOLOCK)       
	INNER JOIN #ParleOutputTaxPercentage P ON P.SalId = B.SalId AND  B.SlNo = P.PrdSlno AND TRANSID = 1       
	SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt INTO #SchFinal FROM       
	(      
	SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt       
	FROM (              
	SELECT  Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM DN_Claim_Scheme A(NOLOCK)       
	INNER JOIN #TaxPerc B ON A.Salid = b.SalId AND a.Prdid = b.PrdId AND Linetype = 1   AND A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid     
	GROUP BY  A.PRDID,A.SchId,TaxPerc      
	)A      
	GROUP BY A.SchId,TaxPerc      
	)B Group by  sCHID  
	     
	INSERT INTO #SchFinal      
	SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt FROM       
	(      
	SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt          
	FROM (      
	SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM DN_Claim_Scheme A(NOLOCK) INNER JOIN RETURNPRODUCT B(NOLOCK) ON A.Salid = b.ReturnID AND a.Prdid = b.PrdId       
	INNER JOIN #ParleOutputTaxPercentage P ON P.SalId = B.ReturnID AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND P.TRANSID = 2 AND a.Linetype =2      
	AND StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)  AND A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	AND P.UsrId = @Pi_Usrid  AND P.Tranid = @Pi_Transid 
	GROUP BY  A.PRDID,A.SchId,TaxPerc      
	)A      
	GROUP BY A.SchId,TaxPerc      
	)B Group by  sCHID
	       
	UPDATE SD SET SD.Amount = CASE S.ApplyTaxForClaim WHEN 0 THEN schamt ELSE  (SchAmt+TaxAmt) END      
	FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid,SUM(SchAmt) SchAmt ,Sum(Taxamt) TaxAmt FROM  #SchFinal GROUP BY Schid) D 
	ON SD.Schid = D.Schid --CHANGED FOR CLAIMAMT MISMATCH      
	INNER JOIN SchemeMaster S ON S.SchId = D.SCHID AND S.SchId = SD.SCHID       
	UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))      
	FROM #SchemeDebit SD (NOLOCK)      
	WHERE SD.[SecSalesVal] <> 0   

	UPDATE #SchemeDebit SET Liab = (Amount / SecSalesVal) * 100 WHERE Liab > 0 

	INSERT INTO TempTradeSchemeClaimDetails 
	SELECT DISTINCT a.SchId,SchDsc,SchValidFrom,SchValidTill,ISNULL(CircularNo,''),ISNULL(SchemeBudget,0),0,0,0 AS SchPerdPriVal,SecSalesVal,
	Liab,Amount,Amount,0,@Pi_Usrid,@Pi_Transid FROM #SchemeDebit A 
	--LEFT OUTER JOIN TradeSchemeFactors B(NOLOCK)
	--ON A.Schid = B.Schid 
	Order by Schid 
	
	UPDATE A SET Lst2Avg= B.L2MPrimarySales ,Wk4PriVal=B.L4WPrimarySales FROM  TempTradeSchemeClaimDetails A 
	INNER JOIN TradeSchemeFactors B(NOLOCK)ON A.Schid = B.Schid 
	 
	UPDATE A  SET SchPerdPriVal = B.SchPrimary FROM TempTradeSchemeClaimDetails A(NOLOCK) INNER JOIN #PrimaryBasedOnSch B(NOLOCK) ON A.SCHID =B.SchId 
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	
	SELECT DISTINCT B.Schid,ISNULL(SUM(CapAmount+SchPerdPriVal),0)  AS CapAmount INTO #CapValue
	FROM TempTradeSchemeClaimDetails A(NOLOCK) INNER JOIN TradeSchemeFactors B(NOLOCK) ON A.Schid = B.Schid 
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
	GROUP BY B.Schid
	
	UPDATE A SET CalClmAmt = ISNULL(( CASE WHEN ISNULL(CapAmount,0)>OrgClmAmt THEN OrgClmAmt ELSE ISNULL(CapAmount,0) END ),0),ApplycapVal =ISNULL(( CASE WHEN ISNULL(CapAmount,0)>OrgClmAmt THEN 0 ELSE 1 END ),0) 
	FROM TempTradeSchemeClaimDetails A (NOLOCK)
	INNER JOIN #CapValue B ON A.Schid = B.Schid  AND CapAmount>0
	AND  A.UsriD   =@Pi_Usrid  AND A.Transid = @Pi_Transid 
 	
END
GO
IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='Cs2Cn_Prk_DebitNoteTopSheet5' AND b.name='ClaimDate')      
BEGIN      
	 ALTER TABLE Cs2Cn_Prk_DebitNoteTopSheet5 ADD ClaimDate DATETIME
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_DebitNoteTopSheet5' And Type ='P')
DROP Procedure Proc_Cs2Cn_DebitNoteTopSheet5
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_DebitNoteTopSheet5 0,'2019-08-31'
select * from Cs2Cn_Prk_DebitNoteTopSheet5 order by slno
Rollback Transaction
*/
CREATE PROCEDURE [Proc_Cs2Cn_DebitNoteTopSheet5]
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/**************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_DebitNoteTopSheet5 
* PURPOSE		: To Extract and Upload Manual Claim Details
* CREATED BY	: Amuthakumar P  CR : CRCRSTAPAR0023
* CREATED DATE	: 25/10/2018
* NOTE			:
* MODIFIED
***************************************************************************************************
* DATE       AUTHOR			CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
***************************************************************************************************/     
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	
	DELETE FROM Cs2Cn_Prk_DebitNoteTopSheet5 WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	DECLARE @FromDate DATETIME  
	DECLARE @ToDate DATETIME  
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK) 
		
	INSERT INTO Cs2Cn_Prk_DebitNoteTopSheet5 (DistCode,[SchemeDescription],
	[From],[TO],[CircularNo],[SchemeBudget],
	[SecSalesValue],[%LiabilityonSecSales],
	[ClaimAmount],[UploadFlag],SyncId,ServerDate,ClaimDate)
	SELECT @DistCode, MCD.DESCRIPTION,
	--MCM.MacDate As [From], MCM.MacDate AS [To],MCD.CircularNo,ProposedLibPercent,
	--convert(varchar(10),CAST(CAST(YEAR(MCM.MacDate) AS VARCHAR(4)) + '-' + CAST(MONTH(MCM.MacDate) AS VARCHAR(2)) + '-01' AS DATETIME),121) As [From], convert(varchar(10),cast(dateadd(dd,-(DAY(MCM.MacDate)),DATEADD(mm,1,MCM.MacDate))as datetime),121) AS [To] ,MCD.CircularNo,ProposedLibPercent,
	JCMSDt As [From], JCMEDt AS [To] ,MCD.CircularNo,ProposedLibPercent,
	TotalSales,ActualLibPercent,
	ClaimAmt,'N' UploadFlag,NULL,@ServerDate,MCM.MacDate
	FROM ManualClaimMaster MCM 
	INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo
	INNER JOIN jcmonth A ON  MCM.jcmid=A.jcmid and fromjcmjcid=jcmjc
	WHERE MacDate BETWEEN @FromDate AND @ToDate
	AND NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = MCM.MacRefNo)
	
	INSERT INTO UploadedSampling (SamplingRefNo,UploadDate)
	SELECT [CircularNo],GETDATE() FROM Cs2Cn_Prk_DebitNoteTopSheet5 P (NOLOCK)
	WHERE NOT EXISTS (SELECT 'C' FROM UploadedSampling L (NOLOCK) WHERE L.SamplingRefNo = P.[CircularNo])
	
	RETURN			
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_Claim_Manual' AND XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_Claim_Manual
GO
--SELECT * FROM Cs2Cn_Prk_ClaimAll
--EXEC Proc_Cs2Cn_Claim_Manual
CREATE PROCEDURE Proc_Cs2Cn_Claim_Manual
AS
SET NOCOUNT ON
/*********************************
* PROCEDURE: Proc_Cs2Cn_Claim_Manual
* PURPOSE: Extract ManualClaim sheet details from CoreStocky to Console
* NOTES:
* CREATED: Aarthi.R    05/08/2008
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
 2019-09-19	 VEKNAT. M			SR		ILCRSTPAR6018		Add Column Circular No, ValidDate, Budget.
*********************************/
BEGIN
	DECLARE @CmpID 	AS NVARCHAR(50)
	DECLARE @DistCode	AS NVARCHAR(50)
	DECLARE @ChkDate	AS DATETIME
	DECLARE @TransDate	AS DATETIME
	DELETE FROM Cs2Cn_Prk_ClaimAll WHERE UploadFlag = 'Y' AND ClaimType='Manual Claim'
	SELECT @CmpID = CmpId FROM Company WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor
	SELECT @ChkDate = NextUpDate FROM DayEndProcess	WHERE ProcId = 12
	SELECT @TransDate=DATEADD(D,-1,GETDATE())
	INSERT INTO Cs2Cn_Prk_ClaimAll
	(
		DistCode ,
		CmpName ,
		ClaimType ,
		ClaimMonth ,
		ClaimYear ,
		ClaimRefNo ,
		ClaimDate ,
		ClaimFromDate ,
		ClaimToDate ,
		DistributorClaim,
		DistributorRecommended,
		ClaimnormPerc,
		SuggestedClaim,
		TotalClaimAmt ,
		Remarks ,
		Description ,
		Amount1 ,
		ProductCode ,
		Batch ,
		Quantity1 ,
		Quantity2 ,
		Amount2 ,
		Amount3 ,--- Budget value
		TotalAmount ,
		Remark2			,
		Remark3			,--CRCRSTPAR0014
		UploadFlag,
		BillNo,-- CirCular No
		BillDate,-- Circular Validfrom Date
		Date2---- Circular ValidTo Date
	)
	SELECT @DistCode  AS DistCode,
		CmpName,'Manual Claim' AS ClaimType,
		DATENAME(MM,ClmDate)AS ClaimMonth,
		DATEPART(YYYY,ClmDate) AS  ClaimYear,
		CD.CircularNo AS ClaimRefNo,
		ClmDate AS ClaimDate,
		B.ValidFromDate AS ClaimFromDate,
		B.ValidToDate AS ClaimToDate,
		TotalClaimAmt,
		TotalClaimAmt,
		ClmPercentage,
		ClmAmount,
		RecommendedAmount,	
		CD.Remarks,
		CD.Description,
		0 AS Amount1,
		ISNULL(UDC.ColumnValue,'')AS ProductCode,
		'' AS Batch,
		0 AS Quantity1,
		0 AS Quantity2,
		0 AS Amount2,
		CD.ActualLibPercent AS Amount3,
		--ClaimAmt AS TotalAmount,
		ROUND((CD.ClaimAmt/CM.TotalClaimAmt)*CDD.RecommendedAmount,2) AS TotalAmount,
		CS.ClmCode,
		CD.RefNo,
		'N' AS UploadFlag,		CM.MacRefNo ,FromDate, ToDate
		FROM Company C WITH (NOLOCK)
		INNER JOIN ManualClaimMaster CM WITH (NOLOCK)  ON CM.CmpID=C.CmpID
		INNER JOIN ManualClaimDetails CD WITH (NOLOCK) ON CD.MacRefNo=CM.MacRefNo
		INNER JOIN ClaimSheetDetail CDD WITH (NOLOCK) ON CM.MacRefNo =CDD.RefCode AND CM.MacRefNo=CD.MacRefNo --AND CDD.Slno=CD.RefNo
		INNER JOIN ClaimSheetHd CS WITH (NOLOCK) ON CS.ClmId=CDD.ClmId AND CS.ClmGrpId= 16
		INNER JOIN ManualClaimDescription B ON CD.CircularNo=B.CirCularNo and CD.Description=B.ManualClmDesc
		LEFT OUTER JOIN UDCDetails UDC WITH (NOLOCK) ON UDC.MasterRecordId=CM.MacRefId
		AND UDC.MasterId= 35 AND UDCMasterId IN(SELECT MIN(UDCMasterId) FROM UDCMaster WHERE MasterId=36)
		WHERE CM.Status=1 AND CDD.Status=1 AND CS.Confirm=1 AND CS.Upload='N' AND CDD.SelectMode=1

END
GO
--TRUNCATE TABLE UploadingReportTransaction  
INSERT INTO UploadingReportTransaction (TransType,TransId,TransNo,TransDate)  
SELECT 1,1,'For RE-upload','2019-04-01' 
UNION ALL
SELECT 1,1,'For RE-upload',GETDATE() 
GO
EXEC Proc_Cs2Cn_DebitNoteTopSheet5 0,'2019-08-31'
GO
DELETE FROM UploadingReportTransaction WHERE TransNo='For RE-upload'
GO
IF EXISTS (SELECT * FROM ManualClaimMaster)
BEGIN
	UPDATE CS SET UPLOAD ='N' FROM ManualClaimMaster CM WITH (NOLOCK) 
	INNER JOIN ManualClaimDetails CD WITH (NOLOCK) ON CD.MacRefNo=CM.MacRefNo
	INNER JOIN ClaimSheetDetail CDD WITH (NOLOCK) ON CM.MacRefNo =CDD.RefCode AND CM.MacRefNo=CD.MacRefNo --AND CDD.Slno=CD.RefNo
	INNER JOIN ClaimSheetHd CS WITH (NOLOCK) ON CS.ClmId=CDD.ClmId AND CS.ClmGrpId= 16
	INNER JOIN ManualClaimDescription B ON CD.CircularNo=B.CirCularNo and CD.Description=B.ManualClmDesc
	WHERE B.ValidFromDate >='2019-04-01'
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempInsTargetClaimDetails' AND TYPE='U')
BEGIN
CREATE TABLE TempInsTargetClaimDetails
(
	CtgName			NVARCHAR(200) NULL,
	FromDate		DATETIME NULL,
	TODate			DATETIME NULL,
	CirNo			VARCHAR(50) NULL,
	MonTarget		NUMERIC(38, 2) NULL,
	Lst2MonAvgSal	NUMERIC(18, 2) NULL,
	CurMonth		NUMERIC(18, 2) NULL,
	OutletsCnt		NUMERIC(18, 0) NULL,
	ClmAmount		NUMERIC(38, 2) NULL,
	UsrId			INT,
	TransId			INT
)
END
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME = 'SCHTYPE' AND ID = OBJECT_ID ('TempInsTargetClaimDetails'))
BEGIN
	    ALTER TABLE TempInsTargetClaimDetails ADD SCHTYPE INT DEFAULT (0)
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='TempInstTargetClaim_PrdWise' AND TYPE='U')
BEGIN
CREATE TABLE TempInstTargetClaim_PrdWise
(	
	[Rtrid]		[INT] NULL,
	[Schid]		[int] NULL,
	[Prdid]		[int] NULL,
	[CtgMainId] [int] NULL,
	[ClmAmt]	[numeric](18, 2) NULL,
	[UsrId] [int] NULL,
	[TransId] [int] NULL
)
END
GO
DECLARE @Cnt INT
DECLARE @CntCode NVARCHAR(50)
DECLARE @CoaId INT
DECLARE @ClaimId INT
IF NOT EXISTS (SELECT * from COAMASTER WHERE AcName='Institutional Scheme' and AcLevel=4 and MainGroup=4)
BEGIN
	SET @CNT=(SELECT CURRVALUE+1 FROM COUNTERS WHERE TABNAME='COAMASTER')
	Set @CntCode=(select Max(AcCode)+1   from Coamaster where MainGroup=4 and AcLevel=4)
		
	INSERT INTO COAMASTER(CoaId,AcCode,AcName,AcLevel,MainGroup,Status,
	Availability,LastModBy,LastModDate,AuthId,AuthDate)
	SELECT @CNT,@CntCode,'Institutional Scheme',4,4,1,1,1,GETDATE(),1,GETDATE()
	UPDATE Counters SET CurrValue=CurrValue+1 WHERE TABNAME='COAMASTER'
END
IF NOT EXISTS (SELECT * FROM ClaimGroupMaster WHERE ClmGrpName ='Institutional Scheme')  
BEGIN	 
	SELECT @CoaId = CoaId FROM CoaMaster WHERE  MainGroup = 4 and AcLevel=4 AND AcName = 'Institutional Scheme'  
	SELECT @ClaimId = MAX(ClmGrpId) + 1 FROM ClaimGroupMaster  
	INSERT INTO ClaimGroupMaster (ClmGrpId,Cmpid,ClmGrpCode,ClmGrpName,AutoClaim,CoaId,  
	Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload,DisplayStatus,GSTTax,ServiceType,ServiceId,ServiceOrGoods)  
	SELECT @ClaimId,0,'CG10004','Institutional Scheme',0,@CoaId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),  
	1,CONVERT(VARCHAR(10),GETDATE(),121),0,1,0,2,0,2
		
	UPDATE Counters SET CurrValue =  @ClaimId WHERE TabName ='ClaimGroupMaster' 
		
	IF EXISTS(SELECT * FROM ClaimNormDefinition)
	BEGIN 
		INSERT INTO ClaimNormDefinition(ClmNormId,CmpId,ClmGrpId,Claimable,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT MAX(ClmNormId),MAX(CmpId),@ClaimId,100.00,1,1,GETDATE(),1,GETDATE() FROM ClaimNormDefinition
	END
		
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_InStBaseDiscountClaim' AND TYPE='P')
DROP PROCEDURE Proc_InStBaseDiscountClaim
GO
/*
--EXEC Proc_InStBaseDiscountClaim 2019,12,2,1
*/  
CREATE PROCEDURE Proc_InStBaseDiscountClaim
(   
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_UsrId	INT,
	@Pi_Transid	INT
)  
AS  
/*******************************************************************************************************************
* PROCEDURE	: Proc_SchUtilization_DNClaim  (COPIED FROM REPORT PROCEDURE)
* PURPOSE	: TO GET THE SCHEME UTILIZATION DETAILS IN GIVEN PERIOD
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 15-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************
* DATE			RESOURCE			CR/BZ				USERSTORYID					DESCRIPTION
* 18-12-2019	MOHANA S			CR					CRCRSTPAR0095				RESTIRCTED INSTITUTIONAL SCHEME IN TRADE SCHEME DOWNLOAD
**********************************************************************************************************************/
BEGIN  
SET NOCOUNT ON  
	 
	DECLARE @Pi_FromDate  DATETIME
	DECLARE @Pi_Todate	   DATETIME
	
	DECLARE @InsFromDate AS DATETIME       
	DECLARE @InsToDate  AS DATETIME   
  
	SELECT @Pi_FromDate= DATEADD(MONTH, (@Pi_Month)-1, CONVERT(VARCHAR(10),@Pi_Year))

	SELECT @Pi_Todate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,CONVERT(VARCHAR(10),@Pi_Year)))	
	 
	DELETE FROM TempInsTargetClaimDetails WHERE SchType<>0
	
	SELECT * INTO #SchemeMaster  FROM SchemeMaster WHERE ClmRefId  IN (SELECT ClmgrpId FROM ClaimGroupMaster WHERE ClmGrpCode ='CG10004') --CRCRSTPAR0095
    
    
	SELECT DISTINCT B.* INTO #SalesInvoiceSchemeLineWise FROM SalesInvoice A (NOLOCK)
	INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SALID =B.SALID AND  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3  
	INNER JOIN #SchemeMaster C ON C.Schid = B.Schid
	AND ClmRefId  IN (SELECT ClmgrpId FROM ClaimGroupMaster WHERE ClmGrpCode ='CG10004') --CRCRSTPAR0095

	SELECT Distinct A.SchId into #SchemeID FROM #SalesInvoiceSchemeLineWise A (NOLOCK) INNER JOIN #SchemeMaster B ON A.Schid = B.Schid 
	
  
	SELECT  DISTINCT RSF.* INTO #ReturnSchemelinedt FROM ReturnHeader RH (NOLOCK)  
	INNER JOIN ReturnSchemelinedt RSF(NOLOCK) ON  RH.ReturnId = RSF.ReturnId  AND
	ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0 
	INNER JOIN #SchemeMaster C ON C.Schid = RSF.Schid
	AND ClmRefId  IN (SELECT ClmgrpId FROM ClaimGroupMaster WHERE ClmGrpCode ='CG10004') --CRCRSTPAR0095
	  
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RtrValueClassId,CtgName,CtgCode    
	INTO #FilterRetailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId     
	
	SELECT R.Rtrid,Schid,Prdid,CtgMainId,CtgName,CtgCode,CircularNo,SUM(ClmAmt) ClmAmt,CAST(0 AS NUMERIC(18,2))   CurMSales,CAST(0 AS NUMERIC(18,2))   L2MSales,0 Outlet 
	INTO #InstDiscount	
	FROM 
	(
	SELECT B.Rtrid,C.SchId,PrdId,CircularNo,SUM(DiscountPerAMount+FlatAmount) ClmAmt FROM #SalesInvoiceSchemeLineWise A 
	INNER JOIN Salesinvoice B ON A.SalId = B.SalId 
	INNER JOIN SchemeMaster C  ON C.Schid = A.Schid 
	INNER JOIN Schemecirculardetails D ON C.CmpSchcode=D.CmpSchcode 
	INNER JOIN #FilterRetailer R ON B.RtrId = R.Rtrid AND B.RtrValueClassId = R.RtrValueClassId 
	GROUP BY B.RtrId ,CircularNo,C.SchId,PrdId
	UNION 
	SELECT RH.Rtrid,C.SchId,PrdId,CircularNo,-1*SUM(ReturnDiscountPerAmount+ReturnFlatAmount)ClmAmt  FROM #ReturnSchemelinedt RSF 
	INNER JOIN  ReturnHeader RH ON RH.ReturnId = RSF.ReturnId
	INNER JOIN SchemeMaster C  ON C.Schid = RSF.Schid 
	INNER JOIN Schemecirculardetails D ON C.CmpSchcode=D.CmpSchcode 
	INNER JOIN #FilterRetailer R ON RH.RtrId = R.Rtrid AND RH.RtrValueClassId = R.RtrValueClassId 
	GROUP BY RH.RtrId,CircularNo ,C.SchId,PrdId
	)A INNER JOIN #FilterRetailer R ON A.RtrId = R.Rtrid
	GROUP BY R.Rtrid,Schid,Prdid,CtgMainId,CtgName,CtgCode ,CircularNo

	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
	INTO #CurrentSales      
	FROM       
	(      
	SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK)
	INNER JOIN  #FilterRetailer R  ON S.SalInvDate BETWEEN @Pi_FromDate AND @Pi_Todate AND S.DlvSts > 3      
	AND S.RtrId = R.RtrId AND S.RtrValueClassId = R.RtrValueClassId 
	INNER JOIN #SalesInvoiceSchemeLineWise SI ON S.SalId = SI.SalId 
	GROUP BY R.CtgMainId      
	UNION ALL      
	SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK)     
	INNER JOIN #FilterRetailer F ON ReturnDate BETWEEN @Pi_FromDate AND @Pi_Todate AND R.Status = 0      
	AND F.RtrId = R.RtrId   AND R.RtrValueClassId = R.RtrValueClassId  
	INNER JOIN #ReturnSchemelinedt SI ON R .ReturnId = SI.ReturnId    
	GROUP BY F.CtgMainId      
	) AS S GROUP BY S.CtgMainId   

	SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet      
	INTO #NoOfOutlet      
	FROM SalesInvoice S (NOLOCK),      
	#FilterRetailer R      
	WHERE S.SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND S.DlvSts > 3      
	AND S.RtrId = R.RtrId      
	GROUP BY R.CtgMainId  
  
	--Last Two Month Sales      
	 SELECT @InsToDate = DATEADD (D,-1,@InsFromDate)       
	SELECT @InsFromDate = DATEADD (MONTH,-2,@InsFromDate)
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
	INTO #L2MSales      
	FROM       
	(      
		SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK) 
		INNER JOIN #FilterRetailer R ON S.SalInvDate BETWEEN  @InsFromDate AND @InsFromDate AND S.DlvSts > 3      
		AND S.RtrId = R.RtrId      
		INNER JOIN #SalesInvoiceSchemeLineWise SI ON S.SalId = SI.SalId 
		GROUP BY R.CtgMainId      
		UNION ALL      
		SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK)
		INNER JOIN #FilterRetailer F      
		ON R.ReturnDate BETWEEN  @InsFromDate AND @InsFromDate AND R.Status = 0      
		AND F.RtrId = R.RtrId 
		INNER JOIN #ReturnSchemelinedt SI ON R .ReturnId = SI.ReturnId     
		GROUP BY F.CtgMainId      
	) AS S GROUP BY S.CtgMainId 
  
	UPDATE I SET I.CurMSales = C.Sales FROM #InstDiscount I (NOLOCK), #CurrentSales C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId 
 
	UPDATE I SET I.L2MSales = C.Sales / 2  FROM #InstDiscount I (NOLOCK),#L2MSales C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId      

	UPDATE I SET I.Outlet = C.Outlet FROM #InstDiscount I (NOLOCK),#NoOfOutlet C (NOLOCK)      
	WHERE I.CtgMainId = C.CtgMainId   

	select * from #InstDiscount	 

	INSERT INTO TempInsTargetClaimDetails
	SELECT CtgName,@Pi_FromDate,@Pi_Todate,CircularNO,0,L2MSales,CurMSales,Outlet ,SUM(ClmAmt) ClmAmt,@Pi_UsrId,@Pi_Transid,1 FROM #InstDiscount
	GROUP BY CtgName,CircularNO,L2MSales,CurMSales,Outlet

	INSERT INTO TempInstTargetClaim_PrdWise
	SELECT Rtrid,Schid,Prdid,CtgMainId,ClmAmt,@Pi_UsrId,@Pi_Transid FROM #InstDiscount

	SELECT * FROM TempInsTargetClaimDetails

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_InsTargetClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_InsTargetClaimDetails
GO
--EXEC Proc_InsTargetClaimDetails 2019,12,1,504
CREATE PROCEDURE Proc_InsTargetClaimDetails
(
	@Pi_Year	INT,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_InsTargetClaimDetails
* PURPOSE	:  TO LOAD ACHIEVED TARGET DETAILS
* DATE		:  07-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
SET NOCOUNT ON

	DELETE FROM  TempInsTargetClaimDetails 
	DELETE FROM TempInstTargetClaim_PrdWise

	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
  
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0))) 
  
	DECLARE @TargetNo AS INT      
	DECLARE @InsFromDate AS DATETIME       
	DECLARE @InsToDate  AS DATETIME      
	DECLARE @Year AS INT       
	DECLARE @Month  AS INT      
	DECLARE @MonthName as Nvarchar(100) 

      
		SELECT   TOP 1 @TargetNo = InsId,@Month=TargetMonth,@Year=TargetYear,
		@InsFromDate = CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01',      
		@InsToDate = DATEADD(DD,-1,DATEADD(MM,1,CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01'))       
		FROM InsTargetHD H (NOLOCK)       
		INNER JOIN  JCMonth A  ON H.TargetMonth = A.JcmJc      
		INNER JOIN    JCMast b on a.JcmId = b.JcmId AND H.TargetYear =  B.JcmYr      
		WHERE A.JcmEdt  BETWEEN @FromDate AND @ToDate AND H.[Status] = 1       
		ORDER BY InsId DESC 
 
		SELECT @MonthName=MonthName FROM MonthDt (NOLOCK) WHERE MonthId=@Month  
		UPDATE InsTargetHD SET TargetMonth=EffFromMonthId WHERE TargetMonth=0   
   
		EXEC Proc_LoadingInstitutionsTarget @Pi_Year,@Month,@MonthName,@Pi_UsrId  
  
		SELECT CtgMainId,CtgName,@InsFromDate FromDate,@InsToDate ToDate,SUM([Target]) [Target],SUM(ClmAmount) DiscAmount,      
		CAST(0 AS NUMERIC(18,6)) L2MSales,CAST(0 AS NUMERIC(18,6)) CurMSales,CAST(0 AS NUMERIC(18,0)) Outlet      
		INTO #Institutions      
		FROM InsTargetDetailsTrans (NOLOCK) WHERE CtgName <>''         
		GROUP BY CtgMainId,CtgName     

		SELECT DISTINCT R.RtrId,RC.CtgMainId,RtrValueClassId    
		INTO #FilterRetailer      
		FROM Retailer R (NOLOCK),      
		RetailerValueClassMap RVCM (NOLOCK),      
		RetailerValueClass RVC (NOLOCK),      
		RetailerCategory RC (NOLOCK),      
		RetailerCategoryLevel RCL (NOLOCK)      
		WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
		AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId      
		AND EXISTS (SELECT '' FROM #Institutions I (NOLOCK) WHERE I.CtgMainId = RC.CtgMainId)  

		SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
		INTO #CurrentSales      
		FROM       
		(      
		SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),      
		#FilterRetailer R      
		WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
		AND S.RtrId = R.RtrId AND S.RtrValueClassId = R.RtrValueClassId 
		GROUP BY R.CtgMainId      
		UNION ALL      
		SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),      
		#FilterRetailer F      
		WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0      
		AND F.RtrId = R.RtrId   AND R.RtrValueClassId = R.RtrValueClassId     
		GROUP BY F.CtgMainId      
		) AS S GROUP BY S.CtgMainId   

	SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet      
	INTO #NoOfOutlet      
	FROM SalesInvoice S (NOLOCK),      
	#FilterRetailer R      
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
	AND S.RtrId = R.RtrId      
	GROUP BY R.CtgMainId  
  
	--Last Two Month Sales      
	SELECT @InsToDate = DATEADD (D,-1,@InsFromDate)       
	SELECT @InsFromDate = DATEADD (MONTH,-2,@InsFromDate)       
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
	INTO #L2MSales      
	FROM       
	(      
		SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),      
		#FilterRetailer R      
		WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
		AND S.RtrId = R.RtrId      
		GROUP BY R.CtgMainId      
		UNION ALL      
		SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),      
		#FilterRetailer F      
		WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0      
		AND F.RtrId = R.RtrId      
		GROUP BY F.CtgMainId      
	) AS S GROUP BY S.CtgMainId
	
 
		UPDATE I SET I.CurMSales = C.Sales FROM #Institutions I (NOLOCK), #CurrentSales C (NOLOCK)      
		WHERE I.CtgMainId = C.CtgMainId 
 
		UPDATE I SET I.L2MSales = C.Sales / 2  FROM #Institutions I (NOLOCK),#L2MSales C (NOLOCK)      
		WHERE I.CtgMainId = C.CtgMainId      

		UPDATE I SET I.Outlet = C.Outlet FROM #Institutions I (NOLOCK),#NoOfOutlet C (NOLOCK)      
		WHERE I.CtgMainId = C.CtgMainId  

	 
		SELECT CtgMainId ,CircularNo,Max(CreatedDate) CreatedDate INTO #Circular FROM SchemeClaimCircular A --WHERE  
		INNER JOIN RetailerCategory B ON A.AttrCode = B.CtgCode AND A.AttrType<>'Class'
		AND ((@FromDate  BETWEEN  SchValidFrom AND SchValidTill  ) OR (@ToDate  BETWEEN  SchValidFrom AND SchValidTill)) 
		WHERE ClaimType='Institutional Claim' GROUP BY CtgMainId ,CircularNo
 

		INSERT INTO TempInsTargetClaimDetails
		SELECT CtgName [Name Of the Category],convert(varchar(10),FromDate,121) [From],convert(varchar(10),ToDate,121) [To],ISNULL(CircularNo,'') ,[Target] [Monthly Target],      
		L2MSales [Last 2 Months Avg Sales],CurMSales [Current Month],Outlet [No of Incentive Outlets],DiscAmount [Total Discount Amount],@Pi_Usrid,@Pi_Transid,0    
		FROM #Institutions A(NOLOCK)   
		INNER JOIN #Circular B ON A.CTGMAINID = B.CTGMAINID 	 

EXEC Proc_InStBaseDiscountClaim @Pi_Year,@Pi_Month,@Pi_Usrid,@Pi_Transid

END									
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempTOTClaimDetails' AND TYPE='U')
BEGIN
	CREATE TABLE TempTOTClaimDetails
	(
	CtgName		NVARCHAR(100),
	Rtrid		INT,
	PrdId		INT,
	FromDate	DATETIME,
	ToDate		DATETIME,
	CirNo  NVARCHAR(100),
	NrmlAmt		NUMERIC(18,2),
	TOTAmt		NUMERIC(18,2),
	DiffAmt		NUMERIC(18,2),
	UsrId		INT,
	TransId		INT
	)
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME='Fn_ReturnToSampleInvoiceCmpName' AND TYPE='TF')
DROP FUNCTION Fn_ReturnToSampleInvoiceCmpName
GO
--Select * from DBO.Fn_ReturnToSampleInvoiceCmpName(0)
CREATE FUNCTION Fn_ReturnToSampleInvoiceCmpName(@RefId AS INT)  
RETURNS @Company  TABLE
(
	CmpId INT,
	CMPNAME NVARCHAR(100)
)
AS  
/**************************************************
* Function : Fn_ReturnToSampleInvoiceCompanyName
* PURPOSE   : To Display by default the Company Name as PARLE BISCUITS PVT LTD
* NOTES     : 
* CREATED   : S.MOORTHI
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
-----------------------------------------------------------------------      
 27/11/2018  S.Moorthi			CR		ILCRSTPAR2672       Comapny name will be fixed to "PARLE BISCUITS PVT  LTD"
 19/12/2019  S.Mohana			BZ		CRCRSTPAR0079       GET CmpId
 **************************************************/ 
BEGIN
---As per Awanish/Client request it should be display purpose.

	INSERT INTO  @Company
	SELECT Cmpid,CmpName  FROM Company WHERE CMPCODE<>'ALL'
 RETURN 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_TOTClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_TOTClaimDetails
GO
--EXEC Proc_TOTClaimDetails 2019,12,1,504
CREATE PROCEDURE Proc_TOTClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_TOTClaimDetails
* PURPOSE	:  TO LOAD TOT CLAIM DETAILS
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
SET NOCOUNT ON
	CREATE Table #TotClaimFinal       
	(      
	CtgName		NVARCHAR(100),
	Rtrid		INT,
	Prdid		INT,      
	Fromdate	DATETIME,      
	Todate		DATETIME,      
	NrmlRate	NUMERIC (18,2),      
	SecSalesTot NUMERIC (18,2),      
	DiffClaims	NUMERIC (18,2)       
	)
	DELETE FROM  TempTOTClaimDetails  
	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
	 
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate 
	     
	SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)    
	
	SELECT PRDBATID INTO #PRDBATID FROM (
	SELECT PrdBatid FROM SalesInvoice S (NOLOCK) INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	UNION
	SELECT PrdBatid FROM ReturnHeader S (NOLOCK) INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0
	)A
	SELECT * INTO #ProductBatchDetails FROM ProductBatchDetails WHERE PrdBatid in (SELECT * FROM #PrdBatid) and slno=3
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,
	CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,         
	B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue ,RtrValueClassId        
	INTO #BillingDetails1          
	FROM SalesInvoice S (NOLOCK)          
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId       
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1         
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3  
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,        
	B.DefaultPriceId ActualPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue,RtrValueClassId         
	INTO #ReturnDetails1          
	FROM ReturnHeader S (NOLOCK)          
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)         
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId          
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1      
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3
	SELECT DISTINCT R.RtrId,RC.CtgMainId,CtgCode,RC.CtgName,RtrValueClassId       
	INTO #Retailer      
	FROM Retailer R (NOLOCK),      
	RetailerValueClassMap RVCM (NOLOCK),      
	RetailerValueClass RVC (NOLOCK),      
	RetailerCategory RC (NOLOCK),      
	RetailerCategoryLevel RCL (NOLOCK)      
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	SELECT tranid,Refid,Rtrid,CtgName,RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno      
	INTO #TotClaim FROM(      
	SELECT 1 tranid,Salid Refid,A.Rtrid,CtgName,Salinvdate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno  
	FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid  and A.RtrValueClassId = B.RtrValueClassId 
	UNION       
	SELECT 2 Transid,ReturnID Refid,A.Rtrid,CtgName,ReturnDate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno  
	FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid    and A.RtrValueClassId = B.RtrValueClassId     
	)A  
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM      
	(      
	SELECT D.PriceId,D.PrdBatDetailValue       
	FROM #TotClaim M (NOLOCK),      
	#ProductBatchDetails D (NOLOCK)       
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	AND PriceCode LIKE '%-Spl Rate-%'         
	UNION       
	SELECT D.PriceId,D.PrdBatDetailValue       
	FROM #TotClaim M (NOLOCK),      
	#ProductBatchDetails D (NOLOCK)       
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
	AND PriceCode LIKE '%SplRate%'        
	)A 
	UPDATE A SET A.SplRate = (BaseQty*((B.SplselRate)+(B.SplselRate*(p.TaxPerc/100)))) FROM  #TotClaim A 
	INNER JOIN #ExistingSpecialPrice B ON A.Priceid = B.Priceid  
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.Priceid <>0  
	UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid      
	WHERE A.Priceid =0
	UPDATE A SET A.NrmlRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
	INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid 
	UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim A    
	
	SELECT DISTINCT  B.CtgName,CircularNo,MAX(CREATEDDATE) CREATEDDATE INTO #Circular FROM SchemeClaimCircular A --WHERE  
	INNER JOIN RetailerCategory B ON A.AttrCode = B.CtgCode AND A.AttrType<>'Class'
	INNER JOIN #Retailer R ON B.CtgCode=R.CtgCode AND A.AttrCode = R.CtgCode
	AND ((SchValidFrom BETWEEN @FromDate  AND @ToDate ) OR ( SchValidTill BETWEEN @FromDate  AND @ToDate)) 
		WHERE ClaimType='TOT Claim' GROUP BY  B.CtgName,CircularNo
	  
	INSERT INTO #TotClaimFinal(CtgName,Rtrid,Prdid,NrmlRate,SecSalesTot,DiffClaims)      
	SELECT CtgName,Rtrid,Prdid,SUM(NrmlRate),SUM(SplRate),SUM(Diff) FROM #TotClaim      
	GROUP BY Ctgname,Rtrid,Prdid
	
	UPDATE A SET Fromdate = B.Frmdt ,Todate = B.todt FROM #TotClaimFinal A  
	INNER JOIN (SELECT Ctgname,MIn(RefDate) Frmdt,Max(RefDate) todt FROM #TotClaim GROUP BY CtgName) B ON A.CtgName = B.Ctgname    
	
	INSERT INTO TempTOTClaimDetails       
	SELECT CtgName,Rtrid,Prdid,Fromdate,Todate,'',SUM(NrmlRate),SUM(SecSalesTot),SUM(DiffClaims),@Pi_Usrid,@Pi_Transid
	FROM #TotClaimFinal
	WHERE DiffClaims > 0   -- SHOWING ONLY +VE VALUE AS PER AWINASH REQUEST ON 19-12-2019
	GROUP BY CtgName,Rtrid,Prdid,Fromdate,Todate

	UPDATE A SET A.CirNO = ISNULL(CircularNo,'') FROM TempTOTClaimDetails A  
	INNER JOIN #CIRCULAR B ON A.CtgName = B.CTGNAME

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_CheckCostCentre' AND TYPE='FN')
DROP FUNCTION Fn_CheckCostCentre
GO
--SELECT DBo.Fn_CheckCostCentre() as aaa
CREATE FUNCTION Fn_CheckCostCentre ()
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckCostCentre  
* PURPOSE	: TO CHECK CostCentre
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 19-12-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @CmpPrdCtgId INT
SELECT @CmpPrdCtgId = CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName ='BRAND'

IF EXISTS ( SELECT * FROM ProductCategoryValue A INNER JOIN ProductCategoryValue B ON
			A.PrdCtgValLinkId = B.PrdCtgValMainId WHERE A.CmpPrdCtgId =@CmpPrdCtgId AND B.PrdCtgValCode NOT IN ('C00','K') 
			 AND  A.PrdCtgValCode NOT IN (SELECT DISTINCT BrandCode  FROM CostCentreDetails))
BEGIN
	SET @ValidateMsg='Cost Centre Not available for Some Brand'
END

RETURN @ValidateMsg
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempManualClaimDetails' AND TYPE='U')
BEGIN
	CREATE TABLE TempManualClaimDetails
	(
	SchDesc		NVARCHAR(100),
	FromDate	DATETIME,
	ToDate		DATETIME,
	CirNo		NVARCHAR(100),
	SchBudget	NUMERIC(18,2),
	SecSales	NUMERIC(18,2),
	LiabPerc	NUMERIC(18,2),
	ClmAmt		NUMERIC(18,2),
	UsrId		INT,
	TransId		INT
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ManualClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_ManualClaimDetails
GO
--EXEC Proc_ManualClaimDetails 2019,12,1,504
CREATE PROCEDURE Proc_ManualClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_ManualClaimDetails
* PURPOSE	:  TO LOAD MANUAL CLAIM DETAILS
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
SET NOCOUNT ON 

	DELETE FROM  TempManualClaimDetails   

	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
 	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))

 
	SELECT DISTINCT  MCD.DEscription,MCD.CircularNo,ProposedLibPercent INTO #CirCular  
	from  ManualClaimMaster MCM 
	INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo
	INNER JOIN jcmonth A ON  MCM.jcmid=A.jcmid and fromjcmjcid=jcmjc
	INNER JOIN ManualClaimDescription B ON MCD.CircularNo = B.CircularNo AND MCD.Description = B.ManualClmDesc 
	WHERE MacDate BETWEEN @FromDate AND @ToDate AND ActiveStatus = 1

	INSERT INTO TempManualClaimDetails
	SELECT DISTINCT  DEscription,JcmSdt,JcmEdt,CircularNo,ProposedLibPercent,TotalSales,ActualLibPercent,ClaimAmt,@Pi_Usrid ,@Pi_Transid 
	FROM (
	SELECT  MCD.DEscription,JcmSdt,JcmEdt ,MCD.CircularNo,B.ProposedLibPercent,SUM(TotalSales) TotalSales,SUM(ActualLibPercent) ActualLibPercent,SUM(ClaimAmt) ClaimAmt--,@Pi_Usrid ,@Pi_Transid      
	from  ManualClaimMaster MCM 
	INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo
	INNER JOIN jcmonth A ON  MCM.jcmid=A.jcmid and fromjcmjcid=jcmjc
	INNER JOIN #CirCular B ON MCD.CircularNo = B.CircularNo AND MCD.Description = B.DEscription 
	WHERE MacDate BETWEEN @FromDate AND @ToDate
	GROUP BY  MCD.DEscription,MCD.CircularNo,B.ProposedLibPercent,JcmSdt,JcmEdt 
	)A

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempDistIncClaimDetails' AND TYPE='U')
BEGIN
	CREATE TABLE TempDistIncClaimDetails
	(
	RefNo		NVARCHAR(100),
	SMCnt		INT,
	CirNo		NVARCHAR(100),
	TotAchSales	NUMERIC(18,2),
	IncAmt		NUMERIC(18,2), 
	UsrId		INT,
	TransId		INT
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_DistIncClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_DistIncClaimDetails
GO
--EXEC Proc_DistIncClaimDetails 2019,8,1,504
CREATE PROCEDURE Proc_DistIncClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_DistIncClaimDetails
* PURPOSE	:  TO LOAD DISTRIBUTOR INCENTIVE CLAIMS 
* DATE		:  14-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN
SET NOCOUNT ON 

	DELETE FROM  TempDistIncClaimDetails    

	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @CirNO	   NVARCHAR(100)
  
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))

		
	SELECT @CirNO = CircularNo FROM
	(
	SELECT TOP 1 ISNULL(CircularNo,'') CircularNo,MAX(CreatedDate) CreatedDate   FROM SchemeClaimCircular A 
	WHERE ((SchValidFrom BETWEEN @FromDate  AND @ToDate ) OR ( SchValidTill BETWEEN @FromDate  AND @ToDate)) 
	AND ClaimType='Distributor Incentive Claim' GROUP BY CircularNo) A
	  
	INSERT INTO TempDistIncClaimDetails
	SELECT A.DistIRefno,COUNT(SMID),@CirNO,SUM(C.AchSales) as TotalAchSales,SUM(C.IncAmount),@Pi_Usrid ,@Pi_Transid 
	FROM DistributorIncentiveMaster A (NOLOCK)  
	INNER JOIN DistributorIncentiveAchDetail C(NOLOCK) ON C.DistIRefno=A.DistIRefno AND DistIRefStatus = 1
	--WHERE C.GeneratedOn BETWEEN @FromDate AND @ToDate  
	WHERE A.IncFromDate BETWEEN @FromDate AND @ToDate OR A.IncToDate BETWEEN @FromDate AND @ToDate 
	GROUP BY A.DistIRefno 

END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='TempSMIncClaimDetails' AND TYPE='U')
BEGIN
	CREATE TABLE TempSMIncClaimDetails
	(
	RefNo		NVARCHAR(100),
	SMName		NVARCHAR(100),
	CirNo		NVARCHAR(100),
	TotAchSales	NUMERIC(18,2),
	FrmRange	NUMERIC(18,2),
	ToRange		NUMERIC(18,2),
	FixedPay	NUMERIC(18,2),
	VarPay		NUMERIC(18,2),
	IncPerc		NUMERIC(18,2),
	IncAmount	NUMERIC(18,2),
	TotIncAmt	NUMERIC(18,2),
	SMID		INT,
	UsrId		INT,
	TransId		INT
	)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptDebitNoteclaim' AND TYPE='P')
DROP PROCEDURE Proc_RptDebitNoteclaim
GO
/*  
BEGIN TRAN  
EXEC Proc_RptDebitNoteclaim 293,1,0,'',0,0,1,'DNTS1900001'      
SELECT * FROM RptDebitNoteClaim_Excel1WID      
SELECT * FROM RptDebitNoteClaim_Excel2WID   
SELECT * FROM RptDebitNoteClaim_Excel3WID   
SELECT * FROM RptDebitNoteClaim_Excel4WID  
SELECT * FROM RptDebitNoteClaim_Excel5WID  
SELECT * FROM RptDebitNoteClaim_Excel6WID  
SELECT * FROM RptDebitNoteClaim_Excel7WID  
SELECT * FROM RptDebitNoteTopSheet_Excel_GrandTotal  
ROLLBACK TRAN      
*/
CREATE PROCEDURE Proc_RptDebitNoteclaim
(      
 @Pi_RptId   INT,      
 @Pi_UsrId   INT,      
 @Pi_SnapId   INT,      
 @Pi_DbName   NVARCHAR(50),      
 @Pi_SnapRequired INT,@Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT,
 @Pi_DNDocNo NVARCHAR(100)      
)      
AS      
/************************************************************************************************************************************      
* PROCEDURE : Proc_RptDebitNoteclaim      
* PURPOSE : Debit Note Claim in Crystal format  
* CREATED : Deepan     
* CREATED DATE :13-11-2019      
* NOTE  : Parle SP for Debit Note Claim      
* MODIFIED       
*************************************************************************************************************************************      
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                               
*************************************************************************************************************************************      
13-11-2019  DEEPAN		 CR		CRCRSTPAR0090	       Debit note Claim report (Design in Crystal Reports)  
16-12-2019  MOHANA		 CR		CRCRSTPAR0079	       Checked only console Ref NO
30-12-2019	MOHANA		 CR		CRCRSTPAR0095		   INCLUDED DESCRIPTION FOR INSTITUTIONAL CLAIM
************************************************************************************************************************************/           
BEGIN      
 SET NOCOUNT ON      
 DECLARE @FromDate   AS DATETIME      
 DECLARE @ToDate    AS DATETIME      
 --SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)      
 --SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)      
 --Report 1      
 DECLARE @CityName AS NVARCHAR(100)      
 DECLARE @DistributorCode AS NVARCHAR(40)      
 DECLARE @DistributorName AS NVARCHAR(100)      
 DECLARE @DBMonth As INT 
 DECLARE @CirNo As NVARCHAR(100)      
      
 SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,      
 @CityName = G.GeoName      
 FROM Distributor D (NOLOCK),      
 Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId      
 --Added By Mohana       
 --SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate      
 SELECT @DBMonth = CASE MONTH (@ToDate)       
  WHEN 4 THEN 1      
  WHEN 5 THEN 2      
  WHEN 6 THEN 3      
  WHEN 7 THEN 4      
  WHEN 8 THEN 5      
  WHEN 9 THEN 6      
  WHEN 10 THEN 7      
  WHEN 11 THEN 8      
  WHEN 12 THEN 9      
  WHEN 1 THEN 10      
  WHEN 2 THEN 11      
  WHEN 3 THEN 12      
 END       
 --Report 1      
 --Report 2      
 DECLARE @slno AS INT      
 DECLARE @SamplingAmount AS NUMERIC(18,2)      
 SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'  
 IF NOT EXISTS(SELECT * FROM DebitNoteTopSheetClaimHd(NOLOCK) WHERE DNDocNo=@Pi_DNDocNo AND ConDocRefNo<>'')-- Commented by MOhana FOR UAT Change AND SAPDocRefNo<>'')
 BEGIN
	RETURN
 END
     
 --SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)      
 --FROM FreeIssueHd J (NOLOCK),      
 --FreeIssueDt D (NOLOCK),      
 --ProductBatchDetails P (NOLOCK)      
 --WHERE J.IssueId = D.IssueId       
 --AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
 --AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate    
 
 -- SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)      
 --FROM FreeIssueHd J (NOLOCK),      
 --FreeIssueDt D (NOLOCK),      
 --ProductBatchDetails P (NOLOCK)      
 --WHERE J.IssueId = D.IssueId       
 --AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
 --AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate  
 
SELECT @SamplingAmount = ISNULL(SUM(D.SamAmt),0) FROM DebitNoteTopSheetClaim_Sampling D INNER JOIN DebitNoteTopSheetClaimHd T ON
D.DNRefId=T.DNRefId 
--WHERE T.ClmDate Between @FromDate AND @ToDate
WHERE T.DNDocNo =@Pi_DNDocNo
 
SELECT @FromDate = D.FromDate FROM DebitNoteTopSheetClaim_Sampling D INNER JOIN DebitNoteTopSheetClaimHd T ON
D.DNRefId=T.DNRefId 
--WHERE T.ClmDate Between @FromDate AND @ToDate
WHERE T.DNDocNo =@Pi_DNDocNo     
SELECT @ToDate = D.ToDate FROM DebitNoteTopSheetClaim_Sampling D INNER JOIN DebitNoteTopSheetClaimHd T ON
D.DNRefId=T.DNRefId 
--WHERE T.ClmDate Between @FromDate AND @ToDate
WHERE T.DNDocNo =@Pi_DNDocNo 
 
  
SELECT @CirNo = D.CirNo FROM DebitNoteTopSheetClaim_Sampling D INNER JOIN DebitNoteTopSheetClaimHd T ON
D.DNRefId=T.DNRefId 
--WHERE T.ClmDate Between @FromDate AND @ToDate
WHERE T.DNDocNo =@Pi_DNDocNo     
 
 --Report 2      
 --DELETE FROM REPORTFILTERDT WHERE RPTID=291  
 --INSERT INTO REPORTFILTERDT(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)  
 --SELECT 291,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate from ReportFilterDt WHERE RptId=@Pi_RptId  
 --    EXEC Proc_RptDebitNoteTopSheet  @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId  

 TRUNCATE TABLE RptDebitNoteClaim_Excel1WID  
 TRUNCATE TABLE RptDebitNoteClaim_Excel2WID   
 TRUNCATE TABLE RptDebitNoteClaim_Excel3WID   
 TRUNCATE TABLE RptDebitNoteClaim_Excel4WID   
 TRUNCATE TABLE RptDebitNoteClaim_Excel5WID   
 TRUNCATE TABLE RptDebitNoteClaim_Excel6WID  
 TRUNCATE TABLE RptDebitNoteClaim_Excel7WID  
 
 INSERT INTO RptDebitNoteClaim_Excel1WID(DNRefId,RefNo,SMName,CirNo,TotAchSales,FrmRange,ToRange,
 FixedPay,VarPay,IncAmount)
 SELECT D.DNRefId,D.RefNo,D.SMName,D.CirNo,D.TotAchSales,D.FrmRange,D.ToRange,D.FixedPay,D.VarPay,D.IncAmount
 FROM DebitNoteTopSheetClaim_SMInc D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId
  --WHERE T.ClmDate Between @FromDate AND @ToDate
   WHERE T.DNDocNo =@Pi_DNDocNo
  IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel1WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
  BEGIN
	 INSERT INTO RptDebitNoteClaim_Excel1WID(DNRefId,RefNo,SMName,CirNo,TotAchSales,FrmRange,ToRange,
	 FixedPay,VarPay,IncAmount)
	SELECT T.DNRefId,'0','0','0','0','0','0','0','0','0'  FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
  END
   
 DELETE FROM RPTFORMULA WHERE RptId=@Pi_RptId  
 INSERT INTO RPTFORMULA([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId])   
 SELECT @Pi_RptId,1,'SamplingAmount','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),1,0 UNION  
 SELECT @Pi_RptId,2,'From','From : ' + CONVERT(VARCHAR(11),@FromDate,105) ,1,0 UNION  
 SELECT @Pi_RptId,3,'To','To : ' + CONVERT(VARCHAR(11),@ToDate,105),1,0 UNION  
 SELECT @Pi_RptId,4,'Heading1','PARLE - DEBIT NOTE / CREDIT NOTE' ,1,0 UNION  
 SELECT @Pi_RptId,5,'WholesalerName','Name of the Wholesaler : ' + ISNULL(@DistributorName,'') ,1,0 UNION  
 SELECT @Pi_RptId,6,'Town','Name of the Town : ' + ISNULL(@CityName,'') ,1,0 UNION  
 SELECT @Pi_RptId,7,'DebitNoteNo','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)  ,1,0 UNION  
 SELECT @Pi_RptId,8,'WholesalerCode','Wholesaler Code : ' + ISNULL(@DistributorCode,'') ,1,0 UNION  
 SELECT @Pi_RptId,9,'ProductSampled','Product Sampled during the period  '  ,1,0  UNION
 SELECT top 1 @Pi_RptId,10,'GrandTotal',CONVERT(NVARCHAR(30),TotalAmt)  ,1,0 from DebitNoteTopSheetClaimHd(NOLOCK) WHERE DNDocNo =@Pi_DNDocNo UNION
 SELECT @Pi_RptId,11,'DNNO','DN RefNo : ' + @Pi_DNDocNo ,1,0 UNION 
 SELECT @Pi_RptId,12,'ConRefNo','Con Doc.RefNo : ' + ConDocRefNo  ,1,0 from DebitNoteTopSheetClaimHd(NOLOCK) WHERE DNDocNo =@Pi_DNDocNo UNION 
 SELECT @Pi_RptId,13,'SAPDocRefNo','SAP Doc.RefNo : ' + SAPDocRefNo  ,1,0 from DebitNoteTopSheetClaimHd(NOLOCK) WHERE DNDocNo =@Pi_DNDocNo  UNION
 SELECT @Pi_RptId,14,'CirNo','Circular No : ' + @CirNo ,1,0   

 --UNION  
-- SELECT top 1 @Pi_RptId,10,'GrandTotal',CONVERT(NVARCHAR(10),Column6)  ,1,0 from RptDebitNoteTopSheet_Excel_GrandTotal(NOLOCK)   

INSERT INTO RptDebitNoteClaim_Excel2WID(DNRefId,RefNo,SMCnt,CirNo,TotAchSales,IncAmt)
SELECT D.DNRefId,D.RefNo,D.SMCnt,D.CirNo,D.TotAchSales,D.IncAmt FROM DebitNoteTopSheetClaim_DistInc D 
INNER JOIN DebitNoteTopSheetClaimHd T ON
D.DNRefId=T.DNRefId 
--WHERE T.ClmDate Between @FromDate AND @ToDate
WHERE T.DNDocNo =@Pi_DNDocNo

 IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel2WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
 BEGIN
	INSERT INTO RptDebitNoteClaim_Excel2WID(DNRefId,RefNo,SMCnt,CirNo,TotAchSales,IncAmt)
	SELECT T.DNRefId,'0','0','0','0','0' FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
 END

INSERT INTO RptDebitNoteClaim_Excel3WID(DNRefId,SchDesc,FromDate,ToDate,CirNo,SchBudget,SecSales,
LiabPerc,ClmAmt)
SELECT D.DNRefId,D.SchDesc,D.FromDate,D.ToDate,D.CirNo,D.SchBudget,D.SecSales,
D.LiabPerc,D.ClmAmt FROM DebitNoteTopSheetClaim_Manual D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId 
 --WHERE T.ClmDate Between @FromDate AND @ToDate
 WHERE T.DNDocNo =@Pi_DNDocNo
 
 IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel3WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
 BEGIN
	INSERT INTO RptDebitNoteClaim_Excel3WID(DNRefId,SchDesc,FromDate,ToDate,CirNo,SchBudget,SecSales,LiabPerc,ClmAmt)
	SELECT T.DNRefId,'0',CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),'0','0','0','0','0' FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
 END

INSERT INTO RptDebitNoteClaim_Excel4WID(DNRefId,CtgName,FromDate,ToDate,CirNo,NrmlAmt,TOTAmt,DiffAmt)
SELECT D.DNRefId,D.CtgName,D.FromDate,D.ToDate,D.CirNo,D.NrmlAmt,D.TOTAmt,D.DiffAmt 
 FROM DebitNoteTopSheetClaim_TOTDiff D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId 
 --WHERE T.ClmDate Between @FromDate AND @ToDate
 WHERE T.DNDocNo =@Pi_DNDocNo
 
  IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel4WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
 BEGIN
	INSERT INTO RptDebitNoteClaim_Excel4WID(DNRefId,CtgName,FromDate,ToDate,CirNo,NrmlAmt,TOTAmt,DiffAmt)
	SELECT T.DNRefId,'0',CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),'0','0','0','0' FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
 END
INSERT INTO RptDebitNoteClaim_Excel5WID(DNRefId,CtgName,FromDate,ToDate,CirNo,MonTarget,Lst2MntSAl,CurMonth,OutletCnt,TotDiscount)
SELECT D.DNRefId,D.CtgName,D.FromDate,D.ToDate,(D.CirNo + '~' + CASE SCHTYPE WHEN 1 THEN 'BaseDisc' ELSE 'TGT' END),
D.MonTarget,D.Lst2MntSAl,D.CurMonth,D.OutletCnt,D.TotDiscount 
FROM DebitNoteTopSheetClaim_InstTarget D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId 
 --WHERE T.ClmDate Between @FromDate AND @ToDate
 WHERE T.DNDocNo =@Pi_DNDocNo

 IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel5WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
 BEGIN
	INSERT INTO RptDebitNoteClaim_Excel5WID(DNRefId,CtgName,FromDate,ToDate,CirNo,MonTarget,Lst2MntSAl,CurMonth,OutletCnt,TotDiscount)
	SELECT T.DNRefId,'0',CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),'0','0','0','0','0','0' FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
 END

INSERT INTO RptDebitNoteClaim_Excel6WID(DNRefId,SchId,SchDesc,FrmDate,ToDate,CirNo,SchBudget,Lst2MntSAl,Wk4PriVal,SchPrimary,SecSales,LaibPer,CalClmAmt,OrgClmAmt)
SELECT D.DNRefId,D.SchId,D.SchDesc,D.FrmDate,D.ToDate,D.CirNo,D.SchBudget,D.Lst2MntSAl,D.Wk4PriVal,D.SchPrimary,D.SecSales,D.LaibPer,D.CalClmAmt,D.OrgClmAmt 
FROM DebitNoteTopSheetClaim_Trade D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId 
 --WHERE T.ClmDate Between @FromDate AND @ToDate
 WHERE T.DNDocNo =@Pi_DNDocNo
 
  IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel6WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
  BEGIN
	INSERT INTO RptDebitNoteClaim_Excel6WID(DNRefId,SchId,SchDesc,FrmDate,ToDate,CirNo,SchBudget,Lst2MntSAl,Wk4PriVal,SchPrimary,SecSales,LaibPer,CalClmAmt,OrgClmAmt)
	SELECT T.DNRefId,'0','0',CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),'0','0','0','0','0','0','0','0','0' FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
 END

INSERT INTO RptDebitNoteClaim_Excel7WID(DNRefId,SancDate,FromDate,ToDate,CirNo,SamAmt)
SELECT D.DNRefId,D.SancDate,D.FromDate,D.ToDate,D.CirNo,D.SamAmt FROM DebitNoteTopSheetClaim_Sampling D INNER JOIN DebitNoteTopSheetClaimHd T ON
 D.DNRefId=T.DNRefId 
 --WHERE T.ClmDate Between @FromDate AND @ToDate
 WHERE T.DNDocNo =@Pi_DNDocNo
 
 IF NOT EXISTS (SELECT * FROM  RptDebitNoteClaim_Excel7WID(NOLOCK) WHERE ISNULL(DNRefId,0) <> 0)
  BEGIN
	INSERT INTO RptDebitNoteClaim_Excel7WID(DNRefId,SancDate,FromDate,ToDate,CirNo,SamAmt)
	SELECT T.DNRefId,CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),CONVERT(CHAR(10),GETDATE(),121),'0','0'	FROM DebitNoteTopSheetClaimHd T(NOLOCK)  WHERE T.DNDocNo =@Pi_DNDocNo
  END

 ---------------- Added  By Lakshman M Dated On 10-08-2019 PMS ID: ILCRSTPAR5448    
 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId    
 IF NOT exists(SELECT * FROM RptDebitNoteClaim_Excel6WID)  
 BEGIN  
  SELECT MAX(RecCount ) RecCount INTO #temp  FROM (  
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel1WID(NOLOCK)  
  union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel2WID(NOLOCK)  
  union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel3WID(NOLOCK)  
  union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel4WID(NOLOCK)  
  union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel5WID(NOLOCK)  
  union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel6WID(NOLOCK)  
    union all   
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel7WID(NOLOCK)  
  ) A
 END  
 --IF NOT EXISTS(SELECT * FROM RptDebitNoteTopSheet_Excel1WID)  
 --BEGIN  
 -- INSERT INTO RptDebitNoteTopSheet_Excel1WID  
 -- SELECT '','','','','',cast(0 as varchar(10)),'',cast(0 as varchar(10)),cast(0 as varchar(10)),cast(0 as varchar(10)),RecCount FROM #temp  
 --END  
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)   
 SELECT  @Pi_RptId, COUNT(*) ,0 ErrNo , @Pi_UsrId FROM RptDebitNoteClaim_Excel6WID  
 SELECT * FROM RptDebitNoteClaim_Excel6WID  
 ---ILCRSTPAR4278  
 RETURN       
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptDebitNoteTopSheet_Rtm' AND TYPE ='P') 
DROP PROCEDURE Proc_RptDebitNoteTopSheet_Rtm
GO
/*    
BEGIN TRAN    
EXEC Proc_RptDebitNoteTopSheet_Rtm 293,1,0,'',0,0,1,'DNTS1900003'      
SELECT * FROM RptDebitNoteClaim_Excel1WID      
SELECT * FROM RptDebitNoteClaim_Excel2WID   
SELECT * FROM RptDebitNoteClaim_Excel3WID   
SELECT * FROM RptDebitNoteClaim_Excel4WID  
SELECT * FROM RptDebitNoteClaim_Excel5WID  
SELECT * FROM RptDebitNoteClaim_Excel6WID  
SELECT * FROM RptDebitNoteClaim_Excel7WID      
ROLLBACK TRAN        
*/    
CREATE PROCEDURE Proc_RptDebitNoteTopSheet_Rtm
(        
 @Pi_RptId   INT,        
 @Pi_UsrId   INT,        
 @Pi_SnapId   INT,        
 @Pi_DbName   NVARCHAR(50),        
 @Pi_SnapRequired INT,@Pi_GetFromSnap  INT,        
 @Pi_CurrencyId  INT ,
 @Pi_DNDocNo	NVARCHAR(100)      
)        
AS        
/************************************************************************************************************************************        
* PROCEDURE : Proc_RptDebitNoteTopSheetNew        
* PURPOSE : Debit Note Top Sheet in Crystal format    
* CREATED : S.MOORTHI       
* CREATED DATE :03-05-2019        
* NOTE  : Parle SP for Debit Note Top Sheet        
* MODIFIED         
*************************************************************************************************************************************        
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                                 
*************************************************************************************************************************************        
03-05-2019  S.MOORTHI    SR      ILCRSTPAR4278       Debit note sheet report (Design in Crystal Reports)    
21-06-2019  S.MOORTHI    CR      CRCRSTPAR0056       STO(Service to Outlet) or Distributor incentive logic to be incorporated and debit note should upload to console    
17-07-2019  S.MOHANA     CR      ILCRSTPAR5199       INCLUDED NEW SUB REPORT -- SMINCENTIVE DETAILS    
10-08-2019  Lakshman M   BZ      ILCRSTPAR5500       Sub reports some table data not available that time report showing no record fiund.    
************************************************************************************************************************************/             
BEGIN        
 SET NOCOUNT ON        
 DECLARE @FromDate   AS DATETIME        
 DECLARE @ToDate    AS DATETIME        
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)        
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)        
 --Report 1        
 DECLARE @CityName AS NVARCHAR(100)        
 DECLARE @DistributorCode AS NVARCHAR(40)        
 DECLARE @DistributorName AS NVARCHAR(100)        
 DECLARE @DBMonth As INT        
 SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,        
 @CityName = G.GeoName        
 FROM Distributor D (NOLOCK),        
 Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId        
 --Added By Mohana         
 --SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate        
 SELECT @DBMonth = CASE MONTH (@ToDate)         
  WHEN 4 THEN 1        
  WHEN 5 THEN 2        
  WHEN 6 THEN 3        
  WHEN 7 THEN 4        
  WHEN 8 THEN 5        
  WHEN 9 THEN 6        
  WHEN 10 THEN 7        
  WHEN 11 THEN 8        
  WHEN 12 THEN 9        
  WHEN 1 THEN 10        
  WHEN 2 THEN 11        
  WHEN 3 THEN 12        
 END         
 --Report 1        
 --Report 2        
 DECLARE @slno AS INT        
 DECLARE @SamplingAmount AS NUMERIC(18,2)        
 SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'        
 --- Change by Amuthakumar P ILCRSTPAR1917        
 SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)        
 FROM FreeIssueHd J (NOLOCK),        
 FreeIssueDt D (NOLOCK),        
 ProductBatchDetails P (NOLOCK)        
 WHERE J.IssueId = D.IssueId         
 AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId         
 AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate        
 --Report 2        



DELETE FROM REPORTFILTERDT WHERE RPTID=293    
INSERT INTO REPORTFILTERDT(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)    
SELECT 293,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate from ReportFilterDt WHERE RptId=@Pi_RptId    

TRUNCATE TABLE RptDebitNoteClaim_Excel1WID       
TRUNCATE TABLE RptDebitNoteClaim_Excel2WID     
TRUNCATE TABLE RptDebitNoteClaim_Excel3WID     
TRUNCATE TABLE RptDebitNoteClaim_Excel4WID    
TRUNCATE TABLE RptDebitNoteClaim_Excel5WID    
TRUNCATE TABLE RptDebitNoteClaim_Excel6WID    
TRUNCATE TABLE RptDebitNoteClaim_Excel7WID  

 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId   

IF EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE DNDocNo = @Pi_DNDocNo AND ConDocRefNo ='')
BEGIN 
RETURN
END

 EXEC Proc_RptDebitNoteclaim @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId,@Pi_DNDocNo    
 ---ILCRSTPAR4278     
  
 INSERT INTO RptDebitNoteTopSheet_Excel1WID([Scheme Description],[From],[To],[Circular No],    
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],SubLinkId)    
 SELECT [Scheme Description],[From],[To],[Circular No],    
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],@DBMonth FROM RptDebitNoteTopSheet_Excel1(NOLOCK)    
 WHERE [Scheme Description]<>'Total'    

 DELETE FROM RPTFORMULA WHERE RptId=@Pi_RptId    
 INSERT INTO RPTFORMULA([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId])     
 SELECT @Pi_RptId,1,'SamplingAmount','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),1,0 UNION    
 SELECT @Pi_RptId,2,'From','From : ' + CONVERT(VARCHAR(11),@FromDate,105) ,1,0 UNION    
 SELECT @Pi_RptId,3,'To','To : ' + CONVERT(VARCHAR(11),@ToDate,105),1,0 UNION    
 SELECT @Pi_RptId,4,'Heading1','PARLE - DEBIT NOTE / CREDIT NOTE' ,1,0 UNION    
 SELECT @Pi_RptId,5,'WholesalerName','Name of the Wholesaler : ' + ISNULL(@DistributorName,'') ,1,0 UNION    
 SELECT @Pi_RptId,6,'Town','Name of the Town : ' + ISNULL(@CityName,'') ,1,0 UNION    
 SELECT @Pi_RptId,7,'DebitNoteNo','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)  ,1,0 UNION    
 SELECT @Pi_RptId,8,'WholesalerCode','Wholesaler Code : ' + ISNULL(@DistributorCode,'') ,1,0 UNION    
 SELECT @Pi_RptId,9,'ProductSampled','Product Sampled during the period  '  ,1,0  UNION    
 SELECT top 1 @Pi_RptId,10,'GrandTotal',CAST( TotalAmt AS VARCHAR(30))  ,1,0 from  DEbitNoteTopSheetClaimHd (NOLOCK) WHERE DNDocNo  =@Pi_DNDocNo
 
DELETE FROM RptDebitNoteHeaderColumns
INSERT INTO RptDebitNoteHeaderColumns(FromDate,ToDate,SamplingAmount,DebitNoteNo,Town,
WholeSalerName,WholeSalerCode,ConsoleDocNO,SapDocNO)   
SELECT top 1 'From : ' + CONVERT(VARCHAR(11),@FromDate,105),'To : ' + CONVERT(VARCHAR(11),@ToDate,105),
'Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),
'Debit Note No :' + ISNULL(DNDocNo,''),
'Name of the Town : ' + ISNULL(@CityName,''),
'Name of the Wholesaler : ' + ISNULL(@DistributorName,''),
'Wholesaler Code : ' + ISNULL(@DistributorCode,''),
'ConsoleDocNo : ' + ISNULL(ConDocRefNo ,''),
'SAPDocNo: ' + ISNULL(SAPDocRefNo ,'')
from  DEbitNoteTopSheetClaimHd (NOLOCK) WHERE DNDocNo  =@Pi_DNDocNo 
 
     
 ---------------- Added  By Lakshman M Dated On 10-08-2019 PMS ID: ILCRSTPAR5448      
   
     
  SELECT ISNULL(MAX(RecCount),0) RecCount INTO #temp  FROM (    
  SELECT MAX(DNRefId ) as RecCount FROM RptDebitNoteClaim_Excel1WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel2WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel3WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel4WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel5WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel6WID(NOLOCK)    
  union all     
  SELECT MAX(DNRefId) as RecCount FROM RptDebitNoteClaim_Excel7WID(NOLOCK)
  ) A  
 
 
 
IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteClaim_Excel1WID)
BEGIN 
	INSERT INTO RptDebitNoteClaim_Excel1WID(DNRefId,RefNo,SMName,CirNo,TotAchSales,FrmRange,ToRange,FixedPay,VarPay,IncAmount)
	SELECT 0,'','','',0,0,0,0,0,0
END 

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteClaim_Excel2WID)
BEGIN 
	INSERT INTO RptDebitNoteClaim_Excel2WID(DNRefId,RefNo,SMCnt,CirNo,TotAchSales,IncAmt)
	SELECT 0,'',0,0,0,0
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteClaim_Excel3WID)
BEGIN 
	INSERT INTO RptDebitNoteClaim_Excel3WID(DNRefId,SchDesc,FromDate,ToDate,CirNo,SchBudget,SecSales,LiabPerc,ClmAmt)
	SELECT 0,'',convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'',0,0,0,0
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteClaim_Excel4WID)
BEGIN 
	INSERT INTO RptDebitNoteClaim_Excel4WID(DNRefId,CtgName,FromDate,ToDate,CirNo,NrmlAmt,TOTAmt,DiffAmt)
	SELECT 0,'',convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'',0,0,0
END

IF NOT EXISTS(SELECT 'x' FROM RptDebitNoteClaim_Excel5WID)
BEGIN 
	INSERT INTO RptDebitNoteClaim_Excel5WID(DNRefId,CtgName,FromDate,ToDate,CirNo,MonTarget,Lst2MntSAl,CurMonth,OutletCnt,TotDiscount)
	SELECT  0,'',convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'',0,0,0,0,0 
END 

IF NOT EXISTS(SELECT * FROM RptDebitNoteClaim_Excel6WID)    
BEGIN
	INSERT INTO RptDebitNoteClaim_Excel6WID(DNRefId,SchId,SchDesc,FrmDate,ToDate,CirNo,SchBudget,Lst2MntSAl,Wk4PriVal,SchPrimary,SecSales,LaibPer,CalClmAmt,OrgClmAmt) 
	SELECT 0,0,'',convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'' ,0,0,0,0,0,0,0,0       
END

IF NOT EXISTS(SELECT * FROM RptDebitNoteClaim_Excel7WID)    
BEGIN
	INSERT INTO RptDebitNoteClaim_Excel7WID(DNRefId,SancDate,FromDate,ToDate,CirNo,SamAmt) 
	SELECT 0,convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),convert(varchar(10),GETDATE(),121),'' ,0      
END
 
INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)     
SELECT  @Pi_RptId, COUNT(*) ,0 ErrNo , @Pi_UsrId FROM #temp     
SELECT * FROM RptDebitNoteClaim_Excel6WID    
   
RETURN  
       
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_SchemeCircularDetails' AND TYPE ='P') 
DROP PROCEDURE Proc_Cn2Cs_SchemeCircularDetails
GO
/*
BEGIN TRAN
delete from errorlog
select * from Cn2Cs_Prk_SchemeCircularDetails where CmpSchcode ='SCH19685'
EXEC Proc_Cn2Cs_SchemeCircularDetails 0
select * from Cn2Cs_Prk_SchemeCircularDetails  
select * from SchemeCircularDetails where CmpSchcode in(select cmpschcode from Cn2Cs_Prk_SchemeCircularDetails)
SELECT * FROM ERRoRLOG
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_SchemeCircularDetails
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SchemeCircularDetails
* PURPOSE		: To validate the downloaded Scheme Circular details from Console
* CREATED		: Mohana
* CREATED DATE	: 10-10-2017
* MODIFIED
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
10-10-2017  Mohana.S	 CR     CCRSTPAR0172          Included Circular Date and scheme Budget  
16-07-2019  Lakshman M   SR     ILCRSTPAR5188         scheme circualr no reflow from console to CS script validation included. circualar no upaded in core stocky.
11-10-2019  Deepak K     BZ     ILCRSTPAR6282         Validation added to not consider the avoidscheme details
04-12-2019	MOHANA S	 BZ		CRCRSTPAR0079		  LOCAL ISSUE FIX FOR (DUPLICATE DOWNLOAD)
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	CREATE TABLE #AvoidScheme
	(
		CircularNo NVARCHAR(50),
		CmpSchCode NVARCHAR(50)
	)
	
	CREATE TABLE #Cn2Cs_Prk_SchemeCircularDetails(
	[DistCode] [nvarchar](50) NULL,
	[CmpSchcode] [nvarchar](50) NULL,
	[CircularNo] [nvarchar](50) NULL,
	[CircularDate] [datetime] NULL,
	[SchemeBudget] [numeric](18, 6) NULL,
	[DownLoadFlag] [nvarchar](10) NULL,
	[CreatedDate] [datetime] NULL
)
	
	DELETE FROM Cn2Cs_Prk_SchemeCircularDetails WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_SchemeCircularDetails (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END

	--ADDED BY MOHANA FOR LOCAL ISSUE FIX
	SELECT CmpSchcode,MAX(CreatedDate) CreatedDate  INTO #MAXDATE FROM Cn2Cs_Prk_SchemeCircularDetails 
	WHERE  DownLoadFlag='D' GROUP BY  CmpSchcode 


	INSERT INTO #Cn2Cs_Prk_SchemeCircularDetails
	SELECT A.* FROM Cn2Cs_Prk_SchemeCircularDetails A
	INNER JOIN #MAXDATE B ON A.CmpSchcode = B.CmpSchcode AND A.CreatedDate = B.CreatedDate
	WHERE  DownLoadFlag='D'
	 
	 -- TILL HERE
	INSERT INTO #AvoidScheme
	SELECT CircularNo,CmpSchcode FROM #Cn2Cs_Prk_SchemeCircularDetails WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_SchemeCircularDetails',CirCularnO,'Scheme Not Available in SchemeMaster' FROM #Cn2Cs_Prk_SchemeCircularDetails WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)
	 
	--INSERT INTO #AvoidScheme(CmpSchCode)
	--SELECT CmpSchCode FROM #Cn2Cs_Prk_SchemeCircularDetails
	--GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1
	
	--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--SELECT 1,'Cn2Cs_Prk_SchemeCircularDetails','CmpSchCode','Duplicate Cmpschcode Available -'+CmpSchCode  FROM #Cn2Cs_Prk_SchemeCircularDetails
	--GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1
	
	
	DELETE FROM #Cn2Cs_Prk_SchemeCircularDetails WHERE CmpSchcode IN (SELECT CmpSchcode FROM #AvoidScheme)
	
	-------------- added by lakshman M Dated ON 16-07-2019 PMS ID: ILCRSTPAR5188 --------------------------
	INSERT INTO #AvoidScheme
	SELECT CirCularNo, CmpSchCode  FROM SchemeCircularDetails WHERE CmpSchCode IN (SELECT Cmpschcode FROM #Cn2Cs_Prk_SchemeCircularDetails)
		
	INSERT INTO SchemeCircularDetails
	SELECT CmpSchCode,CircularNo,CircularDate,SchemeBudget,GETDATE() FROM #Cn2Cs_Prk_SchemeCircularDetails WHERE cmpschcode NOT IN (SELECT cmpschcode FROM #AvoidScheme)
	
	UPDATE A SET A.circularno = B.circularno FROM schemecirculardetails A inner Join #Cn2Cs_Prk_SchemeCircularDetails B ON A.cmpschcode =B.cmpschcode 
	------------------------- Till Here -----------------------------
	UPDATE Cn2Cs_Prk_SchemeCircularDetails SET DownloadFlag ='Y' WHERE CmpSchcode IN (SELECT CmpSchCode FROM SchemeCircularDetails) 
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_SMIncClaimDetails' AND TYPE='P')
DROP PROCEDURE Proc_SMIncClaimDetails
GO
--EXEC Proc_DistIncClaimDetails 2019,8,1,504
CREATE PROCEDURE Proc_SMIncClaimDetails
(
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_Transid	INT
)
AS
BEGIN
SET NOCOUNT ON 

	DELETE FROM  TempSMIncClaimDetails  
	RETURN
	DECLARE @Month1 VARCHAR(100)
	DECLARE @Pi_Year1 INT

	DECLARE @FromDate  DATETIME
	DECLARE @ToDate	   DATETIME
	DECLARE @CirNO	   NVARCHAR(100)
  
	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))

	 
	SET @Month1=DATENAME(MONTH, @FromDate)
	SET @Pi_Year1=@Pi_Year	 

	SELECT @CirNO = CircularNo FROM
	(
	SELECT TOP 1 ISNULL(CircularNo,'') CircularNo,MAX(CreatedDate) CreatedDate   FROM SchemeClaimCircular A 
	WHERE ((SchValidFrom BETWEEN @FromDate  AND @ToDate ) OR ( SchValidTill BETWEEN @FromDate  AND @ToDate)) 
	AND ClaimType='SalesMan Incentive Claim' GROUP BY CircularNo) A 

	INSERT INTO TempSMIncClaimDetails
	SELECT S.SMIRefNo,SMName,ISNULL(@CirNO,''),AchSales,[FromRange],[ToRange],FixedPay,VariablePay,IncPerc,IncAmount,TotalIncAmount,SD.SMID,@Pi_Usrid,@Pi_Transid  
	FROM SalesManIncentiveMaster S INNER JOIN SalesManincentiveDetail SD
	ON S.SMIRefno = SD.SMIRefno 
	INNER JOIN SalesmanIncentiveSlabs SS ON SS.SMIRefno = S.SMIRefno AND SD.SMIRefno=SS.SMIRefno AND SD.AchSlab = SS.Slab 
	INNER JOIN SalesMan A ON SD.SMid = A.SMId AND SMIRefStatus = 1
	WHERE  SMCODE NOT IN('SMDUMMY01') AND S.IncMonth =@Month1 AND S.Incyear =@Pi_Year1   AND SMIrefStatus=1

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_GetDNTopsheetTotalValues' AND TYPE='TF')
DROP FUNCTION Fn_GetDNTopsheetTotalValues
GO
--SELECT  * FROM Fn_GetDNTopsheetTotalValues(1,504)
CREATE FUNCTION Fn_GetDNTopsheetTotalValues(@Pi_Usrid INT,@Pi_Transid INT)
RETURNS @Total Table
(
	Sampling	NUMERIC(38,2),
	Trade		NUMERIC(38,2),
	InstTarget	NUMERIC(38,2),
	TOT			NUMERIC(38,2),
	ManualClm	NUMERIC(38,2),
	DistInctamt NUMERIC(38,2),
	SMInct		NUMERIC(38,2),
	GrandTotal	NUMERIC(38,2),
	Usrid		INT ,
	Tranid		INT
)
AS
/****************************************************************************
* PROCEDURE	:  Fn_GetDNTopsheetTotalValues
* PURPOSE	:  TO LOAD TOTAL VALUES OF ALL CLAIMS
* DATE		:  15-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*******************************************************************************/
BEGIN

	INSERT INTO @Total
	SELECT ISNULL(SUM(Sampling),0),ISNULL(SUM(Trade),0),ISNULL(SUM(InstTarget),0),ISNULL(SUM(TOT),0),
	ISNULL(SUM(ManualClm),0),ISNULL(SUM(DistInctamt),0) ,ISNULL(SUM(SMInct),0),
	(ISNULL(SUM(Sampling),0)+ISNULL(SUM(Trade),0)+ISNULL(SUM(InstTarget),0)+ISNULL(SUM(TOT),0)+
	ISNULL(SUM(ManualClm),0)+ISNULL(SUM(DistInctamt),0) +ISNULL(SUM(SMInct),0)),@Pi_Usrid , @Pi_Transid
	FROM (  
	SELECT ISNULL(SUM(SamAmt),0) Sampling,0 Trade,0 InstTarget,0 TOT,0 ManualClm,0 DistInctamt,0 SMInct FROM TempSamplingClaimDetails Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	UNION ALL   
	SELECT  0,ISNULL(SUM(CalClmAmt),0) Trade,0,0,0,0,0 FROM TempTradeSchemeClaimDetails Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	UNION ALL   
	SELECT  0,0,ISNULL(SUM(ClmAmount),0) InstTarget,0,0,0,0 FROM TempInsTargetClaimDetails  Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	UNION ALL   
	SELECT  0,0,0,ISNULL(SUM(DiffAmt),0) TOT,0,0,0   FROM TempTOTClaimDetails Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	UNION ALL   
	SELECT  0,0,0,0,ISNULL(SUM(ClmAmt),0) ManualClm,0,0    FROM TempManualClaimDetails   Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	UNION ALL   
	SELECT   0,0,0,0,0,ISNULL(SUM(IncAmt),0) DistInctamt,0  FROM TempDistIncClaimDetails    Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid  
	UNION ALL
	SELECT   0,0,0,0,0,0,ISNULL(SUM(TotIncAmt),0) SMInct  FROM TempSmIncClaimDetails   Where UsrId =  @Pi_Usrid AND TransId = @Pi_Transid
	)A  

RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_CheckMonthEnd' AND TYPE='FN')
DROP FUNCTION Fn_CheckMonthEnd
GO
CREATE FUNCTION Fn_CheckMonthEnd (@Pi_Year INT,@Pi_Month INT,@Pi_UsrId INT,@Pi_TransId INT)
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckMonthEnd  
* PURPOSE	: To validate month end details before generating debit note top sheet report
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 18-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @MonthEndDt AS DATETIME
DECLARE @FromDate  DATETIME
DECLARE @ToDate	   DATETIME

	SET  @ValidateMsg  = ''

	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))
	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
	
	IF EXISTS(SELECT * FROM JCMonthEnd)
	BEGIN
		SELECT @MonthEndDt=MAX(JcmEdt) FROM JCMonthEnd
		IF @ToDate>@MonthEndDt
		BEGIN
			SET @ValidateMsg='Month end not completed for selected period . Hence Debit Note Top Sheet Claim Cannot generate'
		END
	END

	IF @ValidateMsg = '' 
	BEGIN
		IF EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid 		
		WHERE A.targetmonth =@Pi_Month AND A.TargetYear =@Pi_Year and A.Status =1)
		BEGIN

			IF NOT EXISTS (SELECT * FROM InsTargetHD A INNER JOIN InsTargetDetails B ON A.insid =b.insid 
			INNER JOIN InsTargetDetailsAch C ON A.insid =b.insid AND b.insid =c.insid  AND B.rtrid =C.Rtrid
			WHERE A.targetmonth =@Pi_Month AND A.TargetYear =@Pi_Year and A.Status =1)
			BEGIN
				SET @ValidateMsg='Target Achievement Not Download From Console for Selected Month.' + CHAR(13) +
				 'Hence Debit Note Top Sheet Claim Cannot generate'
			END
		END
	END
	
RETURN @ValidateMsg
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_CheckDuplicateClmDate' AND TYPE='Fn')
DROP FUNCTION Fn_CheckDuplicateClmDate
GO
CREATE FUNCTION Fn_CheckDuplicateClmDate (@Pi_Year INT,@Pi_Month INT)
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckDuplicateClmDate  
* PURPOSE	: To validate CLAIM DATA WHICH IS ALREADY RAISED
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 17-07-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @MonthEndDt AS DATETIME
DECLARE @FromDate  DATETIME
DECLARE @ToDate	   DATETIME

SET @ValidateMsg = ''
  
IF EXISTS (SELECT * FROM DebitNoteTopSheetClaimHd WHERE ClmYear = @Pi_Year AND Monthid =@Pi_Month )
BEGIN
	SET @ValidateMsg='Claim Already Raised For Selected Month'
END

RETURN @ValidateMsg
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_CheckSalesPending' AND TYPE='Fn')
DROP FUNCTION Fn_CheckSalesPending
GO
CREATE FUNCTION Fn_CheckSalesPending (@Pi_Year INT,@Pi_Month INT)
RETURNS VARCHAR(500) 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_CheckSalesPending  
* PURPOSE	: TO CHECK PENDING DATA
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 18-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @ValidateMsg AS VARCHAR(500)
DECLARE @MonthEndDt AS DATETIME
DECLARE @FromDate  DATETIME
DECLARE @ToDate	   DATETIME

SET @ValidateMsg = ''

	SELECT @FromDate= DATEADD(MONTH, (@Pi_Month)-1,DATEADD(YEAR, @Pi_Year - 1900, 0))

	SELECT @ToDate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,DATEADD(YEAR, @Pi_Year - 1900, 0)))
  
IF EXISTS (SELECT * FROM SalesInvoice (NOLOCK) WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND Upload=0  )
BEGIN
	SET @ValidateMsg='Sales Data Not Uploaded to Console. Kindly do The Sync'
END

RETURN @ValidateMsg
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_GetCirDetails' AND TYPE='FN')
DROP FUNCTION Fn_GetCirDetails
GO
 --SELECT dbo.Fn_GetCirDetails(1,2)
CREATE FUNCTION Fn_GetCirDetails(@Type INT,@UsrId INT)
RETURNS   VARCHAR(100)	 
AS
/*******************************************************************************************************************
* PROCEDURE	: Fn_GetCirDetails  
* PURPOSE	: TO VALIDATE CIRCULAR DETAILS WHILE SAVING THE CLAIM
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 14-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************/
BEGIN
DECLARE @Msg AS VARCHAR(MAX)	
SET @Msg = ''

IF @Type = 1 
BEGIN
	IF EXISTS (SELECT '*' FROM TempSamplingClaimDetails WHERE ISNULL(CircularNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		SET @Msg = 'Circular No Not available For SAMPLING CLAIM'	
	END
	  
	IF EXISTS (SELECT '*' FROM TempTradeSchemeClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For Trade Scheme'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg+ CHAR(13) + 'TRADE SCHEME CLAIM'	
		END
	END
	 
	IF EXISTS (SELECT '*' FROM TempInsTargetClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For Institutional Target'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg+ CHAR(13)  + 'INSTITUTIONAL TARGET CLAIM'	
		END
	END

	IF EXISTS (SELECT '*' FROM TempTOTClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For TOT CLAIM'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg+ CHAR(13) + 'TOT'	
		END
	END
		IF EXISTS (SELECT '*' FROM TempManualClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For MANUAL CLAIM'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg+ CHAR(13)+ 'MANUAL CLAIM'	
		END
	END
		IF EXISTS (SELECT '*' FROM TempDistIncClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For DISTRIBUTOR INCENTIVE CLAIM'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg + CHAR(13)+ 'DISTRIBUTOR INCENTIVE CLAIM'	
		END
	END
	IF EXISTS (SELECT '*' FROM TempSMIncClaimDetails  WHERE ISNULL(CirNo,'') = '' AND UsrId = @Usrid)
	BEGIN 
		If @Msg = '' 
		BEGIN
			SET @Msg = 'Circular No Not available For SALESMAN INCENTIVE CLAIM'	
		END
		ELSE
		BEGIN
			SET @Msg = @Msg + CHAR(13) + 'SALESMAN INCENTIVE CLAIM'	
		END 
	END
END

If @Type = 2 
BEGIN
	IF EXISTS (SELECT * FROM TempTradeSchemeClaimDetails A WHERE NOT EXISTS 
				(SELECT SCHID FROM TradeSchemeFactors B WHERE A.Schid =B.SCHID AND A.Lst2Avg =B.L2MPrimarySales AND A.Wk4PriVal =B.L4WPrimarySales )
				AND UsrId = @Usrid )
	BEGIN
		SET @Msg = ''
		SET @Msg = 'Last2MonthPrimary & 4th Week Primary Not downloaded ' + CHAR(13) + 'from Console For Loaded Schemes'	
	END
	
END

RETURN (@Msg)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='DN_Claim_Scheme' AND TYPE='U')
DROP TABLE [DN_Claim_Scheme]
GO
CREATE TABLE [DN_Claim_Scheme](
	[SchId] [int] NULL,
	[SlabId] [int] NULL,
	[Salid] [int] NULL,
	[FlatAmount] [numeric](38, 6) NULL,
	[DiscountPer] [numeric](38, 6) NULL,
	[FreeValue] [numeric](38, 6) NULL,
	[GiftValue] [numeric](38, 6) NULL,
	[SchemeBudget] [numeric](38, 6) NULL,
	[BudgetUtilized] [numeric](38, 6) NULL,
	[Selected] [int] NULL,
	[Linetype] [int] NULL,
	[Salinvdate] [datetime] NULL,
	[Prdid] [int] NULL,
	UsrId	INT	NULL,
	Transid	INT	NULL
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_SchUtilization_DNClaim' AND TYPE='P')
DROP PROCEDURE Proc_SchUtilization_DNClaim
GO
/*
--EXEC Proc_SchUtilization_DNClaim 2019,9
*/  
CREATE PROCEDURE Proc_SchUtilization_DNClaim
(   
	@Pi_Year	int,
	@Pi_Month	INT,
	@Pi_UsrId	INT,
	@Pi_Transid	INT
)  
AS  
/*******************************************************************************************************************
* PROCEDURE	: Proc_SchUtilization_DNClaim  (COPIED FROM REPORT PROCEDURE)
* PURPOSE	: TO GET THE SCHEME UTILIZATION DETAILS IN GIVEN PERIOD
* NOTES		:  
* CREATED	: S.MOHANA 
* DATE		: 15-11-2019
* PMS		: CRCRSTPAR0079  
**********************************************************************************************************************
* DATE			RESOURCE			CR/BZ				USERSTORYID					DESCRIPTION
* 18-12-2019	MOHANA S			CR					CRCRSTPAR0095				RESTIRCTED INSTITUTIONAL SCHEME IN TRADE SCHEME DOWNLOAD
**********************************************************************************************************************/
BEGIN  
SET NOCOUNT ON  
	DELETE FROM DN_Claim_Scheme  
 
	DECLARE @Pi_FromDate  DATETIME
	DECLARE @Pi_Todate	   DATETIME
  
	SELECT @Pi_FromDate= DATEADD(MONTH, (@Pi_Month)-1, CONVERT(VARCHAR(10),@Pi_Year))

	SELECT @Pi_Todate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,CONVERT(VARCHAR(10),@Pi_Year)))	    
    
	SELECT DISTINCT B.* INTO #SalesInvoiceSchemeLineWise FROM SalesInvoice A (NOLOCK)
	INNER JOIN SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SALID =B.SALID 
	AND  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3  

	SELECT Distinct SchId into #SchemeID FROM #SalesInvoiceSchemeLineWise(NOLOCK)

	SELECT Schid,dbo.Fn_ReturnBudgetUtilized(SchId) as SchemeUtilized INTO #SchemeUtilized from  #SchemeID 

	SELECT  DISTINCT RSF.* INTO #ReturnSchemelinedt FROM ReturnHeader RH (NOLOCK)  
	INNER JOIN ReturnSchemelinedt RSF(NOLOCK) ON  RH.ReturnId = RSF.ReturnId  AND
	ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0 

	SELECT * INTO #SchemeMaster  FROM SchemeMaster WHERE ClmRefId NOT IN (SELECT ClmgrpId FROM ClaimGroupMaster WHERE ClmGrpCode ='CG10004') --CRCRSTPAR0095

	SELECT * INTO #ProductBatch FROM ProductBatch  WHERE PRdbatid in (
	SELECT PrdBatId  FROM SalesInvoice A(NOLOCK)   INNER JOIN SalesInvoiceSchemeDtBilled  B(NOLOCK)   ON A.SALID =B.SALID 
	AND  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3
	UNION
	SELECT FreePrdBatId AS Prdbatid FROM SalesInvoice A(NOLOCK)   INNER JOIN SalesInvoiceSchemeDtFreePrd  B(NOLOCK)   ON A.SALID =B.SALID 
	AND  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3
	UNION
	SELECT FreePrdBatId FROM ReturnHeader A(NOLOCK)   INNER JOIN ReturnSchemeFreePrdDt B(NOLOCK)   ON A.REturnid = B.ReturnId  AND
	ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND A.Status =0  )

	SELECT A.* INTO #ProductBatchDetails FROM ProductBatchDetails A INNER JOIN #ProductBatch B ON A.Prdbatid = B.PrdBatId  AND SLNo=4

	INSERT INTO DN_Claim_Scheme (SchId,SlabId,SALid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)  
	SELECT C.SchId,B.Slabid,A.SALid,ISNULL(SUM(B.FlatAmount),0) As FlatAmount,ISNULL(SUM(B.DisCountPerAmount),0) as DiscountPer,  
	0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,UT.SchemeUtilized,1 as Selected,  
	1 as LineType,SalInvDate,B.PrdId,@Pi_UsrId,@Pi_TransId 
	FROM SalesInvoice A(NOLOCK) INNER JOIN #SalesInvoiceSchemeLineWise B(NOLOCK) ON A.SalId = B.SalId  
	INNER JOIN #SchemeMaster C(NOLOCK) ON B.SchId = C.SchId --CRCRSTPAR0095  
	INNER JOIN #SchemeUtilized UT on UT.SchId =C.SchId
	WHERE  SalInvDate BETWEEN  @Pi_FromDate AND @Pi_Todate AND A.Dlvsts >3  
	GROUP BY C.SchId,B.SlabId,A.Salid,SalInvDate,Budget,B.PrdId,UT.SchemeUtilized 
 
	INSERT INTO DN_Claim_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)   
	SELECT DISTINCT L.SchId,L.SlabId,A.Salid ,0 As FlatAmount,0 as DiscountPer,  
	(L.FreeQty * O.PrdBatDetailValue) as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(L.SchId),1 as Selected,  
	1 as LineType,SalInvDate,B.PrdId,@Pi_UsrId,@Pi_TransId 
	FROM SalesInvoice A INNER JOIN SalesInvoiceSchemeDtBilled B ON A.SalId = B.SalId  
	AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1(NOLOCK) WHERE  
	B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)  
	INNER JOIN #SchemeMaster C(NOLOCK) ON B.SchId = C.SchId INNER JOIN Product I ON B.PrdID = I.PrdId  --CRCRSTPAR0095
	INNER JOIN ProductBatch J(NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId  
	INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L(NOLOCK) ON A.SalId = L.SalId AND C.SchId = L.SchId  
	AND L.SlabId= B.SlabId INNER JOIN Product M(NOLOCK) ON L.FreePrdId = M.PrdId  
	INNER JOIN ProductBatch N(NOLOCK) ON L.FreePrdBatId = N.PrdBatId  
	INNER JOIN #ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.FreePriceId  
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo  
	AND P.ClmRte = 1  
	WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND A.Dlvsts >3 

 
	INSERT INTO DN_Claim_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)   
	SELECT B.SchId,B.SlabId,A.Salid,0 As FlatAmount,0 as DiscountPer,  
	0 as FreeValue,(L.GiftQty * O.PrdBatDetailValue) as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),  
	1 as Selected,1 as LineType,SalInvDate,B.PrdId ,@Pi_UsrId,@Pi_TransId 
	FROM SalesInvoice A(NOLOCK) INNER JOIN SalesInvoiceSchemeDtBilled B(NOLOCK) ON A.SalId = B.SalId  
	AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1(NOLOCK) WHERE  
	B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)  
	INNER JOIN #SchemeMaster C(NOLOCK) ON B.SchId = C.SchId INNER JOIN Product I ON B.PrdID = I.PrdId --CRCRSTPAR0095 
	INNER JOIN ProductBatch J(NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId  
	INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L(NOLOCK) ON A.SalId = L.SalId AND C.SchId = L.SchId  
	AND L.SlabId= B.SlabId INNER JOIN Product M ON L.GiftPrdId = M.PrdId  
	INNER JOIN ProductBatch N (NOLOCK)ON L.GiftPrdBatId = N.PrdBatId  
	INNER JOIN #ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.GiftPriceId  
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo  
	AND P.ClmRte = 1   
	WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND A.Dlvsts >3 
 
	INSERT INTO DN_Claim_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)   
	SELECT B.SchId,B.SlabId,A.Returnid,-1 * ISNULL(SUM(B.ReturnFlatAmount),0) As FlatAmount,  
	-1 * ISNULL(SUM(B.ReturnDiscountPerAmount),0) as DiscountPer,  
	0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),1 as Selected,  
	2 as LineType,ReturnDate,B.PrdId,@Pi_UsrId,@Pi_TransId  
	FROM ReturnHeader A(NOLOCK) INNER JOIN #ReturnSchemelinedt(NOLOCK) B ON A.ReturnId = B.ReturnId  
	INNER JOIN REturnProduct P(NOLOCK) ON P.ReturnID = A.REturnid And B.ReturnID = P.ReturnID AND B.rowid = P.Slno
	AND Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1)
	INNER JOIN #SchemeMaster C(NOLOCK) ON B.SchId = C.SchId   --CRCRSTPAR0095
	WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND A.Status =0   
	GROUP BY B.SchId,B.SlabId,A.Returnid,ReturnDate,Budget,B.PrdId 

	INSERT INTO DN_Claim_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)    
	SELECT RSF.SchId,RSF.SlabId,RH.Returnid,0 AS FlatAmount,0 AS DiscountPer,  
	(-1 * (ISNULL(SUM(RSF.ReturnFreeQty),0) * PBD.PrdBatDetailValue)) AS FreeValue,0 AS GiftValue,SM.Budget AS SchemeBudget,dbo.Fn_ReturnBudgetUtilized(RSF.SchId),  
	1 AS Selected,2 AS LineType,ReturnDate,P.PrdId,@Pi_UsrId,@Pi_TransId  
	FROM ReturnHeader RH (NOLOCK)  
	INNER JOIN ReturnSchemeFreePrdDt RSF(NOLOCK) ON  RH.ReturnId = RSF.ReturnId   
	INNER JOIN #SchemeMaster SM(NOLOCK) ON  SM.SchId = RSF.SchId   --CRCRSTPAR0095
	INNER JOIN Product P(NOLOCK) ON RSF.FreePrdId = P.PrdId  
	INNER JOIN ProductBatch PB(NOLOCK) ON RSF.FreePrdBatId = PB.PrdBatId    
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.FreePriceId  
	INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1  
	WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0  
	and RH.RETURNID IN (SELECT ReturnID FROM RETURNPRODUCT(NOLOCK) WHERE Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1))
	GROUP BY RSF.SchId,RSF.SlabId,RH.Returnid,ReturnDate, PBD.PrdBatDetailValue,SM.Budget,P.PrdId 
  
	INSERT INTO DN_Claim_Scheme (SchId,SlabId,Salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)    
	SELECT RSF.SchId,RSF.SlabId,RH.Returnid,0 AS FlatAmount,0 AS DiscountPer,  
	0 as FreeValue, (-1 * ISNULL(SUM(RSF.ReturnGiftQty),0) * PBD.PrdBatDetailValue) as GiftValue,SM.Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(RSF.SchId),  
	1 as Selected,2 AS LineType,ReturnDate,P.PrdId,@Pi_UsrId,@Pi_TransId  
	FROM ReturnHeader RH (NOLOCK)  
	INNER JOIN ReturnSchemeFreePrdDt RSF(NOLOCK) ON  RH.ReturnId = RSF.ReturnId   
	INNER JOIN #SchemeMaster SM(NOLOCK) ON  SM.SchId = RSF.SchId   --CRCRSTPAR0095
	INNER JOIN Product P(NOLOCK) ON RSF.GiftPrdId = P.PrdId  
	INNER JOIN ProductBatch PB(NOLOCK) ON RSF.GiftPrdBatId = PB.PrdBatId    
	INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.GiftPriceId  
	INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1  
	WHERE ReturnDate Between @Pi_FromDate AND @Pi_Todate  AND RH.Status =0 
	and RH.RETURNID IN (SELECT ReturnID FROM RETURNPRODUCT WHERE Stocktypeid in (select stocktypeid from StockType Where SystemStockType = 1))
	GROUP BY RSF.SchId,RSF.SlabId,RH.Returnid,ReturnDate, PBD.PrdBatDetailValue,SM.Budget,P.PrdId  
 
	INSERT INTO DN_Claim_Scheme (SchId,SlabId,salid,FlatAmount,DiscountPer,FreeValue,GiftValue,SchemeBudget,BudgetUtilized,selected,linetype,salinvdate,PrdId,UsrId,Transid)    
	SELECT B.SchId,B.SlabId,A.salid,0 As FlatAmount,0 as DiscountPer,  
	0 as FreeValue,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilized(B.SchId),2 as Selected,  
	3 as LineType,SalInvDate,0  ,@Pi_UsrId,@Pi_TransId
	FROM SalesInvoice A(NOLOCK) INNER JOIN SalesInvoiceUnSelectedScheme B(NOLOCK) ON A.SalId = B.SalId  
	INNER JOIN #SchemeMaster C(NOLOCK) ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId --CRCRSTPAR0095 
	INNER JOIN RouteMaster D(NOLOCK) ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId  
	INNER JOIN Retailer F(NOLOCK) ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId  
	LEFT OUTER JOIN DeliveryBoy H(NOLOCK) ON A.DlvBoyId = H.DlvBoyId  
	INNER JOIN RetailerValueClassMap RVCM(NOLOCK) on RVCM.Rtrid=F.RtrId  
	INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId  
	INNER JOIN RetailerCategory RC(NOLOCK) on RC.CtgMainId=RVC.CtgMainId  
	INNER JOIN RetailerCategoryLevel RCL(NOLOCK) on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId  
	WHERE SalInvDate Between @Pi_FromDate AND @Pi_Todate  AND  
	A.dlvsts >3  
	GROUP BY B.SchId,B.SlabId,A.SAlid,SalInvDate,Budget 

  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='TaxPercentage_DNClaim' AND TYPE='U')
DROP TABLE TaxPercentage_DNClaim
GO
CREATE TABLE  TaxPercentage_DNClaim
(
	TransId tinyint NULL,
	SalId	numeric(36, 0) NULL,
	PrdSlno int NULL,
	TaxPerc numeric(36, 4) NULL,
	tranId	INT NULL,
	UsrId	INT NULL
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ProductTaxPercentage_DNClaim' AND TYPE='P')
DROP PROCEDURE Proc_ProductTaxPercentage_DNClaim
GO
/*
begin tran 
EXEC Proc_ProductTaxPercentage_DNClaim 2019,12,2,504 
rollback tran
*/
CREATE PROCEDURE Proc_ProductTaxPercentage_DNClaim
(
	@Pi_Year	INT,
	@Pi_Month	INT,
	@Pi_Usrid	INT,
	@Pi_TransId	INT
)
AS
/******************************************************************************************************************
* PROCEDURE		: Proc_ProductTaxPercentage_DNClaim (COPIED FROM REPORT)
* PURPOSE		: To Return Sales Product Taxpercent
* CREATED		: MOHANA S
* CREATED DATE	: 15-11-2019
* PMS NO		: CRCRSTPAR0079  
*****************************************************************************************************************/
BEGIN
	SET NOCOUNT ON
	
	DELETE FROM TaxPercentage_DNClaim  
	
	DECLARE @Pi_FromDate  DATETIME
	DECLARE @Pi_Todate	   DATETIME
  
	SELECT @Pi_FromDate= DATEADD(MONTH, (@Pi_Month)-1, CONVERT(VARCHAR(10),@Pi_Year))
 
	SELECT @Pi_Todate = DATEADD(dd, -1, DATEADD(MONTH, @Pi_Month,CONVERT(VARCHAR(10),@Pi_Year)))
	    

	CREATE TABLE #SalesTax
	(
		SalId NUMERIC(36,0),
		PrdSlno INT,
		TaxPerc NUMERIC(36,4),
		TaxableAmount NUMERIC(36,4)
	)
		
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmount 
	FROM SalesInvoiceProductTax S (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
	WHERE  TaxableAmount>0 and DlvSts > 3
	AND SI.SalInvDate Between @Pi_Fromdate AND @Pi_Todate
	GROUP BY S.Salid,PrdSlno,TaxableAmount
	----------- Added By lakshman M Dated ON 1-04-2019 PMS ID: ILCRSTPAR4014 
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT A.SALID,SLNO,0 AS TAXPERC,0 TAXABLEAMOUNT
	FROM SALESINVOICE A INNER JOIN SALESINVOICEPRODUCT B ON A.SALID =B.SALID  
	--INNER JOIN SALESINVOICESCHEMELINEWISE C ON C.SALID =A.SALID AND C.SALID =B.SALID AND B.PRDBATID =C.PRDBATID AND B.PRDID =C.PRDID
	WHERE SALINVDATE BETWEEN @PI_FROMDATE AND @PI_TODATE AND  DLVSTS >3 AND B.SALID NOT IN (SELECT SALID FROM SALESINVOICEPRODUCTTAX)
	-------- Till Here ----------------------
	SELECT Salid,PrdSlno Into #TaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1 FROM #SalesTax TT
	INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #MaxTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #MinTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
			
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO TaxPercentage_DNClaim(TransId,Salid,PrdSlno,TaxPerc,UsrId,tranId )
	SELECT 1,Salid,PrdSlno,TaxPerc,@Pi_Usrid,@Pi_TransId 
	FROM #SalesTax
	
	DELETE FROM #SalesTax
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmt 
	FROM ReturnProductTax S INNER JOIN ReturnHeader SI ON S.ReturnId=SI.ReturnId
	WHERE  TaxableAmt>0 and SI.Status=0
	AND SI.ReturnDate Between @Pi_Fromdate AND @Pi_ToDate
	GROUP BY S.ReturnId,PrdSlno,TaxableAmt ORDER BY PrdSlno

	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT a.ReturnId,slno,0 as TaxPerc,0 TaxableAmount
	from ReturnHeader a inner join Returnproduct B On A.ReturnId =b.ReturnId  
	--inner join salesinvoiceschemelinewise C ON c.salid =a.salid and c.salid =b.salid and b.prdbatid =c.prdbatid and b.prdid =c.prdid
	--where Returndate between @Pi_Fromdate AND @Pi_ToDate and A.Status=0 AND a.Salid not in (select Returnid from ReturnProductTax )
	where Returndate between @Pi_Fromdate AND @Pi_ToDate and A.Status=0 AND a.ReturnId not in (select Returnid from ReturnProductTax ) --Changed By UAT Issue Fix
	
	SELECT Salid,PrdSlno Into #ReturnTaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1 
	FROM #SalesTax TT
	INNER JOIN #ReturnTaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #ReturnTaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #RetMaxTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #RetMinTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO TaxPercentage_DNClaim(TransId,Salid,PrdSlno,TaxPerc,UsrId,tranId )
	SELECT 2,Salid,PrdSlno,TaxPerc,@Pi_Usrid,@Pi_TransId 
	FROM #SalesTax
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_InsertTradeSchemePrdDetails' AND TYPE='P')
DROP PROCEDURE Proc_InsertTradeSchemePrdDetails
GO
/* 
BEGIN TRAN
DECLARE @ErrorNo INT
EXEC Proc_InsertTradeSchemePrdDetails 1,2,504,0
SELECT * FROM DebitNoteTopSheetClaim_Trade_PrdWise  
ROLLBACK TRAN
*/
CREATE Procedure Proc_InsertTradeSchemePrdDetails
(
@Pi_DNRefid INT,
@Pi_Usrid	INT,
@Pi_TransId	INT,
@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE	:  Proc_TradeSchemeClaimDetails
* PURPOSE	: TO LOAD SCHEME WISE CLAIM AMOUNT
* DATE		:  07-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*********************************/
BEGIN
SET NOCOUNT ON
	Set @Po_ErrNo = 0

	DELETE FROM DebitNoteTopSheetClaim_Trade_PrdWise WHERE DNRefid = @Pi_DNRefid 

	 
	IF NOT EXISTS (SELECT *FROM DebitNoteTopSheetClaimHd A INNER JOIN DebitNoteTopSheetClaim_Trade B ON A.DNRefid = B.DNRefId AND A.DNRefid = @Pi_DNRefid)
	BEGIN 
		Set @Po_ErrNo = 0 
		RETURN
	END

	IF NOT EXISTS (SELECT *FROM DN_Claim_Scheme A WHERE @Pi_Usrid = UsrId AND @Pi_TransId = Transid)
	BEGIN 
		SET @Po_ErrNo = 1 
		RETURN
	END

	IF NOT EXISTS (SELECT *FROM TaxPerCentage_DNCLaim A WHERE @Pi_Usrid = UsrId AND @Pi_TransId = Tranid)
	BEGIN 
		SET @Po_ErrNo = 1 
		RETURN
	END

	BEGIN TRY 
		BEGIN TRAN					
			INSERT INTO DebitNoteTopSheetClaim_Trade_PrdWise 
			SELECT DISTINCT @Pi_DNRefid,A.SchId,SlabId,Salid,FlatAmount,DiscountPer,BudgetUtilized,Linetype,Salinvdate ,A.Prdid,TaxPerc,
			CASE ApplyTaxForClaim WHEN 0 THEN SUM(FlatAmount+DiscountPer) ELSE  (SUM(FlatAmount+DiscountPer)+SUM(FlatAmount+DiscountPer)*(TaxPerc/100)) END  AS SchAmtWithTax,GETDATE()
			FROM (
			SELECT DISTINCT SchId,A.Salid,SlabId,A.Prdid,FlatAmount,DiscountPer,BudgetUtilized,Salinvdate,TaxPerc,Linetype  FROM DN_Claim_Scheme A 
			INNER JOIN TaxPerCentage_DNCLaim B ON A.Salid =B.SalId AND A.UsrId = B.UsrId AND A.Transid = B.tranId 
			INNER JOIN SalesinvoiceProduct C ON A.Salid = C.Salid AND B.Salid =C.Salid AND A.Prdid =C.PrdId 
			AND B.PrdSlno =C.Slno AND LineType=1 AND A.UsrId = @Pi_Usrid AND A.transId = @Pi_TransId AND B.UsrId =@Pi_Usrid AND B.tranId =@Pi_TransId 
			UNION ALL
			SELECT SchId,A.Salid,SlabId,A.Prdid,FlatAmount,DiscountPer,BudgetUtilized,Salinvdate,TaxPerc,A.Linetype FROM DN_Claim_Scheme A 
			INNER JOIN TaxPerCentage_DNCLaim B ON A.Salid =B.SalId  AND A.UsrId = B.UsrId AND A.Transid = B.TranId
			INNER JOIN ReturnProduct  C ON A.Salid = C.ReturnId AND B.Salid =C.ReturnId AND A.Prdid =C.PrdId 
			AND B.PrdSlno =C.Slno AND A.LineType=2 AND A.transId = @Pi_TransId AND A.UsrId = @Pi_Usrid  AND B.UsrId =@Pi_Usrid AND B.tranId =@Pi_TransId 
			)A INNER JOIN SchemeMaster S ON A.Schid =S.Schid 
			GROUP BY  A.SchId,Salid,SlabId,A.Prdid,BudgetUtilized,Salinvdate,TaxPerc,Linetype,ApplyTaxForClaim,FlatAmount,DiscountPer

			IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaim_Trade_PrdWise WHERE DNREFID = @Pi_DNRefid )
			BEGIN
				SET @Po_ErrNo = 1
			END

		COMMIT TRAN
 
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN
		SET @Po_ErrNo = 1		
	END CATCH	 
	SELECT @Po_ErrNo
	RETURN
END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_InsertTOTPrdDetails' AND TYPE='P')
DROP PROCEDURE Proc_InsertTOTPrdDetails
GO
/* 
BEGIN TRAN
DECLARE @ErrorNo INT
EXEC Proc_InsertTradeSchemePrdDetails 1,0
--SELECT * FROM DebitNoteTopSheetClaim_Trade_PrdWise  
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_InsertTOTPrdDetails
(
@Pi_DNRefid INT,
@Pi_Usrid		INT,
@Pi_TransId	INT,
@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE	:  Proc_TradeSchemeClaimDetails
* PURPOSE	: TO LOAD SCHEME WISE CLAIM AMOUNT
* DATE		:  15-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*********************************/
BEGIN
SET NOCOUNT ON
	Set @Po_ErrNo = 0

	DELETE FROM DebitNoteTopSheetClaim_TOT_PrdWise WHERE DNRefid = @Pi_DNRefid 

	IF NOT EXISTS (SELECT *FROM DebitNoteTopSheetClaimHd A INNER JOIN DebitNoteTopSheetClaim_TOTDiff B ON A.DNRefid = B.DNRefId AND A.DNRefid = @Pi_DNRefid)
	BEGIN 
		Set @Po_ErrNo = 0
		SELECT @Po_ErrNo
		RETURN
	END

	BEGIN TRY 
		BEGIN TRAN					
			INSERT INTO DebitNoteTopSheetClaim_TOT_PrdWise 
			SELECT DISTINCT @Pi_DNRefid,Rtrid,Prdid,NrmlAmt,TOTAmt,DiffAmt,GETDATE()
			FROM TempTOTClaimDetails WHERE UsrId = @Pi_Usrid
			AND Transid = @Pi_TransId 

		COMMIT TRAN
		 
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN
		SET @Po_ErrNo = 1		
	END CATCH	 
	SELECT @Po_ErrNo
	RETURN
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnBudgetUtilized' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_ReturnBudgetUtilized
GO
--SELECT dbo.Fn_ReturnBudgetUtilized(8) AS Amt
CREATE FUNCTION Fn_ReturnBudgetUtilized
(
	@Pi_SchId INT
)
RETURNS NUMERIC(38,6)
AS
/***********************************************
* FUNCTION: Fn_ReturnBudgetUtilized
* PURPOSE: Returns the Budget Utilized for the Selected Scheme
* NOTES:
* CREATED: Thrinath Kola	11-06-2007
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
------------------------------------------------
* 22/04/2010	Nanda	   Added FBM Scheme	
************************************************/
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	SET @Points=0
	SET @RetPoints=0
	--Added by Sathishkumar Veeramani 2013/03/14
	DECLARE @ProductBatchDetails TABLE 
	(
		PrdId NUMERIC(18,0),
		PrdBatId NUMERIC(18,0),
		PriceId NUMERIC(18,0),
		PrdBatDetailValue NUMERIC(18,6)
	)
	
		
	INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PrdBatDetailValue) 
	SELECT DISTINCT A.PrdId,A.PrdBatId,B.PriceId,B.PrdBatDetailValue 
	FROM ProductBatch A WITH (NOLOCK) 
	INNER JOIN ProductBatchDetails B WITH (NOLOCK) ON A.PrdBatId = B.PrdBatId 
	INNER JOIN BatchCreation C WITH (NOLOCK) ON  A.BatchSeqId = C.BatchSeqId  AND B.SLNo = C.SLNo AND C.ClmRte = 1
	INNER JOIN SalesInvoiceSchemeDtFreePrd S (NOLOCK) ON A.PrdBatId = S.FreePrdBatId AND B.PrdBatId = S.FreePrdBatId 
	AND B.PriceId = S.FreePriceId 
 
	--Till Here
	
	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0)) FROM
		(SELECT A.SalId,A.SchId,A.FlatAmount,A.ReturnFlatAmount,A.DiscountPerAmount,A.ReturnDiscountPerAmount FROM 
		SalesInvoiceSchemeLineWise A (NOLOCK)INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND A.SchId = @Pi_SchId AND B.Dlvsts<> 3)A1
		INNER JOIN SchemeMaster S (NOLOCK) ON A1.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
	--SELECT @FreeValue = ISNULL(SUM((FreeQty - ReturnFreeQty) * D.PrdBatDetailValue),0)
	--	FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
	--	INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND A.FreePrdBatId = C.PrdBatId
	--	INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId
	--	INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	--	INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
	--	WHERE A.SchId = @Pi_SchId AND DlvSts <> 3


	SELECT  @FreeValue =ISNULL(SUM((FreeQty - ReturnFreeQty) * C.PrdBatDetailValue),0)
		FROM 
		(SELECT A.SchId,A.FreePrdId,A.FreePrdBatId,A.FreePriceId,A.FreeQty,A.ReturnFreeQty FROM 
		SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND B.DlvSts <> 3) A2
		INNER JOIN @ProductBatchDetails C ON A2.FreePrdId = C.PrdId AND A2.FreePrdBatId = C.PrdBatId AND A2.FreePriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A2.FreePriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A2.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A2.SchId = @Pi_SchId 		
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * C.PrdBatDetailValue),0) FROM
		(SELECT A.SchId,A.GiftPrdId,A.GiftPrdBatId,A.GiftPriceId,A.GiftQty,A.ReturnGiftQty FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)	
			INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND DlvSts <> 3 )A3
		INNER JOIN @ProductBatchDetails C ON A3.GiftPrdId = C.PrdId AND A3.GiftPrdBatId = C.PrdBatId AND A3.GiftPriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A3.GiftPriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A3.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A3.SchId = @Pi_SchId 
--	 SELECT @Points = ISNULL(SUM(Points - ReturnPoints),0) FROM SalesInvoiceSchemeDtPoints A
-- 		INNER JOIN SalesInvoice B ON A.SalId = B.SalId WHERE SchId = @Pi_SchId
-- 		AND DlvSts <> 3
--	 SELECT @RetSchemeAmt = (ISNULL(SUM(ReturnFlatAmount),0) +
-- 		ISNULL(SUM(ReturnDiscountPerAmount),0))
-- 		FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		WHERE SchId = @Pi_SchId AND Status = 0
--
--	 SELECT @RetFreeValue = ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
-- 		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--
--	 SELECT @RetGiftValue = ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
-- 		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--	 SELECT @RetPoints = ISNULL(SUM(ReturnPoints),0) FROM ReturnSchemePointsDt A
-- 		INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId WHERE SchId = @Pi_SchId
-- 		AND Status = 0
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A (NOLOCK)
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		WHERE SchId = @Pi_SchId AND DlvSts <> 3
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A (NOLOCK)
		INNER JOIN ChequeDisbursalDetails B (NOLOCK) ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=1)
	--->Added By Nanda on 27/10/2010
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ (NOLOCK)
	INNER JOIN SalesInvoice SI (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=0)
	
	SET @BudgetUtilized = (ISNULL(@SchemeAmt,0) + ISNULL(@FreeValue,0) + ISNULL(@GiftValue,0) + ISNULL(@Points,0) + ISNULL(@WindowAmt,0)+ ISNULL(@FBMSchAmt,0)+ISNULL(@QPSSchAmt,0))
	-- 	- (@RetSchemeAmt + @RetFreeValue + @RetGiftValue + @RetPoints)
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	
	--Added By Sathishkumar Veeramani 2013/09/04
	IF EXISTS (SELECT * FROM SchemeMaster WHERE SchId = @Pi_SchId AND SchType = 5)
	BEGIN
		SET @BudgetUtilized = 0
		SELECT @BudgetUtilized = ISNULL(SUM(SchemeUtlzAmt),0) FROM (
		SELECT DISTINCT A.SalId,SchId,CurSchAmt AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH(NOLOCK),SalesInvoice B WITH (NOLOCK)
		WHERE A.SalId = B.SalId AND DlvSts <> 3 AND SchId = @Pi_SchId AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK)
		WHERE InvoiceType = 1 AND ReturnMode = 1)UNION
		SELECT DISTINCT A.SalId,SchId,-1*(ReturnAmt) AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH (NOLOCK),
		ReturnHeader B WITH (NOLOCK) WHERE A.SalId = B.SalId AND SchId = @Pi_SchId AND ReturnAmt <> 0 AND InvoiceType = 1 AND ReturnMode = 2
		AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 1)) Qry
	END	
	--Till Here
	
	RETURN(@BudgetUtilized)
END
GO
IF NOT EXISTS (SELECT * FROM Counters WHERE TabName ='DebitNoteTopSheetClaimHd')
BEGIN
	DELETE FROM Counters WHERE TabName ='DebitNoteTopSheetClaimHd'
	INSERT INTO Counters 
	SELECT 'DebitNoteTopSheetClaimHd','DNRefId',NULL,0,1,0,'DebitNoteTopSheetClaimHd',0,2019,1,1,GETDATE(),1,GETDATE()
	UNION ALL
	SELECT 'DebitNoteTopSheetClaimHd','DNRefNo','DNTS',5,1,0,'DebitNoteTopSheetClaimHd',0,2019,1,1,GETDATE(),1,GETDATE()
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND module='DebitNoteTopSheet_Referene'
INSERT INTO CustomUpDownload
SELECT 289,1,'DebitNoteTopSheet_Referene','DebitNoteTopSheet_Referene','','','Cn2Cs_Prk_DNTSReference','Proc_Cn2Cs_DNTSReference','Master','Download',1
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='DebitNoteTopSheet_Referene'
INSERT INTO Tbl_DownloadIntegration
SELECT 100,'DebitNoteTopSheet_Referene','Cn2Cs_Prk_DNTSReference','',0,500,GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'Cn2Cs_Prk_DNTSReference')
DROP TABLE Cn2Cs_Prk_DNTSReference
GO
CREATE TABLE Cn2Cs_Prk_DNTSReference
(
	[DistCode]			[nvarchar](100) NULL,
	[ClmMonth]			[nvarchar](50) NULL,
	[ClmYear]			[int] NULL,
	[CSRefNo]			[nvarchar](100) NULL,
	[ConsoleRefNo]		[nvarchar](12) NULL,
	[SAPRefNo]			[nvarchar](12) NULL,
	[ApprovedAmt]		[numeric](38,6) NULL,
	[ApprovedStatus]	[nvarchar](50) NULL,
	[DownloadFlag]		[nvarchar](100),
	[CreatedDate]		[DATETIME]
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_DNTSReference'  AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_DNTSReference
GO
/*
BEGIN TRAN
SELECT * FROM DebitNoteTopSheetClaimhd
EXEC Proc_Cn2Cs_DNTSReference  0
select * from Cn2Cs_Prk_DNTSReference 
SELECT * FROM DebitNoteTopSheetClaimhd
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_DNTSReference
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: 
* PURPOSE		: 
* CREATED		: S.MOHANA
* CREATED DATE	: 19-11-2019
* PMS NO		: CRCRSTNES0028
*********************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  
	 
	DELETE FROM Cn2Cs_Prk_DNTSReference WHERE DownLoadFlag='Y'

	SELECT CSRefNo,Max(CreatedDate) MaxDate INTO #MaxDet FROM Cn2Cs_Prk_DNTSReference WHERE DownloadFlag='D' 
	GROUP BY CSRefNo 

	SELECT A.* INTO #Cn2Cs_Prk_DNTSReference FROM Cn2Cs_Prk_DNTSReference A INNER JOIN #MaxDet B ON A.CSRefNo=B.CSRefNo AND A.CreatedDate =B.MaxDate 
	WHERE DownloadFlag='D'
	
	IF NOT EXISTS(SELECT 'X' FROM #Cn2Cs_Prk_DNTSReference (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END  

	CREATE TABLE #ToAvoid
	(
		CSRefNo NVARCHAR(50)
	)
	
	INSERT INTO #ToAvoid 
	SELECT CSRefNo  FROM #Cn2Cs_Prk_DNTSReference WHERE CSRefNo NOT IN (SELECT DNDocNo FROM DebitNoteTopSheetClaimHd  )

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_DNTSReference','SchemeCode',CSRefNo + 'is Not available in Schememaster'
	FROM #Cn2Cs_Prk_DNTSReference WHERE CSRefNo  NOT IN (SELECT DNDocNo FROM DebitNoteTopSheetClaimHd)

	INSERT INTO #ToAvoid 
	SELECT CSRefNo  FROM #Cn2Cs_Prk_DNTSReference WHERE (ConsoleReFno IS NULL) OR (ConsoleReFno = '')

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_DNTSReference','SchemeCode',ConsoleReFno + 'NULL Values Not Allowed'
	FROM #Cn2Cs_Prk_DNTSReference  WHERE (ConsoleReFno IS NULL) OR (ConsoleReFno = '')
	 	 
	UPDATE B SET ConDocRefNo = A.ConsoleRefNo ,B.SAPDocRefNo = A.SAPRefNo,B.ApprovedAmt= A.ApprovedAmt
	FROM #Cn2Cs_Prk_DNTSReference A INNER JOIN DebitNoteTopSheetClaimHd B ON A.CSRefNo = B.DNDocNo 
	WHERE DownloadFlag ='D' AND A.CSRefNo NOT IN (SELECT CSRefNo FROM #ToAvoid )

	UPDATE B SET DnStatus= CASE WHEN SAPDocRefNo ='' THEN 2 ELSE 3 END
	FROM #Cn2Cs_Prk_DNTSReference A INNER JOIN DebitNoteTopSheetClaimHd B ON A.CSRefNo = B.DNDocNo 
	WHERE DownloadFlag ='D' AND A.CSRefNo NOT IN (SELECT CSRefNo FROM #ToAvoid ) 
	 
	UPDATE A SET DownloadFlag ='Y' FROM Cn2Cs_Prk_DNTSReference A INNER JOIN DebitNoteTopSheetClaimHd B ON  A.CSRefNo = B.DNDocNo 
	AND  A.ConsoleRefNo = B.ConDocRefNo AND DownloadFlag ='D' AND A.CSRefNo NOT IN (SELECT CSRefNo FROM #ToAvoid ) 
 
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND module='Scheme Trade Factor'
INSERT INTO CustomUpDownload
SELECT 286,1,'Scheme Trade Factor','Scheme Trade Factor','','','Cn2Cs_Prk_TradeSchemeFactors','Proc_Cn2Cs_TradeSchemeFactors','Master','Download',1
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='Scheme Trade Factor'
INSERT INTO Tbl_DownloadIntegration
SELECT 97,'Scheme Trade Factor','Cn2Cs_Prk_TradeSchemeFactors','',0,500,GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'Cn2Cs_Prk_TradeSchemeFactors')
DROP TABLE Cn2Cs_Prk_TradeSchemeFactors
GO
CREATE TABLE Cn2Cs_Prk_TradeSchemeFactors
(
	DistCode		NVARCHAR(50),
	CmpSchCode		VARCHAR(20),
	L2MPrimarySales NUMERIC(38,6),
	L4WPrimarySales NUMERIC(38,6),
	CapAmount		NUMERIC(38,6),
	ClaimDate		DATETIME,
	DownloadFlag	VARCHAR(10),
	CreatedDate		DATETIME
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'TradeSchemeFactors')
BEGIN
CREATE TABLE TradeSchemeFactors
(
	Schid			INT,
	CmpSchCode		VARCHAR(20),
	L2MPrimarySales NUMERIC(38,6),
	L4WPrimarySales NUMERIC(38,6),
	CapAmount		NUMERIC(38,6), 
	ClaimDate		DATETIME,
	DownloadedDate	DATETIME
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_TradeSchemeFactors'  AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_TradeSchemeFactors
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_TradeSchemeFactors  0
select *from Cn2Cs_Prk_TradeSchemeFactors
SELECT * FROM TradeSchemeFactors
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_TradeSchemeFactors
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_TradeSchemeFactors
* PURPOSE		: 
* CREATED		: S.MOHANA
* CREATED DATE	: 12-11-2019
* PMS NO		: CRCRSTNES0028
*********************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  
	 
	DELETE FROM Cn2Cs_Prk_TradeSchemeFactors WHERE DownLoadFlag='Y'

	SELECT CmpSchCode ,Max(CreatedDate) MaxDate INTO #MaxDet FROM Cn2Cs_Prk_TradeSchemeFactors WHERE DownloadFlag='D' 
	GROUP BY CmpSchCode 

	SELECT A.* INTO #Cn2Cs_Prk_TradeSchemeFactors FROM Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN #MaxDet B ON A.CmpSchCode=B.CmpSchCode AND A.CreatedDate =B.MaxDate 
	WHERE DownloadFlag='D'
	
	IF NOT EXISTS(SELECT 'X' FROM #Cn2Cs_Prk_TradeSchemeFactors (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END  

	CREATE TABLE #ToAvoid
	(
		Cmpschcode NVARCHAR(50)
	)
	
	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchemeMaster )

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_TradeSchemeFactors','SchemeCode',CmpSchCode + 'is Not available in Schememaster'
	FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchemeMaster )

	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_TradeSchemeFactors WHERE ((L2MPrimarySales IS NULL ) OR (L4WPrimarySales IS NULL) OR(CapAmount IS NULL))

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_TradeSchemeFactors','SchemeCode',CmpSchCode + 'NULL Values Not Allowed'
	FROM #Cn2Cs_Prk_TradeSchemeFactors  WHERE ((L2MPrimarySales IS NULL ) OR (L4WPrimarySales IS NULL) OR(CapAmount IS NULL))

	DELETE A FROM TradeSchemeFactors A INNER JOIN #Cn2Cs_Prk_TradeSchemeFactors B ON A.CmpSchCode = B.CmpSchCode 
	WHERE DownloadFlag ='D' AND A.CmpSchCode NOT IN (SELECT CmpSchCode FROM #ToAvoid )

	INSERT INTO TradeSchemeFactors 
	SELECT DISTINCT Schid,B.CmpSchCode,L2MPrimarySales,L4WPrimarySales,CapAmount,ClaimDate,A.CreatedDate  
	FROM #Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode 
	WHERE DownloadFlag ='D' AND A.CmpSchCode NOT IN (SELECT CmpSchCode FROM #ToAvoid )
	 
	UPDATE A SET DownloadFlag ='Y' FROM Cn2Cs_Prk_TradeSchemeFactors A INNER JOIN TradeSchemeFactors B ON A.CmpSchCode = B.CmpSchCode 
	AND DownloadFlag ='D'
 
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND module='CostCentre'
INSERT INTO CustomUpDownload
SELECT 287,1,'CostCentre','CostCentre','','','Cn2Cs_Prk_CostCentre','Proc_Cn2Cs_CostCentre','Master','Download',1
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='CostCentre'
INSERT INTO Tbl_DownloadIntegration
SELECT 98,'CostCentre','Cn2Cs_Prk_CostCentre','',0,500,GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'Cn2Cs_Prk_CostCentre')
DROP TABLE Cn2Cs_Prk_CostCentre
GO
CREATE TABLE Cn2Cs_Prk_CostCentre
(
	Distcode VARCHAR(50),
	BrandCode NVARCHAR(100),
	Flavour NVARCHAR(100),
	PKTMRP NVARCHAR(50),
	CostCenter NVARCHAR(100),
	CostCenterDesc NVARCHAR(200),
	DownloadFlag VARCHAR(5),
	CreatedDate DATETIME
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'CostCentreDetails')
BEGIN
	CREATE TABLE CostCentreDetails
	(
		BrandCode NVARCHAR(100),
		Flavour NVARCHAR(100),
		PKTMRP NVARCHAR(50),
		CostCenter NVARCHAR(100),
		CostCenterDesc NVARCHAR(200), 
		DownloadedDate	DATETIME
	)
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'CostCentreDetails_BackUp')
BEGIN
CREATE TABLE CostCentreDetails_BackUp
(
	BrandCode NVARCHAR(100),
	Flavour NVARCHAR(100),
	PKTMRP NVARCHAR(50),
	CostCenter NVARCHAR(100),
	CostCenterDesc NVARCHAR(200), 
	DeletedDate	DATETIME
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_CostCentre' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_CostCentre
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_CostCentre  0
select *from Cn2Cs_Prk_CostCentre
select *from CostCentreDetails
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_CostCentre
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_CostCentre
* PURPOSE		: COST CENTRE DATA DUMP
* CREATED		: S.MOHANA
* CREATED DATE	: 12-11-2019
* PMS NO		: CRCRSTNES0028
*********************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  
	 
	DELETE FROM Cn2Cs_Prk_CostCentre WHERE DownLoadFlag='Y'
	
	SELECT BrandCode,CostCenter,Max(CreatedDate) MaxDate INTO #MaxDet FROM Cn2Cs_Prk_CostCentre WHERE DownloadFlag='D' 
	GROUP BY BrandCode,CostCenter 
	
	SELECT A.* INTO #Cn2Cs_Prk_CostCentre FROM Cn2Cs_Prk_CostCentre A INNER JOIN #MaxDet B ON A.BrandCode=B.BrandCode AND A.CreatedDate =B.MaxDate 
	AND A.CostCenter=B.CostCenter
	WHERE DownloadFlag='D'
	
	IF NOT EXISTS(SELECT 'X' FROM #Cn2Cs_Prk_CostCentre (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END  


	CREATE TABLE #ToAvoid
	(
		BrandCode NVARCHAR(100) 
	)
	
	DECLARE @CmpPrdCtgId INT
	SELECT @CmpPrdCtgId = CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName ='BRAND'
	
	INSERT INTO #ToAvoid 
	SELECT BrandCode  FROM #Cn2Cs_Prk_CostCentre WHERE BrandCode NOT IN (SELECT PrdCtgValCode FROM ProductCategoryValue WHERE CmpPrdCtgId =@CmpPrdCtgId)
	
	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_CostCentre','BrandCode',BrandCode + 'is Not available in Product Category'
	FROM #Cn2Cs_Prk_CostCentre WHERE BrandCode NOT IN (SELECT PrdCtgValCode FROM ProductCategoryValue WHERE CmpPrdCtgId =@CmpPrdCtgId)
	
	--IF EXISTS (SELECT * FROM CostCentreDetails WHERE BrandCode IN (SELECT BrandCode FROM #Cn2Cs_Prk_CostCentre))
	--BEGIN
	--	INSERT INTO CostCentreDetails_BackUp 
	--	SELECT BrandCode,Flavour,PKTMRP,CostCenter,CostCenterDesc,GETDATE() FROM CostCentreDetails WHERE BrandCode IN (SELECT BrandCode FROM #Cn2Cs_Prk_CostCentre)
	--	DELETE FROM CostCentreDetails WHERE BrandCode IN (SELECT BrandCode FROM #Cn2Cs_Prk_CostCentre)
	--END 

	DELETE FROM CostCentreDetails

	INSERT INTO CostCentreDetails	
	SELECT DISTINCT BrandCode,Flavour,PKTMRP,CostCenter,CostCenterDesc,GETDATE() 
	FROM #Cn2Cs_Prk_CostCentre 
	WHERE DownloadFlag ='D'  
	 
	UPDATE A SET DownloadFlag ='Y' FROM Cn2Cs_Prk_CostCentre A INNER JOIN CostCentreDetails B ON A.BrandCode = B.BrandCode 
	AND A.CostCenter = B.CostCenter AND DownloadFlag ='D'
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND module='Scheme Claim Circular'
INSERT INTO CustomUpDownload
SELECT 288,1,'Scheme Claim Circular','Scheme Claim Circular','','','Cn2Cs_Prk_SchemeClaimCircular','Proc_Cn2Cs_SchemeClaimCircular','Master','Download',1
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='Scheme Claim Circular'
INSERT INTO Tbl_DownloadIntegration
SELECT 99,'Scheme Claim Circular','Cn2Cs_Prk_SchemeClaimCircular','',0,500,GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'Cn2Cs_Prk_SchemeClaimCircular')
DROP TABLE Cn2Cs_Prk_SchemeClaimCircular
GO
CREATE TABLE Cn2Cs_Prk_SchemeClaimCircular
(
	DistCode NVARCHAR(50),
	CmpSchCode VARCHAR(20),
	SchValidFrom DATETIME,
	SchValidTill DATETIME,
	ClaimType VARCHAR(100),
	AttrType VARCHAR(30),
	AttrCode VARCHAR(100),
	CircularNo NVARCHAR(100),
	CircularDate DATETIME,
	CircularBudget NVARCHAR(100),
	DownloadFlag VARCHAR(10),
	CreatedDate DATETIME 
)
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'SchemeClaimCircular')
BEGIN
CREATE TABLE SchemeClaimCircular
(
	ConRefNo VARCHAR(50),
	SchValidFrom DATETIME,
	SchValidTill DATETIME,
	ClaimType VARCHAR(100),
	AttrType VARCHAR(30),
	AttrCode VARCHAR(100),
	CircularNo NVARCHAR(100),
	CircularDate DATETIME,
	CircularBudget NVARCHAR(100), 
	CreatedDate DATETIME
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_SchemeClaimCircular'  AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_SchemeClaimCircular
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_SchemeClaimCircular  0
select *from Cn2Cs_Prk_SchemeClaimCircular
SELECT * FROM SchemeClaimCircular
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_SchemeClaimCircular
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SchemeClaimCircular
* PURPOSE		: 
* CREATED		: S.MOHANA
* CREATED DATE	: 12-11-2019
* PMS NO		: CRCRSTNES0028
*********************************/
SET NOCOUNT ON
BEGIN
	 
	SET @Po_ErrNo=0  
	 
	DELETE FROM Cn2Cs_Prk_SchemeClaimCircular WHERE DownLoadFlag='Y'

	SELECT CmpSchCode ,Max(CreatedDate) MaxDate INTO #MaxDet FROM Cn2Cs_Prk_SchemeClaimCircular WHERE DownloadFlag='D' 
	GROUP BY CmpSchCode 

	SELECT DISTINCT A.* INTO #Cn2Cs_Prk_SchemeClaimCircular FROM Cn2Cs_Prk_SchemeClaimCircular A INNER JOIN #MaxDet B ON A.CmpSchCode=B.CmpSchCode AND A.CreatedDate =B.MaxDate 
	WHERE DownloadFlag='D'
	
	IF NOT EXISTS(SELECT 'X' FROM #Cn2Cs_Prk_SchemeClaimCircular (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END  

	CREATE TABLE #ToAvoid
	(
		Cmpschcode NVARCHAR(50)
	)
	
	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CmpSchCode IS NULL

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_SchemeClaimCircular','SchemeCode',CmpSchCode + 'is Not available'
		FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CmpSchCode IS NULL

	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CircularNo IS NULL

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_SchemeClaimCircular','CircularNo',CmpSchCode + 'is Not available'
	FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CircularNo IS NULL

	
	INSERT INTO #ToAvoid 
	SELECT CmpSchCode  FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CircularDate  IS NULL

	INSERT INTO ErrorLog 
	SELECT 1,'Cn2Cs_Prk_SchemeClaimCircular','CircularDate',CmpSchCode + 'is Not available'
	FROM #Cn2Cs_Prk_SchemeClaimCircular WHERE CircularDate IS NULL

	INSERT INTO SchemeClaimCircular 
	SELECT DISTINCT CmpSchCode,SchValidFrom,SchValidTill,ClaimType,AttrType,AttrCode,CircularNo,CircularDate,CircularBudget,A.CreatedDate
	FROM #Cn2Cs_Prk_SchemeClaimCircular A  
	WHERE DownloadFlag ='D' AND A.CmpSchCode NOT IN (SELECT CmpSchCode FROM #ToAvoid )
	 
	UPDATE A SET DownloadFlag ='Y' FROM Cn2Cs_Prk_SchemeClaimCircular A INNER JOIN SchemeClaimCircular B ON A.CmpSchCode = B.ConRefNo  
	AND DownloadFlag ='D'
 
END
GO
--CRCRSTPAR0079 ENDS HERE
--DEEPAN CHANGES STARTS HERE
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'SalesInvoice') and name='RtrValueClassId')
BEGIN
	ALTER TABLE SalesInvoice ADD RtrValueClassId INT default 0
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'ReturnHeader') and name='RtrValueClassId')
BEGIN
	ALTER TABLE ReturnHeader ADD RtrValueClassId INT default 0
END
GO
UPDATE SalesInvoice SET RtrValueClassId = RM.RtrValueClassId 
FROM SalesInvoice s	INNER JOIN RetailerValueClassMap RM ON  S.RTRID =RM.RtrId WHERE ISNULL(S.RtrValueClassId,0)=0
GO
UPDATE ReturnHeader set RtrValueClassId = RM.RtrValueClassId 
FROM ReturnHeader s	INNER JOIN RetailerValueClassMap RM ON  S.RTRID =RM.RtrId WHERE ISNULL(S.RtrValueClassId,0)=0
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'BatchCreation') and name='LCTRAmount')
BEGIN
	ALTER TABLE BatchCreation ADD LCTRAmount TINYINT default 0
END
GO
DELETE FROM BatchCreation WHERE SlNo =5
INSERT INTO BatchCreation(SlNo,BatchSeqId,RefCode,FieldDesc,Calculation,MRP,ListPrice,SelRte,ClmRte,Validation,ValidationType,
Availability,LastModBy,LastModDate,AuthId,AuthDate,LCTRAMOUNT)
SELECT 5,1,'E','LCTRAmount','',0,0,0,0,'',0,1,1,CONVERT(CHAR(10),GETDATE(),121),1,CONVERT(CHAR(10),GETDATE(),121),1
GO
UPDATE BatchCreation SET LCTRAMOUNT=0 WHERE ISNULL(LCTRAMOUNT,'')=''
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_ProductBatch_GST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_ProductBatch_GST]
GO
/* 
   BEGIN TRANSACTION
   delete FROM Errorlog 
   EXEC Proc_Cn2Cs_ProductBatch_GST 0
   SELECT * FROM Productbatch WITH(NOLOCK) where prdid =5567
   --WHERE PrdBatId = 29809
   SELECT * FROM Productbatchdetails WITH(NOLOCK) 
   --WHERE PrdBatId = 29809
   --SELECT * FROM ProductBatch (NOLOCK) WHERE PrdId = 1741
   SELECT * FROM Errorlog WITH(NOLOCK)
   ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cn2Cs_ProductBatch_GST]
(
       @Po_ErrNo INT OUTPUT
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_ProductBatch_GST
* PURPOSE		: To Insert and Update records in the Tables ProductBatch and ProductBatchDetails
* CREATED BY	: Murugan.R
* CREATED DATE	: 11/05/2017
* DATE      AUTHOR     DESCRIPTION
-----------------------------------------------------------------------------------------------------
* {date} {developer}  {brief modification description}
* 07/11/2019 Deepan	 LCTR Amount added (Pms ID :CRCRSTPAR0083)
*****************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo =0
	DECLARE @GSTEnabled as TINYINT
	DELETE FROM Cn2Cs_Prk_ProductBatch_GST WHERE   DownLoadFlag='Y'
	INSERT INTO ProductBatch_Temp_GST(DistCode,PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,AddRate5,
	AddRate6,DownLoadFlag,BatchStkStatus)	
	SELECT DISTINCT DistCode,PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,MRP,
	ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,AddRate4,AddRate5,
	AddRate6,DownLoadFlag,0 as BatchStkStatus
	FROM Cn2Cs_Prk_ProductBatch_GST A WHERE 
	NOT EXISTS (
	SELECT PrdCCode,PrdBatCode,MRP FROM ProductBatch_Temp_GST  B WHERE 
	A.PrdCCode=B.PrdCCode and A.PrdBatCode=B.PrdBatCode AND CAST(A.MRP as Numeric(18,6))=CAST(B.MRP as Numeric(18,6)))
	AND A.DownLoadFlag='D'
	SET @GSTEnabled=0
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1)
	BEGIN
		SET @GSTEnabled=1
	END
	
	IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatToAvoid' AND XTYPE = 'U')
	BEGIN
		DROP TABLE PrdBatToAvoid	
	END
	CREATE TABLE PrdBatToAvoid
	(
		PrdCCode NVARCHAR(200),
		PrdBatCode NVARCHAR(200)
	)
	DECLARE @ExistingBatchDetails	TABLE
	(
		PrdId		NUMERIC(18,0),
		PrdCCode	VARCHAR(100),
		PrdBatCode	VARCHAR(100),
		PriceCode	VARCHAR(500),
		OldLSP		NUMERIC(18,0),
		PrdBatId	NUMERIC(18,0),
		PriceId		NUMERIC(18,0)
	)
	DECLARE @ProductBatchWithCounter TABLE
	(
		Slno			NUMERIC(18,0) IDENTITY(1,1),
		TransNo			NUMERIC(18,0),
		PrdId			NUMERIC(18,0),
		PrdCCode		VARCHAR(100),
		PrdBatCode		VARCHAR(100),
		MnfDate			DATETIME,
		ExpDate			DATETIME		
	)	
	DECLARE @ProductBatchPriceWithCounter TABLE
	(
		Slno			NUMERIC(18,0) IDENTITY(1,1),
		TransNo			NUMERIC(18,0),
		PrdId			NUMERIC(18,0),
		PrdBatId		NUMERIC(18,0),
		PriceCode		NVARCHAR(1000),
		MRP				NUMERIC(18,6),
		ListPrice		NUMERIC(18,6),
		SellingRate		NUMERIC(18,6),
		ClaimRate		NUMERIC(18,6),
		AddRate1		NUMERIC(18,6)
		
	)
	DECLARE @ContractPrice TABLE
	(
	   PrdId NUMERIC(18,0),
	   PrdBatId NUMERIC(18,0)
	)
	
	DECLARE @ContractBatchPrice TABLE
    (
	   ContractId       NUMERIC(18,0),
	   CtgMainId        NUMERIC(18,0),
	   PrdId            NUMERIC(18,0),
	   PrdBatId         NUMERIC(18,0),
	   PriceId          NUMERIC(18,0),
	   PriceCode        NVARCHAR(500)
    )
    DECLARE @ProductBatchDetails TABLE
	(
	   PrdId                NUMERIC(18,0),
	   PrdBatId      NUMERIC(18,0),
	   PriceId              NUMERIC(18,0),
	   PriceCode            NVARCHAR(500),
	   NewBatchId           NUMERIC(18,0),
	   Slno                 INT,
	   PrdBatDetailValue    NUMERIC(36,4),
	   NewPriceId           NUMERIC(18,0)
	)
	--Added By Sathishkumar Veeramani 2015/01/08
	DECLARE @ExistingSellingPriceDetails TABLE
	(
	    PrdId        NUMERIC(18,0),
	    PrdBatId     NUMERIC(18,0),
	    PriceId      NUMERIC(18,0)
	)
	DECLARE @ExistingListPriceDetails TABLE
	(
	    PrdId        NUMERIC(18,0),
	    PrdBatId     NUMERIC(18,0),
	    PriceId      NUMERIC(18,0)
	)
	--Till Here  
	
	DECLARE @BatSeqId			AS	INT
	DECLARE @ValDiffRefNo		AS	VARCHAR(100)
	DECLARE @ExistPrdBatMaxId	AS 	INT
	DECLARE @NewPrdBatMaxId		AS 	INT	
	DECLARE @ContPriceId		AS 	NUMERIC(18,0)
	DECLARE @OldPriceIdExt 		AS 	NUMERIC(18,0)
	DECLARE @OldPriceId 		AS 	NUMERIC(18,0)
	DECLARE @NewPriceId			AS  INT
	DECLARE @ContPrdId          AS  INT
    DECLARE @ContPrdBatId       AS  INT
    DECLARE @ContPriceId1       AS  INT
    DECLARE @PriceId            AS  INT 
    DECLARE @PriceBatch         AS  INT
    DECLARE @BatchTransfer		AS	INT
	DECLARE @Po_BatchTransfer	AS	INT
	
	SELECT @OldPriceId=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails WITH (NOLOCK)		
	SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)
	SELECT @ExistPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch WITH (NOLOCK)
	SET @Po_ErrNo =0
	IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK)
	WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D')
	BEGIN
		INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)
		SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK)
		WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Product Batch','PrdCCode','Product :'+PrdCCode+' not available'
		FROM Cn2Cs_Prk_ProductBatch_GST	WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) 
		AND DownLoadFlag='D'
		
		--->Added By Nanda on 05/05/2010
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)
		SELECT DISTINCT DistCode,'Product Batch',PrdBatCode,'Product',PrdCCode,'','N' FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK) 
		WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'
		--->Till Here				
	END
	IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK)
	WHERE LEN(ISNULL(PrdBatCode,''))=0  AND DownLoadFlag='D')
	BEGIN
		INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)
		SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK)
		WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Product Batch','PrdBatCode','Batch Code should not be empty for Product:'+PrdCCode
		FROM Cn2Cs_Prk_ProductBatch_GST WITH (NOLOCK)
		WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'
	END
		
	INSERT INTO @ExistingBatchDetails (PrdId,PrdCCode,PrdBatCode,PriceCode,OldLSP,PrdBatId,PriceId)
	SELECT DISTINCT B.PrdId,B.PrdCCode,A.PrdBatCode,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
	--Code Added and commented by Deepan 07/11/2019
	--CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25))+'-'+CAST(LCTRAmount AS NVARCHAR(25)) AS PriceCode,
	CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,
	ISNULL(D.PrdBatDetailValue,0) AS OldLSP,C.PrdBatId,D.PrdBatId FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK) 
	INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode
	INNER JOIN ProductBatch C (NOLOCK)ON A.PrdBatCode=C.PrdBatCode AND B.PrdId=C.PrdId
	INNER JOIN ProductBatchDetails D (NOLOCK) ON  D.PrdBatId=C.PrdBatId AND D.DefaultPrice=1 AND D.SlNo=2
	WHERE A.PrdBatCode NOT IN (SELECT PrdBatCode FROM PrdBatToAvoid) AND DownLoadFlag='D'
	
	--Added By Sathishkumar Veeramani 2015/01/08
	--Selling Rate Validation
	INSERT INTO @ExistingSellingPriceDetails (PrdId,PrdBatId,PriceId)
	SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK) 
	INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode
	INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.SellingRate = C.PrdBatDetailValue
	WHERE C.SLNo = 3
	
	--List Price Validation
	INSERT INTO @ExistingListPriceDetails (PrdId,PrdBatId,PriceId)
	SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK) 
	INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode
	INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.ListPrice = C.PrdBatDetailValue
	WHERE C.SLNo = 2
	
	SELECT DISTINCT A.PrdId,A.PrdBatId,MAX(A.PriceId) AS PriceId INTO #ExistinPriceCloning 
	FROM @ExistingSellingPriceDetails A 
	INNER JOIN @ExistingListPriceDetails B ON A.PrdId = B.PrdId
	AND A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId GROUP BY A.PrdId,A.PrdBatId
	
	IF EXISTS (SELECT DISTINCT PrdId,PrdBatId,PriceId FROM #ExistinPriceCloning)
	BEGIN
	    UPDATE A SET A.DefaultPrice = 0 FROM ProductBatchDetails A (NOLOCK) 
	    INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId
	    
	    UPDATE A SET A.DefaultPrice = 1 FROM ProductBatchDetails A (NOLOCK)
	    INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId
	    
	    UPDATE A SET A.DefaultPriceId = B.PriceId FROM ProductBatch A (NOLOCK) 
	    INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId	    
	END
	--Till Here
	
	--Added By Sathishkumar Veeramani 2015/01/08
	--Batch Cloning Details
    DECLARE @BatchPriceId AS NUMERIC(18,0)
    SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK)
	SELECT DISTINCT CAST(DENSE_RANK() OVER (ORDER BY MAX(PrdBatId),MRP,ListPrice,SellingRate,ClaimRate,AddRate1) AS NUMERIC(18,0))+@BatchPriceId AS PriceId,
	MAX(PrdBatId) AS PrdBatId,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+CAST(SellingRate AS NVARCHAR(25))+'-'+
	--Code Added and commented by Deepan 07/11/2019
	--CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25))+'-'+CAST(LCTRAmount AS NVARCHAR(25)) AS PriceCode,MRP,ListPrice,
	CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25))AS PriceCode,MRP,ListPrice,
	SellingRate,ClaimRate,AddRate1 AS LCTRAmount INTO #BatchCloningDetails FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK)
	INNER JOIN Product B (NOLOCK) ON A.PrdCCode = B.PrdCCode 
	INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId AND A.PrdBatCode = C.PrdBatCode WHERE DownloadFlag = 'D'
	AND NOT EXISTS (SELECT DISTINCT PrdId,PrdBatId FROM #ExistinPriceCloning D WHERE C.PrdId = D.PrdId AND C.PrdBatId = D.PrdBatId) 
	GROUP BY A.PrdBatCode,MRP,ListPrice,SellingRate,ClaimRate,AddRate1
	
	
	
	IF EXISTS (SELECT DISTINCT PrdBatId FROM #BatchCloningDetails)
	BEGIN
	    UPDATE A SET DefaultPrice = 0 FROM ProductBatchDetails A WITH(NOLOCK) 
		INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId
			    
		INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
		Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,1,SlNo,Rate,1,1,1,1,GETDATE(),1,GETDATE(),0 FROM(
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,1 AS SlNo,MRP AS Rate FROM #BatchCloningDetails UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,2 AS SlNo,ListPrice AS Rate FROM #BatchCloningDetails UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,3 AS SlNo,SellingRate AS Rate FROM #BatchCloningDetails UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,4 AS SlNo,ClaimRate AS Rate FROM #BatchCloningDetails UNION
		SELECT DISTINCT PriceId,PrdBatId,PriceCode,5 AS SlNo,LCTRAmount AS Rate FROM #BatchCloningDetails)Qry ORDER BY PrdBatId
		SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK)
		UPDATE Counters SET CurrValue = @BatchPriceId WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'
		
        UPDATE A SET DefaultPriceId = B.PriceId FROM ProductBatch A WITH(NOLOCK) 
		INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId
    END
	--Till Here
		
	IF EXISTS (SELECT * FROM @ExistingBatchDetails)
	BEGIN
		UPDATE A SET MnfDate=C.ManufacturingDate,ExpDate=ExpiryDate
		FROM ProductBatch A (NOLOCK) INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId
		INNER JOIN Cn2Cs_Prk_ProductBatch_GST C (NOLOCK) ON A.PrdBatCode=C.PrdBatCode  AND B.PrdCCode=C.PrdCCode
		WHERE C.DownLoadFlag='D'
	
		UPDATE Cn2Cs_Prk_ProductBatch_GST SET DownLoadFlag='Y' 
		WHERE PrdCCode+'~'+PrdBatCode IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ExistingBatchDetails) AND DownLoadFlag='D' 
	END
	
	DECLARE @Count1	NUMERIC(18,0)
	DECLARE @Count2	NUMERIC(18,0)
	SELECT @Count1=COUNT(*) FROM Cn2Cs_Prk_ProductBatch_GST
	SELECT @Count2=COUNT(*) FROM @ExistingBatchDetails
	IF @Count1<>@Count2
		BEGIN
	--IF NOT EXISTS (SELECT * FROM @ExistingBatchDetails)
	--BEGIN
	---New ProductBatch		
		INSERT INTO @ProductBatchWithCounter
		SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatch' AND FldName='PrdBatId'),
		B.PrdId,A.PrdCCode,A.PrdBatCode,ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK) 
		INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C (NOLOCK) 
		WHERE C.PrdBatCode=A.PrdBatCode AND B.PrdId=C.PrdId)AND 
		A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'
		ORDER BY ManufacturingDate ASC --Muthuvel
		
			
		UPDATE @ProductBatchWithCounter SET TransNo=TransNo+Slno
	--Existing ProductBatch 
			INSERT INTO @ProductBatchWithCounter
			SELECT DISTINCT C.PrdBatId,B.PrdId,A.PrdCCode,A.PrdBatCode,
			ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch_GST A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode
			INNER JOIN ProductBatch C ON B.PrdId = C.PrdId AND C.PrdBatCode = A.PrdBatCode WHERE 
			NOT EXISTS (SELECT PrdBatId FROM ProductBatchDetails D(NOLOCK) WHERE D.PrdBatId = C.PrdBatId AND D.PriceId = C.DefaultPriceId)	
			AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'
			AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ProductBatchWithCounter)
	
	 --Product Batch   
		INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,Status,
		TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT A.PrdId,TransNo,PrdBatCode,PrdBatCode,MnfDate,ExpDate,
		CASE @GSTEnabled WHEN 1 THEN 1 ELSE 0 END as Status,
		B.TaxGroupId,@BatSeqId,
		6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchWithCounter A 
		INNER JOIN Product B ON A.PrdId=B.PrdId WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C WHERE A.PrdId = C.PrdId 
		AND A.PrdBatCode = C.PrdBatCode)
    --END 
		END
	IF EXISTS (SELECT * FROM @ProductBatchWithCounter) 
	BEGIN
		UPDATE Counters SET CurrValue = (SELECT MAX(PrdBatId) FROM ProductBatch) WHERE TabName = 'ProductBatch' AND FldName = 'prdbatid'
	
		INSERT INTO @ProductBatchPriceWithCounter
		SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'),A.PrdId,A.TransNo,
		A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+
		--Code Added and commented by Deepan 07/11/2019
		--CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25))+'-'+CAST(LCTRAmount AS NVARCHAR(25)),MRP,ListPrice,
		CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)),MRP,ListPrice,
		SellingRate,ClaimRate,AddRate1 FROM @ProductBatchWithCounter A INNER JOIN Cn2Cs_Prk_ProductBatch_GST B WITH (NOLOCK)
		ON A.PrdCCode=B.PrdCCode AND A.PrdBatCode=B.PrdBatCode WHERE B.DownLoadFlag='D'
		
		UPDATE @ProductBatchPriceWithCounter SET TransNo=TransNo+Slno
				
		UPDATE A SET A.DefaultPrice=0 FROM ProductBatchDetails A WITH (NOLOCK),@ProductBatchPriceWithCounter B  
	    WHERE A.PrdBatId = B.PrdBatId
		
	END			
	
	IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
	END
	ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5
	BEGIN
		INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,
		DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		UNION
		SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
		
	END	
	UPDATE A SET DefaultPriceId=C.TransNo FROM ProductBatch A INNER JOIN @ProductBatchPriceWithCounter C ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId	
	
	IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter) 
	BEGIN
		UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails) 	WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'	
	END
	
	--Batch Cloning Price Details
	
	IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeRateForOldBatch' AND ModuleName='Botree Product Batch Download' AND Status=1)
	BEGIN
		IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter A INNER JOIN @ExistingBatchDetails B ON A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId
		WHERE (B.OldLSP-A.ListPrice)<>0 AND Slno=2)
		BEGIN
			SELECT @ValDiffRefNo = dbo.Fn_GetPrimaryKeyString('ValueDifferenceClaim','ValDiffRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			INSERT INTO ValueDifferenceClaim(ValDiffRefNo,Date,PrdId,PrdBatId,OldPriceId,NewPriceId,OldPrice,NewPrice,Qty,
			ValueDiff,ClaimAmt,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			
			SELECT @ValDiffRefNo,GETDATE(),A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice,
			ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0),B.OldLsp-C.ListPrice,
			ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0)*(B.OldLsp-C.ListPrice),
			1,1,GETDATE(),1,GETDATE() FROM ProductBatchLocation A INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatID=B.PrdBatId 
			INNER JOIN @ProductBatchPriceWithCounter C ON A.PrdBatId=C.PrdBatId AND A.PrdId=C.PrdId
			WHERE C.Slno=2	GROUP BY A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice
			
			UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'ValueDifferenceClaim' AND FldName = 'ValDiffRefNo'
		END
	END
	UPDATE ProductBatch SET ProductBatch.DefaultPriceId=PBD.PriceId,ProductBatch.BatchSeqId=PBD.BatchSeqId
	FROM ProductBatchDetails PBD WITH (NOLOCK) WHERE ProductBatch.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1
	
	UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN
	(
	 SELECT PrdBatId FROM ProductBatchDetails WITH (NOLOCK) GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)
	)
	
	SELECT PrdBatId INTO #ZeroBatches FROM ProductBatchDetails WITH (NOLOCK)
	GROUP BY PrdBatId HAVING SUM(DefaultPrice)=0
	
	SELECT B.PrdId,B.PrdBatId,MAX(PriceId) As PriceId INTO #ZeroMaxPrices
	FROM ProductBatchDetails A INNER JOIN ProductBatch B ON A.PrdBatId=B.PrdBatId
	INNER JOIN #ZeroBatches C ON A.PrdBatId=C.PrdBatId
	WHERE A.DefaultPrice=0 AND NOT EXISTS
	(SELECT DISTINCT PriceId FROM #BatchCloningDetails D WHERE A.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId)
	AND NOT EXISTS (SELECT DISTINCT PriceId FROM #ExistinPriceCloning E WHERE A.PrdBatId = E.PrdBatId AND A.PriceId = E.PriceId)
	GROUP BY B.PrdId,B.PrdBatId 
	
	
	UPDATE ProductBatch Set DefaultPriceId=B.PriceId FROM ProductBatch A,#ZeroMaxPrices B
	WHERE A.PrdBatId=B.PrdbatId and A.PrdId=B.PrdId 
	
	UPDATE ProductBatchDetails Set DefaultPrice=1 FROM #ZeroMaxPrices A
	WHERE ProductBatchDetails.PrdbatId=A.PrdBatId AND ProductBatchDetails.PriceId=A.PriceId
	
	SET @Po_ErrNo=0
	SELECT @OldPriceIdExt=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails
	IF @ExistPrdBatMaxId>0
	BEGIN
		SELECT @NewPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch
		IF @NewPrdBatMaxId>@ExistPrdBatMaxId
		BEGIN
		    
		    --Existing Contract Pricing Percentage Updated to New Batch Download
		    --Modified by Rajesh
		    
     	--    SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate INTO #SpecialRateCreatedDate
		    --FROM SpecialRateAftDownload WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode
		    SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate  INTO #SpecialRateCreatedDate1  
			FROM SpecialRateAftDownload_calc WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode
			SELECT DISTINCT A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.CreatedDate ,A.ApplyOn,A.TYPE INTO #SpecialRateCreatedDate
			FROM SpecialRateAftDownload_calc A WITH(NOLOCK) INNER JOIN  #SpecialRateCreatedDate1 B (NOLOCK) 
			ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode  = B.RtrCtgValueCode AND A.RtrCode= B.RtrCode AND A.PrdCCode= B.PrdCCode
			AND A.CreatedDate = B.CreatedDate AND A.ApplyOn is not null
			SELECT DISTINCT C.PrdId,E.PrdBatId,TransNo AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,  
		   D.PrdBatCode,DiscountPerc,B.ApplyOn,B.Type,
		   (CASE B.ApplyOn WHEN 1 THEN 
			(CASE B.[Type] WHEN 1 THEN (MRP*100/(100+DiscountPerc)) WHEN 2 THEN MRP-(MRP*(DiscountPerc/100))
				ELSE SellingRate-(SellingRate*(DiscountPerc/100))  END)	 
			ELSE SellingRate-(SellingRate*(DiscountPerc/100)) END) AS SplRate
		   INTO #SpecialRateDetails   
		   FROM SpecialRateAftDownload_calc A WITH(NOLOCK)  
		   INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode   
		   AND A.RtrCode = B.RtrCode AND A.PrdCCode = B.PrdCCode AND A.CreatedDate = B.CreatedDate  
		   INNER JOIN Product C WITH(NOLOCK) ON A.PrdCCode = C.PrdCCode     
		   INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId  
		   INNER JOIN @ProductBatchPriceWithCounter E ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId  
		   ORDER BY A.PrdCCode 
			--Till Here			
	
			SELECT DISTINCT MAX(E.ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type
			INTO #SpecialContractDetails FROM #SpecialRateDetails A WITH(NOLOCK) 
			INNER JOIN RetailerCategoryLevel B WITH(NOLOCK) ON A.RtrCtgCode = B.CtgLevelName 
			INNER JOIN RetailerCategory C WITH(NOLOCK) ON A.RtrCtgValueCode = C.CtgCode AND B.CtgLevelId = C.CtgLevelId
			INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId 
			INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId AND A.PrdId = E.PrdId 
			GROUP BY A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type
			
			---Tax Calculation
			DECLARE @PrdIdTax as BIGINT
			DECLARE @PrdbatIdTax AS BIGINT
			DECLARE Cur_Tax CURSOR
			FOR 
			SELECT DISTINCT PrdId,PrdbatId FROM #SpecialContractDetails		
			OPEN Cur_Tax	
			FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax
			WHILE @@FETCH_STATUS=0
			BEGIN	
					EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax
			FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax		
			END		
			CLOSE Cur_Tax
			DEALLOCATE Cur_Tax	
			--Modified by Rajesh
						
			SELECT DISTINCT A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,RtrCtgValueCode)+ @OldPriceIdExt AS NewPriceId,
			--CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSelRate 
			CASE A.ApplyOn WHEN 1 THEN 
										(CASE [Type] WHEN 1 THEN (SplRate*100)/(100+TaxPercentage)
											WHEN 2 THEN (SplRate*100)/(100+TaxPercentage)	END)
			ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSelRate
			INTO #SplProductBatchDetails
			FROM #SpecialContractDetails A WITH(NOLOCK) INNER JOIN ProductBatchTaxPercent B WITH(NOLOCK) ON A.PrdId = B.PrdId
			AND A.PrdBatId = B.PrdBatId ORDER BY A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode
			
		
			--Product Batch Details Value Added			
			INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
            Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload) 
            SELECT DISTINCT NewPriceId,A.PrdBatId,PriceCode+'SplRate'+CONVERT(NVARCHAR(200),B.NewSelRate)+CONVERT(NVARCHAR(10),GETDATE(),121),
            A.BatchSeqId,A.SLNo,(CASE SelRte WHEN 1 THEN B.NewSelRate ELSE PrdBatDetailValue END),0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
            CONVERT(NVARCHAR(10),GETDATE(),121),0
            FROM ProductBatchDetails A WITH(NOLOCK) 
            INNER JOIN #SplProductBatchDetails B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId
            INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId
            INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo ORDER BY A.PrdBatId,NewPriceId 
            UPDATE Counters SET CurrValue =(SELECT MAX(PriceId) FROM ProductBatchDetails) WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'
            	
            --Contract Pricing Details Added
            INSERT INTO ContractPricingDetails (ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,LastModDate,AuthId,
            AuthDate,CtgValMainId,ClaimablePercOnMRP)            
            SELECT DISTINCT ContractId,A.PrdId,A.PrdBatId,B.NewPriceId,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),0,0
            FROM #SpecialContractDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdID AND A.PrdBatId = B.PrdBatId AND A.RtrCtgValueCode=B.RtrCtgValueCode
            WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE A.ContractId = C.ContractId 
            AND A.PrdId = C.PrdID AND A.PrdBatId = C.PrdBatId) ORDER BY ContractId,A.PrdId,A.PrdBatId,B.NewPriceId
            --Special Rate Updated
            INSERT INTO SpecialRateAftDownload (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,
            ContractPriceIds,DiscountPerc,SplrateId)
            SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
            '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0
            FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
            and A.RtrCtgValueCode=B.RtrCtgValueCode
            ORDER BY PrdCCode,PrdBatCode
            --Added By Rajesh
            INSERT INTO SpecialRateAftDownload_calc (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,
            ContractPriceIds,DiscountPerc,SplrateId,ApplyOn,TYPE)
            SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
            '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0,A.ApplyOn,A.TYPE
            FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
            and A.RtrCtgValueCode=B.RtrCtgValueCode
            ORDER BY PrdCCode,PrdBatCode
            --Till Here
		END
	END
	
	SELECT @NewPriceId=CurrValue FROM Counters (NOLOCK)	WHERE TabName='ProductBatchDetails' AND FldName='PriceId' 		
	IF @NewPriceId>@OldPriceId
	BEGIN
		IF EXISTS(SELECT * FROM Configuration(NOLOCK) WHERE ModuleId='BotreeRateForOldBatch'
		AND ModuleName='Botree Product Batch Download' AND Status=1)
		BEGIN
			EXEC Proc_DefaultPriceUpdation @ExistPrdBatMaxId,@OldPriceId,1
		END
	END
	IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@OldPriceId)
	BEGIN
		EXEC Proc_DefaultPriceHistory 0,0,@NewPriceId,2,1
	END
	
	UPDATE Cn2Cs_Prk_ProductBatch_GST SET DownLoadFlag='Y' 
	WHERE PrdCCode+'~'+PrdBatCode IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode
	FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)	
	RETURN		
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='CtgCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD CtgCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='CtgName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD CtgName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='ValueClassCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD ValueClassCode NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='ValueClassName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD ValueClassName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='ChannelCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD ChannelCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_DailySales') and name='ChannelName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DailySales ADD ChannelName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='CtgCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD CtgCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='CtgName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD CtgName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='ValueClassCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD ValueClassCode NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='ValueClassName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD ValueClassName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='ChannelCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD ChannelCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_SalesReturn') and name='ChannelName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_SalesReturn ADD ChannelName NVARCHAR(100)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_DailySales]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_DailySales]
GO
/*    
begin tran   
delete from errorlog  
delete from Cs2Cn_Prk_DailySales  
update SalesInvoice set upload = 0 where salinvdate >='2019-12-09'
EXEC Proc_Cs2Cn_DailySales 0,'2019-12-14'    
SELECT LCTRAmount,* FROM Cs2Cn_Prk_DailySales (NOLOCK) where salinvno in('P88071822390')  --and prdcode ='101701241181443312144PKT1305N'
select * from errorlog  
rollback tran     
*/    
CREATE PROCEDURE [Proc_Cs2Cn_DailySales]
(    
 @Po_ErrNo INT OUTPUT,    
 @ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_DailySales    
* PURPOSE  : To Extract Daily Sales Details from CoreStocky to upload to Console    
* CREATED BY : Nandakumar R.G    
* CREATED DATE : 19/03/2010    
* NOTE   :    
* MODIFIED BY : LAKSHMAN M  
* MODIFIED DATE : 06/11/2017   
* PMS ID   : ICRSTPAR6569  
* PURPOSE  : Daily Sales Details from CoreStocky upload LCTR Calculation Validation changed.    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
21/10/2014 Jisha Mathew Included Undelivered bills New Column Added BillStatus,UploadedDate     
12/12/2015 PRAVEENRAJ BHASKARAN LCTRAmount ADDED FOR CCRSTPAR0118    
09/11/2016 Gopikrishnan RtrUniqueCode Added
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************    
09-01-2018  lakshman M   BZ     ICRSTPAR7284          LCTR Formula velidation changed (special price not consider in LCTR Value).
06-02-2017	MOHANA		 BZ     ICRSTPAR7955		  DELVIERED BILLS NOT UPLOADED PROPERLY
25-05-2019  lakshman M   BS     ILCRSTPAR4571         While uploading dat one product done in billing different uom that time LCTR amount same amount reflct in two line level
11-11-2019  Deepan       CR     CRCRSTPAR0089         Category and Value Class and channel Added
*********************************/    
SET NOCOUNT ON    
BEGIN    
 DECLARE @CmpId    AS INT    
 DECLARE @DistCode As nVarchar(50)    
 DECLARE @DefCmpAlone AS INT    
 SET @Po_ErrNo=0    
 DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'Y'    
 IF EXISTS (SELECT * FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2)    
 BEGIN    
  DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2    
 END    
 SELECT @DefCmpAlone=Status FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'    
 SELECT @DistCode = DistributorCode FROM Distributor     
 SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1     
 --INSERT INTO Cs2Cn_Prk_DailySales    
 --(    
 -- DistCode  ,    
 -- SalInvNo  ,    
 -- SalInvDate  ,    
 -- SalDlvDate  ,    
 -- SalInvMode  ,    
 -- SalInvType  ,    
 -- SalGrossAmt  ,    
 -- SalSplDiscAmt ,    
 -- SalSchDiscAmt ,    
 -- SalCashDiscAmt ,    
 -- SalDBDiscAmt ,    
 -- SalTaxAmt  ,    
 -- SalWDSAmt  ,    
 -- SalDbAdjAmt  ,    
 -- SalCrAdjAmt  ,    
 -- SalOnAccountAmt ,    
 -- SalMktRetAmt ,    
 -- SalReplaceAmt ,    
 -- SalOtherChargesAmt,    
 -- SalInvLevelDiscAmt,    
 -- SalTotDedn  ,    
 -- SalTotAddn  ,    
 -- SalRoundOffAmt ,    
 -- SalNetAmt  ,    
 -- LcnId   ,    
 -- LcnCode   ,    
 -- SalesmanCode ,    
 -- SalesmanName ,     
 -- SalesRouteCode ,    
 -- SalesRouteName ,    
 -- RtrId   ,    
 -- RtrCode   ,    
 -- RtrName   ,    
 -- VechName  ,    
 -- DlvBoyName  ,    
 -- DeliveryRouteCode ,     
 -- DeliveryRouteName ,     
 -- PrdCode    ,    
 -- PrdBatCde   ,    
 -- PrdQty    ,    
 -- PrdSelRateBeforeTax ,    
 -- PrdSelRateAfterTax ,    
 -- PrdFreeQty  ,    
 -- PrdGrossAmt  ,    
 -- PrdSplDiscAmt ,    
 -- PrdSchDiscAmt ,    
 -- PrdCashDiscAmt ,    
 -- PrdDBDiscAmt ,    
 -- PrdTaxAmt  ,    
 -- PrdNetAmt  ,    
 -- UploadFlag  ,    
 -- SalInvLineCount ,    
 -- SalInvLvlDiscPer,    
 -- BillStatus,    
 -- UploadedDate,    
 -- OrderRefNo,    
 -- SFAOrderRefNo,    
 -- RtrUniqueCode,
 -- CtgCode,
 -- CtgName,
 -- ValueClassCode,
 -- ValueClassName,
 -- ChannelCode,
 -- ChannelName      
 --)    
 --SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
 --(CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
 --(CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
 --A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
 --A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
 --A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
 --B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
 --ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
 --G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
 --G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
 --G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
 --'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
 --GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,''),RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
 --RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName     
 --FROM SalesInvoice A  (NOLOCK)    
 --INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
 --INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
 --INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
 --LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
 --LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
 --INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
 --INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
 --INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
 --INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
 --INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId  
 ----Code Added by Deepan on 11/11/2019
 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
 --AND A.RTRValueClassId=RM.RtrValueClassId
 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
 --WHERE A.Upload=0 ORDER BY A.SalId   
 
 
 INSERT INTO Cs2Cn_Prk_DailySales    
 (    
  DistCode  ,    
  SalInvNo  ,    
  SalInvDate  ,    
  SalDlvDate  ,    
  SalInvMode  ,    
  SalInvType  ,    
  SalGrossAmt  ,    
  SalSplDiscAmt ,    
  SalSchDiscAmt ,    
  SalCashDiscAmt ,    
  SalDBDiscAmt ,    
  SalTaxAmt  ,    
  SalWDSAmt  ,    
  SalDbAdjAmt  ,    
  SalCrAdjAmt  ,    
  SalOnAccountAmt ,    
  SalMktRetAmt ,    
  SalReplaceAmt ,    
  SalOtherChargesAmt,    
  SalInvLevelDiscAmt,    
  SalTotDedn  ,    
  SalTotAddn  ,    
  SalRoundOffAmt ,    
  SalNetAmt  ,    
  LcnId   ,    
  LcnCode   ,    
  SalesmanCode ,    
  SalesmanName ,     
  SalesRouteCode ,    
  SalesRouteName ,    
  RtrId   ,    
  RtrCode   ,    
  RtrName   ,    
  VechName  ,    
  DlvBoyName  ,    
  DeliveryRouteCode ,     
  DeliveryRouteName ,     
  PrdCode    ,    
  PrdBatCde   ,    
  PrdQty    ,    
  PrdSelRateBeforeTax ,    
  PrdSelRateAfterTax ,    
  PrdFreeQty  ,    
  PrdGrossAmt  ,    
  PrdSplDiscAmt ,    
  PrdSchDiscAmt ,    
  PrdCashDiscAmt ,    
  PrdDBDiscAmt ,    
  PrdTaxAmt  ,    
  PrdNetAmt  ,    
  UploadFlag  ,    
  SalInvLineCount ,    
  SalInvLvlDiscPer,    
  BillStatus,    
  UploadedDate,    
  OrderRefNo,    
  SFAOrderRefNo,    
  RtrUniqueCode
     
 )    
 SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
 (CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
 (CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
 A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
 A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
 A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
 B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
 ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
 G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
 G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
 G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
 'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
 GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,'')
 FROM SalesInvoice A  (NOLOCK)    
 INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
 INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
 INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
 LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
 LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
 INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
 INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
 INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
 INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
 INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId 
 LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
 WHERE A.Upload=0 ORDER BY A.SalId  
 
 ----Code Added by Deepan on 11/11/2019
 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID 
 --AND A.RTRValueClassId=RM.RtrValueClassId
 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 --LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
 --WHERE A.Upload=0 ORDER BY A.SalId   
 
 UPDATE  Cs2Cn_Prk_DailySales SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName
 FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN SALESINVOICE S(NOLOCK) ON C.SALINVNO=S.SALINVNO
 INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON  S.RTRValueClassId=RM.RtrValueClassId
 INNER JOIN RetailerValueClass RC(NOLOCK) ON RM.RtrValueClassId =RC.RtrClassId
 
 UPDATE  Cs2Cn_Prk_DailySales SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
 FROM Cs2Cn_Prk_DailySales C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 
 
   
 
 
 --UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 --FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 --INNER JOIN (    
 --SELECT SalId,SalInvNo,PrdCCode,CmpBatCode,ISNULL(GrossAmt,0) AS GrossAmt,ISNULL(TaxAmount,0) AS TaxAmount,  
 --ISNULL(GrossAmt+TaxAmount,0) AS LCTRAmt     
 --FROM(    
 --SELECT S.SALID,S.SALINVNO,P.PRDID,P.PRDCCODE,PB.CmpBatCode,SP.BASEQTY,SP.PrdUom1EditedSelRate,  
 --ISNULL((SP.BASEQTY*SP.PrdUom1EditedSelRate),0) AS GrossAmt,    
 --ISNULL(Tax.TaxAmount,0) AS TaxAmount    
 --FROM SalesInvoice S (NOLOCK)    
 --INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId=SP.SALID    
 --INNER JOIN (    
 --SELECT SalId,PrdSlno,SUM(TaxAmount) TaxAmount FROM SalesInvoiceProductTax (NOLOCK)    
 --GROUP BY SalId,PrdSlno    
 --)Tax ON Tax.SalId=S.SalId AND SP.SalId=Tax.SalId AND SP.SlNo=Tax.PrdSlNo    
 --INNER JOIN Product P (NOLOCK) ON P.PrdId=SP.PrdId    
 --INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId AND PB.PrdBatId=SP.PrdBatId    
 --) X    
 --WHERE EXISTS (SELECT SalInvNo,PrdCode,PrdBatCde FROM Cs2Cn_Prk_DailySales Y WHERE     
 --X.SalInvNo=Y.SalInvNo AND X.PrdCCode=Y.PrdCode AND X.CmpBatCode=Y.PrdBatCde)    
 --) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
 ---------- Modified by Lakshman M on 06/11/2017 PMS_ICRSTPAR6569 ------------  
  UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 INNER JOIN (    
    SELECT SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,SUM(TaxableAmount) as TaxableAmount,SUM(LCTRAmt)as LCTRAmt,BaseQty FROM (
    SELECT DISTINCT A.SalId SalID ,A.SalInvNo SalInvNo,B.PrdId PrdId,P.PrdCCode PrdCCode,PB.CmpBatCode CmpBatCode,(C.TaxPerc) As taxperc,  
  (C.TaxableAmount) AS TaxableAmount,--PBD.PrdBatDetailValue,
  ((B.BaseQty *(PBD.PrdBatDetailValue))+((B.BaseQty *(PBD.PrdBatDetailValue))*sum(c.TaxPerc/100)))  As LCTRAmt,
  B.BaseQty As BaseQty
  FROM SalesInvoice A (NOLOCK)  
  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.SALID=B.SALID  
  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON A.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo  
  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId  
  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId  
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1	
  INNER JOIN Cs2Cn_Prk_DailySales PRK (NOLOCK)  
  ON PRK.SalInvNo=A.SalInvNo AND PRK.PrdCode=P.PrdCCode AND PRK.PrdBatCde=PB.CmpBatCode and prk.PrdQty=B.BaseQty   ------------- ILCRSTPAR4571 add by lakshman M Dated ON 25-05-2019 
  where C.TaxableAmount >0 and PBD.SLNo =3 -- AND A.salinvno ='P88071822390'-- AND b.prdid = 4777
  GROUP BY A.SalId,A.SalInvNo,B.PrdId,B.PrdUom1EditedSelRate,C.TaxPerc,P.PrdCCode,PB.CmpBatCode,C.TaxableAmount,B.PrdGrossAmount,B.PrdTaxAmount,
  B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue--,B.PrdUnitSelRate,
  HAVING (SUM(C.TaxableAmount))>0 ) A 
  Group by  SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,BaseQty
 ) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde AND Z.BaseQty= A.PrdQty
   ----------------- till here --------------------  
 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
 Where ProcId = 1    
 UPDATE A SET SalInvLineCount=B.SalInvLineCount    
 FROM Cs2Cn_Prk_DailySales A,(SELECT SI.SalInvNo,COUNT(SIP.PrdId) AS SalInvLineCount     
 FROM SalesInvoice SI,SalesInvoiceProduct SIP WHERE     
 SI.UPload=0 AND SI.SalId=SIP.SalId    
 GROUP BY SI.SalInvNo) B    
 WHERE A.SalInvNo=B.SalInvNo    
 --->Added By Nanda on 17/08/2010    
 INSERT INTO Cs2Cn_Prk_SalesInvoiceOrders(DistCode,SalInvNo,OrderNo,OrderDate,UploadFlag)    
 SELECT DISTINCT @DistCode,SI.SalInvNo,OB.OrderNo,OB.OrderDate,'N'    
 FROM SalesInvoice SI,SalesinvoiceOrderBooking SIOB,OrderBooking OB    
 WHERE SI.SalId=SIOB.SalId AND SIOB.OrderNo=OB.OrderNo AND SI.Upload=0 AND SI.DlvSts>3  
 --->Till Here    
 --UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT    
 --SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N') AND Dlvsts IN (3,4,5)   
  	--COMMENTED AND ADDED BY MOHANA  ICRSTPAR7955 
	UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT
	 SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N' AND BillStatus in(3,4,5))
	--TILL HERE
	
	UPDATE Cs2Cn_Prk_DailySales SET ServerDate=@ServerDate   
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_SalesReturn]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_SalesReturn]
GO
/*
BEGIN tran
delete from Cs2Cn_Prk_SalesReturn
update A set rptupload =0,upload=0 from salesinvoice A where SalInvDate between '2019-09-01' and'2019-09-30'
update A set rptupload =0,upload=0 from Returnheader A where ReturnDate between '2019-09-01' and'2019-09-30'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,''  
--delete from returnproducttax where returnid = 2532 and TaxableAmt <0 and TaxAmt <0
update a set status =0,upload =0 from returnheader A where returndate >='2019-11-01'
select * from UploadingReportTransaction
EXEC Proc_Cs2Cn_SalesReturn 0,'2019-09-19'
select * from Cs2Cn_Prk_SalesReturn where SRNRefNo ='PGST1900365'
select 'a',* from ParleOutputTaxPercentage where salid =2532
ROLLBACK tran
*/
CREATE PROCEDURE [Proc_Cs2Cn_SalesReturn] 
(  
 @Po_ErrNo INT OUTPUT,
 @ServerDate DATETIME  
)  
AS
--EXEC Proc_Cs2Cn_SalesReturn 0   
/*********************************  
* PROCEDURE  : Proc_Cs2Cn_SalesReturn  
* PURPOSE  : To Extract Sales Return Details from CoreStocky to upload to Console  
* CREATED BY : Nandakumar R.G  
* CREATED DATE : 21/03/2010  
* NOTE   :  
* MODIFIED  
***************************************************************************************************  
* DATE         AUTHOR         CR/BZ    USER STORY ID           DESCRIPTION                           
***************************************************************************************************  
21-12-2018   Lakshman M        SR      ILCRSTPAR2905        AS per client request LCTR Formula validation changed special price not consider Now default price only considered in LCTR Value. 
19-09-2019   Lakshman M        BZ      ILCRSTPAR6012        while upload sales return values tax perc values column script level validation missing in.
11-11-2019   Deepan			   CR	   CRCRSTPAR0089         Category and Value Class and channel Added
13-12-2019	 MOHANA S		   SR	   CRCRSTPAR0079		LCTR Calculation For New CR
12-11-2019   LAKSHMAN M        SR      ILCRSTPAR6643        Product tax calculation procedure validation splited for sales return upload process.											
*********************************/  
SET NOCOUNT ON  
BEGIN  
 DECLARE @CmpId    AS INT  
 DECLARE @DistCode  As nVarchar(50)  
 DECLARE @DefCmpAlone AS INT  
 SET @Po_ErrNo=0 
 DECLARE @FromDate DATETIME  
 DECLARE @ToDate DATETIME  
 SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK)
 EXEC Proc_SchUtilization_Report @FromDate,@ToDate
	 EXEC Proc_ReturnSalesProductTaxPercentage_SR @FromDate,@ToDate  
	 SELECT * INTO #ParleOutputTaxPercentage  FROM ParleOutputTaxPercentage_SR (NOLOCK) 
 DECLARE @SlNo AS INT  
 SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
 SELECT @DefCmpAlone=ISNULL(Status,0) FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'  
 DELETE FROM Cs2Cn_Prk_SalesReturn WHERE UploadFlag = 'Y'  
 SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1   
 SELECT @DistCode = DistributorCode FROM Distributor  
 --INSERT INTO [Cs2Cn_Prk_SalesReturn]  
 --(  
 -- DistCode  ,  
 -- SRNRefNo  ,  
 -- SRNRefType  ,  
 -- SRNDate   ,  
 -- SRNMode   ,  
 -- SRNType   ,   
 -- SRNGrossAmt  ,  
 -- SRNSplDiscAmt ,   
 -- SRNSchDiscAmt ,  
 -- SRNCashDiscAmt ,  
 -- SRNDBDiscAmt ,  
 -- SRNTaxAmt  ,  
 -- SRNRoundOffAmt ,
 -- SRNInvDiscount,  
 -- SRNNetAmt  ,  
 -- SalesmanName ,  
 -- SalesRouteName ,  
 -- RtrId   ,  
 -- RtrCode   ,  
 -- RtrName   ,  
 -- PrdSalInvNo  ,  
 -- PrdLcnId  ,  
 -- PrdLcnCode  ,  
 -- PrdCode   ,  
 -- PrdBatCde  ,  
 -- PrdSalQty  ,  
 -- PrdUnSalQty  ,  
 -- PrdOfferQty  ,  
 -- PrdSelRate  ,  
 -- PrdGrossAmt  ,  
 -- PrdSplDiscAmt ,  
 -- PrdSchDiscAmt ,  
 -- PrdCashDiscAmt ,  
 -- PrdDBDiscAmt ,  
 -- PrdTaxAmt  ,  
 -- PrdNetAmt  ,  
 -- UploadFlag,
 -- RtrUniqueCode,
 -- CtgCode,
 -- CtgName,
 -- ValueClassCode,
 -- ValueClassName,
 -- ChannelCode,
 -- ChannelName    
 --)  
 --SELECT  
 -- @DistCode ,  
 -- A.ReturnCode ,  
 -- (CASE ReturnType WHEN 1 THEN 'Market Return' ELSE 'Sales Return' END),  
 -- A.ReturnDate ,  
 -- (CASE A.ReturnMode WHEN 0 THEN '' WHEN 1 THEN 'Full' ELSE 'Partial' END),  
 -- (CASE A.InvoiceType WHEN 1 THEN 'Single Invoice' ELSE 'Multi Invoice' END),  
 -- A.RtnGrossAmt,A.RtnSplDisAmt,A.RtnSchDisAmt,A.RtnCashDisAmt,A.RtnDBDisAmt,  
 -- A.RtnTaxAmt,A.RtnRoundOffAmt,A.RtnInvLvlDisc,A.RtnNetAmt,  
 -- SM.SMName,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,  
 -- ISNULL(G.SalInvno,B.SalCode) AS SalInvNo,  
 -- L.LcnId,L.LcnCode,    
 -- D.PrdCCode,F.CmpBatCode,  
 -- (CASE ST.SystemStockType WHEN 1 THEN BaseQty ELSE 0 END)AS SalQty,  
 -- (CASE ST.SystemStockType WHEN 2 THEN BaseQty ELSE 0 END)AS UnSalQty,  
 -- (CASE ST.SystemStockType WHEN 3 THEN BaseQty ELSE 0 END)AS OfferQty,  
 -- B.PrdEditSelRte ,  
 -- B.PrdGrossAmt,B.PrdSplDisAmt,B.PrdSchDisAmt,B.PrdCDDisAmt,B.PrdDBDisAmt,  
 -- B.PrdTaxAmt,B.PrdNetAmt,  
 -- 'N' AS UploadFlag,ISNULL(R.RtrUniqueCode,'') ,RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
 -- RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName   
 -- FROM ReturnHeader A INNER JOIN ReturnProduct B ON A.ReturnId = B.ReturnId  
 -- INNER JOIN RouteMaster C ON A.RMID = C.RMID  
 -- INNER JOIN Product D ON B.PrdId = D.PrdId  
 -- INNER JOIN Company E ON D.CmpId = E.CmpId  
 -- INNER JOIN ProductBatch F ON B.PrdBatId = F.PrdBatId  
 -- INNER JOIN Retailer R ON R.RtrId=A.RtrId  
 -- LEFT OUTER JOIN SalesInvoice G ON B.SalId = G.SalId  
 -- INNER JOIN Salesman SM ON A.SMId=SM.SMId  
 -- INNER JOIN StockType ST ON B.StockTypeId=ST.StockTypeId  
 -- INNER JOIN Location L ON L.LcnId=ST.LcnId  
 --  --Code Added by Deepan on 11/11/2019
 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON A.RTRID =RM.RTRID AND A.RTRValueClassId=RM.RtrValueClassId
 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 --WHERE A.Status = 0 AND E.CmpId = (CASE @DefCmpAlone WHEN 1 THEN @CmpId ELSE E.CmpId END)  
 -- AND A.Upload=0 
  
  
  INSERT INTO [Cs2Cn_Prk_SalesReturn]  
 (  
  DistCode  ,  
  SRNRefNo  ,  
  SRNRefType  ,  
  SRNDate   ,  
  SRNMode   ,  
  SRNType   ,   
  SRNGrossAmt  ,  
  SRNSplDiscAmt ,   
  SRNSchDiscAmt ,  
  SRNCashDiscAmt ,  
  SRNDBDiscAmt ,  
  SRNTaxAmt  ,  
  SRNRoundOffAmt ,
  SRNInvDiscount,  
  SRNNetAmt  ,  
  SalesmanName ,  
  SalesRouteName ,  
  RtrId   ,  
  RtrCode   ,  
  RtrName   ,  
  PrdSalInvNo  ,  
  PrdLcnId  ,  
  PrdLcnCode  ,  
  PrdCode   ,  
  PrdBatCde  ,  
  PrdSalQty  ,  
  PrdUnSalQty  ,  
  PrdOfferQty  ,  
  PrdSelRate  ,  
  PrdGrossAmt  ,  
  PrdSplDiscAmt ,  
  PrdSchDiscAmt ,  
  PrdCashDiscAmt ,  
  PrdDBDiscAmt ,  
  PrdTaxAmt  ,  
  PrdNetAmt  ,  
  UploadFlag,
  RtrUniqueCode  
 )  
 SELECT  
  @DistCode ,  
  A.ReturnCode ,  
  (CASE ReturnType WHEN 1 THEN 'Market Return' ELSE 'Sales Return' END),  
  A.ReturnDate ,  
  (CASE A.ReturnMode WHEN 0 THEN '' WHEN 1 THEN 'Full' ELSE 'Partial' END),  
  (CASE A.InvoiceType WHEN 1 THEN 'Single Invoice' ELSE 'Multi Invoice' END),  
  A.RtnGrossAmt,A.RtnSplDisAmt,A.RtnSchDisAmt,A.RtnCashDisAmt,A.RtnDBDisAmt,  
  A.RtnTaxAmt,A.RtnRoundOffAmt,A.RtnInvLvlDisc,A.RtnNetAmt,  
  SM.SMName,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,  
  ISNULL(G.SalInvno,B.SalCode) AS SalInvNo,  
  L.LcnId,L.LcnCode,    
  D.PrdCCode,F.CmpBatCode,  
  (CASE ST.SystemStockType WHEN 1 THEN BaseQty ELSE 0 END)AS SalQty,  
  (CASE ST.SystemStockType WHEN 2 THEN BaseQty ELSE 0 END)AS UnSalQty,  
  (CASE ST.SystemStockType WHEN 3 THEN BaseQty ELSE 0 END)AS OfferQty,  
  B.PrdEditSelRte ,  
  B.PrdGrossAmt,B.PrdSplDisAmt,B.PrdSchDisAmt,B.PrdCDDisAmt,B.PrdDBDisAmt,  
  B.PrdTaxAmt,B.PrdNetAmt,  
  'N' AS UploadFlag,ISNULL(R.RtrUniqueCode,'')  
  FROM ReturnHeader A INNER JOIN ReturnProduct B ON A.ReturnId = B.ReturnId  
  INNER JOIN RouteMaster C ON A.RMID = C.RMID  
  INNER JOIN Product D ON B.PrdId = D.PrdId  
  INNER JOIN Company E ON D.CmpId = E.CmpId  
  INNER JOIN ProductBatch F ON B.PrdBatId = F.PrdBatId  
  INNER JOIN Retailer R ON R.RtrId=A.RtrId  
  LEFT OUTER JOIN SalesInvoice G ON B.SalId = G.SalId  
  INNER JOIN Salesman SM ON A.SMId=SM.SMId  
  INNER JOIN StockType ST ON B.StockTypeId=ST.StockTypeId  
  INNER JOIN Location L ON L.LcnId=ST.LcnId  
   --Code Added by Deepan on 11/11/2019
 --INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON A.RTRID =RM.RTRID AND A.RTRValueClassId=RM.RtrValueClassId
 --INNER JOIN RetailerValueClass RC(NOLOCK) ON A.RtrValueClassId =RC.RtrClassId
 --INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 --INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 --INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 WHERE A.Status = 0 AND E.CmpId = (CASE @DefCmpAlone WHEN 1 THEN @CmpId ELSE E.CmpId END)  
  AND A.Upload=0 
  
  
 UPDATE  [Cs2Cn_Prk_SalesReturn] SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName
 FROM [Cs2Cn_Prk_SalesReturn] C(NOLOCK) INNER JOIN ReturnHeader S(NOLOCK) ON C.SRNRefNo=S.ReturnCode
 INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON  S.RTRValueClassId=RM.RtrValueClassId
 INNER JOIN RetailerValueClass RC(NOLOCK) ON RM.RtrValueClassId =RC.RtrClassId
 
 UPDATE  [Cs2Cn_Prk_SalesReturn] SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
 FROM [Cs2Cn_Prk_SalesReturn] C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
 
 -------------- Added By LAkshman M dated ON 21-12-2018 PMS ID: ILCRSTPAR2905
 UPDATE PRK SET PRK.LCTRAmount=ISNULL(LCTRAmt,0)
 FROM Cs2Cn_Prk_SalesReturn PRK (NOLOCK)
 INNER JOIN 
 (
	SELECT R.ReturnId,R.ReturnCode,P.PrdCCode,PB.CmpBatCode,
	--(SUM(RP.BaseQty)*RP.PrdEditSelRte)+(SUM(RP.BaseQty)*RP.PrdEditSelRte)*(RPT.TaxPerc/100) AS LCTRAmt,
	ROUND(((Rp.BaseQty *(PBD.PrdBatDetailValue))+(Rp.BaseQty*PBD.PrdBatDetailValue)*(T.TaxPerc/100)),2) AS LCTRAmt,
	SUM(RPT.TaxableAmt) AS TaxableAmt,RPT.TaxPerc  
	FROM ReturnHeader R (NOLOCK)
	INNER JOIN ReturnProduct RP (NOLOCK) ON R.RETURNID=RP.RETURNID
	INNER JOIN ReturnProductTax RPT (NOLOCK) ON R.RETURNID=RPT.RETURNID AND RP.RETURNID=RPT.RETURNID AND RP.SlNO=RPT.PrdSlNo
	INNER JOIN Product P (NOLOCK) ON P.PrdId=RP.PrdId
	INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId AND PB.PrdId=RP.PrdId AND RP.PrdBatId=PB.PrdBatId
	INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1 AND PBD.SLNo =3
	INNER JOIN Cs2Cn_Prk_SalesReturn Prk (NOLOCK) ON Prk.PrdCode=P.PrdCCode AND Prk.PrdBatCde=PB.CmpBatCode
	INNER JOIN #ParleOutputTaxPercentage T (NOLOCK) ON R.ReturnID  = T.Salid AND Rp.Slno = T.PrdSlno  --  ILCRSTPAR6012 added by lakshman M 
	GROUP BY R.ReturnId,R.ReturnCode,P.PrdCCode,PB.CmpBatCode,RPT.TaxPerc,RP.PrdEditSelRte,Rp.BaseQty,PBD.PrdBatDetailValue,T.TaxPerc
	HAVING (SUM(RPT.TaxableAmt))>0
 ) Z ON Z.ReturnCode=PRK.SRNRefNo AND Z.PrdCCode=PRK.PrdCode AND Z.CmpBatCode=PRK.PrdBatCde

  
 SELECT DISTINCT P.Prdccode,PrdBatCode, PrdBatDetailValue LCTR INTO #LCTR 
 FROM  Product P 
 INNER JOIN ProductBatch A ON A.prdid =P.Prdid
 INNER JOIN ProductBatchDetails B ON A.PrdBatId = B.PrdBatId and DefaultPrice =1 and slno=5
 

UPDATE A SET LCTRAmount = B.LCTR FROM Cs2Cn_Prk_SalesReturn A INNER JOIN #LCTR B ON A.PrdBatCde = B.PrdBatCode AND A.PrdCode = B.PrdCCode 
WHERE B.LCTR>0


 ------------ Till here  ---------------
 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),  
 ProcDate = CONVERT(nVarChar(10),GetDate(),121)  
 Where ProcId = 4  
 UPDATE ReturnHeader SET Upload=1 WHERE Upload=0 AND ReturnCode IN (SELECT DISTINCT  
 SRNRefNo FROM Cs2Cn_Prk_SalesReturn WHERE UploadFlag = 'N') AND Status=0   
 UPDATE Cs2Cn_Prk_SalesReturn SET ServerDate=@ServerDate
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='CtgCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD CtgCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='CtgName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD CtgName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='ValueClassCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD ValueClassCode NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='ValueClassName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD ValueClassName NVARCHAR(100)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='ChannelCode')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD ChannelCode NVARCHAR(50)
END
GO
IF NOT Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'Cs2Cn_Prk_TransactionWiseGrnTracking') and name='ChannelName')
BEGIN
	ALTER TABLE Cs2Cn_Prk_TransactionWiseGrnTracking ADD ChannelName NVARCHAR(100)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_TransactionWiseGrnTracking]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cs2Cn_TransactionWiseGrnTracking]
GO
--EXEC Proc_Cs2Cn_TransactionWiseGrnTracking 0,'2017-01-14'
CREATE PROCEDURE [Proc_Cs2Cn_TransactionWiseGrnTracking]
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_TransactionWiseGrnTracking
* PURPOSE		: To Extract Bill Wise GRN refernce from CoreStocky to   Console
* CREATED BY	: Raja C
* CREATED DATE	: 05-06-2017
* NOTE			:
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}	
***************************************************************************************************
* DATE          AUTHOR      CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
* 21-09-2018   Lakshman M	 SR     ILCRSTPAR2151         GRN Tracking uplaod process enabled date On (21-09-2018) as per client request.
* 27-06-2018   Mohana S		 SR     ILCRSTPAR4961         Uploaded MRP,LSP AND Selrate
* 12-11-2019   Deepan        CR     CRCRSTPAR0092         Category and Value Class and channel Added

***************************************************************************************************/ 
SET NOCOUNT ON
BEGIN	
    SET @Po_ErrNo= 0
    -- RETURN -- > Commented By Lakshman M For GRN tracking  process enabled 
	DECLARE @DistCode	As nVarchar(50)
	SELECT @DistCode = DistributorCode FROM Distributor	(NOLOCK)	
	
	UPDATE A SET GSPUpload1 = 1 FROM TransactionWiseGrnTracking A WHERE Refdate  <'2018-09-21' ---> Add By Lakshman M PMS ID: ILCRSTPAR2151 Dated ON 21/09/2018 
	
	DELETE FROM Cs2Cn_Prk_TransactionWiseGrnTracking WHERE UploadFlag='Y'
	
	--ILCRSTPAR4961
	SELECT Prdbatid , Priceid, SUM(MRP) MRP,SUM(LSP) LSP,SUM(SelRate) SelRate
	INTO #ProductBatchDetails
	FROM
	( 
	SELECT PB.Prdbatid,PBD.Priceid,PBD.PrdbatDetailvalue AS MRP,0 LSP,0 SelRate FROM ProductBatch PB (NOLOCK)  
	INNER JOIN ProductBatchDetails PBD(NOLOCK)   ON PB.Prdbatid = PBD.PrdBatId and PBD.DefaultPrice = 1
	INNER JOIN BatchCreation B(NOLOCK)   ON PBD.SLNo = B.SLNO AND B.MRP = 1
	UNION ALL		
	SELECT PB.Prdbatid,PBD.Priceid,0,PBD.PrdbatDetailvalue AS LSP,0 FROM ProductBatch PB (NOLOCK)  
	INNER JOIN ProductBatchDetails PBD(NOLOCK)   ON PB.Prdbatid = PBD.PrdBatId and PBD.DefaultPrice = 1
	INNER JOIN BatchCreation B(NOLOCK)   ON PBD.SLNo = B.SLNO AND B.ListPrice  = 1
	UNION ALL		
	SELECT PB.Prdbatid,PBD.Priceid,0,0,PBD.PrdbatDetailvalue AS SelRate FROM ProductBatch PB (NOLOCK)  
	INNER JOIN ProductBatchDetails PBD(NOLOCK)   ON PB.Prdbatid = PBD.PrdBatId and PBD.DefaultPrice = 1
	INNER JOIN BatchCreation B(NOLOCK)   ON PBD.SLNo = B.SLNO AND B.SelRte = 1
	)A GROUP BY  PrdBatId ,PriceId 
	--ILCRSTPAR4961
	
	
	   --Code Added by Deepan on 11/11/2019(CRCRSTPAR0092)
	--INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	--GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate,MRP ,LSP ,SellingRate,CtgCode,CtgName,ValueClassCode,ValueClassName,ChannelCode,ChannelName)
	
	--SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	--A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate,
	--MRP ,LSP ,SelRate,RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
	--RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName    
	--FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	--INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	--INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	--INNER JOIN #ProductBatchDetails PBD ON PB.Prdbatid = PBD.PrdBatId 
	--INNER JOIN SalesInvoice S(NOLOCK) ON A.REFNO=S.SalInvNo
	--INNER JOIN Retailer R(NOLOCK) ON S.RtrId=R.RtrId 
	--INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON R.RTRID =RM.RTRID AND S.RTRValueClassId=RM.RtrValueClassId
	--INNER JOIN RetailerValueClass RC(NOLOCK) ON S.RtrValueClassId =RC.RtrClassId
	--INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	--INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	--INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	--WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' AND A.TransId=2
	
	INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate,MRP ,LSP ,SellingRate)
	
	SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate,
	MRP ,LSP ,SelRate
	FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	INNER JOIN #ProductBatchDetails PBD ON PB.Prdbatid = PBD.PrdBatId 
	INNER JOIN SalesInvoice S(NOLOCK) ON A.REFNO=S.SalInvNo
	WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' AND A.TransId=2
	
	UPDATE  Cs2Cn_Prk_TransactionWiseGrnTracking SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName
	FROM Cs2Cn_Prk_TransactionWiseGrnTracking C(NOLOCK) INNER JOIN SALESINVOICE S(NOLOCK) ON C.RefNo=S.SALINVNO
	INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON  S.RTRValueClassId=RM.RtrValueClassId
	INNER JOIN RetailerValueClass RC(NOLOCK) ON RM.RtrValueClassId =RC.RtrClassId
	WHERE C.TransactionDescription='Billing'
	
	 UPDATE  Cs2Cn_Prk_TransactionWiseGrnTracking SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
	 FROM Cs2Cn_Prk_TransactionWiseGrnTracking C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
	 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 WHERE C.TransactionDescription='Billing'
 	
 --	INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	--GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate,MRP ,LSP ,SellingRate,CtgCode,CtgName,ValueClassCode,ValueClassName,ChannelCode,ChannelName)
	
	--SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	--A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate,
	--MRP ,LSP ,SelRate,RY.CtgCode,RY.CtgName,RC.ValueClassCode,RC.ValueClassName,
	--RCY.CtgCode AS ChannelCode,RCY.CtgName As ChannelName    
	--FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	--INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	--INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	--INNER JOIN #ProductBatchDetails PBD ON PB.Prdbatid = PBD.PrdBatId 
	--INNER JOIN ReturnHeader S(NOLOCK) ON A.REFNO=S.ReturnCode
	--INNER JOIN Retailer R(NOLOCK) ON S.RtrId=R.RtrId
	--INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON S.RTRID =RM.RTRID AND S.RTRValueClassId=RM.RtrValueClassId
	--INNER JOIN RetailerValueClass RC(NOLOCK) ON S.RtrValueClassId =RC.RtrClassId
	--INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	--INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	--INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	--WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' AND A.TransId=3
	
		INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate,MRP ,LSP ,SellingRate)
	
	SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate,
	MRP ,LSP ,SelRate
	FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	INNER JOIN #ProductBatchDetails PBD ON PB.Prdbatid = PBD.PrdBatId 
	INNER JOIN ReturnHeader S(NOLOCK) ON A.REFNO=S.ReturnCode
	WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' AND A.TransId=3
	
	UPDATE  Cs2Cn_Prk_TransactionWiseGrnTracking SET ValueClassCode=RC.ValueClassCode,ValueClassName=RC.ValueClassName
	FROM Cs2Cn_Prk_TransactionWiseGrnTracking C(NOLOCK) INNER JOIN ReturnHeader S(NOLOCK) ON C.RefNo=S.ReturnCode
	INNER JOIN RetailerValueClassMap  RM(NOLOCK) ON  S.RTRValueClassId=RM.RtrValueClassId
	INNER JOIN RetailerValueClass RC(NOLOCK) ON RM.RtrValueClassId =RC.RtrClassId
	WHERE C.TransactionDescription='Sales Return'
	
	 UPDATE  Cs2Cn_Prk_TransactionWiseGrnTracking SET CtgCode= RY.CtgCode,CtgName=RY.CtgName,ChannelCode=RCY.CtgCode,ChannelName=RCY.CtgName  
	 FROM Cs2Cn_Prk_TransactionWiseGrnTracking C(NOLOCK) INNER JOIN RetailerValueClass RC(NOLOCK) ON C.ValueClassCode=RC.ValueClassCode
	 INNER JOIN RetailerCategory RY ON RC.CtgMainId = RY.CtgMainId
	 INNER JOIN RetailerCategoryLevel RCL ON RY.CtgLevelId = RCL.CtgLevelId
	 INNER JOIN RetailerCategory RCY ON  RY.CtgLinkId=RCY.CtgMainId
	 WHERE C.TransactionDescription='Sales Return'
	
	
	INSERT INTO Cs2Cn_Prk_TransactionWiseGrnTracking(DistCode,TransactionDescription,RefId,RefNo,Refdate,ProductCode,BatchCode,PrdSlno,BaseQty,FreeQty,
	GrnPrdSlNo,GrnQty,GrnFreeQty,PurRcptRefNo,GrnDate,UploadFlag,ServerDate,MRP ,LSP ,SellingRate)
	
	SELECT @DistCode,T.TransactionDescription AS  TransactionDescription,A.RefId,A.RefNo AS RefNo,A.Refdate AS Refdate,PrdCCode AS ProductCode,CmpBatCode AS BatchCode ,A.Slno AS PrdSlno,
	A.BaseQty AS BaseQty,A.FreeQty AS FreeQty,A.GrnPrdSlNo AS GrnPrdSlNo,A.GrnQty AS GrnQty,A.GrnFreeQty AS GrnFreeQty,A.PurRcptRefNo AS PurRcptRefNo,A.GrnDate AS GrnDate,'N',@ServerDate,
	MRP ,LSP ,SelRate 
	FROM TransactionWiseGrnTracking A(NOLOCK) INNER JOIN TransactionMaster T(NOLOCK) ON A.Transid =T.TransactionId 
	INNER JOIN Product P(NOLOCK) ON A.Prdid=P.PrdId
	INNER JOIN ProductBatch PB (NOLOCK) ON A.PrdBatid=PB.PrdBatId
	INNER JOIN #ProductBatchDetails PBD ON PB.Prdbatid = PBD.PrdBatId 
	WHERE GSPUpload1 = 0 AND Refdate >='2018-09-21' AND A.TransId NOT IN(2,3) ---> Add By Lakshman M PMS ID: ILCRSTPAR2151 Dated ON 21/09/2018 
	
	UPDATE A SET A.CmpInvNo=B.CmpInvNo From Cs2Cn_Prk_TransactionWiseGrnTracking A (Nolock) Inner Join PurchaseReceipt B (Nolock)On A.PurRcptRefNo=B.PurRcptRefNo ---Added By Mohanakrishna A.B
	
	UPDATE  A  SET GSPUpload1 = 1 FROM TransactionWiseGrnTracking A WHERE EXISTS (SELECT * FROM Cs2Cn_Prk_TransactionWiseGrnTracking B(NOLOCK)
	WHERE A.RefId=B.RefId AND A.RefNo=B.RefNo )
		
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[RptDebitNoteClaim_Excel1WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel1WID]  (
	[DNRefId] [int] NULL,
	[RefNo] [nvarchar](100) NOT NULL,
	[SMName] [nvarchar](100) NOT NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[TotAchSales] [numeric](18, 6) NOT NULL,
	[FrmRange] [numeric](18, 4) NOT NULL,
	[ToRange] [numeric](18, 4) NOT NULL,
	[FixedPay] [numeric](18, 6) NOT NULL,
	[VarPay] [numeric](18, 6) NOT NULL,
	[IncAmount] [numeric](18, 6) NOT NULL,
	) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[RptDebitNoteClaim_Excel2WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel2WID ](
	[DNRefId] [int] NULL,
	[RefNo] [nvarchar](100) NOT NULL,
	[SMCnt] [int] NOT NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[TotAchSales] [numeric](18, 6) NOT NULL,
	[IncAmt] [numeric](18, 6) NOT NULL
	) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptDebitNoteClaim_Excel3WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel3WID](
	[DNRefId] [int] NULL,
	[SchDesc] [nvarchar](100) NOT NULL,
	[FromDate] [datetime] NOT NULL,
	[ToDate] [datetime] NOT NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[SchBudget] [numeric](18, 6) NOT NULL,
	[SecSales] [numeric](18, 6) NOT NULL,
	[LiabPerc] [numeric](18, 6) NOT NULL,
	[ClmAmt] [numeric](18, 6) NOT NULL
	) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptDebitNoteClaim_Excel4WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel4WID](
	[DNRefId] [int] NULL,
	[CtgName] [nvarchar](100) NOT NULL,
	[FromDate] [datetime] NOT NULL,
	[ToDate] [datetime] NOT NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[NrmlAmt] [numeric](18, 6) NOT NULL,
	[TOTAmt] [numeric](18, 6) NOT NULL,
	[DiffAmt] [numeric](18, 6) NOT NULL
	) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptDebitNoteClaim_Excel5WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel5WID](
	[DNRefId] [int] NULL,
	[CtgName] [nvarchar](100) NOT NULL,
	[FromDate] [datetime] NOT NULL,
	[ToDate] [datetime] NOT NULL,
	[CirNo] [nvarchar](50) NOT NULL,
	[MonTarget] [numeric](38, 6) NOT NULL,
	[Lst2MntSAl] [numeric](38, 6) NOT NULL,
	[CurMonth] [numeric](38, 6) NOT NULL,
	[OutletCnt] [int] NULL,
	[TotDiscount] [numeric](38, 6) NOT NULL
	) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptDebitNoteClaim_Excel6WID]') AND type in (N'U'))
CREATE TABLE [RptDebitNoteClaim_Excel6WID](
	[DNRefId] [int] NULL,
	[SchId] [int] NOT NULL,
	[SchDesc] [nvarchar](200) NOT NULL,
	[FrmDate] [datetime] NULL,
	[ToDate] [datetime] NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[SchBudget] [numeric](38, 6) NOT NULL,
	[Lst2MntSAl] [numeric](38, 6) NOT NULL,
	[Wk4PriVal] [numeric](38, 6) NOT NULL,
	[SchPrimary] [numeric](38, 6) NOT NULL,
	[SecSales] [numeric](38, 6) NOT NULL,
	[LaibPer] [numeric](38, 6) NOT NULL,
	[CalClmAmt] [numeric](38, 6) NOT NULL,
	[OrgClmAmt] [numeric](38, 6) NOT NULL		
) ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptDebitNoteClaim_Excel7WID]') AND type in (N'U'))
CREATE TABLE [dbo].[RptDebitNoteClaim_Excel7WID](
	[DNRefId] [int] NOT NULL,
	[SancDate] [datetime] NOT NULL,
	[FromDate] [datetime] NOT NULL,
	[ToDate] [datetime] NOT NULL,
	[CirNo] [nvarchar](100) NOT NULL,
	[SamAmt] [numeric](38, 6) NOT NULL
	) ON [PRIMARY]
GO
DELETE FROM RptHeader WHERE RPTID=293
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'DebitNoteClaimCrystal','Debit Note Claim',293,'Debit Note Claim','Proc_RptDebitNoteClaim','RptDebitNoteClaim','RptDebitNoteClaim.rpt',''
GO
DELETE FROM RptGroup  WHERE RPTID=293
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'ParleReports',293,'DebitNoteClaimCrystal','Debit Note Claim',0
GO
DELETE FROM RptDetails   WHERE RPTID=293
INSERT INTO RptDetails(RptId,SlNo,TblName,PrntId,PrntRefFld,FldName,FldCaption,PrntTbl,CtrlType,CmnFld,SelcId,SingleMulti,Mandatory,PnlMsg,CaptionChange) 
SELECT 293,1,'FromDate',-1,'','','From Date*','',1,'',10,0,1,'Enter From Date',	0
UNION ALL
SELECT 293,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0
UNION ALL
SELECT 293,3,'RptFilter',-1,NULL,'FilterId,FilterDesc,FilterDesc','Printer Type...',NULL,1,NULL,176,1,NULL,'Press F4/Double Click to select Printer Type',0	
GO
DELETE FROM RptFilter WHERE RPTID=293
INSERT INTO RptFilter(RptId,SelcId,FilterId,FilterDesc)
SELECT 293,176,0,'Generic'
UNION ALL
SELECT 293,176,1,'Laser'
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[DebitNoteBinaryFileDt]') AND type in (N'U'))
CREATE TABLE [DebitNoteBinaryFileDt](
	[ImageName] [varchar](500) NOT NULL,
	[Binaryfile] [varbinary](max) NULL,
	[DNDocNo] [varchar](100) NOT NULL,
	[Status] [int] NOT NULL,
	[Availability] [int] NOT NULL,
	[LastModBy] [int] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [int] NOT NULL,
	[AuthDate] [datetime] NOT NULL,
 CONSTRAINT [PK_DebitNoteBinaryFileDt] PRIMARY KEY CLUSTERED 
(
	[ImageName] ASC,
	[DNDocNo] ASC,
	[Status] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Cs2Cn_Prk_DebitNoteFileUpload]') AND type in (N'U'))
CREATE TABLE [Cs2Cn_Prk_DebitNoteFileUpload](
	[Slno] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[ImageName] [varchar](100) NULL,
	[Binaryfile] [varchar](max) NULL,
	[DNDocNo] [varchar](100) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[Syncid] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
DELETE FROM Tbl_UploadIntegration_QS  WHERE SequenceNo =73
GO
INSERT INTO Tbl_UploadIntegration_QS(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT 73,'DebitNoteFileUpload','DebitNoteFileUpload','Cs2Cn_Prk_DebitNoteFileUpload',GETDATE()
GO
DELETE FROM CUSTOMUPDOWNLOAD WHERE SlNo =174
GO
INSERT INTO CUSTOMUPDOWNLOAD(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 174,1,'DebitNoteFileUpload','DebitNoteFileUpload','Proc_Cs2Cn_DebitNoteFileUpload','','Cs2Cn_Prk_DebitNoteFileUpload','','Transaction','Upload',1
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cs2Cn_DebitNoteFileUpload]') AND type in (N'P', N'PC'))
DROP PROCEDURE Proc_Cs2Cn_DebitNoteFileUpload
GO
/*
BEGIN TRAN
EXEC Proc_Cs2Cn_DebitNoteFileUpload 0,'2019-05-29'
SELECT * FROM Cs2Cn_Prk_DebitNoteFileUpload
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_Cs2Cn_DebitNoteFileUpload]
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME 
)
AS
/*******************************************************************************************************************
* PROCEDURE: Proc_Cs2Cn_DebitNoteFileUpload  
* PURPOSE: Upload Distributor Debitnote PDF file  
* NOTES:  
* CREATED: Deepan
* DATE  : 21-11-2019
* MODIFIED  
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON			  | USER STORY ID  |  CR/BZ |  REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  443		   21-11-2019	Deepan					CRCRSTPAR0090	 CR			Debit Note Binary file upload
**********************************************************************************************************************/
SET NOCOUNT ON 
BEGIN
	DECLARE @Distcode AS Varchar(50)
  	SET @Po_ErrNo=0
  	SELECT @Distcode=DistributorCode FROM Distributor
	DELETE FROM Cs2Cn_Prk_DebitNoteFileUpload WHERE UploadFlag='Y'
	
	IF EXISTS (SELECT * FROM DebitNoteBinaryFileDt (NOLOCK)  WHERE Status =0)
	BEGIN
		INSERT INTO Cs2Cn_Prk_DebitNoteFileUpload (DistCode,ImageName,Binaryfile,DNDocNo,UploadFlag,ServerDate)
		SELECT @Distcode,ImageName,Binaryfile,DNDocNo,'N',@ServerDate
		FROM DebitNoteBinaryFileDt (NOLOCK)  WHERE Status =0
	END
	UPDATE DebitNoteBinaryFileDt SET STATUS=1 FROM DebitNoteBinaryFileDt D INNER JOIN Cs2Cn_Prk_DebitNoteFileUpload C ON
	D.DNDOCNO=C.DNDocNo WHERE D.STATUS =0
END
GO
DELETE FROM ManualConfiguration WHERE ProjectName ='PARLE' AND ModuleId ='ManualClm1' 
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','ManualClm1','Manual Claim','Manual Claim Doc Attachment is Non mandatory',0,'',0,10
GO
DELETE FROM ManualConfiguration WHERE ModuleId='ClaimDoc' and ModuleName='Claim Document'
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'GST','ClaimDoc','Claim Document','Claim Ref Document',1,1,2.00,1
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Import_DebitNoteBinaryData]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Import_DebitNoteBinaryData]
GO
CREATE PROCEDURE [Proc_Import_DebitNoteBinaryData]
(
	@file_path VARCHAR(MAX),
	@DNDocNo   VARCHAR(100)
)
AS
/************************************************************************************************************************************      
* PROCEDURE : Proc_Import_DebitNoteBinaryData      
* PURPOSE : Debit Note Claim in Crystal format  
* CREATED : Deepan     
* CREATED DATE :13-11-2019      
* NOTE  : Parle SP for Debit Note Claim      
* MODIFIED       
*************************************************************************************************************************************      
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                               
*************************************************************************************************************************************      
13-11-2019  Deepan    CR		CRCRSTPAR0091	       Debit note Claim report (Design in Crystal Reports)  
************************************************************************************************************************************/ 
DECLARE @os_file_path VARCHAR(1000)
DECLARE @sql VARCHAR(1000)
SET @os_file_path=@file_path
SET @sql = N'UPDATE dbo.DebitNoteBinaryFileDt 
			 SET Binaryfile = (SELECT * FROM OPENROWSET(BULK N''' + @os_file_path + ''', SINGLE_BLOB) as x)
			 WHERE imagename = ''' + @os_file_path + ''' AND DNDocNo = ''' + @DNDocNo + ''' '
EXEC(@sql)
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Fn_ValueClass]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [Fn_ValueClass]
GO
CREATE FUNCTION [Fn_ValueClass](@RtrId AS Int)
RETURNS @ValueClass Table
(
RtrValueClassId Int,
ValueClassCode Nvarchar(100),
ValueClassName Nvarchar(100),
RtrId BigInt,
Turnover Numeric(18,2)
)
AS
/************************************************************************************************************************************      
* FUNCTION : Fn_ValueClass      
* PURPOSE : Debit Note Claim in Crystal format  
* CREATED : Deepan     
* CREATED DATE :13-11-2019      
* NOTE  : Parle SP for Debit Note Claim      
* MODIFIED       
*************************************************************************************************************************************      
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                               
*************************************************************************************************************************************      
13-11-2019  Deepan    CR		CRCRSTPAR0081	       Debit note Claim report (Design in Crystal Reports)  
************************************************************************************************************************************/ 
BEGIN
INSERT INTO @ValueClass(RtrValueClassId,ValueClassCode,ValueClassName,RtrId,Turnover)
SELECT R.RtrClassId,R.ValueClassCode,R.ValueClassName,Rm.RtrId,R.Turnover  FROM RetailerValueClass R INNER JOIN  RetailerValueClassMap RM ON R.RtrClassId=rm.RtrValueClassId 
WHERE RM.RtrId =@RtrId 
RETURN
END
GO
--DEEPAN CHANGES ENDS
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='ManualClaimCostCentre' AND TYPE='U')
BEGIN
CREATE TABLE ManualClaimCostCentre
(
	ManualClmDesc	NVARCHAR(500),
	ValidFrom		DATETIME,
	ValidTo			DATETIME,
	CiRcularNo		NVARCHAR(50),
	CostCentreCde	NVARCHAR(50),
	CreatedDate		DATETIME 
)
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cn2Cs_Prk_ManualClaimDescription_Temp' AND TYPE='U')
BEGIN
	IF EXISTS (SELECT * FROM Cn2Cs_Prk_ManualClaimDescription WHERE DownloadFlag ='D')
	BEGIN
		SELECT * INTO Cn2Cs_Prk_ManualClaimDescription_Temp FROM Cn2Cs_Prk_ManualClaimDescription WHERE DownloadFlag ='D'
	END
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cn2Cs_Prk_ManualClaimDescription' AND TYPE='U')
DROP TABLE Cn2Cs_Prk_ManualClaimDescription
GO
CREATE TABLE Cn2Cs_Prk_ManualClaimDescription
(
	[DistCode]			[VARCHAR](100) NULL,
	[CircularNo]		[NVARCHAR](100) NULL,
	[CircularDate]		[DATETIME] NULL,
	[ManualClmDesc]		[VARCHAR](150) NULL,
	[ValidFromDate]		[DATETIME] NULL,
	[ValidToDate]		[DATETIME] NULL,
	[ProposedLibPer]	[NUMERIC](8, 4) NULL,
	[EffectiveFromDate] [DATETIME] NULL,
	[ActiveStatus]		[INT] NULL,
	[DownloadFlag]		[VARCHAR](1) NULL,
	[CreatedDate]		[DATETIME] NULL,
	[CostCentreCode]	[NVARCHAR](50) NULL
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cn2Cs_Prk_ManualClaimDescription_Temp' AND TYPE='U')
BEGIN
	
	INSERT INTO Cn2Cs_Prk_ManualClaimDescription(DistCode,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,
EffectiveFromDate,ActiveStatus,DownloadFlag,CreatedDate)
	SELECT DistCode,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,
EffectiveFromDate,ActiveStatus,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ManualClaimDescription_Temp

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_ManualClaimDescription' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_ManualClaimDescription
GO
/*
BEGIN TRAN
	EXEC Proc_Cn2Cs_ManualClaimDescription 0 
	SELECT * FROM Cn2Cs_Prk_ManualClaimDescription
	SELECT * FROM ManualClaimCostCentre 
	SELECT * FROM ManualClaimDescription
ROLLBACK TRAN
*/
CREATE PROCEDURE  Proc_Cn2Cs_ManualClaimDescription
(
	@Po_ErrNo	INT OUTPUT
)
AS
/***************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_ManualClaimDescription
* PURPOSE		: To insert records to parking table To main table DebitNote retailer
* CREATED BY	: S.MOORTHI
* CREATED DATE	: 22/06/2018
* MODIFIED
* DATE        AUTHOR			CR/BZ	USER STORY ID		DESCRIPTION         
----------------------------------------------------------------------------------------------------------------------------------------      
 22/06/2018  S.Moorthi			CR		CRCRSTPAR0014       Load description master in description and attachment option in Manual Claim
 01/10/2018  Amuthakumar P		CR		CRCRSTPAR0029		Add New Columns to import CircularNo, CircularDate, ProposedLibPer From Console
***************************************************************************************************************************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @RefId	AS INT
	SET @RefId=0
	SET @Po_ErrNo=0
	DELETE FROM Cn2Cs_Prk_ManualClaimDescription WHERE DownloadFlag='Y'
	IF NOT EXISTS(SELECT '*' FROM Cn2Cs_Prk_ManualClaimDescription (NOLOCK) WHERE DownloadFlag='D')
	BEGIN
		RETURN
	END
	SELECT DISTINCT DistCode,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,
	EffectiveFromDate,ActiveStatus,DownloadFlag,Max(CreatedDate) CreatedDate INTO #Cn2Cs_Prk_ManualClaimDescription FROM Cn2Cs_Prk_ManualClaimDescription
	GROUP BY DistCode,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,
	EffectiveFromDate,ActiveStatus,DownloadFlag

	SELECT @RefId=ISNULL(MAX(RefId),0) FROM ManualClaimDescription(NOLOCK)
	
	UPDATE M SET M.EffectiveFromDate=CONVERT(VARCHAR(10),N.EffectiveFromDate,121),M.ActiveStatus=N.ActiveStatus FROM 
	#Cn2Cs_Prk_ManualClaimDescription N(NOLOCK)
	INNER JOIN ManualClaimDescription M (NOLOCK) ON M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121)
	
	---- UPDATED New Columns CircularNo, CircularDate, ProposedLibPer by Amuthakumar  CRCRSTPAR0029 on 01/10/2018
	INSERT INTO ManualClaimDescription(RefId,CircularNo,CircularDate,ManualClmDesc,ValidFromDate,ValidToDate,ProposedLibPer,EffectiveFromDate,ActiveStatus,CreatedDate)
	SELECT ROW_NUMBER() OVER(ORDER BY ManualClmDesc,CONVERT(VARCHAR(10),ValidFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121)),CircularNo,CONVERT(VARCHAR(10),CircularDate,121),ManualClmDesc,
	CONVERT(VARCHAR(10),ValidFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121),ProposedLibPer,ISNULL(CONVERT(VARCHAR(10),EffectiveFromDate,121),CONVERT(VARCHAR(10),ValidToDate,121)),ActiveStatus,GETDATE() 
	FROM #Cn2Cs_Prk_ManualClaimDescription N(NOLOCK)
	WHERE DownloadFlag='D' AND ISNULL(ManualClmDesc,'')<>'' 
	and NOT EXISTS(SELECT * FROM ManualClaimDescription M (NOLOCK) WHERE M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) 
	AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121))
	
	INSERT INTO ManualClaimCostCentre
	SELECT DISTINCT N.ManualClmDesc,N.ValidFromDate,N.ValidToDate,N.CircularNo,CostCentreCode,GETDATE() FROM Cn2Cs_Prk_ManualClaimDescription N
	INNER JOIN   #Cn2Cs_Prk_ManualClaimDescription B ON N.ManualClmDesc = B.ManualClmDesc AND N.CircularNo = B.CircularNo AND
	N.ValidFromDate=B.ValidFromDate AND N.ValidToDate=B.ValidToDate AND N.CreatedDate = B.CreatedDate 
	WHERE
	N.DownloadFlag='D' AND ISNULL(N.ManualClmDesc,'')<>'' 
	and NOT EXISTS(SELECT * FROM ManualClaimCostCentre M (NOLOCK) WHERE M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFrom,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) 
	AND CONVERT(VARCHAR(10),M.ValidTo,121)=CONVERT(VARCHAR(10),N.ValidToDate,121)) 

	UPDATE N SET DownloadFlag='Y'  FROM Cn2Cs_Prk_ManualClaimDescription N (NOLOCK)
	WHERE EXISTS(SELECT * FROM ManualClaimDescription M (NOLOCK) WHERE M.ManualClmDesc=N.ManualClmDesc 
	AND CONVERT(VARCHAR(10),M.ValidFromDate,121)=CONVERT(VARCHAR(10),N.ValidFromDate,121) AND CONVERT(VARCHAR(10),M.ValidToDate,121)=CONVERT(VARCHAR(10),N.ValidToDate,121))
END
GO
DELETE FROM CustomCaptions WHERE CtrlName IN ('HotSch-504-2000-5','FpTotal-504-22-6','FpTotal-504-22-7') AND TransId = 504
INSERT INTO CustomCaptions
SELECT 504,2000,5,'HotSch-504-2000-5','ID','','',1,1,1,GETDATE (),1,GETDATE (),'ID','','',1,1 UNION
SELECT 504,22,6,'FpTotal-504-22-6','Service To Outlet','','',1,1,1,GETDATE (),1,GETDATE (),'Distributor Incentive','','',1,1 UNION 
SELECT 504,22,7,'FpTotal-504-22-7','Unit ROI','','',1,1,1,GETDATE (),1,GETDATE (),'SalesMan Incentive','','',1,1   
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Fn_ReturnPDFReportName]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnPDFReportName]
GO
--select * From Fn_ReturnPDFReportName(293,1)
CREATE FUNCTION [dbo].[Fn_ReturnPDFReportName](@RptId AS INT,@UsrId	INT)
RETURNS @PDFReportName TABLE
(
	LaserRptName	VARCHAR(100),
	GenericRptName	VARCHAR(100),
	RptCaption		VARCHAR(100)
)
AS
/************************************************
* FUNCTION : Proc_RptDebitNoteTopSheetNew    
* PURPOSE : Debit Note Top Sheet in Crystal format
* CREATED : S.MOORTHI   
* CREATED DATE :03-05-2019    
* NOTE  : Parle Function to Return Rpt File Selection for Debit Note Top Sheet    
* MODIFIED     
*************************************************************************
* DATE       AUTHOR   CR/BZ USER STORY ID           DESCRIPTION                             
**************************************************************************
24-06-2019  S.MOORTHI		SR		ILCRSTPAR4278       Debit note sheet report (Design in Crystal Reports)
25-11-2019  Deepan			CR		CRCRSTPAR0090       Debit note Claim report (Design in Crystal Reports)

*********************************************************************************/         
BEGIN
--CRCRSTPAR0090
	IF EXISTS(SELECT SelValue FROM ReportFilterDt  WHERE RptId=@RptId and SelId=176 AND SelValue=0 AND UsrId=@UsrId)
	BEGIN
		IF 	@RptId =292
		BEGIN
			INSERT INTO @PDFReportName(LaserRptName,GenericRptName,RptCaption)
			SELECT 'RptDebitNoteTopSheet_Laser.Rpt','RptDebitNoteTopSheet.rpt',RptCaption+' '+replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','') 
			FROM RptHeader Where RptId=@RptId
		END
		ELSE
		BEGIN
			INSERT INTO @PDFReportName(LaserRptName,GenericRptName,RptCaption)
			--SELECT 'RptDebitNoteClaim_Laser.Rpt','RptDebitNoteClaim.rpt',RptCaption+' '+replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','') 
			SELECT 'RptDebitNoteClaim_Laser.Rpt','RptDebitNoteClaim.rpt',replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','')+' '+ RptCaption
			FROM RptHeader Where RptId=@RptId
		END
	END
	ELSE
	BEGIN
		IF 	@RptId =292
		BEGIN	
			INSERT INTO @PDFReportName(LaserRptName,GenericRptName,RptCaption)
			SELECT 'RptDebitNoteTopSheet_Laser.Rpt','RptDebitNoteTopSheet_Laser.rpt',RptCaption+' '+replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','') 
			FROM RptHeader Where RptId=@RptId
		END
		ELSE
		BEGIN	
			INSERT INTO @PDFReportName(LaserRptName,GenericRptName,RptCaption)
			--SELECT 'RptDebitNoteClaim_Laser.Rpt','RptDebitNoteClaim_Laser.rpt',RptCaption+' '+replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','') 
			SELECT 'RptDebitNoteClaim_Laser.Rpt','RptDebitNoteClaim.rpt',replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','') +' '+RptCaption
			FROM RptHeader Where RptId=@RptId
		END	
	END	
	
	--IF EXISTS(SELECT * from MANUALCONFIGURATION WHERE MODULEID='REPORTPRINT' AND PROJECTNAME='PARLE' and STATUS=1)
	--BEGIN
		--IF @RptId=292
		--BEGIN
		--	INSERT INTO @PDFReportName(LaserRptName,GenericRptName,RptCaption)
		--	SELECT 'RptDebitNoteTopSheet_Laser.Rpt',RptName,RptCaption+' '+replace(convert(VARCHAR(20),GETDATE(),105)+''+left(convert(VARCHAR(20),GETDATE(),108),5) ,':','')FROM RptHeader Where RptId=292		
			
		--	--SELECT 'RptDebitNoteTopSheet_Laser.Rpt',RptName,RptCaption FROM RptHeader Where RptId=292		
		--	--SELECT 'RptDebitNoteTopSheet_Laser.Rpt',RptName,RptCaption+'_'+convert(VARCHAR(20),GETDATE(),105) FROM RptHeader Where RptId=292		
		--END
	--END
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_DefaultPriceUpdation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_DefaultPriceUpdation]
GO
/*
BEGIN TRANSACTION
EXEC Proc_DefaultPriceUpdation 4871,22302,1
--SELECT * FROM ProductBatchDetails ORDER BY PriceId
--WHERE PriceId>19
--SELECT * FROM ValueDifferenceClaim
--SELECT * FROM ExistPriceDetails
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_DefaultPriceUpdation]
(
	@Pi_ExistPrdBatId	INT,
	@Pi_ExistPriceId	INT,
	@Pi_UserId			INT
)
AS
/*********************************
* PROCEDURE		: Proc_DefaultPriceUpdation
* PURPOSE		: To update the latest Price
* CREATED		: Nandakumar R.G
* CREATED DATE	: 25/03/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 09-12-2019 Deepan      CR   CRCRSTPAR0083   Query Optimization
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @PrdId		INT
	DECLARE @PrdBatId	INT
	DECLARE @PriceId	INT
	DECLARE @PrdCCode	NVARCHAR(200)
	DECLARE @PrdBatCode	NVARCHAR(200)
	DECLARE @MRP		NUMERIC(38,6)
	DECLARE @LSP		NUMERIC(38,6)
	DECLARE @SellRate	NUMERIC(38,6)
	DECLARE @ClaimRate	NUMERIC(38,6)
	DECLARE @DClaimRate	NUMERIC(38,6)
	DECLARE @LSPChange		NUMERIC(38,6)
	DECLARE @StockInHand	NUMERIC(38,0)
	DECLARE @ValDiffRefNo	NVARCHAR(50)
	
	DECLARE @OldPriceId		INT
	DECLARE @OldLSP			NUMERIC(38,6)
	DECLARE @NewPriceId		INT
	DECLARE @NewPrdBatId	INT
	DECLARE @NewPrdBatCode	NVARCHAR(200)
	DECLARE @BatchSeqId		INT
	DECLARE @Check INT
	SET @Check=0
	--Code Commented and Modified by Deepan CRCRSTPAR0083
	--if exists (select * from dbo.sysobjects where id = object_id(N'[ExistPriceDetails]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	--drop table [ExistPriceDetails]
	--SELECT A.MRP,A.LSP,A.SR,A.CR,A.DCR,A.PrdId,MAX(A.PrdBatId) AS PrdBatId,MAX(A.BatchSeqId) AS BatchSeqId
	--INTO ExistPriceDetails
	--FROM
	--(
	--	SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
	--	PBDM.PrdBatDetailValue AS MRP,PBDL.PrdBatDetailValue AS LSP,PBDS.PrdBatDetailValue AS SR,PBDC.PrdBatDetailValue AS CR,PBDD.PrdBatDetailValue AS DCR
	--	FROM Product P (NOLOCK)
	--	INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
	--	INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
	--	INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
	--	INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId
	--	INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.ListPrice=1
	--	INNER JOIN ProductBatchDetails PBDS (NOLOCK) ON PB.PrdBatId=PBDS.PrdBatId
	--	INNER JOIN BatchCreation BCS (NOLOCK) ON BCS.BatchSeqId=PBDS.BatchSeqId AND BCS.SlNo=PBDS.SlNo AND BCS.SelRte=1
	--	INNER JOIN ProductBatchDetails PBDC (NOLOCK) ON PB.PrdBatId=PBDC.PrdBatId
	--	INNER JOIN BatchCreation BCC (NOLOCK) ON BCC.BatchSeqId=PBDC.BatchSeqId AND BCC.SlNo=PBDC.SlNo AND BCC.ClmRte=1
	--	INNER JOIN ProductBatchDetails PBDD (NOLOCK) ON PB.PrdBatId=PBDD.PrdBatId
	--	INNER JOIN BatchCreation BCD (NOLOCK) ON BCD.BatchSeqId=PBDD.BatchSeqId AND BCD.SlNo=PBDD.SlNo AND BCD.RefCode='E'
	--	WHERE PBDM.PriceId>@Pi_ExistPriceId AND PBDL.PriceId>@Pi_ExistPriceId AND PBDS.PriceId>@Pi_ExistPriceId
	--	AND PBDC.PriceId>@Pi_ExistPriceId AND PBDD.PriceId>@Pi_ExistPriceId
	--	AND PBDM.DefaultPrice=1 AND PBDL.DefaultPrice=1 AND PBDS.DefaultPrice=1 AND PBDC.DefaultPrice=1 AND PBDD.DefaultPrice=1
		
		--SELECT A.MRP,A.LSP,A.SR,A.CR,A.DCR,A.PrdId,MAX(A.PrdBatId) AS PrdBatId,MAX(A.BatchSeqId) AS BatchSeqId
		--INTO ExistPriceDetails
		--FROM
		--(	
		
		SELECT PrdId,PrdCCode,PrdBatId,PrdBatCode,PriceId,BatchSeqId,SUM(MRP) MRP,SUM(LSP) LSP,SUM(SR) SR,SUM(CR) CR,
		SUM(DCR) DCR INTO #PRICEDETAILS
		FROM (
		
		SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
		PBDM.PrdBatDetailValue AS MRP,0 AS LSP,0 AS SR,0 AS CR,0 AS DCR
		FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
		INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
		INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
		WHERE PBDM.PriceId>@Pi_ExistPriceId AND PBDM.DefaultPrice=1
		UNION ALL
		SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
		0 AS MRP,PBDM.PrdBatDetailValue AS LSP,0 AS SR,0 AS CR,0 AS DCR
		FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
		INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
		INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.ListPrice=1
		WHERE PBDM.PriceId>@Pi_ExistPriceId 
		AND PBDM.DefaultPrice=1
		UNION ALL
		SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
		0 AS MRP,0 AS LSP,PBDM.PrdBatDetailValue AS SR,0 AS CR,0 AS DCR
		FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
		INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
		INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.SelRte=1
		WHERE PBDM.PriceId>@Pi_ExistPriceId 
		AND PBDM.DefaultPrice=1
		UNION ALL
		SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
		0 AS MRP,0 AS LSP,0 AS SR,PBDM.PrdBatDetailValue AS CR,0 AS DCR
		FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
		INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
		INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.ClmRte=1
		WHERE PBDM.PriceId>@Pi_ExistPriceId 
		AND PBDM.DefaultPrice=1
		UNION ALL
		SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDM.PriceId,PBDM.BatchSeqId,
		0 AS MRP,0 AS LSP,0 AS SR,0 AS CR,PBDM.PrdBatDetailValue AS DCR
		FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
		INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
		INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.RefCode='E'
		WHERE PBDM.PriceId>@Pi_ExistPriceId 
		AND PBDM.DefaultPrice=1
		) A   GROUP BY  PrdId,PrdCCode,PrdBatId,PrdBatCode,PriceId,BatchSeqId
		
		
	if exists (select * from dbo.sysobjects where id = object_id(N'[ExistPriceDetails]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	drop table [ExistPriceDetails]
	SELECT A.MRP,A.LSP,A.SR,A.CR,A.DCR,A.PrdId,MAX(A.PrdBatId) AS PrdBatId,MAX(A.BatchSeqId) AS BatchSeqId
	INTO ExistPriceDetails
	FROM #PRICEDETAILS  A GROUP BY A.MRP,A.LSP,A.SR,A.CR,A.DCR
	
	
	CREATE TABLE #MRPDETAILSPRICE
	(
		PrdId BIGINT,
		PrdCCode VARCHAR(100),
		PrdBatId BIGINT,
		PrdBatCode VARCHAR(100),
		PriceId BIGINT,
		LSP NUMERIC(38,6),
		SR NUMERIC(38,6),
		CR NUMERIC(38,6),
		DCR NUMERIC(38,6)
		
	)
	
		
	--) A GROUP BY A.MRP,A.LSP,A.SR,A.CR,A.DCR,A.PrdId
	DECLARE Cur_ProductBatch CURSOR
	FOR SELECT PrdId,PrdBatId,BatchSeqId,MRP,LSP,SR,CR,DCR
	FROM ExistPriceDetails (NOLOCK) 	
	ORDER BY PrdId,PrdBatId
	OPEN Cur_ProductBatch
	FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchSeqId,@MRP,@LSP,@SellRate,@ClaimRate,@DClaimRate
	WHILE @@FETCH_STATUS=0
	BEGIN
			--SELECT @PrdId,@PrdCCode,@PrdBatId,@PrdBatCode,@PriceId,@BatchSeqId,@MRP,@LSP,@SellRate,@ClaimRate,@DClaimRate
			DELETE FROM #MRPDETAILSPRICE
			INSERT INTO #MRPDETAILSPRICE(PrdId,PrdCCode,PrdBatId,PrdBatCode,PriceId,LSP,SR,CR,DCR)
			SELECT PrdId,PrdCCode,PrdBatId,PrdBatCode,PriceId,SUM(LSP) AS LSP,SUM(SR) AS SR,SUM(CR) AS CR,SUM(DCR) AS DCR
				FROM (
				SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDL.PriceId,
				PBDL.PrdBatDetailValue LSP,0 SR,0 AS CR,0 AS DCR
				FROM Product P (NOLOCK) 
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId 
				INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId 
				INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
				INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId 
				INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.ListPrice=1
				WHERE P.PrdId=@PrdId AND PBDM.PrdBatDetailValue=@MRP AND PBDM.DefaultPrice=1
				AND PBDL.DefaultPrice=1
				UNION ALL

				SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDL.PriceId,
				0 AS LSP,PBDL.PrdBatDetailValue AS SR,0 AS CR,0 AS DCR
				FROM Product P (NOLOCK) 
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId 
				INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId 
				INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
				INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId 
				INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.SelRte=1
				WHERE P.PrdId=@PrdId AND PBDM.PrdBatDetailValue=@MRP AND PBDM.DefaultPrice=1
				AND PBDL.DefaultPrice=1
				UNION ALL
				SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDL.PriceId,
				0 AS LSP,0 AS SR,PBDL.PrdBatDetailValue AS CR,0 AS DCR
				FROM Product P (NOLOCK) 
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId 
				INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId 
				INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
				INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId 
				INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.ClmRte=1
				WHERE P.PrdId=@PrdId AND PBDM.PrdBatDetailValue=@MRP AND PBDM.DefaultPrice=1
				AND PBDL.DefaultPrice=1
				UNION ALL
				SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDL.PriceId,
				0 AS LSP,0 AS SR,0 AS CR,PBDL.PrdBatDetailValue AS DCR
				FROM Product P (NOLOCK) 
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId 
				INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId 
				INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
				INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId 
				INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.RefCode='E'
				WHERE P.PrdId=@PrdId AND PBDM.PrdBatDetailValue=@MRP AND PBDM.DefaultPrice=1
				AND PBDL.DefaultPrice=1
				) A  GROUP BY PrdId,PrdCCode,PrdBatId,PrdBatCode,PriceId
			
			
			if exists (select * from dbo.sysobjects where id = object_id(N'[ExistNewPriceDetails]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
			drop table [ExistNewPriceDetails]
			SELECT PrdBatId,PrdBatCode,A.LSP-@LSP AS LSPChange,A.LSP AS OldLSP,A.PriceId AS OldPriceId
			INTO ExistNewPriceDetails
			FROM #MRPDETAILSPRICE A
			--(
			--	SELECT P.PrdId,P.PrdCCode,PB.PrdBatId,PB.PrdBatCode,PBDL.PriceId,
			--	PBDL.PrdBatDetailValue AS LSP,PBDS.PrdBatDetailValue AS SR,PBDC.PrdBatDetailValue AS CR,PBDD.PrdBatDetailValue AS DCR
			--	FROM Product P (NOLOCK)
			--	INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
			--	INNER JOIN ProductBatchDetails PBDM (NOLOCK) ON PB.PrdBatId=PBDM.PrdBatId
			--	INNER JOIN BatchCreation BCM (NOLOCK) ON BCM.BatchSeqId=PBDM.BatchSeqId AND BCM.SlNo=PBDM.SlNo AND BCM.MRP=1
			--	INNER JOIN ProductBatchDetails PBDL (NOLOCK) ON PB.PrdBatId=PBDL.PrdBatId
			--	INNER JOIN BatchCreation BCL (NOLOCK) ON BCL.BatchSeqId=PBDL.BatchSeqId AND BCL.SlNo=PBDL.SlNo AND BCL.ListPrice=1
			--	INNER JOIN ProductBatchDetails PBDS (NOLOCK) ON PB.PrdBatId=PBDS.PrdBatId
			--	INNER JOIN BatchCreation BCS (NOLOCK) ON BCS.BatchSeqId=PBDS.BatchSeqId AND BCS.SlNo=PBDS.SlNo AND BCS.SelRte=1
			--	INNER JOIN ProductBatchDetails PBDC (NOLOCK) ON PB.PrdBatId=PBDC.PrdBatId
			--	INNER JOIN BatchCreation BCC (NOLOCK) ON BCC.BatchSeqId=PBDC.BatchSeqId AND BCC.SlNo=PBDC.SlNo AND BCC.ClmRte=1
			--	INNER JOIN ProductBatchDetails PBDD (NOLOCK) ON PB.PrdBatId=PBDD.PrdBatId
			--	INNER JOIN BatchCreation BCD (NOLOCK) ON BCD.BatchSeqId=PBDD.BatchSeqId AND BCD.SlNo=PBDD.SlNo AND BCD.RefCode='E'
			--	WHERE P.PrdId=@PrdId AND PBDM.PrdBatDetailValue=@MRP AND PBDM.DefaultPrice=1	
			--	AND PBDL.DefaultPrice=1 AND PBDS.DefaultPrice=1 AND PBDC.DefaultPrice=1 AND PBDD.DefaultPrice=1
			--) A
			WHERE A.LSP<>@LSP OR A.SR<>@SellRate OR A.CR<>@ClaimRate OR A.DCR<>@DClaimRate
			DECLARE Cur_NewProductBatch CURSOR
			FOR SELECT PrdBatId,PrdBatCode,LSPChange,OldLSP,OldPriceId
			FROM ExistNewPriceDetails (NOLOCK)
			OPEN Cur_NewProductBatch
			FETCH NEXT FROM Cur_NewProductBatch INTO @NewPrdBatId,@NewPrdBatCode,@LSPChange,@OldLSP,@OldPriceId
			WHILE @@FETCH_STATUS=0
			BEGIN
				---SELECT @NewPrdBatId,@NewPrdBatCode,@LSPChange,@OldLSP,@OldPriceId
				SELECT @NewPriceId=dbo.Fn_GetPrimaryKeyInteger('ProductBatchDetails','PriceId',YEAR(GETDATE()),MONTH(GETDATE()))		
				UPDATE Counters SET CurrValue=@NewPriceId WHERE TabName='ProductBatchDetails' AND FldName='PriceId'
				
				UPDATE ProductBatchDetails SET DefaultPrice=0 WHERE PrdBatId=@NewPrdBatId
				UPDATE ProductBatch SET DefaultPriceId=@NewPriceId WHERE PrdBatId=@NewPrdBatId
				INSERT ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
				Availability,LastModBy,LastModDate,AuthId,AuthDate)
				SELECT @NewPriceId,@NewPrdBatId,@NewPrdBatCode+'-'+CAST(@MRP AS NVARCHAR(20))+'-'+CAST(@LSP AS NVARCHAR(20))
				+'-'+CAST(@SellRate AS NVARCHAR(20))+'-'+CAST(@ClaimRate AS NVARCHAR(20))+'-'+CAST(@DClaimRate AS NVARCHAR(20)),
				@BatchSeqId,1,@MRP,1,1,1,1,GETDATE(),1,GETDATE()								
				UNION ALL
				SELECT @NewPriceId,@NewPrdBatId,@NewPrdBatCode+'-'+CAST(@MRP AS NVARCHAR(20))+'-'+CAST(@LSP AS NVARCHAR(20))
				+'-'+CAST(@SellRate AS NVARCHAR(20))+'-'+CAST(@ClaimRate AS NVARCHAR(20))+'-'+CAST(@DClaimRate AS NVARCHAR(20)),
				@BatchSeqId,2,@LSP,1,1,1,1,GETDATE(),1,GETDATE()
				UNION ALL				
				SELECT @NewPriceId,@NewPrdBatId,@NewPrdBatCode+'-'+CAST(@MRP AS NVARCHAR(20))+'-'+CAST(@LSP AS NVARCHAR(20))
				+'-'+CAST(@SellRate AS NVARCHAR(20))+'-'+CAST(@ClaimRate AS NVARCHAR(20))+'-'+CAST(@DClaimRate AS NVARCHAR(20)),
				@BatchSeqId,3,@SellRate,1,1,1,1,GETDATE(),1,GETDATE()
				UNION ALL				
				SELECT @NewPriceId,@NewPrdBatId,@NewPrdBatCode+'-'+CAST(@MRP AS NVARCHAR(20))+'-'+CAST(@LSP AS NVARCHAR(20))
				+'-'+CAST(@SellRate AS NVARCHAR(20))+'-'+CAST(@ClaimRate AS NVARCHAR(20))+'-'+CAST(@DClaimRate AS NVARCHAR(20)),
				@BatchSeqId,4,@ClaimRate,1,1,1,1,GETDATE(),1,GETDATE()
				UNION ALL				
				SELECT @NewPriceId,@NewPrdBatId,@NewPrdBatCode+'-'+CAST(@MRP AS NVARCHAR(20))+'-'+CAST(@LSP AS NVARCHAR(20))
				+'-'+CAST(@SellRate AS NVARCHAR(20))+'-'+CAST(@ClaimRate AS NVARCHAR(20))+'-'+CAST(@DClaimRate AS NVARCHAR(20)),
				@BatchSeqId,5,@DClaimRate,1,1,1,1,GETDATE(),1,GETDATE()	
				IF @LSPChange<>0
				BEGIN
					SELECT @StockInHand=ISNULL(SUM(PrdBatLcnSih+PrdBatLcnUih-PrdBatLcnRessih-PrdBatLcnResUih),0)
					FROM ProductBatchLocation (NOLOCK) WHERE PrdId=@PrdId AND PrdBatId=@NewPrdBatId			
					--SELECT @ValDiffRefNo,GETDATE(),@PrdId,(@StockInHand*@LSPChange),1,1,GETDATE(),1,GETDATE()
					--SELECT @StockInHand
					IF @StockInHand>0
					BEGIN
						SELECT @ValDiffRefNo = dbo.Fn_GetPrimaryKeyString('ValueDifferenceClaim','ValDiffRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
						
						INSERT INTO ValueDifferenceClaim(ValDiffRefNo,Date,PrdId,PrdBatId,OldPriceId,NewPriceId,OldPrice,NewPrice,Qty,ValueDiff,ClaimAmt,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@ValDiffRefNo,GETDATE(),@PrdId,@NewPrdBatId,@OldPriceId,@NewPriceId,@OldLSP,@LSP,@StockInHand,@LSPChange,@StockInHand*@LSPChange,1,1,GETDATE(),1,GETDATE())
						UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'ValueDifferenceClaim' AND FldName = 'ValDiffRefNo'
					END
				END
				FETCH NEXT FROM Cur_NewProductBatch INTO @NewPrdBatId,@NewPrdBatCode,@LSPChange,@OldLSP,@OldPriceId
			END
			CLOSE Cur_NewProductBatch
			DEALLOCATE Cur_NewProductBatch
		
		FETCH NEXT FROM Cur_ProductBatch INTO @PrdId,@PrdBatId,@BatchSeqId,@MRP,@LSP,@SellRate,@ClaimRate,@DClaimRate
	END
	CLOSE Cur_ProductBatch
	DEALLOCATE Cur_ProductBatch	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_ProductBatch]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_ProductBatch]
GO
/*   
   BEGIN TRANSACTION  
   delete FROM Errorlog
   --delete from Productbatchdetails where PrdbatId =965
   --delete from productbatchlocation where prdid = 2370 and prdbatid = 965
   --delete from stockledger where prdid = 2370 and prdbatid = 965
   --delete from Productbatch where PrdId =2370
   --exec Proc_Cn2Cs_Product 0  
   EXEC Proc_Cn2Cs_ProductBatch 0  
   --select * from contractpricingdetails where prdid =4676  
   --SELECT * FROM Productbatch WITH(NOLOCK) where PrdId =2370 order by 2 desc  
   --SELECT * FROM Productbatchdetails WITH(NOLOCK)   order by 1 desc  
   --select 'Ad',* from specialrateaftdownload where prdccode ='10310116150141114PKT00110N'
   --SELECT 'A',* FROM ProductBatchPriceWithCounter WITH(NOLOCK) 
   select *from errorlog  
   ROLLBACK TRANSACTION  
*/  
CREATE PROCEDURE [Proc_Cn2Cs_ProductBatch]  
(  
       @Po_ErrNo INT OUTPUT  
)  
AS  
/***************************************************************************************************  
* PROCEDURE  : Proc_Cn2Cs_ProductBatch  
* PURPOSE  : To Insert and Update records in the Tables ProductBatch and ProductBatchDetails  
* CREATED BY : Nandakumar R.G  
* CREATED DATE : 12/04/2010  
* MODIFIED      : Sathishkumar Veeramani  
* PURPOSE  : New Product Batch - Special Rate Created  
* MODIFIED DATE : 13/09/2012  
* MODIFIED      : Murugan.R  
* PURPOSE  : Batch Optimization  and Akzonabal Price change  
* MODIFIED DATE : 13/09/2012  
* DATE      AUTHOR     DESCRIPTION  
-----------------------------------------------------------------------------------------------------  
* 06-06-2019 MOHANA       CR   CRCRSTPAR0058   INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE  
* 13-08-2019 Lakshman M   BZ   ILCRSTPAR5522   While downlaod new product specail discount create validation missing in core stocky.
* 18-09-2019 Lakshman M   BZ   ILCRSTPAR5989   while download contarct pricing taking time script level validation optimised script has been changed. 
* 05-12-2019 Deepan       CR   CRCRSTPAR0083   LCTR Amount Included 
*****************************************************************************************************/  
SET NOCOUNT ON  
BEGIN  
 SET @Po_ErrNo =0  
 IF NOT EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE DownLoadFlag='D') RETURN  
 --Product batch configuration  For Aznoble Client  
 IF EXISTS(SELECT Status FROM Configuration where ModuleId='GENCONFIG33' and Status=1)  
  BEGIN  
   DELETE FROM ProductBatchEeffectiveDate WHERE UpdateFlag='Y'  
   INSERT INTO ProductBatchEeffectiveDate(PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,  
   EffectiveDate,MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,  
   AddRate3,AddRate4,AddRate5,AddRate6,UpdateFlag)      
   SELECT PrdCCode,PrdBatCode,ManufacturingDate,ExpiryDate,EffectiveDate,  
   MRP,ListPrice,SellingRate,ClaimRate,AddRate1,AddRate2,AddRate3,  
   AddRate4,AddRate5,AddRate6,'N'   
   FROM Cn2Cs_Prk_ProductBatch(nolock) WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)  
   ORDER BY ManufacturingDate ASC --Muthuvel  
   DELETE FROM Cn2Cs_Prk_ProductBatch  WHERE DownLoadFlag='D' AND EffectiveDate>CONVERT(DATETIME ,CONVERT(VARCHAR(10),GETDATE(),121),121)  
   --Product Batch and Price Insert For Aznoble Client  
   EXEC Proc_ValidateBatchLDEeffectiveDate  
   RETURN  
  END  
 IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatToAvoid' AND XTYPE = 'U')  
 BEGIN  
  DROP TABLE PrdBatToAvoid   
 END  
 CREATE TABLE PrdBatToAvoid  
 (  
  PrdCCode NVARCHAR(200),  
  PrdBatCode NVARCHAR(200)  
 )  
 DECLARE @ExistingBatchDetails TABLE  
 (  
  PrdId  NUMERIC(18,0),  
  PrdCCode VARCHAR(100),  
  PrdBatCode VARCHAR(100),  
  PriceCode VARCHAR(500),  
  OldLSP  NUMERIC(18,0),  
  PrdBatId NUMERIC(18,0),  
  PriceId  NUMERIC(18,0)  
 )  
 DECLARE @ProductBatchWithCounter TABLE  
 (  
  Slno   NUMERIC(18,0) IDENTITY(1,1),  
  TransNo   NUMERIC(18,0),  
  PrdId   NUMERIC(18,0),  
  PrdCCode  VARCHAR(100),  
  PrdBatCode  VARCHAR(100),  
  MnfDate   DATETIME,  
  ExpDate   DATETIME    
 )   
 DECLARE @ProductBatchPriceWithCounter TABLE  
 (  
  Slno   NUMERIC(18,0) IDENTITY(1,1),  
  TransNo   NUMERIC(18,0),  
  PrdId   NUMERIC(18,0),  
  PrdBatId  NUMERIC(18,0),  
  PriceCode  NVARCHAR(1000),  
  MRP    NUMERIC(18,6),  
  ListPrice  NUMERIC(18,6),  
  SellingRate  NUMERIC(18,6),  
  ClaimRate  NUMERIC(18,6),  
  AddRate1  NUMERIC(18,6)  
 )  
 DECLARE @ContractPrice TABLE  
 (  
    PrdId NUMERIC(18,0),  
    PrdBatId NUMERIC(18,0)  
 )  
 DECLARE @ContractBatchPrice TABLE  
    (  
    ContractId       NUMERIC(18,0),  
    CtgMainId        NUMERIC(18,0),  
    PrdId            NUMERIC(18,0),  
    PrdBatId         NUMERIC(18,0),  
    PriceId          NUMERIC(18,0),  
    PriceCode        NVARCHAR(500)  
    )  
    DECLARE @ProductBatchDetails TABLE  
 (  
    PrdId                NUMERIC(18,0),  
    PrdBatId      NUMERIC(18,0),  
    PriceId              NUMERIC(18,0),  
    PriceCode            NVARCHAR(500),  
    NewBatchId           NUMERIC(18,0),  
    Slno                 INT,  
    PrdBatDetailValue    NUMERIC(36,4),  
    NewPriceId           NUMERIC(18,0)  
 )  
 --Added By Sathishkumar Veeramani 2015/01/08  
 DECLARE @ExistingSellingPriceDetails TABLE  
 (  
     PrdId        NUMERIC(18,0),  
     PrdBatId     NUMERIC(18,0),  
     PriceId      NUMERIC(18,0)  
 )  
 DECLARE @ExistingListPriceDetails TABLE  
 (  
     PrdId        NUMERIC(18,0),  
     PrdBatId     NUMERIC(18,0),  
     PriceId      NUMERIC(18,0)  
 )  
 --Till Here    
 DECLARE @BatSeqId   AS INT  
 DECLARE @ValDiffRefNo  AS VARCHAR(100)  
 DECLARE @ExistPrdBatMaxId AS  INT  
 DECLARE @NewPrdBatMaxId  AS  INT   
 DECLARE @ContPriceId  AS  NUMERIC(18,0)  
 DECLARE @OldPriceIdExt   AS  NUMERIC(18,0)  
 DECLARE @OldPriceId   AS  NUMERIC(18,0)  
 DECLARE @NewPriceId   AS  INT  
 DECLARE @ContPrdId          AS  INT  
    DECLARE @ContPrdBatId       AS  INT  
    DECLARE @ContPriceId1       AS  INT  
    DECLARE @PriceId            AS  INT   
    DECLARE @PriceBatch         AS  INT  
    DECLARE @BatchTransfer  AS INT  
 DECLARE @Po_BatchTransfer AS INT  
 SELECT @OldPriceId=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails WITH (NOLOCK)    
 SELECT @BatSeqId=MAX(BatchSeqId) FROM BatchCreationMaster WITH (NOLOCK)  
 SELECT @ExistPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch WITH (NOLOCK)  
 SET @Po_ErrNo =0  
 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
 WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D')  
 BEGIN  
  INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)  
  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'  
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Product Batch','PrdCCode','Product :'+PrdCCode+' not available'  
  FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK))   
  AND DownLoadFlag='D'  
  --->Added By Nanda on 05/05/2010  
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)  
  SELECT DISTINCT DistCode,'Product Batch',PrdBatCode,'Product',PrdCCode,'','N' FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)   
  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'  
  --->Till Here      
 END  
 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
 WHERE LEN(ISNULL(PrdBatCode,''))=0  AND DownLoadFlag='D')  
 BEGIN  
  INSERT INTO PrdBatToAvoid(PrdCCode,PrdBatCode)  
  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
  WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Product Batch','PrdBatCode','Batch Code should not be empty for Product:'+PrdCCode  
  FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
  WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  
 END  
 INSERT INTO @ExistingBatchDetails (PrdId,PrdCCode,PrdBatCode,PriceCode,OldLSP,PrdBatId,PriceId)  
 SELECT DISTINCT B.PrdId,B.PrdCCode,A.PrdBatCode,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+  
 CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,  
 ISNULL(D.PrdBatDetailValue,0) AS OldLSP,C.PrdBatId,D.PrdBatId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode  
 INNER JOIN ProductBatch C (NOLOCK)ON A.PrdBatCode=C.PrdBatCode AND B.PrdId=C.PrdId  
 INNER JOIN ProductBatchDetails D (NOLOCK) ON  D.PrdBatId=C.PrdBatId AND D.DefaultPrice=1 AND D.SlNo=2  
 WHERE A.PrdBatCode NOT IN (SELECT PrdBatCode FROM PrdBatToAvoid) AND DownLoadFlag='D'  
 --Added By Sathishkumar Veeramani 2015/01/08  
 --Selling Rate Validation  
 INSERT INTO @ExistingSellingPriceDetails (PrdId,PrdBatId,PriceId)  
 SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode  
 INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.SellingRate = C.PrdBatDetailValue  
 WHERE C.SLNo = 3  
 --List Price Validation  
 INSERT INTO @ExistingListPriceDetails (PrdId,PrdBatId,PriceId)  
 SELECT DISTINCT PrdId,B.PrdBatId,C.PriceId FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
 INNER JOIN @ExistingBatchDetails B ON A.PrdCCode = B.PrdCCode AND A.PrdBatCode = B.PrdBatCode  
 INNER JOIN ProductBatchDetails C (NOLOCK) ON B.PrdBatId = C.PrdBatId AND A.ListPrice = C.PrdBatDetailValue  
 WHERE C.SLNo = 2  
 SELECT DISTINCT A.PrdId,A.PrdBatId,MAX(A.PriceId) AS PriceId INTO #ExistinPriceCloning   
 FROM @ExistingSellingPriceDetails A   
 INNER JOIN @ExistingListPriceDetails B ON A.PrdId = B.PrdId  
 AND A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId GROUP BY A.PrdId,A.PrdBatId  
 IF EXISTS (SELECT DISTINCT PrdId,PrdBatId,PriceId FROM #ExistinPriceCloning)  
 BEGIN  
     UPDATE A SET A.DefaultPrice = 0 FROM ProductBatchDetails A (NOLOCK)   
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId  
     UPDATE A SET A.DefaultPrice = 1 FROM ProductBatchDetails A (NOLOCK)  
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
     UPDATE A SET A.DefaultPriceId = B.PriceId FROM ProductBatch A (NOLOCK)   
     INNER JOIN #ExistinPriceCloning B ON A.PrdBatId = B.PrdBatId  
	 
     IF EXISTS (SELECT PriceId ,Count(Priceid) Cnt  FROM ProductBatchDetails group by PriceId HAVING COUNT(Priceid)>4  )
	BEGIN 
		SELECT Prdbatid,PriceId ,Count(Priceid) Cnt
		INTO #PrdBatch
		FROM ProductBatchDetails 
		group by Prdbatid,PriceId HAVING COUNT(Priceid)>4  
		SELECT  DISTINCT A.PrdBatid,B.Priceid  INTO #Price  FROM ProductBatch  A INNER JOIN PRODUCTBATCHDETAILS B ON A.PrdBatId = B.PrdBatid AND A.LastModDate = B.LastModDate 
		and b.PrdBatId IN (select Prdbatid FROM #PrdBatch)
		and PriceCode NOT LIKE '%Splrate%'  
		UPDATE A SET DefaultPriceId=B.PriceId FROM ProductBatch  A INNER JOIN PRODUCTBATCHDETAILS B ON A.PrdBatId = B.PrdBatid AND A.LastModDate = B.LastModDate 
		and  PriceCode NOT LIKE '%Splrate%'  and b.PrdBatId IN (select Prdbatid FROM #PrdBatch)
		UPDATE PRODUCTBATCHDETAILS SET DefaultPrice =1 WHERE Priceid in (select priceid FROM #Price)  and PrdBatId IN (select Prdbatid FROM #PrdBatch)
		UPDATE PRODUCTBATCHDETAILS SET DefaultPrice =0 WHERE Priceid NOt in (select priceid FROM #Price) 
		and  PrdBatId IN (select Prdbatid FROM #PrdBatch)
	END  
 END  
 --Till Here  
 --Added By Sathishkumar Veeramani 2015/01/08  
 --Batch Cloning Details  
    DECLARE @BatchPriceId AS NUMERIC(18,0)  
    SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK)  
 SELECT DISTINCT CAST(DENSE_RANK() OVER (ORDER BY MAX(PrdBatId),MRP,ListPrice,SellingRate,ClaimRate) AS NUMERIC(18,0))+@BatchPriceId AS PriceId,  
 MAX(PrdBatId) AS PrdBatId,A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+CAST(SellingRate AS NVARCHAR(25))+'-'+  
 CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)) AS PriceCode,MRP,ListPrice,  
 SellingRate,ClaimRate,AddRate1 as LCTRAmount INTO #BatchCloningDetails FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)  
 INNER JOIN Product B (NOLOCK) ON A.PrdCCode = B.PrdCCode   
 INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId AND A.PrdBatCode = C.PrdBatCode WHERE DownloadFlag = 'D'  
 AND NOT EXISTS (SELECT DISTINCT PrdId,PrdBatId FROM #ExistinPriceCloning D WHERE C.PrdId = D.PrdId AND C.PrdBatId = D.PrdBatId)   
 GROUP BY A.PrdBatCode,MRP,ListPrice,SellingRate,ClaimRate,AddRate1  
 IF EXISTS (SELECT DISTINCT PrdBatId FROM #BatchCloningDetails)  
 BEGIN  
     UPDATE A SET DefaultPrice = 0 FROM ProductBatchDetails A WITH(NOLOCK)   
  INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId  
  --CRCRSTPAR0083
  INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,  
  Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)  
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,1,SlNo,Rate,1,1,1,1,GETDATE(),1,GETDATE(),0 FROM(  
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,1 AS SlNo,MRP AS Rate FROM #BatchCloningDetails UNION  
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,2 AS SlNo,ListPrice AS Rate FROM #BatchCloningDetails UNION  
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,3 AS SlNo,SellingRate AS Rate FROM #BatchCloningDetails UNION  
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,4 AS SlNo,ClaimRate AS Rate FROM #BatchCloningDetails UNION
  SELECT DISTINCT PriceId,PrdBatId,PriceCode,5 AS SlNo,LCTRAmount AS Rate FROM #BatchCloningDetails)Qry ORDER BY PrdBatId  
  
  SELECT @BatchPriceId = ISNULL(MAX(PriceId),0) FROM ProductBatchDetails (NOLOCK)  
  UPDATE Counters SET CurrValue = @BatchPriceId WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'  
        UPDATE A SET DefaultPriceId = B.PriceId FROM ProductBatch A WITH(NOLOCK)   
  INNER JOIN #BatchCloningDetails B ON A.PrdBatId = B.PrdBatId  
    END  
 --Till Here  
 IF EXISTS (SELECT * FROM @ExistingBatchDetails)  
 BEGIN  
  UPDATE A SET MnfDate=C.ManufacturingDate,ExpDate=ExpiryDate  
  FROM ProductBatch A (NOLOCK) INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatId=B.PrdBatId  
  INNER JOIN Cn2Cs_Prk_ProductBatch C (NOLOCK) ON A.PrdBatCode=C.PrdBatCode  AND B.PrdCCode=C.PrdCCode  
  WHERE C.DownLoadFlag='D'  
  UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y'   
  WHERE PrdCCode+'~'+PrdBatCode IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ExistingBatchDetails) AND DownLoadFlag='D'   
 END  
 DECLARE @Count1 NUMERIC(18,0)  
 DECLARE @Count2 NUMERIC(18,0)  
 SELECT @Count1=COUNT(*) FROM Cn2Cs_Prk_ProductBatch  
 SELECT @Count2=COUNT(*) FROM @ExistingBatchDetails  
 IF @Count1<>@Count2  
  BEGIN  
 --IF NOT EXISTS (SELECT * FROM @ExistingBatchDetails)  
 --BEGIN  
 ---New ProductBatch    
  INSERT INTO @ProductBatchWithCounter  
  SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatch' AND FldName='PrdBatId'),  
  B.PrdId,A.PrdCCode,A.PrdBatCode,ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK)   
  INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C (NOLOCK)   
  WHERE C.PrdBatCode=A.PrdBatCode AND B.PrdId=C.PrdId)AND   
  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'  
  ORDER BY ManufacturingDate ASC --Muthuvel  
  UPDATE @ProductBatchWithCounter SET TransNo=TransNo+Slno  
 --Existing ProductBatch   
   INSERT INTO @ProductBatchWithCounter  
   SELECT DISTINCT C.PrdBatId,B.PrdId,A.PrdCCode,A.PrdBatCode,  
   ManufacturingDate,ExpiryDate FROM Cn2Cs_Prk_ProductBatch A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdCCode=B.PrdCCode  
   INNER JOIN ProductBatch C ON B.PrdId = C.PrdId AND C.PrdBatCode = A.PrdBatCode WHERE   
   NOT EXISTS (SELECT PrdBatId FROM ProductBatchDetails D(NOLOCK) WHERE D.PrdBatId = C.PrdBatId AND D.PriceId = C.DefaultPriceId)   
   AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM PrdBatToAvoid) AND A.DownLoadFlag='D'  
   AND  A.PrdCCode+'~'+A.PrdBatCode NOT IN (SELECT PrdCCode+'~'+PrdBatCode FROM @ProductBatchWithCounter)  
  --Product Batch     
  INSERT INTO ProductBatch(PrdId,PrdBatId,PrdBatCode,CmpBatCode,MnfDate,ExpDate,Status,  
  TaxGroupId,BatchSeqId,DecPoints,DefaultPriceId,EnableCloning,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  SELECT DISTINCT A.PrdId,TransNo,PrdBatCode,PrdBatCode,MnfDate,ExpDate,1,B.TaxGroupId,@BatSeqId,  
  6,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchWithCounter A   
  INNER JOIN Product B ON A.PrdId=B.PrdId WHERE NOT EXISTS (SELECT PrdBatCode FROM ProductBatch C WHERE A.PrdId = C.PrdId   
  AND A.PrdBatCode = C.PrdBatCode)  
    --END   
  END  
 IF EXISTS (SELECT * FROM @ProductBatchWithCounter)   
 BEGIN  
  UPDATE Counters SET CurrValue = (SELECT MAX(PrdBatId) FROM ProductBatch) WHERE TabName = 'ProductBatch' AND FldName = 'prdbatid'  
  INSERT INTO @ProductBatchPriceWithCounter  
  SELECT DISTINCT (SELECT CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'),A.PrdId,A.TransNo,  
  A.PrdBatCode+'-'+CAST(MRP AS NVARCHAR(25))+'-'+CAST(ListPrice AS NVARCHAR(25))+'-'+  
  CAST(SellingRate AS NVARCHAR(25))+'-'+CAST(ClaimRate AS NVARCHAR(25))+'-'+CAST(AddRate1 AS NVARCHAR(25)),MRP,ListPrice,  
  SellingRate,ClaimRate,AddRate1 FROM @ProductBatchWithCounter A INNER JOIN Cn2Cs_Prk_ProductBatch B WITH (NOLOCK)  
  ON A.PrdCCode=B.PrdCCode AND A.PrdBatCode=B.PrdBatCode WHERE B.DownLoadFlag='D'  
  UPDATE @ProductBatchPriceWithCounter SET TransNo=TransNo+Slno  
  UPDATE A SET A.DefaultPrice=0 FROM ProductBatchDetails A WITH (NOLOCK),@ProductBatchPriceWithCounter B    
     WHERE A.PrdBatId = B.PrdBatId  
     END     
 IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
 BEGIN  
 --CRCRSTPAR0083
  INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,  
  DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter
 END  
 ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
 BEGIN  
  INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,  
  DefaultPrice,PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,1,MRP,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,2,ListPrice,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,3,SellingRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,4,ClaimRate,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
  UNION  
  SELECT DISTINCT TransNo,PrdBatId,PriceCode,@BatSeqId,5,AddRate1 AS LCTRAmount,1,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) FROM @ProductBatchPriceWithCounter  
 END   
 UPDATE A SET DefaultPriceId=C.TransNo FROM ProductBatch A INNER JOIN @ProductBatchPriceWithCounter C ON C.PrdBatId=A.PrdBatId AND A.PrdId=C.PrdId   
 IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter)   
 BEGIN  
  UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails)  WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'   
 END  
 --Batch Cloning Price Details  
 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeRateForOldBatch' AND ModuleName='Botree Product Batch Download' AND Status=1)  
 BEGIN  
  IF EXISTS(SELECT * FROM @ProductBatchPriceWithCounter A INNER JOIN @ExistingBatchDetails B ON A.PrdBatId=B.PrdBatId AND A.PrdId=B.PrdId  
  WHERE (B.OldLSP-A.ListPrice)<>0 AND Slno=2)  
  BEGIN  
   SELECT @ValDiffRefNo = dbo.Fn_GetPrimaryKeyString('ValueDifferenceClaim','ValDiffRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))  
   INSERT INTO ValueDifferenceClaim(ValDiffRefNo,Date,PrdId,PrdBatId,OldPriceId,NewPriceId,OldPrice,NewPrice,Qty,  
   ValueDiff,ClaimAmt,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
   SELECT @ValDiffRefNo,GETDATE(),A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice,  
   ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0),B.OldLsp-C.ListPrice,  
   ISNULL(SUM(A.PrdBatLcnSih+A.PrdBatLcnUih-A.PrdBatLcnRessih-A.PrdBatLcnResUih),0)*(B.OldLsp-C.ListPrice),  
   1,1,GETDATE(),1,GETDATE() FROM ProductBatchLocation A INNER JOIN @ExistingBatchDetails B ON A.PrdId=B.PrdId AND A.PrdBatID=B.PrdBatId   
   INNER JOIN @ProductBatchPriceWithCounter C ON A.PrdBatId=C.PrdBatId AND A.PrdId=C.PrdId  
   WHERE C.Slno=2 GROUP BY A.PrdId,A.PrdBatID,B.PriceId,C.TransNo,B.OldLsp,C.ListPrice  
   UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'ValueDifferenceClaim' AND FldName = 'ValDiffRefNo'  
  END  
 END  
 UPDATE ProductBatch SET ProductBatch.DefaultPriceId=PBD.PriceId,ProductBatch.BatchSeqId=PBD.BatchSeqId  
 FROM ProductBatchDetails PBD WITH (NOLOCK) WHERE ProductBatch.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1  
 UPDATE ProductBatch SET EnableCloning=1 WHERE PrdBatId IN  
 (  
  SELECT PrdBatId FROM ProductBatchDetails WITH (NOLOCK) GROUP BY PrdBatId  HAVING(COUNT(DISTINCT PriceId)>1)  
 )  
 SELECT PrdBatId INTO #ZeroBatches FROM ProductBatchDetails WITH (NOLOCK)  
 GROUP BY PrdBatId HAVING SUM(DefaultPrice)=0  
 SELECT B.PrdId,B.PrdBatId,MAX(PriceId) As PriceId INTO #ZeroMaxPrices  
 FROM ProductBatchDetails A INNER JOIN ProductBatch B ON A.PrdBatId=B.PrdBatId  
 INNER JOIN #ZeroBatches C ON A.PrdBatId=C.PrdBatId  
 WHERE A.DefaultPrice=0 AND NOT EXISTS  
 (SELECT DISTINCT PriceId FROM #BatchCloningDetails D WHERE A.PrdBatId = D.PrdBatId AND A.PriceId = D.PriceId)  
 AND NOT EXISTS (SELECT DISTINCT PriceId FROM #ExistinPriceCloning E WHERE A.PrdBatId = E.PrdBatId AND A.PriceId = E.PriceId)  
 GROUP BY B.PrdId,B.PrdBatId   
 UPDATE ProductBatch Set DefaultPriceId=B.PriceId FROM ProductBatch A,#ZeroMaxPrices B  
 WHERE A.PrdBatId=B.PrdbatId and A.PrdId=B.PrdId   
 UPDATE ProductBatchDetails Set DefaultPrice=1 FROM #ZeroMaxPrices A  
 WHERE ProductBatchDetails.PrdbatId=A.PrdBatId AND ProductBatchDetails.PriceId=A.PriceId  
 SET @Po_ErrNo=0  
 SELECT @OldPriceIdExt=ISNULL(MAX(PriceId),0) FROM ProductBatchDetails  
 IF @ExistPrdBatMaxId>0  
 BEGIN  
  SELECT @NewPrdBatMaxId=ISNULL(MAX(PrdBatId),0) FROM ProductBatch  
  IF @NewPrdBatMaxId>@ExistPrdBatMaxId  
  BEGIN  
      --Existing Contract Pricing Percentage Updated to New Batch Download  
      --Modified by Rajesh  
      --    SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate INTO #SpecialRateCreatedDate  
      --FROM SpecialRateAftDownload WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode  
   SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,MAX(CreatedDate) AS CreatedDate  INTO #SpecialRateCreatedDate1    
   FROM SpecialRateAftDownload_calc WITH(NOLOCK) GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode ORDER BY PrdCCode  
   SELECT DISTINCT A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.CreatedDate ,A.ApplyOn,A.TYPE INTO #SpecialRateCreatedDate  
   FROM SpecialRateAftDownload_calc A WITH(NOLOCK) INNER JOIN  #SpecialRateCreatedDate1 B (NOLOCK)   
   ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode  = B.RtrCtgValueCode AND A.RtrCode= B.RtrCode AND A.PrdCCode= B.PrdCCode  
   AND A.CreatedDate = B.CreatedDate AND A.ApplyOn is not null  
   --SELECT DISTINCT C.PrdId,E.PrdBatId,TransNo AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,  
   --D.PrdBatCode,DiscountPerc,(MRP-(MRP*(DiscountPerc/100))) AS SplRate INTO #SpecialRateDetails   
   --FROM SpecialRateAftDownload A WITH(NOLOCK)  
   --INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode   
   --AND A.RtrCode = B.RtrCode AND A.PrdCCode = B.PrdCCode AND A.CreatedDate = B.CreatedDate  
   --INNER JOIN Product C WITH(NOLOCK) ON A.PrdCCode = C.PrdCCode     
   --INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId  
   --INNER JOIN @ProductBatchPriceWithCounter E ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId  
   --ORDER BY A.PrdCCode  
     SELECT DISTINCT C.PrdId,E.PrdBatId,TransNo AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,    
     D.PrdBatCode,DiscountPerc,B.ApplyOn,B.Type,  
     (CASE B.ApplyOn WHEN 1 THEN   
     (CASE B.[Type] WHEN 1 THEN (MRP*100/(100+DiscountPerc)) WHEN 2 THEN MRP-(MRP*(DiscountPerc/100))  
     ELSE SellingRate-(SellingRate*(DiscountPerc/100))  END)    
     ELSE SellingRate-(SellingRate*(DiscountPerc/100)) END) AS SplRate  
     INTO #SpecialRateDetails     
     FROM SpecialRateAftDownload_calc A WITH(NOLOCK)    
     INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode     
     AND A.RtrCode = B.RtrCode AND A.PrdCCode = B.PrdCCode AND A.CreatedDate = B.CreatedDate    
     INNER JOIN Product C WITH(NOLOCK) ON A.PrdCCode = C.PrdCCode       
     INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId    
     INNER JOIN @ProductBatchPriceWithCounter E ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId    
     ORDER BY A.PrdCCode   
   --Till Here     
   SELECT DISTINCT MAX(E.ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,E.CtgValMainId   
   INTO #SpecialContractDetails FROM #SpecialRateDetails A WITH(NOLOCK)   
   INNER JOIN RetailerCategoryLevel B WITH(NOLOCK) ON A.RtrCtgCode = B.CtgLevelName   
   INNER JOIN RetailerCategory C WITH(NOLOCK) ON A.RtrCtgValueCode = C.CtgCode AND B.CtgLevelId = C.CtgLevelId  
   INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId   
   INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId AND A.PrdId = E.PrdId  AND CtgValMainId=0
   GROUP BY A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,CtgValMainId  
   ---Tax Calculation  
   DECLARE @PrdIdTax as BIGINT  
   DECLARE @PrdbatIdTax AS BIGINT  
   DECLARE Cur_Tax CURSOR  
   FOR   
   SELECT DISTINCT PrdId,PrdbatId FROM #SpecialContractDetails    
   OPEN Cur_Tax   
   FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax  
   WHILE @@FETCH_STATUS=0  
   BEGIN   
     EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax  
   FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax    
   END    
   CLOSE Cur_Tax  
   DEALLOCATE Cur_Tax   
   --Modified by Rajesh  
   SELECT DISTINCT A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,RtrCtgValueCode)+ @OldPriceIdExt AS NewPriceId,  
   --CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSelRate   
   CASE A.ApplyOn WHEN 1 THEN   
          (CASE [Type] WHEN 1 THEN (SplRate*100)/(100+TaxPercentage)  
           WHEN 2 THEN (SplRate*100)/(100+TaxPercentage) END)  
   ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSelRate  
   INTO #SplProductBatchDetails  
   FROM #SpecialContractDetails A WITH(NOLOCK) INNER JOIN ProductBatchTaxPercent B WITH(NOLOCK) ON A.PrdId = B.PrdId  
   AND A.PrdBatId = B.PrdBatId ORDER BY A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode  
   --Product Batch Details Value Added     
	INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,  
    Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)   
    SELECT DISTINCT NewPriceId,A.PrdBatId,PriceCode+'SplRate'+CONVERT(NVARCHAR(200),B.NewSelRate)+CONVERT(NVARCHAR(10),GETDATE(),121),  
    A.BatchSeqId,A.SLNo,(CASE SelRte WHEN 1 THEN B.NewSelRate ELSE PrdBatDetailValue END),0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,  
    CONVERT(NVARCHAR(10),GETDATE(),121),0  
    FROM ProductBatchDetails A WITH(NOLOCK)   
    INNER JOIN #SplProductBatchDetails B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
    INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId  
    INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo ORDER BY A.PrdBatId,NewPriceId   
    UPDATE Counters SET CurrValue =(SELECT MAX(PriceId) FROM ProductBatchDetails) WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'  
    --Contract Pricing Details Added  
    INSERT INTO ContractPricingDetails (ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,LastModDate,AuthId,  
    AuthDate,CtgValMainId,ClaimablePercOnMRP)              
    SELECT DISTINCT ContractId,A.PrdId,A.PrdBatId,B.NewPriceId,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),CtgValMainId,0  
    FROM #SpecialContractDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdID AND A.PrdBatId = B.PrdBatId AND A.RtrCtgValueCode=B.RtrCtgValueCode  
    WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE A.ContractId = C.ContractId   
    AND A.PrdId = C.PrdID AND A.PrdBatId = C.PrdBatId) ORDER BY ContractId,A.PrdId,A.PrdBatId,B.NewPriceId  
    --Special Rate Updated  
    INSERT INTO SpecialRateAftDownload (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,  
    ContractPriceIds,DiscountPerc,SplrateId)  
    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),  
    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0  
    FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
    and A.RtrCtgValueCode=B.RtrCtgValueCode  
    ORDER BY PrdCCode,PrdBatCode  
    --Added By Rajesh  
    INSERT INTO SpecialRateAftDownload_calc (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,  
    ContractPriceIds,DiscountPerc,SplrateId,ApplyOn,TYPE)  
    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,A.PrdCCode,A.PrdBatCode,A.SplRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),  
    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0,A.ApplyOn,A.TYPE  
    FROM #SpecialRateDetails A INNER JOIN #SplProductBatchDetails B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
    and A.RtrCtgValueCode=B.RtrCtgValueCode  
    ORDER BY PrdCCode,PrdBatCode  
    --Till Here  
  --SELECT * INTO #PrdBatch  FROM CONTRACTPRICINGDETAILS A WHERE NOT EXISTS (SELECT PRDID FROM ProductBatch B WHERE  A.PRDID = B.PRDID )  
   --TRUNCATE TABLE ProductBatchPriceWithCounter  
   --IF EXISTS (SELECT *FROM #PrdBatch)  
   --BEGIN 
     TRUNCATE TABLE ProductBatchPriceWithCounter
    INSERT INTO  ProductBatchPriceWithCounter  
    SELECT *  FROM @ProductBatchPriceWithCounter  
    EXEC Proc_InsertContractPricingForNewProduct  
   --END 
   --SELECT PrdId,PrdBatId,TransNo, FROM @ProductBatchPriceWithCounter INNER JOIN   
      --SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId INTO #ContractPrice FROM ProductBatch A (NOLOCK),@ProductBatchWithCounter B  
   --WHERE  A.PrdId = B.PrdId AND A.PrdBatId < @ExistPrdBatMaxId AND EXISTS  
   --(SELECT CPD.PrdBatId FROM ContractPricingDetails CPD (NOLOCK)  
   --INNER JOIN ProductBatch PB1 (NOLOCK) ON CPD.PrdId=PB1.PrdId AND CPD.PrdBatId=PB1.PrdBatId AND A.PrdBatId=CPD.PrdBatId  
   --AND CPD.PrdID IN (SELECT DISTINCT PrdId FROM @ProductBatchWithCounter))GROUP BY A.PrdId   
  -- INSERT INTO @ContractPrice (PrdId,PrdBatId)  
  -- SELECT A.PrdId,MAX(A.PrdBatId) AS PrdBatId FROM ProductBatch A (NOLOCK),  
  -- ContractPricingDetails B (NOLOCK),@ProductBatchWithCounter C  
  --          WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId AND A.PrdId = C.Prdid AND B.PrdId = C.Prdid   
  --          GROUP BY A.PrdId ORDER BY A.PrdId  
  -- IF EXISTS(SELECT * FROM @ContractPrice)  
  -- BEGIN  
  --  SELECT DISTINCT PrdbatId,PriceId,Max(PriceCode) as PriceCode INTO #ProductBatchDetails   
  --  FROM ProductBatchDetails  
  --  GROUP BY PrdbatId,PriceId  
  --  INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode)   
  --  SELECT Max(C.ContractId) as ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,  
  --  --CAST('' AS NVARCHAR(4000)) AS PriceCode  
  --  PriceCode  
  --  FROM  ContractPricingMaster D (NOLOCK)   
  --  INNER JOIN  ContractPricingDetails C (NOLOCK)   ON C.ContractId = D.ContractId  
  --  INNER JOIN  #ProductBatchDetails A (NOLOCK) ON A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId  
  --  INNER JOIN @ContractPrice E  ON E.PrdBatId = C.PrdBatId AND E.PrdId = C.PrdId   
  --  GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId ,PriceCode  
  --     --INSERT INTO @ContractBatchPrice (ContractId,CtgMainId,PrdId,PrdBatId,PriceId,PriceCode)  
  --     --SELECT DISTINCT MAX(D.ContractId) AS ContractId,D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId AS PriceId,  
  --     --CAST('' AS NVARCHAR(4000)) AS PriceCode FROM ProductBatchDetails A (NOLOCK),  
  --     --ContractPricingDetails C (NOLOCK),ContractPricingMaster D (NOLOCK),@ContractPrice E   
  --     --WHERE A.PrdBatId = C.PrdBatId AND A.PriceId = C.PriceId AND C.ContractId = D.ContractId AND E.PrdId = C.PrdId   
  --     --AND E.PrdBatId = C.PrdBatId GROUP BY D.CtgMainId,E.PrdId,E.PrdBatId,C.PriceId      
  --     --UPDATE A SET A.PriceCode = D.PriceCode FROM @ContractBatchPrice A,ContractPricingDetails B WITH(NOLOCK),  
  --     --ContractPricingMaster C WITH(NOLOCK),ProductBatchDetails D WITH(NOLOCK) WHERE A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
  --     --AND A.CtgMainId = C.CtgMainId AND D.PrdBatId = A.PrdBatId AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId   
  --     --UPDATE A SET A.PriceCode = D.PriceCode  
  --     --FROM @ContractBatchPrice A   
  --     --INNER JOIN ContractPricingDetails B WITH(NOLOCK) ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId   
  --     --INNER JOIN ContractPricingMaster C WITH(NOLOCK) ON   A.CtgMainId = C.CtgMainId  AND A.ContractId = C.ContractId AND B.ContractId = C.ContractId and A.ContractId=B.ContractId  
  --     --INNER JOIN #ProductBatchDetails D WITH(NOLOCK) ON D.PrdBatId = A.PrdBatId   
  --     --select 'Botree',* from @ProductBatchPriceWithCounter  
  --     --select 'Software',* from @ContractBatchPrice  
  --  SELECT DISTINCT SlNo INTO #BatchCreation FROM BatchCreation A (NOLOCK)  
  --  INNER JOIN (SELECT MAX(BatchseqId)  as BatchseqId FROM BatchCreationMaster (NOLOCK))X  
  --  ON A.BatchSeqId=X.BatchSeqId  
  --     INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PriceCode,NewBatchId,Slno,PrdBatDetailValue,NewPriceId)   
  --  SELECT DISTINCT A.PrdId,A.PrdBatId,A.PriceId,A.PriceCode,B.PrdBatId AS NewBatchId,PBD.Slno,PrdBatDetailValue,  
  --  DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,B.PrdBatId)+ @OldPriceId AS NewPriceId   
  --  FROM @ContractBatchPrice A INNER JOIN @ProductBatchPriceWithCounter B   
  --  ON A.PrdId = B.PrdId  
  --  INNER JOIN ProductBatchDetails PBD WITH(NOLOCK) ON PBD.PrdBatId=A.PrdBatId and PBD.PriceId=A.PriceId   
  --  INNER JOIN #BatchCreation C WITH(NOLOCK) ON C.SlNo=PBD.Slno  
  --  ORDER BY A.PrdId,A.PrdBatId,A.PriceId,B.PrdBatId  
  --  IF(SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=4  
  --  BEGIN  
  --   INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,  
  --      PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  --   SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,  
  --   1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)   
  --   FROM @ProductBatchDetails  
  --   UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1  
  --   UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2  
  --   UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4   
  --  END  
  --  ELSE IF (SELECT COUNT(*) FROM BatchCreation WHERE BatchSeqId=@BatSeqId)=5  
  --  BEGIN  
  --   INSERT INTO ProductBatchDetails(PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,  
  --   PriceStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
  --   SELECT DISTINCT NewPriceId,NewBatchId,PriceCode,@BatSeqId,SlNo,PrdBatDetailValue,0,1,  
  --   1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121)   
  --                  FROM @ProductBatchDetails  
  --                  UPDATE A SET A.PrdBatDetailValue = B.MRP FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 1  
  --   UPDATE A SET A.PrdBatDetailValue = B.ListPrice FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 2  
  --   UPDATE A SET A.PrdBatDetailValue = B.ClaimRate FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 4  
  --   UPDATE A SET A.PrdBatDetailValue = B.AddRate1 FROM ProductBatchDetails A,@ProductBatchPriceWithCounter B  
  --   WHERE A.PrdBatId = B.PrdBatId AND A.Slno = 5  
  --  END   
  --      IF EXISTS (SELECT * FROM @ProductBatchDetails)  
  --      BEGIN  
  --    INSERT INTO ContractPricingDetails(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,  
  --    Availability,LastModBy,LastModDate,AuthId,AuthDate,CtgValMainId)  
  --    SELECT DISTINCT ContractId,A.PrdId,NewBatchId,NewPriceId,Discount,FlatAmtDisc,  
  --    Availability,LastModBy,GETDATE(),AuthId,GETDATE(),CtgValMainId  
  --    FROM ContractPricingDetails A,@ProductBatchDetails B WHERE A.PrdId = B.PrdId   
  --    AND A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId  
  --   END   
      --UPDATE Counters SET CurrValue = (SELECT MAX(PriceId) FROM ProductBatchDetails)   
      --WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'       
  -- END  
  END  
 END  
 SELECT @NewPriceId=CurrValue FROM Counters (NOLOCK) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'     
 IF @NewPriceId>@OldPriceId  
 BEGIN  
  IF EXISTS(SELECT * FROM Configuration(NOLOCK) WHERE ModuleId='BotreeRateForOldBatch'  
  AND ModuleName='Botree Product Batch Download' AND Status=1)  
  BEGIN  
   EXEC Proc_DefaultPriceUpdation @ExistPrdBatMaxId,@OldPriceId,1  
  END  
 END  
 IF EXISTS(SELECT * FROM ProductBatchDetails WHERE PriceId>=@OldPriceId)  
 BEGIN  
  EXEC Proc_DefaultPriceHistory 0,0,@NewPriceId,2,1  
 END  
 ---MOORTHI  START  
 IF @ExistPrdBatMaxId>0  
 BEGIN    
  SET @BatchTransfer=0  
  SELECT @BatchTransfer=Status FROM Configuration WHERE ModuleId='BotreeAutoBatchTransfer'  
  IF @BatchTransfer=1  
  BEGIN  
   EXEC Proc_AutoBatchTransfer @ExistPrdBatMaxId,@Po_ErrNo = @Po_BatchTransfer OUTPUT  
   IF @Po_BatchTransfer=1  
   BEGIN  
    INSERT INTO Errorlog VALUES (1,'Cn2Cs_Prk_BLProductBatch','Product Batch-Auto Batch Transfer',  
    'Auto Batch Transfer is not done properly')              
    SET @Po_ErrNo=1      
   END  
  END  
 END   
 --END  
 UPDATE Cn2Cs_Prk_ProductBatch SET DownLoadFlag='Y'   
 WHERE PrdCCode+'~'+PrdBatCode IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode  
 FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)   
 RETURN    
END
GO
IF NOT EXISTS(SELECT * FROM ProductBatchDetails WHERE SLNO=5)
BEGIN
	INSERT INTO ProductBatchDetails 
	SELECT PriceId,PrdBatId,PriceCode,BatchSeqId,5 AS SlNo,0 AS PrdBatDetailValue,DefaultPrice,PriceStatus,Availability,LastModBy,
	LastModDate,AuthId,AuthDate,XMLUpload FROM ProductBatchDetails(NOLOCK) WHERE SLNo=3 
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Cn2Cs_Prk_LCTRUpdation]') AND type in (N'U'))
CREATE TABLE [Cn2Cs_Prk_LCTRUpdation](
	[DistCode] [nvarchar](50) NULL,
	[PrdCCode] [nvarchar](200) NULL,
	[PrdBatCode] [nvarchar](200) NULL,
	[LCTRAmount] [numeric](38, 6) NULL,
	[DownLoadFlag] [nvarchar](10) NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatLCTR' AND XTYPE = 'U')  
BEGIN  
	DROP TABLE PrdBatLCTR   
END
GO
CREATE TABLE PrdBatLCTR
(  
	PrdCCode NVARCHAR(200),  
	PrdBatCode NVARCHAR(200)  
)
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Download' AND module='LCTRUpdation'
INSERT INTO CustomUpDownload
SELECT MAX(SLNO)+1,1,'LCTRUpdation','LCTRUpdation','','','Cn2Cs_Prk_LCTRUpdation','Proc_Cn2Cs_LCTRUpdation','Transaction','Download',1 FROM CustomUpDownload
GO
DELETE FROM Tbl_DownloadIntegration WHERE ProcessName ='LCTRUpdation'
INSERT INTO Tbl_DownloadIntegration
SELECT MAX(SequenceNo) +1 ,'LCTRUpdation','Cn2Cs_Prk_LCTRUpdation','',0,500,GETDATE () FROM Tbl_DownloadIntegration
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[Proc_Cn2Cs_LCTRUpdation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [Proc_Cn2Cs_LCTRUpdation]
GO
/*
BEGIN TRAN
DELETE FROM  ERRORLOG
EXEC [Proc_Cn2Cs_LCTRUpdation] 0
select * from PRODUCTBATCHDETAILS(nolock) where slno=5
--SELECT * FROM Cn2Cs_Prk_LCTRUpdation WHERE LCTRAMOUNT IS NULL
select * from PrdBatLCTR
select * from ERRORLOG
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_Cn2Cs_LCTRUpdation]
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_LCTRUpdation
* PURPOSE		: To Validate LCTR Amount data update from Console
* CREATED		: Deepan
* CREATED DATE	: 10/12/2019
* MODIFIED
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON	  | USER STORY ID  |  CR/BZ |   REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  442		 10/12/2019	    Deepan		CRCRSTPAR0081	 CR		  LCTR Amount edition
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
 SET @Po_ErrNo =0  
 IF NOT EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK) WHERE DownLoadFlag='D') RETURN  
 IF EXISTS (SELECT * FROM SysObjects WHERE Name = 'PrdBatLCTR' AND XTYPE = 'U')  
 BEGIN  
  DROP TABLE PrdBatLCTR   
 END  
 CREATE TABLE PrdBatLCTR
 (  
  PrdCCode NVARCHAR(200),  
  PrdBatCode NVARCHAR(200)  
 )  
	 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
	 WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D')  
	 BEGIN  
		  INSERT INTO PrdBatLCTR(PrdCCode,PrdBatCode)  
		  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
		  WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK)) AND DownLoadFlag='D'  
		  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
		  SELECT DISTINCT 1,'LCTR Updation','PrdCCode','Product :'+PrdCCode+' not available'  
		  FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK) WHERE PrdCCode NOT IN (SELECT PrdCCode FROM Product WITH (NOLOCK))   
		  AND DownLoadFlag='D'  
	 END 
	 IF EXISTS(SELECT DISTINCT PrdCCode FROM Cn2Cs_Prk_ProductBatch WITH (NOLOCK)  
	 WHERE LEN(ISNULL(PrdBatCode,''))=0  AND DownLoadFlag='D')  
	 BEGIN  
		  INSERT INTO PrdBatLCTR(PrdCCode,PrdBatCode)  
		  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
		  WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  
		  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
		  SELECT DISTINCT 1,'LCTR Updation','PrdBatCode','Batch Code should not be empty for Product:'+PrdCCode  
		  FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
		  WHERE LEN(ISNULL(PrdBatCode,''))=0 AND DownLoadFlag='D'  
	 END 
	 
	 IF EXISTS(SELECT DISTINCT PrdBatCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
	 WHERE PrdBatCode NOT IN (SELECT PrdBatCode  FROM ProductBatch  WITH (NOLOCK)) AND DownLoadFlag='D')  
	 BEGIN  
		  INSERT INTO PrdBatLCTR(PrdCCode,PrdBatCode)  
		  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
		  WHERE PrdBatCode NOT IN (SELECT PrdBatCode FROM ProductBatch WITH (NOLOCK)) AND DownLoadFlag='D'  
		  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
		  SELECT DISTINCT 1,'LCTR Updation','PrdBatCode','ProductBatch :'+PrdBatCode+' not available'  
		  FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK) WHERE PrdBatCode NOT IN (SELECT PrdBatCode FROM ProductBatch WITH (NOLOCK))   
		  AND DownLoadFlag='D'  
	 END

	 IF EXISTS(SELECT DISTINCT LCTRAmount  FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
	 WHERE LCTRAmount  IS NULL AND DownLoadFlag='D')  
	 BEGIN  
		  INSERT INTO PrdBatLCTR(PrdCCode,PrdBatCode)  
		  SELECT DISTINCT PrdCCode,PrdBatCode FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK)  
		  WHERE  LCTRAmount  IS NULL AND DownLoadFlag='D'
		  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
		  SELECT DISTINCT 1,'LCTR Updation','LCTRAmount','LCTRAmount NULL'  
		  FROM Cn2Cs_Prk_LCTRUpdation WITH (NOLOCK) WHERE  LCTRAmount  IS NULL AND DownLoadFlag='D'
	 END
	 
	 CREATE TABLE #Cn2CS_Prk_LCTRUpdation
	 (
		[PrdCCode] [nvarchar](200) NULL,
		[PrdBatCode] [nvarchar](200) NULL,
		[LCTRAmount] [numeric](38, 6) NULL
	 )
	 
	 INSERT INTO #Cn2CS_Prk_LCTRUpdation([PrdCCode],[PrdBatCode],[LCTRAmount])
	 SELECT distinct [PrdCCode],[PrdBatCode],[LCTRAmount] FROM Cn2CS_Prk_LCTRUpdation A WHERE DOWNLOADFLAG ='D' 
	AND NOT EXISTS(SELECT * FROM PrdBatLCTR B where a.PrdCCode = b.PrdCCode and a.PrdBatCode = b.PrdBatCode )
	 
	 UPDATE ProductBatchDetails SET PrdBatDetailValue = C.LCTRAmount 
	 FROM ProductBatchDetails PBD INNER JOIN ProductBatch PB ON PBD.PrdBatId =PB.PrdBatId AND PBD.PriceId =PB.DefaultPriceId
	 INNER JOIN #Cn2CS_Prk_LCTRUpdation C ON PB.PrdBatCode =C.PrdBatCode 
	 INNER JOIN PRODUCT P ON C.PrdCCode =P.PrdCCode AND P.prdid=PB.prdid  WHERE PBD.SLNo =5
	 
	 UPDATE C SET DownloadFlag='Y' FROM  Cn2CS_Prk_LCTRUpdation C 
	INNER JOIN #Cn2CS_Prk_LCTRUpdation M ON M.PrdBatCode=C.PrdBatCode AND M.PrdCCode =C.PRDCCODE
	WHERE NOT EXISTS(SELECT * FROM PrdBatLCTR P  WHERE C.PrdBatCode=P.PrdBatCode AND C.PRDCCODE=P.PrdCCode) 
	
RETURN 
END
GO
UPDATE A SET CrystalView =0 FROM RptGridView A WHERE rptid = 183
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME = 'ParleOutputTaxPercentage_SR' AND type ='U')
BEGIN
CREATE TABLE ParleOutputTaxPercentage_SR (
	[TransId] [tinyint] NULL,
	[SalId] [numeric](36, 0) NULL,
	[PrdSlno] [int] NULL,
	[TaxPerc] [numeric](36, 4) NULL
)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_ChainWiseBillDetails' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_ChainWiseBillDetails 0,'2018-09-27'
select   * from Cs2Cn_Prk_ChainWiseBillDetails order by Billno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/***************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_ChainWiseBillDetails 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
--------------------------------------------------------------------------------------------------
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 27-03-2018   S.MOhana     CR			CCRSTPAR0188		Included reports changes in upload
 27-09-2018   Amuthakumar  CR           CRCRSTPAR0031       Enable Configuration with Tax in Reports	
 13-12-2019	 MOHANA S	   SR			CRCRSTPAR0079	  INCLUDED GT CATEGORY														
***************************************************************************************************/
SET NOCOUNT ON
BEGIN
	--- Added by Amuthakumar on 27/09/2018 CRCRSTPAR0031
	IF EXISTS(SELECT 'X' FROM MANUALCONFIGURATION (NOLOCK)	WHERE  ModuleId='Report_withTax' AND ModuleName='Report with Tax' AND Status=1 and SeqNo=1)
	BEGIN
		EXEC Proc_Cs2Cn_ChainWiseBillDetails_withTax @Po_ErrNo,@ServerDate
		RETURN
	END
	-- Till Here CRCRSTPAR0031
	
	SET @Po_ErrNo=0
	
	CREATE TABLE #ChainSalesDetails
	(
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL
	)
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_ChainWiseBillDetails WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
			
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	--and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	
	--To Filter Retailers
	INSERT INTO #ChainSalesDetails
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND S.DlvSts > 3  
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid
	UNION ALL
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE  EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	 AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid
	
	UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	
	UPDATE R SET R.ChainLandRate = S.SplSelRate-R.SchemeDiscount
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId
	
	UPDATE A SET A.ChainLandRate = (B.PrdbatDetailValue-A.SchemeDiscount) FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID WHERE A.ChainLandRate=0  
	
	--SELECT S.SalId,S.SalInvNo BillNo,S.SalInvDate BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	--PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,PriceId,ChainLandRate,
	--CAST(0 AS NUMERIC(18,6)) Amount
	--INTO #Chain
	--FROM #ChainSalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	
	 
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,2)) Amount
	INTO #Chain
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--select BillNo,PrdId,QtyInPkt,ROUND(ChainLandRate,2,1),ROUND(Amount,2,1)  from #Chain order by  billno,prdid 
	
	INSERT INTO Cs2Cn_Prk_ChainWiseBillDetails (DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,PktMRP,QtyInPkt,
	ChainLandRate,Amount,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP,sum(QtyInPkt),sum(ROUND(ChainLandRate,2,1)),sum(ROUND(Amount,2,1)),
	'N' UploadFlag,NULL,@ServerDate
	FROM #Chain (NOLOCK) 
	GROUP BY  BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP
	
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--SalesInvoice S (NOLOCK) WHERE U.TransType = 1 AND U.TransId = S.SalId
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--ReturnHeader S (NOLOCK) WHERE U.TransType = 2 AND U.TransId = S.ReturnID
	
	RETURN			
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptBillWisePrdWiseOutPut' AND TYPE ='P')
DROP PROCEDURE Proc_RptBillWisePrdWiseOutPut
GO
-- EXEC [Proc_RptBillWisePrdWiseOutPut] 183,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptBillWisePrdWiseOutPut
	(
		@Pi_RptId  INT,
		@Pi_UsrId  INT,
		@Pi_SnapId  INT,
		@Pi_DbName  nvarchar(50),
		@Pi_SnapRequired INT,
		@Pi_GetFromSnap  INT,
		@Pi_CurrencyId  INT
	)
	AS
/************************************************************
* PROCEDURE : [Proc_RptBillWisePrdWiseOutPut]
* PURPOSE : To get the Product details
* CREATED BY : Murugan.R
* CREATED DATE : 30/09/2009
* NOTE  :
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*************************************************  
* [DATE]		[DEVELOPER]        [USER_STORY_ID]   [CR/BUG]       [DESCRIPTION]  
* 09-08-2018	Lakshman M         ILCRSTPAR1674       BZ          Excel reprot header tax perc & tax amount column hide tax amount validation added in report. 
* 13-12-2019	 MOHANA S		   CRCRSTPAR0079	   BZ		   UAT Reported Issue
*************************************************************/
BEGIN
	SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  NVARCHAR(50)
	DECLARE @TblName  AS NVARCHAR(500)
	DECLARE @TblStruct  AS NVARCHAR(4000)
	DECLARE @TblFields  AS NVARCHAR(4000)
	DECLARE @sSql  AS  NVARCHAR(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS NVARCHAR(50)
	DECLARE @FromDate AS DATETIME
	DECLARE @ToDate   AS DATETIME
	DECLARE @CmpId   AS INT
	DECLARE @LcnId   AS INT
	DECLARE @SMId   AS INT
	DECLARE @RMId   AS INT
	DECLARE @RtrId   AS INT
	DECLARE @PrdCatId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @PrdId  AS INT
	DECLARE @SalId   AS BIGINT
	DECLARE @CancelValue AS INT
	DECLARE @BillStatus AS INT
	DECLARE @TaxBreakup AS INT	
	DECLARE @DiscBreakup AS INT
	DECLARE @QtyBreakup AS INT	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	SET @PrdBatId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	SET @TaxBreakup = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,241,@Pi_UsrId))
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @PrdCatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	CREATE TABLE #RptWithOutTaxBreakup
		(
			SalInvDate datetime,
			SalinvNo Varchar(50),
			RouteName Varchar(75),		
			RtrCode Varchar(50),
			RtrName VarChar(200),			
			Prdccode Varchar(50),
			PrdName Varchar(200),
			PrdBatCode Varchar(75),
			Rate Numeric(36,4),
			SalesQty Int,
			FreeQty Int,
			TotQty Int,
			GrossAmt Numeric(36,4),
			SchemeAmt Numeric(36,4),
			SplDiscount Numeric(36,4),
			CashDiscount Numeric(36,4),
			TotalDiscount Numeric(36,4),
			TaxPerc NVARCHAR(200),		
			TaxAmount Numeric(36,4),				
			TotalTax Numeric(36,4),
			NetAmount Numeric(36,4),		
			DiscBreakup Int,
			QtyBreakup  Int,
			TaxBreakup Int
			
		)
		IF @TaxBreakup=2
		BEGIN
			SET @TblName = 'RptBillWisePrdWiseTaxBreakup'
			SET @TblStruct = 'SalInvDate datetime,
			SalinvNo Varchar(50),	
			RouteName Varchar(75),	
			RtrCode Varchar(50),
			RtrName VarChar(200),			
			Prdccode Varchar(50),
			PrdName Varchar(200),
			PrdBatCode Varchar(75),
			Rate Numeric(36,4),
			SalesQty Int,
			FreeQty Int,
			TotQty Int,
			GrossAmt Numeric(36,4),
			SchemeAmt Numeric(36,4),
			SplDiscount Numeric(36,4),
			CashDiscount Numeric(36,4),
			TotalDiscount Numeric(36,4),
			TotalTax Numeric(36,4),
			NetAmount Numeric(36,4),		
			DiscBreakup Int,
			QtyBreakup  Int,
			TaxBreakup Int'
			SET @TblFields = 'SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
			 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
			 SplDiscount,CashDiscount,TotalDiscount,TotalTax,NetAmount,DiscBreakup,QtyBreakup,TaxBreakup'
		END
		IF @Pi_GetFromSnap = 1
		BEGIN
			Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
			SET @DBNAME = @DBNAME
		END
		ELSE
		BEGIN
			Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
			SET @DBNAME = @PI_DBNAME + @DBNAME
		END
		
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
		EXEC Proc_RptBillWisePrdWise @Pi_RptId,@Pi_UsrId
		--SET @TaxBreakup=2	
		SELECT DISTINCT @DiscBreakup=DiscBreakup FROM RptBillWisePrdWise WHERE UsrId=@Pi_UsrId
		SELECT DISTINCT @QtyBreakup=QtyBreakup FROM RptBillWisePrdWise WHERE UsrId=@Pi_UsrId
		INSERT INTO #RptWithOutTaxBreakup (SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
				 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
				 SplDiscount,CashDiscount,TotalDiscount,TaxPerc,TaxAmount,TotalTax,NetAmount,DiscBreakup,QtyBreakup,TaxBreakup)
			SELECT DISTINCT SalInvDate,SalinvNo,RmName,RtrCode,RtrName,Prdccode,
				PrdName,PrdBatCode, dbo.Fn_ConvertCurrency(Rate,@Pi_CurrencyId),SalesQty,FreeQty,TotQty,
				dbo.Fn_ConvertCurrency(GrossAmt,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(SchemeAmt,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(SplDiscount,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CashDiscount,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(TotalDiscount,@Pi_CurrencyId),
				TaxPerc,
				dbo.Fn_ConvertCurrency(TaxAmount,@Pi_CurrencyId),			
				dbo.Fn_ConvertCurrency(TotalTax,@Pi_CurrencyId),
				dbo.Fn_ConvertCurrency(NetAmount,@Pi_CurrencyId),DiscBreakup,QtyBreakup,TaxBreakup
		FROM RptBillWisePrdWise
		WHERE  UsrId=@Pi_UsrId
		AND  (CmpId = (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END) OR
		CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		AND
		(LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR
		LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
		AND
		(PrdId = (CASE @PrdCatId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
		AND
		(PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR
		PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
		AND
		(PrdBatId = (CASE @PrdBatId WHEN 0 THEN PrdBatId Else 0 END) OR
		PrdBatId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId)))
		IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			SET @SSQL = 'INSERT INTO #RptWithOutTaxBreakup ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+ ' WHERE UsrId=' + CAST(@Pi_UsrId AS nVarchar(10)) + ''
			+ 'AND  (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '
			+ 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '
			+ 'AND (LcnId = (CASE ' + CAST(@LcnId AS nVarchar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR '
			+ 'LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +
			+ 'AND (PrdId = (CASE ' + CAST(@PrdCatId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR '
			+ 'PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (PrdId = (CASE ' + CAST(@PrdId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR '
			+ 'PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',5,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			+ 'AND (PrdBatId = (CASE ' + CAST(@PrdBatId AS nVarchar(10)) + ' WHEN 0 THEN PrdBatId Else 0 END) OR '
			+ 'PrdBatId in (SELECT iCountid from Fn_ReturnRptFilters(' +
			+ CAST(@Pi_RptId AS nVarchar(10)) + ',7,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
				'(SnapId,UserId,RptId,' + @TblFields + ')' +
				' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptWithOutTaxBreakup'
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptWithOutTaxBreakup ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	IF @TaxBreakup=1
	BEGIN	
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptWithOutTaxBreakup
	END
	IF @TaxBreakup=2
	BEGIN	
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptWithOutTaxBreakup 	
	END
	DELETE FROM RptWithOutTaxBreakup_Excel
	DELETE FROM RptColValues WHERE RptId=@Pi_RptId AND Usrid=@Pi_UsrId	
		
	IF EXISTS (SELECT *	FROM RptDataCount WHERE RptId=183 and RecCount>0)
	BEGIN
	--Excel Report
		DELETE FROM RptExcelHeaders Where RptId=@Pi_RptId
		INSERT INTO RptExcelHeaders (RptId,SlNo,FieldName,DisplayName,DisplayFlag,LngId)	
		SELECT @Pi_RptId,ColId ,Name,Name,1,1 FROM SYSCOLUMNS S WHERE Id In (Select Id From SysObjects where Xtype='U' and Name='RptWithOutTaxBreakup_Excel')	
		IF (@DiscBreakup=2 AND @QtyBreakup=2)
		BEGIN	
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(9,10,13,14,15)	and RptId=@Pi_RptId			
		END	
		IF (@DiscBreakup=1  AND @QtyBreakup=2)
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(9,10) and RptId=@Pi_RptId				
		END	
		IF (@DiscBreakup=2  AND @QtyBreakup=1)
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno  In(13,14,15) and RptId=@Pi_RptId
		END
		IF @TaxBreakup = 1
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(18,19) and RptId=@Pi_RptId ------------ Added By Lakshman M Dated On 09/08/2018 PMS ID:ILCRSTPAR1674 Excel header hide the columns in report
		END	
		IF @TaxBreakup = 2
		BEGIN		
			UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE Slno IN(18,19) and RptId=@Pi_RptId				
		END
		
		INSERT INTO RptWithOutTaxBreakup_Excel([Bill Date],[Bill No],[Route Name],[Retailer Code],[Retailer Name],[Product Code],[Product Name],
					[Batch Code],[Selling Rate],[Sales Qty],[Offer Qty],[Total Qty],[Gross Amt],[Scheme Amt],[SplDiscount],
					[Cash Discount],[Total Discount],TaxPerc,TaxAmount,[Total Tax Amount],[NetAmount ])
		SELECT SalInvDate,SalinvNo,RouteName,RtrCode,RtrName,Prdccode,
			 PrdName,PrdBatCode,Rate,SalesQty,FreeQty,TotQty,GrossAmt,SchemeAmt,
			 SplDiscount,CashDiscount,TotalDiscount,TaxPerc,TaxAmount,TotalTax,NetAmount from #RptWithOutTaxBreakup
		
		SELECT * FROM RptWithOutTaxBreakup_Excel
	--End
		--Grid Report
		
		DELETE FROM SpreadDisplayColumns WHERE MasterId=@Pi_RptId
		INSERT INTO SpreadDisplayColumns
		select @Pi_RptId,
		(select count(*) from RptExcelHeaders where slno <= t.slno and DisplayFlag=1 and RptId=@Pi_RptId),
		FieldName,1,1,1,GetDate(),1,Getdate() from RptExcelHeaders t where RptId=@Pi_RptId and DisplayFlag=1
		order by slno
		
		DECLARE @ColName as Varchar(4000)
		DECLARE @ColName1 as Varchar(4000)
		DECLARE @Gsql as Varchar(8000)
		DECLARE @Colcnt as INT
		SET @ColName=''
		SET @ColName1=''
 
		SELECT @ColName=@ColName+'['+ColumnName +'],'  FROM SpreadDisplayColumns WHERe MasterId=@Pi_RptId
		SELECT @Colcnt=Count(*) FROM SpreadDisplayColumns S WHERE MasterId=@Pi_RptId
		SET @ColName=SUBSTRING(@ColName,1,Len(@ColName)-1)
		SELECT @ColName1=@ColName1+'['+Name +'],' FROM SYSCOLUMNS S WHERE Id In (Select Id From SysObjects where Xtype='U' and Name='RptColvalues') 
		and ColId<=@Colcnt ORDER BY S.CoLid

		SET @ColName1=SUBSTRING(@ColName1,1,Len(@ColName1)-1)
 
		SET @Gsql= 'INSERT INTO RptColvalues ( '+@ColName1+',Rptid,Usrid)
		SELECT '+@ColName+ ','+
		CAST(@Pi_RptId AS nVarchar(10))+','+ CAST(@Pi_UsrId AS nVarchar(10)) +'FROM RptWithOutTaxBreakup_Excel Order By [Bill Date],[Bill No]'
		EXEC (@Gsql)
	--END Grid Report
	END
	RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptStoreSchemeDetailsSlab' AND TYPE ='P')
DROP PROCEDURE Proc_RptStoreSchemeDetailsSlab
GO
/*
SELECT  * FROM RPTStoreSchemeDetails where schid=2219 ORDER By SchId,ReferNo
EXEC Proc_RptStoreSchemeDetailsSlab 246,1
*/
CREATE PROCEDURE Proc_RptStoreSchemeDetailsSlab
(	
	@Pi_RptId		INT,
	@Pi_UsrId		INT
)
AS
/*****************************************************************************
* PROCEDURE: Proc_RptStoreSchemeDetailsSlab
* PURPOSE: General Procedure To Get the Scheme Details into Scheme Temp Table
* NOTES:
* CREATED: MarySubashini	07-12-2017 for ICRSTPAR6933
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------
13-12-2019	 MOHANA S		   SR	   CRCRSTPAR0079		OPTIMIZATION DONE
********************************************************************************/
SET NOCOUNT ON
BEGIN
	--Filter Variable
	DECLARE @FromDate	AS 	DateTime
	DECLARE @ToDate		AS	DateTime
	DECLARE @fSchId		AS	Int
	DECLARE @fSMId		AS	Int
	DECLARE @fRMId		AS	Int
	DECLARE @CtgLevelId AS    INT
	DECLARE @CtgMainId  AS    INT
	DECLARE @RtrClassId AS    INT
	DECLARE @fRtrId		AS	Int
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @CtgLevelId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @CtgMainId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @RtrClassId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	--Till Here

	SELECT Prdbatid INTO #BATCH  FROM (
	SELECT FreePrdbatid as Prdbatid  FROM SalesInvoiceSchemeDtFreePrd A(NOLOCK) INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
	AND SALINVDATE BETWEEN @FromDate AND @TODATE AND DLVSTS >3
	UNION 
	SELECT FreePrdbatid FROM ReturnSchemeFreePrdDt A (NOLOCK)INNER JOIN RETURNHEADER B ON A.RETURNID = B.RETURNID 
	AND RETURNDATE BETWEEN @FromDate AND @TODATE AND STATUS = 0
	)A

	SELECT B.* INTO #ProductBatchDetails FROM #BATCH A INNER JOIN ProductBatchDetails B(NOLOCK) ON A.Prdbatid = B.PRDBATID AND DEFAULTPRICE=1 AND SLNO = 4

	DELETE FROM RPTStoreSchemeDetails WHERE UserId = @Pi_UsrId
	--Values For Scheme Amount From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,ISNULL(SUM(B.FlatAmount),0) As FlatAmount,
		ISNULL(SUM(B.DisCountPerAmount),0) as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK)INNER JOIN SalesInvoiceSchemeLineWise B (NOLOCK) ON A.SalId = B.SalId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK) ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK)ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)ON RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)ON RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		B.PrdId,B.PrdBatId,Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,
		I.PrdName,J.PrdBatCode,SalInvDate
	
	--->Added By Nanda on 06/04/2010-For QPS Scheem Amount-Credit Conversion
	--Values For Scheme Amount From SalesInvoice-QPS Convesrion-Qty Based
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId AS SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,ISNULL(SUM(B.CrNoteAmount),0) As FlatAmount,
		0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		'' AS PrdName,'' AS PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceQPSSchemeAdj B (NOLOCK)  ON A.SalId = B.SalId AND B.Mode=1
		INNER JOIN SchemeMaster C (NOLOCK)  ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)  ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId 
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,SalInvDate
	--Values For Scheme Amount From SalesInvoice-QPS Convesrion-Date Based
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId AS SlabId,'' AS SalInvNo,0 AS SMId,0 AS RMId,0 AS DlvRMId,0 AS CtgLevelId,0 AS CtgMainId,0 AS RtrValueClassId,
		0 AS RtrId,4,0 AS VehicleId,0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,ISNULL(SUM(B.CrNoteAmount),0) As FlatAmount,
		0 as DiscountPer,0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,'' AS SMName,'' AS RMName,'' AS DlvRMName,'' AS CtgLevelName,'' AS CtgName,'' AS ValueClassName,'' AS RtrName,'' AS VehicleRegNo,
		'' AS DlvBoyName,'' AS PrdName,'' AS PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,B.LastModDate
	FROM SalesInvoiceQPSSchemeAdj B  (NOLOCK) 
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId AND B.Mode=2
	WHERE B.LastModDate Between @FromDate AND @ToDate 
	GROUP BY B.SchId,B.SlabId,Budget,B.LastModDate
	--->Till Here
	--Values For Points From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		Points AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK)  INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK)  ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK)ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN SalesInvoiceSchemeDtPoints L (NOLOCK)ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND B.SlabId = L.SlabId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--Values For Free Product From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT DISTINCT L.SchId,L.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,L.FreePrdId AS PrdId,L.FreePrdBatId AS PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,L.FreePrdId As FreePrdId,L.FreePrdBatId AS FreePrdBatId,L.FreeQty as FreeQty,
		(L.FreeQty * O.PrdBatDetailValue) as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(L.SchId,L.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,'' AS PrdBatCode,M.PrdName as FreePrdName,N.PrdBatCode as FreeBatchName,
		'-' as GiftPrdName,'' as GiftBatchName,1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK) ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L (NOLOCK) ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND L.SlabId= B.SlabId INNER JOIN Product M (NOLOCK) ON L.FreePrdId = M.PrdId
		INNER JOIN ProductBatch N (NOLOCK) ON L.FreePrdBatId = N.PrdBatId
		INNER JOIN #ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.FreePriceId
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo
	AND P.ClmRte = 1
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC(NOLOCK) on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--Values For Gift Product From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,
		L.GiftPrdId as GiftPrdId,L.GiftPrdBatId As GiftPrdBatId,L.GiftQty as GiftQty,
		(L.GiftQty * O.PrdBatDetailValue) as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),
		1 as Selected,@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,
		ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,
		M.PrdName as GiftPrdName,N.PrdBatCode as GiftBatchName,1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK) ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L (NOLOCK)ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND L.SlabId= B.SlabId INNER JOIN Product M (NOLOCK)ON L.GiftPrdId = M.PrdId
		INNER JOIN ProductBatch N (NOLOCK) ON L.GiftPrdBatId = N.PrdBatId
		INNER JOIN #ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.GiftPriceId
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo
	AND P.ClmRte = 1
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--rathi
	--Values For Scheme Amount From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,0 as DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,0 AS VehicleId,
		0 AS DlvBoyId,B.PrdId,B.PrdBatId,-1 * ISNULL(SUM(B.ReturnFlatAmount),0) As FlatAmount,
		-1 * ISNULL(SUM(B.ReturnDiscountPerAmount),0) as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,'' AS VehicleRegNo,'' AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		2 as LineType,ReturnDate
	FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnSchemeLineDt B (NOLOCK) ON A.ReturnId = B.ReturnId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId  INNER JOIN Product I (NOLOCK)ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Status =0
	GROUP BY B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,
		B.PrdId,B.PrdBatId,Budget,K.SMName,D.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,I.PrdName,J.PrdBatCode,ReturnDate
	--Values For Points From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,0 as DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,0 AS VehicleId,
		0 AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		-1 * ISNULL(SUM(ReturnPoints),0) AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,'' AS VehicleRegNo,''AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		2 as LineType,ReturnDate
	FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnProduct A1 (NOLOCK) ON A.ReturnId = A1.ReturnId
		INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK)ON A1.SalId IN (0,B.SalId) AND A1.PrdId = B.PrdId
		AND A1.PrdBatId = B.PrdBatId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 (NOLOCK) WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId INNER JOIN Product I (NOLOCK)ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN ReturnSchemePointsDt L ON A.ReturnId = L.ReturnId AND C.SchId = L.SchId
		AND B.SlabId = L.SlabId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Status =0
	GROUP BY B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,B.PrdId,B.PrdBatId,
		Budget,K.SMName,D.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,I.PrdName,J.PrdBatCode,ReturnDate
	--Values For Free Product From Return
		
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,0 AS DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,0 AS VehicleId,
		0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,0 AS FlatAmount,0 AS DiscountPer,
		0 AS Points,RSF.FreePrdId,RSF.FreePrdBatId,(-1 * ISNULL(SUM(RSF.ReturnFreeQty),0)) AS FreeQty,
		(-1 * (ISNULL(SUM(RSF.ReturnFreeQty),0) * PBD.PrdBatDetailValue)) AS FreeValue,0 AS GiftPrdId,0 AS GiftPrdBatId,
		0 AS GiftQty,0 AS GiftValue,SM.Budget AS SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(RSF.SchId,RSF.SlabId),1 AS Selected,
		@Pi_UsrId,S.SMName,RM.RMName,'' AS DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,'' AS VehicleRegNo,
		'' AS DlvBoyName,P.PrdName,PB.PrdBatCode,P.PrdName AS FreePrdName,PB.PrdBatCode AS FreeBatchName,
		'-' AS GiftPrdName,'' AS GiftBatchName,2 AS LineType,ReturnDate
	FROM ReturnHeader RH (NOLOCK) 
		INNER JOIN ReturnSchemeFreePrdDt RSF (NOLOCK) ON  RH.ReturnId = RSF.ReturnId 
		INNER JOIN SchemeMaster SM (NOLOCK) ON  SM.SchId = RSF.SchId 
		INNER JOIN SalesMan S ON  S.SMId = RH.SMId
		INNER JOIN RouteMaster RM ON  RM.RMId = RH.RMId
		INNER JOIN Retailer R (NOLOCK)ON  R.RtrId = RH.RtrId 
		INNER JOIN RetailerValueClassMap RVCM(NOLOCK) ON  RVCM.RtrId=R.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)ON  RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON  RCL.CtgLevelId=RC.CtgLevelId 
		INNER JOIN Product P (NOLOCK)ON RSF.FreePrdId = P.PrdId
		INNER JOIN ProductBatch PB (NOLOCK) ON RSF.FreePrdBatId = PB.PrdBatId AND SM.CmpId=RCL.CmpId
		INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.FreePriceId
		INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(RH.SMId = (CASE @fSMId WHEN 0 THEN RH.SMId Else 0 END) OR
		RH.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(RH.RMId = (CASE @fRMId WHEN 0 THEN RH.RMId Else 0 END) OR
		RH.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(RH.RtrID = (CASE @fRtrId WHEN 0 THEN RH.RtrID Else 0 END) OR
		RH.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(SM.SchId = (CASE @fSchId WHEN 0 THEN SM.SchId Else 0 END) OR
		SM.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		RH.Status =0
	GROUP BY RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,
		RSF.FreePrdId,RSF.FreePrdBatId,PBD.PrdBatDetailValue,SM.Budget,S.SMName,RM.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		P.PrdName,PB.PrdBatCode,P.PrdName,PB.PrdBatCode,ReturnDate
	--Values For Gift Product From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,0 AS DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,0 AS VehicleId,
		0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,0 AS FlatAmount,0 AS DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,
		RSF.GiftPrdId,RSF.GiftPrdBatId,(-1 * ISNULL(SUM(RSF.ReturnGiftQty),0)) as GiftQty,
		(-1 * ISNULL(SUM(RSF.ReturnGiftQty),0) * PBD.PrdBatDetailValue) as GiftValue,SM.Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(RSF.SchId,RSF.SlabId),
		1 as Selected,@Pi_UsrId,S.SMName,RM.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		'' AS VehicleRegNo,'' AS DlvBoyName,
		P.PrdName,PB.PrdBatCode,'-' AS FreePrdName,'' AS FreeBatchName,
		P.PrdName AS GiftPrdName,PB.PrdBatCode AS GiftBatchName,2 AS LineType,ReturnDate
	FROM ReturnHeader RH (NOLOCK) 
		INNER JOIN ReturnSchemeFreePrdDt RSF (NOLOCK)ON  RH.ReturnId = RSF.ReturnId 
		INNER JOIN SchemeMaster SM (NOLOCK)ON  SM.SchId = RSF.SchId 
		INNER JOIN SalesMan S (NOLOCK)ON  S.SMId = RH.SMId
		INNER JOIN RouteMaster RM ON  RM.RMId = RH.RMId
		INNER JOIN Retailer R (NOLOCK) ON  R.RtrId = RH.RtrId 
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)ON  RVCM.RtrId=R.RtrId
		INNER JOIN RetailerValueClass RVC(NOLOCK) ON  RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON  RCL.CtgLevelId=RC.CtgLevelId 
		INNER JOIN Product P (NOLOCK)ON RSF.GiftPrdId = P.PrdId
		INNER JOIN ProductBatch PB (NOLOCK) ON RSF.GiftPrdBatId = PB.PrdBatId AND SM.CmpId=RCL.CmpId
		INNER JOIN #ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.GiftPriceId
		INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(RH.SMId = (CASE @fSMId WHEN 0 THEN RH.SMId Else 0 END) OR
		RH.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(RH.RMId = (CASE @fRMId WHEN 0 THEN RH.RMId Else 0 END) OR
		RH.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(RH.RtrID = (CASE @fRtrId WHEN 0 THEN RH.RtrID Else 0 END) OR
		RH.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(SM.SchId = (CASE @fSchId WHEN 0 THEN SM.SchId Else 0 END) OR
		SM.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		RH.Status =0
	GROUP BY RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,
		RSF.GiftPrdId,RSF.GiftPrdBatId,PBD.PrdBatDetailValue,SM.Budget,S.SMName,RM.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		P.PrdName,PB.PrdBatCode,P.PrdName,PB.PrdBatCode,ReturnDate
	--Values For UnSelected Scheme From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,0 as PrdId,0 as PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),2 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		'' As PrdName,'' as PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		3 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceUnSelectedScheme B(NOLOCK)  ON A.SalId = B.SalId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K (NOLOCK)ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E (NOLOCK)ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,SalInvDate
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ReturnBudgetUtilizedSlab' AND TYPE ='FN')
DROP FUNCTION Fn_ReturnBudgetUtilizedSlab
GO
--SELECT dbo.Fn_ReturnBudgetUtilizedSlab(1,1) AS Amt
CREATE FUNCTION Fn_ReturnBudgetUtilizedSlab
(
	@Pi_SchId INT,
	@Pi_SlabId INT
)
RETURNS NUMERIC(38,6)
AS
/**********************************************************************************
* FUNCTION: Fn_ReturnBudgetUtilizedSlab
* PURPOSE: Returns the Budget Utilized for the Selected Scheme based on the slab
* NOTES:
* CREATED: MarySubashini	07-12-2017 for ICRSTPAR6933
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
-----------------------------------------------------------------------------------
13-12-2019	 MOHANA S		   SR	   CRCRSTPAR0079		OPTIMIZATION DONE
***********************************************************************************/
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	SET @Points=0
	SET @RetPoints=0
	DECLARE @ProductBatchDetails TABLE 
	(
	  PrdId NUMERIC(18,0),
	  PrdBatId NUMERIC(18,0),
	  PriceId NUMERIC(18,0),
	  PrdBatDetailValue NUMERIC(18,6)
	)	

	DECLARE @BATCH TABLE
	(
	 PrdBatId NUMERIC(18,0)
	)

	INSERT INTO @BATCH 
	SELECT Prdbatid FROM (
	SELECT FreePrdbatid as Prdbatid  FROM SalesInvoiceSchemeDtFreePrd A(NOLOCK)  WHERE SCHID = @Pi_SchId AND SlabId = @Pi_SlabId 
	UNION 
	SELECT FreePrdbatid FROM ReturnSchemeFreePrdDt A (NOLOCK)  WHERE SCHID = @Pi_SchId AND SlabId = @Pi_SlabId 
	)A 

	INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PrdBatDetailValue) 
	SELECT DISTINCT A.PrdId,A.PrdBatId,B.PriceId,B.PrdBatDetailValue 
	FROM ProductBatch A WITH (NOLOCK)
	INNER JOIN ProductBatchDetails B WITH (NOLOCK) ON A.PrdBatId = B.PrdBatId
	INNER JOIN @BATCH D  ON  A.PrdBatId = D.PrdBatId AND  D.PrdBatId = B.PrdBatId
	INNER JOIN BatchCreation C WITH (NOLOCK) ON A.BatchSeqId = C.BatchSeqId AND B.SLNo = C.SLNo AND C.ClmRte = 1
	

	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0)) FROM
		(SELECT A.SalId,A.SchId,A.FlatAmount,A.ReturnFlatAmount,A.DiscountPerAmount,A.ReturnDiscountPerAmount FROM 
		SalesInvoiceSchemeLineWise A (NOLOCK)INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND A.SchId = @Pi_SchId AND A.SlabId=@Pi_SlabId AND B.Dlvsts<> 3)A1
		INNER JOIN SchemeMaster S (NOLOCK) ON A1.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId 
	SELECT  @FreeValue =ISNULL(SUM((FreeQty - ReturnFreeQty) * C.PrdBatDetailValue),0)
		FROM 
		(SELECT A.SchId,A.FreePrdId,A.FreePrdBatId,A.FreePriceId,A.FreeQty,A.ReturnFreeQty FROM 
		SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND A.SlabId=@Pi_SlabId AND B.DlvSts <> 3) A2
		INNER JOIN @ProductBatchDetails C ON A2.FreePrdId = C.PrdId AND A2.FreePrdBatId = C.PrdBatId AND A2.FreePriceId = C.PriceId
		INNER JOIN SchemeMaster S ON A2.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A2.SchId = @Pi_SchId 	
			
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * C.PrdBatDetailValue),0) FROM
	    (SELECT A.SchId,A.GiftPrdId,A.GiftPrdBatId,A.GiftPriceId,A.GiftQty,A.ReturnGiftQty FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)	
         INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND A.SlabId=@Pi_SlabId AND DlvSts <> 3 )A3
		INNER JOIN @ProductBatchDetails C ON A3.GiftPrdId = C.PrdId AND A3.GiftPrdBatId = C.PrdBatId AND A3.GiftPriceId = C.PriceId
		INNER JOIN SchemeMaster S ON A3.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A3.SchId = @Pi_SchId 
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A (NOLOCK)
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A (NOLOCK)
		INNER JOIN ChequeDisbursalDetails B (NOLOCK) ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=1)
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ (NOLOCK)
	INNER JOIN SalesInvoice SI (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId AND SIQ.SlabId=@Pi_SlabId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=0)
	
	SET @BudgetUtilized = (@SchemeAmt + @FreeValue + @GiftValue + @Points + @WindowAmt+ @FBMSchAmt+@QPSSchAmt)
	
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	
	IF EXISTS (SELECT * FROM SchemeMaster WHERE SchId = @Pi_SchId AND SchType = 5)
	BEGIN
	    SET @BudgetUtilized = 0
	    SELECT @BudgetUtilized = ISNULL(SUM(SchemeUtlzAmt),0) FROM (
	    SELECT DISTINCT A.SalId,SchId,CurSchAmt AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH(NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND DlvSts <> 3 AND SchId = @Pi_SchId AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK)
	    WHERE InvoiceType = 1 AND ReturnMode = 1)UNION
	    SELECT DISTINCT A.SalId,SchId,-1*(ReturnAmt) AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH (NOLOCK),
	    ReturnHeader B WITH (NOLOCK) WHERE A.SalId = B.SalId AND SchId = @Pi_SchId AND ReturnAmt <> 0 AND InvoiceType = 1 AND ReturnMode = 2
	    AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 1)) Qry
	END	
	RETURN(@BudgetUtilized)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cs2Cn_ChainWiseBillDetails_withTax' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails_withTax
GO
/*
Begin transaction 
EXEC Proc_Cs2Cn_ChainWiseBillDetails_withTax 0,'2018-10-18'
select   * from Cs2Cn_Prk_ChainWiseBillDetails order by Billno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_ChainWiseBillDetails_withTax
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*************************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_ChainWiseBillDetails 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
---------------------------------------------------------------------------------------------------
* DATE        AUTHOR		  CR/BZ		USER STORY ID        DESCRIPTION   
 27-03-2018   S.MOhana			CR		CCRSTPAR0188	  Included reports changes in upload	
 18-09-2018  Amuthakumar P		CR		CRCRSTPAR0021	  Promotion claim should be calculating with tax
 09-10-2018  Mohana P		    BZ		ILCRSTPAR2313	  TAX CALCULATION CHANGED AS PER CLIENT REQUEST
  13-12-2019	 MOHANA S	   SR			CRCRSTPAR0079	  INCLUDED GT CATEGORY			
**************************************************************************************************/
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	CREATE TABLE #ChainSalesDetails
	(
		[TransType] INT NOT NULL,
		[SalId] [bigint] NOT NULL,
		[SalInvNo] [nvarchar](50) NOT NULL,
		[SalInvDate] [datetime] NOT NULL,
		[RtrId] [int] NOT NULL,
		[PrdId] [int] NOT NULL,
		[TotalPCS] [numeric](38, 0) NULL,
		[MRP] [numeric](18, 6) NOT NULL,
		[PriceId] [int] NOT NULL,
		[PrdBatid] [int] NOT NULL,
		[ChainLandRate] [numeric](18, 6) NULL,
		[SchemeDiscount] [numeric](18, 6) NULL,
		[PRDSLNO] INT NOT NULL
	)
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_ChainWiseBillDetails WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
			
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	--and  CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A(NOLOCK) where CtgCode NOT IN ('GT'))
	--To Filter Retailers
	
	--COMMENTED BY MOHANA ILCRSTPAR2313
	---- Added by Amuthakumar CRCRSTPAR0021
	--To Filter Products
	--SELECT DISTINCT P.PrdId
	--INTO #FilterProduct
	--FROM Product P (NOLOCK) 
	--WHERE P.PrdType = 3
	--To Filter Products
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)
	--- Till Here 	CRCRSTPAR0021
	
	INSERT INTO #ChainSalesDetails
	SELECT 1 AS TRANSID,S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDiscAmount) SchDisc,SP.SlNo
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FPR (NOLOCK) WHERE SP.PrdId = FPR.PrdId)--- Add by Amuthakumar --COMMENTED BY MOHANA ILCRSTPAR2313
	AND S.DlvSts > 3  
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId,SP.SplPriceid,SP.PrdBatid,SP.SlNo
	UNION ALL
	SELECT 2 AS TRANSID,S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SUM(-1*SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,CASE SP.SplPriceid WHEN 0 THEN 0 ELSE  SP.Priceid END AS Priceid,SP.PrdBatid,
	CAST(0 AS NUMERIC(18,6)) ChainLandRate,SUM(SP.PrdSchDisAmt) SchDisc,SP.Slno
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND SP.StockTypeId IN (SELECT StockTypeId FROM StockType WHERE SystemStockType = 1)
	WHERE  EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	 AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FPR (NOLOCK) WHERE SP.PrdId = FPR.PrdId)--- Add by Amuthakumar --COMMENTED BY MOHANA ILCRSTPAR2313
	GROUP BY S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.SplPriceid,SP.PriceId,SP.PrdBatid,SP.SlNo
		
	
	EXEC Proc_ReturnSalesProductTaxPercentage  @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)
	
		
	UPDATE #ChainSalesDetails SET SchemeDiscount = abs(SchemeDiscount/TotalPCS)
	--ADDED BY MOHANA ILCRSTPAR2313
	UPDATE A SET SchemeDiscount =  SchemeDiscount + (SchemeDiscount *(B.TaxPerc/100)) FROM #ChainSalesDetails a 
	INNER JOIN #ParleOutputTaxPercentage B ON A.TransType=B.TRANSID
	AND A.SalId = B.SALID AND A.PRDSLNO = B.PRDSLNO
	
	SELECT DISTINCT C.PrdBatid,C.Priceid,C.PrdbatDetailValue INTO #NormalPrice FROM #ChainSalesDetails A 
	INNER JOIN Productbatch B ON A.Prdbatid=B.PrdBatid
	INNER JOIN ProductBatchDetails C ON  B.PRDBATID = C.PRDBATID AND DEFAULTPRICE = 1
	and SLNO=3	
	
	--ADDED BY MOHANA
	
	SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM
	(
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%-Spl Rate-%'   
	UNION 
	SELECT D.PriceId,D.PrdBatDetailValue 
	FROM #ChainSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = 3
	AND PriceCode LIKE '%SplRate%'  
	)A
	
	--CAHNGED BY MOHANA ILCRSTPAR2313
	UPDATE R SET R.ChainLandRate = (S.SplSelRate + (S.SplSelRate *(P.TaxPerc/100))-R.SchemeDiscount) 
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK),
	 #ParleOutputTaxPercentage P 
	WHERE R.PriceId = S.PriceId	and	  R.TransType=P.TRANSID
	AND R.SalId = P.SALID AND R.PRDSLNO = P.PRDSLNO
	--Till Here ICRSTPAR7049
	
	UPDATE A SET A.ChainLandRate = ((B.PrdbatDetailValue + (B.PrdbatDetailValue *(P.TaxPerc/100))) -A.SchemeDiscount) 
	FROM #ChainSalesDetails A INNER JOIN #NORMALPRICE B ON A.PRDBATID=B.PRDBATID
	INNER JOIN #ParleOutputTaxPercentage P ON  A.TransType=P.TRANSID
	AND A.SalId = P.SALID AND A.PRDSLNO = P.PRDSLNO
	WHERE A.ChainLandRate=0  
	----TILL HERE ILCRSTPAR2313
	--SELECT S.SalId,S.SalInvNo BillNo,S.SalInvDate BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	--PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,PriceId,ChainLandRate,
	--CAST(0 AS NUMERIC(18,6)) Amount
	--INTO #Chain
	--FROM #ChainSalesDetails S (NOLOCK)
	--INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	--INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	
	 
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,R.CmpRtrCode,P.PrdId,P.PrdName,P.PrdCCode,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) Amount
	INTO #Chain
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	INNER JOIN #FilterRetailer F ON S.Rtrid = F.Rtrid AND R.Rtrid = F.Rtrid
	
	--- Added by Amuthakumar on 18-09-2018 CRCRSTPAR0021
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	--COMMENTED BY MOHANA ILCRSTPAR2313
	--SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	--INTO #SalesInvoiceProductTax
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	----AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	--UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	--FROM #Chain C (NOLOCK)
	--INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	--WHERE C.Amount > 0
	
	--Till here CRCRSTPAR0021
	--select BillNo,PrdId,QtyInPkt,ROUND(ChainLandRate,2,1),ROUND(Amount,2,1)  from #Chain order by  billno,prdid 
	--TILL HERE ILCRSTPAR2313
	INSERT INTO Cs2Cn_Prk_ChainWiseBillDetails (DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,PktMRP,QtyInPkt,
	ChainLandRate,Amount,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP,sum(QtyInPkt),sum(ChainLandRate),sum(Amount),
	'N' UploadFlag,NULL,@ServerDate
	FROM #Chain (NOLOCK) 
	GROUP BY  BillNo,BillDate,CmpRtrCode,PrdCCode,PktWgt,MRP
	
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--SalesInvoice S (NOLOCK) WHERE U.TransType = 1 AND U.TransId = S.SalId
	--UPDATE S SET S.RptUpload = 1
	--FROM UploadingReportTransaction U (NOLOCK),
	--ReturnHeader S (NOLOCK) WHERE U.TransType = 2 AND U.TransId = S.ReturnID
	
	RETURN			
END
GO
-------------------- Added by lakshman M Dated ON 16/12/2019 PMS ID: ILCRSTPAR7051 ------------
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuChequeInventorySupplier'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp6','mnuChequeInventorySupplier','mCmp','Cheque Inventory (Supplier)',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuPurOrderNorm'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp7','mnuPurOrderNorm','mCmp','Purchase Order Norm Mapping',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuPurchaseOrder'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp8','mnuPurchaseOrder','mCmp','Purchase Order',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuPurchasePayment'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp10','mnuPurchasePayment','mCmp','Purchase Payment',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='MnuIDTManagement'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp18','MnuIDTManagement','mCmp','IDT Management',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='MnuIDTCollection'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp19','MnuIDTCollection','mCmp','IDT Collection',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuCreditNoteSupplier'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp13','mnuCreditNoteSupplier','mCmp','Credit Note (Supplier)',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuDebitNoteSupplier'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp14','mnuDebitNoteSupplier','mCmp','Debit Note (Supplier)',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuCrDbAdjSup'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp15','mnuCrDbAdjSup','mCmp','Credit Debit Adjustment',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuSupplierOnAccount'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCmp16','mnuSupplierOnAccount','mCmp','Supplier On Account',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuRtrClassChange'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCus35','mnuRtrClassChange','mCus','Retailer Classification Change Request',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuSchemeMonitor'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCus11','mnuSchemeMonitor','mCus','Scheme Monitor',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuBillSeriesSetting'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCus13','mnuBillSeriesSetting','mCus','Bill Series Setting',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuCrNtAndReplaceSel'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCus21','mnuCrNtAndReplaceSel','mCus','Credit Note And Replacement Selection',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuKitProductMaster'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mCus21','mnuKitProductMaster','mCus','Credit Note And Replacement Selection',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuVanLoadandUnLoad'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mLog6','mnuVanLoadandUnLoad','mLog','Van Load and UnLoad',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuClaimGroup'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mClm1','mnuClaimGroup','mClm','Claim Group',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuClaimNormMapping'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mClm2','mnuClaimNormMapping','mClm','Claim Norm Mapping',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuSMSalaryAndDAClaim'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mClm6','mnuSMSalaryAndDAClaim','mClm','Salesman Salary And DA Claim',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuTargetNorm'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mPln1','mnuTargetNorm','mPln','Target Norm Mapping',0 FROM MenuDefToAvoid
GO
DELETE FROM MenuDefToAvoid WHERE MenuName ='mnuTargetAnalysis'
INSERT INTO MenuDefToAvoid(Slno,MenuId,MenuName,ParentId,Caption,Status)
SELECT MAX(SLNO)+1,'mPln2','mnuTargetAnalysis','mPln','Target Analysis',0 FROM MenuDefToAvoid
GO
IF EXISTS(SELECT menuid FROM menudef WHERE menuname in('MnuCounters','mnuUDCMaster','mnuReasonMaster','mnuUDCGrouping'))
BEGIN
	UPDATE A SET BtnStatus =0  FROM profiledt A WHERE menuid in(SELECT menuid FROM menudef WHERE menuname in('MnuCounters')) and BtnDescription='Edit'AND prfid IN(SELECT PrfId FROM Users WHERE username IN ('USER'))
	UPDATE A SET BtnStatus =0  FROM profiledt A WHERE menuid in(SELECT menuid FROM menudef WHERE menuname in('mnuReasonMaster')) and BtnDescription in('New','Edit','Delete','Print') AND prfid IN(SELECT PrfId FROM Users WHERE username IN ('USER'))
	UPDATE A SET BtnStatus =1  FROM profiledt A WHERE menuid in(SELECT menuid FROM menudef WHERE menuname in('mnuUDCMaster')) and BtnDescription ='Print' AND prfid IN(SELECT PrfId FROM Users WHERE username IN ('USER'))
	UPDATE A SET BtnStatus =0  FROM profiledt A WHERE menuid in(SELECT menuid FROM menudef WHERE menuname in('mnuTargetNorm')) AND prfid IN(SELECT PrfId FROM Users WHERE username IN ('USER'))
	
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ReturnSalesProductTaxPercentage' AND TYPE ='P') 
DROP PROCEDURE Proc_ReturnSalesProductTaxPercentage
GO
/*
begin tran
delete from ParleOutputTaxPercentage
EXEC Proc_ReturnSalesProductTaxPercentage '2019-04-01 ','2019-04-30 '
SELECT * FROM ParleOutputTaxPercentage where salid =  1713
rollback tran
*/
CREATE PROCEDURE Proc_ReturnSalesProductTaxPercentage
(
@Pi_Fromdate AS DATETIME,
@Pi_ToDate AS DATETIME
)
AS
/******************************************************************************************************************
* PROCEDURE	: Proc_ReturnSalesProductTaxPercentage
* PURPOSE	: To Return Sales Product Taxpercent
* CREATED	: Murugan.R
* CREATED DATE	: 18/06/2012
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* [DATE]		[DEVELOPER]			[USER_STORY_ID]   [CR/BUG]			[DESCRIPTION]       
* 12-04-2019	Lakshman. M         ILCRSTPAR4014        BUG			Billofsupply prodcct tax validation included.  
* 16-12-2019	MOHANA S			CRCRSTPAR0079		 BUG			Returnid Wrongly Mapped
*****************************************************************************************************************/
BEGIN
	SET NOCOUNT ON
	
	TRUNCATE TABLE ParleOutputTaxPercentage
	
	CREATE TABLE #SalesTax
	(
		SalId NUMERIC(36,0),
		PrdSlno INT,
		TaxPerc NUMERIC(36,4),
		TaxableAmount NUMERIC(36,4)
	)
		
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmount 
	FROM SalesInvoiceProductTax S (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
	WHERE  TaxableAmount>0 and DlvSts > 3
	AND SI.SalInvDate Between @Pi_Fromdate AND @Pi_Todate
	GROUP BY S.Salid,PrdSlno,TaxableAmount
	----------- Added By lakshman M Dated ON 1-04-2019 PMS ID: ILCRSTPAR4014 
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT A.SALID,SLNO,0 AS TAXPERC,0 TAXABLEAMOUNT
	FROM SALESINVOICE A INNER JOIN SALESINVOICEPRODUCT B ON A.SALID =B.SALID  
	--INNER JOIN SALESINVOICESCHEMELINEWISE C ON C.SALID =A.SALID AND C.SALID =B.SALID AND B.PRDBATID =C.PRDBATID AND B.PRDID =C.PRDID
	WHERE SALINVDATE BETWEEN @PI_FROMDATE AND @PI_TODATE AND  DLVSTS >3 AND B.SALID NOT IN (SELECT SALID FROM SALESINVOICEPRODUCTTAX)
	-------- Till Here ----------------------
	SELECT Salid,PrdSlno Into #TaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1 FROM #SalesTax TT
	INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #MaxTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #MinTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
			
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentage(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 1,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
	
	DELETE FROM #SalesTax
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmt 
	FROM ReturnProductTax S INNER JOIN ReturnHeader SI ON S.ReturnId=SI.ReturnId
	WHERE  TaxableAmt>0 and SI.Status=0
	AND SI.ReturnDate Between @Pi_Fromdate AND @Pi_ToDate
	GROUP BY S.ReturnId,PrdSlno,TaxableAmt ORDER BY PrdSlno

	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT a.ReturnId,slno,0 as TaxPerc,0 TaxableAmount
	from ReturnHeader a inner join Returnproduct B On A.ReturnId =b.ReturnId  
	--inner join salesinvoiceschemelinewise C ON c.salid =a.salid and c.salid =b.salid and b.prdbatid =c.prdbatid and b.prdid =c.prdid
	where Returndate between @Pi_Fromdate AND @Pi_ToDate and A.Status=0 AND a.ReturnId not in (select Returnid from ReturnProductTax )
	
	SELECT Salid,PrdSlno Into #ReturnTaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1 
	FROM #SalesTax TT
	INNER JOIN #ReturnTaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #ReturnTaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #RetMaxTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #RetMinTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentage(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 2,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ReturnSalesProductTaxPercentage_SR' AND TYPE ='P') 
DROP PROCEDURE Proc_ReturnSalesProductTaxPercentage_SR
GO
/*
begin tran
delete from ParleOutputTaxPercentage_SR
EXEC Proc_ReturnSalesProductTaxPercentage_SR '2019-04-01 ','2019-04-30 '
SELECT * FROM ParleOutputTaxPercentage_SR where salid =  1713
rollback tran
*/
CREATE PROCEDURE Proc_ReturnSalesProductTaxPercentage_SR
(
@Pi_Fromdate AS DATETIME,
@Pi_ToDate AS DATETIME
)
AS
/******************************************************************************************************************
* PROCEDURE	: Proc_ReturnSalesProductTaxPercentage
* PURPOSE	: To Return Sales Product Taxpercent
* CREATED	: Murugan.R
* CREATED DATE	: 18/06/2012
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* [DATE]		[DEVELOPER]			[USER_STORY_ID]   [CR/BUG]			[DESCRIPTION]       
* 12-04-2019	Lakshman. M         ILCRSTPAR4014        BUG			Billofsupply prodcct tax validation included.  
* 16-12-2019	MOHANA S			CRCRSTPAR0079		 BUG			Returnid Wrongly Mapped
*****************************************************************************************************************/
BEGIN
	SET NOCOUNT ON
	
	TRUNCATE TABLE ParleOutputTaxPercentage_SR
	
	CREATE TABLE #SalesTax
	(
		SalId NUMERIC(36,0),
		PrdSlno INT,
		TaxPerc NUMERIC(36,4),
		TaxableAmount NUMERIC(36,4)
	)
		
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmount 
	FROM SalesInvoiceProductTax S (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
	WHERE  TaxableAmount>0 and DlvSts > 3
	AND SI.SalInvDate Between @Pi_Fromdate AND @Pi_Todate
	GROUP BY S.Salid,PrdSlno,TaxableAmount
	----------- Added By lakshman M Dated ON 1-04-2019 PMS ID: ILCRSTPAR4014 
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT A.SALID,SLNO,0 AS TAXPERC,0 TAXABLEAMOUNT
	FROM SALESINVOICE A INNER JOIN SALESINVOICEPRODUCT B ON A.SALID =B.SALID  
	--INNER JOIN SALESINVOICESCHEMELINEWISE C ON C.SALID =A.SALID AND C.SALID =B.SALID AND B.PRDBATID =C.PRDBATID AND B.PRDID =C.PRDID
	WHERE SALINVDATE BETWEEN @PI_FROMDATE AND @PI_TODATE AND  DLVSTS >3 AND B.SALID NOT IN (SELECT SALID FROM SALESINVOICEPRODUCTTAX)
	-------- Till Here ----------------------
	SELECT Salid,PrdSlno Into #TaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1 FROM #SalesTax TT
	INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #MaxTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #MinTaxable FROM #TaxCess1 
	GROUP BY Salid,PrdSlno
			
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #TaxCess1 A INNER JOIN #MinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentage_SR(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 1,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
	
	DELETE FROM #SalesTax
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,TaxableAmt 
	FROM ReturnProductTax S INNER JOIN ReturnHeader SI ON S.ReturnId=SI.ReturnId
	WHERE  TaxableAmt>0 and SI.Status=0
	AND SI.ReturnDate Between @Pi_Fromdate AND @Pi_ToDate
	GROUP BY S.ReturnId,PrdSlno,TaxableAmt ORDER BY PrdSlno

	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT a.ReturnId,slno,0 as TaxPerc,0 TaxableAmount
	from ReturnHeader a inner join Returnproduct B On A.ReturnId =b.ReturnId  
	--inner join salesinvoiceschemelinewise C ON c.salid =a.salid and c.salid =b.salid and b.prdbatid =c.prdbatid and b.prdid =c.prdid
	where Returndate between @Pi_Fromdate AND @Pi_ToDate and A.Status=0 AND a.ReturnId not in (select Returnid from ReturnProductTax )
	
	SELECT Salid,PrdSlno Into #ReturnTaxCess FROM #SalesTax 
	GROUP BY Salid,PrdSlno
	HAVING Count(PrdSlno)>1
	
	SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1 
	FROM #SalesTax TT
	INNER JOIN #ReturnTaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno
	
	DELETE A FROM #SalesTax  A INNER JOIN #ReturnTaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno
	
	SELECT Salid,PrdSlno,Max(TaxableAmount) as TaxableAmount INTO #RetMaxTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	SELECT Salid,PrdSlno,Min(TaxableAmount) as TaxableAmount INTO #RetMinTaxable FROM #ReturnTaxCess1 
	GROUP BY Salid,PrdSlno
	
	INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxableAmount)
	SELECT Salid,Prdslno,SUM(TaxPercMain)+(SUM(TaxPercMain)*SUM((TaxPercCess/100))),0
	FROM (
			SELECT A.Salid,A.PrdSlno,A.TaxPerc as TaxPercMain,0 as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMaxTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount		
			UNION ALL
			SELECT A.Salid,A.PrdSlno,0 as TaxPercMain,TaxPerc as TaxPercCess 
			FROM #ReturnTaxCess1 A INNER JOIN #RetMinTaxable B ON A.Salid=B.Salid 
			and A.Prdslno=B.PrdSlno and A.TaxableAmount=B.TaxableAmount	
		 
	)X GROUP BY Salid,Prdslno
	
	INSERT INTO ParleOutputTaxPercentage_SR(TransId,Salid,PrdSlno,TaxPerc)
	SELECT 2,Salid,PrdSlno,TaxPerc
	FROM #SalesTax
END
GO
DELETE FROM CustomCaptions WHERE CtrlId IN (14) AND SubCtrlId IN (6) AND TransId = 504
INSERT INTO CustomCaptions
SELECT 504,14,6,'btnOperation','&Export To PDF','','',1,1,1,GETDATE(),1,GETDATE(),'&Print','','',1,1 
GO
DELETE FROM CustomCaptions WHERE CtrlId IN (23) AND SubCtrlId IN (3) AND TransId = 504
INSERT INTO CustomCaptions 
SELECT 504,23,3,'SSTDebitnote','TOT Diff Claim','','',1,1,1,GETDATE (),1,GETDATE (),'TOT Claim','','',1,1
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_UserValidation' AND TYPE='P')
DROP PROCEDURE Proc_UserValidation
GO
--EXEC Proc_UserValidation 2,'C','D',1,''
CREATE PROCEDURE Proc_UserValidation
(	
	@Pi_UserId AS INT,
	@Pi_HostName AS Varchar(100),
	@Pi_DatabaseName AS Varchar(100),
	@Pi_UserStatus AS TinyInt OUTPUT,
	@Pi_Msg AS Varchar(300) OUTPUT
)
AS
/*********************************
* PROCEDURE	: Proc_UserValidation
* PURPOSE	: To Validate Users
* CREATED	: Murugan.R
* CREATED DATE	: 2013/01/23
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}		{developer}	    USERSTORYID		{brief modification description}    
* 17-12-2019	Mohana S		CRCRSTPAR0079	Remove MultiUser Data If Improper ShutDown happened
****************************/ 
SET NOCOUNT ON
BEGIN
	DECLARE @Pi_HostNameLocked as Varchar(100)
	DECLARE @Pi_UserName as Varchar(100)
	DECLARE @Pi_Error TINYINT
	DECLARE @Pi_ErrorMsg TINYINT
	SET @Pi_Error =0
	SET @Pi_UserStatus=0
	SET @Pi_ErrorMsg=0
		BEGIN TRAN
		
		UPDATE Users Set LoggedStatus=1 where UserId=@Pi_UserId
		IF NOT EXISTS(Select UserId FROM Users (NOLOCK) WHERE UserId=@Pi_UserId and HostName NOT IN(@Pi_HostName,'') and LoggedStatus=1)
		BEGIN
			Update Users Set HostName=@Pi_HostName where UserId=@Pi_UserId
			Update Users Set HostName='' where UserId NOT IN(@Pi_UserId) and HostName=@Pi_HostName
			DELETE FROM MultiUserTransValidation WHERE TransId = 504 --CRCRSTPAR0079
			SET @Pi_Error=0
		END
		ELSE
		BEGIN
			IF EXISTS(
					SELECT Distinct A.HostName FROM Master..Sysprocesses A 
					INNER JOIN sys.dm_Exec_Sessions B ON A.Spid=B.session_id
					INNER JOIN master..SysDatabases C ON A.dbid=C.dbid
					WHERE C.Name collate SQL_Latin1_General_CP1_CI_AS =@Pi_DatabaseName AND LTRIM(RTRIM(A.HostName)) collate SQL_Latin1_General_CP1_CI_AS
					IN(SELECT hostname FROM Users (NOLOCK) WHERE UserId=@Pi_UserId) and A.PROGRAM_NAME IN('Core Stocky','Visual Basic')
					and A.Spid>50 And B.Client_Interface_Name='OLEDB'
					)
			BEGIN
				SELECT @Pi_HostName=HostName,@Pi_UserName=UserName FROM Users (NOLOCK) WHERE UserId=@Pi_UserId
				SET @Pi_Error=1	
			END
			ELSE
			BEGIN
				Update Users Set HostName=@Pi_HostName where UserId=@Pi_UserId
				Update Users Set HostName='' where UserId NOT IN(@Pi_UserId) and HostName=@Pi_HostName
				DELETE FROM MultiUserTransValidation WHERE TransId = 504 --CRCRSTPAR0079
				SET @Pi_Error=0
			END
			
		END
		---Version Control Process
		IF @Pi_Error=0
		BEGIN
			IF NOT EXISTS(SELECT HostName FROM Tbl_ExeVersionControl (NOLOCK) WHERE HostName =@Pi_HostName
						  AND LTRIM(RTRIM(VersionId)) IN(SELECT LTRIM(RTRIM(VersionId)) FROM UtilityProcess (NOLOCK)
											WHERE ProcId=1))
			BEGIN
				SET @Pi_Error=1
				SET @Pi_ErrorMsg=1
			END											
											
		END	
		--Till Here
		IF @Pi_Error=1 
		BEGIN
			IF @Pi_ErrorMsg=0 
			BEGIN
				SET @Pi_Msg='The User '+ UPPER(@Pi_UserName) +' already locked in the machine '+ @Pi_HostName
			END
			ELSE
			BEGIN
				SET @Pi_Msg='Core Stocky application Version mismatch, Please contact Support center for assistance'
			END		
			ROLLBACK TRAN
			SET @Pi_UserStatus=1
		END
		ELSE
		BEGIN
			SELECT 'User logged In' 
			COMMIT TRAN
			SET @Pi_UserStatus=0
			SET @Pi_Msg=''
		END		
END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Upload' AND module='ClaimMismatchDetails'
INSERT INTO CustomUpDownload
SELECT 175,1,'ClaimMismatchDetails','ClaimMismatchDetails','Proc_Cs2Cn_ClaimMismatchDetails','','Cs2Cn_Prk_ClaimMismatchDetails','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='ClaimMismatchDetails'
INSERT INTO Tbl_UploadIntegration
SELECT 74,'ClaimMismatchDetails','ClaimMismatchDetails','Cs2Cn_Prk_ClaimMismatchDetails',GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_ClaimMismatchDetails' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_ClaimMismatchDetails
GO
CREATE TABLE Cs2Cn_Prk_ClaimMismatchDetails
(
Slno			NUMERIC (38,0) IDENTITY(1,1),
DistCode		NVARCHAR(100),
DnRefCode		NVARCHAR(100),
UploadFlag		NVARCHAR(10),
Syncid			NUMERIC(38,0),
ServerDate		DATETIME
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_ClaimMismatchDetails' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_ClaimMismatchDetails
GO
--exec Proc_Cs2Cn_DebitNoteTopSheetClaimDt 0,'2019-09-18'
CREATE PROCEDURE Proc_Cs2Cn_ClaimMismatchDetails
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_ClaimMismatchDetails
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM IF Claim NOT Upload 
* DATE		:  21-12-2019
* CREATED	:  MOHANA S	
* PMS NO	:  ILCRSTPAR7092
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	DECLARE @DistCode	AS NVARCHAR(50)
	
	SELECT @DistCode = DistributorCode FROM Distributor
	
	DELETE FROM Cs2Cn_Prk_ClaimMismatchDetails  WHERE UploadFlag ='Y'
	
	IF NOT EXISTS (SELECT * FROM DebitNoteClaimMisMatch WHERE UPLOAD = 0)
	BEGIN
		RETURN
	END
	
	INSERT INTO Cs2Cn_Prk_ClaimMismatchDetails (DistCode,DnRefCode,UploadFlag,ServerDate)
	SELECT @DistCode,DnDocRefNo,'N',@ServerDate FROM DebitNoteClaimMisMatch WHERE Upload = 0

	UPDATE B SET UPLOAD=1  FROM Cs2Cn_Prk_ClaimMismatchDetails A INNER JOIN DebitNoteClaimMisMatch B ON A.DnRefCode = B.DnDocRefNo 
	AND UPLOAD = 0

END
GO
DELETE FROM CustomUpDownload WHERE Updownload ='Upload' AND module='CostCenterNotAvailable'
INSERT INTO CustomUpDownload
SELECT 176,1,'CostCenterNotAvailable','CostCenterNotAvailable','Proc_Cs2Cn_CostCenterNotAvailable','','Cs2Cn_Prk_CostCenterNotAvailable','','Transaction','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName ='CostCenterNotAvailable'
INSERT INTO Tbl_UploadIntegration
SELECT 75,'CostCenterNotAvailable','CostCenterNotAvailable','Cs2Cn_Prk_CostCenterNotAvailable',GETDATE ()
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Cs2Cn_Prk_CostCenterNotAvailable' AND TYPE='U')
DROP TABLE Cs2Cn_Prk_CostCenterNotAvailable
GO
CREATE TABLE Cs2Cn_Prk_CostCenterNotAvailable
(
Slno			NUMERIC (38,0) IDENTITY(1,1),
DistCode		NVARCHAR(100),
BrandCode		NVARCHAR(100),
UploadFlag		NVARCHAR(10),
Syncid			NUMERIC(38,0),
ServerDate		DATETIME
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_CostCenterNotAvailable' AND TYPE='P')
DROP PROCEDURE Proc_Cs2Cn_CostCenterNotAvailable
GO
--exec Proc_Cs2Cn_CostCenterNotAvailable 0,'2019-09-18'
CREATE PROCEDURE Proc_Cs2Cn_CostCenterNotAvailable
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME
)
AS
/****************************************************************************
* PROCEDURE	:  Proc_Cs2Cn_ClaimMismatchDetails
* PURPOSE	:  TO UPLOAD THE SAVED DEBITNOTETOPSHEET CLAIM IF Claim NOT Upload 
* DATE		:  21-12-2019
* CREATED	:  MOHANA S	
* PMS NO	:  ILCRSTPAR7092
*******************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	DECLARE @DistCode	AS NVARCHAR(50)
	
	SELECT @DistCode = DistributorCode FROM Distributor
	
	DELETE FROM Cs2Cn_Prk_CostCenterNotAvailable  WHERE UploadFlag ='Y'
	 
	DECLARE @CmpPrdCtgId INT
	SELECT @CmpPrdCtgId = CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpPrdCtgName ='BRAND'
 
 
	INSERT INTO Cs2Cn_Prk_CostCenterNotAvailable (DistCode,BrandCode,UploadFlag,ServerDate)
	SELECT @DistCode,PrdCtgValCode,'N',@ServerDate FROM ProductCategoryValue WHERE CmpPrdCtgId =@CmpPrdCtgId 
			AND  PrdCtgValCode NOT IN (SELECT DISTINCT BrandCode  FROM CostCentreDetails)

END
GO
IF EXISTS (SELECT *FROM SYSOBJECTS WHERE NAME ='Proc_InsertInstPrdDetails' AND TYPE='P')
DROP PROCEDURE Proc_InsertInstPrdDetails
GO
/* 
BEGIN TRAN
DECLARE @ErrorNo INT
EXEC Proc_InsertInstPrdDetails 1,2,504,0
SELECT * FROM DebitNoteTopSheetClaim_Inst_PrdWise  
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_InsertInstPrdDetails
(
@Pi_DNRefid INT,
@Pi_Usrid	INT,
@Pi_TransId	INT,
@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE	:  Proc_TradeSchemeClaimDetails
* PURPOSE	: TO LOAD SCHEME WISE CLAIM AMOUNT
* DATE		:  07-11-2019
* CREATED	:  MOHANA S
* PMS NO	:  CRCRSTPAR0079
*********************************/
BEGIN
SET NOCOUNT ON
	Set @Po_ErrNo = 0

	DELETE A FROM DebitNoteTopSheetClaim_Inst_PrdWise A(NOLOCK) WHERE DNRefid = @Pi_DNRefid 

	 
	IF NOT EXISTS (SELECT *FROM DebitNoteTopSheetClaimHd A(NOLOCK) INNER JOIN DebitNoteTopSheetClaim_InstTarget B(NOLOCK) ON A.DNRefid = B.DNRefId
		AND SCHTYPE=1 AND A.DNRefid = @Pi_DNRefid)
	BEGIN 
		Set @Po_ErrNo = 0 
		RETURN
	END
	  
	BEGIN TRY 
		BEGIN TRAN					
			INSERT INTO DebitNoteTopSheetClaim_Inst_PrdWise
			SELECT DISTINCT @Pi_DNRefid,Rtrid,Schid,Prdid,A.CtgMainId,ClmAmt,GETDATE()
			FROM TempInstTargetClaim_PrdWise A(NOLOCK) INNER JOIN RetailerCategory B(NOLOCK) 
			ON A.CtgMainId = B.CtgMainId 
			INNER JOIN DebitNoteTopSheetClaim_InstTarget C(NOLOCK) ON B.CtgName = C.CtgName 			
			WHERE UsrId = @Pi_Usrid AND TransId = @Pi_TransId AND C.DNrefid =@Pi_DNRefid AND SchType=1

			IF EXISTS (SELECT * FROM DebitNoteTopSheetClaim_InstTarget (NOLOCK) WHERE SCHTYPE = 1 AND DNREFID = @Pi_DNRefid)
			BEGIN

				IF NOT EXISTS (SELECT * FROM DebitNoteTopSheetClaim_Inst_PrdWise A(NOLOCK) WHERE DNREFID = @Pi_DNRefid )
				BEGIN
					SET @Po_ErrNo = 1
				END
			END
		COMMIT TRAN
		 
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
			SET @Po_ErrNo = 1				
		END CATCH	
		
	RETURN
END
GO
--CRCRSTPAR0094 (Retailer Level budget validation)
DELETE FROM ManualConfiguration WHERE ModuleId='BILL_SCHEME_APPLY' AND ProjectName ='PARLE'
INSERT INTO ManualConfiguration (ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'PARLE','BILL_SCHEME_APPLY','Billing_Scheme','Allow bill to save with out scheme when budget exceeds',1,0,0,1
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnBudgetUtilizedForRtr' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_ReturnBudgetUtilizedForRtr
GO
CREATE  FUNCTION Fn_ReturnBudgetUtilizedForRtr
(
	@Pi_SchId	INT,
	@Pi_RtrId	INT,
	@FromDate	DATETIME,
	@ToDate		DATETIME
)
RETURNS NUMERIC(38,6)
AS
/*********************************************************************************************************************************
* FUNCTION: Fn_ReturnBudgetUtilizedForRtr
* PURPOSE: Returns the Budget Utilized for the Selected Scheme Wise Retailer
* NOTES:
* CREATED: Boopathy	05-12-2007
* MODIFIED
* DATE			AUTHOR				USERSTORYID			CR/BZ		DESCRIPTION 
---------------------------------------------------------------------------------------------------------------------------------------------    
* 22/04/2010	Nanda												Added FBM Scheme	
* 18/12/2019	MarySubashini.S		CRCRSTPAR0094		CR			Retailer Level budget validation
*****************************************************************************************************************************************************/ 
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	
	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0))
		FROM SalesInvoiceSchemeLineWise A
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
		WHERE A.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
	SELECT @FreeValue = ISNULL(SUM((FreeQty - ReturnFreeQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND A.FreePrdBatId = C.PrdBatId
		INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
		WHERE A.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND A.GiftPrdBatId = C.PrdBatId
		INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId
		INNER JOIN BatchCreation E (NOLOCK) ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
		WHERE S.SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
--	SELECT @Points = ISNULL(SUM(Points - ReturnPoints),0)
--		FROM SalesInvoiceSchemeDtPoints A
--		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
--		INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
--		WHERE A.SchId = @Pi_SchId
--		AND DlvSts <> 3 AND B.SalInvDate Between @FromDate and @ToDate AND B.RtrId =@Pi_RtrId
--
--	SELECT @RetSchemeAmt = (ISNULL(SUM(ReturnFlatAmount),0) +
--		ISNULL(SUM(ReturnDiscountPerAmount),0))
--		FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
--		WHERE SchId = @Pi_SchId AND Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate
--
--	SELECT @RetFreeValue = ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)
--		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
--		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
--		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
--		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
--		WHERE SchId = @Pi_SchId AND B.Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate
--
--	SELECT @RetGiftValue = ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)
--		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
--		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
--		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
--		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
--		WHERE SchId = @Pi_SchId AND B.Status = 1 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate
--
--	SELECT @RetPoints = ISNULL(SUM(ReturnPoints),0) FROM ReturnSchemePointsDt A
--		INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId WHERE SchId = @Pi_SchId
--		AND Status = 0 AND B.RtrId =@Pi_RtrId AND B.ReturnDate Between @FromDate and @ToDate
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.RtrId =@Pi_RtrId AND B.SalInvDate Between @FromDate and @ToDate
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A
		INNER JOIN ChequeDisbursalDetails B ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 AND B.RtrId =@Pi_RtrId And A.ChqDisDate Between @FromDate and @ToDate
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster WHERE FBM=1)
	--->Added By Nanda on 27/10/2010
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ
	INNER JOIN SalesInvoice SI ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster WHERE FBM=0)
	
	SET @BudgetUtilized = (ISNULL(@SchemeAmt,0) + ISNULL(@FreeValue,0) + ISNULL(@GiftValue,0) + ISNULL(@Points,0) + ISNULL(@WindowAmt,0))
		- (ISNULL(@RetSchemeAmt,0) + ISNULL(@RetFreeValue,0) + ISNULL(@RetGiftValue,0) + ISNULL(@RetPoints,0))+ ISNULL(@FBMSchAmt,0)+ISNULL(@QPSSchAmt,0)
		---CRCRSTPAR0094 (ISNULL ADDED)
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	RETURN(@BudgetUtilized)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnCurrentUtilized' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_ReturnCurrentUtilized
GO
CREATE   FUNCTION Fn_ReturnCurrentUtilized(@Pi_SchId INT,@Pi_SalId BIGINT,@Pi_TransId INT,@Pi_UsrId as INT)
RETURNS NUMERIC(38,6)
AS
BEGIN
/*********************************
* FUNCTION: Fn_ReturnCurrentUtilized
* PURPOSE: Returns the Current Budget Utilized for the Selected Scheme
* NOTES: 
* CREATED: Thrinath Kola	11-06-2007
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 
*********************************/

	DECLARE @SchemeAmt 	NUMERIC(38,6)
	DECLARE @FreeValue	NUMERIC(38,6)
	DECLARE @GiftValue	NUMERIC(38,6)
	DECLARE @Points		INT
	DECLARE @PrvSchemeAmt 	NUMERIC(38,6)
	DECLARE @PrvFreeValue	NUMERIC(38,6)
	DECLARE @PrvGiftValue	NUMERIC(38,6)
	DECLARE @PrvPoints	INT
	DECLARE @WindowAmt	NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)

	SELECT @PrvSchemeAmt = (ISNULL(SUM(FlatAmount),0) + 
		ISNULL(SUM(DiscountPerAmount),0))
		FROM SalesInvoiceSchemeLineWise A INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalId = @Pi_SalId

	SELECT @PrvFreeValue = ISNULL(SUM((FreeQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalId = @Pi_SalId

	SELECT @PrvGiftValue = ISNULL(SUM((GiftQty) * D.PrdBatDetailValue),0)
		FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalId = @Pi_SalId

	SELECT @PrvPoints = ISNULL(SUM(Points),0) FROM SalesInvoiceSchemeDtPoints A
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId WHERE SchId = @Pi_SchId
		AND DlvSts <> 3 AND B.SalId = @Pi_SalId

	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A 
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3 AND B.SalId = @Pi_SalId

	SELECT @SchemeAmt = ISNULL(SUM(SchemeAmount + SchemeDiscount),0) FROM ApportionSchemeDetails WHERE 
		TransId = @Pi_TransId and UsrId = @Pi_UsrId AND SchId = @Pi_SchId

	SELECT @FreeValue = ISNULL(SUM((FreeToBeGiven) * D.PrdBatDetailValue),0)
		FROM BillAppliedSchemeHd A INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND 
		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND D.DefaultPrice = 1 INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId

	SELECT @GiftValue = ISNULL(SUM((GiftToBeGiven) * D.PrdBatDetailValue),0)
		FROM BillAppliedSchemeHd A INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND 
		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON 
		C.PrdBatId = D.PrdBatId AND D.DefaultPrice = 1 INNER JOIN BatchCreation E (NOLOCK)
			ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1 
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId

	SELECT @Points = ISNULL(SUM(Points),0) FROM BillAppliedSchemeHd A
		WHERE SchId = @Pi_SchId AND TransId = @Pi_TransId AND UsrId=@Pi_UsrId

	SET @BudgetUtilized = (ISNULL(@SchemeAmt,0) + ISNULL(@FreeValue,0) + ISNULL(@GiftValue,0) + ISNULL(@Points,0) + ISNULL(@WindowAmt,0))
		- (ISNULL(@PrvSchemeAmt,0) + ISNULL(@PrvFreeValue,0) + ISNULL(@PrvGiftValue,0) + ISNULL(@PrvPoints,0))

	RETURN(@BudgetUtilized)
	
END 
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Cn2Cs_BLSchemeRulesetting' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeRulesetting
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cn2Cs_BLSchemeRulesetting 0
SELECT * FROM ErrorLog
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeRulesetting
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************************************************************************************************************
* PROCEDURE		: Proc_Cn2Cs_BLSchemeRulesetting
* PURPOSE		: To Insert and Update records in the Table Etl_Prk_SchemeRuleSettings_Temp,
				  Etl_Prk_SchemeRtrLevelValidation_Temp
* CREATED		: Nandakumar R.G
* CREATED DATE	: 06/01/2009
* MODIFIED
* DATE			AUTHOR				USERSTORYID			CR/BZ		DESCRIPTION 
------------------------------------------------------------------------------------------------------------------------------------------
* 09-Apr-2010   Jayakumar N										Change done based on "Rtr Cap" in SchConfig column in table Etl_Prk_SchemeRuleSettings.
																Based on "Rtr Cap" value updated in respective columns NoOfRtr and RtrCount in SchemeruleSettings table
* 19/12/2019	MarySubashini.S		CRCRSTPAR0094		CR		Retailer Level budget validation
*********************************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @Exist 		AS INT
	DECLARE @Tabname AS     NVARCHAR(100)
	DECLARE @DestTabname AS NVARCHAR(100)
	DECLARE @Fldname AS     NVARCHAR(100)
	DECLARE @CmpSchCode AS NVARCHAR(200)
	DECLARE @SchConfig AS NVARCHAR(200)
	DECLARE @SchRules AS NVARCHAR(200)
	DECLARE @NoofBills AS NVARCHAR(200)
	DECLARE @FromDate AS NVARCHAR(200)
	DECLARE @ToDate AS NVARCHAR(200)
	DECLARE @MarketVisit AS NVARCHAR(200)
	DECLARE @ApplySchBasedOn AS NVARCHAR(200)
	DECLARE @EnableRtrLvl AS NVARCHAR(200)
	DECLARE @AllowSaving AS NVARCHAR(200)
	DECLARE @AllowSelection AS NVARCHAR(200)
	DECLARE @RtrCode AS NVARCHAR(200)
	DECLARE @RtrFromDate AS NVARCHAR(200)
	DECLARE @RtrToDate AS NVARCHAR(200)
	DECLARE @BudgetAllocated AS NVARCHAR(200)
	DECLARE @Status AS NVARCHAR(200)
	DECLARE @SchId AS INT
	DECLARE @SchConfigId AS INT
	DECLARE @SchRulesId AS INT
	DECLARE @ApplySchBasedOnId AS INT
	DECLARE @EnableRtrLvlId AS INT
	DECLARE @AllowSavingId AS INT
	DECLARE @AllowSelectionId AS INT
	DECLARE @RtrId AS INT
	DECLARE @StatusId AS INT
	DECLARE @SchLevelId 	AS INT
	DECLARE @ConFig		AS INT
	DECLARE @GetKey 	AS INT
	DECLARE @GetKeyCode	AS VARCHAR(200)
	DECLARE @CmpId 		AS INT
	DECLARE @SLevel		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @SlNo 		AS INT
	DECLARE @RtrAttrCnt	AS INT
	DECLARE @RtrLvlCnt	AS INT
	DECLARE @SchWithOutPrd AS INT	
	
	SET @DestTabname='SchemeRuleSetting'
	SET @Fldname='SchConfig'
	SET @Tabname = 'Etl_Prk_SchemeRuleSettings_Temp'
	SET @Exist=0
	SET @Po_ErrNo=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE Cur_SchemeRules CURSOR
	FOR SELECT DISTINCT ISNULL(CmpSchCode,'') AS CmpSchCode,ISNULL(SchConfig,''),ISNULL(SchRules,''),ISNULL(NoofBills,''),ISNULL(SchValidFrom,''),ISNULL(SchValidTill,''),
	ISNULL(MarketVisit,''),ISNULL(ApplySchBasedOn,''),ISNULL(EnableRtrLvl,''),ISNULL(AllowSaving,''),ISNULL(AllowSelection,'')
	FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY CmpSchCode
	OPEN Cur_SchemeRules
	FETCH NEXT FROM Cur_SchemeRules INTO @CmpSchCode,@SchConfig,@SchRules,@NoofBills,
	@FromDate,@ToDate,@MarketVisit,@ApplySchBasedOn,@EnableRtrLvl,@AllowSaving,@AllowSelection
	WHILE @@FETCH_STATUS=0
	BEGIN		

		SET @Po_ErrNo=0
		IF LTRIM(RTRIM(@CmpSchCode))=''
		BEGIN
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',
			'Company Scheme Code should not be empty')
			SET @Po_ErrNo=1
		END
		ELSE
		BEGIN
			SELECT @SchId=SchId,@SchLevelId=SchLevelId FROM SchemeMaster
			WHERE CmpSchCode=@CmpSchCode
		END
		
		IF @Po_ErrNo=0
		BEGIN
			IF LTRIM(RTRIM(@SchConfig))='---'
			BEGIN
				GOTO X 
				----CLOSE Cur_SchemeRules
				----DEALLOCATE Cur_SchemeRules
				----Return
			END
			IF LTRIM(RTRIM(@SchConfig))='YES'
			BEGIN
				SET @SchConfigId=1
			END
			ELSE 
			BEGIN
				SET @SchConfigId=0
			END
		END
		

		IF @SchConfigId=1 AND @Po_ErrNo=0
		BEGIN		
			IF LTRIM(RTRIM(@SchRules))=''
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Rules',
				'Scheme Rules should not be empty for Scheme Code:'+@CmpSchCode)
				SET @Po_ErrNo=1
			END
			ELSE
			BEGIN
				IF LTRIM(RTRIM(@SchRules))='PRODUCT'
				BEGIN
					SET @SchRulesId=0
				END
				ELSE IF LTRIM(RTRIM(@SchRules))='BILL'
				BEGIN
					SET @SchRulesId=1
				END	
				ELSE IF LTRIM(RTRIM(@SchRules))='DATE'
				BEGIN
					SET @SchRulesId=2
				END
				ELSE IF LTRIM(RTRIM(@SchRules))='MARKET'
				BEGIN
					SET @SchRulesId=3
				END			
			END
	
			IF @Po_ErrNo=0
			BEGIN
				IF @SchRulesId=1
				BEGIN
					IF NOT ISNUMERIC(@NoofBills)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme No Of Bills should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE IF @NoofBills<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme No Of Bills should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END	
				END
				ELSE IF @SchRulesId=2
				BEGIN
					IF @Po_ErrNo=0
					BEGIN
						IF ISDATE(@FromDate)=1 AND ISDATE(@ToDate)=1
						BEGIN
							IF DATEDIFF(DD,@FromDate,@ToDate)<0 OR @ToDate< CONVERT(NVARCHAR(10),GETDATE(),121)
							BEGIN
								INSERT INTO Errorlog VALUES (1,@TabName,'Date',
								'From Date should be less than To Date for Scheme Code:'+@CmpSchCode)           	
								SET @Po_ErrNo=1
							END
						END
						ELSE
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Date',
							'Either From Date or To Date is wrong for Scheme Code:'+@CmpSchCode)           	
							SET @Po_ErrNo=1
						END
					END	
				END
				IF @SchRulesId=3
				BEGIN
					IF ISNUMERIC(@MarketVisit)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Market Visits',
						'Scheme Market Visits should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE IF @MarketVisit<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Scheme Market Visits should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
				END
			END
	
			IF @Po_ErrNo=0
			BEGIN
				IF LTRIM(RTRIM(@ApplySchBasedOn))=''
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Scheme-Apply Based On',
					'Scheme-Apply Based On Rules should not be empty for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo=1
				END
				ELSE
				BEGIN
					IF LTRIM(RTRIM(@ApplySchBasedOn))='Company'
					BEGIN
						SET @ApplySchBasedOnId=0
					END
					ELSE IF LTRIM(RTRIM(@ApplySchBasedOn))='Retailer'
					BEGIN
						SET @ApplySchBasedOnId=1
					END	
					ELSE IF LTRIM(RTRIM(@ApplySchBasedOn))='JC'
					BEGIN
						SET @ApplySchBasedOnId=2
					END
				END	
			END
		END
		ELSE
		BEGIN
			SET @SchRulesId=-1
			SET @ApplySchBasedOnId=-1		
			SET @MarketVisit=-1		
			IF UPPER(@SchConfig)<>UPPER('Rtr Cap')
			BEGIN
				SET @NoofBills=-1					
			END
		END
	
		IF @Po_ErrNo=0
		BEGIN
			IF LTRIM(RTRIM(@EnableRtrLvl))='Yes'
			BEGIN
				SET @EnableRtrLvlId=1	
							
			END
			ELSE
			BEGIN
				SET @EnableRtrLvlId=0
			END
		END
			
		IF @Po_ErrNo=0
		BEGIN
			IF @EnableRtrLvlId=1
			BEGIN
				 
				IF NOT EXISTS (SELECT * FROM Etl_Prk_Scheme_RetailerLevelValid WHERE CmpSchCode=@CmpSchCode)
				BEGIN
					INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Level Validation',
					'Retailer not found for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo =1
				END
				IF LTRIM(RTRIM(@AllowSaving))='Yes'
				BEGIN
					SET @AllowSavingId=1					
				END
				ELSE
				BEGIN
					SET @AllowSavingId=0					
				END
				IF LTRIM(RTRIM(@AllowSelection))='Yes'
				BEGIN
					SET @AllowSelectionId=1					
				END
				ELSE
				BEGIN
					SET @AllowSelectionId=0					
				END
			END
			ELSE
			BEGIN
				SET @AllowSavingId=0
				SET @AllowSelectionId=0
			END
		END
		 
		
		---Insert Rule
		IF @ConFig<>1
		BEGIN
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster 
			WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
			BEGIN
				INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',
				'Company Scheme Code not found')
				SET @Exist=0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SET @Po_ErrNo =0
				IF EXISTS(SELECT * FROM SchemeRuleSettings WHERE SchId=@GetKey)
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
			END
		END
		ELSE
		BEGIN
			IF EXISTS(SELECT SchId FROM SchemeMaster 
			WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
			BEGIN
				SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster 
				WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId FROM SchemeMaster 
				WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				IF EXISTS(SELECT * FROM SchemeRuleSettings WHERE SchId=@GetKey)
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
				SET @Po_ErrNo =0
			END
			ELSE IF EXISTS(SELECT CmpSchCode FROM ETL_Prk_SchemeMaster_Temp WHERE
				CmpSchCode=LTRIM(RTRIM(@CmpSchCode)) AND UpLoadFlag='N')
			BEGIN
				SELECT @GetKeyCode=CmpSchCode,@CmpId=CmpId FROM ETL_Prk_SchemeMaster_Temp WHERE
				CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpPrdCtgId=SchLevelId
				FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode))
				IF EXISTS(SELECT * FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@CmpSchCode)))
				BEGIN
					SET @Exist=1
				END
				ELSE
				BEGIN
					SET @Exist=0
				END
			END	
		END		
		
		IF @ConFig=1
		BEGIN	
			SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
			IF @CmpPrdCtgId<@SLevel
			BEGIN
				SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='NO'
				AND A.SlabId=0 AND A.SlabValue=0
				SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
				A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='NO'
				AND A.SlabId=0 AND A.SlabValue=0
			END
			ELSE
			BEGIN
				SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='YES'
				AND A.SlabId=0 AND A.SlabValue=0
				SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
				WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
				AND  A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode)) --AND UPPER(A.[SchLevel])='YES'
				AND A.SlabId=0 AND A.SlabValue=0
			END
			IF @EtlCnt=@CmpCnt
			BEGIN	

				SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode))
				SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
				INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
				WHERE A.[CmpSchCode]=LTRIM(RTRIM(@CmpSchCode))
				IF @EtlCnt=@CmpCnt
				BEGIN
					SET @SchWithOutPrd=1
				END
				ELSE
				BEGIN
					SET @SchWithOutPrd=2
				END	
			END
			ELSE
			BEGIN
				SET @SchWithOutPrd=2
			END	
		END
		ELSE
		BEGIN
			SET @SchWithOutPrd=1		
		END
		---		
		IF @Exist=0 AND @SchWithOutPrd=1   
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END
			END 
			----CRCRSTPAR0094
			INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,
			FromDate,ToDate,MarketVisit,ApplySchBasedOn,EnableRtrLvl,AllowSaving,
			AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,NoOfRtr,RtrCount)
			VALUES(@GetKey,@SchConfigId,@SchRulesId,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN -1 ELSE @NoofBills END ,
			@FromDate,@ToDate,@MarketVisit,@ApplySchBasedOnId,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN 1 ELSE @EnableRtrLvlId END,
			@AllowSavingId,@AllowSelectionId,1,1,GETDATE(),1,GETDATE(),
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN 1 ELSE 0 END,
			CASE UPPER(@SchConfig) WHEN UPPER('Rtr Cap') THEN @NoofBills ELSE 0 END)
		END
		IF @Exist=1 AND @SchWithOutPrd=1
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			UPDATE SchemeRuleSettings SET SchConfig=@SchConfigId,SchRules=@SchRulesId,
			NoofBills=@NoofBills,FromDate=@FromDate,ToDate=@ToDate,MarketVisit=@MarketVisit,
			ApplySchBasedOn=@ApplySchBasedOnId,EnableRtrLvl=@EnableRtrLvlId,AllowSaving=@AllowSavingId
			WHERE SchId=@GetKey			
		END
		IF @Exist=0 AND @SchWithOutPrd=2
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			INSERT INTO Etl_Prk_SchemeRuleSettings_Temp(CmpSchCode,SchConfig,SchRules,NoofBills,
			FromDate,ToDate,MarketVisit,ApplySchBasedOn,EnableRtrLvl,AllowSaving,AllowSelection)
			VALUES(@CmpSchCode,@SchConfigId,@SchRulesId,@NoofBills,@FromDate,@ToDate,
			@MarketVisit,@ApplySchBasedOnId,@EnableRtrLvlId,@AllowSavingId,
			@AllowSelectionId)
		END
		IF @Exist=1 AND @SchWithOutPrd=2
		BEGIN
			----CRCRSTPAR0094
			IF @EnableRtrLvlId=1
				BEGIN
				IF @SchRulesId IS NULL 
				BEGIN
					SET @SchRulesId=-1
				END 
				IF @ApplySchBasedOnId IS NULL 
				BEGIN
					SET @ApplySchBasedOnId=-1
				END 
			END
			----CRCRSTPAR0094
			UPDATE Etl_Prk_SchemeRuleSettings_Temp SET SchConfig=@SchConfigId,
			SchRules=@SchRulesId,NoofBills=@NoofBills,FromDate=@FromDate,ToDate=@ToDate,
			MarketVisit=@MarketVisit,ApplySchBasedOn=@ApplySchBasedOnId,
			EnableRtrLvl=@EnableRtrLvlId,AllowSaving=@AllowSavingId
			WHERE CmpSchCode=@CmpSchCode			
		END
		IF @EnableRtrLvlId=1 AND @Po_ErrNo=0
		BEGIN
			SET @SlNo=1 ---CRCRSTPAR0094  
			
			IF EXISTS (SELECT 'X' FROM SchemeRtrLevelValidation WHERE SchId=@GetKey)
			BEGIN
				SET @Exist=1
			END 
			ELSE 
			BEGIN
				SET @Exist=0
			END 		
			
			DECLARE Cur_SchemeRulesRetailer CURSOR
			FOR SELECT ISNULL(RtrCode,''),ISNULL(FromDate,''),ISNULL(ToDate,''),
			ISNULL(BudgetAllocated,''),ISNULL(Status,'')
			FROM Etl_Prk_Scheme_RetailerLevelValid WHERE CmpSchCode=@CmpSchCode
			OPEN Cur_SchemeRulesRetailer
		
			FETCH NEXT FROM Cur_SchemeRulesRetailer INTO @RtrCode,@RtrFromDate,@RtrToDate,
			@BudgetAllocated,@Status
			WHILE @@FETCH_STATUS=0
			BEGIN
				IF LTRIM(RTRIM(@RtrCode))=''
				BEGIN
					INSERT INTO Errorlog VALUES (1,'Etl_Prk_Scheme_RetailerLevelValid','Retailer Code',
					'Retailer Code should not be empty for Scheme Code:'+@CmpSchCode)
					SET @Po_ErrNo=1
				END
				IF @Po_ErrNo=0
				BEGIN
					IF NOT EXISTS(SELECT * FROM Retailer WITH (NOLOCK)
					WHERE CmpRtrCode=@RtrCode)---CRCRSTPAR0094 RtrCode to CmpRtrCode
					BEGIN
						INSERT INTO Errorlog VALUES (1,'Etl_Prk_Scheme_RetailerLevelValid','Retailer',
						'Retailer : '+@RtrCode+' is not available for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					ELSE
					BEGIN
						SELECT @RtrId=RtrId FROM Retailer WITH (NOLOCK)
						WHERE CmpRtrCode=@RtrCode ---CRCRSTPAR0094 RtrCode to CmpRtrCode
					END
				END		
				IF @Po_ErrNo=0
				BEGIN
					IF EXISTS(SELECT * FROM Etl_Prk_Scheme_OnAttributes WHERE 
						CmpSchCode=@CmpSchCode AND AttrType='RETAILER' AND AttrName<> 'ALL')
					BEGIN
						IF NOT EXISTS(SELECT * FROM Etl_Prk_Scheme_OnAttributes WHERE 
						CmpSchCode=@CmpSchCode AND AttrType='RETAILER' AND AttrName=@RtrCode)
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Level Validation',
							'Retailer Mismatch for Scheme Code:'+@CmpSchCode)
							SET @Po_ErrNo =1
						END	
					END
				END
				 
				IF @Po_ErrNo=0
				BEGIN
					IF ISDATE(@RtrFromDate)=1 AND ISDATE(@RtrToDate)=1
					BEGIN
						IF DATEDIFF(DD,@RtrFromDate,@RtrToDate)<0 OR @RtrToDate< CONVERT(NVARCHAR(10),GETDATE(),121)
						BEGIN
							INSERT INTO Errorlog VALUES (1,@TabName,'Date',
							'From Date should be less than To Date for Scheme Code:'+@CmpSchCode)           	
							SET @Po_ErrNo=1
						END
					END
					ELSE
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Either From Date or To Date is wrong for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
				END
				
				IF @Po_ErrNo=0
				BEGIN
					IF (DATEDIFF(DD,@FromDate,@RtrFromDate)<0 OR DATEDIFF(DD,@RtrFromDate,@ToDate)<0)
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Retailer From Date should be within From and To Date for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					
					IF (DATEDIFF(DD,@FromDate,@RtrToDate)<0 OR DATEDIFF(DD,@RtrToDate,@ToDate)<0)
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Date',
						'Retailer To Date should be within From and To Date for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
				END
				
				IF @Po_ErrNo=0
				BEGIN
					IF NOT ISNUMERIC(@BudgetAllocated)=1 
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Budget Allocated',
						'Budget Allocated should be numeric value for Scheme Code:'+@CmpSchCode)           	
						SET @Po_ErrNo=1
					END
					ELSE IF (CAST(@BudgetAllocated AS NUMERIC(38,6)))<=0
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Scheme No Of Bills',
						'Budget Allocated should be greater than zero for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
				END
				IF @Po_ErrNo=0
				BEGIN				
					IF LTRIM(RTRIM(@Status))=''
					BEGIN
						INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Status',
						'Retailer Status should not be empty for Scheme Code:'+@CmpSchCode)
						SET @Po_ErrNo=1
					END
					ELSE
					BEGIN
						IF LTRIM(RTRIM(@Status))='Active'
						BEGIN
							SET @StatusId=1					
						END
						ELSE
						BEGIN
							SET @StatusId=0					
						END
					END
				END	
				IF @Exist=0 AND @SchWithOutPrd=1
				BEGIN
					IF @Po_ErrNo=0 
					BEGIN
						INSERT INTO SchemeRtrLevelValidation(SchId,RtrId,FromDate,ToDate,
						BudgetAllocated,BudgetUtilized,BudgetAvailable,Status,Slno,
						Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@GetKey,@RtrId,@RtrFromDate,@RtrToDate,
						CAST(@BudgetAllocated AS NUMERIC(38,6)),0,0,@StatusId,@SlNo,1,1,GETDATE(),1,GETDATE())
					END
					IF @Exist=1 AND @SchWithOutPrd=1
					BEGIN
						 
						UPDATE SchemeRtrLevelValidation SET FromDate=@FromDate,ToDate=@ToDate,
						BudgetAllocated=CAST(@BudgetAllocated AS NUMERIC(38,6)),
						BudgetAvailable=CAST(@BudgetAllocated AS NUMERIC(38,6))-BudgetUtilized,
						Status=@StatusId
						WHERE SchId=@GetKey AND RtrId=@RtrId	
					END		 
				END
				IF @Po_ErrNo=0 
				BEGIN
					IF @Exist=0 AND @SchWithOutPrd=2
					BEGIN
						INSERT INTO Etl_Prk_SchemeRtrLevelValidation_Temp(CmpSchCode,RtrId,
						RtrCode,FromDate,ToDate,BudgetAllocated,BudgetUtilized,BudgetAvailable,
						Status,Slno)
						VALUES(@CmpSchCode,@RtrId,@RtrCode,@RtrFromDate,@RtrToDate,@BudgetAllocated,
						0,0,@Status,@Slno)
					END
				 
					IF @Exist=1 AND @SchWithOutPrd=2
					BEGIN
						UPDATE Etl_Prk_SchemeRtrLevelValidation_Temp SET FromDate=@FromDate,
						ToDate=@ToDate,BudgetAllocated=CAST(@BudgetAllocated AS NUMERIC(38,6)),Status=@Status
						WHERE CmpSchCode=@CmpSchCode AND RtrCode=@RtrCode			
					END
				END
				SET @SlNo=@SlNo+1
				FETCH NEXT FROM Cur_SchemeRulesRetailer INTO @RtrCode,@RtrFromDate,@RtrToDate,@BudgetAllocated,@Status
			END
			CLOSE Cur_SchemeRulesRetailer
			DEALLOCATE Cur_SchemeRulesRetailer
		END	
		X:			
		FETCH NEXT FROM Cur_SchemeRules INTO @CmpSchCode,@SchConfig,@SchRules,@NoofBills,@FromDate,@ToDate,
		@MarketVisit,@ApplySchBasedOn,@EnableRtrLvl,@AllowSaving,@AllowSelection
	END
	CLOSE Cur_SchemeRules
	DEALLOCATE Cur_SchemeRules
END
GO
DELETE FROM Billtemplatehd where tempname='DEBIT NOTE TOP SHEET'
INSERT INTO Billtemplatehd([TempName],[BillSeqId],[BillSeqDt],[MarketRet],[Replacement],[OtherCharges],[CrDbAdj],[TaxDt],[LineNumber],[UsrId],[Scheme],[PrintType],[SampleIssue])
SELECT 'DEBIT NOTE TOP SHEET',1,'2019-11-26',0,0,0,0,0,200,1,0,10,0
GO
UPDATE Tbl_SyncConfiguration SET Setting =1 WHERE Slno = 1
GO
DELETE FROM CustomCaptions WHERE CtrlName IN ('FpInst-504-17-1','FpInst-504-17-2','FpInst-504-17-3','FpInst-504-17-4','FpInst-504-17-5','FpInst-504-17-6','FpInst-504-17-7','FpInst-504-17-8','FpInst-504-17-9','FpInst-504-17-10','FpInst-504-17-11') AND TransId = 504
INSERT INTO CustomCaptions
SELECT 504,17,1,'FpInst-504-17-1','Name Of The Category','','',1,1,1,GETDATE (),1,GETDATE (),'Name Of The Category','','',1,1 UNION 
SELECT 504,17,2,'FpInst-504-17-2','From Date','','',1,1,1,GETDATE (),1,GETDATE (),'From Date','','',1,1 UNION 
SELECT 504,17,3,'FpInst-504-17-3','To Date','','',1,1,1,GETDATE (),1,GETDATE (),'To Date','','',1,1 UNION 
SELECT 504,17,4,'FpInst-504-17-4','Circular No','','',1,1,1,GETDATE (),1,GETDATE (),'Circular No','','',1,1 UNION 
SELECT 504,17,5,'FpInst-504-17-5','Description','','',1,1,1,GETDATE (),1,GETDATE (),'Description','','',1,1 UNION 
SELECT 504,17,6,'FpInst-504-17-6','Monthly Target','','',1,1,1,GETDATE (),1,GETDATE (),'Monthly Target','','',1,1 UNION 
SELECT 504,17,7,'FpInst-504-17-7','Last 2 Month Avg Sales','','',1,1,1,GETDATE (),1,GETDATE (),'Last 2 Month Avg Sales','','',1,1 UNION 
SELECT 504,17,8,'FpInst-504-17-8','Current Month','','',1,1,1,GETDATE (),1,GETDATE (),'Current Month','','',1,1 UNION 
SELECT 504,17,9,'FpInst-504-17-9','No of Incentive Outlet','','',1,1,1,GETDATE (),1,GETDATE (),'No of Incentive Outlet','','',1,1 UNION 
SELECT 504,17,10,'FpInst-504-17-10','Total Discount','','',1,1,1,GETDATE (),1,GETDATE (),'Total Discount','','',1,1  UNION 
SELECT 504,17,11,'FpInst-504-17-11','Sch Type','','',1,1,1,GETDATE (),1,GETDATE (),'Sch Type','','',1,1 
GO
---SYNC
DELETE FROM Utilityprocess WHERE ProcessName ='Parle_SFAIntegration.Exe'
Insert into Utilityprocess (ProcId,ProcessName,ProcessPath,ProcessType,ConfigExists,ModuleId,ModuleName,Mandatory,DependExe,VersionId,ProcessHandle)
Select MAX(ProcId)+1, 'Parle_SFAIntegration.Exe','App.Path','EXE',1,'','',1,0,'',0 from Utilityprocess 
GO
IF EXISTS(SELECT * FROM Utilityprocess WHERE ProcessName ='Sync.Exe')
BEGIN
Update Utilityprocess Set VersionId ='PV.2.14.0' Where ProcessName ='Sync.Exe'
END
GO
IF NOT EXISTS (Select * from Tbl_syncConfiguration Where ProcessName ='PDAExecuteAfterSync')
BEGIN
	Insert into Tbl_syncConfiguration 
	Select 'PDAExecuteAfterSync',1,GETDATE ()
END	
GO
IF NOT EXISTS (Select * from Tbl_syncConfiguration Where ProcessName ='PDASuccessMsgShow')
BEGIN
	Insert into Tbl_syncConfiguration 
	Select 'PDASuccessMsgShow',1,GETDATE ()
END	
GO
IF NOT EXISTS (Select * from sys.tables Where name ='Tbl_SyncDetails' and type ='U')
BEGIN
	CREATE TABLE Tbl_SyncDetails
(
	[ID] [numeric](18, 0) IDENTITY(1,1) NOT NULL,
	[UploadSyncID] [numeric](18, 0) NULL,
	[SyncStartTime] [datetime] NULL,
	[SyncEndTime] [datetime] NULL,
	[Remarks] [varchar](max) NULL,
	[SyncStatusRemarks] [varchar](max) NULL,
	[SFlag] [int] NULL,
	[UploadFlag] [varchar](10) NULL
) 
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SyncValidation_Summary]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[SyncValidation_Summary](
	[DistCode] [varchar](100) NULL,
	[Syncid] [int] NULL,
	[VStartTime] [datetime] NULL,
	[VEndTime] [datetime] NULL,
	[UploadSyncid] [int] NULL,
	[CreatedDate] [datetime] NULL,
	[UploadFlag] [varchar](1) NULL
)
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SyncValidation_Details]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[SyncValidation_Details](
	[DistCode] [varchar](100) NULL,
	[Syncid] [int] NULL,
	[Processname] [varchar](200) NULL,
	[VStartTime] [datetime] NULL,
	[VEndTime] [datetime] NULL,
	[UploadSyncid] [int] NULL,
	[RecCnt] [int] NULL,
	[CreatedDate] [datetime] NULL
)
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS where name ='SyncAttempt_Archieve' AND Type ='U')
BEGIN
Create table SyncAttempt_Archieve
(
IPAddress Varchar(300), 
Status int, 
StartTime DateTime, 
CreatedDate DateTime
)
END
GO
DELETE FROM Tbl_syncConfiguration WHERE ProcessName in('ClrSyncAttempt','ValidationTrace')
Insert into Tbl_syncConfiguration 
Select 'ClrSyncAttempt',1,GETDATE() Union
Select 'ValidationTrace',1,GETDATE()
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_SyncValidation' AND TYPE ='P')
DROP PROCEDURE Proc_SyncValidation
GO
CREATE PROCEDURE Proc_SyncValidation     
(          
@TypeId Int,          
@Code Varchar(100) = '', -- IP Address in Sync Attempt, DistCode in SyncStatus,          
@Val1 Numeric(18)=0, -- SubTypeId in SyncStatus,          
@Val2 Numeric(18)=0, -- SyncId in SyncStatus,          
@Val3 Numeric(18)=0, -- RecCnt in SyncStatus,          
@Val4 Varchar(100)='',          
@Val5 Varchar(100)='',          
@Val6 Varchar(100)='' ,
@Val7 Varchar(100)=''          
)          
As 
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
04/10/2017  Gowsalya S   CR          CCONSAML1012            Added HotFixMsg Validation 
07/12/2017  Gowsalya S   CR          CCONSPAR0178            Checking ScriptUpdaterfixid between CS and Console 
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
14/12/2017  Gowsalya S   CR          ISTOCWIP1835            For displaying Syncversion number on Sync exe UI
09/01/2018  Gowsalya S   BZ          ICONSWIP1878            Validation added to check distinct Slno Count  
09/11/2018	Gowsalya S	 CR			 CRCONSPAR0035			CSTimer Settings added.
30/12/2019  Lakshman M   SR          ILCRSTPAR7202          New Sync Exe changes
*/           
Begin          
--Added By Lakshman M dated on 12-02-2018
BEGIN TRY        
BEGIN TRANSACTION
--Till Here  
 Delete A From SyncErrorDetails A (Nolock) Where (Convert(Varchar(10),CreatedDate,121)) <= (Convert(Varchar(10),GETDATE()- 30,121))
	
 Declare @Sql Varchar(Max)        
 Declare @IntRetVal Int      
 IF @TypeId = 1 -- Distributor Code, Proc_SyncValidation  piTypeId          
 Begin          
  SELECT DistributorCode FROM Distributor WHERE Distributorid=1           
 End          
 IF @TypeId = 2 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 Begin          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER45') AND ModuleName='DataTransfer' Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId     
 End           
 IF @TypeId = 3 -- Sync Attempt Validation  Proc_SyncValidation  @TypeId,@Code          
 Begin          
  Declare @RetTemp Int      
  SET @RetTemp = 1      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
 --SET @RetTemp = 0      
 IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
 Begin      
  SET @RetTemp = 0      
 End       
  End      
  IF (@RetTemp = 0)      
  Begin      
 Select 0      
 RETURN      
  End      
  IF Not Exists (Select * From CSyncStatus Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 1)      
 Begin      
  Truncate table CSyncStatus      
  Insert into CSyncStatus Select GETDATE(),0      
 End      
  Set @Code = (Select Top 1 HostName From Sys.sysprocesses where  status='RUNNABLE' Order By login_time desc)          
  IF ((SELECT Count(*) From SyncAttempt) < 1)          
   BEGIN          
    INSERT INTO SyncAttempt          
    SELECT @Code,1,Getdate()          
    SELECT 1          
   END           
  ELSE          
   BEGIN          
    IF (SELECT Status From SyncAttempt) = 0          
     BEGIN          
      UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
      SELECT 1          
     END          
    ELSE 
     BEGIN          
      IF ((SELECT DatedIFf(hh,StartTime,Getdate()) From SyncAttempt) > 1)          
       BEGIN          
          UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
          SELECT 1          
       END          
      ELSE          
        IF ((SELECT Count(*) From SyncAttempt WHERE IPAddress = @Code) = 1 )          
         BEGIN          
          UPDATE SyncAttempt SET Status = 1,StartTime = Getdate()           
          SELECT 1          
         END          
        ELSE          
         BEGIN          
          SELECT 0                   
         END          
     END          
   END            
 End          
 IF @TypeId = 4 -- Remove from Redownloadrequest,  Proc_SyncValidation   @TypeId          
 Begin          
  TRUNCATE TABLE ReDownLoadRequest          
 End          
 IF @TypeId = 5 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
   IF @Val1 = 1           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess='SyncProcess0' ORDER BY SyncProcess          
   End          
   IF @Val1 = 2           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess<>'SyncProcess0' ORDER BY SyncProcess          
   End          
 End          
 IF @TypeId = 6 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1           
   Begin          
    SELECT DISTINCT SlNo,SlNo AS SeqNo,Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count           
    FROM Customupdownload  ORDER BY  UpDownload Desc ,SlNo        
   End          
  IF @Val1 = 2           
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Upload'          
End          
  IF @Val1 = 3          
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Download'          
   End          
 End          
 IF @TypeId = 7 -- Sync Status Validation,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3          
 Begin          
  IF Exists(Select * from SyncStatus Where DistCode = @Code and SyncId = @Val2)              
   Begin          
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin       
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End          
       Else if @Val3 = 2-- Added on 2016-07-22  
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End       
     End             
   End              
  Else              
   Begin              
    Delete From SyncStatus Where DistCode = @Code and SyncStatus = 1        
    IF Not Exists (Select * From  SyncStatus (Nolock))      
    Begin        
  Insert into SyncStatus Select @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'      
    End              
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin              
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End       
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End         
     End             
   End            
 End          
 IF @TypeId = 8 -- Select Current SyncId,  Proc_SyncValidation   @TypeId          
 Begin          
	--Select IsNull(MAX(SyncId),0) From Sync_Master-- SyncStatus    
		Select Isnull(Syncid,0) From SyncStatus (Nolock)
 End           
 IF @TypeId = 9 -- Select Syncstatus for this SyncId,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin          
  Select IsNull(Max(SyncStatus),0) From SyncStatus where DistCode = @Code And syncid = @Val1 And SyncStatus = 1          
 End            
 IF @TypeId = 10 -- DB Restoration Concept,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
   Begin          
    Select Count(*) From DefendRestore          
   End           
  IF @Val1 = 2          
   Begin          
    update DefendRestore Set DbStatus = 1,ReqId = 1,CCLockStatus = 1          
   End             
  IF @Val1 = 3          
   Begin          
    Insert into DefendRestore (AccessCode,LastModDate,DbStatus,ReqId,CCLockStatus)      
    Values('',GETDATE(),1,1,1)          
   End           
 End             
 IF @TypeId = 11 -- AAD & Configuration Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId='BotreeSyncCheck'          
  End           
  IF @Val1 = 2          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId LIKE 'BotreeSyncErrLog'          
  End             
  IF @Val1 = 3          
  Begin          
   Select IsNull(Max(FixID),0) from Hotfixlog (NOLOCK)          
  End             
 End             
 IF @TypeId = 12 -- System Date is less than the Last Transaction Date Validation,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT ISNULL(MAX(TransDate),GETDATE()-1) AS TransDate FROM StockLedger          
 End           
 IF @TypeId = 13 -- DayEnd Process Updation,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  UPDATE DayEndProcess SET NextUpDate=@Code WHERE ProcId=13          
 End           
 IF @TypeId = 14 -- Update Sync Attempt Status ,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  Select @Code =  HostName From Sys.sysprocesses where  status='RUNNABLE'          
  Update SyncAttempt Set Status=0 where IPAddress = @Code          
 End            
 IF @TypeId = 15 -- Latest SyncId from Sync_Master ,  Proc_SyncValidation   @TypeId          
 Begin          
  --Select ISNull(Max(SyncId),0) From Sync_Master           
  IF Exists(Select * From SyncStatus (Nolock) Where SyncStatus = 1)      
  Begin      
   Select ISNull(Max(SyncId),0) From Sync_Master (Nolock)      
  End      
  Else      
  Begin      
   Select ISNull(Max(SyncId),0) From SyncStatus (Nolock)      
  End              
 End           
 IF @TypeId = 16 -- Update the Flag as Y for all lesser than the latest Serial No ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF ((Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N') > 0)              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo >=         
    (Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N')               
   End              
   Else              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val1 And SlNo <= @Val2       
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo > @Val2          
   End       
 End            
 IF @TypeId = 17 -- Record Count ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF @Val1 = 1           
  Begin          
   Select Count(*) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2 and UploadFlag = 'N'          
  End          
  IF @Val1 = 2           
  Begin          
   Select Count(Distinct Slno) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
  End             
  IF @Val1 = 3           
  Begin          
   --Select IsNull(Count(*),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
   Select IsNull(Count(Distinct Syncid),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
  End          
 End            
 IF @TypeId = 18 -- Datapreperation Process and Split each 1000 rows for xml file ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin        
 IF @Val1 = 1           
  Begin          
   SELECT * FROM  CustomUpDownload  WHERE SlNo=@Val2  AND UpDownload='Upload' ORDER BY UpDownLoad,SlNo,SeqNo          
  End          
  IF @Val1 = 2           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 3          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM  ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End              
  IF @Val1 = 4          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT * FROM  ' + Convert(Varchar(100),@Code) + ' WHERE  SlNo= ' + Convert(Varchar(100),@Val2) + '  ORDER BY UpDownLoad,SlNo,SeqNo '          
   Exec (@Sql)          
  End             
  IF @Val1 = 5          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + '  '          
   Exec (@Sql)          
  End           
  IF @Val1 = 6          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' DELETE  FROM   ' + Convert(Varchar(100),@Code) + ' WHERE Downloadflag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 7          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) FROM   ' + Convert(Varchar(100),@Code) + ' WHERE DownloadFlag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 8          
  Begin          
   Set @Sql = ''          
  Set @Sql = @Sql + ' SELECT TRowCount FROM Tbl_DownloadIntegration_Process WHERE PrkTableName =''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 9          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = 0  WHERE ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 10          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = ' + Convert(Varchar(100),@Val2) + ' where ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 11           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MAX(SlNo),0) AS Cnt FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 12           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End            
  IF @Val1 = 13           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 14           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Upload'' '          
   Exec (@Sql)          
  End               
  IF @Val1 = 15           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS DownloadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Download'' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 16           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''' And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 17           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus_Download (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''''-- And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 18      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
  Select @Sql      
 End       
  IF @Val1 = 19      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''X'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 20      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''Y'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 21      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''N'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End         
  IF @Val1 = 22      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE UploadFlag=''Y'' And  SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    --Exec (@Sql)        
    --SET @Sql = ''          
    SET @Sql = @Sql + 'UNION ALL SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    Exec (@Sql)           
 End         
  IF @Val1 = 23      
 Begin      
    SET @Sql = ''    
    --Added on 2018-01-09        
    --SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' ' 
    SET @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '         
    Exec (@Sql)           
 End        
 IF @Val1 = 24      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(DistCode) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' '      
    Exec (@Sql)           
 End       
 End            
 IF @TypeId = 19 -- View Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT * FROM ErrorLog WITH (NOLOCK)          
 End          
 IF @TypeId = 20 -- Remove Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  DELETE FROM ErrorLog           
 End           
 IF @TypeId = 21 -- Download Notification Details Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM  CustomUpDownloadCount WHERE UpDownload='Download' ORDER BY SlNo          
 End           
 IF @TypeId = 22 -- Download Details to xml file ,  Proc_SyncValidation   @TypeId          
Begin           
  SELECT * FROM Cs2Cn_Prk_DownloadedDetails WHERE UploadFlag='N'          
 End           
 IF @TypeId = 23 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_DownloadIntegration_Process ORDER BY SequenceNo          
End           
 IF @TypeId = 24 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_DownloadIntegration_Process SET TRowCount=0          
 End            
 IF @TypeId = 25 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_DownloadIntegration_Process WHERE ProcessName = @Code          
 End            
 IF @TypeId = 26 -- Upload Consolidated Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_UploadIntegration_Process ORDER BY SequenceNo          
 End            
 IF @TypeId = 27 -- Download Details   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT DISTINCT Module,DownloadedCount FROM CustomUpDownloadCount WHERE UpDownload='Download' AND DownloadedCount>0          
 End            
 IF @TypeId = 28 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeReDownload'          
 End           
 IF @TypeId = 29 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM ReDownLoadRequest         
 End           
 IF @TypeId = 30 -- Showboard    ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeBBOardOnSync' AND Status=1          
 End           
 IF @TypeId = 31 -- Update sync status if disconnect    ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin           
  IF Not Exists (Select * From CS2Console_Consolidated (nolock) Where DistCode = @Code And Syncid = @Val1 And UploadFlag='N')          
  Begin          
   Update Syncstatus Set Syncstatus = 1 Where DistCode = @Code And Syncid = @Val1          
   Select IsNull(Max(SyncStatus),0) From SyncStatus (nolock) Where DistCode = @Code And Syncid = @Val1          
  End          
 End           
 IF @TypeId = 32 -- Update sync status if disconnect,Proc_SyncValidation @TypeId,@Code,@Val1          
 Begin           
  Declare @RETVAL Varchar(Max)          
  Set @RETVAL = ''          
  IF EXISTS (Select * From Chk_MainSalesIMEIUploadCnt (NOLOCK))          
  Begin            
  Select @RETVAL = Cast(COALESCE(@RETVAL + ', ', '') + Convert(Varchar(40),MainTblBillNo) as ntext) From Chk_MainSalesIMEIUploadCnt             
  Select @RETVAL          
  End          
 End          
 IF @TypeId = 33 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select 'Request given for approval so please approve from Central Help Desk.'            
 End            
 IF @TypeId = 34 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select IsNull(LTrim(RTrim(CmpCode)),'') From Company (Nolock) Where DefaultCompany = 1            
 End            
 IF @TypeId = 35 -- Select Download Sync status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin             
  Select IsNull(SyncStatus,0) from Syncstatus_Download (nolock) Where Distcode = @Code and Syncid = @Val1          
 End            
 IF @TypeId = 36 -- Select Max(Syncid) in Download Sync Status  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SyncId),0) From SyncStatus_Download (Nolock)          
 End            
 IF @TypeId = 37 -- Select Max(SlNo) in Console2CS_Consolidated  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SlNo),0) From Console2CS_Consolidated (Nolock) Where Distcode = @Code and Syncid = @Val1          
 End             
 IF @TypeId = 38 -- Syncstatus  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
 Declare @RetState Int          
 Update CSyncStatus Set SyncStatus = 1 Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 0      
 IF Exists (Select * From SyncStatus (Nolock) where DistCode = @Code And syncid = @Val1 And SyncStatus = 1)          
  Begin          
 If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
  IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 1 -- Upload and Download Completed Successfully              
   End          
  Else          
   Begin          
    Set @RetState = 2 -- Upload Completed, Download Incomplete           
   End          
  End      
 Else      
  Begin      
  Set @RetState = 1 -- Upload and Download Completed Successfully       
  End      
  End          
  Else          
  Begin          
   If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
    IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully                
   End          
  Else          
   Begin          
    Set @RetState = 4 -- Upload and Download Incomplete!!!                 
   End          
  End      
 Else      
  Begin      
  Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully       
  End      
  End          
  Select @RetState          
 End             
 IF @TypeId = 39 -- Update Download Sync Status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3            
 Begin             
 -------          
  IF Exists(SELECT * FROM SyncStatus_Download WHERE DistCode = @Code and SyncId = @Val2)                      
   Begin          
    IF @Val1 = 1                      
    Begin                    
    If Exists (Select * from SyncStatus_Download(Nolock)  Where DistCode = @Code and SyncId = @Val2 And SyncStatus =1 And SyncFlag =0) --Added on 2016-10-04             
    Begin    
     IF Exists(SELECT * FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag Not in ('N','D'))  --Added on 2016-07-25             
     Begin              
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag ='Y'              
     End     
   End            
   else     
   Begin    
  DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2        
   End       
     --Update SyncStatus_Download Set SyncStatus=0,SyncFlag=0 Where DistCode = @Code and SyncId = @Val2   -- Added to Parameter S             
     UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
     --IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)                
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin                
        If @Val3 > 0 -- Added on 2016-07-25      
  Begin            
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2         
  End                 
      End              
     End                   
   End                      
  Else                      
   Begin                      
    INSERT INTO SyncStatus_Download_Archieve  SELECT *,Getdate() FROM SyncStatus_Download WHERE DistCode = @Code                 
    DELETE FROM SyncStatus_Download WHERE DistCode = @Code        
  --  INSERT INTO SyncStatus_Download SELECT @Code,@Val2,Getdate(),Getdate(),0,0      
    -----------Added on 2016-07-25-------------      
 if  @Val3 = 0      
 Begin      
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),1,1                      
 End      
 Else      
 Begin                  
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),0,0                      
 End        
 -----------Added on 2016-07-25-------------        
    INSERT INTO SyncStatus_Download_Archieve SELECT @Code,@Val2,Getdate(),Getdate(),0,0,GETDATE()                       
    IF @Val1 = 1                      
    Begin                      
    UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
--     IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)      
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin       
       IF @Val3 > 0 -- Added on 2016-07-25      
  BEGIN                
   DELETE A FROM Console2CS_Consolidated A (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2                   
  END       
      End               
     End                   
   End            
 ------          
 END      
  IF @TypeId = 40 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_Customdownloadintegration ORDER BY SequenceNo          
 End           
 IF @TypeId = 41 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_Customdownloadintegration SET TRowCount=0          
 End       
 IF @TypeId = 42 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_Downloadintegration WHERE ProcessName = @Code          
 End       
 IF @TypeId = 43 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT TRowCount FROM Tbl_Customdownloadintegration WHERE PrkTableName = @Code          
 End       
 IF @TypeId = 44 -- Download Process   ,  Proc_SyncValidation   @TypeId   
 Begin           
  Update Tbl_Customdownloadintegration Set TRowCount = @Val1 WHERE ProcessName = @Code          
 End       
 IF @TypeId = 45 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId        
 Begin         
 Set @IntRetVal = 0        
 IF @Val1 = 1      
 Begin      
  If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')        
   Begin        
    IF Exists (Select * from UtilityProcess where ProcId = 3)        
    Begin        
     IF ((Select Convert(Varchar(100),VersionId) from UtilityProcess where ProcId = 3) <> @Code)        
     Begin        
   Set @IntRetVal = 1            
     End           
    End        
   End        
 End         
 IF @Val1 = 2      
 Begin      
  If Not Exists (Select * From AppTitle (Nolock) Where  SynVersion = @Code)        
   Begin        
   Set @IntRetVal = 1      
   End      
 End      
 Select @IntRetVal       
 End         
 IF @TypeId = 46 -- Data Purge  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 IF Exists (Select * From Sys.objects Where name = 'DataPurgeDetails' and TYPE='U')      
 Begin      
  IF EXISTS (Select * From DataPurgeDetails)      
  Begin      
   Set @IntRetVal = 0      
  End      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 47 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 --IF Exists (Select * From Sys.objects Where name = 'Distributor' and TYPE='U')      
 --Begin      
 -- Update Distributor Set DistStatus = 0 Where DistributorCode = @Code      
 --End      
 End      
 IF @TypeId = 48 -- Unregistered Database  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0      
 IF Not Exists (Select * From SyncStatus (Nolock))      
 Begin      
  Set @IntRetVal = 1 -- Unregistered Database      
 End      
 Else      
 Begin      
  IF Exists (Select * From SyncStatus (Nolock) Where DistCode Is Null or DistCode = '')      
  Begin      
   Set @IntRetVal = 2 -- Distributor Code is not found      
  End      
 End      
 IF (@IntRetVal > 0)      
 Begin      
  Select @IntRetVal      
  RETURN      
 End      
 IF Not Exists (Select * from SyncStatus (Nolock) where SyncId = 0)      
 Begin      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
   IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
   Begin      
    SET @IntRetVal = 3        
   End      
  End      
 End      
 Else      
 Begin      
  SET @IntRetVal = 4      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 49 -- DB Restoration  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0       
 --If Exists (Select * From Cs2Cn_Prk_DBUnlockDetails (Nolock) Where DistCode = @Code And DBUnlockStatus > 0)      
 --Begin      
 -- Set @IntRetVal = 1      
 --End      
 If Exists (Select * From DefendRestore (Nolock) Where ReqId > 0)      
 Begin      
  Set @IntRetVal = 1      
 End       
 Select @IntRetVal      
 End       
 IF @TypeId = 50 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 BEGIN          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER47') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId         
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45','DATATRANSFER48') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId           
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer'  And Description ='Upload Path' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  And Description ='Download Path' 
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId 
 END       
 IF @TypeId = 51 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_UploadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End      
 IF @TypeId = 52 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @Sql = ''      
 Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
 Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
 Print (@Sql)      
 Exec (@Sql)      
 End       
 IF @TypeId = 53 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin      
 Select * From Tbl_DownloadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End       
 IF @TypeId = 54   -- Added on 2016-07-23 for Partial data upload         
 Begin                
 IF @Val1 = 1                   
 Begin                  
  Select Count(1) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
 End                  
 IF @Val1 = 2          
 Begin                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End     
  IF @Val1 = 3          
 Begin            
 Update SyncStatus Set SyncStatus = 0, SyncFlag ='N' where DistCode = @Code and SyncId = @Val2                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End           
 End        
 IF @TypeId = 55   -- Added on 2016-08-31 for Auto Quick Sync       
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'AutoQuickSync'      
 End      
 IF @TypeId = 56   -- Added on 2016-08-31 for SyncExe Minimized Mode        
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncExeMinimized'      
 End      
 IF @TypeId = 57   -- Added on 2016-08-31 for SuccessMsgShow      
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SuccessMsgShow'      
 End      
  IF @TypeId = 58    
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PartialUploadDataDelete'      
 End      
 IF @TypeId = 59     
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterAfterDeploy'      
 End  
 IF @TypeId = 60         
 Begin              
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'HotFixMsg'          
 End  
  IF @TypeId = 61          
 Begin              
	Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterHotfixId'          
 End
IF @TypeId = 62            
	Begin              
		Select Isnull(Max(fixid),0) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog)      
	End
IF @TypeId = 63          
	Begin   
		IF @Val1 = 1 
		Begin            
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncVersionInUI'     
		End
		IF @Val1 = 2
		Begin          
			If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')            
			Begin 
				IF Exists (Select * from UtilityProcess where ProcId = 3)            
				Begin            
					Select ISNULL(Versionid,'') from UtilityProcess where ProcId = 3
				End
			End
		End           
	End
 --Added By Lakshman M dated on 12-02-2018
IF @TypeId = 64  
Begin  
 Insert into SyncErrorDetails    
 (  
  Module, 	
  ProcessName,  
  ErrorMsg,  
  CreatedDate,  
  ServerDate  
 )   
 Values   
 (  
  @Val4,  
  @Val5, 
  @Val6, 
  GetDate(),  
  CONVERT(DateTime, @Val7, 121)  
 )  
End  
------------------Added by lakshman M dated ON 30-12-2019 PMS ID:  ILCRSTPAR7202
IF @TypeId = 65             
Begin              
	IF @Val1 = 1               
	Begin              
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'WriteAutoDeploymentStatus'         
	End    
	IF @Val1 = 2
	Begin  
			IF NOT EXISTS (SELECT '*' FROM MandatoryDeployment WHERE HFixID = @Val2)
			BEGIN
				Insert into MandatoryDeployment    
				(  
					HFixID,
					ManualStatus,
					MantatoryStatus, 
					FileDownloaded,
					DeploymentSatus,
					CreateDate     
				)   
				Values   
				(  
					@Val2,  
					0, 
					1, 
					0,  
					0,
					getdate() 
				) 
			END	
		END 
	END 
	IF @TypeId = 66         
	BEGIN    
		Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'LoginOCXReg'
	END  
	IF @TypeId = 67    
	BEGIN       
		IF @Val1 = 1     
		BEGIN      
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSAutoNClose'         
		END    
		IF @Val1 = 2    
		BEGIN    
			Select Substring(ProcessName,0,CHARINDEX('.Exe',ProcessName))  from UtilityProcess (Nolock) Where ProcId = 1
		END        
	END  
	IF @TypeId = 68    
	BEGIN       
		IF @Val1 = 1     
		BEGIN      
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'CSTimer Enable'         
		END  
		IF @Val1 = 2     
		BEGIN      
			Select isNull(syncID,0) From syncStatus (Nolock) Where DistCode = @Code        
		END    
		IF @Val1 = 3     
		BEGIN      
			Select convert(varchar(25),GETDATE(),121)     
		END    
	END 
	IF @TypeId = 69
	BEGIN  
		IF @Val1 = 1  
		BEGIN
			If Exists (select * from SyncStatus (Nolock))
			BEGIN
				Insert into tbl_SyncDetails  
				(
					[UploadSyncID],
					[SyncStartTime],
					SyncENDTime,
					Remarks,
					SyncStatusRemarks,
					SFlag,
					UploadFlag
				)
				Select 
					SyncId,
					GETDATE(),
					GETDATE(),
					Case @Val2  When 0 Then 'Internet Connectivity Issue' Else '' END As Remarks,
					Case @Val2 When 0 then 'InComplete' When 1 Then 'Complete' END As SyncStatusRemarks ,
					0, 
					'N'
				from 
					SyncStatus (Nolock)
			END
		END	

		IF @Val1 = 2
		BEGIN
			Update tbl_SyncDetails Set 	SyncENDTime = GETDATE(), SFlag = 1 Where SFlag = 0
		END
	END
	IF @TypeId = 70
	BEGIN  
		If @Val1 = 1
		Begin
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PDAExecuteAfterSync'   
		End
		If @Val1 = 2
		Begin
			--Select Distinct ProcessName  from UtilityProcess (Nolock) Where ProcessName like 'PDA%'
			  Select Distinct ProcessName  from UtilityProcess (Nolock) Where ProcessName ='Parle_SFAIntegration.Exe'
		End
	END
	IF @TypeId = 71
	BEGIN  
		If @Val1 = 1
		BEGIN  
			Select ISNULL (SyncId,0) As SyncId, ISNULL (SyncStatus,0) As SyncStatus from SyncStatus (Nolock)
		END	

		If @Val1 = 2
		BEGIN  
			Truncate table DefENDRestore
		END	
	END 

	IF @TypeId = 72  -- ILCONSAML4923
	BEGIN  
		Declare @HostName As Varchar(50)

		If @Val1 = 1
		BEGIN  
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ClrSyncAttempt'   
		END	
		If @Val1 = 2
		BEGIN  
			Set @HostName = (Select Distinct  Top 1 HostName From Sys.sysprocesses Where LTrim(PROGRAM_NAME) ='.Net SqlClient Data Provider')
			If Exists (Select * from SyncAttempt Where IPAddress = @Code And IPAddress = @HostName)
			BEGIN 
				Select 0
			END
			Else
			BEGIN
				Insert into SyncAttempt_Archieve
				Select *, GETDATE() from SyncAttempt
				Delete from SyncAttempt--  Where IPAddress = @Code
				INSERT INTO SyncAttempt    
				SELECT @HostName,1,Getdate()    
				Select 1

			END
		END	
	END 

	IF @TypeId = 73    -- ILCONSAML4924
	BEGIN       
		IF @Val1 = 1     
		BEGIN   
			SELECT DISTINCT Setting FROM Tbl_syncConfiguration WHERE Processname = 'ValidationTrace'         
		END  
		IF @Val1 = 2     
		BEGIN      
			IF NOT EXISTS (SELECT * FROM SyncValidation_Summary(NOLOCK) WHERE  UploadSyncid = @Val3)
			BEGIN
				INSERT INTO SyncValidation_Summary 
				SELECT @Code, @Val2, GETDATE(),GETDATE(),@Val3,GETDATE(),'D'
			END	
			ELSE
			BEGIN
				UPDATE A SET VENDTime = GETDATE (), UploadFlag ='N' FROM SyncValidation_Summary A (NOLOCK) WHERE UploadSyncid = @Val3
				IF NOT EXISTS (SELECT * FROM SyncValidation_Details(NOLOCK) WHERE  UploadSyncid = @Val3 AND Processname  = @Val4)
				BEGIN
					INSERT INTO SyncValidation_Details
					SELECT @Code , @Val2 ,@Val4, GETDATE(),GETDATE (),@Val3,@Val5,GetDate()
				END
				ELSE
				BEGIN
					UPDATE A SET VENDTime = GETDATE () FROM SyncValidation_Details A (NOLOCK) WHERE UploadSyncid = @Val3 And Processname = @Val4
				END	
			END
		END    
		IF @Val1 = 3
		BEGIN   
			SELECT ISNULL(MAX(Syncid),0) FROM SyncStatus (Nolock)
			SELECT ISNULL(MAX(Syncid),0) FROM SyncStatus_Download (Nolock)
			Set @Sql = ''    
			Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + ' (NOLOCK) WHERE DownloadFlag IN (''N'',''D'')  '    
			Print(@Sql) 
			Exec (@Sql)    
		END  

	END 
COMMIT TRANSACTION          
END TRY          
BEGIN CATCH          
ROLLBACK TRANSACTION       
INSERT INTO Sync_ErrorLog VALUES ('Proc_SyncValidation', ERROR_MESSAGE(), GETDATE())             
END CATCH          
--till Here  
----------Additional Validation----------              
END
GO
---SCHEME ISSUE
IF NOT  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TBL_TableUpdateHistorty]') AND type in (N'U'))
BEGIN
CREATE TABLE TBL_TableUpdateHistorty
(
    EventDate    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    EventType    NVARCHAR(64),
    EventDDL     NVARCHAR(MAX),
    EventXML     XML,
    DatabaseName NVARCHAR(255),
    SchemaName   NVARCHAR(255),
    ObjectName   NVARCHAR(255),
    HostName     VARCHAR(64),
    IPAddress    VARCHAR(32),
    ProgramName  NVARCHAR(255),
    LoginName    NVARCHAR(255)
)
END
GO
IF EXISTS (SELECT NAME FROM SysObjects WHERE XTYPE='TR' AND name='Trigger_TBL_TableDDLHistorty')
DROP TRIGGER Trigger_TBL_TableDDLHistorty
GO
--create trigger to capture the update on table_name
CREATE TRIGGER Trigger_TBL_TableDDLHistorty
    ON SchemeSlabs
    After update 
AS
/***********************************************************************************************************************
* FUNCTION: Trigger_TBL_TableDDLHistorty
* PURPOSE:  
* NOTES:
* CREATED:  
* MODIFIED
* DATE			AUTHOR				USERSTORYID            CR/BZ        DESCRIPTION
---------------------------------------------------------------------------------------------------------------------------
* 18/11/2019     Bharaneedhar	       ILCRSTGCP4323 		   PMS		     Scheme % changed in G1
******************************************************************************************************************************/
BEGIN

    SET NOCOUNT ON;
    DECLARE
        @EventData XML = EVENTDATA();
 
    DECLARE 
        @ip VARCHAR(32) =
        (
            SELECT client_net_address
                FROM sys.dm_exec_connections
                WHERE session_id = @@SPID
        );
 
    INSERT TBL_TableUpdateHistorty
    (
        EventType,
        EventDDL,
        EventXML,
        DatabaseName,
        SchemaName,
        ObjectName,
        HostName,
        IPAddress,
        ProgramName,
        LoginName
    )
    SELECT
        @EventData.value('(/EVENT_INSTANCE/EventType)[1]',   'NVARCHAR(100)'), 
        @EventData.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'NVARCHAR(MAX)'),
        @EventData,
        DB_NAME(),
        @EventData.value('(/EVENT_INSTANCE/SchemaName)[1]',  'NVARCHAR(255)'), 
        @EventData.value('(/EVENT_INSTANCE/ObjectName)[1]',  'NVARCHAR(255)'),
        HOST_NAME(),
        @ip,
        PROGRAM_NAME(),
        SUSER_SNAME();
END
GO
IF EXISTS (SELECT NAME FROM SysObjects WHERE XTYPE='TR' AND name='Trigger_TBL_TableDDLHistortySchPrd')
DROP TRIGGER Trigger_TBL_TableDDLHistortySchPrd
GO
--Trigger to capture the update on SCHEMEPRODUCTS
CREATE TRIGGER Trigger_TBL_TableDDLHistortySchPrd
    ON SchemeProducts
    After update 
AS
BEGIN

    SET NOCOUNT ON;
    DECLARE
        @EventData XML = EVENTDATA();
 
    DECLARE 
        @ip VARCHAR(32) =
        (
            SELECT client_net_address
                FROM sys.dm_exec_connections
                WHERE session_id = @@SPID
        );
 
    INSERT TBL_TableUpdateHistorty
    (
        EventType,
        EventDDL,
        EventXML,
        DatabaseName,
        SchemaName,
        ObjectName,
        HostName,
        IPAddress,
        ProgramName,
        LoginName
    )
    SELECT
        @EventData.value('(/EVENT_INSTANCE/EventType)[1]',   'NVARCHAR(100)'), 
        @EventData.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'NVARCHAR(MAX)'),
        @EventData,
        DB_NAME(),
        @EventData.value('(/EVENT_INSTANCE/SchemaName)[1]',  'NVARCHAR(255)'), 
        @EventData.value('(/EVENT_INSTANCE/ObjectName)[1]',  'NVARCHAR(255)'),
        HOST_NAME(),
        @ip,
        PROGRAM_NAME(),
        SUSER_SNAME();

END
GO
IF EXISTS (SELECT NAME FROM SysObjects WHERE XTYPE='TR' AND name='Trigger_TBL_TableDDLHistortyErrSchslb')
DROP TRIGGER Trigger_TBL_TableDDLHistortyErrSchslb
GO
CREATE TRIGGER Trigger_TBL_TableDDLHistortyErrSchslb
    ON [dbo].[SchemeSlabs]
    INSTEAD OF update 
AS
BEGIN
    SET NOCOUNT ON;   
    RAISERROR('Update not allowed', 20, -1) with log;		
END
GO
IF EXISTS (SELECT NAME FROM SysObjects WHERE XTYPE='TR' AND name='Trigger_TBL_TableDDLHistortyErrSchPrd')
DROP TRIGGER Trigger_TBL_TableDDLHistortyErrSchPrd
GO
CREATE TRIGGER [dbo].[Trigger_TBL_TableDDLHistortyErrSchPrd]
    ON [dbo].[SchemeProducts]
    INSTEAD OF update 
AS
BEGIN
    SET NOCOUNT ON;   
    RAISERROR('Update not allowed', 20, -1) with log;		
END
GO
IF NOT EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Mark_Out_Sl')
BEGIN
CREATE TABLE Mark_Out_Sl
(
[SchId] [int] NOT NULL,
[SlabId] [int] NOT NULL,
[PurQty] [numeric](18, 4) NOT NULL,
[FromQty] [numeric](18, 4) NOT NULL,
[UomId] [int] NOT NULL,
[ToQty] [numeric](18, 4) NOT NULL,
[ToUomId] [int] NOT NULL,
[ForEveryQty] [numeric](18, 4) NOT NULL,
[ForEveryUomId] [int] NOT NULL,
[DiscPer] [numeric](5, 2) NOT NULL,
[FlatAmt] [numeric](18, 4) NOT NULL,
[FlxDisc] [tinyint] NOT NULL,
[FlxValueDisc] [tinyint] NOT NULL,
[FlxFreePrd] [tinyint] NOT NULL,
[FlxGiftPrd] [tinyint] NOT NULL,
[FlxPoints] [tinyint] NOT NULL,
[Points] [numeric](15, 0) NOT NULL,
[MaxDiscount] [numeric](18, 2) NOT NULL,
[MinDiscount] [numeric](18, 2) NOT NULL,
[MaxValue] [numeric](18, 2) NOT NULL,
[MinValue] [numeric](18, 2) NOT NULL,
[MaxPoints] [int] NOT NULL,
[MinPoints] [int] NOT NULL,
[Availability] [tinyint] NOT NULL,
[LastModBy] [tinyint] NOT NULL,
[LastModDate] [datetime] NOT NULL,
[AuthId] [tinyint] NOT NULL,
[AuthDate] [datetime] NOT NULL,
[RetailerCap] [numeric](18, 2) NULL,
[CmpSchCode] [Nvarchar](200)
)
END
GO
IF NOT EXISTS(SELECT * FROM SYS.indexes WHERE name='IDX_Mark_Out_Sl_SchIdSlabId')
BEGIN
CREATE CLUSTERED INDEX IDX_Mark_Out_Sl_SchIdSlabId
ON Mark_Out_Sl(SchId,SlabId)
END
GO
--IF NOT EXISTS(SELECT * FROM SYSCOLUMNS WHERE NAME='CmpSchCode' AND ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='Mark_Out_Sl' AND XTYPE='U'))
--BEGIN
--ALTER TABLE Mark_Out_Sl ADD CmpSchCode  Nvarchar(200)
--END
--GO
--UPDATE B set CmpSchCode=A.CmpSchCode FROM SchemeMaster A INNER JOIN Mark_Out_Sl B ON A.SchId=B.SchId  where B.CmpSchCode Is null
--GO
--IF NOT EXISTS(SELECT * FROM Mark_Out_Sl (NOLOCK))
--BEGIN
--	INSERT INTO Mark_Out_Sl (SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,ForEveryUomId,
--	DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
--	Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,
--	Availability,LastModBy,LastModDate,AuthId,AuthDate,[RetailerCap],CmpSchCode) --,NoofLines,PurchaseValue) 
--	SELECT A.SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,ForEveryUomId,
--	DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
--	Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,
--	A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate,A.[RetailerCap],SM.CmpSchCode --,NoofLines,PurchaseValue
--	FROM SchemeMaster SM (NOLOCK)
--	INNER JOIN SchemeSlabs A ON SM.SchId=A.SchId 
--	WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN SchValidFrom AND SchValidTill
--END
--GO
--IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='TR' AND NAME='Tr_SalbInsertTrack')
--DROP TRIGGER Tr_SalbInsertTrack
--GO
--CREATE TRIGGER [Tr_SalbInsertTrack]
--ON [SchemeSlabs]
--AFTER INSERT
--AS
--/*********************************
--* TRIGGER	: Tr_SalbInsertTrack
--* PURPOSE	: To Track the slab details
--* CREATED	: Murugan.R
--* CREATED DATE	: 21/11/2019
--* NOTE		: 
--* MODIFIED
---------------------------------------------------------
--* {date}		{developer}			CR/BZ		USER STORY ID								{brief modification description}
--* 21-11-2019	Murugan.R			CR										
--*********************************/
--BEGIN
--	PRINT 'G'
--	INSERT INTO Mark_Out_Sl (SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,ForEveryUomId,
--	DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
--	Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,
--	Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpSchCode) --,NoofLines,PurchaseValue) 
--	SELECT A.SchId,SlabId,PurQty,FromQty,UomId,ToQty,ToUomId,ForEveryQty,ForEveryUomId,
--	DiscPer,FlatAmt,FlxDisc,FlxValueDisc,FlxFreePrd,FlxGiftPrd,FlxPoints,
--	Points,MaxDiscount,MinDiscount,MaxValue,MinValue,MaxPoints,MinPoints,
--	A.Availability,A.LastModBy,A.LastModDate,A.AuthId,A.AuthDate,SM.CmpSchCode --,NoofLines,PurchaseValue
--	FROM INSERTED A INNER JOIN SchemeMaster SM (Nolock) ON SM.SchId=A.SchId 
--	WHERE NOT EXISTS(SELECT SchId FROM Mark_Out_Sl B WHERE A.SchId=B.SchId and A.Slabid=B.SlabId and SM.CmpSchCode=B.CmpSchCode)
--END
--GO
IF NOT EXISTS (SELECT * FROM Sysobjects Where name='MarkOut_SI_Console' and XTYPE='U')
BEGIN
CREATE TABLE MarkOut_SI_Console
(
 CmpSchcode Nvarchar(200),
 SchemeCode Nvarchar(200),
 Slabid INT,
 BillDate   Datetime,
 CSLoginDate Datetime,
 CSLoginDateTime Datetime,
 SysServerDate Datetime,
 ErrorMessage Varchar(500),
 Upload INT
)
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Proc_ReturnMarkOutBilling' and XTYPE='P')
DROP PROCEDURE Proc_ReturnMarkOutBilling
GO
CREATE PROCEDURE Proc_ReturnMarkOutBilling
(
	@Pi_ServerDateTime DATETIME,
	@Pi_ServerDate DATETIME,
	@Pi_BillDate Datetime,
	@Pi_Mode  INT,
	@Pi_TransId INT,
	@Pi_OutError TINYINT OUTPUT,
	@Pi_OutMessage Varchar(2000) OUTPUT
)
AS
BEGIN
    SET @Pi_OutError=0
	SET @Pi_OutMessage=''
	
	RETURN
	
	DELETE FROM MarkOut_SI_Console WHERE Upload=1
	
	IF EXISTS(SELECT 'X' FROM SchemeSlabs A (NOLOCK) 
	INNER JOIN Mark_Out_Sl B (NOLOCK) ON A.SchId=B.SchId AND A.SlabId=B.SlabId
	INNER JOIN SchemeMaster C (NOLOCK) ON A.SchId=C.SchId  AND B.SchId=C.SchId AND B.CmpSchCode=C.CmpSchCode
	and C.SchStatus=1
	WHERE  (A.DiscPer<>B.DiscPer OR A.FlatAmt<>B.FlatAmt
	OR A.PurQty<>B.PurQty OR A.FromQty<>B.FromQty 
	OR A.ToQty<>B.ToQty OR A.ForEveryQty<>B.ForEveryQty
	OR A.UomId<>B.UomId OR A.ToUomId<>B.ToUomId
	OR A.ForEveryUomId<>B.ForEveryUomId)
	AND @Pi_BillDate Between SchValidFrom and SchValidTill)
	BEGIN
	    
	    
	    INSERT INTO MarkOut_SI_Console(CmpSchcode,SchemeCode,Slabid,BillDate,CSLoginDate,CSLoginDateTime,
	    SysServerDate,ErrorMessage,Upload)
	    SELECT Distinct C.CmpSchcode,SchCode,A.Slabid,@Pi_BillDate,@Pi_ServerDate,@Pi_ServerDateTime,GETDATE(),
	    'Scheme slab mismatch available,Cannot Continue Billing...',0 FROM SchemeSlabs A (NOLOCK) 
			INNER JOIN Mark_Out_Sl B (NOLOCK) ON A.SchId=B.SchId AND A.SlabId=B.SlabId
			INNER JOIN SchemeMaster C (NOLOCK) ON A.SchId=C.SchId  AND B.SchId=C.SchId AND B.CmpSchCode=C.CmpSchCode
			and C.SchStatus=1
			WHERE  (A.DiscPer<>B.DiscPer OR A.FlatAmt<>B.FlatAmt
			OR A.PurQty<>B.PurQty OR A.FromQty<>B.FromQty 
			OR A.ToQty<>B.ToQty OR A.ForEveryQty<>B.ForEveryQty
			OR A.UomId<>B.UomId OR A.ToUomId<>B.ToUomId
			OR A.ForEveryUomId<>B.ForEveryUomId)
			AND @Pi_BillDate Between SchValidFrom and SchValidTill 
			AND C.SchCode+'~'+ CAST(A.Slabid AS Varchar(10)) Not In (SELECT SchemeCode+'~'+CAST(Slabid AS Varchar(10)) from MarkOut_SI_Console Where Upload=0)
	         
	         SET @Pi_OutError=1
	         If @Pi_TransId<>1000
	          BEGIN
					   If @Pi_Mode=2
						BEGIN
						 SET @Pi_OutMessage='Scheme Slabs Tampered.Cannot Continue Billing'
					   END
					   ELSE
					   BEGIN
						SET @Pi_OutMessage='Scheme Slabs Tampered.Cannot Continue Billing'
					   END
			 END
			 ELSE
			 BEGIN
			       SET @Pi_OutMessage='Scheme Slabs Tampered.Cannot Continue Billing'
			 END
	END
						
	Select @Pi_OutMessage

END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Cs2Cn_Prk_SchemeTampered' and XTYPE='U')
DROP TABLE Cs2Cn_Prk_SchemeTampered
GO
CREATE TABLE Cs2Cn_Prk_SchemeTampered
(
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[CmpSchCode] [nvarchar](200) NULL,
	[DistSchemeCode] [nvarchar](200) NULL,
	[SlabId] [Int],
	[BillDate] [Datetime],
	[CsLoginDate] [Datetime],
	[ErrorMessage] [Nvarchar](4000),
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime]
)
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Proc_Cs2Cn_SchemeTampered' and XTYPE='P')
DROP PROCEDURE Proc_Cs2Cn_SchemeTampered
GO
/*
  BEGIN TRANSACTION
  EXEC Proc_Cs2Cn_SchemeTampered 0,'2018-07-05'
  SELECT * FROM Cs2Cn_Prk_SchemeTampered (NOLOCK)
  ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2Cn_SchemeTampered
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_SchemeTampered
* PURPOSE		: Upload the Rural/Urban ROI Claim
* CREATED BY	: Gopi
* CREATED DATE	: 05/07/2019
* NOTE			: 
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* DATE          AUTHOR          CR/BZ	USER STORY ID      DESCRIPTION					
******************************************************************************************
* 05/07/2019    Gopi			CR      CRCRSTMRC0139     Upload the Rural/Urban ROI Claim
*****************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @DistCode NVARCHAR(50)
	DECLARE @DistName NVARCHAR(100)	
	
	DELETE FROM Cs2Cn_Prk_SchemeTampered WHERE UPLOADFLAG='Y'
	
	SET @Po_ErrNo=0
	
	SELECT @DistCode=DistributorCode,@DistName=DistributorName FROM Distributor
	
	
	INSERT INTO Cs2Cn_Prk_SchemeTampered(DistCode,CmpSchcode,DistSchemeCode,Slabid,BillDate,CSLoginDate,ErrorMessage,UploadFlag,ServerDate)
	SELECT Distinct @DistCode,CmpSchcode,SchemeCode,Slabid,BillDate,CSLoginDateTime,ErrorMessage,'N',@ServerDate  
	FROM MarkOut_SI_Console(Nolock) Where Upload=0
	
	UPDATE MarkOut_SI_Console SET Upload=1 where SchemeCode In (SELECT DistSchemeCode FROM Cs2Cn_Prk_SchemeTampered)
	
END
GO
--Scrpit Updater Scrpits
IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel3')            
DROP TABLE RptDebitNoteTopSheet_Excel3
GO
CREATE TABLE RptDebitNoteTopSheet_Excel3      
(      
	[Name Of the Category] NVARCHAR(200),      
	[From] VARCHAR(12),      
	[TO] VARCHAR(12),      
	[Total Normal Amount] NUMERIC(18,2),      
	[Total Normal Sec Sales AS Per TOT] NUMERIC(18,2),    ------------ column name altered by lakshman M Dated On 30-04-2019 PMS ID: ILCRSTPAR4224  
	[TOT Diff claims] NUMERIC(18,2)       
)
GO
IF NOT EXISTS (SELECT * FROM sysobjects WHERE Name = 'SyncAttempt' AND Xtype = 'U')
BEGIN
CREATE TABLE SyncAttempt(
	[IPAddress] [varchar](300) NULL,
	[Status] [int] NULL,
	[StartTime] [datetime] NULL
) ON [PRIMARY]
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='DelEtlTempPurchaseReceipt' and XTYPE='U')
CREATE TABLE DelEtlTempPurchaseReceipt
(
	CmpInvNo	NVARCHAR(300),
	InvDate		DATETIME,
	DelDate		DATETIME,
	DelSts		BIT
)
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_EtlPurchase' and XTYPE='P')
DROP PROC Proc_EtlPurchase
GO
CREATE PROC Proc_EtlPurchase
AS
BEGIN
	DECLARE		@TodayDate	DATETIME
	DECLARE @DelEtlPurchase TABLE 
	(
		CmpInvNo	NVARCHAR(300),
		InvDate		DATETIME,
		DelDate		DATETIME,
		DelSts		BIT
	)
	Set @TodayDate = Convert(NVarchar(10),getdate(),121)
	IF EXISTS(SELECT * FROM ETLTempPurchaseReceipt WHERE DownloadStatus=0 and DATEDIFF(DD,INVdate,@TodayDate)>30)
	Begin
		--> Purchase Selection below 10 days
		INSERT INTO @DelEtlPurchase 
		SELECT CmpInvNo,InvDate,@TodayDate,0 DelSts FROM ETLTempPurchaseReceipt WHERE DownloadStatus=0 and DATEDIFF(DD,INVdate,@TodayDate)>30
		--<-- Till here

		-- > Delete from Etl tables
		DELETE FROM ETLTempPurchaseReceipt WHERE EXISTS( SELECT * FROM @DelEtlPurchase B WHERE  ETLTempPurchaseReceipt.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseReceiptProduct  WHERE EXISTS (SELECT * FROM @DelEtlPurchase B WHERE  ETLTempPurchaseReceiptProduct.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseReceiptPrdLineDt  WHERE EXISTS ( SELECT * FROM @DelEtlPurchase B WHERE  ETLTempPurchaseReceiptPrdLineDt.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseReceiptClaimScheme  WHERE EXISTS (SELECT * FROM @DelEtlPurchase B WHERE  ETLTempPurchaseReceiptClaimScheme.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments  WHERE EXISTS (SELECT * FROM @DelEtlPurchase B Where  ETLTempPurchaseReceiptCrDbAdjustments.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseReceiptOtherCharges  WHERE EXISTS  (SELECT * FROM @DelEtlPurchase B Where  ETLTempPurchaseReceiptOtherCharges.Cmpinvno = B.Cmpinvno)
		DELETE FROM ETLTempPurchaseFreeProduct  WHERE EXISTS  (SELECT * FROM @DelEtlPurchase B Where  ETLTempPurchaseFreeProduct.Cmpinvno = B.Cmpinvno)
		-- < -- Till here
		
				
		INSERT INTO DelEtlTempPurchaseReceipt
		SELECT * FROM @DelEtlPurchase

		UPDATE A SET A.Delsts=1  from DelEtlTempPurchaseReceipt A INNER JOIN @DelEtlPurchase B
		ON A.CmpInvNo = B.CmpInvNo and A.InvDate= B.InvDate
		
	END
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SpecialRateAftDownLoad_Calc]') AND type in (N'U'))
BEGIN
	CREATE TABLE [dbo].[SpecialRateAftDownLoad_Calc](
		[RtrCtgCode] [nvarchar](100) NULL,
		[RtrCtgValueCode] [nvarchar](100) NULL,
		[RtrCode] [nvarchar](100) NULL,
		[PrdCCode] [nvarchar](100) NULL,
		[PrdBatCCode] [nvarchar](100) NULL,
		[SplSelRate] [numeric](38, 6) NULL,
		[FromDate] [datetime] NULL,
		[CreatedDate] [datetime] NULL,
		[DownloadedDate] [datetime] NULL,
		[ContractPriceIds] [nvarchar](1000) NULL,
		[ConSplSelRate] [numeric](18, 6) NULL,
		[DiscountPerc] [numeric](18, 6) NULL,
		[SplrateId] [int] NULL,
		[ApplyOn] [tinyint] NULL,
		[TYPE] [int] NULL
	)
END
GO
IF EXISTS (SELECT * FROM SYS.OBjects WHERE Name='SyncTrack' AND type='U')
DROP TABLE SyncTrack
GO
CREATE Table SyncTrack
(
Distcode Nvarchar(100),
Syncid INT
)
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME='Debitnote_Scheme' AND TYPE ='U')
BEGIN
	CREATE TABLE Debitnote_Scheme
	(
		[SchId] [int] NULL,
		[SlabId] [int] NULL,
		[Salid] [int] NULL,
		[FlatAmount] [numeric](38, 6) NULL,
		[DiscountPer] [numeric](38, 6) NULL,
		[FreeValue] [numeric](38, 6) NULL,
		[GiftValue] [numeric](38, 6) NULL,
		[SchemeBudget] [numeric](38, 6) NULL,
		[BudgetUtilized] [numeric](38, 6) NULL,
		[Selected] [int] NULL,
		[Linetype] [int] NULL,
		[Salinvdate] [datetime] NULL,
		[Prdid] [int] NULL
	)
END
GO
IF NOT  EXISTS (SELECT * FROM sys.objects WHERE NAME ='CS2Console_Consolidated_Trace' AND type in ('U'))
BEGIN
CREATE TABLE CS2Console_Consolidated_Trace (
	[SlNo] [numeric](38, 0) NULL,
	[DistCode] [varchar](100) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ProcessName] [varchar](200) NULL,
	[ProcessDate] [datetime] NULL,
	[Column1] [varchar](200) NULL,
	[Column2] [varchar](200) NULL,
	[Column3] [varchar](200) NULL,
	[Column4] [varchar](200) NULL,
	[Column5] [varchar](200) NULL,
	[Column6] [varchar](200) NULL,
	[Column7] [varchar](200) NULL,
	[Column8] [varchar](200) NULL,
	[Column9] [varchar](200) NULL,
	[Column10] [varchar](200) NULL,
	[Column11] [varchar](200) NULL,
	[Column12] [varchar](200) NULL,
	[Column13] [varchar](200) NULL,
	[Column14] [varchar](200) NULL,
	[Column15] [varchar](200) NULL,
	[Column16] [varchar](200) NULL,
	[Column17] [varchar](200) NULL,
	[Column18] [varchar](200) NULL,
	[Column19] [varchar](200) NULL,
	[Column20] [varchar](200) NULL,
	[Column21] [varchar](200) NULL,
	[Column22] [varchar](200) NULL,
	[Column23] [varchar](200) NULL,
	[Column24] [varchar](200) NULL,
	[Column25] [varchar](200) NULL,
	[Column26] [varchar](200) NULL,
	[Column27] [varchar](200) NULL,
	[Column28] [varchar](200) NULL,
	[Column29] [varchar](200) NULL,
	[Column30] [varchar](200) NULL,
	[Column31] [varchar](200) NULL,
	[Column32] [varchar](200) NULL,
	[Column33] [varchar](200) NULL,
	[Column34] [varchar](200) NULL,
	[Column35] [varchar](200) NULL,
	[Column36] [varchar](200) NULL,
	[Column37] [varchar](200) NULL,
	[Column38] [varchar](200) NULL,
	[Column39] [varchar](200) NULL,
	[Column40] [varchar](200) NULL,
	[Column41] [varchar](200) NULL,
	[Column42] [varchar](200) NULL,
	[Column43] [varchar](200) NULL,
	[Column44] [varchar](200) NULL,
	[Column45] [varchar](200) NULL,
	[Column46] [varchar](200) NULL,
	[Column47] [varchar](200) NULL,
	[Column48] [varchar](200) NULL,
	[Column49] [varchar](200) NULL,
	[Column50] [varchar](200) NULL,
	[Column51] [varchar](200) NULL,
	[Column52] [varchar](200) NULL,
	[Column53] [varchar](200) NULL,
	[Column54] [varchar](200) NULL,
	[Column55] [varchar](200) NULL,
	[Column56] [varchar](200) NULL,
	[Column57] [varchar](200) NULL,
	[Column58] [varchar](200) NULL,
	[Column59] [varchar](200) NULL,
	[Column60] [varchar](200) NULL,
	[Column61] [varchar](200) NULL,
	[Column62] [varchar](200) NULL,
	[Column63] [varchar](200) NULL,
	[Column64] [varchar](200) NULL,
	[Column65] [varchar](200) NULL,
	[Column66] [varchar](200) NULL,
	[Column67] [varchar](200) NULL,
	[Column68] [varchar](200) NULL,
	[Column69] [varchar](200) NULL,
	[Column70] [varchar](200) NULL,
	[Column71] [varchar](200) NULL,
	[Column72] [varchar](200) NULL,
	[Column73] [varchar](200) NULL,
	[Column74] [varchar](200) NULL,
	[Column75] [varchar](200) NULL,
	[Column76] [varchar](200) NULL,
	[Column77] [varchar](200) NULL,
	[Column78] [varchar](200) NULL,
	[Column79] [varchar](200) NULL,
	[Column80] [varchar](200) NULL,
	[Column81] [varchar](200) NULL,
	[Column82] [varchar](200) NULL,
	[Column83] [varchar](200) NULL,
	[Column84] [varchar](200) NULL,
	[Column85] [varchar](200) NULL,
	[Column86] [varchar](200) NULL,
	[Column87] [varchar](200) NULL,
	[Column88] [varchar](200) NULL,
	[Column89] [varchar](200) NULL,
	[Column90] [varchar](200) NULL,
	[Column91] [varchar](200) NULL,
	[Column92] [varchar](200) NULL,
	[Column93] [varchar](200) NULL,
	[Column94] [varchar](200) NULL,
	[Column95] [varchar](200) NULL,
	[Column96] [varchar](200) NULL,
	[Column97] [varchar](200) NULL,
	[Column98] [varchar](200) NULL,
	[Column99] [varchar](200) NULL,
	[Column100] [varchar](200) NULL,
	[Remarks1] [varchar](500) NULL,
	[Remarks2] [varchar](500) NULL,
	[UploadFlag] [varchar](1) NULL,
	[Uploadeddate] [datetime] NULL
) 
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_PopulateToBeUploaded]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_PopulateToBeUploaded]
GO
--Exec Proc_PopulateToBeUploaded 0
CREATE PROCEDURE [dbo].[Proc_PopulateToBeUploaded]
(
@Po_ErrNo INT OUTPUT
)
As
Begin
	BEGIN TRY        
	SET XACT_ABORT ON        
	BEGIN TRANSACTION  
	declare @SqlStr varchar(8000)
	declare @Process varchar(100)
	declare @colcount int
	declare @Col varchar(5000)
	declare @Tablename varchar(100)
	declare @Sequenceno int
	declare @Lvar int
	declare @MaxId int
	Declare @DistCode Varchar(100)
	Declare @SyncId Int
	SET @Po_ErrNo=0
	-- *** upload integration table to be replaced....
	Create table #Process(ProcessName varchar(100),PrkTableName varchar(100), id int identity(1,1) )
	insert into #Process(ProcessName , PrkTableName) select ProcessName , PrkTableName from Tbl_UploadIntegration order by Sequenceno
	Select @DistCode = DistributorCode From Distributor 
	Select @SyncId = Max(SyncId) From Sync_Master
	--Delete From CS2Console_Consolidated Where UploadFlag = 'Y'
	--Delete A From CS2Console_Consolidated  A (Nolock) , SyncStatus B 
	--Where A.DistCode = B.DistCode And A.UploadFlag = 'Y' And A.SyncId = B.SyncId And B.SyncStatus <> 0
		----- Added by Anand S on 10.09.2012 -- for handling the DB Restoration - SyncId Mismatch....
		--Declare @SyncSts int
		--Declare @ZCnt int
		--Select @SyncSts = ISNULL(SyncStatus,0) from SyncStatus (nolock)
		--select @ZCnt = Count(*) from CS2Console_Consolidated(nolock) where UploadFlag = 'N' and
		--SyncId = (select isnull(SyncId,0)  from SyncStatus (nolock) )
		--if (@SyncSts = 0 and @ZCnt = 0)
		--begin
		--Update CS2Console_Consolidated set UploadFlag = 'N' where 	SyncId = (select isnull(SyncId,0)  from SyncStatus (nolock) )
		--end
		--- Till Here
		
		------------> Added by Lakshman M on 09-03-2018 PMS ID: ICRSTPAR7919 <--------------
		INSERT  INTO CS2Console_Consolidated_Trace
		SELECT *,GETDATE() FROM CS2Console_Consolidated (NOLOCK) WHERE UploadFlag='Y'
		DELETE FROM CS2Console_Consolidated_Trace WHERE CONVERT(VARCHAR(10),Uploadeddate,121) < CONVERT(VARCHAR(10),DATEADD(DD,-15,GETDATE()),121)
		------------> Till here <---------------------
		
		Delete A From CS2Console_Consolidated A (nolock) Where SyncId <> (Select ISNULL(MAX(SyncId),0) From SyncStatus)
		--Delete A From CS2Console_Consolidated A (nolock) Where SyncId < (Select ISNULL(MAX(SyncId),0) From SyncStatus) AND UploadFlag='Y'
		Delete A From CS2Console_Consolidated A (nolock) Where SyncId = (Select ISNULL(MAX(SyncId),0) From SyncStatus WHERE SyncStatus=1) AND UploadFlag='Y' 
		IF ((Select Count(*) From CS2Console_Consolidated (nolock)) = 0)
		Begin
			Truncate Table CS2Console_Consolidated
		End
	set @Lvar = 1
	select @MaxId = Max(id) from #Process
	while @Lvar <= @MaxId
	begin
		select @Tablename = PrkTableName , @Process = ProcessName from #Process where id  = @Lvar
		select @colcount = Max(Column_ID) from sys.columns where object_id = (select object_id from sys.objects where name = @Tablename)
		set @SqlStr = ''
		set @SqlStr = @SqlStr + ' Insert into CS2Console_Consolidated '
		set @Col = ''
		select @Col = @Col + name + ',' from sys.columns 
		where object_id = ( select object_id from sys.objects where name = 'CS2Console_Consolidated')
		and column_id  between 2 and @colcount + 5 Order by column_id 
		set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ',UploadFlag)'
		
		set @Col = ''
		--select @Col = @Col + name + ',' from sys.columns 
		select @Col = @Col + (Case when (name = 'UploadedDate' Or name = 'ServerDate') Then  'CONVERT(VARCHAR(19),[' + name + '],121)' else 'REPLACE(['+name + '],'''''''','''')'  end)+ ',' from sys.columns 
		where Object_Id = ( select Object_Id from sys.objects where name = @Tablename)
		and column_id  <= @colcount Order by column_id 
		set @SqlStr = @SqlStr + 'Select '''+ CONVERT(Varchar(50),@DistCode) + ''','+ CONVERT(Varchar(50),@SyncId) + ',''' + @Process + ''' ,getdate(), '
		set @SqlStr = @SqlStr + ' ' + left(@Col,len(@Col)-1)  + ',''N'' from ' + @Tablename + '(nolock) where UploadFlag = ''N''  And SyncId Is Not Null  Order By SlNo '
		--Print(@SqlStr)
		exec (@SqlStr)
		set @SqlStr = ''
		set @SqlStr = @SqlStr + ' Update B Set B.UploadFlag = ''Y'' From CS2Console_Consolidated A (Nolock),  ' + @Tablename  + ' B (nolock) '
		set @SqlStr = @SqlStr + ' Where A.DistCode = B.DistCode and a.SyncId = b.SyncId and A.ProcessName = ''' + @Process + '''  And A.SyncId Is Not Null '
		exec (@SqlStr)
		--Print(@SqlStr)
		set @SqlStr = ''
		
	set @Lvar = @Lvar + 1
	END
		Update SyncStatus Set SyncFlag = 'Y' Where DistCode=@DistCode And SyncId = @SyncId
		Create Table #SPLTBL (Id INT Identity(1,1),CId INT,CName VARCHAR(200),CType VARCHAR(100))
		INSERT INTO #SPLTBL
		SELECT A.column_id AS CId,A.Name,C.name AS CType FROM Sys.columns A,Sys.objects B,Sys.types C 
		WHERE A.object_id = B.object_id and B.name = 'CS2Console_Consolidated'
		And A.system_type_id = C.system_type_id And C.name='VARCHAR'
		Order by A.column_id 
		DECLARE @CName VARCHAR(100)
		SET @Lvar = 1
		SET @CName = ''
		SELECT @MaxId = IsNull(Count(CId),0) FROM #SPLTBL
		While @Lvar <= @MaxId
		Begin
			SELECT @CName = CName FROM #SPLTBL WHERE Id = @Lvar
			SET @SqlStr = ''
			SET @SqlStr = @SqlStr + ' UPDATE CS2Console_Consolidated  SET '+ @CName + ' = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(' + @CName + ','''''''',''''),''"'',''''),''&'',''''),''<'',''''),''>'','''') '
			Print (@SqlStr)
			exec (@SqlStr)
			
			SET @SqlStr = ''
			SET @SqlStr = @SqlStr + ' UPDATE CS2Console_Consolidated  SET '+ @CName + ' = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(' + @CName + ',''\r'',''''),''\n'',''''),''\f'',''''),''\p'',''''),''\t'',''''),''\s'','''') '
			Print (@SqlStr)
			exec (@SqlStr)
					
			SET @Lvar = @Lvar + 1
		End
	COMMIT TRANSACTION        
	 END TRY        
 BEGIN CATCH        
  ROLLBACK TRANSACTION        
  INSERT INTO Sync_ErrorLog VALUES ('Proc_PopulateToBeUploaded', ERROR_MESSAGE(), GETDATE())        
 END CATCH        
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Proc_ComputeTax' and XTYPE='P')
DROP PROCEDURE Proc_ComputeTax
GO
/*
BEGIN  TRANSACTION
EXEC Proc_ComputeTax 1,226,1,0,'2018-06-25',1
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [dbo].[Proc_ComputeTax]
(      
 @Pi_RowId  INT,      
 @Pi_CalledFrom  INT,        
 @Pi_UserId  INT,
 @Pi_RtrShipId  INT=0,
 @Pi_gServerDate DateTime='1990-01-01',
 @Pi_ApplyTax INT=1
)      
AS      
/*********************************      
* PROCEDURE : Proc_ComputeTax      
* PURPOSE : To Calculate the Line Level Tax      
* CREATED : Thrinath      
* CREATED DATE : 22/03/2007      
* MODIFIED
* DATE      AUTHOR     DESCRIPTION 
24/05/2009	MURUGAN	   OID CalCulation For Nestle	
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
17-11-2017  Mohana.S		 After  Based On Configuration Sales return tax will change.
26-06-2018	Karthick	CRCRSTPAR0008 Tax Calculation for Sample Issue
07/03/2019    Mohana S            ILCRSTPAR3750      	CR			Kerala GST Cess 
------------------------------------------------      
* {date} {developer}  {brief modification description}            
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
Pi_CalledFrom   226 For SampleIssue 'CRCRSTPAR0008
*********************************/       
SET NOCOUNT ON      
BEGIN      
	DECLARE @PrdBatTaxGrp   INT      
	DECLARE @RtrTaxGrp   INT      
	DECLARE @TaxSlab  INT      
	DECLARE @MRP   NUMERIC(28,10)      
	DECLARE @SellingRate  NUMERIC(28,10)      
	DECLARE @PurchaseRate  NUMERIC(28,10)      
	DECLARE @TaxableAmount  NUMERIC(28,10)    
	DECLARE @TotalDedAmt  NUMERIC(28,10)  
	DECLARE @ParTaxableAmount NUMERIC(28,10)      
	DECLARE @TaxPer   NUMERIC(38,6)      
	DECLARE @TaxId   INT      
	DECLARE	@ApplyOn INT
	
--ADDED BY MOHANA FOR CESS CHANGE
	DECLARE @CDate NVARCHAR(100)
	DECLARE @CessConfig INT
	DECLARE @CessDateConfig INT
	SET @CessConfig=0
	SET @CessDateConfig=0
--TILL HERE
	
	DECLARE @TaxSetting TABLE       
	(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,6)      
	)      
--ADDED BY MOHANA FOR CESS CHANGE
	DECLARE @BilledPrdTax Table
	(
	    Rtrid Bigint
	    
	 )  
--TILL HERE

	--ADDED BY MOHANA
	SELECT  @CDate = CONDITION FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01'  

	IF ISNULL(@Pi_gServerDate,'1990-01-01')='1990-01-01'
	BEGIN
		SET @Pi_gServerDate=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
	END
	
	IF ISNULL(@Pi_RtrShipId,0)=0
	BEGIN
		SET @Pi_RtrShipId=0
	END
	
	----Added by MOHANA at 07-03-2019
	   IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX02')
		  BEGIN
			 SET @CessDateConfig=1  ---Unregistered Retailer
		  END
	
		IF @CessDateConfig=0
		  BEGIN	
				IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=3)
				  BEGIN
					 SET @CessConfig=3  ---Unregistered Retailer
				  END
				IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=2)
				  BEGIN
					 SET @CessConfig=2  ---Registered Retailer
				  END
				 IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=1)
				  BEGIN
					 SET @CessConfig=1  ---Both Registered and Unregistered
				  END
		 END
		 ELSE
		  BEGIN
				IF ISDATE(@CDate)=1 AND LEN(@CDate)= 10 --CHECK THE VALID DATA FORMAT -- ADDED BY MOHANA
				BEGIN
					IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=3 and @Pi_gServerDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),Condition,121 ),121))
					BEGIN
						SET @CessConfig=3  ---Unregistered Retailer
					END
					IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=2 and @Pi_gServerDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),Condition,121 ),121))
					BEGIN
						SET @CessConfig=2  ---Registered Retailer
					END
					IF EXISTS (SELECT * FROM ManualConfiguration(Nolock) WHERE Status=1 and ModuleId='BILL_TAX01' and ConfigValue=1 and @Pi_gServerDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),Condition,121 ),121))
					BEGIN
						SET @CessConfig=1  ---Both Registered and Unregistered
					END
				END
		   END
		---Till Here MOHANA at 07-03-2019
	--To Take the Batch TaxGroup Id      
	SELECT @PrdBatTaxGrp = TaxGroupId FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	
	--To Take the Batch MRP      
	SELECT @MRP = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	INNER JOIN ProductBatchDetails C (NOLOCK)      
	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
	INNER JOIN BatchCreation D (NOLOCK)      
	ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
	AND D.MRP = 1       
	
	--To Take the Batch Selling Rate      
	IF @Pi_CalledFrom = 2 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 23  
	BEGIN      
		SELECT @SellingRate = ColValue FROM BilledPrddtForTax WHERE TransId = @Pi_CalledFrom       
		AND UsrId = @Pi_UserId AND RowId = @Pi_RowId AND ColId = -2      
	END      
	ELSE      
	BEGIN      
		IF @Pi_CalledFrom = 20 
		BEGIN 
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT MAX(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
		ELSE      
		BEGIN      
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
	END 
	IF @Pi_CalledFrom = 226 --CRCRSTPAR0008
	BEGIN 
		SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT MAX(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
		INNER JOIN BatchCreation D (NOLOCK) ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1     
	END      
	
	--To Take the Batch List Price 
	--Added by Murugan For OID Calculation
	IF (@Pi_CalledFrom = 5 OR @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37 )
	BEGIN   
		IF  EXISTS(SELECT Status FROM Configuration WHERE ModuleId = 'PURCHASERECEIPT16' and Status=1)   
		BEGIN  
			SELECT  @PurchaseRate = Isnull(ColValue,0) FROM BilledPrdDtForTax B  
			WHERE  B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 
			and COLID=3	   
		END  
		ELSE  
		BEGIN 
			SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.ListPrice = 1     
		END  
		
		
		--->Added By Nanda on 2011/05/12
		IF @Pi_CalledFrom = 37
		BEGIN
			IF EXISTS(SELECT * FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			BEGIN
				SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
				BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
				AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
				INNER JOIN ProductBatchDetails C (NOLOCK)      
				ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
				INNER JOIN BatchCreation D (NOLOCK)      
				ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
				AND LTRIM(RTRIM(D.RefCode)) IN (SELECT LEFT(Condition,1) FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			END
		END
		--->Till Here
	END
	ELSE
	BEGIN
		SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
		INNER JOIN BatchCreation D (NOLOCK)      
		ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1  
	END
	
	IF (@Pi_CalledFrom = 2 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 20 OR @Pi_CalledFrom = 23 OR       
	@Pi_CalledFrom = 24 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom=226)      
	BEGIN      
		--To Take the Retailer TaxGroup Id      
		IF EXISTS(SELECT 'X' FROM RetailerShipAdd C (NOLOCK)
		INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
		INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
		WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
		AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0)
		BEGIN
			SELECT @RtrTaxGrp=C.TaxGroupId FROM RetailerShipAdd C (NOLOCK)
			INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
			INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
			WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0
		END
		ELSE
		BEGIN		 
			SELECT @RtrTaxGrp = TaxGroupId FROM Retailer A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom      
		END		 
	END      
	
	IF (@Pi_CalledFrom = 5 OR  @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)      
	BEGIN      
		--To Take the Supplier TaxGroup Id      
		SELECT @RtrTaxGrp = TaxGroupId FROM Supplier A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.SpmId = B.RtrId      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId      
		AND B.TransId = @Pi_CalledFrom      
	END      
	--Store the Tax Setting for the Corresponding Retailer and Batch      
	INSERT INTO @TaxSetting (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
	SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
	FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
	TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
	INNER JOIN BilledPrdHdForTax C (NOLOCK) ON C.BillSeqId = B.BillSeqId      
	WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp AND C.UsrId = @Pi_UserId      
	AND C.RowId = @Pi_RowId AND C.TransId = @Pi_CalledFrom      
	AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
	RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121) --GST
	)
----Added by MOHANA at 07-03-2019
	IF (@Pi_CalledFrom = 2 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 20 OR @Pi_CalledFrom = 23 OR       
		@Pi_CalledFrom = 24 OR @Pi_CalledFrom = 25)      
		BEGIN 
			IF @CessConfig =0  ----Cess Tax Wont Apply
			 BEGIN
				  DELETE A FROM @TaxSetting A  INNER JOIN TaxConfiguration B ON A.TaxSlab=B.TaxId
				  where ColType=1 and ColVal > 0 and B.TaxCode In ('OutputGSTCess','GSTCess')
			 END
	IF @Pi_RtrShipId>0
	  BEGIN
	
			IF @CessConfig =2  ----Registered Retailer Cess will apply
				 BEGIN
					IF EXISTS (SELECT 'X' FROM RetailerShipAdd C (NOLOCK)
							INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
							INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId AND D.MasterRecordId=C.RtrId 
							INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
							AND E.ColumnName='Retailer Type'
							WHERE C.RtrShipId=@Pi_RtrShipId and E.MasterId=2 and UPPER(D.ColumnValue)='UNREGISTERED')
					BEGIN
						  DELETE A FROM @TaxSetting A  INNER JOIN TaxConfiguration B ON A.TaxSlab=B.TaxId
						  where ColType=1 and ColVal > 0 and B.TaxCode In ('OutputGSTCess','GSTCess')
					END
				  END
				  
			IF @CessConfig =3  ----UnRegistered Retailer Cess will apply
				 BEGIN
					IF EXISTS (SELECT 'X' FROM RetailerShipAdd C (NOLOCK)
							INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
							INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId AND D.MasterRecordId=C.RtrId 
							INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
							AND E.ColumnName='Retailer Type'
							WHERE C.RtrShipId=@Pi_RtrShipId and E.MasterId=2 and UPPER(D.ColumnValue)='REGISTERED')
					BEGIN
						  DELETE A FROM @TaxSetting A  INNER JOIN TaxConfiguration B ON A.TaxSlab=B.TaxId
						  where ColType=1  and ColVal > 0 and B.TaxCode In ('OutputGSTCess','GSTCess')
					END
				  END
		END
		ELSE
		BEGIN
		    INSERT INTO @BilledPrdTax
		    SELECT Distinct Rtrid from BilledPrdHdForTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId       
			AND TransId = @Pi_CalledFrom
		
			IF @CessConfig =2  ----Registered Retailer Cess will apply
				 BEGIN
					IF EXISTS (SELECT 'X' FROM @BilledPrdTax C
							INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
							INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId AND D.MasterRecordId=C.RtrId 
							INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
							AND E.ColumnName='Retailer Type'
							WHERE  E.MasterId=2 and UPPER(D.ColumnValue)='UNREGISTERED')
					BEGIN
						  DELETE A FROM @TaxSetting A  INNER JOIN TaxConfiguration B ON A.TaxSlab=B.TaxId
						  where ColType=1 and ColVal > 0 and B.TaxCode In ('OutputGSTCess','GSTCess')
					END
				  END
				  
			IF @CessConfig =3  ----UnRegistered Retailer Cess will apply
				 BEGIN
					IF EXISTS (SELECT 'X' FROM @BilledPrdTax C
							INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
							INNER JOIN UdcDetails D (NOLOCK) ON D.MasterRecordId=A.RtrId AND D.MasterRecordId=C.RtrId 
							INNER JOIN UdcMaster E (Nolock) ON E.UdcMasterId=D.UdcMasterId AND E.MasterId=D.MasterId
							AND E.ColumnName='Retailer Type'
							WHERE E.MasterId=2 and UPPER(D.ColumnValue)='REGISTERED')
					BEGIN
						  DELETE A FROM @TaxSetting A  INNER JOIN TaxConfiguration B ON A.TaxSlab=B.TaxId
						  where ColType=1  and ColVal > 0 and B.TaxCode In ('OutputGSTCess','GSTCess')
					END
				  END
		
		
		END
	END
 ---Till Here 
	
	
	--Delete the OLD Details From the BilledPrdDtCalculatedTax For the Row and User      
	DELETE FROM BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId       
	AND TransId = @Pi_CalledFrom      
	
	--Cursor For Taking Each Slab and Calculate Tax      
	DECLARE  CurTax CURSOR FOR      
	SELECT DISTINCT TaxSlab FROM @TaxSetting      
	OPEN CurTax        
	FETCH NEXT FROM CurTax INTO @TaxSlab      
	WHILE @@FETCH_STATUS = 0        
	BEGIN      
		SET @TaxableAmount = 0      
		--To Filter the Records Which Has Tax Percentage (>=0)      
		IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0 and ColVal >= 0)      
		BEGIN
			
			--To Get the Tax Percentage for the selected slab      
			SELECT @TaxPer = ColVal FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId = 0      
			
			IF @Pi_ApplyTax=0 
			BEGIN
				SET @TaxPer=0
				--SET @CalSurCharge=0
				--SET @AddtionTax=0
			END			
			
			--To Get the TaxId for the selected slab      
			SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId > 0      
	         
			--To Get the Adjustable amount from Other Columns      
			SELECT @TaxableAmount = ISNULL(SUM(ColValue),0) FROM       
			(SELECT CASE B.ColVal WHEN 1 THEN A.ColValue WHEN 2 THEN -1 * A.ColValue END       
				AS ColValue FROM BilledPrdDtForTax A INNER JOIN @TaxSetting B      
				ON A.ColId = B.ColId AND A.RowId =  @Pi_RowId AND A.UsrId = @Pi_UserId       
				AND A.TransId = @Pi_CalledFrom      
			WHERE TaxSlab = @TaxSlab AND B.ColType = 2 and B.ColId>3      
				And B.ColVal >0) as C      
			
			SET @ApplyOn=0
			SET @TotalDedAmt=@TaxableAmount
			 
			
			--To add MRP to Taxable Amount if MRP Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP      
				SET @ApplyOn=1 
			END
			
			--To add Selling Rate to Taxable Amount if Selling Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 2 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @SellingRate      
	      
			--To add Purchase Rate to Taxable Amount if Purchase Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 3 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @PurchaseRate      
			
			--To Get the Parent Taxable Amount for the Tax Slab      
			SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM BilledPrdDtCalculatedTax A      
			INNER JOIN @TaxSetting B ON A.TaxId = B.ColVal AND A.RowId = @Pi_RowId      
			AND A.UsrId = @Pi_UserId AND B.ColType = 3 AND B.TaxSlab = @TaxSlab      
			AND A.TransId = @Pi_CalledFrom     
			Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount      
	      
			--Insert the New Tax Amounts        
			INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
			TaxableAmount,TaxAmount,Usrid,TransId)      
			SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@TaxId,@TaxSlab,@TaxPer,      
		    @TaxableAmount, CASE @ApplyOn 
			WHEN 0 THEN	cast(@TaxableAmount * (@TaxPer / 100 ) AS NUMERIC(38,6))
			WHEN 1 THEN cast(@TaxableAmount * (@TaxPer / (100 +@TaxPer)) AS NUMERIC(38,6)) END,      
			@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
			B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom     
			
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount =  @TotalDedAmt+ @SellingRate
				UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=@TaxableAmount
				WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId AND TransId = @Pi_CalledFrom 							
			END 
			
		END      
		FETCH NEXT FROM CurTax INTO @TaxSlab      
	END        
	CLOSE CurTax        
	DEALLOCATE CurTax           
	-----Only for SalesReturn
IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId='Sal_Return_Tax' AND Status = 1)--Added By Mohana
BEGIN
	CREATE TABLE #SalesReturnTax
	(
		Slno INT IDENTITY(1,1),
		RowId  INT,
		SalRowId INT,
		Taxperc Numeric(18,6),
		TaxId INT,
		Prdid INT,
		PrdbatId INT
	)
	DECLARE @MaxSlno AS INT
	DECLARE @MinSlno AS INT
	DECLARE @RtnPrdid AS INT
	DECLARE @RtnPrdbatId AS INT
	DECLARE @RtnTaxId AS INT
	DECLARE @RtnTaxPerc AS Numeric(18,6)
	DECLARE @RtnTaxableAmount AS Numeric(18,6)
	SET @MinSlno=1
	
	IF @Pi_CalledFrom = 3
	BEGIN
		IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1)
		BEGIN
				---Only With Reference
				INSERT INTO #SalesReturnTax(RowId,SalRowId,TaxPerc,TaxId,PrdId,PrdbatId)
				SELECT DISTINCT RowId,SalRowId,CASE @Pi_ApplyTax WHEN 0 THEN 0.00 ELSE  TaxPerc END,TaxId,PrdId,PrdbatId 	
				FROM BilledPrdHdForTax_GST A (NOLOCK) 
				INNER JOIN salesinvoiceproducttax B (NOLOCK) ON A.Salid=B.SalId and A.SalRowId=B.PrdSlNo				
				INNER JOIN SalesInvoice S (NOLOCK) ON S.Salid=A.Salid and S.Salid=B.Salid
				WHERE Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				and VatGst='GST' and TaxPerc <> 0
			
				IF EXISTS(SELECT 'X' FROM #SalesReturnTax)
				BEGIN
				
					DELETE A FROM BilledPrdDtCalculatedTax A WHERE NOT EXISTS(SELECT PrdId,PrdBatId,TaxId FROM 
					#SalesReturnTax B WHERE A.PrdId=B.Prdid and A.PrdbatId=B.PrdbatId and A.TaxId=B.TaxId and A.RowId=B.RowId)
					and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				
					SELECT @MaxSlno=MAX(Slno) FROM #SalesReturnTax
					
					WHILE @MinSlno<=@MaxSlno
					BEGIN
						SELECT @RtnPrdid=Prdid,@RtnPrdbatId=PrdbatId ,@RtnTaxId=Taxid,@RtnTaxPerc=TaxPerc FROM #SalesReturnTax
						WHERE Slno=@MinSlno
						
						IF EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
						BEGIN
						
								IF NOT EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId and Cast(TaxPercentage as Numeric(18,6))=@RtnTaxPerc
										and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
										BEGIN																																	
											UPDATE A SET A.TaxPercentage=@RtnTaxPerc,
											A.TaxAmount=cast(A.TaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6))
											FROM BilledPrdDtCalculatedTax A  
											WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
											and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
											and  TaxableAmount>0							
										END
						END	
						ELSE
						BEGIN
						
								SELECT @RtnTaxableAmount=TaxableAmount 
								FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
								and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
								and  TaxableAmount>0
						
								INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
								TaxableAmount,TaxAmount,Usrid,TransId)      
								SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@RtnTaxId,@RtnTaxId,@RtnTaxPerc,      
								@RtnTaxableAmount, cast(@RtnTaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6)),      
								@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
								B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 					  
							
						END			
						
						SET @MinSlno=@MinSlno+1
					END							
				END
		END
	END	
END
	-----Till here
		----Gopi at 02-06-2017 for GST
	UPDATE BilledPrdDtCalculatedTax SET TaxId=0 where TaxId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxSlabId=0 where TaxSlabId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=0 where TaxableAmount Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxPercentage=0 where TaxPercentage Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxAmount=0 where TaxAmount Is null
	 ---Till Here ----        
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptProductWiseSalesTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptProductWiseSalesTaxGST
GO
---EXEC Proc_RptProductWiseSalesTaxGST 401,2,0,'',0,0,1
--Select * from RptProductWiseSalesTaxGST
CREATE PROCEDURE Proc_RptProductWiseSalesTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptProductWiseSalesTaxGST
* PURPOSE	: To get the Tax details
* CREATED	: Murugan.R
* CREATED DATE	: 12/05/2017
* MODIFIED
-------------------------------------------------------------------------------------------------------
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* Date            Name              PMS NO            CR/BUG      Remarks
-------------------------------------------------------------------------------------------------------
*06/10/2018    Deepak Philip      ILCRSTPAR2305        BUG      To show retailer GSTIN no in report.
* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR		UPDATED ZERO FOR QTY AND NETAMOUNT IF THE TAX PERC IS CESS and Included CESS Tax

* 07-03-2019	MOHANA S	    ILCRSTPAR3750	   CR		KERALA CESS CHANGES
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptProductWiseSalesTaxGST')
	BEGIN
		DELETE FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[InvDate] DateTime,
			[InvId] [bigint] NULL,
			[RefNo] [varchar](100) NULL,
			[RetailerName] Varchar(150),
			[RetailerCode] Varchar(75),
			[RtrGSTIN] Varchar(20),
			RtrStateCode Varchar(20),
			RtrStateName Varchar(150) ,
			RtrShipAdd Varchar(150),
			RtrShipAdd1 Varchar(150),
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[RtrId] [int] NULL,
			[Prdid] [int] NULL,
			[InvQty] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			[TaxableAmountCESS] [numeric](38, 6) NULL,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[LineNetAmount] Numeric(36,6),
			[ReverseCharge] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId])
		SELECT SI.SalInvDate,SI.SalId AS InvId,SI.SalInvNo AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		ISNULL(RS.RtrShipAdd1,'') as RtrShipAdd,ISNULL(RS.RtrShipAdd2,'') as RtrShipAdd1,
		PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,SUM(SIP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'Sales' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],0 as [ReverseCharge],[UPC] as [UPC],
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId  
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=SIP.PrdId  
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		LEFT OUTER JOIN RetailerShipAdd RS ON RS.RtrId=SI.RtrId and RS.RtrShipId=SI.RtrShipId  
		WHERE SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts >3
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,RtrCode,PrdName,PrdCCode,TC.TaxCode,ISNULL(RS.RtrShipAdd1,''),ISNULL(RS.RtrShipAdd2,''),
		[UPC]
		HAVING Sum(TaxableAmount) >0  
			
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT SI.SalInvDate,SI.SalId AS InvId,SI.SalInvNo AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		ISNULL(RS.RtrShipAdd1,'') as RtrShipAdd,ISNULL(RS.RtrShipAdd2,'') as RtrShipAdd1,		
		PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,SUM(SIP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],  
		'Sales' as IOTaxType,1 as TaxFlag,Sum(SPT.TaxAmount) as TaxPercent,
		SPT.TaxId,SUM(PrdNetAmount) as [LineNetAmount],0 as [ReverseCharge],[UPC] as [UPC],	
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		SalesInvoice SI WITH (NOLOCK)  
		INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
		INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=SIP.PrdId   
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =SPT.TaxId 
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId
		LEFT OUTER JOIN RetailerShipAdd RS ON RS.RtrId=SI.RtrId and RS.RtrShipId=SI.RtrShipId   
		WHERE SI.Salinvdate Between @FromDate and @ToDate and SI.Dlvsts >3
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId ,
		SPT.TaxId ,RtrName,RtrCode,PrdName,PrdCCode,TC.TaxCode,ISNULL(RS.RtrShipAdd1,''),ISNULL(RS.RtrShipAdd2,''),[UPC]
		HAVING Sum(SPT.TaxAmount+SPT.TaxableAmount) > 0 
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		Select
		Rh.ReturnDate,RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,-1*SUM(RP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,-1 *SUM(TaxableAmt) as TaxableAmount, 0 as [TaxableAmountCESS],
		'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,
		RPT.TaxId,-1 *SUM(PrdNetAmt) as [LineNetAmount],ReverseCharges as [ReverseCharge],[UPC] as [UPC],		
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=RP.PrdId      
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		GROUP BY TaxPerc,RH.ReturnDate,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(TaxableAmt) > 0  
		
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		Select
		Rh.ReturnDate,RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,RtrName,RtrCode,'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,PrdName,PrdCCode,'' as [HSN Code],R.RtrId AS RtrId,P.PrdId as Prdid,-1*SUM(RP.BaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,-1 *SUM(TaxableAmt) as TaxableAmount, 0 AS [TaxableAmountCESS], 
		'SalesReturn' as IOTaxType,1 as TaxFlag,-1*SUM(RPT.TaxAmt) as TaxPercent,
		RPT.TaxId,-1 *SUM(PrdNetAmt) as [LineNetAmount],ReverseCharges as [ReverseCharge],[UPC] as [UPC],
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId 
		INNER JOIN #UOM U ON U.PrdId=P.PrdId and U.PrdId=RP.PrdId      
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		GROUP BY RH.ReturnDate,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(RPT.TaxAmt+TaxableAmt) > 0 
		
		UPDATE A SET LineNetAmount=0,InvQty=0,[TaxableAmountCESS] = TaxableAmount ,TaxableAmount = 0 FROM #TmpRptIOTaxSummary A WHERE TAXPERC IN ('OUTPUTCGSTCESS Value','OUTPUTSGSTCESS Value','OUTPUTIGSTCESS Value',
		'OUTPUTUTGSTCESS Value','CGSTCESS Value','SGSTCESS Value','IGSTCESS Value','UTGSTCESS Value','CESS Value',
		'OUTPUTCGSTCESS Rate','OUTPUTSGSTCESS Rate','OUTPUTIGSTCESS Rate','OUTPUTUTGSTCESS Rate','OUTPUTGSTCESS Rate','OUTPUTGSTCESS Value',
		'CGSTCESS Rate','SGSTCESS Rate','IGSTCESS Rate','UTGSTCESS Rate','CESS Rate','GSTCESS Rate','GSTCESS Value') --ILCRSTBOT0006
		INSERT INTO #TmpRptIOTaxSummary([InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[ReverseCharge],[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT  Null, 0 as [InvId],'' as [RefNo],'' as [RetailerName] ,'' as [RetailerCode],'' as [HSN Code],'' as RtrStateCode,'' as RtrStateName,'' as [RtrGSTIN],
		'' as RtrShipAdd,'' as RtrShipAdd1,'' as [Product Name] ,'' as [Product Code],0 as [RtrId],0 as Prdid,0 as [InvQty],0 as[CmpId],  [TaxPerc] ,0 as [TaxableAmount],0 as [TaxableAmountCESS],'' as [IOTaxType] ,
		100 as [TaxFlag],SUM([TaxPercent]) as [TaxPercent],0 as [TaxId],0 as  LineNetAmount,
		0 as [ReverseCharge],0 as [UPC],
		'ZZZZZZ' as [Group Name],3 as [GroupType],[UsrId]
		FROM #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
		---MOHANA  at 07-03-2019 for ILCRSTPAR3750
		UPDATE A SET A.[RtrGSTIN]=Isnull(S.GSTIN,'')  
		FROM #TmpRptIOTaxSummary A 		
		INNER JOIN SalesInvoice S ON S.SalId=A.[InvId]
		WHERE IOTaxType='Sales'
	
		
		UPDATE A SET A.RtrStateCode=SM.StateCode ,A.RtrStateName=SM.StateName --,A.[RtrGSTIN]=RS.GSTTinNo  
		FROM #TmpRptIOTaxSummary A 		
		INNER JOIN SalesInvoice S ON S.SalId=A.[InvId]
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		INNER JOIN StateMaster SM ON SM.StateId=RS.StateId
		WHERE IOTaxType='Sales'
		
			
		
		UPDATE A  SET A.RtrShipAdd=RS.RtrShipAdd1 ,A.RtrShipAdd1=RS.RtrShipAdd2 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  ReturnHeader B ON A.InvId=B.ReturnID
		INNER JOIN SalesInvoice S ON S.SalId=B.Salid
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		WHERE IOTaxType='SalesReturn'
		
		---Added by MOHANA at 07-03-2018
		
		UPDATE A SET A.[RtrGSTIN]=Isnull(S.GSTIN,'')  
		FROM #TmpRptIOTaxSummary A 		
		INNER JOIN  ReturnHeader B ON A.InvId=B.ReturnID
		INNER JOIN SalesInvoice S ON S.SalId=B.Salid
		WHERE IOTaxType='SalesReturn'
		
		UPDATE A SET A.RtrStateCode=SM.StateCode ,A.RtrStateName=SM.StateName --,A.[RtrGSTIN]=RS.GSTTinNo 
		FROM #TmpRptIOTaxSummary A 		
		INNER JOIN  ReturnHeader B ON A.InvId=B.ReturnID
		INNER JOIN SalesInvoice S ON S.SalId=B.Salid
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		INNER JOIN StateMaster SM ON SM.StateId=RS.StateId
		WHERE IOTaxType='SalesReturn'
		---Till Here ----
		
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		
		--Added by Deepak Philip ILCRSTPAR2305
		UPDATE A SET  A.[RtrGSTIN]=R.[ColumnValue] FROM #TmpRptIOTaxSummary A 
		INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u 
		INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
		INNER JOIN retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   and ColumnName='GSTIN' ) 
		R ON A.[RetailerCode]=R.[rtrcode] WHERE IOTaxType in('SalesReturn','Sales')
		--till here
	
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
		SELECT DISTINCT
		[InvDate],[InvId],[RefNo],[RetailerName] ,[RetailerCode],RtrStateCode,RtrStateName,[RtrGSTIN],
		RtrShipAdd,RtrShipAdd1,[Product Name] ,[Product Code],[HSN Code],[RtrId],[Prdid],[InvQty],[CmpId],
		[TaxableAmount],[IOTaxType],[TaxFlag],LineNetAmount,[UsrId],[ReverseCharge]
		INTO #LineLevelGross
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
	
		
		
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY NVARCHAR(MAX)--ILCRSTBOT0006
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		set @GROUPBY  = ''--ILCRSTBOT0006
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)
		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId
	
	
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxperc)+'),0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno

		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		--ILCRSTBOT0006
		SET @ColSelect='SELECT RtrStateCode,RtrStateName,[RtrGSTIN],[RetailerCode],[RetailerName],RtrShipAdd,RtrShipAdd1,[IOTaxType],[InvDate],[RefNo],'+
		'[HSN Code],[Product Code],[Product Name],[UPC],SUM([InvQty]) [InvQty],SUM([TaxableAmount]) [TaxableAmount],SUM([TaxableAmountcess]) [TaxableAmountcess],'+@ColSelect+'SUM(LineNetAmount) LineNetAmount,'+
		'SUM([ReverseCharge])[ReverseCharge],[Group Name],[GroupType],[UsrId]'
		

		SET @GROUPBY  = ' GROUP BY RtrStateCode,RtrStateName,RtrGSTIN,RetailerCode,RetailerName,RtrShipAdd,RtrShipAdd1,IOTaxType,InvDate,RefNo,[HSN Code],[Product Code],[Product Name],'+	
						'UPC,[Group Name],Grouptype,UsrId	'
		--ILCRSTBOT0006

		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),RtrStateCode Varchar(20),RtrStateName Varchar(150),[RtrGSTIN] varchar(20),[RetailerCode] Varchar(75),[RetailerName] Varchar(150),'+
		'RtrShipAdd Varchar(150),RtrShipAdd1 Varchar(150),[IOTaxType] [varchar](100) NULL,[InvDate] DateTime,'+
		'[RefNo] [varchar](100) NULL,	[HSN Code] varchar(50),[Product Code] Varchar(75),	[Product Name] Varchar(150),UPC INT,'+		
		'[InvQty] [int] NULL,[TaxableAmount] [numeric](38, 6) NULL,[TaxableAmountcess] [numeric](38, 6) NULL,'
	
		SET @Columns1='SELECT RtrStateCode,RtrStateName,[RtrGSTIN],[RetailerCode],[RetailerName],RtrShipAdd,RtrShipAdd1,[IOTaxType],[InvDate],[RefNo],'+
		'[HSN Code],[Product Code],[Product Name] ,UPC,[InvQty],[TaxableAmount],[TaxableAmountcess],LineNetAmount,ReverseCharge,TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'

		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,InvDate,RetailerName,[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptProductWiseSalesTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptProductWiseSalesTaxGST'+
		' CREATE TABLE RptProductWiseSalesTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),ReverseCharge  Numeric(36,2),[Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptProductWiseSalesTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBY + @OrderBy --ILCRSTBOT0006

		--PRINT @SQL
		EXEC(@SQL)
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,
		SUM(TaxableAmount) as TaxableAmount,SUM([ReverseCharge]) as [ReverseCharge]
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount,
		Y.[ReverseCharge]=X.[ReverseCharge]
		FROM RptProductWiseSalesTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,401,'Product Wise Output Tax',1,'RtrStateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',2,'RtrStateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',3,'RtrGSTIN',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',4,'RetailerCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',5,'RetailerName',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',6,'RtrShipAdd',75,1,0,1,1,'Retailer','Shipping','Address',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',7,'RtrShipAdd1',75,1,0,1,1,'Retailer','Shipping','Address2',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',8,'IOTaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',9,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',10,'InvDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',11,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',12,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',13,'HSN Code',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',14,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',15,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',16,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			UNION ALL
			SELECT 1,401,'Product Wise Output Tax',17,'TaxableAmountCESS',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+2,'ReverseCharge',
			18,1,0,2,3,'Reverse','Charge','',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM  SYSOBJECTS WHERE NAME='Proc_RptPurchaseTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptPurchaseTaxGST
GO
--EXEC Proc_RptPurchaseTaxGST  402,1,0,'',1,0,''
CREATE PROCEDURE Proc_RptPurchaseTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptPurchaseTaxGST
* PURPOSE	: To get the GST Purchase Tax details
* CREATED	: Raja C
* CREATED DATE	: 20/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR		UPDATED ZERO FOR QTY AND NETAMOUNT IF THE TAX PERC IS CESS and Included CESS Tax
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))	
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptPurchaseTaxGST')
	BEGIN
		DELETE FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(   
		    [GRN No] NVarchar(100),
            [GRN date] DateTime,
			[InvDate] DateTime,
			[InvId] [bigint] NULL,
			[RefNo] [varchar](100) NULL,
			[ODN Number] [varchar](100) NULL,
			[SupplierCode] Varchar(75),
			[SupplierName] Varchar(150),
			[SupplierAddress] Varchar(150),
			[Supplier GSTIN] Varchar(150),
			[Supplier State] Varchar(150),
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[SpmId] [int] NULL,
			[Prdid] [int] NULL,
			[InvQty] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			[TaxableAmountCESS] [numeric](38, 6) NULL,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[LineNetAmount] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId])
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'Purchase' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId   
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId 
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE PR.InvDate  Between @FromDate and @ToDate and PR.Status=1
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount) >0  
			
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'Purchase' as IOTaxType,1 as TaxFlag,SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId    
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING  SUM(PRPT.TaxAmount+PRPT.TaxableAmount) > 0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'PurchaseReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING SUM(TaxableAmount) >0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,0 as [TaxableAmountCESS],'PurchaseReturn' as IOTaxType,1 as TaxFlag,-1*SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount+PRPT.TaxAmount) >0 
		
		UPDATE A SET LineNetAmount=0,InvQty=0,TaxableAmountcess = TaxableAmount,TaxableAmount = 0 FROM #TmpRptIOTaxSummary A WHERE TAXPERC IN ('INPUTCGSTCESS Value','INPUTSGSTCESS Value',
		'INPUTIGSTCESS Value',	'INPUTUTGSTCESS Value','CGSTCESS Value','SGSTCESS Value','IGSTCESS Value','UTGSTCESS Value','CESS Value',
		'INPUTCGSTCESS Rate','INPUTSGSTCESS Rate','INPUTIGSTCESS Rate','INPUTUTGSTCESS Rate','INPUTGSTCESS Rate','INPUTGSTCESS Value',
		'CGSTCESS Rate','SGSTCESS Rate','IGSTCESS Rate','UTGSTCESS Rate','CESS Rate','GSTCESS Rate','GSTCESS Value') --ILCRSTBOT0006
		

		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[TaxableAmountCESS],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT  '' AS [GRN No],'' AS [GRN date],NULL, 0 [InvId],'' AS [RefNo],'' AS [ODN Number],'' AS [SupplierCode],'' AS [SupplierName],''AS [SupplierAddress],'' AS [Supplier GSTIN],
		'' AS [Supplier State],'' AS [Product Name] ,'' AS [Product Code],'' AS [HSN Code],0 [SpmId],0 as Prdid,0 as [InvQty],0 as[CmpId],  [TaxPerc] ,0 as [TaxableAmount],0 [TaxableAmountCESS],'' as [IOTaxType] ,
		100 as [TaxFlag],SUM([TaxPercent]) as [TaxPercent],0 as [TaxId],0 as  LineNetAmount,0 as [UPC],'ZZZZZZ' as [Group Name],3 as [GroupType],[UsrId]
		FROM #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
		SELECT StateCode,StateName,TinFirst2Digit,MasterRecordId
		INTO #SupplierState 
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
		and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
		INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue and E.StateName=C.ColumnValue
		WHERE MasterName='Supplier Master' and ColumnName='State Name'
		
					
		UPDATE A  SET A.[Supplier State]=B.StateName 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierState  B  ON A.Spmid=B.MasterRecordId
		
		SELECT MasterRecordId,ColumnName AS SupplierGSTIN
		INTO #SupplierGSTIN
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId	
		WHERE MasterName='Supplier Master' and ColumnName='GSTIN'
		
        UPDATE A  SET A.[Supplier GSTIN]=B.SupplierGSTIN 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierGSTIN  B  ON A.Spmid=B.MasterRecordId
		
		
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master' and ColumnName='HSN Code'
		
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
        SELECT DISTINCT
		[GRN No],[GRN date],[InvDate],[InvId],[RefNo],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],
		[TaxableAmount],[IOTaxType],[TaxFlag],LineNetAmount,[UsrId]
		INTO #LineLevelGross	
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY NVARCHAR(MAX)--ILCRSTBOT0006
		
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''

		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)
		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId	

		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxperc)+'),0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		
		SET @ColSelect='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'InvDate,[ODN Number],[Product Code],[Product Name],[HSN Code],[UPC],SUM(InvQty) InvQty,SUM(TaxableAmount) TaxableAmount,SUM(TaxableAmountCESS) TaxableAmountCESS,'+@ColSelect+'SUM(LineNetAmount) LineNetAmount,'+
		'[Group Name],[GroupType],[UsrId]'

		SET @GROUPBY = ' GROUP BY SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
					'InvDate,[ODN Number],[Product Code],[Product Name],[HSN Code],[UPC],[Group Name],[GroupType],[UsrId]'
				
		SET @TableCol= 'Slno BIGINT IDENTITY(1,1),[SupplierCode] Varchar(75),[SupplierName] Varchar(150),[SupplierAddress] Varchar(150),[Supplier GSTIN] Varchar(150),'+
        '[Supplier State] Varchar(150),[IOTaxType] [varchar](100) NULL,[GRN No] NVarchar(100),[GRN date] DateTime,[Invoice Number] NVarchar(100),[Invoice Date] Datetime,[ODN Number] Varchar(100),'+
        '[Product Code] Varchar(75),[Product Name] Varchar(150),[HSN Code] Varchar(50),UPC INT,[InvQty] [int] NULL,[TaxableAmount] [numeric](38, 6) NULL,[TaxableAmountCESS] [numeric](38, 6) NULL,'
		
		SET @Columns1='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'Invdate,[ODN Number],[Product Code],[Product Name],[HSN Code],UPC,[InvQty],[TaxableAmount],[TaxableAmountcess],LineNetAmount,TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,Invdate,SupplierName,[Product Name]'
		
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptPurchaseTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptPurchaseTaxGST'+
		' CREATE TABLE RptPurchaseTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),[Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--PRINT @CreateTable
	    EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptPurchaseTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBY + @OrderBy
		--PRINT @SQL
		EXEC(@SQL)
		
		
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,SUM(TaxableAmount) as TaxableAmount
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount 
		FROM RptPurchaseTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,402,'Product Wise Input Tax',1,'Supplier State',20,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',2,'SupplierCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',3,'SupplierName',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',4,'SupplierAddress',75,1,0,1,1,'Supplier','Address','',0,GETDATE()			
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',5,'IOTaxType',75,1,0,1,1,'Purchase/','PurReturn','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',6,'GRN No',75,1,0,1,1,'GRN.','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',7,'GRN date',75,1,0,1,4,'GRN.','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',8,'Invoice Number',75,1,0,1,1,'Comp InvoiceNo/','ReturnRefNo','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',9,'Invoice Date',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',10,'[ODN Number]',75,1,0,1,1,'Purchase Order','Number','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',11,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',12,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',13,'HSN Code',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',14,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',15,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',16,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',17,'TaxableAmountCESS',20,1,0,2,3,'Taxable','AmountCESS','',2,GETDATE()
		
		
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM  SYSOBJECTS WHERE NAME='Proc_RptSalesReturnCNTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptSalesReturnCNTaxGST
GO
/*
Begin tran
EXEC Proc_RptSalesReturnCNTaxGST 403,2,0,'Gjnj',0,0,1
Select * from RptSalesReturnCNTaxGST
Rollback tran 
*/
CREATE  PROCEDURE Proc_RptSalesReturnCNTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptProductWiseSalesTaxGST
* PURPOSE	: To get the Tax details
* CREATED	: Mohanakrishna A.B
* CREATED DATE	: 12/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}

* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR				Included CESS Tax
* 07-03-2019	MOHANA S	    ILCRSTPAR3750	   CR		KERALA CESS CHANGES
*********************************/
BEGIN
SET NOCOUNT ON
--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptSalesReturnCNTaxGST')
	BEGIN
		DELETE FROM RptSalesReturnCNTaxGST WHERE UsrId=@Pi_UsrId
	END
	
	
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[RetailerCode] Varchar(75),
			[RetailerName] Varchar(150),
			[RtrGSTIN] Varchar(150),
			RtrStateCode Varchar(20),
			RtrStateName Varchar(150),
			RtrShipAdd Varchar(150),
			RtrShipAdd1 Varchar(150),
			[IOTaxType] [varchar](100) NULL,
			[Product Code] Varchar(75),	
			[Product Name] Varchar(150),
			[Item HSN/ SAC] [varchar](100) NULL,
			[InvQty] [int] NULL,
			[SRid] [Int],
			[SR Number] [varchar](100) NULL,
			[SRDate] DateTime,
			[Salid] [int],
			[Original Inv] [varchar](100) NULL,
			[OriginalDate] DateTime,
			[CN Number] [varchar](100) NULL,
			[CNDate] DateTime,
			[RtrId] [int] NULL,
			[Prdid] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[TaxableAmount] [numeric](38, 6) NULL,
			[TaxableAmountCESS] [numeric](38, 6) NULL,
			[LineNetAmount] [numeric](38, 6) NULL,
			[ReverseCharge] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
			)
			
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary
			(
			[RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],
			[Item HSN/ SAC],[InvQty],[SRid],[SR Number],[SRDate],[Salid],
			[Original Inv],[OriginalDate],[CN Number],[CNDate],[RtrId],[Prdid],[CmpId],
			[TaxPerc],[TaxFlag],[TaxPercent],[TaxId],[TaxableAmount],[TaxableAmountCESS],LineNetAmount,[ReverseCharge],[UPC],[Group Name] ,
			[GroupType],[UsrId]
			) 
		Select
		RtrCode,RtrName,'' AS RtrGSTIN,'' as RtrStateCode,'' as RtrStateName,'' as RtrShipAdd,'' as RtrShipAdd1,'SalesReturn' as IOTaxType,PrdCCode,PrdName,
		'' As [Item HSN/ SAC],SUM(RP.BaseQty) AS InvQty,RH.Returnid As [SRid],RH.ReturnCode AS [SR Number],Rh.ReturnDate,RH.SalId AS [Salid],
		SI.SalinvNo AS [Original Inv],SI.SalInvDate AS [OriginalDate],CN.CNRRefNo AS [CN Number],CN.CNRDate  AS [CNDate],R.RtrId AS RtrId,P.PrdId as Prdid,C.CmpId AS CmpId,
		TC.TaxCode +' Rate' as TaxPerc,0 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,SUM(TaxableAmt) as TaxableAmount,0 AS TaxableAmountCESS,SUM(PrdNetAmt) as [LineNetAmount],	
		ReverseCharges as [ReverseCharge],[UPC],
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId  
		INNER JOIN #UOM U ON U.PrdId=RP.PrdId and U.PrdId=P.PrdId  
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN SalesInvoice SI WITH (NOLOCK) ON SI.SalId=RH.SalId --ABM
		INNER JOIN CreditNoteReplacementHD CN WITH (NOLOCK) ON CN.SRNO =RH.ReturnCode
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0  and  CN.CNRDate  Between @FromDate and @ToDate --and RH.ReturnDate  Between @FromDate and @ToDate 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		GROUP BY TaxPerc,RH.ReturnDate,RH.SalId,SI.SalinvNo,SI.SalInvDate,CN.CNRRefNo,CN.CNRDate,
		P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(TaxableAmt) > 0  
		
		INSERT INTO #TmpRptIOTaxSummary
		(
			[RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],
			[Item HSN/ SAC],[InvQty],[SRid],[SR Number],[SRDate],[Salid],
			[Original Inv],[OriginalDate],[CN Number],[CNDate],[RtrId],[Prdid],[CmpId],
			[TaxPerc],[TaxFlag],[TaxPercent],[TaxId],[TaxableAmount],[TaxableAmountCESS],LineNetAmount,[ReverseCharge],[UPC],[Group Name] ,
			[GroupType],[UsrId]
		) 
		
		Select
		RtrCode,RtrName,'' AS RtrGSTIN,'' as RtrStateCode,'' as RtrStateName,'' as RtrShipAdd,'' as RtrShipAdd1,'SalesReturn' as IOTaxType,PrdCCode,PrdName,
		'' As [Item HSN/ SAC],SUM(RP.BaseQty) AS InvQty,RH.Returnid As [SRid],RH.ReturnCode AS [SR Number],Rh.ReturnDate,RH.SalId AS [Salid],
		SI.SalinvNo AS [Original Inv],SI.SalInvDate AS [OriginalDate],CN.CNRRefNo AS [CN Number],CN.CNRDate  AS [CNDate],R.RtrId AS RtrId,P.PrdId as Prdid,C.CmpId AS CmpId,
		TC.TaxCode +' Value' as TaxPerc,1 as TaxFlag,SUM(RPT.TaxAmt) as TaxPercent,RPT.TaxId,SUM(TaxableAmt) as TaxableAmount,0 AS TaxableAmountCESS,SUM(PrdNetAmt) as [LineNetAmount],
		ReverseCharges as [ReverseCharge],[UPC],	
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId 
		From ReturnHeader RH WITH (NOLOCK)  
		INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
		INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =RPT.TaxId 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId  
		INNER JOIN #UOM U ON U.PrdId=RP.PrdId and U.PrdId=P.PrdId    
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId  
		LEFT OUTER JOIN SalesInvoice SI WITH (NOLOCK) ON SI.SalId=RH.SalId 
		INNER JOIN CreditNoteReplacementHD CN WITH (NOLOCK) ON CN.SRNO =RH.ReturnCode
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE RH.Status = 0   and  CN.CNRDate  Between @FromDate and @ToDate --and RH.ReturnDate  Between @FromDate and @ToDate 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		GROUP BY TaxPerc,RH.ReturnDate,RH.SalId,SI.SalinvNo,SI.SalInvDate,CN.CNRRefNo,CN.CNRDate,
		P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,RPT.TaxId,RtrName,
		RtrCode,PrdName,PrdCCode ,RPT.TaxId ,C.CmpId,TC.TaxCode,[UPC],ReverseCharges
		HAVING Sum(TaxableAmt) > 0
				
	
		UPDATE A SET LineNetAmount=0,InvQty=0,[TaxableAmountCESS] = TaxableAmount ,TaxableAmount = 0 FROM #TmpRptIOTaxSummary A WHERE TAXPERC IN ('OUTPUTCGSTCESS Value','OUTPUTSGSTCESS Value','OUTPUTIGSTCESS Value',
		'OUTPUTUTGSTCESS Value','CGSTCESS Value','SGSTCESS Value','IGSTCESS Value','UTGSTCESS Value','CESS Value',
		'OUTPUTCGSTCESS Rate','OUTPUTSGSTCESS Rate','OUTPUTIGSTCESS Rate','OUTPUTUTGSTCESS Rate','OUTPUTGSTCESS Rate','OUTPUTGSTCESS Value','GSTCESS Rate','GSTCESS Value',
		'CGSTCESS Rate','SGSTCESS Rate','IGSTCESS Rate','UTGSTCESS Rate','CESS Rate') --ILCRSTBOT0006


		INSERT INTO #TmpRptIOTaxSummary
		(
			[RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],
			[Item HSN/ SAC],[InvQty],[SRid],[SR Number],[SRDate],[Salid],
			[Original Inv],[OriginalDate],[CN Number],[CNDate],[RtrId],[Prdid],[CmpId],
			[TaxPerc],[TaxFlag],[TaxPercent],[TaxId],[TaxableAmount],[TaxableAmountCESS],LineNetAmount,[ReverseCharge],[UPC],[Group Name] ,
			[GroupType],[UsrId]
		) 
		SELECT '' as [RetailerCode],'' as [RetailerName],'' AS RtrGSTIN,'' as RtrStateCode,'' as RtrStateName,'' as RtrShipAdd,'' as RtrShipAdd1,'' as IOTaxType,
		'' as [Product Code],'' as [Product Name],'' As [Item HSN/ SAC],'' AS InvQty,'' As [SRid],'' AS [SR Number],'' AS  SRDate,'' AS [Salid],
		'' AS [Original Inv],'' AS [OriginalDate],'' AS [CN Number],''  AS [CNDate],'' AS RtrId,'' as Prdid,'' AS CmpId,
		[TaxPerc],100 as TaxFlag,SUM(TaxPercent) AS TaxPercent,0 as TaxId,0 as TaxableAmount,0 as TaxableAmountCESSS,0 as [LineNetAmount],
		0 as [ReverseCharge],0 as [UPC]	,
		'ZZZZZZ' as [Group Name] ,3 as [GroupType],[UsrId] 
		From #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
		
		SELECT StateCode,StateName,TinFirst2Digit,MasterRecordId
		INTO #RetailerState 
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
		and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
		INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue and E.StateName=C.ColumnValue
		WHERE MasterName='Retailer Master' and ColumnName='State Name'
		
		---Commented and Added by MOHANA at 07-03-2019
		--Update B SET  B.[RtrGSTIN]=R.[ColumnValue] FROM #TmpRptIOTaxSummary B 
		--INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue from UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId
		--					INNER JOIN retailer R on R.RtrId=U.MasterRecordId  where US.MasterId=2   and ColumnName='GSTIN' ) 
		--					R ON B.[RetailerCode]=R.[rtrcode]
		Update B SET  B.[RtrGSTIN]=S.GSTIN FROM #TmpRptIOTaxSummary B 
		INNER JOIN ReturnHeader RH (Nolock) ON B.SRid=RH.ReturnID
		INNER JOIN Salesinvoice S (Nolock) ON S.SalId=RH.SalId
							
							
	
		UPDATE A  SET A.RtrStateCode=B.StateCode ,A.RtrStateName=B.StateName 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #RetailerState  B  ON A.RtrId=B.MasterRecordId
		
		UPDATE A  SET A.RtrShipAdd=B.RtrShipAdd1 ,A.RtrShipAdd1=B.RtrShipAdd2 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  RetailerShipAdd  B  ON A.RtrId=B.RtrId --and A.RtrShipId=B.RtrShipId
		
		UPDATE A  SET A.RtrShipAdd=RS.RtrShipAdd1 ,A.RtrShipAdd1=RS.RtrShipAdd2 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  ReturnHeader B ON A.[SRid]=B.ReturnID
		INNER JOIN SalesInvoice S ON S.SalId=B.SalId
		INNER JOIN RetailerShipAdd RS ON RS.RtrId=S.RtrId and RS.RtrShipId=S.RtrShipId
		WHERE IOTaxType='SalesReturn'
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptSalesReturnCNTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptSalesReturnCNTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
		SELECT DISTINCT
			[RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],
			[Item HSN/ SAC],[InvQty],[SRid],[SR Number],[SRDate],[Salid],
			[Original Inv],[OriginalDate],[CN Number],[CNDate],[RtrId],[Prdid],[CmpId],
			[TaxFlag],[TaxableAmount],LineNetAmount,[ReverseCharge],[UPC],[Group Name] ,
			[GroupType],[UsrId]
		INTO #LineLevelGross
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
	
		
		
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY NVARCHAR(MAX)--ILCRSTBOT0006
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)

		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId
		
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxperc)+'),0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		

	
		
		SET @ColSelect='SELECT [RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],'+
			'[Item HSN/ SAC],[UPC],SUM([InvQty]) [InvQty],[SR Number],[SRDate],[Original Inv],[OriginalDate],[CN Number],[CNDate],SUM([TaxableAmount]) [TaxableAmount],'+
			' SUM([TaxableAmountCESS]) [TaxableAmountCESS],'+@ColSelect+'SUM(LineNetAmount) LineNetAmount,SUM([ReverseCharge]) [ReverseCharge],[Group Name],[GroupType],[UsrId]'

		SET @GROUPBY = 'GROUP BY [RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode,RtrStateName,RtrShipAdd,RtrShipAdd1,[IOTaxType],[Product Code],[Product Name],'+
			'[Item HSN/ SAC],[UPC],[SR Number],[SRDate],[Original Inv],[OriginalDate],[CN Number],[CNDate],[Group Name],[GroupType],[UsrId]'

	   	SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),[RetailerCode] Varchar(75),[RetailerName] Varchar(150),[RtrGSTIN] Varchar(150),RtrStateCode Varchar(20),RtrStateName Varchar(150),'+
			'RtrShipAdd Varchar(150),RtrShipAdd1 Varchar(150),[IOTaxType] [varchar](100) NULL,[Product Code] Varchar(75),[Product Name] Varchar(150),[Item HSN/ SAC] [varchar](100) NULL,'+
			'[UPC] INT,[InvQty] [int] NULL,[SR Number] [varchar](100) NULL,[SRDate] DateTime,[Original Inv] [varchar](100) NULL,[OriginalDate] DateTime,[CN Number] [varchar](100) NULL,'+
			'[CNDate] DateTime,[TaxableAmount] [numeric](38, 6) NULL,[TaxableAmountcess] [numeric](38, 6) NULL,'
		
		SET @Columns1='SELECT [RetailerCode],[RetailerName],[RtrGSTIN],RtrStateCode ,RtrStateName ,RtrShipAdd ,'+
			'RtrShipAdd1,[IOTaxType],[Product Code],[Product Name] ,[Item HSN/ SAC],'+
			'[UPC],[InvQty],[SR Number],[SRDate],[Original Inv] ,[OriginalDate],[CN Number],'+
			'[CNDate] ,[TaxableAmount],[TaxableAmountcess],LineNetAmount,[ReverseCharge],TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
			
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,RetailerName,[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptSalesReturnCNTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptSalesReturnCNTaxGST'+
		' CREATE TABLE RptSalesReturnCNTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),ReverseCharge Numeric(36,2), [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--Select  * from #TmpRptIOTaxSummary
		--Print  @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptSalesReturnCNTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBY +  @OrderBy
		---PRINT @SQL
		EXEC(@SQL)
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,SUM(TaxableAmount) as TaxableAmount,
		SUM(ReverseCharge) as ReverseCharge
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount,
		Y.ReverseCharge=X.ReverseCharge 
		FROM RptSalesReturnCNTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,403,'Sales Return Product Tax',1,'RetailerCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',2,'RetailerName',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',3,'RtrGSTIN',50,1,0,1,1,'Retailer','GSTIN','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',4,'RtrStateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',5,'RtrStateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',6,'RtrShipAdd',75,1,0,1,1,'Retailer','Shipping','Address',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',7,'RtrShipAdd1',75,1,0,1,1,'Retailer','Shipping','Address2',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',8,'IOTaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',9,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',10,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',11,'[Item HSN/ SAC]',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',12,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',13,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',14,'SR Number',75,1,0,1,1,'SalesReturn','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',15,'SRDate',75,1,0,1,4,'SalesReturn','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',16,'Original Inv',75,1,0,1,1,'Sales','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',17,'OriginalDate',75,1,0,1,4,'Sales','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',18,'CN Number',75,1,0,1,1,'CreditNote','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',19,'CNDate',75,1,0,1,4,'CreditNote','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',20,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
			UNION ALL
			SELECT 1,403,'Sales Return Product Tax',21,'TaxableAmountCESS',20,1,0,2,3,'Taxable','AmountCESS','',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+2,'ReverseCharge',
			18,1,0,2,3,'Reverse','Charge','',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
	
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptSalesReturnCNTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptSalesReturnCNTaxGST WHERE UsrId=@Pi_UsrId
						
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptOutputSaleTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptOutputSaleTaxGST
GO
/*
BEGIN tran
EXEC Proc_RptOutputSaleTaxGST 404,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE Proc_RptOutputSaleTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptOutputSaleTaxGST
* PURPOSE	: To get the Output Tax
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 29-10-2018	MOHANA S	   ILCRSTBOT0006	   CR		UPDATED ZERO FOR QTY AND NETAMOUNT IF THE TAX PERC IS CESS and Included CESS Tax
* 07-03-2019	MOHANA S	    ILCRSTPAR3750	   CR		KERALA CESS CHANGES
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptOutputSaleTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			RetailerType Varchar(25),
			RtrCode Varchar(50),
			Rtrname Varchar(100),	
			Refid BIGINT,
			RefNo Varchar(50),
			RefDate DateTime,
			RtrId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCess Numeric(32,4), --ADDED BY MOHANA ILCRSTBOT0006
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		
		SELECT Salid,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #SalesTaxableAmount
		FROM(
		SELECT S.Salid,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount--ADDED BY MOHANA ILCRSTBOT0006
		FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
		WHERE  TaxableAmount>0 and DlvSts>3
		AND SI.SalInvDate  Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.Salid,PrdSlno ,TaxId
		)X GROUP BY Salid,Prdslno,TaxId
		
		SELECT ReturnID,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #RetunrTaxableAmount
		FROM(
		SELECT S.ReturnID,PrdSlno,TaxId,SUM(DISTINCT TaxableAmt) as TaxableAmount--ADDED BY MOHANA ILCRSTBOT0006
		FROM ReturnProductTax  S  (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnID=SI.ReturnID
		WHERE  TaxableAmt>0 AND SI.ReturnDate  Between @FromDate AND @ToDate and Status=0
		GROUP BY S.ReturnID,PrdSlno,TaxId
		)X GROUP BY  ReturnID,Prdslno,TaxId

		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,SPT.TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0 and DlvSts>3
		GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalinvNo,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(TaxAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId 
		and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo AND ST.TaxId = SPT.TaxId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId 
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and DlvSts>3
		GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalInvNo,SPT.TaxId,RtrCode,Rtrname
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),0 as TaxableAmountCess,-1*SUM(PrdNetAmt) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxableAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID 
		and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  AND ST.TaxID = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE ReturnDate	Between @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),0 as TaxableAmountCess,-1*SUM(PrdNetAmt) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  AND ST.TaxID = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId		
		WHERE ReturnDate between  @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname

		--ILCRSTBOT0006
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','INputGSTCESS','OutputGSTCESS','GSTCESS')


		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		--ILCRSTBOT0006

	
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,
		Refid,RefNo,RefDate,RtrId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
		
		---Commented and Added by MOHANA at 07-03-2019
		--UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		--B.Statename=A.StateName,
		--B.GSTIN=A.GSTIN,
		--B.RetailerType=CASE A.RetailerType WHEN 1 THEN 'Registered'
		--WHEN 2 THEN 'Unregistered' END
		--FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId
		
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName
		FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId
		
		UPDATE A SET A.GSTIN=Isnull(S.GSTIN,''),
		A.RetailerType=CASE S.RtrType WHEN 'R' THEN  'Registered'
		ELSE 'Unregistered' END
		FROM #TaxHSNSummary A 		
		INNER JOIN SalesInvoice S ON S.SalId=A.Refid
		WHERE TaxType='Sales of Goods'
		
		UPDATE A SET A.GSTIN=Isnull(S.GSTIN,''),
		A.RetailerType=CASE S.RtrType WHEN 'R' THEN  'Registered'
		ELSE 'Unregistered' END
		FROM #TaxHSNSummary A 
		INNER JOIN ReturnHeader RH ON A.Refid=RH.ReturnID		
		INNER JOIN SalesInvoice S ON S.SalId=RH.SalId
		WHERE TaxType='Return of Goods from Retailer'
		
		---Till Here ---
		
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @SumCol AS VARCHAR(MAX)
		DECLARE @GroupByCol as VARCHAR(MAX)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @SumCol=''
		SET @GroupByCol=''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
		
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		
		SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		--SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,SUM(TaxableAmount) as TaxableAmount,SUM(TaxableAmountCESS) as TaxableAmountCESS,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		
		SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
		
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		RetailerType Varchar(25),
		RtrId INT,
		RtrCode Varchar(50),
		Rtrname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		RefDate DateTime,	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(32,2),
		TaxableAmountCESS Numeric(32,2),
		'
		SET @Columns1='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,TaxableAmountCESS,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptOutputSaleTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptOutputSaleTaxGST'+
		' CREATE TABLE RptOutputSaleTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptOutputSaleTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+@GroupByCol+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		--ADDED BY MOHANA ILCRSTBOT0006 (TAXABLE CESS)
		
				
		
		--EXEC Proc_RptOutputSaleTaxGST 404,1,0,'GSTTAX',0,0,1
		SELECT DISTINCT
		StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,
		TaxableAmount,
		NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,
		Y.NetAmount=X.NetAmount
		FROM RptOutputSaleTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
	
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,404,'Output Tax Summary',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',9,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',10,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',11,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE() --ADDED BY MOHANA ILCRSTBOT0006
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
			
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptOutputSaleTaxGST)
			BEGIN
				SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM  SYSOBJECTS WHERE NAME='Proc_RptInputtaxCreditGST' AND TYPE='P')
DROP PROCEDURE Proc_RptInputtaxCreditGST
GO
/*
BEGIN tran
EXEC Proc_RptInputtaxCreditGST 405,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE Proc_RptInputtaxCreditGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputtaxCreditGST
* PURPOSE	: To get the Input Tax
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptInputtaxCreditGST
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			SpmCode Varchar(50),
			Spmname Varchar(100),	
			Refid BIGINT,
			RefNo Varchar(50),
			CmpInvno Varchar(50),
			PurchaseOrderNo Varchar(50),
			InvoiceDate Datetime,
			RefDate DateTime,
			SpmId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCESS Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT PurRcptId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseTaxableAmount
		FROM(
		SELECT S.PurRcptId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId
		WHERE  TaxableAmount>0 and Status=1
		AND SI.InvDate   Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.PurRcptId,PrdSlno ,TaxId
		)X GROUP BY PurRcptId,Prdslno,TaxId
		
		SELECT PurRetId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseRtnTaxableAmount
		FROM(
		SELECT S.PurRetId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId
		WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1
		GROUP BY S.PurRetId,PrdSlno,TaxId
		)X GROUP BY  PurRetId,Prdslno,TaxId
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		WHERE InvDate Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		
		
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 as TaxableAmountCess,SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE InvDate Between @FromDate and @ToDate
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCess,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCess,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCess,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		--ILCRSTBOT0006
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','OutputGSTCESS','GSTCESS','CESS','InputGSTCESS')


		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		--ILCRSTBOT0006
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,
		Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,NUll,Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
	
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN
		FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId
		
		SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo
		INTO #Refcode
		FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId
		
		UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo 
		FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @SumCol AS Varchar(Max)
		DECLARE @GroupByCol AS VARCHAR(Max)
		SET @GroupByCol=''
		SET @SumCol=''
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		--SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,TaxableAmountCess,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		
		SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,SUM(TaxableAmount) as TaxableAmount,SUM(TaxableAmountCESS) as TaxableAmountCESS,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
	
		
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		SpmId INT,
		SpmCode Varchar(50),
		Spmname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		CmpInvno Varchar(50),
		PurchaseOrderNo Varchar(50),
		InvoiceDate Datetime,
		RefDate DateTime,
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),
		TaxableAmountCESS Numeric(34,2),
		'
		SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,TaxableAmountCESS,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptInputtaxCreditGST'' and XTYPE=''U'')'+
		' DROP TABLE RptInputtaxCreditGST'+
		' CREATE TABLE RptInputtaxCreditGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptInputtaxCreditGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GroupByCol+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		SELECT DISTINCT
		StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptInputtaxCreditGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,405,'Input Tax Summary',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',9,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',10,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',11,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',12,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',13,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
	
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptInputtaxCreditGST)
			BEGIN
				SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM  SYSOBJECTS WHERE NAME='RptInputOutPutGSTTax' AND TYPE='U')
DROP TABLE RptInputOutPutGSTTax
GO
CREATE TABLE RptInputOutPutGSTTax
(
	[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
	[Product Name] [varchar](150) NULL,
	[Product Code] [varchar](75) NULL,
	[HSN Code] [varchar](50) NULL,
	[InPutQty] [int] NULL,
	[OutPutQty] [int] NULL,
	[TaxableAmount] [numeric](38, 6) NULL,
	[InputCGST Rate] [numeric](36, 2) NULL,
	[InputCGST Value] [numeric](36, 2) NULL,
	[InputSGST Rate] [numeric](36, 2) NULL,
	[InputSGST Value] [numeric](36, 2) NULL,
	[InputIGST Rate] [numeric](36, 2) NULL,
	[InputIGST Value] [numeric](36, 2) NULL,
	[InputUTGST Rate] [numeric](36, 2) NULL,
	[InputUTGST Value] [numeric](36, 2) NULL,
	[InputCGSTCESS Rate] [numeric](36, 2) NULL,
	[InputCGSTCESS Value] [numeric](36, 2) NULL,
	[InputSGSTCESS Rate] [numeric](36, 2) NULL,
	[InputSGSTCESS Value] [numeric](36, 2) NULL,
	[InputIGSTCESS Rate] [numeric](36, 2) NULL,
	[InputIGSTCESS Value] [numeric](36, 2) NULL,
	[InputUTGSTCESS Rate] [numeric](36, 2) NULL,
	[InputUTGSTCESS Value] [numeric](36, 2) NULL,
	[InputGSTCESS Rate] [numeric](36, 2) NULL,
	[InputGSTCESS Value] [numeric](36, 2) NULL,
	[OutputCGST Rate] [numeric](36, 2) NULL,
	[OutputCGST Value] [numeric](36, 2) NULL,
	[OutputSGST Rate] [numeric](36, 2) NULL,
	[OutputSGST Value] [numeric](36, 2) NULL,
	[OutputIGST Rate] [numeric](36, 2) NULL,
	[OutputIGST Value] [numeric](36, 2) NULL,
	[OutputUTGST Rate] [numeric](36, 2) NULL,
	[OutputUTGST Value] [numeric](36, 2) NULL,
	[OutputCGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputCGSTCESS Value] [numeric](36, 2) NULL,
	[OutputSGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputSGSTCESS Value] [numeric](36, 2) NULL,
	[OutputIGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputIGSTCESS Value] [numeric](36, 2) NULL,
	[OutputUTGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputUTGSTCESS Value] [numeric](36, 2) NULL,
	[OutputGSTCESS Rate] [numeric](36, 2) NULL,
	[OutputGSTCESS Value] [numeric](36, 2) NULL,
	[DiffCGST Value] [numeric](36, 2) NULL,
	[DiffSGST Value] [numeric](36, 2) NULL,
	[DiffIGST Value] [numeric](36, 2) NULL,
	[DiffUTGST Value] [numeric](36, 2) NULL,
	[DiffCGSTCESS Value] [numeric](36, 2) NULL,
	[DiffSGSTCESS Value] [numeric](36, 2) NULL,
	[DiffIGSTCESS Value] [numeric](36, 2) NULL,
	[DiffUTGSTCESS Value] [numeric](36, 2) NULL,
	[DiffGSTCESS Value] [numeric](36, 2) NULL,
	[Group Name] [varchar](100) NULL,
	[Grouptype] [tinyint] NULL,
	[UsrId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptInputOutputProductWiseGSTTax' AND TYPE='P')
DROP PROCEDURE Proc_RptInputOutputProductWiseGSTTax
GO
---EXEC Proc_RptInputOutputProductWiseGSTTax 407,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptInputOutputProductWiseGSTTax
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputOutputProductWiseGSTTax
* PURPOSE	: To get the Tax details
* CREATED	: Murugan.R
* CREATED DATE	: 12/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	        CR		ILCRSTBOT0006			Included CESS Tax	  
************************************************************************************************************************************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptInputOutPutGSTTax')
	BEGIN
		TRUNCATE TABLE RptInputOutPutGSTTax
	END
	
	IF EXISTS(SELECT NAME FROM Tempdb..SYSOBJECTS WHERE XTYPE='U' AND NAME='##RptInputOutPutGSTTax')
	BEGIN
		DROP TABLE ##RptInputOutPutGSTTax
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[Prdid] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			InputQty INT,
			OutPutQty INT,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,			
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		CREATE TABLE #PurchaseVsSales
		(
			TransId TinyInt,
			PrdId INT,
			InOutPutQty INT,
			TaxableAmount Numeric(32,4),
			TaxAmount Numeric(25,4),
			TaxPerc Numeric(10,2),
			TaxId INT
		)
		
		
		CREATE TABLE ##RptInputOutPutGSTTax(
		[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
		[Product Name] [varchar](150) NULL,
		[Product Code] [varchar](75) NULL,
		[HSN Code] [varchar](50) NULL,
		[InPutQty] [int] NULL,
		[OutPutQty] [int] NULL,
		[TaxableAmount] [numeric](38, 6) NULL,
		[InputCGST Rate] [numeric](36, 2) NULL,
		[InputCGST Value] [numeric](36, 2) NULL,
		[InputSGST Rate] [numeric](36, 2) NULL,
		[InputSGST Value] [numeric](36, 2) NULL,
		[InputIGST Rate] [numeric](36, 2) NULL,
		[InputIGST Value] [numeric](36, 2) NULL,
		[InputUTGST Rate] [numeric](36, 2) NULL,
		[InputUTGST Value] [numeric](36, 2) NULL,
		[InputCGSTCESS Rate] [numeric](36, 2) NULL,
		[InputCGSTCESS Value] [numeric](36, 2) NULL,
		[InputSGSTCESS Rate] [numeric](36, 2) NULL,
		[InputSGSTCESS Value] [numeric](36, 2) NULL,
		[InputIGSTCESS Rate] [numeric](36, 2) NULL,
		[InputIGSTCESS Value] [numeric](36, 2) NULL,
		[InputUTGSTCESS Rate] [numeric](36, 2) NULL,
		[InputUTGSTCESS Value] [numeric](36, 2) NULL,
		[InputGSTCESS Rate] [numeric](36, 2) NULL,
		[InputGSTCESS Value] [numeric](36, 2) NULL,
		[OutputCGST Rate] [numeric](36, 2) NULL,
		[OutputCGST Value] [numeric](36, 2) NULL,
		[OutputSGST Rate] [numeric](36, 2) NULL,
		[OutputSGST Value] [numeric](36, 2) NULL,
		[OutputIGST Rate] [numeric](36, 2) NULL,
		[OutputIGST Value] [numeric](36, 2) NULL,
		[OutputUTGST Rate] [numeric](36, 2) NULL,
		[OutputUTGST Value] [numeric](36, 2) NULL,
		[OutputCGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputCGSTCESS Value] [numeric](36, 2) NULL,
		[OutputSGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputSGSTCESS Value] [numeric](36, 2) NULL,
		[OutputIGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputIGSTCESS Value] [numeric](36, 2) NULL,
		[OutputUTGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputUTGSTCESS Value] [numeric](36, 2) NULL,
		[OutputGSTCESS Rate] [numeric](36, 2) NULL,
		[OutputGSTCESS Value] [numeric](36, 2) NULL,
		[Group Name] [varchar](100) NULL,
		[Grouptype] [tinyint] NULL,
		[UsrId] [int] NULL
		)

		CREATE TABLE #SalesInvoiceProductTax
		(
		[SalId] [bigint] NOT NULL,
		[PrdSlNo] [int] NOT NULL,
		[TaxId] [int] NOT NULL,
		[TaxPerc] [numeric](10, 6) NOT NULL,
		[TaxableAmount] [numeric](18, 6) NOT NULL,
		[TaxAmount] [numeric](18, 6) NOT NULL
		)

		INSERT INTO #PurchaseVsSales(TransId,PrdId,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)		
		SELECT 1 as TransId ,Prdid,SUM(InputQty) as InputQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM
		(
			SELECT PrdId ,SUM(PRP.RcvdGoodBaseQty) as InputQty,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(PRPT.TaxAmount) as TaxAmount,TaxPerc ,PRPT.TaxId		
			FROM 
			PurchaseReceipt PR WITH (NOLOCK)  
			INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
			INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId
			HAVING Sum(TaxableAmount) >0  
			UNION ALL
			SELECT Prdid,-1*SUM(RetSalBaseQty+RetUnSalBaseQty) as InputQty,
					-1*SUM(PRPT.TaxableAmount) as TaxableAmount,
					-1*SUM(PRPT.TaxAmount) as TaxAmount, TaxPerc ,PRPT.TaxId
			
			FROM 
			PurchaseReturn  PR WITH (NOLOCK)  
			INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
			INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId
			HAVING SUM(TaxableAmount) >0 		
		)X GROUP BY Prdid,TaxPerc,TaxId
		
		
		
		INSERT INTO #PurchaseVsSales(TransId,PrdId,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)
		SELECT 2 as TransId ,Prdid,SUM(OutPutQty) as OutPutQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM(
				SELECT Prdid,SUM(BaseQty) as OutPutQty,
				SUM(TaxableAmount)	AS TaxableAmount,
				SUM(TaxAmount) as TaxAmount,TaxPerc,SPT.TaxId
				FROM 
				SalesInvoice SI WITH (NOLOCK)  
				INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
				INNER JOIN SalesInvoiceProductTax SPT  ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
				WHERE SI.Salinvdate Between @FromDate and @ToDate
				and SI.Dlvsts >3 and VatGst='GST' and SPT.TaxableAmount>0
				GROUP BY TaxPerc,PrdId,SPT.TaxId				
				UNION ALL
				Select Prdid,-1*SUM(BaseQty) as OutPutQty,	
				-1*SUM(TaxableAmt) AS TaxableAmount	,
				-1*SUM(RPT.TaxAmt),TaxPerc,RPT.TaxID
				FROM ReturnHeader RH WITH (NOLOCK)  
				INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
				INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
				WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate and VatGst='GST'
				and RPT.TaxableAmt>0
				GROUP BY TaxPerc,PrdId,RPT.TaxId
				 
		) X GROUP BY Prdid,TaxPerc,TaxId
			
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Rate'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Rate'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Rate'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Rate'
				WHEN TaxCode IN('InputIGSTCESS','IGSTCESS') THEN 'InputIGSTCESS Rate'
				WHEN TaxCode IN ('InputCGSTCESS','CGSTCESS') Then 'InputCGSTCESS Rate'
				WHEN TaxCode IN ('InputSGSTCESS','SGSTCESS') Then 'InputSGSTCESS Rate'
				WHEN TaxCode IN ('InputUTGSTCESS','UTGSTCESS') Then 'InputUTGSTCESS Rate'				
				WHEN TaxCode IN ('InputGSTCESS','GSTCESS','CESS') Then 'InputGSTCESS Rate'
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty as InputQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','InputGSTCESS','GSTCESS')
		and TransId=1
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Value'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Value'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Value'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Value'
				WHEN TaxCode IN('InputIGSTCESS','IGSTCESS') THEN 'InputIGSTCESS Value'
				WHEN TaxCode IN ('InputCGSTCESS','CGSTCESS') Then 'InputCGSTCESS Value'
				WHEN TaxCode IN ('InputSGSTCESS','SGSTCESS') Then 'InputSGSTCESS Value'
				WHEN TaxCode IN ('InputUTGSTCESS','UTGSTCESS') Then 'InputUTGSTCESS Value'
				WHEN TAXCODE IN ('InputGSTCess','GSTCESS','CESS') THEN 'InputGSTCess Value'		
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','InputGSTCESS','GSTCESS')
		and TransId=1
	
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Rate'
				WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Rate'
				WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Rate'
				WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Rate'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS') THEN 'OutputIGSTCESS Rate'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS') Then 'OutputCGSTCESS Rate'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS') Then 'OutputSGSTCESS Rate'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS') Then 'OutputUTGSTCESS Rate'
						WHEN TAXCODE IN ('OutPutGSTCess','GSTCESS','CESS') THEN 'OutputGSTCess Rate'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0 as InputQty,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS','CESS',
		'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS','GSTCESS')
		and TransId=2
		
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Value'
				WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Value'
				WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Value'
				WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Value'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS') THEN 'OutputIGSTCESS Value'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS') Then 'OutputCGSTCESS Value'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS') Then 'OutputSGSTCESS Value'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS') Then 'OutputUTGSTCESS Value'
						WHEN TAXCODE IN ('OutPutGSTCess','GSTCESS','CESS') THEN 'OutputGSTCess Value'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','InputGSTCESS','GSTCESS',
		'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','OutputGSTCESS')
		and TransId=2
		
				
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		
	
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN		
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax	WHERE UsrId=@Pi_UsrId			
			RETURN
		END
				
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50)		
		)
		
		INSERT INTO #DynamicCol
		SELECT 'OutputIGST Rate'
		UNION
		SELECT 'OutputCGST Rate'
		UNION
		SELECT 'OutputSGST Rate'
		UNION
		SELECT 'OutputUTGST Rate'
		UNION
		SELECT 'OutputIGST Value'
		UNION
		SELECT 'OutputCGST Value'
		UNION
		SELECT 'OutputSGST Value'
		UNION
		SELECT 'OutputUTGST Value'
		UNION
		SELECT 'OutputIGSTCESS Rate'
		UNION
		SELECT 'OutputUTGSTCESS Rate'
		UNION
		SELECT 'OutputCGSTCESS Rate'
		UNION
		SELECT 'OutputSGSTCESS Rate'
		UNION
		SELECT 'OutputGSTCESS Rate'
		UNION
		SELECT 'OutputIGSTCESS Value'
		UNION
		SELECT 'OutputUTGSTCESS Value'
		UNION
		SELECT 'OutputCGSTCESS Value'
		UNION
		SELECT 'OutputSGSTCESS Value'
		UNION
		SELECT 'OutputGSTCESS Value'
		UNION
		SELECT 'InputIGST Rate'
		UNION
		SELECT 'InputCGST Rate'
		UNION
		SELECT 'InputSGST Rate'
		UNION
		SELECT 'InputUTGST Rate'
		UNION
		SELECT 'InputIGST Value'
		UNION
		SELECT 'InputCGST Value'
		UNION
		SELECT 'InputSGST Value'
		UNION
		SELECT 'InputUTGST Value'
		UNION
		SELECT 'InputIGSTCESS Rate'
		UNION
		SELECT 'InputUTGSTCESS Rate'
		UNION
		SELECT 'InputCGSTCESS Rate'
		UNION
		SELECT 'InputSGSTCESS Rate'
		UNION
		SELECT 'InputGSTCESS Rate'
		UNION
		SELECT 'InputIGSTCESS Value'
		UNION
		SELECT 'InputUTGSTCESS Value'
		UNION
		SELECT 'InputCGSTCESS Value'
		UNION
		SELECT 'InputSGSTCESS Value'
		UNION
		SELECT 'InputGSTCESS Value'
 
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxperc)+',0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT [Product Name],[Product Code],[HSN Code],InPutQty,OutPutQty,[TaxableAmount],'+@ColSelect+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'[Product Name] Varchar(150),[Product Code] Varchar(75),[HSN Code] varchar(50),'+		
		'InPutQty INT,OutPutQty INT,[TaxableAmount] [numeric](38, 6) NULL,'
	
		SET @Columns1='SELECT [Product Name],[Product Code],[HSN Code],InPutQty,OutPutQty,[TaxableAmount],TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM Tempdb..SYSOBJECTS WHERE NAME=''##RptInputOutPutGSTTax'' and XTYPE=''U'')'+
		' DROP TABLE ##RptInputOutPutGSTTax'+
		' CREATE TABLE ##RptInputOutPutGSTTax ('+@TableCol+@ColSelectDataType+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO ##RptInputOutPutGSTTax '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		
		
		SELECT [Product Name],[Product Code],[HSN Code],SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		SUM([InputCGST Rate]) as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		SUM([InputSGST Rate]) as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		SUM([InputIGST Rate]) as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		SUM([InputUTGST Rate]) as  [InputUTGST Rate],SUM([InputUTGST Value]) as [InputUTGST Value],
		SUM([InputCGSTCESS Rate]) as [InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		SUM([InputSGSTCESS Rate]) as [InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		SUM([InputIGSTCESS Rate]) as [InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		SUM([InputUTGSTCESS Rate]) as  [InputUTGSTCESS Rate],SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		SUM([InputGSTCESS Rate]) as  [InputGSTCESS Rate],SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		SUM([OutputCGST Rate]) as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		SUM([OutputSGST Rate]) as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		SUM([OutputIGST Rate]) as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		SUM([OutputUTGST Rate]) as [OutputUTGST Rate] ,SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		SUM([OutputCGSTCESS Rate]) as [OutputCGSTCESS Rate],SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value],
		SUM([OutputSGSTCESS Rate]) as [OutputSGSTCESS Rate],SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value],
		SUM([OutputIGSTCESS Rate]) as [OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		SUM([OutputUTGSTCESS Rate]) as [OutputUTGSTCESS Rate] ,SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		SUM([OutputGSTCESS Rate]) as [OutputGSTCESS Rate] ,SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		[Group Name],Grouptype,UsrId
		INTO #RptProductTaxGroup
		FROM ##RptInputOutPutGSTTax		
		GROUP BY [Product Name],[Product Code],[HSN Code],[Group Name],Grouptype,UsrId
		
		
	
		
		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[InputCGSTCESS Rate],[InputCGSTCESS Value],
		[InputSGSTCESS Rate],[InputSGSTCESS Value],[InputIGSTCESS Rate],[InputIGSTCESS Value],
		[InputUTGSTCESS Rate],[InputUTGSTCESS Value],[InputGSTCESS Rate],[InputGSTCESS Value],
		[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[OutputCGSTCESS Rate],[OutputCGSTCESS Value],
		[OutputSGSTCESS Rate],[OutputSGSTCESS Value],[OutputIGSTCESS Rate],[OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],[OutputUTGSTCESS Value],[OutputGSTCESS Rate],
		[OutputGSTCESS Value],[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[DiffCGSTCESS Value],[DiffSGSTCESS Value],
		[DiffIGSTCESS Value],[DiffUTGSTCESS Value],[DiffGSTCESS Value],
		[Group Name],[Grouptype],[UsrId])
		SELECT [Product Name],[Product Code],[HSN Code],SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		[InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		[InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		[InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		[InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		[InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		[InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		[InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		[InputUTGSTCESS Rate] ,SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		[InputGSTCESS Rate],SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		[OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		[OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		[OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		[OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		[OutputCGSTCESS Rate] ,SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value] ,
		[OutputSGSTCESS Rate] ,SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value] ,
		[OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		[OutputGSTCESS Rate] ,SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		[Group Name],Grouptype,UsrId
		FROM #RptProductTaxGroup		
		GROUP BY [Product Name],[Product Code],[HSN Code],[Group Name],Grouptype,UsrId,
		[InputCGST Rate],[InputSGST Rate],[InputIGST Rate],[InputUTGST Rate],[InputGSTCESS Rate],
		[OutputCGST Rate],[OutputSGST Rate],[OutputIGST Rate],[OutputUTGST Rate],
		[InputCGSTCESS Rate],[InputSGSTCESS Rate],[InputIGSTCESS Rate],[InputUTGSTCESS Rate],
		[OutputCGSTCESS Rate],[OutputSGSTCESS Rate],[OutputIGSTCESS Rate],[OutputUTGSTCESS Rate],[OutputGSTCESS Rate] 
		ORDER BY [HSN Code], [Product Name]
		
			
		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[InputCGSTCESS Rate],[InputCGSTCESS Value],
		[InputSGSTCESS Rate],[InputSGSTCESS Value],[InputIGSTCESS Rate],[InputIGSTCESS Value],
		[InputUTGSTCESS Rate],[InputUTGSTCESS Value],[InputGSTCESS Rate],[InputGSTCESS Value],
		[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[OutputCGSTCESS Rate],[OutputCGSTCESS Value],
		[OutputSGSTCESS Rate],[OutputSGSTCESS Value],[OutputIGSTCESS Rate],[OutputIGSTCESS Value],
		[OutputUTGSTCESS Rate],[OutputUTGSTCESS Value],[OutputGSTCESS Rate],[OutputGSTCESS Value],
		[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[DiffCGSTCESS Value],[DiffSGSTCESS Value],
		[DiffIGSTCESS Value],[DiffUTGSTCESS Value],[DiffGSTCESS Value],[Group Name],[Grouptype],[UsrId])
		
		SELECT '' as [Product Name],'' as [Product Code],'' as [HSN Code],SUM([InPutQty]) as [InPutQty],
		SUM([OutPutQty]) as [OutPutQty],
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		0 as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		0 as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		0 as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		0 as [InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		0 as [InputCGSTCESS Rate],SUM([InputCGSTCESS Value]) as [InputCGSTCESS Value],
		0 as [InputSGSTCESS Rate],SUM([InputSGSTCESS Value]) as [InputSGSTCESS Value],
		0 as [InputIGSTCESS Rate],SUM([InputIGSTCESS Value]) as [InputIGSTCESS Value],
		0 as [InputUTGSTCESS Rate] ,SUM([InputUTGSTCESS Value]) as [InputUTGSTCESS Value],
		0 as [InputGSTCESS Rate] ,SUM([InputGSTCESS Value]) as [InputGSTCESS Value],
		0 as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		0 as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		0 as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		0 as [OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		0 as [OutputCGSTCESS Rate],SUM([OutputCGSTCESS Value]) as [OutputCGSTCESS Value],
		0 as [OutputSGSTCESS Rate],SUM([OutputSGSTCESS Value]) as [OutputSGSTCESS Value],
		0 as [OutputIGSTCESS Rate],SUM([OutputIGSTCESS Value]) as [OutputIGSTCESS Value],
		0 as [OutputUTGSTCESS Rate],SUM([OutputUTGSTCESS Value]) as [OutputUTGSTCESS Value] ,
		0 as [OutputGSTCESS Rate],SUM([OutputGSTCESS Value]) as [OutputGSTCESS Value] ,
		ABS(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		ABS(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		ABS(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		ABS(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		ABS(SUM([InputCGSTCESS Value]-[OutputCGSTCESS Value])) as [DiffCGSTCESS Value],
		ABS(SUM([InputSGSTCESS Value]-[OutputSGSTCESS Value])) as [DiffSGSTCESS Value],
		ABS(SUM([InputIGSTCESS Value]-[OutputIGSTCESS Value])) as [DiffIGSTCESS Value],
		ABS(SUM([InputUTGSTCESS Value]-[OutputUTGSTCESS Value])) as [DiffUTGSTCESS Value],
		ABS(SUM([InputGSTCESS Value]-[OutputGSTCESS Value])) as [DiffGSTCESS Value],
		'ZZZZZZ' as [Group Name],3 as Grouptype,@Pi_UsrId as UsrId
		FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
		
		
		DELETE FROM RptInputOutPutGSTTax WHERE ([InPutQty]+[OutPutQty])=0
		AND UsrId=@Pi_UsrId
		
		DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
		INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
		FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
		RoundOff,CreatedDate)
		SELECT 1,407,'Product Wise Input Output Tax',1,'Product Name',50,1,0,1,1,'Product Name','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',2,'Product Code',20,1,0,1,1,'Product Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',3,'HSN Code',20,1,0,1,1,'HSN Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',4,'InPutQty',50,1,0,2,2,'Input','Total','Quantity',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',5,'OutPutQty',50,1,0,2,2,'Output','Total','Quantity',0,GETDATE()
		--UNION ALL
		--SELECT 1,407,'Product Wise Input Output Tax',6,'TaxableAmount',16,1,0,2,3,'Taxable','Amount','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',6,'InputCGST Rate',16,1,0,2,3,'Input','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',7,'InputSGST Rate',16,1,0,2,3,'Input','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',8,'InputIGST Rate',16,1,0,2,3,'Input','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',9,'InputUTGST Rate',16,1,0,2,3,'Input','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',10,'InputCGST Value',16,1,0,2,3,'Input','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',11,'InputSGST Value',16,1,0,2,3,'Input','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',12,'InputIGST Value',16,1,0,2,3,'Input','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',13,'InputUTGST Value',16,1,0,2,3,'Input','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',14,'InputCGSTCESS Rate',16,1,0,2,3,'Input','CGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',15,'InputSGSTCESS Rate',16,1,0,2,3,'Input','SGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',16,'InputIGSTCESS Rate',16,1,0,2,3,'Input','IGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',17,'InputUTGSTCESS Rate',16,1,0,2,3,'Input','UTGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',18,'InputGSTCESS Rate',16,1,0,2,3,'Input','GSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',19,'InputCGSTCESS Value',16,1,0,2,3,'Input','CGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',20,'InputSGSTCESS Value',16,1,0,2,3,'Input','SGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',21,'InputIGSTCESS Value',16,1,0,2,3,'Input','IGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',22,'InputUTGSTCESS Value',16,1,0,2,3,'Input','UTGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',23,'InputGSTCESS Value',16,1,0,2,3,'Input','GSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',24,'OutPutCGST Rate',16,1,0,2,3,'OutPut','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',25,'OutPutSGST Rate',16,1,0,2,3,'OutPut','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',26,'OutPutIGST Rate',16,1,0,2,3,'OutPut','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',27,'OutPutUTGST Rate',16,1,0,2,3,'OutPut','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',28,'OutPutCGST Value',16,1,0,2,3,'OutPut','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',29,'OutPutSGST Value',16,1,0,2,3,'OutPut','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',30,'OutPutIGST Value',16,1,0,2,3,'OutPut','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',31,'OutPutUTGST Value',16,1,0,2,3,'OutPut','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',32,'OutPutCGSTCESS Rate',16,1,0,2,3,'OutPut','CGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',33,'OutPutSGSTCESS Rate',16,1,0,2,3,'OutPut','SGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',34,'OutPutIGSTCESS Rate',16,1,0,2,3,'OutPut','IGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',35,'OutPutUTGSTCESS Rate',16,1,0,2,3,'OutPut','UTGSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',36,'OutPutGSTCESS Rate',16,1,0,2,3,'OutPut','GSTCESS%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',37,'OutPutCGSTCESS Value',16,1,0,2,3,'OutPut','CGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',38,'OutPutSGSTCESS Value',16,1,0,2,3,'OutPut','SGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',39,'OutPutIGSTCESS Value',16,1,0,2,3,'OutPut','IGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',40,'OutPutUTGSTCESS Value',16,1,0,2,3,'OutPut','UTGSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',41,'OutPutGSTCESS Value',16,1,0,2,3,'OutPut','GSTCESS','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',42,'DiffCGST Value',16,1,0,2,3,'Differential of','CGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',43,'DiffSGST Value',16,1,0,2,3,'Differential of','SGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',44,'DiffIGST Value',16,1,0,2,3,'Differential of','IGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',45,'DiffUTGST Value',16,1,0,2,3,'Differential of','UTGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',46,'DiffCGSTCESS Value',16,1,0,2,3,'Differential of','CGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',47,'DiffSGSTCESS Value',16,1,0,2,3,'Differential of','SGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',48,'DiffIGSTCESS Value',16,1,0,2,3,'Differential of','IGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',49,'DiffUTGSTCESS Value',16,1,0,2,3,'Differential of','UTGSTCESS','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',50,'DiffGSTCESS Value',16,1,0,2,3,'Differential of','GSTCESS','Input OutPut Tax Amount',2,GETDATE()
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM  SYSOBJECTS WHERE NAME='Proc_RptFORMGSTR_3B_1_GST' AND TYPE='P')
DROP PROCEDURE Proc_RptFORMGSTR_3B_1_GST
GO
--EXEC Proc_RptFORMGSTR_3B_1_GST 411,1
--SELECT * FROM RptFORMGSTR_3B_1
CREATE PROCEDURE Proc_RptFORMGSTR_3B_1_GST
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT	
)
AS
/************************************************
* PROCEDURE  : Proc_RptFORMGSTR_3B
* PURPOSE    : To Generate Outward Supplies Tax Report
* CREATED BY : Murugan.R
* CREATED ON : 07/08/@Jcmyear
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION

* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR				Included CESS Tax
*************************************************/
BEGIN
SET NOCOUNT ON
		DECLARE @ErrNo	 			AS INT
---Find Zero Tax Product
		DECLARE @PrdBatTaxGrp AS INT
		DECLARE @RtrTaxGrp1 AS INT
		DECLARE @PurSeqId AS INT
		DECLARE @BillSeqId AS INT
		DECLARE @RtrTaxGrp AS INT		 
		DECLARE @TaxSlab  INT  
		DECLARE @MRP INT    
		DECLARE @TaxableAmount  NUMERIC(28,10)      
		DECLARE @ParTaxableAmount NUMERIC(28,10)      
		DECLARE @TaxPer   NUMERIC(38,2)     
		DECLARE @TaxPercentage   NUMERIC(38,5)   
		DECLARE @TaxId   INT 
		DECLARE @MaxSlno   INT
		DECLARE @MinSlno   INT
		DECLARE @Prdid INT
		SET @MinSlno=1
		
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		
		CREATE TABLE #ProductLst
		(
			Slno INT IDENTITY(1,1),	
			TaxSeqId INT,	
			Prdid INT,
			RtrId INT
		)	
		
		CREATE TABLE #ProductZeroTax(
		TaxGroupId [int] NULL,
		[TaxPercentage] [numeric](18, 5) NULL
		) 
		
			
		
		DECLARE @TaxSettingDet TABLE       
		(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,2)      
		) 
		CREATE TABLE #TempProductTax
		(
			Prdid INT,
			TaxId INT,
			TaxSlabId INT,
			TaxPercentage Numeric(5,2),
			TaxAmount Numeric (18,5)
		)
	   
		SELECT @RtrTaxGrp=TaxGroupId FROM TaxGroupSetting (NOLOCK) WHERE RtrGroup='RTRINTRA'
	   
		SELECT * INTO #RtrGroup FROM TaxSettingMaster WHERE      
		RtrId = @RtrTaxGrp 
		and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
		
		INSERT INTO #ProductLst (TaxSeqId,Prdid,RtrId)
		SELECT Max(A.TaxSeqId),A.Prdid,A.RtrId		
		FROM #RtrGroup A INNER JOIN TaxSettingMaster B ON A.RtrId=B.RtrId and A.Prdid=B.Prdid
		GROUP BY A.Prdid,A.RtrId
	    SELECT @MaxSlno=MAX(Slno) FROM #ProductLst
	    WHILE @MinSlno<=@MaxSlno
	    BEGIN
				
				DELETE FROM @TaxSettingDet	
				SELECT @PrdBatTaxGrp=Prdid, @RtrTaxGrp=RtrId FROM  #ProductLst WHERE Slno=@MinSlno
				--To Take the Batch TaxGroup Id      
								
				SELECT @BillSeqId = MAX(BillSeqId)  FROM BillSequenceMaster (NOLOCK)
				
						
				INSERT INTO @TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
				SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
				FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
				TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
				AND B.BillSeqId=@BillSeqId  and Coltype IN(1,3)    
				WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp     
				AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
				RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp
				and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
				)  
			
				SET @MRP=1
				TRUNCATE TABLE #TempProductTax
				DECLARE  CurTax CURSOR FOR      
					SELECT DISTINCT TaxSlab FROM @TaxSettingDet      
				OPEN CurTax        
				FETCH NEXT FROM CurTax INTO @TaxSlab      
				WHILE @@FETCH_STATUS = 0        
				BEGIN      
				SET @TaxableAmount = 0      
				--To Filter the Records Which Has Tax Percentage (>=0)      
				IF EXISTS (SELECT * FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId = 0 and ColVal >= 0)      
				BEGIN      
				--To Get the Tax Percentage for the selected slab      
				SELECT @TaxPer = ColVal FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId = 0      
				--To Get the TaxId for the selected slab      
				SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId > 0      
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP 
				--To Get the Parent Taxable Amount for the Tax Slab      
				SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM #TempProductTax A      
				INNER JOIN @TaxSettingDet B ON A.TaxId = B.ColVal and  
				B.ColType = 3 AND B.TaxSlab = @TaxSlab 
				If @ParTaxableAmount>0
				BEGIN
					Set @TaxableAmount=@ParTaxableAmount
				END 
				ELSE
				BEGIN
					Set @TaxableAmount = @TaxableAmount
				END    
				    
				INSERT INTO #TempProductTax (PrdId,TaxId,TaxSlabId,TaxPercentage,      
				TaxAmount)      
				SELECT @PrdBatTaxGrp,@TaxId,@TaxSlab,@TaxPer,      
				cast(@TaxableAmount*(@TaxPer / 100 ) AS NUMERIC(28,10))      
				 
				  
				END      
				FETCH NEXT FROM CurTax INTO @TaxSlab      
				END        
				CLOSE CurTax        
				DEALLOCATE CurTax      
				SELECT @TaxPercentage=Cast(ISNULL(SUM(TaxAmount)*100,0) as Numeric(18,5))
				FROM #TempProductTax WHERE Prdid=@PrdBatTaxGrp
									
				INSERT INTO #ProductZeroTax(TaxGroupId,TaxPercentage)
				SELECT @PrdBatTaxGrp,@TaxPercentage
				
				SET @MinSlno=@MinSlno+1	
	END	
	
	DELETE FROM #ProductZeroTax WHERE TaxPercentage>0
	
	SELECT DISTINCT B.PrdId INTO #ProductZeroTax1 
	FROM  #ProductZeroTax A INNER JOIN Product B ON A.TaxGroupId=B.TaxGroupId
	
	
	---EXEMPTED PRODUCT
	SELECT DISTINCT P.Prdid 
	INTO #ExemptProduct
	FROM UdcHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
	and C.UdcMasterId=B.UdcMasterId 
	INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
	WHERE A.MasterName='Product Master' and B.ColumnName='Exempt Product'
	and ColumnValue='Yes'
	
	SELECT DISTINCT PRDID INTO #ExemptAndZeroTax FROM(
	SELECT [PrdId] FROM #ProductZeroTax1
	UNION 
	SELECT PrdId FROM #ExemptProduct
	)X
	--Service Invoice UnRegistered Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerUnRegister
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue IN('UnRegistered')
	
		
	
	--WITH Tax
	
	TRUNCATE TABLE RptFORMGSTR_3B_1
	
	
	---OutWard Service
	
	
	SELECT PurRcptId  INTO #PurchaseReceipt FROM PurchaseReceipt (NOLOCK) WHERE GoodsRcvdDate Between '2017-01-01' and '2017-06-30' and Status=1
	and VatGst='VAT'
	
	INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
	SELECT '(a) Outward Taxable Supplies (other than zero rated,nil rated and exempted)' as [Nature Of Supplies],ISNULL(SUM(TaxableAmount),0) as [Total Taxable Amount],
	ISNULL(SUM(Integrated),0) as Integrated,ISNULL(SUM(Central),0) as Central,ISNULL(SUM([State/UTTax]),0) as [State/UTTax],ISNULL(SUM(CESS),0) as CESS,
	@Pi_UsrId,'',2
	FROM(
			SELECT  SUM(TaxableAmount) as TaxableAmount,SUM(TaxAmount) as Integrated,0 as Central,0 as [State/UTTax]  ,0 as CESS
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and VatGst='GST'
			AND TaxAmount>0
			UNION ALL
			SELECT SUM(TaxableAmount) as TaxableAmount,0 as Integrated,  SUM(TaxAmount) as Central,0 as [State/UTTax] ,0 as CESS 
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputCGST','CGST') and VatGst='GST'
			AND TaxAmount>0
			UNION ALL
			SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,SUM(TaxAmount) as [State/UTTax] ,0 as CESS
			FROM SalesInvoice S (NOLOCK)  
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') and VatGst='GST'
			AND TaxAmount>0
			UNION ALL
			SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax] ,SUM(TaxAmount) as CESS
			FROM SalesInvoice S (NOLOCK)  
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','OutputGSTCESS','GSTCESS','SGSTCESS','UTGSTCESS','OutputCGSTCESS','OutputIGSTCESS','IGSTCESS','CGSTCESS') and VatGst='GST'
			AND TaxAmount>0
			UNION ALL
			---Sales Return
			SELECT  -1*SUM(TaxableAmt) as TaxableAmount,-1*SUM(TaxAmt) as Integrated,0 as Central,0 as [State/UTTax]  ,0 as CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and SI.VatGst='GST'
			AND TaxAmt>0
			UNION ALL
			SELECT  -1*SUM(TaxableAmt) as TaxableAmount,0 as Integrated,-1*SUM(TaxAmt) as Central,0 as [State/UTTax] ,0 as CESS 
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputCGST','CGST') and SI.VatGst='GST'
			AND TaxAmt>0
			UNION ALL
			SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,-1*SUM(TaxAmt)  as [State/UTTax]  ,0 as CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') and SI.VatGst='GST'
			AND TaxAmt>0
			UNION ALL
			SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax]  ,-1*SUM(TaxAmt)  as CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputCGSTCESS','OutputIGSTCESS','IGSTCESS','CGSTCESS','OutputGSTCESS','GSTCESS') and SI.VatGst='GST'
			AND TaxAmt>0
			UNION ALL
			SELECT SUM(TaxableAmount) as TaxableAmount,SUM(PPT.TaxAmount) as Integrated,0 as Central,0 as [State/UTTax] ,0 as CESS 
			FROM PurchaseReturn P (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId
			INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
			and TaxCode IN('InputIGST','IGST')
			AND PPT.TaxAmount>0
			UNION ALL
			SELECT SUM(TaxableAmount) as TaxableAmount,0 as Integrated,SUM(PPT.TaxAmount) as Central,0 as [State/UTTax]  ,0 as CESS
			FROM PurchaseReturn P (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId
			INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
			and TaxCode IN('InputCGST','CGST')
			AND PPT.TaxAmount>0
			UNION ALL
			SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,SUM(PPT.TaxAmount) as [State/UTTax] ,0 as CESS
			FROM PurchaseReturn P (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId
			INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
			and TaxCode IN('InputSGST','InputUTGST','SGST','UTGST')
			AND PPT.TaxAmount>0
			UNION ALL
			SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax] ,SUM(PPT.TaxAmount) as CESS
			FROM PurchaseReturn P (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId
			INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
			and TaxCode IN('InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','CGSTCess','SGSTCess','IGSTCess','UTGSTCess','InputGSTCess','GSTCess')
			AND PPT.TaxAmount>0
			--UNION ALL
			----SERVICE OUTWard
			--SELECT SUM(ISNULL(DocAmount,0))  as TaxableAmount,SUM(ISNULL(IGST_AMT,0)) as Integrated,SUM(ISNULL(CGST_Amt,0)) as Central,
			--SUM(ISNULL(SGST_Amt,0)+ISNULL(UTGST_Amt,0)) as [State/UTTax],
			--0 as CESS  
			--FROM ClaimAcknowledgement WHERE ClaimType IN('Project1 Claim','Other Claim','Manual Claim',
			--'VAT Claim','Incentive Claim','ROI Subsidy Claim','VD ManPower Cost Claim','VD Subsidy Claim')
			--and CAST(ClaimMonth as INT)=@MonthStart and ClaimYear=@Jcmyear 
			--and LEN(ISNULL(DocNumber,''))>0 and Status='APPROVED'
			--HAVING SUM(ISNULL(IGST_AMT,0)+ISNULL(CGST_Amt,0)+ISNULL(SGST_Amt,0)+ISNULL(UTGST_Amt,0))>0
	
	)X 
	
		--NOT Applicable
		INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
		SELECT '(b) Outward Taxable Supplies(Zero Rated)' as [Nature Of Supplies],0 as [Total Taxable Amount],
		0 as Integrated,0 as Central,0 as [State/UTTax],0 as CESS,
		@Pi_UsrId,'',2
	
		--EXCEMPTED  AND ZERO Product	
		IF NOT EXISTS(SELECT 'X' FROM #ExemptAndZeroTax)
		BEGIN
			INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
			SELECT '(c) Other Outward Supplies(Nil Rated,Exempted)' as [Nature Of Supplies],0 as [Total Taxable Amount],
			0 as Integrated,0 as Central,0 as [State/UTTax],0 as CESS,
			@Pi_UsrId,'',2
		END
		ELSE
		BEGIN
			
			INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
			SELECT '(c) Other Outward Supplies(Nil Rated,Exempted)' as [Nature Of Supplies],ISNULL(SUM(TaxableAmount),0) as [Total Taxable Amount],
			ISNULL(SUM(Integrated),0) as Integrated,ISNULL(SUM(Central),0) as Central,ISNULL(SUM([State/UTTax]),0) as [State/UTTax],ISNULL(SUM(CESS),0) as CESS,
			@Pi_UsrId,'',2
			FROM(
				SELECT  SUM(TaxableAmount) as TaxableAmount,SUM(TaxAmount) as Integrated,0 as Central,0 as [State/UTTax],0 as CESS 
				FROM SalesInvoice S (NOLOCK)
				INNER JOIN SalesInvoiceProduct SIP ON S.SalId=SIP.SalId 
				INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId and SPT.SalId=SIP.SalId and SIP.SlNo=SPT.PrdSlNo
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=SIP.PrdId
				WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
				and TaxCode IN('OutputIGST','IGST') and VatGst='GST'	
				AND TaxAmount=0			
				UNION ALL
				SELECT  SUM(TaxableAmount) as TaxableAmount,0 as Integrated,SUM(TaxAmount) as Central,0 as [State/UTTax] ,0 as CESS
				FROM SalesInvoice S (NOLOCK)
				INNER JOIN SalesInvoiceProduct SIP ON S.SalId=SIP.SalId 
				INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId and SPT.SalId=SIP.SalId and SIP.SlNo=SPT.PrdSlNo
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=SIP.PrdId
				WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
				and TaxCode IN('OutputCGST','CGST') and VatGst='GST'	
				AND TaxAmount=0			
				UNION ALL
				SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,SUM(TaxAmount) as [State/UTTax],0 as CESS 
				FROM SalesInvoice S (NOLOCK)
				INNER JOIN SalesInvoiceProduct SIP ON S.SalId=SIP.SalId 
				INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId and SPT.SalId=SIP.SalId and SIP.SlNo=SPT.PrdSlNo
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=SIP.PrdId
				WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
				and TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') and VatGst='GST'
				AND TaxAmount=0		
				UNION ALL
				SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax],SUM(TaxAmount) as CESS 
				FROM SalesInvoice S (NOLOCK)
				INNER JOIN SalesInvoiceProduct SIP ON S.SalId=SIP.SalId 
				INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId and SPT.SalId=SIP.SalId and SIP.SlNo=SPT.PrdSlNo
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=SIP.PrdId
				WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
				and TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputCGSTCESS','OutputIGSTCESS','CGSTCESS','IGSTCESS','OutputGSTCess','GSTCess') 
				and VatGst='GST'
				AND TaxAmount=0			
				UNION ALL
				---Sales Return
				SELECT  -1*SUM(TaxableAmt) as TaxableAmount,-1*SUM(TaxAmt) as Integrated,0 as Central,0 as [State/UTTax] ,0 as CESS
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProduct RP (NOLOCK) ON RP.ReturnID=S.ReturnID
				INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID and SPT.ReturnId=Rp.ReturnID and SPT.PrdSlno=Rp.Slno
				INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=RP.PrdId
				WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
				and TaxCode IN('OutputIGST','IGST') and SI.VatGst='GST'
				AND TaxAmt=0				
				UNION ALL
				SELECT  -1*SUM(TaxableAmt) as TaxableAmount,0 as Integrated,-1*SUM(TaxAmt) as Central,0 as [State/UTTax] ,0 as CESS
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProduct RP (NOLOCK) ON RP.ReturnID=S.ReturnID
				INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID and SPT.ReturnId=Rp.ReturnID and SPT.PrdSlno=Rp.Slno
				INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=RP.PrdId
				WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
				and TaxCode IN('OutputCGST','CGST') and SI.VatGst='GST'	
				AND TaxAmt=0			
				UNION ALL
				SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,-1*SUM(TaxAmt) as [State/UTTax] ,0 as CESS
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProduct RP (NOLOCK) ON RP.ReturnID=S.ReturnID
				INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID and SPT.ReturnId=Rp.ReturnID and SPT.PrdSlno=Rp.Slno
				INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=RP.PrdId
				WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
				and TaxCode  IN('OutputSGST','OutputUTGST','SGST','UTGST') and SI.VatGst='GST'	
				AND TaxAmt=0				
				UNION ALL
				SELECT  0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax] ,-1*SUM(TaxAmt) as CESS
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProduct RP (NOLOCK) ON RP.ReturnID=S.ReturnID
				INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID and SPT.ReturnId=Rp.ReturnID and SPT.PrdSlno=Rp.Slno
				INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=RP.PrdId
				WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
				and TaxCode  IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputCGSTCESS','OutputIGSTCESS','CGSTCESS','IGSTCESS','OutputGSTCess','GSTCess') and SI.VatGst='GST'	
				AND TaxAmt=0
				UNION ALL				
				SELECT SUM(TaxableAmount) as TaxableAmount,SUM(PPT.TaxAmount) as Integrated,0 as Central,0 as [State/UTTax] ,0 as CESS 
				FROM PurchaseReturn P (NOLOCK) 
				INNER JOIN PurchaseReturnProduct PRP ON PRP.PurRetId=P.PurRcptId
				INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId  and Prp.PurRetId=PPT.PurRetId and PRP.PrdSlNo=PPT.Prdslno
				INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=PRP.PrdId
				WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
				and TaxCode IN('InputIGST','IGST')
				AND PPT.TaxAmount=0
				UNION ALL
				SELECT SUM(TaxableAmount) as TaxableAmount,0 as Integrated,SUM(PPT.TaxAmount) as Central,0 as [State/UTTax]  ,0 as CESS
				FROM PurchaseReturn P (NOLOCK) 
				INNER JOIN PurchaseReturnProduct PRP ON PRP.PurRetId=P.PurRcptId
				INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId and Prp.PurRetId=PPT.PurRetId and PRP.PrdSlNo=PPT.Prdslno
				INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=PRP.PrdId
				WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
				and TaxCode IN('InputCGST','CGST')
				AND PPT.TaxAmount=0
				UNION ALL
				SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,SUM(PPT.TaxAmount) as [State/UTTax] ,0 as CESS
				FROM PurchaseReturn P (NOLOCK) 
				INNER JOIN PurchaseReturnProduct PRP ON PRP.PurRetId=P.PurRcptId
				INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId  and Prp.PurRetId=PPT.PurRetId and PRP.PrdSlNo=PPT.Prdslno
				INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=PRP.PrdId
				WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
				and TaxCode IN('InputSGST','InputUTGST','SGST','UTGST')				
				AND PPT.TaxAmount=0
				UNION ALL
				SELECT 0 as TaxableAmount,0 as Integrated,0 as Central,0 as [State/UTTax] ,SUM(PPT.TaxAmount) as CESS
				FROM PurchaseReturn P (NOLOCK) 
				INNER JOIN PurchaseReturnProduct PRP ON PRP.PurRetId=P.PurRcptId
				INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId  and Prp.PurRetId=PPT.PurRetId and PRP.PrdSlNo=PPT.Prdslno
				INNER JOIN #PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
				INNER JOIN #ExemptAndZeroTax PT ON PT.PrdId=PRP.PrdId
				WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
				and TaxCode IN('InputCGSTCess','InputSGSTCESS','InputUTGSTCESS','InputIGSTCESS','SGSTCESS','UTGSTCESS','CGSTCESS','IGSTCESS','InputGSTCess','GSTCess')
				AND PPT.TaxAmount=0			
			)X 
		END
		
		
		INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
		SELECT '(d) Inward supplies (liable to reverse charge)' as [Nature Of Supplies],ISNULL(SUM(TaxableAmount),0) as [Total Taxable Amount],
		ISNULL(SUM(Integrated),0) as Integrated,ISNULL(SUM(Central),0) as Central,ISNULL(SUM([State/UT Tax]),0) as [State/UT Tax],0 as CESS,
		@Pi_UsrId,'',2
		FROM(
			
			SELECT SUM(TaxableAmount) as  TaxableAmount ,SUM(TaxAmount) as [Integrated],0 as [Central], 0 as [State/UT Tax] 
			FROM ServiceInvoicehd S (NOLOCK)
			INNER JOIN #RetailerUnRegister R ON R.Rtrid=ServiceFromId
			INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK) ON SI.ServiceInvId=S.ServiceId 
			INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId=SI.TaxId
			WHERE ServiceInvFor=1 and TaxCode IN('OutputIGST','IGST')
			AND TaxAmount>0
			UNION ALL
			SELECT SUM(TaxableAmount) as  TaxableAmount ,0 as [Integrated],SUM(TaxAmount) as [Central],0 as [State/UT Tax] 
			FROM ServiceInvoicehd S (NOLOCK)
			INNER JOIN #RetailerUnRegister R ON R.Rtrid=ServiceFromId
			INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK) ON SI.ServiceInvId=S.ServiceId 
			INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId=SI.TaxId
			WHERE ServiceInvFor=1 and TaxCode IN('OutputCGST','CGST')
			AND TaxAmount>0
			UNION ALL
			SELECT 0 as  TaxableAmount ,0 as [Integrated],0 as [Central] ,SUM(TaxAmount) as [State/UT Tax] 
			FROM ServiceInvoicehd S (NOLOCK)
			INNER JOIN #RetailerUnRegister R ON R.Rtrid=ServiceFromId
			INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK) ON SI.ServiceInvId=S.ServiceId 
			INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId=SI.TaxId
			WHERE ServiceInvFor=1 and TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST')
			AND TaxAmount>0
		
			)X
		
		
		INSERT INTO RptFORMGSTR_3B_1([Nature Of Supplies],[Total Taxable],[Integrated],[Central],[State/UT Tax],[Cess],UsrId,[Group Name],GroupType)
		SELECT '(e) Non-GST Outward Supplies' as [Nature Of Supplies],0 as [Total Taxable Amount],
		0 as Integrated,0 as Central,0 as [State/UTTax],0 as CESS,
		@Pi_UsrId,'',2
		
		DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptFORMGSTR_3B_1
		WHERE UsrId=@Pi_UsrId
		SELECT * FROM RptFORMGSTR_3B_1 WHERE UsrId=@Pi_UsrId
	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptHSNOutPutTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptHSNOutPutTaxGST
Go
/*
BEGIN tran
EXEC Proc_RptHSNOutPutTaxGST 422,2,0,'GSTTAX',0,0,1
Select * from RptHSNOutputTaxGST
ROLLBACK tran 
*/
CREATE PROCEDURE Proc_RptHSNOutPutTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptHSNOutPutTax
* PURPOSE	: To get the HSN Wise Tax Report
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 07-03-2019	MOHANA S	    ILCRSTPAR3750	   CR		KERALA CESS CHANGES
*********************************/
BEGIN
SET NOCOUNT ON

	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		

	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)

		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))

	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptHSNOutputTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)

		

		SELECT DISTINCT P.Prdid,ColumnValue as HSNCODE 
		INTO #HSNCODE
		FROM UdcHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
		and C.UdcMasterId=B.UdcMasterId 
		INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
		WHERE A.MasterName='Product Master' and B.ColumnName='HSN CODE'
	
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			RetailerType Varchar(25),
			RtrCode Varchar(50),
			Rtrname Varchar(100),	
			HsnCode Varchar(50),
			Refid BIGINT,
			RefNo Varchar(50),
			RefDate DateTime,
			RtrId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCESS Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT Salid,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #SalesTaxableAmount
		FROM(
		SELECT S.Salid,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
		WHERE  TaxableAmount>0 and DlvSts>3
		AND SI.SalInvDate  Between @FromDate and @ToDate and VatGST='GST'
		GROUP BY S.Salid,PrdSlno ,TaxId
		)X GROUP BY Salid,Prdslno,TaxId
		
		SELECT ReturnID,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #RetunrTaxableAmount
		FROM(
		SELECT S.ReturnID,PrdSlno,TaxId,SUM(DISTINCT TaxableAmt) as TaxableAmount
		FROM ReturnProductTax  S  (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnID=SI.ReturnID
		WHERE  TaxableAmt>0 AND SI.ReturnDate  Between @FromDate and @ToDate and Status=0
		GROUP BY S.ReturnID,PrdSlno,TaxId
		)X GROUP BY  ReturnID,Prdslno,TaxId

		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0 and DlvSts>3
		GROUP BY HSNCODE,S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalinvNo,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(TaxAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and DlvSts>3
		GROUP BY HSNCODE,S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalInvNo,SPT.TaxId,RtrCode,Rtrname
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount, TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmt) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxableAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE ReturnDate	Between @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY HSNCODE,S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmt) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE ReturnDate between  @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY HSNCODE,S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname

 
		 
		--ILCRSTBOT0006
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','OutputGSTCESS','GSTCESS','InputGSTCESS')		

		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		
		--ILCRSTBOT0006
	
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,
		Refid,RefNo,RefDate,RtrId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','','', 0 as [InvId],'' as [RefNo],Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId	
	 
		--ADDED BY MOHANA ILCRSTPAR3750
		--UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		--B.Statename=A.StateName,
		--B.GSTIN=A.GSTIN,
		--B.RetailerType=CASE A.RetailerType WHEN 1 THEN 'Registered'
		--WHEN 2 THEN 'Unregistered' END
		--FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId
		
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName
		FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId
		
		UPDATE A SET A.GSTIN=Isnull(S.GSTIN,''),
		A.RetailerType=CASE S.RtrType WHEN 'R' THEN  'Registered'
		ELSE 'Unregistered' END
		FROM #TaxHSNSummary A 		
		INNER JOIN SalesInvoice S ON S.SalId=A.Refid
		WHERE TaxType='Sales of Goods'
		
		UPDATE A SET A.GSTIN=Isnull(S.GSTIN,''),
		A.RetailerType=CASE S.RtrType WHEN 'R' THEN  'Registered'
		ELSE 'Unregistered' END
		FROM #TaxHSNSummary A 
		INNER JOIN ReturnHeader RH ON A.Refid=RH.ReturnID		
		INNER JOIN SalesInvoice S ON S.SalId=RH.SalId
		WHERE TaxType='Return of Goods from Retailer'
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount),'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END


		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY AS VARCHAR(4000)
		DECLARE @GROUPBYCOL AS VARCHAR(4000)

		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''
		SET @GROUPBYCOL = ''

		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		
		SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount),SUM(TaxableAmountCESS),'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		RetailerType Varchar(25),
		RtrId INT,
		RtrCode Varchar(50),
		Rtrname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		RefDate DateTime,
		HsnCode Varchar(50),	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),
		TaxableAmountCESS Numeric(34,4),'

		SET @Columns1='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount) TaxableAmount,SUM(TaxableAmountCESS) TaxableAmountCESS,SUM(NetAmount)NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		
		SET @GROUPBY =' GROUP BY  StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
 
		SET @GROUPBYCOL = ' GROUP BY StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId]'

		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptHSNOutputTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptHSNOutputTaxGST'+
		' CREATE TABLE RptHSNOutputTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptHSNOutputTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1 + @GROUPBYCOL +
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBY + @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		
		SELECT DISTINCT
		StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptHSNOutputTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,422,'HSN Code Wise Output Tax',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',9,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',10,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',11,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',12,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')

				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptHSNOutputTaxGST)
			BEGIN
				SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptHSNInputTaxGST' AND TYPE='P')
DROP PROCEDURE Proc_RptHSNInputTaxGST
GO
/*
BEGIN tran
EXEC Proc_RptHSNInputTaxGST 423,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE Proc_RptHSNInputTaxGST
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptHSNOutPutTax
* PURPOSE	: To get the HSN Wise Tax Report
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptHSNInputTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		
		SELECT DISTINCT P.Prdid,ColumnValue as HSNCODE 
		INTO #HSNCODE
		FROM UdcHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
		and C.UdcMasterId=B.UdcMasterId 
		INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
		WHERE A.MasterName='Product Master' and B.ColumnName='HSN CODE'
	
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			SpmCode Varchar(50),
			Spmname Varchar(100),	
			HsnCode Varchar(50),
			Refid BIGINT,
			RefNo Varchar(50),
			CmpInvno Varchar(50),
			PurchaseOrderNo Varchar(50),
			InvoiceDate Datetime,
			RefDate DateTime,
			SpmId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			TaxableAmountCESS Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT PurRcptId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseTaxableAmount
		FROM(
		SELECT S.PurRcptId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId
		WHERE  TaxableAmount>0 and Status=1
		AND SI.InvDate  Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.PurRcptId,PrdSlno ,TaxId
		)X GROUP BY PurRcptId,Prdslno,TaxId
		
		SELECT PurRetId,Prdslno,TaxId,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseRtnTaxableAmount
		FROM(
		SELECT S.PurRetId,PrdSlno,TaxId,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId
		WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1
		GROUP BY S.PurRetId,PrdSlno,TaxId
		)X GROUP BY  PurRetId,Prdslno,TaxId

		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE InvDate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),0 TaxableAmountCESS,SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE InvDate Between @FromDate and @ToDate
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		
		
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,TaxableAmountCESS,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),0 TaxableAmountCESS,-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId AND ST.TaxId = T.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		
		--ILCRSTBOT0006
		
		SELECT Taxid INTO #Cess FROM TaxConfiguration WHERE TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','SGSTCESS','OutputGSTCESS',
		'InputCGSTCESS','CGSTCESS','InputSGSTCESS','SGSTCESS','InputGSTCESS','CESS',
		'OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS','INputIGSTCESS','INputUTGSTCESS','OutputGSTCESS','GSTCESS','INputGSTCESS')		

		UPDATE A SET NetAmount =0 ,TaxableAmountCESS= TaxableAmount , TaxableAmount = 0,GrossAmount =0--,DynamicAmt=0 
		FROM #TaxHSNSummary A WHERE TaxId IN (SELECT * FROM #CESS) 
		
		--ILCRSTBOT0006
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,
		Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,NUll,Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
	
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN
		FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId
		
		SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo
		INTO #Refcode
		FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId
		
		UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo 
		FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount),'
 

		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @GROUPBY AS VARCHAR(4000)
		DECLARE @GROUPBYCOL AS VARCHAR(4000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @GROUPBY = ''
		SET @GROUPBYCOL = ''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount),SUM(TaxableAmountCESS),'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		SpmId INT,
		SpmCode Varchar(50),
		Spmname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		CmpInvno Varchar(50),
		PurchaseOrderNo Varchar(50),
		InvoiceDate Datetime,
		RefDate DateTime,
		HsnCode Varchar(50),	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),
		TaxableAmountCESS Numeric(34,4),'
		SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,SUM(TaxableAmount) TaxableAmount,SUM(TaxableAmountCESS) TaxableAmountCESS,SUM(NetAmount) NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		
		SET @GROUPBY =' GROUP BY StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] '
		 
		SET @GROUPBYCOL=' GROUP BY  StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'

		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptHSNInputTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptHSNInputTaxGST'+
		' CREATE TABLE RptHSNInputTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptHSNInputTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+ @GROUPBY +
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GROUPBYCOL + @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		SELECT DISTINCT
		StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,HsnCode,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptHSNInputTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,423,'HSN Code Wise Input Tax',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',9,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',10,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',11,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',12,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',13,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			UNION ALL
			SELECT 1,423,'HSN Code Wise Input Tax',14,'TaxableAmountCESS',75,1,0,2,3,'Total','TaxableCESS','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
	
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptHSNInputTaxGST)
			BEGIN
				SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptFORMGSTR_3B_2_GST' AND TYPE='P')
DROP PROCEDURE Proc_RptFORMGSTR_3B_2_GST
GO
--EXEC Proc_RptFORMGSTR_3B_2_GST 411,1--,0,'',0,0,0
--SELECT * FROM RptFORMGSTR_3B_2
CREATE PROCEDURE Proc_RptFORMGSTR_3B_2_GST
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptFORMGSTR_3B_2_GST
* PURPOSE    : To Generate Outward Supplies Tax Report
* CREATED BY : Murugan.R
* CREATED ON : 07/08/@Jcmyear
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION
*************************************************/
BEGIN
SET NOCOUNT ON
		DECLARE @ErrNo	 			AS INT
		
	
	DECLARE @CmpId AS INT
	DECLARE @MonthStart INT
	DECLARE @JcmJc AS INT
	DECLARE @Jcmyear AS INT
	DECLARE @JcmFromId AS INT
	SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
	SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
	SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
	
	--Service Invoice UnRegistered Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerUnRegister1
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue IN('UnRegistered')	
	
	--Composite Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerComposite
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Composition' and ColumnValue IN('Yes')
	
	
	SELECT DISTINCT RtrId,StateCode,TinFirst2Digit,StateName,TinFirst2Digit+'-'+StateName as StateAndTin
	INTO #RetailerState
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
	WHERE U.MasterId=2 and ColumnName='State Name' 
	
		
	DELETE A FROM #RetailerUnRegister1 A WHERE EXISTS(SELECT Rtrid FROM #RetailerComposite B WHERE A.RtrId=B.RtrId)
	
	TRUNCATE TABLE RptFORMGSTR_3B_2
	
	INSERT INTO RptFORMGSTR_3B_2([Nature Of Supplies],[Place of supply(State/UT)],[Total Taxable Value],[Amount of Integrated],UsrId,[Group Name],GroupType)
	SELECT 'Supplies made to UnRegistered person' as [Nature Of Supplies],[Place of supply(State/UT)] as [Place of supply(State/UT)],ISNULL(SUM(TaxableAmount),0) as [Total Taxable Amount],
	ISNULL(SUM([Integrated]),0) as [Integrated],
	@Pi_UsrId,'',2
	FROM(
			SELECT  ISNULL(StateAndTin,'') as  [Place of supply(State/UT)], SUM(TaxableAmount) as TaxableAmount,SUM(TaxAmount) as Integrated,0 CESS
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN #RetailerUnRegister1 R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and VatGst='GST' and TaxAmount>0
			GROUP BY ISNULL(StateAndTin,'')		
			UNION ALL
			SELECT  ISNULL(StateAndTin,'') as  [Place of supply(State/UT)], SUM(TaxableAmount) as TaxableAmount,0 as Integrated,SUM(TaxAmount) CESS
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN #RetailerUnRegister1 R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputIGSTCESS','IGSTCESS','CGSTCESS','CESS') and VatGst='GST' and TaxAmount>0
			GROUP BY ISNULL(StateAndTin,'')			
			UNION ALL
			---Sales Return
			SELECT  ISNULL(StateAndTin,'') as  [Place of supply(State/UT)],-1*SUM(TaxableAmt) as TaxableAmount,-1*SUM(TaxAmt) as Integrated,0 CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN #RetailerUnRegister1 R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and SI.VatGst='GST' and TaxAmt>0
			GROUP BY ISNULL(StateAndTin,'')
			UNION ALL
			SELECT  ISNULL(StateAndTin,'') as  [Place of supply(State/UT)],-1*SUM(TaxableAmt) as TaxableAmount,0 as Integrated,-1*SUM(TaxAmt) CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN #RetailerUnRegister1 R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGSTCESS','IGSTCESS','GSTCESS','CESS') and SI.VatGst='GST' and TaxAmt>0
			GROUP BY ISNULL(StateAndTin,'')
	)X GROUP BY [Place of supply(State/UT)]
	
	INSERT INTO RptFORMGSTR_3B_2([Nature Of Supplies],[Place of supply(State/UT)],[Total Taxable Value],[Amount of Integrated],UsrId,[Group Name],GroupType)
	SELECT 'Supplies made to composition taxable person' as [Nature Of Supplies],[Place of supply(State/UT)] as [Place of supply(State/UT)],
	ISNULL(SUM(TaxableAmount),0) as [Total Taxable Amount],
	ISNULL(SUM([Integrated]),0) as [Integrated],
	@Pi_UsrId,'',2
	FROM(
			SELECT  ISNULL(StateAndTin,'') as   [Place of supply(State/UT)], SUM(TaxableAmount) as TaxableAmount,SUM(TaxAmount) as Integrated, 0 CESS
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN #RetailerComposite R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and VatGst='GST' and TaxAmount>0
			GROUP BY ISNULL(StateAndTin,'')
			UNION ALL
			SELECT  ISNULL(StateAndTin,'') as   [Place of supply(State/UT)], 0  TaxableAmount,0 as Integrated, SUM(TaxAmount)  CESS
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN #RetailerComposite R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN SalesInvoiceProductTax SPT (NOLOCK)  ON S.Salid=SPT.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE DlvSts>3 and MONTH(SalInvDate)=@MonthStart and Year(Salinvdate)=@Jcmyear 
			and TaxCode IN('OutputIGSTCESS','IGSTCESS','GSTCESS','CESS') and VatGst='GST' and TaxAmount>0
			GROUP BY ISNULL(StateAndTin,'')						
			UNION ALL
			---Sales Return
			SELECT  ISNULL(StateAndTin,'') as   [Place of supply(State/UT)],-1*SUM(TaxableAmt) as TaxableAmount,-1*SUM(TaxAmt) as Integrated, 0 CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN #RetailerComposite R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGST','IGST') and SI.VatGst='GST' AND TaxAmt>0
			GROUP BY ISNULL(StateAndTin,'')
			UNION ALL
			---Sales Return
			SELECT  ISNULL(StateAndTin,'') as   [Place of supply(State/UT)],0 as TaxableAmount,0 as Integrated, -1*SUM(TaxAmt) CESS
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN #RetailerComposite R ON R.RtrId=S.Rtrid
			LEFT OUTER JOIN #RetailerState RS ON RS.RtrId=R.RtrId and RS.RtrId=S.Rtrid
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGSTCESS','IGSTCESS','GSTCESS','CESS') and SI.VatGst='GST' AND TaxAmt>0
			GROUP BY ISNULL(StateAndTin,'')
			
	)X 
	GROUP BY [Place of supply(State/UT)]
	
	IF NOT EXISTS(SELECT 'X' FROM RptFORMGSTR_3B_2 WHERE [Nature Of Supplies]='Supplies made to UnRegistered person')
	BEGIN
		INSERT INTO RptFORMGSTR_3B_2([Nature Of Supplies],[Place of supply(State/UT)],[Total Taxable Value],[Amount of Integrated],UsrId,[Group Name],GroupType)
		SELECT 'Supplies made to UnRegistered person' as [Nature Of Supplies],'' as [Place of supply(State/UT)],0.00 as [Total Taxable Amount],
		0.00 as [Integrated],
		@Pi_UsrId,'',2
	END
	
	IF NOT EXISTS(SELECT 'X' FROM RptFORMGSTR_3B_2 WHERE [Nature Of Supplies]='Supplies made to composition taxable person')
	BEGIN
		INSERT INTO RptFORMGSTR_3B_2([Nature Of Supplies],[Place of supply(State/UT)],[Total Taxable Value],[Amount of Integrated],UsrId,[Group Name],GroupType)
		SELECT 'Supplies made to composition taxable person' as [Nature Of Supplies],'' as [Place of supply(State/UT)],0.00 as [Total Taxable Amount],
		0.00 as [Integrated],
		@Pi_UsrId,'',2
	END
	
	---Not Applicable 
	INSERT INTO RptFORMGSTR_3B_2([Nature Of Supplies],[Place of supply(State/UT)],[Total Taxable Value],[Amount of Integrated],UsrId,[Group Name],GroupType)
	SELECT 'Supplies made to UIN holders' as [Nature Of Supplies],'' as [Place of supply(State/UT)],0 as [Total Taxable Amount],
	0 as [Integrated],@Pi_UsrId,'',2
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptFORMGSTR_3B_3_GST' AND TYPE='P')
DROP PROCEDURE Proc_RptFORMGSTR_3B_3_GST
GO
--EXEC Proc_RptFORMGSTR_3B_3_GST 411,1--,0,'',0,0,0
--SELECT * FROM RptFORMGSTR_3B_3
CREATE PROCEDURE Proc_RptFORMGSTR_3B_3_GST
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT
)
AS
/************************************************
* PROCEDURE  : Proc_RptFORMGSTR_3B_3_GST
* PURPOSE    : To Generate Outward Supplies Tax Report
* CREATED BY : Murugan.R
* CREATED ON : 07/08/@Jcmyear
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION
*************************************************/
BEGIN
SET NOCOUNT ON
	
	DECLARE @ErrNo	 			AS INT
		
	
	DECLARE @CmpId AS INT
	DECLARE @MonthStart INT
	DECLARE @JcmJc AS INT
	DECLARE @Jcmyear AS INT
	DECLARE @JcmFromId AS INT
	SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
	SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
	SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
	SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
	
	--Service Invoice UnRegistered Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerUnRegister1
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue IN('UnRegistered')
	
	--Registered Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerRegister
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue IN('Registered')
	
	----Composite Retailer
	SELECT DISTINCT RtrId
	INTO #RetailerComposite
	FROM UDCHD U 
	INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
	INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
	WHERE U.MasterId=2 and ColumnName='Composition' and ColumnValue IN('Yes')
	
	DELETE A FROM #RetailerUnRegister1 A WHERE EXISTS(SELECT Rtrid FROM #RetailerComposite B WHERE A.RtrId=B.RtrId)
	
	TRUNCATE TABLE RptFORMGSTR_3B_3
	
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(A) ITC Available (Whether in full or part)' as Details,'' as [Integrated Tax],'' as [Central Tax],'' as [State/UT Tax],
	'' as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(1) Import of goods' as Details,'0.00' as [Integrated Tax],'0.00' as [Central Tax],'0.00' as [State/UT Tax],
	'0.00' as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(2) Import of Services' as Details,'0.00' as [Integrated Tax],'0.00' as [Central Tax],'0.00' as [State/UT Tax],
	'0.00' as Cess,@Pi_UsrId,'',2
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	--SELECT '(3) Inward supplies liable to reverse charge(Other than 1 & 2 above)' as Details,0 as [Integrated Tax],0 as [Central Tax],0 as [State/UT Tax],
	--0 as Cess,@Pi_UsrId,'',2
	SELECT '(3) Inward supplies liable to reverse charge(Other than 1 & 2 above)' as Details,ISNULL(SUM(Integrated),0) as Integrated,
	ISNULL(SUM(Central),0) as Central,ISNULL(SUM([State/UT Tax]),0) as [State/UT Tax],0.00 as CESS,
	@Pi_UsrId,'',2
	FROM(
			
			SELECT
			CAST(ISNULL(CASE  WHEN TaxCode  IN ('OutputIGST','IGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2)) as Integrated,			
			CAST(ISNULL(CASE  WHEN TaxCode IN ('OutputCGST','CGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2))as Central,
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2)) as [State/UT Tax],  
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','CESS','OutputGSTCESS','GSTCESS') 
			THEN SUM(TaxAmount) END,0) as Numeric(18,2))  as CESS			
			FROM ServiceInvoicehd S (NOLOCK)
			INNER JOIN #RetailerUnRegister1 R ON R.Rtrid=ServiceFromId
			INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK) ON SI.ServiceInvId=S.ServiceId 
			INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId=SI.TaxId
			WHERE ServiceInvFor=1 and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','CESS','OutputGSTCESS','GSTCESS')
			and Month(ServiceInvDate)=@MonthStart and YEAR(ServiceInvDate)=@Jcmyear and TaxAmount>0
			GROUP BY TaxCodE		
		)X
		
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(4) Inward supplies from ISD' as Details,0.00 as [Integrated Tax],0.00 as [Central Tax],0.00 as [State/UT Tax],
	0.00 as Cess,@Pi_UsrId,'',2
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(5) All other ITC' as Details,ISNULL(SUM(Integrated),0) as Integrated,
	ISNULL(SUM(Central),0) as Central,ISNULL(SUM([State/UTTax]),0) as [State/UT Tax],ISNULL(SUM(CESS),0) as CESS,
	@Pi_UsrId,'',2
	FROM(
			---Sales Return
			SELECT  
			CAST(ISNULL(CASE  WHEN TaxCode  IN ('OutputIGST','IGST') THEN SUM(TaxAmt) END,0) as Numeric(18,2)) as Integrated,			
			CAST(ISNULL(CASE  WHEN TaxCode IN ('OutputCGST','CGST') THEN SUM(TaxAmt) END,0) as Numeric(18,2)) as Central,
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(TaxAmt) END,0) as Numeric(18,2)) as [State/UTTax],  
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputGSTCESS','GSTCESS','CESS') 
			THEN SUM(TaxAmt) END,0) as Numeric(18,2))  as CESS			
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax SPT (NOLOCK)  ON S.ReturnID=SPT.ReturnID
			INNER JOIN #RetailerRegister R ON R.RtrId=S.RtrId
			INNER JOIN SalesInvoice SI (NOLOCK) ON SI.Salid=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=SPT.TaxId
			WHERE Status=0 
			and MONTH(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputGSTCESS','GSTCESS','CESS') and S.GSTtag='DTVAT'
			and TaxAmt>0	
			GROUP BY TaxCode
						
			UNION ALL
			--Purchase Return
			SELECT 
			CAST(ISNULL(CASE  WHEN TaxCode IN ('InputIGST','IGST') THEN -1*SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as Integrated,			
			CAST(ISNULL(CASE  WHEN TaxCode IN ('InputCGST','CGST') THEN -1*SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as Central,
			CAST(ISNULL(CASE  WHEN TaxCode IN ('InputSGST','InputUTGST','SGST','UTGST') THEN -1*SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as [State/UTTax],  
			CAST(ISNULL(CASE  WHEN TaxCode IN('InputIGSTCESS','IGSTCESS','InputCGSTCESS','CGSTCESS','InputSGSTCESS','InputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','GSTCESS','CESS')
		        THEN -1*SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as CESS			
			FROM PurchaseReturn P (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax PPT (NOLOCK) ON P.PurRetId=PPT.PurRetId
			INNER JOIN PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=P.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE P.Status=1 and Month(P.PurRetDate)=@MonthStart and Year(P.PurRetDate)=@Jcmyear
			and TaxCode  IN('InputIGST','InputCGST','InputSGST','InputUTGST','InputGSTCess','SGST','IGST','UTGST','CGST','CESS',
			'InputIGSTCESS','IGSTCESS','InputCGSTCESS','CGSTCESS','InputSGSTCESS','InputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','GSTCESS','CESS') and PR.VatGst='GST'
			and PPT.TaxAmount>0
			GROUP BY TaxCode
			UNION ALL
			--Purchase Receipt
			SELECT 
			CAST(ISNULL(CASE  WHEN TaxCode IN ('InputIGST','IGST') THEN SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as Integrated,			
			CAST(ISNULL(CASE  WHEN TaxCode IN ('InputCGST','CGST') THEN SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as Central,
			CAST(ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as [State/UTTax],  
			CAST(ISNULL(CASE  WHEN TaxCode IN('InputIGSTCESS','IGSTCESS','InputCGSTCESS','CGSTCESS','InputSGSTCESS','InputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','GSTCESS','CESS')
			THEN SUM(PPT.TaxAmount) END,0) as Numeric(18,2)) as CESS			
			FROM PurchaseReceipt P (NOLOCK) 
			INNER JOIN PurchaseReceiptProductTax PPT (NOLOCK) ON P.PurRcptId=PPT.PurRcptId			
			INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=PPT.TaxId
			WHERE P.Status=1 and Month(P.GoodsRcvdDate)=@MonthStart and Year(P.GoodsRcvdDate)=@Jcmyear
			and TaxCode  IN('InputIGST','InputCGST','InputSGST','InputUTGST','InputGSTCess','SGST','IGST','UTGST','CGST','CESS',
			'InputIGSTCESS','IGSTCESS','InputCGSTCESS','CGSTCESS','InputSGSTCESS','InputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','GSTCESS','CESS') and P.VatGst='GST'
			and PPT.TaxAmount>0
			GROUP BY TaxCode			
			UNION ALL
			SELECT
			CAST(ISNULL(CASE  WHEN TaxCode  IN ('OutputIGST','IGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2)) as Integrated,			
			CAST(ISNULL(CASE  WHEN TaxCode IN ('OutputCGST','CGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2))as Central,
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(TaxAmount) END,0) as Numeric(18,2)) as [State/UT Tax],  
			CAST(ISNULL(CASE  WHEN TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputGSTCESS','GSTCESS','CESS') THEN SUM(TaxAmount) END,0) as Numeric(18,2)) as CESS			
			FROM ServiceInvoicehd S (NOLOCK)
			INNER JOIN #RetailerRegister R ON R.Rtrid=ServiceFromId
			INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK) ON SI.ServiceInvId=S.ServiceId 
			INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId=SI.TaxId
			WHERE ServiceInvFor=1 and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputGSTCESS','GSTCESS','CESS')
			and Month(ServiceInvDate)=@MonthStart and YEAR(ServiceInvDate)=@Jcmyear
			and TaxAmount>0
			GROUP BY TaxCode
	)X
	
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(B) ITC Reversed' as Details,'' as [Integrated Tax],'' as [Central Tax],'' as [State/UT Tax],
	'' as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(1) As per rules 42 & 43 of CGST rules' as Details,0.00 as [Integrated Tax],0.00 as CentralTax,0.00 as [State/UT Tax],
	0.00 as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(2) Others' as Details,0.00 as [Integrated Tax],0.00 as [Central Tax],0.00 as [State/UT Tax],
	0.00 as Cess,@Pi_UsrId,'',2
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(C) Net ITC Available (A)-(B)' as Details,	
	SUM(CAST([Integrated Tax] as Numeric(18,2))) as [Integrated Tax],SUM(CAST([Central Tax] as Numeric(18,2))) as [Central Tax],
	SUM(CAST([State/UT Tax] as Numeric(18,2))) as  [State/UT Tax],
	SUM(CAST(Cess as Numeric(18,2))) as Cess,@Pi_UsrId,'',2
	FROM RptFORMGSTR_3B_3 WHERE  Details IN('(5) All other ITC','(3) Inward supplies liable to reverse charge(Other than 1 & 2 above)')
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(D) Ineligible ITC' as Details,'' as [Integrated Tax],'' as [Central Tax],'' as [State/UT Tax],
	'' as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(1) As per Section 17(5)' as Details,0.00 as [Integrated Tax],0.00 as [Central Tax],0.00 as [State/UT Tax],
	0.00 as Cess,@Pi_UsrId,'',2
	--Not Applicable
	INSERT INTO RptFORMGSTR_3B_3(Details,[Integrated Tax],[Central Tax],[State/UT Tax],Cess,UsrId,[Group Name],GroupType)
	SELECT '(2) Others' as Details,0.00 as [Integrated Tax],0.00 as [Central Tax],0.00 as [State/UT Tax],
	0.00 as Cess,@Pi_UsrId,'',2
			
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR1_B2B' AND Type ='P')
DROp PROCEDURE Proc_RptGSTR1_B2B
GO
/*
EXEC Proc_RptGSTR1_B2B 414,2,0,'',0,0,0
*/
CREATE PROCEDURE Proc_RptGSTR1_B2B
(
	
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptGSTR1_B2B
* PURPOSE		: To Generate a report GSTR1 B2B
* CREATED		: Murugan.R
* CREATED DATE	: 13/04/2017
* MODIFIED
------------------------------------------------
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
* 11-01-2018	  MURUGAN	  BZ			ICRSTLOR2374		GSTR1 Report - REFRESH ISSUE FIX
* 11-06-2018	  S.MOORTHI	  BZ			ILCRSTPAR0926           IDT TAX AMOUNT NOT SHOWING/ILCRSTLOR0379
* 08-10-2018	  MOHANA S	  CR		        ILCRSTBOT0006	         Included CESS Tax
*********************************/
SET NOCOUNT ON
BEGIN
		TRUNCATE TABLE RptGSTR1_B2B
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		--ILCRSTNIV0599 From here
		DELETE FROM  ReportFilterDt WHERE RptId IN(414,415,416,417,418,419,420,421) 
		INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)
		SELECT 414,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 415,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 416,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 417,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 418,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId	
		UNION ALL
		SELECT 419,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 420,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 421,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=424 AND UsrId=@Pi_UsrId
		--ILCRSTNIV0599 Till here
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET 10=7
		--SET 2018=2017
		
		
		CREATE TABLE #RptGSTR1_B2B
		(
		TransId				TINYINT,
		TranType			VARCHAR(20),
		Refid				BIGINT,
		RtrShipId			INT,
		RtrId				INT,
		RtrCode				VARCHAR(50),		
		RtrName				VARCHAR(100),
		[GSTIN/UIN of Recipient]	 VARCHAR(50),
		[Retailer Type]		 VARCHAR(50),
		[Invoice Number]	 VARCHAR(50),
		[Invoice date]		 DATETIME,
		[Invoice Value]		 NUMERIC(32,2),
		[Place Of Supply]	 VARCHAR(125),
		[Reverse Charge]	 VARCHAR(10),
		[Invoice Type]		 VARCHAR(50),
		[Kind of transaction]			Varchar(50),
		[Identifier if Goods or Services]	Varchar(50),		
		[E-Commerce GSTIN]	 VARCHAR(50),
		[Rate]				 NUMERIC(10,2),
		[Taxable Value]		 NUMERIC(32,2),
		[Cess Amount]		 NUMERIC(32,2),
		[IGST rate]			 Numeric(32,2),
		[IGST amount]		 Numeric(32,2),
		[CGST rate]			 Numeric(32,2),
		[CGST amount]		 Numeric(32,2),
		[SGST/UTGST rate]	 Numeric(32,2),
		[SGST/UTGST amount]	 Numeric(32,2),		
		UsrId				 INT,
		[Group Name]		 VARCHAR(100),
		GroupType			 TINYINT
		)
		
		SELECT PurRcptId INTO #Purchareceipt
		FROM PurchaseReceipt (NOLOCK)
		WHERE GoodsRcvdDate Between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		and Status=1
		
		---Retailer State
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
		---Supplier State
		SELECT DISTINCT  R.SpmId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		---IDT Distributor State
		SELECT DISTINCT  R.SpmId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #IDTSupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name'
		
		
		---Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
				
		---IDT Supplier GSTIN
		SELECT DISTINCT  SpmId as RtrId ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		
		---Retailer GSTIN
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue	INTO #RetailerRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='Registered' 
		
		
		---Sales Data
		SELECT S.RtrId,S.RtrshipId,S.Salid,Salinvno,SalInvdate,Prdslno,OrgNetAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #Sales		
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST')
		and ST.TaxableAmount>0
		GROUP BY S.RtrId,S.Salid,Salinvno,SalInvdate,Prdslno,S.RtrshipId,OrgNetAmount
		SELECT S.SalId,S.Rtrid,SUM(PrdNetAmount)PrdNetAmount INTO #SalesNetValue FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SI (NOLOCK) ON S.Salid=SI.SalId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		GROUP BY S.SalId,S.Rtrid
		UPDATE S SET OrgNetAmount=PrdNetAmount FROM #Sales S INNER JOIN #SalesNetValue SI ON S.Salid=SI.Salid
		
		--IDT Sales Data
		SELECT ToSpmId,I.IDTMngRefNo,IDTMngDate,PrdSlNo,IDTNetAmt,SUM(TaxPerc) as TaxPerc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #IDTSales
		FROM IDTManagement I (NOLOCK) 
		INNER JOIN IDTManagementProductTax IT (NOLOCK) ON I.IDTMngRefNo=IT.IDTMngRefNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=IT.TaxId
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		and StkMgmtTypeId=2 and IT.TaxableAmount>0
		GROUP BY ToSpmId,I.IDTMngRefNo,IDTMngDate,PrdSlNo,IDTNetAmt
		
		---Purchase Return Supply Data
		SELECT SpmId,I.PurRetId,I.PurRetRefNo,PurRetDate,PrdSlNo,NetAmount,SUM(IT.TaxPerc) as TaxPerc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(IT.TaxAmount) as TaxAmount
		INTO #PurchaseReturn
		FROM PurchaseReturn I (NOLOCK) 
		INNER JOIN PurchaseReturnProductTax IT (NOLOCK) ON I.PurRetId=IT.PurRetId
		INNER JOIN #Purchareceipt R ON R.PurRcptId=I.PurRcptId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=IT.TaxId
		WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear
		and IT.TaxableAmount>0
		GROUP BY SpmId,I.PurRetRefNo,PurRetDate,PrdSlNo,I.PurRetId,NetAmount
		
		SELECT  S.ServiceToId,S.ServiceInvId as Salid,ServiceInvRefNo as Salinvno,ServiceInvDate as SalInvdate,
		RowNo,AppTotalAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #ServiceData
		FROM ServiceInvoiceHd S (NOLOCK) 
		INNER JOIN ServiceInvoiceTaxDetails SI (NOLOCK)
		ON S.ServiceInvId=SI.ServiceInvId
		WHERE ServiceInvFor=2 and  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear
		and SI.TaxableAmount>0
		GROUP BY S.ServiceToId,S.ServiceInvId,ServiceInvRefNo,ServiceInvDate,RowNo,AppTotalAmount
		
		-----Service
		--SELECT UniqueId,Proforma_Invoice_No ,Proforma_Invoice_Date ,
		--SUM(ISNULL(DocAmount+tax_Amount,0))ApprovedAmt ,SUM(CGST_Per+SGST_Per+IGST_Per+UTGST_Per) as Taxperc,
		--SUM(ISNULL(DocAmount,0)) as TaxableAmount,SUM(ISNULL(tax_Amount,0)) as TaxAmount,CGST_Per,SGST_Per,IGST_Per,UTGST_Per,
		--CGST_Amt,SGST_Amt,IGST_Amt,UTGST_Amt
		--INTO #ServiceData
		--FROM ClaimAcknowledgement WHERE ClaimType IN('Project1 Claim','Other Claim','Manual Claim',
		--'VAT Claim','Incentive Claim','ROI Subsidy Claim','VD ManPower Cost Claim','VD Subsidy Claim','OTHER SERVICE CLAIM')
		--and CAST(ClaimMonth as INT)=@MonthStart and ClaimYear=@Jcmyear 
		--and LEN(ISNULL(DocNumber,''))>0 and Status='APPROVED' and LEN(ISNULL(ServiceAcCode,''))>0
		--GROUP BY UniqueId,Proforma_Invoice_No,Proforma_Invoice_Date,CGST_Per,SGST_Per,IGST_Per,UTGST_Per,CGST_Amt,SGST_Amt,IGST_Amt,UTGST_Amt
		--HAVING SUM(ISNULL(IGST_AMT,0)+ISNULL(CGST_Amt,0)+ISNULL(SGST_Amt,0)+ISNULL(UTGST_Amt,0))>0
		
		---CALCULATE TAX SPLIT 
				
			SELECT TAXID,				
			CASE WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
				 WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
				 WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
				 WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
				 WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
				 WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
				 WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
				 WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
				 WHEN TaxCode IN ('OutputGSTCESS','CESS','GSTCESS','InputGSTCESS') Then 'OutputGSTCESS'

			END	 as TaxCode
			INTO #TaxConfiguration
			FROM  TaxConfiguration WHERE TaxCode 
			IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','CESS',
			'InputCGST','InputSGST','InputIGST','InputUTGST','OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS',
			'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','OutputGSTCESS','GSTCESS','CESS','InputGSTCESS')


		SELECT * INTO #SalesInvoiceProductTax FROM SalesInvoiceProductTax 
			WHERE SalId IN (SELECT DISTINCT salid FROM #Sales) 			
				
		SELECT * INTO #IDTManagementProductTax FROM IDTManagementProductTax 
			WHERE IDTMngRefNo IN (SELECT DISTINCT IDTMngRefNo FROM #IDTSales) 
		SELECT * INTO #PurchaseReturnProductTax  FROM PurchaseReturnProductTax 
			WHERE PurRetId IN (SELECT DISTINCT PurRetId FROM #PurchaseReturn) 
			SELECT * INTO #ServiceInvoiceTaxDetails  FROM ServiceInvoiceTaxDetails 
			WHERE ServiceInvId IN (SELECT DISTINCT ServiceInvId FROM #ServiceData) 
 			
  			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
			FROM
			(
			----SALES DATA
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,
			TaxCode+'Perc' AS TaxCode
			,ST.TaxPerc AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId  AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL	
			-------IDT DETAILS	
			SELECT 2 AS BTYPE,SI.IDTMngRefNo AS Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #IDTSales SI
				INNER JOIN #IDTManagementProductTax ST ON ST.IDTMngRefNo=SI.IDTMngRefNo AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN (SELECT TAXID,TAXCODE FROM  #TaxConfiguration WHERE TaxCode --Added by Mohanakrishna A.B ILCRSTNIV0351
					IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','CESS',
					'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','OutputGSTCESS','GSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS')) T ON T.TaxId=ST.TaxId
			UNION ALL
			SELECT 2 AS BTYPE,SI.IDTMngRefNo  AS Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #IDTSales SI
				INNER JOIN #IDTManagementProductTax ST ON ST.IDTMngRefNo=SI.IDTMngRefNo AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN (SELECT TAXID,TAXCODE FROM  #TaxConfiguration WHERE TaxCode  --Added by Mohanakrishna A.B ILCRSTNIV0351
				IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST','OutputGSTCESS','CESS','INputGSTCESS',
					'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','GSTCESS')) T ON T.TaxId=ST.TaxId
			UNION ALL	
  			---PURCHASE RETURN DETAILS
				SELECT 3 AS BTYPE,SI.PurRetRefNo AS Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #PurchaseReturn SI
				INNER JOIN #PurchaseReturnProductTax ST ON ST.PurRetId=SI.PurRetId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
				SELECT 3 AS BTYPE,SI.PurRetRefNo AS Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #PurchaseReturn SI
				INNER JOIN #PurchaseReturnProductTax ST ON ST.PurRetId=SI.PurRetId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId		
			UNION ALL	
  			---Service Invoice
				SELECT 4 AS BTYPE,SI.Salinvno AS Salinvno,SI.RowNo as Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #ServiceData SI
				INNER JOIN #ServiceInvoiceTaxDetails ST ON ST.ServiceInvId=SI.Salid AND ST.RowNo=SI.RowNo
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
				SELECT 4 AS BTYPE,SI.Salinvno AS Salinvno,SI.RowNo as Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #ServiceData SI
				INNER JOIN #ServiceInvoiceTaxDetails ST ON ST.ServiceInvId=SI.Salid AND ST.RowNo=SI.RowNo
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId			
  			)A
 			ORDER BY BTYPE 

 			SELECT BTYPE,Salinvno,Prdslno,SUM([OutputCGSTPerc])[OutputCGSTPerc],
				SUM([OutputCGST_Amt])[OutputCGST_Amt],SUM([OutputSGSTPerc])[OutputSGSTPerc],SUM([OutputSGST_Amt])[OutputSGST_Amt],
				SUM([OutputIGSTPerc])[OutputIGSTPerc],SUM([OutputIGST_Amt])[OutputIGST_Amt],SUM([OutputUTGSTPerc])[OutputUTGSTPerc],
				SUM([OutputUTGST_Amt])[OutputUTGST_Amt],
				SUM([OutputCGSTCESS_Amt])[OutputCGSTCESS_Amt],SUM([OutputSGSTCESSPerc])[OutputSGSTCESSPerc],SUM([OutputSGSTCESS_Amt])[OutputSGSTCESS_Amt],
				SUM([OutputIGSTCESSPerc])[OutputIGSTCESSPerc],SUM([OutputIGSTCESS_Amt])[OutputIGSTCESS_Amt],SUM([OutputUTGSTCESSPerc])[OutputUTGSTCESSPerc],
				SUM([OutputUTGSTCESS_Amt])[OutputUTGSTCESS_Amt],
				SUM([OutputGSTCESSPerc])[OutputGSTCESSPerc],SUM([OutputGSTCESS_Amt])[OutputGSTCESS_Amt]
			INTO #TAXDETAILS
			FROM(
			SELECT BTYPE,Salinvno,Prdslno,
			ISNULL([OutputCGSTPerc],0)[OutputCGSTPerc],ISNULL([OutputCGST_Amt],0)[OutputCGST_Amt],
			ISNULL([OutputSGSTPerc],0)[OutputSGSTPerc],ISNULL([OutputSGST_Amt],0)[OutputSGST_Amt],
			ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],
			ISNULL([OutputUTGSTPerc],0)[OutputUTGSTPerc],ISNULL([OutputUTGST_Amt],0)[OutputUTGST_Amt],
			ISNULL([OutputCGSTCESSPerc],0)[OutputCGSTCESSPerc],ISNULL([OutputCGSTCESS_Amt],0)[OutputCGSTCESS_Amt],
			ISNULL([OutputSGSTCESSPerc],0)[OutputSGSTCESSPerc],ISNULL([OutputSGSTCESS_Amt],0)[OutputSGSTCESS_Amt],
			ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],
			ISNULL([OutputUTGSTCESSPerc],0)[OutputUTGSTCESSPerc],ISNULL([OutputUTGSTCESS_Amt],0)[OutputUTGSTCESS_Amt],
			ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],ISNULL([OutputGSTCESS_Amt],0)[OutputGSTCESS_Amt]
			FROM (
			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt
			FROM #TAXPIVOT) up
			PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputCGST_Amt],[OutputCGSTPerc],
													[OutputGSTCESS_Amt],[OutputGSTCESSPerc],[OutputSGSTPerc],[OutputSGST_Amt],[OutputIGSTPerc],[OutputIGST_Amt],[OutputUTGSTPerc],
													[OutputUTGST_Amt],[OutputCGSTCESSPerc],[OutputCGSTCESS_Amt],[OutputSGSTCESSPerc],[OutputSGSTCESS_Amt],[OutputIGSTCESSPerc],[OutputIGSTCESS_Amt],
													[OutputUTGSTCESSPerc],[OutputUTGSTCESS_Amt]))  AS PVT 
			)A
			GROUP BY BTYPE,Salinvno,Prdslno 
			
					
 		INSERT INTO #RptGSTR1_B2B(TransId,TranType,Refid ,RtrShipId,RtrId,RtrCode,RtrName,
			[GSTIN/UIN of Recipient],[Retailer Type],[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],
			[Reverse Charge],[Invoice Type],[Kind of transaction],[Identifier if Goods or Services],[E-Commerce GSTIN],
			[Rate],[Taxable Value],[Cess Amount],[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],
			[SGST/UTGST amount],UsrId,[Group Name],GroupType)
		SELECT 1,'Sales',S.Salid,S.RtrShipId,R.RtrId,RtrCode,RtrName,'' as GSTTin,ISNULL(ColumnValue,'') as RetailerType,S.SalInvNo,Salinvdate, OrgNetAmount as SalesValue,'' as PlaceOfSupply,
			  'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount,
			 SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_Amt]) as CessAmount,[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			 ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #Sales S INNER JOIN Retailer R (NOLOCK) ON R.RtrId=S.RtrId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.SalInvNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=1
		LEFT OUTER JOIN #RetailerRegister Rr ON Rr.RtrId=S.RtrId
		GROUP BY 
			S.Salid,R.RtrId,RtrCode,RtrName,S.Salinvno,Salinvdate,Taxperc,S.RtrShipId,OrgNetAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc],ColumnValue
		UNION ALL
		SELECT 2,'IDT',0 as Salid,0 as RtrShipId,R.SpmId as RtrId,SpmCode as RtrCode,SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,
		S.IDTMngRefNo as Salinvno,IDTMngDate as Salinvdate,IDTNetAmt as SalesValue,'' as PlaceOfSupply,
		'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,'' as [E-Commerce],Taxperc,
		SUM(TaxableAmount) as TaxableAmount, SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			   ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #IDTSales S INNER JOIN IDTMaster R (NOLOCK) ON R.SpmId=S.ToSpmId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.IDTMngRefNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=2
		GROUP BY 
			R.SpmId,SpmCode,SpmName,S.IDTMngRefNo,IDTMngDate,Taxperc,IDTNetAmt,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		UNION ALL
		SELECT 3,'PurchaseReturn',S.PurRetId as Salid,0 as RtrShipId,R.SpmId as RtrId,SpmCode as RtrCode,
		SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,S.PurRetRefNo as Salinvno,PurRetDate as Salinvdate,NetAmount as SalesValue,
		'' as PlaceOfSupply,'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of goods' as Kind,'Goods' as Goods ,
		'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount, SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,[OutputIGSTPerc],
		SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			   ([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #PurchaseReturn S 	INNER JOIN Supplier R (NOLOCK) ON R.SpmId=S.SpmId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.PurRetRefNo AND T.PrdSlNo=S.PrdSlNo AND T.BTYPE=3
		GROUP BY 
		R.SpmId,SpmCode,SpmName,S.PurRetRefNo,PurRetDate,Taxperc,S.PurRetId,NetAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		UNION ALL
		SELECT 4,'Service',S.Salid as Salid,0 as RtrShipId,S.ServiceToId as RtrId,SpmCode as RtrCode,
		SpmName as RtrName,'' as GSTTin,'Registered' as RetailerType,
		S.Salinvno as Salinvno,SalInvdate as Salinvdate,AppTotalAmount as SalesValue,'' as PlaceOfSupply,
		'N' as ReverseCharge,'Regular' as InvoiceType,'Sale of service' as Kind,
		'Services' as Goods,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount, 
		SUM([OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputUTGSTCESS_AMT]+[OutputGSTCESS_AMT]) as CessAmount,
		[OutputIGSTPerc] as [OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc] as [OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
	   ([OutputSGSTPerc]+[OutputUTGSTPerc]) as [OutputSGSTPerc], SUM([OutputSGST_Amt]+[OutputUTGST_Amt]) AS [OutputSGST_Amt],
		@Pi_UsrId,'' as [Group Type],2
		FROM #ServiceData S INNER JOIN Supplier R (NOLOCK) ON R.SpmId=S.ServiceToId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.SalInvNo AND T.PrdSlNo=S.RowNo AND T.BTYPE=4
		GROUP BY S.ServiceToId,SpmCode,SpmName,S.Salinvno,SalInvdate,Taxperc,S.Salid,AppTotalAmount,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		
		 
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #RetailerState A INNER JOIN #RptGSTR1_B2B B ON A.Rtrid=B.RtrId
		WHERE B.TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=GSTTinNo FROM #RptGSTR1_B2B R INNER JOIN RetailerShipAdd RS ON RS.RtrShipId=R.RtrShipId
		and R.TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #RetailerGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[GSTIN/UIN of Recipient],''))=0 and R.TransId=1
		
		DELETE A FROM #RptGSTR1_B2B A WHERE NOT EXISTS(SELECT RtrId FROM #RetailerRegister B WHERE A.RtrId=B.RtrId)
		and TransId=1
		
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #SupplierState A INNER JOIN #RptGSTR1_B2B B ON A.RtrId=B.RtrId
		WHERE B.TransId IN(3,4)
	
		
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #IDTSupplierState A INNER JOIN #RptGSTR1_B2B B ON A.Rtrid=B.RtrId
		WHERE B.TransId=2
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #SupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE  R.TransId IN(3,4)
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2B R INNER JOIN #IDTSupplierGSTIN RS ON RS.RtrId=R.RtrId
		WHERE  R.TransId=2
		
	 --select * from #RptGSTR1_B2B
		
		
			
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR1_B2B)
		BEGIN
			INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
			,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
			[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
			[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)
			SELECT '' as [GSTIN/UIN of Recipient],'' as [Recipient Code in application],'' as [Recipient Name],'' as[Recipient Type],
			'' as [Invoice Number],'' as [Invoice date],0,'' as [Place Of Supply],'' as [Reverse Charge],'' as [Invoice Type],'' as [Kind of transaction],	
			'' as [Identifier if Goods or Services],'' as [E-Commerce GSTIN],0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),
			0 as [IGST rate],SUM([IGST amount]),0 as [CGST rate],SUM([CGST amount]),0 as [SGST/UTGST rate],SUM([SGST/UTGST amount]),
			@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
			FROM #RptGSTR1_B2B		
			SELECT * FROM RptGSTR1_B2B (NOLOCK) WHERE UsrId=@Pi_UsrId
			
			DELETE FROM RptGSTR1_B2B WHERE UsrId=@Pi_UsrId			
			
			RETURN
		END
		
		INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
		,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
		[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)		
		SELECT [GSTIN/UIN of Recipient],RtrCode,rtrname,[Retailer Type],[Invoice Number],
		REPLACE(REPLACE(CONVERT(VARCHAR,[Invoice date],106), ' ','-'), ',',''),[Invoice Value],[Place Of Supply],
		[Reverse Charge],[Invoice Type],[Kind of transaction],[Identifier if Goods or Services]	,[E-Commerce GSTIN],[Rate],[Taxable Value],
		[Cess Amount],[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType
		FROM #RptGSTR1_B2B 
		ORDER BY TransId,[GSTIN/UIN of Recipient],[Invoice date],[Invoice Number]
		
		SELECT DISTINCT TransId,[Invoice Number],[Invoice Value]
		INTO #GrandTotal
		FROM #RptGSTR1_B2B
		
		
		INSERT INTO RptGSTR1_B2B([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],[Recipient Type]
		,[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],[Reverse Charge],[Invoice Type],[Kind of transaction],
		[Identifier if Goods or Services],[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)
		SELECT '' as [GSTIN/UIN of Recipient],'' as [Recipient Code in application],'' as [Recipient Name],'' as[Recipient Type],
		'' as [Invoice Number],'' as [Invoice date],0,'' as [Place Of Supply],'' as [Reverse Charge],'' as [Invoice Type],'' as [Kind of transaction],	
		'' as [Identifier if Goods or Services],'' as [E-Commerce GSTIN],0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),
		0 as [IGST rate],SUM([IGST amount]),0 as [CGST rate],SUM([CGST amount]),0 as [SGST/UTGST rate],SUM([SGST/UTGST amount]),
		@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR1_B2B
		
		UPDATE RptGSTR1_B2B SET [Invoice Value]=(SELECT SUM([Invoice Value]) FROM #GrandTotal) WHERE GroupType=3
		
		
		SELECT * FROM RptGSTR1_B2B WHERE UsrId=@Pi_UsrId
				
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR1_B2CL' AND Type ='P')
DROp PROCEDURE Proc_RptGSTR1_B2CL
GO
/*
EXEC Proc_RptGSTR1_B2CL 415,2,0,'',0,0,1
 */
CREATE PROCEDURE Proc_RptGSTR1_B2CL
(
	
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptGSTR1_B2CL
* PURPOSE		: To Generate a report GSTR1 B2CL
* CREATED		: Murugan.R
* CREATED DATE	: 13/04/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR				Included CESS Tax
*********************************/
SET NOCOUNT ON
BEGIN
		TRUNCATE TABLE RptGSTR1_B2CL
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		
		
		CREATE TABLE #RptGSTR1_B2CL
		(
		TransId TinyInt,
		TranType Varchar(20),
		Refid BIGINT,
		RtrShipId INT,
		RtrId INT,
		RtrCode Varchar(50),
		RtrName Varchar(100),
		[GSTIN/UIN of Recipient]	 Varchar(50),
		[Invoice Number]	 Varchar(50),
		[Invoice date]	DateTime,
		[Invoice Value]	Numeric(32,2),
		[Place Of Supply]	Varchar(125),
		[Reverse Charge]	Varchar(10),
		[Invoice Type]	Varchar(50),
		[E-Commerce GSTIN]	Varchar(50),
		[Rate]	Numeric(10,2),	
		[Taxable Value]	Numeric(32,2),
		[Cess Amount]	Numeric(32,2),
		[IGST rate]					NUMERIC(32,2),
		[IGST amount]				NUMERIC(32,2),
		UsrId INT,
		[Group Name] Varchar(100),
		GroupType TINYINT
		)
		
			
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
 		
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		---Retailer Registered
		SELECT R.RtrId,ColumnValue
		INTO #RetailerUnRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='UnRegistered' 
		
		SELECT S.RtrId,S.RtrshipId,S.Salid,Salinvno,SalInvdate,Prdslno,OrgNetAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #Sales		
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
		INNER JOIN #RetailerUnRegister R ON R.RtrId=S.RtrId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		AND TaxCode IN('OutputIGST','IGST') and OrgNetAmount>250000 and TaxableAmount>0
		GROUP BY S.RtrId,S.Salid,Salinvno,SalInvdate,Prdslno,S.RtrshipId,OrgNetAmount
		
		SELECT S.SalId,S.Rtrid,SUM(PrdNetAmount)PrdNetAmount INTO #SalesNetValue FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SI (NOLOCK) ON S.Salid=SI.SalId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		GROUP BY S.SalId,S.Rtrid
		UPDATE S SET OrgNetAmount=PrdNetAmount FROM #Sales S INNER JOIN #SalesNetValue SI ON S.Salid=SI.Salid
			
		---CALCULATE TAX SPLIT 
		SELECT * INTO #SalesInvoiceProductTax FROM SalesInvoiceProductTax 
			WHERE SalId IN (SELECT DISTINCT salid FROM #Sales) 	
						
		SELECT TAXID,				
		CASE WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
			 WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
			 WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
			 WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
			 WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
			 WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
			 WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
			 WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
			 WHEN TaxCode IN ('OutputGSTCESS','CESS','InputGSTCESS','GSTCESS') Then 'OutputGSTCESS'
		END	 as TaxCode
		INTO #TaxConfiguration
		FROM  TaxConfiguration WHERE TaxCode 
		IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
		'InputCGST','InputSGST','InputIGST','InputUTGST','OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','CESS','InputGSTCESS','GSTCESS','OutputGSTCESS',
		'OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS','InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS')
		
		SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
		FROM
		(
		----SALES DATA
		SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
			FROM #Sales SI
			INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId AND ST.PrdSlNo=SI.Prdslno
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
		UNION ALL
		SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
			FROM #Sales SI
			INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId  AND ST.PrdSlNo=SI.Prdslno
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
		)A 


 			SELECT BTYPE,Salinvno,Prdslno,SUM([OutputIGSTPerc])[OutputIGSTPerc],SUM([OutputIGST_Amt])[OutputIGST_Amt],
			SUM([OutputIGSTCESSPerc])[OutputIGSTCESSPerc],SUM([OutputIGSTCESS_Amt])[OutputIGSTCESS_Amt],
			SUM([OutputGSTCESSPerc])[OutputGSTCESSPerc],SUM([OutputGSTCESS_Amt])[OutputGSTCESS_Amt]
			INTO #TAXDETAILS
			FROM(
			SELECT BTYPE,Salinvno,Prdslno,
			ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],
			ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],
			ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],ISNULL([OutputGSTCESS_Amt],0)[OutputGSTCESS_Amt]
			FROM (
			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt
			FROM #TAXPIVOT)UP  
			PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputIGST_Amt],[OutputIGSTPerc],[OutputIGSTCESS_Amt],[OutputIGSTCESSPerc],	[OutputGSTCESS_Amt],[OutputGSTCESSPerc]))  AS PVT 
			)A
			GROUP BY BTYPE,Salinvno,Prdslno 			
				
		
		INSERT INTO #RptGSTR1_B2CL(TransId,TranType,Refid ,RtrShipId,RtrId,RtrCode,RtrName,
		[GSTIN/UIN of Recipient],[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],
		[Reverse Charge],[Invoice Type]	,[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],[IGST rate],[IGST amount],
		UsrId,[Group Name],GroupType)
		SELECT 1,'Sales',S.Salid,S.RtrShipId,R.RtrId,RtrCode,RtrName,'' as GSTTin,S.Salinvno,Salinvdate, OrgNetAmount as SalesValue,'' as PlaceOfSupply,
		'N' as ReverseCharge,'Regular' as InvoiceType,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount,
		SUM([OutputIGSTCESS_Amt]+[OutputGSTCESS_Amt]) as CessAmount,[OutputIGSTPerc],sum([OutputIGST_Amt]) as [OutputIGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #Sales S INNER JOIN Retailer R (NOLOCK) ON R.RtrId=S.RtrId
		INNER JOIN #TAXDETAILS T ON T.Salinvno=S.salinvno and T.prdslno=S.Prdslno
		WHERE OrgNetAmount>250000
		GROUP BY 
		S.Salid,R.RtrId,RtrCode,RtrName,S.SalInvNo,Salinvdate,Taxperc,S.RtrShipId,OrgNetAmount,[OutputIGSTPerc]
		
		
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #RetailerState A INNER JOIN #RptGSTR1_B2CL B ON A.Rtrid=B.RtrId
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=GSTTinNo FROM #RptGSTR1_B2CL R INNER JOIN RetailerShipAdd RS ON RS.RtrShipId=R.RtrShipId
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2CL R INNER JOIN #RetailerGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[GSTIN/UIN of Recipient],''))=0
				
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR1_B2CL)
		BEGIN
			SELECT * FROM RptGSTR1_B2CL (NOLOCK) WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR1_B2CL([Invoice Number],[Invoice date],[Recipient Code in application],
		[Recipient Name],[Invoice Value],[Place Of Supply],[Rate],[Taxable Value],[Cess Amount],[E-Commerce GSTIN],
		UsrId,[Group Name],GroupType)		
		SELECT [Invoice Number],REPLACE(REPLACE(CONVERT(VARCHAR,[Invoice date],106), ' ','-'), ',',''),RtrCode,RtrName,
		[Invoice Value],[Place Of Supply],
		[Rate],[Taxable Value],[Cess Amount],[E-Commerce GSTIN],
		UsrId,[Group Name],GroupType
		FROM #RptGSTR1_B2CL ORDER BY TransId,[Invoice date],[Invoice Number]
		
		INSERT INTO RptGSTR1_B2CL([Invoice Number],[Invoice date],[Recipient Code in application],
			[Recipient Name],[Invoice Value],[Place Of Supply],
			[Rate],[Taxable Value],[Cess Amount],[E-Commerce GSTIN],UsrId,[Group Name],GroupType)
		SELECT'' as [Invoice Number],'' as [Invoice date],'' as [Recipient Code in application],
		'' as [Recipient Name],SUM([Invoice Value]),'' as [Place Of Supply],
		0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),'' as [E-Commerce GSTIN],
		@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR1_B2CL
		
		
		SELECT DISTINCT TransId,[Invoice Number],[Invoice Value]
		INTO #GrandTotal
		FROM #RptGSTR1_B2CL
		
		
		--UPDATE RptGSTR1_B2B SET [Invoice Value]=(SELECT SUM([Invoice Value]) FROM #GrandTotal) WHERE GroupType=3
		
		
		SELECT * FROM RptGSTR1_B2CL (NOLOCK) WHERE UsrId=@Pi_UsrId
				
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptGSTRTRANS1_CDNR' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTRTRANS1_CDNR
GO
--EXEC Proc_RptGSTRTRANS1_CDNR 417,2,0,'',0,0,0 
--SELECT * FROM reportfilterdt where rptid=417
CREATE PROCEDURE Proc_RptGSTRTRANS1_CDNR
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTRTRANS1_CDNR
* PURPOSE    : To Generate GSTRTRANS1_CDNR Report
* CREATED BY : Karthick
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION
 08-10-2018  MOHANA S	             CR			ILCRSTBOT0006   	Included CESS Tax
********************************************************************************************************************************************************/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		SELECT C.RtrId,RtrCode,RtrName,GSTIN,R.StateTinFirst2Digit+'-'+StateName AS StateName,CrNoteNumber,CrNoteDate,PostedFrom AS ReturnCode,C.Amount 
		INTO #CREDITNOTEDETAILS
		FROM Creditnoteretailer C (NOLOCK) INNER JOIN (SELECT * FROM FN_ReturnRetailerUDCDetails()) R ON R.Rtrid=C.Rtrid
		WHERE TransId=30 AND MONTH(CrNoteDate)=@MonthStart AND YEAR(CrNoteDate)=@Jcmyear AND R.RetailerType =1


		SELECT ReturnID,PrdSlno,TaxPerc INTO #RETURNTAXDETAILS
		FROM
		(
		SELECT RH.ReturnID,PrdSlno,SUM(RPT.TaxPerc)TaxPerc 
		FROM ReturnHeader RH (NOLOCK) INNER JOIN ReturnProduct RP (NOLOCK) ON RH.ReturnID=RP.ReturnID
		INNER JOIN ReturnProductTax RPT (NOLOCK) ON RPT.ReturnId=RP.ReturnID AND RPT.PrdSlno=RP.Slno
		INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=RPT.TaxId 
		INNER JOIN #CREDITNOTEDETAILS C ON C.ReturnCode=RH.ReturnCode
		WHERE TaxCode IN('OutputCGST','OutputSGST','CGST','SGST') and VatGst='GST' 
			AND MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear AND TaxableAmt>0
			AND InvoiceType=1
		GROUP BY RH.ReturnID,PrdSlno
		UNION ALL
		SELECT RH.ReturnID,PrdSlno,SUM(RPT.TaxPerc)TaxPerc 
		FROM ReturnHeader RH (NOLOCK) INNER JOIN ReturnProduct RP (NOLOCK) ON RH.ReturnID=RP.ReturnID
		INNER JOIN ReturnProductTax RPT (NOLOCK) ON RPT.ReturnId=RP.ReturnID AND RPT.PrdSlno=RP.Slno
		INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=RPT.TaxId 
		INNER JOIN #CREDITNOTEDETAILS C ON C.ReturnCode=RH.ReturnCode
		WHERE TaxCode IN('OutputIGST','IGST') and VatGst='GST' 
			AND MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear AND TaxableAmt>0
			AND InvoiceType=1
		GROUP BY RH.ReturnID,PrdSlno
		)A  
		SELECT SalInvNo,Salinvdate,RH.ReturnID,rh.ReturnCode  INTO #INVOICEDETAILS
		FROM SalesInvoice SI(NOLOCK) INNER JOIN ReturnHeader RH (NOLOCK) ON RH.SalId=SI.Salid
		INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode
		WHERE RH.VatGst='GST' AND MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear 
			AND Salinvdate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND InvoiceType=1 
		SELECT * INTO #ReturnProductTax FROM ReturnProductTax 
			WHERE ReturnID IN (SELECT DISTINCT ReturnID FROM #INVOICEDETAILS) 	
			
					
		SELECT TAXID,				
		CASE	WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
				WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
				WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
				WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
				WHEN TaxCode IN ('OutputGSTcess','cess','GSTCESS','InputGSTcess') Then 'OutputGSTcess'--ILCRSTBOT0006
		END	 as TaxCode
		INTO #TaxConfiguration
		FROM  TaxConfiguration WHERE TaxCode 
		IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
		'InputCGST','InputSGST','InputIGST','InputUTGST','OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS',
		'UTGSTCESS','InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','OutputGSTcess','cess','GSTCESS','InputGSTcess')
		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
		FROM
		(
		----RETURN DATA
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			WHERE TaxableAmt>0	
		UNION ALL
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmt AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId 
			WHERE TaxableAmt>0	
		UNION ALL
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'_Taxable' AS TaxCode,ST.TaxableAmt AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId 
			WHERE TaxableAmt>0	
		)A
		ORDER BY BTYPE 
		 
		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,([OutputCGSTPerc]),
		SUM([OutputCGST_Amt])[OutputCGST_Amt],SUM([OutputCGST_Taxable]) as [OutputCGST_Taxable],
		([OutputSGSTPerc]),SUM([OutputSGST_Amt])as [OutputSGST_Amt],SUM([OutputSGST_Taxable]) as [OutputSGST_Taxable],
		([OutputIGSTPerc]),SUM([OutputIGST_Amt])as [OutputIGST_Amt],SUM([OutputIGST_Taxable]) as [OutputIGST_Taxable],
		([OutputUTGSTPerc]),SUM([OutputUTGST_Amt]) as [OutputUTGST_Amt],SUM([OutputUTGST_Taxable]) as [OutputUTGST_Taxable],
		([OutputCGSTCESSPerc]),	SUM([OutputCGSTCESS_Amt])[OutputCGSTCESS_Amt],SUM([OutputCGSTCESS_Taxable]) as [OutputCGSTCESS_Taxable],
		([OutputSGSTCESSPerc]),SUM([OutputSGSTCESS_Amt])as [OutputSGSTCESS_Amt],SUM([OutputSGSTCESS_Taxable]) as [OutputSGSTCESS_Taxable],
		([OutputIGSTCESSPerc]),SUM([OutputIGSTCESS_Amt])as [OutputIGSTCESS_Amt],SUM([OutputIGSTCESS_Taxable]) as [OutputIGSTCESS_Taxable],
		([OutputUTGSTCESSPerc]),SUM([OutputUTGSTCESS_Amt]) as [OutputUTGSTCESS_Amt],SUM([OutputUTGSTCESS_Taxable]) as [OutputUTGSTCESS_Taxable],
		([OutputGSTCESSPerc]),SUM([OutputGSTCESS_Amt]) as [OutputGSTCESS_Amt],SUM([OutputGSTCESS_Taxable]) as [OutputGSTCESS_Taxable]  
		 INTO #TAXDETAILS
		FROM(
		SELECT  BTYPE,ReturnID,ReturnCode,Prdslno,
		ISNULL([OutputCGSTPerc],0)[OutputCGSTPerc],ISNULL([OutputCGST_Amt],0)[OutputCGST_Amt],ISNULL([OutputCGST_Taxable],0)[OutputCGST_Taxable],
		ISNULL([OutputSGSTPerc],0)[OutputSGSTPerc],ISNULL([OutputSGST_Amt],0)[OutputSGST_Amt],ISNULL([OutputSGST_Taxable],0)[OutputSGST_Taxable],
		ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],ISNULL([OutputIGST_Taxable],0)[OutputIGST_Taxable],
		ISNULL([OutputUTGSTPerc],0)[OutputUTGSTPerc],ISNULL([OutputUTGST_Amt],0)[OutputUTGST_Amt],ISNULL([OutputUTGST_Taxable],0)[OutputUTGST_Taxable],
		ISNULL([OutputCGSTCESSPerc],0)[OutputCGSTCESSPerc],ISNULL([OutputCGSTCESS_Amt],0)[OutputCGSTCESS_Amt],ISNULL([OutputCGSTCESS_Taxable],0)[OutputCGSTCESS_Taxable],
		ISNULL([OutputSGSTCESSPerc],0)[OutputSGSTCESSPerc],ISNULL([OutputSGSTCESS_Amt],0)[OutputSGSTCESS_Amt],ISNULL([OutputSGSTCESS_Taxable],0)[OutputSGSTCESS_Taxable],
		ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],ISNULL([OutputIGSTCESS_Taxable],0)[OutputIGSTCESS_Taxable],
		ISNULL([OutputUTGSTCESSPerc],0)[OutputUTGSTCESSPerc],ISNULL([OutputUTGSTCESS_Amt],0)[OutputUTGSTCESS_Amt],ISNULL([OutputUTGSTCESS_Taxable],0)[OutputUTGSTCESS_Taxable],
			ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],ISNULL([OutputGSTCESS_Amt],0) as [OutputGSTCESS_Amt],ISNULL([OutputGSTCESS_Taxable],0) as [OutputGSTCESS_Taxable] 
		FROM (
		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,TaxCode,TaxPercAmt
		FROM #TAXPIVOT) up
		PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputCGST_Taxable],[OutputCGST_Amt],[OutputCGSTPerc],
												[OutputSGST_Taxable],[OutputSGST_Amt],[OutputSGSTPerc],
												[OutputIGST_Taxable],[OutputIGST_Amt],[OutputIGSTPerc],
												[OutputUTGST_Taxable],[OutputUTGST_Amt],[OutputUTGSTPerc],
												[OutputCGSTCESS_Taxable],[OutputCGSTCESS_Amt],[OutputCGSTCESSPerc],
												[OutputSGSTCESS_Taxable],[OutputSGSTCESS_Amt],[OutputSGSTCESSPerc],
												[OutputIGSTCESS_Taxable],[OutputIGSTCESS_Amt],[OutputIGSTCESSPerc],
											        [OutputUTGSTCESS_Taxable],[OutputUTGSTCESS_Amt],[OutputUTGSTCESSPerc],
												[OutputGSTCESS_Taxable],[OutputGSTCESS_Amt],[OutputGSTCESSPerc]))  AS PVT 
		)A
		GROUP BY BTYPE,ReturnID,ReturnCode,Prdslno,[OutputCGSTPerc],[OutputSGSTPerc],[OutputIGSTPerc],[OutputUTGSTPerc],[OutputGSTCESSPerc],
		[OutputCGSTCESSPerc],[OutputSGSTCESSPerc],[OutputIGSTCESSPerc],[OutputUTGSTCESSPerc]	
		
				
 		TRUNCATE TABLE RptGSTRTRANS1_CDNR
		INSERT INTO RptGSTRTRANS1_CDNR([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],
						[Invoice/Advance Receipt Number],[Invoice/Advance Receipt date],
						[Note/Refund Voucher Number],[Note/Refund Voucher date],[Document Type],[Reason For Issuing document],
						[Place Of Supply],[Note/Refund Voucher Value],[Rate],[Taxable Value],[Cess Amount],[Pre GST],
						[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],
						[UsrId],[Group Name],[GroupType])
		SELECT C.GSTIN,Rtrcode,Rtrname,SalInvNo,CONVERT(VARCHAR(10),DAY(Salinvdate))+'-'+LEFT(DATENAME(month,Salinvdate),3)+'-'+RIGHT(CONVERT(VARCHAR(10),YEAR(Salinvdate),121),2) AS Salinvdate,
		CrNoteNumber,CONVERT(VARCHAR(10),DAY(CrNoteDate))+'-'+LEFT(DATENAME(month,CrNoteDate),3)+'-'+RIGHT(CONVERT(VARCHAR(10),YEAR(CrNoteDate),121),2) AS CrNoteDate,
		'C' AS DocumentType,'Sales Return' AS Reason,StateName,Amount,TaxPerc,SUM([OutputCGST_Taxable]+[OutputIGST_Taxable]) AS PrdNetAmt, 
		SUM([OutputCGSTCESS_Amt]+[OutputSGSTCESS_Amt]+[OutputIGSTCESS_Amt]+[OutputUTGSTCESS_Amt]+OutputGSTCESS_Amt)AS Cess,'N' AS PreGst,
		[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
		([OutputSGSTPerc]+[OutputUTGSTPerc])as [OutputSGSTPerc],SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM ReturnHeader RH (NOLOCK) INNER JOIN ReturnProduct RP (NOLOCK) ON RH.ReturnID=RP.ReturnID
		INNER JOIN #RETURNTAXDETAILS RT ON RT.ReturnID=RH.ReturnID AND RT.PrdSlno=RP.Slno
		INNER JOIN #CREDITNOTEDETAILS C ON C.ReturnCode=RH.ReturnCode
		INNER JOIN #INVOICEDETAILS I ON I.ReturnID=RH.ReturnID AND I.ReturnID=RT.ReturnID
		INNER JOIN #TAXDETAILS T ON T.ReturnID=RH.ReturnID AND T.ReturnID=RH.ReturnID AND T.prdslno=RT.prdslno AND T.PrdSlno=RP.Slno
		WHERE MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear AND VatGst='GST' 
		AND ReturnDate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND InvoiceType=1
		GROUP BY C.GSTIN,SalInvNo,Salinvdate,CrNoteNumber,CrNoteDate,StateName,Amount,Prdid,TaxPerc,Rtrcode,Rtrname,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		INSERT INTO RptGSTRTRANS1_CDNR([GSTIN/UIN of Recipient],[Recipient Code in application],[Recipient Name],
						[Invoice/Advance Receipt Number],[Invoice/Advance Receipt date],
						[Note/Refund Voucher Number],[Note/Refund Voucher date],[Document Type],[Reason For Issuing document],
						[Place Of Supply],[Note/Refund Voucher Value],[Rate],[Taxable Value],[Cess Amount],[Pre GST],
						[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],
						[UsrId],[Group Name],[GroupType])
		
		SELECT SUM([GSTIN/UIN of Recipient]) as [GSTIN/UIN of Recipient],''[Recipient Code in application],''[Recipient Name],SUM([Invoice/Advance Receipt Number]) as [Invoice/Advance Receipt Number],
		'' as[Invoice/Advance Receipt date],SUM([Note/Refund Voucher Number]) as [Note/Refund Voucher Number],'' as [Note/Refund Voucher date],'' as [Document Type],'' as [Reason For Issuing document],
				'' as [Place Of Supply],SUM([Note/Refund Voucher Value]) as [Note/Refund Voucher Value],0 [Rate],sum([Taxable Value]) as [Taxable Value],
				sum([Cess Amount]) as [Cess Amount] ,'' as [Pre GST],
				0 as [IGST rate],sum([IGST amount]),0 as [CGST rate],sum([CGST amount]),0 as [SGST/UTGST rate],sum([SGST/UTGST amount]),
				@Pi_UsrId AS [UsrId],'ZZZZZZ' AS [Group Name],3 AS [GroupType]
		FROM(			
		SELECT	COUNT(DISTINCT([GSTIN/UIN of Recipient])) AS [GSTIN/UIN of Recipient],COUNT(DISTINCT([Invoice/Advance Receipt Number])) as [Invoice/Advance Receipt Number],
		'' as[Invoice/Advance Receipt date],COUNT(DISTINCT([Note/Refund Voucher Number])) as [Note/Refund Voucher Number],'' as [Note/Refund Voucher date],
		'' as [Document Type],'' as [Reason For Issuing document],
				'' as [Place Of Supply],[Note/Refund Voucher Value],0 [Rate],sum([Taxable Value]) as [Taxable Value],
				sum([Cess Amount]) as [Cess Amount] ,'' as [Pre GST],
				sum([IGST amount]) as [IGST amount],SUM([CGST amount]) as [CGST amount],sum([SGST/UTGST amount]) as [SGST/UTGST amount],
				@Pi_UsrId AS [UsrId],'ZZZZZZ' AS [Group Name],3 AS [GroupType]
		FROM RptGSTRTRANS1_CDNR GROUP BY [Note/Refund Voucher Value])A
		
		DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptGSTRTRANS1_CDNR
		WHERE UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTRTRANS1_CDNR WHERE UsrId=@Pi_UsrId 
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptGSTRTRANS1_CDNUR' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTRTRANS1_CDNUR
GO
--EXEC Proc_RptGSTRTRANS1_CDNUR 418,2,0,'',0,0,0 
--SELECT * FROM reportfilterdt where rptid=418
CREATE PROCEDURE Proc_RptGSTRTRANS1_CDNUR
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTRTRANS1_CDNUR
* PURPOSE    : To Generate GSTRTRANS1_CDNUR Report
* CREATED BY : Karthick
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR      DESCRIPTION
 08-10-2018  MOHANA S	             CR			ILCRSTBOT0006   	Included CESS Tax
********************************************************************************************************************************************************/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		SELECT C.RtrId,GSTIN,R.StateTinFirst2Digit+'-'+StateName AS StateName,CrNoteNumber,CrNoteDate,PostedFrom AS ReturnCode,C.Amount 
		INTO #CREDITNOTEDETAILS
		FROM Creditnoteretailer C (NOLOCK) INNER JOIN (SELECT * FROM FN_ReturnRetailerUDCDetails()) R ON R.Rtrid=C.Rtrid
		WHERE TransId=30 AND MONTH(CrNoteDate)=@MonthStart AND YEAR(CrNoteDate)=@Jcmyear AND R.RetailerType =2
		SELECT ReturnID,PrdSlno,TaxPerc INTO #RETURNTAXDETAILS
		FROM
		(
		SELECT RH.ReturnID,PrdSlno,SUM(RPT.TaxPerc)TaxPerc 
		FROM ReturnHeader RH (NOLOCK) INNER JOIN ReturnProduct RP (NOLOCK) ON RH.ReturnID=RP.ReturnID
		INNER JOIN ReturnProductTax RPT (NOLOCK) ON RPT.ReturnId=RP.ReturnID AND RPT.PrdSlno=RP.Slno
		INNER JOIN TaxConfiguration T (NOLOCK)  ON T.TaxId=RPT.TaxId 
		INNER JOIN #CREDITNOTEDETAILS C ON C.ReturnCode=RH.ReturnCode
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST') and VatGst='GST' 
			AND MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear AND TaxableAmt>0 --and RtnNetAmt>250000 
			AND InvoiceType=1
		GROUP BY RH.ReturnID,PrdSlno
		)A  
		SELECT SalInvNo,Salinvdate,RH.ReturnID,rh.ReturnCode  INTO #INVOICEDETAILS
		FROM SalesInvoice SI(NOLOCK) INNER JOIN ReturnHeader RH (NOLOCK) ON RH.SalId=SI.Salid
		INNER JOIN #CREDITNOTEDETAILS  C ON C.ReturnCode=RH.ReturnCode
		WHERE RH.VatGst='GST' AND MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear 
			AND Salinvdate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND InvoiceType=1 
 		SELECT * INTO #ReturnProductTax FROM ReturnProductTax 
			WHERE ReturnID IN (SELECT DISTINCT ReturnID FROM #INVOICEDETAILS) 			
		
		
		SELECT TAXID,				
		CASE	WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
				WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
				WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
				WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
				WHEN TaxCode IN ('OutputGSTcess','GSTCESS','CESS','InputGSTcess') Then 'OutputGSTcess'--ILCRSTBOT0006
		END	 as TaxCode
		INTO #TaxConfiguration
		FROM  TaxConfiguration WHERE TaxCode 
		IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
		'InputCGST','InputSGST','InputIGST','InputUTGST',
		'OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','OutputGSTcess','GSTCESS','CESS','InputGSTcess')

		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
		FROM
		(
		----RETURN DATA
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			WHERE TaxableAmt>0	
		UNION ALL
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmt AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId 
			WHERE TaxableAmt>0	
		UNION ALL
		SELECT 1 AS BTYPE,SI.ReturnID,ReturnCode,Prdslno,TaxCode+'_Taxable' AS TaxCode,ST.TaxableAmt AS TaxPercAmt 
			FROM #INVOICEDETAILS SI
			INNER JOIN #ReturnProductTax ST ON ST.ReturnID=SI.ReturnID 
			INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId 
			WHERE TaxableAmt>0	
		)A
		ORDER BY BTYPE 
		 
		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,([OutputCGSTPerc]),
		SUM([OutputCGST_Amt])[OutputCGST_Amt],SUM([OutputCGST_Taxable]) as [OutputCGST_Taxable],
		([OutputSGSTPerc]),SUM([OutputSGST_Amt])as [OutputSGST_Amt],SUM([OutputSGST_Taxable]) as [OutputSGST_Taxable],
		([OutputIGSTPerc]),SUM([OutputIGST_Amt])as [OutputIGST_Amt],SUM([OutputIGST_Taxable]) as [OutputIGST_Taxable],
		([OutputUTGSTPerc]),SUM([OutputUTGST_Amt]) as [OutputUTGST_Amt],SUM([OutputUTGST_Taxable]) as [OutputUTGST_Taxable],
		([OutputCGSTCESSPerc]),	SUM([OutputCGSTCESS_Amt])[OutputCGSTCESS_Amt],SUM([OutputCGSTCESS_Taxable]) as [OutputCGSTCESS_Taxable],
		([OutputSGSTCESSPerc]),SUM([OutputSGSTCESS_Amt])as [OutputSGSTCESS_Amt],SUM([OutputSGSTCESS_Taxable]) as [OutputSGSTCESS_Taxable],
		([OutputIGSTCESSPerc]),SUM([OutputIGSTCESS_Amt])as [OutputIGSTCESS_Amt],SUM([OutputIGSTCESS_Taxable]) as [OutputIGSTCESS_Taxable],
		([OutputUTGSTCESSPerc]),SUM([OutputUTGSTCESS_Amt]) as [OutputUTGSTCESS_Amt],SUM([OutputUTGSTCESS_Taxable]) as [OutputUTGSTCESS_Taxable],
			([OutputGSTCESSPerc]),SUM([OutputGSTCESS_Amt]) as [OutputGSTCESS_Amt],SUM([OutputGSTCESS_Taxable]) as [OutputGSTCESS_Taxable] 
		  INTO #TAXDETAILS
		FROM(
		SELECT  BTYPE,ReturnID,ReturnCode,Prdslno,
		ISNULL([OutputCGSTPerc],0)[OutputCGSTPerc],ISNULL([OutputCGST_Amt],0)[OutputCGST_Amt],ISNULL([OutputCGST_Taxable],0)[OutputCGST_Taxable],
		ISNULL([OutputSGSTPerc],0)[OutputSGSTPerc],ISNULL([OutputSGST_Amt],0)[OutputSGST_Amt],ISNULL([OutputSGST_Taxable],0)[OutputSGST_Taxable],
		ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],ISNULL([OutputIGST_Taxable],0)[OutputIGST_Taxable],
		ISNULL([OutputUTGSTPerc],0)[OutputUTGSTPerc],ISNULL([OutputUTGST_Amt],0)[OutputUTGST_Amt],ISNULL([OutputUTGST_Taxable],0)[OutputUTGST_Taxable],
		ISNULL([OutputCGSTCESSPerc],0)[OutputCGSTCESSPerc],ISNULL([OutputCGSTCESS_Amt],0)[OutputCGSTCESS_Amt],ISNULL([OutputCGSTCESS_Taxable],0)[OutputCGSTCESS_Taxable],
		ISNULL([OutputSGSTCESSPerc],0)[OutputSGSTCESSPerc],ISNULL([OutputSGSTCESS_Amt],0)[OutputSGSTCESS_Amt],ISNULL([OutputSGSTCESS_Taxable],0)[OutputSGSTCESS_Taxable],
		ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],ISNULL([OutputIGSTCESS_Taxable],0)[OutputIGSTCESS_Taxable],
		ISNULL([OutputUTGSTCESSPerc],0)[OutputUTGSTCESSPerc],ISNULL([OutputUTGSTCESS_Amt],0)[OutputUTGSTCESS_Amt],ISNULL([OutputUTGSTCESS_Taxable],0)[OutputUTGSTCESS_Taxable],
		ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],ISNULL([OutputGSTCESS_Amt],0) as [OutputGSTCESS_Amt],ISNULL([OutputGSTCESS_Taxable],0) as [OutputGSTCESS_Taxable] 
		
		FROM (
		SELECT BTYPE,ReturnID,ReturnCode,Prdslno,TaxCode,TaxPercAmt
		FROM #TAXPIVOT) up
		PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputCGST_Taxable],[OutputCGST_Amt],[OutputCGSTPerc],
												[OutputSGST_Taxable],[OutputSGST_Amt],[OutputSGSTPerc],
												[OutputIGST_Taxable],[OutputIGST_Amt],[OutputIGSTPerc],
												[OutputUTGST_Taxable],[OutputUTGST_Amt],[OutputUTGSTPerc],
												[OutputCGSTCESS_Taxable],[OutputCGSTCESS_Amt],  [OutputCGSTCESSPerc],
												[OutputSGSTCESS_Taxable],[OutputSGSTCESS_Amt],  [OutputSGSTCESSPerc],
												[OutputIGSTCESS_Taxable],[OutputIGSTCESS_Amt],  [OutputIGSTCESSPerc],
												[OutputUTGSTCESS_Taxable],[OutputUTGSTCESS_Amt],[OutputUTGSTCESSPerc],
												[OutputGSTCESS_Taxable],[OutputGSTCESS_Amt],[OutputGSTCESSPerc]))  AS PVT 
		)A
		GROUP BY BTYPE,ReturnID,ReturnCode,Prdslno,[OutputCGSTPerc],[OutputSGSTPerc],[OutputIGSTPerc],[OutputUTGSTPerc]	,[OutputCGSTCESSPerc],[OutputSGSTCESSPerc],
		[OutputIGSTCESSPerc],[OutputUTGSTCESSPerc],[OutputGSTCESSPerc]

		 

		TRUNCATE TABLE RptGSTRTRANS1_CDNUR																				
		INSERT INTO RptGSTRTRANS1_CDNUR([UR Type],[Note/Refund Voucher Number],[Note/Refund Voucher date],[Document Type],
					[Invoice/Advance Receipt Number],[Invoice/Advance Receipt date],[Reason For Issuing document],
					[Place Of Supply],[Note/Refund Voucher Value],[Rate],[Taxable Value],[Cess Amount],[Pre GST],
					[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],
					[UsrId],[Group Name],[GroupType])
		SELECT 'B2CL',CrNoteNumber,CONVERT(VARCHAR(10),DAY(CrNoteDate))+'-'+LEFT(DATENAME(month,CrNoteDate),3)+'-'+RIGHT(CONVERT(VARCHAR(10),YEAR(CrNoteDate),121),2) AS CrNoteDate,
 		'C' AS DocumentType,SalInvNo,CONVERT(VARCHAR(10),DAY(Salinvdate))+'-'+LEFT(DATENAME(month,Salinvdate),3)+'-'+RIGHT(CONVERT(VARCHAR(10),YEAR(Salinvdate),121),2) AS Salinvdate,
 		'Sales Return' AS Reason,StateName,Amount,TaxPerc,SUM([OutputCGST_Taxable]+[OutputIGST_Taxable]) AS PrdNetAmt,SUM([OutputSGSTCESS_Amt]+[OutputUTGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputIGSTCESS_Amt]+[OutputGSTCESS_Amt]) AS Cess,'N' AS PreGst,
 			[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			   ([OutputSGSTPerc]+[OutputUTGSTPerc])as [OutputSGSTPerc],SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM ReturnHeader RH (NOLOCK) INNER JOIN ReturnProduct RP (NOLOCK) ON RH.ReturnID=RP.ReturnID
		INNER JOIN #RETURNTAXDETAILS RT ON RT.ReturnID=RH.ReturnID AND RT.PrdSlno=RP.Slno
		INNER JOIN #CREDITNOTEDETAILS C ON C.ReturnCode=RH.ReturnCode
		INNER JOIN #INVOICEDETAILS I ON I.ReturnID=RH.ReturnID AND I.ReturnID=RT.ReturnID
		INNER JOIN #TAXDETAILS T ON T.ReturnID=RH.ReturnID AND T.ReturnID=RH.ReturnID AND T.prdslno=RT.prdslno AND T.PrdSlno=RP.Slno
		WHERE MONTH(ReturnDate)=@MonthStart AND YEAR(ReturnDate)=@Jcmyear AND VatGst='GST' 
		AND ReturnDate NOT BETWEEN '2017-01-01' AND '2017-06-30'  AND InvoiceType=1
		GROUP BY C.GSTIN,SalInvNo,Salinvdate,CrNoteNumber,CrNoteDate,StateName,Amount,Prdid,TaxPerc,[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc]
		
		IF NOT EXISTS(SELECT 'X' FROM RptGSTRTRANS1_CDNUR)
		BEGIN
			SELECT * FROM RptGSTRTRANS1_CDNUR WHERE UsrId=@Pi_UsrId 
			RETURN
		END
		INSERT INTO RptGSTRTRANS1_CDNUR([UR Type],[Note/Refund Voucher Number],[Note/Refund Voucher date],[Document Type],
					[Invoice/Advance Receipt Number],[Invoice/Advance Receipt date],[Reason For Issuing document],
					[Place Of Supply],[Note/Refund Voucher Value],[Rate],[Taxable Value],[Cess Amount],[Pre GST],
					[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],
					[UsrId],[Group Name],[GroupType])
		
		SELECT '',SUM([Note/Refund Voucher Number]) as [Note/Refund Voucher Number],'' as [Note/Refund Voucher date],'' as [Document Type],
			SUM([Invoice/Advance Receipt Number]) as [Invoice/Advance Receipt Number],'' as[Invoice/Advance Receipt date],
			'' as [Reason For Issuing document],'' as [Place Of Supply],SUM([Note/Refund Voucher Value]) as [Note/Refund Voucher Value],0 [Rate],sum([Taxable Value]) as [Taxable Value],
				sum([Cess Amount]) as [Cess Amount] ,'' as [Pre GST],
				0 as [IGST rate],sum([IGST amount]),0 as [CGST rate],sum([CGST amount]),0 as [SGST/UTGST rate],sum([SGST/UTGST amount]),
				@Pi_UsrId AS [UsrId],'ZZZZZZ' AS [Group Name],3 AS [GroupType]
		FROM(			
		SELECT COUNT(DISTINCT([Invoice/Advance Receipt Number])) as [Invoice/Advance Receipt Number],
		'' as[Invoice/Advance Receipt date],COUNT(DISTINCT([Note/Refund Voucher Number])) as [Note/Refund Voucher Number],'' as [Note/Refund Voucher date],
		'' as [Document Type],'' as [Reason For Issuing document],
				'' as [Place Of Supply],[Note/Refund Voucher Value],0 [Rate],sum([Taxable Value]) as [Taxable Value],
				sum([Cess Amount]) as [Cess Amount] ,'' as [Pre GST],
				sum([IGST amount]) as [IGST amount],SUM([CGST amount]) as [CGST amount],sum([SGST/UTGST amount]) as [SGST/UTGST amount],
				@Pi_UsrId AS [UsrId],'ZZZZZZ' AS [Group Name],3 AS [GroupType]
		FROM RptGSTRTRANS1_CDNUR GROUP BY [Note/Refund Voucher Value])A
		
		DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
		INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
		SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptGSTRTRANS1_CDNUR
		WHERE UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTRTRANS1_CDNUR WHERE UsrId=@Pi_UsrId 
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptGSTR1_HSNCODE' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTR1_HSNCODE
GO
/*
EXEC Proc_RptGSTR1_HSNCODE 419,1,1,'',0,1,1
 */
CREATE PROCEDURE Proc_RptGSTR1_HSNCODE
(
	
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptGSTR1_HSNCODE
* PURPOSE		: To Generate a report GSTR1 B2B
* CREATED		: Murugan.R
* CREATED DATE	: 13/04/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
**************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 13-12-2017   S.Moorthi   CR			CCRSTMTR0092		GSTR1 report - HSN summary option should consider sales return - Unregistered bills
 11-01-2018	  Mohana S	  BZ			ICRSTLOR2374		GSTR1 Report - Consider Only IDT OUT
*********************************/
SET NOCOUNT ON
BEGIN
		TRUNCATE TABLE RptGSTR1_HSNCODE
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		
		
		CREATE TABLE #RptGSTR1_HSNCODE
		(
			[HSN]	Varchar(20),
			[Description]	Varchar(200),
			[UQC]	Varchar(20),
			[Total Quantity]	BIGINT,
			[Total Value]	Numeric(32,4),
			[Taxable Value]	Numeric(32,4),
			[Integrated Tax Amount]	Numeric(32,4),
			[Central Tax Amount]	Numeric(32,4),
			[State/UT Tax Amount]	Numeric(32,4),
			[Cess Amount]	Numeric(32,4),
			UsrId INT,
			[Group Name] Varchar(100),
			GroupType TINYINT
		)
	
		SELECT DISTINCT Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
		SELECT DISTINCT Prdid,ColumnValue as HSNDesc
		INTO #ProductHsnDesc
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Description' 
		
		---Retailer Registered
		--SELECT R.RtrId,ColumnValue
		--INTO #RetailerUnRegister
		--FROM UDCHD U 
		--INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		--INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		--INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		--WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='UnRegistered' 
		
		Update A Set A.HSNdesc=B.HSNDesc FROM #ProductHsnCode A INNER JOIN #ProductHsnDesc B ON A.Prdid=B.Prdid
		
		SELECT PurRcptId 
		INTO #PurchaseReceipt
		FROM PurchaseReceipt WHERE VatGst='VAT' and GoodsRcvdDate Between '2017-01-01' and '2017-06-30'
		and Status=1
		
		--SELECT Salid INTO #Sales1  FROM Salesinvoice (NOLOCK)		
		--WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		
		
		SELECT Salid,Salinvno,SalInvdate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,SUM(CESSAMOUNT) CESSAMOUNT
		INTO #Sales 
		FROM
		(		
			SELECT S.Salid,Salinvno,SalInvdate,Prdslno,
			ISNULL(CASE WHEN TaxCode IN('OutputIGST','IGST','OutputCGST','CGST') THEN SUM(TaxableAmount) END,0) as TaxableAmount,
			ISNULL(CASE WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(TaxAmount) END ,0) AS IGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(TaxAmount) END ,0) AS CGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(TaxAmount) END ,0) AS SGSTUTTaxAmount,
			ISNULL(CASE WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS',
			'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','OutputGSTCESS','GSTCESS','CESS') THEN SUM(TaxAmount) END ,0) AS CESSAMOUNT
				
			FROM SalesInvoice S (NOLOCK) 
			INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST','OutputIGSTCESS',
			'IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS',
			'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','InputGSTCESS','OutputGSTCESS','GSTCESS','CESS')
			and ST.TaxableAmount>0
			GROUP BY S.Salid,Salinvno,SalInvdate,Prdslno,TaxCode
		)X GROUP BY Salid,Salinvno,SalInvdate,Prdslno
		
	
		
		SELECT  IDTMngRefNo,IDTMngDate,PrdSlNo,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,SUM(CessAmount) AS CessAmount
		INTO #IDTSales	
		FROM
		(		
			SELECT S.IDTMngRefNo,IDTMngDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST','OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(TaxableAmount) END,0) as TaxableAmount,
			ISNULL(CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST') THEN SUM(TaxAmount) END ,0) AS IGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(TaxAmount) END ,0) AS CGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST','IDTSGST','IDTUTGST') THEN SUM(TaxAmount) END ,0) AS SGSTUTTaxAmount,
			ISNULL(CASE WHEN TaxCode IN('OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','OutputIGSTCESS','IGSTCESS',
			'InPutIGSTCESS','IDTIGSTCESS','OutputCGSTCESS','CGSTCESS','InPutCGSTCESS','IDTCGSTCESS','UTGSTCESS','InPutSGSTCESS',
			'InPutUTGSTCESS','IDTSGSTCESS','IDTUTGSTCESS','InputGSTCESS','OutputGSTCESS','GSTCESS','CESS') THEN SUM(TaxAmount) END ,0) AS CESSAMOUNT
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear AND StkMgmtTypeId=2 --ICRSTLOR2374
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','IDTIGST','IDTCGST','IDTSGST','IDTUTGST','OutputSGSTCESS',
			'OutputUTGSTCESS','SGSTCESS','OutputIGSTCESS','IGSTCESS','InPutIGSTCESS','IDTIGSTCESS','OutputCGSTCESS','CGSTCESS',
			'InPutCGSTCESS','IDTCGSTCESS','UTGSTCESS','InPutSGSTCESS',
			'InPutUTGSTCESS','IDTSGSTCESS','IDTUTGSTCESS','InputGSTCESS','OutputGSTCESS','GSTCESS','CESS')
			and ST.TaxableAmount>0
			GROUP BY  S.IDTMngRefNo,IDTMngDate,PrdSlNo,TaxCode
		)X GROUP BY  IDTMngRefNo,IDTMngDate,PrdSlNo
		
		SELECT  PurRetId,PurRetRefNo,PurRetDate,PrdSlNo,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,SUM(CessAmount) AS CessAmount
		INTO #PurchaseSales	
		FROM
		(		
			SELECT S.PurRetId,S.PurRetRefNo,PurRetDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST','OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(ST.TaxableAmount) END,0) as TaxableAmount,
			ISNULL(CASE WHEN TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST') THEN SUM(ST.TaxAmount) END ,0) AS IGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(ST.TaxAmount) END ,0) AS CGSTTaxAmount ,
			ISNULL(CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InPutSGST','InPutUTGST','IDTSGST','IDTUTGST') THEN SUM(ST.TaxAmount) END ,0) AS SGSTUTTaxAmount,
			ISNULL(CASE WHEN TaxCode IN('SGSTCESS','IGSTCESS','InPutIGSTCESS','CGSTCESS','InPutCGSTCESS','IDTCGSTCESS','UTGSTCESS','InPutSGSTCESS',
			'InPutUTGSTCESS''InputGSTCESS','OutputGSTCESS','GSTCESS','CESS') THEN SUM(ST.TaxAmount) END ,0) AS CESSAMOUNT
				
			FROM PurchaseReturn S (NOLOCK) 
			INNER JOIN PurchaseReturnProductTax ST (NOLOCK) ON S.PurRetId=ST.PurRetId
			INNER JOIN #PurchaseReceipt PR ON PR.PurRcptId=S.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear 
			and TaxCode IN('IGST','CGST','SGST','UTGST','InPutIGST','InPutCGST','InPutSGST','InPutUTGST',
			'IGSTCESS','CGSTCESS','SGSTCESS','UTGSTCESS','InPutIGSTCESS','InPutCGSTCESS','InPutSGSTCESS','InPutUTGSTCESS','InputGSTCESS','OutputGSTCESS','GSTCESS','CESS')
			and ST.TaxableAmount>0
			GROUP BY  S.PurRetId,S.PurRetRefNo,PurRetDate,PrdSlNo,TaxCode
		)X GROUP BY  PurRetId,PurRetRefNo,PurRetDate,PrdSlNo
		--Added S.Moorthi CCRSTMTR0092
		CREATE TABLE #SalesReturn
		(
			ReturnId	INT,
			ReturnCode	VARCHAR(100),
			ReturnDate	DATETIME,
			Prdslno		BIGINT,
			TaxableAmount	NUMERIC(18,6),
			IGSTTaxAmount	NUMERIC(18,6),
			CGSTTaxAmount	NUMERIC(18,6),
			SGSTUTTaxAmount	NUMERIC(18,6),
			CESSAMOUNT	NUMERIC(18,6)
		)
		
		IF EXISTS(SELECT * FROM MANUALCONFIGURATION WHERE ModuleId='GSTR1HSNReturn' and ProjectName='GST' AND [Status]=1)
		BEGIN
		
			INSERT INTO #SalesReturn(ReturnId,ReturnCode,ReturnDate,Prdslno,TaxableAmount,IGSTTaxAmount,CGSTTaxAmount,SGSTUTTaxAmount,CESSAMOUNT)
			SELECT ReturnId,ReturnCode,ReturnDate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount	,SUM(CessAmount) AS CessAmount	
			FROM
			(		
				SELECT S.ReturnId,ReturnCode,ReturnDate,Prdslno,
				ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST') THEN SUM(TaxableAmt) END,0) as TaxableAmount,
				ISNULL(CASE WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(TaxAmt) END ,0) AS IGSTTaxAmount ,
				ISNULL(CASE WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(TaxAmt) END ,0) AS CGSTTaxAmount ,
				ISNULL(CASE WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(TaxAmt) END ,0) AS SGSTUTTaxAmount,
				ISNULL(CASE WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS',
				'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputGSTCESS','GSTCESS','CESS') THEN SUM(TaxAmt) END ,0) AS CESSAMOUNT	
				FROM ReturnHeader S (NOLOCK) 
				--INNER JOIN #RetailerUnRegister R (NOLOCK) ON R.RtrId=S.RtrId
				--INNER JOIN #Sales1 SS ON SS.SalId=S.SalId
				INNER JOIN SalesInvoice SS (NOLOCK) ON SS.SalId=S.SalId
				INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnId=ST.ReturnId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE S.[Status]=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear 
				and S.VatGST='GST'
				and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
				'OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS',
			'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS','OutputGSTCESS','GSTCESS','CESS')
				and ST.TaxableAmt>0
				GROUP BY S.ReturnId,ReturnCode,ReturnDate,Prdslno,TaxCode
			)X GROUP BY ReturnId,ReturnCode,ReturnDate,Prdslno
			
		END
		--Till Here CCRSTMTR0092
		INSERT INTO #RptGSTR1_HSNCODE([HSN],[Description],[UQC],[Total Quantity],[Total Value],[Taxable Value],[Integrated Tax Amount],
		[Central Tax Amount],[State/UT Tax Amount],[Cess Amount],UsrId,[Group Name],GroupType)
		SELECT HSNCode,HSNDesc,'NOS-Numbers' as [UQC],SUM(BaseQty) as BaseQty,SUM(SalesValue) as SalesValue,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
		SUM(CessAmount) as CessAmount,
		@Pi_UsrId,'' as [Group Type],2
		FROM
		(		
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(BaseQty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CessAmount) AS CessAmount
			FROM #Sales S INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.Salid and S.Prdslno=SIP.Slno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(Qty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CessAmount) AS CessAmount
			FROM #IDTSales S INNER JOIN IDTManagementProduct SIP (NOLOCK) ON S.IDTMngRefNo=SIP.IDTMngRefNo and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(RetSalBaseQty+RetUnSalBaseQty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CessAmount) AS CessAmount
			FROM #PurchaseSales S INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL --CCRSTMTR0092
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,-1*SUM(SIP.BaseQty) as BaseQty,-1*SUM(SIP.PrdNetAmt) as SalesValue,
			-1*SUM(TaxableAmount) as TaxableAmount,
			-1*SUM(IGSTTaxAmount) as IGSTTaxAmount,
			-1*SUM(CGSTTaxAmount) as CGSTTaxAmount,
			-1*SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			-1*SUM(CessAmount) AS CessAmount
			FROM #SalesReturn S INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnId=SIP.ReturnId and S.Prdslno=SIP.Slno --ICRSTNIV3125
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
		) X GROUP BY HSNCode,HSNDesc
		
			
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR1_HSNCODE)
		BEGIN
			SELECT * FROM RptGSTR1_HSNCODE (NOLOCK) WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR1_HSNCODE([HSN],[Description],[UQC],[Total Quantity],[Total Value],[Taxable Value],[Integrated Tax Amount],
		[Central Tax Amount],[State/UT Tax Amount],[Cess Amount],UsrId,[Group Name],GroupType)		
		SELECT [HSN],[Description],[UQC],[Total Quantity],[Total Value],[Taxable Value],[Integrated Tax Amount],
		[Central Tax Amount],[State/UT Tax Amount],[Cess Amount],UsrId,[Group Name],GroupType
		FROM #RptGSTR1_HSNCODE ORDER BY [HSN]
		
		INSERT INTO RptGSTR1_HSNCODE([HSN],[Description],[UQC],[Total Quantity],[Total Value],
		[Taxable Value],[Integrated Tax Amount],[Central Tax Amount],[State/UT Tax Amount],
		[Cess Amount],UsrId,[Group Name],GroupType)
		SELECT '' as [HSN],'' as [Description],'' as [UQC],SUM([Total Quantity]),SUM([Total Value]) as [Total Value],
		SUM([Taxable Value]),SUM([Integrated Tax Amount]),SUM([Central Tax Amount]),SUM([State/UT Tax Amount]),
		SUM([Cess Amount]),
		@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR1_HSNCODE
		
		
		SELECT * FROM RptGSTR1_HSNCODE WHERE UsrId=@Pi_UsrId
				
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR2_B2B' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTR2_B2B
GO
--EXEC Proc_RptGSTR2_B2B 425,2,0,'',0,0,1
CREATE PROCEDURE Proc_RptGSTR2_B2B
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_B2B
* PURPOSE    : To Generate GSTR2 B2B Report
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
05/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-B2B
11-01-2018	  MOHANA	  BZ			ICRSTLOR2374		GSTR1 Report - REFRESH ISSUE FIX
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_B2B
		--ICRSTLOR2374
		DELETE FROM  ReportFilterDt WHERE RptId IN(425,426,427,428,429,430) 
		INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)
		SELECT 425,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 426,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 427,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 428,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		UNION ALL
		SELECT 429,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId	
		UNION ALL
		SELECT 430,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
		FROM ReportFilterDt WHERE RptId=431 AND UsrId=@Pi_UsrId
		--ICRSTLOR2374
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=8
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
	
	
		CREATE TABLE #RptGSTR2_B2B
		(
		TRANSID	TINYINT	,
		SpmId	INT,
		[Your GSTIN]	Varchar(50),
		[Return Period]	Varchar(20),
		[GSTIN of Supplier]	Varchar(50),
		[Refid] BIGINT,		
		[Invoice Num]	Varchar(50),
		[Invoice Date]	DateTime,
		[Invoice Value]	Numeric(32,6),
		[Place of supply]	Varchar(50),
		[Invoice type]	Varchar(10),
		[Serial no]	INT,
		[Tax Rate]	Numeric(10,2),
		[Taxable value]	Numeric(32,6),
		[IGST]	Numeric(32,6),
		[CGST]	Numeric(32,6),
		[SGST]	Numeric(32,6),
		[CESS]	Numeric(32,6),
		[ITC IGST Amt]	Numeric(32,6),
		[ITC CGST Amt]	Numeric(32,6),
		[ITC SGST Amt]	Numeric(32,6),
		[ITC Cess Amt]	Numeric(32,6),
		[Eligibility]	Varchar(10),
		[Reverse Charge]	Varchar(10)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		--Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		----IDT GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		--Retailer GSTIN
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		--Retailer Registered
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerRegistered
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and UT.ColumnValue='Registered'
		
		--Retailer State
		SELECT DISTINCT  Rtrid as Rtrid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name' 
		
		--Supplier State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name' 
		
		----IDT State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #IDTState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name' 
	
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
	
		SELECT SpmId,X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Pruchase
		FROM(
				SELECT SpmId,S.PurRcptId,CmpInvNo,InvDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputGSTCess','CESS','GSTCESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess')
				 THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM PurchaseReceipt S (NOLOCK) 
				INNER JOIN PurchaseReceiptProductTax ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
				and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess',
				'InputGSTCess','CESS','GSTCESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.PurRcptId,CmpInvNo,InvDate,Prdslno,ST.TaxableAmount,TaxCode,SpmId
			)	X 
			GROUP BY X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,TaxableAmount,SpmId
			ORDER BY X.Prdslno
			
			
			SELECT S.PurRcptId,SUM(PrdNetAmount) as PrdNetAmount
			INTO #PurchaseReceiptProduct
			FROM PurchaseReceipt S (NOLOCK) 
			INNER JOIN PurchaseReceiptProduct ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
			WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
			GROUP BY S.PurRcptId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #Pruchase A INNER JOIN #PurchaseReceiptProduct B
			ON A.PurRcptId=B.PurRcptId
			
			
			---Sales Return
		
			SELECT RtrId,X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #SalesReturn
			FROM(
				SELECT R.Rtrid,S.ReturnID,ReturnCode,ReturnDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmt) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputGSTCESS','GSTCESS','CESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS')
				 THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.RtrId
				INNER JOIN #Sales C ON C.SalId=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
				and TaxCode IN ('InputGSTCESS','OutputGSTCESS','GSTCESS','CESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputGSTCess','OutputGSTCess','CESS','GSTCESS','InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS'
				,'CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS')
				and ST.TaxableAmt>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode,R.Rtrid
			)	X 
			GROUP BY X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,RtrId
			ORDER BY X.Prdslno	
			
			
			SELECT S.ReturnID,SUM(PrdNetAmt) as PrdNetAmount
			INTO #SalesReturnProduct
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProduct ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.ReturnID
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #SalesReturn A INNER JOIN #SalesReturnProduct B
			ON A.ReturnID=B.ReturnID
			
			-----IDT IN
			
			SELECT FromSpmId,IDTMngRefNo,IDTMngDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #IDTIN
			FROM(
				SELECT FromSpmId,S.IDTMngRefNo,IDTMngDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM IDTManagement S (NOLOCK) 
				INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
				and StkMgmtTypeId=1
				and TaxCode IN ('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.IDTMngRefNo,IDTMngDate,Prdslno,TaxCode,FromSpmId
			)	X 
			GROUP BY IDTMngRefNo,IDTMngDate,X.Prdslno,FromSpmId
			ORDER BY X.Prdslno	
						
			SELECT S.IDTMngRefNo,SUM(PrdNetAmount) as PrdNetAmount
			INTO #IDTProduct
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProduct ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.IDTMngRefNo
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #IDTIN A INNER JOIN #IDTProduct B
			ON A.IDTMngRefNo=B.IDTMngRefNo
			
			---Service Invoice
			SELECT ServiceFromId,X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #ServiceRetailer
			FROM(
				SELECT ServiceFromId,S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM ServiceInvoiceHd S (NOLOCK) 
				INNER JOIN ServiceInvoiceTaxDetails ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.ServiceFromId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
				and ServiceInvFor=1
				and TaxCode IN ('OutPutGSTCess','InputGSTCess','CESS','GSTCESS','OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				--and ReverseCharges=0
				GROUP BY S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,TaxCode,ServiceFromId
			)	X 
			GROUP BY X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,ServiceFromId
			ORDER BY X.RowNo
			
			SELECT S.ServiceInvId,SUM(TotServiceAmount) as PrdNetAmount
			INTO #ServiceLineAmt
			FROM ServiceInvoiceHd S (NOLOCK) 
			INNER JOIN ServiceInvoiceDT ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
			WHERE Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
			--and ReverseCharges=0
			GROUP BY S.ServiceInvId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #ServiceRetailer A INNER JOIN #ServiceLineAmt B
			ON A.ServiceInvId=B.ServiceInvId
						
			----Purchase

			 
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 1 AS TRANSID,SpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],X.PurRcptId,CmpInvNo,InvDate,
			PrdNetAmount as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by X.PurRcptId ORDER BY Taxperc,X.PurRcptId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(X.TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #Pruchase X 
			GROUP BY Taxperc,X.PurRcptId,CmpInvNo,InvDate,SpmId,PrdNetAmount
		---Sales Return
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 2 AS TRANSID,RtrId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ReturnID,ReturnCode,ReturnDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ReturnID ORDER BY Taxperc,ReturnID ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #SalesReturn
			GROUP BY Taxperc,ReturnID,ReturnCode,ReturnDate,RtrId,PrdNetAmount
		-----IDT IN	
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 3 AS TRANSID,FromSpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],0,IDTMngRefNo,IDTMngDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by IDTMngRefNo ORDER BY Taxperc,IDTMngRefNo ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #IDTIN
			GROUP BY Taxperc,IDTMngRefNo,IDTMngDate,FromSpmId,PrdNetAmount
			
		-----Service Invoice Retailer		
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 4 AS TRANSID,ServiceFromId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ServiceInvId,ServiceInvRefNo,ServiceInvDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ServiceInvId ORDER BY Taxperc,ServiceInvId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #ServiceRetailer
			GROUP BY Taxperc,ServiceInvRefNo,ServiceInvDate,ServiceFromId,ServiceInvId,PrdNetAmount	
			
			--GSTIN
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTSupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
			--Place Of Supply
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierState B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTState B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
		
		
		UPDATE #RptGSTR2_B2B SET [Invoice Value] = 0 WHERE CESS >0 AND [ITC Cess Amt]>0

		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_B2B)
		BEGIN
			INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],0 as [IGST],0 as [CGST],0 as [SGST],0 as [CESS],0 as [ITC IGST Amt],0 as [ITC CGST Amt],0 as [ITC SGST Amt],
			0 as [ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
			
			SELECT * FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			
			DELETE FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT 	[Your GSTIN],@ReturnPeriod as [Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
			FROM #RptGSTR2_B2B
		
		SELECT 
			SUM(IGST) as [IGST],
			SUM([CGST]) as [CGST],
			SUM([SGST]) as [SGST],
			SUM([CESS]) as [CESS],		
			SUM([ITC IGST Amt]) as [ITC IGST Amt],
			SUM([ITC CGST Amt]) as [ITC CGST Amt],
			SUM([ITC SGST Amt]) as [ITC SGST Amt],
			SUM([ITC Cess Amt]) as [ITC Cess Amt]
		INTO #TaxTotal	
		FROM #RptGSTR2_B2B	
		
		SELECT 3 as GroupType,SUM([Invoice Value]) as [Invoice Value]
		INTO #InvoiceGT
		FROM(
		SELECT DISTINCT TransId,[Refid],[Invoice Num],[Invoice Value]
		FROM #RptGSTR2_B2B
		)X
		
			
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #TaxTotal
		
		UPDATE A SET A.[Invoice Value]=B.[Invoice Value] FROM  RptGSTR2_B2B A 
		INNER JOIN #InvoiceGT B ON  A.GroupType=B.GroupType
		WHERE A.GroupType=3 and UsrId=@Pi_UsrId
		
		UPDATE RptGSTR2_B2B SET [Taxable value] =(SELECT SUM([Taxable value])
		FROM #RptGSTR2_B2B WHERE [CESS]=0) WHERE GroupType=3 and UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTR2_B2B (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR2_HSNSUM' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTR2_HSNSUM
GO
--EXEC Proc_RptGSTR2_HSNSUM 427,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptGSTR2_HSNSUM
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_HSNSUM
* PURPOSE    : To Generate GSTR2 HSN Summary
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
06/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-B2BUR
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_HSNSUM
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
	
	
		CREATE TABLE #RptGSTR2_HSNSUM
		(
		[SERIAL NUMBER]	INT IDENTITY(1,1),
		[HSN OR SAC CODE]	Varchar(50),
		[DESCRIPTION]	Varchar(150),
		[UQC]	Varchar(50),
		[TOTAL QUANTITY]	BIGINT,
		[TOTAL VALUE]	Numeric(32,6),
		[TAXABLE VALUE]	Numeric(32,6),
		[INTEGRATED TAX]	Numeric(32,6),
		[CENTRAL TAX]	Numeric(32,6),
		[STATE OR UT TAX]	Numeric(32,6),
		[CESS]	Numeric(32,6)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'

		SELECT Distinct Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
		SELECT Distinct Prdid,ColumnValue as HSNDesc
		INTO #ProductHsnDesc
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Description' 
		
		Update A Set A.HSNdesc=B.HSNDesc FROM #ProductHsnCode A INNER JOIN #ProductHsnDesc B ON A.Prdid=B.Prdid
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		
		
		SELECT PurRcptId,PurRcptRefNo,InvDate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Pruchase	
		FROM
		(		
			SELECT S.PurRcptId,PurRcptRefNo,InvDate,Prdslno,
			CASE  WHEN TaxCode IN('InputIGST','IGST','InputCGST','CGST') THEN SUM(ST.TaxableAmount) ELSE 0  END as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputGSTCess','GSTCESS','CESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
			FROM PurchaseReceipt S (NOLOCK) 
			INNER JOIN PurchaseReceiptProductTax ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
			and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess',
			'InputGSTCess','GSTCESS','CESS','InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess')
			and ST.TaxableAmount>0
			GROUP BY S.PurRcptId,PurRcptRefNo,InvDate,Prdslno,TaxCode
		)X GROUP BY PurRcptId,PurRcptRefNo,InvDate,Prdslno
		
		
		SELECT IDTMngRefNo,IDTMngDate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #IDT
		FROM
		(		
			SELECT S.IDTMngRefNo,IDTMngDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST','OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(TaxableAmount) END,0) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST','OutputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST','OutputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST','OutputSGST','OutputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputGSTCess','GSTCESS','CESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount	
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE  Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'OutputGSTCess','GSTCESS','CESS','InPutIGST','InPutCGST','InPutSGST','InPutUTGST','IDTIGST','IDTCGST','IDTSGST','IDTUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
			and ST.TaxableAmount>0 and StkMgmtTypeId=1
			GROUP BY S.IDTMngRefNo,IDTMngDate,Prdslno,TaxCode
		)X GROUP BY IDTMngRefNo,IDTMngDate,Prdslno
		
		
		SELECT ReturnID,ReturnCode,ReturnDate,PrdSlNo,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Return
		FROM
		(		
			SELECT S.ReturnID,ReturnCode,ReturnDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST') THEN SUM(TaxableAmt) END,0) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST','OutputIGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST','OutputCGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST','OutputSGST','OutputUTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputGSTCess','GSTCESS','CESS','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount	
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			INNER JOIN #Sales SS ON SS.SalId=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE  Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'InputGSTCess','GSTCESS','CESS','InPutIGST','InPutCGST','InPutSGST','InPutUTGST','IDTIGST','IDTCGST','IDTSGST','IDTUTGST','OutputIGSTCESS','IGSTCESS','OutputCGSTCESS',
			'OutputGSTCess','GSTCESS','CESS','CGSTCESS','OutputSGSTCESS','OutputUTGSTCESS','SGSTCESS','UTGSTCESS',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess')
			and ST.TaxableAmt>0 
			GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode
		)X GROUP BY ReturnID,ReturnCode,ReturnDate,Prdslno
		
		
		
	
	
		INSERT INTO #RptGSTR2_HSNSUM([HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS]	)
		SELECT HSNCode,HSNDesc,'NOS-Numbers' as [UQC],SUM(BaseQty) as BaseQty,SUM(SalesValue) as SalesValue,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CessAmount	
		FROM
		(		
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(RcvdGoodBaseQty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #Pruchase S INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(Qty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #IDT S INNER JOIN IDTManagementProduct SIP (NOLOCK) ON S.IDTMngRefNo=SIP.IDTMngRefNo and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(BaseQty) as BaseQty,SUM(PrdNetAmt) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #Return S INNER JOIN Returnproduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID and S.Prdslno=SIP.Slno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
		) X GROUP BY HSNCode,HSNDesc
				
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_HSNSUM)
		BEGIN
			SELECT * FROM RptGSTR2_HSNSUM WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_HSNSUM([Your GSTIN],[Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],UsrId,[Group Name],GroupType)	
		SELECT 	@DistGSTIN as [Your GSTIN],@ReturnPeriod as [Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		FROM #RptGSTR2_HSNSUM ORDER BY [SERIAL NUMBER]
		
		
			
		INSERT INTO RptGSTR2_HSNSUM([Your GSTIN],[Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],0 as [SERIAL NUMBER],'' as [HSN OR SAC CODE],
		'' as [DESCRIPTION],'' as [UQC],SUM([TOTAL QUANTITY]) as [TOTAL QUANTITY],SUM([TOTAL VALUE]),
		SUM([TAXABLE VALUE]),SUM([INTEGRATED TAX]),SUM([CENTRAL TAX]),SUM([STATE OR UT TAX]),SUM([CESS]),@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR2_HSNSUM
		
		
		SELECT * FROM RptGSTR2_HSNSUM (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptGSTR2_CDN' AND TYPE='P')
DROP PROCEDURE Proc_RptGSTR2_CDN
GO
--EXEC Proc_RptGSTR2_CDN 225,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptGSTR2_CDN
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_CDN
* PURPOSE    : To Generate GSTR2 CDN Details
* CREATED BY : Murugan.R
* CREATED ON : 06/09/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
06/09/2017	Murugan.R	CR		CCRSTAN0150			GSTR2 CDN
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT		
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		DECLARE @DistGSTIN AS VARCHAR(50)
		
		
		TRUNCATE TABLE RptGSTR2_CDN
		
		---Find Zero Tax Product

		DECLARE @ReturnPeriod Varchar(20)

		
	
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=9
		--SET @Jcmyear=2017

	--Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue as GSTIN
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'

		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
	
	IF LEN(@MonthStart)=1 
	BEGIN
		SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END
	ELSE
	BEGIN
		SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END 
	SELECT PurRcptId INTO #Purchase  FROM PurchaseReceipt (NOLOCK)		
	WHERE Status=1 and InvDate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		
		SELECT SpmId,PurRetRefNo,X.PurRetId,CmpInvNo,PurRetDate,X.Prdslno,Cast(0.000000 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #PruchaseReturn
		FROM(
				SELECT PR.SpmId,PurRetRefNo,S.PurRetId,PR.CmpInvNo,PurRetDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess','InputGSTCess','GSTCESS','CESS') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM PurchaseReturn S (NOLOCK) 
				INNER JOIN PurchaseReturnProductTax ST (NOLOCK) ON S.PurRetId=ST.PurRetId
				INNER JOIN PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=S.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE 
				S.Status=1 and 
				Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear 
				and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess',
				'InputCGSTCess','InputSGSTCess','InputIGSTCess','InputUTGSTCess','IGSTCESS','CGSTCESS','SGSTCESS','UTGSTcess','InputGSTCess','GSTCESS','CESS')
				and ST.TaxableAmount>0
				AND NOT EXISTS(SELECT A.PurRcptId FROM #Purchase A WHERE A.PurRcptId=PR.PurRcptId)
				GROUP BY S.PurRetId,PR.CmpInvNo,PurRetDate,Prdslno,ST.TaxableAmount,TaxCode,PR.SpmId,PurRetRefNo
			)	X 
			GROUP BY PurRetRefNo,X.PurRetId,CmpInvNo,PurRetDate,X.Prdslno,TaxableAmount,SpmId
			ORDER BY X.Prdslno
			
			
			SELECT S.PurRetId,SUM(PrdNetAmount) as PrdNetAmount
			INTO #PurchaseReturnProduct
			FROM PurchaseReturn S (NOLOCK) 
			INNER JOIN PurchaseReturnProduct ST (NOLOCK) ON S.PurRetId=ST.PurRetId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear and VatGST='GST'
			GROUP BY S.PurRetId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #PruchaseReturn A INNER JOIN #PurchaseReturnProduct B
			ON A.PurRetId=B.PurRetId
			
			IF NOT EXISTS(SELECT 'X' FROM #PruchaseReturn)
			BEGIN
				SELECT * FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			
			INSERT INTO RptGSTR2_CDN([Your GSTIN],[Return Period],[GSTIN],SpmID,RefId,RefNo,[INVOICE NUMBER],[INVOICE DATE],
			[NOTE TYPE],[NOTE NUMBER],[NOTE DATE],[NOTE VALUE],[REASON],[PRE GST REGIME],
			[SERIAL NUMBER],[RATE],[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],
			[CESS],[ELIGIBILITY],[INTEGRATED ITC AMOUNT],[CENTRAL ITC AMOUNT],
			[STATE OR UT ITC AMOUNT],[CESS ITC AMOUNT],TAXACT,InvCheck,UsrId,[Group Name],GroupType)			
			SELECT @DistGSTIN,@ReturnPeriod,'' as [GSTIN],SpmId,X.PurRetId,PurRetRefNo,CmpInvNo,PurRetDate,'D','' as [NOTE NUMBER],Null as [NOTE DATE],
			PrdNetAmount as [NOTE VALUE],'07-Others' as [REASON],'N' as [PRE GST REGIME],
			Row_Number() OVER(Partition by X.PurRetId ORDER BY Taxperc,X.PurRetId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(X.TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],
			'IP' as [Eligibility],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'' as TAXACT,'' as InvCheck,
			@Pi_UsrId,'' as [Group Name],2 as GroupType		
			FROM #PruchaseReturn X 
			GROUP BY Taxperc,X.PurRetId,CmpInvNo,PurRetDate,SpmId,PrdNetAmount ,PurRetRefNo
			
			UPDATE B SET B.[GSTIN]=A.[GSTIN] FROM #SupplierGSTIN A INNER JOIN RptGSTR2_CDN B ON A.SpmID=B.SpmID
			WHERE UsrId=@Pi_UsrId
			
			UPDATE B SET B.[NOTE NUMBER]=DbNoteNumber,[NOTE DATE]=DbNoteDate 
			FROM DebitNoteSupplier A INNER JOIN RptGSTR2_CDN B ON A.SpmID=B.SpmID and PostedFrom=RefNo
			WHERE UsrId=@Pi_UsrId
			
			SELECT SUM(PrdNetAmount) as Netvalue INTO #NetValue FROM			
			(
			SELECT DISTINCT PurRetId,PurRetRefNo,CmpInvNo,PurRetDate,PrdNetAmount
			FROM #PruchaseReturn
			)X
			
			INSERT INTO RptGSTR2_CDN([Your GSTIN],[Return Period],[GSTIN],SpmID,RefId,RefNo,[INVOICE NUMBER],[INVOICE DATE],
			[NOTE TYPE],[NOTE NUMBER],[NOTE DATE],[NOTE VALUE],[REASON],[PRE GST REGIME],
			[SERIAL NUMBER],[RATE],[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],
			[CESS],[ELIGIBILITY],[INTEGRATED ITC AMOUNT],[CENTRAL ITC AMOUNT],
			[STATE OR UT ITC AMOUNT],[CESS ITC AMOUNT],TAXACT,InvCheck,UsrId,[Group Name],GroupType)
			
			SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN],0 as SpmID,0 as RefId,'' as RefNo,
			'' as [INVOICE NUMBER],Null as [INVOICE DATE],
			'' as [NOTE TYPE],'' as [NOTE NUMBER],Null as [NOTE DATE],0 as [NOTE VALUE],'' as [REASON],''as [PRE GST REGIME],
			0 as [SERIAL NUMBER],0 as [RATE],SUM([TAXABLE VALUE]),SUM([INTEGRATED TAX]),SUM([CENTRAL TAX]),
			SUM([STATE OR UT TAX]),
			SUM([CESS]),'' as [ELIGIBILITY],SUM([INTEGRATED ITC AMOUNT]),SUM([CENTRAL ITC AMOUNT]),
			SUM([STATE OR UT ITC AMOUNT]),SUM([CESS ITC AMOUNT]),
			'' as TAXACT,'' as InvCheck,
			@Pi_UsrId as UsrId,'ZZZZZZ' as [Group Name],3 as GroupType
			FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId
			
			UPDATE RptGSTR2_CDN SET [NOTE VALUE]=(SELECT Netvalue FROM #NetValue) WHERE GroupType=3
			and  UsrId=@Pi_UsrId
			
			SELECT * FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_TaxSetting' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_TaxSetting
GO
/*
BEGIN TRANSACTION
EXEC Proc_CN2CS_TaxSetting 0
--SELECT * FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
--SELECT * FROM TaxSettingEffectiveDate
--SELECT * FROM ErrorLog
SELECT * FROM TaxSettingMaster
--SELECT * FROM TaxSettingDetail
--SElect * from Etl_Prk_TaxSetting
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_TaxSetting]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*************************************************************************************************************
* PROCEDURE	: Proc_CN2CS_TaxSetting
* PURPOSE	: To Store TaxGroup Setting records  from xml file in the Table TaxGroupSetting
* CREATED	: Mahalakshmi.A
* CREATED DATE	: 20/08/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------------------
* {date}		{developer}		{brief modification description}
* 07/09/2009    Nandakumar R.G  Change the validations for Tax on Tax and other basic validations
* 09.09.2009    Panneer			Update the Download Flag in Parking Table
* 19/08/2010    Nandakumar R.G  Discount Validation Changes
* 28/04/2011    Nandakumar R.G  Discount Validation Changes
* 25/04/2017    Murugan.R		GST Migration (Taxtype,EffectiveFrom,Status)
* 28-05-2019	MOHANA S		ILCRSTPAR4626   TO VALIDATE KERALA DISTRIBUTORS
**************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @TaxGroupCode	 AS NVARCHAR(200)
	DECLARE @Type			 AS NVARCHAR(200)
	DECLARE @PrdTaxGroupCode AS NVARCHAR(200)
	DECLARE @TaxCode		 AS NVARCHAR(200)
	DECLARE @Percentage	     AS NUMERIC(38,6)
	DECLARE @ApplyOn		 AS NVARCHAR(100)
	DECLARE @Discount		 AS NVARCHAR(100)
	DECLARE @Tabname		 AS NVARCHAR(100)
	DECLARE @ErrDesc		 AS NVARCHAR(1000)
	DECLARE @sSql			 AS NVARCHAR(4000)
	DECLARE @ErrStatus		 AS INT
	DECLARE @Taction		 AS INT
	DECLARE @TaxSeqId	 AS INT
	DECLARE @RtrId		 AS INT
	DECLARE @PrdId		 AS INT
	DECLARE @BillSeqId	 AS INT
	DECLARE @Slno		 AS INT
	DECLARE @ColNo		 AS INT
	DECLARE @iCntColNo	 AS INT
	DECLARE @iColType	 AS INT
	DECLARE @ColValue	 AS INT
	DECLARE @RowId		 AS INT
	DECLARE @TaxId		 AS INT
	DECLARE @iApplyOn	 AS INT
	DECLARE @iDiscount	 AS INT
	DECLARE @DColNo		 AS INT
	DECLARE @FieldDesc	 AS NVARCHAR(100)
	DECLARE @SColNo		 AS INT
	DECLARE @ColId		 AS INT
	DECLARE @SlNo1		 AS INT
	DECLARE @SlNo2		 AS INT
	DECLARE @BillSeqId_Temp	AS	INT
	DECLARE @EffetOnTax		AS	INT
	DECLARE @SchDiscount		 AS NVARCHAR(100)
	DECLARE @DBDiscount		 AS NVARCHAR(100)
	DECLARE @CDDiscount		 AS NVARCHAR(100)
	DECLARE @FreightCharge   AS NVARCHAR(100)
	DECLARE @TaxType	 AS NVARCHAR(20)
	DECLARE @EffectiveFrom			 AS DATETIME
	DECLARE @ActivationFlag			 AS TinyInt
	/*
		SET @iColType=1   For TaxPercentage Value Column
		SET @iColType=2	  For MRP,SellingRate,PurchaseRate , Bill Column Sequence Value and Purchase Column Sequence
		SET @iColType=3   For Tax Configuration TaxCode Column Value
		SET @ColValue=0	  For "NONE"
		SET @ColValue=1   For "ADD"
		SET @ColValue=2   For "REDUCE"		
	*/
	
	
	DECLARE @Prdid1 INT
	SELECT @Prdid1 = ISNULL(TaxGroupId,0)  FROM TaxGroupSetting WHERE   prdgroup='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0'
	UPDATE A SET EffectiveFrom ='2017-07-01'  FROM TaxSettingMaster A  WHERE PrdId = @Prdid


	Update A set EffectiveFrom ='2017-07-01' from Etl_Prk_TaxSetting A where PrdTaxGroupCode ='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0' 

	
	SET @Tabname = 'Etl_Prk_TaxSetting'
	SET @Po_ErrNo=0
	SET @iCntColNo=0
	DECLARE @TblColNo TABLE
	(
		ColNo			INT IDENTITY(0,1) NOT NULL,
		SlNo1			INT,
		SlNo2			INT,
		FieldDesc		NVARCHAR(50)
	)
	DECLARE @T1 TABLE
	(
		SlNo			INT,
		FieldDesc		NVARCHAR(50)
	)
	DELETE FROM Etl_Prk_TaxSetting WHERE DownLoadFlag='Y'
	SET @ActivationFlag=0
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate and ModuleId='GSTConfig')
	BEGIN
		SELECT @ActivationFlag=1
	END
	

		
	--ADDED BY MOHANA ILCRSTPAR4626
	DECLARE @GSTIN AS NVARCHAR(100)
	DECLARE @SCode AS NVARCHAR(100)
	DECLARE @DSName  AS NVARCHAR(100)

	SELECT @GSTIN = C.ColumnValue  FROM UdcHD A(NOLOCK) 
	INNER JOIN UdcMaster B(NOLOCK) ON A.Masterid = B.Masterid AND A.MasterName='Distributor Info Master' 
	INNER JOIN UdcDetails C(NOLOCK) ON A.Masterid = C.Masterid AND B.UdcMasterId = C.UdcMasterId AND B.ColumnName ='GSTIN'

	SELECT  @DSName = C.ColumnValue FROM UdcHD A(NOLOCK) 
	INNER JOIN UdcMaster B(NOLOCK) ON A.Masterid = B.Masterid AND A.MasterName='Distributor Info Master' 
	INNER JOIN UdcDetails C(NOLOCK) ON A.Masterid = C.Masterid AND B.UdcMasterId = C.UdcMasterId AND B.ColumnName ='STATE NAME'
 
	SELECT @SCode = STATECODE FROM StateMaster(NOLOCK) WHERE StateName  ='KERALA'
 
	IF (LEFT(ISNULL(@GSTIN,''),2)<>@Scode) AND (UPPER(ISNULL(@DSName,''))<>'KERALA')
	BEGIN

			INSERT INTO Etl_Prk_TaxSetting_CESS 
			SELECT * FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D' 

			DELETE FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D' AND TaxCode IN ('OutputCGSTCESS','CGSTCESS','OutputSGSTCESS',
			'SGSTCESS','OutputGSTCESS','GSTCESS','OutputIGSTCESS','IGSTCESS','OutputUTGSTCESS','UTGSTCESS',
			'InputCGSTCESS','InputSGSTCESS','InputGSTCESS','CESS', 'INputIGSTCESS','INputUTGSTCESS')

	END
	--TILL HERE ILCRSTPAR4626


	SELECT DISTINCT ISNULL(TaxGroupCode,'') as TaxGroupCode,ISNULL(Type,'') as Type,ISNULL(PrdTaxGroupCode,'') as PrdTaxGroupCode,
	ISNULL(TaxType,'VAT') as TaxType,
	MAX(ISNULL(EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))) as EffectiveFrom
	INTO #EtlTaxSettings
	FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
	GROUP BY ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),ISNULL(TaxType,'VAT')
	
	
	DELETE A FROM Etl_Prk_TaxSetting A (NOLOCK)	
	INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))<>ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	
	
	SELECT DISTINCT DistCode,A.TaxGroupCode,A.Type,A.PrdTaxGroupCode,A.TaxCode,
	Percentage,ApplyOn,Discount,SchDiscount,DBDiscount,CDDiscount,ApplyTax,
	DownloadFlag,CreatedDate,A.TaxType,A.EffectiveFrom,FreightCharge
	INTO #Etl_Prk_Tax
	FROM Etl_Prk_TaxSetting A (NOLOCK) INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))=ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	DECLARE Cur_TaxSettingMaster CURSOR		--TaxSettingMaster Cursor
	FOR SELECT DISTINCT ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),TaxType,EffectiveFrom
	FROM #EtlTaxSettings
	-- WHERE DownloadFlag='D'
	OPEN Cur_TaxSettingMaster
	FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	WHILE @@FETCH_STATUS=0
	BEGIN
		--Check the Empty Values for TaxSetting Master
		SET @iCntColNo=6
		IF @TaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Tax Group Code: ' + @TaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Group code',@ErrDesc)
		END
		IF @Type=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Type ' + @Type + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		IF @PrdTaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Product Tax Group Code ' + @PrdTaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		--Till Here
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE RtrGroup = @TaxGroupCode) --Get the Retailer/Supplier TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'TaxGroupCode ' + @TaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @RtrId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup= @TaxGroupCode
		END
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE PrdGroup = @PrdTaxGroupCode) --Get the Product TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'Product TaxGroupCode ' + @PrdTaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Product Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @PrdId=TaxGroupId FROM TaxGroupSetting WHERE PrdGroup= @PrdTaxGroupCode
		END
		
		DELETE FROM @T1
		IF UPPER(@Type)='RETAILER'
		BEGIN
			SELECT DISTINCT @BillSeqId=BillSeqId FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			SELECT @iCntColNo=@iCntColNo+COUNT(BillSeqId) FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc
			FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo <
			(SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) Order By SlNo
		END
		ELSE IF UPPER(@Type)='SUPPLIER'
		BEGIN
			SELECT DISTINCT @BillSeqId=PurSeqId FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			
			SELECT @iCntColNo=@iCntColNo+COUNT(PurSeqId) FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))
			and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster) Order By SlNo
		END
		SELECT @iCntColNo=@iCntColNo+(COUNT(TaxId)) FROM TaxConfiguration
		SELECT @TaxSeqId= dbo.Fn_GetPrimaryKeyInteger('TaxSettingMaster','TaxSeqId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
		IF  @Po_ErrNo=0
		BEGIN	
			INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxType,EffectiveFrom,Status)
			VALUES(@TaxSeqId,@RtrId,@PrdID,CONVERT(NVARCHAR(11),GETDATE(),121),1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121),@TaxType,@EffectiveFrom,
			CASE @TaxType WHEN  'VAT' THEN 1 
									  ELSE 
										  CASE @ActivationFlag 
										  WHEN 1 THEN 1							
										  ELSE 0 
										  END  
									  END)
			SET @sSql= 'INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@TaxSeqId AS NVARCHAR(100)) + ',' + CAST(@RtrId AS NVARCHAR(100)) +','+ CAST(@PrdId AS NVARCHAR(100))+ ','''
						+ CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,1,''' + CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,'''+ CONVERT(NVARCHAR(11),GETDATE(),121)+ ''')'
						
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE	Tabname = 'TaxSettingMaster' AND Fldname = 'TaxSeqId'
			
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSettingMaster'' AND Fldname = ''TaxSeqId'''
			
			INSERT INTO Translog(strSql1) Values (@sSQL)
		END
		
		DECLARE @TaxSettingTable TABLE
		(
			TaxId			INT,
			TaxGrpCode		NVARCHAR(200),
			Type			NVARCHAR(200),
			TaxPrdGrpCode	NVARCHAR(200),
			TaxCode			NVARCHAR(200),
			Percentage		NUMERIC(38,6),
			Applyon			NVARCHAR(200),
			Discount		NVARCHAR(200),
			SchDiscount		NVARCHAR(200),
			DBDiscount		NVARCHAR(200),
			CDDiscount		NVARCHAR(200),
			FreightCharge   NVARCHAR(200)
		)
		DELETE FROM @TaxSettingTable
		INSERT INTO @TaxSettingTable (TaxId,TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,
		SchDiscount,DBDiscount,CDDiscount,FreightCharge)
		SELECT DISTINCT TC.TaxId, ISNULL(ETL1.TaxGroupCode,''),ISNULL(ETL1.Type,''),
		ISNULL(ETL1.PrdTaxGroupCode,''),ISNULL(TC.TaxCode,''),ISNULL(ETL1.Percentage,0),
		ISNULL(ETL1.ApplyOn,'None'),ISNULL(ETL1.Discount,'None'),ISNULL(ETL1.SchDiscount,'None'),
		ISNULL(ETL1.DBDiscount,'None'),ISNULL(ETL1.CDDiscount,'None'),ISNULL(ETL1.FreightCharge,'None') 
		FROM
		(SELECT ISNULL(ETL.TaxGroupCode,'') AS TaxGroupCode,ISNULL(ETL.Type,'') AS Type,ISNULL(ETL.TaxCode,'') AS TaxCode,
		ISNULL(ETL.PrdTaxGroupCode,'') AS PrdTaxGroupCode,ISNULL(ETL.Percentage,0) AS Percentage,ISNULL(ETL.ApplyOn,'') AS ApplyOn,
		ISNULL(ETL.Discount,'') AS Discount,ISNULL(ETL.SchDiscount,'') AS SchDiscount,ISNULL(ETL.DBDiscount,'') AS DBDiscount,
		ISNULL(ETL.CDDiscount,'') AS CDDiscount,ISNULL(ETL.FreightCharge,'') AS FreightCharge
		FROM Etl_Prk_TaxSetting ETL
		WHERE DownloadFlag='D' AND TaxGroupCode=@TaxGroupCode AND PrdTaxGroupCode=@PrdTaxGroupCode) ETL1
		RIGHT OUTER JOIN TaxConfiguration TC ON TC.TaxCode=ETL1.TaxCode
		SET @RowId=0
		DECLARE Cur_TaxSettingDetail CURSOR		--TaxSettingDetail Cursor
		FOR SELECT TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,SchDiscount,DBDiscount,CDDiscount,FreightCharge
		FROM @TaxSettingTable Order By TaxId
		OPEN Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
		@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @RowId=@RowId+1
			--Nanda
			--SELECT @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount
			
			IF @TaxCode=''	--Check Empty Values For TaxSetting Details
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Tax Code' + @TaxCode + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			
			IF @Percentage<0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Percentage' + CAST(@Percentage AS NVARCHAR(20)) + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Percentage',@ErrDesc)
			END
			IF @Applyon=''
			BEGIN
				SET @iApplyOn=0
			END
			ELSE IF UPPER(@ApplyOn)='SELLINGRATE' OR UPPER(@ApplyOn)='MRP' OR UPPER(@ApplyOn)='PURCHASERATE'
			BEGIN
				SET @iApplyOn=1
			END
			ELSE
			BEGIN
				SET @iApplyOn=2
			END
			IF @Discount='ADD'
			BEGIN
				SET @iDiscount=1
			END
			ELSE IF UPPER(@Discount)='REDUCE'
			BEGIN
				SET @iDiscount=2
			END
			ELSE
			BEGIN
				SET @iDiscount=0
			END		
			--Till Here
			IF NOT EXISTS  (SELECT * FROM TaxConfiguration WHERE TaxCode = @TaxCode )
			BEGIN
				SET @Po_ErrNo=1
				SET @ErrDesc = 'Tax Code: ' + @TaxCode + ' is not available' 		
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxId=TaxId FROM TaxConfiguration WHERE TaxCode=@TaxCode	
			END
			DELETE FROM @TblColNo
			INSERT INTO @TblColNo(SlNo1,SlNo2,FieldDesc)
			SELECT 1,1,'TaxID' AS FieldDesc
			UNION
			SELECT 2,1,'Tax Name' AS FieldDesc
			UNION
			SELECT 3,1,'Tax%' AS FieldDesc
			UNION
			SELECT 4,1,'MRP' AS FieldDesc
			UNION
			SELECT 5,1,'SELLING RATE' AS FieldDesc
			UNION
			SELECT 6,1,'PURCHASE RATE' AS FieldDesc
			UNION
			SELECT 7,Slno,FieldDesc FROM @T1
			UNION
			SELECT 8,TaxId,TaxName FROM TaxConfiguration
			
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,1,@SlNo,@BillSeqId,@TaxSeqId,1,@TaxId,@TaxId,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
			
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',1,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,' + CAST(@TaxId AS NVARCHAR(100)) + ',' +CAST(@TaxId AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,3,@SlNo,@BillSeqId,@TaxSeqId,1,0,@Percentage,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',3,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,0,' +CAST(@Percentage AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SET @sColNo=4
			
			--------TaxSetting1-->Price Settings---------------------
			DECLARE Cur_TaxSetting1 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,FieldDesc FROM @TblColNo WHERE SlNo1>3 AND SlNo1<7
			OPEN Cur_TaxSetting1
			FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			WHILE @@FETCH_STATUS=0
			BEGIN
				IF @sColNo=4 AND UPPER(@ApplyOn)='MRP'
				BEGIN
					--SET MRP as 1 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=5 AND UPPER(@ApplyOn)='SELLINGRATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Selling Rate Value as 1
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',5,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=6 AND UPPER(@ApplyOn)='PURCHASERATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 1						
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF EXISTS(SELECT TaxCode FROM TaxConfiguration WHERE TaxCode=@ApplyOn) OR UPPER(@ApplyOn)='NONE'
				BEGIN					
					IF @sColNo=4
					BEGIN
						--SET MRP as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					END
					ELSE IF @sColNo=5
					BEGIN
						--SET Sellling Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
						
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @sColNo=6
					BEGIN
						--SET Purchase Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
												
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END	
--				--Nanda
--				SELECT * FROM TaxSettingDetail WHERE TaxSeqId=@TaxSeqId AND RowId=@RowId
				SET @sColNo=@sColNo+1
	
				FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			END
			CLOSE Cur_TaxSetting1
			DEALLOCATE Cur_TaxSetting1
			-----TaxSetting1--------------------------------
			----------------TaxSetting2-->Bill/Purchase Column Sequnce Settings---------------------
			SET @sColNo=7
			SET @ColId=4
			--Nanda
			--SELECT ColNo,SlNo1,FieldDesc FROM @TblColNo WHERE SlNo1=7
			DECLARE Cur_TaxSetting2 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR
				SELECT ColNo,SlNo1,FieldDesc,SlNo2  FROM @TblColNo WHERE SlNo1=7
			OPEN Cur_TaxSetting2
			FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				
				SET @EffetOnTax=0
				IF UPPER(@Type)='RETAILER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(BillSeqId) FROM dbo.BillSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.BillSequenceDetail WHERE BillSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					--->Added By Nanda on 28/04/2011										
					IF @FieldDesc='Spl. Disc' 
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='Sch Disc' 
					BEGIN
						IF UPPER(@SchDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@SchDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='DB Disc' 
					BEGIN
						IF UPPER(@DBDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@DBDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='CD Disc'
					BEGIN
						IF UPPER(@CDDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@CDDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					--->Till Here
				END
				ELSE IF UPPER(@Type)='SUPPLIER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(PurSeqId) FROM dbo.PurchaseSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.PurchaseSequenceDetail WHERE PurSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					
					IF UPPER(@FieldDesc)='FREIGHTCHARGES' 
					BEGIN
						IF UPPER(@FreightCharge)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@FreightCharge)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
				     END
				     ELSE IF UPPER(@FieldDesc) = 'DISC'
					 BEGIN
					    IF UPPER(@Discount)='ADD'
					    BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END
					 END
					 ELSE
					 BEGIN
					     SET @iDiscount=0
					 END
				END			        		 
									
				IF @iApplyOn=2
				BEGIN
					SET @EffetOnTax=0
				END				
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
				ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				--VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@EffetOnTax,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@iDiscount,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,'+ CAST(@ColId AS NVARCHAR(100))+ ',' +CAST(@EffetOnTax AS NVARCHAR(100))+',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
				INSERT INTO Translog(strSql1) Values (@sSQL)					
				SET @sColNo=@sColNo+1
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting2
			DEALLOCATE Cur_TaxSetting2
			------TaxSetting2-----------------------
			-------TaxSetting3-->Tax On Tax Settings-----------------------
			SET @sColNo=@sColNo
			SET @ColId=1
			
			DECLARE Cur_TaxSetting3 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,SlNo1,FieldDesc,SlNo2 FROM @TblColNo WHERE SlNo1=8 AND SlNo2<>@TaxId
			OPEN Cur_TaxSetting3
			FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				IF @iApplyOn<>2
				BEGIN
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
					CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT * FROM TaxConfiguration WHERE TaxCode=@Applyon AND TaxId=@SlNo2)
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,@SlNo2,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @iApplyOn=1
					END
					ELSE
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					END
				END
				SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',3,'+ CAST(@TaxId AS NVARCHAR(100))+ ',0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting3
			DEALLOCATE Cur_TaxSetting3
			UPDATE Etl_Prk_TaxSetting  SET DownloadFlag = 'Y'
			WHERE TaxGroupCode = @TaxGroupCode AND TaxCode = @TaxCode AND Percentage = @Percentage
			AND Type = @Type AND PrdTaxGroupCode = @PrdTaxGroupCode
			FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
			@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		END
		CLOSE Cur_TaxSettingDetail
		DEALLOCATE Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	END
	CLOSE Cur_TaxSettingMaster
	DEALLOCATE Cur_TaxSettingMaster	
	UPDATE TaxSettingDetail SET ColVal=0 WHERE ColId=1 AND ColType=2 AND CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10))
	NOT IN (SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId IN(SELECT TaxId FROM TaxConfiguration WHERE TaxCode='VAT'))
	AND  CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) IN (
	SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId=0 AND ColVal=0)
	
	----Retailer Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Retailer' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @RtrTaxGroupId AS NUMERIC(18,0)
	--	SET @RtrTaxGroupId = 0
	--	SELECT @RtrTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 1
	--	IF @RtrTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Retailer SET TaxGroupId = @RtrTaxGroupId
	--	END
	--END
	----Till Here
	----Supplier Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Supplier' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @SupTaxGroupId AS NUMERIC(18,0)
	--	SET @SupTaxGroupId = 0
	--	SELECT @SupTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 3
	--	IF @SupTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Supplier SET TaxGroupId = @SupTaxGroupId
	--	END
	--END
	----Till Here
	
	RETURN
END
GO
IF EXISTS (SELECT 'D' FROM SysObjects WHERE name ='Proc_RptGSTR1_B2CS' AND Type='P')
DROP PROCEDURE Proc_RptGSTR1_B2CS
GO
/*
EXEC Proc_RptGSTR1_B2CS 416,2,0,'',0,0,1
 */
CREATE PROCEDURE Proc_RptGSTR1_B2CS
(
	
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE		: Proc_RptGSTR1_B2CS
* PURPOSE		: To Generate a report GSTR1 B2Consumar Small
* CREATED		: Murugan.R
* CREATED DATE	: 13/04/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
* 08-10-2018	MOHANA S	    ILCRSTBOT0006	   CR				Included CESS Tax
*********************************/
SET NOCOUNT ON
BEGIN
		TRUNCATE TABLE RptGSTR1_B2CS
		DECLARE @CmpId AS INT
		DECLARE @MonthStart INT
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		
		
		CREATE TABLE #RptGSTR1_B2CS
		(
		TransId			TinyInt,
		TranType		Varchar(20),
		Refid			BIGINT,
		RtrShipId		INT,
		RtrId			INT,
		RtrCode			Varchar(50),	
		RtrName			Varchar(100),
		[GSTIN/UIN of Recipient]	 Varchar(50),
		[Invoice Number]	 Varchar(50),
		[Invoice date]	DateTime,
		[Invoice Value]	Numeric(32,2),
		[Place Of Supply]	Varchar(125),
		[Reverse Charge]	Varchar(10),
		[Invoice Type]	Varchar(50),
		[E-Commerce GSTIN]	Varchar(50),
		[Rate]			Numeric(10,2),
		[Taxable Value]	Numeric(32,2),
		[Cess Amount]	Numeric(32,2),
		[IGST rate]			Numeric(32,2),
		[IGST amount]		Numeric(32,2),
		[CGST rate]			Numeric(32,2),
		[CGST amount]		Numeric(32,2),
		[SGST/UTGST rate]	Numeric(32,2),
		[SGST/UTGST amount]	Numeric(32,2),
		UsrId INT,
		[Group Name] Varchar(100),
		GroupType TINYINT
		)
			
			
		---Retailer Registered
		SELECT R.RtrId,ColumnValue
		INTO #RetailerUnRegister
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and ColumnValue='UnRegistered' 
		
		
		SELECT DISTINCT  R.RtrId as RtrId,TinFirst2Digit+'-'+StateName as StateName
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name'
		
	
		
		
		SELECT DISTINCT  R.RtrId as RtrId,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.RtrId=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
				
		SELECT S.RtrId,S.RtrshipId,S.Salid,Salinvno,SalInvdate,Prdslno,OrgNetAmount,SUM(TaxPerc) as Taxperc,SUM(DISTINCT TaxableAmount) as TaxableAmount,SUM(TaxAmount) as TaxAmount
		INTO #Sales		
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
		INNER JOIN #RetailerUnRegister R ON R.RtrId=S.RtrId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		AND  TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST') and TaxableAmount>0
		GROUP BY S.RtrId,S.Salid,Salinvno,SalInvdate,Prdslno,S.RtrshipId,OrgNetAmount
		
		SELECT S.SalId,S.Rtrid,SUM(PrdNetAmount)PrdNetAmount INTO #SalesNetValue FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SI (NOLOCK) ON S.Salid=SI.SalId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		GROUP BY S.SalId,S.Rtrid
		UPDATE S SET OrgNetAmount=PrdNetAmount FROM #Sales S INNER JOIN #SalesNetValue SI ON S.Salid=SI.Salid
		
		---CALCULATE TAX SPLIT 			
		SELECT TAXID,				
		CASE	WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN 'OutputIGST'
				WHEN TaxCode IN ('OutputCGST','CGST','InputCGST') Then 'OutputCGST'
				WHEN TaxCode IN ('OutputSGST','SGST','InputSGST') Then 'OutputSGST'
				WHEN TaxCode IN ('OutputUTGST','UTGST','InputUTGST') Then 'OutputUTGST'
				WHEN TaxCode IN('OutputIGSTCESS','IGSTCESS','InputIGSTCESS') THEN 'OutputIGSTCESS'
				WHEN TaxCode IN ('OutputCGSTCESS','CGSTCESS','InputCGSTCESS') Then 'OutputCGSTCESS'
				WHEN TaxCode IN ('OutputSGSTCESS','SGSTCESS','InputSGSTCESS') Then 'OutputSGSTCESS'
				WHEN TaxCode IN ('OutputUTGSTCESS','UTGSTCESS','InputUTGSTCESS') Then 'OutputUTGSTCESS'
				WHEN TaxCode IN ('OutputGSTCESS','GSTCESS','CESS','InputGSTCESS') Then 'OutputGSTCESS'
		END	 as TaxCode
		INTO #TaxConfiguration
		FROM  TaxConfiguration WHERE TaxCode 
		IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
		'InputCGST','InputSGST','InputIGST','InputUTGST','OutputCGSTCESS','OutputSGSTCESS','OutputIGSTCESS','OutputUTGSTCESS','CGSTCESS','SGSTCESS','IGSTCESS','UTGSTCESS',
		'InputCGSTCESS','InputSGSTCESS','InputIGSTCESS','InputUTGSTCESS','InputGSTCESS','GSTCESS','CESS','OutputGSTCESS')
		SELECT * INTO #SalesInvoiceProductTax FROM SalesInvoiceProductTax 
			WHERE SalId IN (SELECT DISTINCT salid FROM #Sales) 		
			
			
				
			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt INTO #TAXPIVOT
			FROM
			(
			----SALES DATA
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'Perc' AS TaxCode,ST.TaxPerc AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
			UNION ALL
			SELECT 1 AS BTYPE,SI.Salinvno,SI.Prdslno,TaxCode+'_Amt' AS TaxCode,ST.TaxAmount AS TaxPercAmt 
				FROM #Sales SI
				INNER JOIN #SalesInvoiceProductTax ST ON ST.SalId=SI.SalId  AND ST.PrdSlNo=SI.Prdslno
				INNER JOIN #TaxConfiguration T ON T.TaxId=ST.TaxId
  			)A
 			ORDER BY BTYPE 
 			SELECT BTYPE,Salinvno,Prdslno,SUM([OutputCGSTPerc])[OutputCGSTPerc],
				SUM([OutputCGST_Amt])[OutputCGST_Amt],SUM([OutputSGSTPerc])[OutputSGSTPerc],SUM([OutputSGST_Amt])[OutputSGST_Amt],
				SUM([OutputIGSTPerc])[OutputIGSTPerc],SUM([OutputIGST_Amt])[OutputIGST_Amt],SUM([OutputUTGSTPerc])[OutputUTGSTPerc],
				SUM([OutputUTGST_Amt])[OutputUTGST_Amt],
				SUM([OutputCGSTCESSPerc])[OutputCGSTCESSPerc],
				SUM([OutputCGSTCESS_Amt])[OutputCGSTCESS_Amt],SUM([OutputSGSTCESSPerc])[OutputSGSTCESSPerc],SUM([OutputSGSTCESS_Amt])[OutputSGSTCESS_Amt],
				SUM([OutputIGSTCESSPerc])[OutputIGSTCESSPerc],SUM([OutputIGSTCESS_Amt])[OutputIGSTCESS_Amt],SUM([OutputUTGSTCESSPerc])[OutputUTGSTCESSPerc],
				SUM([OutputUTGSTCESS_Amt])[OutputUTGSTCESS_Amt],SUM([OutputGSTCESSPerc])[OutputGSTCESSPerc],SUM([OutputGSTCESS_Amt])[OutputGSTCESS_Amt]
			INTO #TAXDETAILS
			FROM(
			SELECT BTYPE,Salinvno,Prdslno,
			ISNULL([OutputCGSTPerc],0)[OutputCGSTPerc],ISNULL([OutputCGST_Amt],0)[OutputCGST_Amt],
			ISNULL([OutputSGSTPerc],0)[OutputSGSTPerc],ISNULL([OutputSGST_Amt],0)[OutputSGST_Amt],
			ISNULL([OutputIGSTPerc],0)[OutputIGSTPerc],ISNULL([OutputIGST_Amt],0)[OutputIGST_Amt],
			ISNULL([OutputUTGSTPerc],0)[OutputUTGSTPerc],ISNULL([OutputUTGST_Amt],0)[OutputUTGST_Amt],
			ISNULL([OutputCGSTCESSPerc],0)[OutputCGSTCESSPerc],
			ISNULL([OutputCGSTCESS_Amt],0)[OutputCGSTCESS_Amt],
			ISNULL([OutputSGSTCESSPerc],0)[OutputSGSTCESSPerc],
			ISNULL([OutputSGSTCESS_Amt],0)[OutputSGSTCESS_Amt],
			ISNULL([OutputIGSTCESSPerc],0)[OutputIGSTCESSPerc],
			ISNULL([OutputIGSTCESS_Amt],0)[OutputIGSTCESS_Amt],
			ISNULL([OutputUTGSTCESSPerc],0)[OutputUTGSTCESSPerc],
			ISNULL([OutputUTGSTCESS_Amt],0)[OutputUTGSTCESS_Amt],
			ISNULL([OutputGSTCESSPerc],0)[OutputGSTCESSPerc],
			ISNULL([OutputGSTCESS_Amt],0)[OutputGSTCESS_Amt]
			FROM (
			SELECT BTYPE,Salinvno,Prdslno,TaxCode,TaxPercAmt
			FROM #TAXPIVOT) up
			PIVOT (SUM(TaxPercAmt) FOR TaxCode IN ([OutputCGST_Amt],[OutputCGSTPerc],
													[OutputSGST_Amt],[OutputSGSTPerc],
													[OutputIGST_Amt],[OutputIGSTPerc],
													[OutputUTGST_Amt],[OutputUTGSTPerc],
													[OutputCGSTCESS_Amt],[OutputCGSTCESSPerc],
													[OutputSGSTCESS_Amt],[OutputSGSTCESSPerc],
													[OutputIGSTCESS_Amt],[OutputIGSTCESSPerc],
													[OutputUTGSTCESS_Amt],[OutputUTGSTCESSPerc],
													[OutputGSTCESS_Amt],[OutputGSTCESSPerc]))  AS PVT 
			)A
			GROUP BY BTYPE,Salinvno,Prdslno 
					
		
		----IGST Invoice wise Net Value <250000
		SELECT DISTINCT S.Salid
		INTO #SalesIGST		
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProductTax ST (NOLOCK) ON S.Salid=ST.SalId
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
		INNER JOIN #RetailerunRegister R ON R.RtrId=S.RtrId
		WHERE Dlvsts>3 and Month(SalInvdate)=@MonthStart and Year(Salinvdate)=@Jcmyear and VatGST='GST'
		and TaxCode IN('OutputIGST','IGST') and TaxableAmount>0
			
		INSERT INTO #RptGSTR1_B2CS(TransId,TranType,Refid ,RtrShipId,RtrId,RtrCode,RtrName,
		[GSTIN/UIN of Recipient],[Invoice Number],[Invoice date],[Invoice Value],[Place Of Supply],
		[Reverse Charge],[Invoice Type]	,[E-Commerce GSTIN],[Rate],[Taxable Value],[Cess Amount],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],
		UsrId,[Group Name],GroupType)
		SELECT 1,'Sales',S.Salid,S.RtrShipId,R.RtrId,RtrCode,RtrName,'' as GSTTin,S.Salinvno,Salinvdate, OrgNetAmount as SalesValue,'' as PlaceOfSupply,
			'N' as ReverseCharge,'Regular' as InvoiceType,'' as [E-Commerce],Taxperc,SUM(TaxableAmount) as TaxableAmount,
			SUM([OutputSGSTCESS_Amt]+[OutputIGSTCESS_Amt]+[OutputCGSTCESS_Amt]+[OutputUTGSTCESS_Amt]+OutputGSTCESS_Amt) as CessAmount,
			[OutputIGSTPerc],SUM([OutputIGST_Amt]) AS [OutputIGST_Amt],[OutputCGSTPerc],SUM([OutputCGST_Amt]) AS [OutputCGST_Amt],
			([OutputSGSTPerc]+[OutputUTGSTPerc]),SUM([OutputSGST_Amt]+[OutputUTGST_Amt])AS [OutputSGST_Amt],@Pi_UsrId,'' as [Group Type],2
		FROM #Sales S INNER JOIN Retailer R (NOLOCK) ON R.RtrId=S.RtrId
		INNER JOIN #TAXDETAILS T ON T.SalInvNo=S.SalInvNo AND T.Prdslno=S.Prdslno
		GROUP BY 
		S.Salid,R.RtrId,RtrCode,RtrName,S.Salinvno,Salinvdate,Taxperc,S.RtrShipId,OrgNetAmount,
		[OutputIGSTPerc],[OutputCGSTPerc],[OutputSGSTPerc],[OutputUTGSTPerc], [OutputGSTCESSPerc]
		
	 	
					
		UPDATE B Set B.[Place Of Supply]=A.StateName FROM #RetailerState A INNER JOIN #RptGSTR1_B2CS B ON A.Rtrid=B.RtrId
		and TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=GSTTinNo FROM #RptGSTR1_B2CS R INNER JOIN RetailerShipAdd RS ON RS.RtrShipId=R.RtrShipId
		and TransId=1
		
		UPDATE R Set R.[GSTIN/UIN of Recipient]=ColumnValue FROM #RptGSTR1_B2CS R INNER JOIN #RetailerGSTIN RS ON RS.RtrId=R.RtrId
		WHERE LEN(ISNULL(R.[GSTIN/UIN of Recipient],''))=0
		and TransId=1
	
		DELETE A FROM #RptGSTR1_B2CS A INNER JOIN #SalesIGST B ON A.Refid=B.SalId and TransId=1
		WHERE [Invoice Value]>250000
		
 		
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR1_B2CS)
		BEGIN
			SELECT * FROM RptGSTR1_B2CS (NOLOCK) WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR1_B2CS([Type],[Place Of Supply],[Rate],[Taxable Value],[Cess Amount],[E-Commerce GSTIN],
		[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)		
		SELECT 'OE',[Place Of Supply],[Rate],SUM([Taxable Value]),SUM([Cess Amount]),[E-Commerce GSTIN],
			[IGST rate],SUM([IGST amount]),[CGST rate],sum([CGST amount]),[SGST/UTGST rate],sum([SGST/UTGST amount]),
			@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		FROM #RptGSTR1_B2CS 
		GROUP BY [Rate],[Place Of Supply],[E-Commerce GSTIN],[IGST rate],[CGST rate],[SGST/UTGST rate]
		
		
		INSERT INTO RptGSTR1_B2CS([Type],[Place Of Supply],	[Rate],[Taxable Value],[Cess Amount],[E-Commerce GSTIN],
			[IGST rate],[IGST amount],[CGST rate],[CGST amount],[SGST/UTGST rate],[SGST/UTGST amount],UsrId,[Group Name],GroupType)
		SELECT'' as [Type],'' as [Place Of Supply],0.00 as [Rate],SUM([Taxable Value]),SUM([Cess Amount]),'' as [E-Commerce GSTIN],
		0 as [IGST rate],SUM([IGST amount]),0 as [CGST rate],sum([CGST amount]),0 as [SGST/UTGST rate],SUM([SGST/UTGST amount]),
			@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR1_B2CS
 		
		
		SELECT * FROM RptGSTR1_B2CS (NOLOCK) WHERE UsrId=@Pi_UsrId				
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_RptDebitNoteTopSheetNew' AND TYPE ='P')
DROP PROCEDURE Proc_RptDebitNoteTopSheetNew
GO
/*  
BEGIN TRAN  
EXEC Proc_RptDebitNoteTopSheetNew 292,2,0,'',0,0,1      
SELECT * FROM RptDebitNoteTopSheet_Excel1      
SELECT * FROM RptDebitNoteTopSheet_Excel2   
SELECT * FROM RptDebitNoteTopSheet_Excel3   
SELECT * FROM RptDebitNoteTopSheet_Excel6WID  
SELECT * FROM RptDebitNoteTopSheet_Excel_GrandTotal  
ROLLBACK TRAN      
*/  
CREATE PROCEDURE Proc_RptDebitNoteTopSheetNew  
(      
 @Pi_RptId   INT,      
 @Pi_UsrId   INT,      
 @Pi_SnapId   INT,      
 @Pi_DbName   NVARCHAR(50),      
 @Pi_SnapRequired INT,@Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT      
)      
AS      
/************************************************************************************************************************************      
* PROCEDURE : Proc_RptDebitNoteTopSheetNew      
* PURPOSE : Debit Note Top Sheet in Crystal format  
* CREATED : S.MOORTHI     
* CREATED DATE :03-05-2019      
* NOTE  : Parle SP for Debit Note Top Sheet      
* MODIFIED       
*************************************************************************************************************************************      
* DATE       AUTHOR     CR/BZ    USER STORY ID           DESCRIPTION                               
*************************************************************************************************************************************      
03-05-2019  S.MOORTHI    SR      ILCRSTPAR4278       Debit note sheet report (Design in Crystal Reports)  
21-06-2019  S.MOORTHI    CR      CRCRSTPAR0056       STO(Service to Outlet) or Distributor incentive logic to be incorporated and debit note should upload to console  
17-07-2019 S.MOHANA      CR      ILCRSTPAR5199       INCLUDED NEW SUB REPORT -- SMINCENTIVE DETAILS  
10-08-2019  Lakshman M   BZ      ILCRSTPAR5500       Sub reports some table data not available that time report showing no record fiund.  
************************************************************************************************************************************/           
BEGIN      
 SET NOCOUNT ON      
 DECLARE @FromDate   AS DATETIME      
 DECLARE @ToDate    AS DATETIME      
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)      
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)      
 --Report 1      
 DECLARE @CityName AS NVARCHAR(100)      
 DECLARE @DistributorCode AS NVARCHAR(40)      
 DECLARE @DistributorName AS NVARCHAR(100)      
 DECLARE @DBMonth As INT      
 SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,      
 @CityName = G.GeoName      
 FROM Distributor D (NOLOCK),      
 Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId      
 --Added By Mohana       
 --SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate      
 SELECT @DBMonth = CASE MONTH (@ToDate)       
  WHEN 4 THEN 1      
  WHEN 5 THEN 2      
  WHEN 6 THEN 3      
  WHEN 7 THEN 4      
  WHEN 8 THEN 5      
  WHEN 9 THEN 6      
  WHEN 10 THEN 7      
  WHEN 11 THEN 8      
  WHEN 12 THEN 9      
  WHEN 1 THEN 10      
  WHEN 2 THEN 11      
  WHEN 3 THEN 12      
 END       
 --Report 1      
 --Report 2      
 DECLARE @slno AS INT      
 DECLARE @SamplingAmount AS NUMERIC(18,2)      
 SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'      
 --- Change by Amuthakumar P ILCRSTPAR1917      
 SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)      
 FROM FreeIssueHd J (NOLOCK),      
 FreeIssueDt D (NOLOCK),      
 ProductBatchDetails P (NOLOCK)      
 WHERE J.IssueId = D.IssueId       
 AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
 AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate      
 --Report 2      
 DELETE FROM REPORTFILTERDT WHERE RPTID=291  
 INSERT INTO REPORTFILTERDT(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)  
 SELECT 291,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate from ReportFilterDt WHERE RptId=@Pi_RptId  
     EXEC Proc_RptDebitNoteTopSheet  @Pi_RptId,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId  
 ---ILCRSTPAR4278   
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel1WID  
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel2WID  
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel3WID  
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel4WID  
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel5WID  
 TRUNCATE TABLE RptDebitNoteTopSheet_Excel6WID  
   
 INSERT INTO RptDebitNoteTopSheet_Excel1WID([Scheme Description],[From],[To],[Circular No],  
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],SubLinkId)  
 SELECT [Scheme Description],[From],[To],[Circular No],  
 [Date],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],@DBMonth FROM RptDebitNoteTopSheet_Excel1(NOLOCK)  
 WHERE [Scheme Description]<>'Total'  
    
   
   
 DELETE FROM RPTFORMULA WHERE RptId=@Pi_RptId  
 INSERT INTO RPTFORMULA([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId])   
 SELECT @Pi_RptId,1,'SamplingAmount','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30)),1,0 UNION  
 SELECT @Pi_RptId,2,'From','From : ' + CONVERT(VARCHAR(11),@FromDate,105) ,1,0 UNION  
 SELECT @Pi_RptId,3,'To','To : ' + CONVERT(VARCHAR(11),@ToDate,105),1,0 UNION  
 SELECT @Pi_RptId,4,'Heading1','PARLE - DEBIT NOTE / CREDIT NOTE' ,1,0 UNION  
 SELECT @Pi_RptId,5,'WholesalerName','Name of the Wholesaler : ' + ISNULL(@DistributorName,'') ,1,0 UNION  
 SELECT @Pi_RptId,6,'Town','Name of the Town : ' + ISNULL(@CityName,'') ,1,0 UNION  
 SELECT @Pi_RptId,7,'DebitNoteNo','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)  ,1,0 UNION  
 SELECT @Pi_RptId,8,'WholesalerCode','Wholesaler Code : ' + ISNULL(@DistributorCode,'') ,1,0 UNION  
 SELECT @Pi_RptId,9,'ProductSampled','Product Sampled during the period  '  ,1,0  UNION  
 SELECT top 1 @Pi_RptId,10,'GrandTotal',CONVERT(NVARCHAR(10),Column6)  ,1,0 from RptDebitNoteTopSheet_Excel_GrandTotal(NOLOCK)   
   
   
 INSERT INTO RptDebitNoteTopSheet_Excel2WID([Name Of the Category],[From],[TO],[Circular No],[Monthly Target],  
 [Last 2 Mont Avg Sal],[Current Month],[No of Incent Outlets],[Total Discount Amount],SubLinkId)  
 SELECT [Name Of the Category],[From],[TO],[Circular No],[Monthly Target],  
 [Last 2 Mont Avg Sal],[Current Month],[No of Incent Outlets],[Total Discount Amount],@DBMonth FROM RptDebitNoteTopSheet_Excel2(NOLOCK)  
 WHERE [Name Of the Category]<>'Total'  
   
 INSERT INTO RptDebitNoteTopSheet_Excel3WID([Name Of the Category],[From],[TO],[Total Normal Amount],  
 [Total Normal Sec Sales AS Per TOT],[TOT Diff claims],SubLinkId)  
 SELECT [Name Of the Category],[From],[TO],[Total Normal Amount],  
 [Total Normal Sec Sales AS Per TOT],[TOT Diff claims],@DBMonth FROM RptDebitNoteTopSheet_Excel3(NOLOCK)  
 WHERE [Name Of the Category]<>'Total'  
   
 INSERT INTO RptDebitNoteTopSheet_Excel4WID([Scheme Description],[From],[TO],[Circular No],[Scheme Budget],  
 [Sec Sales Value],[% Lib on Sec Sales],[Claim Amount],SubLinkId)  
 SELECT [Scheme Description],[From],[TO],[Circular No],[Scheme Budget],[Sec Sales Value],  
 [% Lib on Sec Sales],[Claim Amount],@DBMonth SubLinkId FROM RptDebitNoteTopSheet_Excel4(NOLOCK)  
 WHERE [Scheme Description]<>'Total'  
   
 INSERT INTO RptDebitNoteTopSheet_Excel5WID([Dist. Incentive Ref. No.],  
 [No of Salesman],[Total Sales Value],[Incentive Amount],SubLinkId)  
 SELECT [Dist. Incentive Ref. No.],[No of Salesman],[Total Sales Value],[Incentive Amount],@DBMonth SubLinkId     
 FROM RptDebitNoteTopSheet_Excel5  (NOLOCK)  
 WHERE [Dist. Incentive Ref. No.]<>'Total'   
 INSERT INTO RptDebitNoteTopSheet_Excel6WID(SMIRefNo,IncMonth,IncYear,SMName,TotalAchSales,[From Range],[To Range],FixedPay,  
 VariablePay,IncPerc,IncAmount,[Total Incentive Amount],SubLinkId )  
 SELECT SMIRefNo,IncMonth,IncYear,SMName,TotalAchSales,[From Range],[To Range],FixedPay,  
 VariablePay,IncPerc,IncAmount,[Total Incentive Amount],@DBMonth SubLinkId  
 FROM RptDebitNoteTopSheet_Excel6 (NOLOCK)  
 WHERE SMIRefNo<>'Total'   
 ---------------- Added  By Lakshman M Dated On 10-08-2019 PMS ID: ILCRSTPAR5448    
 DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId    
   
   
 IF NOT exists(SELECT * FROM RptDebitNoteTopSheet_Excel1WID)  
 BEGIN  
  SELECT MAX(RecCount ) RecCount INTO #temp  FROM (  
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel1WID(NOLOCK)  
  union all   
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel2WID(NOLOCK)  
  union all   
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel3WID(NOLOCK)  
  union all   
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel4WID(NOLOCK)  
  union all   
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel5WID(NOLOCK)  
  union all   
  SELECT MAX(SUBLINKID) as RecCount FROM RptDebitNoteTopSheet_Excel6WID(NOLOCK)  
  ) A
 END  
   
 IF NOT EXISTS(SELECT * FROM RptDebitNoteTopSheet_Excel1WID)  
 BEGIN  
  INSERT INTO RptDebitNoteTopSheet_Excel1WID  
  SELECT '','','','','',cast(0 as varchar(10)),'',cast(0 as varchar(10)),cast(0 as varchar(10)),cast(0 as varchar(10)),RecCount FROM #temp  
 END  
  
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)   
 SELECT  @Pi_RptId, COUNT(*) ,0 ErrNo , @Pi_UsrId FROM RptDebitNoteTopSheet_Excel1WID  
   
   
 SELECT * FROM RptDebitNoteTopSheet_Excel1WID  
 ---ILCRSTPAR4278  
 RETURN       
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='RetailerMarketOldRouteTrack' AND TYPE ='U')
BEGIN
CREATE TABLE RetailerMarketOldRouteTrack 
(
	[RtrId] [int] NOT NULL,
	[RMId] [int] NOT NULL,
	[Availability] [tinyint] NOT NULL,
	[LastModBy] [tinyint] NOT NULL,
	[LastModDate] [datetime] NOT NULL,
	[AuthId] [tinyint] NOT NULL,
	[AuthDate] [datetime] NOT NULL,
	[Upload] [int],
	[LastRouteRemoveddate] DATETIME
)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE Name ='Proc_Cn2Cs_RetailerReDownload' AND TYPE ='P')
DROP PROCEDURE Proc_Cn2Cs_RetailerReDownload
GO
/*
BEGIN TRAN
DELETE FROM ERRORLOG
--EXEC Proc_CN2CS_RouteMaster 0
--EXEC Proc_CN2CS_SalesManMaster 0
EXEC Proc_Cn2Cs_RetailerReDownload 0
SELECT * FROM Retailer WHERE rtrid =1314
select * from RetailerMarket where rtrid =1314
SELECT * FROM ERRORLOG
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_RetailerReDownload
(
	@Po_ErrNo	INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_RetailerMigration
* PURPOSE		: To validate and update records from parking table to main table
* CREATED		: S.MOORTHI
* CREATED DATE	: 08/01/2018
* MODIFIED
**************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID       DESCRIPTION                         
**************************************************************************************************
 08/01/2018  S.Moorthi   CR     ICRSTPAR7299        for 1 CR point
 09-08-2019  M.Lakshman  SR     ILCRSTPAR5462       New route updated validation included.
*********************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @MasterId INT
	DECLARE @UDCMasterId INT
	DECLARE @RtrId INT
	DECLARE @RtrShipAddId INT
	DECLARE @UdcCurrMasterId INT
	DECLARE @UdcCurrUniqueID INT	
	DECLARE @CoaID INT
	DECLARE @AccCode VARCHAR(200)
	
	BEGIN TRY
		
		
		SET @Po_ErrNo = 0
		SELECT @RtrId = CurrValue From Counters WHERE TabName = 'Retailer' AND FldName = 'RtrId'
		SELECT @RtrShipAddId = CurrValue From Counters WHERE TabName = 'RetailerShipAdd'
		SELECT @UdcCurrMasterId = CurrValue From Counters WHERE TabName = 'UDCDetails' AND FldName = 'UdcDetailsId'
		SELECT @UdcCurrUniqueID = CurrValue From Counters WHERE TabName = 'UDCDetails' AND FldName = 'UDCUniqueId'		
		SELECT @CoaID = CurrValue From Counters WHERE TabName = 'CoaMaster'
		SELECT @AccCode = MAX(AcCode) From COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%'
		DELETE FROM Cn2Cs_Prk_RetailerReDownload WHERE DownloadFlag = 'Y'
		
		CREATE TABLE #TempMigrateRetailer
			(
				[RetailerCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[CmpRtrCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RetailerName] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress1] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress2] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrAddress3] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrPinNo] [int] NULL,
				[RtrChannelCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrGroupCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrClassCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[KeyAccount] [nvarchar](20) COLLATE DATABASE_DEFAULT,
				[RelationStatus] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[ParentCode] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrRegDate] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrStatus] [int]NULL,
				[Approved] [varchar](10) NULL,
				[SalesRoute] [nvarchar](50) COLLATE DATABASE_DEFAULT,
				[DeliveryRoute] [nvarchar](50) COLLATE DATABASE_DEFAULT,
				[RtrType] [varchar](100) NULL,
				[RtrTINNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrCrBills] [int] NULL,
				[RtrCrLimit] [numeric](38, 6) NULL,
				[RtrCrDays] [int] NULL,
				[RtrDayOff] [int] NULL,
				[RtrCSTNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrPhoneNo] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrContactPerson] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrTaxGroup] [nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrTaxable] [varchar](1) NULL,
				[RtrUniqueCode]	[nvarchar](100) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd1] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd2] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[RtrShippAdd3] [nvarchar](200) COLLATE DATABASE_DEFAULT,
				[DownloadFlag] [varchar](1) NULL
			)
	
			DELETE FROM Errorlog WHERE TableName = 'Cn2Cs_Prk_RetailerReDownload'
			
			--Find Duplicate Retailers From Download
			SELECT PR.RetailerCode INTO #ParkingDuplicateRetailers 
			FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
			WHERE DownloadFlag = 'D' GROUP BY PR.RetailerCode
			HAVING COUNT(7)>1
			
			SELECT Row_Number() OVER(Order By RetailerCode,CmpRtrCode) RowNo,RetailerCode,CmpRtrCode 
			INTO #DuplicateRetailers
			FROM 
			(
				SELECT PR.RetailerCode,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateRetailers D ON PR.RetailerCode = D.RetailerCode
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RetailerCode,PR.CmpRtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RetailerCode = R.RtrCode
				WHERE DownloadFlag = 'D'
			) A
			
			--Find Duplicate Retailers From Download			
			SELECT Row_Number() OVER(Order By RetailerCode,RtrUniqueCode) RowNo,RetailerCode,RtrUniqueCode 
			INTO #DuplicateRetailers1
			FROM 
			(
				SELECT PR.RetailerCode,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) 
				INNER JOIN #ParkingDuplicateRetailers D ON PR.RetailerCode = D.RetailerCode
				WHERE DownloadFlag = 'D'		
				UNION				
				SELECT PR.RetailerCode,PR.RtrUniqueCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON PR.RetailerCode = R.RtrCode
				WHERE DownloadFlag = 'D'
			) A
						
			--Delete Duplicate Retailers in Temp Table WHILE RtrStatus=1
			--DELETE D FROM #DuplicateRetailers D  (NOLOCK) 
			--INNER JOIN Retailer R (NOLOCK) ON D.RetailerCode = R.RtrCode AND D.CmpRtrCode = R.CmpRtrCode
			--WHERE R.RtrStatus = 1  --Approved=1
			
			--IF EXISTS (SELECT 7 FROM #DuplicateRetailers)
			--BEGIN
			
			--	SELECT RtrCode INTO #ExistingRtrCode FROM
			--	(
			--		SELECT RetailerCode AS RtrCode FROM Cn2Cs_Prk_RetailerReDownload PR (NOLOCK) WHERE DownloadFlag = 'D'
			--		UNION
			--		SELECT RtrCode  FROM Retailer R (NOLOCK)
			--	)X
			--	DECLARE @CntOfDuplicate AS INTEGER
			--	DECLARE @CurrentNo AS NVARCHAR(3)
			--	DECLARE @Counter AS NVARCHAR(6)
			--	DECLARE @RtrFlag AS TINYINT
			--	DECLARE @RetailerCode AS NVARCHAR(200)
			--	DECLARE @FreshRtrCode AS NVARCHAR(200)
			--	SET @CntOfDuplicate = 0
			--	SET @CurrentNo = 1
				
			--	--Duplicate Retailer Count
			--	SELECT @CntOfDuplicate = COUNT(7) FROM #DuplicateRetailers (NOLOCK)
			--	WHILE (@CntOfDuplicate >= @CurrentNo)
			--	BEGIN
			--		SET @RtrFlag = 0
			--		SET @Counter = 1
					
			--		SELECT @RetailerCode = RetailerCode FROM #DuplicateRetailers (NOLOCK) WHERE RowNo = @CurrentNo
					
			--		WHILE (@RtrFlag = 0)
			--		BEGIN
										
			--			SET @FreshRtrCode = 'M'+@Counter+@RetailerCode
						
			--			IF NOT EXISTS(SELECT 7 FROM #ExistingRtrCode E (NOLOCK) WHERE RtrCode = @FreshRtrCode)
			--			BEGIN
						
			--				UPDATE D SET RetailerCode = @FreshRtrCode FROM #DuplicateRetailers D (NOLOCK) WHERE RowNo = @CurrentNo
							
			--				INSERT INTO #ExistingRtrCode
			--				SELECT @FreshRtrCode
							
			--				SET @RtrFlag = 1			
			--			END
			--			ELSE
			--			BEGIN
			--				SET @Counter = @Counter + 1
			--			END						
			--		 END
					 					 
			--		 SET @CurrentNo = @CurrentNo + 1	
			--	 END
			
			--	UPDATE P SET P.RetailerCode = D.RetailerCode
			--	FROM #DuplicateRetailers D (NOLOCK) INNER JOIN Cn2Cs_Prk_RetailerReDownload P (NOLOCK) 
			--	ON P.CmpRtrCode = D.CmpRtrCode WHERE DownloadFlag = 'D'	
			--END
			--Till Here
			
			INSERT INTO #TempMigrateRetailer (RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3)
			SELECT DISTINCT RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3
			FROM Cn2Cs_Prk_RetailerReDownload A WITH (NOLOCK)  WHERE DownLoadFlag = 'D'
			AND NOT EXISTS(SELECT RetailerCode,CmpRtrCode FROM #DuplicateRetailers B WHERE A.RetailerCode=B.RetailerCode and A.CmpRtrCode=B.CmpRtrCode)	
			AND NOT EXISTS(SELECT RetailerCode,RtrUniqueCode FROM #DuplicateRetailers1 C WHERE A.RetailerCode=C.RetailerCode and A.RtrUniqueCode=C.RtrUniqueCode)	


			SELECT DISTINCT RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3
			INTO #TempMigrateRetailerExisting FROM Cn2Cs_Prk_RetailerReDownload A WITH (NOLOCK)  WHERE DownLoadFlag = 'D'
			AND  EXISTS(SELECT RetailerCode,CmpRtrCode FROM #DuplicateRetailers B WHERE A.RetailerCode=B.RetailerCode and A.CmpRtrCode=B.CmpRtrCode)	
			AND EXISTS(SELECT RetailerCode,RtrUniqueCode FROM #DuplicateRetailers1 C WHERE A.RetailerCode=C.RetailerCode and A.RtrUniqueCode=C.RtrUniqueCode)	

	
			--Check Cmp Retailer Code --> Join Check RtrCode?
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'RetailerMigration','CmpRtrCode','Retailer '+B.CmpRtrCode+' Already Exists' FROM Retailer A (NOLOCK)  
			INNER JOIN #TempMigrateRetailer B (NOLOCK) ON A.CmpRtrCode = B.CmpRtrCode AND A.RtrCode = B.RetailerCode 			
			
			DELETE B FROM Retailer A
			INNER JOIN #TempMigrateRetailer B ON A.CmpRtrCode = B.CmpRtrCode AND A.RtrCode = B.RetailerCode	
			
			--Retailer Code Length
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode','Retailer Code '+RetailerCode+' Maximum Length should be 25' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RetailerCode)))>25
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RetailerCode)))>25
			
			--Retailer Code Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','RetailerCode','Company Retailer Code for '+RetailerCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RetailerCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RetailerCode)))<=0
			
			--Company Retailer Code Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','Company RetailerCode','Company Retailer Code for '+CmpRtrCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(CmpRtrCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(CmpRtrCode)))<=0
			
			
			--RtrUniqueCode Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 2,'Retailer','Company RetailerCode','Retailer Unique Code for '+RtrUniqueCode+' is mandatory for Restored retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(RtrUniqueCode)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(RtrUniqueCode)))<=0
			
			--Retailer Category CHANNEL
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Category Code '+RtrChannelCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel  C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrChannelCode=B.CtgCode AND UPPER(C.CtgLevelName)='CHANNEL') 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel C  (NOLOCK)ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrChannelCode=B.CtgCode AND UPPER(C.CtgLevelName)='CHANNEL') 
			
			--Retailer Category GROUP
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Group Code '+RtrGroupCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrGroupCode=B.CtgCode AND UPPER(C.CtgLevelName)='GROUP') 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT CtgCode FROM RetailerCategory B (NOLOCK) 
			INNER JOIN RetailerCategoryLevel  C (NOLOCK) ON C.CtgLevelId=B.CtgLevelId
			WHERE A.RtrGroupCode=B.CtgCode AND UPPER(C.CtgLevelName)='GROUP')
						
			--Retailer Value Class
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 5,'Retailer Category','Catagory Code','Value Class Code '+RtrClassCode+' does not exists' 
			FROM #TempMigrateRetailer A (NOLOCK) WHERE NOT EXISTS(SELECT ValueClassCode FROM RetailerValueClass B (NOLOCK) 			
			WHERE A.RtrClassCode=B.ValueClassCode) 
			
			DELETE A FROM #TempMigrateRetailer A WHERE NOT EXISTS(SELECT ValueClassCode FROM RetailerValueClass B (NOLOCK) 			
			WHERE A.RtrClassCode=B.ValueClassCode)  
			
			--INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			--SELECT 9,'Retailer','MigrateDate','Migrate Date for '+CmpRtrCode+' is mandatory for Migrated/Restored retailers' 
			--FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(MigrateDate)))<=0 
			--DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(MigrateDate)))<=0 
			
			--Sales Route Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 10,'Retailer','RmCode','Sales Route for '+CmpRtrCode+' is mandatory for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(SalesRoute)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(SalesRoute)))<=0
			
			--Delivery Route Blank
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 11,'Retailer','DRmCode','Delivery Route for '+CmpRtrCode+' is mandatory for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE LEN(LTRIM(RTRIM(DeliveryRoute)))<=0
			
			DELETE FROM #TempMigrateRetailer WHERE LEN(LTRIM(RTRIM(DeliveryRoute)))<=0
			
			--Sales Route --> Route Master
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 12,'Retailer','RmCode','Sales Route for '+CmpRtrCode+' does not exists for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE SalesRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1 AND RMSRouteType = 1) 
			
			DELETE FROM #TempMigrateRetailer WHERE SalesRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1 AND RMSRouteType = 1)
			
			--Delivery Route -->Route Master
			INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)
			SELECT 13,'Retailer','DRmCode','Delivery Route for '+CmpRtrCode+' does not exists for Migrated retailers' 
			FROM #TempMigrateRetailer (NOLOCK) WHERE DeliveryRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1) 
			
			DELETE FROM #TempMigrateRetailer WHERE DeliveryRoute NOT IN (SELECT RMCode FROM RouteMaster WHERE RmStatus = 1)	
			--Take Geography Details
			CREATE TABLE #Geography
			(
				RtrCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				RmId			INT,
				RmCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
				GeoMainid		INT,
				GeoLevelId		INT,
				GeoName			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				GeoLevelName	NVARCHAR(200) COLLATE DATABASE_DEFAULT
			)
			
			INSERT INTO #Geography (RtrCode,RmId,RmCode,GeoMainid,GeoLevelId,GeoName,GeoLevelName)
			SELECT DISTINCT A.RetailerCode,R.RMId,R.RMCode,B.GeoMainId,C.GeoLevelId,B.GeoName,C.GeoLevelName 
			FROM #TempMigrateRetailer A (NOLOCK)
				INNER JOIN RouteMaster R (NOLOCK) ON A.SalesRoute=R.RMCode
				INNER JOIN Geography B (NOLOCK) ON R.GeoMainId=B.GeoMainId AND RMSRouteType=1
				INNER JOIN GeographyLevel C (NOLOCK) ON B.GeoLevelId=C.GeoLevelId
			
			
			--Take Delivery Route
			CREATE TABLE #DeliveryRoute
			(
				RtrCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				RmId			INT,
				RmCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT
			)
			
			INSERT INTO #DeliveryRoute (RtrCode,RmId,RmCode)
			SELECT DISTINCT A.RetailerCode,R.RMId,R.RMCode
			FROM #TempMigrateRetailer A (NOLOCK)
				INNER JOIN RouteMaster R (NOLOCK) ON A.DeliveryRoute=R.RMCode AND RMSRouteType=2
				
			SET @RtrId=ISNULL(@RtrId,0)
			
						
			----(CASE R.RtrType WHEN 1 THEN 'Retailer' WHEN 2 THEN 'Sub Stockist' WHEN 3 THEN 'Hub' WHEN 4 THEN 'Spoke' ELSE 'Distributor' END)
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,RtrContactPerson,
			RtrKeyAcc,RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrCSTNo,RtrDepositAmt,
			RtrCrBills,RtrCrLimit,RtrCrDays,RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,RtrLicNo,RtrLicExpiryDate,
			RtrDrugLicNo,RtrDrugExpiryDate,RtrPestLicNo,RtrPestExpiryDate,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrResPhone1,
			RtrResPhone2,RtrOffPhone1,RtrOffPhone2,RtrDOB,RtrAnniversary,RtrRemark1,RtrRemark2,RtrRemark3,CoaId,RtrOnAcc,RtrType,RtrFrequency,
			RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,
			Approved,XMLUpload,RtrPayment,RtrUniqueCode)
			SELECT @RtrId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),
			RetailerCode,RetailerName,ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),
			ISNULL(RtrAddress3,''),ISNULL(RtrPinNo,''),ISNULL(RtrPhoneNo,''),'' AS RtrEmailId,ISNULL(RtrContactPerson,''),
			(CASE ISNULL(KeyAccount,'NO') WHEN 'NO' THEN 0 ELSE 1 END) AS KeyAccount,
			1,CONVERT(VARCHAR(10),CAST(RtrRegDate as datetime),121),ISNULL(RtrDayOff,0),ISNULL(RtrStatus,1),(CASE ISNULL(RtrTaxable,'Y') WHEN 'Y' THEN 1 ELSE 1 END) AS RtrTaxable,
			(CASE ISNULL(RtrTINNo,'') WHEN '' THEN 1 ELSE 0 END) AS RtrTaxType,ISNULL(RtrTINNo,'') AS RtrTINNo,ISNULL(RtrCSTNo,'') AS RtrCSTNo,0,ISNULL(RtrCrBills,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0),
			0,0,0,'','','','','','',ISNULL(#Geography.GeoMainid,0),ISNULL(#DeliveryRoute.RmId,0),0 VillageId,0 RtrShipId,0 TaxGroupId,'',
			'','','',GETDATE(),GETDATE(),'','','',0 AS CoaId,0,CASE RtrType WHEN 'Retailer' THEN 1 WHEN 'Sub Stockist' THEN  2 WHEN  'Hub' THEN 3 WHEN 'Spoke'  THEN  3 ELSE 0 END as RtrType,0, --ISNULL(RtrType,1),0,
			0,0,0,'N',CASE ISNULL(RelationStatus,'INDEPENDENT') WHEN 'PARENT' THEN 2 WHEN 'CHILD' THEN 3  ELSE 1 END AS RelationStatus,
						1,1,GETDATE(),1,GETDATE(),CmpRtrCode,CASE ISNULL(Approved,'APPROVED') WHEN 'APPROVED' THEN 1 WHEN 'PENDING' THEN 0  ELSE 2 END Approved,0,1,RtrUniqueCode
			 FROM #TempMigrateRetailer A (NOLOCK)
			LEFT OUTER JOIN #Geography ON A.RetailerCode =#Geography.RtrCode AND A.SalesRoute=#Geography.RmCode
			INNER JOIN #DeliveryRoute ON A.RetailerCode = #DeliveryRoute.RtrCode
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0
			
			
			DECLARE @TrackID as BIGINT			
			SELECT @TrackID=MAX(ISNULL(TrackID,0)) FROM RetailerReDownloadTracking
			
			INSERT INTO RetailerReDownloadTracking (TrackID,RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,CreatedDate)
			SELECT DISTINCT ISNULL(@TrackID,0)+1,RetailerCode,CmpRtrCode,RetailerName,RtrAddress1,RtrAddress2,
			RtrAddress3,RtrPinNo,RtrChannelCode,RtrGroupCode,RtrClassCode,KeyAccount,RelationStatus,ParentCode,RtrRegDate,RtrStatus,
			Approved,SalesRoute,DeliveryRoute,RtrType,RtrTINNo,RtrCrBills,RtrCrLimit,RtrCrDays,RtrDayOff,RtrCSTNo,RtrPhoneNo,
			RtrContactPerson,RtrTaxGroup,RtrTaxable,RtrUniqueCode,RtrShippAdd1,RtrShippAdd2,RtrShippAdd3,GETDATE()
			FROM #TempMigrateRetailer 
			
			--------------Added By lakshman M Dated ON 09082019 PMS ID: ILCRSTPAR5462  (Retailer Market Old Route Bakup and New route updating.) ---------------- 
			INSERT INTO RetailerMarketOldRouteTrack (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload,LastRouteRemoveddate)
			SELECT Distinct  A.*,GETDATE() FROM retailermarket A INNER JOIN Retailer B ON A.Rtrid =b.rtrid 
			--left outer JOin RouteMaster C ON A.Rmid =C.Rmid 
			INNER JOIN #TempMigrateRetailerExisting D ON B.rtrCode =D.RetailerCode 
			inner join RouteMaster C ON C.RmCode =D.SalesRoute AND  EXISTS (SELECT * FROM Retailermarket R WHERE R.Rmid = A.Rmid ANd R.Rtrid =A.Rtrid )
	
			DELETE A FROM RetailerMarket A  inner join RetailerMarketOldRouteTrack B ON A.Rtrid =B.Rtrid --And A.Rmid=B.RMId

			INSERT INTO RetailerMarket (RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
			SELECT Distinct B.Rtrid,ISNULL(C.Rmid,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),0 
			FROM RetailerMarketOldRouteTrack A (NOLOCK) INNER JOIN Retailer B (NOLOCK) ON A.Rtrid =b.rtrid 
			--left outer JOin RouteMaster C ON A.Rmid =C.Rmid 
			INNER JOIN #TempMigrateRetailerExisting D ON B.rtrCode =D.RetailerCode 
			inner join RouteMaster C (NOLOCK) ON C.RmCode =D.SalesRoute AND EXISTS (SELECT * FROM RetailerMarketOldRouteTrack R WHERE  R.Rtrid =A.Rtrid )
			-------------------------- Till here  PMS ID: ILCRSTPAR5462 -----------------------------------------------------

			--Retailer Market
			INSERT INTO RetailerMarket(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
			SELECT R.RtrId,ISNULL(#Geography.RmId,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),0
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			LEFT OUTER JOIN #Geography ON R.RtrCode =#Geography.RtrCode 
			
			--Retailer Value Class
			CREATE TABLE #RetailerDet
			(
				RetailerCode		NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				ChannelCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
				GroupCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,				
				ValueClassCode		NVARCHAR(100) COLLATE DATABASE_DEFAULT,				
				RtrClassId			INT,
				CtgMainId			INT,
				CtgLinkId			INT,
				CtgLevelId			INT,		
				CtgLinkCode			NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				CtgLevelName		NVARCHAR(200) COLLATE DATABASE_DEFAULT,
				CmpId				INT,		
				CmpName				NVARCHAR(200) COLLATE DATABASE_DEFAULT
			)
	
	
			INSERT INTO #RetailerDet (RetailerCode,ChannelCode,GroupCode,ValueClassCode,RtrClassId,CtgMainId,CtgLinkId,CtgLevelId,CtgLinkCode,
									  CtgLevelName,CmpId,CmpName)
			SELECT DISTINCT TR.RetailerCode,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode,RVC.ValueClassCode,
			RVC.RtrClassId,RC.CtgMainId,RC.CtgLinkId,RC.CtgLevelId,RC.CtgLinkCode,RCL.CtgLevelName,C.CmpId,C.CmpName
				FROM
				RetailerValueClass RVC,
				RetailerCategory RC,
				RetailerCategoryLevel RCL,
				RetailerCategory RC1,
				Cn2Cs_Prk_RetailerReDownload TR,
				Company C
			WHERE RVC.CtgMainId=RC.CtgMainId
				AND	RCL.CtgLevelId=RC.CtgLevelId
				AND	RC.CtgLinkId = RC1.CtgMainId				
				AND TR.RtrClassCode=RVC.ValueClassCode			
				AND RC.CtgCode=TR.RtrGroupCode
				AND C.CmpId=RCL.CmpId AND C.DefaultCompany=1
				
					
			INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT R.RtrId,ISNULL(#RetailerDet.RtrClassId,0),1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			LEFT OUTER JOIN #RetailerDet ON R.RtrCode =#RetailerDet.RetailerCode
			--Till Here
			
			--RetailerShipAdd
			INSERT INTO RetailerShipAdd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,RtrShipDefaultAdd,
			Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT @RtrShipAddId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),@RtrId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),
			A.RtrShippAdd1,A.RtrShippAdd2,A.RtrShippAdd3,'','',
			1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM Retailer R (NOLOCK)
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 
			
			UPDATE A SET A.RtrShipId=B.RtrShipId FROM Retailer A(NOLOCK) 			
			INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId 
			
			--UPDATE R SET R.VillageId=B.VillageId FROM Retailer R(NOLOCK) 			
			--INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 		
			--INNER JOIN RouteVillage B (NOLOCK) ON B.VillageCode=A.VillageCode 
			
			UPDATE R SET R.TaxGroupId=B.TaxGroupId FROM Retailer R(NOLOCK) 			
			INNER JOIN #TempMigrateRetailer A (NOLOCK) ON R.RtrCode = A.RetailerCode AND R.CmpRtrCode = A.CmpRtrCode 		
			INNER JOIN TaxGroupSetting B (NOLOCK) ON B.RtrGroup=A.RtrTaxGroup 
			
			--CoaMaster
			CREATE TABLE #TempCoaMaster
				(
					CoaId		INT,
					AcCode		VARCHAR(100),
					RtrCode		VARCHAR(100),
					CmpRtrCode	VARCHAR(100),
					RetailerName VARCHAR(200)	
				)
			
			INSERT INTO #TempCoaMaster(CoaId,AcCode,RtrCode,CmpRtrCode,RetailerName)
			SELECT @CoaId + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),@AccCode + ROW_NUMBER() OVER (ORDER BY RetailerCode,RetailerName),RetailerCode,R.CmpRtrCode,RetailerName
			FROM #TempMigrateRetailer A
			INNER JOIN Retailer R WITH (NOLOCK) ON A.RetailerCode = R.RtrCode AND A.CmpRtrCode = R.CmpRtrCode
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0 
			
			--Coa Master
			INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT CoaId,AcCode,RetailerName,4,2,2,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM #TempCoaMaster
			
			UPDATE A SET A.CoaId=R.CoaId FROM Retailer A
			INNER JOIN #TempCoaMaster R WITH (NOLOCK) ON A.RtrCode = R.RtrCode AND A.CmpRtrCode = R.CmpRtrCode
			
			--UPDATE COUNTERS
			SELECT @CoaID = ISNULL(MAX(CoaID),0) FROM COAMaster 	
			UPDATE Counters SET CurrValue = @CoaID WHERE TabName = 'COAMaster'
			
			
			SELECT @RtrShipAddId = ISNULL(MAX(RtrShipId),0) FROM RetailerShipAdd
			UPDATE Counters SET CurrValue = @RtrShipAddId WHERE TabName = 'RetailerShipAdd'
			
			SELECT @RtrID = ISNULL(MAX(RtrId),0) FROM Retailer
			UPDATE Counters SET CurrValue = @RtrID WHERE TabName = 'Retailer' AND FldName = 'RtrId'
			
			--Update CompanyCounters 
			IF EXISTS(SELECT 7 FROM Cn2Cs_Prk_RetailerReDownload P (NOLOCK))
			BEGIN
				SELECT Prefix,CurYear,MAX(REPLACE(CmpRtrCode,(Prefix+RIGHT(CurYear,2)),0)) CurValue
				INTO #UpdatingCompanyCounters
				FROM CompanyCounters C (NOLOCK)
				INNER JOIN Retailer R (NOLOCK) ON R.CmpRtrCode LIKE (C.Prefix+RIGHT(C.CurYear,2))+'%'
				WHERE TabName = 'Retailer' AND FldName = 'CmpRtrCode' --AND CurrValue = 0
				GROUP BY Prefix,CurYear
				
				UPDATE T SET T.CurrValue = F.CurValue
				FROM #UpdatingCompanyCounters F (NOLOCK)
				INNER JOIN CompanyCounters T (NOLOCK) ON F.Prefix = T.Prefix AND F.CurYear = T.CurYear
			END
			
			IF EXISTS(SELECT '*' FROM Cn2Cs_Prk_RetailerGST(NOLOCK) WHERE ISNULL(DownLoadFlag,'D')='D')
			BEGIN
				EXEC Proc_Cn2Cs_RetailerGST 0
			END
			
			UPDATE A SET A.DownloadFlag='Y' FROM Cn2Cs_Prk_RetailerReDownload A (NOLOCK) 
			INNER JOIN Retailer B (NOLOCK) ON A.RetailerCode=B.RtrCode AND A.CmpRtrCode = B.CmpRtrCode 
			WHERE LEN(RetailerCode) > 0 AND LEN(RetailerName) > 0 AND LEN(A.CmpRtrCode) > 0 AND DownloadFlag = 'D' 
	
	END TRY
	BEGIN CATCH
		SET @Po_ErrNo=1
		SELECT ERROR_LINE(),ERROR_MESSAGE ()
	END CATCH
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_ContractPricing_Detail_Zero_percent')
BEGIN
CREATE TABLE [Cn2Cs_Prk_ContractPricing_Detail_Zero_percent](
	[DistCode] [nvarchar](50) NULL,
	[CPRefCode] [nvarchar](50) NULL,
	[PrdCatLvl] [nvarchar](25) NULL,
	[PrdCatCode] [nvarchar](100) NULL,
	[ApplyOn] [nvarchar](50) NULL,
	[DiscPer] [numeric](18, 2) NULL,
	[FlatAmt] [numeric](18, 2) NULL,
	[SplPrice] [numeric](18, 2) NULL,
	[SPWTax] [nvarchar](10) NULL,
	[DownloadFlag] [nvarchar](5) NULL,
	[CreatedDate] [datetime] NULL
)
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='SpecialDiscountDownload_track' AND TYPE ='U')
BEGIN
CREATE TABLE SpecialDiscountDownload_track
(
	Slno INt,
	Productcode Nvarchar(100),
	ProductBatch Nvarchar(100),
	ErrorDescription Nvarchar(250),
	Createddate Datetime,
	CpRefcode varchar(100)
	
)
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE name='ContractPricingTraceRePush' AND xtype='U')
BEGIN
CREATE TABLE ContractPricingTraceRePush(
	[ReferenceNo] [varchar](50) NULL,
	[UploadDate] DATETIME NULL
) ON [PRIMARY]
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ContractPricingTraceRePush' and xtype='P')
DROP PROCEDURE Proc_ContractPricingTraceRePush
GO
/*
BEGIN TRAN
 INSERT INTO Console2CS_Consolidated_Trace   
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock)
 
 --UPDATE A SET SYNCID=385 FROM Console2CS_Consolidated_Trace A (NOLOCK) WHERE PROCESSNAME ='DiscountHeader' AND Column3='DISC00000031'
 --UPDATE A SET SYNCID=385 FROM Console2CS_Consolidated_Trace A (NOLOCK) WHERE PROCESSNAME ='DiscountDetail' AND Column3='DISC00000031'
SELECT * FROM Console2CS_Consolidated_Trace A (NOLOCK) WHERE PROCESSNAME ='DiscountHeader' AND Column3='DISC00000031'
	
update a set comconrefno='DISC00000031002' from ContractPricingMaster a where comconrefno='DISC00000031'
--SELECT * FROM Cn2Cs_Prk_SpecialDiscount WHERE CPREFCODE='DISC00000031'
DELETE FROM Cn2Cs_Prk_ContractPricing_Header 
DELETE FROM Cn2Cs_Prk_ContractPricing_Detail
EXEC Proc_ContractPricingTraceRePush 
SELECT * FROM Cn2Cs_Prk_ContractPricing_Header
SELECT * FROM Cn2Cs_Prk_ContractPricing_Detail

EXEC Proc_Cn2Cs_DiscountMaster 0
EXEC Proc_Cn2Cs_SpecialDiscount 0

select * from contractpricingmaster where comconrefno='DISC00000031'
select * from contractpricingdetails where contractId in (select contractId from contractpricingmaster where comconrefno='DISC00000031')
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_ContractPricingTraceRePush
AS
/***************************************************************************************************
* Procedure: Proc_ContractPricingTraceRePush
* Purpose  : To Contract Pricing Trace Re Push
* Created  :  
* Modified
'****************************************************************************************************************************
' Version       Date        Person          User Story ID    CR/BZ     Remarks          Code Review By   Review Date
  442			16/08/2019  S.MOORTHI		ILCRSTPAR5558	  BZ	  Missing Contract Pricing details move from Trace Table
*****************************************************************************************************************************/
BEGIN
	
	/*
	Note : InActive ReferenceNo don't Consider : 'DISC00000108','DISC00000002','DISC00000123','DISC00000022'
	*/

	CREATE TABLE #Temp
	(
		PROCESSNAME	VARCHAR(100),
		RefNo		varchar(100),
		SYNCID		NUMERIC(18,0),
		CreatedDate	DATETIME
	)

	CREATE TABLE #Temp2
	(
		PROCESSNAME	VARCHAR(100),
		RefNo		varchar(100),
		SYNCID		NUMERIC(18,0),
		CreatedDate	DATETIME
	)

	CREATE TABLE #AvailableContract
	(
		RefNo		varchar(100)
	)

	BEGIN TRY
	

		INSERT INTO #Temp2(PROCESSNAME,RefNo,CreatedDate,SYNCID)
		SELECT DISTINCT PROCESSNAME,A.Column2,PROCESSDATE,MAX(SYNCID) AS SYNCID FROM Console2CS_Consolidated_Trace A (NOLOCK) 
		WHERE PROCESSNAME ='DiscountDetail' and A.Column2 NOT IN ('DISC00000108','DISC00000002','DISC00000123','DISC00000022')
		GROUP BY PROCESSNAME,A.Column2,PROCESSDATE

		INSERT INTO #Temp2(PROCESSNAME,RefNo,CreatedDate,SYNCID)
		SELECT DISTINCT PROCESSNAME,A.Column3,PROCESSDATE,MAX(SYNCID) AS SYNCID FROM Console2CS_Consolidated_Trace A (NOLOCK) 
		WHERE PROCESSNAME ='DiscountHeader' and A.Column3 NOT IN ('DISC00000108','DISC00000002','DISC00000123','DISC00000022')
		GROUP BY PROCESSNAME,A.Column3,PROCESSDATE

		
		INSERT INTO #Temp(PROCESSNAME,RefNo,SYNCID,CreatedDate)
		SELECT PROCESSNAME,RefNo,SYNCID,MAX(CreatedDate) AS PROCESSDATE  FROM #Temp2 
		GROUP BY PROCESSNAME,RefNo,SYNCID


		--DiscountDetail
		INSERT INTO #AvailableContract(RefNo)
		SELECT DISTINCT ComConRefNo FROM ContractPricingMaster A (NOLOCK) WHERE LEN(LTRIM(RTRIM(ISNULL(ComConRefNo,''))))>0
		UNION
		SELECT DISTINCT CPRefCode as ComConRefNo FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE LEN(LTRIM(RTRIM(ISNULL(CPRefCode,''))))>0 and DownloadFlag='D'
		UNION
		SELECT DISTINCT CPRefCode as ComConRefNo FROM Cn2Cs_Prk_ContractPricing_Header A (NOLOCK) WHERE DownloadFlag='D'
		UNION
		SELECT DISTINCT CPRefCode as ComConRefNo FROM Cn2Cs_Prk_ContractPricing_Detail A (NOLOCK)WHERE DownloadFlag='D'


		SELECT DISTINCT B.* INTO #TempHeader  FROM #Temp A
		INNER JOIN Console2CS_Consolidated_Trace B (NOLOCK) ON A.ProcessName=B.ProcessName and A.SyncId=B.SyncId AND A.CreatedDate=PROCESSDATE 
		WHERE A.PROCESSNAME='DiscountHeader' 

		SELECT DISTINCT B.* INTO #TempDetail  FROM #Temp A
		INNER JOIN Console2CS_Consolidated_Trace B (NOLOCK) ON A.ProcessName=B.ProcessName and A.SyncId=B.SyncId AND A.CreatedDate=PROCESSDATE 
		WHERE A.PROCESSNAME='DiscountDetail' 
		
		INSERT INTO ContractPricingTraceRePush(ReferenceNo,UploadDate)
		SELECT DISTINCT A.Column3,GETDATE() FROM #TempHeader A 
		INNER JOIN #TempDetail B ON A.Column3=B.Column2
		WHERE NOT EXISTS(SELECT * FROM #AvailableContract C WHERE A.Column3=C.RefNo AND B.Column2=C.RefNo)
		

		INSERT INTO Cn2Cs_Prk_ContractPricing_Header(DistCode,CMPCode,CPRefCode,CPRefName,EffFromDate,EffToDate,DiscType,
		RtrType,CPStatus,RtrCatLvl,RtrCatCode,ClassCode,RtrCode,ProductLvl,DownloadFlag,CreatedDate,IONumber)
		SELECT DISTINCT A.Column1,A.Column2,A.Column3,A.Column4,CONVERT(DATETIME,A.Column5,121),CONVERT(DATETIME,A.Column6,121),A.Column7,
		A.Column8,A.Column9,A.Column10,A.Column11,A.Column12,A.Column13,
		A.Column14,'D' Column15,CONVERT(DATETIME,GETDATE(),121),A.Column17 FROM #TempHeader A 
		INNER JOIN #TempDetail B ON A.Column3=B.Column2
		WHERE NOT EXISTS(SELECT * FROM #AvailableContract C WHERE A.Column3=C.RefNo AND B.Column2=C.RefNo)


		INSERT INTO Cn2Cs_Prk_ContractPricing_Detail(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,
		SPWTax,DownloadFlag,CreatedDate)
		SELECT DISTINCT B.Column1,B.Column2,B.Column3,B.Column4,B.Column5,B.Column6,B.Column7,
		B.Column8,B.Column9,'D' Column10,CONVERT(DATETIME,GETDATE(),121) FROM #TempHeader A 
		INNER JOIN #TempDetail B ON A.Column3=B.Column2
		WHERE NOT EXISTS(SELECT * FROM #AvailableContract C WHERE A.Column3=C.RefNo AND B.Column2=C.RefNo)
		
		IF EXISTS(SELECT * FROM #TempHeader)
		BEGIN
			EXEC Proc_Cn2Cs_DiscountMaster 0
			EXEC Proc_Cn2Cs_SpecialDiscount 0
		END
		
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
	END CATCH

RETURN
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE NAMe='Proc_Console2CS_ConsolidatedDownload' AND type ='P')
DROP PROCEDURE Proc_Console2CS_ConsolidatedDownload
GO
CREATE PROCEDURE Proc_Console2CS_ConsolidatedDownload
As  
/*
**************************************************************************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
**************************************************************************************************
23/01/2018  Gowsalya S   Issue          ICONSWIP1888            SyncStatus has been updated as 1 for incomplete sync
20-08-2019  Lakshman M   SR             ILCRSTPAR5587           script has been prepared to avoid the Special discount process while moving data from consolidated to parking table.  
*/
Begin  
BEGIN TRY    
SET XACT_ABORT ON    
BEGIN TRANSACTION
Declare @Lvar Int  
Declare @MaxId Int  
Declare @SqlStr Varchar(8000)  
Declare @Process Varchar(100)  
Declare @colcount Int  
Declare @Col Varchar(5000)  
Declare @Tablename Varchar(100)  
Declare @Sequenceno Int  
 Create Table #Col (ColId int)  
 CREATE TABLE #Console2CS_Consolidated  
 (  
  [SlNo] [numeric](38, 0) NULL, [DistCode] [VARCHAR](200) COLLATE Database_Default NULL, [SyncId] [numeric](38, 0) NULL,  
  [ProcessName] [VARCHAR](200) COLLATE Database_Default NULL, [ProcessDate] [datetime] NULL, 
  [Column1] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column2] [VARCHAR](200) COLLATE Database_Default NULL, [Column3] [VARCHAR](200) COLLATE Database_Default NULL, [Column4] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column5] [VARCHAR](200) COLLATE Database_Default NULL, [Column6] [VARCHAR](200) COLLATE Database_Default NULL, [Column7] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column8] [VARCHAR](200) COLLATE Database_Default NULL, [Column9] [VARCHAR](200) COLLATE Database_Default NULL, [Column10] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column11] [VARCHAR](200) COLLATE Database_Default NULL, [Column12] [VARCHAR](200) COLLATE Database_Default NULL, [Column13] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column14] [VARCHAR](200) COLLATE Database_Default NULL, [Column15] [VARCHAR](200) COLLATE Database_Default NULL, [Column16] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column17] [VARCHAR](200) COLLATE Database_Default NULL, [Column18] [VARCHAR](200) COLLATE Database_Default NULL, [Column19] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column20] [VARCHAR](200) COLLATE Database_Default NULL, [Column21] [VARCHAR](200) COLLATE Database_Default NULL, [Column22] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column23] [VARCHAR](200) COLLATE Database_Default NULL, [Column24] [VARCHAR](200) COLLATE Database_Default NULL, [Column25] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column26] [VARCHAR](200) COLLATE Database_Default NULL, [Column27] [VARCHAR](200) COLLATE Database_Default NULL, [Column28] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column29] [VARCHAR](200) COLLATE Database_Default NULL, [Column30] [VARCHAR](200) COLLATE Database_Default NULL, [Column31] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column32] [VARCHAR](200) COLLATE Database_Default NULL, [Column33] [VARCHAR](200) COLLATE Database_Default NULL, [Column34] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column35] [VARCHAR](200) COLLATE Database_Default NULL, [Column36] [VARCHAR](200) COLLATE Database_Default NULL, [Column37] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column38] [VARCHAR](200) COLLATE Database_Default NULL, [Column39] [VARCHAR](200) COLLATE Database_Default NULL, [Column40] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column41] [VARCHAR](200) COLLATE Database_Default NULL, [Column42] [VARCHAR](200) COLLATE Database_Default NULL, [Column43] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column44] [VARCHAR](200) COLLATE Database_Default NULL, [Column45] [VARCHAR](200) COLLATE Database_Default NULL, [Column46] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column47] [VARCHAR](200) COLLATE Database_Default NULL, [Column48] [VARCHAR](200) COLLATE Database_Default NULL, [Column49] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column50] [VARCHAR](200) COLLATE Database_Default NULL, [Column51] [VARCHAR](200) COLLATE Database_Default NULL, [Column52] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column53] [VARCHAR](200) COLLATE Database_Default NULL, [Column54] [VARCHAR](200) COLLATE Database_Default NULL, [Column55] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column56] [VARCHAR](200) COLLATE Database_Default NULL, [Column57] [VARCHAR](200) COLLATE Database_Default NULL, [Column58] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column59] [VARCHAR](200) COLLATE Database_Default NULL, [Column60] [VARCHAR](200) COLLATE Database_Default NULL, [Column61] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column62] [VARCHAR](200) COLLATE Database_Default NULL, [Column63] [VARCHAR](200) COLLATE Database_Default NULL, [Column64] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column65] [VARCHAR](200) COLLATE Database_Default NULL, [Column66] [VARCHAR](200) COLLATE Database_Default NULL, [Column67] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column68] [VARCHAR](200) COLLATE Database_Default NULL, [Column69] [VARCHAR](200) COLLATE Database_Default NULL, [Column70] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column71] [VARCHAR](200) COLLATE Database_Default NULL, [Column72] [VARCHAR](200) COLLATE Database_Default NULL, [Column73] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column74] [VARCHAR](200) COLLATE Database_Default NULL, [Column75] [VARCHAR](200) COLLATE Database_Default NULL, [Column76] [VARCHAR](200) COLLATE Database_Default NULL,   
  [Column77] [VARCHAR](200) COLLATE Database_Default NULL, [Column78] [VARCHAR](200) COLLATE Database_Default NULL, [Column79] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column80] [VARCHAR](200) COLLATE Database_Default NULL, [Column81] [VARCHAR](200) COLLATE Database_Default NULL, [Column82] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column83] [VARCHAR](200) COLLATE Database_Default NULL, [Column84] [VARCHAR](200) COLLATE Database_Default NULL, [Column85] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column86] [VARCHAR](200) COLLATE Database_Default NULL, [Column87] [VARCHAR](200) COLLATE Database_Default NULL, [Column88] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column89] [VARCHAR](200) COLLATE Database_Default NULL, [Column90] [VARCHAR](200) COLLATE Database_Default NULL, [Column91] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column92] [VARCHAR](200) COLLATE Database_Default NULL, [Column93] [VARCHAR](200) COLLATE Database_Default NULL, [Column94] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column95] [VARCHAR](200) COLLATE Database_Default NULL, [Column96] [VARCHAR](200) COLLATE Database_Default NULL, [Column97] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column98] [VARCHAR](200) COLLATE Database_Default NULL, [Column99] [VARCHAR](200) COLLATE Database_Default NULL, [Column100] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Remarks1] [VARCHAR](200) COLLATE Database_Default NULL, [Remarks2] [VARCHAR](200) COLLATE Database_Default NULL, [DownloadFlag] [VARCHAR](1) COLLATE Database_Default NULL,  
  DWNStatus INT
 )   
 INSERT INTO Console2CS_Consolidated_Trace 
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y'
 DELETE FROM Console2CS_Consolidated_Trace where CONVERT (DATETIME,[Downloaded Date],121)<=Convert(DATETIME,GETDATE()-15,121)
 Delete A From Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y' 
 ---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Console2CS_Consolidated'
	And A.system_type_id = C.system_type_id And C.name='varchar'
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ----------------------------------
	
	SELECT Distinct DistCode, SyncId Into #IncompleteSync  FROM Console2CS_Consolidated (NOLOCK) WHERE DownloadFlag='N'  
	
	Select A.DistCode , A.SyncId , MAX(CreatedDate) CreatedDate Into #MaxDate
	 from SyncStatus_Download_Archieve A(Nolock), #IncompleteSync B
	Where A.DistCode = B.DistCode And A.SyncId = B.SyncId 
	Group by  A.DistCode , A.SyncId
	
	Update A Set SyncStatus =1 From
	SyncStatus_Download_Archieve A (Nolock) , 
	#MaxDate B
	Where A.DistCode = B.DistCode And A.Syncid = B.Syncid And A.CreatedDate = B.CreatedDate 
 ------------------------------------
	
 Insert Into #Console2CS_Consolidated  
 Select *,0 as DWNStatus from Console2CS_Consolidated (Nolock) Where DownloadFlag In ('D','N')
   Update A Set A.DWNStatus = 1  
   From  
    #Console2CS_Consolidated A (NOLOCK),  
    (  
     SELECT   
     DistCode,SyncId   
     FROM   
     SyncStatus_Download (NOLOCK)  
     WHERE       
     SyncStatus = 1 AND SyncId > 0  
     UNION  
     SELECT   
     DistCode,SyncId  
     FROM   
     SyncStatus_Download_Archieve (NOLOCK)  
     WHERE  
     SyncStatus = 1 AND SyncId > 0  
    ) B  
   Where   
    A.DistCode = B.DistCode AND   
    A.SyncId = B.SyncId   
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
 -- Purchase Trace Ends here
 Delete A From #Console2CS_Consolidated A (Nolock) Where DWNStatus = 0 
 Create Table #Process(ProcessName Varchar(100),PrkTableName Varchar(100), id Int Identity(1,1) )  
 Insert Into #Process(ProcessName , PrkTableName)   
 Select Distinct A.ProcessName , A.PrkTableName From Tbl_DownloadIntegration A,#Console2CS_Consolidated B   
 Where A.ProcessName = B.ProcessName And A.SequenceNo not in(100000) AND A.Processname NOT IN('SpecialDiscount')  --Order By Sequenceno   -- Added by lakshman M Dated ON PMS : ILCRSTPAR5587

  Set @Lvar = 1  
  Select @MaxId = Max(id) From #Process  
  While @Lvar <= @MaxId  
   Begin  
    Select @Tablename = PrkTableName , @Process = ProcessName From #Process Where id  = @Lvar  
    Select @colcount = Count(Column_ID) From sys.columns Where object_id = (select object_id From sys.objects Where name = @Tablename)  
    Set @SqlStr = ''  
    Set @SqlStr = @SqlStr + ' Insert Into ' + @Tablename + ' '  
    Set @Col = ''  
    select @Col = @Col + '[' +name + '],' From sys.columns   
    where object_id = ( select object_id From sys.objects Where name = @Tablename) Order by Column_Id  
    Truncate Table #Col      
    Insert Into #Col     
    Select  a.column_id + 5 As ColId  
    From sys.columns a,sys.types b where a.user_type_id = b.user_type_id  
    and a.object_id = ( Select object_id From sys.objects Where name = @Tablename)  
    and b.name = 'datetime' --and a.name <> 'CreatedDate'  
    Set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ') '  
    Set @Col = ''  
    Select @Col = @Col + (Case when column_id In (Select ColId From #Col) then 'Convert(Datetime,'+name + ',121)' else name end) + ','   
    From sys.columns Where object_id = ( Select object_id From sys.objects Where name = 'Console2CS_Consolidated ')  
    and column_id  between 6 and 5 + @colcount 
    Order by column_id
    Set @SqlStr = @SqlStr + ' Select '+ left(@Col,len(@Col)-1)  + ' From #Console2CS_Consolidated (nolock) '  
    Set @SqlStr = @SqlStr + ' Where ProcessName = '''+ @Process +''' And DWNStatus = 1 '      
--    Print (@SqlStr) 
    Exec (@SqlStr)  
    Set @Lvar = @Lvar + 1  
   End  
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
  -- Purchase Trace Ends here
  Update A Set A.DownloadFlag = 'Y'   
   From   
    Console2CS_Consolidated A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
   Update A Set A.SyncFlag = 1  
   From   
    Syncstatus_Download A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  

	DELETE FROM Console2CS_Consolidated WHERE Processname IN('SpecialDiscount') AND downloadflag in('D','N')  ---- Added by lakshman M Dated ON20-08-2019 PMS : ILCRSTPAR5587

COMMIT TRANSACTION    
 END TRY    
 BEGIN CATCH    
  ROLLBACK TRANSACTION    
  INSERT INTO XML2CSPT_ErrorLog VALUES ('Proc_Console2CS_ConsolidatedDownload', ERROR_MESSAGE(), GETDATE())    
 END CATCH    
END
GO
IF NOT EXISTS (SELECT * FROM SYSCOLUMNS WHERE NAME='CPRefNo' AND ID= Object_id('SpecialRate_Track'))
BEGIN
	ALTER TABLE SpecialRate_Track ADD CPRefNO NVARCHAR(100)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_NewBatchNCategoryInsert' AND TYPE ='P')
DROP PROCEDURE Proc_NewBatchNCategoryInsert
GO
CREATE PROCEDURE Proc_NewBatchNCategoryInsert
AS
BEGIN
DELETE FROM ProductBatchPriceWithCounter
INSERT into ProductBatchPriceWithCounter (Slno,TransNo,PrdId,PrdBatId,PriceCode,MRP,ListPrice,SellingRate,ClaimRate,AddRate1) 
SELECT Row_number() over (partition by A.Prdid order by prdid ) AS Slno,Defaultpriceid  AS Transid,Prdid,prdbatid,Pricecode,sum(MRP) AS MRP,sum(LSP) AS LSP,Sum(SellingRate)AS SellingRate,Sum(ClaimRate) AS ClaimRate,0 FROM 
(
SELECT A.PrdId,B.PrdBatId,C.PriceCode,Defaultpriceid ,CASE slno when 1 then C.PrdBatDetailValue END AS MRP,
CASE slno when 2 then C.PrdBatDetailValue END AS LSP,
CASE slno when 3 then C.PrdBatDetailValue END AS SellingRate,
CASE slno when 4 then C.PrdBatDetailValue END AS ClaimRate
FROM Product A(NOLOCK) INNER Join Productbatch B(NOLOCK) ON A.PrdId =b.PrdId 
INNER Join Productbatchdetails  C(NOLOCK) On c.PrdBatId =b.PrdBatId and C.PriceId =B.DefaultPriceid
WHERE DefaultPrice =1 AND convert(VARCHAR(10),b.LASTMODDATE,121)>='2019-08-01') A 
Group by Prdid,prdbatid,Pricecode,Defaultpriceid 
 


	CREATE TABLE #ProductCategory
	(
		PrdId	BIGINT,
		PrdCtgValMainId	BIGINT,
		PrdctgValmainCode NVARCHAR(100)
	)

	INSERT INTO #ProductCategory(PrdId,PrdCtgValMainId,PrdctgValmainCode)
	SELECT A.PrdId,COMPANY_Id,COMPANY_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)  UNION
	SELECT A.PrdId,Category_Id,Category_Code  FROM TBL_GR_BUILD_PH A (NOLOCK) UNION
	SELECT A.PrdId,Brand_Id,Brand_Code  FROM TBL_GR_BUILD_PH A (NOLOCK) UNION
	SELECT A.PrdId,PriceSlot_Id,PriceSlot_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)  UNION
	SELECT A.PrdId,Flavor_Id,Flavor_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)  

	 
	DECLARE @Dist as VARCHAR(100)
	DECLARE @DistCde AS VARCHAR(100)

	SELECT @Dist='CP-'+lEFT(DistributorCode,4) ,@DistCde=DistributorCode fROM DISTRIBUTOR
	
	SELECT DISTINCT A.ContractId,CtgCode,P.PrdctgValmainCode INTO #temp from  contractpricingmaster A 
	inner join retailercategory rc on A.CtgMainId=rc.CtgMainId 
	INNER JOIN ContractPricingDetails CPD ON CPD.ContractId=A.ContractId AND isnull(A.ComConRefNo,'')<>''
	INNER JOIN #ProductCategory P ON P.PrdCtgValMainId=CPD.CtgValMainId AND Status = 1
	WHERE A.ComConRefNo not like @Dist+'%'


	SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCtgLevel AS PrdCCode ,MAX(CreatedDate) AS CreatedDate  INTO #SpecialRateCreatedDate1  
	FROM SpecialRate_Track WITH(NOLOCK) where  PrdCCode ='' GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCtgLevel ORDER BY PrdCtgLevel


	SELECT DISTINCT A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,B.PrdCCode,A.CreatedDate ,A.ApplyOn,A.TYPE INTO #SpecialRateCreatedDate
	FROM SpecialRate_Track A WITH(NOLOCK) INNER JOIN  #SpecialRateCreatedDate1 B (NOLOCK) 
	ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode  = B.RtrCtgValueCode AND A.RtrCode= B.RtrCode AND A.PrdCtgLevel= B.PrdCCode
	AND A.CreatedDate = B.CreatedDate AND A.ApplyOn is not null AND A.PrdCCode =''


	SELECT DISTINCT A.*
	INTO #SpecialRateDetails   
	FROM SpecialRate_Track A WITH(NOLOCK)  
	INNER JOIN #SpecialRateCreatedDate B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode   
	AND A.RtrCode = B.RtrCode AND A.PrdCtglevel = B.PrdCCode AND A.CreatedDate = B.CreatedDate AND A.ApplyOn = B.ApplyOn 
	--INNER JOIN #TempProductBatch T ON T.PrdCtgvalcode  = A.PrdCtgCode AND  (CASE B.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLING RATE' THEN 3 WHEN 'PURCHASE RATE' THEN 2  END )=T.ApplyON 
	INNER JOIN #ProductCategory PP ON  PP.PrdctgValmainCode = A.PrdCtgcode
	ORDER BY A.PrdCtgcode  
	 

	INSERT INTO Cn2cs_prk_specialdiscount (DistCode,RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue,DiscPer,
	EffFromDate,EffToDate,DownLoadFlag,CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,CPRefName)
	SELECT @DistCde,RtrCtgCode,RtrCtgValueCode,PrdCtgLevel,PrdCtgcode ,DiscountPerc ,FromDate ,'2030-12-31','D',Getdate(),ApplyON,
	Type,0,0,0,'DOC_IF_01','MissingCategory'
	FROM #SpecialRateDetails A 
	--INNER JOIN #tEMP4 D ON A.RtrCtgValueCode=D.CtgCode
	WHERE NOT EXISTS(SELECT * FROM #temp B WHERE  A.PrdCtgcode=b.PrdctgValmainCode and a.RtrCtgValueCode=b.CtgCode)-- and D.CONTRACTID=B.CONTRACTID)
	and ISNULL(A.PrdCtgCode ,'')<>''

END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME ='Cn2Cs_Prk_ContractPricing_Header_NP' AND type ='U')
BEGIN
CREATE TABLE Cn2Cs_Prk_ContractPricing_Header_NP (
	[DistCode] [nvarchar](50) NULL,
	[CMPCode] [nvarchar](50) NULL,
	[CPRefCode] [nvarchar](50) NULL,
	[CPRefName] [nvarchar](150) NULL,
	[EffFromDate] [datetime] NULL,
	[EffToDate] [datetime] NULL,
	[DiscType] [nvarchar](50) NULL,
	[RtrType] [nvarchar](50) NULL,
	[CPStatus] [nvarchar](15) NULL,
	[RtrCatLvl] [nvarchar](25) NULL,
	[RtrCatCode] [nvarchar](50) NULL,
	[ClassCode] [nvarchar](50) NULL,
	[RtrCode] [nvarchar](50) NULL,
	[ProductLvl] [varchar](25) NULL,
	[DownloadFlag] [nvarchar](5) NULL,
	[CreatedDate] [datetime] NULL,
	[IONumber] [nvarchar](100) NULL
)
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE NAME ='Cn2Cs_Prk_ContractPricing_Detail_NP' AND TYPE ='U')
BEGIN
CREATE TABLE Cn2Cs_Prk_ContractPricing_Detail_NP (
	[DistCode] [nvarchar](50) NULL,
	[CPRefCode] [nvarchar](50) NULL,
	[PrdCatLvl] [nvarchar](25) NULL,
	[PrdCatCode] [nvarchar](100) NULL,
	[ApplyOn] [nvarchar](50) NULL,
	[DiscPer] [numeric](18, 2) NULL,
	[FlatAmt] [numeric](18, 2) NULL,
	[SplPrice] [numeric](18, 2) NULL,
	[SPWTax] [nvarchar](10) NULL,
	[DownloadFlag] [nvarchar](5) NULL,
	[CreatedDate] [datetime] NULL
)
END
GO
IF NOT EXISTS (SELECT * FROM sysobjects WHERE NAME ='Cn2Cs_Prk_SpecialDiscount_NP' AND type ='U')
BEGIN
CREATE TABLE Cn2Cs_Prk_SpecialDiscount_NP (
	[DistCode] [nvarchar](100) NULL,
	[RetCategoryLevel] [nvarchar](100) NULL,
	[RetCatLevelValue] [nvarchar](100) NULL,
	[PrdCategoryLevel] [nvarchar](100) NULL,
	[PrdCategoryLevelValue] [nvarchar](100) NULL,
	[DiscPer] [numeric](18, 2) NULL,
	[EffFromDate] [datetime] NULL,
	[EffToDate] [datetime] NULL,
	[DownLoadFlag] [nvarchar](1) NULL,
	[CreatedDate] [datetime] NULL,
	[ApplyOn] [varchar](50) NULL,
	[Type] [varchar](50) NULL,
	[FlatAmt] [numeric](18, 2) NULL,
	[SplPrice] [numeric](18, 2) NULL,
	[SPWTax] [nvarchar](10) NULL,
	[CPRefCode] [nvarchar](50) NULL,
	[CPRefName] [nvarchar](150) NULL
)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ContractPricingTraceRePush_New' and xtype='P')
DROP PROCEDURE Proc_ContractPricingTraceRePush_New
GO
/*
BEGIN TRAN
EXEC Proc_ContractPricingTraceRePush_New 
SELECT * FROM Cn2Cs_Prk_ContractPricing_Header
SELECT * FROM Cn2Cs_Prk_ContractPricing_Detail
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_ContractPricingTraceRePush_New
AS
/***************************************************************************************************
* Procedure: Proc_ContractPricingTraceRePush
* Purpose  : To Contract Pricing Trace Re Push
* Created  :  
* Modified
'****************************************************************************************************************************
' Version       Date        Person          User Story ID    CR/BZ     Remarks          Code Review By   Review Date
  441			26/08/2019  M.Lakshman		ILCRSTPAR5558	  BZ	   Missing Contract Pricing details new process to old process data re-pushed.
*****************************************************************************************************************************/
BEGIN	
		UPDATE A SET ComConRefNo=ComConRefNo +'-26082019',A.STATUS =0  
		FROM ContractPricingMaster A (NOLOCK) 
		INNER JOIN Cn2Cs_Prk_SpecialDiscount_NP SD (NOLOCK) ON SD.CPRefcode =A.comconrefno
		WHERE LEN(LTRIM(RTRIM(ISNULL(ComConRefNo,''))))>0 AND ValidFromDate >='2019-08-01'

		INSERT INTO Cn2Cs_Prk_SpecialDiscount (DistCode,RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue,DiscPer,
		EffFromDate,EffToDate,DownLoadFlag,CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,CPRefName)
		SELECT  DistCode,RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue,DiscPer,EffFromDate,EffToDate,DownLoadFlag,
		CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,CPRefName FROm Cn2Cs_Prk_SpecialDiscount_NP WHERE DownloadFlag='D' 
		AND CPRefCode NOT IN('DISC00000108','DISC00000002','DISC00000123','DISC00000022')

		UPDATE A SET DownLoadFlag = 'C' FROM Cn2Cs_Prk_SpecialDiscount_NP A INNER JOIN Cn2Cs_Prk_SpecialDiscount B ON A.CPRefCode =B.CPRefCode
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_ValidateDayEndProcess' AND TYPE ='P')
DROP PROCEDURE Proc_ValidateDayEndProcess
GO
/*
begin tran
delete from DayEndValidation
EXEC Proc_ValidateDayEndProcess '2019-08-25'
SELECT * FROM DayEndValidation
rollback tran
*/
CREATE PROCEDURE Proc_ValidateDayEndProcess
(
	@Pi_Fromdate AS DATETIME
)
AS
BEGIN
/*********************************
* PROCEDURE: Proc_ValidateDayEndProcess
* PURPOSE: To Validate the Day end
* NOTES: 
* CREATED:Murugan.R
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
* 17-07-2013 Praveenraj B for adding master user access validation for GCPL
*****************************************************************************************************
* 27-08-2019     Lakshman M     BZ   ILCRSTPAR5695    Dayend validation missing in core stocky.
*****************************************************************************************************/ 
--DayEnd Type 1 --Find Jc Mont exists
--DayEnd Type 2 --Pending Day End
DECLARE @MonthEnd AS TINYINT
DECLARE @Pi_JcFromdate AS DATETIME
DECLARE @Pi_JcTodate AS DATETIME
DECLARE @CheckPendingTransaction AS TINYINT
DELETE FROM DayEndValidation
SET @MonthEnd=0
SET @CheckPendingTransaction=0
----------- Added By lakshman M Dated ON 07/01/2018 PMS ID: ILCRSTPAR3026 -------------
IF NOT EXISTS(SELECT * FROM stockledger)
BEGIN
	Return
END
----------- Till here -----------
IF NOT EXISTS(SELECT J.JcmId,JcmJc,JcmYr,JcmSdt,JcmEdt FROM JcMast J INNER JOIN Jcmonth Jc ON J.JcmId=Jc.JcmId INNER JOIN Company C On C.CmpId=J.CmpId
WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_Fromdate,121),121) BETWEEN JcmSdt and JcmEdt And DefaultCompany=1)
BEGIN
	INSERT INTO DayEndValidation(DayEndType,DayEndStartDate,Status)
	SELECT 1,CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_Fromdate,121),121),1
END	
	SELECT  MIN(DayEndStartDate) as  DayEndStartDate  INTO #DayEndExists
	FROM DayEndDates WHERE DayEndStartDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_Fromdate,121),121) AND Status=0
------------- ILCRSTPAR5695 ----------
--IF EXISTS(SELECT  * FROM #DayEndExists WHERE DayEndStartDate IS NOT NULL)
--BEGIN
--	INSERT INTO DayEndValidation(DayEndType,DayEndStartDate,Status)
--	SELECT 2, MIN(DayEndStartDate) ,1 FROM DayEndDates WHERE DayEndStartDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_Fromdate,121),121)
--	AND Status=0
--END

IF EXISTS(SELECT  * FROM #DayEndExists WHERE DayEndStartDate IS NOT NULL)
BEGIN
	INSERT INTO DayEndValidation(DayEndType,DayEndStartDate,Status)
	SELECT 2, MIN(DayEndStartDate) ,1 FROM DayEndDates WHERE DayEndStartDate<CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_Fromdate,121),121)
	AND Status=0
END

	IF EXISTS(SELECT TOP 1 JcmSdt,JcmEdt from JcmonthEnd WHERE Status=0 ORDER BY JcmSdt)
	BEGIN
		SELECT TOP 1 JcmSdt,JcmEdt INTO #JCEND FROM JcmonthEnd WHERE Status=0 ORDER BY JcmSdt
		SELECT @Pi_JcFromdate=JcmSdt,@Pi_JcTodate=JcmEdt FROM #JCEND 
		IF NOT EXISTS(SELECT * from Dayenddates WHERE DayEndstartdate BETWEEN @Pi_JcFromdate and @Pi_JcTodate and Status=0)
		BEGIN
			INSERT INTO DayEndValidation(DayEndType,DayEndStartDate,Status)
			SELECT 3,JcmEdt ,1 FROM #JCEND 		
		END
	END
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Validate_ContractPricing' AND TYPE ='P')
DROP PROCEDURE Proc_Validate_ContractPricing
GO
/*
BEGIN TRANSACTION
--SELECT DISTINCT * FROM Cn2Cs_Prk_ContractPricing
EXEC Proc_Validate_ContractPricing 0
SELECT * FROM ErrorLog
SELECT * FROM ContractPricingMaster where ContractId = 17
SELECT * FROM ContractPricingDetails  where ContractId = 17
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Validate_ContractPricing
(
@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE : Proc_Validate_ContractPricing(Base:Proc_ValidateBLContractPricing)
* PURPOSE : To Insert Contract Pricing Details for Special Rates
* CREATED : Nandakumar R.G
* CREATED DATE : 04/05/2010
* MODIFIED
* DATE AUTHOR DESCRIPTION
------------------------------------------------
* {date} {developer} {brief modification description}
* 21/10/2010 Nanda Effective From/To Date changes
* 10-06-2019 MOHANA CR CRCRSTPAR0058 INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE
* 22-08-2019 Lakshman M SR ILCRSTPAR5594 Contract pricing Retailer category wsie validation
* 24-08-2019 Lakshman M SR ILCRSTPAR5656 while download records cursor validation variable decalreation missing in core stocky script has been modified..
* 04-09-2019      MOHANA S	   SR	ILCRSTPAR5800   INCLUDED RETAILER WISE CONTRACT PRICING 
*********************************/
SET NOCOUNT ON
BEGIN
DECLARE @EffectiveDate AS DATETIME
DECLARE @ToDate AS DATETIME
DECLARE @CmpId AS INT
DECLARE @RtrId AS INT
DECLARE @CtgMainId AS INT
DECLARE @CtgLevelId AS INT
DECLARE @PrdCtgValMainId AS INT
DECLARE @RtrClassId AS INT
DECLARE @CmpPrdCtgId AS INT
DECLARE @PrdId AS INT
DECLARE @ContractId AS INT
DECLARE @RtrTaxGroupId AS INT
DECLARE @PrdBatId AS INT
DECLARE @PriceId AS INT
DECLARE @ConRefNo AS NVARCHAR(100)
DECLARE @Disc AS NUMERIC(38,6)
DECLARE @FlatAmt AS NUMERIC(38,6)
DECLARE @SplPrice AS NUMERIC(38,6)
DECLARE @WithTax INT
DECLARE @Applyon INT
DECLARE @Refno NVARCHAR(100)
DECLARE @RefName NVARCHAR(100)
Declare @createddate DATETIME

SET @Po_ErrNo =0
DECLARE Cur_ContPrice CURSOR
	FOR SELECT DISTINCT CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,RtrId,EffectiveDate,ToDate,RtrTaxGroupId,SplPrice,ComConRefNo,ComConRefName,
ApplyON,WithTax,CreatedDate
FROM Cn2Cs_Prk_ContractPricing
WHERE EffectiveDate<=GETDATE()
	ORDER BY  CreatedDate,ComConRefNo,RtrId,CtgMainId,CmpId,CtgLevelId,EffectiveDate
OPEN Cur_ContPrice
	FETCH NEXT FROM Cur_ContPrice INTO @CmpId,@CtgLevelId,@CtgMainId,@RtrClassId,@CmpPrdCtgId,
	@RtrId,@EffectiveDate,@ToDate,@RtrTaxGroupId,@SplPrice,@Refno,@RefName,@Applyon,@WithTax,@CreatedDate
WHILE @@FETCH_STATUS=0
BEGIN
	SET @ContractId=0
	SET @ConRefNo=''
	SELECT @ContractId= dbo.Fn_GetPrimaryKeyInteger('ContractPricingMaster','ContractId',CAST(YEAR(GETDATE()) AS INT),MONTH(GETDATE()))
	SELECT @ConRefNo= dbo.Fn_GetPrimaryKeyString('ContractPricingMaster','ConRefNo',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
	IF @ContractId>(SELECT ISNULL(MAX(ContractId),0) AS ContractId FROM ContractPricingMaster) AND @ConRefNo<>''
	BEGIN

		INSERT INTO ContractPricingMaster(ContractId,CmpId,CtgLevelId,CtgMainId,RtrClassId,
		CmpPrdCtgId,PrdCtgValMainId,RtrId,RtrTaxGroupId,Availability,LastModBy,LastModDate,AuthId,AuthDate,
		DisplayMode,ConRefNo,ConDate,ValidFromDate,ValidTillDate,Status,AllowDiscount,ComConRefNo ,ComConRefName )
		VALUES(@ContractId,@CmpId,@CtgLevelId,@CtgMainId,@RtrClassId,@CmpPrdCtgId,0,
		@RtrId,@RtrTaxGroupId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),
		0,@ConRefNo,CONVERT(VARCHAR(10),GETDATE(),121),@EffectiveDate,@ToDate,1,0,@Refno,@RefName)

		UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'ContractPricingMaster' AND FldName = 'ContractId'
		UPDATE Counters SET CurrValue = CurrValue+1 WHERE TabName = 'ContractPricingMaster' AND FldName = 'ConRefNo'

		INSERT INTO ContractPricingDetails(ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,
		Availability,LastModBy,LastModDate,AuthId,AuthDate,CtgValMainId,ClaimablePercOnMRP,ApplyOn ,WithTax ,SpecialPrice)
		SELECT @ContractId,PrdId,PrdBatId,PriceId,DiscountPerc,FlatAmount,1,1,GETDATE(),1,GETDATE(),PrdCtgValMainId,0,@Applyon,@WithTax,@SplPrice
		FROM Cn2Cs_Prk_ContractPricing WHERE CmpId= @CmpId AND CtgLevelId= @CtgLevelId AND
		CtgMainId= @CtgMainId AND RtrClassId= @RtrClassId AND CmpPrdCtgId = @CmpPrdCtgId AND RtrId = @RtrId
		AND RtrTaxGroupId=@RtrTaxGroupId AND EffectiveDate=@EffectiveDate AND ComConRefNo = @Refno
		ORDER BY PrdId,PrdBatId,PriceId,DiscountPerc,FlatAmount
	END
	ELSE
	BEGIN
		INSERT INTO Errorlog VALUES (1,'Cn2Cs_Prk_ContractPricing','System Date',
		'Reset the Counters/System is showing Date as :'+CAST(GETDATE() AS NVARCHAR(10))+'. Please change the System Date')
		SET @Po_ErrNo=1
		CLOSE Cur_ContPrice
		DEALLOCATE Cur_ContPrice
		RETURN
END
		FETCH NEXT FROM Cur_ContPrice INTO @CmpId,@CtgLevelId,@CtgMainId,@RtrClassId,@CmpPrdCtgId,
		@RtrId,@EffectiveDate,@ToDate,@RtrTaxGroupId,@SplPrice,@Refno,@RefName,@Applyon,@WithTax,@createddate
END

CLOSE Cur_ContPrice
DEALLOCATE Cur_ContPrice
IF @Po_ErrNo=0
BEGIN
	DELETE FROM Cn2Cs_Prk_ContractPricing WHERE EffectiveDate<=GETDATE()
END

END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_CalculateSpecialDiscountAftRate' AND TYPE='P')
DROP PROCEDURE Proc_CalculateSpecialDiscountAftRate
GO
--EXEC Proc_CalculateSpecialDiscountAftRate
CREATE PROCEDURE Proc_CalculateSpecialDiscountAftRate
AS  
/*
--------------------------------------------------------------------------------------------------------------------------------------------------  
* [DATE]      [DEVELOPER]		[USER_STORY_ID]			[CR/BUG]    [DESCRIPTION]
* 22-09-2018   VASANTHARAJ		  ILCRSTPAR2104			BUG			System is considering random  special rate and applying same to Billing Screen
* 06-06-2019	MOHANA		 	  CRCRSTPAR0058			CR  		INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE
* 04-09-2019    MOHANA S	      ILCRSTPAR5800			SR			INCLUDED RETAILER WISE CONTRACT PRICING 
--------------------------------------------------------------------------------------------------------------------------------------------------
*/ 
SET NOCOUNT ON  
BEGIN
     --Added by SAthishkumar Veeramani 2015/04/01
	 DECLARE @SplDiscountToAvoid TABLE
	 (
	   RetCategoryLevel       NVARCHAR(100),
	   RetCatLevelValue       NVARCHAR(100),
	   PrdCategoryLevel       NVARCHAR(100),
	   PrdCategoryLevelValue  NVARCHAR(100)
	 )    
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE (ApplyOn = '' OR ApplyOn IS NULL)
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Apply On','Apply On Should Not be Empty or Null-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE (ApplyOn = '' OR ApplyOn IS NULL)
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) NOT IN ('MRP','SELLINGRATE','PURCHASERATE')
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Apply On','Apply On Should Not be in MRP Or SELLINGRATE Or PURCHASERATE-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) NOT IN ('MRP','SELLINGRATE','PURCHASERATE')
     --Till Here
	 INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND ISNULL([Type],'')=''
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Type','Type Should Not be Empty For Appy On MRP-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND ISNULL([Type],'')=''
     INSERT INTO @SplDiscountToAvoid (RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue)
     SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND 
     UPPER(LTRIM(RTRIM(ISNULL([Type],'')))) NOT IN ('MARK DOWN','MARK UP')
     INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	 SELECT DISTINCT 1,'Cn2Cs_Prk_SpecialDiscount','Type','Type Should be Mark Up/Mark Down For Appy On MRP-'+PrdCategoryLevelValue 
     FROM Cn2Cs_Prk_SpecialDiscount (NOLOCK) WHERE UPPER(LTRIM(RTRIM(ApplyOn))) IN ('MRP') AND 
     UPPER(LTRIM(RTRIM(ISNULL([Type],'')))) NOT IN ('MARK DOWN','MARK UP')

	 EXEC Proc_GR_Build_PH  

	 TRUNCATE TABLE TempSpecialRateDiscountProduct
	 DELETE FROM Cn2Cs_Prk_SpecialDiscount where DownLoadFlag='Y'
	  -- Added by Vasantharaj on 22/09/2018 , PMS NO : ILCRSTPAR2104
	  SELECT RetCategoryLevel ,RetCatLevelValue,PrdCategoryLevel ,PrdCategoryLevelValue,DiscPer,MAX(CreatedDate) Createddate,CPRefCode 	  
	  INTO #Cn2Cs_Prk_SpecialDiscount FROM Cn2Cs_Prk_SpecialDiscount
	  GROUP BY RetCategoryLevel ,RetCatLevelValue,PrdCategoryLevel ,PrdCategoryLevelValue,DiscPer,CPRefCode 
	  
	  DELETE A FROM  Cn2Cs_Prk_SpecialDiscount A INNER JOIN #Cn2Cs_Prk_SpecialDiscount C ON A.RetCategoryLevel=C.RetCategoryLevel
	  AND A.PrdCategoryLevel=C.PrdCategoryLevel AND A.RetCatLevelValue=C.RetCatLevelValue AND A.PrdCategoryLevelValue=C.PrdCategoryLevelValue
	  AND A.DiscPer=C.DiscPer AND A.CreatedDate<>C.Createddate AND A.CPRefCode = C.CPRefCode 

	  --Till Here	  
	 INSERT INTO TempSpecialRateDiscountProduct (CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,DiscPer,SpecialSellingRate,EffectiveFromDate,
     	 EffectiveToDate,CreatedDate,ApplyOn,[Type], PrdCtgValMainId,CPRefCode,CPRefName)
	 SELECT DISTINCT A.RetCategoryLevel,A.RetCatLevelValue,'ALL',ProductCode,PrdBatCode,DiscPer,
	 --PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) SplRate,
	 (CASE ApplyOn WHEN 1 THEN 
		 (CASE [Type] WHEN 1 THEN (PrdBatDetailValue*100/(100+DiscPer)) WHEN 2 THEN PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))
			ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))  END)	 
	 ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) END) AS SplRate,	 
	 EffFromDate,EffToDate,CreatedDate,ApplyOn,[Type],A.PrdCtgValMainId	,CPRefCode,CPRefName 
	 FROM (  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],cOMPANY_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.COMPANY_Code  
	 WHERE CP.PrdCategoryLevel='COMPANY' and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION   
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Category_iD as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Category_Code  
	 WHERE CP.PrdCategoryLevel='Category'and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Brand_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Brand_Code  
	 WHERE CP.PrdCategoryLevel='Brand'and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type] ,PriceSlot_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.PriceSlot_Code  
	 WHERE CP.PrdCategoryLevel='PriceSlot'and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)  
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn ,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Flavor_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Flavor_Code  
	 WHERE CP.PrdCategoryLevel='Flavor'and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],0 as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	 WHERE CP.PrdCategoryLevel='Product'and CP.DownloadFlag='D' AND CP.RetCategoryLevel <>'RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CP.RetCatLevelValue,CP.RetCategoryLevel,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],0 as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	 WHERE CP.DownloadFlag='D'  AND CP.RetCategoryLevel <>'RETAILER' AND NOT EXISTS (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
	 FROM @SplDiscountToAvoid SA WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue 
	 AND CP.PrdCategoryLevel = SA.PrdCategoryLevel AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue))A  
	 INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId and A.ProductCode=P.PrdCCode  
	 INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId  
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId  
	 INNER JOIN BatchCreation BC (NOLOCK) ON BC.SlNo=PBD.SLNo AND BC.SlNo = A.ApplyOn
	 --INNER JOIN Configuration C (NOLOCK) ON BC.SlNo = ISNULL(CAST(C.ConfigValue AS INT),0)
	 WHERE PBD.DefaultPrice=1 --AND C.ModuleId = 'SPLDISC'


	 INSERT INTO TempSpecialRateDiscountProduct (CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,DiscPer,SpecialSellingRate,EffectiveFromDate,
     EffectiveToDate,CreatedDate,ApplyOn,[Type], PrdCtgValMainId,CPRefCode,CPRefName)
	 SELECT DISTINCT 'ALL','ALL',CmpRtrCode,ProductCode,PrdBatCode,DiscPer,
	 --PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) SplRate,
	 (CASE ApplyOn WHEN 1 THEN 
		 (CASE [Type] WHEN 1 THEN (PrdBatDetailValue*100/(100+DiscPer)) WHEN 2 THEN PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))
			ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100))  END)	 
	 ELSE PrdBatDetailValue-(PrdBatDetailValue*(DiscPer/100)) END) AS SplRate,	 
	 EffFromDate,EffToDate,CreatedDate,ApplyOn,[Type],A.PrdCtgValMainId	,CPRefCode,CPRefName 
	 FROM (  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],cOMPANY_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.COMPANY_Code  
	 INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='COMPANY' and CP.DownloadFlag='D' AND CP.RetCategoryLevel = 'RETAILER' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION   
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Category_iD as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Category_Code  
	 INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='Category'and CP.DownloadFlag='D' AND CP.RetCategoryLevel = 'RETAILER' AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Brand_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Brand_Code  
	  INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='Brand'and CP.DownloadFlag='D' AND CP.RetCategoryLevel='RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue) 
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type] ,PriceSlot_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.PriceSlot_Code  
	  INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='PriceSlot'and CP.DownloadFlag='D' AND CP.RetCategoryLevel = 'RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)  
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn ,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],Flavor_ID as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.Flavor_Code  
	  INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='Flavor'and CP.DownloadFlag='D' AND CP.RetCategoryLevel ='RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION  
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],0 as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	  INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.PrdCategoryLevel='Product'and CP.DownloadFlag='D' AND CP.RetCategoryLevel ='RETAILER'  AND NOT EXISTS 
	 (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue FROM @SplDiscountToAvoid SA 
	 WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue AND CP.PrdCategoryLevel = SA.PrdCategoryLevel
	 AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue)
	 UNION
	 SELECT CP.PrdCategoryLevel,CP.PrdCategoryLevelValue,CmpRtrCode,Prdid,T.ProductCode,DiscPer,EffFromDate,
	 EffToDate,CreatedDate,(CASE UPPER(LTRIM(RTRIM(CP.ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END) AS ApplyOn,
	 CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type],0 as PrdCtgValMainId,CPRefCode,CPRefName
	 FROM Cn2Cs_Prk_SpecialDiscount CP INNER JOIN TBL_GR_BUILD_PH T on CP.PrdCategoryLevelValue=T.ProductCode  
	  INNER JOIN Retailer R ON CP.RetCatLevelValue = R.CmpRtrCode
	 WHERE CP.DownloadFlag='D'  AND CP.RetCategoryLevel = 'RETAILER' AND NOT EXISTS (SELECT DISTINCT RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue 
	 FROM @SplDiscountToAvoid SA WHERE CP.RetCategoryLevel = SA.RetCategoryLevel AND CP.RetCatLevelValue = SA.RetCatLevelValue 
	 AND CP.PrdCategoryLevel = SA.PrdCategoryLevel AND CP.PrdCategoryLevelValue = SA.PrdCategoryLevelValue))A  
	 INNER JOIN Product P (NOLOCK) ON P.PrdId=A.PrdId and A.ProductCode=P.PrdCCode  
	 INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId  
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId  
	 INNER JOIN BatchCreation BC (NOLOCK) ON BC.SlNo=PBD.SLNo AND BC.SlNo = A.ApplyOn
	 --INNER JOIN Configuration C (NOLOCK) ON BC.SlNo = ISNULL(CAST(C.ConfigValue AS INT),0)
	 WHERE PBD.DefaultPrice=1 --AND C.ModuleId = 'SPLDISC'
 
	 
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_DistributorIncentiveCalculation' AND TYPE ='P')  
DROP PROCEDURE Proc_DistributorIncentiveCalculation
GO
/*  
BEGIN TRAN  
--SELECT * FROM DistributorIncentiveMaster  
--update DistributorIncentiveMaster set incentivegenerated=0  
EXEC Proc_DistributorIncentiveCalculation 2,'2019-09-05',0,'0' 
SELECT * FROM DistributorIncentiveAchDetail  
SELECT * FROM DistributorIncentiveAchDetailRouteLevel  
SELECT * FROM DistributorIncentiveMaster  
ROLLBACK TRAN  
*/  
CREATE PROCEDURE [dbo].[Proc_DistributorIncentiveCalculation]  
(  
@Pi_UserId AS INT,  
@Pi_TransDate AS DATETIME,  
@Po_ErrNo AS TinyINT OUTPUT,  
@Po_ErrorMessage AS Varchar(4000) OUTPUT  
)  
AS  
/**************************************************************************************************************************************************************************************  
* PROCEDURE  : Proc_Cn2Cs_DistributorIncentiveMaster  
* PURPOSE  : Calculate Distributor incentive master and detail  
* CREATED  : S.Moorthi  
* CREATED DATE : 27/05/2019  
* MODIFIED  
**************************************************************************************************************************************************************************************  
* VERSION    |  DATE      |   PERSON     | USER STORY ID  |  CR/BZ |  REMARKS                      | CODE REVIEW BY     | REVIEW DATE  
**************************************************************************************************************************************************************************************  
  441     27-05-2019   S.Moorthi    CRCRSTPAR0056  CR   STO(Service to Outlet) or Distributor service invoice logic to be incorporated and debit note should upload to console  
  441     05-09-2019   M Lakshman   ILCRSTPAR5816  BZ   distributor incentive Divisible by error validation included in script level.
**************************************************************************************************************************************************************************************/  
SET NOCOUNT ON  
BEGIN   
      
 DECLARE @DbNoteNumber AS NVARCHAR(100)  
 DECLARE @CoaId AS INT  
 DECLARE @ReasonId AS INT  
 DECLARE @ErrStatus AS INT  
 DECLARE @SpmId AS INT  
   
 SET @Po_ErrNo=0  
 SET @Po_ErrorMessage=''  
   
    
  DECLARE @JcmSdt AS DATETIME  
  SET @JcmSdt=(SELECT JcmSdt FROM JCMonth WHERE CONVERT(VARCHAR(10),@Pi_TransDate,121) BETWEEN JcmSdt AND JcmEdt)  
      
  IF NOT EXISTS(SELECT * FROM SalesmanRouteRetailerSnapShot A WHERE EXISTS(  
  SELECT JcmEdt,JcmJc,JcmId FROM JCMonth B WHERE JcmEdt=DATEADD(D,-1,@JcmSdt) AND A.JcmJc=B.JcmJc AND A.JcmId=B.JcmId))  
  BEGIN  
   DECLARE @JcmId AS INT  
   DECLARE @JcmJc AS INT  
   SELECT @JcmJc=JcmJc,@JcmId=JcmId FROM JCMonth B WHERE JcmEdt=DATEADD(D,-1,@JcmSdt)  
     
   INSERT INTO SalesmanRouteRetailerSnapShot(JcmId,JcmJc,SMID,RMID,RtrId,CreatedDate)  
   SELECT @JcmId,@JcmJc,A.SMId,C.RMId,R.RtrId,GETDATE() FROM SalesMan A  
   INNER JOIN SalesmanMarket B ON A.SMId=B.SMId   
   INNER JOIN RetailerMarket C ON C.RMId=B.RMId   
   INNER JOIN Retailer R ON R.RtrId=C.RtrId   
     
  END  
 --drop table #TempDistInc  
  SELECT DISTINCT DistIRefno,IncFromDate,IncToDate INTO #TempDistInc FROM DistributorIncentiveMaster(nolock)   
  WHERE  IncentiveGenerated=0 and DistIRefStatus=1 AND @Pi_TransDate>=IncToDate     
  SELECT B.DistIRefno,B.IncFromDate,B.IncToDate INTO #DistributorIncentiveMaster FROM JCMonth A,   
  #TempDistInc B,JCMonthEnd M WHERE B.IncToDate BETWEEN A.JcmSdt AND A.JcmEdt   
  AND M.JcmEdt=A.JcmEdt AND M.JcmSdt=A.JcmSdt  
  IF NOT EXISTS(SELECT * FROM  #DistributorIncentiveMaster)  
  BEGIN  
   SET @Po_ErrNo=0  
   RETURN  
  END  
    
   DELETE FROM TempDistributorIncentiveCalculation WHERE UserId=@Pi_UserId  
   EXEC Proc_TempDistributorIncentiveCalculation @Pi_UserId,@Pi_TransDate,@Pi_TransDate  
    
   IF NOT EXISTS(SELECT * FROM TempDistributorIncentiveCalculation (NOLOCK) WHERE UserId=@Pi_UserId)  
   BEGIN  
    SET @Po_ErrNo=0  
    RETURN  
   END  
     
   --If Already Generated    
   DELETE B from DistributorIncentiveAchDetail A INNER JOIN TempDistributorIncentiveCalculation B ON A.DistIRefno=B.DistIRefno  
     
   IF EXISTS(SELECT * FROM TempDistributorUserTrack WHERE UsrId<>@Pi_UserId)  
   BEGIN  
    RETURN  
   END  
     
   BEGIN TRY  
   BEGIN TRAN  
    DELETE FROM TempDistributorUserTrack WHERE UsrId=@Pi_UserId  
    INSERT INTO TempDistributorUserTrack(UsrId,TransId)  
    SELECT @Pi_UserId,5000  
     
    CREATE TABLE #TempSMWiseIncentive  
    (  
     DistIRefNo    VARCHAR(100),  
     SMID     INT,  
     NoOfActiveRetailer  INT,  
     NoOfEffectiveRetailer INT,  
     PercEffectivity   NUMERIC(18,2),  
     NoOfBillsGenerated  INT,  
     PercOpportunityUtil  NUMERIC(18,2),  
     TotalSales    NUMERIC(18,3),  
     DepthPerRoute   NUMERIC(18,0),  
     DepthPerBill   NUMERIC(18,0),  
     [WeeklyCalc]   INT,  
     incentivePerc   NUMERIC(18,3),  
     Slab     INT,  
     IncentiveAmt   numeric(18,3)  
    )  
     
    INSERT INTO #TempSMWiseIncentive(DistIRefNo,SMID,NoOfActiveRetailer,NoOfEffectiveRetailer,  
    PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,incentivePerc,Slab,IncentiveAmt)  
    SELECT DISTINCT DistIRefNo,SMID,SUM(NoOfActiveRetailer),SUM(NoOfEffectiveRetailer),0 PercEffectivity,  
    SUM(NoOfBillsGenerated),0 PercOpportunityUtil,SUM(TotalSales),0 DepthPerRoute,0 DepthPerBill,SUM(WeeklyCalc),0 incentivePerc,0 Slab,0 IncentiveAmt   
    FROM TempDistributorIncentiveCalculation WHERE UserId=@Pi_UserId   
    GROUP BY DistIRefNo,SMID  
     
    ---PercEffectivity Update  
    UPDATE A SET A.PercEffectivity=CAST(NoOfEffectiveRetailer AS NUMERIC(18,3))/CAST(nullif(NoOfActiveRetailer,0) AS NUMERIC(18,3))*100  -- 
    FROM #TempSMWiseIncentive A WHERE NoOfEffectiveRetailer<>0  
     
    ---Opportunity Utilization  
    UPDATE A SET A.PercOpportunityUtil=CAST(NoOfBillsGenerated AS NUMERIC(18,3))/CAST(WeeklyCalc AS NUMERIC(18,3))*100  
    FROM #TempSMWiseIncentive A WHERE WeeklyCalc<>0  
     
    ---Depth Per Route  
    UPDATE A SET A.DepthPerRoute=CAST(TotalSales AS NUMERIC(18,3))/CAST(NoOfEffectiveRetailer AS NUMERIC(18,3))  
    FROM #TempSMWiseIncentive A WHERE NoOfEffectiveRetailer<>0  
     
    ---Depth Per Bill  
    UPDATE A SET A.DepthPerBill=CAST(TotalSales AS NUMERIC(18,3))/CAST(NoOfBillsGenerated AS NUMERIC(18,3))  
    FROM #TempSMWiseIncentive A WHERE NoOfBillsGenerated<>0  
     
     
    SELECT S.DistIRefno,S.Slab,FromRange,ToRange,DistIncentivePerc,B.SMID,PercOpportunityUtil   
    INTO #DistributorIncentiveSlabs   
    FROM DistributorIncentiveSlabs  S (NOLOCK)     
    INNER JOIN  #TempSMWiseIncentive B ON B.DistIRefno=S.DistIRefno  
    WHERE PercOpportunityUtil>0  
     
    SELECT DistIRefno,SMID,MAX(Slab) AS Slab INTO #DistActualIncentiveSlab  
    FROM (  
     SELECT DistIRefno,SMID,MAX(Slab) AS Slab FROM #DistributorIncentiveSlabs (NOLOCK)   
     WHERE PercOpportunityUtil>=FromRange and PercOpportunityUtil<=ToRange  
     GROUP BY DistIRefno,SMID,DistIncentivePerc  
     UNION ALL  
     SELECT DistIRefno,SMID,MAX(Slab) AS Slab FROM #DistributorIncentiveSlabs (NOLOCK)   
     WHERE PercOpportunityUtil>=FromRange and PercOpportunityUtil>ToRange  
     GROUP BY DistIRefno,SMID  
    ) A GROUP BY DistIRefno,SMID  
    
    
    IF @Po_ErrNo=0  
    BEGIN  
     INSERT INTO DistributorIncentiveAchDetail(DistIRefno,GeneratedOn,SMId,AchSales,AchSlab,IncPerc,IncAmount,  
     Upload,DebitNoteUpload,Availability,LastModBy,LastModDate,AuthId,AuthDate)  
     SELECT A.DistIRefNo,@Pi_TransDate,A.SMID,A.TotalSales,B.Slab,C.DistIncentivePerc,  
     (TotalSales*C.DistIncentivePerc)/100,0 AS upload,0 DebitNoteUpload,1 AS Availability,@Pi_UserId AS LastModBy,GETDATE() AS  LastModDate,  
     @Pi_UserId AS AuthId, GETDATE() AuthDate FROM #TempSMWiseIncentive A   
     INNER JOIN #DistActualIncentiveSlab B ON A.DistIRefNo=B.DistIRefno AND B.SMID=A.SMID   
     INNER JOIN DistributorIncentiveSlabs C(NOLOCK) ON C.DistIRefno=B.DistIRefno AND C.DistIRefno=A.DistIRefNo AND B.Slab=C.Slab  
     INNER JOIN DistributorIncentiveMaster  SM (NOLOCK) ON SM.DistIRefno=C.DistIRefno AND SM.DistIRefno=B.DistIRefno AND SM.DistIRefno=A.DistIRefNo   
     WHERE SM.IncentiveGenerated=0 and TotalSales>0  
      
     INSERT INTO DistributorIncentiveAchDetailRouteLevel(DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,  
     PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,GeneratedOn,UserId)  
     SELECT DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,  
     TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,GETDATE(),@Pi_UserId  
     FROM TempDistributorIncentiveCalculation WHERE UserId=@Pi_UserId   
      
     UPDATE DistributorIncentiveMaster SET IncentiveGenerated=1  FROM  DistributorIncentiveMaster S   
     INNER JOIN DistributorIncentiveAchDetail  SM ON SM.DistIRefno=S.DistIRefno   
     WHERE S.IncentiveGenerated=0 AND SM.UPLOAD=0  
      
    END  
   
    DELETE FROM TempDistributorUserTrack  
    
    COMMIT TRAN  
    
   END TRY   
   BEGIN CATCH    
     SET @Po_ErrNo=1   
     ROLLBACK TRAN    
     RETURN      
   END CATCH      
RETURN  
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_Cs2Cn_DailyProductDetails' AND TYpe ='P')
DROP PROCEDURE PROC_CS2CN_DAILYPRODUCTDETAILS
GO
/*  
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_DailyProductDetails 0  
SELECT COUNT(*) FROM Cs2Cn_Prk_DailyProductDetails  
--DELETE FROM Cs2Cn_Prk_DailyProductDetails  
SELECT * FROM DayEndProcess WHERE ProcId=15  
--UPDATE DayEndProcess SET NextUpDate='2010-08-10' WHERE ProcId>13  
--UPDATE Configuration SET Status=1,ConfigValue=2 WHERE ModuleId='BotreePrdUpload'  
SELECT * FROM Configuration WHERE ModuleId='BotreeRtrUpload'  
ROLLBACK TRANSACTION  
*/  
CREATE PROCEDURE Proc_Cs2Cn_DailyProductDetails  
(  
 @Po_ErrNo INT OUTPUT,  
 @ServerDate DATETIME  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cs2Cn_DailyProductDetails  
* PURPOSE  : Upload Daily Product Details from CoreStocky to Console  
* NOTES   :  
* CREATED BY : Nandakumar R.G  
* CREATED DATE : 30-03-2010  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
*************************************************  
*  
*************************************************/  
SET NOCOUNT ON  
BEGIN  
RETURN
 SET @Po_ErrNo=0  
 DECLARE @DistCode As nVarchar(50)  
 DECLARE @Days  AS INT  
 SELECT @DistCode = DistributorCode FROM Distributor  
 DELETE FROM Cs2Cn_Prk_DailyProductDetails WHERE UploadFlag = 'Y'  
 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreePrdUpload' AND Status=1)  
 BEGIN  
  SELECT @Days=ISNULL(ConfigValue,0) FROM Configuration WHERE ModuleId='BotreePrdUpload'  
  IF EXISTS(SELECT * FROM DayEndProcess WHERE DATEADD(DAY,@Days,NextUpDate)<=GETDATE() AND ProcId=15)  
  BEGIN  
   INSERT INTO Cs2Cn_Prk_DailyProductDetails  
   (  
    DistCode,  
    PrdId,  
    ProductCompanyCode,  
    ProductDistributorCode,  
    ProductName,  
    ProductShortName,  
    ProductStatus,  
    PrdBatId,  
    ProductBatchCode,  
    CompanyBatchCode,  
    ProductBatchStatus,  
    DefaultPriceCode,  
    DefaultMRP,  
    DefaultListPrice,  
    DefaultSellingRate,  
    DefaultClaimRate,  
    AddRate1,  
    AddRate2,  
    AddRate3,  
    AddRate4,  
    AddRate5,  
    AddRate6,  
    UploadedDate,  
    UploadFlag  
   )  
   SELECT  
   @DistCode,  
   P.PrdId,  
   P.PrdCCode AS ProductCompanyCode,  
   P.PrdDCode AS ProductDistributorCode,  
   P.PrdName AS ProductName,  
   P.PrdShrtName AS ProductShortName,  
   (CASE P.PrdStatus WHEN 1 THEN 'Active' ELSE 'InActive' END) AS ProductStatus,  
   ISNULL(PB.PrdBatId,0) AS PrdBatId,  
   ISNULL(PB.PrdBatCode,'') AS ProductBatchCode,  
   ISNULL(PB.CmpBatCode,'') AS CompanyBatchCode,  
   (CASE PB.Status WHEN 1 THEN 'Active' WHEN 0 THEN 'InActive' ELSE '' END) AS ProductBatchStatus,  
   ISNULL(PB.DefaultPriceCode,'') As DefaultPriceCode,  
   ISNULL(PB.DefaultMRP,0) AS DefaultMRP,  
   ISNULL(PB.DefaultListPrice,0) AS DefaultListPrice,  
   ISNULL(PB.DefaultSellingRate,0) AS DefaultSellingRate,  
   ISNULL(PB.DefaultClaimRate,0) AS DefaultClaimRate,  
   ISNULL(PB.AddRate1,0) AS AddRate1,  
   ISNULL(PB.AddRate2,0) AS AddRate2,  
   ISNULL(PB.AddRate3,0) AS AddRate3,  
   ISNULL(PB.AddRate4,0) AS AddRate4,  
   ISNULL(PB.AddRate5,0) AS AddRate5,  
   ISNULL(PB.AddRate6,0) AS AddRate6,  
   GETDATE(),  
   'N' AS UploadFlag  
   FROM Product P  
   LEFT OUTER JOIN  
   (SELECT PB.PrdId,PB.PrdBatId,PB.CmpBatCode,PB.Status,PB.PrdBatCode,PBDM.PriceCode AS DefaultPriceCode,  
   PBDM.PrdBatDetailValue AS DefaultMRP,  
   PBDL.PrdBatDetailValue AS DefaultListPrice,  
   PBDS.PrdBatDetailValue AS DefaultSellingRate,  
   PBDC.PrdBatDetailValue AS DefaultClaimRate,  
   0 AS AddRate1,  
   0 AS AddRate2,  
   0 AS AddRate3,  
   0 AS AddRate4,  
   0 AS AddRate5,  
   0 AS AddRate6  
   FROM ProductBatch PB  
   INNER JOIN ProductBatchDetails PBDM ON PB.PrdBatId=PBDM.PrdBatId AND PBDM.DefaultPrice=1  
   INNER JOIN BatchCreation BCM ON PBDM.SlNo=BCM.SlNo AND PBDM.BatchSeqId=BCM.BatchSeqId  
   AND PBDM.BatchSeqId =BCM.BatchSeqId AND BCM.MRP=1  
   INNER JOIN ProductBatchDetails PBDL ON PB.PrdBatId=PBDL.PrdBatId AND PBDL.DefaultPrice=1  
   INNER JOIN BatchCreation BCL ON PBDL.SlNo=BCL.SlNo AND PBDL.BatchSeqId=BCL.BatchSeqId  
   AND PBDL.BatchSeqId =BCL.BatchSeqId AND BCL.ListPrice=1  
   INNER JOIN ProductBatchDetails PBDS ON PB.PrdBatId=PBDS.PrdBatId AND PBDS.DefaultPrice=1  
   INNER JOIN BatchCreation BCS ON PBDS.SlNo=BCS.SlNo AND PBDS.BatchSeqId=BCS.BatchSeqId  
   AND PBDS.BatchSeqId =BCS.BatchSeqId AND BCS.SelRte=1  
   INNER JOIN ProductBatchDetails PBDC ON PB.PrdBatId=PBDC.PrdBatId AND PBDC.DefaultPrice=1  
   INNER JOIN BatchCreation BCC ON PBDC.SlNo=BCC.SlNo AND PBDC.BatchSeqId=BCC.BatchSeqId  
   AND PBDC.BatchSeqId =BCC.BatchSeqId AND BCC.ClmRte=1   
   ) PB  
   ON P.PrdId=PB.PrdId AND P.PrdCCode=PB.PrdBatCode  
   UPDATE Prk SET AddRate1=PB.AddRate1  
   FROM Cs2Cn_Prk_DailyProductDetails Prk,  
   (SELECT PBDAD1.PrdBatId,PBDAD1.PrdBatDetailvalue AS AddRate1  
   FROM BatchCreation BCAD1,ProductBatchDetails PBDAD1  
   WHERE PBDAD1.SlNo=BCAD1.SlNo AND PBDAD1.BatchSeqId=BCAD1.BatchSeqId  
   AND BCAD1.RefCode='E' AND PBDAD1.DefaultPrice=1) AS PB  
   WHERE Prk.PrdBatId=PB.PrdBatId  
   UPDATE DayEndProcess SET NextUpDate=DATEADD(DAY,@Days,NextUpDate) WHERE ProcId=15  
  END   
 END  
 UPDATE Cs2Cn_Prk_DailyProductDetails SET ServerDate=@ServerDate  
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_Cn2Cs_DiscountMaster' AND TYPE ='P')  
DROP PROCEDURE Proc_Cn2Cs_DiscountMaster
GO
/*  
BEGIN TRANSACTION  
delete from errorlog
EXEC Proc_Cn2Cs_DiscountMaster 0  
select distinct * from cn2cs_prk_ContractPricing_header
select * from cn2cs_prk_ContractPricing_detail
Select * from Cn2Cs_Prk_SpecialDiscount
ROLLBACK TRANSACTION
*/  
CREATE PROCEDURE Proc_Cn2Cs_DiscountMaster  
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cn2Cs_DiscountMaster  
* PURPOSE  : To Insert and Update Special Rate records in the Table    
* CREATED  : MOHANA S  
* CREATED DATE : 11-06-2019  
* USER STORY ID : CRCRSTPAR0058 
--------------------------------------------------------------------------------------------------------------------------------------------------  
* [DATE]      [DEVELOPER]		[USER_STORY_ID]			[CR/BUG]    [DESCRIPTION] 
* 04-09-2019    MOHANA S	      ILCRSTPAR5800			SR			INCLUDED RETAILER WISE CONTRACT PRICING 
--------------------------------------------------------------------------------------------------------------------------------------------------
*/  
SET NOCOUNT ON  
BEGIN  
   
 DECLARE @CmpPrdCtgName   AS NVARCHAR(50)  
 DECLARE @ErrStatus    AS INT  
   
 SET @Po_ErrNo=0  
 SET @ErrStatus=0  
   
 IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SplRateToAvoidNew')  
 AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)  
 BEGIN  
  DROP TABLE SplRateToAvoidNew  
 END  
   
 CREATE TABLE SplRateToAvoidNew  
 (  
  CPRefCode Nvarchar(50)  
 )

 
 DELETE FROM Cn2Cs_Prk_ContractPricing_Detail WHERE DownloadFlag ='Y'

 UPDATE B SET B.DownloadFlag ='D'  FROM Cn2Cs_Prk_ContractPricing_Detail A INNER JOIN Cn2Cs_Prk_ContractPricing_Header B ON A.CPRefCode =B.CPRefCode  WHERE A.DownloadFlag ='D'

 DELETE FROM Cn2Cs_Prk_ContractPricing_Header  WHERE DownloadFlag ='Y'


/* Remove Zero Percentage rows  PMS ID: ILCRSTPAR5535 Added By Lakshman M Dated ON 14-08-2019 */
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_ContractPricing_Detail_Zero_percent')
BEGIN

----------Remove Zero Percentage
--	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
--	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail  (NOLOCK) 
--	WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0 

--	DELETE FROM Cn2Cs_Prk_ContractPricing_Detail 
--	WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0 
--	--------Remove Product  Hierarchy/Product Not Available
	SET @CmpPrdCtgName=(SELECT TOP 1 CmpPrdCtgName FROM ProductCategoryLevel ORDER BY CmpPrdCtgId DESC)

	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail  (NOLOCK) 
	WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product)  

	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail  
	WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName) AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) 

	--DELETE FROM Cn2Cs_Prk_ContractPricing_Detail 
	--WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) 

	--DELETE FROM Cn2Cs_Prk_ContractPricing_Detail 
	--WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName) AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)

	---Remove From Header	
	--DELETE A FROM Cn2Cs_Prk_ContractPricing_Header A WHERE NOT EXISTS(SELECT B.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail B WHERE A.CPRefCode=B.CPRefCode)
END
/* ------------------ Till Here ----------------------*/
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header   
 WHERE (ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR  
    ISNULL(RtrType,'')='' OR     ISNULL(CPStatus,'')='' OR  
    ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR  
    ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')='' )  AND UPPER(rtrType)<>'RETAILER'

--INSERT INTO SplRateToAvoidNew  
---SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode  IN  
--(SELECT ComConRefNo FROM contractpricingmaster)  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode NOT IN  
   (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail)  
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE CPRefCode NOT IN  
   (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header)  
   
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header   
  WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)   AND UPPER(RtrType) <>'RETAILER'  
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header  
  WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory) AND UPPER(RtrType) <>'RETAILER'  
    
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header  
  WHERE RtrCode NOT IN (SELECT CmpRtrCode  FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail   
 WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''    
    
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail   
 --WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('DISCPER','FLATAMT')  
 WHERE ISNULL(ApplyOn,'')=''  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('SPLPRICE')  
 WHERE ISNULL(SPWTax,'')=''  
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE')  
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel)  
   
 --SET @CmpPrdCtgName=(SELECT TOP 1 CmpPrdCtgName FROM ProductCategoryLevel ORDER BY CmpPrdCtgId DESC)  
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  
 --AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product)   
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
 --AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)  
   
   
 INSERT INTO ErrorLog   
 SELECT DISTINCT 1,'Discount Master','Contract RefCode','Discount Details Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail)  
 UNION ALL  
 SELECT DISTINCT 2,'Discount Master','Contract RefCode','Header Details Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Detail WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header)  
 UNION ALL  
 SELECT  DISTINCT 3,'Discount Master','','Mandatory Fields Cannot be Null'+CPRefCode  FROM Cn2Cs_Prk_ContractPricing_Header WHERE ( ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR ISNULL(RtrType,'')='' OR       
 ISNULL(CPStatus,'')='' OR ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')='' ) AND UPPER(rtrType)<>'RETAILER'  
 UNION ALL  
 SELECT DISTINCT 3,'Discount Master','Retailer Category Level','Retailer Category Level Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)   AND UPPER(RtrType)<>'RETAILER'  
 UNION ALL  
 SELECT DISTINCT 4,'Discount Master','Retailer Category Level Value','Retailer Category Code Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory)    AND UPPER(RtrType)<>'RETAILER' 
 UNION ALL    
 SELECT DISTINCT 5,'Discount Master','Retailer Code','Retailer Code Not Available'+CPRefCode    
 FROM Cn2Cs_Prk_ContractPricing_Header WHERE RtrCode NOT IN (SELECT cmpRtrCode FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
 UNION ALL  
 SELECT DISTINCT 6,'Discount Master','Product Category Level','Mandatory Fields Cannot be Null'+CPRefCode     
 FROM Cn2Cs_Prk_ContractPricing_Detail WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''    
 --UNION ALL  
 --SELECT DISTINCT 7,'Discount Master','Discount','Discounts Cannot be Zero'+CPRefCode    
 --FROM Cn2Cs_Prk_ContractPricing_Detail WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0  
 UNION ALL  
 SELECT DISTINCT 8,'Discount Master','ApllyOn','Aplly On Cannot be Null'+A.CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(DiscType) IN ('DISCPER','FLATAMT') WHERE ISNULL(ApplyOn,'')=''  
 UNION ALL  
 SELECT DISTINCT 9,'Discount Master','WithTax','With Tax Cannot be Null'+A.CPRefCode    
 FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(DiscType) IN ('SPLPRICE') WHERE ISNULL(SPWTax,'')=''  
 UNION ALL  
 SELECT DISTINCT 10,'Discount Master','Status','Status Cannot be Null'+A.CPRefCode     
 FROM Cn2Cs_Prk_ContractPricing_Header A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE')  
 UNION ALL  
 SELECT DISTINCT 11,'Discount Master','PrdCatLvl','Product Category Level Not Available'+CPRefCode      
 FROM Cn2Cs_Prk_ContractPricing_Detail WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel) AND UPPER(PrdCatLvl)<>(UPPER(@CmpPrdCtgName))   
 UNION ALL  
 SELECT DISTINCT 12,'Discount Master','PrdCatCode','Product Code Not Available'+CPRefCode       
 FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)   
 AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl) =(UPPER(@CmpPrdCtgName))   
 UNION ALL  
 SELECT DISTINCT 13,'Discount Master','PrdCatCode','Product Category Level Value Not Available'+CPRefCode        
 FROM Cn2Cs_Prk_ContractPricing_Detail  WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
  AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)  
    
      SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_Header FROM Cn2Cs_Prk_ContractPricing_Header  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D'  
      SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_DETAIL FROM Cn2Cs_Prk_ContractPricing_DETAIL  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D' 

	DELETE FROM #Cn2Cs_Prk_ContractPricing_DETAIL  WHERE PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) AND UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
  
	DELETE FROM #Cn2Cs_Prk_ContractPricing_DETAIL WHERE PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  
  
	SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_HEADER FROM Cn2Cs_Prk_ContractPricing_Header GROUP BY CPRefCode  

	SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_DETAILS FROM Cn2Cs_Prk_ContractPricing_DETAIL GROUP BY CPRefCode  

	DELETE A  FROM #Cn2Cs_Prk_ContractPricing_Header A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_HEADER B WHERE A.CPRefCode =B.CPRefCode AND A.CREATEDDATE = B.CREATEDDATE)  

	DELETE A  FROM #Cn2Cs_Prk_ContractPricing_DETAIL A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_DETAILS B WHERE A.CPRefCode =B.CPRefCode AND A.CREATEDDATE = B.CREATEDDATE)  
	AND DOWNLOADFLAG='D'  

	INSERT INTO Cn2Cs_Prk_SpecialDiscount 
        SELECT DISTINCT DistCode,RTRCATLVL,RTRCATCODE,ProductLvl,PRDCATCODE,DiscPer,
	EffFromDate,EffToDate,DownLoadFlag,CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,
	CPRefName FROM  
	( 
	SELECT A.DISTCODE,RTRCATLVL,RTRCATCODE,CASE WHEN ProductLvl <> 'PRODUCT' THEN PrdCatLvl ELSE 'PRODUCT' END ProductLvl ,PRDCATCODE,DISCPER,  
	EffFromDate ,EffToDate ,'D' DownLoadFlag,A.CreatedDate ,APPLYON,CASE   WHEN ApplyOn<>'MRP' THEN '' ELSE  DiscType  END Type,  
	FlatAmt , SplPrice ,SPWTax ,A.CPRefCode ,A.CPRefName   
	FROM #Cn2Cs_Prk_ContractPricing_Header A INNER JOIN #Cn2Cs_Prk_ContractPricing_DETAIL B ON A.CPRefCode =B.CPREFCODE  
	AND A.DOWNLOADFLAG='D' AND RtrType <>'Retailer' 
	UNION ALL
	SELECT A.DISTCODE,'RETAILER',RtrCode ,CASE WHEN ProductLvl <> 'PRODUCT' THEN PrdCatLvl ELSE 'PRODUCT' END ,PRDCATCODE,DISCPER,
	EffFromDate ,EffToDate ,'D',A.CreatedDate,APPLYON, CASE   (CONVERT(DECIMAL(18, 2),DISCPER ))WHEN 0 THEN '' ELSE  DiscType  END,
	FlatAmt , SplPrice ,SPWTax ,A.CPRefCode ,A.CPRefName 
	FROM #Cn2Cs_Prk_ContractPricing_Header A INNER JOIN #Cn2Cs_Prk_ContractPricing_DETAIL B ON A.CPRefCode =B.CPREFCODE
	AND A.DOWNLOADFLAG='D' AND RtrType ='Retailer' 
	)A ORDER BY CreatedDate,CPRefCode
   
	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Header C INNER JOIN Cn2Cs_Prk_SpecialDiscount CP  
	ON C.CPRefCode=CP.CPRefCode

	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Detail C  
	INNER JOIN #Cn2Cs_Prk_ContractPricing_DETAIL A ON A. CPRefCode =C.CPRefCode 
	AND C.PrdCatCode = A.PrdCatCode AND C.CPRefCode IN (SELECT CPRefCode FROM Cn2Cs_Prk_SpecialDiscount)
   
 RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_Cn2Cs_DiscountMaster_NP' AND TYPE ='P')  
DROP PROCEDURE Proc_Cn2Cs_DiscountMaster_NP
GO
/*  
BEGIN TRANSACTION  
delete from errorlog
EXEC Proc_Cn2Cs_DiscountMaster_NP 0  
select * from errorlog
EXEC Proc_Cn2Cs_SpecialDiscount 0
ROLLBACK TRANSACTION
*/  
CREATE PROCEDURE Proc_Cn2Cs_DiscountMaster_NP
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cn2Cs_DiscountMaster  
* PURPOSE  : To Insert and Update Special Rate records in the Table    
* CREATED  : lakshman M  
* CREATED DATE : 11-06-2019  
* USER STORY ID : ILCRSTPAR5680  
*********************************/  
SET NOCOUNT ON  
BEGIN  
   
 DECLARE @CmpPrdCtgName   AS NVARCHAR(50)  
 DECLARE @ErrStatus    AS INT  
   
 SET @Po_ErrNo=0  
 SET @ErrStatus=0  
   
 IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SplRateToAvoidNew')  
 AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)  
 BEGIN  
	DROP TABLE SplRateToAvoidNew  
 END  
   
 CREATE TABLE SplRateToAvoidNew  
 (  
  CPRefCode Nvarchar(50)  
 )

 DELETE FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE DownloadFlag ='Y'

 UPDATE B SET B.DownloadFlag ='D'  FROM Cn2Cs_Prk_ContractPricing_Detail_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Header_NP B ON A.CPRefCode =B.CPRefCode  WHERE B.DownloadFlag ='D'

 DELETE FROM Cn2Cs_Prk_ContractPricing_Header_NP  WHERE DownloadFlag ='Y'

/* Remove Zero Percentage rows  PMS ID: ILCRSTPAR5535 Added By Lakshman M Dated ON 14-08-2019 */
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cn2Cs_Prk_ContractPricing_Detail_Zero_percent')
BEGIN

----------Remove Zero Percentage
--	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
--	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail_NP  (NOLOCK) 
--	WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0 

--	DELETE FROM Cn2Cs_Prk_ContractPricing_Detail_NP 
--	WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0 
--	--------Remove Product  Hierarchy/Product Not Available
	SET @CmpPrdCtgName=(SELECT TOP 1 CmpPrdCtgName FROM ProductCategoryLevel ORDER BY CmpPrdCtgId DESC)

	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail_NP  (NOLOCK) 
	WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product)  

	INSERT INTO Cn2Cs_Prk_ContractPricing_Detail_Zero_percent(DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate)
	SELECT DistCode,CPRefCode,PrdCatLvl,PrdCatCode,ApplyOn,DiscPer,FlatAmt,SplPrice,SPWTax,DownloadFlag,CreatedDate FROM Cn2Cs_Prk_ContractPricing_Detail_NP  
	WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName) AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) 

	--DELETE FROM Cn2Cs_Prk_ContractPricing_Detail_NP 
	--WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) 

	--DELETE FROM Cn2Cs_Prk_ContractPricing_Detail_NP 
	--WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName) AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)

	---Remove From Header	
	--DELETE A FROM Cn2Cs_Prk_ContractPricing_Header_NP A WHERE NOT EXISTS(SELECT B.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP B WHERE A.CPRefCode=B.CPRefCode)
END
/* ------------------ Till Here ----------------------*/
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP   
 WHERE ( ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR  
    ISNULL(RtrType,'')='' OR     ISNULL(CPStatus,'')='' OR  
    ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR  
    ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')='')   AND UPPER(rtrType)<>'RETAILER'

--INSERT INTO SplRateToAvoidNew  
--SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE CPRefCode  IN  
--(SELECT ComConRefNo FROM contractpricingmaster)  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE CPRefCode NOT IN  
 (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP)  
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE CPRefCode NOT IN  
 (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP)  
   
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP  
  WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)  AND UPPER(RtrType) <>'RETAILER' 
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP  
  WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory)  AND UPPER(RtrType) <>'RETAILER' 
    
 INSERT INTO SplRateToAvoidNew   
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP  
  WHERE RtrCode NOT IN (SELECT CmpRtrCode FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP   
 WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''    
    
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP   
 --WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('DISCPER','FLATAMT')  
 WHERE ISNULL(ApplyOn,'')=''  
   
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(DiscType) IN ('SPLPRICE')  
 WHERE ISNULL(SPWTax,'')='' 
  
 INSERT INTO SplRateToAvoidNew  
 SELECT DISTINCT A.CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B  
     ON A.CPRefCode=B.CPRefCode AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE')
	  
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel)  
   
 --SET @CmpPrdCtgName=(SELECT TOP 1 CmpPrdCtgName FROM ProductCategoryLevel ORDER BY CmpPrdCtgId DESC)  

 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  
 --AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) 
   
 --INSERT INTO SplRateToAvoidNew  
 --SELECT DISTINCT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
 --AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)
   
 INSERT INTO ErrorLog   
 SELECT DISTINCT 1,'Discount Master','Contract RefCode','Discount Details Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Detail_NP)  
 UNION ALL  
 SELECT DISTINCT 2,'Discount Master','Contract RefCode','Header Details Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE CPRefCode NOT IN (SELECT CPRefCode FROM Cn2Cs_Prk_ContractPricing_Header_NP)  
 UNION ALL  
 SELECT  DISTINCT 3,'Discount Master','','Mandatory Fields Cannot be Null'+CPRefCode  FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE (ISNULL(CPRefCode,'')='' OR   ISNULL(DiscType,'')='' OR ISNULL(RtrType,'')='' OR       
 ISNULL(CPStatus,'')='' OR ISNULL(RtrCatLvl,'')='' OR   ISNULL(RtrCatCode,'')='' OR ISNULL(ClassCode,'')='' OR   ISNULL(RtrCode,'')=''   ) AND UPPER(rtrType)<>'RETAILER'
 UNION ALL  
 SELECT DISTINCT 3,'Discount Master','Retailer Category Level','Retailer Category Level Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE Rtrcatlvl NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)  AND UPPER(RtrType)<>'RETAILER'  
 UNION ALL  
 SELECT DISTINCT 4,'Discount Master','Retailer Category Level Value','Retailer Category Code Not Available'+CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE RtrCatCode NOT IN (SELECT CtgCode FROM RetailerCategory)  AND UPPER(RtrType)<>'RETAILER'  
 UNION ALL    
 SELECT DISTINCT 5,'Discount Master','Retailer Code','Retailer Code Not Available'+CPRefCode    
 FROM Cn2Cs_Prk_ContractPricing_Header_NP WHERE RtrCode NOT IN (SELECT CmpRtrCode FROM Retailer ) AND UPPER(RtrType) ='RETAILER'  
 UNION ALL  
 SELECT DISTINCT 6,'Discount Master','Product Category Level','Mandatory Fields Cannot be Null'+CPRefCode     
 FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE ISNULL(PrdCatLvl,'')='' OR ISNULL(PrdCatCode,'')=''    
 --UNION ALL  
 --SELECT DISTINCT 7,'Discount Master','Discount','Discounts Cannot be Zero'+CPRefCode    
 --FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE ISNULL(DiscPer,0)+ ISNULL(FlatAmt,0)+ISNULL(SplPrice,0)=0  
 UNION ALL  
 SELECT DISTINCT 8,'Discount Master','ApllyOn','Aplly On Cannot be Null'+A.CPRefCode   
 FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(DiscType) IN ('DISCPER','FLATAMT') WHERE ISNULL(ApplyOn,'')=''  
 UNION ALL  
 SELECT DISTINCT 9,'Discount Master','WithTax','With Tax Cannot be Null'+A.CPRefCode    
 FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(DiscType) IN ('SPLPRICE') WHERE ISNULL(SPWTax,'')=''  
 UNION ALL  
 SELECT DISTINCT 10,'Discount Master','Status','Status Cannot be Null'+A.CPRefCode     
 FROM Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN Cn2Cs_Prk_ContractPricing_Detail_NP B ON A.CPRefCode=B.CPRefCode   
 AND UPPER(CPStatus) NOT IN ('ACTIVE','INACTIVE')  
 UNION ALL  
 SELECT DISTINCT 11,'Discount Master','PrdCatLvl','Product Category Level Not Available'+CPRefCode      
 FROM Cn2Cs_Prk_ContractPricing_Detail_NP WHERE PrdCatLvl NOT IN(SELECT CmpPrdCtgName FROM ProductCategoryLevel) AND UPPER(PrdCatLvl)<>(UPPER(@CmpPrdCtgName))   
 UNION ALL  
 SELECT DISTINCT 12,'Discount Master','PrdCatCode','Product Code Not Available'+CPRefCode       
 FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)   
 AND PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl) =(UPPER(@CmpPrdCtgName))   
 UNION ALL  
 SELECT DISTINCT 13,'Discount Master','PrdCatCode','Product Category Level Value Not Available'+CPRefCode        
 FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
  AND PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue)  
    
 SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_Header_NP FROM Cn2Cs_Prk_ContractPricing_Header_NP  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D'  

 SELECT DISTINCT * INTO  #Cn2Cs_Prk_ContractPricing_Detail_NP FROM Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE CPRefCode NOT IN (SELECT CPRefCode FROM SplRateToAvoidNew) AND DOWNLOADFLAG='D' 
 
 DELETE FROM #Cn2Cs_Prk_ContractPricing_Detail_NP   WHERE PrdCatCode NOT IN(SELECT PrdCtgValCode FROM ProductCategoryValue) AND UPPER(PrdCatLvl)<>UPPER(@CmpPrdCtgName)  
  
 DELETE FROM #Cn2Cs_Prk_ContractPricing_Detail_NP  WHERE PrdCatCode NOT IN(SELECT PRDCCODE FROM Product) AND UPPER(PrdCatLvl)=UPPER(@CmpPrdCtgName)  

 SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_HEADER FROM Cn2Cs_Prk_ContractPricing_Header_NP GROUP BY CPRefCode  
 SELECT CPRefCode ,MAX(CreatedDate) CREATEDDATE INTO  #MAXRECORDS_DETAILS FROM Cn2Cs_Prk_ContractPricing_Detail_NP GROUP BY CPRefCode  

 DELETE A  FROM #Cn2Cs_Prk_ContractPricing_Header_NP A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_HEADER B WHERE A.CPRefCode =B.CPRefCode AND A.CREATEDDATE = B.CREATEDDATE)

 DELETE A  FROM #Cn2Cs_Prk_ContractPricing_Detail_NP A WHERE NOT EXISTS (SELECT CPRefCode,CREATEDDATE FROM #MAXRECORDS_DETAILS B WHERE A.CPRefCode =B.CPRefCode AND A.CREATEDDATE = B.CREATEDDATE) 
 AND DOWNLOADFLAG='D'  

	INSERT INTO Cn2Cs_Prk_SpecialDiscount_NP
	SELECT DISTINCT DistCode,RTRCATLVL,RTRCATCODE,ProductLvl,PRDCATCODE,DiscPer,
	EffFromDate,EffToDate,DownLoadFlag,CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,
	CPRefName FROM  
	( 
	SELECT A.DISTCODE,RTRCATLVL,RTRCATCODE,CASE WHEN ProductLvl <> 'PRODUCT' THEN PrdCatLvl ELSE 'PRODUCT' END ProductLvl ,PRDCATCODE,DISCPER,  
	EffFromDate ,EffToDate ,'D' DownLoadFlag,A.CreatedDate ,APPLYON,CASE   WHEN ApplyOn<>'MRP' THEN '' ELSE  DiscType  END Type,  
	FlatAmt , SplPrice ,SPWTax ,A.CPRefCode ,A.CPRefName   
	FROM #Cn2Cs_Prk_ContractPricing_Header_NP  A INNER JOIN #Cn2Cs_Prk_ContractPricing_Detail_NP B ON A.CPRefCode =B.CPREFCODE  
	AND A.DOWNLOADFLAG='D' AND RtrType <>'Retailer' 
	UNION ALL
	SELECT A.DISTCODE,'RETAILER',RtrCode ,CASE WHEN ProductLvl <> 'PRODUCT' THEN PrdCatLvl ELSE 'PRODUCT' END ,PRDCATCODE,DISCPER,
	EffFromDate ,EffToDate ,'D',A.CreatedDate,APPLYON, CASE   (CONVERT(DECIMAL(18, 2),DISCPER ))WHEN 0 THEN '' ELSE  DiscType  END,
	FlatAmt , SplPrice ,SPWTax ,A.CPRefCode ,A.CPRefName 
	FROM #Cn2Cs_Prk_ContractPricing_Header_NP A INNER JOIN #Cn2Cs_Prk_ContractPricing_Detail_NP B ON A.CPRefCode =B.CPREFCODE
	AND A.DOWNLOADFLAG='D' AND RtrType ='Retailer' 
	)A ORDER BY CreatedDate,CPRefCode
   
	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Header C INNER JOIN Cn2Cs_Prk_SpecialDiscount CP  
	ON C.CPRefCode=CP.CPRefCode

	UPDATE C SET DOWNLOADFLAG='Y' FROM Cn2Cs_Prk_ContractPricing_Detail_NP C  
	INNER JOIN #Cn2Cs_Prk_ContractPricing_DETAIL_NP A ON A. CPRefCode =C.CPRefCode 
	AND C.PrdCatCode = A.PrdCatCode AND C.CPRefCode IN (SELECT CPRefCode FROM Cn2Cs_Prk_SpecialDiscount_NP)

	IF EXISTS(SELECT * FROM cn2cs_prk_specialdiscount_np WHERE Downloadflag ='D')
	BEGIN
			DELETE FROM Cn2Cs_Prk_SpecialDiscount_NP WHERE DistCode ='1009135' AND CPRefCode IN ('DISC00000152_0509','DISC00000153_0509','DISC00000202_0509','DISC00000205_0509')
		
			INSERT INTO Cn2Cs_Prk_SpecialDiscount (DistCode,RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue,DiscPer,
			EffFromDate,EffToDate,DownLoadFlag,CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,CPRefName)
			SELECT  DistCode,RetCategoryLevel,RetCatLevelValue,PrdCategoryLevel,PrdCategoryLevelValue,DiscPer,EffFromDate,EffToDate,DownLoadFlag,
			CreatedDate,ApplyOn,Type,FlatAmt,SplPrice,SPWTax,CPRefCode,CPRefName FROm Cn2Cs_Prk_SpecialDiscount_NP WHERE DownloadFlag='D' 
			AND CPRefCode NOT IN('DISC00000108_0509','DISC00000002_0509','DISC00000123_0509','DISC00000022_0509') 
			ORDER BY CreatedDate,CPRefCode

			UPDATE A SET DownLoadFlag ='C' FROM Cn2Cs_Prk_SpecialDiscount_NP(NOLOCK) A WHERE EXISTS (SELECT '8' FROM Cn2Cs_Prk_SpecialDiscount B(NOLOCK)
			 WHERE A.CPRefCode =B.CPRefCode )

			IF EXISTS(SELECT * FROM Cn2Cs_Prk_SpecialDiscount WHERE Downloadflag ='D')
			BEGIN
				EXEC Proc_Cn2Cs_SpecialDiscount 0  
			END
	END

 RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cs2Cn_DebitNoteTopSheet2' AND TYPE ='P')
DROP PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet2
GO
/*      
Begin transaction     
delete  from Cs2Cn_Prk_DebitNoteTopSheet2    
update A set rptupload =0,upload=0 from salesinvoice A where SalInvDate between '2019-06-01' and'2019-06-30'    
update A set rptupload =0,upload=0 from Returnheader A where ReturnDate between '2019-06-01' and'2019-06-30'    
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,'2019-08-14'      
EXEC Proc_Cs2Cn_DebitNoteTopSheet2 0,'2019-08-14'     
select *from Cs2Cn_Prk_DebitNoteTopSheet2 -- where cmpschcode ='SCH18547'    
--select *from cs2console_consolidated where column3 ='SCH13813' and processname like '%debitnote%'    
Rollback Transaction    
*/      
CREATE PROCEDURE Proc_Cs2Cn_DebitNoteTopSheet2    
(      
 @Po_ErrNo INT OUTPUT,      
 @ServerDate DATETIME      
)      
AS      
/*********************************      
* PROCEDURE  : Proc_Cs2Cn_DebitNoteTopSheet2       
* PURPOSE  : To Extract LMISDetails      
* CREATED BY : Aravindh Deva C      
* CREATED DATE : 03.06.2016      
* NOTE   :       
------------------------------------------------      
* {date} {developer}  {brief modification description}      
*************************************************      
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]       [DESCRIPTION]      
* 26-12-2017  S.MOORTHI  CR      ICRSTPAR7182                 Date Wise Data Upload(TransDate)    
* 18-12-2017  Lakshman. M        ICRSTPAR7106        BUG      Scheme id validation missing.Script validation added from CS.    
* 13-07-2018  Lakshman M         ILCRSTPAR1254       BZ       Report caluculation included for upload process debit note top sheet2 from CS.    
* 25/07/2018  Lakshman M         ILCRSTPAR1496       BZ       scheme code valdiation included from CS.   
* 29-03-2019  Lakshman M         ILCRSTPAR3860       BZ       upload process scheme wsie and transaction wsie scheme utilization amount validation included. 
* 14-08-2019  Lakshman M         ILCRSTPAR5513       SR       upload process scheme wsie and transaction wsie Repot logic validation included. Now both upload and report are matched. 
*************************************************/      
SET NOCOUNT ON      
BEGIN      
  SET @Po_ErrNo=0      
  DECLARE @DistCode As NVARCHAR(50)      
  DELETE FROM Cs2Cn_Prk_DebitNoteTopSheet2 WHERE UploadFlag = 'Y'      
   IF NOT EXISTS (SELECT * FROM UploadingReportTransaction (NOLOCK))      
   BEGIN      
    RETURN      
   END      
  SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)       
  DECLARE @FromDate DATETIME      
  DECLARE @ToDate DATETIME      
  --ICRSTPAR7182    
 --SELECT @FromDate = MIN(SchValidFrom),@ToDate = MAX(SchValidTill) FROM SchemeMaster S (NOLOCK)    
 --WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate BETWEEN S.SchValidFrom AND S.SchValidTill)    
  SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) FROM UploadingReportTransaction S (NOLOCK)    
 --ICRSTPAR7182 till here      
  EXEC Proc_SchUtilization_Report @FromDate,@ToDate  
  EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
  SELECT * INTO #ParleOutputTaxPercentage  FROM ParleOutputTaxPercentage (NOLOCK) 
    
  DECLARE @SlNo AS INT      
  SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'     
 ------------------ added by Lakshman M dated on 13/07/2018 Pms ID: ILCRSTPAR1254 & ILCRSTPAR1496 ------------    
 --------------------- Added By Lakshman M Dated on 14/08/2019 PMS ID:  ILCRSTPAR5513---------------    
  SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,        
  B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid       
  INTO #BillingDetails        
  FROM SalesInvoice S (NOLOCK)        
  INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId        
  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId     
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1     
 -- INNER JOIN Debitnote_Scheme D ON D.Salid = S.SalId AND SP.SalId = D.Salid AND D.Prdid =SP.PrdID AND D.linetype = 1    
  WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate  AND S.DlvSts > 3 and PBD.SLNo =3    
 
  SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,        
  B.DefaultPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid        
  INTO #ReturnDetails        
  FROM ReturnHeader S (NOLOCK)        
  INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID        
  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId        
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1  
  AND StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)    
  --INNER JOIN Debitnote_Scheme D ON D.Salid = S.ReturnID AND SP.ReturnID = D.Salid  AND D.linetype = 2    
  WHERE S.ReturnDate BETWEEN  @FromDate AND @ToDate  AND S.[Status] = 0 and PBD.SLNo =3    
  
  SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,    
  PrdBatDetailValue as PrdUnitSelRate ,Schid ,    
  CAST (0 AS NUMERIC(18,6)) AS LCTR      
  INTO #DebitSalesDetails        
  FROM         
  (        
  SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue , schid FROM #BillingDetails       
  UNION ALL        
  SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId ,SlNo,prdtaxamount,PrdBatDetailValue, schid  FROM #ReturnDetails        
  ) Consolidated     
 ------------------------- Till Here ----------------    
  UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)        
  FROM #DebitSalesDetails M (NOLOCK),        
  ProductBatchDetails D (NOLOCK)         
  WHERE M.ActualPriceId = D.PriceId AND D.SLNo = 3     
  
  UPDATE R SET R.LCTR = ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2)          
  FROM #DebitSalesDetails R (NOLOCK),        
  #ParleOutputTaxPercentage T (NOLOCK)    
  WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType      
  --------------------- Till Here ----------------        
  CREATE TABLE #ApplicableProduct      
  (      
   SchId  INT,      
   PrdId   INT      
  )    
   ----------------- added by lakshman M on 21-12-2017 sales invoice scheme added --------------      
 INSERT INTO #ApplicableProduct(SchId,PrdId)    
 SELECT DISTINCT A.SchId,B.Prdid    
  FROM SchemeMaster A    
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid    
  INNER JOIN Product C On B.Prdid = C.PrdId    
  WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0    
 UNION ALL    
 SELECT DISTINCT A.SchId,E.Prdid    
  FROM SchemeMaster A    
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid    
  INNER JOIN ProductCategoryValue C ON     
  B.PrdCtgValMainId = C.PrdCtgValMainId     
  INNER JOIN ProductCategoryValue D ON    
  D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'    
  INNER JOIN Product E On    
  D.PrdCtgValMainId = E.PrdCtgValMainId     
  INNER JOIN ProductBatch F On    
  F.PrdId = E.Prdid    
  WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0    
 UNION ALL    
 SELECT DISTINCT S.SchId,B.MasterRecordId    
  FROM SchemeProducts A     
  INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId     
  INNER JOIN SchemeMaster S ON A.SchId = S.SchId    
  WHERE S.SchemeLvlMode = 1    

  --added by mohana ILCRSTPAR0500     
 INSERT INTO #ApplicableProduct(SchId,PrdId)    
 SELECT Schid ,PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode    
 INNER JOIN Product C ON c.PrdCCode = A.FromValue    
 WHERE ChangeType='Remove'   AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0)    
 
 INSERT INTO #ApplicableProduct(SchId,PrdId)      
 SELECT DISTINCT A.SchId,E.Prdid    
 FROM SchemeMaster A    
 INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode    
 INNER JOIN ProductCategoryValue C ON     
 B.FromValue = C.PrdCtgValCode    
 INNER JOIN ProductCategoryValue D ON    
 D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'    
 INNER JOIN Product E On    
 D.PrdCtgValMainId = E.PrdCtgValMainId     
 INNER JOIN ProductBatch F On    
 F.PrdId = E.Prdid    
 WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )    
 AND ChangeType='Remove'      
 --------------- Tille Here --------------    
  CREATE TABLE #ApplicableScheme      
  (      
   SchId   INT,      
   CmpSchCode  NVARCHAR(100),      
   SchValidFrom DATETIME,       SchValidTill DATETIME,       
   Budget   NUMERIC(18,2),      
   BudgetAllocationNo VARCHAR(100),      
   PrdId INT      
  )    
 ------------- added by M. Lakshman dated on 18-12-2017 ----- Scheme id validation ----------       
 INSERT INTO #ApplicableScheme (SchId,CmpSchCode,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)       
 SELECT DISTINCT A.SchId,S.cmpschcode,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId    
 FROM #ApplicableProduct A (NOLOCK),    
 SchemeMaster S (NOLOCK)    
 WHERE A.SchId = S.SchId AND A.SchId  IN (SELECT SCHID FROM Debitnote_Scheme)     
 AND S.Claimable = 1 
 
 
 SELECT  S.SchId,B.transdate,B.TransType,SM.CmpSchCode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,    
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,    
 CAST(0 AS NUMERIC(18,6)) Amount    
 INTO #SchemeDebit1    
 FROM #ApplicableScheme S (NOLOCK),    
 #DebitSalesDetails B (NOLOCK) ,--Debitnote_Scheme D ,    
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana    
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=1 AND  --B.Schid = D.Schid  AND SM.Schid = D.Schid AND    
-- d.sCHID = s.sCHID and s.PRDID = D.PRDID AND b.PrdId = D.PRDID  and b.sALID = d.sALID AND Linetype = 1 AND     
 --PMS NO:ILCRSTPAR0909    
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate    
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate    
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate    
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)    
 (B.Transdate BETWEEN @FromDate AND @ToDate     
 or B.Transdate  BETWEEN @FromDate AND @ToDate )  -- and s.schid =678 
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type IN ('Trade Scheme','General Scheme'))  --ILCRSTPAR5132  
 GROUP BY S.SchId,SM.cmpschcode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,B.transdate,B.TransType    
 ORDER BY S.SchId

 INSERT INTO #SchemeDebit1       
 SELECT  APS.Schid,DS.transdate,DS.TransType,SM.CmpSchCode,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(SP.BaseQty) [SecSalesQty],Round(CAST((sum(SP.BaseQty*PrdBatDetailValue)+ (sum(SP.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,2)),2)  AS  [SecSalesVal],      
 CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
 from SalesInvoice S       
 inner join SalesInvoiceproduct SP ON S.salid =sp.salid       
 inner join SalesInvoiceSchemeLineWise SIL ON SIL.salid=s.salid and SIL.salid =SP.salid AND SIL.prdid =sp.prdid and sil.prdbatid =sp.PrdBatId       
 inner join #DebitSalesDetails DS ON DS.salid =S.salid AND DS.salid =SP.salid AND DS.salid =SIl.salid and DS.prdid =SP.prdid and DS.prdbatid = SP.prdbatid AND DS.prdid =SP.prdid and DS.prdbatid =SIl.prdbatid        
 inner join #ApplicableScheme APS ON APS.schid = SIL.schid AND APS.prdid =DS.prdid AND APS.Prdid =SIL.Prdid       
 inner join SchemeMaster SM ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
 inner join #ParleOutputTaxPercentage T ON T.salid =DS.salid and S.salid =T.salid and SP.Salid =T.salid AND SP.Salid =SIL.Salid and DS.slno =T.PrdSlno and T.TransId = DS.TransType       
 LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 inner join ProductBatchDetails D on D.prdbatid=SIL.prdbatid and D.prdbatid=Sp.prdbatid and D.SlNo=3 and DefaultPrice=1      
 WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  and Transtype=1 AND      
 --PMS NO:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (DS.Transdate BETWEEN @FromDate AND @ToDate       
 OR DS.TransDate BETWEEN @FromDate AND @ToDate )  ----PMS NO:ILCRSTPAR1309 Till Here      
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type NOT IN ('Trade Scheme','General Scheme'))      --ILCRSTPAR5132  
 GROUP BY APS.SchId,SM.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,SP.BaseQty,PrdBatDetailValue,T.TaxPerc
 ,DS.transdate,DS.TransType,SM.CmpSchCode     
 ORDER BY APS.SchId 

 INSERT INTO #SchemeDebit1       
 SELECT S.SchId,B.transdate,B.TransType,SM.cmpschcode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 FROM #ApplicableScheme S (NOLOCK),      
 #DebitSalesDetails B (NOLOCK) ,      
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2 AND       
 --PMSNo:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (B.Transdate BETWEEN @FromDate AND @ToDate       
 OR  B.Transdate  BETWEEN @FromDate AND @ToDate )     
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type  IN ('Trade Scheme','General Scheme'))       --ILCRSTPAR5132 
 GROUP BY S.SchId,SM.Cmpschcode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate,B.TransType       
 ORDER BY S.SchId

 INSERT INTO #SchemeDebit1      
 SELECT  APS.Schid,DS.transdate,DS.TransType,SM.cmpschcode,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(SP.BaseQty) [SecSalesQty],Round(cast((sum(SP.BaseQty*PrdBatDetailValue)+ (sum(SP.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,6)),2) AS  [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
 from Returnheader S       
 inner join Returnproduct SP ON S.Returnid =sp.Returnid       
 inner join ReturnSchemeLineDt SIL ON SIL.Returnid=s.Returnid and SIL.Returnid =SP.Returnid AND SIL.prdid =sp.prdid and sil.prdbatid =sp.PrdBatId       
 inner join #DebitSalesDetails DS ON DS.salid =S.Returnid AND DS.salid =SP.Returnid AND DS.salid =SIl.Returnid and DS.prdid =SP.prdid and DS.prdbatid = SP.prdbatid AND DS.prdid =SP.prdid and DS.prdbatid =SIl.prdbatid        
 inner join #ApplicableScheme APS ON APS.schid = SIL.schid AND APS.prdid =DS.prdid AND APS.Prdid =SIL.Prdid       
 inner join SchemeMaster SM ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
 inner join #ParleOutputTaxPercentage T ON T.salid =DS.salid and S.Returnid =T.salid and SP.Salid =T.salid AND SP.Salid =SIL.Returnid       
 and DS.slno =T.PrdSlno and T.TransId = DS.TransType       
 LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana       
 inner join ProductBatchDetails D on D.prdbatid=SIL.prdbatid and D.prdbatid=Sp.prdbatid and D.SlNo=3 and DefaultPrice=1      
 WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  and Transtype=2 AND      
 --PMS NO:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (DS.Transdate BETWEEN @FromDate AND @ToDate       
 OR DS.TransDate BETWEEN @FromDate AND @ToDate )----PMS NO:ILCRSTPAR1309 Till Here      
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type not IN ('Trade Scheme','General Scheme'))       --ILCRSTPAR5132 
 GROUP BY APS.SchId,SM.cmpschcode,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,SP.BaseQty,PrdBatDetailValue,T.TaxPerc
 ,DS.transdate,DS.TransType      
 ORDER BY APS.SchId
 
 DELETE FROM #SchemeDebit1 WHERE SchId NOT IN (SELECT Schid FROM Debitnote_Scheme WHERE Linetype=1)            

 INSERT INTO #SchemeDebit1    
 SELECT  S.SchId,B.transdate,B.TransType ,SM.CmpSchCode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,    
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,    
 CAST(0 AS NUMERIC(18,6)) Amount    
 FROM #ApplicableScheme S (NOLOCK),    
 #DebitSalesDetails B (NOLOCK) , 
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana    
 ,Debitnote_Scheme D       
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2      
 AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid     
 AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1) AND Linetype = 2    
 GROUP BY S.SchId,SM.CmpSchCode,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,B.transdate,B.TransType    
 ORDER BY S.SchId    
 
 --SELECT  SchId,transdate,CmpSchCode,SchValidFrom,SchValidTill,SchemeBudget,CircularNo, CircularDate,    
 --SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,    
 --CAST(0 AS NUMERIC(18,6)) Amount,CASE TransType WHEN 1 THEN 'Sales' WHEN 2 THEN 'Sales Return' END TransType    
 --INTO #SchemeDebit from #SchemeDebit1      
 --GROUP BY SchId,CmpSchCode,SchValidFrom,SchValidTill,SchemeBudget,CircularNo, CircularDate,transdate,TransType 
 
 SELECT  A.SchId,Transdate,TransType,A.CmpSchCode,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
 SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 INTO #SchemeDebit       
 from #SchemeDebit1 A INNER JOIN SCHEMEMASTER B ON A.schid=B.schid and B.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type IN ('Trade Scheme','General Scheme'))        --ILCRSTPAR5132
 GROUP BY A.SchId,A.transdate,TransType,A.CmpSchCode,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate 
 
 INSERT  INTO #SchemeDebit      
 SELECT  A.SchId,Transdate,TransType,A.CmpSchCode,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
 SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 from #SchemeDebit1 A      
 INNER JOIN SCHEMEMASTER B ON A.schid=B.schid and B.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type NOT IN ('Trade Scheme','General Scheme') )      --ILCRSTPAR5132  
 GROUP BY A.SchId,Transdate,TransType,A.CmpSchCode,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate      

 -------------------  Added by lakshman M dated on 29-03-2019 PMS ID: ILCRSTPAR3860 ----
  SELECT DISTINCT TaxPerc,B.SalId,B.PrdId  INTO #TaxPerc FROM SalesInvoiceProduct B   
  INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.SalId and  B.SlNo = P.PrdSlno AND TRANSID = 1   
  --Till Here   
	
  SELECT salid,Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt INTO #SchFinal 
  FROM   
  (  
	  SELECT salid,A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt   
	   FROM (  
			  --ILCRSTPAR2868  
			  --SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A   
			  --INNER JOIN SalesInvoiceProduct B ON A.Salid = b.SalId AND a.Prdid = b.PrdId    
			  --INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.SalId AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 1 AND Linetype = 1  
			  --GROUP BY  A.PRDID,A.SchId,TaxPerc  
			  SELECT  A.salid,Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A   
			  INNER JOIN #TaxPerc B ON A.Salid = b.SalId AND a.Prdid = b.PrdId AND Linetype = 1 -- where   schid = 1983    
			  GROUP BY  A.PRDID,A.SchId,TaxPerc,A.salid 
			  --Till Here  
			)A  
  GROUP BY A.SchId,TaxPerc,salid  
  )B Group by  sCHID,salid   
  
	  insert into #SchFinal  
	  SELECT salid,Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt FROM   
	  (  
	  SELECT A.salid,A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt      
	  FROM (  
	  SELECT A.salid,Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt   
	  FROM Debitnote_Scheme A INNER JOIN RETURNPRODUCT B ON A.Salid = b.ReturnID AND a.Prdid = b.PrdId   
	  INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.ReturnID AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 2 AND a.Linetype =2  
	  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1) 
	  GROUP BY  A.PRDID,A.SchId,TaxPerc,A.salid  
	  )A  
	  GROUP BY A.SchId,TaxPerc,salid 
	  )B Group by  sCHID,salid   

	SELECT DISTINCT  SALINVDATE,SD.SCHID,CASE S.APPLYTAXFORCLAIM WHEN 0 THEN SCHAMT ELSE  (SCHAMT+TAXAMT) END AS SCHAMT INTO #SCHTAXFINAL
	FROM #SCHEMEDEBIT SD (NOLOCK) INNER JOIN (SELECT DISTINCT SALINVDATE ,SCHID,SUM(SCHAMT) SCHAMT ,SUM(TAXAMT) TAXAMT FROM  #SCHFINAL A INNER JOIN SALESINVOICE S ON A.SALID =S.SALID  
	GROUP BY SCHID,SALINVDATE) D  ON SD.SCHID = D.SCHID --CHANGED FOR CLAIMAMTMISMATCH  
	INNER JOIN SCHEMEMASTER S ON S.SCHID = D.SCHID AND S.SCHID = SD.SCHID AND SD.TRANSDATE=D.SALINVDATE --WHERE  SD.SCHID = 1983 
	
	SELECT DISTINCT  Returndate,SD.SCHID,CASE S.APPLYTAXFORCLAIM WHEN 0 THEN SCHAMT ELSE  (SCHAMT+TAXAMT) END AS SCHAMT INTO #SCHTAXFINAL1
	FROM #SCHEMEDEBIT SD (NOLOCK) INNER JOIN (SELECT DISTINCT Returndate ,SCHID,SUM(SCHAMT) SCHAMT ,SUM(TAXAMT) TAXAMT FROM  #SCHFINAL A
	 INNER JOIN ReturnHeader 
	 S ON A.SALID =S.ReturnID ANd a.SchAmt <0   
	GROUP BY SCHID,Returndate) D  ON SD.SCHID = D.SCHID --CHANGED FOR CLAIMAMTMISMATCH  
	INNER JOIN SCHEMEMASTER S ON S.SCHID = D.SCHID AND S.SCHID = SD.SCHID AND SD.TRANSDATE=D.Returndate --WHERE  SD.SCHID = 1983 
	UPDATE SD SET SD.AMOUNT = D.SCHAMT
	FROM #SCHEMEDEBIT SD (NOLOCK) INNER JOIN #SCHTAXFINAL D  ON SD.SCHID = D.SCHID --CHANGED FOR CLAIMAMT MISMATCH  
	INNER JOIN SCHEMEMASTER S ON S.SCHID = D.SCHID AND S.SCHID = SD.SCHID  
	AND D.SALINVDATE=SD.TRANSDATE
	
	
	UPDATE SD SET SD.AMOUNT = D.SCHAMT
	FROM #SCHEMEDEBIT SD (NOLOCK) INNER JOIN #SCHTAXFINAL1 D  ON SD.SCHID = D.SCHID --CHANGED FOR CLAIMAMT MISMATCH  
	INNER JOIN SCHEMEMASTER S ON S.SCHID = D.SCHID AND S.SCHID = SD.SCHID  
	AND D.ReturnDate=SD.TRANSDATE
	------------------------ Till here PMS ID: ILCRSTPAR5513--------------- 
	------------------------ till here PMS ID: ILCRSTPAR3860 ---------------
	  
 --UPDATE SD SET SD.Amount = schamt    
 --FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid ,Salinvdate ,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt    
 --FROM Debitnote_Scheme where Linetype = 1  group by Schid,Salinvdate )D  ON SD.Schid = D.Schid AND SD.TransDate =D.Salinvdate    
 --ANd transType = 'Sales'    
 --UPDATE SD SET SD.Amount = schamt    
 --FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid ,Salinvdate ,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt    
 --FROM Debitnote_Scheme where Linetype = 2  group by Schid,Salinvdate)D  ON SD.Schid = D.Schid AND SD.TransDate =D.Salinvdate    
 --ANd transType = 'Sales Return'  
 UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))    
 FROM #SchemeDebit SD (NOLOCK)    
 WHERE SD.[SecSalesVal] <> 0

  INSERT INTO Cs2Cn_Prk_DebitNoteTopSheet2 (DistCode,CmpSchCode,SecSalesQty,SecSalesVal,Liab,Amount,      
  UploadFlag,SyncId,ServerDate,TransDate,TransType)      
  SELECT @DistCode,CmpSchCode,[SecSalesQty],[SecSalesVal],Liab,Amount,'N' UploadFlag,NULL,@ServerDate,TransDate,TransType    
  FROM #SchemeDebit    
 --ICRSTPAR7182    
 UPDATE A SET UPLOAD=1 FROM DebitNoteTopSheet2Track A(NOLOCK) WHERE Upload=0 and TransDate=@FromDate    
 --ICRSTPAR7182    
 RETURN         
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ReturnToBloackRetailerColumns' AND TYPE ='FN')
DROP FUNCTION Fn_ReturnToBloackRetailerColumns
GO
--SELECT DBO.Fn_ReturnToBloackRetailerColumns(68,0,'NewSalesman',1,2) AS Validate
CREATE FUNCTION Fn_ReturnToBloackRetailerColumns(@TransId	INT,
@RefId		INT,
@ColumnName	VARCHAR(100),
@Mode AS INT,
@UsrId	INT
)
RETURNS VARCHAR(100)
AS
/********************************************************************************************************************** 
* FUNCTION  :	 Fn_ReturnToBloackRetailerColumns  
* PURPOSE  :	 To Validate Columns to Edit
* CREATED BY :	 S.MOORTHI  
* CREATED DATE : 24/06/2019  
* MODIFIED  
* DATE        AUTHOR   CR/BZ	    USER STORY ID		DESCRIPTION           
-----------------------------------------------------------------------        
 26/06/2019	 S.Moorthi	  CR		CRCRSTPAR0071		Salesman and Route master access level changes in user login
 25-07-2019  Lakshman M   SR        ILCRSTPAR5307       userlogin retailer route and value class edit valiation included.
***********************************************************************************************************************/ 
BEGIN
DECLARE @ReturMsg AS VARCHAR(1000)
SET @ReturMsg=''
DECLARE @DisplayMsg AS VARCHAR(100)
SET @DisplayMsg=''
	
	IF @UsrId<>1000 ---1000 AS ETL
	BEGIN	
		IF NOT EXISTS(SELECT * FROM Users WHERE UserId=@UsrId and UPPER(UserName) in ('SA','SMADMIN'))
		BEGIN
			IF @TransId=79 AND @Mode=2
			BEGIN
				IF @ColumnName IN ('DlvRMId','SalesRMIdAdd','SalesRMIdRemove','Frequency','ValueClassAdd','ValueClassRemove') 
				BEGIN
					SET @ReturMsg='Access Denied'
				END
			END
			
			
			IF @TransId=68
			BEGIN
				IF NOT EXISTS(SELECT * FROM Users WHERE UserId=@UsrId and UPPER(UserName) in ('SA','SMADMIN','ASM'))
				BEGIN
					IF @ColumnName IN ('NewSalesman') AND @Mode=1
					BEGIN
						SET @ReturMsg='Access Denied'
					END
				
					IF @ColumnName IN ('RouteRemove','RouteAdd','SMCODE') AND @Mode=2
					BEGIN
						SET @ReturMsg='Access Denied'
					END
				END			
			END
			
			
			IF @TransId=78 AND @Mode=2
			BEGIN
			IF NOT EXISTS(SELECT * FROM Users WHERE UserId=@UsrId and UPPER(UserName) in ('SA','SMADMIN','ASM'))
			BEGIN
				IF @ColumnName IN ('FraDays') 
				BEGIN
					SET @ReturMsg='Access Denied'
				END
			END
			END
			
			IF @TransId=78 AND @Mode=1
			BEGIN
			IF NOT EXISTS(SELECT * FROM Users WHERE UserId=@UsrId and UPPER(UserName) in ('SA','SMADMIN','ASM'))
			BEGIN
				IF @ColumnName IN ('NewRoute') 
				BEGIN
					SET @ReturMsg='Access Denied'
				END
			END
			END
		END
	END
	
	IF @ReturMsg<>''
	BEGIN
		RETURN @ReturMsg
	END
	
	IF EXISTS(SELECT * FROM ManualConfiguration WHERE ModuleId='RETAILERBLOCK1' AND Status=1)
	BEGIN
		
		IF @TransId=79 AND @RefId<>0
		BEGIN
			----------- added by lakshman M Dated ON 25-07-2019 PMS ID: ILCRSTPAR5307
				IF @ColumnName IN ('RtrName','RtrStatus','ValueClassAdd','ValueClassRemove','Geography','GeographyLevel') AND @Mode<>1 AND @usrid <>(SELECT userid FROM Users WHERE UserId=@UsrId and UPPER(UserName)  NOT IN ('SA','SMADMIN'))
				BEGIN				
					SET @ReturMsg='Access Denied,Can''''t be modify in locally'
				END
			--------------- Till here -------------------
		END
		IF @TransId=68 AND @RefId<>0
		BEGIN
			IF NOT EXISTS(SELECT * FROM Users WHERE UserId=@UsrId and UPPER(UserName) in ('SA','SMADMIN','ASM'))
			BEGIN
			----------- added by lakshman M Dated ON 25-07-2019 PMS ID: ILCRSTPAR5307
				IF @ColumnName IN ('RtrName','RtrStatus','ValueClassAdd','ValueClassRemove','Geography','GeographyLevel') AND @Mode<>1 AND @usrid <>(SELECT userid FROM Users WHERE UserId=@UsrId and UPPER(UserName)  NOT IN ('SA','SMADMIN','ASM'))
				BEGIN				
					SET @ReturMsg='Access Denied,Can''''t be modify in locally'
				END
			END
			--------------- Till here -------------------
		END
		IF @TransId=227
		BEGIN
			IF @ColumnName IN ('NewChangeReq','LoadRetailer') AND @Mode<>1
			BEGIN				
				SET @ReturMsg='Retailer Classification details can not be modify in locally '
			END	
		END
	END
RETURN @ReturMsg
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_InsertContractPricingForNewProduct' And Type ='P')
DROP Procedure Proc_InsertContractPricingForNewProduct
GO
/*
BEGIN TRAN
select * from ProductBatchPriceWithCounter
EXEC Proc_InsertContractPricingForNewProduct   
select * from ProductBatchPriceWithCounter 
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_InsertContractPricingForNewProduct
AS
/******************************************************************************  
* PROCEDURE : Proc_InsertContractPricingForNewProduct  
* PURPOSE : To Raise Contract Pricing
* CREATED : S.MOHANA  
* CREATED DATE : 19/04/2018  
* USER STORY ID : CRCRSTPAR0058           
-------------------------------------------------------------------------------------------------------------
* 06-06-2019      MOHANA       CR   CRCRSTPAR0058   INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE  
* 13-08-2019      Lakshman M   BZ   ILCRSTPAR5522   While downlaod new product specail discount create validation missing in core stocky.
* 04-09-2019      MOHANA S    SR  ILCRSTPAR5800   INCLUDED RETAILER WISE CONTRACT PRICING 
*******************************************************************************/
BEGIN

EXEC PROC_GR_BUILD_PH
      
       CREATE TABLE #TempProductBatch
       (
              PrdId           BIGINT,
              CtgValMainId    BIGINT,
              Rtrid                BIGINT,
              ContractId      BIGINT,
              PrdBatId        BIGINT,
              DefaultPriceId  BIGINT,
              PrdCtgvalcode   NVARCHAR(100),
              ApplyON         INT,
              CpRefNo                    NVARCHAR(100)
       )
       CREATE TABLE #Product
       (
              Prdid BIGINT
       )
       CREATE TABLE #ProductCategory
      (
              PrdId BIGINT,
              PrdCtgValMainId   BIGINT,
              PrdctgValmainCode NVARCHAR(100)
       )

       CREATE TABLE  #SpecialContractDetails1
       (
              [ContractId]         BIGINT NULL,
              [PrdId]                           BIGINT NOT NULL,
              [PrdBatId]                 NUMERIC(18, 0) NULL,
              [PriceId]                  BIGINT NOT NULL,
              [CtgLevelId]         BIGINT NOT NULL,
              [CtgMainId]                BIGINT NOT NULL,
              [SplRate]                  NUMERIC(38, 13) NULL,
              [RtrCtgValueCode]    NVARCHAR(100) NULL,
              [ApplyOn]                  NVARCHAR(100) NULL,
              [Type]                     NVARCHAR(100) NULL,
              [CtgValMainId]             BIGINT NOT NULL,
              [RtrId]                           BIGINT NOT NULL,
              [RTRCODE]                  NVARCHAR(100) NOT NULL,
              [CpRefNo]                  NVARCHAR(100) NOT NULL
       )  


              INSERT INTO #ProductCategory(PrdId,PrdCtgValMainId,PrdctgValmainCode)
              SELECT A.PRDID,A.PrdCtgValMainId,A.PrdctgValmainCode
              FROM (
              SELECT A.PrdId,COMPANY_Id AS PrdCtgValMainId,COMPANY_Code AS PrdctgValmainCode  FROM TBL_GR_BUILD_PH A (NOLOCK)  UNION
              SELECT A.PrdId,Category_Id,Category_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)   UNION
              SELECT A.PrdId,Brand_Id,Brand_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)  UNION
              SELECT A.PrdId,PriceSlot_Id,PriceSlot_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)   UNION
              SELECT A.PrdId,Flavor_Id,Flavor_Code  FROM TBL_GR_BUILD_PH A (NOLOCK)  
              )A INNER JOIN Product B ON A.PrdId = B.PrdId AND PrdStatus = 1
            INNER JOIN ProductBatchPriceWithCounter P(NOLOCK) ON A.PrdId = B.PrdId AND B.PrdId = P.PrdId 
       
      
              INSERT INTO #TempProductBatch(PrdId,CtgValMainId,Rtrid,ContractId,PrdBatId,DefaultPriceId,Prdctgvalcode,ApplyON,CpRefNo)
              SELECT DISTINCT A.PrdId,A.CtgValMainId,A.RtrId,A.ContractId,A.PrdBatId,A.DefaultPriceId,A.PrdctgValmainCode,A.ApplyOn,COMCONREFNO FROM 
              (
                        SELECT DISTINCT C.PrdId,B.CtgValMainId,RtrId,CtgMainId,MAX(A.ContractId) ContractId,PB.PrdBatId,PB.DefaultPriceId,PrdctgValmainCode,ApplyOn  FROM 
                        ContractPricingMaster A (NOLOCK)
                        INNER JOIN ContractPricingDetails B(NOLOCK) ON A.ContractId=B.ContractId 
                        INNER JOIN #ProductCategory C(NOLOCK) ON B.CtgValMainId=C.PrdCtgValMainId 
                        INNER JOIN ProductBatch PB(NOLOCK) ON PB.PrdId=C.PrdId
                        WHERE B.CtgValMainId<>0 and A.Status=1 AND PB.STATUS = 1 AND  
                        CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN A.ValidFromDate AND A.ValidTillDate AND  ISNULL(ComConRefNo,'')<>''
                                    AND B.ApplyOn IS NOT NULL
                        GROUP BY C.PrdId,B.CtgValMainId,RtrId,PB.PrdBatId,PB.DefaultPriceId,PrdctgValmainCode,ApplyOn,CtgMainId
              )A INNER JOIN ContractPricingMaster B(NOLOCK) ON A.ContractId =B.ContractId

              SELECT DISTINCT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCtgLevel AS PrdCCode ,MAX(CreatedDate) AS CreatedDate,ISNULL(CPRefNO,'') CPRefNO  
              INTO #SpecialRateCreatedDat1  
              FROM SpecialRate_Track A WITH(NOLOCK)
              WHERE  PrdCCode ='' AND CPRefNO <>'' GROUP BY RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCtgLevel,CPRefNO ORDER BY PrdCtgLevel
            
              SELECT DISTINCT A.RtrCtgCode,A.RtrCtgValueCode,A.RtrCode,B.PrdCCode,A.CreatedDate ,A.ApplyOn,A.TYPE,ISNULL(A.CPRefNO,'') CPRefNO 
              INTO #SpecialRateCreatedDat
              FROM SpecialRate_Track A WITH(NOLOCK) INNER JOIN  #SpecialRateCreatedDat1 B (NOLOCK) 
              ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode  = B.RtrCtgValueCode AND A.RtrCode= B.RtrCode AND A.PrdCtgLevel= B.PrdCCode
              AND A.CreatedDate = B.CreatedDate AND A.ApplyOn is not null AND A.PrdCCode ='' AND ISNULL(A.CPRefNO,'') =B.CPRefNO
              AND A.CPRefNO <>''
                           
              SELECT DISTINCT C.PrdId,E.PrdBatId,D.DefaultPriceid AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode, CASE  A.RtrCode WHEN ''  Then 'ALL' ELSE  A.RtrCode END RtrCode,A.PrdCtgcode,  
              D.PrdBatCode,DiscountPerc,A.Applyon,B.Type,
              (CASE B.ApplyOn WHEN 'MRP' THEN 
              (CASE B.[Type] WHEN 'Mark Up' THEN (MRP*100/(100+DiscountPerc)) WHEN 'Mark down' THEN MRP-(MRP*(DiscountPerc/100))
              ELSE SellingRate-(SellingRate*(DiscountPerc/100))  END)     
              ELSE SellingRate-(SellingRate*(DiscountPerc/100)) END) AS SplRate,B.CPREFNO
              INTO #SpecialRateDet1   
              FROM SpecialRate_Track A WITH(NOLOCK)  
              INNER JOIN #SpecialRateCreatedDat B ON A.RtrCtgCode = B.RtrCtgCode AND A.RtrCtgValueCode = B.RtrCtgValueCode   
              AND A.RtrCode = B.RtrCode AND A.PrdCtglevel = B.PrdCCode AND A.CreatedDate=B.CreatedDate  AND A.ApplyOn = B.ApplyOn 
              INNER JOIN #TempProductBatch T ON T.PrdCtgvalcode  = A.PrdCtgCode AND  (CASE B.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON 
              AND  (CASE A.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON
              AND T.CPREFNO=ISNULL(A.CPREFNO,'') AND B.CPREFNO= T.CPREFNO
              INNER JOIN Product C WITH(NOLOCK) ON T.PrdId = C.Prdid     
              INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId  
              INNER JOIN ProductBatchPriceWithCounter E(NOLOCK) ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId  
              INNER JOIN #ProductCategory PP(NOLOCK) ON C.Prdid =PP.Prdid AND PP.PrdctgValmainCode = T.PrdCtgvalcode  AND T.Rtrid = 0
              ORDER BY A.PrdCtgcode  


              INSERT INTO #SpecialRateDet1
              SELECT DISTINCT C.PrdId,E.PrdBatId,D.DefaultPriceid AS PriceId,A.RtrCtgCode,A.RtrCtgValueCode, CASE  A.RtrCode WHEN ''  Then 'ALL' ELSE  A.RtrCode END RtrCode,A.PrdCtgcode,  
              D.PrdBatCode,DiscountPerc,A.Applyon,B.Type,
              (CASE B.ApplyOn WHEN 'MRP' THEN 
              (CASE B.[Type] WHEN 'Mark Up' THEN (MRP*100/(100+DiscountPerc)) WHEN 'Mark down' THEN MRP-(MRP*(DiscountPerc/100))
              ELSE SellingRate-(SellingRate*(DiscountPerc/100))  END)     
              ELSE SellingRate-(SellingRate*(DiscountPerc/100)) END) AS SplRate,B.CPREFNO            
              FROM SpecialRate_Track A WITH(NOLOCK)  
              INNER JOIN #SpecialRateCreatedDat B ON A.RtrCode  = B.RtrCode-- AND A.RtrCtgValueCode = B.RtrCtgValueCode   
              AND A.RtrCode = B.RtrCode AND A.PrdCtglevel = B.PrdCCode AND A.CreatedDate=B.CreatedDate  AND A.ApplyOn = B.ApplyOn 
              INNER JOIN #TempProductBatch T ON T.PrdCtgvalcode  = A.PrdCtgCode AND  (CASE B.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON 
              AND T.CPREFNO=ISNULL(A.CPREFNO,'') AND B.CPREFNO= T.CPREFNO AND T.Rtrid <> 0
              AND  (CASE A.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON
              INNER JOIN Product C WITH(NOLOCK) ON T.PrdId = C.Prdid     
              INNER JOIN ProductBatch D WITH(NOLOCK) ON C.PrdId = D.PrdId 
              INNER JOIN ProductBatchPriceWithCounter E(NOLOCK) ON C.PrdId = E.PrdId AND D.PrdBatId = E.PrdBatId  
              INNER JOIN #ProductCategory PP(NOLOCK) ON C.Prdid =PP.Prdid AND PP.PrdctgValmainCode = T.PrdCtgvalcode  
              ORDER BY A.PrdCtgcode  

              SELECT contractid,PrdBatId into #temp FROM ContractPricingDetails  a(NOLOCK)
              WHERE EXISTS(SELECT * FROM ProductBatchPriceWithCounter B(NOLOCK) WHERE A.Prdbatid=b.PrdBatId)

            SELECT D.ContractId,RtrId ,CtgMainId ,CtgLevelId ,ComConRefNo,E.CtgValMainId,PrdId,PrdBatId  INTO #ContractPricing 
            FROM ContractPricingMaster D WITH(NOLOCK) --ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId   
              INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId 
             --AND PrdId IN (SELECT DISTINCT PrdId FROM #ProductCategory(NOLOCK))  
            AND  NOT EXISTS(SELECT * fROM  #temp TB(NOLOCK) WHERE D.CONTRACTID=TB.CONTRACTID and  E.CONTRACTID=TB.CONTRACTID AND E.Prdbatid=TB.PrdBatId)
              
              INSERT INTO #SpecialContractDetails1
              --SELECT DISTINCT MAX(E.ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,
              --SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,E.CtgValMainId,0 RtrId,'ALL' RTRCODE,ISNULL(A.CpRefNo,'')CpRefNo
              --FROM #SpecialRateDet1 A WITH(NOLOCK) 
              --INNER JOIN RetailerCategoryLevel B WITH(NOLOCK) ON A.RtrCtgCode = B.CtgLevelName 
              --INNER JOIN RetailerCategory C WITH(NOLOCK) ON A.RtrCtgValueCode = C.CtgCode AND B.CtgLevelId = C.CtgLevelId AND RTRCODE='ALL'
              ----INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId 
              ----INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId AND              
              --INNER JOIN  #TempProductBatch T(NOLOCK) ON A.PrdId = T.PrdId AND  (CASE A.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON 
              --INNER JOIN #ProductCategory PP(NOLOCK) ON T.prdid  =PP.Prdid   AND  E.CtgValMainId = PP.PrdCtgValMainId AND A.CpRefNo = T.CpRefno
              --AND D.ComConRefno = T.CpRefno AND   D.ComCOnRefno = A.CpRefno               
              --GROUP BY A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,E.CtgValMainId,A.CpRefNo
            SELECT DISTINCT MAX(D .ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,  
              SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,D.CtgValMainId,0 RtrId,'ALL' RTRCODE,ISNULL(A.CpRefNo,'')CpRefNo  
              FROM #SpecialRateDet1 A WITH(NOLOCK)   
              INNER JOIN RetailerCategoryLevel B WITH(NOLOCK) ON A.RtrCtgCode = B.CtgLevelName   
              INNER JOIN RetailerCategory C WITH(NOLOCK) ON A.RtrCtgValueCode = C.CtgCode AND B.CtgLevelId = C.CtgLevelId AND RTRCODE='ALL'  
              --INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId   
              --INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId   
              INNER JOIN #ContractPricing D  ON B.CtgLevelId = D.CtgLevelId AND C.CtgMainId = D.CtgMainId   
              INNER JOIN  #TempProductBatch T ON A.PrdId = T.PrdId AND  (CASE A.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON   
              INNER JOIN #ProductCategory PP ON T.prdid  =PP.Prdid   AND  D.CtgValMainId = PP.PrdCtgValMainId AND A.CpRefNo = T.CpRefno  
              AND D.ComConRefno = T.CpRefno AND   D.ComCOnRefno = A.CpRefno  
              WHERE NOT EXISTS(SELECT * fROM  #temp TB(NOLOCK) WHERE D.CONTRACTID=TB.CONTRACTID and  D.CONTRACTID=TB.CONTRACTID AND D.Prdbatid=TB.PrdBatId)  
              GROUP BY A.PrdId,A.PrdBatId,A.PriceId,B.CtgLevelId,C.CtgMainId,SplRate,RtrCtgValueCode,A.ApplyOn, A.Type,D.CtgValMainId,A.CpRefNo  


              INSERT INTO #SpecialContractDetails1
              SELECT DISTINCT MAX(E.ContractId) AS ContractId,A.PrdId,A.PrdBatId,A.PriceId,0 CtgLevelId, 0 CtgMainId,
              SplRate,'ALL' RtrCtgValueCode,A.ApplyOn, A.Type,E.CtgValMainId,R.Rtrid,R.CmpRtrCode,A.CpRefNo           
              FROM #SpecialRateDet1 A WITH(NOLOCK) 
              INNER JOIN Retailer R ON A.RTRCODE=R.CMPRTRCODE AND A.RTRCODE<>'ALL'
              INNER JOIN ContractPricingMaster D WITH(NOLOCK) ON R.RTRID = D.RtrId
              INNER JOIN ContractPricingDetails E WITH(NOLOCK) ON D.ContractId = E.ContractId 
              INNER JOIN  #TempProductBatch T ON A.PrdId = T.PrdId AND  (CASE A.ApplyOn WHEN 'MRP' THEN 1 WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2  END )=T.ApplyON 
              INNER JOIN #ProductCategory PP ON T.prdid  =PP.Prdid   AND  E.CtgValMainId = PP.PrdCtgValMainId
              AND A.CpRefNo = T.CpRefno AND D.ComCOnRefno = T.CpRefno AND   D.ComCOnRefno = A.CpRefno
              WHERE NOT EXISTS(SELECT * fROM  #temp TB WHERE D.CONTRACTID=TB.CONTRACTID and  E.CONTRACTID=TB.CONTRACTID AND E.Prdbatid=TB.PrdBatId)
              GROUP BY A.PrdId,A.PrdBatId,A.PriceId ,SplRate,A.ApplyOn, A.Type,E.CtgValMainId,R.Rtrid,R.CmpRtrCode,A.CpRefNo
              ORDER BY PRDID 
                       
                       
        ---Tax Calculation
        DECLARE @PrdIdTax as BIGINT
        DECLARE @PrdbatIdTax AS BIGINT
        DECLARE Cur_Tax CURSOR
        FOR 
        SELECT DISTINCT PrdId,PrdbatId FROM #SpecialContractDetails1       
        OPEN Cur_Tax      
        FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax
        WHILE @@FETCH_STATUS=0
        BEGIN 
                    EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax
        FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax         
        END         
        CLOSE Cur_Tax
        DEALLOCATE Cur_Tax      
      
                  
        DECLARE @ExtPriceId AS BIGINT
        SELECT @ExtPriceId =MAX(PriceId) FROM ProductBatchDetails
        SELECT DISTINCT A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,
            DENSE_RANK ()OVER (ORDER BY A.PriceId,A.PrdbatId,RtrCtgValueCode,Rtrid,NewSelRate)+@ExtPriceId AS NewPriceId,
            NewSelRate,CtgValMainId,Rtrid,CpRefNo
            INTO #SplProductBatchDetails1
            FROM(
            SELECT DISTINCT A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,Rtrid,
        CASE A.ApplyOn WHEN 'MRP' THEN (CASE [Type] WHEN 'MARK UP' THEN (SplRate*100)/(100+TaxPercentage)
                                                    WHEN 'MARK DOWN' THEN (SplRate*100)/(100+TaxPercentage)   END)
        ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSelRate,CtgValMainId,CpRefNo
        FROM #SpecialContractDetails1 A WITH(NOLOCK) INNER JOIN ProductBatchTaxPercent B WITH(NOLOCK) ON A.PrdId = B.PrdId  
        AND A.PrdBatId = B.PrdBatId)A ORDER BY A.PrdId,A.PrdBatId,PriceId,RtrCtgValueCode,CtgValMainId,Rtrid,CpRefNo



              IF EXISTS (SELECT DISTINCT '*' FROM ProductBatchDetails A WITH(NOLOCK) 
                                  INNER JOIN #SplProductBatchDetails1 B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId
                                  INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId
                                                              INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo
                                  INNER JOIN #ProductCategory P (NOLOCK) ON B.CtgValMainId = P.PrdCtgValMainId AND P.PrdId =C.PrdId)
              BEGIN            
                    INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
                    Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload) 
                    SELECT DISTINCT NewPriceId,A.PrdBatId,PriceCode+'SplRate'+CONVERT(NVARCHAR(200),B.NewSelRate)+CONVERT(NVARCHAR(10),GETDATE(),121),
                    A.BatchSeqId,A.SLNo,(CASE SelRte WHEN 1 THEN B.NewSelRate ELSE PrdBatDetailValue END),0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
                    CONVERT(NVARCHAR(10),GETDATE(),121),0
                    FROM ProductBatchDetails A WITH(NOLOCK) 
                    INNER JOIN #SplProductBatchDetails1 B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId
                    INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId
                    INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo
                    INNER JOIN #ProductCategory P (NOLOCK) ON B.CtgValMainId = P.PrdCtgValMainId AND P.PrdId =C.PrdId 
                    INNER JOIN #SpecialContractDetails1 S ON S.PrdId = B.PrdID AND S.PrdBatId = B.PrdBatId AND S.RtrCtgValueCode=B.RtrCtgValueCode
                    AND RTRCODE='ALL'  AND S.CpRefNO = B.CpRefNO
                    WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE S.ContractId = C.ContractId 
                    AND S.PrdId = C.PrdID AND S.PrdBatId = C.PrdBatId) 
                    ORDER BY A.PrdBatId,NewPriceId  

                    INSERT INTO ProductBatchDetails (PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
                    Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload) 
                    SELECT DISTINCT NewPriceId,A.PrdBatId,PriceCode+'SplRate'+CONVERT(NVARCHAR(200),B.NewSelRate)+CONVERT(NVARCHAR(10),GETDATE(),121),
                    A.BatchSeqId,A.SLNo,(CASE SelRte WHEN 1 THEN B.NewSelRate ELSE PrdBatDetailValue END),0,1,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,
                    CONVERT(NVARCHAR(10),GETDATE(),121),0
                    FROM ProductBatchDetails A WITH(NOLOCK) 
                    INNER JOIN #SplProductBatchDetails1 B ON A.PrdBatId = B.PrdBatId AND A.PriceId = B.PriceId
                    INNER JOIN ProductBatch C WITH(NOLOCK) ON A.PrdBatId = C.PrdBatId
                    INNER JOIN BatchCreation D WITH(NOLOCK) ON C.BatchSeqId = D.BatchSeqId AND A.SLNo = D.SlNo
                    INNER JOIN #ProductCategory P (NOLOCK) ON B.CtgValMainId = P.PrdCtgValMainId AND P.PrdId =C.PrdId 
                    INNER JOIN #SpecialContractDetails1 S ON S.PrdId = B.PrdID AND S.PrdBatId = B.PrdBatId AND S.RTRID=B.RTRID
                    AND RTRCODE<>'ALL' AND S.CpRefNO = B.CpRefNO
                    WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE S.ContractId = C.ContractId 
                    AND S.PrdId = C.PrdID AND S.PrdBatId = C.PrdBatId) 
                    ORDER BY A.PrdBatId,NewPriceId 
              
                    UPDATE Counters SET CurrValue =(SELECT MAX(PriceId) FROM ProductBatchDetails) WHERE TabName = 'ProductBatchDetails' AND FldName = 'PriceId'
              
                    INSERT INTO ContractPricingDetails (ContractId,PrdId,PrdBatId,PriceId,Discount,FlatAmtDisc,Availability,LastModBy,LastModDate,AuthId,
                    AuthDate,CtgValMainId,ClaimablePercOnMRP,ApplyOn,WithTax,SpecialPrice)            
                    SELECT DISTINCT ContractId,A.PrdId,A.PrdBatId,B.NewPriceId,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),
                    a.CtgValMainId,0,CASE UPPER(LTRIM(RTRIM(ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END as Applyon,0,0
                    FROM #SpecialContractDetails1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdID AND A.PrdBatId = B.PrdBatId AND A.RtrCtgValueCode=B.RtrCtgValueCode
                    AND RTRCODE='ALL' AND A.CpRefNO = B.CpRefNO
                    WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE A.ContractId = C.ContractId 
                    AND A.PrdId = C.PrdID AND A.PrdBatId = C.PrdBatId) 
                    UNION ALL
                    SELECT DISTINCT ContractId,A.PrdId,A.PrdBatId,B.NewPriceId,0,0,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121),
                    a.CtgValMainId,0,CASE UPPER(LTRIM(RTRIM(ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END as Applyon,0,0
                    FROM #SpecialContractDetails1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdID AND A.PrdBatId = B.PrdBatId
                    AND A.RTRID=B.RTRID AND RTRCODE<>'ALL' AND A.CpRefNO = B.CpRefNO
                    WHERE NOT EXISTS (SELECT ContractId FROM ContractPricingDetails C WITH(NOLOCK) WHERE A.ContractId = C.ContractId 
                    AND A.PrdId = C.PrdID AND A.PrdBatId = C.PrdBatId)                          

                    INSERT INTO SpecialRateAftDownload (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,
                    ContractPriceIds,DiscountPerc,SplrateId)
                    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,CASE A.RtrCode WHEN '' THEN 'ALL' ELSE A.RtrCode END,P.PrdCCode,A.PrdBatCode,B.NewSelRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
                    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0
                    FROM #SpecialRateDet1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
                    and A.RtrCtgValueCode=B.RtrCtgValueCode AND RTRCODE='ALL'  AND A.CpRefNO = B.CpRefNO
                    INNER JOIN Product P(NOLOCK) ON A.Prdid = P.Prdid AND B.PrdId = P.PrdId
                    INNER JOIN #ProductCategory PC ON B.CtgValMainId = PC.PrdCtgValMainId AND PC.PrdId =P.PrdId AND B.Prdid =PC.Prdid 
                    UNION ALL
                    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,CASE A.RtrCode WHEN '' THEN 'ALL' ELSE A.RtrCode END,P.PrdCCode,A.PrdBatCode,B.NewSelRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
                    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0
                    FROM #SpecialRateDet1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
                    INNER JOIN RETAILER R(NOLOCK) ON A.RtrCode = R.CmpRtrCode AND B.RtrId = R.RtrId  
                    AND A.RTRCODE<>'ALL' AND A.CpRefNO = B.CpRefNO
                    INNER JOIN Product P(NOLOCK) ON A.Prdid = P.Prdid AND B.PrdId = P.PrdId
                    INNER JOIN #ProductCategory PC ON B.CtgValMainId = PC.PrdCtgValMainId AND PC.PrdId =P.PrdId AND B.Prdid =PC.Prdid  

                    INSERT INTO SpecialRateAftDownload_calc (RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,SplSelRate,FromDate,CreatedDate,DownloadedDate,
                    ContractPriceIds,DiscountPerc,SplrateId,ApplyOn,TYPE)
                    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,CASE A.RtrCode WHEN '' THEN 'ALL' ELSE A.RtrCode END,P.PrdCCode,A.PrdBatCode,B.NewSelRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
                    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0,CASE UPPER(LTRIM(RTRIM(ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END as Applyon,
                    CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
                    FROM #SpecialRateDet1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
                    and A.RtrCtgValueCode=B.RtrCtgValueCode AND RTRCODE='ALL' AND A.CpRefNO = B.CpRefNO
                    INNER JOIN Product P ON A.Prdid = P.Prdid AND B.PrdId = P.PrdId     
                    UNION ALL
                    SELECT DISTINCT RtrCtgCode,A.RtrCtgValueCode,CASE A.RtrCode WHEN '' THEN 'ALL' ELSE A.RtrCode END,P.PrdCCode,A.PrdBatCode,B.NewSelRate,CONVERT(NVARCHAR(10),GETDATE(),121),GETDATE(),GETDATE(),
                    '-'+CONVERT(NVARCHAR(50),NewPriceId)+'-',DiscountPerc,0,CASE UPPER(LTRIM(RTRIM(ApplyOn))) WHEN 'SELLINGRATE' THEN 3 WHEN 'PURCHASERATE' THEN 2 ELSE 1 END as Applyon,
                    CASE UPPER(LTRIM(RTRIM([Type]))) WHEN 'MARK UP' THEN 1 WHEN 'MARK DOWN' THEN 2 ELSE 0 END AS [Type]
                    FROM #SpecialRateDet1 A INNER JOIN #SplProductBatchDetails1 B ON A.PrdId = B.PrdId AND A.PrdBatId = B.PrdBatId 
                    and A.RtrCtgValueCode=B.RtrCtgValueCode AND RTRCODE<>'ALL' AND A.CpRefNO = B.CpRefNO
                    INNER JOIN Product P ON A.Prdid = P.Prdid AND B.PrdId = P.PrdId  
                    INNER JOIN RETAILER R ON A.RtrCode = R.CmpRtrCode AND B.RtrId = R.RtrId                  

              END 
              DELETE A FROM ProductBatchPriceWithCounter A (Nolock)
RETURN
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_BLSchemeAttributes' AND TYPE ='P')
DROP PROCEDURE Proc_Cn2Cs_BLSchemeAttributes
GO
/*
BEGIN TRANSACTION
delete from errorlog
EXEC Proc_Cn2Cs_BLSchemeAttributes 0
SELECT * FROM ErrorLog
select * from SchemeRetAttr where schid =2641 and attrtype =6 
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cn2Cs_BLSchemeAttributes
(
@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************
* PROCEDURE: Proc_Cn2Cs_BLSchemeAttributes
* PURPOSE: To Insert and Update Scheme Attributes
* CREATED: Boopathy.P on 02/01/2009
***************************************************************************************************
* 12.09.2011  Panner AttrType Checking (Product or SKU)
**************************************************************************************************
* DATE         AUTHOR          CR/BZ    USER STORY ID   DESCRIPTION                         
*****************************************************************************************************
 11/01/2019   lakshman M       BR      ILCRSTPAR3079   Reatiler category main id wronly mapped.
 23/09/2019   lakshman M       BZ      ILCRSTPAR6003   Scheeme Attributes retailer category validation missing in script level.
*****************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 	AS VARCHAR(50)
	DECLARE @AttrType 	AS VARCHAR(50)
	DECLARE @AttrCode 	AS VARCHAR(50)
	DECLARE @AttrTypeId 	AS INT
	DECLARE @AttrId  	AS INT
	DECLARE @CmpId  	AS INT
	DECLARE @SchLevelId 	AS INT
	DECLARE @SelMode 	AS INT
	DECLARE @ChkCount 	AS INT
	DECLARE @ErrDesc  	AS VARCHAR(1000)
	DECLARE @TabName  	AS VARCHAR(50)
	DECLARE @GetKey  	AS VARCHAR(50)
	DECLARE @Taction  	AS INT
	DECLARE @sSQL   	AS VARCHAR(4000)
	DECLARE @ConFig		AS INT
	DECLARE @CmpCnt		AS INT
	DECLARE @EtlCnt		AS INT
	DECLARE @CombiId	AS INT
	DECLARE @SLevel		AS INT
	DECLARE @iCnt		AS INT
	DECLARE @DepChk		AS INT
	DECLARE @MasterRecordID AS INT
	DECLARE @AttrName 	AS VARCHAR(100)
	SET @DepChk=0
	SET @TabName = 'Etl_Prk_Scheme_OnAttributes'
	SET @Po_ErrNo =0
	SET @iCnt=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	
	DELETE FROM Etl_Prk_SchemeAttribute_Temp
	DECLARE  @Temp_CtgAttrDt TABLE
	(
		SchId		INT,
		CtgMainId	INT
	)
	DECLARE  @Temp_CtgAttrDt_Temp TABLE
	(
		SchId		NVARCHAR(50),
		CtgMainId	INT
	)
	DECLARE  @Temp_ValAttrDt TABLE
	(
		SchId		INT,
		RtrClassId	VARCHAR(400)
	)
	
	DECLARE  @Temp_ValAttrDt_Temp TABLE
	(
		SchId		NVARCHAR(50),
		RtrClassId	INT
	)
	
	DECLARE  @Temp_ValAttrDt_Final TABLE
	(
		SchId		INT,
		AttrType    INT,
		RtrClassId	VARCHAR(400)
	)
	DECLARE  @Temp_KeyAttrDt TABLE
	(
		SchId		INT,
		RtrId		INT
	)
	DECLARE Cur_SchemeAttr CURSOR
	FOR SELECT DISTINCT ISNULL([CmpSchCode],'') AS [Company Scheme Code],ISNULL([AttrType],'') AS [Attribute Type],
	ISNULL([AttrName],'') AS [Attribute Master Code] FROM Etl_Prk_Scheme_OnAttributes 
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D' 
	AND CmpSchCode IN (SELECT CmpSchCode FROM SchemeMaster(NOLOCK))
	ORDER BY [Company Scheme Code], [Attribute Type]
	OPEN Cur_SchemeAttr
	FETCH NEXT FROM Cur_SchemeAttr INTO @SchCode,@AttrType,@AttrCode
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @iCnt=@iCnt+1
		SET @Taction = 2
		SET @Po_ErrNo =0
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank'
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@AttrType))<>''
		BEGIN
			IF LTRIM(RTRIM(@AttrCode))=''
			BEGIN
				SET @ErrDesc = 'Attribute Code should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (1,@TabName,'Attribute Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		ELSE IF LTRIM(RTRIM(@AttrCode))<>''
		BEGIN
			IF LTRIM(RTRIM(@AttrType))=''
			BEGIN
				SET @ErrDesc = 'Attribute Type should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (1,@TabName,'Attribute Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo=0
		BEGIN
			IF @ConFig<>1
			BEGIN
				IF NOT EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
					
				END
				ELSE
				BEGIN
					SET @DepChk=1
					SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SelMode=SchemeLvlMode,@CombiId=CombiSch FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SchLevelId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
				END	
			END
			ELSE
			BEGIN
				IF EXISTS(SELECT SchId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode)))
				BEGIN
					SET @DepChk=1
					SELECT @GetKey=SchId,@CmpId=CmpId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SelMode=SchemeLvlMode,@CombiId=CombiSch FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					SELECT @SchLevelId=SchLevelId FROM SchemeMaster WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT CmpSchCode FROM ETL_Prk_SchemeMaster_Temp WHERE
					CmpSchCode=LTRIM(RTRIM(@SchCode)) AND UpLoadFlag='N')
					BEGIN	
						IF NOT EXISTS(SELECT [CmpSchCode] FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE
						[CmpSchCode]=LTRIM(RTRIM(@SchCode)))
						BEGIN
							SET @ErrDesc = 'Company Scheme Code not found for Scheme Code:'+@SchCode+ ' in table Etl_Prk_SchemeHD_Slabs_Rules  '
							INSERT INTO Errorlog VALUES (1,@TabName,'Scheme Code',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @CmpId=B.CmpId FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON
							B.CmpCode=A.[CmpCode] WHERE [CmpSchCode]=LTRIM(RTRIM(@SchCode))
							SELECT @SchLevelId=C.CmpPrdCtgId,
								@SelMode=(CASE A.SchemeLevelMode
								WHEN 'PRODUCT' THEN 0 ELSE 1 END),@CombiId=(CASE A.CombiSch
								WHEN 'NO' THEN 0 ELSE 1 END)
							FROM Etl_Prk_SchemeHD_Slabs_Rules A INNER JOIN COMPANY B ON B.CmpCode=A.CmpCode
							INNER JOIN ProductCategoryLevel C ON A.SchLevel=C.CmpPrdCtgName
							AND B.CmpId=C.CmpId WHERE A.CmpSchCode=LTRIM(RTRIM(@SchCode))
						END
					END
					ELSE
					BEGIN
						SET @DepChk=2
						SELECT @GetKey=CmpSchCode,@CmpId=CmpId FROM ETL_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
	
						SELECT @SelMode=SchemeLvlMode,@CombiId=CombiSch FROM ETL_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
	
						SELECT @SchLevelId=SchLevelId FROM ETL_Prk_SchemeMaster_Temp
						WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
					END	
				END
			END
			IF UPPER(LTRIM(RTRIM(@AttrType)))= 'SALESMAN'
				BEGIN
				SET @AttrTypeId=1
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT SMID FROM SALESMAN WITH (NOLOCK) WHERE
						SMCODE=LTRIM(RTRIM(@AttrCode)) AND STATUS = 1)
					BEGIN
						SET @ErrDesc = 'Salesman Code:'+ @AttrCode+ ' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'SalesMan',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=SMID FROM SALESMAN WITH (NOLOCK) WHERE
						SMCODE=LTRIM(RTRIM(@AttrCode)) AND STATUS = 1
					END
				END
			END
			--->Added By Nanda on 28/07/2010
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'CLUSTER'
				BEGIN
				SET @AttrTypeId=21
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT ClusterId FROM ClusterMaster WITH (NOLOCK) WHERE
						ClusterCode=LTRIM(RTRIM(@AttrCode)))
					BEGIN
						SET @ErrDesc = 'Cluster Code:'+ @AttrCode+ ' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Cluster',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=ClusterId FROM ClusterMaster WITH (NOLOCK) WHERE
						ClusterCode=LTRIM(RTRIM(@AttrCode))
					END
				END
			END
			--->Till Here
			
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'ROUTE'
			BEGIN
				SET @AttrTypeId=2
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT RMID FROM RouteMaster WITH (NOLOCK) WHERE
						RMCODE=LTRIM(RTRIM(@AttrCode)) AND RMStatus = 1)
					BEGIN
						SET @ErrDesc = 'Route Code:'+@AttrCode +' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Route',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=RMID FROM RouteMaster WITH (NOLOCK) WHERE
						RMCODE=LTRIM(RTRIM(@AttrCode)) AND RMStatus = 1
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'VILLAGE'
			BEGIN
				SET @AttrTypeId=3
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT VillageId FROM RouteVillage WITH (NOLOCK) WHERE
						VILLAGECODE=LTRIM(RTRIM(@AttrCode)) AND VillageStatus = 1)
					BEGIN
						SET @ErrDesc = 'Route Village Code:'+@AttrCode +' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'RouteVillage',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=VillageId FROM RouteVillage WITH (NOLOCK) WHERE
						VILLAGECODE=LTRIM(RTRIM(@AttrCode)) AND VillageStatus = 1
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'CATEGORY LEVEL'
			BEGIN
				SET @AttrTypeId=4
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT CtgLevelId FROM RetailerCategoryLevel WITH (NOLOCK) WHERE
						CtgLevelName=LTRIM(RTRIM(@AttrCode)))
					BEGIN
						SET @ErrDesc = 'Category Level:'+@AttrCode +' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Category Level',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=CtgLevelId FROM RetailerCategoryLevel WITH (NOLOCK) WHERE
						CtgLevelName=LTRIM(RTRIM(@AttrCode))
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'CATEGORY LEVEL VALUE'
			BEGIN
				SET @AttrTypeId=5
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT CtgMainId FROM RetailerCategory WITH (NOLOCK) WHERE
					CtgCOde=LTRIM(RTRIM(@AttrCode)))
					BEGIN
						SET @ErrDesc = 'Category Level Value not found''' + LTRIM(RTRIM(@SchCode)) + ''''
						INSERT INTO Errorlog VALUES (1,@TabName,'Category Level Value',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=CtgMainId FROM RetailerCategory WITH (NOLOCK) WHERE
						CtgCOde=LTRIM(RTRIM(@AttrCode))
						--->Modified By Nanda on 24/08/2009
						IF @DepChk=1
						BEGIN
							INSERT INTO @Temp_CtgAttrDt SELECT @GetKey,@AttrId
						END
						ELSE
						BEGIN
							INSERT INTO @Temp_CtgAttrDt_Temp SELECT @GetKey,@AttrId
						END
						--Till Here
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'VALUECLASS'
			BEGIN
				SET @AttrTypeId=6
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT RtrClassId FROM RETAILERVALUECLASS WITH (NOLOCK) WHERE
						ValueClassCode=LTRIM(RTRIM(@AttrCode)))
					BEGIN
						SET @ErrDesc = 'Value Class Code:'+@AttrCode +' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Value Class',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=RtrClassId FROM RETAILERVALUECLASS WITH (NOLOCK) WHERE
						ValueClassCode=LTRIM(RTRIM(@AttrCode))
						--->Modified By Nanda on 24/08/2009
--						IF @DepChk=1
--						BEGIN
--							INSERT INTO @Temp_ValAttrDt SELECT @GetKey,@AttrCode
--						END
--						ELSE
--						BEGIN
--							INSERT INTO @Temp_ValAttrDt_Temp SELECT @GetKey,@AttrCode
--						END
						--Till Here
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'POTENTIALCLASS'
			BEGIN
				SET @AttrTypeId=7
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF NOT EXISTS(SELECT RtrClassId FROM RETAILERPOTENTIALCLASS WITH (NOLOCK) WHERE
						PotentialClassCode=LTRIM(RTRIM(@AttrCode)))
					BEGIN
						SET @ErrDesc = 'Potential Class Code:'+@AttrCode +' not found for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Potential Class',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE
					BEGIN
						SELECT @AttrId=RtrClassId FROM RETAILERPOTENTIALCLASS WITH (NOLOCK) WHERE
						PotentialClassCode=LTRIM(RTRIM(@AttrCode))
					END
				END
			END
			ELSE IF ((UPPER(LTRIM(RTRIM(@AttrType)))= 'KEYGROUP') OR (UPPER(LTRIM(RTRIM(@AttrType)))= 'RETAILER'))
			BEGIN
				SET @AttrTypeId=8
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN	
					IF (UPPER(LTRIM(RTRIM(@AttrType)))= 'KEYGROUP')
					BEGIN
						IF NOT EXISTS(SELECT GrpId FROM KeyGroupMaster WITH (NOLOCK) WHERE
								GrpCode = @AttrCode)
						BEGIN
							SET @ErrDesc = 'Key Code:'+@AttrCode +' not found for Scheme Code:'+@SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'Key Group',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @AttrName = GrpName FROM KeyGroupMaster WITH (NOLOCK) WHERE GrpCode = LTRIM(RTRIM(@AttrCode))
							DECLARE Cur_KeyGrp CURSOR FOR 
							SELECT ISNULL(MasterRecordID,0) AS [MasterRecordID] FROM UdcDetails A INNER JOIN UdcMaster B
							ON A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C On A.MasterId=C.MasterId
							INNER JOIN RETAILER R ON A.MasterRecordId=R.RtrId INNER JOIN KeyGroupMaster K 
							ON K.GrpName=A.ColumnValue Where A.ColumnValue=@AttrName AND C.MAsterID = 2
							OPEN Cur_KeyGrp
							FETCH NEXT FROM Cur_KeyGrp INTO @MasterRecordID
							WHILE @@FETCH_STATUS=0
							BEGIN
								INSERT INTO @Temp_KeyAttrDt SELECT @GetKey,@MasterRecordID
							FETCH NEXT FROM Cur_KeyGrp INTO @MasterRecordID
							END
							CLOSE Cur_KeyGrp
							DEALLOCATE Cur_KeyGrp
						END
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'RETAILER'
					BEGIN
						IF NOT EXISTS (SELECT RtrId FROM Retailer WITH (NOLOCK) WHERE CmpRtrCode = LTRIM(RTRIM(@AttrCode)))
						BEGIN
							SET @ErrDesc = 'Retailer Code:'+ @AttrCode + ' not found for Scheme Code:'+ @SchCode
							INSERT INTO Errorlog VALUES (1,@TabName,'Retailer Code',@ErrDesc)
							SET @Taction = 0
							SET @Po_ErrNo =1
						END
						ELSE
						BEGIN
							SELECT @AttrId = RtrId FROM Retailer WITH (NOLOCK) WHERE CmpRtrCode = LTRIM(RTRIM(@AttrCode))
						END
					END
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@AttrType))) = 'SKU' OR UPPER(LTRIM(RTRIM(@AttrType)))= 'PRODUCT')
			BEGIN
				SET @AttrTypeId=9
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF @SelMode=0
					BEGIN
						SET @AttrId=1
					END
					ELSE IF @SelMode=1
					BEGIN
						IF NOT EXISTS(SELECT DISTINCT A.UDCUniqueId FROM UdcDetails A INNER JOIN UdcMaster B
							ON A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C On A.MasterId=C.MasterId
							INNER JOIN Product P ON A.MasterRecordId=P.PrdId AND P.CmpId=@CmpId
							Where A.UdcMasterId=@SchLevelId)
						BEGIN
							SET @AttrId=@AttrCode
						END
						ELSE
						BEGIN
							SELECT DISTINCT @AttrId=A.UDCUniqueId FROM UdcDetails A INNER JOIN UdcMaster B
							ON A.UdcMasterId=B.UdcMasterId INNER JOIN UdcHD C On A.MasterId=C.MasterId
							INNER JOIN Product P ON A.MasterRecordId=P.PrdId AND P.CmpId=@CmpId
							Where A.UdcMasterId=@SchLevelId
						END
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'BILL TYPE'
			BEGIN
				SET @AttrTypeId=10
				IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'VAN SALES' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'READY STOCK'
					AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'ORDER BOOKING'
				BEGIN
					SET @ErrDesc = 'BILL TYPE SHOULD BE(VAN SALES OR READY STOCK OR ORDER BOOKING) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (1,@TabName,'Bill Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='VAN SALES'
				BEGIN
					SET @AttrId=3
				END
				ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='READY STOCK'
				BEGIN
					SET @AttrId=2
				END
				ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='ORDER BOOKING'
				BEGIN
					SET @AttrId=1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'BILL MODE'
			BEGIN
				SET @AttrTypeId=11
				IF UPPER(LTRIM(RTRIM(@AttrCode)))='ALL'
				BEGIN
					SET @AttrId=1
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'CASH' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'CREDIT'
					BEGIN
						SET @ErrDesc = 'BILL MODE SHOULD BE(CASH OR CREDIT) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'Bill Mode',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='CASH'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='CREDIT'
					BEGIN
						SET @AttrId=2
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'RETAILER TYPE'
			BEGIN
				SET @AttrTypeId=12
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'KEY OUTLET' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'NON-KEY OUTLET'
					BEGIN
						SET @ErrDesc = 'RETAIER TYPE SHOULD BE(KEY OUTLET OR NON-KEY OUTLET) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'RETAILER TYPE',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='KEY OUTLET'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='NON-KEY OUTLET'
					BEGIN
						SET @AttrId=2
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'CLASS TYPE'
			BEGIN
				SET @AttrTypeId=13
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'VALUE CLASSIFICATION' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'POTENTIAL CLASSIFICATION'
					BEGIN
						SET @ErrDesc = 'CLASS TYPE SHOULD BE(VALUE CLASSIFICATION OR POTENTIAL CLASSIFICATION) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'CLASS TYPE',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='VALUE CLASSIFICATION'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='POTENTIAL CLASSIFICATION'
					BEGIN
						SET @AttrId=2
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'ROAD CONDITION'
			BEGIN
				SET @AttrTypeId=14
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'GOOD' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'ABOVE AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'AVERAGE' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'BELOW AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'POOR'
					BEGIN
						SET @ErrDesc = 'ROAD CONDITION SHOULD BE(GOOD OR ABOVE AVERAGE OR AVERAGE OR  BELOW AVERAGE OR POOR) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'ROAD CONDITION',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='GOOD'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='ABOVE AVERAGE'
					BEGIN
						SET @AttrId=2
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='AVERAGE'
					BEGIN
						SET @AttrId=3
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='BELOW AVERAGE'
					BEGIN
						SET @AttrId=4
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='POOR'
					BEGIN
						SET @AttrId=5
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'INCOME LEVEL'
			BEGIN
				SET @AttrTypeId=15
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'GOOD' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'ABOVE AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'AVERAGE' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'BELOW AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'POOR'
					BEGIN
						SET @ErrDesc = 'INCOME LEVEL SHOULD BE(GOOD OR ABOVE AVERAGE OR AVERAGE OR  BELOW AVERAGE OR POOR) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'INCOME LEVEL',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='GOOD'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='ABOVE AVERAGE'
					BEGIN
						SET @AttrId=2
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='AVERAGE'					
					BEGIN
						SET @AttrId=3
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='BELOW AVERAGE'
					BEGIN
						SET @AttrId=4
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='POOR'
					BEGIN
						SET @AttrId=5
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'ACCEPTABILITY'
			BEGIN
				SET @AttrTypeId=16
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'GOOD' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'ABOVE AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'AVERAGE' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'BELOW AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'POOR'
					BEGIN
						SET @ErrDesc = 'ACCEPTABILITY SHOULD BE(GOOD OR ABOVE AVERAGE OR AVERAGE OR  BELOW AVERAGE OR POOR) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'ACCEPTABILITY',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='GOOD'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='ABOVE AVERAGE'
					BEGIN
						SET @AttrId=2
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='AVERAGE'
					BEGIN
						SET @AttrId=3
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='BELOW AVERAGE'
					BEGIN
						SET @AttrId=4
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='POOR'
					BEGIN
						SET @AttrId=5
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'AWARENESS'
			BEGIN
				SET @AttrTypeId=17
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'GOOD' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'ABOVE AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'AVERAGE' AND UPPER(LTRIM(RTRIM(@AttrCode)))<>'BELOW AVERAGE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'POOR'
					BEGIN
						SET @ErrDesc = 'AWARENESS SHOULD BE(GOOD OR ABOVE AVERAGE OR AVERAGE OR  BELOW AVERAGE OR POOR) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'AWARENESS',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='GOOD'
					BEGIN
						SET @AttrId=1
					END 					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='ABOVE AVERAGE'
					BEGIN
						SET @AttrId=2
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='AVERAGE'
					BEGIN
						SET @AttrId=3
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='BELOW AVERAGE'
					BEGIN
						SET @AttrId=4
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='POOR'
					BEGIN
						SET @AttrId=5
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'ROUTE TYPE'
			BEGIN
				SET @AttrTypeId=18
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'SALES ROUTE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'DELIVERY ROUTE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'MERCHANDISING ROUTE'
					BEGIN
						SET @ErrDesc = 'ROUTE TYPE SHOULD BE(SALES ROUTE OR DELIVERY ROUTE OR MERCHANDISING ROUTE) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'ROUTE TYPE',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='SALES ROUTE'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='DELIVERY ROUTE'
					BEGIN
						SET @AttrId=2
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='MERCHANDISING ROUTE'
					BEGIN
						SET @AttrId=3
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'LOCALUPCOUNTRY'
			BEGIN
				SET @AttrTypeId=19
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'LOCAL ROUTE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'UPCOUNTRY ROUTE'
					BEGIN
						SET @ErrDesc = 'LOCAL/UPCOUNTRY SHOULD BE(LOCAL ROUTE OR UPCOUNTRY ROUTE) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'LOCALUPCOUNTRY',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='LOCAL ROUTE'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='UPCOUNTRY ROUTE'
					BEGIN
						SET @AttrId=2
					END
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@AttrType)))= 'VAN/NON VAN ROUTE'
			BEGIN
				SET @AttrTypeId=20
				IF LTRIM(RTRIM(@AttrCode))='ALL'
				BEGIN
					SET @AttrId=0
				END
				ELSE
				BEGIN
					IF UPPER(LTRIM(RTRIM(@AttrCode)))<>'VAN ROUTE' AND
					UPPER(LTRIM(RTRIM(@AttrCode)))<>'NON VAN ROUTE'
					BEGIN
						SET @ErrDesc = 'VAN/NON VAN ROUTE SHOULD BE(VAN ROUTE OR NON VAN ROUTE) for Scheme Code:'+@SchCode
						INSERT INTO Errorlog VALUES (1,@TabName,'NON VAN ROUTE',@ErrDesc)
						SET @Taction = 0
						SET @Po_ErrNo =1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='VAN ROUTE'
					BEGIN
						SET @AttrId=1
					END
					ELSE IF UPPER(LTRIM(RTRIM(@AttrCode)))='NON VAN ROUTE'
					BEGIN
						SET @AttrId=2
					END
				END
			END
		END
		IF @Po_ErrNo =1
		BEGIN
			IF @DepChk=1
			BEGIN
				EXEC Proc_DependencyCheck 'SCHEMEMASTER',@GetKey
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					SET @Taction = 0
				END
			END
		END
		ELSE
		BEGIN
			IF @ConFig=1
			BEGIN
				SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
				IF @SchLevelId <@SLevel
				BEGIN
					SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
					WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
					AND A.SlabId=0 AND A.SlabValue=0
					SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
					WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
					A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
					AND A.SlabId=0 AND A.SlabValue=0
				END
				ELSE
				BEGIN
					SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
					WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
					AND A.SlabId=0 AND A.SlabValue=0
					SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
					WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
					AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
					AND A.SlabId=0 AND A.SlabValue=0				
				END					
	
				IF @EtlCnt=@CmpCnt
				BEGIN
					SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
					WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
	
					SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
					INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
					WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))	
					IF @EtlCnt=@CmpCnt
					BEGIN
			
						IF UPPER(LTRIM(RTRIM(@AttrType)))= 'BILL MODE' OR UPPER(LTRIM(RTRIM(@AttrType)))='BILL TYPE' OR UPPER(LTRIM(RTRIM(@AttrType)))='CATEGORY LEVEL VALUE'
						BEGIN
							DELETE FROM SchemeRetAttr WHERE SchId=ISNULL(@GetKey,0) AND AttrType=@AttrTypeId
							AND AttrId=@AttrId
			
							SET @sSQL='DELETE FROM SchemeRetAttr WHERE SchId='+ CAST(@GetKey AS VARCHAR(10)) +
							' AND AttrType=' + CAST(@AttrTypeId AS VARCHAR(10)) + ' AND AttrId=' + CAST(@AttrId AS VARCHAR(10))
						END
						ELSE
						BEGIN
							DELETE FROM SchemeRetAttr WHERE SchId=ISNULL(@GetKey,0) AND AttrType=@AttrTypeId AND AttrId=@AttrId
			
							SET @sSQL='DELETE FROM SchemeRetAttr WHERE SchId='+ CAST(@GetKey AS VARCHAR(10)) +
							' AND AttrType=' + CAST(@AttrTypeId AS VARCHAR(10))
						END
						
						INSERT INTO Translog(strSql1) Values (@sSQL)
						INSERT INTO SchemeRetAttr(SchId,AttrType,AttrId,Availability,LastModBy,LastModDate,
						AuthId,AuthDate) VALUES(ISNULL(@GetKey,0),@AttrTypeId,@AttrId,1,1,convert(varchar(10),getdate(),121),
						1,convert(varchar(10),getdate(),121))
		
						SET @sSQL='INSERT INTO SchemeRetAttr(SchId,AttrType,AttrId,Availability,LastModBy,LastModDate,
						AuthId,AuthDate) VALUES(' + CAST(@GetKey AS VARCHAR(10)) + ',' + CAST(@AttrTypeId AS VARCHAR(10)) +
						',' + CAST(@AttrId AS VARCHAR(10)) + ',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
						INSERT INTO Translog(strSql1) Values (@sSQL)
				
					END					
					ELSE
					BEGIN	
						INSERT INTO Etl_Prk_SchemeAttribute_Temp(CmpSchCode,AttrType,AttrId,UpLoadFlag)
						VALUES (LTRIM(RTRIM(@SchCode)),@AttrTypeId,@AttrId,'N')
						SET @sSQL='INSERT INTO Etl_Prk_SchemeAttribute_Temp(CmpSchCode,AttrType,AttrId,UpLoadFlag
						) VALUES(' + CAST(@SchCode AS VARCHAR(50)) + ',' + CAST(@AttrTypeId AS VARCHAR(10)) + ',''N'''')'
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
			
				END
				ELSE
				BEGIN	
					--Nanda
					--SELECT LTRIM(RTRIM(@SchCode)),@AttrTypeId,@AttrId
					INSERT INTO Etl_Prk_SchemeAttribute_Temp(CmpSchCode,AttrType,AttrId,UpLoadFlag)
						VALUES (LTRIM(RTRIM(@SchCode)),@AttrTypeId,@AttrId,'N')
					SET @sSQL='INSERT INTO Etl_Prk_SchemeAttribute_Temp(CmpSchCode,AttrType,AttrId,UpLoadFlag
					) VALUES(' + CAST(@SchCode AS VARCHAR(50)) + ',' + CAST(@AttrTypeId AS VARCHAR(10)) + ',''N'''')'
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--Nanda
					--SELECT * FROM Etl_Prk_SchemeAttribute_Temp					
				END					
			END
			ELSE
			BEGIN
				IF UPPER(LTRIM(RTRIM(@AttrType)))= 'BILL MODE' OR UPPER(LTRIM(RTRIM(@AttrType)))='BILL TYPE' OR  UPPER(LTRIM(RTRIM(@AttrType)))='CATEGORY LEVEL VALUE'
				BEGIN
					DELETE FROM SchemeRetAttr WHERE SchId=ISNULL(@GetKey,0) AND AttrType=@AttrTypeId
					AND AttrId=@AttrId
	
					SET @sSQL='DELETE FROM SchemeRetAttr WHERE SchId='+ CAST(@GetKey AS VARCHAR(10)) +
					' AND AttrType=' + CAST(@AttrTypeId AS VARCHAR(10)) + ' AND AttrId=' + CAST(@AttrId AS VARCHAR(10))
				END
				ELSE
				BEGIN
					DELETE FROM SchemeRetAttr WHERE SchId=ISNULL(@GetKey,0) AND AttrType=@AttrTypeId
	
					SET @sSQL='DELETE FROM SchemeRetAttr WHERE SchId='+ CAST(@GetKey AS VARCHAR(10)) +
					' AND AttrType=' + CAST(@AttrTypeId AS VARCHAR(10))
				END
	
				INSERT INTO Translog(strSql1) Values (@sSQL)
				INSERT INTO SchemeRetAttr(SchId,AttrType,AttrId,Availability,LastModBy,LastModDate,
				AuthId,AuthDate) VALUES(ISNULL(@GetKey,0),@AttrTypeId,@AttrId,1,1,convert(varchar(10),getdate(),121),
				1,convert(varchar(10),getdate(),121))
	
				SET @sSQL='INSERT INTO SchemeRetAttr(SchId,AttrType,AttrId,Availability,LastModBy,LastModDate,
				AuthId,AuthDate) VALUES(' + CAST(@GetKey AS VARCHAR(10)) + ',' + CAST(@AttrTypeId AS VARCHAR(10)) +
				',' + CAST(@AttrId AS VARCHAR(10)) + ',1,1,''' + convert(varchar(10),getdate(),121) + ''',1,''' + convert(varchar(10),getdate(),121) + ''')'
				INSERT INTO Translog(strSql1) Values (@sSQL)
			END --Sathishkumar Veeramani
			------------ start here  PMS ID: ILCRSTPAR6003 
            IF UPPER(LTRIM(RTRIM(@AttrType)))= 'VALUECLASS'
            BEGIN
                 IF LTRIM(RTRIM(@AttrCode))<> 'ALL'
					IF @DepChk=1
					BEGIN
						INSERT INTO @Temp_ValAttrDt 
						SELECT @GetKey,RtrClassId FROM RETAILERVALUECLASS WITH (NOLOCK) 
                        WHERE ValueClassCode=LTRIM(RTRIM(@AttrCode)) 
                        IF EXISTS (SELECT * FROM Etl_Prk_Scheme_OnAttributes WHERE LTRIM(RTRIM(UPPER(AttrType))) = 'CATEGORY LEVEL VALUE'
                        AND LTRIM(RTRIM(UPPER(AttrName))) <> 'ALL' AND CmpSchCode = @SchCode)
                        BEGIN
							IF EXISTS (SELECT * FROM Etl_Prk_Scheme_OnAttributes WITH(NOLOCK) WHERE LTRIM(RTRIM(UPPER(AttrType))) = 'CATEGORY LEVEL' 
							AND LTRIM(RTRIM(UPPER(AttrName))) = 'CHANNEL' AND CmpSchCode = @SchCode)
							BEGIN
								 INSERT INTO @Temp_ValAttrDt_Final(SchId,AttrType,RtrClassId)
								 SELECT DISTINCT ISNULL(@GetKey,0),6,RC4.RtrClassId 
								 FROM RetailerCategory RC1 WITH(NOLOCK)
								 INNER JOIN @Temp_CtgAttrDt Temp ON RC1.CtgMainId = Temp.CtgMainId and Temp.SchId=@GetKey
								 INNER JOIN RetailerCategory RC2 WITH(NOLOCK) ON Temp.CtgMainId = RC2.CtgLinkId
								 INNER JOIN RetailerCategory RC3 WITH(NOLOCK) ON RC2.CtgMainId = RC3.CtgMainId
								 INNER JOIN RetailerValueClass RC4 WITH(NOLOCK) ON RC3.CtgMainId = RC4.CtgMainId
								 INNER JOIN @Temp_ValAttrDt Temp1 ON RC4.RtrClassId = Temp1.RtrClassId and temp1.SchId=@GetKey
								 WHERE NOT EXISTS (SELECT SchId,RtrClassId FROM @Temp_ValAttrDt_Final Z WHERE SchId =  ISNULL(@GetKey,0) 
								 AND RC4.RtrClassId = Z.RtrClassId )
							END
							ELSE 
							IF EXISTS (SELECT * FROM Etl_Prk_Scheme_OnAttributes WITH(NOLOCK) WHERE LTRIM(RTRIM(UPPER(AttrType))) = 'CATEGORY LEVEL' 
							AND LTRIM(RTRIM(UPPER(AttrName))) = 'SUB CHANNEL' AND CmpSchCode = @SchCode)
							BEGIN
							     INSERT INTO @Temp_ValAttrDt_Final(SchId,AttrType,RtrClassId)
								 SELECT DISTINCT ISNULL(@GetKey,0),6,RC3.RtrClassId FROM RetailerCategory RC1 WITH(NOLOCK)
								 INNER JOIN @Temp_CtgAttrDt Temp ON RC1.CtgMainId = Temp.CtgMainId and Temp.SchId=@GetKey
								 INNER JOIN RetailerCategory RC2 WITH(NOLOCK) ON Temp.CtgMainId = RC2.CtgLinkId
								 INNER JOIN RetailerValueClass RC3 WITH(NOLOCK) ON RC2.CtgMainId = RC3.CtgMainId
								 INNER JOIN @Temp_ValAttrDt Temp1 ON RC3.RtrClassId = Temp1.RtrClassId and temp1.SchId=@GetKey
								 WHERE NOT EXISTS (SELECT SchId,RtrClassId FROM @Temp_ValAttrDt_Final Z WHERE SchId =  ISNULL(@GetKey,0) 
								 AND RC3.RtrClassId = Z.RtrClassId )                           
							END
							ELSE
							IF EXISTS (SELECT * FROM Etl_Prk_Scheme_OnAttributes WITH(NOLOCK) WHERE LTRIM(RTRIM(UPPER(AttrType))) = 'CATEGORY LEVEL' 
							AND LTRIM(RTRIM(UPPER(AttrName))) = 'GROUP' AND CmpSchCode = @SchCode)
							BEGIN
							    INSERT INTO @Temp_ValAttrDt_Final(SchId,AttrType,RtrClassId)
								SELECT DISTINCT ISNULL(@GetKey,0),6,RVC.RtrClassId
								FROM RetailerCategory RC WITH(NOLOCK)
								INNER JOIN @Temp_CtgAttrDt T on T.CtgMainId=RC.CtgMainId AND SCHID=@GetKey
								INNER JOIN RetailerValueClass RVC ON RVC.CtgMainId=RC.CtgMainId
								INNER JOIN @Temp_ValAttrDt T1 ON T1.rtrclassid=RVC.RtrClassId AND T1.SchId=@GetKey	 							 
								WHERE NOT EXISTS (SELECT SchId,RtrClassId FROM @Temp_ValAttrDt_Final Z WHERE SchId =  ISNULL(@GetKey,0) 
								AND RVC.RtrClassId = Z.RtrClassId )                           
							END							
                        END
                        ELSE
                        BEGIN
                     		 INSERT INTO @Temp_ValAttrDt_Final(SchId,AttrType,RtrClassId)
							 SELECT DISTINCT ISNULL(@GetKey,0),6,RCV1.RtrClassId FROM RetailerValueClass RCV1 WITH(NOLOCK)
							 INNER JOIN @Temp_ValAttrDt Temp1 ON RCV1.RtrClassId = Temp1.RtrClassId and temp1.SchId=@GetKey
							 WHERE NOT EXISTS (SELECT SchId,RtrClassId FROM @Temp_ValAttrDt_Final Z WHERE SchId =  ISNULL(@GetKey,0) 
							 AND RCV1.RtrClassId = Z.RtrClassId)
                        END
					END
					ELSE
					BEGIN
						INSERT INTO @Temp_ValAttrDt_Temp SELECT @GetKey,RtrClassId FROM RETAILERVALUECLASS WITH (NOLOCK) 
                        WHERE ValueClassCode=LTRIM(RTRIM(@AttrCode))
					END 
            END--Till Here   			
		END
	FETCH NEXT FROM Cur_SchemeAttr INTO @SchCode,@AttrType,@AttrCode
	END
	CLOSE Cur_SchemeAttr
	DEALLOCATE Cur_SchemeAttr
	--SELECT * FROM SchemeRetAttr WHERE SchId=10
	IF EXISTS (SELECT * FROM Etl_Prk_Scheme_OnAttributes)
	BEGIN
		-->Modified By Nanda on 30/11/2009  
		IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SchAttrToAvoid') 
		AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
		BEGIN
			DROP TABLE SchAttrToAvoid	
		END
		CREATE TABLE SchAttrToAvoid
		(
			SchId INT
		)
		INSERT INTO SchAttrToAvoid
		SELECT SchId FROM SchemeRetAttr WHERE AttrId=0 AND AttrType=6
		DELETE FROM SchemeRetAttr WHERE AttrType=6 AND SchId IN  (SELECT DISTINCT SchId FROM @Temp_CtgAttrDt)
		AND SchId NOT IN (SELECT SchId FROM SchAttrToAvoid)
--		INSERT INTO SchemeRetAttr
--		SELECT DISTINCT B.SchId,6,A.RtrClassId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) 
--		FROM RETAILERVALUECLASS A 
--		INNER JOIN @Temp_CtgAttrDt B ON A.CtgMainId=B.CtgMainId 
--		INNER JOIN @Temp_ValAttrDt C ON A.ValueClassCode = C.ValClass AND B.SchId=C.SchId
--		AND B.SchId NOT IN (SELECT SchId FROM SchAttrToAvoid)
		INSERT INTO SchemeRetAttr
		SELECT DISTINCT C.SchId,6,A.RtrValueClassId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) FROM 
		(SELECT DISTINCT RVC.ValueClassCode,RVCM.RtrValueClassId,RC.CtgMainId,RC.CtgLinkId,RCL.CtgLevelId,
		R.RtrKeyAcc,R.VillageId,RC.CtgLinkCode
		FROM Retailer R INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId 
		INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
		INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId) A
		INNER JOIN @Temp_ValAttrDt C ON A.RtrValueClassId = C.RtrClassId  
		INNER JOIN @Temp_CtgAttrDt B ON A.CtgMainId=B.CtgMainId 
		AND C.SchId NOT IN (SELECT SchId FROM SchAttrToAvoid)
		INSERT INTO SchemeRetAttr (SchId,AttrType,AttrId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
		SELECT DISTINCT SchId,AttrType,RtrClassId,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),GETDATE(),121) 
		FROM @Temp_ValAttrDt_Final A WHERE SchId NOT IN (SELECT SchId FROM SchAttrToAvoid) AND NOT EXISTS 
		(SELECT SchId,AttrType,AttrId FROM SchemeRetAttr SA WITH(NOLOCK) 
		WHERE A.SchId = SA.SchId AND A.AttrType = SA.AttrType AND A.RtrClassId = SA.AttrId)
		-->Till Here
		
		DELETE FROM Etl_Prk_SchemeAttribute_Temp WHERE AttrType=6 AND CmpSchCode IN  (SELECT DISTINCT SchId FROM @Temp_CtgAttrDt_Temp)
		INSERT INTO Etl_Prk_SchemeAttribute_Temp
		SELECT DISTINCT B.SchId,6,A.RtrClassId,'N'
		FROM RETAILERVALUECLASS A INNER JOIN @Temp_CtgAttrDt_Temp B
		ON A.CtgMainId=B.CtgMainId INNER JOIN @Temp_ValAttrDt_Temp C ON
		A.RtrClassId = C.RtrClassID AND B.SchId=C.SchId 
		IF EXISTS (SELECT * FROM @Temp_KeyAttrDt)
		BEGIN
			DELETE FROM SchemeRetAttr WHERE AttrType=8 AND SchId IN (SELECT DISTINCT SchId FROM @Temp_KeyAttrDt)
			INSERT INTO SchemeRetAttr
			SELECT DISTINCT SchID,8,RtrId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
			FROM @Temp_KeyAttrDt
		END
		IF EXISTS (SELECT * FROM @Temp_KeyAttrDt)
		BEGIN
			DELETE FROM Etl_Prk_SchemeAttribute_Temp WHERE AttrType=8 AND CmpSchCode IN  (SELECT DISTINCT SchId FROM @Temp_KeyAttrDt)
			INSERT INTO Etl_Prk_SchemeAttribute_Temp
			SELECT DISTINCT SchID,8,RtrId,'N' FROM @Temp_KeyAttrDt
		END
	END
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name ='Proc_Cn2Cs_SpecialDiscount' AND TYPE ='P' )  
DROP Procedure Proc_Cn2Cs_SpecialDiscount
GO
/*    
BEGIN TRAN   
EXEC Proc_Cn2Cs_SpecialDiscount 0   
SELECT PriceId ,Count(Priceid) Cnt  FROM ProductBatchDetails group by PriceId HAVING COUNT(Priceid)>4   
SELECT * FROM CONTRACTPRICINGMASTER where contractid >=17  
SELECT * FROM CONTRACTPRICINGDETAILS where contractid =17  
 select * from ProductBatchDetails where PrdBatId =607 and priceid=9608 and slno=3 order by  priceid   
 select * from specialrateaftdownload_calc where rtrcode ='10017821900054' and prdccode='10170123129144336144PKT005N'  
ROLLBACK TRAN  
*/    
CREATE PROCEDURE Proc_Cn2Cs_SpecialDiscount    
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/*********************************    
* PROCEDURE  : Proc_Cn2Cs_SpecialDiscount    
* PURPOSE  : To insert SpecialRateDetails in Productbatchdetails table    
* CREATED  :  Muthukrishnan.G.P    
* CREATED DATE :  31-12-2012    
* MODIFIED      :       
* DATE AUTHOR   : DESCRIPTION    
------------------------------------------------    
* {date}  {developer}  {brief modification description}    
* 2013-03-01 Vijendra Kumar  CR(PM)-CCRSTPVM0001    
* 05-10-2015 Mahesh Babu D      Tax Not Attached for Product  ICRSTPAR1798    
* 28-12-2015 Mahesh Babu D      Selling Rate Spl Rate Calc   ICRSTPAR1960     
* 04-06-2019 MOHANA   CR CRCRSTPAR0058   INCLUDED CATEGORY WISE DOWNLOAD FOR SPL RATE    
* 29-07-2019    Lakshman M  SR  ILCRSTPAR5341   while downloading refnocode is null  we will created Dummy reference no. after special price got downloaded.    
* 22-08-2019    Lakshman M  SR  ILCRSTPAR5594   Contract pricing Retailer category wsie validation  
* 04-09-2019    MOHANA S  SR ILCRSTPAR5800   INCLUDED RETAILER WISE CONTRACT PRICING   
*********************************/    
SET NOCOUNT ON    
BEGIN    
 DECLARE @RtrHierLevelCode   AS  NVARCHAR(100)    
 DECLARE @RtrHierLevelValueCode  AS  NVARCHAR(100)    
 DECLARE @RtrCode    AS  NVARCHAR(100)    
 DECLARE @PrdCCode    AS  NVARCHAR(100)    
 DECLARE @PrdBatCode    AS  NVARCHAR(100)    
 DECLARE @PrdBatCodeAll   AS  NVARCHAR(100)    
 DECLARE @PriceCode    AS  NVARCHAR(4000)    
 DECLARE @Disperc                AS  NUMERIC(38,6)    
 DECLARE @SplRate    AS  NUMERIC(38,6)    
 DECLARE @PrdCtgValMainId  AS INT    
 DECLARE @CtgLevelId    AS  INT    
 DECLARE @CtgMainId    AS  INT    
 DECLARE @RtrId      AS  INT    
 DECLARE @PrdId      AS  INT    
 DECLARE @PrdBatId    AS  INT    
 DECLARE @PriceId    AS  INT    
 DECLARE @ContractReq   AS  INT    
 DECLARE @SRReCalc    AS  INT    
 DECLARE @ReCalculatedSR   AS  NUMERIC(38,6)    
 DECLARE @EffFromDate   AS  DATETIME    
 DECLARE @EffToDate    AS  DATETIME    
 DECLARE @CreatedDate   AS  DATETIME    
 DECLARE @MulTaxGrp    AS  INT    
 DECLARE @TaxGroupId    AS INT    
 DECLARE @MulRtrId    AS INT    
 DECLARE @MulTaxGroupId   AS  INT    
 DECLARE @DownldSplRate   AS  NUMERIC(38,6)    
 DECLARE @ContHistExist   AS INT    
 DECLARE @ContractPriceIds  AS NVARCHAR(1000)    
 DECLARE @RefPriceId    AS INT    
 DECLARE @CmpId     AS INT    
 DECLARE @CmpPrdCtgId   AS INT    
 DECLARE @RefRtrId    AS INT    
 DECLARE @ErrStatus    AS INT    
 DECLARE @RtrTaxGrp AS INT    
 ------------------- Added By lakshman M Dated ON 29-07-2019 PMS ID: ILCRSTPAR5341    
 DECLARE @Distcode AS NVarchar(20)    
 --DECLARE @Prefixdatemonth As NVARchar(50)    
 --DECLARE @PrefixdatemonthTime AS NVARchar(50)    
 SET @Po_ErrNo=0    
 SET @ErrStatus=0    
 SET @RtrTaxGrp=0    
 --SELECT @Distcode='CP-'+ Substring(DistributorCode,1,4)  FROM Distributor     
 --SELECT @Prefixdatemonth =cast(replace(convert( VARCHAR(10),getdate(),121),'-','') as NVARCHAR(10))+''+replace(convert(VARCHAR(5),getdate(),108),':','')    
 --SELECT @PrefixdatemonthTime = @Distcode+'-'+@Prefixdatemonth    
 --UPDATE A SET CPRefCode=@PrefixdatemonthTime,CPRefName=@PrefixdatemonthTime  FROM Cn2Cs_Prk_SpecialDiscount A where CPRefCode is null and CPRefName is null    
 -------------------------- Till here ----------------------------------    
 SET @ContractReq=1    
 SET @SRReCalc=2    
    TRUNCATE TABLE ETL_Prk_BLContractPricing     
 CREATE TABLE #SpecialRateToAvoid    
 (    
  Slno    BIGINT,    
  RtrHierLevel  NVARCHAR(100) COLLATE DATABASE_DEFAULT,    
  RtrHierValue  NVARCHAR(100) COLLATE DATABASE_DEFAULT,    
  RtrCode    NVARCHAR(100) COLLATE DATABASE_DEFAULT,    
  PrdCCode   NVARCHAR(100) COLLATE DATABASE_DEFAULT,    
  PrdBatCode   NVARCHAR(100) COLLATE DATABASE_DEFAULT,    
  EffectiveFromDate DATETIME    
 )    
 CREATE TABLE #RetailerCategory    
 (    
 CHANNEL NVARCHAR(100),    
 GRP NVARCHAR(100)    
 )    
INSERT INTO #RetailerCategory      
SELECT DISTINCT R.CtgCode AS CHANNEL,RC.CtgCode  AS GRP    
FROM RetailerCategory R(nolock)    
INNER JOIN RetailerCategory RC(nolock)  ON R.CtgMainId  = RC.CtgLinkId     
INNER JOIN RetailerValueClass RVC(nolock) ON  RC.CtgMainId=RVC.CtgMainId    
--INNER JOIN RetailerValueClassMap RCM(nolock) ON RCM.RtrValueClassId=RVC.RtrClassId    
DELETE A FROM Cn2Cs_Prk_SpecialDiscount A(NOLOCK) WHERE RetCatLevelValue NOT IN (SELECT GRP FROm #RetailerCategory) AND RetCategoryLevel ='Group'  
DELETE A FROM Cn2Cs_Prk_SpecialDiscount A(NOLOCK)  WHERE RetCatLevelValue NOT IN (SELECT CHANNEL FROm #RetailerCategory) AND RetCategoryLevel ='Channel'  
  EXEC Proc_CalculateSpecialDiscountAftRate    
 --SELECT DISTINCT CtgCode    
 --FROM RetailerCategory RC     
 --INNER JOIN RetailerValueClass RVC ON  RC.CtgMainId=RVC.CtgMainId    
 --INNER JOIN RetailerValueClassMap RCM ON RCM.RtrValueClassId=RVC.RtrClassId     
  ---Retailer Class Validation    
  --INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  --SELECT DISTINCT T.SlNo,CtgLevelName,T.CtgCode,RtrCode,PrdCCode,PrdBatCode,T.EffectiveFromDate    
  --FROM TempSpecialRateDiscountProduct T    
  --WHERE NOT EXISTS(SELECT GRP FROM #RetailerCategory R WHERE R.GRP=T.CtgCode) AND rtrcode='ALL' AND CtgLevelName ='GROUP'    
  --UNION     
  --SELECT DISTINCT T.SlNo,CtgLevelName,T.CtgCode,RtrCode,PrdCCode,PrdBatCode,T.EffectiveFromDate    
  --FROM TempSpecialRateDiscountProduct T    
  --WHERE NOT EXISTS(SELECT CHANNEL FROM #RetailerCategory R WHERE R.CHANNEL=T.CtgCode) AND rtrcode='ALL' AND CtgLevelName ='CHANNEL'    
  --INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  --SELECT DISTINCT 1,'Special Rate','Retailer','Retailer Not Attached to Category:'+RtrHierLevel+' Not Available' FROM #SpecialRateToAvoid    
  INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  SELECT DISTINCT T.SlNo,CtgLevelName,T.CtgCode,RtrCode,PrdCCode,PrdBatCode,T.EffectiveFromDate    
  FROM TempSpecialRateDiscountProduct T    
  WHERE NOT EXISTS(SELECT CmpRtrCode  FROM Retailer R WHERE R.CmpRtrCode=T.RTRCODE)  AND CtgLevelName='ALL'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Special Rate','Retailer','Retailer Not Available :'+RtrCode  FROM #SpecialRateToAvoid    
  DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON  
   A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode   
  --Product Batch Validation    
  --INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  --SELECT DISTINCT 1,RetCategoryLevel,RetCatLevelValue,'ALL',PrdCategoryLevelValue,'ALL',EffFromDate     
  --FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'    
  --AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK)     
  --INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)    
  --INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  --SELECT DISTINCT 1,'Product','Product & ProductBatch','Product or Product Batch Not Available-'+PrdCategoryLevelValue    
  --FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'     
  --AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK)     
  --INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)    
 INSERT INTO SpecialDiscountDownload_track (Slno,Productcode,ProductBatch,ErrorDescription,Createddate,CpRefcode)  
 SELECT DISTINCT 1,'Product','Product & ProductBatch','Product or Product Batch Not Available-'+PrdCategoryLevelValue,Getdate(),CpRefcode    
 FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'     
 AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK)     
 INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)  
 SELECT A.* INTO #Cn2Cs_Prk_SpecialDisc FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'     
 AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK)     
 INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)  
 DELETE A FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'     
 AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK)     
 INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)  
  --Till Here     
  ---Retailer Category Level Validation    
  INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate    
  FROM TempSpecialRateDiscountProduct    
  WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)  AND ISNULL(RtrCode,'ALL') ='ALL'  
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Special Rate','Retailer Category Level','Retailer Category Level:'+CtgLevelName+' Not Available' FROM TempSpecialRateDiscountProduct    
  WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)   AND ISNULL(RtrCode,'ALL') ='ALL'  
  DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode--Modified by Raja.C    
  ----    
        --ProductTaxGroup Validation       
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 2,'Tax Group','TaxGroup Not Attached','Tax Group for :'+PrdCCode+' Not Available' FROM TempSpecialRateDiscountProduct    
  WHERE PrdCCode  IN (SELECT PrdCCode FROM Product(NOLOCK) WHERE TaxGroupId=0 and prdstatus =1)      
  DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN Product B(NOLOCK)  ON A.PrdCCode=B.PrdCCode and B.TaxGroupId=0     
  --Till here    
  ---Retailer Category Code Validation    
  INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate    
  FROM TempSpecialRateDiscountProduct    
  WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)     AND ISNULL(RtrCode,'ALL') ='ALL'     
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Special Rate','Retailer Category Level Value','Retailer Category Level Value:'+CtgCode+' Not Available' FROM TempSpecialRateDiscountProduct    
  WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)   AND ISNULL(RtrCode,'ALL') ='ALL'     
  DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode   
  --Eeffective From Date Validation    
  INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)    
  SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate    
  FROM TempSpecialRateDiscountProduct    
  WHERE CONVERT(VARCHAR(10),EffectiveFromDate,121)>=CONVERT(VARCHAR(10),GETDATE(),121)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Special Rate','Effective From Date','Effective Date :'+CAST(EffectiveFromDate AS NVARCHAR(12))+' is greater '     
  FROM TempSpecialRateDiscountProduct    
  WHERE CONVERT(VARCHAR(10),EffectiveFromDate,121)>=CONVERT(VARCHAR(10),GETDATE(),121)    
  DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue  and A.Prdccode=B.Prdccode --Modified by Raja.C    
  IF NOT EXISTS(SELECT * FROM TempSpecialRateDiscountProduct)    
  BEGIN    
   RETURN    
  END    
  SELECT @CmpId=ISNULL(CmpId,0) FROM Company C WHERE DefaultCompany=1    
  IF EXISTS(Select 'X' FROM TaxSettingMaster A (NOLOCK)     
  INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId     
  WHERE TaxGroup=1 and A.TaxType='GST')    
  BEGIN        
   Select @RtrTaxGrp=MIN(Distinct A.RtriD) FROM TaxSettingMaster A (NOLOCK)     
   INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId     
   WHERE TaxGroup=1 and A.TaxType='GST' AND RtrGroup='RTRINTRA'       
  END     
  ELSE    
  BEGIN    
   SELECT @RtrTaxGrp=MIN(Distinct A.RtriD) FROM TaxSettingMaster A (NOLOCK)     
   INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId     
   WHERE TaxGroup=1 and A.TaxType='VAT'        
  END    
  SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,    
  RtrCode,0 as RTRID,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,  
  ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,    
  ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,CONVERT(VARCHAR(10),GETDATE(),121)) as EffToDate,    
  ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,    
  ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,    
  Prdbatid,Prk.PrdCtgValMainId,CmpPrdCtgId,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName     
  INTO #SplPriceDetails    
  FROM TempSpecialRateDiscountProduct Prk(nolock)     
  INNER JOIN Product P(nolock) ON Prk.PrdCCode=P.PrdCCode     
  INNER JOIN Productbatch PB(nolock) ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode    
  INNER JOIN ProductCategoryValue PCV(nolock) ON P.PrdCtgValMainId=PCV.PrdCtgValMainId    
  INNER JOIN RetailerCategoryLevel RCL(nolock) ON Prk.CtgLevelName=RCL.CtgLevelName     
  INNER JOIN RetailerCategory RC(nolock) ON Prk.CtgCode=RC.CtgCode     
  WHERE  Prk.EffectiveFromDate<=GETDATE()   AND Prk.PrdCtgValMainId <> 0 AND PRK.RTRCODE='ALL'  
  INSERT INTO #SplPriceDetails    
  SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,    
  RtrCode,0 as RTRID,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,  
  ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,    
  ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,CONVERT(VARCHAR(10),GETDATE(),121)) as EffToDate,    
  ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,    
  ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,    
  Prdbatid,0,0,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName     
  FROM TempSpecialRateDiscountProduct Prk(nolock)     
  INNER JOIN Product P(nolock) ON Prk.PrdCCode=P.PrdCCode     
  INNER JOIN Productbatch PB(nolock) ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode    
  INNER JOIN RetailerCategoryLevel RCL(nolock) ON Prk.CtgLevelName=RCL.CtgLevelName     
  INNER JOIN RetailerCategory RC(nolock) ON Prk.CtgCode=RC.CtgCode     
  WHERE  Prk.EffectiveFromDate<=GETDATE() AND Prk.PrdCtgValMainId = 0 AND  RTRCODE='ALL'  
  --INSERT INTO #SplPriceDetails    
  --SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,    
  --RtrCode,RTRID,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,  
  --ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,    
  --ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,'2013-12-31') as EffToDate,    
  --ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,    
  --ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,    
  --Prdbatid,Prk.PrdCtgValMainId,CmpPrdCtgId,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName      
  --FROM TempSpecialRateDiscountProduct Prk   (nolock)  
  --INNER JOIN Product P (nolock)ON Prk.PrdCCode=P.PrdCCode     
  --INNER JOIN Productbatch PB (nolock)ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode    
  --INNER JOIN ProductCategoryValue PCV(nolock) ON P.PrdCtgValMainId=PCV.PrdCtgValMainId    
  --INNER JOIN RetailerCategoryLevel RCL(nolock) ON Prk.CtgLevelName=RCL.CtgLevelName     
  --INNER JOIN RetailerCategory RC(nolock) ON Prk.CtgCode=RC.CtgCode    
  --INNER JOIN RetailerCategory R (nolock)ON R.CtgLinkCode =RC.CtgCode     
  --WHERE  Prk.EffectiveFromDate<=GETDATE()   AND Prk.PrdCtgValMainId <> 0 AND PRK.RTRCODE='ALL'    
  --INSERT INTO #SplPriceDetails    
  --SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,    
  --RtrCode,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,    
  --ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,    
  --ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,'2013-12-31') as EffToDate,    
  --ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,    
  --ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,    
  --Prdbatid,0,0,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName     
  --FROM TempSpecialRateDiscountProduct Prk (nolock)    
  --INNER JOIN Product P (nolock)ON Prk.PrdCCode=P.PrdCCode     
  --INNER JOIN Productbatch PB(nolock) ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode    
  --INNER JOIN RetailerCategoryLevel RCL (nolock)ON Prk.CtgLevelName=RCL.CtgLevelName     
  --INNER JOIN RetailerCategory RC (nolock)ON Prk.CtgCode=RC.CtgCode     
  --INNER JOIN RetailerCategory R (nolock)ON R.CtgLinkCode =RC.CtgCode     
  --WHERE  Prk.EffectiveFromDate<=GETDATE() AND Prk.PrdCtgValMainId = 0 AND  RTRCODE='ALL'    
 INSERT INTO #SplPriceDetails  
  SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,  
  CMPRtrCode,RTRID,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,  
  ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,  
  ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,CONVERT(VARCHAR(10),GETDATE(),121)) as EffToDate,  
  ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,  
  0 AS CtgLevelId,0 AS CtgMainId,  
  Prdbatid,Prk.PrdCtgValMainId,CmpPrdCtgId,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName     
  FROM TempSpecialRateDiscountProduct Prk   
  INNER JOIN Product P ON Prk.PrdCCode=P.PrdCCode   
  INNER JOIN Productbatch PB ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode  
  INNER JOIN ProductCategoryValue PCV ON P.PrdCtgValMainId=PCV.PrdCtgValMainId  
  INNER JOIN RETAILER R ON R.CmpRtrCode = PRK.RtrCode    
  WHERE  Prk.EffectiveFromDate<=GETDATE()   AND Prk.PrdCtgValMainId <> 0 AND prk.RTRCODE<>'ALL'  
  INSERT INTO #SplPriceDetails  
  SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,  
  CmpRtrCode,RTRID ,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,  
  ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,  
  ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,CONVERT(VARCHAR(10),GETDATE(),121)) as EffToDate,  
  ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,  
  0 AS CtgLevelId,0 AS CtgMainId,  
  Prdbatid,0,0,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type],CPRefCode,CPRefName   
  FROM TempSpecialRateDiscountProduct Prk   
  INNER JOIN Product P ON Prk.PrdCCode=P.PrdCCode   
  INNER JOIN Productbatch PB ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode  
  INNER JOIN RETAILER R ON R.CmpRtrCode = PRK.RtrCode   
  WHERE  Prk.EffectiveFromDate<=GETDATE() AND Prk.PrdCtgValMainId = 0 AND prk.RTRCODE<>'ALL'     
    
  ---Tax Calculation    
  DECLARE @PrdIdTax as BIGINT    
  DECLARE @PrdbatIdTax AS BIGINT    
  DECLARE Cur_Tax CURSOR    
  FOR     
  SELECT DISTINCT PrdId,PrdbatId FROM #SplPriceDetails      
  OPEN Cur_Tax     
  FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax    
  WHILE @@FETCH_STATUS=0    
  BEGIN     
    EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax    
  FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax      
  END      
  CLOSE Cur_Tax    
  DEALLOCATE Cur_Tax     
  DECLARE @MaxPriceId as BIGINT    
  SELECT @MaxPriceId=ISNULL(MAX(PriceId),0) from ProductBatchDetails    
  --SELECT A.*,CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSellRate    
  SELECT A.*,CASE A.ApplyOn WHEN 1 THEN     
           (CASE [Type] WHEN 1 THEN (SplRate*100)/(100+TaxPercentage)    
            WHEN 2 THEN (SplRate*100)/(100+TaxPercentage) END)    
  ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSellRate,   -- MODIFIED FOR ICRSTPAR1960     
  @MaxPriceId+ROW_NUMBER() OVER(Order by A.PrdId,A.PrdBatId,CtgLevelId,CtgMainId,A.PrdCtgValMainId,CmpPrdCtgId,RtrCode)    
  as NewPriceId    
  INTO #PriceMaster    
  FROM #SplPriceDetails A(nolock) INNER JOIN ProductBatchTaxPercent B (nolock) ON A.PrdId=B.PrdId    
  AND A.PrdBatId=b.PrdBatId    
  --SELECT A.*,CASE A.ApplyOn WHEN 1 THEN     
  --         (CASE [Type] WHEN 1 THEN SplRate-(SplRate*(TaxPercentage/100))    
  --          WHEN 2 THEN SplRate-(SplRate*(TaxPercentage/100)) END)    
  --ELSE CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) END AS NewSellRate    
  --,@MaxPriceId+ROW_NUMBER() OVER(Order by A.PrdId,A.PrdBatId,CtgLevelId,CtgMainId,PrdCtgValMainId,CmpPrdCtgId)    
  --as NewPriceId    
  --INTO #PriceMaster    
  --FROM #SplPriceDetails A INNER JOIN ProductBatchTaxPercent B ON A.PrdId=B.PrdId    
  --AND A.PrdBatId=b.PrdBatId    
  --SELECT * FROM ProductBatchTaxPercent WHERE PRDID=2556    
  SELECT PrdbatId,MAX(PriceId) as PriceId     
  INTO #ProductbatchDetails     
  FROM ProductBatchDetails GROUP BY PrdbatId    
  INSERT INTO ProductBatchDetails(    
  PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,    
  Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)    
  SELECT DISTINCT     
  NewPriceId,A.PrdBatId,PrdBatCode+'-SplRate-'+CAST(NewSellRate AS NVARCHAR(100))    
      +CAST(GETDATE() AS NVARCHAR(20)) ,        
  D.BatchSeqId,D.SlNo,    
    (CASE BC.SelRte WHEN 1 THEN NewSellRate ELSE D.PrdBatDetailValue END) AS SelRte,    
    0,1,1,1,GETDATE(),1,GETDATE(),0     
  FROM #PriceMaster A  (nolock)   
  INNER JOIN #ProductbatchDetails B (nolock)ON A.PrdBatId=B.PrdBatId    
  INNER JOIN ProductBatchDetails D (nolock)ON D.PrdBatId=A.PrdBatId and D.PrdBatId=B.PrdBatId and D.PriceId=B.PriceId    
  INNER JOIN BatchCreation BC (nolock)ON BC.BatchSeqId=D.BatchSeqId AND D.SlNo=BC.SlNo    
  INNER JOIN ProductBatch C (nolock)ON C.PrdBatId=A.PrdBatId and C.PrdBatId=B.PrdBatId and C.PrdId=A.PRdId    
  and D.PrdBatId=C.PrdBatId    
  ORder by NewPriceId,A.PrdBatId,D.SlNo    
  UPDATE Counters SET CurrValue=(SELECT ISNULL(Max(PriceId),0) FROM ProductBatchDetails) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'          
  --Contract Price Praking Table insert    
 INSERT INTO Cn2Cs_Prk_ContractPricing(CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,PrdCtgValMainId,    
 RtrId,PrdId,PrdBatId,PriceId,DiscountPerc,FlatAmount,EffectiveDate,ToDate,CreatedDate,RtrTaxGroupId,ApplyOn,SplPrice,WithTax,ComConRefNo,ComConRefName)    
 SELECT DISTINCT @CmpId,CtgLevelId,CtgMainId,0,0,a.PrdCtgValMainId,CASE WHEN RtrCode='ALL' THEN '0' ELSE ISNULL(RtrCode,'') END,    
 Prdid,Prdbatid,NewPriceId,0,0,A.EffFromDate,A.EffToDate,A.CreatedDate,@RtrTaxGrp,A.ApplyON,SplPrice,SPWTax,B.CPRefCode,B.CPRefName    
 FROM #PriceMaster A (nolock) INNER JOIN Cn2Cs_Prk_SpecialDiscount B (nolock) ON A.RtrHierLevelCode = B.RetCategoryLevel     
 AND A.RtrHierLevelValueCode = B.RetCatLevelValue AND A.CPRefCode=B.CPRefCode  AND A.CPRefName = B.CPRefName    
 UNION ALL  
 SELECT DISTINCT @CmpId,CtgLevelId,CtgMainId,0,0,a.PRDCTGVALMAINID,rtrid,  
 Prdid,Prdbatid,NewPriceId,0,0,A.EffFromDate,A.EffToDate,A.CreatedDate,@RtrTaxGrp,A.ApplyON,SplPrice,SPWTax,B.CPRefCode,B.CPRefName  
 FROM #PriceMaster A INNER JOIN Cn2Cs_Prk_SpecialDiscount B ON A.RtrCode  = B.RetCatLevelValue   
 AND A.CPRefCode=B.CPRefCode  AND A.CPRefName = B.CPRefName --AND DiscPer>0   
  ---Special Rate Screen Table Insert and Update    
  INSERT INTO SpecialRateAftDownLoad(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,    
  SplSelRate,FromDate,CreatedDate,DownloadedDate,ContractPriceIds,DiscountPerc)       
  SELECT DISTINCT RtrHierLevelCode,RtrHierLevelValueCode,RtrCode,PrdCCode,PrdBatCodeAll,    
  NewSellRate,EffFromDate,CreatedDate,GETDATE(),'-'+CAST(NewPriceId AS NVARCHAR(10))+'-',Disperc     
  FROM #PriceMaster A (nolock)    
  WHERE NOT EXISTS(      
   SELECT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode, FromDate     
   FROM     
   SpecialRateAftDownLoad B (nolock) WHERE B.RtrCtgCode=A.RtrHierLevelCode    
   and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode    
   And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll    
   and FromDate<=EffFromDate and B.SplSelRate=A.SplRate    
      )     
  --Added by Rajesh    
  INSERT INTO SpecialRateAftDownLoad_Calc(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,    
  SplSelRate,FromDate,CreatedDate,DownloadedDate,ContractPriceIds,DiscountPerc,ApplyOn,TYPE)      
  SELECT DISTINCT RtrHierLevelCode,RtrHierLevelValueCode,RtrCode,PrdCCode,PrdBatCodeAll,    
  NewSellRate,EffFromDate,CreatedDate,GETDATE(),'-'+CAST(NewPriceId AS NVARCHAR(10))+'-',Disperc     
  ,ApplyOn,TYPE FROM #PriceMaster A (nolock)   
  WHERE NOT EXISTS(      
   SELECT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode, FromDate     
   FROM     
   SpecialRateAftDownLoad_Calc B (nolock) WHERE B.RtrCtgCode=A.RtrHierLevelCode    
   and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode    
   And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll    
   and FromDate<=EffFromDate and B.SplSelRate=A.SplRate    
    )    
  UPDATE B  SET SplSelRate=NewSellRate,ContractPriceIds='-'+CAST(NewPriceId AS NVARCHAR(10))+'-',DiscountPerc=Disperc    
  FROM #PriceMaster A INNER JOIN SpecialRateAftDownLoad_Calc B ON     
  B.RtrCtgCode=A.RtrHierLevelCode    
  and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode    
  And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll     
  AND B.DiscountPerc=A.DisPerc      
  WHERE  FromDate<=EffFromDate    
  --Till here     
  UPDATE B  SET SplSelRate=NewSellRate,ContractPriceIds='-'+CAST(NewPriceId AS NVARCHAR(10))+'-',DiscountPerc=Disperc    
  FROM #PriceMaster A INNER JOIN SpecialRateAftDownLoad B ON     
  B.RtrCtgCode=A.RtrHierLevelCode    
  and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode    
  And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll     
  AND B.DiscountPerc=A.DisPerc  -- Added FOR ICRSTPAR1960    
  WHERE  FromDate<=EffFromDate    
  ---    
  EXEC Proc_Validate_ContractPricing @Po_ErrNo=@ErrStatus    
  SET @Po_ErrNo=@ErrStatus    
  ------------ Added By Lakshman M ON -------  
  
  SELECT * INTO #SpecialRateAftDownload FROM SpecialRateAftDownload(Nolock) WHERE DownloadedDate >='2019-08-01'
    
  IF EXISTS (SELECT * FROM  Cn2Cs_Prk_SpecialDiscount WHERE PrdCategoryLevel='Category')    
  BEGIN    
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P on A.PrdCategoryLevelValue=P.Category_Code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
   AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode AND RtrCode='ALL' 
   AND PrdCategoryLevel='Category' 
    
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK) on A.PrdCategoryLevelValue=P.Category_Code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode     
   AND A.RetCatLevelValue = B.RtrCode    AND RtrCode<>'ALL' AND PrdCategoryLevel='Category'  
  END    
  IF EXISTS (SELECT * FROM  Cn2Cs_Prk_SpecialDiscount WHERE PrdCategoryLevel='Brand')    
  BEGIN     
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Brand_code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
   AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode AND RtrCode='ALL' 
   AND PrdCategoryLevel='Brand'  
   
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Brand_code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
    AND A.RetCatLevelValue = B.RtrCode AND RtrCode<>'ALL' AND PrdCategoryLevel='Brand' 
  END    
  IF EXISTS (SELECT * FROM  Cn2Cs_Prk_SpecialDiscount WHERE PrdCategoryLevel='PriceSlot')    
  BEGIN     
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Priceslot_code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
   AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode  AND RtrCode='ALL' 
   AND PrdCategoryLevel='PriceSlot'
    
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Priceslot_code     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
    AND A.RetCatLevelValue = B.RtrCode  AND RtrCode<>'ALL' AND PrdCategoryLevel='PriceSlot'
  END    
  IF EXISTS (SELECT * FROM  Cn2Cs_Prk_SpecialDiscount WHERE PrdCategoryLevel='Flavor')    
  BEGIN    
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Flavor_Code      
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
   AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode AND RtrCode='ALL' 
   AND PrdCategoryLevel='Flavor'  
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)    
   INNER JOIN TBL_GR_BUILD_PH P(NOLOCK)  on A.PrdCategoryLevelValue=P.Flavor_Code      
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON B.PrdCCode=p.productcode    
    AND A.RetCatLevelValue = B.RtrCode  AND RtrCode<>'ALL'  
    AND PrdCategoryLevel='Flavor'
  END    
 ------------- Till Here --------------    
  --IF @Po_ErrNo=0    
  --BEGIN     
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON A.PrdCategoryLevelValue = B.PrdCCode     
   AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode AND RtrCode='ALL'   
   AND PrdCategoryLevel='Product'
    
   UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK)     
   INNER JOIN #SpecialRateAftDownload B (NOLOCK) ON A.PrdCategoryLevelValue = B.PrdCCode     
   AND A.RetCatLevelValue = B.RtrCode  AND RtrCode<>'ALL' AND PrdCategoryLevel='Product'
   --INSERT FOR REMOVED  
   IF EXISTS (SELECT * FROM #Cn2Cs_Prk_SpecialDisc WHERE DownLoadFlag ='D')  
   BEGIN  
    INSERT INTO Cn2Cs_Prk_SpecialDiscount  
    SELECT * FROM #Cn2Cs_Prk_SpecialDisc WHERE DownLoadFlag ='D'  
   END
  --END    
  ----ADDED BY MOHANA     
  INSERT INTO SpecialRate_Track(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCtgLevel,Prdccode,PrdCtgcode,DiscountPerc,ApplyOn ,Type,FromDate,CreatedDate,DownloadedDate,CpRefNo)    
  SELECT DISTINCT A.RetCategoryLevel,CASE RetCategoryLevel WHEN 'RETAILER' THEN 'ALL' ELSE A.RetCatLevelValue END,    
  CASE WHEN RetCategoryLevel ='RETAILER' THEN A.RetCatLevelValue ELSE 'ALL' END ,PrdCategoryLevel,'',PrdCategoryLevelvalue,DISCPER,ApplyOn ,Type,A.EffFromDate,A.CreatedDate,GETDATE(),  
  CPRefCode FROM  Cn2Cs_Prk_SpecialDiscount A (NOLOCK)  WHERE A.PrdCategoryLevel <>'PRODUCT' AND DOWNLOADFLAG='Y'    
  UNION ALL    
  SELECT DISTINCT A.RetCategoryLevel,CASE RetCategoryLevel WHEN  'RETAILER' THEN 'ALL' ELSE A.RetCatLevelValue END,CASE RetCategoryLevel WHEN 'RETAILER' THEN A.RetCatLevelValue ELSE '' END  ,    
  PrdCategoryLevel,PrdCategoryLevelValue,'',DISCPER,ApplyOn,Type,    
  A.EffFromDate,A.CreatedDate,GETDATE(),CPRefCode FROM  Cn2Cs_Prk_SpecialDiscount A (NOLOCK)     
  WHERE A.PrdCategoryLevel = 'PRODUCT'  AND DOWNLOADFLAG='Y'   
  IF EXISTS (SELECT * FROM SpecialRate_Track WHERE  RtrCode = '')  
  BEGIN  
 UPDATE SpecialRate_Track SET RTRCODE='ALL' WHERE RtrCode = ''  
  END  
  RETURN    
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ReturnSplDiscount' AND TYPE='P')
DROP PROCEDURE Proc_ReturnSplDiscount
GO
--EXEC Proc_ReturnSplDiscount 4,3,6,'2014-03-18',0,0,0,0,0,0
CREATE  PROCEDURE Proc_ReturnSplDiscount
(
      @Pi_PrdId         INT,
      @Pi_PrdBatId            INT,
      @Pi_RtrId         INT,
      @Pi_InvDate             DATETIME,
      @Po_SplDiscount         NUMERIC(38,6)     OUTPUT,
      @Po_SplFlatAmount NUMERIC(38,6)     OUTPUT,
      @Po_SplPriceId          INT         OUTPUT,
      @Po_MRP                 NUMERIC(38,6)     OUTPUT,
      @Po_SellRate            NUMERIC(38,6)     OUTPUT,
      @Po_ClaimablePercOnMRP  NUMERIC(38,6)     OUTPUT,
      @Pi_RtrShipId                 INT=NULL
)
AS
/*********************************
* PROCEDURE : Proc_ReturnSplDiscount
* PURPOSE   : To Return the Special Discount for the Selected Retailer and Product
* CREATED   : Thrinath
* CREATED DATE    : 29/04/2007
* NOTE            : General SP for Returning the Special Discount for the Selected Retailer and Product
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}      {developer}       {brief modification description}
* 24/03/2009  Nandakumar R.G  Addition of Tax Group
*********************************/
SET NOCOUNT ON
BEGIN
      DECLARE @ContractId AS INT
      DECLARE @RtrTaxGroupId AS INT
      DECLARE @PrdCtgValMainId      AS INT
      DECLARE @DiscAlone                  AS INT
      SET @ContractId = 0
      SET @Po_SplDiscount = 0
      SET @Po_SplFlatAmount = 0
      SET @Po_SplPriceId = 0
      SET @Po_MRP = 0
      SET @Po_SellRate = 0
      SET @DiscAlone=0
      
      --GST Change
      SELECT @RtrTaxGroupId=A.TaxGroupId FROM RetailerShipAdd A (NOLOCK)
      INNER JOIN Retailer B (NOLOCK) ON A.RtrId=B.RtrId
      WHERE A.RtrId=@Pi_RtrId and A.RtrShipId=@Pi_RtrShipId
      
      IF ISNULL(@RtrTaxGroupId,0)=0
      BEGIN
            SELECT @RtrTaxGroupId=TaxGroupId FROM Retailer (NOLOCK) WHERE RtrId=@Pi_RtrId
      END
      --Till Here
      
      SELECT @PrdCtgValMainId=PrdCtgValMainId FROM Product WHERE PrdId=@Pi_PrdId    
      --Return Contract Price Id if set at Retailer Level
      --SELECT @ContractId = ISNULL(MAX(ContractId),0) FROM ContractPricingMaster CP WHERE RtrId = @Pi_RtrId
      --AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate     
      
      SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM ContractPricingMaster CP(NOLOCK)
      INNER JOIN ContractPricingDetails B(NOLOCK) ON CP.contractId =b.ContractId  WHERE RtrId = @Pi_RtrId
      AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
      AND PrdId = @Pi_PrdId AND PrdBatId = @Pi_PrdBatId 
      
      
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId  
      
      --SELECT '1',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '2',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Value Class Level with Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.RtrClassId = RVCM.RtrValueClassId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)         
                  WHERE R.RtrId =@Pi_RtrId AND CP.RtrId = 0 AND CP.RtrtaxGroupId=R.TaxGroupId
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      
      --SELECT '3',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '4',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Value Class Level without Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.RtrClassId = RVCM.RtrValueClassId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE R.RtrId =@Pi_RtrId AND CP.RtrId = 0
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '5',@ContractId,@DiscAlone 
      
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '6',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Category Level Value with Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.CtgMainId = RVC.CtgMainId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE R.RtrId =@Pi_RtrId AND CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.RtrtaxGroupId=R.TaxGroupId
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '7',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '8',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Category Level Value without Tax Group-Group Level
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId AND R.RtrId=@Pi_RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.CtgMainId = RVC.CtgMainId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE (CP.RtrId = @Pi_RtrId OR CP.RtrId = 0) AND CP.RtrClassId = 0 AND CP.PrdCtgValMainId IN (0,@PrdCtgValMainId)
                  --Retailer Categorly Level updated By Alphonse J on 2014-03-18
                  IF @ContractId = 0
                  BEGIN
                        SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                        INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId AND R.RtrId=@Pi_RtrId
                        INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                        INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                        INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                        INNER JOIN ContractPricingMaster CP ON CP.CtgMainId = RVC.CtgMainId
                        AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                        INNER JOIN ProductCategoryValue PCV ON CP.PrdCtgValMainId=PCV.PrdCtgValMainId 
                        INNER JOIN ProductCategoryValue PCV1 ON PCV1.PrdCtgValLinkCode LIKE PCV.PrdCtgValLinkCode+'%'
                        INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                        --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                      AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                        WHERE (CP.RtrId = @Pi_RtrId OR CP.RtrId = 0) AND CP.RtrClassId = 0 AND PCV1.PrdCtgValMainId IN (@PrdCtgValMainId)
                  END
            --SELECT * FROM ContractPricingMaster
      END   
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT  '9',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '10',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Category Level Value without Tax Group-Channel Level
      IF @ContractId = 0
      BEGIN
                  SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId AND R.RtrId=@Pi_RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RCG ON RCG.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategory RCC ON RCC.CtgMainId = RCG.CtgLinkId
                  INNER JOIN RetailerCategoryLevel RCL ON RCC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.CtgMainId = RCC.CtgMainId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE (CP.RtrId = @Pi_RtrId OR CP.RtrId = 0) AND CP.RtrClassId = 0 AND CP.PrdCtgValMainId IN (0,@PrdCtgValMainId)
            --SELECT * FROM ContractPricingMaster
      END   
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT  '9-1',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '10-1',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Category Level with Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.CtgLevelId = RCL.CtgLevelId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE R.RtrId =@Pi_RtrId AND CP.RtrId = 0 AND CP.RtrClassId = 0
                  AND CP.CtgMainId = 0 AND CP.RtrtaxGroupId=R.TaxGroupId
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '11',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '12',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Retailer Category Level without Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Retailer  R
                  INNER JOIN RetailerValueClassmap RVCM ON R.RtrId = RVCM.RtrId
                  INNER JOIN RetailerValueClass RVC ON RVCM.RtrValueClassId = RVC.RtrClassId
                  INNER JOIN RetailerCategory RC ON RC.CtgMainId = RVC.CtgMainId
                  INNER JOIN RetailerCategoryLevel RCL ON RC.CtgLevelId = RCL.CtgLevelId
                  INNER JOIN ContractPricingMaster CP ON CP.CtgLevelId = RCL.CtgLevelId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE R.RtrId =@Pi_RtrId AND CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.CtgMainId = 0
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '13',@ContractId,@DiscAlone
      
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '14',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Company Level For all Retailer with Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Product P 
                  INNER JOIN ContractPricingMaster CP ON CP.CmpId = P.CmpId 
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId 
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE P.PrdId =@Pi_PrdId AND CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.CtgMainId = 0
                  AND CP.CtgLevelId = 0 AND CP.RtrtaxGroupId=@RtrTaxGroupId
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '15',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      ----SELECT '16',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Company Level For all Retailer without Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM Product P
                  INNER JOIN ContractPricingMaster CP ON CP.CmpId = P.CmpId
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  WHERE P.PrdId =@Pi_PrdId AND CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.CtgMainId = 0
                  AND CP.CtgLevelId = 0
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '17',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END   
      --SELECT '18',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Company Level For all Retailer with Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM ContractPricingMaster CP
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  WHERE CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.CtgMainId = 0
                  AND CP.CtgLevelId = 0 AND CP.CmpId = 0 AND CP.RtrtaxGroupId=@RtrTaxGroupId
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '19',@ContractId,@DiscAlone
      IF @DiscAlone=0
      BEGIN
            IF NOT EXISTS(SELECT * FROM  ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B ON A.ContractId = B.ContractId
            WHERE A.ContractId=@ContractId AND PrdId=@Pi_PrdId AND      PrdBatId=(CASE DisplayMode WHEN 0 THEN 
            (CASE AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE PrdBatId END) ELSE PrdBatId END))
            BEGIN
                  SET @ContractId=0
            END
      ELSE
            IF NOT EXISTS(SELECT * FROM ContractPricingDetails WHERE ContractId=@ContractId AND
            PrdId=@Pi_PrdId)
            BEGIN
                  SET @ContractId=0
            END
      END
      --SELECT '20',@ContractId,@DiscAlone
      --Return Contract Price Id if set at Company Level For all Retailer without Tax Group
      IF @ContractId = 0
      BEGIN
            SELECT @ContractId = ISNULL(MAX(CP.ContractId),0) FROM ContractPricingMaster CP
                  INNER JOIN ContractPricingDetails CPD ON CP.ContractId= CPD.ContractId AND CPD.PrdID=@Pi_PrdId
                  --AND CPD.PrdBatId=(CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END)
                  AND CPD.PrdBatId=(CASE CP.DisplayMode WHEN 0 THEN (CASE CP.AllowDiscount WHEN 0 THEN @Pi_PrdBatId ELSE CPD.PrdBatId END) ELSE CPD.PrdBatId END)
                  AND CP.Status=1 AND @Pi_InvDate BETWEEN CP.ValidFromDate AND CP.ValidTillDate
                  WHERE CP.RtrId = 0 AND CP.RtrClassId = 0 AND CP.CtgMainId = 0
                  AND CP.CtgLevelId = 0 AND CP.CmpId = 0
      END
      SELECT @DiscAlone=ISNULL(AllowDiscount,0) FROM ContractPricingMaster WHERE ContractId=@ContractId
      --SELECT '21',@ContractId,@DiscAlone
      IF @ContractId = 0
      BEGIN
            SET @Po_SplDiscount = 0
            SET @Po_SplFlatAmount = 0
            SET @Po_SplPriceId = 0
            SET @Po_MRP = 0
            SET @Po_SellRate = 0
            SET @Po_ClaimablePercOnMRP = 0
      END
      ELSE
      BEGIN
            SELECT @Po_SplDiscount = Discount, @Po_SplFlatAmount = FlatAmtDisc,
            @Po_SplPriceId = PriceId, @Po_ClaimablePercOnMRP = ClaimablePercOnMRP 
            FROM ContractPricingMaster A (NOLOCK) INNER JOIN ContractPricingDetails B (NOLOCK) ON A.ContractId = B.ContractId
            WHERE A.ContractId = @ContractId AND PrdId =@Pi_PrdId AND PrdBatId = (CASE PrdBatId WHEN 0 THEN PrdBatId ELSE @Pi_PrdBatId END)
            --PrdBatId = (CASE @DiscAlone WHEN 0 THEN Pi_PrdBatId ELSE PrdBatId END)            
            IF EXISTS (Select PrdBatId From ProductBatchDetails WHERE PriceId = @Po_SplPriceId AND PrdBatId = @Pi_PrdBatId AND DefaultPrice=1)
            BEGIN
                  SET @Po_SplPriceId = 0
                  SET @Po_MRP = 0
                  SET @Po_SellRate = 0
            END
            ELSE
            BEGIN
                  SELECT @Po_MRP = B.PrdBatDetailValue , @Po_SellRate = D.PrdBatDetailValue
                        FROM ProductBatch A (NOLOCK)
                        INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID
                        INNER JOIN BatchCreation C (NOLOCK) ON C.BatchSeqId = B.BatchSeqId
                        AND B.SlNo = C.SlNo AND C.MRP = 1 INNER JOIN ProductBatchDetails D (NOLOCK) ON
                        A.PrdBatId = D.PrdBatID INNER JOIN BatchCreation E (NOLOCK) ON
                        E.BatchSeqId = D.BatchSeqId AND D.SlNo = E.SlNo AND E.SelRte = 1
                        WHERE A.Status = 1 AND A.PrdId=@Pi_PrdId AND B.PriceId = @Po_SplPriceId
                        AND D.PriceID = @Po_SplPriceId AND A.PrdBatId = @Pi_PrdBatId
            END
      END    
RETURN
END
GO
IF NOT EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME = 'CN2Cs_Prk_RetailerMasterDownload' AND type in ('U'))
BEGIN
CREATE TABLE CN2Cs_Prk_RetailerMasterDownload (
	   [DistCode] [varchar](50) NULL,
       [RtrCode] [varchar](50) NULL,
       [RtrName] [varchar](100) NULL,
       [RtrAddress1] [varchar](100) NULL,
       [RtrAddress2] [varchar](100) NULL,
       [RtrAddress3] [varchar](100) NULL,
       [CityName] [varchar](100) NULL,
       [StateName] [varchar](50) NULL,
       [PostalCode] [varchar](50) NULL,
       [RtrChannelCode] [varchar](50) NULL,
       [RtrGroupCode] [varchar](50) NULL,
       [RtrClassCode] [varchar](50) NULL,
       [RtrKeyAcc] [varchar](50) NULL,
       [RelationStatus]	[nvarchar](100),
       [ParentCode]	[nvarchar](100),
       [Status] [varchar](50) NULL,
       [GeoLevel] [nvarchar](100) NULL,
       [GeoLevelValue] [nvarchar](200) NULL,
       [PhNumber] [varchar](50) NULL,
       [ContactPerson] [varchar](50) NULL,
       [TinNumber] [varchar](50) NULL,
       [TaxType] [varchar](50) NULL,
       [RtrTaxGroup] [varchar](50) NULL,
       [SalesRoute] [varchar](50) NULL,
       [DeliveryRoute] [varchar](50) NULL,
       [CashDisc] [numeric](9, 2) NULL,
       [RtrCrLimit][numeric](18,2) NULL,
       [RtrCrDays] [int] NULL,
       [CSRtrType] [varchar](50) NULL,
       [RegDate] [DateTime] NULL,
       [FrequencyMode] [varchar](50) NULL,
       [Eligible] [int] NULL,      
       [RetailerType] [varchar](50) NULL,
       [Composition] [varchar](50) NULL,
       [PANNumber] [varchar](50) NULL,
       [GSTIN] [varchar](50) NULL,
       [RelatedParty] [varchar](50) NULL,
       [Latitude] [varchar](50) NULL,
       [Longitude] [varchar](50) NULL,
       [RtrUniqueCode] [varchar](50) NULL,       
       [Approved] [varchar](50) NULL,
       [RtrMobileNo] [varchar](50) NULL,
       [DownLoadFlag] [varchar](10) NULL,
       [CreatedDate] [datetime] NULL       
)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_LoadingInstitutionsTarget' AND TYPE ='P')
DROP PROCEDURE Proc_LoadingInstitutionsTarget
GO
-- EXEC PROC_LOADINGINSTITUTIONSTARGET 2019,'06','JUNE',2
CREATE PROCEDURE Proc_LoadingInstitutionsTarget
(
	@Year AS INT,
	@Month AS INT,
	@MonthName AS Nvarchar(50),
	@UserId AS INT
)
AS
/*********************************
* PROCEDURE		: Proc_SMIncentiveValidateNProcess
* PURPOSE		: 
* CREATED		: Aravindh Deva C
* CREATED DATE	: 07/03/2016
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date}		{developer}  {brief modification description}
* DATE          AUTHOR       CR/BZ USER     STORY ID           DESCRIPTION                             
*************************************************************************************************************************************    
17-11-2018      Lakshman M		BZ		  ILCRSTPAR5207        target Achivemment base discount amount zero values not considered in core stocky.  
11-09-2019      lakshman M      BZ        ILCRSTPAR5900        while download target achivement max values only considered in report. script validation included.        
*************************************************************************************************************************************/
BEGIN
SET NOCOUNT ON
	
		DELETE T FROM InsTargetDetailsTrans T (NOLOCK) WHERE UserId = @UserId
		DECLARE @Confirm TINYINT
		
		DECLARE @FromDate DATETIME
		DECLARE @ToDate DATETIME
		
	
		SELECT @FromDate = CONVERT(Nvarchar(10),CAST(@Year AS VARCHAR(5))+ '-' + CAST(@Month AS VARCHAR(2)) + '-01',121)
		SELECT @ToDate = DATEADD(DD,-1,DATEADD(MM,1,@FromDate))
		
		DECLARE  @InsDetails TABLE
		(
		 Insid Int,
		 Rtrid int,
		 Achievement Numeric(18,6),
		 BaseAch Numeric(18,6),
		 TargetAch Numeric(18,6),
		 ValBaseAch Numeric(18,6),
		 ValTargetAch Numeric(18,6),
		 ClmAmount Numeric(18,6),
		 Liability Numeric(18,6),
		 LastModDate Datetime
		 )
		 
		 CREATE TABLE #Institution
		 (
		  CtgMainId Int,
		  CtgName Nvarchar(100),
		  Rtrid int,
		  RtrCode Nvarchar(50),
		  RtrName Nvarchar(100),
		  AvgSal Numeric(18,6),
		  Target Numeric(18,6),
		  Achievement Numeric(18,6),
		  BaseAch Numeric(18,6),
		  TargetAch Numeric(18,6),
		  ValBaseAch Numeric(18,6),
		  ValTargetAch Numeric(18,6),
		  ClmAmount Numeric(18,6),
		  Liability Numeric(18,6),
		  CSAch Numeric(18,6),
		  Insid int,
		  Flag Int
		  )
		  
		INSERT INTO #Institution
		SELECT Distinct CtgMainId,CtgName,Rtrid,RtrCode,RtrName,AvgSal,[Target],0.00 as Achievement,0.00 as BaseAch,0.00 as TargetAch,
		0.00 as ValBaseAch,0.00 as ValTargetAch,0.00 as ClmAmount,0.00 as Liability,0.00 AS CSAch,Insid,0 as Flag  FROM
		(SELECT DISTINCT D.CtgMainId,D.CtgName,C.RtrId,C.RtrCode,C.RtrName,B.AvgSal,B.[Target],H.Insid
		FROM InsTargetHD H (NOLOCK)
		--INNER JOIN InsTargetDetails D (NOLOCK) ON H.InsId = D.InsId
		--left outer JOIN RetailerCategory C (NOLOCK) ON D.RtrCtgMainId = C.CtgMainId
		--LEFT OUTER JOIN RetailerValueClass V (NOLOCK) ON C.CtgMainId = V.CtgMainId
		--LEFT OUTER JOIN RetailerValueClassMap M (NOLOCK) ON V.RtrClassId = M.RtrValueClassId
		--LEFT OUTER JOIN Retailer R (NOLOCK) ON M.RtrId = R.RtrId AND D.RtrId = R.RtrId
		inner join InsTargetDetails B ON H.InsId =B.InsId 
		inner join Retailer C ON B.RtrId =C.Rtrid
		LEFT OUTER JOIN RetailerValueClassMap M (NOLOCK) ON C.RtrId = M.RtrId
		LEFT OUTER JOIN RetailerValueClass V (NOLOCK) ON  V.RtrClassId  =M.RtrValueClassId
		left outer JOIN RetailerCategory D (NOLOCK) ON  D.CtgMainId =V.CtgMainId 
		WHERE H.EffFromMonthId = @Month and H.TargetYear=@Year AND H.Status =1
		--WHERE H.EffFromMonthId <= @Month and H.TargetYear=@Year
		--UNION ALL
		--SELECT DISTINCT C.CtgMainId,C.CtgName,R.RtrId,R.RtrCode,R.RtrName,D.AvgSal,D.[Target],H.Insid
		--FROM InsTargetHD H (NOLOCK)
		--INNER JOIN InsTargetDetails D (NOLOCK) ON H.InsId = D.InsId
		--INNER JOIN RetailerCategory C (NOLOCK) ON D.RtrCtgMainId = C.CtgMainId
		--INNER JOIN RetailerValueClass V (NOLOCK) ON C.CtgMainId = V.CtgMainId
		--INNER JOIN RetailerValueClassMap M (NOLOCK) ON V.RtrClassId = M.RtrValueClassId
		--INNER JOIN Retailer R (NOLOCK) ON M.RtrId = R.RtrId AND D.RtrId = R.RtrId
		--WHERE H.EffToMonthId >= @Month and H.ToTargetYear=@Year		
		) A
		ORDER BY A.CtgName,A.RtrName
		
			SELECT S.RtrId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales
			INTO #SalesAsAchievement
			FROM 
			(
			SELECT I.RtrId,SUM(S.SalGrossAmount) Sales FROM #Institution I (NOLOCK)
			INNER JOIN SalesInvoice S (NOLOCK) ON I.RtrId = S.RtrId
			WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
			GROUP BY I.RtrId
			UNION ALL
			SELECT I.RtrId,-1 * SUM(R.RtnGrossAmt) FROM #Institution I (NOLOCK)
			INNER JOIN ReturnHeader R (NOLOCK) ON I.RtrId = R.RtrId
			WHERE R.ReturnDate BETWEEN @FromDate AND @ToDate AND R.Status = 0
			GROUP BY I.RtrId
			) AS S GROUP BY S.RtrId
			
			INSERT INTO @InsDetails (Insid,Rtrid,Achievement,BaseAch,TargetAch,ValBaseAch,ValTargetAch,ClmAmount,Liability,LastModDate)
			SELECT DISTINCT Insid,Rtrid,max(Achievement) Achievement,BaseAch,max(TargetAch) TargetAch,max(ValBaseAch) ValBaseAch,
			max(ValTargetAch)ValTargetAch,max(ClmAmount)ClmAmount,Liability,max(lastmoddate)
			FROM InsTargetDetailsAch (Nolock)
			WHERE TargetYear=@Year and TargetMonth=@MonthName
			and Insid In (SELECT Distinct Insid from #Institution)	and TargetYear=@Year and TargetMonth =@MonthName and BaseAch <>'0.000000' -------- Added by lakshman M Dated On PMS ID: ILCRSTPAR5207	
			GROUP BY Insid,Rtrid,BaseAch,Liability		
			
								
			UPDATE I SET I.Achievement=A.Achievement,
			I.BaseAch=A.BaseAch,I.TargetAch=A.TargetAch,I.ValBaseAch=A.ValBaseAch,I.ValTargetAch=A.ValTargetAch,
			I.ClmAmount=A.ClmAmount,I.Liability=A.Liability,Flag=1
			FROM #Institution I (NOLOCK) INNER JOIN @InsDetails A
			ON I.Insid=A.Insid and I.Rtrid=A.Rtrid
						
			UPDATE I SET I.CSAch = A.Sales -- IF NEGATIVE?
			FROM #Institution I (NOLOCK),
			#SalesAsAchievement A (NOLOCK)
			WHERE I.RtrId = A.RtrId
	
		
		
		UPDATE I SET 
		I.AvgSal		= CAST(I.AvgSal AS NUMERIC(18,2)),
		I.[Target]		= CAST(I.[Target] AS NUMERIC(18,2)),
		I.Achievement	= CAST(I.Achievement AS NUMERIC(18,2)),
		I.BaseAch		= CAST(I.BaseAch AS NUMERIC(18,2)),
		I.TargetAch		= CAST(I.TargetAch AS NUMERIC(18,2)),
		I.ValBaseAch	= CAST(I.ValBaseAch AS NUMERIC(18,2)),
		I.ValTargetAch	= CAST(I.ValTargetAch AS NUMERIC(18,2)),
		I.ClmAmount		= CAST(I.ClmAmount AS NUMERIC(18,2)),
		I.Liability		= CAST(I.Liability AS NUMERIC(18,2)),
		I.CSAch		    = CAST(I.CSAch AS NUMERIC(18,2))
		FROM #Institution I (NOLOCK)		
		
		INSERT INTO InsTargetDetailsTrans (SlNo,CtgMainId,CtgName,RtrId,RtrCode,RtrName,AvgSal,[Target],
		CSAchievement,Achievement,BaseAch,TargetAch,ValBaseAch,ValTargetAch,ClmAmount,Liability,UserId,Flag)
		
		SELECT SlNo,CtgMainId,CtgName,RtrId,RtrCode,RtrName,AvgSal,[Target],
		CSAch,Achievement,BaseAch,TargetAch,ValBaseAch,ValTargetAch,ClmAmount,Liability,@UserId UserId,Flag
		FROM
		(
		SELECT ROW_NUMBER() OVER (PARTITION BY CtgMainId ORDER BY CtgName,RtrCode) SlNo,
		CtgMainId,CtgName,RtrId,RtrCode,RtrName,AvgSal,[Target],
		CSAch,Achievement,BaseAch,TargetAch,ValBaseAch,ValTargetAch,ClmAmount,Liability,Flag 
		FROM #Institution
		UNION ALL
		SELECT 9999 SlNo,CtgMainId,'ZZZZZZZZ' CtgName,0 RtrId,'ZZZZZZZZ' RtrCode,'Total' RtrName,SUM(AvgSal) AvgSal,SUM([Target]) [Target],
		sum(CSAch) CSAch,SUM(Achievement) Achievement,SUM(BaseAch) BaseAch,SUM(TargetAch) TargetAch,SUM(ValBaseAch) ValBaseAch,SUM(ValTargetAch) ValTargetAch,
		SUM(ClmAmount) ClmAmount,SUM(Liability),1 as Flag 
		FROM #Institution ROLLUP
		GROUP BY CtgMainId
		) Consolidated ORDER BY CtgMainId,RtrCode
		
		UPDATE I SET CtgName = '',RtrCode = ''
		FROM InsTargetDetailsTrans I (NOLOCK) WHERE SlNo = 9999
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_RptDebitNoteTopSheet' AND TYPE='P')
DROP PROCEDURE Proc_RptDebitNoteTopSheet
GO
/*  
BEGIN TRAN  
EXEC Proc_RptDebitNoteTopSheet 291,2,0,'',0,0,1      
--SELECT * FROM RptDebitNoteTopSheet_Excel1      
--SELECT * FROM RptDebitNoteTopSheet_Excel2   
--SELECT * FROM RptDebitNoteTopSheet_Excel3 
SELECT * FROM RptDebitNoteTopSheet_Excel5  
--SELECT * FROM RptDebitNoteTopSheet_Excel6  
SELECT * FROM RptDebitNoteTopSheet_Excel_GrandTotal  
ROLLBACK TRAN      
*/      
CREATE PROCEDURE Proc_RptDebitNoteTopSheet
(      
 @Pi_RptId   INT,      
 @Pi_UsrId   INT,      
 @Pi_SnapId   INT,      
 @Pi_DbName   NVARCHAR(50),      
 @Pi_SnapRequired INT,@Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT      
)      
AS      
/************************************************************************************************************************************      
* PROCEDURE : Proc_RptDebitNoteTopSheet      
* PURPOSE : To Return the Scheme Utilization Details      
* CREATED : Aravindh Deva C      
* CREATED DATE : 27 05 2016      
* NOTE  : Parle SP for Debit Note Top Sheet      
* MODIFIED       
*************************************************************************************************************************************      
* DATE			AUTHOR			CR/BZ			USER STORY ID           DESCRIPTION                               
*************************************************************************************************************************************      
10-10-2017		Mohana.S			CR			CCRSTPAR0172        Included Circular Date and scheme Budget       
04-12-2017		Mohana				BZ			ICRSTPAR6760		Added New Function for calculating Scheme utilized for selected month      
07-12-2017		Mary.S				BZ			ICRSTPAR6933		Excel Sheet row Witdth change          
13-12-2017		Mohana.S			CR			ICRSTPAR6933		Changed Sampling Amount as Zero (default)         
09-01-2018		Lakshman M			BZ			ICRSTPAR7284        LCTR Formula validation changed.(special price not consider in LCTR Value).      
26-03-2018		Mohana S			CR			CCRSTPAR0187		TOT Diff Claims Report Created.       
08-05-2018		Mohana S			SR			ILCRSTPAR0500       included Removed Scheme Products.       
09-05-2018		Mohana S			BZ			ILCRSTPAR0506       chaged the target data selection      
10-05-2018		Mohana S			BZ			ILCRSTPAR0546		Sales return issue fix in Trade schemes      
08-06-2018		Muthulakshmi.V		BZ			ILCRSTPAR0909       Scheme valid date checking condition changed      
25-07-2018		Lakshman M			BZ			ILCRSTPAR1496       Scheme code valdiation included from CS.      
30-08-2018		Amuthakumar P		BZ			ILCRSTPAR1917		Changed Sampling Amount from Sample Issue ( FreeIssueDt)      
19-09-2018		Amuthakumar P		BZ			CRCRSTPAR0023		Debit note Top Sheet not Consider un-salable Sales return / Manual Claim Report Inserted      
09-10-2018		Mohana P			BZ			ILCRSTPAR2313       TAX CALCULATION CHANGED AS PER CLIENT REQUEST      
12-10-2018		Mohana P			BZ			ILCRSTPAR2343       TAX CALCULATION CHANGED AS PER CLIENT REQUEST      
16-10-2018		Mohana P			BZ			ILCRSTPAR2343       Incorprated LIVE Changes in UAT (AS per Awanish discussion, LIVE REport is correct. So we have changed based on live)      
07-12-2018		Lakshman M			BZ			ILCRSTPAR2760       As per Client request manual claim valdaition included.      
19-12-2018		Vasantharaj R		SR			ILCRSTPAR2868       As per Client request [All the report must be generate based on Date range selection.]       
12-03-2019		Lakshman M			SR			CRCRSTPAR0037       As per Client request scheme category type validation included from CS.      
15-03-2019		Lakshman M			SR			ILCRSTPAR3767       As per Client request scheme category non trade scheme Sec sales qty and sec sales values validation included from CS.       
17-04-2019		Lakshman M			CR			CRCRSTPAR0042       In Report Grand Total values added report wise.  
25-04-2019		lakshman M			SR			ILCRSTPAR4201       IN Report GRAND Total validation included.  
30-04-2019		Lakshman M			SR			ILCRSTPAR4224       column name altered for this report  
21-06-2019		S.MOORTHI			CR			CRCRSTPAR0056       STO(Service to Outlet) or Distributor incentive logic to be incorporated and debit note should upload to console  
11-07-2019		S.Mohana			CR			ILCRSTPAR5132		Included General Scheme In Trade Scheme Part
17-07-2019		S.MOHANA			CR			ILCRSTPAR5199		INCLUDED SM INCENTIVE DETAILS 
20-08-2019      Lakshman M          SR          ILCRSTPAR5536       manual claim report circular valid from and valid to date considered in script level.
04-09-2019      Deepak K            BZ          ILCRSTPAR5812       Date Range validation added into manual Claim for avoid the duplication circular No wise.
07-09-2019      Raja C              BZ          ILCRSTPAR5847        Manual claim details not showing
12-10-2019      Deepak K            SR          ILCRSTPAR6283       Consider the Date Range based on IncFromDate  and IncToDate
************************************************************************************************************************************/           
BEGIN      
 SET NOCOUNT ON      
 DECLARE @FromDate   AS DATETIME      
 DECLARE @ToDate    AS DATETIME      
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)      
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)      
 --Report 1      
  DECLARE @CityName AS NVARCHAR(100)      
 DECLARE @DistributorCode AS NVARCHAR(40)      
 DECLARE @DistributorName AS NVARCHAR(100)      
 DECLARE @DBMonth As INT     
  --SELECT @FromDate,@ToDate
 EXEC Proc_SchUtilization_Report @FromDate,@ToDate      
 SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,      
 @CityName = G.GeoName      
 FROM Distributor D (NOLOCK),      
 Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId      
 --Added By Mohana       
 --SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate      
 SELECT @DBMonth = CASE MONTH (@ToDate)       
  WHEN 4 THEN 1      
  WHEN 5 THEN 2      
  WHEN 6 THEN 3      
  WHEN 7 THEN 4      
  WHEN 8 THEN 5      
  WHEN 9 THEN 6      
  WHEN 10 THEN 7      
  WHEN 11 THEN 8      
  WHEN 12 THEN 9      
  WHEN 1 THEN 10      
  WHEN 2 THEN 11      
  WHEN 3 THEN 12      
 END       
 --Report 1      
 --Report 2      
 DECLARE @slno AS INT      
 DECLARE @SamplingAmount AS NUMERIC(18,2)      
 SELECT @slno = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'      
 --- Change by Amuthakumar P ILCRSTPAR1917      
 SELECT @SamplingAmount = ISNULL(SUM(D.TotalAmt),0)      
 FROM FreeIssueHd J (NOLOCK),      
 FreeIssueDt D (NOLOCK),      
 ProductBatchDetails P (NOLOCK)      
 WHERE J.IssueId = D.IssueId       
 AND P.PrdBatId = D.PrdBatId AND P.PriceId = D.PriceId       
 AND P.SLNo = 3 AND J.IssueDate BETWEEN @FromDate AND @ToDate      
--*****************************************************************************Report 2*******************************************************************************
 --- Till Here ILCRSTPAR1917      
 --Report 3      
 EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate      
 SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)       
 -------------------- Added by Lakshman M On 07/11/2017 PMS_ICRSTPAR6575-------------------      
  -------------- Scheme code validation added by LAkshman M Dated By On 25/07/2018 PMS ID:ILCRSTPAR1496 ------------      
  SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,          
  B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
  INTO #BillingDetails          
  FROM SalesInvoice S (NOLOCK)          
  INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId       
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1        
  --INNER JOIN Debitnote_Scheme D ON D.Salid = S.SalId AND SP.SalId = D.Salid AND D.Prdid =SP.PrdID AND D.linetype = 1      
  WHERE S.SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3      
  SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,          
  B.DefaultPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue,CAST(0 AS Int) AS Schid          
  INTO #ReturnDetails          
  FROM ReturnHeader S (NOLOCK)          
  INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID          
  INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId          
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1      
  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)       
 --INNER JOIN Debitnote_Scheme D ON D.Salid = S.ReturnID AND SP.ReturnID = D.Salid AND D.linetype = 2      
  WHERE S.ReturnDate BETWEEN  @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3      
  SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,      
PrdBatDetailValue as PrdUnitSelRate,Schid,         
  CAST (0 AS NUMERIC(18,6)) AS LCTR      
  INTO #DebitSalesDetails          
  FROM           
  (          
  SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #BillingDetails         
  UNION ALL          
  SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId ,SlNo,prdtaxamount,PrdBatDetailValue,Schid  FROM #ReturnDetails          
  ) Consolidated       
 ------------------ Till Here ----------------------      
  UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)          
  FROM #DebitSalesDetails M (NOLOCK),          
  ProductBatchDetails D (NOLOCK)           
  WHERE M.ActualPriceId = D.PriceId AND D.SLNo = 3       
 ---------------- commented by Lakshman M on 07/11/2017 ---------------        
 --UPDATE R SET R.LCTR = R.BaseQty * (R.ActualSellRate+(R.ActualSellRate*(T.TaxPerc/100)))      
 --FROM #DebitSalesDetails R (NOLOCK),      
 --#ParleOutputTaxPercentage T (NOLOCK)      
 --WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType      
  -----------------------      
  UPDATE R SET R.LCTR = ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2)            
  FROM #DebitSalesDetails R (NOLOCK),          
  #ParleOutputTaxPercentage T (NOLOCK)      
  WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType        
 CREATE TABLE #ApplicableProduct      
 (      
  SchId  INT,      
  PrdId   INT      
 )      
 INSERT INTO #ApplicableProduct(SchId,PrdId)      
 SELECT DISTINCT A.SchId,B.Prdid      
  FROM SchemeMaster A      
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid      
  INNER JOIN Product C On B.Prdid = C.PrdId      
  WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0      
 UNION ALL      
 SELECT DISTINCT A.SchId,E.Prdid      
  FROM SchemeMaster A      
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid      
  INNER JOIN ProductCategoryValue C ON       
  B.PrdCtgValMainId = C.PrdCtgValMainId       
  INNER JOIN ProductCategoryValue D ON      
  D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
  INNER JOIN Product E On      
  D.PrdCtgValMainId = E.PrdCtgValMainId       
  INNER JOIN ProductBatch F On      
  F.PrdId = E.Prdid      
  WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0      
 UNION ALL      
 SELECT DISTINCT S.SchId,B.MasterRecordId      
  FROM SchemeProducts A       
  INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId       
  INNER JOIN SchemeMaster S ON A.SchId = S.SchId      
  WHERE S.SchemeLvlMode = 1      
  --added by mohana ILCRSTPAR0500       
 INSERT INTO #ApplicableProduct(SchId,PrdId)      
 SELECT Schid ,PrdId FROM SchemeMasterControlHistory A INNER JOIN SchemeMaster B ON A.CmpSchCode = B.CmpSchCode      
 INNER JOIN Product C ON c.PrdCCode = A.FromValue      
 WHERE ChangeType='Remove'   AND B.SchId in (SELECT SchId FROM SchemeProducts Where PrdCtgValMainId = 0 )      
 INSERT INTO #ApplicableProduct(SchId,PrdId)        
 SELECT DISTINCT A.SchId,E.Prdid      
 FROM SchemeMaster A      
 INNER JOIN SchemeMasterControlHistory B ON A.CmpSchCode = B.CmpSchCode      
 INNER JOIN ProductCategoryValue C ON       
 B.FromValue = C.PrdCtgValCode      
 INNER JOIN ProductCategoryValue D ON      
 D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
 INNER JOIN Product E On      
 D.PrdCtgValMainId = E.PrdCtgValMainId       
 INNER JOIN ProductBatch F On      
 F.PrdId = E.Prdid      
 WHERE A.SchemeLvlMode = 0  AND A.SchId in (SELECT SchId FROM SchemeProducts Where PrdId = 0 )      
 AND ChangeType='Remove'        
 CREATE TABLE #ApplicableScheme      
 (      
  SchId   INT,      
  SchDsc   NVARCHAR(100),      
  SchValidFrom DATETIME,      
  SchValidTill DATETIME,       
  Budget   NUMERIC(18,2),      
  BudgetAllocationNo VARCHAR(100),      
  PrdId   INT      
 )      
 INSERT INTO #ApplicableScheme (SchId,SchDsc,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)         
 SELECT DISTINCT A.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId      
 FROM #ApplicableProduct A (NOLOCK),      
 SchemeMaster S (NOLOCK)      
 WHERE A.SchId = S.SchId AND A.SchId  IN (SELECT SCHID FROM Debitnote_Scheme)       
 AND S.Claimable = 1      
 --Added CircularNo and date By Mohana      
 --SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 --SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 --CAST(0 AS NUMERIC(18,6)) Amount      
 --INTO #SchemeDebit      
 --FROM #ApplicableScheme S (NOLOCK),      
 --#DebitSalesDetails B (NOLOCK) ,      
 --SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode       
 --WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId AND S.SchId in (SELECT DISTINCT  SCHID FROM DEbitnote_Scheme)       
 --GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
 --ORDER BY S.SchId      
 --SchemeCirculardetails      
 SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 INTO #SchemeDebit1      
 FROM #ApplicableScheme S (NOLOCK),      
 #DebitSalesDetails B (NOLOCK) ,      
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=1 AND      
 --PMS NO:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (B.Transdate BETWEEN @FromDate AND @ToDate      
 OR B.TransDate BETWEEN @FromDate AND @ToDate)----PMS NO:ILCRSTPAR1309 Till Here      
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type IN ('Trade Scheme','General Scheme'))  --ILCRSTPAR5132    
 GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate      
 ORDER BY S.SchId      
 ---------------------- Added By lakshman  Dated On 16-03-2019 PMS ID: ILCRSTPAR3767      
 --INSERT INTO #SchemeDebit1       
 --SELECT DISTINCT APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 --SUM(SP.BaseQty) [SecSalesQty],CAST(SUM(SP.PrdActualNetAmount) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
 --from SalesInvoice S       
 --inner join SalesInvoiceproduct SP ON S.salid =sp.salid       
 --inner join SalesInvoiceSchemeLineWise SIL ON SIL.salid=s.salid and SIL.salid =SP.salid AND SIL.prdid =sp.prdid and sil.prdbatid =sp.PrdBatId       
 --inner join #DebitSalesDetails DS ON DS.salid =S.salid AND DS.salid =SP.salid AND DS.salid =SIl.salid and DS.prdid =SP.prdid and DS.prdbatid = SP.prdbatid AND DS.prdid =SP.prdid and DS.prdbatid =SIl.prdbatid        
 --inner join #ApplicableScheme APS ON APS.schid = SIL.schid AND APS.prdid =DS.prdid AND APS.Prdid =SIL.Prdid       
 --inner join SchemeMaster SM ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
 --LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana  
 --WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  and Transtype=1 AND      
 ----PMS NO:ILCRSTPAR0909      
 ----S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 ----AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 ----(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 ----or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 --(DS.Transdate BETWEEN @FromDate AND @ToDate      
 --OR DS.TransDate BETWEEN @FromDate AND @ToDate)----PMS NO:ILCRSTPAR1309 Till Here      
 --AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type not IN ('Trade Scheme','General Scheme'))      
 --GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
 --ORDER BY APS.SchId      
INSERT INTO #SchemeDebit1       
SELECT APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(SP.BaseQty) [SecSalesQty],Round(CAST((sum(SP.BaseQty*PrdBatDetailValue)+ (sum(SP.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,2)),2)  AS  [SecSalesVal],      
 CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
 from SalesInvoice S       
 inner join SalesInvoiceproduct SP ON S.salid =sp.salid       
 inner join SalesInvoiceSchemeLineWise SIL ON SIL.salid=s.salid and SIL.salid =SP.salid AND SIL.prdid =sp.prdid and sil.prdbatid =sp.PrdBatId       
 inner join #DebitSalesDetails DS ON DS.salid =S.salid AND DS.salid =SP.salid AND DS.salid =SIl.salid and DS.prdid =SP.prdid and DS.prdbatid = SP.prdbatid AND DS.prdid =SP.prdid and DS.prdbatid =SIl.prdbatid        
 inner join #ApplicableScheme APS ON APS.schid = SIL.schid AND APS.prdid =DS.prdid AND APS.Prdid =SIL.Prdid       
 inner join SchemeMaster SM ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
 inner join #ParleOutputTaxPercentage T ON T.salid =DS.salid and S.salid =T.salid and SP.Salid =T.salid AND SP.Salid =SIL.Salid and DS.slno =T.PrdSlno and T.TransId = DS.TransType       
 LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 inner join ProductBatchDetails D on D.prdbatid=SIL.prdbatid and D.prdbatid=Sp.prdbatid and D.SlNo=3 and DefaultPrice=1      
 WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  and Transtype=1 AND      
 --PMS NO:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (DS.Transdate BETWEEN @FromDate AND @ToDate      
 OR DS.TransDate BETWEEN @FromDate AND @ToDate)----PMS NO:ILCRSTPAR1309 Till Here      
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type NOT IN ('Trade Scheme','General Scheme'))      --ILCRSTPAR5132  
 GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,SP.BaseQty,PrdBatDetailValue,T.TaxPerc      
 ORDER BY APS.SchId      
 ---------------- Till here -----------------      
 INSERT INTO #SchemeDebit1      
 SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 FROM #ApplicableScheme S (NOLOCK),      
 #DebitSalesDetails B (NOLOCK) ,      
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2 AND       
 --PMSNo:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (B.Transdate BETWEEN @FromDate AND @ToDate      
 OR  B.Transdate  BETWEEN @FromDate AND @ToDate)     
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type  IN ('Trade Scheme','General Scheme'))       --ILCRSTPAR5132 
 GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,Transdate       
 ORDER BY S.SchId      
 ----------------- Added By lakshman M ON Dated ON 15-03-2019  PMS ID: ILCRSTPAR3767      
 INSERT INTO #SchemeDebit1      
 SELECT  APS.Schid,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(SP.BaseQty) [SecSalesQty],Round(cast((sum(SP.BaseQty*PrdBatDetailValue)+ (sum(SP.BaseQty*PrdBatDetailValue)*(T.TaxPerc/100))) AS Numeric(18,6)),2) AS  [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,CAST(0 AS NUMERIC(18,6)) Amount      
 from Returnheader S       
 inner join Returnproduct SP ON S.Returnid =sp.Returnid       
 inner join ReturnSchemeLineDt SIL ON SIL.Returnid=s.Returnid and SIL.Returnid =SP.Returnid AND SIL.prdid =sp.prdid and sil.prdbatid =sp.PrdBatId       
 inner join #DebitSalesDetails DS ON DS.salid =S.Returnid AND DS.salid =SP.Returnid AND DS.salid =SIl.Returnid and DS.prdid =SP.prdid and DS.prdbatid = SP.prdbatid AND DS.prdid =SP.prdid and DS.prdbatid =SIl.prdbatid        
 inner join #ApplicableScheme APS ON APS.schid = SIL.schid AND APS.prdid =DS.prdid AND APS.Prdid =SIL.Prdid       
 inner join SchemeMaster SM ON SM.schid =SIL.Schid AND SM.Schid =APS.Schid       
 inner join #ParleOutputTaxPercentage T ON T.salid =DS.salid and S.Returnid =T.salid and SP.Salid =T.salid AND SP.Salid =SIL.Returnid       
 and DS.slno =T.PrdSlno and T.TransId = DS.TransType       
 LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana       
 inner join ProductBatchDetails D on D.prdbatid=SIL.prdbatid and D.prdbatid=Sp.prdbatid and D.SlNo=3 and DefaultPrice=1      
 WHERE APS.PrdId = DS.PrdId AND APS.SchId=SM.SchId  and Transtype=2 AND      
 --PMS NO:ILCRSTPAR0909      
 --S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --AND S.SchValidTill  BETWEEN @FromDate AND @ToDate      
 --(S.SchValidFrom BETWEEN @FromDate AND @ToDate      
 --or S.SchValidTill  BETWEEN @FromDate AND @ToDate)      
 (DS.Transdate BETWEEN @FromDate AND @ToDate      
 OR DS.TransDate BETWEEN @FromDate AND @ToDate)----PMS NO:ILCRSTPAR1309 Till Here      
 AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type not IN ('Trade Scheme','General Scheme'))       --ILCRSTPAR5132 
 GROUP BY APS.SchId,APS.SchDsc,APS.SchValidFrom,APS.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate,SP.BaseQty,PrdBatDetailValue,T.TaxPerc      
 ORDER BY APS.SchId      
 ----------------- Till here ----------------      
 DELETE FROM #SchemeDebit1 WHERE SchId NOT IN (SELECT Schid FROM Debitnote_Scheme WHERE Linetype=1)            
 INSERT INTO #SchemeDebit1      
 SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 FROM #ApplicableScheme S (NOLOCK),      
 #DebitSalesDetails B (NOLOCK) ,      
 SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
 ,Debitnote_Scheme D         
 WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2        
 AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid       
 AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)      
 GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
 ORDER BY S.SchId      
  --- added on 12-MAr-2019      
  --INSERT INTO #SchemeDebit1       
  --SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
  --SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
  --CAST(0 AS NUMERIC(18,6)) Amount      
  --FROM #ApplicableScheme S (NOLOCK),      
  --#DebitSalesDetails B (NOLOCK) ,      
  --SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
  --,Debitnote_Scheme D         
  --WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2        
  --AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid       
  --AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)      
  --AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type IN ('Trade Scheme','General Scheme'))      
  --GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
  --ORDER BY S.SchId      
  --INSERT INTO #SchemeDebit1       
  --SELECT  S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,      
  --SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
  --CAST(0 AS NUMERIC(18,6)) Amount      
  --FROM #ApplicableScheme S (NOLOCK),      
  --#DebitSalesDetails B (NOLOCK) ,      
  --SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana      
  --,Debitnote_Scheme D         
  --WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId  and Transtype=2        
  --AND S.Schid = D.Schid AND B.Prdid =D.Prdid AND B.Salid =D.Salid       
  --AND S.SchId NOT IN (SELECT schid FROM #SchemeDebit1)      
  --AND SM.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type NOT IN ('Trade Scheme','General Scheme'))      
  --GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate      
  --ORDER BY S.SchId      
  -- end here 12-Mar-2019      
 SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
 SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 INTO #SchemeDebit       
 from #SchemeDebit1 A      
 INNER JOIN SCHEMEMASTER B ON A.schid=B.schid and B.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type IN ('Trade Scheme','General Scheme') )        --ILCRSTPAR5132
 GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate      
 INSERT  INTO #SchemeDebit      
 SELECT  A.SchId,A.SchDsc,A.SchValidFrom,A.SchValidTill,SchemeBudget,CircularNo, CircularDate,      
 SUM(SecSalesQty) SecSalesQty,CAST(SUM(SecSalesVal) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,      
 CAST(0 AS NUMERIC(18,6)) Amount      
 from #SchemeDebit1 A      
 INNER JOIN SCHEMEMASTER B ON A.schid=B.schid and B.cmpschcode in (select Cmpschcode from SchemeCategorydetails where Schcategory_type NOT IN ('Trade Scheme','General Scheme') )      --ILCRSTPAR5132  
 GROUP BY A.SchId,A.SchDsc,a.SchValidFrom,a.SchValidTill,SchemeBudget,CircularNo, CircularDate      
   --ILCRSTPAR2868      
 SELECT DISTINCT TaxPerc,B.SalId,B.PrdId  INTO #TaxPerc FROM SalesInvoiceProduct B       
 INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.SalId and  B.SlNo = P.PrdSlno AND TRANSID = 1       
 --Till Here       
 SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt INTO #SchFinal FROM       
  (      
  SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt       
   FROM (      
  --ILCRSTPAR2868      
  --SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A       
  --INNER JOIN SalesInvoiceProduct B ON A.Salid = b.SalId AND a.Prdid = b.PrdId        
  --INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.SalId AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 1 AND Linetype = 1      
  --GROUP BY  A.PRDID,A.SchId,TaxPerc      
  SELECT  Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A       
  INNER JOIN #TaxPerc B ON A.Salid = b.SalId AND a.Prdid = b.PrdId AND Linetype = 1       
  GROUP BY  A.PRDID,A.SchId,TaxPerc      
  --Till Here      
  )A      
  GROUP BY A.SchId,TaxPerc      
  )B Group by  sCHID       
  insert into #SchFinal      
  SELECT Schid,SUM(Schamt) SchAmt ,Sum(taxamt) TaxAmt FROM       
  (      
  SELECT A.SchId,SUM(A.schamt) SchAmt, (SUM(A.schamt)*(TaxPerc/100)) TaxAmt          
  FROM (      
  SELECT Schid ,a.PRDID,TaxPerc,SUM (FlatAmount+DiscountPer+FreeValue+GiftValue)schamt FROM Debitnote_Scheme A INNER JOIN RETURNPRODUCT B ON A.Salid = b.ReturnID AND a.Prdid = b.PrdId       
  INNER JOIN ParleOutputTaxPercentage P ON P.SalId = B.ReturnID AND A.Salid = P.SalId AND B.SlNo = P.PrdSlno AND TRANSID = 2 AND a.Linetype =2      
  and StockTypeId IN (SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1)        
  GROUP BY  A.PRDID,A.SchId,TaxPerc      
  )A      
  GROUP BY A.SchId,TaxPerc      
  )B Group by  sCHID       
 UPDATE SD SET SD.Amount = CASE S.ApplyTaxForClaim WHEN 0 THEN schamt ELSE  (SchAmt+TaxAmt) END      
 FROM #SchemeDebit SD (NOLOCK) INNER JOIN (SELECT Schid,SUM(SchAmt) SchAmt ,Sum(Taxamt) TaxAmt FROM  #SchFinal GROUP BY Schid) D  ON SD.Schid = D.Schid --CHANGED FOR CLAIMAMT MISMATCH      
 INNER JOIN SchemeMaster S ON S.SchId = D.SCHID AND S.SchId = SD.SCHID       
 UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))      
 FROM #SchemeDebit SD (NOLOCK)      
 WHERE SD.[SecSalesVal] <> 0      
 --*********************************************************************Report 3**********************************************************************************
 DECLARE @TargetNo AS INT      
 DECLARE @InsFromDate AS DATETIME       
 DECLARE @InsToDate  AS DATETIME      
 DECLARE @Year AS INT       
 DECLARE @Month  AS INT      
 DECLARE @MonthName as Nvarchar(100) 
 --Changed by Mohana ILCRSTPAR0506       
 SELECT   TOP 1 @TargetNo = InsId,@Month=TargetMonth,@Year=TargetYear,      
 @InsFromDate = CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01',      
 @InsToDate = DATEADD(DD,-1,DATEADD(MM,1,CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01'))       
 FROM InsTargetHD H (NOLOCK)       
 INNER JOIN  JCMonth A  ON H.TargetMonth = A.JcmJc      
 INNER JOIN    JCMast b on a.JcmId = b.JcmId AND H.TargetYear =  B.JcmYr      
 WHERE A.JcmEdt  BETWEEN @FromDate AND @ToDate AND H.[Status] = 1       
 ORDER BY InsId DESC 
 SELECT @MonthName=MonthName FROM MonthDt (NOLOCK) WHERE MonthId=@Month  
 UPDATE InsTargetHD SET TargetMonth=EffFromMonthId WHERE TargetMonth=0   
 --EXEC Proc_LoadingInstitutionsTarget @TargetNo,@Pi_UsrId      
 EXEC Proc_LoadingInstitutionsTarget @Year,@Month,@MonthName,@Pi_UsrId   
 SELECT CtgMainId,CtgName,@InsFromDate FromDate,@InsToDate ToDate,SUM([Target]) [Target],SUM(ClmAmount) DiscAmount,      
 CAST(0 AS NUMERIC(18,6)) L2MSales,CAST(0 AS NUMERIC(18,6)) CurMSales,CAST(0 AS NUMERIC(18,0)) Outlet      
 INTO #Institutions      
 FROM InsTargetDetailsTrans (NOLOCK) WHERE CtgName <>''      
 --WHERE UserId = @Pi_UsrId AND SlNo <> 0 and SlNo<>9999      
 GROUP BY CtgMainId,CtgName     
 SELECT DISTINCT R.RtrId,RC.CtgMainId      
 INTO #FilterRetailer      
 FROM Retailer R (NOLOCK),      
 RetailerValueClassMap RVCM (NOLOCK),      
 RetailerValueClass RVC (NOLOCK),      
 RetailerCategory RC (NOLOCK),      
 RetailerCategoryLevel RCL (NOLOCK)      
 WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
 AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId      
 AND EXISTS (SELECT '' FROM #Institutions I (NOLOCK) WHERE I.CtgMainId = RC.CtgMainId)  
 SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
 INTO #CurrentSales      
 FROM       
 (      
 SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),      
 #FilterRetailer R      
 WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
 AND S.RtrId = R.RtrId      
 GROUP BY R.CtgMainId      
 UNION ALL      
 SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),      
 #FilterRetailer F      
 WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0      
 AND F.RtrId = R.RtrId      
 GROUP BY F.CtgMainId      
 ) AS S GROUP BY S.CtgMainId   
 SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet      
 INTO #NoOfOutlet      
 FROM SalesInvoice S (NOLOCK),      
 #FilterRetailer R      
 WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
 AND S.RtrId = R.RtrId      
 GROUP BY R.CtgMainId   
 --Last Two Month Sales      
 SELECT @InsToDate = DATEADD (D,-1,@InsFromDate)       
 SELECT @InsFromDate = DATEADD (MONTH,-2,@InsFromDate)       
 SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales      
 INTO #L2MSales      
 FROM       
 (      
 SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),      
 #FilterRetailer R      
 WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3      
 AND S.RtrId = R.RtrId      
GROUP BY R.CtgMainId      
 UNION ALL      
 SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),      
 #FilterRetailer F      
 WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0      
 AND F.RtrId = R.RtrId      
 GROUP BY F.CtgMainId      
 ) AS S GROUP BY S.CtgMainId  
 UPDATE I SET I.CurMSales = C.Sales      
 FROM #Institutions I (NOLOCK),      
 #CurrentSales C (NOLOCK)      
 WHERE I.CtgMainId = C.CtgMainId 
 UPDATE I SET I.L2MSales = C.Sales / 2      
 FROM #Institutions I (NOLOCK),      
 #L2MSales C (NOLOCK)      
 WHERE I.CtgMainId = C.CtgMainId      
 UPDATE I SET I.Outlet = C.Outlet      
 FROM #Institutions I (NOLOCK),      
 #NoOfOutlet C (NOLOCK)      
 WHERE I.CtgMainId = C.CtgMainId  
--Nagarajan on 28.Aug.2017      
 IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel1')      
 BEGIN      
  DROP TABLE RptDebitNoteTopSheet_Excel1       
 END       
 CREATE TABLE RptDebitNoteTopSheet_Excel1      
 (      
 [Scheme Description] VARCHAR(100),      
 [From] VARCHAR(10),      
 [To] VARCHAR(10),      
 [Circular No] VARCHAR(100),      
 [Date] NVARCHAR(10),      
 [Scheme Budget] NUMERIC(18,6),      
 [Sec Sales Qty] BIGINT,      
 [Sec Sales Value] NUMERIC(18,6),      
 [% Lib on Sec Sales] NUMERIC(18,6),      
 [Claim Amount] NUMERIC(18,6)      
 )         
 UPDATE #SchemeDebit SET Liab = (Amount / SecSalesVal) * 100 WHERE Liab > 0 
 SELECT S.SchDsc [Scheme Description],CONVERT(VARCHAR(10),S.SchValidFrom,103) [From],CONVERT(VARCHAR(10),S.SchValidTill,103) [To],ISNULL(S.CircularNo,'') [Circular No],      
  CONVERT(VARCHAR(10),S.CircularDate,103)  [Date],S.SchemeBudget [Scheme Budget],[SecSalesQty] [Sec Sales Qty],[SecSalesVal] [Sec Sales Value],CAST(Round(Liab,2) AS Numeric(18,2)) AS [% Liability on Sec Sales],      
  cast(round(Amount,2) as Numeric(18,2)) as  [Claim Amount],'A' As Dummy      
 INTO #RptDebitNoteTopSheet_Excel1      
 FROM #SchemeDebit S (NOLOCK) --WHERE Amount > 0       
 WHERE Amount <> 0 --- CRCRSTPAR0023  IF Difference of Claim Amt is Zero need not Shown --Changed as not equal to 
 IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel1) > 0      
 BEGIN      
  INSERT INTO #RptDebitNoteTopSheet_Excel1 ([Scheme Description],[Circular No],[Scheme Budget],[Sec Sales Qty],[Sec Sales Value],[Claim Amount],Dummy)  
  SELECT 'Total' [Scheme Description], '' AS [Circular No],0 AS [Scheme Budget],      
  SUM([Sec Sales Qty]) AS [Sec Sales Qty],SUM([Sec Sales Value]) AS [Sec Sales Value],SUM([Claim Amount]) [Claim Amount],'B' Dummy      
  FROM  #RptDebitNoteTopSheet_Excel1     
 END
 SELECT * INTO #Excel1 FROM #RptDebitNoteTopSheet_Excel1 ORDER BY Dummy 
 DECLARE @RecCount AS BIGINT      
 SELECT @RecCount = COUNT(7) FROM #RptDebitNoteTopSheet_Excel1 
 INSERT INTO RptDebitNoteTopSheet_Excel1      
 SELECT [Scheme Description],Cast(isnull([From],' ') As Varchar(10)) [From],Cast(isnull([To],' ') As Varchar(10)) [To],[Circular No],ISNULL([Date],' ') AS [Date] ,[Scheme Budget],      
 [Sec Sales Qty],[Sec Sales Value],[% Liability on Sec Sales] ,[Claim Amount]      
 FROM #Excel1 ORDER BY Dummy  
 IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel2')      
 BEGIN      
  DROP TABLE RptDebitNoteTopSheet_Excel2       
 END        
 CREATE TABLE RptDebitNoteTopSheet_Excel2      
 (      
  [Name Of the Category] NVARCHAR(200),      
  [From] VARCHAR(10),      
  [TO] VARCHAR(10),      
  [Circular No] VARCHAR(50),      
  [Monthly Target] NUMERIC(38,6),      
  [Last 2 Mont Avg Sal] NUMERIC(18,6),      
  [Current Month] NUMERIC(18,6),      
  [No of Incent Outlets] NUMERIC(18,0),      
  [Total Discount Amount] NUMERIC(38,6)      
 )
 SELECT CtgName [Name Of the Category],convert(varchar(10),FromDate,103) [From],convert(varchar(10),ToDate,103) [To],'' [Circular No],[Target] [Monthly Target],      
 L2MSales [Last 2 Months Avg Sales],CurMSales [Current Month],Outlet [No of Incentive Outlets],DiscAmount [Total Discount Amount],'A' Dummy      
 INTO #RptDebitNoteTopSheet_Excel2      
 FROM #Institutions (NOLOCK)   
 IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel2) > 0      
 BEGIN      
 ----------------- modified by lakshman M on 04/10/2017----------------          
  --INSERT INTO #RptDebitNoteTopSheet_Excel2          
  --SELECT 'Total' As [Name Of the Category],'' As [From],'' As [To],0 As [Circular No],0 As [Monthly Target],          
  --0 As [Last 2 Months Avg Sales],0 As [Current Month],0 As [No of Incentive Outlets],sum([Total Discount Amount]) [Total Discount Amount],'B' Dummy          
  --FROM #RptDebitNoteTopSheet_Excel2       
  Update A set [Name Of the Category]= null ,[From]=null,[To]=null,[Monthly Target]=null,[Last 2 Months Avg Sales]=null        
  ,[Current Month]=null,[No of Incentive Outlets]=null, [Total Discount Amount]=null,[Circular No]='' from #RptDebitNoteTopSheet_Excel2 A where Dummy ='B'        
    -------------------- Till here -----------------------------       
 END  
 SELECT * INTO #Excel2 FROM #RptDebitNoteTopSheet_Excel2 ORDER BY Dummy  
 INSERT INTO RptDebitNoteTopSheet_Excel2      
 SELECT [Name Of the Category],[From],[To],[Circular No],[Monthly Target],      
 [Last 2 Months Avg Sales],[Current Month],[No of Incentive Outlets],[Total Discount Amount]      
 FROM #Excel2   
 --------------- added by lakshman M Dated ON 20-08-2019 PMS ID: CRCRSTPAR0042  -------------------  
 IF(SELECT COUNT(*) FROM RptDebitNoteTopSheet_Excel2) > 0  
 BEGIN  
 INSERT INTO RptDebitNoteTopSheet_Excel2    
  SELECT 'Total' AS [Name Of the Category],' '[From],' '[To],' ' AS [Circular No],SUM([Monthly Target]) AS [Monthly Target],      
 SUM([Last 2 Months Avg Sales]) AS [Last 2 Months Avg Sales],SUM([Current Month]) AS [Current Month],SUM([No of Incentive Outlets])  AS [No of Incentive Outlets],SUM([Total Discount Amount]) AS [Total Discount Amount]  
 FROM #Excel2  
 END  
 ----------------------------------------------------TOT CLAIM Added By Mohana REPORT 4-------------------------------------------------------------------      
 DECLARE @RecCount1 INT      
 SELECT @RecCount1  = COUNT(*) FROM RptDebitNoteTopSheet_Excel2      
 CREATE Table #TotClaimFinal       
 (      
 CtgName  NVARCHAR(100),      
 Fromdate DATETIME,      
 Todate DATETIME,      
 NrmlRate NUMERIC (18,2),      
 SecSalesTot NUMERIC (18,2),      
 DiffClaims NUMERIC (18,2)       
 )  
 SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,
 CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,         
 B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue         
 INTO #BillingDetails1          
 FROM SalesInvoice S (NOLOCK)          
 INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId          
 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId       
 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1         
 WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3  
 SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,CASE SP.SplPriceId WHEN 0 THEN 0 ELSE SP.Priceid END As  Priceid,        
 B.DefaultPriceId ActualPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue        
 INTO #ReturnDetails1          
 FROM ReturnHeader S (NOLOCK)          
 INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID AND StockTypeid in (select stocktypeid from  stocktype where systemstocktype =1)         
 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId          
 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1      
 WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3
 SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName      
 INTO #Retailer      
 FROM Retailer R (NOLOCK),      
 RetailerValueClassMap RVCM (NOLOCK),      
 RetailerValueClass RVC (NOLOCK),      
 RetailerCategory RC (NOLOCK),      
 RetailerCategoryLevel RCL (NOLOCK)      
 WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId      
 AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
 SELECT tranid,Refid,Rtrid,CtgName,RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,SelRate,CAST(0 AS NUMERIC(18,2)) Nrmlrate,CAST(0 AS NUMERIC(18,2)) SplRate,CAST(0 AS NUMERIC(18,2)) Diff,Slno      
 INTO #TotClaim FROM(      
 SELECT 1 tranid,Salid Refid,A.Rtrid,CtgName,Salinvdate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno FROM #BillingDetails1 A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid       
 UNION       
 SELECT 2 Transid,ReturnID Refid,A.Rtrid,CtgName,ReturnDate RefDate,Prdid,Prdbatid,BaseQty,Priceid,ActualPriceid,PrdbatDetailvalue SelRate,Slno FROM #ReturnDetails1  A  INNER JOIN #Retailer B ON A.Rtrid = B.Rtrid       
 )A    
 SELECT DISTINCT Priceid,PrdBatDetailValue SplSelRate  INTO #ExistingSpecialPrice FROM      
 (      
 SELECT D.PriceId,D.PrdBatDetailValue       
 FROM #TotClaim M (NOLOCK),      
 ProductBatchDetails D (NOLOCK)       
 WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
 AND PriceCode LIKE '%-Spl Rate-%'         
 UNION       
 SELECT D.PriceId,D.PrdBatDetailValue       
 FROM #TotClaim M (NOLOCK),      
 ProductBatchDetails D (NOLOCK)       
 WHERE M.PriceId = D.PriceId AND D.SLNo = 3      
 AND PriceCode LIKE '%SplRate%'        
 )A 
  UPDATE A SET A.SplRate = (BaseQty*((B.SplselRate)+(B.SplselRate*(p.TaxPerc/100)))) FROM  #TotClaim A INNER JOIN #ExistingSpecialPrice B      
  ON A.Priceid = B.Priceid  
  INNER JOIN  ParleOutputtaxPercentage P ON A.Refid = p.salid and A.slno = p.prdslno AND A.Tranid=P.Transid      
  WHERE A.Priceid <>0  
  UPDATE A SET A.SplRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
   INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid      
  WHERE A.Priceid =0
  UPDATE A SET A.NrmlRate = (BaseQty*(( SelRate)+(SelRate*(P.TaxPerc/100)))) FROM  #TotClaim A       
  INNER JOIN  #ParleOutputtaxPercentage P ON A.Refid = p.salid and a.slno = p.prdslno AND A.Tranid=P.Transid 
  UPDATE A SET A.Diff = (NrmlRate-SplRate) FROM  #TotClaim A        
  INSERT INTO #TotClaimFinal(CtgName,NrmlRate,SecSalesTot,DiffClaims)      
  SELECT CtgName,SUM(NrmlRate),SUM(SplRate),SUM(Diff) FROM #TotClaim      
  GROUP BY Ctgname  
  UPDATE A SET Fromdate = B.Frmdt ,Todate = B.todt FROM #TotClaimFinal A  INNER JOIN (SELECT Ctgname,MIn(RefDate) Frmdt,Max(RefDate) todt FROM #TotClaim GROUP BY CtgName) B ON A.CtgName = B.Ctgname      
 IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel3')      
 BEGIN      
  DROP TABLE RptDebitNoteTopSheet_Excel3       
 END        
 CREATE TABLE RptDebitNoteTopSheet_Excel3      
 (      
  [Name Of the Category] NVARCHAR(200),      
  [From] VARCHAR(12),      
  [TO] VARCHAR(12),      
  [Total Normal Amount] NUMERIC(18,2),      
     [Total Normal Sec Sales AS Per TOT] NUMERIC(18,2),    ------------ column name altered by lakshman M Dated On 30-04-2019 PMS ID: ILCRSTPAR4224  
     [TOT Diff claims] NUMERIC(18,2)       
 ) 
  INSERT INTO RptDebitNoteTopSheet_Excel3      
  SELECT * FROM #TotClaimFinal WHERE DiffClaims > 0 --- CRCRSTPAR0023  IF Difference of Claim Amt is Zero need not Shown      
  ----------- added by lakshman M Dated ON 20-08-2019 PMS ID: CRCRSTPAR0042   
IF( SELECT COUNT(*) FROM RptDebitNoteTopSheet_Excel3)> 0  
BEGIN  
INSERT INTO RptDebitNoteTopSheet_Excel3   
SELECT 'Total' AS CtgName,' ' AS Fromdate,' ' AS Todate ,SUM(NrmlRate) AS NrmlRate, SUM(SecSalesTot) AS SecSalesTot ,sum(DiffClaims) AS DiffClaims from #TotClaimFinal WHERE DiffClaims > 0  
--UPDATE A SET [From] =' ' ,[TO] =' '  from RptDebitNoteTopSheet_Excel3 A WHERE [TOT Diff claims] > 0 AND [Name Of the Category] ='Total'  
END  
SET @RecCount = @RecCount + 1      
SET @RecCount1 = @RecCount1 +@RecCount + 1      
-- Till here      
 ----------------------------------------MANUAL CLAIM Added By Amuthakumar CRCRSTAPAR0023 ---------------------------------------------      
---------------- Added By Lakshman M Dated ON 07-12-2018 PMS ID: ILCRSTPAR2760 -----------       
 --SELECT MCD.DESCRIPTION,MCM.MacDate As [From], MCM.MacDate AS [To],MCM.MacRefNo,ProposedLibPercent,TotalSales,ActualLibPercent,ClaimAmt      
 --INTO #TotManualClaim      
 --FROM ManualClaimMaster MCM INNER JOIN ManualClaimDetails MCD ON MCM.MacRefNo = MCD.MacRefNo      
 --WHERE MacDate BETWEEN @FromDate AND @ToDate ------- commented by lakshman M on dated on 07-12-2018      
 --SELECT MCD.DESCRIPTION,A.MacDate As [From], A.MacDate AS [To],MCD.CircularNo,ProposedLibPercent,TotalSales,ActualLibPercent,ClaimAmt      
 --INTO #TotManualClaim from ManualClaimMaster A       
 --INNER JOIN ManualClaimDetails MCD ON A.MacRefNo = MCD.MacRefNo      
 --INNER JOIN  JCMonth B ON A.Jcmid = B.Jcmid AND A.FromJcmJcid = B.JcmJc AND A.ToJcmJcId = B.JcmJc       
 --WHERE Jcmsdt  between @FromDate   AND @ToDate AND JcmEdt between @FromDate   AND @ToDate  
 ------- commented by lakshman M on dated on 20-08-2019 PMS ID: ILCRSTPAR5536 ---------------  
 SELECT DISTINCT MCD.DESCRIPTION,ValidFromDate As [From],ValidToDate AS [To],MCD.CircularNo,ProposedLibPercent,TotalSales,ActualLibPercent,ClaimAmt      
 INTO #TotManualClaim 
 from ManualClaimMaster A       
 INNER JOIN ManualClaimDetails MCD ON A.MacRefNo = MCD.MacRefNo      
 INNER JOIN  JCMonth B ON A.Jcmid = B.Jcmid AND A.FromJcmJcid = B.JcmJc AND A.ToJcmJcId = B.JcmJc
 inner join  ManualClaimdescription D ON  D.CircularNo =MCD.CircularNo  
 WHERE Jcmsdt  between @FromDate   AND @ToDate AND JcmEdt between @FromDate   AND @ToDate 
 --AND D.ValidFromDate between @FromDate   AND @ToDate--ILCRSTPAR5812
 --AND D.ValidToDate  between @FromDate   AND @ToDate    --ILCRSTPAR5812
 AND @FromDate BETWEEN D.ValidFromDate AND D.ValidToDate --ILCRSTPAR5847  
 AND @ToDate BETWEEN D.ValidFromDate AND D.ValidToDate   --ILCRSTPAR5847 
 ----------------- Till Here -------------      
 IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel4')      
 BEGIN      
  DROP TABLE RptDebitNoteTopSheet_Excel4       
 END        
 CREATE TABLE RptDebitNoteTopSheet_Excel4      
 (      
  [Scheme Description] NVARCHAR(200),      
  [From] DATETIME,      
  [TO] DATETIME,      
  [Circular No] NVARCHAR(100),      
  [Scheme Budget] NUMERIC(18,2),      
  [Sec Sales Value] NUMERIC(18,2),      
  [% Lib on Sec Sales] NUMERIC(18,2),      
  [Claim Amount] NUMERIC(18,2)      
 )      
INSERT INTO RptDebitNoteTopSheet_Excel4      
SELECT * FROM #TotManualClaim  
----------- added by lakshman M Dated ON 20-08-2019 PMS ID: CRCRSTPAR0042   
IF (SELECT count(*) FROM RptDebitNoteTopSheet_Excel4) >0  
BEGIN  
INSERT INTO RptDebitNoteTopSheet_Excel4 ([Scheme Description],[Sec Sales Value],[Claim Amount])  
SELECT 'Total' AS [Scheme Description],ISNULL(SUM(TotalSales),0) AS [Sec Sales Value],ISNULL(SUM(ClaimAmt),0) AS [Claim Amount]   
FROM #TotManualClaim  
END   
  -----CRCRSTPAR0056
IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel5')      
BEGIN      
	DROP TABLE RptDebitNoteTopSheet_Excel5       
END  
	      
CREATE TABLE RptDebitNoteTopSheet_Excel5     
(      
[Dist. Incentive Ref. No.]	varchar(100),    
[No of Salesman] INT,    
[Total Sales Value] NUMERIC(18,2),       
[Incentive Amount] NUMERIC(18,2)      
) 
	 
INSERT INTO RptDebitNoteTopSheet_Excel5([Dist. Incentive Ref. No.],[No of Salesman],[Total Sales Value],[Incentive Amount])
SELECT A.DistIRefno,COUNT(SMID),SUM(C.AchSales) as TotalAchSales,SUM(C.IncAmount)
FROM DistributorIncentiveMaster A (NOLOCK)  
INNER JOIN DistributorIncentiveAchDetail C(NOLOCK) ON C.DistIRefno=A.DistIRefno 
--WHERE C.GeneratedOn BETWEEN @FromDate AND @ToDate  
WHERE A.IncFromDate BETWEEN @FromDate AND @ToDate OR A.IncToDate BETWEEN @FromDate AND @ToDate--ILCRSTPAR6283
--WHERE (A.IncFromDate BETWEEN @FromDate AND @ToDate OR A.IncToDate BETWEEN @FromDate AND @ToDate)
--Jcmsdt  between @FromDate   AND @ToDate AND JcmEdt between @FromDate   AND @ToDate   
GROUP BY A.DistIRefno
	
IF (SELECT COUNT(*) FROM RptDebitNoteTopSheet_Excel5) >0  
BEGIN  
	INSERT INTO RptDebitNoteTopSheet_Excel5 ([Dist. Incentive Ref. No.],[Total Sales Value],[Incentive Amount])  
	SELECT 'Total' AS [Dist. Incentive Ref. No.],ISNULL(SUM([Total Sales Value]),0) AS [Total Sales Value],ISNULL(SUM([Incentive Amount]),0) AS [Incentive Amount]   
	FROM RptDebitNoteTopSheet_Excel5  
END
	
----CRCRSTPAR0056
DECLARE @RecCount2 INT    
DECLARE @RecCountAct2 INT      
SELECT @RecCount2  = COUNT(*) FROM RptDebitNoteTopSheet_Excel3      
set @RecCount1 = @RecCount1+1      
SET @RecCount2 = @RecCount2 + @RecCount1 + 1      
-- Till Here CRCRSTAPAR0023  
--**************************************************************SALESMAN INCENTIVE ILCRSTPAR5199 ********************************************************************
IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel6')      
BEGIN      
	DROP TABLE RptDebitNoteTopSheet_Excel6     
END 
    					 
CREATE TABLE RptDebitNoteTopSheet_Excel6
(
	SMIRefNo VARCHAR(100),
	IncMonth VARCHAR(50),
	IncYear   INT,
	SMName	  VARCHAR(100),
	[TotalAchSales] Numeric(18,6),
	[From Range] Numeric(18,4),
	[To Range] Numeric(18,4),
	FixedPay Numeric(18,6),
	VariablePay Numeric(18,6),
	IncPerc Numeric(18,6),
	IncAmount Numeric(18,6),
	[Total Incentive Amount] Numeric(18,6)
)
	DECLARE @Month1 VARCHAR(100)
	DECLARE @Year1 INT
	SET @Month1=DATENAME(MM, @FromDate)
	SET @Year1=YEAR(@ToDate)
	INSERT INTO  RptDebitNoteTopSheet_Excel6(SMIRefNo,IncMonth,IncYear,SMName,[From Range],[To Range],[TotalAchSales],FixedPay,VariablePay,IncPerc,IncAmount,[Total Incentive Amount])
	SELECT S.SMIRefNo,S.IncMonth,S.IncYear,SMName,[FromRange],[ToRange],AchSales,FixedPay,VariablePay,IncPerc,IncAmount,TotalIncAmount 
	FROM SalesManIncentiveMaster S INNER JOIN SalesManincentiveDetail SD
	ON S.SMIRefno = SD.SMIRefno 
	INNER JOIN SalesmanIncentiveSlabs SS ON SS.SMIRefno = S.SMIRefno AND SD.SMIRefno=SS.SMIRefno AND SD.AchSlab = SS.Slab 
	INNER JOIN SalesMan A ON SD.SMid = A.SMId 
	WHERE  SMCODE NOT IN('SMDUMMY01') AND S.IncMonth =@Month1 AND S.Incyear =@Year1   AND SMIrefStatus=1
IF (SELECT count(*) FROM RptDebitNoteTopSheet_Excel6) >0  
BEGIN  
INSERT INTO RptDebitNoteTopSheet_Excel6 (SMiREfno,TotalAchSales,[Total Incentive Amount])  
	SELECT 'Total' AS SMiREfno,ISNULL(SUM(TotalAchSales),0) AS TotalAchSales,ISNULL(SUM([Total Incentive Amount]),0) AS [Total Incentive Amount]   
	FROM RptDebitNoteTopSheet_Excel6   
END 
 DECLARE @RecCount3 INT      
 SELECT @RecCount3  = COUNT(*) FROM RptDebitNoteTopSheet_Excel6
 SELECT @RecCount3  = @RecCount2+ @RecCount3  + 1  
  -------------- Added by lakshmn M Dated ON 25-04-2019 PMS ID: ILCRSTPAR4201  --------------  
truncate table RptDebitNoteTopSheet_Excel_GrandTotal  
INSERT INTO RptDebitNoteTopSheet_Excel_GrandTotal   
--SELECT 'GRAND TOTAL','','','',0,0,SUM([Claim Amount]) [Claim Amount],SUM([TOT Diff claims]) [TOT Diff claims],SUM([Total disc Amount]) [Total disc Amount],SUM([claim amount1]) [claim amount1]  
SELECT 'GRAND TOTAL','','','','','','','','',SUM([Claim Amount]) +SUM([TOT Diff claims]) +SUM([Total discount Amount]) +SUM([claim amount1]) [claim amount1]  
FROM (  
SELECT 0 [Claim Amount],0 [TOT Diff claims],0 [Total discount Amount],[claim amount] [claim amount1] FROM RptDebitNoteTopSheet_Excel1  WHERE [Scheme Description] ='Total'  
UNION ALL   
SELECT 0,0, [Total discount Amount],0 FROM RptDebitNoteTopSheet_Excel2 WHERE [Name Of the Category] ='Total'  
UNION ALL   
SELECT 0,[TOT Diff claims],0,0 FROM RptDebitNoteTopSheet_Excel3 WHERE [Name Of the Category] = 'Total'  
UNION ALL   
SELECT  [Claim Amount],0,0,0 FROM RptDebitNoteTopSheet_Excel4 WHERE [SCHEMe description] ='Total' 
UNION ALL   
SELECT  [Incentive Amount],0,0,0 FROM RptDebitNoteTopSheet_Excel5 WHERE [Dist. Incentive Ref. No.] ='Total' 
UNION ALL   
SELECT  [Total Incentive Amount] ,0,0,0 FROM RptDebitNoteTopSheet_Excel6 WHERE SMIREFNO ='Total'     
)A  
 DECLARE @RecCount4 INT      
 SELECT @RecCount4  = COUNT(*) FROM RptDebitNoteTopSheet_Excel5 
 SELECT @RecCount4  = @RecCount3+ @RecCount4  + 1    
---------- till here ------------------  
 TRUNCATE TABLE RptExcelDebitNote        
 INSERT INTO RptExcelDebitNote(Row,Col,MergeCells,Value)      
 SELECT 1,1,'A1:J1','PARLE - DEBIT NOTE / CREDIT NOTE'      
 UNION ALL      
 SELECT 2,1,'A2:J2',''   --ICRSTPAR6933 (Row Number Changed OlRowNo+1)      
 UNION ALL      
 SELECT 3,1,'A3:H3','Name of the Town : ' + ISNULL(@CityName,'')      
 UNION ALL      
 SELECT 3,9,'I3:J3','Passed by SO / SE :'      
 UNION ALL      
 SELECT 4,1,'A4:F4','Name of the Wholesaler : ' + ISNULL(@DistributorName,'')      
 UNION ALL      
 SELECT 4,7,'G4:H4','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)      
 UNION ALL      
 SELECT 4,9,'I4:J4','Verified by ASM :'      
 UNION ALL      
 SELECT 5,1,'A5:F5','Wholesaler Code : ' + ISNULL(@DistributorCode,'')      
 UNION ALL      
 SELECT 5,7,'G5:H5','Credit Note No :'      
 UNION ALL      
 SELECT 5,9,'I5:J5','Authorized by DSM :'    
 UNION ALL      
 SELECT 6,1,'A6:F6','Name of the Division :'      
 UNION ALL      
 SELECT 6,7,'G6:H6','Credit Note Date :'      
 UNION ALL      
 SELECT 6,9,'I6:J6','Value of Approved credit note :'      
 UNION ALL      
 SELECT 7,1,'A7:J7',''      
 UNION ALL       
 SELECT 8,1,'A8:J8','1.SAMPLING'      
 UNION ALL      
 SELECT 9,1,'A9:E9','DSM Sanction Letter Date '      
 UNION ALL      
 SELECT 9,6,'F9:J9','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30))      
 UNION ALL      
 SELECT 10,1,'A10:D10','Product Sampled during the period  '      
 UNION ALL      
 SELECT 10,5,'E10:G10','From : ' + CONVERT(VARCHAR(11),@FromDate,105)      
 UNION ALL      
 SELECT 10,8,'H10:J10','To : ' + CONVERT(VARCHAR(11),@ToDate,105)      
 UNION ALL      
 SELECT 11,1,'A11:J11',''       
 UNION ALL      
 SELECT 12,1,'A12:J12','2.TRADE SCHEME'       
 UNION ALL      
 SELECT 13,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel1'      
 UNION ALL      
 SELECT 14,1,'A14','1R'       
 UNION ALL      
 SELECT 14 + @RecCount + 1,1,'A' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) + ':J' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) ,'3.INSTITUTIONAL SALES'       
 UNION ALL      
 SELECT 14 + @RecCount + 2,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel2'      
 UNION ALL      
 SELECT 14 + @RecCount + 3,1,'A' + CAST(14 + @RecCount + 3 AS VARCHAR(10)),'2R'      
 UNION ALL      
 SELECT 14 + @RecCount,1,'A' + CAST(14 + @RecCount AS VARCHAR(10)) + ':' + 'J' + CAST(14 + @RecCount AS VARCHAR(10)),''       
 UNION ALL--Added By Mohana      
 SELECT 15,1,'A15','1R'      
 UNION ALL      
 SELECT 15 + @RecCount1 + 2,1,'A' + CAST(15 + @RecCount1 + 2 AS VARCHAR(10)) + ':J' + CAST(15 + @RecCount1 + 2 AS VARCHAR(10)) ,'4.TOT DIFF CLAIMS'       
 UNION ALL      
  SELECT 15 + @RecCount1 + 4,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel3'      
  UNION ALL      
  SELECT 15 + @RecCount1 + 6,1,'A' + CAST(15 + @RecCount1 + 6 AS VARCHAR(10)),'3R'      
 UNION ALL      
 SELECT 15 + @RecCount1+5,1,'A' + CAST(15 + @RecCount1+5 AS VARCHAR(10)) + ':' + 'J' + CAST(15 + @RecCount1+5 AS VARCHAR(10)),''       
 UNION ALL--Till Here      
 --Added By Amuthakumar  CRCRSTAPAR0023      
 SELECT 16,1,'A14','1R'      
 UNION ALL      
 SELECT 16 + @RecCount2 + 9,1,'A' + CAST(16 + @RecCount2 + 9 AS VARCHAR(10)) + ':J' + CAST(16 + @RecCount2 + 9 AS VARCHAR(10)) ,'5.MANUAL CLAIM'       
 UNION ALL      
  SELECT 16 + @RecCount2 + 11,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel4'      
  UNION ALL      
  SELECT 16 + @RecCount2 + 13,1,'A' + CAST(16 + @RecCount2 + 13 AS VARCHAR(10)),'4R'      
 UNION ALL      
 SELECT 16 + @RecCount2 + 12,1,'A' + CAST(16 + @RecCount2+12 AS VARCHAR(10)) + ':' + 'J' + CAST(16 + @RecCount2+12 AS VARCHAR(10)),''     
 UNION ALL          
  SELECT 17 + @RecCount3 + 15,1,'A' + CAST(16 + @RecCount3 + 13 AS VARCHAR(10)),'5R' -------------- Added by lakshmn M Dated ON 25-04-2019 PMS ID: ILCRSTPAR4201  --------------  
  UNION ALL      
  SELECT 18 + @RecCount2 + 11,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel6' 
  UNION ALL          
  SELECT 17 + @RecCount3 + 15,1,'A' + CAST(16 + @RecCount3 + 13 AS VARCHAR(10)),'6R' -------------- Added by lakshmn M Dated ON 25-04-2019 PMS ID: ILCRSTPAR4201  --------------  
  UNION ALL      
  SELECT 18 + @RecCount2 + 11,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel5' 
 -- UNION ALL  
 --SELECT 17 + '@RecCount3 + 15, C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel_GrandTotal'        
 UNION ALL--Till Here  CRCRSTAPAR0023      
 SELECT 0,10,'B15','ColumnWidth'        
 UNION ALL      
 SELECT 0,10,'C14','ColumnWidth'       
 UNION ALL      
 SELECT 1,1,'-4108','HorizontalAlignment'      
 UNION ALL      
 SELECT 2,25,'2:6','RowHeight' --ICRSTPAR6933      
 RETURN       
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Validate_InstitutionsTargetSetting' AND TYPE ='P')
DROP PROCEDURE Proc_Validate_InstitutionsTargetSetting
GO
/*
BEGIN TRAN
--SELECT * FROM InsTargetHD (NOLOCK)
EXEC Proc_Validate_InstitutionsTargetSetting 0
SELECT * FROM InsTargetHD (NOLOCK)
select * from Cn2Cs_Prk_InstitutionsTargetSetting
ROLLBACK TRAN
*/  
CREATE PROCEDURE Proc_Validate_InstitutionsTargetSetting  
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*****************************************************************************************************************************************************************  
* PROCEDURE : Proc_Validate_InstitutionsTargetSetting 0  
* PURPOSE : To Validate Proc_Validate_InstitutionsTargetSetting and move to main  
* CREATED : Aravindh Deva C  
* CREATED DATE : 20/05/2016  
* MODIFIED   
' Version       Date        Person           User Story ID    CR/BZ          Remarks               Code Review By   Review Date
' 436           15/05/2018  S.MOORTHI        CRCRSTPAR0004    CR			 Target Resetting 
' 432           04/11/2019  M.Lakshman       ILCRSTPAR6556    SR             while download target setting program code year,month and retailer wise status validation included.  
*******************************************************************************************************************************************************************/   
BEGIN  
 SET @Po_ErrNo=0  
 BEGIN TRY    
   DELETE PRK FROM Cn2Cs_Prk_InstitutionsTargetSetting PRK (NOLOCK) WHERE DownloadFlag='Y'  
   SELECT DISTINCT * INTO #Cn2Cs_Prk_InstitutionsTargetSetting FROM Cn2Cs_Prk_InstitutionsTargetSetting (NOLOCK) WHERE DownloadFlag='D'  
   IF NOT EXISTS (SELECT * FROM #Cn2Cs_Prk_InstitutionsTargetSetting (NOLOCK)) RETURN  
   CREATE TABLE #InsToAvoid  
   (  
    ProgramCode VARCHAR(50),  
    SlNo INT,  
    TableName NVARCHAR (200),  
    FieldName NVARCHAR (200),  
    ErrDesc NVARCHAR (1000)  
   )  
   SELECT DISTINCT C.CtgCode,R.CmpRtrCode,C.CtgMainId,R.RtrId  
   INTO #CSCtgCode  
   FROM RetailerCategory C (NOLOCK)  
   INNER JOIN RetailerValueClass V (NOLOCK) ON C.CtgMainId = V.CtgMainId  
   INNER JOIN RetailerValueClassMap M (NOLOCK) ON V.RtrClassId = M.RtrValueClassId  
   INNER JOIN Retailer R (NOLOCK) ON M.RtrId = R.RtrId  
   INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,1,'Cn2Cs_Prk_InstitutionsTargetSetting','ProgramCode','The program code is already existing ' +   
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting Prk (NOLOCK)   
   WHERE EXISTS (SELECT 'C' FROM InsTargetHD C (NOLOCK) WHERE Prk.ProgramCode = C.InsRefNo)  
   INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,2,'Cn2Cs_Prk_InstitutionsTargetSetting','CtgCode','Retailer / Category / Retailer and Category mapping is not valid for Program ' +   
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting Prk (NOLOCK) WHERE NOT EXISTS  
   (SELECT * FROM #CSCtgCode C (NOLOCK) WHERE Prk.RtrGroup = C.CtgCode AND Prk.CmpRtrCode = C.CmpRtrCode)  
   INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,3,'Cn2Cs_Prk_InstitutionsTargetSetting','ProgramCode','No values should be NULL for the Program ' +  
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting   
   WHERE (FromProgramYear) IS NULL  Or (ToProgramYear) IS NULL  
   OR (RtrGroup + CmpRtrCode) IS NULL  
   OR (AVGSales + TargetAmount + EffFromMonthId) IS NULL  
   INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,4,'Cn2Cs_Prk_InstitutionsTargetSetting','TargetAmount','TargetAmount field should not be Zero Or NULL' +  
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting   
   WHERE ISNULL(TargetAmount,0) = 0  
      INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,5,'Cn2Cs_Prk_InstitutionsTargetSetting','EffFromMonthId','EffFromMonthId field should not be Zero Or NULL' +  
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting   
   WHERE ISNULL(EffFromMonthId,0) = 0  
   INSERT INTO #InsToAvoid (ProgramCode,SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT ProgramCode,6,'Cn2Cs_Prk_InstitutionsTargetSetting','EffToMonthId','EffToMonthId field should not be Zero Or NULL' +  
   ProgramCode FROM #Cn2Cs_Prk_InstitutionsTargetSetting   
   WHERE ISNULL(EffToMonthId,0) = 0  
   INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
   SELECT DISTINCT SlNo,TableName,FieldName,ErrDesc FROM #InsToAvoid (NOLOCK)  
   DELETE P FROM #Cn2Cs_Prk_InstitutionsTargetSetting P  
   WHERE EXISTS (SELECT 'C' FROM #InsToAvoid A (NOLOCK) WHERE P.ProgramCode = A.ProgramCode)  
   DECLARE @CurrValue AS INT  
   SELECT @CurrValue = CurrValue FROM Counters  (NOLOCK)   
   WHERE TabName='InsTargetHD' AND FldName='InsId'  
   ----CRCRSTPAR0004
   ----------Added by lakshman M dated ON 04/11/2019 PMS ID: ILCRSTPAR6556 -------------
	UPDATE B SET B.[Status]=0 FROM #Cn2Cs_Prk_InstitutionsTargetSetting A 
	INNER JOIN InsTargetHD B ON A.FromProgramYear=B.TargetYear and A.EffFromMonthId=B.TargetMonth
	INNER JOIN InsTargetdetails C ON C.insid =B.insid AND C.CmpRtrCode = A.CmpRtrCode
	WHERE CAST(CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(targetmonth AS VARCHAR(2))+ '-01'  AS DATETIME)>=
	(SELECT JcmSdt FROM JCMonth WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN JcmSdt AND JcmEdt)
	
	DELETE A FROM #Cn2Cs_Prk_InstitutionsTargetSetting A  
	INNER JOIN InsTargetHD B ON A.FromProgramYear=B.TargetYear and A.EffFromMonthId=B.TargetMonth
	INNER JOIN InsTargetdetails C ON C.insid =B.insid AND C.CmpRtrCode = A.CmpRtrCode
	WHERE CAST(CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(targetmonth AS VARCHAR(2))+ '-01'  AS DATETIME)<
	(SELECT JcmSdt FROM JCMonth WHERE CONVERT(VARCHAR(10),GETDATE(),121) BETWEEN JcmSdt AND JcmEdt)
	---------------- Till here ------------------------------
    --CRCRSTPAR0004
   --Header  
   INSERT INTO InsTargetHD (InsId,InsRefNo,TargetDate,TargetMonth,TargetYear,[Status],Confirm,Upload,Availability,  
   LastModBy,LastModDate,AuthId,AuthDate,EffFromMonthId,EffToMonthId,ToTargetYear)  
   SELECT ROW_NUMBER() OVER(ORDER BY ProgramCode) + @CurrValue InsId,  
   ProgramCode InsRefNo,GETDATE() TargetDate,EffFromMonthId [TargetMonth],FromProgramYear [TargetYear],1 [Status],0 Confirm,0 Upload,  
   1 Availability,1 LastModBy,GETDATE() LastModDate,1 AuthId,MAX(CreatedDate) AuthDate,EffFromMonthId,EffToMonthId,ToProgramYear [ToTargetYear]     
   FROM #Cn2Cs_Prk_InstitutionsTargetSetting   
   GROUP BY ProgramCode,[FromProgramYear],EffFromMonthId,EffToMonthId,ToProgramYear  
   --Retailer Details  
   --INSERT INTO InsTargetDetails (InsId,RtrCtgMainId,RtrId,AvgSal,[Target],Achievement,BaseAch,TargetAch,  
   --ValBaseAch,ValTargetAch,ClmAmount,Liability,Availability,LastModBy,LastModDate,AuthId,AuthDate,  
   --RtrUniqueCode,CmpRtrCode,AchDownloadDate,MonthName,RtrGroup)  
   --SELECT DISTINCT H.InsId,C.CtgMainId,C.RtrId,P.AVGSales,P.[TargetAmount],  
   --0 Achievement,0 BaseAch,0 TargetAch,0 ValBaseAch,0 ValTargetAch,0 ClmAmount,0 Liability,  
   --1 Availability,1 LastModBy,GETDATE() LastModDate,1 AuthId,CreatedDate AuthDate,  
   --P.RtrUniqueCode,P.CmpRtrCode,'1900-01-01','',P.RtrGroup     
   --FROM #Cn2Cs_Prk_InstitutionsTargetSetting P (NOLOCK)  
   --INNER JOIN InsTargetHD H (NOLOCK) ON P.ProgramCode = H.InsRefNo  
   --INNER JOIN #CSCtgCode C (NOLOCK) ON P.RtrGroup = C.CtgCode AND P.CmpRtrCode = C.CmpRtrCode  
   --ORDER BY InsId,C.CtgMainId,C.RtrId  
   INSERT INTO InsTargetDetails (InsId,RtrCtgMainId,RtrId,AvgSal,[Target],Achievement,BaseAch,TargetAch,  
   ValBaseAch,ValTargetAch,ClmAmount,Liability,Availability,LastModBy,LastModDate,AuthId,AuthDate,  
   RtrUniqueCode,CmpRtrCode)  
   SELECT DISTINCT H.InsId,C.CtgMainId,C.RtrId,P.AVGSales,P.[TargetAmount],  
   0 Achievement,0 BaseAch,0 TargetAch,0 ValBaseAch,0 ValTargetAch,0 ClmAmount,0 Liability,  
   1 Availability,1 LastModBy,GETDATE() LastModDate,1 AuthId,CreatedDate AuthDate,  
   P.RtrUniqueCode,P.CmpRtrCode    
   FROM #Cn2Cs_Prk_InstitutionsTargetSetting P (NOLOCK)  
   INNER JOIN InsTargetHD H (NOLOCK) ON P.ProgramCode = H.InsRefNo and P.EffFromMonthId=H.EffFromMonthId  
   AND P.FromProgramYear=H.TargetYear  
   INNER JOIN #CSCtgCode C (NOLOCK) ON P.RtrGroup = C.CtgCode AND P.CmpRtrCode = C.CmpRtrCode  
   ORDER BY InsId,C.CtgMainId,C.RtrId  
   
   UPDATE C SET C.CurrValue = (SELECT ISNULL(MAX(InsId),0) FROM InsTargetHD (NOLOCK))  
   FROM Counters C (NOLOCK)  
   WHERE TabName='InsTargetHD' AND FldName='InsId'  
   UPDATE P SET P.DownloadFlag='Y'  
   FROM Cn2Cs_Prk_InstitutionsTargetSetting P (NOLOCK),  
   #Cn2Cs_Prk_InstitutionsTargetSetting HP,  
   InsTargetHD H (NOLOCK) WHERE P.ProgramCode = HP.ProgramCode AND P.ProgramCode = H.InsRefNo  

 END TRY  
 BEGIN CATCH  
  PRINT 'There is a problem in process!'  
  SET @Po_ErrNo=1 -- 1 will rollback the process through Sync EXE  
  RETURN  
 END CATCH    
RETURN  
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE Name = 'Cn2Cs_Prk_BLPurchaseReceipt_Trace' AND type ='U')
BEGIN
CREATE TABLE Cn2Cs_Prk_BLPurchaseReceipt_Trace (
	[DistCode] [varchar](50) NULL,
	[CompInvNo] [varchar](25) NULL,
	[CompInvDate] [datetime] NULL,
	[NetValue] [numeric](18, 2) NULL,
	[TotalTax] [numeric](18, 2) NULL,
	[LessDiscount] [numeric](18, 2) NULL,
	[LessSchemeAmount] [numeric](18, 2) NULL,
	[SupplierCode] [varchar](50) NULL,
	[CompanyName] [varchar](100) NULL,
	[TransporterName] [varchar](50) NULL,
	[LRNO] [varchar](15) NULL,
	[LRDate] [datetime] NULL,
	[WayBillNo] [varchar](50) NULL,
	[ProductCode] [varchar](100) NULL,
	[UOMCode] [varchar](25) NULL,
	[PurQty] [int] NULL,
	[CashDiscRs] [numeric](18, 2) NULL,
	[CashDiscPer] [numeric](18, 2) NULL,
	[LineLevelAmount] [numeric](18, 2) NULL,
	[BatchNo] [varchar](200) NULL,
	[ManufactureDate] [datetime] NULL,
	[ExpiryDate] [datetime] NULL,
	[MRP] [numeric](18, 2) NULL,
	[ListPriceNSP] [numeric](18, 2) NULL,
	[PurchaseTaxValue] [numeric](18, 2) NULL,
	[PurchaseDiscount] [numeric](18, 2) NULL,
	[PurchaseRate] [numeric](18, 2) NULL,
	[SellingRate] [numeric](18, 2) NULL,
	[SellingRateAfterTAX] [numeric](18, 2) NULL,
	[SellingRateAfterVAT] [numeric](18, 2) NULL,
	[FreightCharges] [numeric](18, 2) NULL,
	[VatBatch] [int] NULL,
	[VATTaxValue] [numeric](18, 2) NULL,
	[Status] [int] NULL,
	[FreeSchemeFlag] [varchar](5) NULL,
	[SchemeRefrNo] [varchar](25) NULL,
	[BundleDeal] [varchar](50) NULL,
	[CreatedDate] [datetime] NULL,
	[DownloadFlag] [varchar](1) NULL,
	[TaxType] [varchar](10) NULL,
	[PurDownloadedDate] [datetime]
)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_PurchaseReceipt' AND TYPE ='P')
DROP Procedure Proc_Cn2Cs_PurchaseReceipt
GO
/*    
BEGIN TRANSACTION   
EXEC Proc_Cn2Cs_PurchaseReceipt 0 
select *from ETLTempPurchaseReceipt --WHERE DownLoadStatus=0
select *from etltemppurchasereceiptproduct where cmpinvno in(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=0)
SELECT * FROM ETLTempPurchaseReceiptClaimScheme 
ROLLBACK TRANSACTION    
*/    
CREATE PROCEDURE Proc_Cn2Cs_PurchaseReceipt
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/***********************************************************    
* PROCEDURE : Proc_Cn2Cs_PurchaseReceipt    
* PURPOSE : To Insert the records FROM Console into Temp Tables    
* SCREEN : Console Integration-PurchaseReceipt    
* CREATED BY: Nandakumar R.G On 03-05-2010    
* MODIFIED :    
* DATE      AUTHOR     DESCRIPTION    
14/08/2013 Murugan.R Logistic Material Management    
* {date} {developer}  {brief modIFication description}    
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
29-09-2018  Lakshman M	 SR     ILCRSTPAR2251         Purchase backup date validation included from CS As per request 5 days configuration .
04-10-2018  lakshman M   BZ     ILCRSTPAR2285         purchase downloaded status validation added from CS.
28-01-2019  Lakshman M	 SR     ILCRSTPAR3256         Purchase backup date validation increased from CS As per request 10 days configuration .
05-03-2019  Lakshman M	 SR     ILCRSTPAR3638         Purchase backup date validation decreased from CS As per request 7 days only configuration.
19-10-2019  Lakshman M   SR     ILCRSTPAR6350         Purchase process trace validation included for one month date Range current month less than 30 days.
***************************************************************************************************/  
SET NOCOUNT ON    
BEGIN    
 -- For Clearing the Prking/Temp Table -----     
 ---------------->  Added by Lakshman M on 29/09/2018  <-------------------
 DECLARE @FROMDATE AS Datetime
 DECLARE @TodayDt AS datetime
 SELECT @FROMDATE = cast(DATEADD(DAY, -7, GETDATE()) AS DATETIME)
 SELECT @FROMDATE=CONVERT(VARCHAR(11), @FROMDATE, 121)
 SELECT @TodayDt= CAST(convert(varchar,getdate()) AS DATETIME)
 SELECT @TodayDt= CONVERT(VARCHAR(11), @TodayDt, 121)
 SELECT * INTO #ETLTempPurchaseReceipt_temp FROM ETLTempPurchaseReceipt WHERE InvDate between CONVERT(VARCHAR(11), @FROMDATE, 121) and CONVERT(VARCHAR(11), @TodayDt, 121)
 UPDATE A SET A.downloadstatus = 0 FROM ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp B ON A.CmpInvNo =B.CmpInvNo
 UPDATE A SET A.downloadstatus = 1 from ETLTempPurchaseReceipt A where CmpInvNo in(select CmpInvNo from PurchaseReceipt)   ---> added By Lakshman M PMS ID: ILCRSTPAR2285 
 SELECT * INTO #ETLTempPurchaseReceipt_temp1 FROM ETLTempPurchaseReceipt WHERE InvDate < CONVERT(VARCHAR(11),@FROMDATE, 121)
 Delete A from ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo  
 Delete A from ETLTempPurchaseReceiptproduct A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
 Delete A from ETLTempPurchaseReceiptClaimScheme A INNER JOIN #ETLTempPurchaseReceipt_temp1 B ON A.CmpInvNo =B.CmpInvNo
 Delete A from ETLTempPurchaseReceiptClaimScheme A where A.CmpInvNo not in(select B.CmpInvNo from #ETLTempPurchaseReceipt_temp1 B)
 ----------------- Added by lakshman M Dated ON dated ON 19-10-2019 PMS ID: ILCRSTPAR6350 

INSERT INTO Cn2Cs_Prk_BLPurchaseReceipt_Trace(
DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,PurDownloadedDate )
SELECT DistCode,CompInvNo,CompInvDate,NetValue,TotalTax,LessDiscount,LessSchemeAmount,SupplierCode,CompanyName,TransporterName,LRNO,LRDate,WayBillNo,ProductCode,UOMCode,
PurQty,CashDiscRs,CashDiscPer,LineLevelAmount,BatchNo,ManufactureDate,ExpiryDate,MRP,ListPriceNSP,PurchaseTaxValue,PurchaseDiscount,PurchaseRate,SellingRate,SellingRateAfterTAX,
SellingRateAfterVAT,FreightCharges,VatBatch,VATTaxValue,Status,FreeSchemeFlag,SchemeRefrNo,BundleDeal,CreatedDate,DownloadFlag,TaxType,GETDATE() FROM Cn2Cs_Prk_BLPurchaseReceipt
DELETE FROM Cn2Cs_Prk_BLPurchaseReceipt_Trace where compinvdate <(cast(DATEADD(DAY, -30, GETDATE()) AS DATETIME))
---------------->  Till Here  <----------------------
 DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in     
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN     
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1    
 DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments WHERE CmpInvNo     
 IN (SELECT CmpInvNo FROM PurchaseReceipt WHERE Status = 1) AND DownloadStatus = 1    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim    
 TRUNCATE TABLE ETL_Prk_PurchaseReceipt    
 TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptCrDbAdjustments  
 --------------------------------------    
 DECLARE @ErrStatus INT    
 DECLARE @BatchNo   NVARCHAR(200)    
 DECLARE @ProductCode  NVARCHAR(100)    
 DECLARE @ListPrice   NUMERIC(38,6)    
 DECLARE @FreeSchemeFlag  NVARCHAR(5)    
 DECLARE @CompInvNo   NVARCHAR(25)    
 DECLARE @UOMCode   NVARCHAR(25)    
 DECLARE @Qty    INT    
 DECLARE @PurchaseDiscount NUMERIC(38,6)    
 DECLARE @VATTaxValue  NUMERIC(38,6)    
 DECLARE @SchemeRefrNo  NVARCHAR(25)    
 DECLARE @SupplierCode  NVARCHAR(30)    
 DECLARE @TransporterCode NVARCHAR(30)    
 DECLARE @POUOM    INT    
 DECLARE @RowId    INT    
 DECLARE @LineLvlAmt   NUMERIC(38,6)    
 DECLARE @QtyInKg   NUMERIC(38,6)    
 DECLARE @ExistCompInvNo  NVARCHAR(25)    
 DECLARE @FreightCharges  NUMERIC(38,6)    
 SET @RowId=1    
 --->Added By Nanda on 17/09/2009    
 IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')    
 AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)    
 BEGIN    
  DROP TABLE InvToAvoid     
 END    
 CREATE TABLE InvToAvoid    
 (    
  CmpInvNo NVARCHAR(50)    
 )    
 IF EXISTS (SELECT DISTINCT CompInvNo,SupplierCode FROM Cn2Cs_Prk_BLPurchaseReceipt  
 WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST'))  
 BEGIN  
  INSERT INTO InvToAvoid (CmpInvNo)  
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
  INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Purchase Receipt','Tax Type','Purchase Tax Type should be VAT or GST '+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
 END  
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Till Here        
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode+'~'+BatchNo    
 NOT IN    
 (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN    
  (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Till Here    
 END    
 --Supplier Credit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
        SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'CreditNoteSupplier','PostedRefNo','Supplier Credit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'      
 END    
 --Supplier Debit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
        SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'DebitNoteSupplier','PostedRefNo','Supplier Debit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'      
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvDate>GETDATE())     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvDate>GETDATE()    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo     
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE CompInvDate>GETDATE()    
 END    
--Commented and Added By Mohana.S PMS NO: DCRSTKAL0012    
 --IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 --WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))     
 --BEGIN    
 -- INSERT INTO InvToAvoid(CmpInvNo)    
 -- SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 -- INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
 -- SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 --END    
 IF EXISTS (SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
 FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId))    
 BEGIN    
   INSERT INTO InvToAvoid(CmpInvNo)    
   SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
   INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
   SELECT DISTINCT 1,'Purchase Receipt',PRODUCTCODE+'Product UOM','UOMCode:'+UOMCode+' is not available for Invoice:'+CompInvNo     
   FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode  NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
 END     
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK)))     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Supplier','Supplier:'+SupplierCode+' is not available for Invoice:'+CompInvNo    
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
 END     
 --->Till Here    
 -- Eliminated Duplicate records insertion on 02/03/2015  
 SET @ExistCompInvNo=0    
 DECLARE Cur_Purchase CURSOR    
 FOR    
 SELECT DISTINCT ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,    
 ISNULL(FreightCharges,0) AS FreightCharges    
 FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)    
 ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges    
 OPEN Cur_Purchase    
 FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
 @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
 @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges     
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
--  IF @ExistCompInvNo<>@CompInvNo    
--  BEGIN    
--   SET @ExistCompInvNo=@CompInvNo    
--   SET @RowId=2    
--  END    
  --To insert into ETL_Prk_PurchaseReceiptPrdDt    
  IF(@FreeSchemeFlag='0')    
  BEGIN    
   INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],    
   [PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges)    
   VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,    
   @PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)    
--   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
--   VALUES(@CompInvNo,@RowId,'E',@QtyInKg)    
  END    
  --To insert into ETL_Prk_PurchaseReceiptClaim    
  IF(@FreeSchemeFlag='1')    
  BEGIN    
   INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],    
   [Batch Code],[Qty],[Stock Type],[Amount],FreightAmt)    
   VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0,@FreightCharges)    
  END    
--  SET @RowId=@RowId+1    
  FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
  @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
  @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges    
 END    
 CLOSE Cur_Purchase    
 DEALLOCATE Cur_Purchase    
 --To insert into ETL_Prk_PurchaseReceipt    
 SELECT @TransporterCode=TransporterCode FROM Transporter    
 WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter WITH(NOLOCK))    
 IF @TransporterCode=''    
 BEGIN    
  INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter','Transporter not available')    
 END    
 INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],  
 [Invoice Date],[Transporter Code],[NetPayable Amount],[TaxType])  
 SELECT DISTINCT C.CmpCode,SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue,  
 P.TaxType  
 FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P  
 WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)  
 UPDATE A SET [TaxType]='VAT' FROM ETL_Prk_PurchaseReceipt A (NOLOCK)   
 INNER JOIN Cn2Cs_Prk_BLPurchaseReceipt B (NOLOCK) ON B.CompInvNo=A.[Company Invoice No]   
 AND A.[Supplier Code]=B.SupplierCode WHERE ISNULL(A.TaxType,'')=''  
 --Added By Sathishkumar Veeramani 2013/08/13    
 --INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)    
 --SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)    
 --WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 --Added by Sathishkumar Veeramani 2013/11/22    
 INSERT INTO ETL_Prk_PurchaseReceiptCrDbAdjustments([Company Invoice No],[Adjustment Type],[Ref No],[Amount])    
 SELECT DISTINCT CompInvNo,AdjType,RefNo,Amount FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WITH (NOLOCK)    
 WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT    
 IF @ErrStatus =0    
 BEGIN    
  EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT    
  IF @ErrStatus =0    
  BEGIN    
   EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT    
   IF @ErrStatus =0    
   BEGIN    
    EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT    
    IF @ErrStatus =0    
    BEGIN    
       EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT    
       IF @ErrStatus =0    
       BEGIN    
           EXEC Proc_Validate_PurchaseReceiptCrDbAdjustments @Po_ErrNo= @ErrStatus OUTPUT    
           IF @ErrStatus =0    
           BEGIN    
            SET @ErrStatus=@ErrStatus    
        END        
       END        
    END    
   END    
  END    
 END    
 --Proc_Validate_PurchaseReceiptCrDbAdjustments    
 --->Added By Nanda on 17/09/2009    
 DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN    
 (SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)    
 UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'    
 WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)    
 --->Till Here    
 SET @Po_ErrNo= @ErrStatus    
 RETURN    
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE name ='Proc_CN2Cs_RetailerMasterDownload_New' AND TYPE ='P')
DROP PROCEDURE Proc_CN2Cs_RetailerMasterDownload_New
GO
/*
BEGIN TRAN
delete from errorlog
exec Proc_CN2Cs_RetailerMasterDownload_New 0
--select * from CN2Cs_Prk_RetailerMasterDownload
select * from retailer -- where Rtrid >574
select * from errorlog
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_CN2Cs_RetailerMasterDownload_New
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : NG2Cs_Prk_RetailerMasterDownload  
* PURPOSE  : To Update RetailerMaster data.
* CREATED  : VENKAT. M PMS NO : ILCRSTCKL0147
* CREATED DATE : 25-01-2019  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* [DATE]      [DEVELOPER]         [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]
* 23/09/2019  Kishore R			  ILCRSTPAR5992		 SR		   Retailer Download From Console		
* 13/11/2019  M Lakshman          ILCRSTPAR6671      SR        Due to Phone no & TIN no blank and max length validation has been removed in CS. 
*********************************/  
SET NOCOUNT ON  
BEGIN  
 DECLARE @sSql   NVARCHAR(2000)  
 DECLARE @Taction    INT  
 DECLARE @ErrDesc    NVARCHAR(1000)  
 DECLARE @Tabname    NVARCHAR(50)  
 Declare @RtrCode  	varchar	(50) 
 Declare @RtrName  	varchar	(100) 
 Declare @RtrAddress1  	varchar	(100) 
 Declare @RtrAddress2  	varchar	(100)
 Declare @RtrAddress3  	varchar	(100) 
 Declare @CityName  	varchar	(100) 
 Declare @StateName  	varchar	(50)
 Declare @PostalCode  	varchar	(50) 
 Declare @RtrChannelCode  	varchar (50) 
 Declare @RtrGroupCode  	varchar (50) 
 Declare @RtrClassCode  	varchar	(50) 
 Declare @RtrKeyAcc  	varchar	(50) 
 Declare @RelationStatus 	nvarchar (100)
 Declare @ParentCode 	nvarchar (100)
 Declare @Status  	varchar	(50) 
 Declare @GeoLevel  	nvarchar	(100) 
 Declare @GeoLevelValue  	nvarchar	(200) 
 Declare @PhNumber  	varchar	(50) 
 Declare @ContactPerson  	varchar	(50)
 Declare @TinNumber  	varchar	(50) 
 Declare @TaxType  	varchar	(50) 
 Declare @RtrTaxGroup  	varchar	(50) 
 Declare @SalesRoute  	varchar	(50) 
 Declare @DeliveryRoute  	varchar	(50) 
 Declare @CashDisc  	numeric	(9, 2) 
 Declare @RtrCrLimit 	numeric	(18,2) 
 Declare @RtrCrDays  	int	 
 Declare @CSRtrType  	varchar	(50) 
 Declare @RegDate  	DateTime	 
 Declare @FrequencyMode  	varchar	(50) 
 Declare @Eligible  	int	       
 Declare @RetailerType  	varchar	(50) 
 Declare @Composition  	varchar	(50) 
 Declare @PANNumber  	varchar	(50) 
 Declare @GSTIN  	varchar	(50) 
 Declare @RelatedParty  	varchar	(50) 
 Declare @Latitude  	varchar	(50) 
	Declare @Longitude  	varchar	(50) 
	Declare @RtrUniqueCode  	varchar	(50)        
	Declare @Approved  	varchar	(50) 
	Declare @DownLoadFlag  	varchar	(10) 
	Declare @CreatedDate  	datetime	 
	Declare @RtrMobileNo  	varchar	(50) 
	DeClare @RtrCovMode as Int
	Declare @RtrDayOff as Int
	Declare @RtrTaxable as varchar(10)
	Declare @KeyAccId as Int
	   Declare @CtgClassMainId as Int
	   Declare @RtrClassId as Int
	   Declare @TaxGroupId as Int
	   Declare @RMID as Int
	   Declare @SRMID as Int	   
	   Declare @ApprovedId as Int
	   Declare @RTRFREQUENCYID as Int
	   Declare @CmpRtrCode as Varchar(50)
	   Declare @RtrId as Int
	   Declare @Pi_UserId as Int
	   Declare @DefultRMid as Int
	   Declare @DefultRMNAME as varchar(50)
	   DECLARE @GeoLevelId AS INT 
	   Declare @GeoMainId as Int	   
	   Declare @RelationStatusID as Int
	   Declare @RtrChildId as Int
	   Declare @RtrCashDiscPerc as numeric(18,2)
	   Declare @CoaId as Int
	   Declare @AcCode	as Nvarchar(100)
	   Declare @RtrType as varchar(50)
	   Declare @RtrTypeID as Int
	   Declare @RtrShipId as Int	   
	
 SET @Taction=0 
 SET @Po_ErrNo=0  
 SET @Tabname = 'CN2Cs_Prk_RetailerMasterDownload'  
 SET @Pi_UserId=1  
 SET @GeoLevelId = 0
 SET @RtrChildId = 0
 DELETE FROM CN2Cs_Prk_RetailerMasterDownload WHERE DOWNLOADFLAG='Y'
 DECLARE Cur_RetailerMasterDownload_New CURSOR  
 FOR SELECT DISTINCT ISNULL(RtrCode,''),ISNULL(RtrName,''),ISNULL(RtrAddress1,''),ISNULL(RtrAddress2,''),ISNULL(RtrAddress3,''),ISNULL(PostalCode,''),ISNULL(PhNumber,''),
 ISNULL(ContactPerson,''),ISNULL(RtrKeyAcc,''),1 AS RtrCovMode, ISNULL(RegDate,'1900-01-01'),0 AS RtrDayOff,ISNULL(Status,''),'Yes' as RtrTaxable,ISNULL(TaxType,''),
 ISNULL(TinNumber,''),ISNULL(GeoLevel,''),ISNULL(GeoLevelValue,''),ISNULL(DeliveryRoute,''),ISNULL(SalesRoute,''),
 ISNULL(CashDisc,0),ISNULL(RtrCrLimit,0),ISNULL(RtrCrDays,0)
 ,ISNULL(RtrTaxGroup,''),
 ISNULL(RtrMobileNo,''),ISNULL(FrequencyMode,''),ISNULL(RtrUniqueCode,''), ISNULL(Approved,''),ISNULL(RelationStatus,''),
 ISNULL(ParentCode,''),ISNULL(RtrGroupCode,''),ISNULL(RtrChannelCode,''),ISNULL(RtrClassCode,''),ISNULL(CSRtrType,''),
 ISNULL(Latitude,''),ISNULL(Longitude,''),ISNULL(StateName,''),ISNULL(RetailerType,''),ISNULL(Composition,''),
 ISNULL(PANNumber,''),ISNULL(GSTIN,''),ISNULL(RelatedParty,'')		
 FROM CN2Cs_Prk_RetailerMasterDownload WHERE [DownLoadFlag] ='D' -- and CSRtrType='Sub Stockist' 
 OPEN Cur_RetailerMasterDownload_New  
 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty
 WHILE @@FETCH_STATUS=0  
 BEGIN  
		SET @Po_ErrNo=0  
		SET @Taction=0 
		Delete from ETL_Prk_UdcDetails
					
		IF LTRIM(RTRIM(@RtrCode))<>''  
		BEGIN  
			IF EXISTS (SELECT '*' FROM Retailer WHERE RtrCode = @RtrCode )  
			BEGIN  
				SET @Taction=2  
			END  
			ELSE  
			BEGIN  
				SET @Taction=1  
			END  
		END  
		ELSE  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Code should not be empty '      
			INSERT INTO Errorlog VALUES (1,@Tabname,'RetailerCode',@ErrDesc)  
		END  
		IF LTRIM(RTRIM(@RtrName))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Name should not be empty'    
			INSERT INTO Errorlog VALUES (2,@Tabname,'RetailerName',@ErrDesc)  
		END
		IF LTRIM(RTRIM(@RtrAddress1))=''  
		BEGIN  
			SET @Po_ErrNo=1   
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Address  should not be empty'    
			INSERT INTO Errorlog VALUES (3,@Tabname,'Address',@ErrDesc)  
		END 		   
		--IF LTRIM(RTRIM(@PhNumber))=''
		--BEGIN
		--	SET @Po_ErrNo=1
		--	SET @Taction=0
		--	SET @ErrDesc = 'Ph Number should not be empty'		
		--	INSERT INTO Errorlog VALUES (4,@Tabname,'TINNumber',@ErrDesc)
		--END
		--ELSE
		--BEGIN
		--	IF LEN(@PhNumber)>12
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'Ph Number Maximum Length should be 12'		
		--		INSERT INTO Errorlog VALUES (5,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--END
		IF UPPER(LTRIM(RTRIM(@RtrKeyAcc)))=UPPER('Yes')  
		BEGIN  
			SET @KeyAccId=1   
		END 
		ELSE  
		BEGIN  
			SET	@KeyAccId=0
		END		
		IF UPPER(LTRIM(RTRIM(@Status)))=UPPER('ACTIVE')  
		--IF UPPER(LTRIM(RTRIM(@Status)))= 1  
		BEGIN  
			SET @Status=1   
		END  
		ELSE  
		BEGIN  
			SET @Status=0  
		END
		IF LTRIM(RTRIM(@TaxType))=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'TaxType should not be empty'		
			INSERT INTO Errorlog VALUES (6,@Tabname,'TaxType',@ErrDesc)
		END
		ELSE
		BEGIN
			IF LTRIM(RTRIM(@TaxType))='VAT' OR LTRIM(RTRIM(@TaxType))='NON VAT' OR LTRIM(RTRIM(@TaxType))='GST' 
			BEGIN
				IF @Po_ErrNo=0
				BEGIN
					SET @Po_ErrNo=0	
				END	
			END
			ELSE
			BEGIN
				SET @Po_ErrNo=1		
				SET @Taction=0
				SET @ErrDesc = 'TaxType Type '+@TaxType+ ' is not available'		
				INSERT INTO Errorlog VALUES (7,@Tabname,'TaxType',@ErrDesc)
			END
		END
		--IF @TaxType='VAT'
		--BEGIN
		--	IF LTRIM(RTRIM(@TINNumber))=''
		--	BEGIN
		--		SET @Po_ErrNo=1
		--		SET @Taction=0
		--		SET @ErrDesc = 'TIN Number should not be empty'		
		--		INSERT INTO Errorlog VALUES (8,@Tabname,'TINNumber',@ErrDesc)
		--	END
		--	ELSE
		--	BEGIN
		--		IF LEN(@TINNumber)>11
		--		BEGIN
		--			SET @Po_ErrNo=1
		--			SET @Taction=0
		--			SET @ErrDesc = 'TIN Number Maximum Length should be 11'		
		--			INSERT INTO Errorlog VALUES (9,@Tabname,'TINNumber',@ErrDesc)
		--		END
		--	END
		--END
		
		IF LTRIM(RTRIM(@RtrTaxGroup)) <> ''
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup)
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Retailer Tax Group Code ' + @RtrTaxGroup + ' is not available'  		
				INSERT INTO Errorlog VALUES (10,@Tabname,'TaxGroup',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxGroupId =TaxGroupId FROM TaxGroupSetting WHERE RtrGroup = @RtrTaxGroup
			END
		END
		IF NOT EXISTS  (SELECT '*' FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 )  
		BEGIN  
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Route Code ' + @DeliveryRoute + ' is not available'      
			INSERT INTO Errorlog VALUES (11,@Tabname,'DeliveryRoute',@ErrDesc)  
		END  
		ELSE  
		BEGIN    
			SELECT @RMId =RMId FROM RouteMaster WHERE RMCode = @DeliveryRoute AND RMSRouteType=2 
		END
		IF NOT EXISTS (SELECT '*' FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute)  
		BEGIN  
		   SET @ErrDesc = 'Route Code:'+@SalesRoute+'does not Mapped Salesman'  
		   INSERT INTO Errorlog VALUES (12,@TabName,'Route Code',@ErrDesc)  
		   SET @Po_ErrNo=1  
		   
		END  
		ELSE  
		BEGIN  
			SELECT @SRMID =B.Rmid  FROM SalesmanMarket A INNER JOIN Routemaster B ON A.Rmid =B.Rmid and RmsRouteType =1 WHERE RMCode=@SalesRoute    
		END 		
		IF LTRIM(RTRIM(@FrequencyMode))=''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Retailer Frequency  should not be empty'		
			INSERT INTO Errorlog VALUES (13,@Tabname,'Retailer Frequency',@ErrDesc)
		END		
		IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Bi-Weekly')  
		BEGIN  
			SET @RTRFREQUENCYID=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Fort Nightly')  
		BEGIN  
			SET @RTRFREQUENCYID=2  
		END 
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Monthly')  
		BEGIN  
			SET @RTRFREQUENCYID=3  
		END
		ELSE IF UPPER(LTRIM(RTRIM(@FrequencyMode)))=UPPER('Daily')  
		BEGIN  
			SET @RTRFREQUENCYID=4 
		END 
		IF ISNULL(@RtrUniqueCode,'')='' AND UPPER(ISNULL(@Approved,'PENDING'))='APPROVED'  
		BEGIN  
			SET @ErrDesc = 'Retailer Unique Code Mandatory for Approved retailers :'+@RtrCode  
			INSERT INTO Errorlog VALUES (14,@TabName,'Retailer Unique Code',@ErrDesc)  
			SET @Po_ErrNo=1  
		END 
		
		IF @Approved = ''
		BEGIN
			SET @Po_ErrNo=1	
			SET @Taction=0
			SET @ErrDesc = 'Approved  should not be empty'		
			INSERT INTO Errorlog VALUES (24,@Tabname,'Approved',@ErrDesc)		
		END
		ELSE
		IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('PENDING')  
		BEGIN  
			SET @ApprovedId=0   
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('APPROVED')  
		BEGIN  
			SET @ApprovedId=1  
		END  
		ELSE IF UPPER(LTRIM(RTRIM(@Approved)))=UPPER('REJECTED')  
		BEGIN  
			SET @ApprovedId=2  
		END
		
		IF LTRIM(RTRIM(@RtrCrLimit))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrLimit)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Limit value Should be Number'    
				INSERT INTO Errorlog VALUES (15,@Tabname,'CreditLimit',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCrDays))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCrDays)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Credit Days value Should be Number'    
				INSERT INTO Errorlog VALUES (16,@Tabname,'CreditDays',@ErrDesc)  
			END  
		END  
		IF LTRIM(RTRIM(@RtrCashDiscPerc))<>''  
		BEGIN  
			IF ISNUMERIC(@RtrCashDiscPerc)=0  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Cash Discount Percentage value Should be Number'    
				INSERT INTO Errorlog VALUES (17,@Tabname,'CashDiscountPercentage',@ErrDesc)  
			END  
		END  
		 
		IF NOT EXISTS  (SELECT '*' FROM GEOGRAPHYLEVEL(NOLOCK) WHERE GeoLevelName = @GeoLevel )  
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Geogrpahy Level: ' + @GeoLevel + ' is not available'      
			INSERT INTO Errorlog VALUES (18,@Tabname,'GEOGRAPHYLEVEL',@ErrDesc)				
		END
		ELSE
		BEGIN
			SELECT @GeoLevelId = GeoLevelId FROM GEOGRAPHYLEVEL WHERE GeoLevelName = @GeoLevel 
		END
		 
		IF @GeoLevelId <> 0 
		BEGIN
			IF NOT EXISTS  (SELECT '*' FROM Geography(NOLOCK) WHERE GeoName = @GeoLevelValue )  
			BEGIN  
				SET @Po_ErrNo=1  
				SET @Taction=0  
				SET @ErrDesc = 'Geogrpahy Code: ' + @GeoLevelValue + ' is not available'      
				INSERT INTO Errorlog VALUES (19,@Tabname,'GeographyHierarchyValue',@ErrDesc)  
			END  
			ELSE  
			BEGIN  
				SELECT @GeoMainId =GeoMainId FROM Geography WHERE GeoName = @GeoLevelValue  
			END	
		END
	
		IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Independent')
		BEGIN
			SET @RelationStatusID =1
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Parent')
		BEGIN
			SET @RelationStatusID =2
			IF UPPER(LTRIM(RTRIM(@ParentCode))) <> ''
			BEGIN			
				Select @RtrChildId = rtrid from Retailer (Nolock) where RtrCode = @ParentCode
			END
		END
		ELSE IF UPPER(LTRIM(RTRIM(@RelationStatus)))=UPPER('Child')
		BEGIN
			SET @RelationStatusID =3 
		END
		
		IF UPPER(LTRIM(RTRIM(@RtrType)))=UPPER('Sub Stockist')
		BEGIN
			SET @RtrTypeID = 2
		END
		ELSE
		BEGIN
			SET @RtrTypeID = 1		
		END
	
		IF NOT EXISTS(SELECT '*' FROM RETAILERCATEGORY A (NOLOCK) 
		INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
		inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
		where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode)
		BEGIN
			SET @Po_ErrNo=1  
			SET @Taction=0  
			SET @ErrDesc = 'Retailer Category: ' + @RtrClassCode + ' is not available'      
			INSERT INTO Errorlog VALUES (20,@Tabname,'RETAILERCATEGORY',@ErrDesc)		 
		END
		ELSE
		BEGIN
			 SELECT @RtrClassId = RtrClassId FROM RETAILERCATEGORY A (NOLOCK)
			 INNER JOIN RETAILERCATEGORY B (NOLOCK) ON A.Ctgmainid=B.CtglinkId
			 inner join retailervalueclass C (NOLOCK) ON C.CTGMAINID=B.ctgmainid
			 where B.CTGCODE=@RtrGroupCode AND A.CTGCODE=@RtrChannelCode AND C.Valueclasscode=@RtrClassCode		 
		END
		SET @CmpRtrCode = ''			
		--IF @Po_ErrNo = 0 AND @Taction = 1
		--BEGIN
			SELECT @RtrId=dbo.Fn_GetPrimaryKeyInteger('Retailer','RtrId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @RtrShipId=dbo.Fn_GetPrimaryKeyInteger('retailershipadd','RtrShipId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			
			SELECT @CoaId=dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))
			SELECT @AcCode=AcCode+1 FROM COAMaster WHERE CoaId=(SELECT MAX(A.CoaId) 
			FROM COAMaster A Where A.MainGroup=2 and A.AcCode LIKE '216%')  
			
			IF (SELECT Status FROM Configuration WHERE ModuleId='RET33' AND ModuleName='Retailer')=1  
			BEGIN     
				IF NOT EXISTS(SELECT '*' FROM Retailer)  
				BEGIN  
					UPDATE CompanyCounters SET CurrValue = 0 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'   
				END  
				SELECT @CmpRtrCode=dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))     				
			END  
			ELSE  
			BEGIN  
				SET @CmpRtrCode=@RtrCode  
			END 	
			IF @CmpRtrCode=''  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Company Retailer Code should not be empty'    
				INSERT INTO Errorlog VALUES (21,@Tabname,'Counter Value',@ErrDesc)  
			END  
			IF @RtrId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (22,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @RtrShipId=0  
			BEGIN  
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Reset the Counter Year Value '    
				INSERT INTO Errorlog VALUES (23,@Tabname,'Counter Value',@ErrDesc)  
			END	
			IF @StateName = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Sate name Should not be Empty '    
				INSERT INTO Errorlog VALUES (25,@Tabname,'Sate name',@ErrDesc) 			
			
			END
			IF @RetailerType = '' 
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer Type Should not be Empty '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer Type',@ErrDesc) 			
			
			END
			ELSE
			BEGIN
				IF Upper(@RetailerType) = 'REGISTERED'
				BEGIN
					IF UPPER(@Composition) NOT IN('YES','NO','')
					BEGIN
						SET @Po_ErrNo=1    
						SET @Taction=0  
						SET @ErrDesc = 'REGISTERED Retailer Composition Should not be Empty OR either Yes / No'    
						INSERT INTO Errorlog VALUES (27,@Tabname,'Composition',@ErrDesc) 			
					
					END
				END
			END	
			IF UPPER(@RelatedParty) NOT IN('YES','NO')
			BEGIN
				SET @Po_ErrNo=1    
				SET @Taction=0  
				SET @ErrDesc = 'Retailer PARTY Should not be yes / No '    
				INSERT INTO Errorlog VALUES (26,@Tabname,'Retailer PARTY',@ErrDesc) 			
			
			END				
		
		IF @Po_ErrNo = 0 AND @Taction = 1
		BEGIN			
			INSERT INTO Retailer(RtrId,RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrContactPerson,RtrKeyAcc,
			RtrCovMode,RtrRegDate,RtrDayOff,RtrStatus,RtrTaxable,RtrTaxType,RtrTINNo,RtrDepositAmt,RtrCrBills,RtrCrLimit,RtrCrDays,
			RtrCashDiscPerc,RtrCashDiscCond,RtrCashDiscAmt,GeoMainId,RMId,VillageId,RtrShipId,TaxGroupId,RtrOffPhone2,RtrDOB,
			RtrAnniversary,RtrRemark1,CoaId,RtrOnAcc,RtrType,RtrFrequency,RtrCrBillsAlert,RtrCrLimitAlert,RtrCrDaysAlert,Upload,
			RtrRlStatus,Availability,LastModBy,LastModDate,AuthId,AuthDate,CmpRtrCode,Approved,XMLUpload,RtrPayment,RtrUniqueCode,
			WSUpload)
			
			SELECT @RtrId,@RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
			@ContactPerson,@KeyAccId,@RtrCovMode,@RegDate,@RtrDayOff,@Status,(CASE UPPER(@RtrTaxable) WHEN 'YES' THEN 1 ELSE 0 END) RtrTaxable,
			(CASE @TaxType WHEN 'VAT' THEN 0 WHEN 'GST' THEN 2 ELSE 1 END) TaxType
			,@TinNumber,0 RtrDepositAmt,0 RtrCrBills,@RtrCrLimit,@RtrCrDays,@RtrCashDiscPerc,1 RtrCashDiscCond,0 RtrCashDiscAmt,
			@GeoMainId,@RMId,0 VillageId,@RtrShipId,@TaxGroupId,@RtrMobileNo,@RegDate,@RegDate,'Downloaded Retailer',@CoaId,0 RtrOnAcc,
			@RtrTypeID,@RTRFREQUENCYID,0 RtrCrBillsAlert,0 RtrCrLimitAlert,0 RtrCrDaysAlert,'N' Upload,@RelationStatusID,
			1,@Pi_UserId,GETDATE(),@Pi_UserId,GETDATE(),@CmpRtrCode,@ApprovedId,0 XMLUpload,1 RtrPayment,@RtrUniqueCode,
			'N' WSUpload
			
			IF EXISTS (SELECT '*' FROM Retailer WHERE RtrId=@RtrId)  
			BEGIN  
				INSERT INTO CoaMaster (CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
				VALUES (@CoaId,@AcCode,@RtrName,4,2,2,1,1,CONVERT(NVARCHAR(10),GETDATE(),121),1,CONVERT(NVARCHAR(10),
				GETDATE(),121))  
			 			
				INSERT INTO RETAILERMARKET(RtrId,RMId,Availability,LastModBy,LastModDate,AuthId,AuthDate,Upload)
				SELECT @Rtrid,@SRMID,1,1,GETDATE(),1,GETDATE(),0
				
				INSERT INTO RetailerValueClassMap(RtrId,RtrValueClassId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				VALUES(@RtrId,@RtrClassId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121))
				
				IF ISNULL(@RtrChildId,0) <> 0
				BEGIN
					INSERT INTO Retailerrelation(RtrId,RtrChildId,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					Select @RtrId,@RtrChildId,1,@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,
					CONVERT(NVARCHAR(10),GETDATE(),121)
				END
								
				INSERT INTO Retailershipadd (RtrShipId,RtrId,RtrShipAdd1,RtrShipAdd2,RtrShipAdd3,RtrShipPinNo,RtrShipPhoneNo,
				RtrShipDefaultAdd,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxGroupId,StateId,GSTTinNo,Upload)
				SELECT @RtrShipId,@RtrId,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,1,1,@Pi_UserId,
				CONVERT(NVARCHAR(10),GETDATE(),121),@Pi_UserId,CONVERT(NVARCHAR(10),GETDATE(),121),@TaxGroupId,0,'','N'
					
				INSERT INTO ETL_Prk_UdcDetails
				SELECT 'Retailer Master','Latitude', @RtrCode,(CASE @Latitude WHEN '' THEN '0' ELSE @Latitude END) UNION ALL								
				SELECT 'Retailer Master','Longitude', @RtrCode,(CASE @Longitude WHEN '' THEN '0' ELSE @Longitude END) UNION ALL
				SELECT 'Retailer Master','State Name', @RtrCode,@StateName  UNION ALL
				SELECT 'Retailer Master','Retailer Type', @RtrCode,@RetailerType UNION ALL				
				SELECT 'Retailer Master','Composition', @RtrCode,(CASE @Composition WHEN '' THEN 'NA' ELSE @Composition END) UNION ALL
				SELECT 'Retailer Master','PAN Number', @RtrCode,(CASE @PANNumber WHEN '' THEN NULL ELSE @PANNumber END) UNION ALL
				SELECT 'Retailer Master','GSTIN', @RtrCode,(CASE @GSTIN WHEN '' THEN NULL ELSE @GSTIN END) UNION ALL
				SELECT 'Retailer Master','Related Party', @RtrCode,(CASE @RelatedParty WHEN '' THEN 'NO' ELSE @RelatedParty END)
				IF EXISTS(SELECT * FROM ETL_Prk_UdcDetails)
				BEGIN
					EXEC Proc_ValidateUdcDetails 0
				END
				
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'CoaMaster' AND Fldname = 'CoaId'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'retailershipadd' AND Fldname = 'RtrShipId'  
				UPDATE companycounters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'CmpRtrCode'  
				UPDATE Counters SET CurrValue = CurrValue+1 WHERE Tabname =  'Retailer' AND Fldname = 'RtrId'
			END		  		  
		END
	 FETCH NEXT FROM Cur_RetailerMasterDownload_New INTO @RtrCode,@RtrName,@RtrAddress1,@RtrAddress2,@RtrAddress3,@PostalCode,@PhNumber,
	 @ContactPerson,@RtrKeyAcc,@RtrCovMode,@RegDate,@RtrDayOff,@Status,@RtrTaxable,@TaxType,@TinNumber,@GeoLevel,@GeoLevelValue,
	 @DeliveryRoute,@SalesRoute,@RtrCashDiscPerc,@RtrCrLimit,@RtrCrDays,
	 @RtrTaxGroup,@RtrMobileNo,@FrequencyMode,@RtrUniqueCode,@Approved,@RelationStatus,@ParentCode,
	 @RtrGroupCode,@RtrChannelCode,@RtrClassCode,@RtrType,
	 @Latitude,@Longitude,@StateName,@RetailerType,@Composition,@PANNumber,@GSTIN,@RelatedParty
 END  
 CLOSE Cur_RetailerMasterDownload_New  
 DEALLOCATE Cur_RetailerMasterDownload_New  
 UPDATE C SET C.DownLoadFlag='Y' FROM CN2Cs_Prk_RetailerMasterDownload C INNER JOIN Retailer R ON R.RtrCode=C.RtrCODE 
 RETURN  
END
GO
IF NOT EXISTS(select * from sysobjects A inner join syscolumns B ON A.id =b.id and A.NAME ='DBHEALTHCHECK' AND B.NAME ='TotalDBSpace')
BEGIN
	ALTER TABLE DBHealthCheck ADD [TotalDBSpace] NVARCHAR(30)
END
GO
IF NOT EXISTS(select * from sysobjects A inner join syscolumns B ON A.id =b.id and A.NAME ='Cs2Cn_Prk_DBHealthCheck' AND B.NAME ='TotalDBSpace')
BEGIN
	ALTER TABLE Cs2Cn_Prk_DBHealthCheck ADD [TotalDBSpace] NVARCHAR(30)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_DatabaseStatusCheck' AND TYPE ='P')
DROP PROCEDURE Proc_DatabaseStatusCheck
GO
/*
begin tran 
EXEC Proc_DatabaseStatusCheck 'CSTimer_parle',0
select * from DBHealthCheck
EXEC Proc_Cs2Cn_DBHealthCheck 0,'2019-12-12'
SELECT * FROM CS2CN_PRK_DBHEALTHCHECK
SELECT * FROM DBHEALTHCHECK
rollback tran
*/ 
CREATE  PROCEDURE Proc_DatabaseStatusCheck
(
	@Pi_DbName Varchar(200),
	@Po_ErrNo INT OUTPUT
)
AS
/***********************************************************************************************
* PROCEDURE		: Proc_DatabaseStatusCheck
* PURPOSE		: To Validate Database status 
* CREATED		: Murugan.R  
* CREATED DATE	: 19/12/2012
* MODIFIED
************************************************************************************************  
DATE			AUTHOR					CR/BZ	 USER STORY ID    DESCRIPTION                           
************************************************************************************************  
27-05-2019     Govindaraj.P			  SR	 CRCRSTPAR0050     Database HealthCheck included DB Shrink 
11-06-2019     Lakshman M             BZ     ILCRSTPAR4793     Database health checkup process temp table columns mismatched.
************************************************************************************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
------------- added by lakshman M  Dated ON 11-06-2019  PMS id: ILCRSTPAR4793 -------------
CREATE TABLE #CheckDBTemp (
     Error        INT
   , [Level]      INT
   , [State]      INT
   , MessageText  NVARCHAR(1000)
   , RepairLevel  NVARCHAR(1000)
   , [Status]     INT
   , [DBID]       INT
   , [DBFragId]	  INT
   , ObjectID     INT
   , IndexID      INT
   , PartitionID  BIGINT
   , AllocUnitID  BIGINT
   , RidDbId	  INT
   , RidPruId	  INT
   , [File]       INT
   , [Page]       INT
   , Slot         INT
   , RefDbId	  INT
   , RefPruId     INT
   , RefFile      INT
   , RefPage      INT
   , RefSlot      INT
   , Allocation   INT
)
----------- till here --------------
-- Needed variables
BEGIN TRY
DECLARE @TSQL         VARCHAR(Max)
-- Added by Amuthakumar ILCRSTAML2177
--SET @TSQL=''
--SET @TSQL = 'EXEC Proc_DBShrink(''' +  @Pi_DbName  + ''')'
--EXEC(@TSQL)
-- Till Here
SET @TSQL=''
SET @TSQL = 'DBCC CHECKDB(''' +  @Pi_DbName  + ''') WITH TABLERESULTS,no_infomsgs'
INSERT INTO #CheckDBTemp
EXEC(@TSQL) 
TRUNCATE TABLE DBHealthCheck
If Exists(SELECT * FROM #CheckDBTemp)
BEGIN
	 SET @Po_ErrNo=1
	 SELECT @Po_ErrNo
		 INSERT INTO DBHealthCheck(LastUpdate,Errmsg,HealthFlag,UploadFlag) ------------Added by lakshman M  Dated ON 11-06-2019  PMS id: ILCRSTPAR4793 
		 SELECT GETDATE(),@Po_ErrNo,1,0
END
ELSE
BEGIN
		 INSERT INTO DBHealthCheck(LastUpdate,Errmsg,HealthFlag,UploadFlag) ------------Added by lakshman M  Dated ON 11-06-2019  PMS id: ILCRSTPAR4793 
		 SELECT GETDATE(),0,0,0
END	
--------------------- Added by lakshmamn M dated 11-12-2019 PMS Id: ILCRSTPAR7008 ---------------------
--SELECT TOP 1 DB_NAME(mf.database_id) AS 'DB Name', 
--    name AS 'File Logical Name',
--    'File Type' = CASE WHEN type_desc = 'LOG' THEN 'Log File' WHEN type_desc = 'ROWS' THEN 'Data File' ELSE type_desc END,
--    mf.physical_name AS 'File Physical Name', 
--    cast(size_on_disk_bytes/ 1024 AS Nvarchar(50)) + ' (KB)' AS 'Size(KB)', 
--    cast(size_on_disk_bytes/ 1024 / 1024 AS Nvarchar(50)) + ' (MB)' AS 'TotalDBSizeMB'
--	,cast(size_on_disk_bytes/ 1024 / 1024 / 1024 AS Nvarchar(50)) + ' (GB)' AS 'TotalDBSizeGB'
--	--INTO #DBSpac
--FROM 
--    sys.dm_io_virtual_file_stats(NULL, NULL) AS divfs 
--    JOIN sys.master_files AS mf 
--        ON mf.database_id = divfs.database_id 
--            AND mf.file_id = divfs.file_id
--WHERE mf.database_id = DB_ID()
--ORDER BY DB_NAME(mf.database_id)

SELECT name AS [File Name], [file_id], physical_name AS [Physical Name], size/128.0 AS [Total Size in MB],
size/128.0 - CAST(FILEPROPERTY(name, 'SpaceUsed') AS int)/128.0 AS [Available Space In MB]  INTO #TempDB
FROM sys.database_files WITH (NOLOCK) OPTION (RECOMPILE);

SELECT SUM([Total Size in MB]) AS [Total Size in MB] INTO #TempDB1 FROM #TempDB

Update a SET TotalDBSpace = (select SUM([Total Size in MB]) FROM #TempDB1 ) from DBHealthCheck A  ----------- Db size upload column valdiation added
-------------------- Till here ------------------------------------
TRUNCATE TABLE #CheckDBTemp
END TRY
BEGIN CATCH
	IF @@ERROR>0
	BEGIN
		SET @Po_ErrNo=1
		SELECT @Po_ErrNo
	END
END CATCH
END
GO
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'Proc_Cs2Cn_DBHealthCheck' AND xtype ='P')
DROP PROCEDURE Proc_Cs2Cn_DBHealthCheck
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_DBHealthCheck 0,'2018-01-23'
SELECT * FROM CS2CN_PRK_DBHEALTHCHECK
SELECT * FROM DBHEALTHCHECK
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_Cs2Cn_DBHealthCheck
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME	
)
AS
BEGIN
SET NOCOUNT ON
/***********************************************************************************************
* PROCEDURE		: Proc_Cs2Cn_DBHealthCheck
* PURPOSE		: DB Health Status Upload
* NOTES			:
* CREATED		: Amuthakumar P
* CREATED DATE	: 2018-12-24
* MODIFIED
************************************************************************************************  
DATE			AUTHOR					CR/BZ	 USER STORY ID    DESCRIPTION                           
************************************************************************************************  
21/03/2018      AMUTHAKUMAR P			  SR	 ILCRSTAML2177    Database HealthCheck Upload
************************************************************************************************/
	SET @Po_ErrNo=0
		
	DELETE FROM Cs2Cn_Prk_DBHealthCheck WHERE UploadFlag = 'Y'
		
	IF NOT EXISTS (SELECT Slno FROM DBHealthCheck(NOLOCK) WHERE UploadFlag = 0 )
	BEGIN
	   RETURN
	END
	--- HealthFlag and ErrMsg is  0 for Good Database, 1 for Corrupted Database
	INSERT INTO Cs2Cn_Prk_DBHealthCheck(DistCode,LastUpdate,Errmsg,HealthFlag,UploadFlag,SyncId,ServerDate,TotalDBSpace)
	SELECT DistributorCode,LastUpdate,Errmsg,HealthFlag,'N',0,@ServerDate,A.TotalDBSpace ----------- Db size upload column (TotalDBSpace) valdiation added
	FROM DBHealthCheck A(NOLOCK) 
	CROSS JOIN Distributor C(NOLOCK) 
	WHERE UploadFlag=0 

	UPDATE DBHealthCheck SET UploadFlag = 1 WHERE UploadFlag=0 
		
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_TempDistributorIncentiveCalculation' AND TYPE ='P')
DROP PROCEDURE Proc_TempDistributorIncentiveCalculation
GO
/*
BEGIN TRAN
EXEC Proc_TempDistributorIncentiveCalculation 1000,'2019-10-01','2019-10-31'
SELECT * FROM TempDistributorIncentiveCalculation
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_TempDistributorIncentiveCalculation
(
@Pi_UserId AS INT,
@Pi_TransDate AS DATETIME,
@Pi_ToDate AS DATETIME
)
AS
/**************************************************************************************************************************************************************************************
* PROCEDURE		: Proc_TempDistributorIncentiveCalculation
* PURPOSE		: Distributor Incentive Master data prepared
* CREATED		: S.Moorthi
* CREATED DATE	: 27/05/2019
* MODIFIED
**************************************************************************************************************************************************************************************
* VERSION    |  DATE      |	  PERSON			  | USER STORY ID  |  CR/BZ |  REMARKS                      | CODE REVIEW BY     | REVIEW DATE
**************************************************************************************************************************************************************************************
  441		   27-05-2019	 S.Moorthi				CRCRSTPAR0056	 CR			STO(Service to Outlet) or Distributor service invoice logic to be incorporated and debit note should upload to console
  441          08-07-2019    M.Lakshman             ILCRSTPAR5086    BZ         while generate dynamic report Divided by zero error validation added in core stocky 
**************************************************************************************************************************************************************************************/
SET NOCOUNT ON
BEGIN	
		
		CREATE TABLE #DistributorIncentiveMaster
		(
			DistIRefno		VARCHAR(100),
			IncFromDate		DATETIME,
			IncToDate		DATETIME
		)
		----------------- Added By Lakshman M Dated ON 02-12-2019 PMS ID : 
		 IF EXISTS(SELECT * FROM DistributorIncentiveAchDetailRouteLevel A INNER JOIN TempDistributorIncentiveCalculation B ON A.DistIRefNo =B.DistIRefNo AND A.Totalsales ='0.000')
		 BEGIN
			DELETE FROM DistributorIncentiveAchDetailRouteLevel WHERE DistIRefNo IN(SELECT DistIRefNo FROM TempDistributorIncentiveCalculation) AND Totalsales ='0.000'
			DELETE FROM TempDistributorIncentiveCalculation WHERE Totalsales ='0.000' AND UserId=@Pi_UserId
		 END
		 ------------------- Till Here ---------------------
		DELETE FROM TempDistributorIncentiveCalculation WHERE UserId=@Pi_UserId
		
		if @Pi_UserId=1000
		BEGIN
			INSERT INTO #DistributorIncentiveMaster(DistIRefno,IncFromDate,IncToDate)
			SELECT DISTINCT DistIRefno,IncFromDate,IncToDate FROM DistributorIncentiveMaster A   
			WHERE (@Pi_TransDate BETWEEN IncFromDate AND IncToDate OR @Pi_ToDate BETWEEN IncFromDate AND IncToDate 
			OR IncFromDate BETWEEN @Pi_TransDate AND @Pi_ToDate OR IncToDate BETWEEN @Pi_TransDate AND @Pi_ToDate) 
		END
		ELSE
		BEGIN			 
			SELECT DISTINCT DistIRefno,IncFromDate,IncToDate INTO #TempDistInc FROM DistributorIncentiveMaster(nolock) 
			WHERE  IncentiveGenerated=0 and DistIRefStatus=1 AND @Pi_TransDate>IncToDate   --@Pi_TransDate>=IncToDate   
			
			INSERT INTO #DistributorIncentiveMaster(DistIRefno,IncFromDate,IncToDate)
			SELECT B.DistIRefno,B.IncFromDate,B.IncToDate FROM JCMonth A, 
			#TempDistInc B,JCMonthEnd M WHERE B.IncToDate BETWEEN A.JcmSdt AND A.JcmEdt 
			AND M.JcmEdt=A.JcmEdt AND M.JcmSdt=A.JcmSdt
			
			DELETE B FROM SalesInvoice A (NOLOCK),#DistributorIncentiveMaster B
			WHERE A.SalInvDate BETWEEN B.IncFromDate AND B.IncToDate AND A.DlvSts<2	
		END
		
		--SET @DATEVALE=1
		--IF EXISTS (SELECT * FROM CONFIGURATION WHERE MODULENAME='Day End Process' AND ModuleId='DAYENDPROCESS4' AND Status=1)
		--BEGIN
		--	SELECT @DATEVALE=ISNULL(Condition,0) FROM CONFIGURATION WHERE MODULENAME='Day End Process' AND ModuleId='DAYENDPROCESS4' AND Status=1
		--	IF ISNULL(@DATEVALE,0)=0
		--	BEGIN
		--		SET @DATEVALE=3
		--	END
		--END
		IF @Pi_UserId=1000
		BEGIN
			INSERT INTO TempDistributorIncentiveCalculation(DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,
			PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,UserId)
			SELECT A.DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,
			PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,@Pi_UserId 
			FROM #DistributorIncentiveMaster A INNER JOIN DistributorIncentiveAchDetailRouteLevel B ON A.DistIRefno=B.DistIRefno
			
		END
		DELETE A FROM #DistributorIncentiveMaster A INNER JOIN DistributorIncentiveAchDetailRouteLevel B ON A.DistIRefno=B.DistIRefno
		
		IF NOT EXISTS(SELECT * FROM #DistributorIncentiveMaster)
		BEGIN
			RETURN
		END
		
		CREATE TABLE #TempDistributorIncentive
		(
			DistIRefNo				VARCHAR(100),
			SMID					INT,
			RMID					INT,
			NoOfActiveRetailer		INT,
			NoOfEffectiveRetailer	INT,
			PercEffectivity			NUMERIC(18,2),
			NoOfBillsGenerated		INT,
			PercOpportunityUtil		NUMERIC(18,2),
			TotalSales				NUMERIC(18,3),
			DepthPerRoute			NUMERIC(18,0),
			DepthPerBill			NUMERIC(18,0),
			[WeeklyCalc]			INT
		)
		INSERT INTO #TempDistributorIncentive(DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,
		PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc)
		SELECT DISTINCT DistIRefNo,SMId,RMId,0 NoOfActiveRetailer,0 NoOfEffectiveRetailer,
		0 PercEffectivity,0 NoOfBillsGenerated,0 PercOpportunityUtil,0 TotalSales,0 DepthPerRoute,0 DepthPerBill,0 WeeklyCalc 
		FROM SalesmanMarket A CROSS JOIN #DistributorIncentiveMaster 
		
		---Sales Update
		
		--SELECT DistIRefno,SMId,RMID,SUM(Sales) Sales into #DistTotalSales
		--FROM (
		--	SELECT DIM.DistIRefno,SS.SMId,SS.RMID,SUM(SIP.PrdNetAmount)  Sales FROM SalesInvoice SS (NOLOCK) 
		--	INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) ON SS.SalId=SIP.SalId
		--	INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
		--	WHERE SS.Dlvsts>3  
		--	GROUP  BY DIM.DistIRefno,SS.SMId,SS.RMID
		--	UNION ALL
		--	SELECT DIM.DistIRefno,SS.SMId,SS.RMID,-SUM(SIP.PrdNetAmt)  Sales FROM Returnheader SS (NOLOCK) 
		--	INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid 
		--	INNER JOIN #DistributorIncentiveMaster DIM ON SS.ReturnDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
		--	WHERE SS.Status=0  
		--	GROUP  BY DIM.DistIRefno,SS.SMId,SS.RMID
		--) A
		--GROUP BY DistIRefno,SMId,RMID
		
		
		----Sales Calculate with LCTR 
		DECLARE @FromDate AS DATETIME
		DECLARE @ToDate AS DATETIME
		SET @FromDate=(SELECT MIN(IncFromDate) FROM #DistributorIncentiveMaster)
		SET @ToDate=(SELECT MAX(IncToDate) FROM #DistributorIncentiveMaster)
		
		EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate      
		SELECT * INTO #ParleOutputTaxPercentage FROM ParleOutputTaxPercentage (NOLOCK)   
		--SELECT StockTypeId FROM STOCKTYPE WHERE SystemStockType = 1
		--ROUND(((R.BaseQty *(R.PrdUnitSelRate))+(R.BaseQty*R.PrdUnitSelRate)*(T.TaxPerc/100)),2) 
		SELECT DistIRefno,SMId,RMID,SUM(Sales) Sales into #DistTotalSales
		FROM (
			SELECT DIM.DistIRefno,SS.SMId,SS.RMID,
			ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2) Sales 
			FROM SalesInvoice SS (NOLOCK) INNER JOIN Salesinvoiceproduct  SIP (NOLOCK) ON SS.SalId=SIP.SalId 
			INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
			INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1 AND PBD.SLNo=3
			INNER JOIN #ParleOutputTaxPercentage PO (NOLOCK) ON PO.SalId=SS.SalId AND PO.SalId=SIP.SalId AND PO.PrdSlno=SIP.SlNo and PO.TransId=1
			INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
			WHERE SS.Dlvsts>3  
			GROUP  BY DIM.DistIRefno,SS.SMId,SS.RMID
			UNION ALL
			SELECT DIM.DistIRefno,SS.SMId,SS.RMID,
			-1*ROUND(SUM(((SIP.BaseQty*PBD.PrdBatDetailValue)+((SIP.BaseQty*PBD.PrdBatDetailValue)*(PO.TaxPerc/100)))),2)  Sales 
			FROM Returnheader SS (NOLOCK) INNER JOIN Returnproduct  SIP (NOLOCK) ON SS.returnid=Sip.returnid 
			INNER JOIN STOCKTYPE ST (NOLOCK) ON ST.StockTypeId=SIP.StockTypeId AND ST.SystemStockType=1
			INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=SIP.PrdId and PB.PrdBatId=SIP.PrdBatId 
			INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId=PB.PrdBatId AND PBD.PrdBatId=SIP.PrdBatId AND DefaultPrice=1  AND PBD.SLNo=3
			INNER JOIN #ParleOutputTaxPercentage PO (NOLOCK) ON PO.SalId=SS.ReturnID AND PO.SalId=SIP.ReturnID AND PO.PrdSlno=SIP.SlNo and PO.TransId=2
			INNER JOIN #DistributorIncentiveMaster DIM ON SS.ReturnDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
			WHERE SS.Status=0  
			GROUP  BY DIM.DistIRefno,SS.SMId,SS.RMID
		) A
		GROUP BY DistIRefno,SMId,RMID
		-----Sales Calculation
		
		UPDATE A SET A.TotalSales=B.Sales FROM #TempDistributorIncentive A 
		INNER JOIN #DistTotalSales B ON A.DistIRefNo=B.DistIRefno AND A.SMID=B.SMId AND A.RMID=B.RMId
		
		---IF SALESMAN/ROUTE NOW CHANGED BUT BILLED WITH DIFFERENT MAPPING
		INSERT INTO #TempDistributorIncentive(DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,
		PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc)
		SELECT DISTINCT DistIRefNo,SMId,RMId,0 NoOfActiveRetailer,0 NoOfEffectiveRetailer,
		0 PercEffectivity,0 NoOfBillsGenerated,0 PercOpportunityUtil,A.Sales,0 DepthPerRoute,0 DepthPerBill,0 WeeklyCalc  FROM #DistTotalSales A WHERE 
		NOT EXISTS(SELECT * FROM #TempDistributorIncentive B WHERE A.SMId=B.SMID AND A.RMId=B.RMID AND A.DistIRefno=B.DistIRefNo) 
		
		
		---SalesMan Wise Effective Outlet
		SELECT DIM.DistIRefno,SS.SMId,SS.RMID,COUNT(DISTINCT RtrId)  EffectiveRtrCount INTO #EffectiveOutlet FROM SalesInvoice SS (NOLOCK) 
		INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
		WHERE SS.Dlvsts>3  GROUP BY DIM.DistIRefno,SS.SMId,SS.RMID
		
		UPDATE A SET A.NoOfEffectiveRetailer=B.EffectiveRtrCount FROM #TempDistributorIncentive A 
		INNER JOIN #EffectiveOutlet B ON A.DistIRefNo=B.DistIRefno AND A.SMID=B.SMId AND A.RMID=B.RMId
		
		
		----No of Active Retailers
		SELECT SMId,SM.RMId,COUNT(DISTINCT RM.RtrId) ActiveRtrCount INTO #ActiveRetailers FROM SalesmanMarket SM (NOLOCK)
		INNER JOIN RetailerMarket RM(NOLOCK) ON SM.RMId=RM.RMId 
		INNER JOIN Retailer R(NOLOCK) ON R.RtrId=RM.RtrId 
		WHERE R.RtrStatus=1 GROUP BY SMId,SM.RMId
		
		UPDATE A SET A.NoOfActiveRetailer=B.ActiveRtrCount FROM #TempDistributorIncentive A 
		INNER JOIN #ActiveRetailers B ON A.SMID=B.SMId AND A.RMID=B.RMId
		
		---PercEffectivity Update
		UPDATE A SET A.PercEffectivity=isnull(CAST(NoOfEffectiveRetailer AS NUMERIC(18,3))/CAST(nullif(NoOfActiveRetailer,0) AS NUMERIC(18,3)),0)*100 --------- added by lakshman M (Divided by zero error validation added.)
		FROM #TempDistributorIncentive A WHERE NoOfEffectiveRetailer<>0
		
		
		-----No Of Bill count
		SELECT DIM.DistIRefno,SS.SMId,SS.RMID,COUNT(SS.SalId)  BillBount INTO #TempBillCount FROM SalesInvoice SS (NOLOCK) 
		INNER JOIN #DistributorIncentiveMaster DIM ON SS.SalInvDate BETWEEN DIM.IncFromDate AND DIM.IncToDate
		WHERE SS.Dlvsts>3  GROUP  BY DIM.DistIRefno,SS.SMId,SS.RMID
		
		
		UPDATE A SET A.NoOfBillsGenerated=B.BillBount FROM #TempDistributorIncentive A 
		INNER JOIN #TempBillCount B ON A.DistIRefNo=B.DistIRefno and A.SMID=B.SMId AND A.RMID=B.RMId
		
		/*
			--Weekly  - 0		--> 4
			--Bi-Weekly - 1		--> 8
			--Fort Nightly -2   --> 2
			--Monthly	3
			--Daily 4
		
		*/
		----------weekly/Bi Weekly Count
		SELECT SMM.SMId,A.RMId,R.RtrId,(CASE WHEN RtrFrequency=0 THEN 4 
					WHEN RtrFrequency=1 THEN 8
					WHEN RtrFrequency=2 THEN 2
					WHEN RtrFrequency=3 THEN 1
					WHEN RtrFrequency=4 THEN 30 ELSE 4 END) as RtrFrequency INTO #TempRtrFrequency1
		FROM RetailerMarket A 
		INNER JOIN Retailer R ON A.RtrId=R.RtrId 
		INNER JOIN SalesmanMarket SMM ON SMM.RMId=A.RMId  
		WHERE RtrStatus=1
		
		SELECT SMId,RMId,RtrFrequency,COUNT(RtrId) as RtrCount INTO #TempRtrFreq2  FROM #TempRtrFrequency1 GROUP BY SMId,RMId,RtrFrequency
		
		SELECT SMId,RMId,SUM(RtrFrequency*RtrCount) AS [WeeklyCalc] INTO #WeeklyCalc FROM #TempRtrFreq2 GROUP BY SMId,RMId
		UPDATE B SET B.WeeklyCalc=A.WeeklyCalc FROM #WeeklyCalc A
		INNER JOIN #TempDistributorIncentive B ON A.SMID=B.SMID AND A.RMID=B.RMID 
		
		---Opportunity Utilization
		UPDATE A SET A.PercOpportunityUtil=ISNULL(CAST(NoOfBillsGenerated AS NUMERIC(18,3))/CAST(NULLIF(WeeklyCalc,0) AS NUMERIC(18,3)),0)*100
		FROM #TempDistributorIncentive A WHERE WeeklyCalc<>0
		
		---Depth Per Route
		UPDATE A SET A.DepthPerRoute=ISNULL(CAST(TotalSales AS NUMERIC(18,3))/CAST(NULLIF(NoOfEffectiveRetailer,0) AS NUMERIC(18,3)),0)
		FROM #TempDistributorIncentive A WHERE NoOfEffectiveRetailer<>0
		
		---Depth Per Bill
		UPDATE A SET A.DepthPerBill=ISNULL(CAST(TotalSales AS NUMERIC(18,3))/CAST(NULLIF(NoOfBillsGenerated,0) AS NUMERIC(18,3)),0)
		FROM #TempDistributorIncentive A WHERE NoOfBillsGenerated<>0
		
		INSERT INTO TempDistributorIncentiveCalculation(DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,
		PercEffectivity,NoOfBillsGenerated,PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,UserId)
		SELECT DistIRefNo,SMID,RMID,NoOfActiveRetailer,NoOfEffectiveRetailer,PercEffectivity,NoOfBillsGenerated,
		PercOpportunityUtil,TotalSales,DepthPerRoute,DepthPerBill,WeeklyCalc,@Pi_UserId FROM #TempDistributorIncentive
	
RETURN
END
GO
UPDATE UtilityProcess SET VersionId = '3.1.0.20' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.20',442
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 442)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(442,'D','2020-01-02',GETDATE(),1,'Core Stocky Service Pack 442')
GO