--[Stocky HotFix Version]=434
DELETE FROM Versioncontrol WHERE Hotfixid='434'
INSERT INTO VersionControl(HotFixId,VersionNo,FixType,FixedOn,HotFixReleasedOn,VersionReleasedOn,ReplacedOn,ChangesDone) 
VALUES('434','3.1.0.11','D','2018-02-02','2018-02-02','2018-02-02',CONVERT(VARCHAR(11),GETDATE()),'Product Version-Major: Product GST Issue Fix')
GO
DELETE FROM Tbl_DownloadIntegration WHERE SequenceNo = 76
INSERT INTO Tbl_DownloadIntegration
SELECT 76,'SchemeCircularDetails','Cn2Cs_Prk_SchemeCircularDetails','Proc_Import_SchemeCircularDetails',0,500,GETDATE()
GO
DELETE FROM CustomUpDownload WHERE SlNo=268
INSERT INTO CustomUpDownload
SELECT 268,1,'SchemeCircularDetails','SchemeCircularDetails','','Proc_Import_SchemeCircularDetails','Cn2Cs_Prk_SchemeCircularDetails','Proc_Cn2Cs_SchemeCircularDetails','Master','Download',1
GO
IF EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME ='Cn2Cs_Prk_SchemeCircularDetails' AND TYPE='U')
DROP TABLE Cn2Cs_Prk_SchemeCircularDetails
GO
CREATE TABLE Cn2Cs_Prk_SchemeCircularDetails
(
DistCode     NVARCHAR(50) NULL,
CmpSchcode   NVARCHAR(50) NULL,
CircularNo	 NVARCHAR(50) NULL,
CircularDate DATETIME,
SchemeBudget NUMERIC(18,6),
DownLoadFlag NVARCHAR(10) NULL,
CreatedDate  DATETIME NULL
)
GO
IF NOT EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME ='SchemeCircularDetails' AND TYPE='U')
BEGIN
	CREATE TABLE SchemeCircularDetails
	(
	CmpSchcode   NVARCHAR(50) NULL,
	CircularNo	 NVARCHAR(50) NULL,
	CircularDate DATETIME,
	SchemeBudget NUMERIC(18,6),
	DownloadedDate  DATETIME NULL
	)
END
GO
IF EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_Import_SchemeCircularDetails' AND TYPE='P')
DROP PROCEDURE Proc_Import_SchemeCircularDetails
GO
CREATE PROCEDURE Proc_Import_SchemeCircularDetails
(
	@Pi_Records TEXT
)
AS
/*********************************
* PROCEDURE		: Proc_Import_SchemeCircularDetails
* PURPOSE		: To Insert records from xml file in the Table Proc_Cn2Cs_SchemeCircularDetails
* CREATED		: Mohana S
* CREATED DATE	: 17-06-2017
* MODIFIED
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
10-10-2017  Mohana.S	 CR     CCRSTPAR0172          Included Circular Date and scheme Budget  
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @hDoc INTEGER
	
	EXEC sp_xml_preparedocument @hDoc OUTPUT,@Pi_Records
	INSERT INTO Cn2Cs_Prk_SchemeCircularDetails(
		DistCode   ,
		CmpSchcode ,
		CircularNo ,
		CircularDate,
		SchemeBudget,
		DownLoadFlag,
		CreatedDate
	)
	SELECT DistCode,
	    CmpSchcode,
		CircularNo,
		CircularDate,
		SchemeBudget,
		ISNULL(DownLoadFlag,'D'),
		GETDATE()
	FROM OPENXML (@hdoc,'/Root/Console2CS_SchemeCircularDetails',1)
	WITH
	(
		DistCode     NVARCHAR(50) ,
		CmpSchcode   NVARCHAR(50) ,
		CircularNo	 NVARCHAR(50) ,
		CircularDate DATETIME,
		SchemeBudget NUMERIC(18,6),
		DownLoadFlag NVARCHAR(10) 
	) XMLObj
	EXEC sp_xml_removedocument @hDoc
END
GO
IF EXISTS (SELECT * FROM SYS.OBJECTS WHERE NAME='Proc_Cn2Cs_SchemeCircularDetails' AND TYPE='P')
DROP PROCEDURE Proc_Cn2Cs_SchemeCircularDetails
GO
/*
BEGIN TRAN
EXEC Proc_Cn2Cs_SchemeCircularDetails 0
SELECT * FROM ERRoRLOG
SELECT * FROM SchemeCircularDetails 
ROLLBACK TRAN

*/
CREATE PROCEDURE Proc_Cn2Cs_SchemeCircularDetails
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SchemeCircularDetails
* PURPOSE		: To validate the downloaded Scheme Circular details from Console
* CREATED		: Mohana
* CREATED DATE	: 10-10-2017
* MODIFIED
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
10-10-2017  Mohana.S	 CR     CCRSTPAR0172          Included Circular Date and scheme Budget  
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	
	CREATE TABLE #AvoidScheme
	(
		CircularNo NVARCHAR(50)
	)
	
	
	DELETE FROM Cn2Cs_Prk_SchemeCircularDetails WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_SchemeCircularDetails (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END
	 
	INSERT INTO #AvoidScheme
	SELECT CircularNo FROM Cn2Cs_Prk_SchemeCircularDetails WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)

	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_SchemeCircularDetails',CirCularnO,'Scheme Not Available in SchemeMaster' FROM Cn2Cs_Prk_SchemeCircularDetails WHERE CMpSchcode NOT IN (SELECT CmpSchCode FROM SchemeMaster)
	 
	INSERT INTO #AvoidScheme
	SELECT  CmpSchCode as CirCularNo FROM Cn2Cs_Prk_SchemeCircularDetails
	GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 1,'Cn2Cs_Prk_SchemeCircularDetails','CmpSchCode','Duplicate Cmpschcode Available -'+CmpSchCode  FROM Cn2Cs_Prk_SchemeCircularDetails
	GROUP BY CmpSchCode HAVING COUNT(CmpSchCode)>1

	INSERT INTO SchemeCircularDetails
	SELECT CmpSchCode,CircularNo,CircularDate,SchemeBudget,GETDATE() FROM Cn2Cs_Prk_SchemeCircularDetails WHERE CircularNo NOT IN (SELECT CircularNo FROM #AvoidScheme)
	
	UPDATE Cn2Cs_Prk_SchemeCircularDetails SET DownloadFlag ='Y' WHERE CmpSchcode IN (SELECT CmpSchCode FROM SchemeCircularDetails) 
		
	RETURN
	
END
GO
--Debitnote Top Sheet
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Fn_ReturnBudgetUtilized_Scheme' AND TYPE='FN')
DROP FUNCTION Fn_ReturnBudgetUtilized_Scheme
GO
--SELECT dbo.Fn_ReturnBudgetUtilized(331) AS Amt 
--SELECT dbo.Fn_ReturnBudgetUtilized_Scheme(331,'2017-08-01','2017-08-31') AS Amt
CREATE FUNCTION Fn_ReturnBudgetUtilized_Scheme
(
	@Pi_SchId INT,
	@pi_Fromdate Datetime,
	@pi_Todate Datetime
)
RETURNS NUMERIC(38,6)
AS
/***********************************************
* FUNCTION		: Fn_ReturnBudgetUtilized
* PURPOSE		: Returns the Budget Utilized for selected Date(copied from Fn_ReturnBudgetUtilized)
* NOTES			:
* CREATED		: Mohana 
* DATE			: 04-12-2017	 
* User Story ID	: ICRSTPAR6760
************************************************/
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	SET @Points=0
	SET @RetPoints=0
	--Added by Sathishkumar Veeramani 2013/03/14
	DECLARE @ProductBatchDetails TABLE 
	(
	  PrdId NUMERIC(18,0),
	  PrdBatId NUMERIC(18,0),
	  PriceId NUMERIC(18,0),
	  PrdBatDetailValue NUMERIC(18,6)
	)	
	INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PrdBatDetailValue) 
	SELECT DISTINCT A.PrdId,A.PrdBatId,B.PriceId,B.PrdBatDetailValue 
	FROM ProductBatch A WITH (NOLOCK),ProductBatchDetails B WITH (NOLOCK),BatchCreation C WITH (NOLOCK) 
	WHERE A.PrdBatId = B.PrdBatId AND A.BatchSeqId = C.BatchSeqId AND B.SLNo = C.SLNo AND C.ClmRte = 1
	--Till Here
	
	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0)) FROM
		(SELECT A.SalId,A.SchId,A.FlatAmount,A.ReturnFlatAmount,A.DiscountPerAmount,A.ReturnDiscountPerAmount FROM 
		SalesInvoiceSchemeLineWise A (NOLOCK)INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND A.SchId = @Pi_SchId AND B.Dlvsts<> 3
		AND Salinvdate BETWEEN @Pi_fromdate AND @Pi_Todate		)A1
		INNER JOIN SchemeMaster S (NOLOCK) ON A1.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
	--SELECT @FreeValue = ISNULL(SUM((FreeQty - ReturnFreeQty) * D.PrdBatDetailValue),0)
	--	FROM SalesInvoiceSchemeDtFreePrd A INNER JOIN SalesInvoice B ON A.SalId = B.SalId
	--	INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND A.FreePrdBatId = C.PrdBatId
	--	INNER JOIN ProductBatchDetails D (NOLOCK) ON C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId
	--	INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
	--	INNER JOIN SchemeMaster S ON A.SchId=S.SchId AND S.FBM=0
	--	WHERE A.SchId = @Pi_SchId AND DlvSts <> 3
	SELECT  @FreeValue =ISNULL(SUM((FreeQty - ReturnFreeQty) * C.PrdBatDetailValue),0)
		FROM 
		(SELECT A.SchId,A.FreePrdId,A.FreePrdBatId,A.FreePriceId,A.FreeQty,A.ReturnFreeQty FROM 
		SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND B.DlvSts <> 3
		AND Salinvdate BETWEEN @Pi_fromdate AND @Pi_Todate
		) A2
		INNER JOIN @ProductBatchDetails C ON A2.FreePrdId = C.PrdId AND A2.FreePrdBatId = C.PrdBatId AND A2.FreePriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A2.FreePriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A2.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A2.SchId = @Pi_SchId 		
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * C.PrdBatDetailValue),0) FROM
	    (SELECT A.SchId,A.GiftPrdId,A.GiftPrdBatId,A.GiftPriceId,A.GiftQty,A.ReturnGiftQty FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)	
         INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND DlvSts <> 3 AND Salinvdate BETWEEN @Pi_fromdate AND @Pi_Todate )A3
		INNER JOIN @ProductBatchDetails C ON A3.GiftPrdId = C.PrdId AND A3.GiftPrdBatId = C.PrdBatId AND A3.GiftPriceId = C.PriceId
		--INNER JOIN @ProductBatchDetails D ON C.PrdBatId = D.PrdBatId AND A3.GiftPriceId = D.PriceId
		--INNER JOIN BatchCreation E (NOLOCK)	ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
		INNER JOIN SchemeMaster S ON A3.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A3.SchId = @Pi_SchId 
--	 SELECT @Points = ISNULL(SUM(Points - ReturnPoints),0) FROM SalesInvoiceSchemeDtPoints A
-- 		INNER JOIN SalesInvoice B ON A.SalId = B.SalId WHERE SchId = @Pi_SchId
-- 		AND DlvSts <> 3
--	 SELECT @RetSchemeAmt = (ISNULL(SUM(ReturnFlatAmount),0) +
-- 		ISNULL(SUM(ReturnDiscountPerAmount),0))
-- 		FROM ReturnSchemeLineDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		WHERE SchId = @Pi_SchId AND Status = 0
--
--	 SELECT @RetFreeValue = ISNULL(SUM(ReturnFreeQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.FreePrdId = C.PrdId AND
-- 		A.FreePrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.FreePriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--
--	 SELECT @RetGiftValue = ISNULL(SUM(ReturnGiftQty * D.PrdBatDetailValue),0)
-- 		FROM ReturnSchemeFreePrdDt A INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId
-- 		INNER JOIN ProductBatch C (NOLOCK) ON A.GiftPrdId = C.PrdId AND
-- 		A.GiftPrdBatId = C.PrdBatId INNER JOIN ProductBatchDetails D (NOLOCK) ON
-- 		C.PrdBatId = D.PrdBatId AND A.GiftPriceId = D.PriceId INNER JOIN BatchCreation E (NOLOCK)
--			 ON E.BatchSeqId = C.BatchSeqId AND D.SlNo = E.SlNo AND E.ClmRte = 1
-- 		WHERE SchId = @Pi_SchId AND B.Status = 0
--	 SELECT @RetPoints = ISNULL(SUM(ReturnPoints),0) FROM ReturnSchemePointsDt A
-- 		INNER JOIN ReturnHeader B ON A.ReturnId = B.ReturnId WHERE SchId = @Pi_SchId
-- 		AND Status = 0
	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A (NOLOCK)
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId
		WHERE SchId = @Pi_SchId AND DlvSts <> 3
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A (NOLOCK)
		INNER JOIN ChequeDisbursalDetails B (NOLOCK) ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 
		
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=1)
	--->Added By Nanda on 27/10/2010
	
	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ (NOLOCK)
	INNER JOIN SalesInvoice SI (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=0) AND Salinvdate BETWEEN @Pi_fromdate AND @Pi_Todate
	
	SET @BudgetUtilized = (@SchemeAmt + @FreeValue + @GiftValue + @Points + @WindowAmt+ @FBMSchAmt+@QPSSchAmt)
	-- 	- (@RetSchemeAmt + @RetFreeValue + @RetGiftValue + @RetPoints)
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	
	--Added By Sathishkumar Veeramani 2013/09/04
	IF EXISTS (SELECT * FROM SchemeMaster WHERE SchId = @Pi_SchId AND SchType = 5)
	BEGIN
	    SET @BudgetUtilized = 0
	    SELECT @BudgetUtilized = ISNULL(SUM(SchemeUtlzAmt),0) FROM (
	    SELECT DISTINCT A.SalId,SchId,CurSchAmt AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH(NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND DlvSts <> 3 AND Salinvdate BETWEEN @Pi_fromdate AND @Pi_Todate
	     AND SchId = @Pi_SchId AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK)
	    WHERE InvoiceType = 1 AND ReturnMode = 1)UNION
	    SELECT DISTINCT A.SalId,SchId,-1*(ReturnAmt) AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH (NOLOCK),
	    ReturnHeader B WITH (NOLOCK) 
	    WHERE A.SalId = B.SalId AND SchId = @Pi_SchId AND ReturnAmt <> 0 AND InvoiceType = 1 AND ReturnMode = 2 AND B.ReturnDate BETWEEN @Pi_fromdate AND @Pi_Todate
	    AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 1)) Qry
	END	
	--Till Here
	
	RETURN(@BudgetUtilized)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptDebitNoteTopSheet]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptDebitNoteTopSheet]
GO
--Proc_RptDebitNoteTopSheet 291,1,0,'',0,0,1
CREATE PROCEDURE Proc_RptDebitNoteTopSheet
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*************************************************************************************************
* PROCEDURE	: Proc_RptDebitNoteTopSheet
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Debit Note Top Sheet
* MODIFIED 
***************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
10-10-2017  Mohana.S	 CR     CCRSTPAR0172          Included Circular Date and scheme Budget 
04-12-2017	Mohana		 BZ		ICRSTPAR6760		  Added New Function for calculating Scheme utilized for selected month
07-12-2017  Mary.S		 BZ		ICRSTPAR6933		  Excel Sheet row Witdth change    
13-12-2017  Mohana.S	 CR		ICRSTPAR6933		  Changed Sampling Amount as Zero (default)   
09-01-2018  lakshman M   BZ     ICRSTPAR7284          LCTR Formula velidation changed.(special price not consider in LCTR Value).
***************************************************************************************************/     
 
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	
	--Report 1
	DECLARE @CityName AS NVARCHAR(100)
	DECLARE @DistributorCode AS NVARCHAR(40)
	DECLARE @DistributorName AS NVARCHAR(100)
	DECLARE @DBMonth As INT
	
	SELECT @DistributorCode = DistributorCode, @DistributorName = DistributorName,
	@CityName = G.GeoName
	FROM Distributor D (NOLOCK),
	Geography G (NOLOCK) WHERE D.GeoMainId = G.GeoMainId
	
	--Added By Mohana 
	
	--SELECT @DBMonth = COUNT(*) FROM ACMaster  A INNER JOIN ACPeriod B ON A.AcmId=B.AcmId WHERE AcmYr = YEAR (GETDATE()) AND AcmSdt < =@ToDate
	SELECT @DBMonth = CASE MONTH (@ToDate) 
		WHEN 4 THEN 1
		WHEN 5 THEN 2
		WHEN 6 THEN 3
		WHEN 7 THEN 4
		WHEN 8 THEN 5
		WHEN 9 THEN 6
		WHEN 10 THEN 7
		WHEN 11 THEN 8
		WHEN 12 THEN 9
		WHEN 1 THEN 10
		WHEN 2 THEN 11
		WHEN 3 THEN 12
 END 
	--Report 1
		
	--Report 2
	DECLARE @MGSaleable AS INT 
	DECLARE @MGOffer AS INT
	DECLARE @SlNo AS INT
	
	DECLARE @SamplingAmount AS NUMERIC(18,2)
	SELECT @MGSaleable = StockTypeId FROM StockType WHERE UserStockType = 'MGSaleable'
	SELECT @MGOffer = StockTypeId FROM StockType WHERE UserStockType = 'MGOffer'
	SELECT @SlNo = SlNo FROM BatchCreation WHERE FieldDesc = 'Selling Price'
	SELECT DISTINCT J.PrdId,J.PrdBatId,B.TaxGroupId,CAST(0 AS NUMERIC(18,2)) TaxPercentage
	INTO #SamplingBatchTaxPercent
	FROM StockJournal J,
	StockJournalDt D (NOLOCK),
	ProductBatch B (NOLOCK)
	WHERE J.StkJournalRefNo = D.StkJournalRefNo
	AND J.PrdBatId = B.PrdBatId	AND J.PrdId = B.PrdId
	AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	
	SELECT ROW_NUMBER() OVER (ORDER BY T.TaxGroupId) RowNo,
	MAX(T.PrdBatId) PrdBatId,T.TaxGroupId 
	INTO #BatchTaxPercent
	FROM #SamplingBatchTaxPercent T
	WHERE T.TaxGroupId <> 0
	GROUP BY T.TaxGroupId
	
	DECLARE @PrdId AS INT
	DECLARE @PrdBatId AS INT
	DECLARE @TaxGroupId AS INT
	DECLARE @TaxPercentage AS NUMERIC(18,2)
	DECLARE @RowNo AS INT
	DECLARE @TotalRow AS INT
	
	SET @RowNo = 1
	SELECT @TotalRow = COUNT(TaxGroupId) FROM #BatchTaxPercent D (NOLOCK)	
		
	TRUNCATE TABLE SamplingBatchTaxPercent
	WHILE (@RowNo < = @TotalRow)
	BEGIN	
		SELECT @PrdId = B.PrdId, @PrdBatId = S.PrdBatId, @TaxGroupId = B.TaxGroupId
		FROM #BatchTaxPercent S,
		#SamplingBatchTaxPercent B (NOLOCK)
		WHERE S.PrdBatId = B.PrdBatId AND S.TaxGroupId = B.TaxGroupId
		AND RowNo = @RowNo
		EXEC Proc_SamplingTaxCalCulation @PrdId,@PrdBatId
		
		SELECT @TaxPercentage = TaxPercentage FROM SamplingBatchTaxPercent S (NOLOCK)
		WHERE PrdBatId = @PrdBatId
		
		UPDATE B SET B.TaxPercentage = @TaxPercentage
		FROM #SamplingBatchTaxPercent B
		WHERE B.TaxGroupId = @TaxGroupId
		
		SET @RowNo = @RowNo + 1
		
	END	
	
	SELECT @SamplingAmount =  ISNULL(SUM( D.StkTransferQty * (P.PrdBatDetailValue + (P.PrdBatDetailValue * (T.TaxPercentage / 100)))),0)
	FROM StockJournal J,
	StockJournalDt D (NOLOCK),
	ProductBatchDetails P (NOLOCK),
	#SamplingBatchTaxPercent T (NOLOCK)
	WHERE J.StkJournalRefNo = D.StkJournalRefNo AND J.PriceId = P.PriceId
	AND P.PrdBatId = T.PrdBatId
	AND StockTypeId = @MGSaleable AND TransferStkTypeId = @MGOffer
	AND P.SLNo = @SlNo
	--Report 2
	
	--Report 3
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	
	-------------------- Added by Lakshman M On 07/11/2017 PMS_ICRSTPAR6575-------------------
	 SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,    
	 B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue    
	 INTO #BillingDetails    
	 FROM SalesInvoice S (NOLOCK)    
	 INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId    
	 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId 
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1		 
	 WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3
	    
	 SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,    
	 B.DefaultPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue  
	 INTO #ReturnDetails    
	 FROM ReturnHeader S (NOLOCK)    
	 INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID    
	 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId    
	 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1
	 WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3
	     
	 SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,PrdBatDetailValue as PrdUnitSelRate,   
	 CAST (0 AS NUMERIC(18,6)) AS LCTR    
	 INTO #DebitSalesDetails    
	 FROM     
	 (    
	 SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue FROM #BillingDetails    
	 UNION ALL    
	 SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId,SlNo,prdtaxamount,PrdBatDetailValue FROM #ReturnDetails    
	 ) Consolidated 
	    
	 UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)    
	 FROM #DebitSalesDetails M (NOLOCK),    
	 ProductBatchDetails D (NOLOCK)     
	 WHERE M.ActualPriceId = D.PriceId AND D.SLNo = @SlNo 
	
	---------------- commented by Lakshman M on 07/11/2017 ---------------  
	--UPDATE R SET R.LCTR = R.BaseQty * (R.ActualSellRate+(R.ActualSellRate*(T.TaxPerc/100)))
	--FROM #DebitSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType
  -----------------------
	 UPDATE R SET R.LCTR = ((R.BaseQty *(R.PrdUnitSelRate))+(R.PrdUnitSelRate *(T.TaxPerc/100)))    
	 FROM #DebitSalesDetails R (NOLOCK),    
	 #ParleOutputTaxPercentage T (NOLOCK)
	 WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType  
	
	CREATE TABLE #ApplicableProduct
	(
		SchId		INT,
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT DISTINCT A.SchId,B.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN Product C On B.Prdid = C.PrdId
		WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0
	UNION ALL
	SELECT DISTINCT A.SchId,E.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F On
		F.PrdId = E.Prdid
		WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0
	UNION ALL
	SELECT DISTINCT S.SchId,B.MasterRecordId
		FROM SchemeProducts A 
		INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId 
		INNER JOIN SchemeMaster S ON A.SchId = S.SchId
		WHERE S.SchemeLvlMode = 1
		
	CREATE TABLE #ApplicableScheme
	(
		SchId			INT,
		SchDsc			NVARCHAR(100),
		SchValidFrom	DATETIME,
		SchValidTill	DATETIME,	
		Budget			NUMERIC(18,2),
		BudgetAllocationNo VARCHAR(100),
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableScheme (SchId,SchDsc,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)			
	SELECT DISTINCT A.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId
	FROM #ApplicableProduct A (NOLOCK),
	SchemeMaster S (NOLOCK),#BillingDetails B (NOLOCK)
	WHERE A.SchId = S.SchId AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	AND S.Claimable = 1
	
	--Added CircularNo and date By Mohana
	SELECT S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo, CircularDate,
	SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,6)) [SecSalesVal],CAST(0 AS NUMERIC(18,6)) Liab,
	CAST(0 AS NUMERIC(18,6)) Amount
	INTO #SchemeDebit
	FROM #ApplicableScheme S (NOLOCK),
	#DebitSalesDetails B (NOLOCK) ,
	SchemeMaster SM LEFT Outer JOIN SchemeCirculardetails SC ON SM.CmpSchCode=SC.CmpSchcode-- added By Mohana
	WHERE S.PrdId = B.PrdId AND S.SchId=SM.SchId   AND B.TransDate BETWEEN S.SchValidFrom AND S.SchValidTill
	GROUP BY S.SchId,S.SchDsc,S.SchValidFrom,S.SchValidTill,SC.SchemeBudget,CircularNo,CircularDate
	ORDER BY S.SchId
	--SchemeCirculardetails
	
	--SELECT S.SchId,SUM(B.BaseQty) [SecSalesQtyInScheme]
	--INTO #SchemeForLiab
	--FROM #ApplicableScheme S (NOLOCK),
	--#BillingDetails B (NOLOCK)
	--WHERE S.PrdId = B.PrdId AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	--AND EXISTS (SELECT 'C' FROM SalesInvoiceSchemeDtBilled SB (NOLOCK) WHERE B.SalId = SB.SalId AND S.SchId = SB.SchId)
	--GROUP BY S.SchId
	
	UPDATE SD SET SD.Amount = DBO.Fn_ReturnBudgetUtilized_scheme(SD.SchId,@FromDate,@ToDate)   
	FROM #SchemeDebit SD (NOLOCK)
	  
	
	UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,6))
	FROM #SchemeDebit SD (NOLOCK)
	WHERE SD.[SecSalesVal] <> 0
	
	--Report 3
	
	--Report 4
	DECLARE @TargetNo	AS INT
	
	DECLARE @InsFromDate	AS	DATETIME	
	DECLARE @InsToDate		AS	DATETIME
	DECLARE @Year	AS INT	
	DECLARE @Month  AS INT
	DECLARE @MonthName as Nvarchar(100)
			
	SELECT TOP 1 @TargetNo = InsId,@Month=TargetMonth,@Year=TargetYear,
	@InsFromDate = CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01',
	@InsToDate = DATEADD(DD,-1,DATEADD(MM,1,CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01'))	
	
	FROM InsTargetHD H (NOLOCK) WHERE H.[Status] = 1	
	AND CAST(TargetYear AS VARCHAR(5))+ '-' + CAST(TargetMonth AS VARCHAR(2)) + '-01' BETWEEN @FromDate AND @ToDate
	ORDER BY InsId DESC
	
	SELECT @MonthName=MonthName FROM MonthDt (NOLOCK) WHERE MonthId=@Month
	update InsTargetHD set TargetMonth=EffFromMonthId where TargetMonth=0
	
	--EXEC Proc_LoadingInstitutionsTarget @TargetNo,@Pi_UsrId
	EXEC Proc_LoadingInstitutionsTarget @Year,@Month,@MonthName,@Pi_UsrId
	
	SELECT CtgMainId,CtgName,@InsFromDate FromDate,@InsToDate ToDate,SUM([Target]) [Target],SUM(ClmAmount) DiscAmount,
	CAST(0 AS NUMERIC(18,6)) L2MSales,CAST(0 AS NUMERIC(18,6)) CurMSales,CAST(0 AS NUMERIC(18,0)) Outlet
	INTO #Institutions
	FROM InsTargetDetailsTrans (NOLOCK) 
	WHERE UserId = @Pi_UsrId AND SlNo <> 0 and SlNo<>9999
	GROUP BY CtgMainId,CtgName
	
	SELECT DISTINCT R.RtrId,RC.CtgMainId
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND EXISTS (SELECT '' FROM #Institutions I (NOLOCK) WHERE I.CtgMainId = RC.CtgMainId)
	
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales
	INTO #CurrentSales
	FROM 
	(
	SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId
	UNION ALL
	SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),
	#FilterRetailer F
	WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0
	AND F.RtrId = R.RtrId
	GROUP BY F.CtgMainId
	) AS S GROUP BY S.CtgMainId
	SELECT R.CtgMainId,COUNT(DISTINCT S.RtrId) Outlet
	INTO #NoOfOutlet
	FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId	
	
	--Last Two Month Sales
	SELECT @InsToDate = DATEADD (D,-1,@InsFromDate) 
	SELECT @InsFromDate = DATEADD (MONTH,-2,@InsFromDate) 
	
	SELECT S.CtgMainId,CAST(SUM(S.Sales) AS NUMERIC(18,2)) Sales
	INTO #L2MSales
	FROM 
	(
	SELECT R.CtgMainId,SUM(S.SalGrossAmount) Sales FROM SalesInvoice S (NOLOCK),
	#FilterRetailer R
	WHERE S.SalInvDate BETWEEN @InsFromDate AND @InsToDate AND S.DlvSts > 3
	AND S.RtrId = R.RtrId
	GROUP BY R.CtgMainId
	UNION ALL
	SELECT F.CtgMainId,-1 * SUM(R.RtnGrossAmt) FROM ReturnHeader R (NOLOCK),
	#FilterRetailer F
	WHERE R.ReturnDate BETWEEN @InsFromDate AND @InsToDate AND R.Status = 0
	AND F.RtrId = R.RtrId
	GROUP BY F.CtgMainId
	) AS S GROUP BY S.CtgMainId
	
	UPDATE I SET I.CurMSales = C.Sales
	FROM #Institutions I (NOLOCK),
	#CurrentSales C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	UPDATE I SET I.L2MSales = C.Sales / 2
	FROM #Institutions I (NOLOCK),
	#L2MSales C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	UPDATE I SET I.Outlet = C.Outlet
	FROM #Institutions I (NOLOCK),
	#NoOfOutlet C (NOLOCK)
	WHERE I.CtgMainId = C.CtgMainId
	--Report 4
	
	--Nagarajan on 28.Aug.2017
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel1')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel1	
	END	
	
	CREATE TABLE RptDebitNoteTopSheet_Excel1
	(
	[Scheme Description] VARCHAR(100),
	[From] VARCHAR(10),
	[To] VARCHAR(10),
	[Circular No] VARCHAR(100),
	[Date] NVARCHAR(10),
	[Scheme Budget] NUMERIC(18,6),
	[Sec Sales Qty] BIGINT,
	[Sec Sales Value] NUMERIC(18,6),
	[% Liability on Sec Sales] NUMERIC(18,6),
	[Claim Amount] NUMERIC(18,6)
	) 
	
		
	UPDATE #SchemeDebit SET Liab = (Amount / SecSalesVal) * 100 WHERE Liab > 0

	
	SELECT S.SchDsc [Scheme Description],CONVERT(VARCHAR(10),S.SchValidFrom,103) [From],CONVERT(VARCHAR(10),S.SchValidTill,103) [To],ISNULL(S.CircularNo,'') [Circular No],
	 CONVERT(VARCHAR(10),S.CircularDate,103)  [Date],S.SchemeBudget [Scheme Budget],[SecSalesQty] [Sec Sales Qty],[SecSalesVal] [Sec Sales Value],Liab [% Liability on Sec Sales],Amount [Claim Amount],'A' As Dummy
	INTO #RptDebitNoteTopSheet_Excel1
	FROM #SchemeDebit S (NOLOCK) WHERE Amount > 0
	
	DECLARE @RecCount AS BIGINT
	SELECT @RecCount = COUNT(7) FROM #RptDebitNoteTopSheet_Excel1
	IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel1) > 0BEGIN
		INSERT INTO #RptDebitNoteTopSheet_Excel1
		SELECT 'Total' [Scheme Description],'' [From],'' [To],'' [Circular No],'' [Date], 0 [Scheme Budget],
        0 [Sec Sales Qty], 0 [Sec Sales Value],0 [% Liability on Sec Sales],SUM([Claim Amount]) [Claim Amount],'B' Dummy
		FROM  #RptDebitNoteTopSheet_Excel1 
	END
	SELECT * INTO #Excel1 FROM #RptDebitNoteTopSheet_Excel1 ORDER BY Dummy
	
	INSERT INTO RptDebitNoteTopSheet_Excel1
	SELECT [Scheme Description],Cast([From] As Varchar(10)) [From],Cast([To] As Varchar(10)) [To],[Circular No],[Date],[Scheme Budget],
	[Sec Sales Qty],[Sec Sales Value],[% Liability on Sec Sales],[Claim Amount]
	FROM #Excel1
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptDebitNoteTopSheet_Excel2')
	BEGIN
		DROP TABLE RptDebitNoteTopSheet_Excel2	
	END		
	CREATE TABLE RptDebitNoteTopSheet_Excel2
	(
		[Name Of the Category] NVARCHAR(200),
		[From] VARCHAR(10),
		[TO] VARCHAR(10),
		[Circular No] VARCHAR(50),
		[Monthly Target] NUMERIC(38,6),
	    [Last 2 Months Avg Sales] NUMERIC(18,6),
	    [Current Month] NUMERIC(18,6),
	    [No of Incentive Outlets] NUMERIC(18,0),
	    [Total Discount Amount] NUMERIC(38,6)
	)
	
	SELECT CtgName [Name Of the Category],convert(varchar(10),FromDate,103) [From],convert(varchar(10),ToDate,103) [To],'' [Circular No],[Target] [Monthly Target],
	L2MSales [Last 2 Months Avg Sales],CurMSales [Current Month],Outlet [No of Incentive Outlets],DiscAmount [Total Discount Amount],'A' Dummy
	INTO #RptDebitNoteTopSheet_Excel2
	FROM #Institutions (NOLOCK)
	IF (SELECT COUNT(*) FROM #RptDebitNoteTopSheet_Excel2) > 0
	BEGIN
----------------- modified by lakshman M on 04/10/2017----------------  
	 --INSERT INTO #RptDebitNoteTopSheet_Excel2   
	 --SELECT '' [Name Of the Category],'' [From],'' [To],'' [Circular No],'' [Monthly Target],    
	 --'' [Last 2 Months Avg Sales],'' [Current Month],'' [No of Incentive Outlets],sum([Total Discount Amount]) [Total Discount Amount],'B' Dummy    
	 --FROM #RptDebitNoteTopSheet_Excel2    
	 INSERT INTO #RptDebitNoteTopSheet_Excel2    
	 SELECT 0 As [Name Of the Category],0 As [From],0 As [To],0 As [Circular No],0 As [Monthly Target],    
	 0 As [Last 2 Months Avg Sales],0 As [Current Month],0 As [No of Incentive Outlets],sum([Total Discount Amount]) [Total Discount Amount],'B' Dummy    
	 FROM #RptDebitNoteTopSheet_Excel2 
	   
	 Update A set [Name Of the Category]= null ,[From]=null,[To]=null,[Monthly Target]=null,[Last 2 Months Avg Sales]=null  
	 ,[Current Month]=null,[No of Incentive Outlets]=null, [Total Discount Amount]=null,[Circular No]='' from #RptDebitNoteTopSheet_Excel2 A where Dummy ='B'  
  -------------------- Till here ----------------------------- 
	END
	
	SELECT * INTO #Excel2 FROM #RptDebitNoteTopSheet_Excel2 ORDER BY Dummy
	
	INSERT INTO RptDebitNoteTopSheet_Excel2
	SELECT [Name Of the Category],[From],[To],[Circular No],[Monthly Target],
	[Last 2 Months Avg Sales],[Current Month],[No of Incentive Outlets],[Total Discount Amount]
	FROM #Excel2
	
/*
EXEC Proc_RptDebitNoteTopSheet 291,2,0,'Parle',0,0,1
select * from RptDebitNoteTopSheet_Excel1
select * from RptDebitNoteTopSheet_Excel2
*/	
	SET @RecCount = @RecCount + 1
	-- Till here
		
	TRUNCATE TABLE RptExcelDebitNote
	
	INSERT INTO RptExcelDebitNote(Row,Col,MergeCells,Value)
	SELECT 1,1,'A1:J1','PARLE - DEBIT NOTE / CREDIT NOTE'
	UNION ALL
	SELECT 2,1,'A2:J2',''   --ICRSTPAR6933 (Row Number Changed OlRowNo+1)
	UNION ALL
	SELECT 3,1,'A3:H3','Name of the Town : ' + ISNULL(@CityName,'')
	UNION ALL
	SELECT 3,9,'I3:J3','Passed by SO / SE :'
	UNION ALL
	SELECT 4,1,'A4:F4','Name of the Wholesaler : ' + ISNULL(@DistributorName,'')
	UNION ALL
	SELECT 4,7,'G4:H4','Debit Note No :' + CONVERT(NVARCHAR(10),@DBMonth)
	UNION ALL
	SELECT 4,9,'I4:J4','Verified by ASM :'
	UNION ALL
	SELECT 5,1,'A5:F5','Wholesaler Code : ' + ISNULL(@DistributorCode,'')
	UNION ALL
	SELECT 5,7,'G5:H5','Credit Note No :'
	UNION ALL
	SELECT 5,9,'I5:J5','Authorized by DSM :'
	UNION ALL
	SELECT 6,1,'A6:F6','Name of the Division :'
	UNION ALL
	SELECT 6,7,'G6:H6','Credit Note Date :'
	UNION ALL
	SELECT 6,9,'I6:J6','Value of Approved credit note :'
	UNION ALL
	SELECT 7,1,'A7:J7',''
	UNION ALL	
	SELECT 8,1,'A8:J8','1.SAMPLING'
	UNION ALL
	SELECT 9,1,'A9:E9','DSM Sanction Letter Date '
	UNION ALL
	SELECT 9,6,'F9:J9','Sampling Amount : ' + CAST(@SamplingAmount AS VARCHAR(30))
	UNION ALL
	SELECT 10,1,'A10:D10','Product Sampled during the period  '
	UNION ALL
	SELECT 10,5,'E10:G10','From : ' + CONVERT(VARCHAR(11),@FromDate,105)
	UNION ALL
	SELECT 10,8,'H10:J10','To : ' + CONVERT(VARCHAR(11),@ToDate,105)
	UNION ALL
	SELECT 11,1,'A11:J11',''	
	UNION ALL
	SELECT 12,1,'A12:J12','2.TRADE SCHEME'	
	UNION ALL
	SELECT 13,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel1'
	UNION ALL
	SELECT 14,1,'A14','1R'	
	UNION ALL
	SELECT 14 + @RecCount + 1,1,'A' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) + ':J' + CAST(14 + @RecCount + 1 AS VARCHAR(10)) ,'3.INSTITUTIONAL SALES'	
	UNION ALL
	SELECT 14 + @RecCount + 2,C.colid,'',C.name FROM SYSOBJECTS O ,SYSCOLUMNS C WHERE O.id = C.id AND O.name = 'RptDebitNoteTopSheet_Excel2'
	UNION ALL
	SELECT 14 + @RecCount + 3,1,'A' + CAST(14 + @RecCount + 3 AS VARCHAR(10)),'2R'
	UNION ALL
	SELECT 14 + @RecCount,1,'A' + CAST(14 + @RecCount AS VARCHAR(10)) + ':' + 'J' + CAST(14 + @RecCount AS VARCHAR(10)),''	
	UNION ALL
	SELECT 0,0,'A14:A' + CAST(13 + @RecCount AS VARCHAR(10)),'WrapText'	
	UNION ALL
	SELECT 0,10,'B14','ColumnWidth'		
	UNION ALL
	SELECT 0,10,'C14','ColumnWidth'	
	UNION ALL
	SELECT 1,1,'-4108','HorizontalAlignment'
	UNION ALL
	SELECT 2,25,'2:6','RowHeight'	--ICRSTPAR6933
	
	RETURN	
END
GO
IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptSchemeStockReconciliationReport_Excel')
DROP TABLE RptSchemeStockReconciliationReport_Excel
GO
CREATE TABLE [dbo].[RptSchemeStockReconciliationReport_Excel](
	[SchId] [int] NOT NULL,
	[SchCode] [nvarchar](20) NOT NULL,
	[PrdId] [numeric](18, 2) NULL,
	[PrdName] [nvarchar](100) NOT NULL,
	[CB] [int] NULL,
	[OpenStock] [numeric](18, 0) NULL,
	[Purrcptid] [bigint] NOT NULL,
	[CmpInvNo] [nvarchar](50) NOT NULL,
	[GoodsRcvdDate] [nvarchar](11) NULL,
	[BaseQty] [numeric](38, 0) NULL,
	[CloseStock] [numeric](18, 0) NULL
) ON [PRIMARY]
GO
DELETE FROM RptExcelHeaders  WHERE RptId = 290
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,1,'SchId','SchId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,2,'SchCode','Scheme Code',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,3,'PrdId','PrdId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,4,'PrdName','Name of the SKU & Slot',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,5,'CB','No. of Pkts/CB',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,6,'OpenStock','Opening Stock',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,7,'SalId','SalId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,8,'SalInvNo','Invoice No',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,9,'SalInvDate','Dated',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,10,'BaseQty','Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (290,11,'CloseStock','Closing Stock',1,1)
GO
--Stock Reconsilation Report
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptSchemeStockReconciliationReport' AND TYPE='P')
DROP PROCEDURE Proc_RptSchemeStockReconciliationReport
GO
/*
begin tran
EXEC Proc_RptSchemeStockReconciliationReport 290,2,0,'Parle',0,0,1
rollback tran
*/
CREATE PROCEDURE [dbo].[Proc_RptSchemeStockReconciliationReport]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*************************************************************************************************
* PROCEDURE	: Proc_RptSchemeStockReconciliationReport
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
12-10-2017  Mohana.S	 CR     CCRSTPAR0174          Changed the Stock details based on Purchase 
07-12-2017  Mohana.S	 BZ     ICRSTPAR6933          RcvdGoodDate changed to InvDate
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
		
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @SchId	AS INT		
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @SchId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	
	--Commented by Mohana
	--To Filter Products
	--SELECT S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId,SUM(SP.BaseQty) BaseQty
	--INTO #BillingDetails
	--FROM SalesInvoice S (NOLOCK)
	--INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	--WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	--GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,SP.PrdId
	
	--Added By Mohana ICRSTPAR6933
		
	SELECT A.PurRcptId,A.CmpInvNo,A.GoodsRcvdDate InvDate,B.PrdId,SUM(B.RcvdGoodBaseQty) BaseQty
	INTO #PurchaseDetails FROM PurchaseReceipt  A 
	INNER JOIN PurchaseReceiptProduct B ON A.PurRcptId= B.PurRcptId
	AND A.GoodsRcvdDate BETWEEN @FromDate AND @ToDate AND A.Status = 1
	AND EXISTS   (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE B.PrdId = FP.PrdId)
	GROUP BY  A.PurRcptId,A.CmpInvNo,B.PrdId,A.GoodsRcvdDate
		
	CREATE TABLE #ApplicableProduct
	(
		SchId		INT,
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableProduct(SchId,PrdId)
	SELECT DISTINCT A.SchId,B.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN Product C On B.Prdid = C.PrdId
		WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0
	UNION ALL
	SELECT DISTINCT A.SchId,E.Prdid
		FROM SchemeMaster A
		INNER JOIN SchemeProducts B ON A.Schid = B.Schid
		INNER JOIN ProductCategoryValue C ON 
		B.PrdCtgValMainId = C.PrdCtgValMainId 
		INNER JOIN ProductCategoryValue D ON
		D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'
		INNER JOIN Product E On
		D.PrdCtgValMainId = E.PrdCtgValMainId 
		INNER JOIN ProductBatch F On
		F.PrdId = E.Prdid
		WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0
	UNION ALL
	SELECT DISTINCT S.SchId,B.MasterRecordId
		FROM SchemeProducts A 
		INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId 
		INNER JOIN SchemeMaster S ON A.SchId = S.SchId
		WHERE S.SchemeLvlMode = 1
	CREATE TABLE #ApplicableScheme
	(
		SchId			INT,
		SchValidFrom	DATETIME,
		SchValidTill	DATETIME,	
		PrdId 		INT
	)
	
	INSERT INTO #ApplicableScheme (SchId,SchValidFrom,SchValidTill,PrdId)			
	SELECT DISTINCT A.SchId,S.SchValidFrom,S.SchValidTill,A.PrdId FROM #ApplicableProduct A (NOLOCK),
	SchemeMaster S (NOLOCK) , #PurchaseDetails B
	WHERE A.SchId = S.SchId AND B.InvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	AND (S.SchId = (CASE @SchId  WHEN 0 THEN S.SchId ELSE 0 END) OR 
	S.SchId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,8, @Pi_UsrId)))	
	
	SELECT S.SchId,S.SchValidFrom,S.SchValidTill,
	B.PrdId,CAST(0 AS INT) CB,CAST(0 AS NUMERIC(18,0)) OpenStock,CAST(0 AS NUMERIC(18,0)) CloseStock,
	B.PurRcptId,B.CmpInvNo,B.InvDate,B.BaseQty
	INTO #SchemeStock
	FROM #ApplicableScheme S (NOLOCK),
	#PurchaseDetails B (NOLOCK) 
	WHERE S.PrdId = B.PrdId AND B.InvDate BETWEEN S.SchValidFrom AND S.SchValidTill
	
	UPDATE S SET S.CB = ConversionFactor
	FROM #SchemeStock S (NOLOCK),
	(
	SELECT P.PrdId,MAX(U.ConversionFactor) ConversionFactor
	FROM Product P (NOLOCK),UomGroup U (NOLOCK)
	WHERE P.UomGroupId = U.UomGroupId 
	GROUP BY P.PrdId
	) C WHERE C.PrdId = S.PrdId
	
	SELECT * INTO #StockLedger 
	FROM StockLedger S (NOLOCK)
	WHERE EXISTS (SELECT '' FROM #ApplicableScheme A (NOLOCK) WHERE S.PrdId = A.PrdId)
	AND S.LcnId = 1
	
	--OpenStock	
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Open
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate < S.SchValidFrom
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	
	SELECT SchId,PrdId,SUM(SalClsStock) OpenStock
	INTO #OpenStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock SalClsStock
	FROM #Open O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) O
	GROUP BY SchId,PrdId
	--OpenStock
	--CloseStock
	SELECT SchId,SL.PrdId,SL.PrdBatId,MAX(SL.TransDate) TransDate
	INTO #Close
	FROM #SchemeStock S,
	#StockLedger SL (NOLOCK)
	WHERE S.PrdId = SL.PrdId AND SL.TransDate <= S.SchValidTill
	GROUP BY SchId,SL.PrdId,SL.PrdBatId
	SELECT SchId,PrdId,SUM(SalClsStock) CloseStock
	INTO #CloseStock
	FROM 
	(
	SELECT O.SchId,O.PrdId,O.PrdBatId,SalClsStock
	FROM #Close O,
	#StockLedger S (NOLOCK)
	WHERE O.PrdId = S.PrdId AND O.PrdBatId = S.PrdBatId AND O.TransDate = S.TransDate
	) C
	GROUP BY SchId,PrdId
	--CloseStock
	UPDATE S SET S.OpenStock = O.OpenStock
	FROM #SchemeStock S (NOLOCK),
	#OpenStock O (NOLOCK)
	WHERE S.SchId = O.SchId AND S.PrdId = O.PrdId	
	
	UPDATE S SET S.CloseStock = C.CloseStock
	FROM #SchemeStock S (NOLOCK),
	#CloseStock C (NOLOCK)
	WHERE S.SchId = C.SchId AND S.PrdId = C.PrdId
	
	SELECT SM.SchId SchId,SM.SchCode,CAST(P.PrdId AS NUMERIC(18,2)) PrdId,P.PrdName,S.CB,S.OpenStock,
	PurRcptId,CmpInvNo,CONVERT(NVARCHAR(11),S.InvDate,105) GoodsRcvdDate,S.BaseQty,S.CloseStock
	INTO #SchemeStockReconciliation
	FROM #SchemeStock S,
	SchemeMaster SM (NOLOCK),
	Product P (NOLOCK)
	WHERE S.SchId = SM.SchId AND S.PrdId = P.PrdId
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptSchemeStockReconciliationReport_Excel')
	DROP TABLE RptSchemeStockReconciliationReport_Excel
	
	SELECT *
	INTO RptSchemeStockReconciliationReport_Excel
	FROM #SchemeStockReconciliation (NOLOCK) 
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptSchemeStockReconciliationReport_Excel
	
	IF EXISTS (SELECT 'C' FROM RptSchemeStockReconciliationReport_Excel (NOLOCK))
	BEGIN
		INSERT INTO RptSchemeStockReconciliationReport_Excel (SchId,SchCode,PrdId,PrdName,CB,OpenStock,Purrcptid,CmpInvNo,GoodsRcvdDate,
		BaseQty,CloseStock)
		
		SELECT SchId,'' SchCode,PrdId + 0.5 ,'Total' PrdName,MAX(CB) CB,MAX(OpenStock) OpenStock,
		MIN(Purrcptid),'' Cmpinvno,'' GoodsRcvdDate,SUM(BaseQty),MAX(CloseStock)
		FROM RptSchemeStockReconciliationReport_Excel
		GROUP BY SchId,PrdId
		
		UPDATE R SET R.OpenStock = NULL,R.PrdName = '',R.SchCode = ''
		FROM RptSchemeStockReconciliationReport_Excel R (NOLOCK)
		WHERE NOT EXISTS (SELECT 'C' FROM RptSchemeStockReconciliationReport_Excel T 
		WHERE T.PrdName = 'Total' AND R.SchId = T.SchId AND R.PrdId + 0.5 = T.PrdId AND R.Purrcptid = T.Purrcptid)
		AND R.PrdName <> 'Total'
		
		UPDATE R SET R.CloseStock = NULL
		FROM RptSchemeStockReconciliationReport_Excel R (NOLOCK)
		WHERE R.PrdName <> 'Total'
	END
	SELECT * FROM RptSchemeStockReconciliationReport_Excel ORDER BY SchId,PrdId,Purrcptid
	
	RETURN
END
GO
--Scheme Utilization Report
DELETE FROM RptExcelHeaders WHERE RptId = 246
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,21,'GiftQty','GiftQty',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,22,'GiftValue','GiftValue',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,1,'SchId','SchId',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,2,'SchCode','SchCode',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,3,'SchDesc','SchDesc',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,4,'CircularNo','CircularNo',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,5,'SlabId','Slab',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,6,'SchemeBudget','Scheme Budget',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,7,'BudgetUtilized','BudgetUtilized',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,8,'NoOfRetailer','NoOfRetailerBilled',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,9,'NoOfBills','NoOfBillsApplied',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,10,'UnSELECTedCnt','NoOfBillsNotApplied',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,11,'BaseQtyBox','BaseQtyBox',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,12,'BaseQtyPack','BaseQtyPack',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,13,'DiscountPer','Scheme Amount',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,14,'FreePrdName','Free ProductName',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,15,'FreeQty','Free Qty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,16,'FreeValue','Free Qty Value',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,17,'FlatAmount','FlatAmount',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,18,'Points','Points',0,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,19,'BaseQty','BaseQty',1,1)
INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (246,20,'GiftPrdName','GiftPrdName',0,1)
GO
--ADDED BY GOWSALYA.S
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Tbl_syncConfiguration]') AND type in (N'U'))
DROP TABLE [dbo].[Tbl_syncConfiguration]
GO
CREATE TABLE [dbo].[Tbl_syncConfiguration](
	[SlNo] [int] IDENTITY(1,1) NOT NULL,
	[ProcessName] [nvarchar](200) NULL,
	[Setting] [int] NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
Insert into [Tbl_syncConfiguration]
Select 'AutoQuickSync',0,GetDate() Union
Select 'SyncExeMinimized',0,GetDate()Union
Select 'SuccessMsgShow',1,GetDate() Union
Select 'SyncStatus Archieve',0,GetDate() Union
Select 'ScriptUpdaterAfterDeploy',1,GetDate() Union
Select 'PartialUploadDataDelete',1,GetDate() UNION
Select 'HotFixMsg',0,GETDATE() UNION
Select 'ScriptUpdaterHotfixId',1,GetDate() UNION
Select 'SyncVersionInUI',0,GetDate()
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SyncStatus_History]') AND type in (N'U'))
DROP TABLE [dbo].[SyncStatus_History]
GO
CREATE TABLE [dbo].[SyncStatus_History](
	[DistCode] [varchar](100) NULL,
	[SyncId] [int] NULL,
	[DPStartTime] [datetime] NULL,
	[DPEndTime] [datetime] NULL,
	[UpStartTime] [datetime] NULL,
	[UpEndTime] [datetime] NULL,
	[DwnStartTime] [datetime] NULL,
	[DwnEndTime] [datetime] NULL,
	[SyncStatus] [int] NULL,
	[SyncFlag] [varchar](2) NULL,
	[CreatedDate] [datetime] NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CSyncStatus]') AND type in (N'U'))
DROP TABLE [dbo].[CSyncStatus]
GO
CREATE TABLE [dbo].[CSyncStatus](
	[CDate] [datetime] NULL,
	[SyncStatus] [int] NULL
) ON [PRIMARY]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_SyncIdGeneration]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_SyncIdGeneration]
GO
--EXEC Proc_SyncIdGeneration 0
CREATE PROCEDURE [dbo].[Proc_SyncIdGeneration]
(
	@Po_SyncStatus AS INT
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/  
BEGIN
  
BEGIN TRY        
  
SET XACT_ABORT ON        
BEGIN TRANSACTION          
  
		DECLARE @CurrValue AS NUMERIC(38,0)
		SELECT @CurrValue=CurrValue FROM SyncCounter WHERE ModuleName='SyncCount'
		
		Declare @SStatus int
		Select @SStatus = Syncid From SyncStatus (Nolock) Where SyncStatus = 1
		
		IF @SStatus = @CurrValue
		Begin		
		IF Exists(Select * From SyncStatus (Nolock) Where SyncStatus = 1)
			Begin
				IF @Po_SyncStatus=1
					BEGIN
						INSERT INTO Sync_Master (SyncId,SyncDate)
						SELECT @CurrValue+1,GETDATE() FROM  SyncCounter 
						UPDATE SyncCounter SET CurrValue=@CurrValue+1 WHERE ModuleName='SyncCount'
					END
			   End
		End
COMMIT TRANSACTION                  
END TRY                  
  
BEGIN CATCH                  
ROLLBACK TRANSACTION                  
INSERT INTO Sync_ErrorLog VALUES ('Proc_SyncIdGeneration', ERROR_MESSAGE(), GETDATE())        
END CATCH               		
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_SyncValidation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_SyncValidation]
GO
CREATE PROCEDURE [dbo].[Proc_SyncValidation]      
(          
@TypeId Int,          
@Code Varchar(100) = '', -- IP Address in Sync Attempt, DistCode in SyncStatus,          
@Val1 Numeric(18)=0, -- SubTypeId in SyncStatus,          
@Val2 Numeric(18)=0, -- SyncId in SyncStatus,          
@Val3 Numeric(18)=0, -- RecCnt in SyncStatus,          
@Val4 Varchar(100)='',          
@Val5 Varchar(100)='',          
@Val6 Varchar(100)=''          
)          
As 
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
04/10/2017  Gowsalya S   CR          CCONSAML1012            Added HotFixMsg Validation 
07/12/2017  Gowsalya S   CR          CCONSPAR0178            Checking ScriptUpdaterfixid between CS and Console 
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
14/12/2017  Gowsalya S   CR          ISTOCWIP1835            For displaying Syncversion number on Sync exe UI
09/01/2018  Gowsalya S   BZ          ICONSWIP1878            Validation added to check distinct Slno Count  
*/           
Begin          
 Declare @Sql Varchar(Max)        
 Declare @IntRetVal Int      
 IF @TypeId = 1 -- Distributor Code, Proc_SyncValidation  piTypeId          
 Begin          
  SELECT DistributorCode FROM Distributor WHERE Distributorid=1           
 End          
 IF @TypeId = 2 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 Begin          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER45') AND ModuleName='DataTransfer' Order By ModuleId           
  
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
      
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId     
 End           
 IF @TypeId = 3 -- Sync Attempt Validation  Proc_SyncValidation  @TypeId,@Code          
 Begin          
  Declare @RetTemp Int      
  SET @RetTemp = 1      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
 --SET @RetTemp = 0      
 IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
 Begin      
  SET @RetTemp = 0      
 End       
  End      
  IF (@RetTemp = 0)      
  Begin      
 Select 0      
 RETURN      
  End      
  IF Not Exists (Select * From CSyncStatus Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 1)      
 Begin      
  Truncate table CSyncStatus      
  Insert into CSyncStatus Select GETDATE(),0      
 End      
  Set @Code = (Select Top 1 HostName From Sys.sysprocesses where  status='RUNNABLE' Order By login_time desc)          
  IF ((SELECT Count(*) From SyncAttempt) < 1)          
   BEGIN          
    INSERT INTO SyncAttempt          
    SELECT @Code,1,Getdate()          
    SELECT 1          
   END           
  ELSE          
   BEGIN          
    IF (SELECT Status From SyncAttempt) = 0          
     BEGIN          
      UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
      SELECT 1          
     END          
    ELSE          
     BEGIN          
      IF ((SELECT DatedIFf(hh,StartTime,Getdate()) From SyncAttempt) > 1)          
       BEGIN          
          UPDATE SyncAttempt SET IPAddress = @Code,Status = 1,StartTime = Getdate()           
          SELECT 1          
       END          
      ELSE          
        IF ((SELECT Count(*) From SyncAttempt WHERE IPAddress = @Code) = 1 )          
         BEGIN          
          UPDATE SyncAttempt SET Status = 1,StartTime = Getdate()           
          SELECT 1          
         END          
        ELSE          
         BEGIN          
          SELECT 0                   
         END          
     END          
   END            
 End          
 IF @TypeId = 4 -- Remove from Redownloadrequest,  Proc_SyncValidation   @TypeId          
 Begin          
  TRUNCATE TABLE ReDownLoadRequest          
 End          
 IF @TypeId = 5 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
   IF @Val1 = 1           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess='SyncProcess0' ORDER BY SyncProcess          
   End          
   IF @Val1 = 2           
   Begin          
    SELECT * FROM Customupdownloadstatus Status WHERE SyncProcess<>'SyncProcess0' ORDER BY SyncProcess          
   End          
 End          
 IF @TypeId = 6 -- Sync Process Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1           
   Begin          
    SELECT DISTINCT SlNo,SlNo AS SeqNo,Module AS Process,TranType AS [Transaction Type],UpDownload AS [Exchange Type], 0 AS Count           
    FROM Customupdownload  ORDER BY  UpDownload Desc ,SlNo        
   End          
  IF @Val1 = 2           
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Upload'          
End          
  IF @Val1 = 3          
   Begin          
    SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM  Customupdownload  WHERE UpDownload='Download'          
   End          
 End          
 IF @TypeId = 7 -- Sync Status Validation,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3          
 Begin          
  IF Exists(Select * from SyncStatus Where DistCode = @Code and SyncId = @Val2)              
   Begin          
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin       
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End          
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End       
     End             
   End              
  Else              
   Begin              
    Delete From SyncStatus Where DistCode = @Code and SyncStatus = 1        
    IF Not Exists (Select * From  SyncStatus (Nolock))      
    Begin        
  Insert into SyncStatus Select @Code,@Val2,Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),Getdate(),0,'N'      
    End              
    IF @Val1 = 1              
       Begin              
      Update SyncStatus Set DPStartTime = Getdate(),DPEndTime = Getdate(),SyncFlag='N' where DistCode = @Code and SyncId = @Val2             
       End              
    Else IF @Val1 = 2              
     Begin              
      Update SyncStatus Set DPEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End          
    IF @Val1 = 3              
     Begin              
      Update SyncStatus Set UpStartTime = Getdate(),UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 4              
     Begin              
      Update SyncStatus Set UpEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 5              
     Begin              
      Update SyncStatus Set DwnStartTime = Getdate(),DwnEndTime = Getdate() where DistCode = @Code  and SyncId = @Val2            
     End              
    Else IF @Val1 = 6              
     Begin              
      Update SyncStatus Set DwnEndTime = Getdate() where DistCode = @Code and SyncId = @Val2             
     End              
    Else IF @Val1 = 7          
     Begin              
      IF @Val3 = 1          
       Begin          
        Update SyncStatus Set SyncStatus = 1 where DistCode = @Code and SyncId = @Val2             
        Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val2               
       End       
       Else if @Val3 = 2-- Added on 2016-07-22      
       Begin       
   Update SyncStatus Set SyncStatus = 0 where DistCode = @Code and SyncId = @Val2        
   Update CS2Console_Consolidated Set UploadFlag = 'N' where DistCode = @Code and SyncId = @Val2        
       End      
        If (Select Count(1) from Tbl_syncConfiguration(Nolock) Where ProcessName ='SyncStatus Archieve' And Setting = 1) > 0    
  Begin     
   Insert into SyncStatus_History    
   Select *,GETDATE() As CreatedDate from SyncStatus (Nolock)    
  End         
     End             
   End            
 End          
 IF @TypeId = 8 -- Select Current SyncId,  Proc_SyncValidation   @TypeId          
 Begin          
  Select IsNull(MAX(SyncId),0) From Sync_Master-- SyncStatus          
 End           
 IF @TypeId = 9 -- Select Syncstatus for this SyncId,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin          
  Select IsNull(Max(SyncStatus),0) From SyncStatus where DistCode = @Code And syncid = @Val1 And SyncStatus = 1          
 End            
 IF @TypeId = 10 -- DB Restoration Concept,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
   Begin          
    Select Count(*) From DefendRestore          
   End           
  IF @Val1 = 2          
   Begin          
    update DefendRestore Set DbStatus = 1,ReqId = 1,CCLockStatus = 1          
   End             
  IF @Val1 = 3          
   Begin          
    Insert into DefendRestore (AccessCode,LastModDate,DbStatus,ReqId,CCLockStatus)      
    Values('',GETDATE(),1,1,1)          
   End           
 End             
 IF @TypeId = 11 -- AAD & Configuration Validation,  Proc_SyncValidation   @TypeId,'',@Val1          
 Begin          
  IF @Val1 = 1          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId='BotreeSyncCheck'          
  End           
  IF @Val1 = 2          
  Begin          
   SELECT * FROM Configuration WHERE ModuleId LIKE 'BotreeSyncErrLog'          
  End             
  IF @Val1 = 3          
  Begin          
   Select IsNull(Max(FixID),0) from Hotfixlog (NOLOCK)          
  End             
 End             
 IF @TypeId = 12 -- System Date is less than the Last Transaction Date Validation,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT ISNULL(MAX(TransDate),GETDATE()-1) AS TransDate FROM StockLedger          
 End           
 IF @TypeId = 13 -- DayEnd Process Updation,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  UPDATE DayEndProcess SET NextUpDate=@Code WHERE ProcId=13          
 End           
 IF @TypeId = 14 -- Update Sync Attempt Status ,  Proc_SyncValidation   @TypeId,@Code          
 Begin          
  Select @Code =  HostName From Sys.sysprocesses where  status='RUNNABLE'          
  Update SyncAttempt Set Status=0 where IPAddress = @Code          
 End            
 IF @TypeId = 15 -- Latest SyncId from Sync_Master ,  Proc_SyncValidation   @TypeId          
 Begin          
  --Select ISNull(Max(SyncId),0) From Sync_Master           
  IF Exists(Select * From SyncStatus (Nolock) Where SyncStatus = 1)      
  Begin      
   Select ISNull(Max(SyncId),0) From Sync_Master (Nolock)      
  End      
  Else      
  Begin      
   Select ISNull(Max(SyncId),0) From SyncStatus (Nolock)      
  End              
 End           
 IF @TypeId = 16 -- Update the Flag as Y for all lesser than the latest Serial No ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF ((Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N') > 0)              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo >=         
    (Select ISNULL(Min(SlNo),0) From CS2Console_Consolidated (Nolock) Where DistCode = @Code And SyncId = @Val1 And SlNo <= @Val2 And UploadFlag='N')               
   End              
   Else              
   Begin              
    Update CS2Console_Consolidated Set UploadFlag='Y' Where DistCode = @Code and SyncId = @Val1 And SlNo <= @Val2       
    Update CS2Console_Consolidated Set UploadFlag='N' Where DistCode = @Code and SyncId = @Val1 And SlNo > @Val2          
   End       
 End            
 IF @TypeId = 17 -- Record Count ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
  IF @Val1 = 1           
  Begin          
   Select Count(*) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2 and UploadFlag = 'N'          
  End          
  IF @Val1 = 2           
  Begin          
   Select Count(Distinct Slno) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
  End             
  IF @Val1 = 3           
  Begin          
   --Select IsNull(Count(*),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
   Select IsNull(Count(Distinct Syncid),0) From SyncStatus (Nolock) Where DistCode = @Code And SyncId = @Val2 And SyncFlag = 'Y'               
         
  End          
 End            
 IF @TypeId = 18 -- Datapreperation Process and Split each 1000 rows for xml file ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin        IF @Val1 = 1           
  Begin          
   SELECT * FROM  CustomUpDownload  WHERE SlNo=@Val2  AND UpDownload='Upload' ORDER BY UpDownLoad,SlNo,SeqNo          
  End          
  IF @Val1 = 2           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 3          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM  ' + Convert(Varchar(100),@Code) + ' WHERE UploadFlag=''N'''          
   Exec (@Sql)          
  End              
  IF @Val1 = 4          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT * FROM  ' + Convert(Varchar(100),@Code) + ' WHERE  SlNo= ' + Convert(Varchar(100),@Val2) + '  ORDER BY UpDownLoad,SlNo,SeqNo '          
   Exec (@Sql)          
  End             
  IF @Val1 = 5          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM   ' + Convert(Varchar(100),@Code) + '  '          
   Exec (@Sql)          
  End           
  IF @Val1 = 6          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' DELETE  FROM   ' + Convert(Varchar(100),@Code) + ' WHERE Downloadflag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 7          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) FROM   ' + Convert(Varchar(100),@Code) + ' WHERE DownloadFlag = ''D'' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 8          
  Begin          
   Set @Sql = ''          
  Set @Sql = @Sql + ' SELECT TRowCount FROM Tbl_DownloadIntegration_Process WHERE PrkTableName =''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 9          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = 0  WHERE ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 10          
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Update Tbl_DownloadIntegration_Process Set TRowCount = ' + Convert(Varchar(100),@Val2) + ' where ProcessName=''' + Convert(Varchar(100),@Code) + ''' '          
   Exec (@Sql)          
  End             
  IF @Val1 = 11           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MAX(SlNo),0) AS Cnt FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End             
  IF @Val1 = 12           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT ISNULL(MIN(SlNo),0) AS SlNo FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'''          
   Exec (@Sql)          
  End            
  IF @Val1 = 13           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(*) AS Count FROM ' + Convert(Varchar(100),@Code) + ' WHERE SyncId =' + Convert(Varchar(100),@Val2) + ' And UploadFlag=''N'' '          
   Exec (@Sql)          
  End            
  IF @Val1 = 14           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS UploadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Upload'' '          
   Exec (@Sql)          
  End               
  IF @Val1 = 15           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS DownloadCount FROM ' + Convert(Varchar(100),@Code) + ' WHERE UpDownload=''Download'' '          
   Exec (@Sql)          
  End           
  IF @Val1 = 16           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''' And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 17           
  Begin          
   Set @Sql = ''          
   Set @Sql = @Sql + ' Select DistCode +''-eertoB-''+ CONVERT(Varchar(10),SyncID)  From SyncStatus_Download (nolock) Where DistCode =''' + Convert(Varchar(100),@Code) + ''''-- And  SyncStatus = 0 '          
   Exec (@Sql)          
  End           
  IF @Val1 = 18      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
  Select @Sql      
 End       
  IF @Val1 = 19      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''X'' WHERE UploadFlag=''N'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 20      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''Y'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End       
  IF @Val1 = 21      
 Begin      
  Set @Sql = ''      
  Set @Sql = @Sql + ' UPDATE ' + Convert(Varchar(100),@Code) + ' SET UploadFlag=''N'' WHERE UploadFlag=''X'' AND SlNo BETWEEN '      
  Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' '      
  Exec (@Sql)      
 End         
  IF @Val1 = 22      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE UploadFlag=''Y'' And  SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    --Exec (@Sql)        
    --SET @Sql = ''          
    SET @Sql = @Sql + 'UNION ALL SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '          
    Exec (@Sql)           
 End         
  IF @Val1 = 23      
 Begin      
    SET @Sql = ''    
    --Added on 2018-01-09        
    --SET @Sql = @Sql + ' SELECT COUNT(SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' ' 
    SET @Sql = @Sql + ' SELECT COUNT(DISTINCT SlNo) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' WHERE SyncId =' + Convert(VARCHAR(100),@Val2) + ' '         
    Exec (@Sql)           
 End        
 IF @Val1 = 24      
 Begin      
    SET @Sql = ''          
    SET @Sql = @Sql + ' SELECT COUNT(DistCode) AS SlNo FROM ' + Convert(VARCHAR(100),@Code) + ' '      
    Exec (@Sql)           
 End       
 End            
 IF @TypeId = 19 -- View Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin          
  SELECT * FROM ErrorLog WITH (NOLOCK)          
 End          
 IF @TypeId = 20 -- Remove Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  DELETE FROM ErrorLog           
 End           
 IF @TypeId = 21 -- Download Notification Details Error Log Details ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM  CustomUpDownloadCount WHERE UpDownload='Download' ORDER BY SlNo          
 End           
 IF @TypeId = 22 -- Download Details to xml file ,  Proc_SyncValidation   @TypeId          
Begin           
  SELECT * FROM Cs2Cn_Prk_DownloadedDetails WHERE UploadFlag='N'          
 End           
 IF @TypeId = 23 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_DownloadIntegration_Process ORDER BY SequenceNo          
 End           
 IF @TypeId = 24 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_DownloadIntegration_Process SET TRowCount=0          
 End            
 IF @TypeId = 25 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_DownloadIntegration_Process WHERE ProcessName = @Code          
 End            
 IF @TypeId = 26 -- Upload Consolidated Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_UploadIntegration_Process ORDER BY SequenceNo          
 End            
 IF @TypeId = 27 -- Download Details   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT DISTINCT Module,DownloadedCount FROM CustomUpDownloadCount WHERE UpDownload='Download' AND DownloadedCount>0          
 End            
 IF @TypeId = 28 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeReDownload'          
 End           
 IF @TypeId = 29 -- ReDownload Request   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM ReDownLoadRequest         
 End           
 IF @TypeId = 30 -- Showboard    ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Configuration WHERE ModuleId='BotreeBBOardOnSync' AND Status=1          
 End           
 IF @TypeId = 31 -- Update sync status if disconnect    ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin           
  IF Not Exists (Select * From CS2Console_Consolidated (nolock) Where DistCode = @Code And Syncid = @Val1 And UploadFlag='N')          
  Begin          
   Update Syncstatus Set Syncstatus = 1 Where DistCode = @Code And Syncid = @Val1          
   Select IsNull(Max(SyncStatus),0) From SyncStatus (nolock) Where DistCode = @Code And Syncid = @Val1          
  End          
 End           
 IF @TypeId = 32 -- Update sync status if disconnect,Proc_SyncValidation @TypeId,@Code,@Val1          
 Begin           
  Declare @RETVAL Varchar(Max)          
  Set @RETVAL = ''          
  IF EXISTS (Select * From Chk_MainSalesIMEIUploadCnt (NOLOCK))          
  Begin            
  Select @RETVAL = Cast(COALESCE(@RETVAL + ', ', '') + Convert(Varchar(40),MainTblBillNo) as ntext) From Chk_MainSalesIMEIUploadCnt             
  Select @RETVAL          
  End          
 End          
 IF @TypeId = 33 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select 'Request given for approval so please approve from Central Help Desk.'            
 End            
 IF @TypeId = 34 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId            
 Begin             
   Select IsNull(LTrim(RTrim(CmpCode)),'') From Company (Nolock) Where DefaultCompany = 1            
 End            
 IF @TypeId = 35 -- Select Download Sync status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1          
 Begin             
  Select IsNull(SyncStatus,0) from Syncstatus_Download (nolock) Where Distcode = @Code and Syncid = @Val1          
 End            
 IF @TypeId = 36 -- Select Max(Syncid) in Download Sync Status  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SyncId),0) From SyncStatus_Download (Nolock)          
 End            
 IF @TypeId = 37 -- Select Max(SlNo) in Console2CS_Consolidated  ,  Proc_SyncValidation   @TypeId            
 Begin             
  Select IsNull(Max(SlNo),0) From Console2CS_Consolidated (Nolock) Where Distcode = @Code and Syncid = @Val1          
 End             
 IF @TypeId = 38 -- Syncstatus  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2          
 Begin          
 Declare @RetState Int          
 Update CSyncStatus Set SyncStatus = 1 Where CONVERT(Varchar(10),CDate,121) = CONVERT(Varchar(10),GETDATE(),121) And SyncStatus = 0      
 IF Exists (Select * From SyncStatus (Nolock) where DistCode = @Code And syncid = @Val1 And SyncStatus = 1)          
  Begin          
 If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
  IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 1 -- Upload and Download Completed Successfully              
   End          
  Else          
   Begin          
    Set @RetState = 2 -- Upload Completed, Download Incomplete           
   End          
  End      
 Else      
  Begin      
  Set @RetState = 1 -- Upload and Download Completed Successfully       
  End      
  End          
  Else          
  Begin          
   If (Select Count(1) from SyncStatus_Download_Archieve (Nolock) Where SyncId > 0) > 0      
  Begin      
    IF Exists (Select * From SyncStatus_Download (Nolock) where DistCode = @Code And syncid = @Val2 And SyncStatus = 1)          
   Begin          
    Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully                
   End          
  Else          
   Begin          
    Set @RetState = 4 -- Upload and Download Incomplete!!!                 
   End          
  End      
 Else      
  Begin      
  Set @RetState = 3 -- Upload Incomplete, Download Completed Successfully       
  End      
  End          
  Select @RetState          
 End             
 IF @TypeId = 39 -- Update Download Sync Status  ,  Proc_SyncValidation   @TypeId,@Code,@Val1,@Val2,@Val3            
 Begin             
 -------          
  IF Exists(SELECT * FROM SyncStatus_Download WHERE DistCode = @Code and SyncId = @Val2)                      
   Begin          
    IF @Val1 = 1                      
    Begin                    
    If Exists (Select * from SyncStatus_Download(Nolock)  Where DistCode = @Code and SyncId = @Val2 And SyncStatus =1 And SyncFlag =0) --Added on 2016-10-04             
    Begin    
     IF Exists(SELECT * FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag Not in ('N','D'))  --Added on 2016-07-25             
     Begin              
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag ='Y'              
     End     
   End            
   else     
   Begin    
  DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2        
   End       
     --Update SyncStatus_Download Set SyncStatus=0,SyncFlag=0 Where DistCode = @Code and SyncId = @Val2   -- Added to Parameter S             
     UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
     --IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)                
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin                
        If @Val3 > 0 -- Added on 2016-07-25      
  Begin            
   DELETE A FROM Console2CS_Consolidated A (NOLOCK)  WHERE DistCode = @Code and SyncId = @Val2         
  End                 
      End              
     End                   
   End                      
  Else                      
   Begin                      
    INSERT INTO SyncStatus_Download_Archieve  SELECT *,Getdate() FROM SyncStatus_Download WHERE DistCode = @Code                 
    DELETE FROM SyncStatus_Download WHERE DistCode = @Code        
  --  INSERT INTO SyncStatus_Download SELECT @Code,@Val2,Getdate(),Getdate(),0,0      
    -----------Added on 2016-07-25-------------      
 if  @Val3 = 0      
 Begin      
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),1,1                      
 End      
 Else      
 Begin                  
  Insert into SyncStatus_Download Select @Code,@Val2,Getdate(),Getdate(),0,0                      
 End        
 -----------Added on 2016-07-25-------------        
    INSERT INTO SyncStatus_Download_Archieve SELECT @Code,@Val2,Getdate(),Getdate(),0,0,GETDATE()                       
    IF @Val1 = 1                      
    Begin                      
    UPDATE SyncStatus_Download SET DwnStartTime = Getdate(),DwnEndTime = Getdate() WHERE DistCode = @Code  and SyncId = @Val2                    
    End                      
    IF @Val1 = 2                      
     Begin                      
    UPDATE SyncStatus_Download SET DwnEndTime = Getdate() WHERE DistCode = @Code and SyncId = @Val2                     
     End                  
    IF @Val1 = 3                      
     Begin                      
--     IF (@Val3 = (SELECT COUNT(Distinct SlNo) FROM Console2CS_Consolidated (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2 And DownloadFlag='N'))                
  IF (@Val3 = 1)      
      Begin                
    UPDATE SyncStatus_Download SET SyncStatus = 1 WHERE DistCode = @Code and SyncId = @Val2                   
      End               
     Else            
      Begin       
       IF @Val3 > 0 -- Added on 2016-07-25      
  BEGIN                
   DELETE A FROM Console2CS_Consolidated A (NOLOCK) WHERE DistCode = @Code and SyncId = @Val2                   
  END       
      End               
     End                   
   End            
 ------          
 END      
  IF @TypeId = 40 -- Download Integration Details  ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT * FROM Tbl_Customdownloadintegration ORDER BY SequenceNo          
 End           
 IF @TypeId = 41 -- Reset TRow Count  ,  Proc_SyncValidation   @TypeId          
 Begin           
  UPDATE Tbl_Customdownloadintegration SET TRowCount=0          
 End       
 IF @TypeId = 42 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT PrkTableName,SPName FROM Tbl_Downloadintegration WHERE ProcessName = @Code          
 End       
 IF @TypeId = 43 -- Download Process   ,  Proc_SyncValidation   @TypeId          
 Begin           
  SELECT TRowCount FROM Tbl_Customdownloadintegration WHERE PrkTableName = @Code          
 End       
 IF @TypeId = 44 -- Download Process   ,  Proc_SyncValidation   @TypeId   
 Begin           
  Update Tbl_Customdownloadintegration Set TRowCount = @Val1 WHERE ProcessName = @Code          
 End       
 IF @TypeId = 45 -- Update DB Restore request status  ,  Proc_SyncValidation   @TypeId        
 Begin         
 Set @IntRetVal = 0        
 IF @Val1 = 1      
 Begin      
  If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')        
   Begin        
    IF Exists (Select * from UtilityProcess where ProcId = 3)        
    Begin        
     IF ((Select Convert(Varchar(100),VersionId) from UtilityProcess where ProcId = 3) <> @Code)        
     Begin        
   Set @IntRetVal = 1            
     End           
    End        
   End        
 End         
 IF @Val1 = 2      
 Begin      
  If Not Exists (Select * From AppTitle (Nolock) Where  SynVersion = @Code)        
   Begin        
   Set @IntRetVal = 1      
   End      
 End      
 Select @IntRetVal       
 End         
 IF @TypeId = 46 -- Data Purge  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 IF Exists (Select * From Sys.objects Where name = 'DataPurgeDetails' and TYPE='U')      
 Begin      
  IF EXISTS (Select * From DataPurgeDetails)      
  Begin      
   Set @IntRetVal = 0      
  End      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 47 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 1      
 --IF Exists (Select * From Sys.objects Where name = 'Distributor' and TYPE='U')      
 --Begin      
 -- Update Distributor Set DistStatus = 0 Where DistributorCode = @Code      
 --End      
 End      
 IF @TypeId = 48 -- Unregistered Database  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0      
 IF Not Exists (Select * From SyncStatus (Nolock))      
 Begin      
  Set @IntRetVal = 1 -- Unregistered Database      
 End      
 Else      
 Begin      
  IF Exists (Select * From SyncStatus (Nolock) Where DistCode Is Null or DistCode = '')      
  Begin      
   Set @IntRetVal = 2 -- Distributor Code is not found      
  End      
 End      
 IF (@IntRetVal > 0)      
 Begin      
  Select @IntRetVal      
  RETURN      
 End      
 IF Not Exists (Select * from SyncStatus (Nolock) where SyncId = 0)      
 Begin      
  IF Not Exists (Select * From SyncStatus (Nolock) Where Syncid = (Select MAX(Syncid) From Sync_Master (Nolock)))      
  Begin      
   IF Not Exists (Select * From SyncStatus (Nolock) Where SyncStatus = 1 And Syncid = (Select MAX(Syncid) -1 From Sync_Master (Nolock)))      
   Begin      
    SET @IntRetVal = 3        
   End      
  End      
 End      
 Else      
 Begin      
  SET @IntRetVal = 4      
 End      
 Select @IntRetVal       
 End      
 IF @TypeId = 49 -- DB Restoration  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @IntRetVal = 0       
 --If Exists (Select * From Cs2Cn_Prk_DBUnlockDetails (Nolock) Where DistCode = @Code And DBUnlockStatus > 0)      
 --Begin      
 -- Set @IntRetVal = 1      
 --End      
 If Exists (Select * From DefendRestore (Nolock) Where ReqId > 0)      
 Begin      
  Set @IntRetVal = 1      
 End       
 Select @IntRetVal      
 End       
 IF @TypeId = 50 -- Upload And Download, Path Proc_SyncValidation  piTypeId          
 BEGIN          
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44','DATATRANSFER47') AND ModuleName='DataTransfer' And Description ='Upload Path'  Order By ModuleId         
  --SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45','DATATRANSFER48') AND ModuleName='DataTransfer' And Description ='Download Path'  Order By ModuleId           
  
  
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER44') AND ModuleName='DataTransfer'  And Description ='Upload Path' 
  Union   
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Upload Path 2') Order By ModuleId 
      
  SELECT * FROM Configuration WHERE ModuleId In ('DATATRANSFER45') AND ModuleName='DataTransfer'  And Description ='Download Path' 
  Union      
  SELECT * FROM Configuration WHERE  ModuleName='DataTransfer' AND Description In ('Download Path 2') Order By ModuleId 
  
 END       
 IF @TypeId = 51 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_UploadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End      
 IF @TypeId = 52 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Set @Sql = ''      
 Set @Sql = @Sql + ' SELECT * FROM ' + Convert(Varchar(100),@Code) + ' As DU WHERE UploadFlag=''N'' AND SlNo BETWEEN  '      
 Set @Sql = @Sql + '  ' + Convert(Varchar(100),@Val2) + ' And ' + Convert(Varchar(100),@Val3) + ' ORDER BY SlNo  ' --FOR XML AUTO '      
 Print (@Sql)      
 Exec (@Sql)      
 End       
 IF @TypeId = 53 -- Update In Active Distributor  ,  Proc_SyncValidation   @TypeId        
 Begin        
 Select * From Tbl_DownloadIntegration_Process (Nolock) Where ProcessName='DB_Restore'      
 End       
 IF @TypeId = 54   -- Added on 2016-07-23 for Partial data upload         
 Begin                
 IF @Val1 = 1                   
 Begin                  
  Select Count(1) From CS2Console_Consolidated where DistCode = @Code and syncid =@Val2           
 End                  
 IF @Val1 = 2          
 Begin                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End     
  IF @Val1 = 3          
 Begin            
 Update SyncStatus Set SyncStatus = 0, SyncFlag ='N' where DistCode = @Code and SyncId = @Val2                  
  Update  A Set UploadFlag='N' From CS2Console_Consolidated A (Nolock)  Where DistCode = @Code and SyncId = @Val2                            
 End           
 End        
 IF @TypeId = 55   -- Added on 2016-08-31 for Auto Quick Sync       
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'AutoQuickSync'      
 End      
 IF @TypeId = 56   -- Added on 2016-08-31 for SyncExe Minimized Mode        
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncExeMinimized'      
 End      
 IF @TypeId = 57   -- Added on 2016-08-31 for SuccessMsgShow      
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SuccessMsgShow'      
 End      
  IF @TypeId = 58    
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'PartialUploadDataDelete'      
 End      
 IF @TypeId = 59     
 Begin          
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterAfterDeploy'      
 End  
 IF @TypeId = 60         
 Begin              
 Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'HotFixMsg'          
 End  
 
  IF @TypeId = 61          
 Begin              
	Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'ScriptUpdaterHotfixId'          
 End
 
	IF @TypeId = 62            
	Begin              
		Select Isnull(Max(fixid),0) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog)      
	End
 
	IF @TypeId = 63          
	Begin   
		IF @Val1 = 1 
		Begin            
			Select Distinct Setting from Tbl_syncConfiguration Where Processname = 'SyncVersionInUI'     
		End
		IF @Val1 = 2
		Begin          
			If Exists (Select * From sys.Objects where TYPE='U' and name ='UtilityProcess')            
			Begin 
				IF Exists (Select * from UtilityProcess where ProcId = 3)            
				Begin            
					Select ISNULL(Versionid,'') from UtilityProcess where ProcId = 3
				End
			End
		End           
	End
 
----------Additional Validation----------          
END
GO
UPdate A Set Status = 0 FROM Configuration A WHERE ModuleId='BotreeSyncCheck'
GO
IF NOT EXISTS(SELECT * FROM Tbl_UploadIntegration_Process WHERE ProcessName='DB_Restore')  
BEGIN   
	Insert into Tbl_UploadIntegration_Process(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
	Select 2,'DB_Restore','Proc_RetailerUploadDBUnlock','Cs2Cn_Prk_RetailerMasterDBUnlock',GetDate()
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_Retailer_DBUnlock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock](
	[ProcessName] [nvarchar](100) NOT NULL,
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[RtrId] [int] NULL,
	[RtrCode] [nvarchar](100) NULL,
	[CmpRtrCode] [nvarchar](100) NULL,
	[RtrName] [nvarchar](100) NULL,
	[RtrAddress1] [nvarchar](100) NULL,
	[RtrAddress2] [nvarchar](100) NULL,
	[RtrAddress3] [nvarchar](100) NULL,
	[RtrPINCode] [nvarchar](20) NULL,
	[RtrChannelCode] [nvarchar](100) NULL,
	[RtrGroupCode] [nvarchar](100) NULL,
	[RtrClassCode] [nvarchar](100) NULL,
	[KeyAccount] [nvarchar](20) NULL,
	[RelationStatus] [nvarchar](100) NULL,
	[ParentCode] [nvarchar](100) NULL,
	[RtrRegDate] [nvarchar](100) NULL,
	[GeoLevel] [nvarchar](100) NULL,
	[GeoLevelValue] [nvarchar](100) NULL,
	[VillageId] [int] NULL,
	[VillageCode] [nvarchar](100) NULL,
	[VillageName] [nvarchar](100) NULL,
	[Status] [tinyint] NULL,
	[Mode] [nvarchar](100) NULL,
	[DrugLNo] [nvarchar](50) NULL,
	[RtrFrequency] [nvarchar](100) NULL,
	[RtrPhoneNo] [nvarchar](50) NULL,
	[RtrTINNumber] [nvarchar](50) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[Approved] [nvarchar](100) NULL,
	[EmailId] [nvarchar](100) NULL,
	[ContactPerson] [nvarchar](100) NULL,
	[TaxType] [nvarchar](20) NULL,
	[RetailerMobileNumber] [nvarchar](50) NULL,
	[CreditBills] [numeric](18, 0) NULL,
	[CreditDays] [numeric](18, 0) NULL,
	[CreditLimit] [numeric](18, 0) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL,
	[Remarks1] [nvarchar](200) NULL,
	[AutoClass] [nvarchar](100) NULL,
	[TownType] [nvarchar](100) NULL,
	[RtrType] [varchar](100) NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT ('') FOR [Approved]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT ((0)) FOR [SyncId]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT (getdate()) FOR [ServerDate]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT ('NIL') FOR [Remarks1]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT ('NO') FOR [AutoClass]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Retailer_DBUnlock] ADD  DEFAULT ('') FOR [RtrType]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_Route_DBUnlock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_Route_DBUnlock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_Route_DBUnlock](
	[ProcessName] [nvarchar](100) NOT NULL,
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[RMId] [int] NULL,
	[RMCode] [nvarchar](100) NULL,
	[RMName] [nvarchar](100) NULL,
	[Distance] [numeric](38, 6) NULL,
	[RMPopulation] [numeric](38, 6) NULL,
	[VanRoute] [nvarchar](100) NULL,
	[RouteType] [nvarchar](100) NULL,
	[LocalUpCountry] [nvarchar](100) NULL,
	[GeoLevel] [nvarchar](100) NULL,
	[GeoValue] [nvarchar](100) NULL,
	[Status] [nvarchar](20) NULL,
	[MonDay] [nvarchar](20) NULL,
	[TuesDay] [nvarchar](20) NULL,
	[WednesDay] [nvarchar](20) NULL,
	[ThursDay] [nvarchar](20) NULL,
	[FriDay] [nvarchar](20) NULL,
	[SaturDay] [nvarchar](20) NULL,
	[SunDay] [nvarchar](20) NULL,
	[UploadFlag] [nvarchar](1) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Route_DBUnlock] ADD  DEFAULT ((0)) FOR [SyncId]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Route_DBUnlock] ADD  DEFAULT (getdate()) FOR [ServerDate]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_RetailerRoute_DBUnlock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_RetailerRoute_DBUnlock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_RetailerRoute_DBUnlock](
	[ProcessName] [nvarchar](100) NOT NULL,
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[RtrId] [int] NULL,
	[RtrCode] [nvarchar](100) NULL,
	[RtrName] [nvarchar](100) NULL,
	[RMId] [int] NULL,
	[RMCode] [nvarchar](100) NULL,
	[RMName] [nvarchar](100) NULL,
	[RouteType] [nvarchar](100) NULL,
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_RetailerRoute_DBUnlock] ADD  DEFAULT ((0)) FOR [SyncId]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_RetailerRoute_DBUnlock] ADD  DEFAULT (getdate()) FOR [ServerDate]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_Salesman_DBUnLock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_Salesman_DBUnLock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_Salesman_DBUnLock](
	[ProcessName] [nvarchar](100) NOT NULL,
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](100) NULL,
	[SMId] [int] NULL,
	[SMCode] [nvarchar](100) NULL,
	[SMName] [nvarchar](100) NULL,
	[SMPhoneNo] [nvarchar](100) NULL,
	[SMEmail] [nvarchar](100) NULL,
	[SMOtherDetails] [nvarchar](500) NULL,
	[SMDailyAllowance] [numeric](38, 6) NULL,
	[SMMonthlySalary] [numeric](38, 6) NULL,
	[SMMktCredit] [numeric](38, 6) NULL,
	[SMCreditDays] [int] NULL,
	[Status] [nvarchar](20) NULL,
	[RMId] [int] NULL,
	[RMCode] [nvarchar](100) NULL,
	[RMName] [nvarchar](100) NULL,
	[UploadFlag] [nvarchar](1) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Salesman_DBUnLock] ADD  DEFAULT ((0)) FOR [SyncId]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_Salesman_DBUnLock] ADD  DEFAULT (getdate()) FOR [ServerDate]
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_UDCDetails_DBUnlock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_UDCDetails_DBUnlock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_UDCDetails_DBUnlock](
	[ProcessName] [nvarchar](100) NOT NULL,
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[MasterId] [int] NULL,
	[MasterName] [nvarchar](200) NULL,
	[MasterValueCode] [nvarchar](200) NULL,
	[MasterValueName] [nvarchar](200) NULL,
	[ColumnName] [nvarchar](100) NULL,
	[ColumnValue] [nvarchar](100) NULL,
	[UploadFlag] [nvarchar](1) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_UDCDetails_DBUnlock] ADD  DEFAULT ((0)) FOR [SyncId]
GO
ALTER TABLE [dbo].[Cs2Cn_Prk_UDCDetails_DBUnlock] ADD  DEFAULT (getdate()) FOR [ServerDate]
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_DBUnlock]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_DBUnlock]
GO
CREATE Proc [dbo].[Proc_DBUnlock]  
(  
@TypeId int = 0,  
@Reason nvarchar(100) = null,  
@Remarks nvarchar(200) = null,  
@DBStatus int = 0  
)  
as   
Begin  
 If @TypeId = 1  
 Begin  
   
  Select DistributorCode,DistributorName From Distributor with(nolock)  
   
 End  
 If @TypeId = 2  
 Begin  
   
  Create table #Reason  
  (  
   RId int,  
   RName nvarchar(100)  
  )  
    
  Insert into #Reason  
  Select 0,'--- Select ---'  
      
  Insert into #Reason  
  Select 1,'Database Restored'  
      
  Insert into #Reason  
  Select 2,'Database Crashed '  
      
  Insert into #Reason  
  Select 3,'System Formated'  
   
  Select RId,RName From #Reason   
     
 End  
 If @TypeId = 3  
 Begin  
   
  Select AccessCode,LastModDate,DbStatus,ReqId From DefendRestore with(nolock)  
    
 End  
 If @TypeId = 4  
 Begin  
   
  Truncate table Cs2Cn_Prk_DBUnlockDetails  
   
  Insert into Cs2Cn_Prk_DBUnlockDetails  
  (  
   DistCode,  
   SyncId,  
   HotFixId,  
   IPAddress,  
   Reason,  
   Remarks,  
   DBUnlockStatus,  
   UploadDate,  
   UploadFlag  
  )  
  Select Distinct  
   DistributorCode as DistCode,  
   0 as SyncId,  
   0 as HotFixId,  
   '' as IPAddress,  
   @Reason as Reason,  
   @Remarks as Remarks,  
   1 as DBUnlockStatus,  
   getdate() as UploadDate,  
   'N' as UploadFlag   
  From   
   Distributor   
     
  If ((Select Count(*) from SyncStatus with(nolock)) > 0)  
  Begin  
     
   If ((Select Count(*) from SyncStatus with(nolock) where SyncStatus = 1 ) > 0)  
   Begin  
      
    Update Cs2Cn_Prk_DBUnlockDetails set SyncId = (Select SyncId From SyncStatus with(nolock) where SyncStatus = 1 )  
     
   End  
   Else      
   Begin  
      
    Update Cs2Cn_Prk_DBUnlockDetails set SyncId = (Select SyncId - 1 From SyncStatus with(nolock))  
     
   End  
  End  
  Else  
  Begin  
   Update Cs2Cn_Prk_DBUnlockDetails set SyncId = 0  
  End   
    
    
     
  Update Cs2Cn_Prk_DBUnlockDetails set HotFixId = (Select  IsNull(Max(FixID),0) From Hotfixlog with(nolock))  
     
  Update Cs2Cn_Prk_DBUnlockDetails set IPAddress = (Select IPAddress From SyncAttempt with(nolock))  
     
  Update Cs2Cn_Prk_DBUnlockDetails set DBUnlockStatus = (Select DbStatus From DefendRestore with(nolock))  
   
  Update DefendRestore set ReqId = 999  
    
  Select Distinct   
   DistCode,  
   SyncId,  
   HotFixId,  
   IPAddress,  
   Reason,  
   Remarks,  
   DBUnlockStatus,  
   UploadDate,  
   UploadFlag   
  From Cs2Cn_Prk_DBUnlockDetails with(nolock) for xml auto  
   
 End  
 If @TypeId = 5  
 Begin  
   
  Select * From Configuration with(nolock) Where ModuleId='DATATRANSFER44' AND ModuleName='DataTransfer'  
    
 End  
 If @TypeId = 6  
 Begin   
    
  Select * From Configuration with(nolock) Where ModuleId='DATATRANSFER45' AND ModuleName='DataTransfer'  
    
 End  
 If @TypeId = 7  
 Begin   
    
  If (@DBStatus = 0)  
  Begin  
   Update DefendRestore set DBStatus = @DBStatus,ReqId = 0  
  End  
  Else  
  Begin  
   Update DefendRestore set DBStatus = @DBStatus  
  End  
    
 End  
 If @TypeId = 8  
 Begin   
    
  If ((Select Count(*) from SyncStatus with(nolock)) > 0)  
  Begin  
     
   If ((Select Count(*) from SyncStatus with(nolock) where SyncStatus = 1 ) > 0)  
   Begin  
      
    Select SyncId From SyncStatus with(nolock) where SyncStatus = 1   
     
   End  
   Else      
   Begin  
      
    Select SyncId - 1 From SyncStatus with(nolock)  
     
   End  
  End  
  Else  
  Begin  
   Select 0  
  End    
 End  
 If @TypeId = 9  
 Begin   
  Truncate table DefendRestore  
 End  
End  
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Cs2Cn_Prk_RetailerMasterDBUnlock]') AND type in (N'U'))
DROP TABLE [dbo].[Cs2Cn_Prk_RetailerMasterDBUnlock]
GO
CREATE TABLE [dbo].[Cs2Cn_Prk_RetailerMasterDBUnlock](
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [varchar](100) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ProcessName] [varchar](100) NULL,
	[ProcessDate] [datetime] NULL,
	[Master] [varchar](100) NULL,
	[Column1] [varchar](100) NULL,
	[Column2] [varchar](100) NULL,
	[Column3] [varchar](100) NULL,
	[Column4] [varchar](100) NULL,
	[Column5] [varchar](100) NULL,
	[Column6] [varchar](100) NULL,
	[Column7] [varchar](100) NULL,
	[Column8] [varchar](100) NULL,
	[Column9] [varchar](100) NULL,
	[Column10] [varchar](100) NULL,
	[Column11] [varchar](100) NULL,
	[Column12] [varchar](100) NULL,
	[Column13] [varchar](100) NULL,
	[Column14] [varchar](100) NULL,
	[Column15] [varchar](100) NULL,
	[Column16] [varchar](100) NULL,
	[Column17] [varchar](100) NULL,
	[Column18] [varchar](100) NULL,
	[Column19] [varchar](100) NULL,
	[Column20] [varchar](100) NULL,
	[Column21] [varchar](100) NULL,
	[Column22] [varchar](100) NULL,
	[Column23] [varchar](100) NULL,
	[Column24] [varchar](100) NULL,
	[Column25] [varchar](100) NULL,
	[Column26] [varchar](100) NULL,
	[Column27] [varchar](100) NULL,
	[Column28] [varchar](100) NULL,
	[Column29] [varchar](100) NULL,
	[Column30] [varchar](100) NULL,
	[Column31] [varchar](100) NULL,
	[Column32] [varchar](100) NULL,
	[Column33] [varchar](100) NULL,
	[Column34] [varchar](100) NULL,
	[Column35] [varchar](100) NULL,
	[Column36] [varchar](100) NULL,
	[Column37] [varchar](100) NULL,
	[Column38] [varchar](100) NULL,
	[Column39] [varchar](100) NULL,
	[Column40] [varchar](100) NULL,
	[Column41] [varchar](100) NULL,
	[Column42] [varchar](100) NULL,
	[Column43] [varchar](100) NULL,
	[Column44] [varchar](100) NULL,
	[Column45] [varchar](100) NULL,
	[Column46] [varchar](100) NULL,
	[Column47] [varchar](100) NULL,
	[Column48] [varchar](100) NULL,
	[Column49] [varchar](100) NULL,
	[Column50] [varchar](100) NULL,
	[UploadFlag] [varchar](1) NULL
) ON [PRIMARY]
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_Retailer_DBUnlock]') AND type in (N'P'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_Retailer_DBUnlock]
GO
/*
BEGIN TRANSACTION
delete  from Cs2Cn_Prk_Retailer_DBUnlock
EXEC Proc_Cs2Cn_Retailer_DBUnlock 0,'2014-08-25',10
SELECT * FROM Cs2Cn_Prk_Retailer_DBUnlock (NOLOCK) Order by Rtrid
--select * from retailerapprovalstatus 
ROLLBACK TRANSACTION 
*/
CREATE PROCEDURE  [dbo].[Proc_Cs2Cn_Retailer_DBUnlock]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME,
	@SyncId INT
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
SET NOCOUNT ON
BEGIN
	DECLARE @CmpID 		AS INTEGER
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	DELETE FROM Cs2Cn_Prk_Retailer_DBUnlock WHERE UploadFlag = 'Y'
	SELECT @CmpID = CmpId FROM Company(NOLOCK) WHERE DefaultCompany = 1	
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)
	IF EXISTS(SELECT * FROM Retailer WHERE RtrOffPhone2 IS NULL)
	BEGIN
		UPDATE Retailer SET RtrOffPhone2 = '0' WHERE RtrOffPhone2 IS NULL
	END
	
	IF EXISTS(SELECT * FROM Retailer WHERE LTRIM(RTRIM(RtrOffPhone2 ))='')
	BEGIN
		UPDATE Retailer SET RtrOffPhone2 = '0' WHERE LTRIM(RTRIM(RtrOffPhone2 ))=''
	END
	
	INSERT INTO Cs2Cn_Prk_Retailer_DBUnlock
	(  
	    Processname,
		DistCode ,
		RtrId ,
		RtrCode ,
		CmpRtrCode ,
		RtrName ,
		RtrAddress1,
		RtrAddress2,
		RtrAddress3,
		RtrPINCode,
		RtrChannelCode ,
		RtrGroupCode ,
		RtrClassCode ,
		[Status],
		KeyAccount,
		RelationStatus,
		ParentCode,
		RtrRegDate,
		GeoLevel,
		GeoLevelValue,
		VillageId,
		VillageCode,
		VillageName,
		Mode,
        DrugLNo,
        RtrFrequency,
        RtrPhoneNo,
        RtrTINNumber,			
		UploadFlag,
		Approved,
		EmailId	  ,
		ContactPerson ,
		[TaxType] ,
		[RetailerMobileNumber],
		CreditBills,           
		CreditDays ,
		CreditLimit,
		Remarks1,
		AutoClass,
		RtrType
	)
	SELECT DISTINCT
	    'Master',
		@DistCode ,
		R.RtrId ,
		R.RtrCode ,
		R.CmpRtrCode ,
		R.RtrName ,
		R.RtrAdd1 ,
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		'' CtgCode ,
		'' CtgCode ,
		'' ValueClassCode ,
		RtrStatus,	
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','New',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),'N',(CASE ISNULL(Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
		ISNULL(R.RtrEmailId,''),ISNULL(R.RtrContactPerson,''),CASE ISNULL(R.RtrTaxType,0) WHEN 0 THEN 'VAT' ELSE 'NONVAT' END,
		ISNULL(R.RtrOffPhone2,0),ISNULL(R.RtrCrBills,0),ISNULL(R.RtrCrDays,0),ISNULL(RtrCrLimit,0),
		(
			CASE (ISNULl(RtrNameChange,0)+ISNULL(RtrCatChange,0)+ISNULL(RtrClassChange,0)+ISNULL(RtrGeoChange,0)+ISNULL(RtrStatusChange,0)) 
			WHEN 0 THEN 'NEW RETAILER' ELSE  
			(	
				(CASE ISNULl(RtrNameChange,0) WHEN 1 THEN 'Retailer Name,' ELSE '' END)+
				(CASE ISNULL(RtrCatChange,0) WHEN 1 THEN 'Retailer Category,' ELSE '' END)+
				(CASE ISNULL(RtrClassChange,0) WHEN 1 THEN 'Retailer Class,' WHEN 2 THEN 'Retailer Auto Class Shift,' ELSE '' END)+
				(CASE ISNULL(RtrGeoChange,0) WHEN 1 THEN 'Retailer GeoGraphy, ' ELSE '' END)+
				(CASE ISNULL(RtrStatusChange,0) WHEN 1 THEN 'Retailer Status ' ELSE '' END)+'has been Changed'				
			) END
	    ) AS Remarks1,
	    (CASE RtrClassChange WHEN 2 THEN 'YES' ELSE 'NO' END) AS AutoClass,
	    (CASE ISNULL(R.RtrType,0) WHEN 1 THEN 'RETAILER' WHEN 2 THEN 'SUB STOCKIST' ELSE '' END)AS RtrType
	FROM		
		Retailer R(NOLOCK)
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE (NOLOCK)
		INNER JOIN Retailer K (NOLOCK) ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN RetailerFlagChange RFC (NOLOCK) ON R.RtrId = RFC.RtrId AND RFC.Upload = 0
	WHERE R.Upload ='Y'	--New,Approval(Existing) retailer will upload through normal process	
		
	UNION
	SELECT DISTINCT
	    'Approval',
		@DistCode ,
		RCC.RtrId,
		R.RtrCode,
		R.CmpRtrCode,
		(CASE ISNULL(RCC.Rtrname,'') WHEN '' THEN R.Rtrname ELSE RCC.Rtrname END) AS rtrname ,
		R.RtrAdd1 ,
		R.RtrAdd2 ,
		R.RtrAdd3 ,
		R.RtrPinNo ,
		'' CtgCode,
		'' CtgCode,
		'' ValueClassCode,
		(CASE ISNULL(RCC.RtrStatus,2) WHEN 2 THEN R.RtrStatus ELSE RCC.RtrStatus END) AS RtrStatus,
		CASE RtrKeyAcc WHEN 0 THEN 'NO' ELSE 'YES' END AS KeyAccount,
		CASE RtrRlStatus WHEN 2 THEN 'PARENT' WHEN 3 THEN 'CHILD' WHEN 1 THEN 'INDEPENDENT' ELSE 'INDEPENDENT' END AS RelationStatus,
		(CASE RtrRlStatus WHEN 3 THEN ISNULL(RET.RtrCode,'') ELSE '' END) AS ParentCode,
		CONVERT(VARCHAR(10),R.RtrRegDate,121),'' AS GeoLevelName,'' AS GeoName,0,'','','CR',R.RtrDrugLicNo,
		CASE RtrFrequency WHEN 0 THEN 'WEEKLY' WHEN 1 THEN 'BI-WEEKLY' WHEN 2 THEN 'FORT NIGHTLY' when 3 then 'MONTHLY' when 4 then 'DAILY' END AS RtrFrequency,
		ISNULL(RtrPhoneNo,''),ISNULL(RtrTINNo,''),'N',(CASE ISNULL(Approved,0) WHEN 0 THEN 'PENDING' WHEN 1 THEN 'APPROVED' ELSE 'REJECTED' END) AS Approved,
		ISNULL(R.RtrEmailId,''),ISNULL(R.RtrContactPerson,''),CASE ISNULL(R.RtrTaxType,0) WHEN 0 THEN 'VAT' ELSE 'NONVAT' END,
		ISNULL(R.RtrOffPhone2,0),ISNULL(R.RtrCrBills,0),ISNULL(R.RtrCrDays,0),ISNULL(RtrCrLimit,0),
		(
			CASE (ISNULl(RtrNameChange,0)+ISNULL(RtrCatChange,0)+ISNULL(RtrClassChange,0)+ISNULL(RtrGeoChange,0)+ISNULL(RtrStatusChange,0)) 
			WHEN 0 THEN 'NEW RETAILER' ELSE  
			(
				(CASE ISNULl(RtrNameChange,0) WHEN 1 THEN 'Retailer Name,' ELSE '' END)+
				(CASE ISNULL(RtrCatChange,0) WHEN 1 THEN 'Retailer Category,' ELSE '' END)+
				(CASE ISNULL(RtrClassChange,0) WHEN 1 THEN 'Retailer Class,' WHEN 2 THEN 'Retailer Auto Class Shift,' ELSE '' END)+
				(CASE ISNULL(RtrGeoChange,0) WHEN 1 THEN 'Retailer GeoGraphy, ' ELSE '' END)+
				(CASE ISNULL(RtrStatusChange,0) WHEN 1 THEN 'Retailer Status ' ELSE '' END)+'has been Changed'
			) END
		) AS Remarks1,
		(CASE RtrClassChange WHEN 2 THEN 'YES' ELSE 'NO' END) AS AutoClass,	    
	    (CASE ISNULL(R.RtrType,0) WHEN 1 THEN 'RETAILER' WHEN 2 THEN 'SUB STOCKIST' ELSE '' END)AS RtrType
	FROM
		RetailerApprovalStatus RCC(NOLOCK)			
		INNER JOIN Retailer R(NOLOCK) ON R.RtrId=RCC.RtrId
		LEFT OUTER JOIN (SELECT K.RtrCode,RE.RtrId,RE.RtrChildId FROM RetailerRelation RE(NOLOCK)
		INNER JOIN Retailer K(NOLOCK) ON RE.RtrId=K.RtrId) RET ON RET.RtrChildId=R.RtrId
		LEFT OUTER JOIN RetailerFlagChange RFC(NOLOCK) ON R.RtrId = RFC.RtrId AND RFC.Upload = 0
	WHERE RCC.Upload<>0
	
	UPDATE ETL SET ETL.RtrChannelCode=RVC.ChannelCode,ETL.RtrGroupCode=RVC.GroupCode,ETL.RtrClassCode=RVC.ValueClassCode
	FROM Cs2Cn_Prk_Retailer_DBUnlock ETL,
	(
		SELECT R.RtrId,RC1.CtgCode AS ChannelCode,RC.CtgCode  AS GroupCode ,RVC.ValueClassCode
		FROM
		RetailerValueClassMap RVCM(NOLOCK) ,
		RetailerValueClass RVC(NOLOCK)	,
		RetailerCateGOry RC(NOLOCK) ,
		RetailerCateGOryLevel RCL(NOLOCK),
		RetailerCateGOry RC1(NOLOCK),
		Retailer R(NOLOCK)  		
	WHERE
		R.Rtrid = RVCM.RtrId
		AND	RVCM.RtrValueClassId = RVC.RtrClassId
		AND	RVC.CtgMainId=RC.CtgMainId
		AND	RCL.CtgLevelId=RC.CtgLevelId
		AND	RC.CtgLinkId = RC1.CtgMainId
	) AS RVC
	WHERE ETL.RtrId=RVC.RtrId  
	
	UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoCode
	FROM Cs2Cn_Prk_Retailer_DBUnlock ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoCode,'') AS GeoCode
		FROM			
		Retailer R (NOLOCK) 		
		LEFT OUTER JOIN Geography G(NOLOCK) ON R.GeoMainId=G.GeoMainId
		LEFT OUTER JOIN GeographyLevel GL(NOLOCK) ON GL.GeoLevelId=G.GeoLevelId
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId	
	UPDATE ETL SET ETL.VillageId=V.VillageId,ETL.VillageCode=V.VillageCode,ETL.VillageName=V.VillageName
	FROM Cs2Cn_Prk_Retailer_DBUnlock ETL,
	(
		SELECT R.RtrId,R.VillageId,V.VillageCode,V.VillageName
		FROM			
		Retailer R (NOLOCK) 		
		INNER JOIN RouteVillage V(NOLOCK) ON R.VillageId=V.VillageId
	) V
	WHERE ETL.RtrId=V.RtrId
	
		UPDATE ETL SET ETL.GeoLevel=Geo.GeoLevelName,ETL.GeoLevelValue=Geo.GeoCode
	FROM Cs2Cn_Prk_Retailer_DBUnlock ETL,
	(
		SELECT R.RtrId,ISNULL(GL.GeoLevelName,'City') AS GeoLevelName,
		ISNULL(G.GeoCode,'') AS GeoCode
		FROM			
		RetailerApprovalStatus  R (NOLOCK) 		
		LEFT OUTER JOIN Geography G(NOLOCK) ON R.GEOID=G.GeoMainId
		LEFT OUTER JOIN GeographyLevel GL(NOLOCK) ON GL.GeoLevelId=G.GeoLevelId
		WHERE R.Geoid <>0
	) AS Geo
	WHERE ETL.RtrId=Geo.RtrId and ETL.Processname='Approval'	
	 --till here 
	 
	
	UPDATE ETL SET  ETL.RtrChannelCode=ChannelCode,ETL.RtrGroupCode = X.CtgCode,ETL.RtrClassCode = X.ValueClassCode FROM Cs2Cn_Prk_Retailer_DBUnlock ETL INNER JOIN
	(
	SELECT DISTINCT A.RtrId,B1.Ctgcode ChannelCode,B.CtgCode,C.ValueClassCode FROM RetailerApprovalStatus A(NOLOCK),
	RetailerCategory B(NOLOCK),RetailerValueClass C(NOLOCK),Retailercategory B1 (NOLOCK)
    WHERE A.RtrCtgId = B.CtgMainId AND A.RtrClassId = C.RtrClassId AND B.CtgMainId = C.CtgMainId --AND Upload = 0
    AND B1.ctgmainid =B.CtgLinkId
    AND RtrCtgId <> 0 AND A.RtrClassId <> 0
    )X 
    ON ETL.RtrId = X.RtrId AND ETL.Mode = 'CR' and ETL.Processname='Approval'	
	UPDATE A SET  A.TownType = ISNULL(Z.ColumnValue,'')
	FROM Cs2Cn_Prk_Retailer_DBUnlock A 
	LEFT OUTER JOIN
	(
		SELECT C.* FROM UDCHd A(Nolock),UDCMaster B(NOLOCK),UDCDetails C(NOLOCK)
		WHERE A.MasterId = B.MasterId AND UPPER(A.MasterName) = 'RETAILER MASTER' AND UPPER(B.ColumnName)='TOWN TYPE' AND 
		B.UDCMasterId = C.UdcMasterId AND A.MasterId = C.MasterId
	) Z ON A.RtrId = Z.MasterRecordId
	
	UPDATE Cs2Cn_Prk_Retailer_DBUnlock SET Mode='CR' WHERE Autoclass='YES'
	UPDATE Cs2Cn_Prk_Retailer_DBUnlock SET Remarks1 = 'MIGRATED RETAILER' WHERE CmpRtrCode NOT LIKE @DistCode +'%'
	UPDATE Cs2Cn_Prk_Retailer_DBUnlock SET ServerDate=@ServerDate
	UPDATE Cs2Cn_Prk_Retailer_DBUnlock SET SyncId=@SyncId 	
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_Route_DBUnlock]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_Route_DBUnlock]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_Route_DBUnlock 0,'2015-10-07',10
SELECT * FROM Cs2Cn_Prk_Route_DBUnlock ORDER BY SlNo
SELECT * FROM RouteMaster
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE  [dbo].[Proc_Cs2Cn_Route_DBUnlock]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME,
	@SyncId INT
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
SET NOCOUNT ON
BEGIN

	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	DELETE FROM Cs2Cn_Prk_Route_DBUnlock WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor
	INSERT INTO Cs2Cn_Prk_Route_DBUnlock
	(   
	Processname,
		DistCode,
		RMId,
		RMCode,
		RMName,
		Distance,
		RMPopulation,
		VanRoute,
		RouteType,
		LocalUpCountry,
		GeoLevel,
		GeoValue,
		Status,
		MonDay,
		TuesDay,
		WednesDay,
		ThursDay,
		FriDay,
		SaturDay,
		SunDay,
		UploadFlag
	)
	SELECT
	'Master',
		@DistCode,
		RM.RMId,
		RM.RMCode,
		RM.RMName,
		RM.RMDistance,
		RM.RMPopulation,
		RM.RMVanRoute,
		RM.RMSRouteType,
		RM.RMLocalUpcountry,
		'' AS GeoLevel,
		'' AS GeoValue,
		(CASE RM.RMstatus WHEN 0 THEN 'InActive' ELSE 'Active' END) AS Status,
		(CASE RM.RMMon WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMTue WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMWed WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMThu WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMFri WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMSat WHEN 1 THEN 'Yes' ELSE 'No' END),
		(CASE RM.RMSun WHEN 1 THEN 'Yes' ELSE 'No' END),		
		'N'				
	FROM		
		RouteMaster RM
	
	UPDATE A SET A.GeoLevel=B.GeoLevelName,A.GeoValue=B.GeoCode
	FROM Cs2Cn_Prk_Route_DBUnlock A,
	(SELECT RM.RMId,GL.GeoLevelName,G.GeoCode FROM RouteMaster RM,Geography G,GeographyLevel GL
	WHERE RM.GeoMainId=G.GeoMainId AND G.GeoLevelId=GL.GeoLevelId AND RM.Upload='N') B
	WHERE A.RMid=B.RMId
	
	UPDATE Cs2Cn_Prk_Route_DBUnlock SET ServerDate=@ServerDate
	UPDATE Cs2Cn_Prk_Route_DBUnlock SET SyncId=@SyncId	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_RetailerRoute_DBUnlock]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_RetailerRoute_DBUnlock]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_RetailerRoute_DBUNlock 0,'2015-10-07',10
SELECT * FROM Cs2Cn_Prk_RetailerRoute_DBUnlock ORDER BY SlNo
--SELECT * FROM RetailerMarket
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE  [dbo].[Proc_Cs2Cn_RetailerRoute_DBUnlock]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME,
	@SyncId INT
)
AS
SET NOCOUNT ON
BEGIN
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	DELETE FROM Cs2Cn_Prk_RetailerRoute_DBUnlock WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor
	INSERT INTO Cs2Cn_Prk_RetailerRoute_DBUnlock
	(   
	    ProcessName ,
		DistCode	,
		RtrId		,
		RtrCode		,
		RtrName		,
		RMId		,
		RMCode		,
		RMName		,
		RouteType	,
		UploadFlag	
	)
	SELECT 'Master', @DistCode,RtrId,CmpRtrCode,RtrName,RMId,RMCode,RMName,RouteType,'N' 
	FROM 
	(
		SELECT RMK.RtrId,R.CmpRtrCode,R.RtrName,RMK.RMId,RM.RMCode,RM.RMName,'Sales Route' AS RouteType 
		FROM RetailerMarket RMK,Retailer R,RouteMaster RM
		WHERE R.RtrId=RMK.RtrId AND RMK.RMId=RM.RMId --AND RMK.Upload=0
		UNION ALL
		SELECT R.RtrId,R.CmpRtrCode,R.RtrName,R.RMId,RM.RMCode,RM.RMName,'Delivery Route' AS RouteType  
		FROM Retailer R,RouteMaster RM
		WHERE RM.RMId=R.RMId --AND R.RtrId IN (SELECT RtrId FROM RetailerMarket WHERE Upload=0)
	)
	AS A
	ORDER BY RtrId,CmpRtrCode,RtrName,RMId,RMCode,RMName,RouteType 
	
	UPDATE Cs2Cn_Prk_RetailerRoute_DBUnlock SET ServerDate=@ServerDate
	UPDATE Cs2Cn_Prk_RetailerRoute_DBUnlock SET SyncId=@SyncId	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_Salesman_DBUnlock]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_Salesman_DBUnlock]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_Salesman_DBUnlock 0,'2015-11-05',10
SELECT * FROM Cs2Cn_Prk_Salesman_DBUnlock ORDER BY SlNo
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE  [dbo].[Proc_Cs2Cn_Salesman_DBUnlock]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME,
	@SyncId INT
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
SET NOCOUNT ON
BEGIN
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	DELETE FROM Cs2Cn_Prk_Salesman_DBUnlock WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor
	INSERT INTO Cs2Cn_Prk_Salesman_DBUnlock
	(   
	    ProcessName ,
		DistCode,
		SMId,
		SMCode,
		SMName,
		SMPhoneNo,
		SMEmail,
		SMOtherDetails,
		SMDailyAllowance,
		SMMonthlySalary,
		SMMktCredit,
		SMCreditDays,
		Status,
		RMId,
		RMCode,
		RMName,
		UploadFlag
	)
	SELECT
	    'Master',
		@DistCode,
		SM.SMId,
		SM.SMCode,
		SM.SMName,
		SM.SMPhoneNumber,
		SM.SMEmailID,
		SM.SMOtherDetails,
		SM.SMDailyAllowance,
		SM.SMMonthlySalary,
		SM.SMMktCredit,
		SM.SMCreditDays,
		(CASE SM.Status WHEN 0 THEN 'InActive' ELSE 'Active' END) AS Status,
		ISNULL(SMR.RMId,0) AS RMId,
		ISNULL(RM.RMCode,'') AS RMCode,
		ISNULL(RM.RMName,'') AS RMName,
		'N'				
	FROM		
		Salesman SM LEFT OUTER JOIN  SalesmanMarket SMR
		ON SM.SMId=SMR.SMId
		LEFT OUTER JOIN  RouteMaster RM ON SMR.RMId=RM.RMId
	
	
	UPDATE Cs2Cn_Prk_Salesman_DBUnlock SET ServerDate=@ServerDate
	UPDATE Cs2Cn_Prk_Salesman_DBUnlock SET SyncId=@SyncId	
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_UDCDetails_DBUnlock]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_UDCDetails_DBUnlock]
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_UDCDetails_DBUnlock 0,'2015-10-07',10
SELECT * FROM Cs2Cn_Prk_UDCDetails_DBUnlock ORDER BY SlNo
--SELECT * FROM Retailer
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE  [dbo].[Proc_Cs2Cn_UDCDetails_DBUnlock]
(
	@Po_ErrNo	INT OUTPUT,
	@ServerDate DATETIME,
	@SyncId INT
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
SET NOCOUNT ON
BEGIN
	DECLARE @DistCode	As nVarchar(50)
	
	SET @Po_ErrNo=0
	DELETE FROM Cs2Cn_Prk_UDCDetails_DBUnlock WHERE UploadFlag = 'Y'
	
	SELECT @DistCode = DistributorCode FROM Distributor
	INSERT INTO Cs2Cn_Prk_UDCDetails_DBUnlock
	(   
	    ProcessName,
		DistCode,
		MasterId,
		MasterName,
		MasterValueCode,
		MasterValueName,
		ColumnName,
		ColumnValue,
		UploadFlag		
	)
	SELECT 'Master',@DistCode,UD.MasterId,UH.MasterName,SM.SMCode,SM.SMName,UM.ColumnName,UD.ColumnValue,'N' 
	FROM UDCDetails UD,UdcHd UH,UDCMaster UM,Salesman SM
	WHERE UD.MasterId=UH.MasterId AND UD.UdcMasterId=UM.UdcMasterId
	AND UD.MasterRecordId=SM.SMId AND UD.MasterId=4 AND UD.Upload=0
	
	UNION ALL
	SELECT 'Master' ,@DistCode,UD.MasterId,UH.MasterName,R.CmpRtrCode,R.RtrName,UM.ColumnName,UD.ColumnValue,'N'
	FROM UDCDetails UD,UdcHd UH,UDCMaster UM,Retailer R
	WHERE UD.MasterId=UH.MasterId AND UD.UdcMasterId=UM.UdcMasterId
	AND UD.MasterRecordId=R.RtrId AND UD.MasterId=2 AND UD.Upload=0
	UPDATE Cs2Cn_Prk_UDCDetails_DBUnlock SET ServerDate=@ServerDate
	UPDATE Cs2Cn_Prk_UDCDetails_DBUnlock SET SyncId=@SyncId	
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RetailerFlagChange]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[RetailerFlagChange](
	[RtrId] [numeric](18, 0) NULL,
	[RtrNameChange] [tinyint] NULL,
	[RtrCatChange] [tinyint] NULL,
	[RtrClassChange] [tinyint] NULL,
	[RtrGeoChange] [tinyint] NULL,
	[RtrStatusChange] [tinyint] NULL,
	[Upload] [tinyint] NULL
) ON [PRIMARY]
END
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RetailerApprovalStatus]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[RetailerApprovalStatus](
	[RtrId] [numeric](18, 0) NULL,
	[RtrCtgId] [bigint] NULL,
	[RtrClassId] [bigint] NULL,
	[RtrStatus] [tinyint] NULL,
	[Rtrname] [nvarchar](50) NULL,
	[Geoid] [int] NULL,
	[Upload] [tinyint] NULL,
	[Mode] [tinyint] NULL,
	[ModDate] [datetime] NULL
) ON [PRIMARY]
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RetailerUploadDBUnlock]') AND type in (N'P'))
DROP PROCEDURE [dbo].[Proc_RetailerUploadDBUnlock]
GO
/*
BEGIN TRANSACTION
--delete from Cs2Cn_Prk_RetailerMasterDBUnlock
exec Proc_RetailerUploadDBUnlock 0,'2015-10-06'
select * from Cs2Cn_Prk_RetailerMasterDBUnlock(NOLOCK)  WHERE Processname Like '%route%' order by slno
ROLLBACK TRANSACTION
*/
CREATE Procedure [dbo].[Proc_RetailerUploadDBUnlock]
(
@Po_ErrNo INT OUTPUT,
@ServerDATe DATETIME
)
AS
/*************************************************************
* Procedure	: Proc_SyncIdGeneration
* PURPOSE	: To Generate SyncId 
* CREATED BY	: Praveenraj B
* CREATED DATE	: 18/07/2012
*************************************************************/
/*
***********************************************
* DATE       AUTHOR     CR/BZ USER STORY ID           DESCRIPTION                         
*************************************************
25/09/2017  Gowsalya S   CR          CCONSPAR0176           New Sync Exe changes
*/ 
SET NOCOUNT ON
BEGIN
BEGIN TRY        
      SET @Po_ErrNo=0
      RETURN
SET XACT_ABORT ON        
BEGIN TRANSACTION  	
	declare @SqlStr varchar(8000)
	declare @Process varchar(100)
	declare @colcount int
	declare @Col varchar(5000)
	declare @Tablename varchar(100)
	declare @Sequenceno int
	declare @Lvar int
	declare @MaxId int
	Declare @DistCode Varchar(100)
	Declare @SyncId Int
	SET @Po_ErrNo=0
	
	Select @SyncId = Max(SyncId) From SyncStatus (NOLOCK)
	EXEC Proc_Cs2Cn_Retailer_DBUnlock       @Po_ErrNo,@ServerDATe,@SyncId
	EXEC Proc_Cs2Cn_Route_DBUnlock          @Po_ErrNo,@ServerDATe,@SyncId
	EXEC  Proc_Cs2Cn_Salesman_DBUnlock      @Po_ErrNo,@ServerDATe,@SyncId
	EXEC Proc_Cs2Cn_RetailerRoute_DBUNlock  @Po_ErrNo,@ServerDATe,@SyncId
	EXEC Proc_Cs2Cn_UDCDetails_DBUnlock     @Po_ErrNo,@ServerDATe,@SyncId
	
 	Create table #ProcessDBUnlock(ProcessName varchar(100),PrkTableName varchar(100), id int identity(1,1) )
	insert into #ProcessDBUnlock(ProcessName , PrkTableName)
	 select ProcessName, PrkTableName+'_DBUnlock' from Tbl_UploadIntegration WHERE 
	 Processname in('Route','Retailer','Salesman','Retailer Route','UDC Details')order by Sequenceno
	 
	Select @DistCode = DistributorCode From Distributor 
	
	--Delete A From Cs2Cn_Prk_RetailerMasterDBUnlock A (nolock) Where SyncId <> (Select ISNULL(MAX(SyncId),0) From SyncStatus)
	
	--Delete A From Cs2Cn_Prk_RetailerMasterDBUnlock A (nolock) Where SyncId = (Select ISNULL(MAX(SyncId),0) From SyncStatus WHERE SyncStatus=1) AND UploadFlag='Y'
	 
	IF ((Select Count(*) From Cs2Cn_Prk_RetailerMasterDBUnlock (nolock)) = 0)
	Begin
		Truncate Table Cs2Cn_Prk_RetailerMasterDBUnlock
	End	
	
	set @Lvar = 1
select @MaxId = Max(id) from #ProcessDBUnlock
while @Lvar <= @MaxId
begin
	select @Tablename = PrkTableName, @Process = ProcessName  from #ProcessDBUnlock where id  = @Lvar
	select @colcount = Max(Column_ID) from sys.columns where object_id = (select object_id from sys.objects where name = @Tablename)
	set @SqlStr = ''
	set @SqlStr = @SqlStr + ' Insert into Cs2Cn_Prk_RetailerMasterDBUnlock '
	set @Col = ''
	select @Col = @Col + name + ',' from sys.columns 
	where object_id = ( select object_id from sys.objects where name = 'Cs2Cn_Prk_RetailerMasterDBUnlock')
	and column_id  between 2 and @colcount + 5
	set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ',UploadFlag)'
	set @Col = ''
	
	select @Col = @Col + (Case when (name = 'UploadedDate' Or name = 'ServerDate') Then  'CONVERT(VARCHAR(19),[' + name + '],121)' else 'REPLACE(['+name + '],'''''''','''')'  end)+ ',' from sys.columns 
	where Object_Id = ( select Object_Id from sys.objects where name = @Tablename)
	and column_id  <= @colcount
	set @SqlStr = @SqlStr + 'Select '''+ CONVERT(Varchar(50),@DistCode) + ''','+ CONVERT(Varchar(50),@SyncId) + ',''' + @Process + ''' ,getdate(), '
    set @SqlStr = @SqlStr + ' ' + left(@Col,len(@Col)-1)  + ',''N'' from ' + @Tablename + '(nolock) where UploadFlag = ''N''  And SyncId Is Not Null  Order By SlNo '
	--Print(@SqlStr)
	exec (@SqlStr)
	set @SqlStr = ''
	set @SqlStr = @SqlStr + ' Update B Set B.UploadFlag = ''Y'' From Cs2Cn_Prk_RetailerMasterDBUnlock A (Nolock),  ' + @Tablename  + ' B (nolock) '
	set @SqlStr = @SqlStr + ' Where A.DistCode = B.DistCode and a.SyncId = b.SyncId and A.ProcessName = ''' + @Process + '''  And A.SyncId Is Not Null '
	exec (@SqlStr)
	--Print(@SqlStr)
	set @SqlStr = ''
	
set @Lvar = @Lvar + 1
end
Select Count(1) From Cs2Cn_Prk_RetailerMasterDBUnlock (Nolock) where Uploadflag<>'Y'
COMMIT TRANSACTION        
END TRY        
BEGIN CATCH        
ROLLBACK TRANSACTION        
	INSERT INTO DbUnlock_ErrorLog VALUES ('Proc_RetailerUploadDBUnlock', ERROR_MESSAGE(), GETDATE())        	
END CATCH  	
END
GO
Update A Set VersionId ='PV.2.6.0' from UtilityProcess A Where Procid =3
GO
--GOWSALYA.S TILL HERE
--Added By Gopi.R
IF NOT EXISTS(SELECT S.Name FROM SYSOBJECTS S INNER JOIN SYSCOLUMNS SS ON S.ID=SS.id
WHERE S.XTYPE='U' and S.name='Distributor' and SS.name='ActualDistributorCode')
BEGIN
	ALTER TABLE Distributor ADD ActualDistributorCode nVarchar(40)
END
GO
UPDATE Distributor SET ActualDistributorCode=DistributorCode WHERE ActualDistributorCode IS NULL
GO
IF EXISTS(SELECT S.Name FROM SYSOBJECTS S INNER JOIN SYSCOLUMNS SS ON S.ID=SS.id
WHERE S.XTYPE='U' and S.name='Distributor' and SS.name='ActualDistributorCode')
BEGIN
	DELETE FROM DefendRestore
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Tbl_DownloadIntegration_BEFOREDistCodeSwap' AND xtype='U')
BEGIN
	SELECT * INTO Tbl_DownloadIntegration_BEFOREDistCodeSwap FROM Tbl_DownloadIntegration
END
GO
IF NOT EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='CustomUpdownload_BEFOREDistCodeSwap' AND xtype='U')
BEGIN
	SELECT * INTO CustomUpdownload_BEFOREDistCodeSwap FROM CustomUpdownload
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Cn2Cs_Prk_DistributorCodeSwaping' and XTYPE='U')
DROP TABLE Cn2Cs_Prk_DistributorCodeSwaping
GO
CREATE TABLE Cn2Cs_Prk_DistributorCodeSwaping
(
DistCode Nvarchar(50),
OldDistCode Nvarchar(50),
NewDistCode Nvarchar(50),
DownLoadFlag Nvarchar(5),
CreatedDate Datetime
)
GO
IF NOT EXISTS (SELECT * FROM Sysobjects Where name='DistributorCodeSwaping' and XTYPE='U')
BEGIN
CREATE TABLE [DistributorCodeSwaping]
(
	[OldDistCode] [nvarchar](50) NULL,
	[NewDistCode] [nvarchar](50) NULL,
	[DownloadDate] [datetime] NULL,
	[ValidateDate] [datetime] NULL,
	UpdatedFlag Varchar(2)
)
END
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS S INNER JOIN SYSCOLUMNS SS ON S.id=SS.id  
WHERE S.XTYPE='U' AND S.NAME='DistributorCodeSwaping' and SS.name='UpdatedFlag')
BEGIN
ALTER TABLE DistributorCodeSwaping ADD 	UpdatedFlag Varchar(2)
END
UPDATE DistributorCodeSwaping SET UpdatedFlag='N' WHERE UpdatedFlag IS NULL
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Proc_Import_DistributorCodeSwaping' and XTYPE='P')
DROP PROCEDURE Proc_Import_DistributorCodeSwaping
GO
CREATE PROCEDURE Proc_Import_DistributorCodeSwaping
(
	@Pi_Records NTEXT
)
AS
/************************************************
* PROCEDURE  : Proc_Import_DistributorCodeSwaping
* PURPOSE    : To Download Distributor Code Swapping
* CREATED BY : Gopi
* CREATED ON : 27-11-2017
* MODIFICATION
***********************************************************************
* DATE       AUTHOR     CR/BZ  USER STORY ID     DESCRIPTION                         
***************************************************************************
27/11/2017  Gopi        CR     CCRSTPAR0173      To download Distributor Code Swapping details
*/
SET NOCOUNT ON
BEGIN
	DECLARE @hDoc INTEGER
	
	EXEC sp_xml_preparedocument @hDoc OUTPUT,@Pi_Records
	INSERT INTO Cn2Cs_Prk_DistributorCodeSwaping
	(
		DistCode,
		OldDistCode,
		NewDistCode,
		DownLoadFlag,
		CreatedDate
	)
	SELECT DistCode,
		OldDistCode,
		NewDistCode,
		ISNULL(DownLoadFlag,'D'),
		GETDATE()
	FROM OPENXML (@hdoc,'/Root/Console2CS_DistributorCodeSwaping',1)
	WITH
	(
		DistCode 	 [nvarchar](50),
	    OldDistCode  [nvarchar](50),
		NewDistCode  [nvarchar](50),
		DownLoadFlag [nvarchar](10)
	) XMLObj
	EXEC sp_xml_removedocument @hDoc
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cn2Cs_DistributorCodeSwaping')
DROP PROCEDURE Proc_Cn2Cs_DistributorCodeSwaping
GO
/*
BEGIN TRAN
SELECT dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))	
INSERT INTO Cn2Cs_Prk_DistributorCodeSwaping
SELECT '4171','4171','2525','D',getdate()
SELECT * FROM Cn2Cs_Prk_DistributorCodeSwaping
EXEC Proc_Cn2Cs_DistributorCodeSwaping 0
SELECT * FROM DISTRIBUTOR
SELECT dbo.Fn_GetPrimaryKeyCmpString('Retailer','CmpRtrCode',CAST(YEAR(GetDate()) AS INT),MONTH(GETDATE()))	
ROLLBACK TRAN
*/
CREATE PROCEDURE [Proc_Cn2Cs_DistributorCodeSwaping]
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/************************************************
* PROCEDURE  : Proc_Cn2Cs_DistributorCodeSwaping
* PURPOSE    : To Validate the Download Distributor Code Swapping
* CREATED BY : Gopi
* CREATED ON : 27-11-2017
* MODIFICATION
***********************************************************************
* DATE       AUTHOR     CR/BZ  USER STORY ID     DESCRIPTION                         
***************************************************************************
27/11/2017  Gopi        CR     CCRSTPAR0173      To download Distributor Code Swapping details
*/
SET NOCOUNT ON  
BEGIN    
 SET @Po_ErrNo=0   
 DECLARE @DistCode AS VARCHAR(50)   
 DECLARE @OldDistCode AS Nvarchar(50)
 DECLARE @NewDistCode AS Nvarchar(50)
 SET @DistCode=''  
 DELETE FROM Cn2Cs_Prk_DistributorCodeSwaping WHERE DownloadFlag='Y'
 IF NOT EXISTS(SELECT '*' FROM Cn2Cs_Prk_DistributorCodeSwaping WHERE DownLoadFlag='D')  
 BEGIN  
  RETURN  
 END  
 SELECT * INTO #Cn2Cs_Prk_DistributorCodeSwaping FROM Cn2Cs_Prk_DistributorCodeSwaping WHERE DownLoadFlag='D'  
 DELETE A FROM #Cn2Cs_Prk_DistributorCodeSwaping A  
 WHERE CreatedDate<>(SELECT MAX(CreatedDate) FROM #Cn2Cs_Prk_DistributorCodeSwaping)  
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT DISTINCT 1,'Distributor Code Swapping','DistCode','Invalid Distributor' FROM #Cn2Cs_Prk_DistributorCodeSwaping A   
 WHERE NOT EXISTS(SELECT DISTRIBUTORCODE FROM Distributor B WHERE A.DISTCODE=B.DISTRIBUTORCODE)  
 DELETE A FROM  #Cn2Cs_Prk_DistributorCodeSwaping A  
 WHERE NOT EXISTS(SELECT DISTRIBUTORCODE FROM Distributor B WHERE A.DISTCODE=B.DISTRIBUTORCODE) 
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT DISTINCT 2,'Distributor Code Swapping','NewDistCode','New Distributor Code Cannot Be Empty' FROM #Cn2Cs_Prk_DistributorCodeSwaping A   
 WHERE NewDistCode=''
 DELETE  FROM  #Cn2Cs_Prk_DistributorCodeSwaping WHERE NewDistCode=''
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT DISTINCT 2,'Distributor Code Swapping','OldDistCode','Old Distributor Code Cannot Be Empty' FROM #Cn2Cs_Prk_DistributorCodeSwaping A   
 WHERE OldDistCode=''
 DELETE  FROM  #Cn2Cs_Prk_DistributorCodeSwaping WHERE OldDistCode=''

	DECLARE Cur_DistCdeSwap CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([OldDistCode])),''),ISNULL(LTRIM(RTRIM([NewDistCode])),'')
	FROM #Cn2Cs_Prk_DistributorCodeSwaping 
	OPEN Cur_DistCdeSwap
	FETCH NEXT FROM Cur_DistCdeSwap INTO @OldDistCode,@NewDistCode
	WHILE @@FETCH_STATUS=0
	BEGIN
	  UPDATE Distributor SET DistributorCode=@NewDistCode where DistributorCode=@OldDistCode
	  UPDATE ProductBatch_Temp_GST SET DistCode=@NewDistCode where DistCode=@OldDistCode
	  UPDATE Cn2cs_Prk_ProductAlliasName SET DistCode=@NewDistCode where DistCode=@OldDistCode
	  
	  UPDATE A SET A.Prefix=@NewDistCode FROM COMPANYCOUNTERS A WHERE TabName='Retailer' and FldName='CmpRtrCode'
	  
	  DELETE FROM DefendRestore
							
	FETCH NEXT FROM Cur_DistCdeSwap INTO @OldDistCode,@NewDistCode
	END
	CLOSE Cur_DistCdeSwap
	DEALLOCATE Cur_DistCdeSwap
   UPDATE Cn2Cs_Prk_DistributorCodeSwaping SET DownloadFlag='Y'
   
	INSERT INTO DistributorCodeSwaping(OldDistCode,NewDistCode,DownloadDate,ValidateDate,UpdatedFlag)
	SELECT OldDistCode,NewDistCode,CreatedDate,GETDATE() ,'N'
	FROM #Cn2Cs_Prk_DistributorCodeSwaping WHERE DownLoadFlag='D' 
 RETURN  
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cs2Cn_SyncDetails')
DROP PROCEDURE Proc_Cs2Cn_SyncDetails
GO
/*
BEGIN TRANSACTION
EXEC Proc_Cs2Cn_SyncDetails 0,'2013-05-22'
SELECT * FROM Cs2Cn_Prk_SyncDetails
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [Proc_Cs2Cn_SyncDetails]
(
	@Po_ErrNo INT OUTPUT,
	@Sever_Date AS DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_SyncDetails
* PURPOSE		: To Extract Hot Fix Details
* CREATED		: Nandakumar R.G
* CREATED DATE	: 07/06/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
	
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @CmpId 		AS INTEGER
	DECLARE @DistCode	AS NVARCHAR(50)
	DECLARE @HostName   AS NVARCHAR(200)	
	SET @Po_ErrNo=0
	
	IF EXISTS(SELECT 'X' FROM DistributorCodeSwaping (NOLOCK) WHERE UpdatedFlag='N')
	BEGIN
		UPDATE SyncStatus SET DistCode=(SELECT TOP 1 NewDistCode FROM DistributorCodeSwaping (NOLOCK) WHERE UpdatedFlag='N' ORDER BY ValidateDate DESC) , SyncStatus = 0, SyncFlag= 'N'
		DELETE FROM  SyncStatus_Download	
		UPDATE  DistributorCodeSwaping SET UpdatedFlag='Y' WHERE UpdatedFlag='N'
	END
	 
	
	SELECT @DistCode = DistributorCode FROM Distributor
	SELECT TOP 1 HostName AS HostName INTO #HostName FROM Sys.sysprocesses WHERE Status='RUNNABLE' ORDER BY Login_time DESC
	SELECT @HostName = HostName FROM #HostName WITH (NOLOCK)
	
	TRUNCATE TABLE Cs2Cn_Prk_SyncDetails
	INSERT INTO Cs2Cn_Prk_SyncDetails(DistCode,FixId,FixDate,FixVersion,SyncDate,UploadFlag,SyncId,ServerDate,HostName,UpdatedHotfixId,SyncExeVersion)
	SELECT @DistCode,H.FixId,FixedOn AS FixDate,SynVersion AS FixVersion,GETDATE(),'N',
	(SELECT ISNULL(MAX(SyncId),0) AS SYNCID FROM sync_master (NOLOCK)),@Sever_Date,@HostName,U.Fixid,
	--(Select MAX(Fixid) From UpdaterLog (Nolock)),
	(Select VersionId From UtilityProcess (Nolock) Where ProcId = 3)
	FROM AppTitle A ,HotFixLog H,UPdaterLog U WHERE H.FixID IN (SELECT ISNULL(MAX(FixId),0) FROM HotFixLog)
	AND U.FixId NOT IN (SELECT FixId FROM Hotfixupdater_Bck (NOLOCK) WHERE FixType = 'UpdaterLog')
	
	IF NOT EXISTS(SELECT * FROM Cs2Cn_Prk_SyncDetails)
	BEGIN
		INSERT INTO Cs2Cn_Prk_SyncDetails(DistCode,FixId,FixDate,FixVersion,SyncDate,UploadFlag,SyncId,ServerDate,HostName,UpdatedHotfixId,SyncExeVersion)
		SELECT @DistCode,H.FixId,FixedOn AS FixDate,SynVersion AS FixVersion,GETDATE(),'N',
		(SELECT ISNULL(MAX(SyncId),0) AS SYNCID FROM sync_master (NOLOCK)),@Sever_Date,@HostName,U.Fixid,
		--(Select MAX(Fixid) From UpdaterLog (Nolock)),
		(Select VersionId From UtilityProcess (Nolock) Where ProcId = 3)
		FROM AppTitle A ,HotFixLog H,UPdaterLog U WHERE H.FixID IN (SELECT ISNULL(MAX(FixId),0) FROM HotFixLog)
		and u.Fixid = (Select Max(fixid) from Updaterlog where Releaseon = (select MAX(ReleaseOn) from UPdaterLog))
	END
	
	INSERT INTO Hotfixupdater_Bck(Fixid,FixType)
	SELECT DISTINCT UpdatedHotfixId,'UpdaterLog' FROM Cs2Cn_Prk_SyncDetails	 A WHERE NOT EXISTS(SELECT * FROM Hotfixupdater_Bck B (NOLOCK) WHERE A.UpdatedHotfixid=B.Fixid AND B.FixType='UpdaterLog')
	
END
GO
DELETE FROM Tbl_DownloadIntegration 
INSERT INTO Tbl_DownloadIntegration([SequenceNo],[ProcessName],[PrkTableName],[SPName],[TRowCount],[SelectCount],[CreatedDate]) 
SELECT 1,'DistributorCodeSwaping','Cn2Cs_Prk_DistributorCodeSwaping','Proc_Import_DistributorCodeSwaping',0,500,CONVERT(VARCHAR(10),GETDATE(),121) UNION ALL
SELECT 2,'GSTConfiguration','Cn2Cs_Prk_GSTConfiguration','Proc_Import_GSTConfiguration',0,500,CONVERT(VARCHAR(10),GETDATE(),121) UNION ALL
SELECT 3,'StateMaster','Cn2Cs_Prk_StateMaster','Proc_Import_StateMaster',0,500,CONVERT(VARCHAR(10),GETDATE(),121) UNION ALL
SELECT 4,'Hierarchy Level','Cn2Cs_Prk_HierarchyLevel','Proc_Import_HierarchyLevel',0,500,'2011-03-22' UNION ALL
SELECT 5,'Hierarchy Level Value','Cn2Cs_Prk_HierarchyLevelValue','Proc_Import_HierarchyLevelValue',0,500,'2011-03-22' UNION ALL
SELECT 6,'Retailer Hierarchy','Cn2Cs_Prk_BLRetailerCategoryLevelValue','Proc_ImportBLRtrCategoryLevelValue',0,500,'2011-03-22' UNION ALL
SELECT 7,'Retailer Classification','Cn2Cs_Prk_BLRetailerValueClass','Proc_ImportBLRetailerValueClass',0,500,'2011-03-22' UNION ALL
SELECT 8,'Prefix Master','Cn2Cs_Prk_PrefixMaster','Proc_Import_PrefixMaster',0,500,'2011-03-22' UNION ALL
SELECT 9,'Retailer Approval','Cn2Cs_Prk_RetailerApproval','Proc_Import_RetailerApproval',0,500,'2011-03-22' UNION ALL
SELECT 10,'UOM','Cn2Cs_Prk_BLUOM','Proc_ImportBLUOM',0,500,'2011-03-22' UNION ALL
SELECT 11,'Tax Configuration Group Setting','Etl_Prk_TaxConfig_GroupSetting','Proc_ImportTaxMaster',0,500,'2011-03-22' UNION ALL
SELECT 12,'Tax Settings','Etl_Prk_TaxSetting','Proc_ImportTaxConfigGroupSetting',0,500,'2011-03-22' UNION ALL
SELECT 13,'Product Hierarchy Change','Cn2Cs_Prk_BLProductHiereachyChange','Proc_ImportBLProductHiereachyChange',0,500,'2011-03-22' UNION ALL
SELECT 14,'Product','Cn2Cs_Prk_Product','Proc_Import_Product',0,500,'2011-03-22' UNION ALL
SELECT 15,'Product Batch','Cn2Cs_Prk_ProductBatch','Proc_Import_ProductBatch',0,200,'2011-03-22' UNION ALL
SELECT 16,'Product Batch GST','Cn2Cs_Prk_ProductBatch_GST','Proc_Import_ProductBatch_GST',0,200,'2012-05-24' UNION ALL
SELECT 17,'Product Tax Mapping GST','ETL_Prk_TaxMapping_GST','Proc_ImportTaxGrpMapping_GST',0,500,'2012-06-28' UNION ALL
SELECT 18,'Product Tax Mapping','Etl_Prk_TaxMapping','Proc_ImportTaxGrpMapping',0,500,'2011-03-22' UNION ALL
SELECT 19,'Special Rate','Cn2Cs_Prk_SpecialRate','Proc_Import_SpecialRate',0,500,'2011-03-22' UNION ALL
SELECT 20,'Scheme Header Slabs Rules','Etl_Prk_SchemeHD_Slabs_Rules','Proc_ImportSchemeHD_Slabs_Rules',0,100,'2011-03-22' UNION ALL
SELECT 21,'Scheme Products','Etl_Prk_SchemeProducts_Combi','Proc_ImportSchemeProducts_Combi',0,100,'2011-03-22' UNION ALL
SELECT 22,'Scheme Attributes','Etl_Prk_Scheme_OnAttributes','Proc_ImportScheme_OnAttributes',0,100,'2011-03-22' UNION ALL
SELECT 23,'Scheme Free Products','Etl_Prk_Scheme_Free_Multi_Products','Proc_ImportScheme_Free_Multi_Products',0,100,'2011-03-22' UNION ALL
SELECT 24,'Scheme On Another Product','Etl_Prk_Scheme_OnAnotherPrd','Proc_ImportScheme_OnAnotherPrd',0,100,'2011-03-22' UNION ALL
SELECT 25,'Scheme Retailer Validation','Etl_Prk_Scheme_RetailerLevelValid','Proc_ImportScheme_RetailerLevelValid',0,100,'2011-03-22' UNION ALL
SELECT 26,'Purchase','Cn2Cs_Prk_BLPurchaseReceipt','Proc_ImportBLPurchaseReceipt',0,500,'2011-03-22' UNION ALL
SELECT 27,'Purchase Receipt Mapping','Cn2Cs_Prk_PurchaseReceiptMapping','Proc_Import_PurchaseReceiptMapping',0,500,'2011-03-22' UNION ALL
SELECT 28,'Scheme Master Control','Cn2Cs_Prk_NVSchemeMasterControl','Proc_ImportNVSchemeMasterControl',0,500,'2011-03-22' UNION ALL
SELECT 29,'Claim Norm','Cn2Cs_Prk_ClaimNorm','Proc_Import_ClaimNorm',0,500,'2011-03-22' UNION ALL
SELECT 30,'Reason Master','Cn2Cs_Prk_ReasonMaster','Proc_Import_ReasonMaster',0,500,'2011-03-22' UNION ALL
SELECT 31,'Bulletin Board','Cn2Cs_Prk_BulletinBoard','Proc_Import_BulletinBoard',0,500,'2011-03-22' UNION ALL
SELECT 32,'ERP Product Mapping','Cn2Cs_Prk_ERPPrdCCodeMapping','Proc_Import_ERPPrdCCodeMapping',0,500,'2011-03-22' UNION ALL
SELECT 33,'Configuration','Cn2Cs_Prk_Configuration','Proc_Import_Configuration',0,500,'2011-03-22' UNION ALL
SELECT 34,'Claim Settlement','Cn2Cs_Prk_ClaimSettlementDetails','Proc_Import_ClaimSettlementDetails',0,500,'2011-03-22' UNION ALL
SELECT 35,'Cluster Master','Cn2Cs_Prk_ClusterMaster','Proc_Import_ClusterMaster',0,100,'2011-03-22' UNION ALL
SELECT 36,'Cluster Group','Cn2Cs_Prk_ClusterGroup','Proc_Import_ClusterGroup',0,100,'2011-03-22' UNION ALL
SELECT 37,'Cluster Assign Approval','Cn2Cs_Prk_ClusterAssignApproval','Proc_Import_ClusterAssignApproval',0,100,'2011-03-22' UNION ALL
SELECT 38,'SupplierMaster','Cn2Cs_Prk_SupplierMaster','Proc_Import_SupplierMaster',0,100,'2011-03-22' UNION ALL
SELECT 39,'UDC Master','Cn2Cs_Prk_UDCMaster','Proc_Import_UDCMaster',0,500,'2011-03-22' UNION ALL
SELECT 40,'UDC Details','Cn2Cs_Prk_UDCDetails','Proc_Import_UDCDetails',0,500,'2011-03-22' UNION ALL
SELECT 41,'UDC Defaults','Cn2Cs_Prk_UDCDefaults','Proc_Import_UDCDefaults',0,500,'2011-03-22' UNION ALL
SELECT 42,'Retailer Migration','Cn2Cs_Prk_RetailerMigration','Proc_Import_RetailerMigration',0,500,'2011-03-22' UNION ALL
SELECT 43,'Points Rules Header','Cn2Cs_Prk_PointsRulesHeader','Proc_Import_PointsRulesHeader',0,100,'2011-03-22' UNION ALL
SELECT 44,'Points Rules Retailer','Cn2Cs_Prk_PointsRulesRetailer','Proc_Import_PointsRulesRetailer',0,100,'2011-03-22' UNION ALL
SELECT 45,'Points Rules Slab','CN2CS_Prk_PointsRulesSlab','Proc_Import_PointsRulesSlab',0,100,'2011-03-22' UNION ALL
SELECT 46,'Points Rules Slab Product','Cn2Cs_Prk_PointsRulesProduct','Proc_Import_PointsRulesSlabProduct',0,100,'2011-03-22' UNION ALL
SELECT 47,'ReUpload','Cn2Cs_Prk_ReUpload','Proc_Import_ReUpload',0,500,'2011-03-22' UNION ALL
SELECT 48,'Purchase Receipt Adjustments','Cn2Cs_Prk_PurchaseReceiptAdjustments','Proc_Import_PurchaseReceiptAdjustments',0,100,'2011-03-22' UNION ALL
SELECT 49,'Village Master','Cn2Cs_Prk_VillageMaster','Proc_Import_VillageMaster',0,100,'2011-03-22' UNION ALL
SELECT 50,'Scheme Payout','Cn2Cs_Prk_SchemePayout','Proc_Import_SchemePayout',0,100,'2011-03-22' UNION ALL
SELECT 51,'KitItem','Cn2Cs_Prk_KitProducts','Proc_ImportKitProduct',0,500,'2015-11-30' UNION ALL
SELECT 52,'SupplierCreditNote','ETL_Prk_CreditNoteSupplier','Proc_ImportCreditNoteSupplier',0,500,'2015-11-30' UNION ALL
SELECT 53,'SupplierDebitNote','ETL_Prk_DebitNoteSupplier','Proc_ImportDebitNoteSupplier',0,500,'2015-11-30' UNION ALL
SELECT 54,'MarketIntelligence','Cn2Cs_Prk_MarketIntelligenceHD','Proc_ImportMarketIntelligenceHD',0,500,'2015-11-30' UNION ALL
SELECT 55,'MarketIntelligenceDT','Cn2Cs_Prk_MarketIntelligenceDT','Proc_ImportMarketIntelligenceDT',0,500,'2015-11-30' UNION ALL
SELECT 56,'ProductUnification','CN2CS_Prk_ProductCodeUnification','Proc_Import_ProductCodeUnification',0,500,'2015-11-30' UNION ALL
SELECT 57,'Purchase With Location Code','CN2CS_Prk_PurchaseWithLocationCode','Proc_Import_PurchaseWithLocationCode',0,500,'2015-11-30' UNION ALL
SELECT 58,'SpecialDiscount','Cn2Cs_Prk_SpecialDiscount','Proc_Import_SpecialDiscount',0,500,'2015-11-30' UNION ALL
SELECT 59,'Bulletin Board Status','CN2CS_PRK_BulletinBoardStatus','PROC_IMPORT_BulletinBoardStatus',0,500,'2015-11-30' UNION ALL
SELECT 60,'KitProductCategory','Cn2Cs_Prk_KitItemRetailerCategory','Proc_Import_KitProductCategory',0,500,'2016-03-23' UNION ALL
SELECT 61,'Target Setting','Cn2Cs_Prk_InstitutionsTargetSetting','Proc_Import_InstitutionsTargetSetting',0,500,'2017-01-03' UNION ALL
SELECT 62,'InstitutionsTargetAchievement','Cn2Cs_Prk_InstitutionsTargetAchievement','Proc_Import_InstitutionsTargetAchievement',0,500,'2017-01-03' UNION ALL
SELECT 63,'RetailerCreditNote','Cn2Cs_Prk_RetailerCreditNote','Proc_Import_RetailerCreditNote',0,500,'2017-01-03' UNION ALL
SELECT 64,'SFAProductAlliasName','Cn2cs_Prk_ProductAlliasName','Proc_Import_SFAproductAlliasName',0,500,'2017-04-07' UNION ALL
SELECT 65,'DistributorInfo','Cn2Cs_Prk_DistributorInfo','Proc_Import_DistributorInfo',0,500,'2017-04-19' UNION ALL
SELECT 66,'ServiceTaxSetting','Cn2Cs_Prk_ServiceTaxSetting','Proc_Import_ServiceTaxSetting',0,500,GETDATE() UNION ALL
SELECT 67,'ServiceMaster','Cn2Cs_Prk_ServiceMaster','Proc_Import_ServiceMaster',0,500,'2017-04-19' UNION ALL
SELECT 68,'Product HSN','Cn2Cs_Prk_ProductHSNCode','Proc_Import_ProductHSNCode',0,500,'2017-04-19' UNION ALL
SELECT 69,'RetailerGST','Cn2Cs_Prk_RetailerGST','Proc_Import_RetailerGST',0,500,'2017-04-12' UNION ALL
SELECT 70,'PurchaseReturn_GST','Cn2Cs_Prk_PurchaseReturn','Proc_Import_PurchaseReturn',0,500,GETDATE()UNION ALL
SELECT 71,'ServiceClaimGroup','Cn2Cs_Prk_ServiceClaimGroup','Proc_Import_ServiceClaimGroup',0,500,getdate() UNION ALL
SELECT 72,'PurchaseinvSeriesDtGST','Cn2CS_Prk_PurchaseinvSeriesDtGST','Proc_Import_PurchaseinvSeriesDtGST',0,500,GETDATE() UNION ALL
SELECT 73,'BillSeriesDtUpdationGST','Cn2CS_Prk_BillSeriesDtUpdationGST','Proc_Import_BillSeriesDtUpdationGST',0,500,GETDATE() UNION ALL
SELECT 74,'CompanyCountersUpdationGST','Cn2CS_Prk_CompanyCountersUpdationGST','Proc_Import_CompanyCountersUpdationGST',0,500,GETDATE() UNION ALL
SELECT 75,'CountersUpdationGST','Cn2CS_Prk_CountersUpdationGST','Proc_Import_CountersUpdationGST',0,500,GETDATE() UNION ALL
SELECT 76,'ServiceInvoiceApproval','Cn2Cs_Prk_ServiceInvoiceApproval','',0,500,GETDATE() UNION ALL
SELECT 77,'SchemeCircularDetails','Cn2Cs_Prk_SchemeCircularDetails','Proc_Import_SchemeCircularDetails',0,500,GETDATE()
GO
DELETE FROM CustomUpdownload WHERE UpDownload='Download'
INSERT INTO CustomUpdownload([SlNo],[SeqNo],[Module],[Screen],[ExportFnName],[ImportProcName],[ParkTable],[ValidateProcName],[TranType],[UpDownload],[MandatoryFile])
SELECT 201,1,'DistributorCodeSwaping','DistributorCodeSwaping','','Proc_Import_DistributorCodeSwaping','Cn2Cs_Prk_DistributorCodeSwaping','Proc_Cn2Cs_DistributorCodeSwaping','Master','Download',1 UNION ALL
SELECT 202,1,'GSTConfiguration','GSTConfiguration','','Proc_Import_GSTConfiguration','Cn2Cs_Prk_GSTConfiguration','Proc_Cn2Cs_GSTConfiguration','Master','Download',1 UNION ALL
SELECT 203,1,'StateMaster','StateMaster','','Proc_Import_StateMaster','Cn2Cs_Prk_StateMaster','Proc_Cn2Cs_StateMaster','Master','Download',1 UNION ALL
SELECT 204,1,'Hierarchy Level','Hieararchy Level','Proc_Cs2Cn_HierarchyLevel','Proc_Import_HierarchyLevel','Cn2Cs_Prk_HierarchyLevel','Proc_Cn2Cs_HierarchyLevel','Master','Download',1 UNION ALL
SELECT 205,1,'Hierarchy Level Value','Hieararchy Level Value','Proc_Cs2Cn_HierarchyLevelValue','Proc_Import_HierarchyLevelValue','Cn2Cs_Prk_HierarchyLevelValue','Proc_Cn2Cs_HierarchyLevelValue','Master','Download',1 UNION ALL
SELECT 206,1,'Retailer Category Level Value','Retailer Category Level Value','Proc_CS2CNBLRetailerCategoryLevelValue','Proc_ImportBLRtrCategoryLevelValue','Cn2Cs_Prk_BLRetailerCategoryLevelValue','Proc_Cn2Cs_BLRetailerCategoryLevelValue','Master','Download',1 UNION ALL
SELECT 207,1,'Retailer Value Classification','Retailer Value Classification','Proc_CS2CNBLRetailerValueClass','Proc_ImportBLRetailerValueClass','Cn2Cs_Prk_BLRetailerValueClass','Proc_Cn2Cs_BLRetailerValueClass','Master','Download',1 UNION ALL
SELECT 208,1,'Prefix Master','Prefix Master','Proc_Cs2Cn_PrefixMaster','Proc_Import_PrefixMaster','Cn2Cs_Prk_PrefixMaster','Proc_Cn2Cs_PrefixMaster','Master','Download',1 UNION ALL
SELECT 209,1,'Retailer Aproval','Retailer Approval','Proc_Cs2Cn_RetailerApproval','Proc_Import_RetailerApproval','Cn2Cs_Prk_RetailerApproval','Proc_Cn2Cs_RetailerApproval','Master','Download',0 UNION ALL
SELECT 210,1,'UOM','UOM','Proc_Cn2Cs_BLUOM','Proc_ImportBLUOM','Cn2Cs_Prk_BLUOM','Proc_Cn2Cs_BLUOM','Master','Download',1 UNION ALL
SELECT 211,1,'Tax Configuration','Tax Configuration','Proc_ValidateTaxConfig_Group','Proc_ImportTaxMaster','Etl_Prk_TaxConfig_GroupSetting','Proc_ValidateTaxConfig_Group','Master','Download',1 UNION ALL
SELECT 212,1,'Tax Setting','Tax Setting','Proc_CN2CS_TaxSetting','Proc_ImportTaxConfigGroupSetting','Etl_Prk_TaxSetting','Proc_CN2CS_TaxSetting','Master','Download',1 UNION ALL
SELECT 213,1,'Product Hierarchy Change','Product Hierarchy Change','Proc_CS2CNBLProductHierarchyChange','Proc_ImportBLProductHiereachyChange','Cn2Cs_Prk_BLProductHiereachyChange','Proc_Cn2Cs_BLProductHiereachyChange','Master','Download',1 UNION ALL
SELECT 214,1,'Product','Product','Proc_Cs2Cn_Product','Proc_Import_Product','Cn2Cs_Prk_Product','Proc_Cn2Cs_Product','Master','Download',1 UNION ALL
SELECT 215,1,'Product Batch','Product Batch','Proc_Cs2Cn_ProductBatch','Proc_Import_ProductBatch','Cn2Cs_Prk_ProductBatch','Proc_Cn2Cs_ProductBatch','Master','Download',1 UNION ALL
SELECT 216,1,'Product Batch GST','Product Batch GST','Proc_Cs2Cn_ProductBatch','Proc_Import_ProductBatch_GST','Cn2Cs_Prk_ProductBatch_GST','Proc_Cn2Cs_ProductBatch_GST','Master','Download',1 UNION ALL
SELECT 217,1,'Tax Group Mapping','Tax Group Mapping','Proc_ValidateTaxMapping','Proc_ImportTaxGrpMapping','Etl_Prk_TaxMapping','Proc_ValidateTaxMapping','Master','Download',1 UNION ALL
SELECT 218,1,'Product Tax Mapping GST','Product Tax Mapping GST','Proc_ValidateTaxMapping_GST','Proc_ImportTaxGrpMapping_GST','ETL_Prk_TaxMapping_GST','Proc_ValidateTaxMapping_GST','Master','Download',1 union all
SELECT 219,1,'Special Rate','Special Rate','Proc_Cs2Cn_SpecialRate','Proc_Import_SpecialRate','Cn2Cs_Prk_SpecialRate','Proc_Cn2Cs_SpecialRate','Master','Download',1 UNION ALL
SELECT 220,1,'Cluster Master','Cluster Master','Proc_Cs2Cn_ClusterMaster','Proc_Import_ClusterMaster','Cn2Cs_Prk_ClusterMaster','Proc_Cn2Cs_ClusterMaster','Master','Download',1 UNION ALL
SELECT 221,1,'Cluster Group','Cluster Group','Proc_Cs2Cn_ClusterGroup','Proc_Import_ClusterGroup','Cn2Cs_Prk_ClusterGroup','Proc_Cn2Cs_ClusterGroup','Master','Download',1 UNION ALL
SELECT 222,1,'Scheme','Scheme Master','Proc_CS2CNBLSchemeMaster','Proc_ImportBLSchemeMaster','Etl_Prk_SchemeHD_Slabs_Rules','Proc_CN2CS_BLSchemeMaster','Transaction','Download',1 UNION ALL
SELECT 222,2,'Scheme','Scheme Attributes','Proc_CS2CNBLSchemeAttributes','Proc_ImportBLSchemeAttributes','Etl_Prk_Scheme_OnAttributes','Proc_CN2CS_BLSchemeAttributes','Transaction','Download',1 UNION ALL
SELECT 222,3,'Scheme','Scheme Products','Proc_CS2CNBLSchemeProducts','Proc_ImportBLSchemeProducts','Etl_Prk_SchemeProducts_Combi','Proc_CN2CS_BLSchemeProducts','Transaction','Download',1 UNION ALL
SELECT 222,4,'Scheme','Scheme Slabs','Proc_CS2CNBLSchemeSlab','Proc_ImportBLSchemeSlab','Etl_Prk_SchemeHD_Slabs_Rules','Proc_CN2CS_BLSchemeSlab','Transaction','Download',1 UNION ALL
SELECT 222,5,'Scheme','Scheme Rule Setting','Proc_CS2CNBLSchemeRulesetting','Proc_ImportBLSchemeRulesetting','Etl_Prk_SchemeHD_Slabs_Rules','Proc_CN2CS_BLSchemeRulesetting','Transaction','Download',0 UNION ALL
SELECT 222,6,'Scheme','Scheme Free Products','Proc_CS2CNBLSchemeFreeProducts','Proc_ImportBLSchemeFreeProducts','Etl_Prk_Scheme_Free_Multi_Products','Proc_CN2CS_BLSchemeFreeProducts','Transaction','Download',0 UNION ALL
SELECT 222,7,'Scheme','Scheme Combi Products','Proc_CS2CNBLSchemeCombiPrd','Proc_ImportBLSchemeCombiPrd','Etl_Prk_SchemeProducts_Combi','Proc_CN2CS_BLSchemeCombiPrd','Transaction','Download',0 UNION ALL
SELECT 222,8,'Scheme','Scheme On Another Product','Proc_CS2CNBLSchemeOnAnotherPrd','Proc_ImportBLSchemeOnAnotherPrd','Etl_Prk_Scheme_OnAnotherPrd','Proc_CN2CS_BLSchemeOnAnotherPrd','Transaction','Download',0 UNION ALL
SELECT 223,1,'Scheme Master Control','Scheme Master Control','Proc_CS2CNNVSchemeMasterControl','Proc_ImportNVSchemeMasterControl','Cn2Cs_Prk_NVSchemeMasterControl','Proc_Cn2Cs_NVSchemeMasterControl','Master','Download',1 UNION ALL
SELECT 224,1,'Claim Settlement','Claim Settlement','Proc_Cs2Cn_ClaimSettlementDetails','Proc_Import_ClaimSettlementDetails','Cn2Cs_Prk_ClaimSettlementDetails','Proc_Cn2Cs_ClaimSettlementDetails','Transaction','Download',1 UNION ALL
SELECT 225,1,'SupplierCreditNote','SupplierCreditNote','Proc_ValidateCreditNoteSupplier','Proc_ImportCreditNoteSupplier','ETL_Prk_CreditNoteSupplier','Proc_ValidateCreditNoteSupplier','Master','Download',1 UNION ALL
SELECT 226,1,'SupplierDebitNote','SupplierDebitNote','Proc_ValidateDebitNoteSupplier','Proc_ImportDebitNoteSupplier','ETL_Prk_DebitNoteSupplier','Proc_ValidateDebitNoteSupplier','Master','Download',1 UNION ALL
SELECT 227,1,'Supplier','Supplier','Proc_Cs2Cn_SupplierMaster','Proc_Import_SupplierMaster','Cn2Cs_Prk_SupplierMaster','Proc_Cn2Cs_SupplierMaster','Master','Download',1 UNION ALL
SELECT 228,1,'Purchase Receipt','Purchase Receipt','Proc_Cs2Cn_PurchaseReceipt','Proc_ImportBLPurchaseReceipt','Cn2Cs_Prk_BLPurchaseReceipt','Proc_Cn2Cs_PurchaseReceipt','Transaction','Download',1 UNION ALL
SELECT 229,1,'Purchase Receipt Mapping','Purchase Receipt Mapping','Proc_Cs2Cn_PurchaseReceiptMapping','Proc_Import_PurchaseReceiptMapping','Cn2Cs_Prk_PurchaseReceiptMapping','Proc_Cn2Cs_PurchaseReceiptMapping','Transaction','Download',1 UNION ALL
SELECT 230,1,'Claim Norm Mapping','Claim Norm Mapping','Proc_Cs2Cn_ClaimNorm','Proc_Import_ClaimNorm','Cn2Cs_Prk_ClaimNorm','Proc_Cn2Cs_ClaimNorm','Master','Download',1 UNION ALL
SELECT 231,1,'Reason Master','Reason Master','Proc_Cs2Cn_ReasonMaster','Proc_Import_ReasonMaster','Cn2Cs_Prk_ReasonMaster','Proc_Cn2Cs_ReasonMaster','Master','Download',1 UNION ALL
SELECT 232,1,'Bulletin Board','BulletingBoard','Proc_Cs2Cn_BulletinBoard','Proc_Import_BulletinBoard','Cn2Cs_Prk_BulletinBoard','Proc_Cn2Cs_BulletinBoard','Master','Download',1 UNION ALL
SELECT 233,1,'ERP Product Mapping','ERP Product Mapping','Proc_Cs2Cn_ERPPrdCCodeMapping','Proc_Import_ERPPrdCCodeMapping','Cn2Cs_Prk_ERPPrdCCodeMapping','Proc_Cn2Cs_ERPPrdCCodeMapping','Transaction','Download',1 UNION ALL
SELECT 234,1,'Configuration','Configuration','Proc_Cs2Cn_Configuration','Proc_Import_Configuration','Cn2Cs_Prk_Configuration','Proc_Cn2Cs_Configuration','Master','Download',1 UNION ALL
SELECT 235,1,'Cluster Assign Approval','Cluster Assign Approval','Proc_Cs2Cn_ClusterAssignApproval','Proc_Import_ClusterAssignApproval','Cn2Cs_Prk_ClusterAssignApproval','Proc_Cn2Cs_ClusterAssignApproval','Master','Download',1 UNION ALL
SELECT 236,1,'UDC Master','UDC Master','Proc_Cs2Cn_UDCMaster','Proc_Import_UDCMaster','Cn2Cs_Prk_UDCMaster','Proc_Cn2Cs_UDCMaster','Master','Download',1 UNION ALL
SELECT 237,1,'UDC Details','UDC Details','Proc_Cs2Cn_UDCDetailss','Proc_Import_UDCDetails','Cn2Cs_Prk_UDCDetails','Proc_Cn2Cs_UDCDetails','Master','Download',1 UNION ALL
SELECT 238,1,'UDC Defaults','UDC Defaults','Proc_Cs2Cn_UDCDefaults','Proc_Import_UDCDefaults','Cn2Cs_Prk_UDCDefaults','Proc_Cn2Cs_UDCDefaults','Master','Download',1 UNION ALL
SELECT 239,1,'Retailer Migration','Retailer Migration','Proc_Cs2Cn_RetailerMigration','Proc_Import_RetailerMigration','Cn2Cs_Prk_RetailerMigration','Proc_Cn2Cs_RetailerMigration','Master','Download',1 UNION ALL
SELECT 240,1,'Point Redemption Rules','Point Redemption Rules','Proc_Cs2Cn_PointsRulesSetting','Proc_Import_PointsRulesSetting','Cn2Cs_Prk_PointsRulesHeader','Proc_Cn2Cs_PointsRulesSetting','Master','Download',1 UNION ALL
SELECT 241,1,'Village Master','Village Master','Proc_Cs2Cn_VillageMaster','Proc_Import_VillageMaster','Cn2Cs_Prk_VillageMaster','Proc_Cn2Cs_Dummy','Master','Download',1 UNION ALL
SELECT 242,1,'Scheme Payout','Scheme Payout','Proc_Cs2Cn_SchemePayout','Proc_Import_SchemePayout','Cn2Cs_Prk_SchemePayout','Proc_Cn2Cs_SchemePayout','Transaction','Download',1 UNION ALL
SELECT 243,1,'ReUpload','ReUpload','Proc_Cs2Cn_ReUpload','Proc_Import_ReUpload','Cn2Cs_Prk_ReUpload','Proc_Cn2Cs_ReUpload','Transaction','Download',1 UNION ALL
SELECT 244,1,'KitItem','KitItem','Proc_Cn2Cs_KitProduct','Proc_ImportKitProduct','Cn2Cs_Prk_KitProducts','Proc_Cn2Cs_KitProduct','Master','Download',1 UNION ALL
SELECT 245,1,'MarketIntelligence','MarketIntelligence','','Proc_ImportMarketIntelligenceHD','Cn2Cs_Prk_MarketIntelligenceHD','Proc_ValidatetMarketIntelligenceHD','Master','Download',1 UNION ALL
SELECT 246,1,'MarketIntelligenceDT','MarketIntelligenceDT','','Proc_ImportMarketIntelligenceDT','Cn2Cs_Prk_MarketIntelligenceDT','Proc_ValidatetMarketIntelligenceDT','Master','Download',1 UNION ALL
SELECT 247,1,'ProductUnification','ProductUnification','Proc_CN2CS_ProductCodeUnification','','CN2CS_Prk_ProductCodeUnification','Proc_CN2CS_ProductCodeUnification','Transaction','Download',1 UNION ALL
SELECT 248,1,'Purchase With Location Code','Purchase With Location Code','Proc_CN2CS_PurchaseWithLocationCode','Proc_Import_PurchaseWithLocationCode','CN2CS_Prk_PurchaseWithLocationCode','Proc_CN2CS_PurchaseWithLocationCode','Transaction','Download',1 UNION ALL
SELECT 249,1,'SpecialDiscount','SpecialDiscount','Proc_Cn2Cs_SpecialDiscount','Proc_Import_SpecialDiscount','Cn2Cs_Prk_SpecialDiscount','Proc_Cn2Cs_SpecialDiscount','Master','Download',1 UNION ALL
SELECT 250,1,'Scheme Flag Change','Scheme Flag Change','Proc_CN2CS_BLSchemeFlagChange','','Etl_Prk_SchemeHD_Slabs_Rules','Proc_CN2CS_BLSchemeFlagChange','Master','Download',1 UNION ALL
SELECT 251,1,'Bulletin Board Status','Bulletin Board Status','','PROC_IMPORT_BulletinBoardStatus','CN2CS_PRK_BulletinBoardStatus','PROC_VALIDATE_BulletinBoardStatus','Master','Download',1 UNION ALL
SELECT 252,1,'KitProductCategory','KitProductCategory','','Proc_Import_KitProductCategory','Cn2Cs_Prk_KitItemRetailerCategory','Proc_ValiDate_KitProductCategory','Master','Download',1 UNION ALL
SELECT 253,1,'Target Setting','Target Setting','','Proc_Import_InstitutionsTargetSetting','Cn2Cs_Prk_InstitutionsTargetSetting','Proc_Validate_InstitutionsTargetSetting','Master','Download',1 UNION ALL
SELECT 254,1,'InstitutionsTargetAchievement','InstitutionsTargetAchievement','','Proc_Import_InstitutionsTargetAchievement','Cn2Cs_Prk_InstitutionsTargetAchievement','Proc_Cn2Cs_InstitutionsTargetAchievement','Transaction','Download',0 UNION ALL
SELECT 255,1,'RetailerCreditNote','RetailerCreditNote','','Proc_Import_RetailerCreditNote','Cn2Cs_Prk_RetailerCreditNote','Proc_Cn2Cs_RetailerCreditNote','Master','Download',0 UNION ALL
SELECT 256,1,'SFAProductAlliasName','SFAProductAlliasName','','Proc_Import_SFAproductAlliasName','Cn2cs_Prk_ProductAlliasName','Proc_Cn2cs_ProductAlliasName','Master','Download',0 UNION ALL
SELECT 257,1,'DistributorInfo','DistributorInfo','','Proc_Import_DistributorInfo','Cn2Cs_Prk_DistributorInfo','Proc_Cn2Cs_DistributorInfo','Master','Download',1 UNION ALL
SELECT 258,1,'ServiceTaxSetting','ServiceTaxSetting','','Proc_Import_ServiceTaxSetting','Cn2Cs_Prk_ServiceTaxSetting','Proc_Cn2Cs_Prk_ServiceTaxSetting','Transaction','Download',1 UNION ALL
SELECT 259,1,'ServiceMaster','ServiceMaster','','Proc_Import_ServiceMaster','Cn2Cs_Prk_ServiceMaster','Proc_Cn2Cs_ServiceMaster','Master','Download',1 UNION ALL
SELECT 260,1,'Product HSN','Product HSN','','Proc_Import_ProductHSNCode','Cn2Cs_Prk_ProductHSNCode','Proc_Cn2Cs_ProductHSNCode','Master','Download',1 UNION ALL
SELECT 261,1,'RetailerGST','RetailerGST','','Proc_Import_RetailerGST','Cn2Cs_Prk_RetailerGST','Proc_Cn2Cs_RetailerGST','Master','Download',1 UNION ALL
SELECT 262,1,'PurchaseReturn_GST','PurchaseReturn_GST','','Proc_Import_PurchaseReturn','Cn2Cs_Prk_PurchaseReturn','Proc_Cn2Cs_PurchaseReturn','Transaction','Download',1  UNION ALL
SELECT 263,1,'ServiceClaimGroup','ServiceClaimGroup','','Proc_Import_ServiceClaimGroup','Cn2Cs_Prk_ServiceClaimGroup','Proc_Cn2Cs_ServiceClaimGroup','Master','Download',1 UNION ALL
SELECT 264,1,'PurchaseinvSeriesDtGST','PurchaseinvSeriesDtGST','','Proc_Import_PurchaseinvSeriesDtGST','Cn2CS_Prk_PurchaseinvSeriesDtGST','Proc_Cn2Cs_PurchaseinvSeriesDtGST','Master','Download',1 UNION ALL
SELECT 265,1,'BillSeriesDtUpdationGST','BillSeriesDtUpdationGST','','Proc_Import_BillSeriesDtUpdationGST','Cn2CS_Prk_BillSeriesDtUpdationGST','Proc_Cn2Cs_BillSeriesDtUpdationGST','Master','Download',1 UNION ALL
SELECT 266,1,'CompanyCountersUpdationGST','CompanyCountersUpdationGST','','Proc_Import_CompanyCountersUpdationGST','Cn2CS_Prk_CompanyCountersUpdationGST','Proc_Cn2Cs_CompanyCountersUpdationGST','Master','Download',1 UNION ALL
SELECT 267,1,'CountersUpdationGST','CountersUpdationGST','','Proc_Import_CountersUpdationGST','Cn2CS_Prk_CountersUpdationGST','Proc_Cn2Cs_CountersUpdationGST','Master','Download',1 UNION ALL
SELECT 268,1,'ServiceInvoiceApproval','ServiceInvoiceApproval','','Proc_Import_ServiceInvoiceApproval','Cn2Cs_Prk_ServiceInvoiceApproval','Proc_Cn2Cs_ServiceInvoiceApproval','Master','Download',1 UNION ALL
SELECT 269,1,'SchemeCircularDetails','SchemeCircularDetails','','Proc_Import_SchemeCircularDetails','Cn2Cs_Prk_SchemeCircularDetails','Proc_Cn2Cs_SchemeCircularDetails','Master','Download',1
GO
--Till Here
--Added By S.Moorthi
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnBillWindowDisplayToSave' and XTYPE IN ('TF','FN'))
DROP FUNCTION Fn_ReturnBillWindowDisplayToSave
GO
CREATE FUNCTION Fn_ReturnBillWindowDisplayToSave(@SalId AS BIGINT,@UsrId INT)
RETURNS @ReturnWindow TABLE
(
	SalId		BIGINT,
	RtrId		BIGINT,
	SchId		BIGINT,
	SchCode		VARCHAR(100),
	SchName		VARCHAR(200),
	AlredayAdjust	NUMERIC(18,6),
	AdjAmt	NUMERIC(18,6),
	UsrId	INT
)
AS
/***********************************************
* FUNCTION: Fn_ReturnBillWindowDisplayToSave
* PURPOSE: To Save Window Display Amount 
* NOTES:
* CREATED: S.Moorthi	17-11-2017
* MODIFIED
* DATE       AUTHOR     CR/BZ  USER STORY ID       DESCRIPTION                         
**********************************************************************
17/11/2017  S.Moorthi   CR     ICRSTPVCS0006        New configuration  to validate invoice Number Length
************************************************/
BEGIN

	INSERT INTO @ReturnWindow(SalId,RtrId,SchId,SchCode,SchName,AlredayAdjust,AdjAmt,UsrId)
	SELECT SalId,RtrId,B.SchId,A.SchCode,SchName as SchDsc,SUM(AlredayAdjust) as AlrdyAdjAmt,SUM(TobeAdjust) AS AdjAmt,UsrId 
	FROM BillingWindowDisplay A WITH (Nolock)
	INNER JOIN SchemeMaster B ON A.SchCode = B.SchCode WHERE SalId = @SalId AND UsrId = @UsrId 
	GROUP BY SalId,RtrId,B.SchId,A.SchCode,SchName,UsrId

RETURN
END
GO
DELETE FROM ManualConfiguration  WHERE ProjectName='GST' and ModuleId='ChkRefNoLen' 
INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
SELECT 'GST','ChkRefNoLen','ALL','Restrict to Save Bill/Return/ServiceInvoice, Refernce No length Greater than ',1,'',16.00,1
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Fn_ToValidateRefNoLength' and xtype IN ('TF','FN'))
DROP FUNCTION Fn_ToValidateRefNoLength
GO
--SELECT DBO.Fn_ToValidateRefNoLength('BILL012345678901',1,502)
CREATE FUNCTION Fn_ToValidateRefNoLength(@ReferenceNo VARCHAR(100),@Imode AS INT,@TransId AS INT)
RETURNS VARCHAR(MAX)
AS
/********************************************************************
* PROCEDURE: Fn_ToValidateRefNoLength
* PURPOSE: To Return to Validate Bill/Return/ServiceInvoice No Length
* NOTES:
* CREATED: S.Moorthi	24-11-2017
* MODIFIED
* DATE       AUTHOR     CR/BZ  USER STORY ID       DESCRIPTION                         
**********************************************************************
17/11/2017  S.Moorthi   CR     ICRSTPVCS0006       New configuration  to validate invoice Number Length
*********************************************************************/
BEGIN
	DECLARE @ReturnMsg AS VARCHAR(MAX)
	SET @ReturnMsg=''
	DECLARE @MaxLen AS INT
	SET @MaxLen=16
	
	IF @Imode<>1 
	BEGIN
		RETURN @ReturnMsg
	END
	
	IF @TransId IN (18,32,19,33)
	BEGIN
		RETURN @ReturnMsg
	END
			
	IF EXISTS(SELECT '*' FROM ManualConfiguration  WHERE ProjectName='GST' and ModuleId='ChkRefNoLen' AND [Status]=1)
	BEGIN
	
		SELECT @MaxLen=ISNULL(ConfigValue,16) FROM ManualConfiguration  WHERE ProjectName='GST' and ModuleId='ChkRefNoLen'
		
		IF ISNULL(@ReferenceNo,'')<>''
		BEGIN
			IF LEN(@ReferenceNo)>@MaxLen
			BEGIN
			
				IF @TransId=2
				BEGIN
					SET @ReturnMsg='Bill can not be process,Bill Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END
				ELSE IF @TransId=25
				BEGIN
					SET @ReturnMsg=' Order can not be process,Bill Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END
				ELSE IF @TransId=16
				BEGIN
					SET @ReturnMsg=' Claim Top sheet can not be Raised,Claim Top Sheet Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END				
				ELSE IF @TransId=3
				BEGIN
					SET @ReturnMsg='Sales Return can not be process,Return Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END
				ELSE IF @TransId=502
				BEGIN
					SET @ReturnMsg='Service Invoice can not be process,Service Invoice Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END
				ELSE IF @TransId=272
				BEGIN
					SET @ReturnMsg='IDT can not be process,IDT Reference Number Max length must be '+CAST(@MaxLen AS VARCHAR(5))
				END
			END
		END
	END
	
RETURN @ReturnMsg
END
GO
--S.Moorthi Till Here
--Added By Mary
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Fn_ReturnBudgetUtilizedSlab]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[Fn_ReturnBudgetUtilizedSlab]
GO
--SELECT dbo.Fn_ReturnBudgetUtilizedSlab(1,1) AS Amt
CREATE FUNCTION Fn_ReturnBudgetUtilizedSlab
(
	@Pi_SchId INT,
	@Pi_SlabId INT
)
RETURNS NUMERIC(38,6)
AS
/**********************************************************************************
* FUNCTION: Fn_ReturnBudgetUtilizedSlab
* PURPOSE: Returns the Budget Utilized for the Selected Scheme based on the slab
* NOTES:
* CREATED: MarySubashini	07-12-2017 for ICRSTPAR6933
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
-----------------------------------------------------------------------------------
***********************************************************************************/
BEGIN
	DECLARE @SchemeAmt 		NUMERIC(38,6)
	DECLARE @FreeValue		NUMERIC(38,6)
	DECLARE @GiftValue		NUMERIC(38,6)
	DECLARE @Points			INT
	DECLARE @RetSchemeAmt 	NUMERIC(38,6)
	DECLARE @RetFreeValue	NUMERIC(38,6)
	DECLARE @RetGiftValue	NUMERIC(38,6)
	DECLARE @RetPoints		INT
	DECLARE @WindowAmt		NUMERIC(38,6)
	DECLARE @BudgetUtilized	NUMERIC(38,6)
	DECLARE @FBMSchAmt		NUMERIC(38,6)
	DECLARE @QPSSchAmt		NUMERIC(38,6)
	SET @Points=0
	SET @RetPoints=0
	DECLARE @ProductBatchDetails TABLE 
	(
	  PrdId NUMERIC(18,0),
	  PrdBatId NUMERIC(18,0),
	  PriceId NUMERIC(18,0),
	  PrdBatDetailValue NUMERIC(18,6)
	)	
	INSERT INTO @ProductBatchDetails (PrdId,PrdBatId,PriceId,PrdBatDetailValue) 
	SELECT DISTINCT A.PrdId,A.PrdBatId,B.PriceId,B.PrdBatDetailValue 
	FROM ProductBatch A WITH (NOLOCK),ProductBatchDetails B WITH (NOLOCK),BatchCreation C WITH (NOLOCK) 
	WHERE A.PrdBatId = B.PrdBatId AND A.BatchSeqId = C.BatchSeqId AND B.SLNo = C.SLNo AND C.ClmRte = 1

	SELECT @SchemeAmt = (ISNULL(SUM(FlatAmount - ReturnFlatAmount),0) +
		ISNULL(SUM(DiscountPerAmount - ReturnDiscountPerAmount),0)) FROM
		(SELECT A.SalId,A.SchId,A.FlatAmount,A.ReturnFlatAmount,A.DiscountPerAmount,A.ReturnDiscountPerAmount FROM 
		SalesInvoiceSchemeLineWise A (NOLOCK)INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId AND A.SchId = @Pi_SchId AND A.SlabId=@Pi_SlabId AND B.Dlvsts<> 3)A1
		INNER JOIN SchemeMaster S (NOLOCK) ON A1.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId 

	SELECT  @FreeValue =ISNULL(SUM((FreeQty - ReturnFreeQty) * C.PrdBatDetailValue),0)
		FROM 
		(SELECT A.SchId,A.FreePrdId,A.FreePrdBatId,A.FreePriceId,A.FreeQty,A.ReturnFreeQty FROM 
		SalesInvoiceSchemeDtFreePrd A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND A.SlabId=@Pi_SlabId AND B.DlvSts <> 3) A2
		INNER JOIN @ProductBatchDetails C ON A2.FreePrdId = C.PrdId AND A2.FreePrdBatId = C.PrdBatId AND A2.FreePriceId = C.PriceId
		INNER JOIN SchemeMaster S ON A2.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A2.SchId = @Pi_SchId 	
			
	SELECT @GiftValue = ISNULL(SUM((GiftQty - ReturnGiftQty) * C.PrdBatDetailValue),0) FROM
	    (SELECT A.SchId,A.GiftPrdId,A.GiftPrdBatId,A.GiftPriceId,A.GiftQty,A.ReturnGiftQty FROM SalesInvoiceSchemeDtFreePrd A (NOLOCK)	
         INNER JOIN SalesInvoice B (NOLOCK) ON A.SalId = B.SalId WHERE A.SchId=@Pi_SchId AND A.SlabId=@Pi_SlabId AND DlvSts <> 3 )A3
		INNER JOIN @ProductBatchDetails C ON A3.GiftPrdId = C.PrdId AND A3.GiftPrdBatId = C.PrdBatId AND A3.GiftPriceId = C.PriceId
		INNER JOIN SchemeMaster S ON A3.SchId=S.SchId AND S.FBM=0 AND S.SchId = @Pi_SchId
		WHERE A3.SchId = @Pi_SchId 

	SELECT @WindowAmt = ISNULL(SUM(AdjAmt),0) FROM SalesInvoiceWindowDisplay A (NOLOCK)
		INNER JOIN SalesInvoice B ON A.SalId = B.SalId 
		WHERE SchId = @Pi_SchId AND DlvSts <> 3
	SELECT @WindowAmt = @WindowAmt + ISNULL(SUM(Amount),0) FROM ChequeDisbursalMaster A (NOLOCK)
		INNER JOIN ChequeDisbursalDetails B (NOLOCK) ON A.ChqDisRefNo = B.ChqDisRefNo
		WHERE TransId = @Pi_SchId AND TransType = 1 
	SELECT @FBMSchAmt=ISNULL(SUM(DiscAmt),0) FROM FBMSchDetails (NOLOCK) WHERE SchId=@Pi_SchId AND TransId IN (2)
	AND SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=1)

	SELECT @QPSSchAmt=ISNULL(SUM(CrNoteAmount),0) FROM SalesInvoiceQPSSchemeAdj SIQ (NOLOCK)
	INNER JOIN SalesInvoice SI (NOLOCK) ON SI.SalId=SIQ.SalId AND SI.DlvSts>3 AND SIQ.SchId=@Pi_SchId AND SIQ.SlabId=@Pi_SlabId
	WHERE SIQ.SchId IN(SELECT SchId FROM SchemeMaster (NOLOCK) WHERE FBM=0)
	
	SET @BudgetUtilized = (@SchemeAmt + @FreeValue + @GiftValue + @Points + @WindowAmt+ @FBMSchAmt+@QPSSchAmt)
	
	SET @BudgetUtilized=ISNULL(@BudgetUtilized,0)
	
	IF EXISTS (SELECT * FROM SchemeMaster WHERE SchId = @Pi_SchId AND SchType = 5)
	BEGIN
	    SET @BudgetUtilized = 0
	    SELECT @BudgetUtilized = ISNULL(SUM(SchemeUtlzAmt),0) FROM (
	    SELECT DISTINCT A.SalId,SchId,CurSchAmt AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH(NOLOCK),SalesInvoice B WITH (NOLOCK)
	    WHERE A.SalId = B.SalId AND DlvSts <> 3 AND SchId = @Pi_SchId AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK)
	    WHERE InvoiceType = 1 AND ReturnMode = 1)UNION
	    SELECT DISTINCT A.SalId,SchId,-1*(ReturnAmt) AS SchemeUtlzAmt FROM PercentageWiseSchemeHD A WITH (NOLOCK),
	    ReturnHeader B WITH (NOLOCK) WHERE A.SalId = B.SalId AND SchId = @Pi_SchId AND ReturnAmt <> 0 AND InvoiceType = 1 AND ReturnMode = 2
	    AND A.SalId NOT IN (SELECT SalId FROM ReturnHeader WITH (NOLOCK) WHERE InvoiceType = 1 AND ReturnMode = 1)) Qry
	END	
	RETURN(@BudgetUtilized)
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptStoreSchemeDetailsSlab]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptStoreSchemeDetailsSlab]
GO
/*
SELECT  * FROM RPTStoreSchemeDetails where schid=2219 ORDER By SchId,ReferNo
EXEC Proc_RptStoreSchemeDetailsSlab 246,1
*/
CREATE PROCEDURE [Proc_RptStoreSchemeDetailsSlab]
(	
	@Pi_RptId		INT,
	@Pi_UsrId		INT
)
AS
/*****************************************************************************
* PROCEDURE: Proc_RptStoreSchemeDetailsSlab
* PURPOSE: General Procedure To Get the Scheme Details into Scheme Temp Table
* NOTES:
* CREATED: MarySubashini	07-12-2017 for ICRSTPAR6933
* MODIFIED
* DATE			AUTHOR     DESCRIPTION
-------------------------------------------------------------------------------
********************************************************************************/
SET NOCOUNT ON
BEGIN
	--Filter Variable
	DECLARE @FromDate	AS 	DateTime
	DECLARE @ToDate		AS	DateTime
	DECLARE @fSchId		AS	Int
	DECLARE @fSMId		AS	Int
	DECLARE @fRMId		AS	Int
	DECLARE @CtgLevelId AS    INT
	DECLARE @CtgMainId  AS    INT
	DECLARE @RtrClassId AS    INT
	DECLARE @fRtrId		AS	Int
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @CtgLevelId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @CtgMainId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @RtrClassId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	--Till Here

	DELETE FROM RPTStoreSchemeDetails WHERE UserId = @Pi_UsrId
	--Values For Scheme Amount From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,ISNULL(SUM(B.FlatAmount),0) As FlatAmount,
		ISNULL(SUM(B.DisCountPerAmount),0) as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK)INNER JOIN SalesInvoiceSchemeLineWise B (NOLOCK) ON A.SalId = B.SalId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK) ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK)ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)ON RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)ON RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		B.PrdId,B.PrdBatId,Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,
		I.PrdName,J.PrdBatCode,SalInvDate
	
	--->Added By Nanda on 06/04/2010-For QPS Scheem Amount-Credit Conversion
	--Values For Scheme Amount From SalesInvoice-QPS Convesrion-Qty Based
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId AS SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,ISNULL(SUM(B.CrNoteAmount),0) As FlatAmount,
		0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		'' AS PrdName,'' AS PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceQPSSchemeAdj B (NOLOCK)  ON A.SalId = B.SalId AND B.Mode=1
		INNER JOIN SchemeMaster C (NOLOCK)  ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)  ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId 
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,SalInvDate
	--Values For Scheme Amount From SalesInvoice-QPS Convesrion-Date Based
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId AS SlabId,'' AS SalInvNo,0 AS SMId,0 AS RMId,0 AS DlvRMId,0 AS CtgLevelId,0 AS CtgMainId,0 AS RtrValueClassId,
		0 AS RtrId,4,0 AS VehicleId,0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,ISNULL(SUM(B.CrNoteAmount),0) As FlatAmount,
		0 as DiscountPer,0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,'' AS SMName,'' AS RMName,'' AS DlvRMName,'' AS CtgLevelName,'' AS CtgName,'' AS ValueClassName,'' AS RtrName,'' AS VehicleRegNo,
		'' AS DlvBoyName,'' AS PrdName,'' AS PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,B.LastModDate
	FROM SalesInvoiceQPSSchemeAdj B  (NOLOCK) 
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId AND B.Mode=2
	WHERE B.LastModDate Between @FromDate AND @ToDate 
	GROUP BY B.SchId,B.SlabId,Budget,B.LastModDate
	--->Till Here
	--Values For Points From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		Points AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK)  INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK)  ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK)ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN SalesInvoiceSchemeDtPoints L (NOLOCK)ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND B.SlabId = L.SlabId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--Values For Free Product From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT DISTINCT L.SchId,L.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,L.FreePrdId AS PrdId,L.FreePrdBatId AS PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,L.FreePrdId As FreePrdId,L.FreePrdBatId AS FreePrdBatId,L.FreeQty as FreeQty,
		(L.FreeQty * O.PrdBatDetailValue) as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(L.SchId,L.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,'' AS PrdBatCode,M.PrdName as FreePrdName,N.PrdBatCode as FreeBatchName,
		'-' as GiftPrdName,'' as GiftBatchName,1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK) ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L (NOLOCK) ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND L.SlabId= B.SlabId INNER JOIN Product M (NOLOCK) ON L.FreePrdId = M.PrdId
		INNER JOIN ProductBatch N (NOLOCK) ON L.FreePrdBatId = N.PrdBatId
		INNER JOIN ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.FreePriceId
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo
	AND P.ClmRte = 1
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC(NOLOCK) on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--Values For Gift Product From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,
		L.GiftPrdId as GiftPrdId,L.GiftPrdBatId As GiftPrdBatId,L.GiftQty as GiftQty,
		(L.GiftQty * O.PrdBatDetailValue) as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),
		1 as Selected,@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,
		ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,
		M.PrdName as GiftPrdName,N.PrdBatCode as GiftBatchName,1 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK) ON A.SalId = B.SalId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK) ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId INNER JOIN Product I ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN dbo.SalesInvoiceSchemeDtFreePrd L (NOLOCK)ON A.SalId = L.SalId AND C.SchId = L.SchId
		AND L.SlabId= B.SlabId INNER JOIN Product M (NOLOCK)ON L.GiftPrdId = M.PrdId
		INNER JOIN ProductBatch N (NOLOCK) ON L.GiftPrdBatId = N.PrdBatId
		INNER JOIN ProductBatchDetails O (NOLOCK) ON N.PrdBatId = O.PrdBatID AND O.PriceId=L.GiftPriceId
	INNER JOIN BatchCreation P (NOLOCK) ON P.BatchSeqId = N.BatchSeqId AND O.SlNo = P.SlNo
	AND P.ClmRte = 1
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Dlvsts >3
	--rathi
	--Values For Scheme Amount From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,0 as DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,0 AS VehicleId,
		0 AS DlvBoyId,B.PrdId,B.PrdBatId,-1 * ISNULL(SUM(B.ReturnFlatAmount),0) As FlatAmount,
		-1 * ISNULL(SUM(B.ReturnDiscountPerAmount),0) as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,'' AS VehicleRegNo,'' AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		2 as LineType,ReturnDate
	FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnSchemeLineDt B (NOLOCK) ON A.ReturnId = B.ReturnId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D (NOLOCK)ON A.RMId = D.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId  INNER JOIN Product I (NOLOCK)ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J (NOLOCK) ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Status =0
	GROUP BY B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,
		B.PrdId,B.PrdBatId,Budget,K.SMName,D.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,I.PrdName,J.PrdBatCode,ReturnDate
	--Values For Points From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,0 as DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,0 AS VehicleId,
		0 AS DlvBoyId,B.PrdId,B.PrdBatId,0 As FlatAmount,0 as DiscountPer,
		-1 * ISNULL(SUM(ReturnPoints),0) AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),1 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,'' AS VehicleRegNo,''AS DlvBoyName,
		I.PrdName,J.PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		2 as LineType,ReturnDate
	FROM ReturnHeader A (NOLOCK) INNER JOIN ReturnProduct A1 (NOLOCK) ON A.ReturnId = A1.ReturnId
		INNER JOIN SalesInvoiceSchemeDtBilled B (NOLOCK)ON A1.SalId IN (0,B.SalId) AND A1.PrdId = B.PrdId
		AND A1.PrdBatId = B.PrdBatId
		AND B.PrdId = (Select TOP 1 PrdId FROM SalesInvoiceSchemeDtBilled B1 (NOLOCK) WHERE
			B.SalId = B1.SalId AND B.SchId = B1.SchID AND B.SlabId = B1.SlabId)
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId
		INNER JOIN Retailer F (NOLOCK) ON A.RtrId = F.RtrId INNER JOIN Product I (NOLOCK)ON B.PrdID = I.PrdId
		INNER JOIN ProductBatch J ON B.PrdBatId = J.PrdBatId AND I.PrdID = J.PrdId
		INNER JOIN ReturnSchemePointsDt L ON A.ReturnId = L.ReturnId AND C.SchId = L.SchId
		AND B.SlabId = L.SlabId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.Status =0
	GROUP BY B.SchId,B.SlabId,A.ReturnCode,A.SMId,A.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.Status,B.PrdId,B.PrdBatId,
		Budget,K.SMName,D.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,I.PrdName,J.PrdBatCode,ReturnDate
	--Values For Free Product From Return
		
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,0 AS DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,0 AS VehicleId,
		0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,0 AS FlatAmount,0 AS DiscountPer,
		0 AS Points,RSF.FreePrdId,RSF.FreePrdBatId,(-1 * ISNULL(SUM(RSF.ReturnFreeQty),0)) AS FreeQty,
		(-1 * (ISNULL(SUM(RSF.ReturnFreeQty),0) * PBD.PrdBatDetailValue)) AS FreeValue,0 AS GiftPrdId,0 AS GiftPrdBatId,
		0 AS GiftQty,0 AS GiftValue,SM.Budget AS SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(RSF.SchId,RSF.SlabId),1 AS Selected,
		@Pi_UsrId,S.SMName,RM.RMName,'' AS DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,'' AS VehicleRegNo,
		'' AS DlvBoyName,P.PrdName,PB.PrdBatCode,P.PrdName AS FreePrdName,PB.PrdBatCode AS FreeBatchName,
		'-' AS GiftPrdName,'' AS GiftBatchName,2 AS LineType,ReturnDate
	FROM ReturnHeader RH (NOLOCK) 
		INNER JOIN ReturnSchemeFreePrdDt RSF (NOLOCK) ON  RH.ReturnId = RSF.ReturnId 
		INNER JOIN SchemeMaster SM (NOLOCK) ON  SM.SchId = RSF.SchId 
		INNER JOIN SalesMan S ON  S.SMId = RH.SMId
		INNER JOIN RouteMaster RM ON  RM.RMId = RH.RMId
		INNER JOIN Retailer R (NOLOCK)ON  R.RtrId = RH.RtrId 
		INNER JOIN RetailerValueClassMap RVCM(NOLOCK) ON  RVCM.RtrId=R.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)ON  RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON  RCL.CtgLevelId=RC.CtgLevelId 
		INNER JOIN Product P (NOLOCK)ON RSF.FreePrdId = P.PrdId
		INNER JOIN ProductBatch PB (NOLOCK) ON RSF.FreePrdBatId = PB.PrdBatId AND SM.CmpId=RCL.CmpId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.FreePriceId
		INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(RH.SMId = (CASE @fSMId WHEN 0 THEN RH.SMId Else 0 END) OR
		RH.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(RH.RMId = (CASE @fRMId WHEN 0 THEN RH.RMId Else 0 END) OR
		RH.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(RH.RtrID = (CASE @fRtrId WHEN 0 THEN RH.RtrID Else 0 END) OR
		RH.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(SM.SchId = (CASE @fSchId WHEN 0 THEN SM.SchId Else 0 END) OR
		SM.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		RH.Status =0
	GROUP BY RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,
		RSF.FreePrdId,RSF.FreePrdBatId,PBD.PrdBatDetailValue,SM.Budget,S.SMName,RM.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		P.PrdName,PB.PrdBatCode,P.PrdName,PB.PrdBatCode,ReturnDate
	--Values For Gift Product From Return
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,
		FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,0 AS DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,0 AS VehicleId,
		0 AS DlvBoyId,0 AS PrdId,0 AS PrdBatId,0 AS FlatAmount,0 AS DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,
		RSF.GiftPrdId,RSF.GiftPrdBatId,(-1 * ISNULL(SUM(RSF.ReturnGiftQty),0)) as GiftQty,
		(-1 * ISNULL(SUM(RSF.ReturnGiftQty),0) * PBD.PrdBatDetailValue) as GiftValue,SM.Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(RSF.SchId,RSF.SlabId),
		1 as Selected,@Pi_UsrId,S.SMName,RM.RMName,'' as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		'' AS VehicleRegNo,'' AS DlvBoyName,
		P.PrdName,PB.PrdBatCode,'-' AS FreePrdName,'' AS FreeBatchName,
		P.PrdName AS GiftPrdName,PB.PrdBatCode AS GiftBatchName,2 AS LineType,ReturnDate
	FROM ReturnHeader RH (NOLOCK) 
		INNER JOIN ReturnSchemeFreePrdDt RSF (NOLOCK)ON  RH.ReturnId = RSF.ReturnId 
		INNER JOIN SchemeMaster SM (NOLOCK)ON  SM.SchId = RSF.SchId 
		INNER JOIN SalesMan S (NOLOCK)ON  S.SMId = RH.SMId
		INNER JOIN RouteMaster RM ON  RM.RMId = RH.RMId
		INNER JOIN Retailer R (NOLOCK) ON  R.RtrId = RH.RtrId 
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)ON  RVCM.RtrId=R.RtrId
		INNER JOIN RetailerValueClass RVC(NOLOCK) ON  RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)ON  RCL.CtgLevelId=RC.CtgLevelId 
		INNER JOIN Product P (NOLOCK)ON RSF.GiftPrdId = P.PrdId
		INNER JOIN ProductBatch PB (NOLOCK) ON RSF.GiftPrdBatId = PB.PrdBatId AND SM.CmpId=RCL.CmpId
		INNER JOIN ProductBatchDetails PBD (NOLOCK) ON  PB.PrdBatId = PBD.PrdBatID AND PBD.PriceId=RSF.GiftPriceId
		INNER JOIN BatchCreation BC (NOLOCK) ON BC.BatchSeqId = PBD.BatchSeqId AND PBD.SlNo = BC.SlNo AND BC.ClmRte = 1
	WHERE ReturnDate Between @FromDate AND @ToDate  AND
		(RH.SMId = (CASE @fSMId WHEN 0 THEN RH.SMId Else 0 END) OR
		RH.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(RH.RMId = (CASE @fRMId WHEN 0 THEN RH.RMId Else 0 END) OR
		RH.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(RH.RtrID = (CASE @fRtrId WHEN 0 THEN RH.RtrID Else 0 END) OR
		RH.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(SM.SchId = (CASE @fSchId WHEN 0 THEN SM.SchId Else 0 END) OR
		SM.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		RH.Status =0
	GROUP BY RSF.SchId,RSF.SlabId,RH.ReturnCode,S.SMId,RM.RMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,RH.RtrId,RH.Status,
		RSF.GiftPrdId,RSF.GiftPrdBatId,PBD.PrdBatDetailValue,SM.Budget,S.SMName,RM.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,R.RtrName,
		P.PrdName,PB.PrdBatCode,P.PrdName,PB.PrdBatCode,ReturnDate
	--Values For UnSelected Scheme From SalesInvoice
	INSERT INTO RPTStoreSchemeDetails (SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,CtgLevelId,CtgMainId,RtrClassId,RtrId,DlvSts,VehicleId,DlvBoyId,
		PrdID,PrdBatId,FlatAmount,DiscountPer,
		Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,
		GiftQty,GiftValue,SchemeBudget,BudgetUtilized,Selected,
		UserId,SMName,RMName,DlvRMName,CtgLevelName,CtgName,ValueClassName,RtrName,VehicleName,DeliveryBoyName,
		PrdName,BatchName,FreePrdName,FreeBatchName,GiftPrdName,GiftBatchName,LineType,ReferDate)
	SELECT B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,ISNULL(A.VehicleId,0) AS VehicleId,
		ISNULL(A.DlvBoyId,0) AS DlvBoyId,0 as PrdId,0 as PrdBatId,0 As FlatAmount,0 as DiscountPer,
		0 AS Points,0 As FreePrdId,0 AS FreePrdBatId,0 as FreeQty,0 as FreeValue,0 as GiftPrdId,0 As GiftPrdBatId,
		0 as GiftQty,0 as GiftValue,Budget as SchemeBudget,dbo.Fn_ReturnBudgetUtilizedSlab(B.SchId,B.SlabId),2 as Selected,
		@Pi_UsrId,K.SMName,D.RMName,E.RMName as DlvRMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,ISNULL(G.VehicleRegNo,'') AS VehicleRegNo,
		ISNULL(H.DlvBoyName,'') AS DlvBoyName,
		'' As PrdName,'' as PrdBatCode,'-' as FreePrdName,'' as FreeBatchName,'-' as GiftPrdName,'' as GiftBatchName,
		3 as LineType,SalInvDate
	FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceUnSelectedScheme B(NOLOCK)  ON A.SalId = B.SalId
		INNER JOIN SchemeMaster C (NOLOCK)ON B.SchId = C.SchId INNER JOIN SalesMan K (NOLOCK)ON A.SMId = K.SMId
		INNER JOIN RouteMaster D ON A.RMId = D.RMId INNER JOIN ROUTEMASTER E (NOLOCK)ON A.DlvRMId = E.RMId
		INNER JOIN Retailer F (NOLOCK)ON A.RtrId = F.RtrId LEFT OUTER JOIN Vehicle G ON A.VehicleId = G.VehicleId
		LEFT OUTER JOIN DeliveryBoy H ON A.DlvBoyId = H.DlvBoyId
		INNER JOIN RetailerValueClassMap RVCM (NOLOCK)on RVCM.Rtrid=F.RtrId
		INNER JOIN RetailerValueClass RVC (NOLOCK)on RVCM.RtrValueClassId =RVC.RtrClassId
		INNER JOIN RetailerCategory RC (NOLOCK)on RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerCategoryLevel RCL (NOLOCK)on RCL.CtgLevelId=RC.CtgLevelId AND C.CmpId=RCL.CmpId
	WHERE SalInvDate Between @FromDate AND @ToDate  AND
		(A.SMId = (CASE @fSMId WHEN 0 THEN A.SMId Else 0 END) OR
		A.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
		(A.RMId = (CASE @fRMId WHEN 0 THEN A.RMId Else 0 END) OR
		A.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
		(RCL.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId Else 0 END) OR
		RCL.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
		(RC.CtgMainId = (CASE @CtgMainId WHEN 0 THEN RC.CtgMainId Else 0 END) OR
		RC.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
		(RVC.RtrClassId = (CASE @RtrClassId WHEN 0 THEN RVC.RtrClassId Else 0 END) OR
		RVC.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
		(A.RtrID = (CASE @fRtrId WHEN 0 THEN A.RtrID Else 0 END) OR
		A.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
		(C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR
		C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
		A.dlvsts >3
	GROUP BY B.SchId,B.SlabId,A.SalInvNo,A.SMId,A.RMId,A.DlvRMId,RCL.CtgLevelId,RC.CtgMainId,RVCM.RtrValueClassId,A.RtrId,A.DlvSts,A.VehicleId,A.DlvBoyId,
		Budget,K.SMName,D.RMName,E.RMName,RCL.CtgLevelName,RC.CtgName,RVC.ValueClassName,F.RtrName,G.VehicleRegNo,H.DlvBoyName,SalInvDate
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptSchemeUtilization_Parle]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptSchemeUtilization_Parle]
GO
--EXEC Proc_RptSchemeUtilization_Parle 246,1,0,'Henkel',0,0,1
CREATE PROCEDURE Proc_RptSchemeUtilization_Parle
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE: Proc_RptSchemeUtilization
* PURPOSE: Procedure To Return the Scheme Utilization for the Selected Filters
* NOTES:
* CREATED: Thrinath Kola	30-07-2007
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*Modified by Praveenraj B For Parle Scheme Utilization Report On 25/01/2012
***************************************************************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
12-10-2017  Mohana.S	 CR     CCRSTPAR0175          Showing Slab Details Instead of Slab id 
08-12-2017  Mary.S		 BZ     ICRSTPAR6933          Showing Slab wise Budget utilized Details   
12-12-2017  Mohana.S	 BZ     ICRSTPAR6933          Showing Slab wise Details (all columns)  
***************************************************************************************************/  
SET NOCOUNT ON
BEGIN
	DECLARE @NewSnapId 	AS	INT
	DECLARE @DBNAME		AS 	nvarchar(50)
	DECLARE @TblName 	AS	nvarchar(500)
	DECLARE @TblStruct 	AS	nVarchar(4000)
	DECLARE @TblFields 	AS	nVarchar(4000)
	DECLARE @sSql		AS 	nVarChar(4000)
	DECLARE @ErrNo	 	AS	INT
	DECLARE @PurDBName	AS	nVarChar(50)
	
	--Filter Variable
	DECLARE @FromDate	      AS 	DateTime
	DECLARE @ToDate		      AS	DateTime
	DECLARE @fSchId		      AS	Int
	DECLARE @fSMId		      AS	Int
	DECLARE @fRMId		      AS 	Int
	DECLARE @CtgLevelId           AS    	INT
	DECLARE @CtgMainId  	      AS    	INT
	DECLARE @RtrClassId           AS    	INT
	DECLARE @fRtrId		      AS	INT
	DECLARE @TempCtgLevelId       AS    	INT
	
	DECLARE @TempData	TABLE
	(	
		SchId	Int,
		Slabid INT,
		RtrCnt	Int,
		BillCnt	Int
	)
	--Till Here
	--Assgin Value for the Filter Variable
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))
	SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))
	SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))
	SET @CtgLevelId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))
	SET @CtgMainId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @RtrClassId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))
	SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))
	--Till Here
	SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)
	
	SELECT DISTINCT Prdid,U.ConversionFactor 
	Into #PrdUomBox
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	--Where Um.UomCode='BX'--Commented and added by Rajesh ICRSTPAR3196
	Where Um.UomCode IN('BX','BOX')
		
	SELECT DISTINCT Prdid,U.ConversionFactor
	Into #PrdUomPack
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	Where  P.PrdId Not In (Select PrdId From #PrdUomBox) And U.BaseUom='Y'
	
	Create Table #PrdUomAll
	(
		PrdId Int,
		ConversionFactor Int
	)
	Insert Into #PrdUomAll
	Select Distinct PrdId,ConversionFactor From #PrdUomBox
	Union All
	Select Distinct PrdId,ConversionFactor From #PrdUomPack
	
CREATE TABLE #RptStoreSchemeDetails
(
	[SchId] [int] NULL,
	[SlabId] [int] NULL,
	[ReferNo] [nvarchar](100) COLLATE DATABASE_DEFAULT  NULL,
	[SMId] [int] NULL,
	[RMId] [int] NULL,
	[DlvRMId] [int] NULL,
	[RtrId] [int] NULL,
	[DlvSts] [int] NULL,
	[VehicleId] [int] NULL,
	[DlvBoyId] [int] NULL,
	[PrdID] [int] NULL,
	[PrdBatId] [int] NULL,
	[FlatAmount] [numeric](38, 6) NULL,
	[DiscountPer] [numeric](38, 6) NULL,
	[Points] [int] NULL,
	[FreePrdId] [int] NULL,
	[FreePrdBatId] [int] NULL,
	[FreeQty] [int] NULL,
	[FreeValue] [numeric](38, 6) NULL,
	[GiftPrdId] [int] NULL,
	[GiftPrdBatId] [int] NULL,
	[GiftQty] [int] NULL,
	[GiftValue] [numeric](38, 6) NULL,
	[SchemeBudget] [numeric](38, 6) NULL,
	[BudgetUtilized] [numeric](38, 6) NULL,
	[Selected] [tinyint] NULL,
	[UserId] [int] NULL,
	[SMName] [nvarchar](200)  COLLATE DATABASE_DEFAULT NULL,
	[RMName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[DlvRMName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[RtrName] [nvarchar](200)  COLLATE DATABASE_DEFAULT  NULL,
	[VehicleName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[DeliveryBoyName] [nvarchar](200)COLLATE DATABASE_DEFAULT   NULL,
	[PrdName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[BatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[FreePrdName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[FreeBatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[GiftPrdName] [nvarchar](200)COLLATE DATABASE_DEFAULT   NULL,
	[GiftBatchName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[LineType] [int] NULL,
	[ReferDate] [datetime] NULL,
	[CtgLevelId] [int] NULL,
	[CtgLevelName] [nvarchar](200)COLLATE DATABASE_DEFAULT  NULL,
	[CtgMainId] [int] NULL,
	[CtgName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[RtrClassId] [int] NULL,
	[ValueClassName] [nvarchar](200) COLLATE DATABASE_DEFAULT  NULL,
	[BaseQty] [Int],
	[BaseQtyBox] [Int],
	[BaseQtyPack] [Int]
) ON [PRIMARY]
	
	Create TABLE #RptSchemeUtilizationDet_Parle
	(
		SchId		Int,
		SchCode		nVarChar(100),
		SchDesc		nVarChar(500),
		SlabId		nVarChar(50),
		SchemeBudget	Numeric(38,6),
		BudgetUtilized	Numeric(38,6),
		NoOfRetailer	Int,
		NoOfBills	Int,
		UnselectedCnt	Int,
		FlatAmount	Numeric(38,6),
		DiscountPer	Numeric(38,6),
		Points		Int,
		FreePrdName	nVarchar(200),
		FreeQty		Int,
		[BaseQty] [Int],
		BaseQtyBox	Int,
		BaseQtyPack Int,
		FreeValue	Numeric(38,6),
		GiftPrdName	nVarchar(200),
		GiftQty		Int,
		GiftValue	Numeric(38,6),
		[CircularNo] [Nvarchar](50)
	)
	SET @TblName = '#RptSchemeUtilizationDet_Parle'
	
	SET @TblStruct = '	SchId		Int,
				SchCode		nVarChar(100),
				SchDesc		nVarChar(500),
				SlabId		nVarChar(10),
				SchemeBudget	Numeric(38,6),
				BudgetUtilized	Numeric(38,6),
				NoOfRetailer	Int,
				NoOfBills	Int,
				UnselectedCnt	Int,
				FlatAmount	Numeric(38,6),
				DiscountPer	Numeric(38,6),
				Points		Int,
				FreePrdName	nVarchar(50),
				FreeQty		Int,
				[BaseQty] [Int],
				BaseQtyBox	Int,
				BaseQtyPack Int,
				FreeValue	Numeric(38,6),
				GiftPrdName	nVarchar(50),
				GiftQty		Int,
				GiftValue	Numeric(38,6)'
	SET @TblFields = 'SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
		NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,BaseQty,BaseQtyBox,BaseQtyPack,FreeValue,
		GiftPrdName,GiftQty,GiftValue'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	IF @Pi_GetFromSnap = 0		--To Generate For New Report Data
	BEGIN
		EXEC Proc_RptStoreSchemeDetailsSlab @Pi_RptId,@Pi_UsrId --ICRSTPAR6933
	
		--Added By Nanda on 13/02/2009
--		IF @CtgLevelId=0 
--		BEGIN			
--			SELECT @TempCtgLevelId=MAX(CtgLevelId) FROM RetailerCategoryLevel
--		END
--		ELSE
--		BEGIN
			SELECT @TempCtgLevelId=iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)
--		END
		--Till Here
		Insert Into #RptStoreSchemeDetails(SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,RtrId,DlvSts,VehicleId,DlvBoyId,PrdID,PrdBatId,FlatAmount,DiscountPer,
										   Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,GiftQty,GiftValue,SchemeBudget,BudgetUtilized,
										   Selected,UserId,SMName,RMName,DlvRMName,RtrName,VehicleName,DeliveryBoyName,PrdName,BatchName,FreePrdName,FreeBatchName
										   ,GiftPrdName,GiftBatchName,LineType,ReferDate,CtgLevelId,CtgLevelName,CtgMainId,CtgName,RtrClassId,ValueClassName,BaseQty,BaseQtyBox,BaseQtyPack) 
		Select SchId,SlabId,ReferNo,SMId,RMId,DlvRMId,RtrId,DlvSts,VehicleId,DlvBoyId,PrdID,PrdBatId,FlatAmount,DiscountPer,
										   Points,FreePrdId,FreePrdBatId,FreeQty,FreeValue,GiftPrdId,GiftPrdBatId,GiftQty,GiftValue,SchemeBudget,BudgetUtilized,
										   Selected,UserId,SMName,RMName,DlvRMName,RtrName,VehicleName,DeliveryBoyName,PrdName,BatchName,FreePrdName,FreeBatchName
										   ,GiftPrdName,GiftBatchName,LineType,ReferDate,CtgLevelId,CtgLevelName,CtgMainId,CtgName,RtrClassId,ValueClassName,0,0,0
										  From RPTStoreSchemeDetails Where Userid = @Pi_UsrId AND BudgetUtilized>0
		
		--Select Distinct ReferNo,BaseQty,PrdId,PrdBatId Into #RptScheme From #RptStoreSchemeDetails Where LineType<>3 And Userid = @Pi_UsrId
		--Changed By Mohana
		Update X Set X.BaseQty=Sp.BaseQty --Case When FreeValue=0 Then Sp.BaseQty Else 0 End
			From SalesInvoice S
					Inner Join (SELECT A.SalId,slabid,a.PrdId,a.PrdBatId,SUM(BaseQty) AS BaseQty FROM SalesInvoiceProduct A INNER JOIN SalesInvoiceSchemeLineWise B ON 
					A.salid =b.salid and B.Prdid=A.Prdid AND A.prdbatid =B.prdbatid 
					GROUP BY A.SalId,slabid,a.PrdId,a.PrdBatId,slabid) SP On S.SalId=SP.SalId					 
					Inner Join  #RptStoreSchemeDetails X On X.ReferNo=S.SalInvNo And X.PrdID=SP.PrdId And X.PrdBatId=SP.PrdBatId and sp.slabid=x.slabid
					Inner join  #PrdUomAll PU On PU.PrdId=X.PrdID
				 Where X.LineType<>3 
		--SELECT 'lll', * FROM #RptStoreSchemeDetails
--EXEC Proc_RptSchemeUtilization_Parle 237,1,0,'Henkel',0,0,1
		
		--SELECT * FROM #RptStoreSchemeDetails Inner join  #PrdUomAll PU On PU.PrdId=#RptStoreSchemeDetails.PrdID
		--Changed By Mohana
		
		SELECT DISTINCT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.PrdID,SUM(Discountper) Discountper,ISNULL(Sum(BaseQty),0) as BaseQty,
		Case When Isnull(Sum(BaseQty),0)<MAX(ConversionFactor) Then 0 Else Isnull(Sum(BaseQty),0)/MAX(ConversionFactor) End As BaseQtyBox,
		Case When Isnull(Sum(BaseQty),0)<MAX(ConversionFactor) Then Isnull(Sum(BaseQty),0) Else Isnull(Sum(BaseQty),0)%MAX(ConversionFactor) End As BaseQtyPack
		INTO #ProductUOM
		FROM SchemeMaster A INNER JOIN #RPTStoreSchemeDetails B On A.SchId= B.SchId
		AND B.Userid = @Pi_UsrId
		Inner Join #PrdUomAll PU On PU.PrdId=B.PrdID
		WHERE ReferDate Between @FromDate AND @ToDate  AND

		B.LineType <> 3 AND BudgetUtilized>0
		GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.PrdID
		 
							   
		INSERT INTO #RptSchemeUtilizationDet_Parle(SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,
			NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,BaseQty,BaseQtyBox,BaseQtyPack,FreeValue,
			GiftPrdName,GiftQty,GiftValue,CircularNo)
		SELECT DISTINCT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,Count(Distinct B.RtrId),
			Count(Distinct B.ReferNo),0 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,
			CASE FreePrdId WHEN 0 THEN dbo.Fn_ConvertCurrency(ISNULL(SUM(B.DiscountPer),0),@Pi_CurrencyId) ELSE '0.00' END as DiscountPer,
			ISNULL(SUM(Points),0) as Points,CASE ISNULL(SUM(FreeQty),0) WHEN 0 THEN '' ELSE FreePrdName END AS FreePrdName,
			CASE FreePrdName WHEN '' THEN 0 ELSE ISNULL(SUM(FreeQty),0)  END as FreeQty,0 as BaseQty,
			 0 as BaseQtyBox,
			0 as BaseQtyPack,
			ISNULL(SUM(FreeValue),0) as FreeValue,
			CASE ISNULL(SUM(GiftValue),0) WHEN 0 THEN '' ELSE GiftPrdName END AS GiftPrdName,ISNULL(SUM(GiftQty),0) as FreeQty,
			ISNULL(SUM(GiftValue),0) as GiftValue,isnull(BudgetAllocationNo,'')
		FROM SchemeMaster A INNER JOIN #RPTStoreSchemeDetails B On A.SchId= B.SchId
			AND B.Userid = @Pi_UsrId
		Inner Join #ProductUOM PU On PU.PrdId=B.PrdID
		WHERE ReferDate Between @FromDate AND @ToDate  AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @TempCtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (@TempCtgLevelId)) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR
			A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType <> 3 AND BudgetUtilized>0
		GROUP BY A.SchId,B.SlabId,A.SchCode,A.SchDsc,B.SchemeBudget,B.BudgetUtilized,FreePrdId,
			FreePrdName,GiftPrdName,BudgetAllocationNo--,B.PrdID 
 

		
		UPDATE A SET Discountper=b.Discountper, BaseQty=B.BaseQty,BaseQtyBox=B.BaseQtyBox,BaseQtyPack=B.BaseQtyPack FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		(SELECT SchId,SlabId,SUM(Discountper) Discountper,SUM(BaseQty) BaseQty,SUM(BaseQtyBox) BaseQtyBox,SUM(BaseQtyPack) BaseQtyPack FROM #ProductUOM
		GROUP BY SchId,Slabid
		) B ON A.SchId=B.SchId
		AND A.SlabId=B.SlabId

	 
				
			
		UPDATE A SET A.DiscountPer= (CASE FreePrdName WHEN '' THEN CAST(B.FlatAmt AS NUMERIC(18,2)) ELSE '0.00' END) FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		(SELECT SchId,SlabId,SUM(FlatAmount)+SUM(DiscountPer) AS FlatAmt FROM #RptSchemeUtilizationDet_Parle GROUP BY SchId,SlabId) B
		ON A.SchId=B.SchId AND A.SlabId=B.SlabId
		
		SELECT SchId,SlabId,ReferNo,RtrId INTO #TempBilledDt FROM RptStoreSchemeDetails WHERE LineType <> 3
		
		
		--UPDATE A SET NoOfBills = BillCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		--(SELECT SchId,SlabId,COUNT(DISTINCT ReferNo) AS BillCnt FROM
		--#TempBilledDt GROUP By SchId,SlabId) B ON A.SchId=B.SchId AND A.SlabId=B.SlabId
		
		--UPDATE A SET NoOfRetailer = RtrCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN 
		--(SELECT SchId,SlabId,COUNT(DISTINCT RtrId) AS RtrCnt FROM
		--#TempBilledDt GROUP By SchId,SlabId) B ON A.SchId=B.SchId AND A.SlabId=B.SlabId
				
		DELETE FROM #RptSchemeUtilizationDet_Parle WHERE (BaseQtyBox+BaseQtyPack+FreeQty+GiftQty)<=0
		
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,Slabid,RtrCnt,BillCnt)
		SELECT SchId,B.Slabid, Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B 
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 1
		GROUP BY B.SchId,B.Slabid
		
		UPDATE #RptSchemeUtilizationDet_Parle SET NoOfRetailer = NoOfRetailer,
			NoOfBills = BillCnt FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet_Parle.SchId AND B.Slabid = #RptSchemeUtilizationDet_Parle.SlabId
	
		DELETE FROM @TempData
	
		INSERT INTO @TempData(SchId,Slabid,RtrCnt,BillCnt)
		SELECT SchId,B.Slabid,  Count(Distinct B.RtrId),Count(Distinct ReferNo)
		FROM RPTStoreSchemeDetails B
		WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND
			(B.SMId = (CASE @fSMId WHEN 0 THEN B.SMId Else 0 END) OR
			B.SMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))) AND
			(B.RMId = (CASE @fRMId WHEN 0 THEN B.RMId Else 0 END) OR
			B.RMId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))) AND
			(B.CtgLevelId = (CASE @CtgLevelId WHEN 0 THEN B.CtgLevelId Else 0 END) OR
			B.CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))) AND
			(B.CtgMainId = (CASE @CtgMainId WHEN 0 THEN B.CtgMainId Else 0 END) OR
			B.CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))) AND
			(B.RtrClassId = (CASE @RtrClassId WHEN 0 THEN B.RtrClassId Else 0 END) OR
			B.RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))) AND
			(B.RtrID = (CASE @fRtrId WHEN 0 THEN B.RtrID Else 0 END) OR
			B.RtrID in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))) AND
			(B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR
			B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND
			B.LineType = 3
			AND CAST(B.SchId AS VARCHAR(10))+'~'+CAST(B.SlabId AS VARCHAR(10))+'~'+CAST(B.RtrId AS VARCHAR(10)) NOT IN 
			(Select DISTINCT CAST(SchId AS VARCHAR(10))+'~'+CAST(SlabId AS VARCHAR(10))+'~'+CAST(RtrId AS VARCHAR(10)) FROM #TempBilledDt)
			GROUP BY B.SchId,B.Slabid
			
		UPDATE #RptSchemeUtilizationDet_Parle SET UnselectedCnt = RtrCnt
			FROM @TempData B WHERE B.SchId = #RptSchemeUtilizationDet_Parle.SchId AND B.Slabid = #RptSchemeUtilizationDet_Parle.SlabId
		
		IF LEN(@PurDBName) > 0
		BEGIN
			EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT
			
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet_Parle ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +
				' WHERE ReferDate Between ''' + @FromDate + ''' AND ''' + @ToDate + '''AND '+
				' (SMId = (CASE ' + CAST(@fSMId AS nVarchar(10)) + ' WHEN 0 THEN SMId Else 0 END) OR '+
				' SMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RMId = (CASE ' + CAST(@fRMId AS nVarchar(10)) + ' WHEN 0 THEN RMId Else 0 END) OR '+
				' RMId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgLevelId = (CASE ' + CAST(@CtgLevelId AS nVarchar(10)) + ' WHEN 0 THEN CtgLevelId Else 0 END) OR '+
				' CtgLevelId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (CtgMainId = (CASE ' + CAST(@CtgMainId AS nVarchar(10)) + ' WHEN 0 THEN CtgMainId Else 0 END) OR '+
				' CtgMainId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrClassId = (CASE ' + CAST(@RtrClassId AS nVarchar(10)) + ' WHEN 0 THEN RtrClassId Else 0 END) OR '+
				' RtrClassId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (RtrID = (CASE ' + CAST(@fRtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrID Else 0 END) OR ' +
				' RtrID in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND' +
				' (SchId = (CASE ' + CAST(@fSchId AS nVarchar(10)) + ' WHEN 0 THEN SchId Else 0 END) OR ' +
				' SchId in (SELECT iCountid from Fn_ReturnRptFilters(' +
				CAST(@Pi_RptId AS nVarchar(10)) + ',8,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'
	
			EXEC (@SSQL)
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			IF @ErrNo = 0
			BEGIN
				SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
					'(SnapId,UserId,RptId,' + @TblFields + ')' +
					' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
					' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSchemeUtilizationDet_Parle'
				
				EXEC (@SSQL)
				PRINT 'Saved Data Into SnapShot Table'
			END
		END
	END
	ELSE				--To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
				@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		PRINT @ErrNo
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptSchemeUtilizationDet_Parle ' +
				'(' + @TblFields + ')' +
				' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
				' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
				' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
				' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			
			
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			PRINT 'DataBase or Table not Found'
		END
	END
	--Check for Report Data
	Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId
	
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSchemeUtilizationDet_Parle
	-- Till Here
	--UPDATE A SET BaseQty = B.BaseQty FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	--(SELECT C.SchId,(SUM(B.BaseQty)-SUM(ReturnedQty)) AS BaseQty FROM Salesinvoice A INNER JOIN SalesInvoiceProduct B ON A.SalId=B.SalId
	--INNER JOIN 
	--(SELECT DISTINCT ReferNo,B.PrdId,A.SchId,SlabId FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	--A.SchId=B.SchId)C ON A.SalInvNo=C.ReferNo AND B.PrdId=C.PrdId GROUP BY C.SchId,slabid) B ON A.SchId=B.SchId 
	
	UPDATE A SET FreeQty = (CASE FreePrdName WHEN '' THEN 0 ELSE B.FreeQty END) FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	(SELECT C.SchId,(SUM(B.FreeQty)- SUM(ReturnFreeQty)) AS FreeQty FROM Salesinvoice A INNER JOIN SalesInvoiceSchemeDtFreePrd B ON A.SalId=B.SalId
	INNER JOIN 
	(SELECT DISTINCT ReferNo,A.FreePrdId,A.SchId FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	A.SchId=B.SchId AND A.FreePrdId > 0)C ON A.salInvNo=C.ReferNo GROUP BY C.SchId) B ON A.SchId=B.SchId
	
	--UPDATE A SET NoOfBills = B.BillCnt FROM #RptSchemeUtilizationDet_Parle A INNER JOIN
	--(SELECT SchId,SUM(BillCnt) As BillCnt FROM 
	--(SELECT  CASE LineType WHEN 1 THEN COUNT(DISTINCT ReferNo) ELSE COUNT(DISTINCT ReferNo) *-1 END 
	--AS BillCnt,A.SchId,LineType FROM RptStoreSchemeDetails A INNER JOIN Fn_ReturnSchemeProductWithScheme() B ON 
	--A.SchId=B.SchId AND A.FreePrdId<>0 GROUP BY A.SchId,LineType) A GROUp By SchId) B ON A.SchId=B.SchId
	UPDATE RPT SET RPT.SchCode=S.CmpSchCode FROM #RptSchemeUtilizationDet_Parle RPT INNER JOIN SchemeMaster S ON RPT.SchId=S.SchId 
--Added By Mohana	
	SELECT A.SchId ,B.SlabId, CASE B.PurQty WHEN 0 THEN CONVERT (NVARCHAR(20),B.FromQty) + '-' + CONVERT(NVARCHAR(20),B.ToQty)
	ELSE  CONVERT (NVARCHAR(20),B.PurQty) + '-' + CONVERT(NVARCHAR(20),B.ToQty)END Slabdet INTO #SlabDet FROM SchemeMaster A INNER JOIN SchemeSlabs B ON A.SchId = B.SchId
	INNER JOIN #RptSchemeUtilizationDet_Parle R on R.schid=a.schid  and R.schid=b.SchId and R.slabid=b.SlabId 


	UPDATE A SET SlabId = Slabdet FROM #RptSchemeUtilizationDet_Parle A INNER JOIN #SlabDet B ON A.SchId =B.Schid AND A.SlabId = B.slabid
--Till here
	SELECT DISTINCT SchId,SchCode,SchDesc,CircularNo,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,NoOfBills AS NoOfBills ,
	UnselectedCnt,(BaseQtyBox) AS BaseQtyBox,(BaseQtyPack) AS BaseQtyPack,
	DiscountPer,(CASE FreeQty WHEN 0 THEN '-' ELSE FreePrdName END) AS FreePrdName,FreeQty,
    (CASE FreeQty WHEN 0 THEN '0.00' ELSE FreeValue END) AS FreeValue,FlatAmount,Points,(BaseQty) AS BaseQty,
	GiftPrdName,GiftQty,GiftValue
	FROM #RptSchemeUtilizationDet_Parle 
	
	IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
	BEGIN
	IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'RptSchemeUtilizationDet_Parle_Excel') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
		DROP TABLE RptSchemeUtilizationDet_Parle_Excel
			SELECT DISTINCT SchId,SchCode,SchDesc,CircularNo,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,NoOfBills AS NoOfBills ,
			UnselectedCnt,(BaseQtyBox) AS BaseQtyBox,(BaseQtyPack) AS BaseQtyPack,
			DiscountPer,(CASE FreeQty WHEN 0 THEN '-' ELSE FreePrdName END) AS FreePrdName,FreeQty,
			(CASE FreeQty WHEN 0 THEN '0.00' ELSE FreeValue END) AS FreeValue,FlatAmount,Points,(BaseQty) AS BaseQty,
			GiftPrdName,GiftQty,GiftValue
			INTO RptSchemeUtilizationDet_Parle_Excel FROM #RptSchemeUtilizationDet_Parle Order By SchId
	END 
RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptRailwayDiscountReconsolidation' AND TYPE='P')
DROP PROCEDURE Proc_RptRailwayDiscountReconsolidation
GO
--EXEC Proc_RptRailwayDiscountReconsolidation 288,1,0,'Parle',0,0,1
CREATE PROCEDURE Proc_RptRailwayDiscountReconsolidation
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptTradePromotionReport
* PURPOSE	: To Return the Scheme Utilization Details
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. IRCTC rate should display the net rate in billing screen   
 14-12-2017   S.Mohana    CR			ICRSTPAR7049	    Corrected Excel Column values.
*************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND RC.CtgCode = 'RAI'
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE (L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	 
	AND (L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate,CAST(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact AS NUMERIC(18,6)) PrdUnitNetRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte,CAST(SIP.PrdUom1NetRate AS NUMERIC(18,6))/SIP.Uom1ConvFact PrdUnitNetRate
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN SalesInvoice SI(NOLOCK) ON SI.SalId=S.SalId
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON SIP.SalId=S.SalId and SIP.SalId=SI.SalId and SIP.PrdId=SP.PrdId and SIP.PrdBatId=SP.PrdBatId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0 and S.InvoiceType=1 and S.ReturnMode=1
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	INSERT INTO #ReturnDetails
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte,
	CAST((PrdGrossAmt-(PrdSplDisAmt+PrdSchDisamt+PrdCDDisAmt)+PrdTaxAmt)/CAST(BaseQty AS NUMERIC(18,6)) AS NUMERIC(18,6))  AS PrdUnitNetRate
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0 --AND (ISNULL(S.InvoiceType,0)<>1 OR ISNULL(S.ReturnMode,0)<>1)
	AND NOT EXISTS(SELECT * FROM #ReturnDetails R (NOLOCK) WHERE R.ReturnId=S.ReturnId)
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	
	
	--SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	--SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	--INTO #ReturnDetails
	--FROM ReturnHeader S (NOLOCK)
	--INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	--WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	--AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	--AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,PrdUnitNetRate,MRP,PriceId,SlNo,CAST(0 AS NUMERIC(18,6))[SellRate],
	CAST(0 AS NUMERIC(18,2)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,2)) AS LCTR
	INTO #RailwaySalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,PrdUnitNetRate,MRP,PriceId,SlNo FROM #ReturnDetails
	
	) Consolidated
	
	DECLARE @SlNo AS INT
	
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE R SET R.[SellRate] = D.PrdBatDetailValue
	FROM #RailwaySalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	SELECT R.PriceId,C.DiscountPerc,C.[TYPE]
	INTO #ExistingSpecialPrice
	FROM #RailwaySalesDetails R (NOLOCK),
	SpecialRateAftDownLoad_Calc C (NOLOCK)
	WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]
	FROM #RailwaySalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId
	
	UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))
	FROM #RailwaySalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	--SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,
	SELECT P.PrdId,P.PrdName,SUM(TotalPCS) TotalPCS,PrdUnitNetRate,MRP,
	LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,
	CAST(0 AS NUMERIC(18,6)) IRCTCRate,
	CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,
	CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,
	CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR
	INTO #RailwayDiscount
	FROM #RailwaySalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	GROUP BY P.PrdId,P.PrdName,MRP,LCTR,IRCTCMargin,S.[Type],PrdUnitNetRate
	
	--UPDATE R SET R.IRCTCRate = MRP - (MRP * IRCTCMargin / 100.00), 
	UPDATE R SET R.IRCTCRate = PrdUnitNetRate, 
	TotalMRP  = TotalPCS * MRP, 
	TotalLCTR = TotalPCS * LCTR
	FROM #RailwayDiscount R (NOLOCK)
	
	UPDATE R SET R.IRCTCTotal = TotalPCS * IRCTCRate
	FROM #RailwayDiscount R (NOLOCK)
	
	UPDATE R SET R.ClmAmount = TotalLCTR - IRCTCTotal
	FROM #RailwayDiscount R (NOLOCK)
	
	UPDATE R SET R.LibOnMRP = ClmAmount / TotalMRP
	FROM #RailwayDiscount R (NOLOCK)
	WHERE R.TotalMRP <> 0
	
	UPDATE R SET R.LibOnLCTR = ClmAmount / TotalLCTR
	FROM #RailwayDiscount R (NOLOCK)
	WHERE R.TotalLCTR <> 0	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptRailwayDiscountReconsolidation_Excel')
	DROP TABLE RptRailwayDiscountReconsolidation_Excel	
	
	SELECT * 
	INTO RptRailwayDiscountReconsolidation_Excel
	FROM #RailwayDiscount (NOLOCK) ORDER BY PrdName
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptRailwayDiscountReconsolidation_Excel
	
	SELECT * FROM RptRailwayDiscountReconsolidation_Excel ORDER BY PrdName,MarkUpDown
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'TotalPCS','Total PCS',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'PrdUnitNetrate','PrdUnitNetrate',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'LCTR','LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'IRCTCMargin','IRCTC Margin',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'MarkUpDown','MarkUp /Mark Down',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'IRCTCRate','IRCTC Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'TotalMRP','Parle Total MRP Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalLCTR','Parle Total LCTR Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'IRCTCTotal','IRCTC Total Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'ClmAmount','Claim Amount',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'LibOnMRP','% Lib On MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'LibOnLCTR','% Lib On LCTR',1,1)
	
	RETURN	
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptChainWiseBillDetails' AND TYPE='P' )
DROP PROCEDURE Proc_RptChainWiseBillDetails
GO
--exec Proc_RptChainWiseBillDetails 288,1,0,'',0,0,0
CREATE PROCEDURE Proc_RptChainWiseBillDetails
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptChainWiseBillDetsils
* PURPOSE	: 
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		1. Chain lending rate should display the net rate in billing screen
															2. Bill number column should be after the party name column   
 19-12-2017   S.Mohana   CR				ICRSTPAR7049			3. Added SubTotal in Excel 
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	DECLARE @ReportType	AS INT	
	--Added By Mohana
	CREATE TABLE #Chain
	(
		[SalId] [bigint] NOT NULL,
		[BillNo] [nvarchar](50) NOT NULL,
		[BillDate] NVARCHAR(100),
		[RtrId] [int] NOT NULL,
		RtrName NVARCHAR(100),
		[PrdId] [int] NOT NULL,
		PrdName NVARCHAR(100),
		PktWgt [numeric](18, 6),
		[MRP] [numeric](18, 6) NOT NULL,
		QtyInPkt [numeric](38, 0) NULL,		
		[ChainLandRate] [numeric](38, 17) NULL,
		Amount [numeric](38, 17) NULL
	)  
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	
	SET @ReportType = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,315,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) AND
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SUM(SP.BaseQty) TotalPCS,SP.PrdUnitMRP MRP,SP.PriceId,
	--SUM(CAST(SP.PrdUom1NetRate AS NUMERIC(18,6))/Uom1ConvFact) as ChainLandRate --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) ChainLandRate
	INTO #ChainSalesDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdUnitMRP,SP.PriceId
	
	--ICRSTPAR7049 Till Here
	SELECT R.PriceId,C.SplSelRate 
	INTO #ExistingSpecialPrice
	FROM #ChainSalesDetails R (NOLOCK),
	SpecialRateAftDownLoad_Calc C (NOLOCK)
	WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)
	
	UPDATE R SET R.ChainLandRate = S.SplSelRate
	FROM #ChainSalesDetails R (NOLOCK),
	#ExistingSpecialPrice S (NOLOCK)
	WHERE R.PriceId = S.PriceId		
	--Till Here ICRSTPAR7049
	
	
	INSERT INTO #Chain
	SELECT S.SalId,S.SalInvNo BillNo,CONVERT(VARCHAR(10),S.SalInvDate,121) as  BillDate,S.RtrId,R.RtrName,P.PrdId,P.PrdName,
	PrdWgt PktWgt,MRP,TotalPCS QtyInPkt,ChainLandRate, --ICRSTPAR7049
	CAST(0 AS NUMERIC(18,6)) Amount
	FROM #ChainSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	
	UPDATE C SET C.Amount = QtyInPkt * ChainLandRate
	FROM #Chain C (NOLOCK)
	
	--Nagarajan on 29.08.2017 as per PMS : ICRSTPAR5917
	SELECT S.SalId,S.RtrId,SP.PrdId,SUM(SPT.TaxAmount) TaxAmount
	INTO #SalesInvoiceProductTax
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId = SP.SalId AND SPT.PrdSlNo = SP.SlNo 
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 AND SPT.TaxAmount > 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	GROUP BY S.SalId,S.RtrId,SP.PrdId
	
	UPDATE C SET C.Amount = C.Amount + ISNULL(SPT.TaxAmount,0)
	FROM #Chain C (NOLOCK)
	INNER JOIN #SalesInvoiceProductTax SPT ON SPT.SalId=C.SalId AND SPT.RtrId = C.SalId AND SPT.PrdId=C.PrdId
	WHERE C.Amount > 0
	--Till here


	-- ICRSTPAR7049 Bill No Column Change
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptChainWiseBillDetails_Excel')
	DROP TABLE RptChainWiseBillDetails_Excel
		
	SELECT SalId,BillDate,RtrId,RtrName,BillNo,PrdId,PrdName,PktWgt,MRP,QtyInPkt,ChainLandRate,Amount 
	INTO RptChainWiseBillDetails_Excel
	FROM #Chain (NOLOCK)
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptChainWiseBillDetails_Excel
	
	SELECT * FROM RptChainWiseBillDetails_Excel Order By RtrName,BillNo
	
	INSERT INTO RptChainWiseBillDetails_Excel
	SELECT 0 SalId,'' BillDate,0 RtrId,RtrName,'TOTAL'BillNo, 0 PrdId,''PrdName,0 PktWgt,0 MRP,SUM(QtyInPkt) QtyInPkt,SUM(ChainLandRate) ChainLandRate,
	SUM(Amount) Amount FROM RptChainWiseBillDetails_Excel	
	group by RtrName 
	
 
	
	--SELECT * FROM RptChainWiseBillDetails_Excel Order By RtrName,BillNo
	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'SalId','SalId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'BillDate','BillDate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'RtrId','RtrId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'RtrName','Party Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'BillNo','BillNo',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'PktWgt','Pkt Wgt',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'ChainLandRate','Chain Lending Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'Amount','Amount',1,1)	
	RETURN
END
GO
IF EXISTS(SELECT 'x' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptMTChainSKUWiseOffer')
DROP PROCEDURE Proc_RptMTChainSKUWiseOffer
GO
--EXEC Proc_RptMTChainSKUWiseOffer 288,1,0,'',0,0,1
CREATE PROCEDURE [dbo].[Proc_RptMTChainSKUWiseOffer]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/************************************************************************************************
* PROCEDURE	: Proc_RptMTChainSKUWiseOffer
* PURPOSE	: To Return the Trade Promotion Report
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------
* DATE       AUTHOR     CR/BZ    USER STORY ID    DESCRIPTION                         
**************************************************************************************************
06/10/2017  Mohana S    BZ       ICRSTPAR6321     Issue Fix in ChainRate and LCTR Calculations. 
***************************************************************************************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	
	WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE 
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	
	AND E.PrdType = 3
	--To Filter Products
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)	
		
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	
	SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],
	CAST(0 AS NUMERIC(18,2)) ChainRate,CAST(0 AS NUMERIC(18,2)) AS ParleLCTR,CAST(0 AS NUMERIC(18,2)) ChainOffRate
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate] FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte FROM #ReturnDetails
	
	) Consolidated	
	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	--Added By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.PrdId,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
		SELECT DISTINCT M.Salid,M.Rtrid,KP.KitPrdid,KP.PrdId,K.BaseQty Qty
	INTO	#KitItemsQty 
	FROM KitProduct KP (NOLOCK),
	#MTSalesDetails M (NOLOCK),
	SalesInvoiceKitItemDt K(NOLOCK)
	WHERE M.PrdId= KP.KitPrdId AND M.SalId = K.SalId AND M.PrdId = K.KitPrdId --AND M.SlNo = K.SlNo
	AND KP.PrdId=K.PrdId AND KP.KitPrdid=K.KitPrdId AND M.rtrid = K.RtrId
	
	--
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	 
	
	UPDATE M SET M.SellRate = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,Sum(NormalSellRate*qty) NormalSellRate  FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid AND A.rtrid =B.rtrid AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,Fromdate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)
	
	SELECT S.* 
	INTO #LatesSpecialPrice1
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(Fromdate) Fromdate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.Fromdate = S.Fromdate
	
 
	
	SELECT DISTINCT RtrId,PrdId,MAX(PrdBatId)PrdBatId, Fromdate,SplSelRate INTO #LatesSpecialPrice FROM #LatesSpecialPrice1 
	GROUP BY RtrId,PrdId, Fromdate,SplSelRate
	
	
	
	
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
 
	
	UPDATE M SET M.ChainRate = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,A.SalId,A.PrdId,SlNo,SUM(NormalSpecialRate*Qty) NormalSpecialRate FROM #NormalProduct A INNER JOIN #KitItemsQty B
	ON A.NormalPrd=B.prdid AND  A.prdid=B.kitprdid   AND A.rtrid =B.rtrid  AND A.salid=B.salid
	GROUP BY TransType,A.SalId,A.PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo	
	
	
	--Nagarajan on 29.Aug.2017
	
	UPDATE M SET M.ChainRate = (M.ChainRate +(M.ChainRate *(T.TaxPerc/100)))
	FROM #MTSalesDetails M (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE M.TransType = T.TransId AND M.SalId = T.Salid AND M.Slno = T.PrdSlno
	

	 
 
	
	-- Till here
	
	UPDATE R SET R.ParleLCTR = (R.[SellRate]+(R.[SellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	
	
	
	
	UPDATE R SET R.ChainOffRate = D.PrdBatDetailValue
	FROM #MTSalesDetails R (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo AND R.PriceId=D.PriceId
	AND R.PrdBatId=D.PrdBatId	
	

	-- Nagarajan on 29.08.2017
	
	--UPDATE R SET R.ChainOffRate = (R.[ChainOffRate]+(R.[ChainOffRate]*(T.TaxPerc/100)))
	--FROM #MTSalesDetails R (NOLOCK),
	--#ParleOutputTaxPercentage T (NOLOCK)
	--WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno	

	--Commented By Mohana
	
	--SELECT DISTINCT KP.KitPrdid,KP.Qty
	--INTO	#KitItemsQty 
	--FROM KitProduct KP (NOLOCK),
	--#MTSalesDetails SD (NOLOCK)
	--WHERE SD.PrdId= KP.KitPrdId 
	
	--UPDATE SD SET SD.ParleLCTR = SD.ParleLCTR * KIQ.Qty 
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId 

	--UPDATE SD SET SD.ChainRate = SD.ChainRate * KIQ.Qty
	--FROM #MTSalesDetails SD (NOLOCK),
	--#KitItemsQty  KIQ (NOLOCK)
	--WHERE KIQ.KitPrdid = SD.PrdId	
	
	--
	
	SELECT S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,SUM(TotalPCS) QtyInPkt,
	SUM(ParleLCTR) ParleLCTR,SUM(ChainRate) ChainRate,ChainOffRate ,
	CAST(0 AS NUMERIC(18,2)) TotalOffLCTR,CAST(0 AS NUMERIC(18,2)) TotalOffPerTOT,
	CAST(0 AS NUMERIC(18,2)) TotalOffPerChain,CAST(0 AS NUMERIC(18,2)) OffClmDiff,
	CAST(0 AS NUMERIC(18,2)) OffLiabVal,CAST(0 AS NUMERIC(18,2)) ClmLiabWOTOT,
	CAST(0 AS NUMERIC(18,2)) ClmLiabTotSal
	INTO #MTChain
	FROM #MTSalesDetails S (NOLOCK)
	INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId
	INNER JOIN Retailer R (NOLOCK) ON S.RtrId = R.RtrId
	GROUP BY S.RtrId,R.RtrName,P.PrdId,P.PrdName,MRP,ChainOffRate
	
 
	
		--Added By Mohana	
	UPDATE R SET R.ParleLCTR = ParleLCTR / QtyInPkt ,   ChainRate = ChainRate/QtyInPkt
	FROM #MTChain R (NOLOCK)
	 
	
	UPDATE R SET R.TotalOffLCTR = QtyInPkt * ParleLCTR,
	R.TotalOffPerTOT = QtyInPkt * ChainRate,
	R.TotalOffPerChain = QtyInPkt * ChainOffRate
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.OffClmDiff = TotalOffLCTR - TotalOffPerChain,
	R.OffLiabVal = TotalOffPerTOT - TotalOffPerChain
	FROM #MTChain R (NOLOCK)
	
	UPDATE R SET R.ClmLiabWOTOT = (OffLiabVal / TotalOffLCTR)*100 , ClmLiabTotSal = (OffClmDiff / TotalOffLCTR)*100
	FROM #MTChain R (NOLOCK)
	WHERE TotalOffLCTR <> 0

	
	
	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTChainSKUWiseOffer_Excel')
	DROP TABLE RptMTChainSKUWiseOffer_Excel
	
	SELECT RtrId,RtrName,PrdId,PrdName,MRP,QtyInPkt,ParleLCTR,ChainRate,ChainOffRate,TotalOffLCTR,TotalOffPerTOT,TotalOffPerChain,
	ABS(OffClmDiff) OffClmDiff,ABS(OffLiabVal) OffLiabVal,ABS(ClmLiabWOTOT) ClmLiabWOTOT,ABS(ClmLiabTotSal) ClmLiabTotSal
	INTO RptMTChainSKUWiseOffer_Excel
	FROM #MTChain (NOLOCK)
	
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTChainSKUWiseOffer_Excel
	
	SELECT * FROM RptMTChainSKUWiseOffer_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'RtrId','RtrId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'RtrName','Retailer Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'PrdId','PrdId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'PrdName','Product Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'MRP','MRP',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'QtyInPkt','Quantity in Pkts',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'ParleLCTR','Parle LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'ChainRate','Chain Rate as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'ChainOffRate','Chain Offer Rate',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'TotalOffLCTR','Total Offer LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'TotalOffPerTOT','Total Offer Sec Sales as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalOffPerChain','Total Offer Sec Sales as Per offer rate to Chain',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'OffClmDiff','Offer Claim Difference',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'OffLiabVal','Offer Liability Value',1,1)		
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'ClmLiabWOTOT','% Liab Of claims on Total Sales without TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,16,'ClmLiabTotSal','% Liab Of claims on Total Sales',1,1)
	RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Fn_SpecialRateAftDownloadDetails' AND xtype IN ('TF','FN'))
DROP FUNCTION Fn_SpecialRateAftDownloadDetails
GO
CREATE FUNCTION Fn_SpecialRateAftDownloadDetails(@Pi_CurrentRate AS INT,@Pi_RtrCategory AS NVARCHAR(200),
@Pi_RtrCategoryValue AS NVARCHAR(200),@Pi_PrdCCode AS NVARCHAR(200),@Pi_PrdCategoryCode AS NVARCHAR(200)) 
RETURNS @SpecialRateAftDownloadDetails TABLE
(
  CtgLevelId       NUMERIC(18,0),
  CtgMainId        NUMERIC(18,0),
  RtrCtgCode       NVARCHAR(200),
  RtrCtgValueCode  NVARCHAR(200),
  RtrId            NUMERIC(18,0),
  RtrCode          NVARCHAR(200),
  PrdId            NUMERIC(18,0),
  PrdCCode         NVARCHAR(200),
  PrdName          NVARCHAR(200),
  Chk              NVARCHAR(200),
  SellingRate      NUMERIC(18,6),
  SplSelRate       NUMERIC(18,6),
  PDRate           NUMERIC(18,6),
  DiscountPerc     NUMERIC(18,6),
  FromDate         DATETIME,
  DownloadedDate   NVARCHAR(200)
)
/****************************************************	
* FUNCTION: Fn_SpecialRateAftDownloadDetails
* PURPOSE : Special Rate Download Details
* NOTES:
* CREATED : Sathishkumar Veeramani ON 29-01-2015
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
**************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		Target uploaded is not reflecting in Report
****************************************************/
AS
BEGIN
	IF ISNULL(@Pi_PrdCategoryCode,'0')='0'
	BEGIN
		SET @Pi_PrdCategoryCode='0'
	END

	IF @Pi_CurrentRate = 0
	BEGIN
	    INSERT INTO @SpecialRateAftDownloadDetails (CtgLevelId,CtgMainId,RtrCtgCode,RtrCtgValueCode,RtrId,RtrCode,PrdId,PrdCCode,PrdName,
        Chk,SellingRate,SplSelRate,PDRate,DiscountPerc,FromDate,DownloadedDate)
        SELECT DISTINCT RC.CtgLevelId,RC.CtgMainId,SRAD.RtrCtgCode,SRAD.RtrCtgValueCode,0 RtrId,SRAD.RtrCode,0 PrdId,SRAD.PrdCCode,P.PrdName,'' Chk,
		PrdBatDetailValue AS SellingRate,CAST(SRAD.SplSelRate AS NUMERIC(38,6)) SplSelRate,ISNULL(PD.Rate,0) AS PDRate,
		ISNULL(SRAD.DiscountPerc,0) AS DiscountPerc,SRAD.FromDate,SRAD.DownloadedDate 
		FROM (
		SELECT DISTINCT RtrCode,RtrCtgCode,PrdCCode,RtrCtgValueCode,CAST(SplSelRate AS NUMERIC(38,6)) SplSelRate,CONVERT(VARCHAR(10),
		DownloadedDate,103) DownloadedDate,FromDate,DiscountPerc FROM SpecialRateAftDownload (NOLOCK)) SRAD
		INNER JOIN Product P (NOLOCK) ON SRAD.PrdCCode=P.PrdCCode
		INNER JOIN ProductCategoryValue PCV (NOLOCK) ON P.PrdCtgvalMainId=PCV.PrdCtgValMainId
		INNER JOIN RetailerCategory RC (NOLOCK) 
		ON RC.CtgCode= (CASE ISNULL(SRAD.RtrCtgValueCode,'ALL') WHEN 'ALL' THEN RC.CtgCode ELSE SRAD.RtrCtgValueCode END)
		LEFT OUTER JOIN PriceDifference PD (NOLOCK) ON P.PrdId=PD.PrdId AND RC.CtgMainId=PD.CtgMainId
		INNER JOIN (SELECT P.PRDID,MAX(PB.PRDBATID)PRDBATID,PrdBatDetailValue  
		FROM Product P (NOLOCK) INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId =P.PrdId 
		INNER JOIN Productbatchdetails PBD (NOLOCK) ON PBD.PrdbatId=PB.PrdbatId 
		WHERE PBD.DefaultPrice=1 AND SLNo=3 GROUP BY P.PrdId,PrdBatDetailValue)C ON P.PrdId = C.PrdId
		--WHERE PCV.PrdCtgValLinkCode LIKE '0%' AND RC.CtgLinkCode LIKE '0%' 
		WHERE PCV.PrdCtgValLinkCode LIKE @Pi_PrdCategoryCode+'%' AND RC.CtgLinkCode LIKE '0%'
		AND SRAD.RtrCtgCode = (CASE ISNULL(@Pi_RtrCategory,'ALL') WHEN 'ALL' THEN SRAD.RtrCtgCode 
		WHEN ISNULL(@Pi_RtrCategory,'') THEN SRAD.RtrCtgCode ELSE @Pi_RtrCategory END)
		AND RC.CtgName = (CASE ISNULL(@Pi_RtrCategoryValue,'ALL') WHEN 'ALL' THEN RC.CtgName 
		WHEN '' THEN RC.CtgName ELSE @Pi_RtrCategoryValue END)
		AND SRAD.PrdCCode = (CASE @Pi_PrdCCode WHEN '0' THEN SRAD.PrdCCode ELSE @Pi_PrdCCode END)
		ORDER BY SRAD.RtrCtgValueCode,SRAD.RtrCode,SRAD.PrdCCode,P.PrdName
	END
    ELSE
    BEGIN
        INSERT INTO @SpecialRateAftDownloadDetails (CtgLevelId,CtgMainId,RtrCtgCode,RtrCtgValueCode,RtrId,RtrCode,PrdId,PrdCCode,PrdName,
        Chk,SellingRate,SplSelRate,PDRate,DiscountPerc,FromDate,DownloadedDate)
        SELECT DISTINCT 0 CtgLevelId,0 CtgMainId,SRAD.RtrCtgCode RtrCtgCode,SRAD.RtrCtgValueCode,0 RtrId,SRAD.RtrCode,0 PrdId,SRAD.PrdCCode,P.PrdName,'' Chk,
		PrdBatDetailValue AS SellingRate,CAST(SRAD.SplSelRate AS NUMERIC(38,6)) SplSelRate,ISNULL(PD.rate,0) AS PDRate,
		ISNULL(SRAD.DiscountPerc,0) AS DiscountPerc,SRAD.FromDate,SRAD.DownloadedDate 
		FROM (
		SELECT DISTINCT RtrCode,RtrCtgCode,PrdCCode,RtrCtgValueCode,CAST(SplSelRate AS NUMERIC(38,6)) SplSelRate,DownloadedDate DownloadedDate,
		FromDate,DiscountPerc FROM SpecialRateAftDownload (NOLOCK)) SRAD 
		INNER JOIN Product P (NOLOCK) ON SRAD.PrdCCode=P.PrdCCode
		INNER JOIN ProductCategoryValue PCV (NOLOCK) ON P.PrdCtgvalMainId=PCV.PrdCtgValMainId
		INNER JOIN RetailerCategory RC (NOLOCK) ON SRAD.RtrCtgValueCode = RC.CtgCode
		LEFT OUTER JOIN PriceDifference PD (NOLOCK) ON P.PrdId = PD.PrdId AND RC.CtgMainId = PD.CtgMainId
		INNER JOIN 
		(SELECT SRAD.RtrCtgCode,SRAD.RtrCtgValueCode,RC.CtgName,SRAD.RtrCode,SRAD.PrdCCode,P.PrdName,MAX(SRAD.FromDate) AS FromDate,
		ISNULL(DiscountPerc,0) AS DiscountPerc,MAX(SRAD.DownloadedDate) AS DownloadedDate 
		FROM SpecialRateAftDownload SRAD (NOLOCK) 
		INNER JOIN Product P (NOLOCK) ON SRAD.PrdCCode=P.PrdCCode
		INNER JOIN ProductCategoryValue PCV (NOLOCK) ON P.PrdCtgvalMainId=PCV.PrdCtgValMainId
		INNER JOIN RetailerCategory RC (NOLOCK) ON SRAD.RtrCtgValueCode = RC.CtgCode
		--WHERE PCV.PrdCtgValLinkCode LIKE '0%' AND RC.CtgLinkCode LIKE '0%' 
		WHERE PCV.PrdCtgValLinkCode LIKE @Pi_PrdCategoryCode+'%' AND RC.CtgLinkCode LIKE '0%' 
		GROUP BY SRAD.RtrCtgCode,SRAD.RtrCtgValueCode,RC.CtgName,SRAD.RtrCode,SRAD.PrdCCode,P.PrdName,DiscountPerc)A 
		ON SRAD.RtrCtgValueCode=A.RtrCtgValueCode AND SRAD.RtrCode=A.RtrCode AND SRAD.PrdCCode=A.PrdCCode AND SRAD.DownloadedDate=A.DownloadedDate  
		AND P.PrdName=A.PrdName AND RC.CtgName=A.CtgName
		INNER JOIN 
		(SELECT P.PRDID,MAX(PB.PRDBATID)PRDBATID,PrdBatDetailValue  FROM Product P (NOLOCK)
		INNER JOIN ProductBatch PB (NOLOCK) ON pb.PrdId =p.PrdId INNER JOIN Productbatchdetails PBD (NOLOCK)ON PBD.prdbatid=pb.prdbatid 
		WHERE PBD.DefaultPrice=1 AND SLNo=3  GROUP BY P.PrdId,PrdBatDetailValue)C ON P.PrdId = C.PrdId
		--WHERE PCV.PrdCtgValLinkCode LIKE '0%' AND RC.CtgLinkCode LIKE '0%'
		WHERE PCV.PrdCtgValLinkCode LIKE @Pi_PrdCategoryCode+'%' AND RC.CtgLinkCode LIKE '0%'
		AND SRAD.RtrCtgCode = (CASE ISNULL(@Pi_RtrCategory,'ALL') WHEN 'ALL' THEN SRAD.RtrCtgCode 
		WHEN ISNULL(@Pi_RtrCategory,'') THEN SRAD.RtrCtgCode ELSE @Pi_RtrCategory END)
		AND RC.CtgName = (CASE ISNULL(@Pi_RtrCategoryValue,'ALL') WHEN 'ALL' THEN RC.CtgName 
		WHEN '' THEN RC.CtgName ELSE @Pi_RtrCategoryValue END)
		AND SRAD.PrdCCode = (CASE @Pi_PrdCCode WHEN '0' THEN SRAD.PrdCCode ELSE @Pi_PrdCCode END)  
		ORDER BY SRAD.RtrCtgValueCode,SRAD.RtrCode,SRAD.PrdCCode,P.PrdName,
		SRAD.FromDate,SRAD.DownloadedDate,SRAD.SplSelRate,PrdBatDetailValue        
	END         
RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Proc_GSTUserLogInValidation' AND xtype ='P')
DROP PROCEDURE Proc_GSTUserLogInValidation
GO
CREATE PROCEDURE [dbo].[Proc_GSTUserLogInValidation](@ServerDate AS DATETIME)
AS
/*********************************
* PROCEDURE		: Proc_UserLogInValidation
* PURPOSE		: To Validate User Log in Proc_UserLogInValidation
* CREATED		: S.Moorthi
* CREATED DATE	: 17-04-2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
**************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		Target uploaded is not reflecting in Report
*********************************/
SET NOCOUNT ON
BEGIN

DECLARE @GstEnabled AS INT
SET @GstEnabled=0

	IF EXISTS(SELECT * FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 AND 
	AcknowledgeStatus=1 and ConsoleAckStatus=1 AND ModuleId='GSTCONFIG' )
	BEGIN
		SET @GstEnabled=1
	END
	
	
	DECLARE @SpmId AS INT
	SET @SpmId=0
	IF NOT EXISTS(SELECT '*' FROM Supplier (NOLOCK) WHERE SpmDefault=1)
	BEGIN
		SELECT @SpmId=MAX(ISNULL(SpmId,0)) FROM Supplier (NOLOCK)
		UPDATE Supplier SET SpmDefault=1 WHERE SpmId=@SpmId
	END
	
	DECLARE @VatTaxGroupId AS INT
	SET @VatTaxGroupId=0
	IF EXISTS(SELECT * FROM VATDefaultSupplierGST (NOLOCK))
	BEGIN		
		DECLARE @CmpId AS INT
		SET @CmpId=0
		SELECT @CmpId=CmpId FROM COMPANY WHERE DefaultCompany=1
		SELECT @VatTaxGroupId=MAX(ISNULL(TaxGroupId,0)) FROM VATDefaultSupplierGST (NOLOCK)
		UPDATE Supplier SET VATTaxGroupId=@VatTaxGroupId --WHERE ISNULL(VATTaxGroupId,0)=0
		UPDATE Supplier SET CmpId=@CmpId WHERE ISNULL(CmpId,0)=0
	END

	IF @GstEnabled=0
	BEGIN
		---NESTLE EDITABLE=1
		UPDATE A SET A.Editable=0,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='PRODUCT MASTER' AND ColumnName IN ('HSN Code','HSN Description')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='RETAILER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Retailer Type','Composition','Related Party')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='SUPPLIER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','Status')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='DISTRIBUTOR INFO MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Distributor Type')


		UPDATE A SET A.Editable=1,ColumnMandatory=0 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='COMPANY MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number')
		
	END
	ELSE
	BEGIN
	
		UPDATE A SET A.Editable=0,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='PRODUCT MASTER' AND ColumnName IN ('HSN Code','HSN Description')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='RETAILER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Retailer Type','Composition','Related Party')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='SUPPLIER MASTER' AND 
		ColumnName IN ('State Name','GSTIN','Status')

		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='COMPANY MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number')
		
		UPDATE A SET A.Editable=1,ColumnMandatory=1 FROM UdcMaster A (NOLOCK)
		INNER JOIN UdcHD B(NOLOCK) ON A.MasterId=B.MasterId 
		WHERE UPPER(B.MasterName)='DISTRIBUTOR INFO MASTER' AND 
		ColumnName IN ('State Name','GSTIN','PAN Number','Distributor Type')

		IF NOT EXISTS(SELECT * FROM Gst_FieldLevelConfiguration WHERE Transid=2)
		BEGIN
			INSERT INTO Gst_FieldLevelConfiguration
			SELECT 2,1,'fxtInvDisc',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,2,'fxtInvDiscAmt',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			--SELECT 2,3,'fxtWindowDisplayAmount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,4,'chkInvoiceDisc',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,5,'fxtOnAccountAmount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,6,'btnOperation',12,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,7,'btnOperation',9,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,8,'btnOperation',8,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,9,'btnOperation',10,1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,10,'btnOperation',11,1,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) UNION
			SELECT 2,11,'chkOnAccount',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121) --UNION
			--SELECT 2,12,'chkWindowDisplay',0,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)
		END
		----Retailer Taxgroup Update Post GST Migrate
		UPDATE  B SET B.TaxGroupId=C.TaxGroupId 
		FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=1 and A.UpdateFlag=0

		UPDATE  D SET D.TaxGroupId=C.TaxGroupId 
		FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode
		INNER JOIN RetailerShipAdd D ON D.RtrId=B.RtrId
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=1 and A.UpdateFlag=0 and RtrShipDefaultAdd=1

		DELETE A FROM RetailerGSTTaxGroupUpdate A 
		INNER JOIN Retailer B ON A.RetailerCode=B.RtrCode 
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup  and B.TaxGroupId=C.TaxGroupId
		WHERE C.TaxGroup=1 and A.UpdateFlag=0

		--DECLARE @VatTaxGroupId AS INT
		SET @VatTaxGroupId=0
		IF EXISTS(SELECT * FROM VATDefaultSupplier (NOLOCK))
		BEGIN
			SELECT @VatTaxGroupId=MAX(ISNULL(TaxGroupId,0)) FROM VATDefaultSupplier (NOLOCK)
			UPDATE Supplier SET VATTaxGroupId=@VatTaxGroupId WHERE ISNULL(VATTaxGroupId,0)=0
		END
		
		----Supplier TaxGroup Update Post GST Migrate
		UPDATE  B SET B.TaxGroupId=C.TaxGroupId 
		FROM SupplierGSTTaxGroupUpdate A 
		INNER JOIN Supplier B ON A.SpmCode=B.SpmCode
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup 
		WHERE C.TaxGroup=3 and A.UpdateFlag=0
		
		DELETE A FROM SupplierGSTTaxGroupUpdate A 
		INNER JOIN Supplier B ON A.SpmCode=B.SpmCode 
		INNER JOIN TaxGroupSetting C ON C.RtrGroup=A.TaxGroup  and B.TaxGroupId=C.TaxGroupId
		WHERE C.TaxGroup=3 and A.UpdateFlag=0
		
	END
	
RETURN
END
GO
DELETE FROM RptFormula WHERE RptId=288 and Formula in ('TotLCTR','SalesTOT','ClaimDiff','LiabSales')
INSERT INTO RptFormula([RptId],[SlNo],[Formula],[FormulaValue],[LcId],[SelcId]) 
SELECT 288,52,'TotLCTR','Total Normal LCTR',1,0 UNION
SELECT 288,53,'SalesTOT','Total Normal Sec Sales As Per TOT',1,0 UNION
SELECT 288,54,'ClaimDiff','TOT Normal Diff Claims',1,0 UNION
SELECT 288,55,'LiabSales','% Liab on Normal Sale',1,0
GO
IF EXISTS(SELECT 'x' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_Cs2Cn_MTDebitSummary')
DROP PROCEDURE Proc_Cs2Cn_MTDebitSummary
GO
/*
Begin transaction
EXEC Proc_Cs2Cn_MTDebitSummary 0,'2014-02-04'
select * from Cs2Cn_Prk_MTDebitSummary order by slno
Rollback Transaction
*/
CREATE PROCEDURE Proc_Cs2Cn_MTDebitSummary
(
	@Po_ErrNo INT OUTPUT,
	@ServerDate DATETIME
)
AS
/*********************************
* PROCEDURE		: Proc_Cs2Cn_MTDebitSummary 
* PURPOSE		: To Extract LMISDetails
* CREATED BY	: Aravindh Deva C
* CREATED DATE	: 03.06.2016
* NOTE			:
* MODIFIED
------------------------------------------------
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		 Only MT & IRCTC category details should display in report
*********************************/
SET NOCOUNT ON
BEGIN
	
	SET @Po_ErrNo=0
	
	DECLARE @DistCode As NVARCHAR(50)
	DELETE FROM Cs2Cn_Prk_MTDebitSummary WHERE UploadFlag = 'Y'
	
	IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))
	BEGIN
		RETURN
	END
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)	
	
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)	
	WHERE 
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A where CtgCode in ('IRCTC','NC','SSO')))
	
	DECLARE @FromDate DATETIME
	DECLARE @ToDate DATETIME
	
	SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate) 
	FROM UploadingReportTransaction (NOLOCK)	
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)
	
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE S.Status = 0
	AND EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)
	SELECT TransType,RtrId,SalId,TransDate,PrdId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) TotalLCTR, CAST(0 AS NUMERIC(18,6)) SalesTOT
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId FROM #ReturnDetails
	
	) Consolidated
	
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE M SET M.ActualSellRate = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%-Spl Rate-%'
	--
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	UPDATE M SET M.[ActualSellRate] = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSellRate) NormalSellRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	--
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	UPDATE M SET M.[SpecialSellRate] = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSpecialRate) NormalSpecialRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo		
	UPDATE R SET R.TotalLCTR =  R.TotalPCS * (R.[ActualSellRate]+(R.[ActualSellRate]*(T.TaxPerc/100))),
	R.SalesTOT = R.TotalPCS * (R.[SpecialSellRate]+(R.[SpecialSellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno
	
	SELECT M.RtrId,TransDate,M.PrdId,P.PrdCCode,SUM(CASE P.PrdType WHEN 3 THEN 0 ELSE TotalLCTR END) TotalLCTR,
	SUM(CASE P.PrdType WHEN 3 THEN 0 ELSE SalesTOT END) SalesTOT,
	CAST(0 AS NUMERIC(18,2)) [ClaimDiff], CAST(0 AS NUMERIC(18,2)) [LiabSales],
	SUM(CASE P.PrdType WHEN 3 THEN TotalLCTR ELSE 0 END) [TotalOffLCTR],
	SUM(CASE P.PrdType WHEN 3 THEN SalesTOT ELSE 0 END) [OffTOT],
	CAST(0 AS NUMERIC(18,2)) [TotalOff],CAST(0 AS NUMERIC(18,2)) [OffClaimDiff],
	CAST(0 AS NUMERIC(18,2)) [LiabOff],CAST(0 AS NUMERIC(18,2)) [TotalSales],
	CAST(0 AS NUMERIC(18,2)) [LiabWOTOT],CAST(0 AS NUMERIC(18,2)) [LiabTOT],CAST(0 AS NUMERIC(18,2)) [TotalLiab]
	INTO #DebitNote
	FROM #MTSalesDetails M,
	Product P (NOLOCK) 
	WHERE M.PrdId = P.PrdId
	GROUP BY M.RtrId,TransDate,M.PrdId,P.PrdCCode
	
	UPDATE D SET [ClaimDiff] = TotalLCTR - SalesTOT, [TotalOff] = [TotalOffLCTR] - [OffTOT]
	FROM #DebitNote D (NOLOCK)
	UPDATE D SET [LiabSales] = [ClaimDiff] / TotalLCTR
	FROM #DebitNote D (NOLOCK)
	WHERE TotalLCTR <> 0
	UPDATE D SET [OffClaimDiff] = [TotalOffLCTR] - [TotalOff]
	FROM #DebitNote D (NOLOCK)
	UPDATE D SET [LiabOff] = [OffTOT] - [TotalOff]
	FROM #DebitNote D (NOLOCK)	
	UPDATE D SET [TotalSales] = TotalLCTR + [TotalOffLCTR]
	FROM #DebitNote D (NOLOCK)
	
	UPDATE D SET [LiabWOTOT] = [LiabOff] / [TotalSales]
	FROM #DebitNote D (NOLOCK)	
	WHERE [TotalSales] <> 0
	UPDATE D SET [LiabTOT] = [TotalOffLCTR] / [TotalSales]
	FROM #DebitNote D (NOLOCK)
	WHERE [TotalSales] <> 0		
	UPDATE D SET [TotalLiab] = ([ClaimDiff] + [OffClaimDiff])/[TotalSales]
	FROM #DebitNote D (NOLOCK)
	WHERE [TotalSales] <> 0	
	
	--ICRSTPAR7049
	UPDATE D SET [LiabSales] = [LiabSales]/100.00,
	LiabWOTOT=LiabWOTOT/100.00,LiabTOT=LiabTOT/100.00,TotalLiab=TotalLiab/100.00
	FROM #DebitNote D (NOLOCK)
	--Till Here ICRSTPAR7049
	
	INSERT INTO Cs2Cn_Prk_MTDebitSummary (DistCode,TransDate,CmpRtrCode,PrdCCode,TotalLCTR,SalesTOT,ClaimDiff,LiabSales,
	TotalOffLCTR,OffTOT,TotalOff,OffClaimDiff,LiabOff,TotalSales,LiabWOTOT,LiabTOT,TotalLiab,UploadFlag,SyncId,ServerDate)
	SELECT @DistCode,TransDate,R.CmpRtrCode,PrdCCode,
	SUM(TotalLCTR) TotalLCTR,
	SUM(SalesTOT) SalesTOT,
	SUM(ClaimDiff) ClaimDiff,
	SUM(LiabSales) LiabSales,
	SUM(TotalOffLCTR) TotalOffLCTR,
	SUM(OffTOT) OffTOT,
	SUM(TotalOff) TotalOff,
	SUM(OffClaimDiff) OffClaimDiff,
	SUM(LiabOff) LiabOff,
	SUM(TotalSales) TotalSales,
	SUM(LiabWOTOT) LiabWOTOT,
	SUM(LiabTOT) LiabTOT,
	SUM(TotalLiab) TotalLiab,'N' UploadFlag,NULL,@ServerDate
	FROM #DebitNote D (NOLOCK),
	Retailer R (NOLOCK)
	WHERE D.RtrId = R.RtrId
	GROUP BY TransDate,R.CmpRtrCode,PrdCCode
	RETURN			
END
GO
IF EXISTS(SELECT 'x' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptMTDebitSummary')
DROP PROCEDURE Proc_RptMTDebitSummary
GO
--EXEC Proc_RptMTDebitSummary 288,1,0,'Parle',0,0,1
CREATE PROCEDURE Proc_RptMTDebitSummary
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			NVARCHAR(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptTradePromotionReport
* PURPOSE	: To Return the Trade Promotion Report
* CREATED	: Aravindh Deva C
* CREATED DATE	: 27 05 2016
* NOTE		: Parle SP for Trade Promotion Reports
* MODIFIED 
***************************************************************************************************
* DATE        AUTHOR      CR/BZ			USER STORY ID       DESCRIPTION   
 14-12-2017   S.Moorthi   CR			ICRSTPAR7049		 Only MT & IRCTC category details should display in report
*********************************/  
BEGIN
	SET NOCOUNT ON
	
	DECLARE @FromDate			AS	DATETIME
	DECLARE @ToDate				AS	DATETIME
	DECLARE @CmpId				AS  INT 
	DECLARE @CtgLevelId			AS  INT  
	DECLARE @CtgMainId			AS  INT	
	DECLARE @CmpPrdCtgId		AS INT
	DECLARE @PrdCtgValMainId	AS INT	
	
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
	
	SET @CtgLevelId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
	SET @CtgMainId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))
	SET @CmpPrdCtgId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId))
	SET @PrdCtgValMainId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,21,@Pi_UsrId))
	--To Filter Retailers
	SELECT DISTINCT R.RtrId,RC.CtgMainId,RC.CtgName,RC.CtgCode
	INTO #FilterRetailer
	FROM Retailer R (NOLOCK),
	RetailerValueClassMap RVCM (NOLOCK),
	RetailerValueClass RVC (NOLOCK),
	RetailerCategory RC (NOLOCK),
	RetailerCategoryLevel RCL (NOLOCK)
	WHERE 
	RC.CTGCODE IN (SELECT CtgCode FROM RetailerCategory A 
	WHERE CtgLinkId IN (SELECT CtgMainId FROM RetailerCategory A where CtgCode in ('IRCTC','NC','SSO')))
	AND 
	R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId
	AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId
	AND (RVC.CmpId=(CASE @CmpId WHEN 0 THEN RVC.CmpId ELSE 0 END) OR
	RVC.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
	AND (RCL.CtgLevelId=(CASE @CtgLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR  
	RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))
	AND (RC.CtgMainId=(CASE @CtgMainId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR  
	RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))
	--To Filter Retailers
	--To Filter Products
	SELECT DISTINCT E.PrdId,E.PrdType
	INTO #FilterProduct
	FROM ProductCategoryValue C (NOLOCK)
	INNER JOIN ProductCategoryValue D (NOLOCK) ON
	D.PrdCtgValLinkCode LIKE Cast(C.PrdCtgValLinkCode AS NVARCHAR(1000)) + '%'
	INNER JOIN Product E (NOLOCK) ON D.PrdCtgValMainId = E.PrdCtgValMainId
	INNER JOIN ProductCategoryLevel L (NOLOCK) ON L.CmpPrdCtgId = C.CmpPrdCtgId
	
	WHERE 	
	(L.CmpId=(CASE @CmpId WHEN 0 THEN L.CmpId ELSE 0 END) OR
	L.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))	AND 
	
	(L.CmpPrdCtgId = (CASE @CmpPrdCtgId  WHEN 0 THEN L.CmpPrdCtgId ELSE 0 END) OR
	L.CmpPrdCtgId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,16,@Pi_UsrId)))
	
	AND (C.PrdCtgValMainId = (CASE @PrdCtgValMainId  WHEN 0 THEN C.PrdCtgValMainId ELSE 0 END) OR 
	C.PrdCtgValMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId ,21, @Pi_UsrId)))
	--To Filter Products
	
		
		
	EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate
	SELECT * INTO #ParleOutputTaxPercentage
	FROM ParleOutputTaxPercentage (NOLOCK)		
	SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate,B.DefaultPriceId
	INTO #BillingDetails
	FROM SalesInvoice S (NOLOCK)
	INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,
	SP.PriceId,SP.SlNo,SP.PrdEditSelRte,B.DefaultPriceId
	INTO #ReturnDetails
	FROM ReturnHeader S (NOLOCK)
	INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID
	INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdId  = B.PrdId AND SP.PrdBatId = B.PrdBatId
	WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.Status = 0
	AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)
	AND EXISTS (SELECT 'C' FROM #FilterProduct FP (NOLOCK) WHERE SP.PrdId = FP.PrdId)
	SELECT TransType,RtrId,SalId,TransDate,PrdId,BaseQty TotalPCS,MRP,PriceId,SlNo,[SellRate],DefaultPriceId,
	CAST(0 AS NUMERIC(18,6))[ActualSellRate],CAST(0 AS NUMERIC(18,6))[SpecialSellRate],
	CAST(0 AS NUMERIC(18,6)) TotalLCTR, CAST(0 AS NUMERIC(18,6)) SalesTOT
	INTO #MTSalesDetails
	FROM 
	(
	SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,BaseQty,MRP,PriceId,SlNo,PrdUom1EditedSelRate [SellRate],DefaultPriceId FROM #BillingDetails
	
	UNION ALL
	
	SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,BaseQty,MRP,PriceId,SlNo,PrdEditSelRte,DefaultPriceId FROM #ReturnDetails
	
	) Consolidated
	SELECT M.TransType,M.SalId,M.RtrId,M.PrdId,M.SlNo,K.PrdId [NormalPrd],K.PrdBatId [NormalBat],
	CAST(0 AS NUMERIC(18,6)) NormalSellRate,CAST(0 AS NUMERIC(18,6)) NormalSpecialRate
	INTO #NormalProduct
	FROM #MTSalesDetails M,
	KitProductTransDt K (NOLOCK)
	WHERE M.SalId = K.TransNo AND M.PrdId = K.KitPrdId AND M.SlNo = K.SlNo
	AND K.TransId = (CASE M.TransType WHEN 2 THEN 8 ELSE 1 END) -- TransId = 1 - Billing, 8 - Sales Return
	
	DECLARE @SlNo AS INT
	SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'
	
	UPDATE M SET M.ActualSellRate = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	UPDATE M SET M.[SpecialSellRate] = D.PrdBatDetailValue
	FROM #MTSalesDetails M (NOLOCK),
	ProductBatchDetails D (NOLOCK) 
	WHERE M.PriceId = D.PriceId AND D.SLNo = @SlNo
	AND PriceCode LIKE '%-Spl Rate-%'
	
	--
	UPDATE N SET N.NormalSellRate = D.PrdBatDetailValue
	FROM #NormalProduct N (NOLOCK),
	ProductBatch B (NOLOCK),
	ProductBatchDetails D (NOLOCK)
	WHERE N.NormalBat = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo
	
	UPDATE M SET M.[ActualSellRate] = N.NormalSellRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSellRate) NormalSellRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo
	--
	
	SELECT R.RtrId,P.PrdId,B.PrdBatId,S.SplSelRate,DownloadedDate
	INTO #SpecialPrice
	FROM SpecialRateAftDownLoad S (NOLOCK),
	#FilterRetailer R,
	Product P (NOLOCK), ProductBatch B (NOLOCK)
	WHERE S.RtrCtgValueCode = R.CtgCode AND
	S.PrdCCode = P.PrdCCode AND B.PrdBatCode = S.PrdBatCCode AND P.PrdId = B.PrdId
	AND EXISTS (SELECT 'C' FROM #NormalProduct N (NOLOCK) WHERE P.PrdId = N.NormalPrd)	
	SELECT S.* 
	INTO #LatesSpecialPrice
	FROM #SpecialPrice S,
	(
		SELECT RtrId,PrdId,PrdBatId,MAX(DownloadedDate) DownloadedDate 
		FROM #SpecialPrice
		GROUP BY RtrId,PrdId,PrdBatId
	) L
	WHERE L.RtrId = S.RtrId AND L.PrdId = S.PrdId AND L.PrdBatId = S.PrdBatId AND L.DownloadedDate = S.DownloadedDate
	UPDATE N SET N.NormalSpecialRate = L.SplSelRate
	FROM #NormalProduct N (NOLOCK),
	#LatesSpecialPrice L (NOLOCK)
	WHERE N.RtrId = L.RtrId AND N.NormalPrd = L.PrdId AND N.NormalBat = L.PrdBatId
	
	UPDATE M SET M.[SpecialSellRate] = N.NormalSpecialRate
	FROM #MTSalesDetails M,
	(
	SELECT TransType,SalId,PrdId,SlNo,SUM(NormalSpecialRate) NormalSpecialRate FROM #NormalProduct
	GROUP BY TransType,SalId,PrdId,SlNo
	) N WHERE M.TransType = N.TransType AND M.SalId = N.SalId AND M.PrdId = N.PrdId AND M.SlNo = N.SlNo		
	UPDATE R SET R.TotalLCTR =  R.TotalPCS * (R.[ActualSellRate]+(R.[ActualSellRate]*(T.TaxPerc/100))),
	R.SalesTOT = R.TotalPCS * (R.[SpecialSellRate]+(R.[SpecialSellRate]*(T.TaxPerc/100)))
	FROM #MTSalesDetails R (NOLOCK),
	#ParleOutputTaxPercentage T (NOLOCK)
	WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno
	
	SELECT M.RtrId,TransDate,M.PrdId,SUM(CASE P.PrdType WHEN 3 THEN 0 ELSE TotalLCTR END) TotalLCTR,
	SUM(CASE P.PrdType WHEN 3 THEN 0 ELSE SalesTOT END) SalesTOT,
	SUM(CASE P.PrdType WHEN 3 THEN TotalLCTR ELSE 0 END) [TotalOffLCTR],
	SUM(CASE P.PrdType WHEN 3 THEN SalesTOT ELSE 0 END) [OffTOT]
	INTO #DebitNotePrduct
	FROM #MTSalesDetails M,
	Product P (NOLOCK) 
	WHERE M.PrdId = P.PrdId
	GROUP BY M.RtrId,TransDate,M.PrdId
	SELECT R.CtgMainId,R.CtgName,
	CAST(SUM(TotalLCTR) AS NUMERIC(18,2)) TotalLCTR,
	CAST(SUM(SalesTOT) AS NUMERIC(18,2)) SalesTOT,
	CAST(0 AS NUMERIC(18,2)) [ClaimDiff], CAST(0 AS NUMERIC(18,2)) [LiabSales],
	CAST(SUM(TotalOffLCTR) AS NUMERIC(18,2)) TotalOffLCTR,
	CAST(SUM(OffTOT) AS NUMERIC(18,2)) OffTOT,
	CAST(0 AS NUMERIC(18,2)) [TotalOff],CAST(0 AS NUMERIC(18,2)) [OffClaimDiff],
	CAST(0 AS NUMERIC(18,2)) [LiabOff],CAST(0 AS NUMERIC(18,2)) [TotalSales],
	CAST(0 AS NUMERIC(18,2)) [LiabWOTOT],CAST(0 AS NUMERIC(18,2)) [LiabTOT],CAST(0 AS NUMERIC(18,2)) [TotalLiab]
	INTO #DebitNote
	FROM #DebitNotePrduct D (NOLOCK),
	#FilterRetailer R (NOLOCK)
	WHERE D.RtrId = R.RtrId
	GROUP BY R.CtgName,R.CtgMainId	
	
	UPDATE D SET [ClaimDiff] = TotalLCTR - SalesTOT, [TotalOff] = [TotalOffLCTR] - [OffTOT]
	FROM #DebitNote D (NOLOCK)
	
	UPDATE D SET [LiabSales] = [ClaimDiff] / TotalLCTR
	FROM #DebitNote D (NOLOCK)
	WHERE TotalLCTR <> 0
		
	UPDATE D SET [OffClaimDiff] = [TotalOffLCTR] - [TotalOff]
	FROM #DebitNote D (NOLOCK)
	
	UPDATE D SET [LiabOff] = [OffTOT] - [TotalOff]
	FROM #DebitNote D (NOLOCK)	
	UPDATE D SET [TotalSales] = TotalLCTR + [TotalOffLCTR]
	FROM #DebitNote D (NOLOCK)
	
	UPDATE D SET [LiabWOTOT] = [LiabOff] / [TotalSales]
	FROM #DebitNote D (NOLOCK)	
	WHERE [TotalSales] <> 0
	
	UPDATE D SET [LiabTOT] = [TotalOffLCTR] / [TotalSales]
	FROM #DebitNote D (NOLOCK)
	WHERE [TotalSales] <> 0	
	

	UPDATE D SET [TotalLiab] = ([ClaimDiff] + [OffClaimDiff])/[TotalSales]
	FROM #DebitNote D (NOLOCK)
	WHERE [TotalSales] <> 0	
	
	--ICRSTPAR7049
	UPDATE D SET [LiabSales] = [LiabSales]/100.00,
	LiabWOTOT=LiabWOTOT/100.00,LiabTOT=LiabTOT/100.00,TotalLiab=TotalLiab/100.00
	FROM #DebitNote D (NOLOCK)
	--Till Here ICRSTPAR7049

	IF EXISTS (SELECT 'C' FROM SYSOBJECTS WHERE XTYPE = 'U' AND NAME = 'RptMTDebitSummary_Excel')
	DROP TABLE RptMTDebitSummary_Excel
	
	SELECT *
	INTO RptMTDebitSummary_Excel
	FROM #DebitNote D (NOLOCK)
	DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
	INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
	SELECT @Pi_RptId,Count(*) as RecCount,0,@Pi_UsrId FROM RptMTDebitSummary_Excel
	
	SELECT * FROM RptMTDebitSummary_Excel	
	DELETE FROM RptExcelHeaders WHERE RptId = 288
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,1,'CtgMainId','CtgMainId',0,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,2,'CtgName','Chain Name',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,3,'TotLCTR','Total Normal LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,4,'SalesTOT','Total  Normal  Sec Sales As Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,5,'ClaimDiff','TOT Diff Claims',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,6,'LiabSales','% Liab on Normal Sale',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,7,'TotalOffLCTR','Total Offer LCTR',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,8,'OffTOT','Total Offer Sec Sales as Per TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,9,'TotalOff','Total Offer Sec Sale As Per Offer Rate To Chain',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,10,'OffClaimDiff','Offers Claims Diff (TOT+Offer)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,11,'LiabOff','Offer Liability Value',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,12,'TotalSales','Total Sale(Offer + Non Offer)',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,13,'LiabWOTOT','% Liab of Offer Claims On Sale Without TOT',1,1)
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,14,'LiabTOT','% Liab of Offer Claims On Total Sale',1,1)		
	INSERT INTO RptExcelHeaders([RptId],[SlNo],[FieldName],[DisplayName],[DisplayFlag],[LngId]) VALUES (288,15,'TotalLiab','Total % Liab',1,1)
	RETURN
END
GO
DELETE FROM CustomUpDownload WHERE Module='DistcodeSwapConfirm'
INSERT INTO CustomUpDownload(SlNo,SeqNo,Module,Screen,ExportFnName,ImportProcName,ParkTable,
ValidateProcName,TranType,UpDownload,MandatoryFile)
SELECT 156,1,'DistcodeSwapConfirm','DistcodeSwapConfirm','Proc_Cs2Cn_DistributorCodeSwapConfirm','','Cs2Cn_Prk_DistributorCodeSwapConfirm','','Master','Upload',1
GO
DELETE FROM Tbl_UploadIntegration WHERE ProcessName='DistcodeSwapConfirm'
INSERT INTO Tbl_UploadIntegration(SequenceNo,ProcessName,FolderName,PrkTableName,CreatedDate)
SELECT 54,'DistcodeSwapConfirm','DistcodeSwapConfirm','Cs2Cn_Prk_DistributorCodeSwapConfirm',GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='Cs2Cn_Prk_DistributorCodeSwapConfirm')
BEGIN
CREATE TABLE [Cs2Cn_Prk_DistributorCodeSwapConfirm](
	[SlNo] [numeric](38, 0) IDENTITY(1,1) NOT NULL,
	[DistCode] [nvarchar](50) NULL,
	[NewDistcode] [varchar](50) NULL,
	[OldDistcode] [varchar](50) NULL,	
	[UploadFlag] [nvarchar](10) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ServerDate] [datetime] NULL
)
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='P' AND NAME='Proc_Cs2Cn_DistributorCodeSwapConfirm')
DROP PROCEDURE Proc_Cs2Cn_DistributorCodeSwapConfirm
GO
--EXEC Proc_Cs2Cn_GSTInvoiceNumberCorrection 0,'2017-07-01'
CREATE PROCEDURE [Proc_Cs2Cn_DistributorCodeSwapConfirm]
(
   @Po_ErrNo INT OUTPUT,
   @ServerDate DATETIME
)
AS
/*****************************************************************************
* PROCEDURE		: Proc_Cs2Cn_DistributorCodeSwapConfirm
* PURPOSE		: To upload distributor swaping details
* CREATED BY	: Murugan.R
* CREATED DATE	: 22/12/2017
* NOTE			:
* MODIFIED
* DATE			AUTHOR     CR/BUG			USER STORY ID	DESCRIPTION
------------------------------------------------
* {date}		{developer}									{brief modification description}
* 22/12/2017	Murugan.R	CR				CCRSTPAR0173    
********************************************************************************/
SET NOCOUNT ON
BEGIN	
    SET @Po_ErrNo=0
	DECLARE @DistCode As nVarchar(50)
	DELETE FROM Cs2Cn_Prk_DistributorCodeSwapConfirm WHERE UploadFlag = 'Y'	
	SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)
	
    INSERT INTO Cs2Cn_Prk_DistributorCodeSwapConfirm
    ([DistCode],NewDistcode,OldDistcode,[UploadFlag],ServerDate)
	SELECT @DistCode,DistributorCode,ActualDistributorCode,'N',@ServerDate
	FROM Distributor (NOLOCK) WHERE DistributorCode<>ActualDistributorCode
 
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_RailwayDiscountReconsolidation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_RailwayDiscountReconsolidation]
GO
/*  
Begin transaction  
update A set rptupload =0 from salesinvoice A where SalInvDate between '2017-09-01'and'2017-09-30'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,''  
EXEC Proc_Cs2Cn_DebitNoteTopSheet2 0,'2017-12-20'  
select * from Cs2Cn_Prk_DebitNoteTopSheet2 where cmpschcode ='SCH09383' order by slno  
Rollback Transaction  
*/  
CREATE PROCEDURE [dbo].[Proc_Cs2Cn_RailwayDiscountReconsolidation]  
(  
 @Po_ErrNo INT OUTPUT,  
 @ServerDate DATETIME  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cs2Cn_RailwayDiscountReconsolidation   
* PURPOSE  :   
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* {date} {developer}  {brief modification description}  
   
*********************************/  
SET NOCOUNT ON  
BEGIN  
   
 SET @Po_ErrNo=0  
   
 DECLARE @DistCode   As NVARCHAR(50)  
 DELETE FROM Cs2Cn_Prk_RailwayDiscountReconsolidation WHERE UploadFlag = 'Y'  
   
 TRUNCATE TABLE UploadingReportTransaction  
   
 INSERT INTO UploadingReportTransaction (TransType,TransId,TransNo,TransDate)  
 SELECT 1,SalId,SalInvNo,SalInvDate FROM SalesInvoice (NOLOCK) WHERE DlvSts > 3 AND RptUpload = 0  
 UNION ALL  
 SELECT 2,ReturnID,ReturnCode,ReturnDate FROM ReturnHeader (NOLOCK) WHERE Status = 0 AND RptUpload = 0  
   
 IF NOT EXISTS (SELECT '' FROM UploadingReportTransaction (NOLOCK))  
 BEGIN  
  RETURN  
 END  
   
 DECLARE @FromDate DATETIME  
 DECLARE @ToDate DATETIME  
   
 SELECT @FromDate = MIN(TransDate),@ToDate = MAX(TransDate)   
 FROM UploadingReportTransaction (NOLOCK)  
   
 EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate  
   
 SELECT * INTO #ParleOutputTaxPercentage  
 FROM ParleOutputTaxPercentage (NOLOCK)  
 SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)   
   
 --To Filter Retailers  
 SELECT DISTINCT R.RtrId,RC.CtgCode  
 INTO #FilterRetailer  
 FROM Retailer R (NOLOCK),  
 RetailerValueClassMap RVCM (NOLOCK),  
 RetailerValueClass RVC (NOLOCK),  
 RetailerCategory RC (NOLOCK),  
 RetailerCategoryLevel RCL (NOLOCK)  
 WHERE R.Rtrid = RVCM.RtrId AND RVCM.RtrValueClassId = RVC.RtrClassId  
 AND  RVC.CtgMainId=RC.CtgMainId AND  RCL.CtgLevelId=RC.CtgLevelId  
 AND RC.CtgCode = 'RAI'  
 --To Filter Retailers  
   
 SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
 SP.PriceId,SP.SlNo,SP.PrdUom1EditedSelRate  
 INTO #BillingDetails  
 FROM SalesInvoice S (NOLOCK)
 INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
 --inner join SalesInvoiceSchemeLineWise Sch (Nolock) ON Sch.salid =sp.salid and sch.salid =s.salid and sch.prdid =sp.prdid and sch.prdbatid =sp.PrdBatId 
 WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.SalInvDate)  
 AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
 AND S.DlvSts > 3  
   
 SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,  
 SP.PriceId,SP.SlNo,SP.PrdEditSelRte  
 INTO #ReturnDetails  
 FROM ReturnHeader S (NOLOCK)  
 INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID  
 WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate = S.ReturnDate)  
 AND EXISTS (SELECT 'C' FROM #FilterRetailer FR (NOLOCK) WHERE S.RtrId = FR.RtrId)  
 AND S.[Status] = 0  
   
 SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty TotalPCS,MRP,PriceId,SlNo,CAST(0 AS NUMERIC(18,6))[SellRate],  
 CAST(0 AS NUMERIC(18,2)) IRCTCMargin,CAST(0 AS INT) [Type],CAST(0 AS NUMERIC(18,2)) AS LCTR  
 INTO #RailwaySalesDetails  
 FROM   
 (  
 SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo FROM #BillingDetails  
 UNION ALL  
 SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,MRP,PriceId,SlNo FROM #ReturnDetails  
   
 ) Consolidated  
 DECLARE @SlNo AS INT  
   
 SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
   
 UPDATE R SET R.[SellRate] = D.PrdBatDetailValue  
 FROM #RailwaySalesDetails R (NOLOCK),  
 ProductBatch B (NOLOCK),  
 ProductBatchDetails D (NOLOCK)  
 WHERE R.PrdBatId = B.PrdBatId AND B.DefaultPriceId = D.PriceId AND D.SLNo = @SlNo   
   
 SELECT R.PriceId,C.DiscountPerc,C.[TYPE]  
 INTO #ExistingSpecialPrice  
 FROM #RailwaySalesDetails R (NOLOCK),  
 SpecialRateAftDownLoad_Calc C (NOLOCK)  
 WHERE R.PriceId = CAST(REPLACE(C.ContractPriceIds,'-','') AS BIGINT)  
   
 UPDATE R SET R.IRCTCMargin = S.DiscountPerc,R.[Type] = S.[TYPE]  
 FROM #RailwaySalesDetails R (NOLOCK),  
 #ExistingSpecialPrice S (NOLOCK)  
 WHERE R.PriceId = S.PriceId  
   
 UPDATE R SET R.LCTR = R.[SellRate] + (R.[SellRate]*(T.TaxPerc/100))  
 FROM #RailwaySalesDetails R (NOLOCK),  
 #ParleOutputTaxPercentage T (NOLOCK)  
 WHERE R.TransType = T.TransId AND R.SalId = T.Salid AND R.Slno = T.PrdSlno  
     
 SELECT RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,SUM(TotalPCS) TotalPCS,MRP,  
 LCTR,IRCTCMargin,CASE S.[Type] WHEN 1 THEN 'Mark Up' WHEN 2 THEN 'Mark Down' ELSE '' END MarkUpDown,  
 CAST(0 AS NUMERIC(18,6)) IRCTCRate,  
 CAST(0 AS NUMERIC(18,6)) TotalMRP,CAST(0 AS NUMERIC(18,6)) TotalLCTR,  
 CAST(0 AS NUMERIC(18,6)) IRCTCTotal,CAST(0 AS NUMERIC(18,6)) ClmAmount,  
 CAST(0 AS NUMERIC(18,2)) LibOnMRP,CAST(0 AS NUMERIC(18,2)) LibOnLCTR  
 INTO #RailwayDiscount  
 FROM #RailwaySalesDetails S (NOLOCK)  
 INNER JOIN Product P (NOLOCK) ON S.PrdId = P.PrdId  
 GROUP BY RtrId,TransDate,P.PrdId,P.PrdName,P.PrdCCode,MRP,LCTR,IRCTCMargin,S.[Type]  
   
 UPDATE R SET R.IRCTCRate = MRP - (MRP * IRCTCMargin / 100.00), TotalMRP  = TotalPCS * MRP, TotalLCTR = TotalPCS * LCTR  
 FROM #RailwayDiscount R (NOLOCK)  
   
 UPDATE R SET R.IRCTCTotal = TotalPCS * IRCTCRate  
 FROM #RailwayDiscount R (NOLOCK)  
 UPDATE R SET R.ClmAmount = TotalLCTR - IRCTCTotal  
 FROM #RailwayDiscount R (NOLOCK)  
 UPDATE R SET R.LibOnMRP = ClmAmount / TotalMRP  
 FROM #RailwayDiscount R (NOLOCK)  
 WHERE R.TotalMRP <> 0  
 UPDATE R SET R.LibOnLCTR = ClmAmount / TotalLCTR  
 FROM #RailwayDiscount R (NOLOCK)  
 WHERE R.TotalLCTR <> 0  
   
 INSERT INTO Cs2Cn_Prk_RailwayDiscountReconsolidation (DistCode,TransDate,CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,  
 LibOnLCTR,UploadFlag,SyncId,ServerDate)  
   
 SELECT @DistCode,TransDate,R.CmpRtrCode,PrdCCode,TotalPCS,MRP,LCTR,IRCTCMargin,MarkUpDown,IRCTCRate,TotalMRP,TotalLCTR,IRCTCTotal,ClmAmount,LibOnMRP,  
 LibOnLCTR,'N' UploadFlag,NULL,@ServerDate  
 FROM #RailwayDiscount RD,  
 Retailer R (NOLOCK)  
 WHERE RD.RtrId = R.RtrId  
 RETURN     
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_DailySales]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_DailySales]
GO
/*    
begin tran   
delete from errorlog  
--select * from Cs2Cn_Prk_DailySales (nolock)
update SalesInvoice set upload = 0 where salinvno in('PPL02681702910') 
EXEC Proc_Cs2Cn_DailySales 0,'2017-11-06'    
SELECT LCTRAmount,* FROM Cs2Cn_Prk_DailySales (NOLOCK) where salinvno in('PPL02681702910')  
select * from errorlog  
rollback tran     
*/    
CREATE PROCEDURE [dbo].[Proc_Cs2Cn_DailySales]    
(    
 @Po_ErrNo INT OUTPUT,    
 @ServerDate DATETIME  
)
AS    
/*********************************    
* PROCEDURE  : Proc_Cs2Cn_DailySales    
* PURPOSE  : To Extract Daily Sales Details from CoreStocky to upload to Console    
* CREATED BY : Nandakumar R.G    
* CREATED DATE : 19/03/2010    
* NOTE   :    
* MODIFIED BY : LAKSHMAN M  
* MODIFIED DATE : 06/11/2017   
* PMS ID   : ICRSTPAR6569  
* PURPOSE  : Daily Sales Details from CoreStocky upload LCTR Calculation Validation changed.    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
21/10/2014 Jisha Mathew Included Undelivered bills New Column Added BillStatus,UploadedDate     
12/12/2015 PRAVEENRAJ BHASKARAN LCTRAmount ADDED FOR CCRSTPAR0118    
09/11/2016 Gopikrishnan RtrUniqueCode Added    
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************    
09-01-2018  lakshman M   BZ     ICRSTPAR7284          LCTR Formula velidation changed (special price not consider in LCTR Value).
*********************************/    
SET NOCOUNT ON    
BEGIN    
 DECLARE @CmpId    AS INT    
 DECLARE @DistCode As nVarchar(50)    
 DECLARE @DefCmpAlone AS INT    
 SET @Po_ErrNo=0    
 DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'Y'    
 IF EXISTS (SELECT * FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2)    
 BEGIN    
  DELETE FROM Cs2Cn_Prk_DailySales WHERE UploadFlag='N' AND Billstatus<=2    
 END    
 SELECT @DefCmpAlone=Status FROM Configuration WHERE ModuleId='BotreeUpload01' AND ModuleName='Botree Upload'    
 SELECT @DistCode = DistributorCode FROM Distributor     
 SELECT @CmpId = CmpId FROM Company WHERE DefaultCompany = 1     
 INSERT INTO Cs2Cn_Prk_DailySales    
 (    
  DistCode  ,    
  SalInvNo  ,    
  SalInvDate  ,    
  SalDlvDate  ,    
  SalInvMode  ,    
  SalInvType  ,    
  SalGrossAmt  ,    
  SalSplDiscAmt ,    
  SalSchDiscAmt ,    
  SalCashDiscAmt ,    
  SalDBDiscAmt ,    
  SalTaxAmt  ,    
  SalWDSAmt  ,    
  SalDbAdjAmt  ,    
  SalCrAdjAmt  ,    
  SalOnAccountAmt ,    
  SalMktRetAmt ,    
  SalReplaceAmt ,    
  SalOtherChargesAmt,    
  SalInvLevelDiscAmt,    
  SalTotDedn  ,    
  SalTotAddn  ,    
  SalRoundOffAmt ,    
  SalNetAmt  ,    
  LcnId   ,    
  LcnCode   ,    
  SalesmanCode ,    
  SalesmanName ,     
  SalesRouteCode ,    
  SalesRouteName ,    
  RtrId   ,    
  RtrCode   ,    
  RtrName   ,    
  VechName  ,    
  DlvBoyName  ,    
  DeliveryRouteCode ,     
  DeliveryRouteName ,     
  PrdCode    ,    
  PrdBatCde   ,    
  PrdQty    ,    
  PrdSelRateBeforeTax ,    
  PrdSelRateAfterTax ,    
  PrdFreeQty  ,    
  PrdGrossAmt  ,    
  PrdSplDiscAmt ,    
  PrdSchDiscAmt ,    
  PrdCashDiscAmt ,    
  PrdDBDiscAmt ,    
  PrdTaxAmt  ,    
  PrdNetAmt  ,    
  UploadFlag  ,    
  SalInvLineCount ,    
  SalInvLvlDiscPer,    
  BillStatus,    
  UploadedDate,    
  OrderRefNo,    
  SFAOrderRefNo,    
  RtrUniqueCode    
 )    
 SELECT  @DistCode,A.SalInvNo,A.SalInvDate,A.SalDlvDate,    
 (CASE A.BillMode WHEN 1 THEN 'Cash' ELSE 'Credit' END) AS BillMode,    
 (CASE A.BillType WHEN 1 THEN 'Order Booking' WHEN 2 THEN 'Ready Stock' ELSE 'Van Sales' END) AS BillType,    
 A.SalGrossAmount,A.SalSplDiscAmount,A.SalSchDiscAmount,A.SalCDAmount,A.SalDBDiscAmount,A.SalTaxAmount,    
 A.WindowDisplayAmount,A.DBAdjAmount,A.CRAdjAmount,A.OnAccountAmount,A.MarketRetAmount,A.ReplacementDiffAmount,    
 A.OtherCharges,A.SalInvLvlDisc AS InvLevelDiscAmt,A.TotalDeduction,A.TotalAddition,A.SalRoundOffAmt,A.SalNetAmt,A.LcnId,L.LcnCode,    
 B.SMCode,B.SMName,C.RMCode,C.RMName,A.RtrId,R.CmpRtrCode,R.RtrName,    
 ISNULL(E.VehicleRegNo,'') AS VehicleName,ISNULL(D.DlvBoyName,''),F.RMCode,F.RMName,H.PrdCCode,I.CmpBatCode,    
 G.BaseQty AS SalInvQty ,G.PrdUom1EditedSelRate,G.PrdUom1EditedNetRate,G.SalManFreeQty AS SalInvFree ,    
 G.PrdGrossAmount,G.PrdSplDiscAmount,G.PrdSchDiscAmount,    
 G.PrdCDAmount,G.PrdDBDiscAmount,G.PrdTaxAmount,G.PrdNetAmount,    
 'N' AS UploadFlag,0,A.SalInvLvlDiscPer,Dlvsts AS BillStatus,    
 GETDATE(),ISNULL(O.OrderNo,''),ISNULL(O.DocRefNo,''),isnull(R.RtrUniqueCode,'')     
 FROM SalesInvoice A  (NOLOCK)    
 INNER JOIN Retailer R (NOLOCK) ON A.RtrId = R.RtrId    
 INNER JOIN SalesMan B (NOLOCK) ON A.SMID = B.SmID    
 INNER JOIN RouteMaster C (NOLOCK) ON A.RMID = C.RMID    
 LEFT OUTER JOIN DeliveryBoy D  (NOLOCK) ON A.DlvBoyId = D.DlvBoyId    
 LEFT OUTER JOIN Vehicle E (NOLOCK) ON E.VehicleId = A. VehicleId    
 INNER JOIN RouteMaster F (NOLOCK) ON A.DlvRMID = F.RMID    
 INNER JOIN SalesInvoiceProduct G (NOLOCK) ON A.SalId = G.SalId    
 INNER JOIN Product H (NOLOCK) ON G.PrdId = H.PrdId    
 INNER JOIN ProductBatch I (NOLOCK) ON G.PrdBatID = I.PrdBatId AND H.PrdId=I.PrdId    
 INNER JOIN Location L (NOLOCK) ON L.LcnId=A.LcnId    
 LEFT OUTER JOIN OrderBooking O(NOLOCK) ON O.OrderNo=A.OrderKeyNo    
 WHERE A.Upload=0 ORDER BY A.SalId    
 --UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 --FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 --INNER JOIN (    
 --SELECT SalId,SalInvNo,PrdCCode,CmpBatCode,ISNULL(GrossAmt,0) AS GrossAmt,ISNULL(TaxAmount,0) AS TaxAmount,  
 --ISNULL(GrossAmt+TaxAmount,0) AS LCTRAmt     
 --FROM(    
 --SELECT S.SALID,S.SALINVNO,P.PRDID,P.PRDCCODE,PB.CmpBatCode,SP.BASEQTY,SP.PrdUom1EditedSelRate,  
 --ISNULL((SP.BASEQTY*SP.PrdUom1EditedSelRate),0) AS GrossAmt,    
 --ISNULL(Tax.TaxAmount,0) AS TaxAmount    
 --FROM SalesInvoice S (NOLOCK)    
 --INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId=SP.SALID    
 --INNER JOIN (    
 --SELECT SalId,PrdSlno,SUM(TaxAmount) TaxAmount FROM SalesInvoiceProductTax (NOLOCK)    
 --GROUP BY SalId,PrdSlno    
 --)Tax ON Tax.SalId=S.SalId AND SP.SalId=Tax.SalId AND SP.SlNo=Tax.PrdSlNo    
 --INNER JOIN Product P (NOLOCK) ON P.PrdId=SP.PrdId    
 --INNER JOIN ProductBatch PB ON PB.PrdId=P.PrdId AND PB.PrdBatId=SP.PrdBatId    
 --) X    
 --WHERE EXISTS (SELECT SalInvNo,PrdCode,PrdBatCde FROM Cs2Cn_Prk_DailySales Y WHERE     
 --X.SalInvNo=Y.SalInvNo AND X.PrdCCode=Y.PrdCode AND X.CmpBatCode=Y.PrdBatCde)    
 --) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
 ---------- Modified by Lakshman M on 06/11/2017 PMS_ICRSTPAR6569 ------------  
  UPDATE A SET A.LCTRAmount=ISNULL(Z.LCTRAmt,0)    
 FROM Cs2Cn_Prk_DailySales A (NOLOCK)    
 INNER JOIN (    
    SELECT SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc,SUM(TaxableAmount) as TaxableAmount,SUM(LCTRAmt)as LCTRAmt FROM (
    SELECT DISTINCT A.SalId SalID ,A.SalInvNo SalInvNo,B.PrdId PrdId,P.PrdCCode PrdCCode,PB.CmpBatCode CmpBatCode,(C.TaxPerc) As taxperc,  
  (C.TaxableAmount) AS TaxableAmount,--PBD.PrdBatDetailValue,
  ((B.BaseQty *(round(PBD.PrdBatDetailValue,2)))+((B.BaseQty *(round(PBD.PrdBatDetailValue,2)))*sum(c.TaxPerc/100)))  As LCTRAmt
  --((B.BaseQty *(round(B.PrdUnitSelRate,2)))+(B.PrdTaxAmount))  As LCTRAmt,
  --((B.BaseQty *(round(B.PrdUnitSelRate,2)))+((B.BaseQty *(round(B.PrdUnitSelRate,2)))*sum(c.TaxPerc/100)))  As LCTRAmt
  
  FROM SalesInvoice A (NOLOCK)  
  INNER JOIN SalesInvoiceProduct B (NOLOCK) ON A.SALID=B.SALID  
  INNER JOIN SalesInvoiceProductTax C (NOLOCK) ON A.SalId=C.SalId AND B.SalId=C.SalId AND B.SlNo=C.PrdSlNo  
  INNER JOIN PRODUCT P (NOLOCK) ON B.PrdId=P.PrdId  
  INNER JOIN ProductBatch PB (NOLOCK) ON PB.PrdId=P.PrdId AND PB.PrdId=B.PrdId AND PB.PrdBatId=B.PrdBatId  
  INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =PB.PrdBatId and DefaultPrice =1	
  INNER JOIN Cs2Cn_Prk_DailySales PRK (NOLOCK)  
  ON PRK.SalInvNo=A.SalInvNo AND PRK.PrdCode=P.PrdCCode AND PRK.PrdBatCde=PB.CmpBatCode  
  where C.TaxableAmount >0 and PBD.SLNo =3 --and A.SalInvNo in('PPL41011700683') and PB.PrdId =6802 
  GROUP BY A.SalId,A.SalInvNo,B.PrdId,B.PrdUom1EditedSelRate,C.TaxPerc,P.PrdCCode,PB.CmpBatCode,C.TaxableAmount,B.PrdGrossAmount,B.PrdTaxAmount,
  B.BaseQty,B.prdtaxamount,PBD.PrdBatDetailValue--,B.PrdUnitSelRate,
  HAVING (SUM(C.TaxableAmount))>0 ) A 
  Group by  SalID,SalInvNo,PrdId,PrdCCode,CmpBatCode,taxperc     
 ) Z ON Z.SalInvNo=A.SalInvNo AND Z.PrdCCode=A.PrdCode AND Z.CmpBatCode=A.PrdBatCde    
   ----------------- till here --------------------  
 UPDATE DayEndProcess SET NextUpDate = CONVERT(nVarChar(10),GetDate(),121),    
 ProcDate = CONVERT(nVarChar(10),GetDate(),121)    
 Where ProcId = 1    
 UPDATE A SET SalInvLineCount=B.SalInvLineCount    
 FROM Cs2Cn_Prk_DailySales A,(SELECT SI.SalInvNo,COUNT(SIP.PrdId) AS SalInvLineCount     
 FROM SalesInvoice SI,SalesInvoiceProduct SIP WHERE     
 SI.UPload=0 AND SI.SalId=SIP.SalId    
 GROUP BY SI.SalInvNo) B    
 WHERE A.SalInvNo=B.SalInvNo    
 --->Added By Nanda on 17/08/2010    
 INSERT INTO Cs2Cn_Prk_SalesInvoiceOrders(DistCode,SalInvNo,OrderNo,OrderDate,UploadFlag)    
 SELECT DISTINCT @DistCode,SI.SalInvNo,OB.OrderNo,OB.OrderDate,'N'    
 FROM SalesInvoice SI,SalesinvoiceOrderBooking SIOB,OrderBooking OB    
 WHERE SI.SalId=SIOB.SalId AND SIOB.OrderNo=OB.OrderNo AND SI.Upload=0 AND SI.DlvSts>3    
 --->Till Here    
 UPDATE SalesInvoice SET Upload=1 WHERE Upload=0 AND SalInvNo IN (SELECT DISTINCT    
 SalInvNo FROM Cs2Cn_Prk_DailySales WHERE UploadFlag = 'N') AND Dlvsts IN (3,4,5)    
 UPDATE Cs2Cn_Prk_DailySales SET ServerDate=@ServerDate    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cs2Cn_DebitNoteTopSheet2]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cs2Cn_DebitNoteTopSheet2]
GO
/*  
Begin transaction  
update A set rptupload =0 from salesinvoice A where SalInvDate between '2017-09-01'and'2017-09-30'
exec Proc_Cs2Cn_RailwayDiscountReconsolidation 0,''  
EXEC Proc_Cs2Cn_DebitNoteTopSheet2 0,'2017-12-20'  
select * from Cs2Cn_Prk_DebitNoteTopSheet2 where cmpschcode ='SCH09383' order by slno  
Rollback Transaction  
*/  
CREATE PROCEDURE [dbo].[Proc_Cs2Cn_DebitNoteTopSheet2]  
(  
 @Po_ErrNo INT OUTPUT,  
 @ServerDate DATETIME  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cs2Cn_DebitNoteTopSheet2   
* PURPOSE  : To Extract LMISDetails  
* CREATED BY : Aravindh Deva C  
* CREATED DATE : 03.06.2016  
* NOTE   :   
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*************************************************  
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]  
* 18-12-2017  Lakshman. M    ICRSTPAR7106        BUG      Scheme id validation missing.Script validation added from CS.   
*************************************************/  
SET NOCOUNT ON  
BEGIN  
   
 SET @Po_ErrNo=0  
   
 DECLARE @DistCode As NVARCHAR(50)  
 DELETE FROM Cs2Cn_Prk_DebitNoteTopSheet2 WHERE UploadFlag = 'Y'  
   
 IF NOT EXISTS (SELECT * FROM UploadingReportTransaction (NOLOCK))  
 BEGIN  
  RETURN  
 END  
 SELECT @DistCode = DistributorCode FROM Distributor(NOLOCK)   
   
 DECLARE @FromDate DATETIME  
 DECLARE @ToDate DATETIME  
 
Select @ToDate=MAX(TransDate) from UploadingReportTransaction
     
 SELECT @FromDate = MIN(SchValidFrom) FROM SchemeMaster S (NOLOCK)  
 WHERE EXISTS (SELECT 'C' FROM UploadingReportTransaction FP (NOLOCK) WHERE FP.TransDate BETWEEN S.SchValidFrom AND S.SchValidTill)  
 EXEC Proc_ReturnSalesProductTaxPercentage @FromDate,@ToDate  
   
 SELECT * INTO #ParleOutputTaxPercentage  
 FROM ParleOutputTaxPercentage (NOLOCK)  
-------------------- commented by Lakshman on 07/11/2017----------  
-- SELECT S.SalId,S.SalInvNo,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,  
-- B.DefaultPriceId ActualPriceId,SP.SlNo  
-- INTO #BillingDetails  
-- FROM SalesInvoice S (NOLOCK)  
-- INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId  
-- INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId  
-- WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3  
-- SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,  
-- B.DefaultPriceId,SP.SlNo  
-- INTO #ReturnDetails  
-- FROM ReturnHeader S (NOLOCK)  
-- INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID  
-- INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId  
-- WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0   
-- SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,  
-- CAST (0 AS NUMERIC(18,6)) AS LCTR  
-- INTO #DebitSalesDetails  
-- FROM   
-- (  
-- SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo FROM #BillingDetails  
--   
-- UNION ALL  
--   
-- SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId,SlNo FROM #ReturnDetails  
--   
-- ) Consolidated    
--   
-- DECLARE @SlNo AS INT  
-- SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
--   
-- UPDATE M SET M.ActualSellRate = D.PrdBatDetailValue  
-- FROM #DebitSalesDetails M (NOLOCK),  
-- ProductBatchDetails D (NOLOCK)   
-- WHERE M.ActualPriceId = D.PriceId AND D.SLNo = @SlNo  
-- UPDATE R SET R.LCTR = R.BaseQty * (R.ActualSellRate+(R.ActualSellRate*(T.TaxPerc/100)))  
-- FROM #DebitSalesDetails R (NOLOCK),  
-- #ParleOutputTaxPercentage T (NOLOCK)  
-- WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType  
---------- till here ------  
 -------------------- Added by Lakshman M On 07/11/2017 PMS_ICRSTPAR6575-------------------  
 SELECT S.SalId,S.SalInvNo,sch.schid,S.SalInvDate,S.RtrId,SP.PrdId,SP.PrdBatId,SP.BaseQty BaseQty,      
 B.DefaultPriceId ActualPriceId,SP.SlNo,sp.PrdTaxAmount,PrdUnitSelRate,PrdBatDetailValue      
 INTO #BillingDetails      
 FROM SalesInvoice S (NOLOCK)      
 INNER JOIN SalesInvoiceProduct SP (NOLOCK) ON S.SalId = SP.SalId      
 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId   
 INNER JOIN SalesInvoiceSchemeLineWise sch (NOLOCK)ON  sch.salid=s.salid and sch.salid =sp.salid    
 and sch.prdid =sp.prdid and sch.prdbatid =  sp.prdbatid   
 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1
 WHERE SalInvDate BETWEEN @FromDate AND @ToDate AND S.DlvSts > 3 and PBD.SLNo =3
 
   
 SELECT S.ReturnID,S.ReturnCode,S.ReturnDate,S.RtrId,SP.PrdId,SP.PrdBatId,-1 * SP.BaseQty BaseQty,SP.PrdUnitMRP MRP,      
 B.DefaultPriceId,SP.SlNo,SP.PrdEditSelRte,sp.PrdTaxAmt as prdtaxamount,PrdUnitSelRte as  PrdUnitSelRate,PrdBatDetailValue 
 INTO #ReturnDetails      
 FROM ReturnHeader S (NOLOCK)      
 INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID = SP.ReturnID      
 INNER JOIN ProductBatch B (NOLOCK) ON SP.PrdBatId = B.PrdBatId    
 INNER JOIN ProductBatchDetails PBD (NOLOCK) ON PBD.PrdBatId =B.PrdBatId and DefaultPrice =1  
 WHERE ReturnDate BETWEEN @FromDate AND @ToDate AND S.[Status] = 0 and PBD.SLNo =3
     
 SELECT TransType,RtrId,SalId,TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,CAST (0 AS NUMERIC(18,6)) AS ActualSellRate,prdtaxamount,PrdBatDetailValue as PrdUnitSelRate,     
 CAST (0 AS NUMERIC(18,6)) AS LCTR      
 INTO #DebitSalesDetails      
 FROM       
 (      
 SELECT 1 TransType,RtrId,SalId,SalInvDate TransDate,PrdId,PrdBatId,BaseQty,ActualPriceId,SlNo,prdtaxamount,PrdBatDetailValue FROM #BillingDetails      
 UNION ALL      
 SELECT 2 TransType,RtrId,ReturnID,ReturnDate TransDate,PrdId,PrdBatId,BaseQty,DefaultPriceId,SlNo,prdtaxamount,PrdBatDetailValue FROM #ReturnDetails      
 ) Consolidated
   
 DECLARE @SlNo AS INT  
 SELECT @SlNo = SlNo FROM BatchCreation (NOLOCK) WHERE FieldDesc = 'Selling Price'  
 UPDATE M SET M.ActualSellRate = round(D.PrdBatDetailValue,2)      
 FROM #DebitSalesDetails M (NOLOCK),      
 ProductBatchDetails D (NOLOCK)       
 WHERE M.ActualPriceId = D.PriceId AND D.SLNo = @SlNo    
 ---------------- commented by Lakshman M on 07/11/2017 ---------------    
 --UPDATE R SET R.LCTR = R.BaseQty *(R.ActualSellRate+(R.ActualSellRate*(T.TaxPerc/100)))      
 --FROM #DebitSalesDetails R (NOLOCK),      
 --#ParleOutputTaxPercentage T (NOLOCK)   
  -----------------------  
 UPDATE R SET R.LCTR = ((R.BaseQty *(R.PrdUnitSelRate))+(R.PrdUnitSelRate *(T.TaxPerc/100)))    
 FROM #DebitSalesDetails R (NOLOCK),    
 #ParleOutputTaxPercentage T (NOLOCK)
 WHERE R.SalId = T.Salid AND R.Slno = T.PrdSlno AND T.TransId = R.TransType    
 --------------------- Till Here ----------------    
 CREATE TABLE #ApplicableProduct  
 (  
  SchId  INT,  
  PrdId   INT  
 )  
   
 ------------------ added by lakshman M on 21-12-2017 sales invoice scheme added --------------  
  INSERT INTO #ApplicableProduct(SchId,PrdId)      
  SELECT DISTINCT A.SchId,B.Prdid      
  FROM SchemeMaster A      
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid      
  INNER JOIN Product C On B.Prdid = C.PrdId     
  INNER JOIN salesinvoiceschemelinewise sch ON Sch.schid =A.schid and sch.prdid =C.prdid  
  WHERE A.SchemeLvlMode = 0 AND B.PrdId <> 0    
  UNION ALL       
  SELECT DISTINCT A.SchId,E.Prdid      
  FROM SchemeMaster A      
  INNER JOIN SchemeProducts B ON A.Schid = B.Schid      
  INNER JOIN ProductCategoryValue C ON       
  B.PrdCtgValMainId = C.PrdCtgValMainId       
  INNER JOIN ProductCategoryValue D ON      
  D.PrdCtgValLinkCode LIKE Cast(c.PrdCtgValLinkCode as nvarchar(1000)) + '%'      
  INNER JOIN Product E On      
  D.PrdCtgValMainId = E.PrdCtgValMainId       
  INNER JOIN ProductBatch F On      
  F.PrdId = E.Prdid  
  INNER JOIN salesinvoiceschemelinewise sch ON Sch.schid =A.schid and sch.prdid =E.prdid      
  WHERE A.SchemeLvlMode = 0 AND B.PrdCtgValMainId <> 0    
  UNION ALL      
  SELECT DISTINCT S.SchId,B.MasterRecordId      
  FROM SchemeProducts A       
  INNER JOIN UdcDetails B on B.UDCUniqueId =A.PrdCtgValMainId       
  INNER JOIN SchemeMaster S ON A.SchId = S.SchId    
  INNER JOIN salesinvoiceschemelinewise sch ON Sch.schid =S.schid and sch.PrdId =A.PrdId and sch.PrdBatId =A.PrdBatId 
  WHERE S.SchemeLvlMode = 1  
  --------------- till here ----------------  
 CREATE TABLE #ApplicableScheme  
 (  
  SchId   INT,  
  CmpSchCode  NVARCHAR(40),  
  SchValidFrom DATETIME,  
  SchValidTill DATETIME,   
  Budget   NUMERIC(18,2),  
  BudgetAllocationNo VARCHAR(100),  
  PrdId   INT  
 )  
 ------------- added by M. Lakshman dated on 18-12-2017 ----- Scheme id validation ----------   
 INSERT INTO #ApplicableScheme (SchId,CmpSchCode,SchValidFrom,SchValidTill,Budget,BudgetAllocationNo,PrdId)     
 SELECT DISTINCT A.SchId,S.CmpSchCode,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo, A.PrdId  
 FROM #ApplicableProduct A (NOLOCK),  
 SchemeMaster S (NOLOCK),#BillingDetails B (NOLOCK)  
 WHERE A.SchId = S.SchId AND B.schid =S.schid AND B.SalInvDate BETWEEN S.SchValidFrom AND S.SchValidTill  
 AND S.Claimable = 1  
 ----------------- Till here --------------  
   
 SELECT S.SchId,S.CmpSchCode,S.SchValidFrom,S.SchValidTill,S.Budget,S.BudgetAllocationNo,  
 SUM(B.BaseQty) [SecSalesQty],CAST(SUM(B.LCTR) AS NUMERIC(18,2)) [SecSalesVal],CAST(0 AS NUMERIC(18,2)) Liab,  
 CAST(0 AS NUMERIC(18,2)) Amount  
 INTO #SchemeDebit  
 FROM #ApplicableScheme S (NOLOCK),  
 #DebitSalesDetails B (NOLOCK)   
 WHERE S.PrdId = B.PrdId AND B.TransDate BETWEEN S.SchValidFrom AND S.SchValidTill  
 GROUP BY S.SchId,S.CmpSchCode,S.SchValidFrom,S.SchValidTill,Budget,BudgetAllocationNo  
 ORDER BY S.SchId
   
 --Commented and Added by Mohana ICRSTPAR6760
 --UPDATE SD SET SD.Amount = DBO.Fn_ReturnBudgetUtilized(SD.SchId)  
 --FROM #SchemeDebit SD (NOLOCK)
	
 UPDATE SD SET SD.Amount = DBO.Fn_ReturnBudgetUtilized_scheme(SD.SchId,@FromDate,@ToDate)   
 FROM #SchemeDebit SD (NOLOCK)  
   
 UPDATE SD SET SD.Liab = CAST(( SD.Amount / SD.[SecSalesVal]) AS NUMERIC(18,2))  
 FROM #SchemeDebit SD (NOLOCK)  
 WHERE SD.[SecSalesVal] <> 0  
    
 INSERT INTO Cs2Cn_Prk_DebitNoteTopSheet2 (DistCode,CmpSchCode,SecSalesQty,SecSalesVal,Liab,Amount,  
 UploadFlag,SyncId,ServerDate)  
 SELECT @DistCode,CmpSchCode,[SecSalesQty],[SecSalesVal],Liab,Amount,  
 'N' UploadFlag,NULL,@ServerDate  
 FROM #SchemeDebit  
   
 RETURN     
END  
GO
--Script From Live ScriptUpdater 
IF EXISTS(SELECT NAME FROM Sysobjects WHERE XTYPE='P' and NAME='Proc_Cn2Cs_GSTConfiguration')
DROP PROCEDURE Proc_Cn2Cs_GSTConfiguration
GO
/*
BEGIN TRAN
DELETE FROM ERRORLOG
INSERT INTO Cn2Cs_Prk_GSTConfiguration
SELECT DistributorCode,'GSTCONFIG','2017-04-19','YES','YES','D',GETDATE() FROM Distributor
exec Proc_Cn2Cs_GSTConfiguration 0
SELECT * FROM GSTConfiguration
select * From Cn2Cs_Prk_GSTConfiguration
SELECT * FROM ERRORLOG
ROLLBACK TRAN
*/
CREATE PROCEDURE Proc_Cn2Cs_GSTConfiguration
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_GSTConfiguration
* PURPOSE		: To validate the downloaded GST Configuration details from Console
* CREATED		: S.Moorthi
* CREATED DATE	: 17/04/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @ActivationStatus AS TINYINT
	DECLARE @ConsoleAckStatus AS TINYINT
	DECLARE @ActivationDate AS DATETIME
	DECLARE @SpmId AS INT
	DECLARE @TaxGroupId AS INT
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT
	
	CREATE TABLE #Cn2Cs_Prk_GSTConfiguration
	(
		ModuleId			[Varchar](50),
		ActivationDate		[datetime],
		ActivationStatus	 [Varchar](50),
		ConsoleAcknowledgeStatus	[Varchar](10)		
	)
	DELETE FROM Cn2Cs_Prk_GSTConfiguration WHERE DownLoadFlag='Y'
	
	IF NOT EXISTS(SELECT 'X' FROM Cn2Cs_Prk_GSTConfiguration (NOLOCK) WHERE DownLoadFlag='D')
	BEGIN
		RETURN
	END
	
	SELECT ModuleId,MAX(CreatedDate) as CreatedDate
	INTO #LatestMaster
	FROM Cn2Cs_Prk_GSTConfiguration WHERE DownLoadFlag='D'
	GROUP BY ModuleId
	
	INSERT INTO #Cn2Cs_Prk_GSTConfiguration(ModuleId,ActivationDate,ActivationStatus,ConsoleAcknowledgeStatus)
	SELECT DISTINCT A.ModuleId,A.ActivationDate,ActivationStatus,ConsoleAcknowledgeStatus
	FROM Cn2Cs_Prk_GSTConfiguration A (NOLOCK) INNER JOIN #LatestMaster B ON A.ModuleId=B.ModuleId 
	and A.CreatedDate=B.CreatedDate
	WHERE DownLoadFlag='D'
	
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'GSTConfiguration','GSTConfiguration','GST Configuration Details Should not be empty' 
	FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE (
	LEN(RTRIM(LTRIM(ISNULL(ModuleId,''))))=0 
	OR LEN(RTRIM(LTRIM(ISNULL(ActivationDate,''))))=0 
	OR LEN(RTRIM(LTRIM(ISNULL(ActivationStatus,''))))=0 
	)
	DELETE A FROM #Cn2Cs_Prk_GSTConfiguration A
	WHERE 
	(
		LEN(RTRIM(LTRIM(ISNULL(ModuleId,''))))=0 
		OR LEN(RTRIM(LTRIM(ISNULL(ActivationDate,''))))=0 
		OR LEN(RTRIM(LTRIM(ISNULL(ActivationStatus,''))))=0 
	)
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 4,'GSTConfiguration','ModuleId','Console Acknowledge Status already completed,Can not modified ' 
	FROM #Cn2Cs_Prk_GSTConfiguration B WHERE 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.ConsoleAckStatus=1 and A.AcknowledgeStatus=1)
	
	DELETE B FROM #Cn2Cs_Prk_GSTConfiguration B WHERE 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.ConsoleAckStatus=1 and A.AcknowledgeStatus=1)
	--ActivationStatus
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 2,'GSTConfiguration','ActivationStatus','Activation Status should be YES/NO - '+ActivationStatus FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ActivationStatus,'')))) NOT IN ('YES','NO')
	
	DELETE FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ActivationStatus,'')))) NOT IN ('YES','NO')
	
	--Acknowledge Status
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 3,'GSTConfiguration','ConsoleAcknowledgeStatus','Console Acknowledge Status Status should be YES/NO - '+ConsoleAcknowledgeStatus FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ConsoleAcknowledgeStatus,'')))) NOT IN ('YES','NO')
	
	DELETE FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ConsoleAcknowledgeStatus,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 3,'GSTConfiguration','ModuleId','Invalid Module Id - '+ConsoleAcknowledgeStatus FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ModuleId,'')))) NOT IN ('GSTCONFIG')
	
	DELETE FROM #Cn2Cs_Prk_GSTConfiguration
	WHERE UPPER(RTRIM(LTRIM(ISNULL(ModuleId,'')))) NOT IN ('GSTCONFIG')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 4,'GSTConfiguration','ModuleId','Console Acknowledge Status does not allow With out GST activation '+ConsoleAcknowledgeStatus 
	FROM #Cn2Cs_Prk_GSTConfiguration B WHERE B.ConsoleAcknowledgeStatus='YES' AND 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.ActivationStatus=0)
	
	DELETE B FROM #Cn2Cs_Prk_GSTConfiguration B WHERE B.ConsoleAcknowledgeStatus='YES' AND 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.ActivationStatus=0)
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT 4,'GSTConfiguration','ModuleId','Console Acknowledge Status does not allow With out Core Stocky Approval '+ConsoleAcknowledgeStatus 
	FROM #Cn2Cs_Prk_GSTConfiguration B WHERE B.ConsoleAcknowledgeStatus='YES' AND 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.AcknowledgeStatus=0)
	
	DELETE B FROM #Cn2Cs_Prk_GSTConfiguration B WHERE B.ConsoleAcknowledgeStatus='YES' AND 
	EXISTS (SELECT * FROM GSTConfiguration A WHERE A.MODULEID='GSTCONFIG' AND A.AcknowledgeStatus=0)
	
	SET @ActivationStatus=0
	SET @ConsoleAckStatus=0
	
	IF NOT EXISTS(SELECT * FROM #Cn2Cs_Prk_GSTConfiguration)
	BEGIN
		RETURN
	END
	
	IF EXISTS(SELECT * FROM #Cn2Cs_Prk_GSTConfiguration)
	BEGIN
		
		SELECT @ActivationStatus=CASE WHEN ActivationStatus='YES' THEN 1 ELSE 0 END,
		@ConsoleAckStatus=CASE WHEN ConsoleAcknowledgeStatus='YES' THEN 1 ELSE 0 END,
		@ActivationDate= ActivationDate
		FROM #Cn2Cs_Prk_GSTConfiguration
		
		IF EXISTS(SELECT * FROM GSTConfiguration WHERE ModuleId='GSTCONFIG' and AcknowledgeStatus=0)
		BEGIN
			IF EXISTS(SELECT '*' FROM GSTConfiguration WHERE ModuleId='GSTCONFIG' and ActivationStatus=0)
			BEGIN
				UPDATE GSTConfiguration SET ActivationStatus=@ActivationStatus
				WHERE ModuleId='GSTCONFIG' 
			END
			
			UPDATE GSTConfiguration SET DownloadActDate=GETDATE(),ActivationDate=CONVERT(DATETIME,CONVERT(VARCHAR(10),@ActivationDate,121),121)
			WHERE ModuleId='GSTCONFIG' 
			
		END
		
		IF EXISTS(SELECT * FROM GSTConfiguration WHERE ModuleId='GSTCONFIG' and ActivationStatus=1 AND AcknowledgeStatus=1)
		BEGIN
			UPDATE GSTConfiguration SET ConsoleAckStatus=@ConsoleAckStatus,DownloadAcknowDate=GETDATE()
			WHERE ModuleId='GSTCONFIG'
		END
	END
	
	---Tax Status enable
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and ModuleId='GSTConfig')
	BEGIN
		UPDATE TaxSettingMaster Set Status=1 WHERE TaxType='GST'
		
			--Product Batch Tax Setting
		IF NOT EXISTS(SELECT '*' FROM ProductBatchVATTaxB4GST (NOLOCK))
			BEGIN
				
				CREATE TABLE #DefaultPrice
					(
						PrdId		BIGINT,
						PrdBatId	BIGINT,
						PriceId		BIGINT
					)
				
				INSERT INTO ProductBatchVATTaxB4GST(PrdId,PrdBatId,PrdTaxGroupId,BatchTaxGroupId,DefaultPriceId,CreatedDate)
				SELECT DISTINCT P.PrdId,PB.PrdBatId,P.TaxGroupId,PB.TaxGroupId as BatTaxGroupId,0,GETDATE() FROM Product P (NOLOCK)
				INNER JOIN ProductBatch PB (NOLOCK) ON P.PrdId=PB.PrdId
				
				UPDATE PBV SET PBV.DefaultPriceId=PB.DefaultPriceId FROM ProductBatch PB(NOLOCK)
				INNER JOIN ProductBatchDetails PBD (NOLOCK)ON PB.PrdBatId=PBD.PrdBatId AND PB.DefaultPriceId=PBD.PriceId AND PBD.DefaultPrice=1
				INNER JOIN ProductBatchVATTaxB4GST PBV (NOLOCK) ON PBV.PrdId=PB.PrdId AND PBV.PrdBatId=PB.PrdBatId 
				AND PBV.PrdBatId=PBD.PrdBatId
				
				IF EXISTS(SELECT * FROM ProductBatchVATTaxB4GST (NOLOCK) WHERE DefaultPriceId=0)
				BEGIN
				
					INSERT INTO #DefaultPrice(PrdId,PrdBatId,PriceId)
					SELECT PB.PrdId,PB.PrdBatId,MAX(PBD.PriceId) AS PriceId FROM ProductBatch PB(NOLOCK)
					INNER JOIN ProductBatchDetails PBD (NOLOCK)ON PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1
					INNER JOIN ProductBatchVATTaxB4GST PBV (NOLOCK) ON PBV.PrdId=PB.PrdId AND PBV.PrdBatId=PB.PrdBatId 
					AND PBV.PrdBatId=PBD.PrdBatId
					WHERE PBV.DefaultPriceId=0
					GROUP BY PB.PrdId,PB.PrdBatId
					
					UPDATE A SET A.DefaultPriceId=B.PriceId FROM ProductBatchVATTaxB4GST A 
					INNER JOIN #DefaultPrice B (NOLOCK) ON A.PrdId=b.PrdId and A.PrdBatId=B.PrdBatId 
					WHERE A.DefaultPriceId=0
				END
				
				IF EXISTS(SELECT * FROM ProductBatchVATTaxB4GST (NOLOCK) WHERE DefaultPriceId=0)
				BEGIN
				
					TRUNCATE TABLE #DefaultPrice

					INSERT INTO #DefaultPrice(PrdId,PrdBatId,PriceId)
					SELECT PB.PrdId,PB.PrdBatId,MAX(PBD.PriceId) AS PriceId FROM ProductBatch PB(NOLOCK)
					INNER JOIN ProductBatchDetails PBD (NOLOCK)ON PB.PrdBatId=PBD.PrdBatId --AND PBD.DefaultPrice=1
					INNER JOIN ProductBatchVATTaxB4GST PBV (NOLOCK) ON PBV.PrdId=PB.PrdId AND PBV.PrdBatId=PB.PrdBatId 
					AND PBV.PrdBatId=PBD.PrdBatId
					WHERE PBV.DefaultPriceId=0
					GROUP BY PB.PrdId,PB.PrdBatId
					
					UPDATE A SET A.DefaultPriceId=B.PriceId FROM ProductBatchVATTaxB4GST A 
					INNER JOIN #DefaultPrice B (NOLOCK) ON A.PrdId=b.PrdId and A.PrdBatId=B.PrdBatId 
					WHERE A.DefaultPriceId=0
					
				END
				
				UPDATE A SET A.TaxGroupId=0 FROM Product A
				UPDATE A SET A.TaxGroupId=0 FROM ProductBatch A				
				
			END
			
			--Retailer Tax Group Backup
			IF NOT EXISTS(SELECT '*' FROM RetailerVATTaxB4GST (NOLOCK))
			BEGIN
								
				INSERT INTO RetailerVATTaxB4GST(RtrId,TaxGroupId,DefaultShipId,ShippingTaxGroupId,CreatedDate)
				SELECT RtrID,TaxGroupId,0,0,GETDATE() fROM Retailer (NOLOCK)
				
				UPDATE A SET A.ShippingTaxGroupId=B.TaxGroupId,A.DefaultShipId=B.RtrShipId FROM RetailerVATTaxB4GST A (NOLOCK)
				INNER JOIN RetailerShipAdd B(NOLOCK) ON A.RtrId=B.RtrId
				WHERE B.RtrShipDefaultAdd=1
				
				UPDATE R SET R.TaxGroupId=0 FROM Retailer R(NOLOCK)
			END
			
			--Supplier Tax Group			
			IF EXISTS(SELECT '*' FROM Supplier WHERE ISNULL(TaxGroupId,0)<>0)
			BEGIN
				SET @SpmId=0
				SET @TaxGroupId=0
				SELECT @SpmId=MAX(ISNULL(SpmId,0)) FROM Supplier WHERE ISNULL(TaxGroupId,0)<>0
				SELECT @TaxGroupId=TaxGroupId FROM Supplier WHERE SpmId=@SpmId

				INSERT INTO VATDefaultSupplier(SpmId,TaxGroupId,CreatedDate)
				SELECT @SpmId,@TaxGroupId,GETDATE()
				
				UPDATE R SET R.TaxGroupId=0 FROM Supplier R(NOLOCK)
			END						
			--IDT Tax Group
			IF EXISTS(SELECT '*' FROM IDTMaster WHERE ISNULL(TaxGroupId,0)<>0)
			BEGIN
				SET @SpmId=0
				SET @TaxGroupId=0
				SELECT @SpmId=MAX(ISNULL(SpmId,0)) FROM IDTMASTER WHERE ISNULL(TaxGroupId,0)<>0
				SELECT @TaxGroupId=TaxGroupId FROM IDTMASTER WHERE SpmId=@SpmId

				INSERT INTO VATDefaultIDT(SpmId,TaxGroupId,CreatedDate)
				SELECT @SpmId,@TaxGroupId,GETDATE()
			
				UPDATE R SET R.TaxGroupId=0 FROM IDTMASTER R(NOLOCK)
			END
			
			--Retailer Shipping Address
			IF EXISTS(SELECT '*' FROM RetailerShipAdd WHERE ISNULL(TaxGroupId,0)<>0)
			BEGIN
				UPDATE R SET R.TaxGroupId=0 FROM RetailerShipAdd R(NOLOCK)
			END
			
			--Bill Series Setting
			DELETE FROM ManualConfiguration WHERE  ModuleId IN ('ReturnHeader','ReturnGSTR1','ClaimSheetHD','PurchaseReturn','ServiceInvoicehd','ServiceInvoiceHd_Unreg',
			'CreditNoteRetailer','DebitNoteRetailer','ServiceInvoiceDistributor','SamplePurchaseReceipt','FreeIssueHd') AND ProjectName='GST'
			INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo])
			Select 'GST','ReturnHeader','ReturnCode','Distributor Code Added in Slaes Return',1,'PPL',0.00,3 UNION
			Select 'GST','ClaimSheetHD','ClmCode','Distributor Code Added in Claim Sheet HD',1,'PPL',0.00,4 UNION
			Select 'GST','PurchaseReturn','PurRetRefNo','Distributor Code Added in Purchase Return',0,'',0.00,5 UNION
			Select 'GST','ServiceInvoicehd','ServiceInvRefNo','Distributor Code Added in Service Invoice',1,'PPL',0.00,6 UNION
			Select 'GST','ServiceInvoiceHd_Unreg','ServiceInvRefNo','Distributor Code Added in ALL Service Invoice UnRegisterd Retailer',1,'PPL',0.00,7 UNION
			Select 'GST','ServiceInvoiceDistributor','ServiceInvRefNo','Distributor Code Added in ALL Service Invoice Distributor',1,'PPL',0.00,8 UNION
			Select 'GST','CreditNoteRetailer','CrNoteNumber','Distributor Code Added in Credit Note Retailer',1,'PPL',0.00,9 UNION
			Select 'GST','DebitNoteRetailer','DbNoteNumber','Distributor Code Added in Debit Note Retailer',1,'PPL',0.00,10 UNION
			Select 'GST','SamplePurchaseReceipt','ReturnRefNo','Distributor Code Added in Sample Return',0,'',0.00,11 UNION
			Select 'GST','FreeIssueHd','IssueRefNo','Distributor Code Added in Free issue',0,'',0.00,12 UNION 
			Select 'GST','ReturnGSTR1','ReturnCode','Distributor Code Added in Slaes Return',1,'PPL',0.00,13 
			
			DELETE FROM ManualConfiguration WHERE PROJECTNAME='GST' AND ModuleId='BILL_EDIT2' AND MODULENAME='BillSeriesSetting'
			INSERT INTO ManualConfiguration([ProjectName],[ModuleId],[ModuleName],[Description],[Status],[Condition],[ConfigValue],[SeqNo])
			SELECT 'GST','BILL_EDIT2','BillSeriesSetting','Distributor Code Added in Bill series Prefix',1,'',4.00,2
			
			DELETE FROM MANUALCONFIGURATION WHERE PROJECTNAME='GST' AND ModuleId='REPLACEMENT1' AND MODULENAME='CreditNoteReplacement'
			INSERT INTO ManualConfiguration(ProjectName,ModuleId,ModuleName,Description,Status,Condition,ConfigValue,SeqNo)
			SELECT 'GST','REPLACEMENT1','CreditNoteReplacement','Block Repalcement in CreditNoteReplacement',1,'',0.00,1
			
			If EXISTS (SELECT * FROM Configuration where ModuleId ='SALESRTN15')
			BEGIN 
				UPDATE Configuration SET Status=1  where ModuleId ='SALESRTN15'
			END 
			ELSE
			BEGIN
			   INSERT INTO Configuration(Moduleid,ModuleName,Description,Status,Condition,ConfigValue,Seqno)
			   SELECT 'SALESRTN15','Sales Return','Perform automatic Credit Note / Replacement selection entry based on the rule setting',1,'',0.00,1
			END
			
			UPDATE ManualConfiguration SET Status=0 WHERE PROJECTNAME='GST' AND ModuleId='BILL_EDIT1' AND MODULENAME='BILLING'
			
		IF EXISTS (SELECT * FROM ManualConfiguration (NOLOCK)
		WHERE ModuleId = 'BILL_EDIT2' AND ModuleName = 'BillSeriesSetting' AND Status = 1)
		BEGIN
			IF EXISTS (SELECT * FROM ManualConfiguration (NOLOCK) 
			WHERE ModuleId = 'BILL_EDIT3' AND ModuleName = 'BillSeriesSetting' AND Status = 0)
			BEGIN
			
			UPDATE Counters SET CurrValue=0,Prefix='GS',DisplayFlag=1 WHERE TabName='ClaimSheetHd' and FldName='ClmCode'
			UPDATE Counters SET CurrValue=0,Prefix='SR',DisplayFlag=1 WHERE TabName='ServiceInvoiceHd' and FldName='ServiceInvRefNo'
			UPDATE Counters SET CurrValue=0,Prefix='SU',DisplayFlag=1 WHERE TabName='ServiceInvoiceHd_Unreg' and FldName='ServiceInvRefNo'
			UPDATE Counters SET CurrValue=0,Prefix='DS',DisplayFlag=1 WHERE TabName='ServiceInvoiceHd' and FldName='ServiceInvoiceDistributor'
			
			UPDATE Counters SET CurrValue=0,Prefix='SRN',DisplayFlag=1,Zpad=5 WHERE TabName='ReturnHeader' and FldName='ReturnCode'
			UPDATE Counters SET CurrValue=0,Prefix='GST',DisplayFlag=1 WHERE TabName='ReturnGSTR1' and FldName='ReturnCode'
			
			UPDATE Counters SET CurrValue=0,Prefix='CR',DisplayFlag=1 WHERE TabName='CreditNoteRetailer' and FldName='CrNoteNumber'
			UPDATE Counters SET CurrValue=0,Prefix='DB',DisplayFlag=1 WHERE TabName='DebitNoteRetailer' and FldName='DbNoteNumber'
			
			
			UPDATE BillSeriesHD SET YearConfig=1
			
			DECLARE @Sequenceid AS INT
			DECLARE @SeriesId AS INT
			DECLARE @SeriesDT AS INT
			DECLARE @SeriesDTMAX AS INT
			DECLARE @Curvalue as BIGINT
			SET @Sequenceid=(SELECT ISNULL(MAX(Billseqid),1) from BillSequenceMaster)
			SET @SeriesId=(SELECT ISNULL(MAX(SeriesId)+1,1) from BillSeriesHd)
			SET @SeriesDT=(SELECT ISNULL(MAX(SeriesDtId)+1,1) from BillSeriesdt)
			SET @SeriesDTMAX=(SELECT ISNULL(MAX(SeriesDtId),0) from BillSeriesdt)
			SET @Curvalue=(SELECT ISNULL(CurrValue,0) from BillSeriesDtValue where SeriesDtId=@SeriesDTMAX)

			INSERT INTO BillSeriesHd(SeriesID,SeriesMasterId,SequenceId,
			Availability,LastModBy,LastModDate,AuthId,AuthDate)
			SELECT @SeriesId,3,@Sequenceid,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)

			INSERT INTO BillSeriesdt(SeriesDtId,SeriesID,SeriesMasterId,SeriesValue,Availability,LastModBy,Lastmoddate,Authid,Authdate)
			SELECT @SeriesDT,@SeriesId,3,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121)

			INSERT INTO BillSeriesDtValue(SeriesDtId,Prefix,Zpad,Currvalue,Availability,LastModBy,Lastmoddate,Authid,AuthDate,DistCode)
			SELECT @SeriesDT,'PPL',5,0,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,CONVERT(VARCHAR(10),GETDATE(),121),''
			
				Declare @SeriesDtId Int
				DECLARE @Prefix Nvarchar(50)
				DECLARE Cur_Billseries CURSOR
				FOR Select SeriesDtId FROM BillSeriesDt where SeriesID IN(Select max(SeriesID) FROM BillSeriesHD)
				OPEN Cur_Billseries
				FETCH NEXT FROM Cur_Billseries INTO @SeriesDtId
				WHILE @@FETCH_STATUS=0
				BEGIN					
					SELECT @Prefix = Prefix  FROM Fn_Prefix() where SeriesDtId = @SeriesDtId
					UPDATE billseriesdtvalue SET Prefix = (select [prefix] FROM Fn_Billseriessetting (@Prefix)), 
					CurrValue = 0,DistCode = (select DistCode FROM Fn_Billseriessetting(@Prefix)) WHERE  seriesdtid = @SeriesDtId			
					FETCH NEXT FROM Cur_Billseries INTO @SeriesDtId
						END
						CLOSE Cur_Billseries
						DEALLOCATE Cur_Billseries
						
						DECLARE @ModuleName Nvarchar(50)						
						DECLARE @TabName Nvarchar(50)
						DECLARE @FldName Nvarchar(50)
						DECLARE Cur_Billseries CURSOR
						FOR SELECT B.ModuleName,b.[Prefix],A.ModuleId,A.ModuleName from manualconfiguration A (NOLOCK)
						INNER JOIN (select * FROM dbo.FN_Gst_ReturnCounterPrefix()) b ON A.ModuleId = b.TabName AND A.ModuleName = b.FldName
						AND A.Status=1
						OPEN Cur_Billseries
						FETCH NEXT FROM Cur_Billseries INTO @ModuleName,@Prefix,@TabName,@FldName
						WHILE @@FETCH_STATUS=0
						BEGIN
						
							Update counters SET [Prefix] = (SELECT [prefix] FROM Fn_Gst_countersetting(@ModuleName,@Prefix,@TabName,@FldName))
							where TabName = @TabName and FldName = @FldName
							FETCH NEXT FROM Cur_Billseries INTO @ModuleName,@Prefix,@TabName,@FldName
						END
						CLOSE Cur_Billseries
						DEALLOCATE Cur_Billseries		
						
						UPDATE ManualConfiguration SET Status = 1
						WHERE ModuleId = 'BILL_EDIT3' AND ModuleName = 'BillSeriesSetting' AND Status = 0 
					END	
				END					
			END

	UPDATE A SET DownLoadFlag='Y' FROM Cn2Cs_Prk_GSTConfiguration A 
	INNER JOIN #Cn2Cs_Prk_GSTConfiguration B ON A.ModuleId=B.ModuleId
	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ISGSTINNumber' AND XTYPE IN('TF','FN'))
DROP FUNCTION Fn_ISGSTINNumber
GO
--SELECT DBO.Fn_ISGSTINNumber('11GPKPM5222K1G5')
CREATE FUNCTION Fn_ISGSTINNumber(@gSTINNumber AS Varchar(20))--,@StateId as Int
RETURNS INT
/*********************************
* FUNCTION: Fn_ISGSTINNumber
* PURPOSE: GSTIN Number Validation
* NOTES: 
* CREATED: Murugan.R 27/02/2017
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 
*********************************/
AS
BEGIN
	/*
	a.	First 2 digits should be Numeric.
	b.	Next 10 digits should be as PAN no validation (First 5 character should alphabetic, next 4 character should be Numeric and last character should alphabetic).
	c.	13th digit should be Numeric.
	d.	14th digit should be Alphabetic.
	e.	15th digit should be Numeric.
	*/
	DECLARE @gSTIN AS TINYINT
	DECLARE @gStateCode AS Varchar(15)
	SET @gSTIN=0
	
	RETURN @gSTIN
	
	IF LEN(LTRIM(RTRIM(@gSTINNumber)))<>15
	BEGIN
		SET @gSTIN=1
	END
	---First 2 digits should be Numeric 
	IF (SELECT DBO.Fn_ISInt(LEFT(@gSTINNumber,2)))=0
	BEGIN
		SET @gSTIN=1
	END
	---Next 10 digits should be as PAN no validation (First 5 character should alphabetic, 
	--next 4 character should be Numeric and last character should alphabetic
	IF (SELECT DBO.Fn_ISAlpha(SUBSTRING(@gSTINNumber,3,5)))=0
	BEGIN
		SET @gSTIN=1
	END
	
	
	IF (SELECT DBO.Fn_ISInt(SUBSTRING(@gSTINNumber,8,4)))=0
	BEGIN
		SET @gSTIN=1
	END
	
	IF (SELECT DBO.Fn_ISAlpha(SUBSTRING(@gSTINNumber,12,1)))=0
	BEGIN
		SET @gSTIN=1
	END
	
	IF ((SELECT DBO.Fn_ISInt(SUBSTRING(@gSTINNumber,13,1)))=0) AND  ((SELECT DBO.Fn_ISAlpha(SUBSTRING(@gSTINNumber,13,1)))=0)
	BEGIN
		SET @gSTIN=1
	END
	
	IF ((SELECT DBO.Fn_ISAlpha(SUBSTRING(@gSTINNumber,14,1)))=0) AND ((SELECT DBO.Fn_ISInt(SUBSTRING(@gSTINNumber,14,1)))=0)
	BEGIN
		SET @gSTIN=1
	END
	
	IF ((SELECT DBO.Fn_ISInt(SUBSTRING(@gSTINNumber,15,1)))=0) AND ((SELECT DBO.Fn_ISAlpha(SUBSTRING(@gSTINNumber,15,1)))=0)
	BEGIN
		SET @gSTIN=1
	END
	
	--IF @gSTIN=0 AND @StateId>0
	--BEGIN
	--	SELECT @gStateCode=StateCode FROM StateMaster (NOLOCK) WHERE Stateid=@StateId 
	--	IF @gStateCode<>LEFT(@gSTINNumber,2)
	--	BEGIN
	--		SET @gSTIN=2
	--	END
	--END 
	
	RETURN @gSTIN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Fn_ISPanNumber' AND XTYPE IN('TF','FN'))
DROP FUNCTION Fn_ISPanNumber
GO
--SELECT DBO.Fn_ISPanNumber('GAAAY3556Y')
CREATE FUNCTION Fn_ISPanNumber(@gPanNumber AS Varchar(20))--,@StateId as Int
RETURNS INT
/*********************************
* FUNCTION: Fn_ISPanNumber
* PURPOSE: Pancard Number Validation
* NOTES: 
* CREATED: Murugan.R 27/02/2017
* MODIFIED 
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* 
*********************************/
AS
BEGIN
	/*	
	1. First 5 character should alphabetic. 
	2. Next 4 character should be Numeric 
	3. Last character should alphabetic.	
	*/
	DECLARE @gPnum AS TINYINT
	
	SET @gPnum=0
	RETURN @gPnum
	
	IF LEN(LTRIM(RTRIM(@gPanNumber)))<>10
	BEGIN
		SET @gPnum=1
	END
	IF (SELECT DBO.Fn_ISAlpha(SUBSTRING(@gPanNumber,1,5)))=0
	BEGIN
		SET @gPnum=1
	END
		
	IF (SELECT DBO.Fn_ISInt(SUBSTRING(@gPanNumber,6,4)))=0
	BEGIN
		SET @gPnum=1
	END
	
	IF (SELECT DBO.Fn_ISAlpha(SUBSTRING(@gPanNumber,10,1)))=0
	BEGIN
		SET @gPnum=1
	END
	
	RETURN @gPnum
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='Proc_Cn2Cs_DistributorInfo' AND XTYPE='P')  
DROP PROCEDURE Proc_Cn2Cs_DistributorInfo
GO
CREATE PROCEDURE Proc_Cn2Cs_DistributorInfo  
(  
 @Po_ErrNo INT OUTPUT  
)  
AS  
/*********************************  
* PROCEDURE  : Proc_Cn2Cs_DistributorInfo  
* PURPOSE  : To validate the downloaded Distributor Info details from Console  
* CREATED  : S.Moorthi  
* CREATED DATE : 13/04/2017  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*********************************/  
SET NOCOUNT ON  
BEGIN  
 /*  
 COMPOSITE  
 REGULAR  
 */  
 SET @Po_ErrNo=0  
 DECLARE @PanNumber AS VARCHAR(25)  
 DECLARE @GSTTIN AS VARCHAR(25)   
 DECLARE @StateName as VARCHAR(200)  
 DECLARE @DistributorType AS VARCHAR(20)  
 DECLARE @EmailID AS VARCHAR(50)   
 DECLARE @ContactNumber AS VARCHAR(50)  
 DECLARE @DistCode AS VARCHAR(50)   
 DECLARE @AadharNo AS VARCHAR(50)  
 DECLARE @DrugLicense AS VARCHAR(50)  
 DECLARE @DLvalidTill AS DATETIME  
 DECLARE @FoodLicense AS VARCHAR(50)  
 DECLARE @FLvalidTill AS DATETIME  
   
 SET @PanNumber=''  
 SET @DistributorType=''  
 SET @GSTTIN=''  
 SET @StateName=''  
 SET @EmailID=''  
 SET @ContactNumber=''  
 SET @DistCode=''  
 SET @AadharNo=''  
 SET @DrugLicense=''  
 SET @DLvalidTill=''  
 SET @FoodLicense=''  
 SET @FLvalidTill=''  
    
 IF NOT EXISTS(SELECT '*' FROM Cn2Cs_Prk_DistributorInfo WHERE DownLoadFlag='D')  
 BEGIN  
  RETURN  
 END  
 SELECT * INTO #Cn2Cs_Prk_DistributorInfo FROM Cn2Cs_Prk_DistributorInfo WHERE DownLoadFlag='D'  
   
 DELETE A FROM #Cn2Cs_Prk_DistributorInfo A  
 WHERE CreatedDate<>(SELECT MAX(CreatedDate) FROM #Cn2Cs_Prk_DistributorInfo)  
   
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT DISTINCT 1,'Distributor Info','Distributor Info','Invalid Distributor' FROM #Cn2Cs_Prk_DistributorInfo A   
 WHERE NOT EXISTS(SELECT DISTRIBUTORCODE FROM Distributor B WHERE A.DISTCODE=B.DISTRIBUTORCODE)  
   
 DELETE A FROM  #Cn2Cs_Prk_DistributorInfo A  
 WHERE NOT EXISTS(SELECT DISTRIBUTORCODE FROM Distributor B WHERE A.DISTCODE=B.DISTRIBUTORCODE)  
   
 --INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 --SELECT DISTINCT 1,'Distributor Info','Distributor Info','Distributor Info Should not be empty'   
 --FROM #Cn2Cs_Prk_DistributorInfo  
 --WHERE (RTRIM(LTRIM(ISNULL(PanNumber,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(StateCode,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(DistributorType,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')  
   
   
 --DELETE A FROM  #Cn2Cs_Prk_DistributorInfo A  
 --WHERE (RTRIM(LTRIM(ISNULL(PanNumber,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(StateCode,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(DistributorType,'')))=''   
 --OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')  
 
 INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 SELECT DISTINCT 6,'Distributor Info','DistributorType','DistributorType Should be COMPOSITE / REGULAR 'e FROM   
 #Cn2Cs_Prk_DistributorInfo A WHERE RTRIM(LTRIM(UPPER(ISNULL(DistributorType,'')))) NOT IN ('Composition','REGULAR')  
   
 DELETE A  FROM #Cn2Cs_Prk_DistributorInfo A   
 WHERE RTRIM(LTRIM(UPPER(ISNULL(DistributorType,'')))) NOT IN ('Composition','REGULAR')  
    
 IF EXISTS(SELECT DISTINCT DistCode FROM #Cn2Cs_Prk_DistributorInfo A   
 WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))  
 BEGIN  
    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 4,'Distributor Info','State Code','Distributor Info State Code Not available-' FROM #Cn2Cs_Prk_DistributorInfo A   
  WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))  
    
  DELETE A  FROM #Cn2Cs_Prk_DistributorInfo A   
  WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))  
 END  
   
 IF EXISTS(SELECT '*' FROM #Cn2Cs_Prk_DistributorInfo CSM  
   INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode  
   WHERE NOT EXISTS(  
    SELECT UD.* FROM UdcHD A (NOLOCK)  
    INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
    INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId  
    WHERE UPPER(A.MasterName)='DISTRIBUTOR INFO MASTER' AND B.ColumnName='State Name'   
    AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)  
    )  
 BEGIN  
   
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 5,'Distributor Info','StateName','Distributor Info State Code Not available ' FROM #Cn2Cs_Prk_DistributorInfo CSM  
   INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode  
   WHERE NOT EXISTS(  
    SELECT UD.* FROM UdcHD A (NOLOCK)  
    INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
    INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId  
    WHERE UPPER(A.MasterName)='DISTRIBUTOR INFO MASTER' AND B.ColumnName='State Name'   
    AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)  
      
   DELETE CSM FROM #Cn2Cs_Prk_DistributorInfo CSM  
   INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode  
   WHERE NOT EXISTS(  
    SELECT UD.* FROM UdcHD A (NOLOCK)  
    INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
    INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId  
    WHERE UPPER(A.MasterName)='DISTRIBUTOR INFO MASTER' AND B.ColumnName='State Name'   
    AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)  
 END  
 SET @AadharNo=''  
 SET @DrugLicense=''  
 SET @DLvalidTill=''  
 SET @FoodLicense=''  
 SET @FLvalidTill=''  
   
 SELECT @GSTTIN=GSTTIN,@DistributorType=DistributorType,@PanNumber=PanNumber,@StateName=B.StateName,  
 @EmailID=EmailID,@ContactNumber=ContactNumber,@DistCode=DistCode,@AadharNo=AadharNo,  
 @DrugLicense=DrugLicense,@DLvalidTill=ISNULL(DLvalidTill,'1990-01-01'),  
 @FoodLicense=FoodLicense,@FLvalidTill=ISNULL(FLvalidTill,'1990-01-01') FROM #Cn2Cs_Prk_DistributorInfo A   
 INNER JOIN StateMaster B ON A.StateCode=B.StateCode  
   
 --IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''  
 --BEGIN  
 -- IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1  
 -- BEGIN  
 --  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 --  SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'  
 --  SET @Po_ErrNo =1  
 -- END  
 --END  
   
 --IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''  
 --BEGIN  
 -- IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1  
 -- BEGIN  
 --  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)  
 --  SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'  
 --  SET @Po_ErrNo =1  
 -- END  
 --END  
   
 IF @Po_ErrNo=0  
 BEGIN  
   
  IF ISNULL(@ContactNumber,'')<>''  
  BEGIN  
   UPDATE Distributor SET PhoneNo=@ContactNumber  
  END  
    
  IF ISNULL(@EmailID,'')<>''  
  BEGIN  
   UPDATE Distributor SET EmailID=@EmailID  
  END  
    
    
  DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='DISTRIBUTOR INFO MASTER' AND [Column Code]=@DistCode  
    
  INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)  
  SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','State Name',@DistCode,@StateName,0 UNION ALL  
  SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','Distributor Type',@DistCode,@DistributorType,0 --UNION ALL  
    
  IF RTRIM(LTRIM(UPPER(ISNULL(@AadharNo,''))))<>''  
  BEGIN  
   INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)  
   SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','Aadhar No',@DistCode,@AadharNo,0   
  END  
    
  IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''  
  BEGIN  
   INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)  
   SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','GSTIN',@DistCode,@GSTTIN,0   
  END  
    
  IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''  
  BEGIN  
   --IF EXISTS(SELECT * FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.ID   
   -- WHERE A.NAME='Distributor' and B.Name='PANNumber' AND A.XTYPE='U')  
   --BEGIN  
   -- UPDATE Distributor SET PANNumber=@PanNumber  
   --END  
   --ELSE  
   --BEGIN  
    INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)   
    SELECT DISTINCT 'DISTRIBUTOR INFO MASTER','PAN Number',@DistCode,@PanNumber,0  
   --END  
  END  
    
  IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='DISTRIBUTOR INFO MASTER')  
  BEGIN    
   EXEC Proc_Validate_CN2CS_UdcDetails 0     
  END  
 END  
   
 UPDATE E SET E.DownLoadFlag='Y' FROM UdcHD A (NOLOCK)  
 INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId   
 INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId AND C.UdcMasterId=C.UdcMasterId   
 INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=C.MasterRecordId   
 INNER JOIN Cn2Cs_Prk_DistributorInfo E (NOLOCK) ON E.DistCode=D.DistributorCode --AND C.ColumnValue=E.GSTTIN  
 WHERE UPPER(A.MasterName)='DISTRIBUTOR INFO MASTER' AND B.ColumnName='State Name' 
 

 RETURN  
END
GO
IF EXISTS(SELECT B.* FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.ID WHERE 
B.NAME='DocRefNo' AND A.name='StockJournal' AND A.xtype='U' AND B.LENGTH<100)
BEGIN
	ALTER TABLE StockJournal ALTER COLUMN DocRefNo Nvarchar(100)
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ValidateRetailerMasterGST' AND type='P')
DROP PROCEDURE Proc_ValidateRetailerMasterGST
GO
/*
 BEGIN TRAN
 Delete  FROM ERRORLOG
 --update retailer set taxgroupid=0 where RtrCode='CDP1134'
 EXEC Proc_ValidateRetailerMasterGST 0
 SELECT * FROM ETL_Prk_UDCRetailerGST
 Select * from ETL_Prk_RetailerGST

 EXEC Proc_ETLValidate_UdcDetailsGST 0
  SELECT  * FROM ERRORLOG
 SELECT * FROM UdcDetails where masterid=2 AND MasterRecordId=2
 --Select * from Retailer where RtrCode='CDP1134'
 ROLLBACK TRAN
 */
CREATE PROCEDURE Proc_ValidateRetailerMasterGST
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_ValidateRetailerMasterGST
* PURPOSE		: To validate the downloaded Retailer GST details from Console
* CREATED		: Mohanakrishna A.B
* CREATED DATE	: 23/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	SET @Po_ErrNo=0
	DECLARE @CurrValue as INT	
	DECLARE @UdcMasterId AS INT
	DECLARE @RtrCode VARCHAR(100)
	DECLARE @StateCode VARCHAR(100)
	DECLARE @RtrTaxGroup VARCHAR(100)
	DECLARE @Composite VARCHAR(10)
	DECLARE @RelatedParty AS VARCHAR(10)
	DECLARE @PanNumber AS VARCHAR(25)
	DECLARE @GSTTIN AS VARCHAR(25)
	DECLARE @TaxGrpId AS INT
	DECLARE @StateName as VARCHAR(200)
	DECLARE @RetailerType as VARCHAR(100)
	DECLARE @RtrId AS INT
	CREATE TABLE #ToAvoidUDCRetailer
	(
		RtrCode NVARCHAR(200)
	)
	
	CREATE TABLE #ETL_Prk_RetailerGST
	(
		RtrCode			[Varchar](50),
		RtrName			[Varchar](75),
		StateCode		[Varchar](50),
		GSTTIN			[Varchar](25),
		PanNumber		[Varchar](15),
		Composite		[Varchar](5),
		RetailerType	[Varchar](25),
		RelatedParty	[Varchar](5),
		RtrTaxGroup		[Varchar](50)
	)
	
	DECLARE @GSTEnabled AS TINYINT
	SET @GSTEnabled=0
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)
	BEGIN
		SET @GSTEnabled=1
	END
	

	INSERT INTO #ETL_Prk_RetailerGST
	SELECT ISNULL([Retailer Code],''),ISNULL([Retailer Name],''),ISNULL([StateCode],''),ISNULL([GSTTIN],''),ISNULL([PanNumber],''),
	ISNULL([Composite],''),ISNULL([RetailerType],''),ISNULL(RelatedParty	,''),ISNULL([Tax Group]	,'')  from ETL_Prk_RetailerGST
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 1,'Retailer GST','Retailer Code','Retailer GST Details Should not be empty' 
	FROM #ETL_Prk_RetailerGST
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='')
	--OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	DELETE A FROM #ETL_Prk_RetailerGST A
	WHERE (RTRIM(LTRIM(ISNULL(RtrCode,'')))='' 
	OR RTRIM(LTRIM(ISNULL(StateCode,'')))='') 
	--OR RTRIM(LTRIM(ISNULL(RtrTaxGroup,'')))='')
	--OR RTRIM(LTRIM(ISNULL(PanNumber,'')))=''
	--OR RTRIM(LTRIM(ISNULL(GSTTIN,'')))='')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT RtrCode FROM #ETL_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT  2,'RetailerGST','Retailer','Retailer GST Details Not allow more than 1-'+RtrCode FROM #ETL_Prk_RetailerGST
	GROUP BY RtrCode HAVING COUNT(RtrCode)>1
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT CmpRtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.CmpRtrCode) ---and DownLoadFlag='D'
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 3,'RetailerGST','RetailerCode','Retailer Code not Available-'+RtrCode FROM #ETL_Prk_RetailerGST  A(NOLOCK) 
	WHERE NOT EXISTS(SELECT CmpRtrCode FROM Retailer B(NOLOCK) WHERE A.RtrCode=B.CmpRtrCode) ---and DownLoadFlag='D'
	IF EXISTS(SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST A 
	WHERE  NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	BEGIN
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST A 
		WHERE NOT  EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 4,'RetailerGST','State Code','Retailer GST State Code Not available-'+RtrCode FROM #ETL_Prk_RetailerGST A 
		WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	END
	
	
	IF EXISTS(SELECT '*' FROM #ETL_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
				)
	BEGIN
	
		INSERT INTO #ToAvoidUDCRetailer (RtrCode)
		SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
		INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
		WHERE NOT EXISTS(
			SELECT UD.* FROM UdcHD A (NOLOCK)
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
			INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
			WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
			AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 5,'Retailer GST','StateName','Retailer State Code Not available '+RtrCode FROM #ETL_Prk_RetailerGST CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Retailer Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	END
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','RetailerType','RetailerType Should be REGISTERED / UN REGISTERED / NOT ASSIGNED'+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RetailerType,'')))) NOT IN ('REGISTERED','Unregistered','NOT ASSIGNED')
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composite Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) NOT IN ('YES','NO') AND 
	EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 6,'Retailer GST','Composition','Composite Not allow YES/NO, when Retailer Type is  Non Regesitered'+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(Composite,'')))) IN ('YES','NO') AND 
	NOT EXISTS(SELECT * FROM #ETL_Prk_RetailerGST B WHERE CSM.RtrCode=B.RtrCode and RTRIM(LTRIM(UPPER(ISNULL(B.RetailerType,''))))='REGISTERED')
	INSERT INTO #ToAvoidUDCRetailer (RtrCode)
	SELECT DISTINCT RtrCode FROM #ETL_Prk_RetailerGST 
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
	
	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	SELECT DISTINCT 7,'Retailer GST','Related Party','Related Party Should be YES / No '+RtrCode FROM #ETL_Prk_RetailerGST CSM
	WHERE RTRIM(LTRIM(UPPER(ISNULL(RelatedParty,'')))) NOT IN ('YES','NO')
		
	DELETE FROM ETL_Prk_UDCRetailerGST WHERE MasterName='RETAILER MASTER' AND UpdateFlag=1
	
	DECLARE @RetailerCode AS VARCHAR(100)
	
	
	DECLARE Cur_RetailerGST CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([RtrCode])),''),ISNULL(LTRIM(RTRIM([StateCode])),''),
	ISNULL(LTRIM(RTRIM([Composite])),'NA'),ISNULL(LTRIM(RTRIM([RelatedParty])),''),ISNULL(LTRIM(RTRIM([PanNumber])),''),
	ISNULL(LTRIM(RTRIM([GSTTIN])),''),ISNULL(LTRIM(RTRIM([RetailerType])),''),ISNULL(LTRIM(RTRIM(RtrTaxGroup)),'')
	FROM #ETL_Prk_RetailerGST WHERE --[DownLoadFlag] ='D' AND
	RtrCode NOT IN (SELECT RtrCode FROM #ToAvoidUDCRetailer)
	OPEN Cur_RetailerGST
	FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@Composite,
	@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrTaxGroup
	WHILE @@FETCH_STATUS=0
	BEGIN
	
			SET @Po_ErrNo=0
			SET @TaxGrpId=0
			SET @RetailerCode=''
			
			SET @Rtrid=''
			SELECT @Rtrid=Rtrid,@RetailerCode=RtrCode FROM Retailer(NOLOCK ) WHERE CmpRtrCode =@RtrCode
			
			--DELETE FROM ETL_Prk_RetailerGST WHERE MasterName='RETAILER MASTER' AND [Column Code]=@RtrCode
			DECLARE @DistState AS VARCHAR(100)
			SET @DistState=''
			SET @StateName=''
			SELECT @StateName=StateName FROM StateMaster WHERE StateCode=@StateCode
								
			SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
			INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
			INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
			INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
			WHERE U.MasterId=16 and ColumnName='State Name' 
			
			IF UPPER(@DistState)<>UPPER(@StateName)
			BEGIN
				SET @RtrTaxGroup='RTRINTER'	
			END
			ELSE IF UPPER(@DistState)=UPPER(@StateName)
			BEGIN
				SET @RtrTaxGroup='RTRINTRA'	
			END
			
			IF NOT EXISTS(SELECT * FROM TaxGroupSetting WHERE RtrGroup=UPPER(@RtrTaxGroup) AND TaxGroup=1)
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				SELECT DISTINCT 1,'Retailer GST','Tax Group Code','Tax Group Code Not Foud'
				SET @Po_ErrNo =1
				SET @TaxGrpId=0
			END
			ELSE
			BEGIN
				SELECT @TaxGrpId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup=@RtrTaxGroup AND TaxGroup=1
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@GSTTIN,''))))<>''
			BEGIN
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','GSTIN',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'GSTIN',@GSTTIN)					
					SET @Po_ErrNo =1
				END
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@PanNumber,''))))<>''
			BEGIN								
				IF (SELECT dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber))<>''
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT 1,'Retailer GST','PanNumber',dbo.Fn_ValidateSaveUDC(79,@RtrId,2,'PanNumber',@PanNumber)
					--SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
				
			END
			
			IF RTRIM(LTRIM(UPPER(ISNULL(@RetailerType,''))))='REGISTERED' 
			BEGIN			
				IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','GSTIN','Invalid GST Tin Number'
					SET @Po_ErrNo =1
				END
				
				IF (SELECT DBO.Fn_ISPanNumber(@PanNumber))=1
				BEGIN
					INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
					SELECT DISTINCT 1,'Retailer GST','PanNumber','Invalid Pan Number'
					SET @Po_ErrNo =1
				END
			END			
									
			IF @Po_ErrNo=0
			BEGIN
				
				IF @GSTEnabled=1
				BEGIN
					IF ISNULL(@TaxGrpId,0)<>0
					BEGIN
						UPDATE A SET TaxGroupId=@TaxGrpId,LastModDate=CONVERT(VARCHAR(10),GETDATE(),121) FROM Retailer A 
						WHERE CmpRtrCode=@RtrCode 
					END
				END
				ELSE
				BEGIN
					DELETE FROM RetailerGSTTaxGroupUpdate WHERE RetailerCode=@RtrCode
					INSERT INTO RetailerGSTTaxGroupUpdate(RetailerCode,TaxGroup,UpdateDateTime,UpdateFlag)
					SELECT @RetailerCode,@RtrTaxGroup,Getdate(),0
				END	
				
				INSERT INTO ETL_Prk_UDCRetailerGST (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
				SELECT DISTINCT 'Retailer Master','State Name',@RtrCode,@StateName,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','GSTIN',@RtrCode,@GSTTIN,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Composition',@RtrCode,@Composite,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Related Party',@RtrCode,@RelatedParty,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','Retailer Type',@RtrCode,@RetailerType,0 UNION ALL
				SELECT DISTINCT 'Retailer Master','PAN Number',@RtrCode,@PanNumber,0
				
				IF EXISTS(SELECT * FROM ETL_Prk_UDCRetailerGST WHERE MasterName='Retailer Master')
				BEGIN
				
					EXEC Proc_ETLValidate_UdcDetailsGST 0
				END
				
				EXEC Proc_UpdateRetailerShipping @RtrId,0
				
				
			END
							
		FETCH NEXT FROM Cur_RetailerGST INTO @RtrCode,@StateCode,@Composite,
		@RelatedParty,@PanNumber,@GSTTIN,@RetailerType,@RtrTaxGroup
	END
	CLOSE Cur_RetailerGST
	DEALLOCATE Cur_RetailerGST
	RETURN
END
GO
DECLARE @DistState AS VARCHAR(100)
SET @DistState=''
SELECT @DistState=ISNULL(S.StateCode,'') FROM UdcMaster U (NOLOCK) 
INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
WHERE U.MasterId=16 and ColumnName='State Name' 

IF ISNULL(@DistState,'')<>''
BEGIN

	SELECT DISTINCT D.RtrId INTO #TempRtr FROM UdcMaster U (NOLOCK) 
	INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
	INNER JOIN Retailer D (NOLOCK) ON D.RtrId=UD.MasterRecordId
	INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue 
	WHERE U.MasterId=2 and ColumnName='State Name' and S.StateCode<>''

	DELETE FROM ETL_Prk_RetailerGST
	INSERT INTO ETL_Prk_RetailerGST([Retailer Code],[Retailer Name],[StateCode],GSTTIN,PanNumber,Composite,
	RetailerType,RelatedParty,[Tax Group])
	SELECT CmpRtrCode,RtrName,@DistState,'','','NA','Unregistered','NO','RTRINTRA' FROM Retailer (NOLOCK)
	WHERE RTRID NOT IN (SELECT RtrId FROM #TempRtr)
	
	IF EXISTS(SELECT * FROM ETL_Prk_RetailerGST)
	BEGIN
		EXEC Proc_ValidateRetailerMasterGST 0
	END
END
GO
IF EXISTS(SELECT '*' FROM SYSCOLUMNS A 
INNER JOIN SYSCONSTRAINTS B ON A.NAME='SalesmanPhoneNo' AND A.id=B.id AND B.constid=A.cdefault
INNER JOIN SYSOBJECTS C ON C.ID=B.CONSTID
WHERE A.ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='RptBillTemplateFinal' AND XTYPE='U'))
BEGIN
	DECLARE @CONSTRAINTNAME AS VARCHAR(200)
	DECLARE @ssql AS VARCHAR(200)
	SET @CONSTRAINTNAME=''
	SELECT @CONSTRAINTNAME=C.NAME FROM SYSCOLUMNS A 
	INNER JOIN SYSCONSTRAINTS B ON A.NAME='SalesmanPhoneNo' AND A.id=B.id AND B.constid=A.cdefault
	INNER JOIN SYSOBJECTS C ON C.ID=B.CONSTID
	WHERE A.ID IN (SELECT ID FROM SYSOBJECTS WHERE NAME='RptBillTemplateFinal' AND XTYPE='U')
	
	SET @ssql=''
	SET @ssql='ALTER TABLE RptBillTemplateFinal DROP CONSTRAINT '+@CONSTRAINTNAME
	EXEC(@ssql)
END
GO
IF EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')  
BEGIN  
	ALTER TABLE RptBillTemplateFinal ALTER COLUMN  SalesmanPhoneNo NVARCHAR(100)
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptBillTemplateFinal'AND  Xtype='P')
DROP PROCEDURE Proc_RptBillTemplateFinal
GO
-- EXEC PROC_RptBillTemplateFinal 16,2,0,'BILLPrintissue03012018',0,0,1,'RPTBT_VIEW_FINAL1_BILLTEMPLATE'           
CREATE PROCEDURE Proc_RptBillTemplateFinal
(      
 @Pi_RptId  INT,      
 @Pi_UsrId  INT,      
 @Pi_SnapId  INT,      
 @Pi_DbName  NVARCHAR(50),      
 @Pi_SnapRequired INT,      
 @Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT,      
 @Pi_BTTblName    NVARCHAR(50)      
)      
AS      
/***************************************************************************************************      
* PROCEDURE : Proc_RptBillTemplateFinal      
* PURPOSE : General Procedure      
* NOTES  :        
* CREATED :      
* MODIFIED      
* DATE       AUTHOR     DESCRIPTION      
----------------------------------------------------------------------------------------------------      
* 01.10.2009  Panneer      Added Tax summary Report Part(UserId Condition)      
* 10/07/2015  PRAVEENRAJ BHASKARAN     Added Grammge For Parle  
* DATE       AUTHOR     CR/BZ	USER STORY ID           DESCRIPTION                         
***************************************************************************************************
  10-01-2018  LAKSHMAN	 BZ     ICRSTPAR7339             Bill Print Allot ment Issue
****************************************************************************************************/      
SET NOCOUNT ON      
BEGIN      
 --Added By Murugan 04/09/2009      
 DECLARE @FieldCount AS INT      
 DECLARE @UomStatus AS INT       
 DECLARE @UOMCODE AS nVARCHAR(25)      
 DECLARE @pUOMID as INT      
 DECLARE @UomFieldList as nVARCHAR(3000)      
 DECLARE @UomFields as nVARCHAR(3000)      
 DECLARE @UomFields1 as nVARCHAR(3000)      
 --END      
 DECLARE @NewSnapId  AS INT      
 DECLARE @DBNAME  AS  nvarchar(50)      
 DECLARE @TblName  AS nvarchar(500)      
 DECLARE @TblStruct  AS nVarchar(4000)      
 DECLARE @TblFields  AS nVarchar(4000)      
 DECLARE @sSql  AS  nVarChar(4000)      
 DECLARE @ErrNo   AS INT      
 DECLARE @PurDBName AS nVarChar(50)      
 Declare @Sub_Val  AS TINYINT      
 DECLARE @FromDate AS DATETIME      
 DECLARE @ToDate   AS DATETIME      
 DECLARE @FromBillNo  AS   BIGINT      
 DECLARE @TOBillNo    AS   BIGINT      
 DECLARE @SMId   AS INT      
 DECLARE @RMId   AS INT      
 DECLARE @RtrId   AS INT      
 DECLARE @vFieldName    AS nvarchar(255)      
 DECLARE @vFieldType AS nvarchar(10)      
 DECLARE @vFieldLength as nvarchar(10)      
 DECLARE @FieldList as      nvarchar(4000)      
 DECLARE @FieldTypeList as varchar(8000)      
 DECLARE @FieldTypeList2 as varchar(8000)      
 DECLARE @DeliveredBill  AS INT      
 DECLARE @SSQL1 AS NVARCHAR(4000)      
 DECLARE @FieldList1 as      nvarchar(4000)      
 --For B&L Bill Print Configurtion      
 SELECT @DeliveredBill=Status FROM  Configuration WHERE ModuleName='Discount & Tax Collection' AND ModuleId='DISTAXCOLL5'      
 IF @DeliveredBill=1      
 BEGIN        
  DELETE FROM RptBillToPrint WHERE [Bill Number] IN(      
  SELECT SalInvNo FROM SalesInvoice WHERE DlvSts NOT IN(4,5))      
 END      
 --Till Here      
 --Added By Murugan 04/09/2009      
 --print @Pi_BTTblName      
 SET @FieldCount=0      
 SELECT @UomStatus=Isnull(Status,0) FROM configuration  WHERE ModuleName='General Configuration' and ModuleId='GENCONFIG22' and SeqNo=22      
 --Till Here      
 SET @FromDate =(SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId))      
 SET @ToDate = (SELECT  TOP 1 dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId))      
 DECLARE CurField CURSOR FOR      
 select sc.name fieldname,st.name fieldtype,sc.length from syscolumns sc, systypes st      
 where sc.id in (select id from sysobjects where name like @Pi_BTTblName )      
 and sc.xtype = st.xtype      
 and sc.xusertype = st.xusertype      
 Set @FieldList = ''      
 Set @FieldTypeList = ''      
 OPEN CurField      
 FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
 WHILE @@Fetch_Status = 0      
 BEGIN      
  if len(@FieldTypeList) > 3060      
  begin      
   Set @FieldTypeList2 = @FieldTypeList      
   Set @FieldTypeList = ''      
  end      
  --->Added By Nanda on 12/03/2010      
  IF LEN(@FieldList)>3060      
  BEGIN      
   SET @FieldList1=@FieldList      
   SET @FieldList=''    
  END      
  --->Till Here      
  if @vFieldName = 'UsrId'      
  begin      
   Set @FieldList = @FieldList  + 'V.[' + @vFieldName + '] , '      
  end      
  else      
  begin      
   Set @FieldList = @FieldList + '[' + @vFieldName + '] , '      
  end      
  if @vFieldType = 'nvarchar' or @vFieldType = 'varchar' or @vFieldType = 'char'      
  begin      
   Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(' + @vFieldLength + ')' + ','      
  end      
  else if @vFieldType = 'numeric'      
  begin      
   Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + '(38,2)' + ','      
  end      
  else      
  begin      
   Set @FieldTypeList = @FieldTypeList + '[' + @vFieldName + '] ' + @vFieldType + ','      
  end      
  FETCH CurField INTO @vFieldName,@vFieldType,@vFieldLength      
 END      
 Set @FieldList = left(@FieldList,len(@FieldList)-1)      
 Set @FieldTypeList = left(@FieldTypeList,len(@FieldTypeList)-1)      
 CLOSE CurField      
 DEALLOCATE CurField      
 --Added by Murugan UomCoversion 04/09/2009      
 IF @UomStatus=1      
 BEGIN       
  TRUNCATE TABLE BillTemplateUomBased       
  SET @UomFieldList=''      
  SET @UomFields=''      
  SET @UomFields1=''      
  SET @FieldCount= @FieldCount+1       
  DECLARE CUR_UOM CURSOR      
  FOR SELECT UOMID,UOMCODE FROM UOMMASTER  Order BY UOMID      
  OPEN CUR_UOM      
  FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
  WHILE @@FETCH_STATUS=0      
  BEGIN      
   SET @FieldCount= @FieldCount+1      
   SET @UomFieldList=@UomFieldList+'['+@UOMCODE +'] INT,'      
   SET @UomFields=@UomFields+'0 AS ['+@UOMCODE +'],'      
   SET @UomFields1=@UomFields1+'['+@UOMCODE +'],'       
   INSERT INTO BillTemplateUomBased(ColId,UOMID,UomCode)      
   VALUES (@FieldCount,@pUOMID,@UOMCODE)      
  FETCH NEXT FROM CUR_UOM INTO @pUOMID,@UOMCODE      
  END       
  CLOSE CUR_UOM      
  DEALLOCATE CUR_UOM      
  SET @UomFieldList= subString(@UomFieldList,1,Len(Ltrim(rtrim(@UomFieldList)))-1)      
  SET @UomFields= subString(@UomFields,1,Len(Ltrim(rtrim(@UomFields)))-1)      
  SET @UomFields1= subString(@UomFields1,1,Len(Ltrim(rtrim(@UomFields1)))-1)        
 END      
 -----      
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)      
 if exists (select * from dbo.sysobjects where id = object_id(N'[RptBillTemplateFinal]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)      
 drop table [RptBillTemplateFinal]      
 IF @UomStatus=1      
 BEGIN       
  EXEC('CREATE TABLE RptBillTemplateFinal      
  (' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500),'+ @UomFieldList +')')      
 END      
 ELSE      
 BEGIN      
  EXEC('CREATE TABLE RptBillTemplateFinal      
  (' +  @FieldTypeList2 + @FieldTypeList  + ',AmtInWrd nVarchar(500))')      
 END      
 SET @TblName = 'RptBillTemplateFinal'      
 SET @TblStruct = @FieldTypeList2 + @FieldTypeList      
 SET @TblFields = @FieldTypeList2 + @FieldTypeList      
 IF @Pi_GetFromSnap = 1      
 BEGIN      
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId      
  SET @DBNAME =   @DBNAME      
 END      
 ELSE      
 BEGIN      
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3      
  SET @DBNAME = @PI_DBNAME + @DBNAME      
 END      
 --Nanda01      
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data      
 BEGIN      
  DELETE FROM RptBillTemplateFinal Where UsrId = @Pi_UsrId      
  IF @UomStatus=1      
  BEGIN      
   EXEC ('INSERT INTO RptBillTemplateFinal (' + @FieldList1+@FieldList + ','+ @UomFields1 + ')' +      
   'Select  DISTINCT' + @FieldList1+@FieldList +','+ @UomFields+'  from ' + @Pi_BTTblName + ' V,RptBillToPrint T Where V.[Sales Invoice Number] = T.[Bill Number]')      
  END      
  ELSE      
  BEGIN      
   --SELECT 'Nanda002'       
   Exec ('INSERT INTO RptBillTemplateFinal (' +@FieldList1+ @FieldList + ')' +      
   'Select  DISTINCT' + @FieldList1+ @FieldList + '  from ' + @Pi_BTTblName + ' V,RptBillToPrint T Where V.[Sales Invoice Number] = T.[Bill Number]')      
  END      
  IF LEN(@PurDBName) > 0      
  BEGIN      
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT      
   SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
    '(' + @TblFields + ')' +      
   ' SELECT DISTINCT' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName + ' Where UsrId = ' + @Pi_UsrId      
         EXEC (@SSQL)      
   PRINT @SSQL      
   PRINT 'Retrived Data From Purged Table'      
  END      
  IF @Pi_SnapRequired = 1      
     BEGIN      
   SELECT @NewSnapId = @Pi_SnapId      
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
    @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
   IF @ErrNo = 0      
      BEGIN      
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +      
     '(SnapId,UserId,RptId,' + @TblFields + ')' +      
     ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +      
     ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
     ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM RptBillTemplateFinal'      
    EXEC (@SSQL)      
    PRINT 'Saved Data Into SnapShot Table'      
      END      
     END      
 END      
 --Nanda02      
 ELSE    --To Retrieve Data From Snap Data      
 BEGIN      
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
    @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
  PRINT @ErrNo      
  IF @ErrNo = 0      
     BEGIN      
   SET @SSQL = 'INSERT INTO RptBillTemplateFinal ' +      
    '(' + @TblFields + ')' +      
    ' SELECT DISTINCT' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +      
    ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +      
    ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
    ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))      
   EXEC (@SSQL)      
   PRINT 'Retrived Data From Snap Shot Table'      
     END      
  ELSE      
     BEGIN      
   PRINT 'DataBase or Table not Found'      
     END      
 END      
 --Update SplitUp Tax Amount & Perc      
 IF @UomStatus=1      
 BEGIN       
  EXEC Proc_BillTemplateUOM @Pi_UsrId      
 END      
-- EXEC Proc_BillPrintingTax @Pi_UsrId      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax 1')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 1]=BillPrintTaxTemp.[Tax1Perc]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax Amount1')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount1]=BillPrintTaxTemp.[Tax1Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax 2')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 2]=BillPrintTaxTemp.[Tax2Perc],[RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax Amount2')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount2]=BillPrintTaxTemp.[Tax2Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax 3')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 3]=BillPrintTaxTemp.[Tax3Perc]      
FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax Amount3')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount3] =BillPrintTaxTemp.[Tax3Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax 4')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 4]=BillPrintTaxTemp.[Tax4Perc],[RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax Amount4')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount4]=BillPrintTaxTemp.[Tax4Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax 5')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax 5]=BillPrintTaxTemp.[Tax5Perc],[RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Tax Amount5')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Tax Amount5]=BillPrintTaxTemp.[Tax5Amount]      
  FROM BillPrintTaxTemp WHERE [RptBillTemplateFinal].SalId=BillPrintTaxTemp.[SalId] AND [RptBillTemplateFinal].[Product Code]=BillPrintTaxTemp.[PrdCode]      
  AND [RptBillTemplateFinal].[Batch Code] =BillPrintTaxTemp.[BatchCode]'      
  EXEC (@SSQL1)  
 END      
 --Till Here      
 --- Sl No added  ---      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Product SL No')      
 BEGIN      
  SET @SSQL1='UPDATE [RptBillTemplateFinal] SET [RptBillTemplateFinal].[Product SL No]=SalesInvoiceProduct.[SlNo]      
  FROM SalesInvoiceProduct,Product,ProductBatch WHERE [RptBillTemplateFinal].SalId=SalesInvoiceProduct.[SalId] AND [RptBillTemplateFinal].[Product Code]=Product.[PrdCCode]      
  AND Product.Prdid=SalesInvoiceProduct.prdid      
  And ProductBatch.Prdid=Product.Prdid and ProductBatch.PrdBatid=SalesInvoiceProduct.PrdBatId      
  AND [RptBillTemplateFinal].[Batch Code] =ProductBatch.[PrdBatCode]'      
  EXEC (@SSQL1)      
 END       
 --- End Sl No      
 --->Added By Nanda on 2011/02/24 for Henkel      
 if not exists (Select Id,name from Syscolumns where name = 'Product Weight' and id in (Select id from       
  Sysobjects where name ='RptBillTemplateFinal'))      
 begin      
  ALTER TABLE [dbo].[RptBillTemplateFinal]      
  ADD [Product Weight] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
 END      
 if not exists (Select Id,name from Syscolumns where name = 'Product UPC' and id in (Select id from       
  Sysobjects where name ='RptBillTemplateFinal'))      
 begin      
  ALTER TABLE [dbo].[RptBillTemplateFinal]      
  ADD [Product UPC] NUMERIC(38,6) NULL DEFAULT 0 WITH VALUES      
 END      
  IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD GSTTIN VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [Pan Number] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [Retailer Type] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='Composite')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD Composite VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD RelatedParty VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [State Name] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [State Code] VARCHAR(10) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [StateTinNo] VARCHAR(10) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD HSNCode VARCHAR(100) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD HSNDescription VARCHAR(100) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD DistributorGstTin VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD DistributorStateName VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [Distributor Type] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD AadharNo VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateCode')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD DistributorStateCode VARCHAR(10) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateTinNo')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD DistributorStateTinNo VARCHAR(10) DEFAULT '' WITH VALUES      
 END        
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [Dist Food Lic No] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
 BEGIN      
  ALTER TABLE RptBillTemplateFinal ADD [Dist Drug Lic no] VARCHAR(50) DEFAULT '' WITH VALUES      
 END      
 IF NOT EXISTS(SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='SalesInvoice NetAmount Actual')      
 BEGIN      
  ALTER  TABLE RptBillTemplateFinal ADD [SalesInvoice NetAmount Actual] Numeric(18,2)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Product Weight')      
 BEGIN      
  SET @SSQL1='UPDATE Rpt SET Rpt.[Product Weight]=P.PrdWgt*(CASE P.PrdUnitId WHEN 2 THEN Rpt.[Base Qty]/1000 ELSE Rpt.[Base Qty] END)      
  FROM Product P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code] AND P.PrdUnitId IN (2,3)'      
  EXEC (@SSQL1)      
 END      
 IF Exists(SELECT Name FROM dbo.sysColumns where id = object_id(N'RptBillTemplateFinal') and name='Product UPC')      
 BEGIN      
  SET @SSQL1='UPDATE Rpt SET Rpt.[Product UPC]=Rpt.[Base Qty]/P.ConversionFactor       
     FROM       
     (      
      SELECT P.PrdId,P.PrdCCode,MAX(U.ConversionFactor)AS ConversionFactor FROM Product P,UOMGroup U      
      WHERE P.UOMGroupId=U.UOMGroupId      
      GROUP BY P.PrdId,P.PrdCCode      
     ) P,RptBillTemplateFinal Rpt WHERE P.PrdCCode=Rpt.[Product Code]'      
  EXEC (@SSQL1)      
 END      
 --->Till Here      
 --Check for Report Data      
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId      
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptBillTemplateFinal      
 -- Till Here      
 Delete From RptBillTemplate_Tax Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_Other Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_Replacement Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_CrDbAdjustment Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_MarketReturn Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_SampleIssue Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_Scheme Where UsrId = @Pi_UsrId      
 Delete From RptBillTemplate_PrdUOMDetails Where UsrId = @Pi_UsrId      
 ---------------------------------TAX (SubReport)      
-- Select @Sub_Val = TaxDt  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
-- If @Sub_Val = 1      
-- Begin      
        DELETE FROM RptBillTemplate_Tax WHERE UsrId = @Pi_UsrId          
  Insert into RptBillTemplate_Tax(SalId,SalInvNo,PrdSlNo,TaxId,TaxCode,TaxName,TaxPerc,TaxableAmount,TaxAmount,UsrId)      
  SELECT SI.SalId,S.SalInvNo,0,SI.TaxId,TaxCode,TaxName,TaxPerc,SUM(TaxableAmount),SUM(TaxAmount),@Pi_UsrId      
  FROM SalesInvoiceProductTax SI , TaxConfiguration T,SalesInvoice S,RptBillToPrint B      
  WHERE SI.TaxId = T.TaxId and SI.SalId = S.SalId and S.SalInvNo = B.[Bill Number] and B.UsrId = @Pi_UsrId      
  GROUP BY SI.SalId,S.SalInvNo,SI.TaxId,TaxCode,TaxName,TaxPerc HAVING SUM(TaxableAmount) > 0 --Muthuvel      
-- End      
 ------------------------------ Other      
 --Select @Sub_Val = OtherCharges FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
 --If @Sub_Val = 1      
 --Begin      
  Delete From RptBillTemplate_Other Where UsrId = @Pi_UsrId      
  Insert into RptBillTemplate_Other(SalId,SalInvNo,AccDescId,Description,Effect,Amount,UsrId)      
  SELECT SI.SalId,S.SalInvNo,      
  SI.AccDescId,P.Description,Case P.Effect When 0 Then 'Add' else 'Reduce' End Effect,      
  Adjamt Amount,@Pi_UsrId      
  FROM SalInvOtherAdj SI,PurSalAccConfig P,SalesInvoice S,RptBillToPrint B      
  WHERE P.TransactionId = 2      
  and SI.AccDescId = P.AccDescId      
  and SI.SalId = S.SalId      
  and S.SalInvNo = B.[Bill Number]      
 --End      
 ---------------------------------------Replacement      
 --Select @Sub_Val = Replacement FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
 --If @Sub_Val = 1      
 --Begin      
  Delete From RptBillTemplate_Replacement Where UsrId = @Pi_UsrId      
  Insert into RptBillTemplate_Replacement(SalId,SalInvNo,RepRefNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Rate,Tax,Amount,UsrId)      
  SELECT H.SalId,SI.SalInvNo,H.RepRefNo,D.PrdId,P.PrdName,D.PrdBatId,PB.PrdBatCode,RepQty,SelRte,Tax,RepAmount,@Pi_UsrId      
  FROM ReplacementHd H, ReplacementOut D, Product P, ProductBatch PB,SalesInvoice SI,RptBillToPrint B      
  WHERE H.SalId <> 0      
  and H.RepRefNo = D.RepRefNo      
  and D.PrdId = P.PrdId      
  and D.PrdBatId = PB.PrdBatId      
  and H.SalId = SI.SalId      
  and SI.SalInvNo = B.[Bill Number]      
 --End      
 ----------------------------------Credit Debit Adjus      
 --Select @Sub_Val = CrDbAdj  FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
 --If @Sub_Val = 1      
 --Begin      
     Delete From RptBillTemplate_CrDbAdjustment Where UsrId = @Pi_UsrId      
  Insert into RptBillTemplate_CrDbAdjustment(SalId,SalInvNo,NoteNumber,Amount,UsrId)      
  Select A.SalId,S.SalInvNo,CrNoteNumber,A.CrAdjAmount,@Pi_UsrId      
  from SalInvCrNoteAdj A,SalesInvoice S,RptBillToPrint B      
  Where A.SalId = s.SalId      
  and S.SalInvNo = B.[Bill Number]      
  Union All      
  Select A.SalId,S.SalInvNo,DbNoteNumber,A.DbAdjAmount,@Pi_UsrId      
  from SalInvDbNoteAdj A,SalesInvoice S,RptBillToPrint B      
  Where A.SalId = s.SalId      
  and S.SalInvNo = B.[Bill Number]      
 --End      
 ---------------------------------------Market Return      
-- Select @Sub_Val = MarketRet FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
-- If @Sub_Val = 1      
-- Begin      
  Delete from RptBillTemplate_MarketReturn where UsrId = @Pi_UsrId      
  Insert into RptBillTemplate_MarketReturn(Type,SalId,SalInvNo,PrdId,PrdName,PrdBatId,PrdBatCode,Qty,Amount,UsrId)      
  Select 'Market Return' Type ,H.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
  D.PrdBatId,PB.PrdBatCode,BaseQty,PrdNetAmt,@Pi_UsrId      
  From ReturnHeader H,ReturnProduct D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B      
  Where returntype = 1      
  and H.ReturnID = D.ReturnID      
  and D.PrdId = P.PrdId      
  and D.PrdBatId = PB.PrdBatId      
  and H.SalId = S.SalId      
  and S.SalInvNo = B.[Bill Number]      
  Union ALL      
  Select 'Market Return Free Product' Type,D.SalId,S.SalInvNo,D.PrdId,P.PrdName,      
  D.PrdBatId,PB.PrdBatCode,D.BaseQty,GrossAmount,@Pi_UsrId      
  From ReturnPrdHdForScheme D,Product P,ProductBatch PB,SalesInvoice S,RptBillToPrint B,ReturnHeader H,ReturnProduct T      
  WHERE returntype = 1 AND      
  D.PrdId = P.PrdId      
  and D.PrdBatId = PB.PrdBatId      
  and H.SalId = T.SalId      
  and H.ReturnID = T.ReturnID      
  and S.SalInvNo = B.[Bill Number]      
-- End      
 ------------------------------ SampleIssue      
 Select @Sub_Val = SampleIssue FROM BillTemplateHD WHERE TempName=substring(@Pi_BTTblName,18,len(@Pi_BTTblName))      
 If @Sub_Val = 1      
 Begin      
  Insert into RptBillTemplate_SampleIssue(SalId,SalInvNo,SchId,SchCode,SchName,PrdId,PrdCCode,CmpId,CmpCode,      
  CmpName,PrdDCode,PrdShrtName,PrdBatId,PrdBatCode,UomId,UomCode,Qty,TobeReturned,DueDate,UsrId)      
  SELECT A.SalId,C.SalInvNo,D.SchId,D.SchCode,D.SchDsc,B.PrdId,      
  E.PrdCCode,E.CmpId,F.CmpCode,F.CmpName,E.PrdDCode,E.PrdShrtName,B.PrdBatId,G.PrdBatCode,      
  B.IssueUomID,H.UomCode,B.IssueQty,CASE B.TobeReturned WHEN 0 THEN 'No' ELSE 'Yes' END AS TobeReturned,      
  B.DueDate,@Pi_UsrId      
  FROM SampleIssueHd A WITH (NOLOCK)      
  INNER JOIN SampleIssueDt B WITH(NOLOCK)ON A.IssueId=B.IssueID      
  INNER JOIN SalesInvoice C WITH(NOLOCK)ON A.SalId=C.SalId      
  INNER JOIN SampleSchemeMaster D WITH(NOLOCK)ON B.SchId=D.SchId      
  INNER JOIN Product E WITH (NOLOCK) ON B.PrdID=E.PrdId      
  INNER JOIN Company F WITH (NOLOCK) ON E.CmpId=F.CmpId      
  INNER JOIN ProductBatch G WITH (NOLOCK) ON E.PrdID=G.PrdID AND B.PrdBatId=G.PrdBatId      
  INNER JOIN UOMMaster H WITH (NOLOCK) ON B.IssueUomID=H.UomID      
  INNER JOIN RptBillToPrint I WITH (NOLOCK) ON C.SalInvNo=I.[Bill Number]      
 End      
 --->Added By Nanda on 10/03/2010      
 ------------------------------ Scheme      
 Select @Sub_Val = [Scheme] FROM BillTemplateHD WHERE TempName=SUBSTRING(@Pi_BTTblName,18,LEN(@Pi_BTTblName))      
 If @Sub_Val = 1      
 Begin      
  INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
  PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
  SELECT SI.SalId,SI.SalInvNo,SISL.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
  WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
  0,'',0,0,SUM(SISL.DiscountPerAmount+SISL.FlatAmount),0,0,0,@Pi_UsrId      
  FROM SalesInvoice SI,SalesInvoiceSchemeLineWise SISL,SchemeMaster SM,RptBillToPrint RBT      
  WHERE SISL.SchId=SM.SchId AND SI.SalId=SISL.SalId AND RBT.[Bill Number]=SI.SalInvNo      
  GROUP BY SI.SalId,SI.SalInvNo,SISL.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
  HAVING SUM(SISL.DiscountPerAmount+SISL.FlatAmount)>0      
  INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
  PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
  SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
  WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.FreePrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
  SISFP.FreePrdBatId,PB.PrdBatCode,SISFP.FreeQty,PBD.PrdBatDetailValue,SISFP.FreeQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
  FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
  ProductBatchDetails PBD,BatchCreation BC      
  WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
  AND SISFP.FreePrdId=P.PrdId AND SISFP.FreePrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
  PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
  INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
  PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
  SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
  WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.GiftPrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
  SISFP.GiftPrdBatId,PB.PrdBatCode,SISFP.GiftQty,PBD.PrdBatDetailValue,SISFP.GiftQty*PBD.PrdBatDetailValue,0,0,0,@Pi_UsrId      
  FROM SalesInvoice SI,SalesInvoiceSchemeDtFreePrd SISFP,SchemeMaster SM,RptBillToPrint RBT,Product P,ProductBatch PB,      
  ProductBatchDetails PBD,BatchCreation BC      
  WHERE SISFP.SchId=SM.SchId AND SI.SalId=SISFP.SalId AND RBT.[Bill Number]=SI.SalInvNo      
  AND SISFP.GiftPrdId=P.PrdId AND SISFP.GiftPrdBatId=PB.PrdBatId AND PB.PrdBatId=PBD.PrdBatId AND      
  PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1      
  INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
  PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
  SELECT SI.SalId,SI.SalInvNo,SIWD.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
  WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,0,'','','','',      
  0,'',0,0,SUM(SIWD.AdjAmt),0,0,0,@Pi_UsrId      
  FROM SalesInvoice SI,SalesInvoiceWindowDisplay SIWD,SchemeMaster SM,RptBillToPrint RBT      
  WHERE SIWD.SchId=SM.SchId AND SI.SalId=SIWD.SalId AND RBT.[Bill Number]=SI.SalInvNo      
  GROUP BY SI.SalId,SI.SalInvNo,SIWD.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc      
  UPDATE RPT SET SalInvSchemeValue=A.SalInvSchemeValue      
  FROM RptBillTemplate_Scheme RPT,(SELECT SalId,SUM(SchemeValueInAmt) AS SalInvSchemeValue FROM RptBillTemplate_Scheme GROUP BY SalId)A      
  WHERE A.SAlId=RPT.SalId      
  --->Added By Jay on 09/12/2010      
  INSERT INTO RptBillTemplate_Scheme(SalId,SalInvNo,SchId,SchType,CmpSchCode,SchCode,SchName,PrdId,PrdCCode,PrdDCode,      
  PrdShrtName,PrdName,PrdBatId,PrdBatCode,Qty,Rate,SchemeValueInAmt,SchemeValueInPoints,SalInvSchemeValue,SchemeCumulativePoints,UsrId)      
  SELECT SI.SalId,SI.SalInvNo,SISFP.SchId,(CASE SM.SchType WHEN 1 THEN 'Quantity' WHEN 2 THEN 'Amount' WHEN 3 THEN 'Weight'      
  WHEN 4 THEN 'Window Display' END),SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,P.PrdName,      
  SISFP.PrdBatId,PB.PrdBatCode,0,PBD.PrdBatDetailValue,0,SUM(Points),0,0,@Pi_UsrId      
  FROM SalesInvoice SI,SalesInvoiceSchemeDtPoints SISFP,SchemeMaster SM,      
  RptBillToPrint RBT,Product P,ProductBatch PB,ProductBatchDetails PBD,BatchCreation BC      
  WHERE SI.SalId=SISFP.SalId AND SISFP.SchId=SM.SchId AND RBT.[Bill Number]=SI.SalInvNo      
  AND SISFP.PrdId=P.PrdId AND SISFP.PrdBatId=PB.PrdBatId AND RBT.UsrId=@Pi_UsrId      
  AND PB.PrdBatId=PBD.PrdBatId AND PBD.DefaultPrice=1 AND PBD.BatchSeqId=BC.BatchSeqId AND BC.SlNo=PBD.SlNo AND BC.SelRte=1 AND LEN(SISFP.ReDimRefId)=0        
  GROUP BY SI.SalId,SI.SalInvNo,SISFP.SchId,SM.SchType,SM.CmpSchCode,SM.SchCode,SM.SchDsc,SISFP.PrdId,P.PrdCCode,P.PrdDCode,P.PrdShrtName,      
  P.PrdName,SISFP.PrdBatId,PB.PrdBatCode,PBD.PrdBatDetailValue      
  --->Till Here      
  --->Added By Nanda on 22/12/2010       
  UPDATE R SET SchemeCumulativePoints=A.CumulativePoints      
  FROM RptBillTemplate_Scheme R,SalesInvoice SI,      
  (SELECT SI.RtrId,SISP.SchId,SUM(SISP.Points-SISP.ReturnPoints) AS CumulativePoints      
  FROM SalesInvoiceSchemeDtPoints SISP      
  INNER JOIN SalesInvoice SI ON SI.SalId=SISP.SalId AND SI.DlvSts<>3      
  --INNER JOIN RptBillToPrint R ON R.[Bill Number]=SI.SalInvNo      
  GROUP BY SI.RtrId,SISP.SchId) A      
  WHERE R.SalId=SI.SalId AND A.RtrId=SI.RtrId      
  --->Till Here        
 End      
 --->Till Here       
 --->Added By Nanda on 14/03/2011      
 ------------------------------ Prd UOM Details      
 --INSERT INTO RptBillTemplate_PrdUOMDetails(SalId,SalInvNo,TotPrdVolume,TotPrdKG,TotPrdLtrs,TotPrdUnits,      
 --TotPrdDrums,TotPrdCartons,TotPrdBuckets,TotPrdPieces,TotPrdBags,UsrId)       
 --SELECT SalId,SalInvNo,SUM(TotPrdVolume) AS TotPrdVolume,SUM(TotPrdKG) AS TotPrdKG,SUM(TotPrdLtrs) AS TotPrdLtrs,SUM(TotPrdUnits) AS TotPrdUnits,      
 --SUM(TotPrdDrums) AS TotPrdDrums,SUM(TotPrdCartons) AS TotPrdCartons,SUM(TotPrdBuckets) AS TotPrdBuckets,SUM(TotPrdPieces) AS TotPrdPieces,SUM(TotPrdBags) AS TotPrdBags,@Pi_UsrId      
 --FROM      
 --(      
 -- SELECT DISTINCT SI.SalId,SI.SalInvNo,SIP.PrdId,SIP.BaseQty*dbo.Fn_ReturnProductVolumeInLtrs(SIP.PrdId) AS TotPrdVolume,      
 -- SIP.BaseQty*P.PrdUpSKU * (CASE P.PrdUnitId WHEN 2 THEN .001 WHEN 3 THEN 1 ELSE 0 END) AS TotPrdKG,      
 -- SIP.BaseQty * P.PrdWgt * (CASE P.PrdUnitId WHEN 4 THEN .001 WHEN 5 THEN 1 ELSE 0 END) AS TotPrdLtrs,      
 -- SIP.BaseQty*(CASE P.PrdUnitId WHEN 1 THEN 0 ELSE 0 END) AS TotPrdUnits,      
 -- (CASE ISNULL(UMP1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP1.UOM1Qty,0) END)+      
 -- (CASE ISNULL(UMP2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPP2.UOM2Qty,0) END) AS TotPrdPieces,      
 -- (CASE ISNULL(UMBU1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU1.UOM1Qty,0) END)+      
 -- (CASE ISNULL(UMBU2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBU2.UOM2Qty,0) END) AS TotPrdBuckets,      
 -- (CASE ISNULL(UMBA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA1.UOM1Qty,0) END)+      
 -- (CASE ISNULL(UMBA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPBA2.UOM2Qty,0) END) AS TotPrdBags,      
 -- (CASE ISNULL(UMDR1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR1.UOM1Qty,0) END)+      
 -- (CASE ISNULL(UMDR2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPDR2.UOM2Qty,0) END) AS TotPrdDrums,      
 -- (CASE ISNULL(UMCA1.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA1.UOM1Qty,0) END)+      
 -- (CASE ISNULL(UMCA2.UOMId,0) WHEN 0 THEN 0 ELSE ISNULL(SIPCA2.UOM2Qty,0) END)+       
 -- CEILING((CASE ISNULL(UMCN1.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN1.UOM1Qty,0) AS NUMERIC(38,6))/CAST(UGC1.ConvFact AS NUMERIC(38,6)) END))+      
 -- CEILING((CASE ISNULL(UMCN2.UOMId,0) WHEN 0 THEN 0 ELSE CAST(ISNULL(SIPCN2.UOM2Qty,0) AS NUMERIC(38,6))/CAST(UGC2.ConvFact AS NUMERIC(38,6)) END)) AS TotPrdCartons      
 -- FROM SalesInvoice SI INNER JOIN SalesInvoiceProduct SIP ON SI.SalId=SIP.SalId      
 -- INNER JOIN RptBillToPrint Rpt ON SI.SalInvNo = Rpt.[Bill Number] AND Rpt.UsrId=@Pi_UsrId      
 -- INNER JOIN Product P ON SIP.PrdID=P.PrdID      
 -- INNER JOIN ProductBatch PB ON SIP.PrdBatID=PB.PrdBatID AND P.PrdID=PB.PrdId      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP1 ON SI.SalId=SIPP1.SalId AND SIP.PrdID=SIPP1.PrdID AND SIP.PrdBatID=SIPP1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPP2 ON SI.SalId=SIPP2.SalId AND SIP.PrdID=SIPP2.PrdID AND SIP.PrdBatID=SIPP2.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU1 ON SI.SalId=SIPBU1.SalId AND SIP.PrdID=SIPBU1.PrdID AND SIP.PrdBatID=SIPBU1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBU2 ON SI.SalId=SIPBU2.SalId AND SIP.PrdID=SIPBU2.PrdID AND SIP.PrdBatID=SIPBU2.PrdBatID        
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA1 ON SI.SalId=SIPBA1.SalId AND SIP.PrdID=SIPBA1.PrdID AND SIP.PrdBatID=SIPBA1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPBA2 ON SI.SalId=SIPBA2.SalId AND SIP.PrdID=SIPBA2.PrdID AND SIP.PrdBatID=SIPBA2.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR1 ON SI.SalId=SIPDR1.SalId AND SIP.PrdID=SIPDR1.PrdID AND SIP.PrdBatID=SIPDR1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPDR2 ON SI.SalId=SIPDR2.SalId AND SIP.PrdID=SIPDR2.PrdID AND SIP.PrdBatID=SIPDR2.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA1 ON SI.SalId=SIPCA1.SalId AND SIP.PrdID=SIPCA1.PrdID AND SIP.PrdBatID=SIPCA1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCA2 ON SI.SalId=SIPCA2.SalId AND SIP.PrdID=SIPCA2.PrdID AND SIP.PrdBatID=SIPCA2.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN1 ON SI.SalId=SIPCN1.SalId AND SIP.PrdID=SIPCN1.PrdID AND SIP.PrdBatID=SIPCN1.PrdBatID      
 -- LEFT OUTER JOIN SalesInvoiceProduct SIPCN2 ON SI.SalId=SIPCN2.SalId AND SIP.PrdID=SIPCN2.PrdID AND SIP.PrdBatID=SIPCN2.PrdBatID      
 -- LEFT OUTER JOIN UOMMaster UMP1 ON UMP1.UOMId=SIPP1.UOM1Id AND UMP1.UOMDescription='PIECES'      
 -- LEFT OUTER JOIN UOMMaster UMP2 ON UMP1.UOMId=SIPP2.UOM2Id AND UMP2.UOMDescription='PIECES'      
 -- LEFT OUTER JOIN UOMMaster UMBU1 ON UMBU1.UOMId=SIPBU1.UOM1Id AND UMBU1.UOMDescription='BUCKETS'       
 -- LEFT OUTER JOIN UOMMaster UMBU2 ON UMBU1.UOMId=SIPBU2.UOM2Id AND UMBU2.UOMDescription='BUCKETS'      
 -- LEFT OUTER JOIN UOMMaster UMBA1 ON UMBA1.UOMId=SIPBA1.UOM1Id AND UMBA1.UOMDescription='BAGS'       
 -- LEFT OUTER JOIN UOMMaster UMBA2 ON UMBA1.UOMId=SIPBA2.UOM2Id AND UMBA2.UOMDescription='BAGS'      
 -- LEFT OUTER JOIN UOMMaster UMDR1 ON UMDR1.UOMId=SIPDR1.UOM1Id AND UMDR1.UOMDescription='DRUMS'       
 -- LEFT OUTER JOIN UOMMaster UMDR2 ON UMDR1.UOMId=SIPDR2.UOM2Id AND UMDR2.UOMDescription='DRUMS'      
 -- LEFT OUTER JOIN UOMMaster UMCA1 ON UMCA1.UOMId=SIPCA1.UOM1Id AND UMCA1.UOMDescription='CARTONS'       
 -- LEFT OUTER JOIN UOMMaster UMCA2 ON UMCA1.UOMId=SIPCA2.UOM2Id AND UMCA2.UOMDescription='CARTONS'      
 -- LEFT OUTER JOIN UOMMaster UMCN1 ON UMCN1.UOMId=SIPCN1.UOM1Id AND UMCN1.UOMDescription='CANS'       
 -- LEFT OUTER JOIN UOMMaster UMCN2 ON UMCN1.UOMId=SIPCN2.UOM2Id AND UMCN2.UOMDescription='CANS'      
 -- LEFT OUTER JOIN (      
 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
 -- GROUP BY P.PrdID) UGC1 ON SIPCN1.PrdId=UGC1.PrdID      
 -- LEFT OUTER JOIN (      
 -- SELECT P.PrdId,MAX(UG.ConversionFactor) AS ConvFact FROM Product P,UOMGroup UG      
 -- WHERE P.UOMGroupId=UG.UOMGroupId AND UG.UOMGroupId IN (       
 -- SELECT UOMGroupId FROM UOMGroup WHERE UOMId IN (SELECT UOMId FROM UOMMAster WHERE UOMDescription LIKE 'CANS') )      
 -- GROUP BY P.PrdID) UGC2 ON SIPCN2.PrdId=UGC2.PrdID      
 --) A      
 --GROUP BY SalId,SalInvNo      
 --->Till Here      
 --Added By Sathishkumar Veeramani 2012/12/13      
 IF NOT EXISTS (SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')      
 BEGIN      
      ALTER TABLE RptBillTemplateFinal ADD [Payment Mode] NVARCHAR(20)      
 END      
 IF Exists(SELECT * FROM Syscolumns WHERE ID IN (SELECT ID FROM Sysobjects WHERE XTYPE = 'U' AND name = 'RptBillTemplateFinal')AND name = 'Payment Mode')          
 BEGIN          
  SET @SSQL1='UPDATE A SET A.[Payment Mode] = Z.[Payment Mode] FROM RptBillTemplateFinal A INNER JOIN       
     (SELECT SalId,(CASE RtrPayMode WHEN 1 THEN ''Cash'' ELSE ''Cheque'' END) AS [Payment Mode] FROM SalesInvoice WITH (NOLOCK)) Z ON A.Salid = Z.SalId       
     AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
  EXEC (@SSQL1)          
 END      
 --Till Here      
 --->Added By Nanda on 23/03/2010-For Grouping the details based on product for nondrug products      
 IF EXISTS(SELECT * FROM Configuration WHERE ModuleId='BotreeBillPrinting01' AND ModuleName='Botree Bill Printing' AND Status=1)      
 BEGIN      
  IF EXISTS (SELECT * FROM dbo.SysObjects WHERE Id = Object_Id(N'[RptBillTemplateFinal_Group]') AND OBJECTPROPERTY(Id, N'IsUserTable') = 1)      
  DROP TABLE [RptBillTemplateFinal_Group]      
  SELECT * INTO RptBillTemplateFinal_Group FROM RptBillTemplateFinal  WHERE [Visibility]=1
  Select * from RptBillTemplateFinal_Group     
  DELETE FROM RptBillTemplateFinal    
  INSERT INTO RptBillTemplateFinal      
  (      
   [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
   [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
   [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
   [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
   [CD Disc Header Amount],[CD Disc LineUnit Amount],      
   [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
   [CD Disc UOM Amount],[CD Disc UOM Percentage],      
   [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
   [DB Disc Header Amount],[DB Disc LineUnit Amount],      
   [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
   [DB Disc UOM Amount],[DB Disc UOM Percentage],      
   [Line Base Qty Amount],[Line Base Qty Percentage],      
   [Line Effect Amount],[Line Unit Amount],      
   [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
   [Manual Free Qty],      
   [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
   [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
   [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
   [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
   [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
   [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
   [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
   [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
   [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
   [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
   [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
   [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
   [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
   [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
   [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
   [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
   [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
   [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
   [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
   [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
   [Route Code],[Route Name],      
   [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
   [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
   [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
   [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
   [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
   [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
   [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
   [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
   [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
   [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
   [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
   [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
   [LST Number],[Order Date],[Order Number],      
   [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
   [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
  )        
  SELECT      
  [SalId],      
  [Sales Invoice Number],      
  [Product Code],[Product Name],[Product Short Name],MIN([Product SL No]) AS [Product SL No],[Product Type],[Scheme Points],      
  SUM([Base Qty]) AS [Base Qty],      
  '' AS [Batch Code],MAX([Batch Expiry Date]) AS [Batch Expiry Date],MIN([Batch Manufacturing Date]) AS [Batch Manufacturing Date],      
  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
  SUM([CD Disc Base Qty Amount]) AS [CD Disc Base Qty Amount],SUM([CD Disc Effect Amount]) AS [CD Disc Effect Amount],      
  SUM(DISTINCT [CD Disc Header Amount]) AS [CD Disc Header Amount],SUM([CD Disc LineUnit Amount]) AS [CD Disc LineUnit Amount],      
  --SUM([CD Disc Qty Percentage]) AS [CD Disc Qty Percentage],SUM([CD Disc Unit Percentage]) AS [CD Disc Unit Percentage],      
  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
  SUM([CD Disc UOM Amount]),SUM([CD Disc UOM Percentage]) AS [CD Disc UOM Percentage],      
  SUM([DB Disc Base Qty Amount]) AS [DB Disc Base Qty Amount],SUM([DB Disc Effect Amount]) AS [DB Disc Effect Amount],      
  SUM(DISTINCT [DB Disc Header Amount]) AS [DB Disc Header Amount],SUM([DB Disc LineUnit Amount]) AS [DB Disc LineUnit Amount],      
  --SUM([DB Disc Qty Percentage]) AS [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]) AS [DB Disc Unit Percentage],      
  [DB Disc Qty Percentage],SUM([DB Disc Unit Percentage]),      
  SUM([DB Disc UOM Amount]) AS [DB Disc UOM Amount],SUM([DB Disc UOM Percentage]) AS [DB Disc UOM Percentage],      
  SUM([Line Base Qty Amount]) AS [Line Base Qty Amount],SUM([Line Base Qty Percentage]) AS [Line Base Qty Percentage],      
  SUM([Line Effect Amount]) AS [Line Effect Amount],      
  --SUM([Line Unit Amount]) AS [Line Unit Amount],      
  [Line Unit Amount],      
  SUM([Line Unit Percentage]) AS [Line Unit Percentage],SUM([Line UOM1 Amount]) AS [Line UOM1 Amount],SUM([Line UOM1 Percentage]) AS [Line UOM1 Percentage],      
  SUM([Manual Free Qty]),      
  SUM([Sch Disc Base Qty Amount]) AS [Sch Disc Base Qty Amount],SUM([Sch Disc Effect Amount]) AS [Sch Disc Effect Amount],      
  SUM(DISTINCT [Sch Disc Header Amount]) AS [Sch Disc Header Amount],SUM([Sch Disc LineUnit Amount]) AS [Sch Disc LineUnit Amount],      
  --SUM([Sch Disc Qty Percentage]) AS [Sch Disc Qty Percentage],SUM([Sch Disc Unit Percentage]) AS [Sch Disc Unit Percentage],      
  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
  SUM([Sch Disc UOM Amount]) AS [Sch Disc UOM Amount],SUM([Sch Disc UOM Percentage]) AS [Sch Disc UOM Percentage],      
  SUM([Spl. Disc Base Qty Amount]) AS [Spl. Disc Base Qty Amount],SUM([Spl. Disc Effect Amount]) AS [Spl. Disc Effect Amount],      
  SUM(DISTINCT [Spl. Disc Header Amount]) AS [Spl. Disc Header Amount],SUM([Spl. Disc LineUnit Amount]) AS [Spl. Disc LineUnit Amount],      
  --SUM([Spl. Disc Qty Percentage]) AS [Spl. Disc Qty Percentage],SUM([Spl. Disc Unit Percentage]) AS [Spl. Disc Unit Percentage],      
  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
  SUM([Spl. Disc UOM Amount]) AS [Spl. Disc UOM Amount],SUM([Spl. Disc UOM Percentage]) AS [Spl. Disc UOM Percentage],      
  --SUM([Tax 1]) AS [Tax 1],SUM([Tax 2]) AS [Tax 2],SUM([Tax 3]) AS [Tax 3],SUM([Tax 4]) AS [Tax 4],      
  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
  SUM([Tax Amount1]) AS [Tax Amount1],SUM([Tax Amount2]) AS [Tax Amount2],SUM([Tax Amount3]) AS [Tax Amount3],SUM([Tax Amount4]) AS [Tax Amount4],      
  SUM([Tax Amt Base Qty Amount]) AS [Tax Amt Base Qty Amount],SUM([Tax Amt Effect Amount]) AS [Tax Amt Effect Amount],      
  SUM(DISTINCT [Tax Amt Header Amount]) AS [Tax Amt Header Amount],SUM([Tax Amt LineUnit Amount]) AS [Tax Amt LineUnit Amount],      
  SUM([Tax Amt Qty Percentage]) AS [Tax Amt Qty Percentage],SUM([Tax Amt Unit Percentage]) AS [Tax Amt Unit Percentage],      
  SUM([Tax Amt UOM Amount]) AS [Tax Amt UOM Amount],SUM([Tax Amt UOM Percentage]) AS [Tax Amt UOM Percentage],      
  '' AS [Uom 1 Desc],SUM([Base Qty]) AS [Uom 1 Qty],'' AS [Uom 2 Desc],0 AS [Uom 2 Qty],[Vehicle Name],      
  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
  SUM([SalesInvoice Line Gross Amount]) AS [SalesInvoice Line Gross Amount],SUM([SalesInvoice Line Net Amount]) AS [SalesInvoice Line Net Amount],      
  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
  [Route Code],[Route Name],      
  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
  [LST Number],[Order Date],[Order Number],      
  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
  FROM RptBillTemplateFinal_Group,Product P      
  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType<>5   AND  [Visibility]=1  
  GROUP BY [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
  [LST Number],      
  [Order Date],[Order Number],      
  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],      
  [Product Code],[Product Name],[Product Short Name],[Product Type],      
  [Remarks],      
  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],      
  [Route Code],[Route Name],      
  [Sales Invoice Number],[SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
  [SalId],      
  [Scheme Points],      
  [Tax Type],[TIN Number],      
  [Vehicle Name],[Tax 1],[Tax 2],[Tax 3],[Tax 4],      
  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
  [DB Disc Qty Percentage],--[DB Disc Unit Percentage],      
  [Line Unit Amount],      
  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],        
  [UsrId],[Visibility],[AmtInWrd] ,
  [Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd] ---------------- Group by columns Added by Lakshman M  on 09/01/2018    
  UNION ALL      
  SELECT [SalId],[Sales Invoice Number],[Product Code],[Product Name],[Product Short Name],[Product SL No],[Product Type],[Scheme Points],      
  [Base Qty],[Batch Code],[Batch Expiry Date],[Batch Manufacturing Date],      
  [Batch MRP],[Batch Selling Rate],[Bill Date],[Bill Doc Ref. Number],[Bill Mode],[Bill Type],      
  [CD Disc Base Qty Amount],[CD Disc Effect Amount],      
  [CD Disc Header Amount],[CD Disc LineUnit Amount],      
  [CD Disc Qty Percentage],[CD Disc Unit Percentage],      
  [CD Disc UOM Amount],[CD Disc UOM Percentage],      
  [DB Disc Base Qty Amount],[DB Disc Effect Amount],      
  [DB Disc Header Amount],[DB Disc LineUnit Amount],      
  [DB Disc Qty Percentage],[DB Disc Unit Percentage],      
  [DB Disc UOM Amount],[DB Disc UOM Percentage],      
  [Line Base Qty Amount],[Line Base Qty Percentage],      
  [Line Effect Amount],[Line Unit Amount],      
  [Line Unit Percentage],[Line UOM1 Amount],[Line UOM1 Percentage],      
  [Manual Free Qty],      
  [Sch Disc Base Qty Amount],[Sch Disc Effect Amount],      
  [Sch Disc Header Amount],[Sch Disc LineUnit Amount],      
  [Sch Disc Qty Percentage],[Sch Disc Unit Percentage],      
  [Sch Disc UOM Amount],[Sch Disc UOM Percentage],      
  [Spl. Disc Base Qty Amount],[Spl. Disc Effect Amount],      
  [Spl. Disc Header Amount],[Spl. Disc LineUnit Amount],      
  [Spl. Disc Qty Percentage],[Spl. Disc Unit Percentage],      
  [Spl. Disc UOM Amount],[Spl. Disc UOM Percentage],      
  [Tax 1],[Tax 2],[Tax 3],[Tax 4],      
  [Tax Amount1],[Tax Amount2],[Tax Amount3],[Tax Amount4],      
  [Tax Amt Base Qty Amount],[Tax Amt Effect Amount],      
  [Tax Amt Header Amount],[Tax Amt LineUnit Amount],      
  [Tax Amt Qty Percentage],[Tax Amt Unit Percentage],      
  [Tax Amt UOM Amount],[Tax Amt UOM Percentage],      
  [Uom 1 Desc],[Uom 1 Qty],[Uom 2 Desc],[Uom 2 Qty],[Vehicle Name],      
  [SalesInvoice ActNetRateAmount],[SalesInvoice CDPer],[SalesInvoice CRAdjAmount],[SalesInvoice DBAdjAmount],[SalesInvoice GrossAmount],      
  [SalesInvoice Line Gross Amount],[SalesInvoice Line Net Amount],      
  [SalesInvoice MarketRetAmount],[SalesInvoice NetAmount],[SalesInvoice NetRateDiffAmount],      
  [SalesInvoice OnAccountAmount],[SalesInvoice OtherCharges],[SalesInvoice RateDiffAmount],[SalesInvoice ReplacementDiffAmount],[SalesInvoice RoundOffAmt],      
  [SalesInvoice TotalAddition],[SalesInvoice TotalDeduction],[SalesInvoice WindowDisplayAmount],[SalesMan Code],[SalesMan Name],      
  [Route Code],[Route Name],      
  [Retailer Address1],[Retailer Address2],[Retailer Address3],[Retailer Code],[Retailer ContactPerson],[Retailer Coverage Mode],      
  [Retailer Credit Bills],[Retailer Credit Days],[Retailer Credit Limit],[Retailer CSTNo],[Retailer Deposit Amount],[Retailer Drug ExpiryDate],      
  [Retailer Drug License No],[Retailer EmailId],[Retailer GeoLevel],[Retailer License ExpiryDate],[Retailer License No],[Retailer Name],      
  [Retailer OffPhone1],[Retailer OffPhone2],[Retailer OnAccount],[Retailer Pestcide ExpiryDate],[Retailer Pestcide LicNo],[Retailer PhoneNo],      
  [Retailer Pin Code],[Retailer ResPhone1],[Retailer ResPhone2],[Retailer Ship Address1],[Retailer Ship Address2],[Retailer Ship Address3],      
  [Retailer ShipId],[Retailer TaxType],[Retailer TINNo],[Retailer Village],[Tax Type],[TIN Number],      
  [Company Address1],[Company Address2],[Company Address3],[Company Code],[Company Contact Person],      
  [Company EmailId],[Company Fax Number],[Company Name],[Company Phone Number],[Contact Person],[CST Number],      
  [DC DATE],[DC NUMBER],[Delivery Boy],[Delivery Date],[Deposit Amount],      
  [Distributor Address1],[Distributor Address2],[Distributor Address3],[Distributor Code],[Distributor Name],      
  [Drug Batch Description],[Drug Licence Number 1],[Drug Licence Number 2],[Drug1 Expiry Date],[Drug2 Expiry Date],      
  [EAN Code],[EmailID],[Geo Level],[Interim Sales],[Licence Number],      
  [LST Number],[Order Date],[Order Number],      
  [Pesticide Expiry Date],[Pesticide Licence Number],[PhoneNo],[PinCode],[Remarks],      
  [UsrId],[Visibility],[Distributor Product Code],[Allotment No],[Bx Selling Rate],[AmtInWrd]      
  FROM RptBillTemplateFinal_Group,Product P      
  WHERE P.PrdCCode=RptBillTemplateFinal_Group.[Product Code] AND P.PrdType=5   AND  [Visibility]=1   
 END       
 --->Till Here      
  IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')      
  BEGIN      
   ALTER TABLE RptBillTemplateFinal ADD InvDisc NUMERIC (18,2) DEFAULT 0 WITH VALUES       
  END      
  IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')      
  BEGIN      
   ALTER TABLE RptBillTemplateFinal ADD InvDiscPer NUMERIC (18,2) DEFAULT 0 WITH VALUES       
  END
  IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')      
  BEGIN      
   ALTER TABLE RptBillTemplateFinal ADD SalesmanPhoneNo NVARCHAR(100)
  END        
  IF NOT EXISTS (SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')      
  BEGIN      
   ALTER TABLE RptBillTemplateFinal ADD Grammage NUMERIC (38,2) DEFAULT 0 WITH VALUES       
  END      
  IF Exists(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDisc')          
  BEGIN          
   SET @SSQL1='UPDATE A SET A.InvDisc=B.SalInvLvlDisc FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
      ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
   EXEC (@SSQL1)          
  END       
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='InvDiscPer')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.InvDiscPer=B.SalInvLvlDiscPer FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesInvoice B (NOLOCK)       
      ON A.[Sales Invoice Number]=B.SalInvNo AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
   EXEC (@SSQL1)      
  END      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='SalesmanPhoneNo')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.SalesmanPhoneNo=ISNULL(B.SMPhoneNumber,'''') FROM RptBillTemplateFinal A (NOLOCK) INNER JOIN SalesMan B (NOLOCK)       
      ON A.[SalesMan Code]=B.SMCode AND A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
   EXEC (@SSQL1)          
  END      
--- Added by Rajesh ICRSTPAR3196      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='bx')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.bx=bx+box FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))      
   EXEC (@SSQL1)          
  END      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='PBG')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.PB=PB+PBG FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))             
   EXEC (@SSQL1)          
  END      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIN')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.Tn=TN+TIN FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
   EXEC (@SSQL1)          
  END      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='TIF')          
  BEGIN        
   SET @SSQL1='UPDATE A SET A.TIF=TIF+TBX FROM RptBillTemplateFinal A (NOLOCK) WHERE A.UsrId='+ CAST(@Pi_UsrId AS VARCHAR(10))        
   EXEC (@SSQL1)          
  END      
--Till here      
-------------------GST Changes(Mohanakrishna A.B) begins here      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Food Lic No')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[Dist Food Lic No]=R.DrugLicNo2       
  FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Dist Drug Lic no')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[Dist Drug Lic no]=R.DrugLicNo1       
  FROM RptBillTemplateFinal B INNER JOIN DISTRIBUTOR R ON B.[Distributor Code]=R.DistributorCode'      
  EXEC (@SSQL1)       
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='GSTTIN')      
 BEGIN      
  SET @SSQL1='UPDATE A SET A.[GSTTIN]=B.GSTTinNo FROM RptBillTemplateFinal A       
  INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='PAN Number')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[Pan Number]=R.[ColumnValue]       
  FROM RptBillTemplateFinal B INNER JOIN (      
  SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''PAN Number'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Retailer Type')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[Retailer Type]=R.[ColumnValue] FROM RptBillTemplateFinal B       
  INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Retailer Type'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='RelatedParty')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[RelatedParty]=R.[ColumnValue] FROM RptBillTemplateFinal B       
  INNER JOIN (SELECT R.RtrId,R.rtrcode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Retailer R on R.RtrId=U.MasterRecordId  WHERE US.MasterId=2   AND ColumnName=''Related Party'' ) R ON B.[Retailer Code]=R.[rtrcode]'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Name')      
 BEGIN      
  SET @SSQL1='UPDATE A SET A.[State Name]=C.StateName FROM RptBillTemplateFinal A       
  INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='State Code')      
 BEGIN      
  SET @SSQL1='UPDATE A SET A.[State Code]=C.StateCode FROM RptBillTemplateFinal A       
  INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='StateTinNo')      
 BEGIN      
  SET @SSQL1='UPDATE A SET A.[StateTinNo]=C.TinFirst2Digit FROM RptBillTemplateFinal A       
  INNER JOIN RetailerShipAdd B ON A.[Retailer ShipId]=B.RtrShipId INNER JOIN StateMaster C ON C.StateId=B.StateId'      
  EXEC (@SSQL1)       
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNCode')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[HSNCode]=R.[ColumnValue] FROM RptBillTemplateFinal B       
  INNER JOIN (select R.prdid,R.prdccode,U.ColumnValue from UdcDetails u inner JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN product  R on R.prdid=U.MasterRecordId  where US.MasterId=1   and ColumnName=''HSN Code'' ) R ON B.[Product Code]=R.[prdccode]'      
  EXEC (@SSQL1)      
 END      
   IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND b.name='HSNDescription')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[HSNDescription]=R.[ColumnValue] FROM RptBillTemplateFinal B       
  INNER JOIN (SELECT R.prdid,R.prdccode,U.ColumnValue FROM UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Product  R on R.prdid=U.MasterRecordId  WHERE US.MasterId=1   AND ColumnName=''HSN Description'' ) R ON B.[Product Code]=R.[prdccode]'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorGstTin')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[DistributorGstTin]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
  SELECT D.DistributorCode,u.ColumnValue from UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId WHERE US.MasterId=16  and ColumnName=''GSTIN'') R on B.[Distributor Code]=R.DistributorCode'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='DistributorStateName')      
 BEGIN      
  SELECT StateCode,StateName,TinFirst2Digit,DistributorCode      
  INTO #DistState       
  FROM UDCHD A (NOLOCK)      
  INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId      
  INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId      
  AND B.UdcMasterId=C.UdcMasterId      
  INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId AND D.MasterId=B.MasterId      
  AND D.UdcMasterId=C.UdcMasterId AND D.UdcMasterId=B.UdcMasterId      
  INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue AND E.StateName=C.ColumnValue      
  INNER JOIN Distributor DB ON DB.DistributorId=C.MasterRecordId      
  WHERE MasterName='Distributor Info Master' AND ColumnName='State Name'      
  SET @SSQL1='UPDATE B SET B.[DistributorStateName]=R.StateName,DistributorStateCode=R.StateCode,       
  DistributorStateTinNo=R.TinFirst2Digit FROM RptBillTemplateFinal B INNER JOIN #DistState R ON B.[Distributor Code]=R.DistributorCode'       
  EXEC (@SSQL1)      
  DROP TABLE #DistState      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='Distributor Type')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[Distributor Type]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
  SELECT D.DistributorCode,u.ColumnValue from UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId where US.MasterId=16  AND ColumnName=''Distributor Type'') R on B.[Distributor Code]=R.DistributorCode'      
  EXEC (@SSQL1)      
 END      
 IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='AadharNo')      
 BEGIN      
  SET @SSQL1='UPDATE B SET B.[AadharNo]=R.ColumnValue  FROM RptBillTemplateFinal B INNER JOIN (      
  SELECT D.DistributorCode,u.ColumnValue from UdcDetails u INNER JOIN UdcMaster US ON u.UdcMasterId=US.UdcMasterId      
  INNER JOIN Distributor D ON D.DistributorId=u.MasterRecordId where US.MasterId=16  AND ColumnName=''Aadhar No'') R on B.[Distributor Code]=R.DistributorCode'      
  EXEC (@SSQL1)      
 END      
 -------------------GST Changes(Mohanakrishna) Ends here      
  IF EXISTS(SELECT A.NAME FROM SysObjects A INNER JOIN SysColumns B ON A.id=B.id AND A.name='RptBillTemplateFinal' AND B.name='Grammage')          
  BEGIN       
     --SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
     --    INNER JOIN (      
     --     SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,ISNULL(      
     --     CASE U.PRDUNITID WHEN 2 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0)/1000      
     --     WHEN 3 THEN ISNULL(SUM(PrdWgt * SP.[Base Qty]),0) END,0) AS Grammage      
     --     FROM RptBillTemplateFinal SP (NOLOCK)      
     --     INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
     --     INNER JOIN PRODUCTUNIT U (NOLOCK) ON P.PrdUnitId=U.PrdUnitId      
     --     WHERE SP.USRID=      
     --     GROUP BY P.PRDID,P.PrdCCode,P.PrdDCode,U.PrdUnitCode,U.PRDUNITID,SP.[Sales Invoice Number]      
     --    ) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''               
     SET @SSQL1=' UPDATE RPT SET RPT.Grammage=X.Grammage FROM RptBillTemplateFinal RPT (NOLOCK)       
         INNER JOIN (      
          SELECT SP.[Sales Invoice Number],P.PRDID,P.PrdCCode,P.PrdDCode,P.PrdWgt Grammage      
          FROM RptBillTemplateFinal SP (NOLOCK)      
          INNER JOIN Product P (NOLOCK) ON P.PrdCCode=SP.[Product Code]      
          WHERE SP.USRID='+CAST(@Pi_UsrId AS VARCHAR(10))+'      
         ) X ON X.PrdCCode=RPT.[PRODUCT CODE] AND X.[Sales Invoice Number]=RPT.[Sales Invoice Number] WHERE RPT.UsrId='+CAST(@Pi_UsrId AS VARCHAR(10))+''               
     EXEC (@SSQL1)          
  END      
  IF EXISTS (SELECT B.NAME FROM SYSOBJECTS A INNER JOIN SYSCOLUMNS B ON A.ID=B.id WHERE A.name='RptBillTemplateFinal' AND B.name='[SalesInvoice NetAmount Actual]')      
  BEGIN      
   SET @SSQL1='UPDATE A SET A.[SalesInvoice NetAmount Actual]=B.OrgNetAmount       
    FROM RptBillTemplateFinal A INNER JOIN SalesInvoice B (NOLOCK) ON A.Salid=B.SalId'      
   EXEC (@SSQL1)       
  END
 IF EXISTS (SELECT A.SalId FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo)      
	 BEGIN      
		  TRUNCATE TABLE RptFinalBillTemplate_DC      
		  INSERT INTO RptFinalBillTemplate_DC(SalId,InvNo,DCNo,DCDate)      
		  SELECT A.SalId,B.SalInvNo,A.DCNo,DCDate FROM SalInvoiceDeliveryChallan A INNER JOIN SalesInvoice B      
		  ON A.SalId=B.SalId INNER JOIN RptBillToPrint C ON C.[Bill Number]=SalInvNo      
	 END      
 ELSE      
	 BEGIN      
		TRUNCATE TABLE RptFinalBillTemplate_DC      
	 END      
 RETURN      
END
GO
UPDATE A SET A.Status=0 fROM ManualConfiguration A WHERE MODULEID='BILL_EDIT1' AND ProjectName='GST'
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='fnSplitString' AND XTYPE in ('TF','FN'))
DROP FUNCTION fnSplitString
GO
CREATE FUNCTION [dbo].[fnSplitString] 
( 
    @string NVARCHAR(200), 
    @delimiter CHAR(1) 
) 
RETURNS @output TABLE(splitdata NVARCHAR(10) 
) 
BEGIN 
    DECLARE @start INT, @end INT 
    SELECT @start = 1, @end = CHARINDEX(@delimiter, @string) 
    WHILE @start < LEN(@string) + 1 BEGIN 
        IF @end = 0  
            SET @end = LEN(@string) + 1
		
		DELETE FROM @output
        INSERT INTO @output (splitdata)  
        VALUES(SUBSTRING(@string, @start, @end - @start)) 
        SET @start = @end + 1 
        SET @end = CHARINDEX(@delimiter, @string, @start)

END 
RETURN
END
GO
IF EXISTS(SELECT * fROM SYSOBJECTS WHERE name='Proc_Cn2Cs_SpecialDiscount' AND XTYPE='P')
DROP PROCEDURE Proc_Cn2Cs_SpecialDiscount
GO
--EXEC Proc_Cn2Cs_SpecialDiscount 0
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_SpecialDiscount]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SpecialDiscount
* PURPOSE		: To insert SpecialRateDetails in Productbatchdetails table
* CREATED		:  Muthukrishnan.G.P
* CREATED DATE	:  31-12-2012
* MODIFIED      :   
* DATE AUTHOR   : DESCRIPTION
------------------------------------------------
* {date}		{developer}		{brief modification description}
* 2013-03-01	Vijendra Kumar	CR(PM)-CCRSTPVM0001
* 05-10-2015	Mahesh Babu D	Tax Not Attached for Product		ICRSTPAR1798
* 28-12-2015	Mahesh Babu D	Selling Rate Spl Rate Calc			ICRSTPAR1960 
*********************************/
SET NOCOUNT ON
BEGIN
	
	DECLARE @RtrHierLevelCode 		AS  NVARCHAR(100)
	DECLARE @RtrHierLevelValueCode 	AS  NVARCHAR(100)
	DECLARE @RtrCode				AS 	NVARCHAR(100)
	
	DECLARE @PrdCCode				AS 	NVARCHAR(100)
	DECLARE @PrdBatCode				AS 	NVARCHAR(100)
	DECLARE @PrdBatCodeAll			AS 	NVARCHAR(100)
	DECLARE @PriceCode				AS 	NVARCHAR(4000)
	DECLARE @Disperc                AS 	NUMERIC(38,6)
	DECLARE @SplRate				AS 	NUMERIC(38,6)
	DECLARE @PrdCtgValMainId		AS	INT
	DECLARE @CtgLevelId				AS 	INT
	DECLARE @CtgMainId				AS 	INT
	DECLARE @RtrId 					AS 	INT
	DECLARE @PrdId 					AS 	INT
	DECLARE @PrdBatId				AS 	INT
	DECLARE @PriceId				AS 	INT
	DECLARE @ContractReq			AS 	INT
	DECLARE @SRReCalc				AS 	INT
	DECLARE @ReCalculatedSR			AS 	NUMERIC(38,6)
	DECLARE @EffFromDate			AS 	DATETIME
	DECLARE @EffToDate				AS 	DATETIME
	DECLARE @CreatedDate			AS 	DATETIME
	
	DECLARE @MulTaxGrp				AS 	INT
	DECLARE @TaxGroupId				AS	INT
	DECLARE @MulRtrId				AS	INT
	DECLARE @MulTaxGroupId			AS 	INT
	DECLARE @DownldSplRate			AS 	NUMERIC(38,6)
	DECLARE @ContHistExist			AS	INT
	DECLARE @ContractPriceIds		AS	NVARCHAR(1000)
	DECLARE @RefPriceId				AS	INT
	DECLARE @CmpId					AS	INT
	DECLARE @CmpPrdCtgId			AS	INT
	DECLARE @RefRtrId				AS	INT
	DECLARE @ErrStatus				AS	INT
	DECLARE @RtrTaxGrp AS INT
	SET @Po_ErrNo=0
	SET @ErrStatus=0
	SET @RtrTaxGrp=0
	
	EXEC Proc_CalculateSpecialDiscountAftRate
	
    SET @ContractReq=1
	SET @SRReCalc=2
	
    TRUNCATE TABLE ETL_Prk_BLContractPricing	
	CREATE TABLE #SpecialRateToAvoid
	(
		Slno				BIGINT,
		RtrHierLevel		NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		RtrHierValue		NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		RtrCode				NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		PrdCCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		PrdBatCode			NVARCHAR(100) COLLATE DATABASE_DEFAULT,
		EffectiveFromDate	DATETIME
	)
		SELECT DISTINCT CtgCode INTO #RetailerCategory 
		FROM RetailerCategory RC 
		INNER JOIN RetailerValueClass RVC ON  RC.CtgMainId=RVC.CtgMainId
		INNER JOIN RetailerValueClassMap RCM ON RCM.RtrValueClassId=RVC.RtrClassId
	
		---Retailer Class Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT T.SlNo,CtgLevelName,T.CtgCode,RtrCode,PrdCCode,PrdBatCode,T.EffectiveFromDate
		FROM TempSpecialRateDiscountProduct T
		WHERE NOT EXISTS(SELECT CtgCode FROM #RetailerCategory R WHERE R.CtgCode=T.CtgCode)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer','Retailer Not Attached to Category:'+RtrHierLevel+' Not Available' FROM #SpecialRateToAvoid
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode--Modified by Raja.C
		--Product Batch Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT 1,RetCategoryLevel,RetCatLevelValue,'ALL',PrdCategoryLevelValue,'ALL',EffFromDate 
		FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product'
		AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK) 
		INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Product','Product & ProductBatch','Product or Product Batch Not Available-'+PrdCategoryLevelValue
		FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) WHERE DownLoadFlag = 'D' AND PrdCategoryLevel = 'Product' 
		AND NOT EXISTS (SELECT DISTINCT PrdCCode FROM Product B (NOLOCK) 
		INNER JOIN ProductBatch C (NOLOCK) ON B.PrdId = C.PrdId WHERE A.PrdCategoryLevelValue = B.PrdCCode)
		--Till Here	
			
		---Retailer Category Level Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer Category Level','Retailer Category Level:'+CtgLevelName+' Not Available' FROM TempSpecialRateDiscountProduct
		WHERE CtgLevelName NOT IN (SELECT CtgLevelName FROM RetailerCategoryLevel)
		
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode--Modified by Raja.C
		----
        --ProductTaxGroup Validation 		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 2,'Tax Group','TaxGroup Not Attached','Tax Group for :'+PrdCCode+' Not Available' FROM TempSpecialRateDiscountProduct
		WHERE PrdCCode  IN (SELECT PrdCCode FROM Product(NOLOCK) WHERE TaxGroupId=0)		
	
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN Product B(NOLOCK)  ON A.PrdCCode=B.PrdCCode and B.TaxGroupId=0 
		--Till here
		
		---Retailer Category Code Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Retailer Category Level Value','Retailer Category Level Value:'+CtgCode+' Not Available' FROM TempSpecialRateDiscountProduct
		WHERE CtgCode NOT IN (SELECT CtgCode FROM RetailerCategory)		
	
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue and A.Prdccode=B.Prdccode--Modified by Raja.C 
		--Eeffective From Date Validation
		INSERT INTO #SpecialRateToAvoid(SlNo,RtrHierLevel,RtrHierValue,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate)
		SELECT DISTINCT SlNo,CtgLevelName,CtgCode,RtrCode,PrdCCode,PrdBatCode,EffectiveFromDate
		FROM TempSpecialRateDiscountProduct
		WHERE EffectiveFromDate>GETDATE()
		
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Special Rate','Effective From Date','Effective Date :'+CAST(EffectiveFromDate AS NVARCHAR(12))+' is greater ' 
		FROM TempSpecialRateDiscountProduct
		WHERE EffectiveFromDate>GETDATE()
		DELETE A FROM TempSpecialRateDiscountProduct A INNER JOIN #SpecialRateToAvoid B ON A.Slno=B.Slno and A.CtgCode=B.RtrHierValue  and A.Prdccode=B.Prdccode --Modified by Raja.C
			
		IF NOT EXISTS(SELECT * FROM TempSpecialRateDiscountProduct)
		BEGIN
			RETURN
		END
		
		SELECT @CmpId=ISNULL(CmpId,0) FROM Company C WHERE DefaultCompany=1
		
		IF EXISTS(Select 'X' FROM TaxSettingMaster A (NOLOCK) 
		INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId 
		WHERE TaxGroup=1	and A.TaxType='GST')
		BEGIN				
			Select @RtrTaxGrp=MIN(Distinct A.RtriD) FROM TaxSettingMaster A (NOLOCK) 
			INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId 
			WHERE TaxGroup=1	and A.TaxType='GST'	AND RtrGroup='RTRINTRA'			
		END	
		ELSE
		BEGIN
			SELECT @RtrTaxGrp=MIN(Distinct A.RtriD) FROM TaxSettingMaster A (NOLOCK) 
			INNER JOIN  TaxGroupSetting B (NOLOCK) ON A.RtrId=B.TaxGroupId 
			WHERE TaxGroup=1	and A.TaxType='VAT'				
		END
		
	
		SELECT DISTINCT ISNULL(Prk.CtgLevelName,'') as RtrHierLevelCode,ISNULL(Prk.CtgCode,'') as RtrHierLevelValueCode,
		RtrCode,ISNULL(Prk.PrdCCode,'') as PrdCCode,ISNULL(Prk.PrdBatCode,'') as PrdBatCodeAll,
		ISNULL(DiscPer,0) as Disperc,ISNULL(SpecialSellingRate,0) as SplRate,
		ISNULL(Prk.EffectiveFromDate,GETDATE()) as EffFromDate,ISNULL(Prk.EffectiveToDate,'2013-12-31') as EffToDate,
		ISNULL(CreatedDate,GETDATE()) as CreatedDate,ISNULL(P.PrdId,0) AS PrdId,
		ISNULL(RCL.CtgLevelId,0) AS CtgLevelId,ISNULL(RC.CtgMainId,0) AS CtgMainId,
		Prdbatid,PCV.PrdCtgValMainId,CmpPrdCtgId,ISNULL(Prk.ApplyOn,0) AS ApplyOn,ISNULL(Prk.[Type],0) AS [Type]
		INTO #SplPriceDetails
		FROM TempSpecialRateDiscountProduct Prk 
		INNER JOIN Product P ON Prk.PrdCCode=P.PrdCCode 
		INNER JOIN Productbatch PB ON PB.prdid=P.Prdid and PB.PrdBatCode=Prk.PrdBatCode
		INNER JOIN ProductCategoryValue PCV ON P.PrdCtgValMainId=PCV.PrdCtgValMainId
		INNER JOIN RetailerCategoryLevel RCL ON Prk.CtgLevelName=RCL.CtgLevelName 
		INNER JOIN RetailerCategory RC ON Prk.CtgCode=RC.CtgCode	
		WHERE  Prk.EffectiveFromDate<=GETDATE()	
	
		---Tax Calculation
		DECLARE @PrdIdTax as BIGINT
		DECLARE @PrdbatIdTax AS BIGINT
		DECLARE Cur_Tax CURSOR
		FOR 
		SELECT DISTINCT PrdId,PrdbatId FROM #SplPriceDetails		
		OPEN Cur_Tax	
		FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax
		WHILE @@FETCH_STATUS=0
		BEGIN	
				EXEC Proc_SellingTaxCalCulation @PrdIdTax,@PrdbatIdTax
		FETCH NEXT FROM Cur_Tax INTO @PrdIdTax,@PrdbatIdTax		
		END		
		CLOSE Cur_Tax
		DEALLOCATE Cur_Tax	
	
		DECLARE @MaxPriceId as BIGINT
		SELECT @MaxPriceId=ISNULL(MAX(PriceId),0) from ProductBatchDetails
	
		--SELECT A.*,CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) AS NewSellRate
		
		SELECT A.*,CASE A.ApplyOn WHEN 1 THEN 
											(CASE [Type] WHEN 1 THEN (SplRate*100)/(100+TaxPercentage)
											 WHEN 2 THEN (SplRate*100)/(100+TaxPercentage)	END)
		ELSE CAST(SplRate AS NUMERIC(38,6)) END AS NewSellRate			-- MODIFIED FOR ICRSTPAR1960 
		,@MaxPriceId+ROW_NUMBER() OVER(Order by A.PrdId,A.PrdBatId,CtgLevelId,CtgMainId,PrdCtgValMainId,CmpPrdCtgId)
		as NewPriceId
		INTO #PriceMaster
		FROM #SplPriceDetails A INNER JOIN ProductBatchTaxPercent B ON A.PrdId=B.PrdId
		AND A.PrdBatId=b.PrdBatId
		  
		--SELECT A.*,CASE A.ApplyOn WHEN 1 THEN 
		--									(CASE [Type] WHEN 1 THEN SplRate-(SplRate*(TaxPercentage/100))
		--									 WHEN 2 THEN SplRate-(SplRate*(TaxPercentage/100))	END)
		--ELSE CAST(SplRate*100/(100+TaxPercentage) AS NUMERIC(38,6)) END AS NewSellRate
		--,@MaxPriceId+ROW_NUMBER() OVER(Order by A.PrdId,A.PrdBatId,CtgLevelId,CtgMainId,PrdCtgValMainId,CmpPrdCtgId)
		--as NewPriceId
		--INTO #PriceMaster
		--FROM #SplPriceDetails A INNER JOIN ProductBatchTaxPercent B ON A.PrdId=B.PrdId
		--AND A.PrdBatId=b.PrdBatId
	
		--SELECT * FROM ProductBatchTaxPercent WHERE PRDID=2556
		
		SELECT PrdbatId,MAX(PriceId) as PriceId 
		INTO #ProductbatchDetails 
		FROM ProductBatchDetails GROUP BY PrdbatId
	
		INSERT INTO ProductBatchDetails(
		PriceId,PrdBatId,PriceCode,BatchSeqId,SLNo,PrdBatDetailValue,DefaultPrice,PriceStatus,
		Availability,LastModBy,LastModDate,AuthId,AuthDate,XMLUpload)
		SELECT DISTINCT 
		NewPriceId,A.PrdBatId,PrdBatCode+'-Spl Rate-'+CAST(NewSellRate AS NVARCHAR(100))
						+CAST(GETDATE() AS NVARCHAR(20)) ,
		
		D.BatchSeqId,D.SlNo,
				(CASE BC.SelRte WHEN 1 THEN NewSellRate ELSE D.PrdBatDetailValue END) AS SelRte,
				0,1,1,1,GETDATE(),1,GETDATE(),0 
		FROM #PriceMaster A 
		INNER JOIN #ProductbatchDetails B ON A.PrdBatId=B.PrdBatId
		INNER JOIN ProductBatchDetails D ON D.PrdBatId=A.PrdBatId and D.PrdBatId=B.PrdBatId and D.PriceId=B.PriceId
		INNER JOIN BatchCreation BC ON BC.BatchSeqId=D.BatchSeqId AND D.SlNo=BC.SlNo
		INNER JOIN ProductBatch C ON C.PrdBatId=A.PrdBatId and C.PrdBatId=B.PrdBatId and C.PrdId=A.PRdId
		and D.PrdBatId=C.PrdBatId
		ORder by NewPriceId,A.PrdBatId,D.SlNo
		
		UPDATE Counters SET CurrValue=(SELECT ISNULL(Max(PriceId),0) FROM ProductBatchDetails) WHERE TabName='ProductBatchDetails' AND FldName='PriceId'
		UPDATE A SET EnableCloning=1 FROM ProductBatch A
		INNER JOIN #PriceMaster B ON B.Prdbatid=A.PrdbatId
		
		--Contract Price Praking Table insert
		INSERT INTO Cn2Cs_Prk_ContractPricing(CmpId,CtgLevelId,CtgMainId,RtrClassId,CmpPrdCtgId,PrdCtgValMainId,
		RtrId,PrdId,PrdBatId,PriceId,DiscountPerc,FlatAmount,EffectiveDate,ToDate,CreatedDate,RtrTaxGroupId)
		SELECT DISTINCT @CmpId,CtgLevelId,CtgMainId,0,0,0,CASE WHEN RtrCode='ALL' THEN '0' ELSE ISNULL(RtrCode,'') END,
		Prdid,Prdbatid,NewPriceId,0,0,EffFromDate,EffToDate,CreatedDate,@RtrTaxGrp
		FROM #PriceMaster
		
		---Special Rate Screen Table Insert and Update
		INSERT INTO SpecialRateAftDownLoad(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,
		SplSelRate,FromDate,CreatedDate,DownloadedDate,ContractPriceIds,DiscountPerc)			
		SELECT DISTINCT RtrHierLevelCode,RtrHierLevelValueCode,RtrCode,PrdCCode,PrdBatCodeAll,
		NewSellRate,EffFromDate,CreatedDate,GETDATE(),'-'+CAST(NewPriceId AS NVARCHAR(10))+'-',Disperc 
		FROM #PriceMaster A
		WHERE NOT EXISTS(		
			SELECT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode, FromDate 
			FROM 
			SpecialRateAftDownLoad B WHERE B.RtrCtgCode=A.RtrHierLevelCode
			and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
			And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll
			and FromDate<=EffFromDate and B.SplSelRate=A.SplRate
						)
		--Added by Rajesh
		INSERT INTO SpecialRateAftDownLoad_Calc(RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode,
		SplSelRate,FromDate,CreatedDate,DownloadedDate,ContractPriceIds,DiscountPerc,ApplyOn,TYPE)		
		SELECT DISTINCT RtrHierLevelCode,RtrHierLevelValueCode,RtrCode,PrdCCode,PrdBatCodeAll,
		NewSellRate,EffFromDate,CreatedDate,GETDATE(),'-'+CAST(NewPriceId AS NVARCHAR(10))+'-',Disperc 
		,ApplyOn,TYPE FROM #PriceMaster A
		WHERE NOT EXISTS(		
			SELECT RtrCtgCode,RtrCtgValueCode,RtrCode,PrdCCode,PrdBatCCode, FromDate 
			FROM 
			SpecialRateAftDownLoad_Calc B WHERE B.RtrCtgCode=A.RtrHierLevelCode
			and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
			And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll
			and FromDate<=EffFromDate and B.SplSelRate=A.SplRate
						)
						
		UPDATE B  SET SplSelRate=NewSellRate,ContractPriceIds='-'+CAST(NewPriceId AS NVARCHAR(10))+'-',DiscountPerc=Disperc
		FROM #PriceMaster A INNER JOIN SpecialRateAftDownLoad_Calc B ON 
		B.RtrCtgCode=A.RtrHierLevelCode
		and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
		And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll 
		AND B.DiscountPerc=A.DisPerc  
		WHERE  FromDate<=EffFromDate
		--Till here 
		
		UPDATE B  SET SplSelRate=NewSellRate,ContractPriceIds='-'+CAST(NewPriceId AS NVARCHAR(10))+'-',DiscountPerc=Disperc
		FROM #PriceMaster A INNER JOIN SpecialRateAftDownLoad B ON 
		B.RtrCtgCode=A.RtrHierLevelCode
		and B.RtrCtgValueCode=A.RtrHierLevelValueCode and B.RtrCode= A.RtrCode
		And B.PrdCCode=A.PrdCCode and B.PrdBatCCode=A.PrdBatCodeAll 
		AND B.DiscountPerc=A.DisPerc  -- Added FOR ICRSTPAR1960
		WHERE  FromDate<=EffFromDate
		---
	
	
		EXEC Proc_Validate_ContractPricing @Po_ErrNo=@ErrStatus
		SET @Po_ErrNo=@ErrStatus
	
		--IF @Po_ErrNo=0
		--BEGIN	
			UPDATE A SET A.DownLoadFlag='Y' FROM Cn2Cs_Prk_SpecialDiscount A (NOLOCK) 
			INNER JOIN SpecialRateAftDownload B (NOLOCK) ON A.PrdCategoryLevelValue = B.PrdCCode 
			AND A.RetCategoryLevel = B.RtrCtgCode AND A.RetCatLevelValue = B.RtrCtgValueCode
		--END
		RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptCollectionReport]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptCollectionReport]
GO
--EXEC Proc_RptCollectionReport 4,1,0,'ParleGSTBillEdit',0,0,1    
 CREATE PROCEDURE [dbo].[Proc_RptCollectionReport]    
(    
 @Pi_RptId  INT,    
 @Pi_UsrId  INT,    
 @Pi_SnapId  INT,    
 @Pi_DbName  nvarchar(50),    
 @Pi_SnapRequired INT,    
 @Pi_GetFromSnap  INT,    
 @Pi_CurrencyId  INT    
)    
AS    
BEGIN    
     
 SET NOCOUNT ON     
 DECLARE @NewSnapId  AS INT    
 DECLARE @DBNAME  AS  nvarchar(50)    
 DECLARE @TblName  AS nvarchar(500)    
 DECLARE @TblStruct  AS nVarchar(4000)    
 DECLARE @TblFields  AS nVarchar(4000)    
 DECLARE @sSql  AS  nVarChar(4000)    
 DECLARE @ErrNo   AS INT    
 DECLARE @PurDBName AS nVarChar(50)    
     
 DECLARE @FromDate AS DATETIME    
 DECLARE @ToDate   AS DATETIME    
 DECLARE @SMId   AS INT    
 DECLARE @RMId   AS INT    
 DECLARE @DlvRId  AS  INT    
 DECLARE @SColId  AS  INT    
 DECLARE @RtrId   AS INT    
 DECLARE @SalId   AS BIGINT    
 DECLARE @TypeId  AS INT    
 DECLARE @TotBillAmount AS NUMERIC(38,6)    
     
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)    
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)    
 SET @SMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))    
 SET @RMId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))    
 SET @DlvRId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId))    
 SET @RtrId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))    
 SET @SalId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId))    
 SET @TypeId =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,77,@Pi_UsrId))    
 SET @SColId=(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))     
 IF @SColId=1    
 BEGIN    
  UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE SlNo IN (2,3) AND RptId = @Pi_RptId   --- RptId = @Pi_UsrId  --MOORTHI    
  UPDATE RptExcelHeaders SET DisplayFlag=1 WHERE SlNo IN (5,6) AND RptId = @Pi_RptId    ---RptId = @Pi_UsrId  --MOORTHI    
 END    
 ELSE    
 BEGIN    
  UPDATE RptExcelHeaders SET DisplayFlag=1 WHERE SlNo IN (2,3) AND RptId = @Pi_RptId    --RptId = @Pi_UsrId --MOORTHI    
  UPDATE RptExcelHeaders SET DisplayFlag=0 WHERE SlNo IN (5,6) AND RptId = @Pi_RptId     --RptId = @Pi_UsrId --MOORTHI    
 END    
 CREATE TABLE #RptCollectionDetail    
 (    
  SalId    BIGINT,    
  SalInvNo  NVARCHAR(50) collate database_default,    
  SalInvDate              DATETIME,    
  SalInvRef   NVARCHAR(50),    
  RtrId    INT,    
  RtrName                 NVARCHAR(50) collate database_default,    
  BillAmount              NUMERIC (38,6),    
  CrAdjAmount             NUMERIC (38,6),    
  DbAdjAmount             NUMERIC (38,6),    
  CashDiscount  NUMERIC (38,6),    
  CollectedAmount         NUMERIC (38,6),    
  BalanceAmount           NUMERIC (38,6),    
  PayAmount            NUMERIC (38,6),    
  TotalBillAmount  NUMERIC (38,6),    
  AmtStatus    NVARCHAR(10) collate database_default,    
  InvRcpDate   DATETIME,    
  CurPayAmount        NUMERIC (38,6),    
  CollCashAmt   NUMERIC (38,6),    
  CollChqAmt   NUMERIC (38,6),    
  CollDDAmt   NUMERIC (38,6),    
  CollRTGSAmt   NUMERIC (38,6),    
  [CashBill]   [numeric](38, 0) NULL,    
  [ChequeBill]  [numeric](38, 0) NULL,    
  [DDbill]   [numeric](38, 0) NULL,    
  [RTGSBill]   [numeric](38, 0) NULL,    
  [TotalBills]  [numeric](38, 0) NULL,      
  InvRcpNo   nvarchar(50)     
      
 )    
 SET @TblName = 'RptCollectionDetail'    
 SET @TblStruct = ' SalId    BIGINT,    
    SalInvNo  NVARCHAR(50),    
    SalInvDate              DATETIME,    
    SalInvRef   NVARCHAR(50),    
    RtrId    INT,    
    RtrName                 NVARCHAR(50),    
    BillAmount              NUMERIC (38,6),    
    CrAdjAmount             NUMERIC (38,6),    
    DbAdjAmount             NUMERIC (38,6),    
    CashDiscount  NUMERIC (38,6),    
    CollectedAmount         NUMERIC (38,6),    
    BalanceAmount           NUMERIC (38,6),    
    PayAmount            NUMERIC (38,6),    
TotalBillAmount  NUMERIC (38,6),    
    AmtStatus   NVARCHAR(10),    
    InvRcpDate  DATETIME,    
    CurPayAmount            NUMERIC (38,6),    
    CollCashAmt NUMERIC (38,6),    
    CollChqAmt NUMERIC (38,6),    
    CollDDAmt  NUMERIC (38,6),    
    CollRTGSAmt NUMERIC (38,6),    
    [CashBill] [numeric](38, 0) NULL,    
    [ChequeBill] [numeric](38, 0) NULL,    
    [DDbill] [numeric](38, 0) NULL,    
    [RTGSBill] [numeric](38, 0) NULL,    
    [TotalBills]  [numeric](38, 0) NULL,    
    InvRcpNo nvarchar(50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL    
    '    
 SET @TblFields = 'SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
     BillAmount,CrAdjAmount,DbAdjAmount,CashDiscount,CollectedAmount,    
     BalanceAmount,PayAmount,TotalBillAmount,AmtStatus,InvRcpDate,CurPayAmount,CollCashAmt,    
    CollChqAmt,CollDDAmt,CollRTGSAmt,[CashBill],[ChequeBill],[DDbill],[RTGSBill],[TotalBills],InvRcpNo'    
 IF @Pi_GetFromSnap = 1     
 BEGIN    
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId    
  SET @DBNAME =  @DBNAME    
 END    
 ELSE    
 BEGIN    
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3    
  SET @DBNAME = @PI_DBNAME + @DBNAME    
 END    
 IF @TypeId=1     
 BEGIN    
  EXEC Proc_CollectionValues 4    
      
 END    
 ELSE    
 BEGIN     
  EXEC Proc_CollectionValues 1    
 END    
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data    
 BEGIN     
  INSERT INTO #RptCollectionDetail (SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
  BillAmount,CrAdjAmount,DbAdjAmount,CashDiscount,CollectedAmount,    
  BalanceAmount,PayAmount,TotalBillAmount,AmtStatus,InvRcpDate,CurPayAmount,CollCashAmt,CollChqAmt,CollDDAmt,CollRTGSAmt    
  ,InvRcpNo)    
  SELECT SalId,SalInvNo,SalInvDate,SalInvRef,RtrId,RtrName,    
  dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CashDiscount,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId),    
  ABS(dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId))    
  --dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)    
  AS BalanceAmount,dbo.Fn_ConvertCurrency(PayAmount,@Pi_CurrencyId),0 AS TotalBillAmount,    
  ( --Commented and Added by Thiru on 20/11/2009    
--   CASE WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
--   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))>0     
--   THEN 'Db'     
--   WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
--   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CollectedAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))< 0     
--   THEN 'Cr'     
--   ELSE '' END    
   CASE WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))>0     
   THEN 'Db'     
   WHEN (dbo.Fn_ConvertCurrency(BillAmount,@Pi_CurrencyId)+dbo.Fn_ConvertCurrency(DbAdjAmount,@Pi_CurrencyId)    
   -dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId)-dbo.Fn_ConvertCurrency(CrAdjAmount,@Pi_CurrencyId))< 0     
   THEN 'Cr'     
   ELSE '' END    
--Till Here    
  ) AS AmtStatus,    
  R.InvRcpDate,dbo.Fn_ConvertCurrency(CurPayAmount,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CollCashAmt,@Pi_CurrencyId),    
  dbo.Fn_ConvertCurrency(CollChqAmt,@Pi_CurrencyId),dbo.Fn_ConvertCurrency(CollDDAmt,@Pi_CurrencyId)    
  ,dbo.Fn_ConvertCurrency(CollRTGSAmt,@Pi_CurrencyId),R.InvRcpNo    
  FROM RptCollectionValue R    
  WHERE (SMId = (CASE @SMId WHEN 0 THEN SMId ELSE 0 END) OR    
  SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId)))     
  AND     
  (RMId = (CASE @RMId WHEN 0 THEN RMId ELSE 0 END) OR    
  RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))     
  AND    
  (DlvRMId=(CASE @DlvRId WHEN 0 THEN DlvRMId ELSE 0 END) OR    
  DlvRMId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,35,@Pi_UsrId)) )    
  AND     
  (RtrId = (CASE @RtrId WHEN 0 THEN RtrId ELSE 0 END) OR    
  RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))    
  AND    
  (SalId = (CASE @SalId WHEN 0 THEN SalId ELSE 0 END) OR    
  SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,14,@Pi_UsrId)))     
  AND InvRcpDate BETWEEN @FromDate AND @ToDate     
      
  IF LEN(@PurDBName) > 0    
  BEGIN    
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT    
       
   SET @SSQL = 'INSERT INTO #RptCollectionDetail ' +     
    '(' + @TblFields + ')' +     
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName     
    +  ' WHERE (SMId = (CASE ' + CAST(@SMId AS nVarchar(10)) + ' WHEN 0 THEN SMId ELSE 0 END) OR '+    
    'SMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',1,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RMId = (CASE ' + CAST(@RMId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR ' +    
    'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',2,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RMId = (CASE ' + CAST(@DlvRId AS nVarchar(10)) + ' WHEN 0 THEN RMId ELSE 0 END) OR ' +    
    'RMId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',35,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND (RtrId = (CASE ' + CAST(@RtrId AS nVarchar(10)) + ' WHEN 0 THEN RtrId ELSE 0 END) OR '+    
    'RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',3,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))    
    AND (SalId = (CASE ' + CAST(@SalId AS nVarchar(10)) + ' WHEN 0 THEN SalId ELSE 0 END) OR ' +    
    'SalId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',14,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))     
    AND INvRcpDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''    
     
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Purged Table'    
  END    
  IF @Pi_SnapRequired = 1    
  BEGIN    
   SELECT @NewSnapId = @Pi_SnapId    
       
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
   IF @ErrNo = 0    
   BEGIN    
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +     
     '(SnapId,UserId,RptId,' + @TblFields + ')' +     
     ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +    
     ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
     ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptCollectionDetail'    
        
    EXEC (@SSQL)    
    PRINT 'Saved Data Into SnapShot Table'    
   END    
  END    
 END    
 ELSE    --To Retrieve Data From Snap Data    
 BEGIN    
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
  PRINT @ErrNo    
  IF @ErrNo = 0     
  BEGIN    
   SET @SSQL = 'INSERT INTO #RptCollectionDetail ' +     
    '(' + @TblFields + ')' +     
    ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +    
    ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +    
    ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
    ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))    
       
       
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Snap Shot Table'    
  END    
  ELSE    
  BEGIN    
   PRINT 'DataBase or Table not Found'    
  END    
 END    
 --Check for Report Data    
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId    
     
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)    
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptCollectionDetail    
 -- Till Here    
     
 CREATE TABLE #Tempbalance    
 (    
  Billamt numeric(18,4),    
  CurPayAmt numeric(18,4),    
  Balance numeric(18,4),    
  RtrId int,    
  Salesinvoice nvarchar(50),    
  Receiptinvoice nvarchar(50)    
 )    
 DECLARE @BillAmount NUMERIC (38,6)    
 DECLARE @CurPayAmount NUMERIC (38,6)    
 DECLARE @BalanceAmount NUMERIC (38,6)    
 DECLARE @InvRcpNo nvarchar(50)    
 DECLARE @SalinvNo nvarchar(50)    
 DECLARE @TempInvoiceRcpNo nvarchar(50)    
 DECLARE @CurPayAmountbal NUMERIC (38,6)    
 DECLARE @BalRtrId int    
 DECLARE Cur_BalanceAmt CURSOR FOR    
 SELECT BillAmount,CurPayAmount,BalanceAmount,InvRcpNo,SalInvNo,RtrId FROM #RptCollectionDetail ORDER BY SalInvNo,InvRcpNo    
 OPEN Cur_BalanceAmt    
 FETCH NEXT FROM Cur_BalanceAmt INTO @BillAmount,@CurPayAmount,@BalanceAmount,@InvRcpNo,@SalinvNo,@BalRtrId    
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT into #Tempbalance(BillAmt,CurPayAmt,RtrId,Salesinvoice,Receiptinvoice) VALUES (@BillAmount,@CurPayAmount,@BalRtrId,@SalinvNo,@InvRcpNo)    
        SELECT @CurPayAmountbal=sum(CurPayAmt) FROM #Tempbalance WHERE RtrId=@BalRtrId AND Salesinvoice=@SalinvNo --AND Receiptinvoice=@InvRcpNo    
        UPDATE #RptCollectionDetail SET BalanceAmount=BillAmount-@CurPayAmountbal WHERE CurPayAmount=@CurPayAmount    
  AND SalInvNo=@SalinvNo AND InvRcpNo=@InvRcpNo AND RtrId=@BalRtrId    
  FETCH NEXT FROM Cur_BalanceAmt INTO @BillAmount,@CurPayAmount,@BalanceAmount,@InvRcpNo,@SalinvNo,@BalRtrId    
 END    
 CLOSE Cur_BalanceAmt    
 DEALLOCATE Cur_BalanceAmt    
     
 UPDATE #RptCollectionDetail SET  [CashBill]=(CASE WHEN CollCashAmt<>0 THEN 1 ELSE 0 END)     
 UPDATE #RptCollectionDetail SET  [ChequeBill]=(CASE WHEN CollChqAmt<>0 THEN 1 ELSE 0 END)    
 UPDATE #RptCollectionDetail SET  [DDbill]=(CASE WHEN BalanceAmount<>0 THEN 1 ELSE 0 END) WHERE  AmtStatus='DB'    
 UPDATE #RptCollectionDetail SET  [RTGSBill]=(CASE WHEN  CollRTGSAmt<>0 THEN 1 ELSE 0 END)    
 UPDATE #RptCollectionDetail SET  [TotalBills]=(SELECT Count(Salid) FROM #RptCollectionDetail)    
     
 SELECT SalId,SalInvNo,SalInvDate,SalInvRef,A.InvRcpNo,InvRcpDate,RtrId,RtrName, ----------- Added by Lakshman M (A.InvRcpNo two column name same aliasname modified)   
 BillAmount,CurPayAmount,CrAdjAmount,DbAdjAmount,CashDiscount,    
 ISNULL(CollCashAmt,0) AS CollCashAmt,ISNULL(CollChqAmt,0) AS CollChqAmt,ISNULL(CollDDAmt,0) AS CollDDAmt,ISNULL(CollRTGSAmt,0) AS CollRTGSAmt,BalanceAmount,CollectedAmount,PayAmount,TotalBillAmount,AmtStatus,    
 CashBill,Chequebill,DDBill,RTGSBill,InvRcpNo,[TotalBills] FROM #RptCollectionDetail A ORDER BY SalId,InvRcpDate,A.InvRcpNo   
 select 'AAA',* from #RptCollectionDetail  
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptId=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)    
 BEGIN    
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptCollectionDetail_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)    
  DROP TABLE RptCollectionDetail_Excel    
  SELECT  SalId,SalInvNo,SalInvDate,SalInvRef,InvRcpNo,InvRcpDate,RtrId,RtrName,    
   BillAmount,CurPayAmount,CrAdjAmount,DbAdjAmount,CashDiscount,    
   ISNULL(CollCashAmt,0) AS CollCashAmt,ISNULL(CollChqAmt,0) AS CollChqAmt,ISNULL(CollDDAmt,0) AS CollDDAmt,    
   ISNULL(CollRTGSAmt,0) AS CollRTGSAmt,BalanceAmount,CollectedAmount,PayAmount,TotalBillAmount,AmtStatus INTO RptCollectionDetail_Excel FROM #RptCollectionDetail    
 END    
RETURN    
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Fn_ReturnClaimDetailsWithSalesValue' AND XTYPE IN('TF','FN'))
DROP FUNCTION Fn_ReturnClaimDetailsWithSalesValue
GO
--SELECT * FROM Fn_ReturnClaimDetailsWithSalesValue(2,16)
CREATE FUNCTION Fn_ReturnClaimDetailsWithSalesValue(@PI_USRID INT,@PI_TRANSID INT)
RETURNS @CLMDETAILS TABLE
(
	Reference				VARCHAR(100),
	SchDesc					VARCHAR(500),
	[Select]				INT,
	[Sales Value]			NUMERIC(38,6),
	[Discount Value]		NUMERIC(38,6),
	[Free Product Value]	NUMERIC(38,6),
	[Gift Product Value]	NUMERIC(38,6),
	[Total Spent Amount]	NUMERIC(38,6),
	[Tax]					NUMERIC(38,6),
	[Liability]				NUMERIC(38,2),
	[% Claimable]			NUMERIC(38,6),
	[Claimable Amount]		NUMERIC(38,6),
	[Recommended Amount]	NUMERIC(38,6),
	[Received Amount]		NUMERIC(38,6),
	[Db/Cr Note Selection]	INT,
	Status					VARCHAR(50),
	Remarks					VARCHAR(200)
)
AS
/***************************************************************************************************
* PROCEDURE	: Fn_ReturnClaimDetailsWithSalesValue
* PURPOSE	: To Return Scheme Claim Details
* DATE		: 10/07/2015
* CREATED	: PRAVEENRAJ BHASKARAN
* MODIFIED
* DATE			    AUTHOR     DESCRIPTION
----------------------------------------------------------------------------------------------------
****************************************************************************************************/
BEGIN
		INSERT INTO @CLMDETAILS (Reference,SchDesc,[Select],[Sales Value],[Discount Value],[Free Product Value],[Gift Product Value],
								 [Total Spent Amount],[Tax],[Liability],[% Claimable],[Claimable Amount],[Recommended Amount],[Received Amount],
								 [Db/Cr Note Selection],Status,Remarks)
		SELECT SchCode as 'Reference',(CASE LEN(ISNULL(CmpSchCode,'')) 
		WHEN 0 THEN ISNULL(SchCode,'')+' - '+SchDesc ELSE ISNULL(CmpSchCode,'')+' -'+SchDesc END) AS SchDesc,
		Selected as [Select],ISNULL(SUM(SalesValue),0) AS 'Sales Value',ISNULL(SUM([DiscountAmt]),0) as 'Discount Value',ISNULL(SUM([FreeAmt]),0) 
		as 'Free Product Value',ISNULL(SUM([GiftAmt]),0) as 'Gift Product Value',ISNULL(SUM([TotSpent]),0) 
		as 'Total Spent Amount',ISNULL(SUM([GSTTax]),0) as 'GSTTax',0 as 'Liability',Claimable as '% Claimable', 0.00 as 'Claimable Amount' , 0 'Recommended Amount' ,
		0 'Received Amount' , 0 AS 'Db/Cr Note Selection','Cancelled' as 'Status','' AS Remarks FROM TempSchemeClaimDetails 
		WHERE Usrid = @PI_USRID AND TransID = @PI_TRANSID GROUP BY  SchCode,CmpSchCode,SchDesc,Selected,Claimable
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptCurrentStockParle]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptCurrentStockParle]
GO
--Exec Proc_RptCurrentStockParle 249,1,0,'PARLE',0,0,1,0
CREATE PROCEDURE [dbo].[Proc_RptCurrentStockParle]
(
	@Pi_RptId  INT,
	@Pi_UsrId  INT,
	@Pi_SnapId  INT,
	@Pi_DbName  nvarchar(50),
	@Pi_SnapRequired INT,
	@Pi_GetFromSnap  INT,
	@Pi_CurrencyId  INT,
	@Po_Errno  INT OUTPUT
)
AS
/*********************************
* PROCEDURE : Proc_RptCurrentStock
* PURPOSE : To get the Current Stock details for Report
* CREATED : Nandakumar R.G
* CREATED DATE : 01/08/2007
* MODIFIED
* DATE			AUTHOR				DESCRIPTION
24/07/2009	MarySubashini.S		To add the Tax Validation
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	DECLARE @NewSnapId  AS INT
	DECLARE @DBNAME  AS  nvarchar(50)
	DECLARE @TblName  AS nvarchar(500)
	DECLARE @TblStruct  AS nVarchar(4000)
	DECLARE @TblFields  AS nVarchar(4000)
	DECLARE @sSql  AS  nVarChar(4000)
	DECLARE @ErrNo   AS INT
	DECLARE @PurDBName AS nVarChar(50)
	--Filter Variable
	DECLARE @CmpId          AS Int
	DECLARE @LcnId          AS Int
	DECLARE @CmpPrdCtgId  AS Int
	DECLARE @PrdCtgMainId  AS Int
	DECLARE @StockValue      AS Int
	DECLARE @DispBatch  AS Int
	DECLARE @PrdStatus       AS Int
	DECLARE @PrdBatId        AS Int
	DECLARE @PrdBatStatus       AS Int
	DECLARE @SupTaxGroupId      AS Int
	DECLARE @RtrTaxFroupId      AS Int
	DECLARE @fPrdCatPrdId       AS Int
	DECLARE @fPrdId        AS Int
	DECLARE @SupZeroStock	AS INT
	DECLARE @StockType	AS INT
	DECLARE @RptDispType	AS INT
	--Till Here
	--Assgin Value for the Filter Variable
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	SET @LcnId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))
	SET @StockValue = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,23,@Pi_UsrId))
	SET @DispBatch = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,28,@Pi_UsrId))
	SET @PrdStatus = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId))
	SET @PrdBatStatus = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId))
	SET @PrdBatId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))
	SET @SupTaxGroupId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,18,@Pi_UsrId))
	SET @RtrTaxFroupId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,19,@Pi_UsrId))
	SET @SupZeroStock = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))
	SET @StockType = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,240,@Pi_UsrId))
	SET @RptDispType = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,221,@Pi_UsrId))
		--Till Here
	--Modified by Lakshman 	M on 03/05/2017 ---
	DECLARE @ProdStatus TABLE
	(
		PrdStatus INT
	)	
	
	IF(ISNULL(@PrdStatus,0)=0)
	BEGIN
		INSERT INTO @ProdStatus (PrdStatus)
		SELECT 0 UNION
		SELECT 1 UNION
		SELECT 2
	END
	ELSE IF(@PrdStatus = 1)
	BEGIN
		INSERT INTO @ProdStatus (PrdStatus)
		SELECT 1 
	END
	ELSE IF(@PrdStatus = 2)
	BEGIN
	INSERT INTO @ProdStatus (PrdStatus)
		SELECT 0 UNION
		SELECT 2
	END
	----  Till here end ---------
	
	--If Product Category Filter is available
	EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId
	SET @fPrdCatPrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))
	SET @fPrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))
	--Till Here
	SELECT DISTINCT Prdid,U.ConversionFactor 
	Into #PrdUomBox
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	--Where Um.UomCode='BX'
	Where Um.UomCode IN ('BX','BOX')
	
	INSERT Into #PrdUomBox		
	SELECT DISTINCT Prdid,U.ConversionFactor
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	INNER JOIN UomMaster UM On U.UomId=Um.UomId
	Where  P.PrdId Not In (Select PrdId From #PrdUomBox) AND U.ConversionFactor > 1
			
	SELECT DISTINCT Prdid,U.ConversionFactor
	Into #PrdUomPack
	FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid
	Inner Join UomMaster UM On U.UomId=Um.UomId
	Where  P.PrdId Not In (Select PrdId From #PrdUomBox) And U.BaseUom='Y'
	
	Create Table #PrdUomAll
	(
		PrdId Int,
		ConversionFactor Int
	)
	Insert Into #PrdUomAll
	Select Distinct PrdId,ConversionFactor From #PrdUomBox
	Union All
	Select Distinct PrdId,ConversionFactor From #PrdUomPack
	SELECT Prdid,
			Case PrdUnitId 
			When 2 Then (PrdWgt/1000)/1000
			When 3 Then PrdWgt/1000 END AS PrdWgt
			Into #PrdWeight  From Product
			
			
	Create TABLE #RptCurrentStock
	(
		PrdId            INT,
		PrdDcode         NVARCHAR(100),
		PrdName      NVARCHAR(200),
		PrdBatId         INT,
		PrdBatCode       NVARCHAR(100),
		MRP              NUMERIC (38,6),
		DisplayRate      NUMERIC (38,6),
		Saleable         INT,
		SaleableWgt	     NUMERIC (38,6),
		Unsaleable       INT,
		UnsaleableWgt	 NUMERIC (38,6),
		Offer            INT,
		OfferWgt		 NUMERIC (38,6),
		DisplaySalRate   NUMERIC (38,6),
		DisplayUnSalRate NUMERIC (38,6),
		DisplayTotRate   NUMERIC (38,6),
		StockType	     INT
		
	)
	SET @TblName = 'RptCurrentStock'
	SET @TblStruct = '  PrdId      INT,
						PrdDcode    NVARCHAR(100),
						PrdName     NVARCHAR(200),
						PrdBatId       INT,
						PrdBatCode     NVARCHAR(100),
						MRP            NUMERIC (38,6),
						DisplayRate    NUMERIC (38,6),
						Saleable       INT,
						SaleableWgt	    NUMERIC (38,6),
						Unsaleable		INT,
						UnsaleableWgt	 NUMERIC (38,6),
						Offer           INT,
						OfferWgt		 NUMERIC (38,6),
						DisplaySalRate    NUMERIC (38,6),
						DisplayUnSalRate   NUMERIC (38,6),
						DisplayTotRate     NUMERIC (38,6),
						StockType		   INT'
	SET @TblFields = 'PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,MRP,DisplayRate,
	Saleable,SaleableWgt,Unsaleable,UnsaleableWgt,Offer,OfferWgt,DisplaySalRate,DisplayUnSalRate,DisplayTotRate,StockType'
	IF @Pi_GetFromSnap = 1
	BEGIN
		Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId
		SET @DBNAME = @DBNAME
	END
	ELSE
	BEGIN
		Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3
		SET @DBNAME = @PI_DBNAME + @DBNAME
	END
	SET @Po_Errno = 0
	IF @Pi_GetFromSnap = 0  --To Generate For New Report Data
	BEGIN
	     INSERT INTO #RptCurrentStock (PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,MRP,DisplayRate,
				Saleable,SaleableWgt,Unsaleable,UnsaleableWgt,Offer,OfferWgt,DisplaySalRate,DisplayUnSalRate,DisplayTotRate,StockType)
								SELECT VC.PrdId,PrdDcode,PrdName,0,0,
				dbo.Fn_ConvertCurrency(MRP,@Pi_CurrencyId) AS MRP,
				(CASE @StockValue WHEN 1 THEN dbo.Fn_ConvertCurrency(SelRate,@Pi_CurrencyId)
				WHEN 2 THEN dbo.Fn_ConvertCurrency(ListPrice,@Pi_CurrencyId)
				ELSE dbo.Fn_ConvertCurrency(MRP,1) END ) AS DisplayRate,
				SUM(Saleable) AS Saleable,(SUM(Saleable)* P.PrdWgt),
				SUM(Unsaleable) AS Unsaleable,(SUM(Unsaleable)* P.PrdWgt),
				SUM(Offer) AS Offer,(SUM(Offer)* P.PrdWgt),
				SUM((CASE @StockValue WHEN 1 THEN dbo.Fn_ConvertCurrency(SalSelRate,@Pi_CurrencyId)
				WHEN 2 THEN dbo.Fn_ConvertCurrency(SalListPrice,@Pi_CurrencyId)
				ELSE dbo.Fn_ConvertCurrency(SalMRP,@Pi_CurrencyId) END )) AS DisplaySalRate,
				SUM((CASE @StockValue WHEN 1 THEN dbo.Fn_ConvertCurrency(UnSalSelRate,@Pi_CurrencyId)
				WHEN 2 THEN dbo.Fn_ConvertCurrency(UnSalListPrice,@Pi_CurrencyId)
				ELSE dbo.Fn_ConvertCurrency(UnSalMRP,@Pi_CurrencyId) END )) AS DisplayUnSalRate,
				SUM((CASE @StockValue WHEN 1 THEN dbo.Fn_ConvertCurrency(TotSelRate,@Pi_CurrencyId)
				WHEN 2 THEN dbo.Fn_ConvertCurrency(TotListPrice,@Pi_CurrencyId)
				ELSE dbo.Fn_ConvertCurrency(TotMRP,@Pi_CurrencyId) END )) AS DisplayTotRate,@StockType
				FROM dbo.View_CurrentStockReportParle VC LEFT OUTER JOIN #PrdWeight P ON VC.PrdId = P.PrdId 
				WHERE (CmpId=  (CASE @CmpId WHEN 0 THEN CmpId ELSE 0 END ) OR
				CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
				AND   (LcnId=  (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END ) OR
				LcnId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))
				AND   (VC.PrdId = (CASE @fPrdCatPrdId WHEN 0 THEN VC.PrdId Else 0 END) OR
				VC.PrdId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))
				AND   (VC.PrdId = (CASE @fPrdId WHEN 0 THEN VC.PrdId Else 0 END) OR
				VC.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))
				--AND   (PrdStatus=(CASE @PrdStatus WHEN 0 THEN PrdStatus ELSE 0 END ) OR
				--PrdStatus IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId)))
				AND   (Status= (CASE @PrdBatStatus WHEN 0 THEN Status ELSE -1 END ) OR
				Status IN (SELECT iCountId-1 FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId)))
				AND   (PrdBatId=(CASE @PrdBatId WHEN 0 THEN PrdBatId ELSE 0 END ) OR
				PrdBatId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))) 
				--AND	UsrId = @Pi_UsrId
				AND PrdStatus IN (SELECT Prdstatus from @ProdStatus)  --- Added Lakshman on 03/05/2017 
				GROUP BY VC.PrdId,PrdDcode,PrdName,MRP,ListPrice,SelRate,P.PrdWgt Order By PrdDcode
				
				--UPDATE #RptCurrentStock 
				
	IF LEN(@PurDBName) > 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptCurrentStock ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName
			+' WHERE (CmpId=(CASE '+CAST(@CmpId AS NVARCHAR(10))+' WHEN 0 THEN CmpId ELSE 0 END ) OR
			CmpId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',4,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			AND   (LcnId=(CASE '+CAST(@LcnId AS NVARCHAR(10))+' WHEN 0 THEN LcnId ELSE 0 END ) OR
			LcnId IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',22,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			AND   (PrdId = (CASE '+CAST(@fPrdCatPrdId AS NVARCHAR(10))+' WHEN 0 THEN PrdId Else 0 END) OR
			PrdId IN (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',26,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			AND   (PrdId = (CASE'+CAST(@fPrdId AS NVARCHAR(10))+' WHEN 0 THEN PrdId Else 0 END) OR
			PrdId in (SELECT iCountid from Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',5,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			AND   (PrdStatus=(CASE '+CAST(@PrdStatus AS NVARCHAR(10))+' WHEN 0 THEN PrdStatus ELSE 0 END ) OR
			PrdStatus IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',24,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			AND   (Status=(CASE '+CAST(@PrdBatStatus AS NVARCHAR(10))+' WHEN 0 THEN Status ELSE 0 END ) OR
			Status IN (SELECT iCountId-1 FROM dbo.Fn_ReturnRptFilters('+CAST(@Pi_RptId AS NVARCHAR(10))+',25,'+CAST(@Pi_UsrId AS NVARCHAR(10))+')))
			GROUP BY PrdId,PrdDcode,PrdName,PrdBatId,PrdBatCode,MRP,ListPrice,SelRate'
			EXEC (@SSQL)
			UPDATE #RptCurrentStock SET DispBatch=@DispBatch
			PRINT 'Retrived Data From Purged Table'
		END
		IF @Pi_SnapRequired = 1
		BEGIN
			SELECT @NewSnapId = @Pi_SnapId
			EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
			@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
			SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +
			'(SnapId,UserId,RptId,' + @TblFields + ')' +
			' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptCurrentStock'
			EXEC (@SSQL)
			PRINT 'Saved Data Into SnapShot Table'
		END
	END
	ELSE    --To Retrieve Data From Snap Data
	BEGIN
		EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,
		@Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT
		IF @ErrNo = 0
		BEGIN
			SET @SSQL = 'INSERT INTO #RptCurrentStock ' +
			'(' + @TblFields + ')' +
			' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +
			' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +
			' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +
			' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))
			EXEC (@SSQL)
			PRINT 'Retrived Data From Snap Shot Table'
		END
		ELSE
		BEGIN
			SET @Po_Errno = 1
			PRINT 'DataBase or Table not Found'
			RETURN
		END
	END		
	IF @SupZeroStock = 1
		BEGIN
        SELECT A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,MAX(A.DisplayRate) AS DisplayRate,
        Case When SUM(Saleable)<MAX(ConversionFactor) Then 0 Else SUM(Saleable)/MAX(ConversionFactor) End  As SaleableBOX,
		Case When SUM(Saleable)<MAX(ConversionFactor) Then SUM(Saleable) Else SUM(Saleable)%MAX(ConversionFactor) End  As SaleablePKT,
		Case When SUM(UnSaleable)<MAX(ConversionFactor) Then 0 Else SUM(UnSaleable)/MAX(ConversionFactor) End  As UnSaleableBOX,
		Case When SUM(UnSaleable)<MAX(ConversionFactor) Then SUM(UnSaleable) Else SUM(UnSaleable)%MAX(ConversionFactor) End  As UnSaleablePKT,
		Case When SUM(Offer)<MAX(ConversionFactor) Then 0 Else SUM(Offer)/MAX(ConversionFactor) End  As OfferBOX,
		Case When SUM(Offer)<MAX(ConversionFactor) Then SUM(Offer) Else SUM(Offer)%MAX(ConversionFactor) End As OfferPKT,
        SUM(A.DisplaySalRate) AS DisplaySalRate,SUM(A.DisplayUnSalRate) AS DisplayUnSalRate,SUM(A.DisplayTotRate) AS DisplayTotRate,A.StockType 
		FROM #RptCurrentStock A,#PrdUomAll B WHERE A.Prdid = B.Prdid 
	    GROUP BY A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,A.StockType Having SUM(A.Saleable + A.UnSaleable + A.Offer)<>0 Order By A.PrdDcode
			IF EXISTS(SELECT * FROM Sysobjects WHERE Name = 'RptCurrentStockReportParle_Excel' And XTYPE = 'U')
	        DROP TABLE RptCurrentStockReportParle_Excel
			SELECT A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,MAX(A.DisplayRate) AS DisplayRate,
			Case When SUM(Saleable)<MAX(ConversionFactor) Then 0 Else SUM(Saleable)/MAX(ConversionFactor) End  As SaleableBOX,
			Case When SUM(Saleable)<MAX(ConversionFactor) Then SUM(Saleable) Else SUM(Saleable)%MAX(ConversionFactor) End  As SaleablePKT,
			Case When SUM(UnSaleable)<MAX(ConversionFactor) Then 0 Else SUM(UnSaleable)/MAX(ConversionFactor) End  As UnSaleableBOX,
			Case When SUM(UnSaleable)<MAX(ConversionFactor) Then SUM(UnSaleable) Else SUM(UnSaleable)%MAX(ConversionFactor) End  As UnSaleablePKT,
			Case When SUM(Offer)<MAX(ConversionFactor) Then 0 Else SUM(Offer)/MAX(ConversionFactor) End  As OfferBOX,
			Case When SUM(Offer)<MAX(ConversionFactor) Then SUM(Offer) Else SUM(Offer)%MAX(ConversionFactor) End As OfferPKT,
			SUM(A.DisplaySalRate) AS DisplaySalRate,SUM(A.DisplayUnSalRate) AS DisplayUnSalRate,SUM(A.DisplayTotRate) AS DisplayTotRate,A.StockType 
			INTO RptCurrentStockReportParle_Excel FROM #RptCurrentStock A,#PrdUomAll B WHERE A.PrdId = B.PrdId
			GROUP BY A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,A.StockType Having SUM(A.Saleable + A.UnSaleable + A.Offer)<>0 Order By A.PrdDcode
		    DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptCurrentStock WHERE (Saleable+UnSaleable+Offer)<>0
		END
		ELSE
		BEGIN
			SELECT A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,MAX(A.DisplayRate) AS DisplayRate,
			Case When SUM(Saleable)<MAX(ConversionFactor) Then 0 Else SUM(Saleable)/MAX(ConversionFactor) End  As SaleableBOX,
			Case When SUM(Saleable)<MAX(ConversionFactor) Then SUM(Saleable) Else SUM(Saleable)%MAX(ConversionFactor) End  As SaleablePKT,
			Case When SUM(UnSaleable)<MAX(ConversionFactor) Then 0 Else SUM(UnSaleable)/MAX(ConversionFactor) End  As UnSaleableBOX,
			Case When SUM(UnSaleable)<MAX(ConversionFactor) Then SUM(UnSaleable) Else SUM(UnSaleable)%MAX(ConversionFactor) End  As UnSaleablePKT,
			Case When SUM(Offer)<MAX(ConversionFactor) Then 0 Else SUM(Offer)/MAX(ConversionFactor) End  As OfferBOX,
			Case When SUM(Offer)<MAX(ConversionFactor) Then SUM(Offer) Else SUM(Offer)%MAX(ConversionFactor) End As OfferPKT,
            SUM(A.DisplaySalRate) AS DisplaySalRate,SUM(A.DisplayUnSalRate) AS DisplayUnSalRate,SUM(A.DisplayTotRate) AS DisplayTotRate,A.StockType 
			FROM #RptCurrentStock A,#PrdUomAll B WHERE A.Prdid = B.Prdid 
            GROUP BY A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,A.StockType Order By A.PrdDcode
				IF EXISTS(SELECT * FROM Sysobjects WHERE Name = 'RptCurrentStockReportParle_Excel' And XTYPE = 'U')
				DROP TABLE RptCurrentStockReportParle_Excel
				SELECT A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,MAX(A.DisplayRate) AS DisplayRate,
				Case When SUM(Saleable)<MAX(ConversionFactor) Then 0 Else SUM(Saleable)/MAX(ConversionFactor) End  As SaleableBOX,
				Case When SUM(Saleable)<MAX(ConversionFactor) Then SUM(Saleable) Else SUM(Saleable)%MAX(ConversionFactor) End  As SaleablePKT,
				Case When SUM(UnSaleable)<MAX(ConversionFactor) Then 0 Else SUM(UnSaleable)/MAX(ConversionFactor) End  As UnSaleableBOX,
				Case When SUM(UnSaleable)<MAX(ConversionFactor) Then SUM(UnSaleable) Else SUM(UnSaleable)%MAX(ConversionFactor) End  As UnSaleablePKT,
				Case When SUM(Offer)<MAX(ConversionFactor) Then 0 Else SUM(Offer)/MAX(ConversionFactor) End  As OfferBOX,
				Case When SUM(Offer)<MAX(ConversionFactor) Then SUM(Offer) Else SUM(Offer)%MAX(ConversionFactor) End As OfferPKT,
				SUM(A.DisplaySalRate) AS DisplaySalRate,SUM(A.DisplayUnSalRate) AS DisplayUnSalRate,SUM(A.DisplayTotRate) AS DisplayTotRate,A.StockType 
				INTO RptCurrentStockReportParle_Excel FROM #RptCurrentStock A,#PrdUomAll B WHERE A.Prdid = B.Prdid 
				GROUP BY A.PrdId,A.PrdDcode,A.PrdName,A.PrdBatId,A.PrdBatCode,A.MRP,A.StockType Order By A.PrdDcode
			DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptCurrentStock
			
		END
		RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptStockandSalesVolumeParle]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptStockandSalesVolumeParle]
GO
--EXEC Proc_RptStockandSalesVolumeParle 236,2,0,'CKProduct',0,0,1  
CREATE PROCEDURE [dbo].[Proc_RptStockandSalesVolumeParle]  
(    
  @Pi_RptId  INT,    
  @Pi_UsrId  INT,    
  @Pi_SnapId  INT,    
  @Pi_DbName  nvarchar(50),    
  @Pi_SnapRequired INT,    
  @Pi_GetFromSnap  INT,    
  @Pi_CurrencyId  INT    
)    
AS  
/**************************************************************************  
* PROCEDURE : Proc_RptStockandSalesVolume_Parle  
* PURPOSE : To get the Stock and Sales Volume details Uom Wise for Report  
* CREATED : Praveen Raj B  
* CREATED DATE : 24/01/2012  
* MODIFIED  
***************************************************************************/  
BEGIN    
SET NOCOUNT ON    
 DECLARE @NewSnapId  AS INT    
 DECLARE @DBNAME  AS  nvarchar(50)    
 DECLARE @TblName  AS nvarchar(500)    
 DECLARE @TblStruct  AS nVarchar(4000)    
 DECLARE @TblFields  AS nVarchar(4000)    
 DECLARE @sSql  AS  nVarChar(4000)    
 DECLARE @ErrNo   AS INT    
 DECLARE @PurDBName AS nVarChar(50)    
 DECLARE @FromDate AS DATETIME    
 DECLARE @ToDate  AS DATETIME    
 DECLARE @LcnId   AS INT    
 DECLARE @PrdCatValId AS INT    
 DECLARE @PrdId  AS INT    
 DECLARE @CmpId   AS INT    
 DECLARE @PrdStatus  AS INT    
 DECLARE @PrdBatId AS INT    
 DECLARE @StockValue  AS INT  
 DECLARE @RptDispType AS INT  
 --select *  from TempRptStockNSales    
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)    
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)    
 SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))    
 SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))    
 EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId    
 SET @PrdCatValId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))    
 SET @PrdId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))    
 SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))    
 SET @PrdStatus =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId))    
 SET @PrdBatId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,7,@Pi_UsrId))    
 SET @StockValue =(SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,23,@Pi_UsrId))    
 SET @RptDispType = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,221,@Pi_UsrId))  
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)   
 	--Till Here
	--Modified by Lakshman M on 03/05/2017 ----- 	
	DECLARE @ProdStatus TABLE
	(
		PrdStatus INT
	)	
	
	IF(ISNULL(@PrdStatus,0)=0)
	BEGIN
		INSERT INTO @ProdStatus (PrdStatus)
		SELECT 0 UNION
		SELECT 1 UNION
		SELECT 2
	END
	ELSE IF(@PrdStatus = 1)
	BEGIN
		INSERT INTO @ProdStatus (PrdStatus)
		SELECT 1 
	END
	ELSE IF(@PrdStatus = 2)
	BEGIN
	INSERT INTO @ProdStatus (PrdStatus)
		SELECT 0 UNION
		SELECT 2
	END
	---- till here End ----- 
 --IF @IncOffStk=1      
 --BEGIN      
  Exec Proc_GetStockNSalesDetailsWithOffer @FromDate,@ToDate,@Pi_UsrId      
 --END      
 --ELSE      
 --BEGIN      
 -- Exec Proc_GetStockNSalesDetails @FromDate,@ToDate,@Pi_UsrId      
 --END    
 CREATE TABLE #RptStockandSalesVolume_Parle    
 (    
  PrdId   INT,    
  PrdDCode   NVARCHAR(50),    
  PrdName   NVARCHAR(100),    
  PrdBatId   INT,    
  PrdBatCode  NVARCHAR(50),    
  CmpId   INT,    
  CmpName   NVARCHAR(50),    
  LcnId   INT,    
  LcnName   NVARCHAR(50),     
  OpeningStock  Int,      
  Purchase   Int,    
  Sales   INT,    
  Adjustment      Int,  
  PurchaseReturn   INT,    
  SalesReturn  INT,      
  ClosingStock  INT,    
  ClosingStkValue NUMERIC (38,6),  
  OpenWeight NUMERIC (38,6),  
  PurchaseWeight NUMERIC (38,6),  
  SalesWeight NUMERIC (38,6),  
  AdjustmentWeight NUMERIC (38,6),  
  PurchaseReturnWeight NUMERIC (38,6),  
  SalesReturnWeight NUMERIC (38,6),  
  ClosingStockWeight NUMERIC (38,6),  
  OpeningStkValue NUMERIC (38,6),  
  PurchaseStkValue NUMERIC (38,6),  
  SalesStkValue NUMERIC (38,6),  
  AdjustmentStkValue NUMERIC (38,6),  
  ClosingStockkValue NUMERIC (38,6)  
 )    
 SELECT DISTINCT Prdid,U.ConversionFactor   
 Into #PrdUomBox  
 FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid  
 Inner Join UomMaster UM On U.UomId=Um.UomId  
 --Where Um.UomCode='BX'--Commented and added by Rajesh ICRSTPAR3196  
 Where Um.UomCode IN('BX','BOX')  
    
 SELECT DISTINCT Prdid,U.ConversionFactor  
 Into #PrdUomPack  
 FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid  
 Inner Join UomMaster UM On U.UomId=Um.UomId  
 Where  P.PrdId Not In (Select PrdId From #PrdUomBox) And U.BaseUom='Y'  
   
 Create Table #PrdUomAll  
 (  
  PrdId Int,  
  ConversionFactor Int  
 )  
 Insert Into #PrdUomAll  
 Select Distinct PrdId,ConversionFactor From #PrdUomBox  
 Union All  
 Select Distinct PrdId,ConversionFactor From #PrdUomPack  
   
 SELECT Prdid,  
   Case PrdUnitId   
   When 2 Then (PrdWgt/1000)/1000  
   When 3 Then PrdWgt/1000 END AS PrdWgt  
   Into #PrdWeight  From Product  
   
 SELECT * INTO #RptStockandSalesVolume_Parle1 FROM #RptStockandSalesVolume_Parle    
 SET @TblName = 'RptStockandSalesVolume'    
 SET @TblStruct = 'PrdId    INT,    
       PrdDCode   NVARCHAR(40),    
       PrdName   NVARCHAR(100),    
       PrdBatId   INT,    
       PrdBatCode  NVARCHAR(50),    
       CmpId    INT,    
       CmpName   NVARCHAR(50),    
       LcnId    INT,    
       LcnName   NVARCHAR(50),     
       OpeningStock  Int,    
       Purchase   Int,    
       Sales    INT,       
       Adjustment  Int,  
       PurchaseReturn INT,    
       SalesReturn  INT,       
       ClosingStock  INT,    
       ClosingStkValue NUMERIC (38,6),  
       OpenWeight  NUMERIC (38,6),  
       PurchaseWeight NUMERIC (38,6),  
       SalesWeight  NUMERIC (38,6),  
       AdjustmentWeight NUMERIC (38,6),  
       PurchaseReturnWeight NUMERIC (38,6),  
       SalesReturnWeight  NUMERIC (38,6),  
       ClosingStockWeight NUMERIC (38,6)    
       OpeningStkValue  NUMERIC (38,6),  
       PurchaseStkValue  NUMERIC (38,6),  
       SalesStkValue   NUMERIC (38,6),  
       AdjustmentStkValue NUMERIC (38,6),  
       ClosingStockkValue  NUMERIC (38,6)'  
 SET @TblFields = 'PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,    
          LcnName,OpeningStock,Purchase,Sales,Adjustment,    
       PurchaseReturn,SalesReturn,ClosingStock,DispBatch,ClosingStkValue,OpenWeight,PurchaseWeight  
       SalesWeight,AdjustmentWeight,PurchaseReturnWeight,SalesReturnWeight,ClosingStockWeight,  
       OpeningStkValue,PurchaseStkValue,SalesStkValue,AdjustmentStkValue,ClosingStockkValue'    
 IF @Pi_GetFromSnap = 1    
 BEGIN    
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId    
  SET @DBNAME =  @DBNAME    
 END    
 ELSE    
 BEGIN    
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3    
  SET @DBNAME = @PI_DBNAME + @DBNAME    
 END    
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data    
 BEGIN    
   INSERT INTO #RptStockandSalesVolume_Parle (PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,    
             LcnName,OpeningStock,Purchase,Sales,Adjustment,PurchaseReturn,SalesReturn,  
             ClosingStock,ClosingStkValue,OpenWeight,PurchaseWeight,  
             SalesWeight,AdjustmentWeight,PurchaseReturnWeight,SalesReturnWeight,ClosingStockWeight  
             ,OpeningStkValue,PurchaseStkValue,SalesStkValue,AdjustmentStkValue,ClosingStockkValue)    
   SELECT PrdId,PrdDcode,PrdName,0,0,TempRptStockNSales.CmpId,CmpName,LcnId,LcnName,    
   Opening,(Purchase-PurchaseReturn),(Sales-SalesReturn),(AdjustmentIn-AdjustmentOut),PurchaseReturn,SalesReturn,Closing,  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN CloSelRte WHEN 2 THEN CloPurRte WHEN 3 THEN CloMRPRte END,@Pi_CurrencyId),0,0,0,0,0,0,0,  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN OpnSelRte WHEN 2 THEN OpnPurRte WHEN 3 THEN OpnMRPRte END,@Pi_CurrencyId),  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN PurSelRte WHEN 2 THEN PurPurRte WHEN 3 THEN PurMRPRte END,@Pi_CurrencyId),  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN SalSelRte WHEN 2 THEN SalPurRte WHEN 3 THEN SalMRPRte END,@Pi_CurrencyId),  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN (AdjInSelRte-AdjOutSelRte) WHEN 2 THEN (AdjInPurRte+AdjOutPurRte) WHEN 3 THEN   
   (AdjInMRPRte+AdjOutMRPRte) END,@Pi_CurrencyId),  
   dbo.Fn_ConvertCurrency(CASE @StockValue WHEN 1 THEN CloSelRte WHEN 2 THEN CloPurRte WHEN 3 THEN CloMRPRte END,@Pi_CurrencyId)  
   FROM TempRptStockNSales   
   INNER JOIN  Company  C ON C.CmpId = TempRptStockNSales.CmpId   
   WHERE   
   ( TempRptStockNSales.CmpId = (CASE @CmpId WHEN 0 THEN TempRptStockNSales.CmpId ELSE 0 END) OR    
   TempRptStockNSales.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)) )    
   AND (LcnId = (CASE @LcnId WHEN 0 THEN LcnId ELSE 0 END) OR    
   LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))    
   AND (PrdStatus = (CASE @PrdStatus WHEN 0 THEN PrdStatus ELSE 0 END) OR    
   PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId)))    
   --AND (BatStatus = (CASE @BatStatus WHEN 0 THEN BatStatus ELSE 2 END) OR    
   --BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,25,@Pi_UsrId)))    
   AND (PrdId = (CASE @PrdCatValId WHEN 0 THEN PrdId Else 0 END) OR    
   PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))    
   AND (PrdId = (CASE @PrdId WHEN 0 THEN PrdId Else 0 END) OR    
   PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))    
   AND UserId=@Pi_UsrId AND PrdStatus IN (SELECT Prdstatus from @ProdStatus)  ---- Added by lakshman M on 03/05/2017 
   And Opening+Purchase+Sales+AdjustmentIn+AdjustmentOut+PurchaseReturn+SalesReturn+Closing <>0 Order By PrdDcode  
   
   Update R Set OpenWeight=(OpeningStock*PrdWgt),  
   PurchaseWeight=(Purchase*PrdWgt),  
   SalesWeight=(Sales*PrdWgt),  
   AdjustmentWeight=(Adjustment*PrdWgt),  
   PurchaseReturnWeight=(PurchaseReturn*PrdWgt),  
   SalesReturnWeight=(SalesReturn*PrdWgt),  
   ClosingStockWeight=(ClosingStock*PrdWgt)  
   From #PrdWeight PW   
   Inner Join #RptStockandSalesVolume_Parle R On R.PrdId=PW.PrdId  
    
  IF LEN(@PurDBName) > 0    
  BEGIN    
   SET @SSQL = 'INSERT INTO #RptStockandSalesVolume_Parle ' +    
   '(' + @TblFields + ')' +    
   ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName    
   + ' WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR ' +    
   ' CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '    
   + '( LcnId = (CASE ' + CAST(@LcnId AS nVarChar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR ' +    
   ' LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',22,' + CAST(@Pi_UsrId AS nVarChar(10)) + '))) AND '    
   + '( PrdStatus = (CASE ' + CAST(@PrdStatus AS nVarchar(10)) + ' WHEN 0 THEN PrdStatus ELSE 0 END) OR ' +    
   ' PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',24,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) AND '    
   --+ '( BatStatus = (CASE ' + CAST(@BatStatus AS nVarchar(10)) + ' WHEN 0 THEN BatStatus ELSE 0 END) OR ' +    
   --' BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',25,' + CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND '    
   + '( PrdId = (CASE ' + CAST(@PrdCatValId AS nVarchar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +    
   ' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + ' ))) AND '    
   + ' (R.PrdId = (CASE ' + CAST(@PrdId AS nVarChar(10)) + ' WHEN 0 THEN PrdId Else 0 END) OR ' +    
   ' PrdId in (SELECT iCountid from Fn_ReturnRptFilters(' + CAST(@Pi_RptId AS  nVarchar(10)) + ',5,' +  CAST(@Pi_UsrId AS nVarchar(10)) + ' )))'    
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Purged Table'    
  END    
  IF @Pi_SnapRequired = 1    
  BEGIN    
   SELECT @NewSnapId = @Pi_SnapId    
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
   SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +    
   '(SnapId,UserId,RptId,' + @TblFields + ')' +    
   ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +    
   ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
   ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptStockandSalesVolume_Parle'    
   EXEC (@SSQL)    
   PRINT 'Saved Data Into SnapShot Table'    
  END    
 END   
 ELSE    --To Retrieve Data From Snap Data    
 BEGIN    
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,    
  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT    
  IF @ErrNo = 0    
  BEGIN    
   SET @SSQL = 'INSERT INTO #RptStockandSalesVolume_Parle ' +    
   '(' + @TblFields + ')' +    
   ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +    
   ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +    
   ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +    
   ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))    
   EXEC (@SSQL)    
   PRINT 'Retrived Data From Snap Shot Table'    
  END    
  ELSE    
  BEGIN    
   PRINT 'DataBase or Table not Found'    
   RETURN    
  END    
 END    
   
   SELECT RV.PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,LcnName,   
     Cast(Case When SUM(OpeningStock)<MAX(ConversionFactor) Then 0 Else SUM(OpeningStock)/MAX(ConversionFactor) End As VarChar(25)) As OpeneningBox,  
     Cast(Case When SUM(OpeningStock)<MAX(ConversionFactor) Then SUM(OpeningStock) Else SUM(OpeningStock)%MAX(ConversionFactor) End As VarChar(25)) As OpeneningPack,  
     Cast(Case When SUM(Purchase)<MAX(ConversionFactor) Then 0 Else SUM(Purchase)/MAX(ConversionFactor) End As VarChar(25)) As PurchaseBox,  
     Cast(Case When SUM(Purchase)<MAX(ConversionFactor) Then SUM(Purchase) Else SUM(Purchase)%MAX(ConversionFactor) End As VarChar(25)) As PurchasePack,  
     Cast(Case When SUM(Sales)<MAX(ConversionFactor) Then 0 Else SUM(Sales)/MAX(ConversionFactor) End As VarChar(25)) As SalesBox,  
     Cast(Case When SUM(Sales)<MAX(ConversionFactor) Then SUM(Sales) Else SUM(Sales)%MAX(ConversionFactor) End As VarChar(25)) As SalesPack,  
     Cast(Case When SUM(Adjustment)<MAX(ConversionFactor) Then 0 Else SUM(Adjustment)/MAX(ConversionFactor) End As VarChar(25)) As AdjustmentBox,  
     Cast(Case When SUM(Adjustment)<MAX(ConversionFactor) Then SUM(Adjustment) Else SUM(Adjustment)%MAX(ConversionFactor) End As VarChar(25)) As AdjustmentPack,  
     --Cast(Case When AdjustmentIn<MAX(ConversionFactor) Then 0 Else AdjustmentIn/MAX(ConversionFactor) End As Int) -  
     --Cast(Case When AdjustmentOut<MAX(ConversionFactor) Then 0 Else AdjustmentOut/MAX(ConversionFactor) End As Int)AdjustmentBox,  
     --Cast(Case When AdjustmentIn<MAX(ConversionFactor) Then AdjustmentIn Else AdjustmentIn%MAX(ConversionFactor) End As Int)-  
     --Cast(Case When AdjustmentOut<MAX(ConversionFactor) Then AdjustmentOut Else AdjustmentOut%MAX(ConversionFactor) End As Int) As AdjustmentPack,  
     --Cast(Case When PurchaseReturn<MAX(ConversionFactor) Then 0 Else PurchaseReturn/MAX(ConversionFactor) End As VarChar(25)) As PurchaseReturnBox,  
     --Cast(Case When PurchaseReturn<MAX(ConversionFactor) Then PurchaseReturn Else PurchaseReturn%MAX(ConversionFactor) End As VarChar(25)) As PurchaseReturnPack,  
     --Cast(Case When SalesReturn<MAX(ConversionFactor) Then 0 Else SalesReturn/MAX(ConversionFactor) End As VarChar(25)) As SalesReturnBox,  
     --Cast(Case When SalesReturn<MAX(ConversionFactor) Then SalesReturn Else SalesReturn%MAX(ConversionFactor) End As VarChar(25)) As SalesReturnPack,  
     Cast(Case When SUM(ClosingStock)<MAX(ConversionFactor) Then 0 Else SUM(ClosingStock)/MAX(ConversionFactor) End As VarChar(25)) As ClosingStockBox,  
     Cast(Case When SUM(ClosingStock)<MAX(ConversionFactor) Then SUM(ClosingStock) Else SUM(ClosingStock)%MAX(ConversionFactor) End As VarChar(25)) As ClosingStockPack,  
     SUM(ClosingStkValue) AS ClosingStkValue,SUM(OpenWeight) AS OpenWeight,SUM(PurchaseWeight) AS PurchaseWeight,SUM(SalesWeight) AS SalesWeight,  
     SUM(AdjustmentWeight) As AdjustmentWeight,  
     --PurchaseReturnWeight,SalesReturnWeight,  
     SUM(ClosingStockWeight) AS ClosingStockWeight,SUM(OpeningStkValue)AS OpeningStkValue,SUM(PurchaseStkValue) AS PurchaseStkValue,  
     SUM(SalesStkValue)AS SalesStkValue,SUM(AdjustmentStkValue) AS AdjustmentStkValue,SUM(ClosingStockkValue) As ClosingStockkValue  
     FROM #RptStockandSalesVolume_Parle RV   
     INNER JOIN #PrdUomAll P On RV.PrdId=P.PrdId  
     Group By RV.PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,    
        LcnName Order By PrdDcode  
       --PurchaseReturnWeight,SalesReturnWeight,  
           
     DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId    
     INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)    
     SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #RptStockandSalesVolume_Parle     
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)    
 BEGIN    
  If Exists (Select [Name] From SysObjects Where [Name]='RptStockandSalesVolumeParle_Excel' And XTYPE='U')  
  Drop Table RptStockandSalesVolumeParle_Excel  
           SELECT RV.PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,LcnName,   
     Cast(Case When SUM(OpeningStock)<MAX(ConversionFactor) Then 0 Else SUM(OpeningStock)/MAX(ConversionFactor) End As VarChar(25)) As OpeneningBox,  
     Cast(Case When SUM(OpeningStock)<MAX(ConversionFactor) Then SUM(OpeningStock) Else SUM(OpeningStock)%MAX(ConversionFactor) End As VarChar(25)) As OpeneningPack,  
     Cast(Case When SUM(Purchase)<MAX(ConversionFactor) Then 0 Else SUM(Purchase)/MAX(ConversionFactor) End As VarChar(25)) As PurchaseBox,  
     Cast(Case When SUM(Purchase)<MAX(ConversionFactor) Then SUM(Purchase) Else SUM(Purchase)%MAX(ConversionFactor) End As VarChar(25)) As PurchasePack,  
     Cast(Case When SUM(Sales)<MAX(ConversionFactor) Then 0 Else SUM(Sales)/MAX(ConversionFactor) End As VarChar(25)) As SalesBox,  
     Cast(Case When SUM(Sales)<MAX(ConversionFactor) Then SUM(Sales) Else SUM(Sales)%MAX(ConversionFactor) End As VarChar(25)) As SalesPack,  
     Cast(Case When SUM(Adjustment)<MAX(ConversionFactor) Then 0 Else SUM(Adjustment)/MAX(ConversionFactor) End As VarChar(25)) As AdjustmentBox,  
     Cast(Case When SUM(Adjustment)<MAX(ConversionFactor) Then SUM(Adjustment) Else SUM(Adjustment)%MAX(ConversionFactor) End As VarChar(25)) As AdjustmentPack,  
     --Cast(Case When AdjustmentIn<MAX(ConversionFactor) Then 0 Else AdjustmentIn/MAX(ConversionFactor) End As Int) -  
     --Cast(Case When AdjustmentOut<MAX(ConversionFactor) Then 0 Else AdjustmentOut/MAX(ConversionFactor) End As Int)AdjustmentBox,  
     --Cast(Case When AdjustmentIn<MAX(ConversionFactor) Then AdjustmentIn Else AdjustmentIn%MAX(ConversionFactor) End As Int)-  
     --Cast(Case When AdjustmentOut<MAX(ConversionFactor) Then AdjustmentOut Else AdjustmentOut%MAX(ConversionFactor) End As Int) As AdjustmentPack,  
     --Cast(Case When PurchaseReturn<MAX(ConversionFactor) Then 0 Else PurchaseReturn/MAX(ConversionFactor) End As VarChar(25)) As PurchaseReturnBox,  
     --Cast(Case When PurchaseReturn<MAX(ConversionFactor) Then PurchaseReturn Else PurchaseReturn%MAX(ConversionFactor) End As VarChar(25)) As PurchaseReturnPack,  
     --Cast(Case When SalesReturn<MAX(ConversionFactor) Then 0 Else SalesReturn/MAX(ConversionFactor) End As VarChar(25)) As SalesReturnBox,  
     --Cast(Case When SalesReturn<MAX(ConversionFactor) Then SalesReturn Else SalesReturn%MAX(ConversionFactor) End As VarChar(25)) As SalesReturnPack,  
     Cast(Case When SUM(ClosingStock)<MAX(ConversionFactor) Then 0 Else SUM(ClosingStock)/MAX(ConversionFactor) End As VarChar(25)) As ClosingStockBox,  
     Cast(Case When SUM(ClosingStock)<MAX(ConversionFactor) Then SUM(ClosingStock) Else SUM(ClosingStock)%MAX(ConversionFactor) End As VarChar(25)) As ClosingStockPack,  
     SUM(ClosingStkValue) AS ClosingStkValue,SUM(OpenWeight) AS OpenWeight,SUM(PurchaseWeight) AS PurchaseWeight,SUM(SalesWeight) AS SalesWeight,  
     SUM(AdjustmentWeight) As AdjustmentWeight,  
     --PurchaseReturnWeight,SalesReturnWeight,  
     SUM(ClosingStockWeight) AS ClosingStockWeight,SUM(OpeningStkValue)AS OpeningStkValue,SUM(PurchaseStkValue) AS PurchaseStkValue,  
     SUM(SalesStkValue)AS SalesStkValue,SUM(AdjustmentStkValue) AS AdjustmentStkValue,SUM(ClosingStockkValue) As ClosingStockkValue  
     INTO RptStockandSalesVolumeParle_Excel FROM #RptStockandSalesVolume_Parle RV   
     INNER JOIN #PrdUomAll P On RV.PrdId=P.PrdId  
     Group By RV.PrdId,PrdDCode,PrdName,PrdBatId,PrdBatCode,CmpId,CmpName,LcnId,    
        LcnName Order By PrdDcode  
 END
 RETURN    
END  
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_ClosingStockTaxCalCulation]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_ClosingStockTaxCalCulation]
GO
/*  
  BEGIN TRANSACTION  
  EXEC Proc_ClosingStockTaxCalCulation  
  SELECT * FROM ClosingStockProductTaxPercent (NOLOCK)  
  ROLLBACK TRANSACTION  
*/  
CREATE PROCEDURE [dbo].[Proc_ClosingStockTaxCalCulation]  
AS  
BEGIN  
  --DECLARE @TaxSettingDet TABLE         
  CREATE TABLE #TaxSettingDet
  (        
   TaxSlab    INT,        
   ColNo      INT,        
   SlNo       INT,        
   BillSeqId  INT,        
   TaxSeqId   INT,        
   ColType    INT,         
   ColId      INT,        
   ColVal     NUMERIC(38,2),  
   PrdId      NUMERIC(18,0)        
  )   
    
  DECLARE @PurSeqId AS INT  
  DECLARE @BillSeqId AS INT  
  DECLARE @RtrTaxGrp AS INT     
  DECLARE @TaxSlab  INT    
  DECLARE @MRP INT      
  DECLARE @TaxableAmount  NUMERIC(28,10)        
  DECLARE @ParTaxableAmount NUMERIC(28,10)        
  DECLARE @TaxPer   NUMERIC(38,2)       
  DECLARE @TaxPercentage   NUMERIC(38,5)     
  DECLARE @TaxId   INT  
    
  --To Take the Batch TaxGroup Id        
  --SELECT @PrdBatTaxGrp = TaxGroupId FROM Product A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId  
  SELECT @BillSeqId = MAX(BillSeqId)  FROM BillSequenceMaster (NOLOCK)  
  SELECT @RtrTaxGrp = MAX(DISTINCT RtrId) FROM TaxSettingMaster A (NOLOCK)   
  INNER JOIN TaxGroupSetting B (NOLOCK) ON A.RtrId = B.TaxGroupId WHERE B.TaxGroup = 1  
    
  --INSERT INTO @TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,PrdId)        
  --SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal,C.PrdId        
  --FROM TaxSettingMaster A (NOLOCK) INNER JOIN TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId        
  --AND B.BillSeqId=@BillSeqId AND Coltype IN(1,3)   
  --INNER JOIN   
  --(SELECT DISTINCT A.PrdId,TaxGroupId FROM Product A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId) C   
  --ON A.PrdId = C.TaxGroupId  WHERE A.RtrId = @RtrTaxGrp       
  --AND A.TaxSeqId IN (SELECT ISNULL(MAX(TaxSeqId),0) FROM TaxSettingMaster   
  --WHERE RtrId = @RtrTaxGrp AND PrdId = C.TaxGroupId) 
--------------> Added by Lakshman M on 14/07/2017  <--------------------
  SELECT PrdId,ISNULL(MAX(TaxSeqId),0) as TaxSeqId INTO #tempTax1 fROM TaxSettingMaster where rtrid=@RtrTaxGrp
  GROUP BY PrdId
  
  SELECT DISTINCT A.PrdId,TaxGroupId INTo #TempClosing FROM Product A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId
      
  INSERT INTO #TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,PrdId)        
  SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal,C.PrdId        
  FROM TaxSettingMaster A (NOLOCK) INNER JOIN TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId        
  AND B.BillSeqId=@BillSeqId AND Coltype IN(1,3)   
  INNER JOIN #TempClosing C   ON A.PrdId = C.TaxGroupId  
  INNER JOIN #tempTax1 D ON D.PrdID=C.TaxGroupId and A.TaxseqId=D.TaxSeqId
  WHERE A.RtrId = @RtrTaxGrp    
  ----------------->Till here <-----------------
      
  TRUNCATE TABLE ClosingStockProductTaxPercent     
          
  --To Get the Tax Percentage for the selected slab        
  SELECT PrdId,ColVal AS TaxPerc,TaxSlab INTO #TaxPercentage FROM #TaxSettingDet   
  WHERE ColType = 1 AND ColId = 0 AND ColVal > 0  
    
  --Addtional Tax  
  SELECT DISTINCT A.PrdId,A.TaxSlab,B.TaxPerc,CAST(1*(B.TaxPerc/100) AS NUMERIC(28,10)) AS TaxAmount  
  INTO #ClosingStockAddTax FROM #TaxSettingDet A INNER JOIN #TaxPercentage B ON A.TaxSlab = B.TaxSlab   
  AND A.PrdId = B.PrdId WHERE ColType = 3 AND ColVal > 0    
    
  SELECT DISTINCT A.PrdId,A.TaxSlab,B.TaxPerc,CAST(1*(B.TaxPerc/100) AS NUMERIC(28,10)) AS TaxAmount  
  INTO #ClosingStockTax FROM #TaxSettingDet A INNER JOIN #TaxPercentage B ON A.TaxSlab = B.TaxSlab AND A.PrdId = B.PrdId  
  WHERE ColVal > 0 AND NOT EXISTS (SELECT PrdId FROM #ClosingStockAddTax C WHERE A.PrdId = C.PrdId   
  AND A.TaxSlab = C.TaxSlab)  
    
  INSERT INTO #ClosingStockTax (PrdId,TaxSlab,TaxPerc,TaxAmount)  
  SELECT DISTINCT A.PrdId,A.TaxSlab,A.TaxPerc,CAST((B.TaxAmount * A.TaxAmount) AS NUMERIC(28,10)) AS TaxAmount  
  FROM #ClosingStockAddTax A INNER JOIN #ClosingStockTax B ON A.PrdId = B.PrdId  
    
  INSERT INTO ClosingStockProductTaxPercent(PrdId,TaxPercentage)  
  SELECT DISTINCT PrdId,ISNULL(SUM(TaxAmount)*100,0) FROM #ClosingStockTax (NOLOCK) GROUP BY PrdId    
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='ParlUpaterLog' and Xtype='U')
DROP TABLE ParlUpaterLog
GO
CREATE TABLE ParlUpaterLog
(
[FixId] [int] NULL,
[ReleaseOn] [datetime] NULL,
[UpdateDate] [datetime]
)
GO
IF EXISTS (SELECT * FROM Sysobjects Where name='Fn_ReturnTaxError' and Xtype in ('TF','FN'))
DROP FUNCTION Fn_ReturnTaxError
GO
--Select * from Fn_ReturnTaxError(272,69,1007,0,0,0,1)
CREATE FUNCTION Fn_ReturnTaxError(@TransId AS INT,@MasterId as INT, @RtrId AS INT,@Prdid AS INT,
@PrdbatId AS INT,@SpmId as INT,@RtrShipId AS INT)
RETURNS @ReturnTaxError TABLE
(
	ErrorMessage  Varchar(500)
)
AS
BEGIN
		DECLARE @DistState AS Varchar(100)
		DECLARE @SupState AS Varchar(100)
		DECLARE @SupIntra AS Varchar(100)
		DECLARE @SupInter AS Varchar(100)
		DECLARE @RtrState AS Varchar(100)
		DECLARE @RtrIntra AS Varchar(100)
		DECLARE @RtrInter AS Varchar(100)
		DECLARE @Enabled AS TINYINT
		DECLARE @RtrType AS VARCHAR(50)
		SET @Enabled=0
		
		IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK)
		WHERE  ModuleId='GSTCONFIG' AND Description='GST Configuration' AND ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
		--AND CONVERT(DATETIME,CONVERT(VARCHAR(10),@Date,121),121)>=ActivationDate
		)
		BEGIN
			SET @Enabled=1
		END
		
		
		IF @MasterId=79 AND @TransId IN(2,25,3)--Retailer Master
		BEGIN
			---BOTH GST AND VAT TAX Validation
			IF EXISTS(Select 'X' FROM Retailer (NOLOCK) WHERE RtrId=@RtrId and TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Retailer tax group not attached for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
					RETURN
			END
			
			IF NOT EXISTS (Select 'X' FROM Retailer A (NOLOCK) INNER JOIN RetailerShipAdd B (Nolock) on A.RtrId=B.RtrId  WHERE A.RtrId=@RtrId)
			BEGIN
				INSERT INTO @ReturnTaxError(ErrorMessage)
				SELECT 'Retailer Shipping Address not available for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
				RETURN
			END 
			
			IF @Enabled=1---GST Tax Validation
			BEGIN
			
				IF EXISTS(Select 'X' FROM Retailer  A(NOLOCK) 
				INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId  
				WHERE A.RtrId=@RtrId AND B.RtrShipId=@RtrShipId and B.TaxgroupId=0)
				BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Retailer Shipping Address tax group not attached for the retailer '+ RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
						RETURN
				END
				
				IF EXISTS(Select 'X' FROM Retailer  A(NOLOCK) 
				INNER JOIN RetailerShipAdd B (NOLOCK) ON A.RtrId=B.RtrId  
				WHERE A.RtrId=@RtrId AND B.RtrShipId=@RtrShipId and B.RtrShipDefaultAdd=1 and A.TaxGroupId<>B.TaxGroupId)
				BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Retailer Tax Group shuold be same for Default Shipping Address Tax Group for the retailer '+ RtrCode FROM Retailer (NOLOCK) 
						WHERE RtrId=@RtrId 
						RETURN
				END
				
				
				SELECT @RtrType=ColumnValue FROM UdcMaster U (NOLOCK) 
				INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
				INNER JOIN Retailer D (NOLOCK) ON D.RtrId=UD.MasterRecordId
				WHERE U.MasterId=2 and ColumnName='Retailer Type'   and D.RtrId=@RtrId
				IF LEN(LTRIM(RTRIM(ISNULL(@RtrType,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the Retailer Type in Retailer Master on UDC tab for the retailer code '+
					RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
					
					RETURN
		        END
			
					SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
					INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
					INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
					INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
					WHERE U.MasterId=16 and ColumnName='State Name' 
					
					IF LEN(LTRIM(RTRIM(ISNULL(@DistState,''))))=0
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach the state in Distributor on UDC tab'
						RETURN
					END
					
					
					SELECT @RtrState=ColumnValue FROM UdcMaster U (NOLOCK) 
					INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
					INNER JOIN Retailer D (NOLOCK) ON D.RtrId=UD.MasterRecordId
					INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
					WHERE U.MasterId=2 and ColumnName='State Name'   and D.RtrId=@RtrId
					
					IF LEN(LTRIM(RTRIM(ISNULL(@RtrState,''))))=0
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach the state in Retailer Master on UDC tab for the retailer code '+
						RtrCode FROM Retailer (NOLOCK) WHERE RtrId=@RtrId 
						RETURN
					END
					
				IF @RtrShipId<>0
				BEGIN	
					----Added by Gopi at 10/07/2017
					SELECT @RtrState=StateName from StateMaster A INNER JOIN RetailerShipAdd B ON A.StateId=B.StateId
					AND B.RtrShipId=@RtrShipId and Rtrid=@Rtrid
					
					IF LEN(LTRIM(RTRIM(ISNULL(@RtrState,''))))=0
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach the state in Retailer Shpping address for the retailer address '+
						RtrShipadd1 FROM RetailerShipAdd (NOLOCK) WHERE RtrId=@RtrId and RtrShipId=@RtrShipId
						RETURN
					END
				END	
				----Till Here ----
			
			IF @RtrShipId=0
			BEGIN
					---Distributor and Retailer in Same State
					IF UPPER(@DistState)=UPPER(@RtrState)
					BEGIN
						SELECT @RtrIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
						INNER JOIN Retailer B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
						WHERE RtrId=@RtrId
						IF UPPER(@RtrIntra)<>'RTRINTRA'
						BEGIN
							INSERT INTO @ReturnTaxError(ErrorMessage)
							SELECT 'Please attach Retailer intra tax group (RTRINTRA) in Retailer Master on UDC tab'
							RETURN
						END
					END
					---Distributor and Retailer in different State
					IF UPPER(@DistState)<>UPPER(@RtrState)
					BEGIN
						SELECT @RtrInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
						INNER JOIN Retailer B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
						WHERE RtrId=@RtrId
						IF UPPER(@RtrInter)<>'RTRINTER'
						BEGIN
							INSERT INTO @ReturnTaxError(ErrorMessage)
							SELECT 'Please attach Retailer Inter tax group (RTRINTER) in Retailer Master on UDC Tab'
							RETURN
						END
					END	
				END
					
					---Distributor and Retailer in Same State
					IF UPPER(@DistState)=UPPER(@RtrState)
					BEGIN
						SELECT @RtrIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
						INNER JOIN RetailerShipAdd B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
						WHERE RtrId=@RtrId and B.RtrShipId=@RtrShipId
						IF UPPER(@RtrIntra)<>'RTRINTRA'
						BEGIN
							INSERT INTO @ReturnTaxError(ErrorMessage)
							SELECT 'Please attach Retailer intra tax group (RTRINTRA) in Retailer Shipping'
							RETURN
						END
					END
					---Distributor and Retailer in different State
					IF UPPER(@DistState)<>UPPER(@RtrState)
					BEGIN
						SELECT @RtrInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
						INNER JOIN RetailerShipAdd B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
						WHERE RtrId=@RtrId and B.RtrShipId=@RtrShipId
						IF UPPER(@RtrInter)<>'RTRINTER'
						BEGIN
							INSERT INTO @ReturnTaxError(ErrorMessage)
							SELECT 'Please attach Retailer intra tax group (RTRINTER) in Retailer Shipping'
							RETURN
						END
					END	
					
			END			
		END	
		--Billing,Salespanel,SalesReturn,Purchase,Purchase Return
		IF @TransId IN(2,25,3,5,7,272)--Product
		BEGIN
			IF EXISTS(Select 'X' FROM Product (NOLOCK) WHERE Prdid=@Prdid and TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Product tax group not attached for the product '+ PrdCCode FROM Product (NOLOCK) WHERE Prdid=@Prdid 
					RETURN
			END
		END	
		--Billing,Salespanel,SalesReturn,Purchase,Purchase Return
		IF @TransId IN(2,25,3,5,7,272)
		BEGIN
				
			IF EXISTS(Select 'X' FROM Productbatch (NOLOCK) WHERE PrdbatId=@PrdbatId and TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Product tax group not attached for the product batch '+ PrdBatCode +Space(2)+' for the product ' +  PrdCCode
					FROM Productbatch A (NOLOCK) INNER JOIN Product B (NOLOCK) ON A.PrdId=B.Prdid WHERE PrdbatId=@PrdbatId 
					RETURN
			END
			
			IF @TransId IN(2,25)
			BEGIN
				IF @Enabled=1
				BEGIN
					IF EXISTS(SELECT '*' FROM ProductBatch_Temp_GST(NOLOCK))
					BEGIN
						DECLARE @Count AS INT
						SET @Count=0
						
						SELECT @Count=Count(*) FROM ProductBatch_Temp_GST(NOLOCK)  WHERE DownLoadFlag='Y'
						
						IF ISNULL(@Count,0)=0
						BEGIN
							INSERT INTO @ReturnTaxError(ErrorMessage)
							SELECT 'GST Product batch downloaded pending for batch transfer,Please login and continue..'					
							RETURN
						END
					END
					ELSE
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'GST Product batch not downloaded can not continue..'					
						RETURN
					END	
				END
			END
			
		END	
		
		IF @MasterId=69 AND @TransId=272--Supplier	
		BEGIN
			IF EXISTS(Select 'X' FROM IDTMaster (NOLOCK) WHERE SpmId=@SpmId and TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'IDT Distributor tax group not attached for the Distributor Code '+SpmCode FROM IDTMaster (NOLOCK) WHERE SpmId=@SpmId
					RETURN
			END
		END
		
		IF @MasterId=69 AND @TransId IN(5,7)--Supplier		
		BEGIN
		
			IF EXISTS(Select 'X' FROM Supplier (NOLOCK) WHERE SpmId=@SpmId and TaxgroupId=0)
			BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Supplier tax group not attached for the Supplier Code '+SpmCode FROM Supplier (NOLOCK) WHERE SpmId=@SpmId
					RETURN
			END
			IF @Enabled=1---GST Tax Validation
			BEGIN
				SELECT @DistState=ColumnValue FROM UdcMaster U (NOLOCK) 
				INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
				INNER JOIN Distributor D (NOLOCK) ON D.DistributorId=UD.MasterRecordId
				INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
				WHERE U.MasterId=16 and ColumnName='State Name' 
				
				IF LEN(LTRIM(RTRIM(ISNULL(@DistState,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the state in Distributor on UDC tab'
					RETURN
				END

				SELECT @SupState=ColumnValue FROM UdcMaster U (NOLOCK) 
				INNER JOIN UdcDetails UD (NOLOCK) ON U.MasterId=UD.MasterId and U.UdcMasterId=UD.UdcMasterId
				INNER JOIN Supplier D (NOLOCK) ON D.SpmId=UD.MasterRecordId
				INNER JOIN StateMaster S (NOLOCK) ON S.StateName=UD.ColumnValue
				WHERE U.MasterId=8 and ColumnName='State Name' and SpmId=@SpmId
				
				IF LEN(LTRIM(RTRIM(ISNULL(@SupState,''))))=0
				BEGIN
					INSERT INTO @ReturnTaxError(ErrorMessage)
					SELECT 'Please attach the state in Supplier Master on UDC tab'
					RETURN
				END
				---Distributor and supplier in Same State
				IF UPPER(@DistState)=UPPER(@SupState)
				BEGIN
					SELECT @SupIntra=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN Supplier B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE SpmId=@SpmId
					IF UPPER(@SupIntra)<>'SUPINTRA'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach supplier intra tax group (SUPINTRA) in Supplier Master'
						RETURN
					END
				END
				---Distributor and supplier in different State
				IF UPPER(@DistState)<>UPPER(@SupState)
				BEGIN
					SELECT @SupInter=RtrGroup from TaxGroupSetting A (NOLOCK) 
					INNER JOIN Supplier B (NOLOCK) ON A.TaxGroupId=B.TaxGroupId
					WHERE SpmId=@SpmId
					IF UPPER(@SupInter)<>'SUPINTER'
					BEGIN
						INSERT INTO @ReturnTaxError(ErrorMessage)
						SELECT 'Please attach supplier Inter tax group (SUPINTER) in Supplier Master'
						RETURN
					END
				END
			END
		END	
		
RETURN
END
GO
IF NOT  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Console2CS_Consolidated_Trace]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[Console2CS_Consolidated_Trace](
	[SlNo] [numeric](38, 0) NOT NULL,
	[DistCode] [varchar](100) NULL,
	[SyncId] [numeric](38, 0) NULL,
	[ProcessName] [varchar](200) NULL,
	[ProcessDate] [datetime] NULL,
	[Column1] [varchar](200) NULL,
	[Column2] [varchar](200) NULL,
	[Column3] [varchar](200) NULL,
	[Column4] [varchar](200) NULL,
	[Column5] [varchar](200) NULL,
	[Column6] [varchar](200) NULL,
	[Column7] [varchar](200) NULL,
	[Column8] [varchar](200) NULL,
	[Column9] [varchar](200) NULL,
	[Column10] [varchar](200) NULL,
	[Column11] [varchar](200) NULL,
	[Column12] [varchar](200) NULL,
	[Column13] [varchar](200) NULL,
	[Column14] [varchar](200) NULL,
	[Column15] [varchar](200) NULL,
	[Column16] [varchar](200) NULL,
	[Column17] [varchar](200) NULL,
	[Column18] [varchar](200) NULL,
	[Column19] [varchar](200) NULL,
	[Column20] [varchar](200) NULL,
	[Column21] [varchar](200) NULL,
	[Column22] [varchar](200) NULL,
	[Column23] [varchar](200) NULL,
	[Column24] [varchar](200) NULL,
	[Column25] [varchar](200) NULL,
	[Column26] [varchar](200) NULL,
	[Column27] [varchar](200) NULL,
	[Column28] [varchar](200) NULL,
	[Column29] [varchar](200) NULL,
	[Column30] [varchar](200) NULL,
	[Column31] [varchar](200) NULL,
	[Column32] [varchar](200) NULL,
	[Column33] [varchar](200) NULL,
	[Column34] [varchar](200) NULL,
	[Column35] [varchar](200) NULL,
	[Column36] [varchar](200) NULL,
	[Column37] [varchar](200) NULL,
	[Column38] [varchar](200) NULL,
	[Column39] [varchar](200) NULL,
	[Column40] [varchar](200) NULL,
	[Column41] [varchar](200) NULL,
	[Column42] [varchar](200) NULL,
	[Column43] [varchar](200) NULL,
	[Column44] [varchar](200) NULL,
	[Column45] [varchar](200) NULL,
	[Column46] [varchar](200) NULL,
	[Column47] [varchar](200) NULL,
	[Column48] [varchar](200) NULL,
	[Column49] [varchar](200) NULL,
	[Column50] [varchar](200) NULL,
	[Column51] [varchar](200) NULL,
	[Column52] [varchar](200) NULL,
	[Column53] [varchar](200) NULL,
	[Column54] [varchar](200) NULL,
	[Column55] [varchar](200) NULL,
	[Column56] [varchar](200) NULL,
	[Column57] [varchar](200) NULL,
	[Column58] [varchar](200) NULL,
	[Column59] [varchar](200) NULL,
	[Column60] [varchar](200) NULL,
	[Column61] [varchar](200) NULL,
	[Column62] [varchar](200) NULL,
	[Column63] [varchar](200) NULL,
	[Column64] [varchar](200) NULL,
	[Column65] [varchar](200) NULL,
	[Column66] [varchar](200) NULL,
	[Column67] [varchar](200) NULL,
	[Column68] [varchar](200) NULL,
	[Column69] [varchar](200) NULL,
	[Column70] [varchar](200) NULL,
	[Column71] [varchar](200) NULL,
	[Column72] [varchar](200) NULL,
	[Column73] [varchar](200) NULL,
	[Column74] [varchar](200) NULL,
	[Column75] [varchar](200) NULL,
	[Column76] [varchar](200) NULL,
	[Column77] [varchar](200) NULL,
	[Column78] [varchar](200) NULL,
	[Column79] [varchar](200) NULL,
	[Column80] [varchar](200) NULL,
	[Column81] [varchar](200) NULL,
	[Column82] [varchar](200) NULL,
	[Column83] [varchar](200) NULL,
	[Column84] [varchar](200) NULL,
	[Column85] [varchar](200) NULL,
	[Column86] [varchar](200) NULL,
	[Column87] [varchar](200) NULL,
	[Column88] [varchar](200) NULL,
	[Column89] [varchar](200) NULL,
	[Column90] [varchar](200) NULL,
	[Column91] [varchar](200) NULL,
	[Column92] [varchar](200) NULL,
	[Column93] [varchar](200) NULL,
	[Column94] [varchar](200) NULL,
	[Column95] [varchar](200) NULL,
	[Column96] [varchar](200) NULL,
	[Column97] [varchar](200) NULL,
	[Column98] [varchar](200) NULL,
	[Column99] [varchar](200) NULL,
	[Column100] [varchar](200) NULL,
	[Remarks1] [varchar](500) NULL,
	[Remarks2] [varchar](500) NULL,
	[DownloadFlag] [varchar](1) NULL,
	[Downloaded Date] [datetime]
) ON [PRIMARY]
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_Console2CS_ConsolidatedDownload' AND TYPE='P')
DROP PROCEDURE Proc_Console2CS_ConsolidatedDownload
GO
CREATE PROCEDURE [dbo].[Proc_Console2CS_ConsolidatedDownload]
As  
Begin  
BEGIN TRY    
SET XACT_ABORT ON    
BEGIN TRANSACTION
Declare @Lvar Int  
Declare @MaxId Int  
Declare @SqlStr Varchar(8000)  
Declare @Process Varchar(100)  
Declare @colcount Int  
Declare @Col Varchar(5000)  
Declare @Tablename Varchar(100)  
Declare @Sequenceno Int  
 Create Table #Col (ColId int)  
 CREATE TABLE #Console2CS_Consolidated  
 (  
  [SlNo] [numeric](38, 0) NULL, [DistCode] [VARCHAR](200) COLLATE Database_Default NULL, [SyncId] [numeric](38, 0) NULL,  
  [ProcessName] [VARCHAR](200) COLLATE Database_Default NULL, [ProcessDate] [datetime] NULL, 
  [Column1] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column2] [VARCHAR](200) COLLATE Database_Default NULL, [Column3] [VARCHAR](200) COLLATE Database_Default NULL, [Column4] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column5] [VARCHAR](200) COLLATE Database_Default NULL, [Column6] [VARCHAR](200) COLLATE Database_Default NULL, [Column7] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column8] [VARCHAR](200) COLLATE Database_Default NULL, [Column9] [VARCHAR](200) COLLATE Database_Default NULL, [Column10] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column11] [VARCHAR](200) COLLATE Database_Default NULL, [Column12] [VARCHAR](200) COLLATE Database_Default NULL, [Column13] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column14] [VARCHAR](200) COLLATE Database_Default NULL, [Column15] [VARCHAR](200) COLLATE Database_Default NULL, [Column16] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column17] [VARCHAR](200) COLLATE Database_Default NULL, [Column18] [VARCHAR](200) COLLATE Database_Default NULL, [Column19] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column20] [VARCHAR](200) COLLATE Database_Default NULL, [Column21] [VARCHAR](200) COLLATE Database_Default NULL, [Column22] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column23] [VARCHAR](200) COLLATE Database_Default NULL, [Column24] [VARCHAR](200) COLLATE Database_Default NULL, [Column25] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column26] [VARCHAR](200) COLLATE Database_Default NULL, [Column27] [VARCHAR](200) COLLATE Database_Default NULL, [Column28] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column29] [VARCHAR](200) COLLATE Database_Default NULL, [Column30] [VARCHAR](200) COLLATE Database_Default NULL, [Column31] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column32] [VARCHAR](200) COLLATE Database_Default NULL, [Column33] [VARCHAR](200) COLLATE Database_Default NULL, [Column34] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column35] [VARCHAR](200) COLLATE Database_Default NULL, [Column36] [VARCHAR](200) COLLATE Database_Default NULL, [Column37] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column38] [VARCHAR](200) COLLATE Database_Default NULL, [Column39] [VARCHAR](200) COLLATE Database_Default NULL, [Column40] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column41] [VARCHAR](200) COLLATE Database_Default NULL, [Column42] [VARCHAR](200) COLLATE Database_Default NULL, [Column43] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column44] [VARCHAR](200) COLLATE Database_Default NULL, [Column45] [VARCHAR](200) COLLATE Database_Default NULL, [Column46] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column47] [VARCHAR](200) COLLATE Database_Default NULL, [Column48] [VARCHAR](200) COLLATE Database_Default NULL, [Column49] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column50] [VARCHAR](200) COLLATE Database_Default NULL, [Column51] [VARCHAR](200) COLLATE Database_Default NULL, [Column52] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column53] [VARCHAR](200) COLLATE Database_Default NULL, [Column54] [VARCHAR](200) COLLATE Database_Default NULL, [Column55] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column56] [VARCHAR](200) COLLATE Database_Default NULL, [Column57] [VARCHAR](200) COLLATE Database_Default NULL, [Column58] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column59] [VARCHAR](200) COLLATE Database_Default NULL, [Column60] [VARCHAR](200) COLLATE Database_Default NULL, [Column61] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column62] [VARCHAR](200) COLLATE Database_Default NULL, [Column63] [VARCHAR](200) COLLATE Database_Default NULL, [Column64] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column65] [VARCHAR](200) COLLATE Database_Default NULL, [Column66] [VARCHAR](200) COLLATE Database_Default NULL, [Column67] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column68] [VARCHAR](200) COLLATE Database_Default NULL, [Column69] [VARCHAR](200) COLLATE Database_Default NULL, [Column70] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column71] [VARCHAR](200) COLLATE Database_Default NULL, [Column72] [VARCHAR](200) COLLATE Database_Default NULL, [Column73] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column74] [VARCHAR](200) COLLATE Database_Default NULL, [Column75] [VARCHAR](200) COLLATE Database_Default NULL, [Column76] [VARCHAR](200) COLLATE Database_Default NULL,   
  [Column77] [VARCHAR](200) COLLATE Database_Default NULL, [Column78] [VARCHAR](200) COLLATE Database_Default NULL, [Column79] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column80] [VARCHAR](200) COLLATE Database_Default NULL, [Column81] [VARCHAR](200) COLLATE Database_Default NULL, [Column82] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column83] [VARCHAR](200) COLLATE Database_Default NULL, [Column84] [VARCHAR](200) COLLATE Database_Default NULL, [Column85] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column86] [VARCHAR](200) COLLATE Database_Default NULL, [Column87] [VARCHAR](200) COLLATE Database_Default NULL, [Column88] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column89] [VARCHAR](200) COLLATE Database_Default NULL, [Column90] [VARCHAR](200) COLLATE Database_Default NULL, [Column91] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column92] [VARCHAR](200) COLLATE Database_Default NULL, [Column93] [VARCHAR](200) COLLATE Database_Default NULL, [Column94] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column95] [VARCHAR](200) COLLATE Database_Default NULL, [Column96] [VARCHAR](200) COLLATE Database_Default NULL, [Column97] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Column98] [VARCHAR](200) COLLATE Database_Default NULL, [Column99] [VARCHAR](200) COLLATE Database_Default NULL, [Column100] [VARCHAR](200) COLLATE Database_Default NULL,  
  [Remarks1] [VARCHAR](200) COLLATE Database_Default NULL, [Remarks2] [VARCHAR](200) COLLATE Database_Default NULL, [DownloadFlag] [VARCHAR](1) COLLATE Database_Default NULL,  
  DWNStatus INT
 )   
 INSERT INTO Console2CS_Consolidated_Trace 
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y'
 DELETE FROM Console2CS_Consolidated_Trace where CONVERT (DATETIME,[Downloaded Date],121)<=Convert(DATETIME,GETDATE()-15,121)
 Delete A From Console2CS_Consolidated A (Nolock) Where DownloadFlag='Y' 
 ---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Console2CS_Consolidated'
	And A.system_type_id = C.system_type_id And C.name='varchar'
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Console2CS_Consolidated  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ----------------------------------
 Insert Into #Console2CS_Consolidated  
 Select *,0 as DWNStatus from Console2CS_Consolidated (Nolock) Where DownloadFlag In ('D','N')
   Update A Set A.DWNStatus = 1  
   From  
    #Console2CS_Consolidated A (NOLOCK),  
    (  
     SELECT   
     DistCode,SyncId   
     FROM   
     SyncStatus_Download (NOLOCK)  
     WHERE       
     SyncStatus = 1 AND SyncId > 0  
     UNION  
     SELECT   
     DistCode,SyncId  
     FROM   
     SyncStatus_Download_Archieve (NOLOCK)  
     WHERE  
     SyncStatus = 1 AND SyncId > 0  
    ) B  
   Where   
    A.DistCode = B.DistCode AND   
    A.SyncId = B.SyncId   
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
 -- Purchase Trace Ends here
 Delete A From #Console2CS_Consolidated A (Nolock) Where DWNStatus = 0 
 Create Table #Process(ProcessName Varchar(100),PrkTableName Varchar(100), id Int Identity(1,1) )  
 Insert Into #Process(ProcessName , PrkTableName)   
 Select Distinct A.ProcessName , A.PrkTableName From Tbl_DownloadIntegration A,#Console2CS_Consolidated B   
 Where A.ProcessName = B.ProcessName And A.SequenceNo not in(100000) --Order By Sequenceno  
  Set @Lvar = 1  
  Select @MaxId = Max(id) From #Process  
  While @Lvar <= @MaxId  
   Begin  
    Select @Tablename = PrkTableName , @Process = ProcessName From #Process Where id  = @Lvar  
    Select @colcount = Count(Column_ID) From sys.columns Where object_id = (select object_id From sys.objects Where name = @Tablename)  
    Set @SqlStr = ''  
    Set @SqlStr = @SqlStr + ' Insert Into ' + @Tablename + ' '  
    Set @Col = ''  
    select @Col = @Col + '[' +name + '],' From sys.columns   
    where object_id = ( select object_id From sys.objects Where name = @Tablename) Order by Column_Id  
    Truncate Table #Col      
    Insert Into #Col     
    Select  a.column_id + 5 As ColId  
    From sys.columns a,sys.types b where a.user_type_id = b.user_type_id  
    and a.object_id = ( Select object_id From sys.objects Where name = @Tablename)  
    and b.name = 'datetime' --and a.name <> 'CreatedDate'  
    Set @SqlStr = @SqlStr + '(' + left(@Col,len(@Col)-1)  + ') '  
    Set @Col = ''  
    Select @Col = @Col + (Case when column_id In (Select ColId From #Col) then 'Convert(Datetime,'+name + ',121)' else name end) + ','   
    From sys.columns Where object_id = ( Select object_id From sys.objects Where name = 'Console2CS_Consolidated ')  
    and column_id  between 6 and 5 + @colcount 
    Order by column_id
    Set @SqlStr = @SqlStr + ' Select '+ left(@Col,len(@Col)-1)  + ' From #Console2CS_Consolidated (nolock) '  
    Set @SqlStr = @SqlStr + ' Where ProcessName = '''+ @Process +''' And DWNStatus = 1 '      
--    Print (@SqlStr) 
    Exec (@SqlStr)  
    Set @Lvar = @Lvar + 1  
   End  
-- Purchase trace starts here   
 Insert into Tbl_SchedulerInvoiceparle
 SELECT  DISTINCT SyncId,column2,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Purchase' And DWNStatus = 1   Union	
 SELECT  DISTINCT SyncId,column2+'-'+Column3+'-'+Column7+'-'+Column8+'-'+Column9+'-'+Column10,DwnStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product Batch' And DWNStatus = 1 Union
 SELECT  DISTINCT SyncId,column26,DWNStatus,getdate() From #Console2CS_Consolidated (NOLOCK) Where Processname = 'Product' And DWNStatus = 1  
  -- Purchase Trace Ends here
  Update A Set A.DownloadFlag = 'Y'   
   From   
    Console2CS_Consolidated A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
   Update A Set A.SyncFlag = 1  
   From   
    Syncstatus_Download A (nolock),  
    #Console2CS_Consolidated B (nolock)  
   Where   
    A.DistCode= B.DistCode And   
    A.SyncId = B.SyncId And   
    B.DWNStatus = 1  
COMMIT TRANSACTION    
 END TRY    
 BEGIN CATCH    
  ROLLBACK TRANSACTION    
  INSERT INTO XML2CSPT_ErrorLog VALUES ('Proc_Console2CS_ConsolidatedDownload', ERROR_MESSAGE(), GETDATE())    
 END CATCH    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Console2CS_Consolidated]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Console2CS_Consolidated]
GO
CREATE  Procedure [dbo].[Proc_Console2CS_Consolidated]    
(    
 @Pi_Records TEXT    
)    
AS    
/*********************************    
* PROCEDURE : Proc_Console2CS_Consolidated    
* PURPOSE : To Insert records from xml file in the Table Console2CS_Consolidated    
* CREATED : Arul. V  
* CREATED DATE : 02/11/2012  
* MODIFIED    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
*********************************/    
SET NOCOUNT ON    
BEGIN    
 DECLARE @hDoc INTEGER   
 INSERT INTO Console2CS_Consolidated_Trace   
 SELECT *,GETDATE() CREATEDATE from Console2CS_Consolidated A (Nolock)
 DELETE FROM Console2CS_Consolidated_Trace where CONVERT (DATETIME,[Downloaded Date],121)<=Convert(DATETIME,GETDATE()-15,121)
 DELETE FROM Console2CS_Consolidated WHERE DownloadFlag='Y'    
 EXEC sp_xml_preparedocument @hDoc OUTPUT,@Pi_Records    
 INSERT INTO Console2CS_Consolidated  
 (  
 SlNo,DistCode,SyncId,ProcessName,ProcessDate,  
 Column1,Column2,Column3,Column4,Column5,Column6,Column7,Column8,Column9,Column10,  
 Column11,Column12,Column13,Column14,Column15,Column16,Column17,Column18,Column19,Column20,  
 Column21,Column22,Column23,Column24,Column25,Column26,Column27,Column28,Column29,Column30,  
 Column31,Column32,Column33,Column34,Column35,Column36,Column37,Column38,Column39,Column40,  
 Column41,Column42,Column43,Column44,Column45,Column46,Column47,Column48,Column49,Column50,  
 Column51,Column52,Column53,Column54,Column55,Column56,Column57,Column58,Column59,Column60,  
 Column61,Column62,Column63,Column64,Column65,Column66,Column67,Column68,Column69,Column70,  
 Column71,Column72,Column73,Column74,Column75,Column76,Column77,Column78,Column79,Column80,  
 Column81,Column82,Column83,Column84,Column85,Column86,Column87,Column88,Column89,Column90,  
 Column91,Column92,Column93,Column94,Column95,Column96,Column97,Column98,Column99,Column100,  
 Remarks1,Remarks2,DownloadFlag)  
 SELECT  SlNo,DistCode,SyncId,ProcessName,ProcessDate,  
 Column1,Column2,Column3,Column4,Column5,Column6,Column7,Column8,Column9,Column10,  
 Column11,Column12,Column13,Column14,Column15,Column16,Column17,Column18,Column19,Column20,  
 Column21,Column22,Column23,Column24,Column25,Column26,Column27,Column28,Column29,Column30,  
 Column31,Column32,Column33,Column34,Column35,Column36,Column37,Column38,Column39,Column40,  
 Column41,Column42,Column43,Column44,Column45,Column46,Column47,Column48,Column49,Column50,  
 Column51,Column52,Column53,Column54,Column55,Column56,Column57,Column58,Column59,Column60,  
 Column61,Column62,Column63,Column64,Column65,Column66,Column67,Column68,Column69,Column70,  
 Column71,Column72,Column73,Column74,Column75,Column76,Column77,Column78,Column79,Column80,  
 Column81,Column82,Column83,Column84,Column85,Column86,Column87,Column88,Column89,Column90,  
 Column91,Column92,Column93,Column94,Column95,Column96,Column97,Column98,Column99,Column100,  
 Remarks1,Remarks2,DownloadFlag  
 FROM OPENXML (@hdoc,'/Root/DD',1)    
 WITH (    
 [SlNo] [numeric](38, 0) , [DistCode] [varchar](100) , [SyncId] [numeric](38, 0) , [ProcessName] [varchar](100) , [ProcessDate] [datetime] ,  
 [Column1] [varchar](200) , [Column2] [varchar](200) , [Column3] [varchar](200) , [Column4] [varchar](200) , [Column5] [varchar](200) ,  
 [Column6] [varchar](200) , [Column7] [varchar](200) , [Column8] [varchar](200) , [Column9] [varchar](200) , [Column10] [varchar](200) ,  
 [Column11] [varchar](200) , [Column12] [varchar](200) , [Column13] [varchar](200) , [Column14] [varchar](200) , [Column15] [varchar](200) ,  
 [Column16] [varchar](200) , [Column17] [varchar](200) , [Column18] [varchar](200) , [Column19] [varchar](200) , [Column20] [varchar](200) ,  
 [Column21] [varchar](200) , [Column22] [varchar](200) , [Column23] [varchar](200) , [Column24] [varchar](200) , [Column25] [varchar](200) ,  
 [Column26] [varchar](200) , [Column27] [varchar](200) , [Column28] [varchar](200) , [Column29] [varchar](200) , [Column30] [varchar](200) ,  
 [Column31] [varchar](200) , [Column32] [varchar](200) , [Column33] [varchar](200) , [Column34] [varchar](200) , [Column35] [varchar](200) ,  
 [Column36] [varchar](200) , [Column37] [varchar](200) , [Column38] [varchar](200) , [Column39] [varchar](200) , [Column40] [varchar](200) ,  
 [Column41] [varchar](200) , [Column42] [varchar](200) , [Column43] [varchar](200) , [Column44] [varchar](200) , [Column45] [varchar](200) ,  
 [Column46] [varchar](200) , [Column47] [varchar](200) , [Column48] [varchar](200) , [Column49] [varchar](200) , [Column50] [varchar](200) ,  
 [Column51] [varchar](200) , [Column52] [varchar](200) , [Column53] [varchar](200) , [Column54] [varchar](200) , [Column55] [varchar](200) ,  
 [Column56] [varchar](200) , [Column57] [varchar](200) , [Column58] [varchar](200) , [Column59] [varchar](200) , [Column60] [varchar](200) ,  
 [Column61] [varchar](200) , [Column62] [varchar](200) , [Column63] [varchar](200) , [Column64] [varchar](200) , [Column65] [varchar](200) ,  
 [Column66] [varchar](200) , [Column67] [varchar](200) , [Column68] [varchar](200) , [Column69] [varchar](200) , [Column70] [varchar](200) ,  
 [Column71] [varchar](200) , [Column72] [varchar](200) , [Column73] [varchar](200) , [Column74] [varchar](200) , [Column75] [varchar](200) ,  
 [Column76] [varchar](200) , [Column77] [varchar](200) , [Column78] [varchar](200) , [Column79] [varchar](200) , [Column80] [varchar](200) ,  
 [Column81] [varchar](200) , [Column82] [varchar](200) , [Column83] [varchar](200) , [Column84] [varchar](200) , [Column85] [varchar](200) ,  
 [Column86] [varchar](200) , [Column87] [varchar](200) , [Column88] [varchar](200) , [Column89] [varchar](200) , [Column90] [varchar](200) ,  
 [Column91] [varchar](200) , [Column92] [varchar](200) , [Column93] [varchar](200) , [Column94] [varchar](200) , [Column95] [varchar](200) ,  
 [Column96] [varchar](200) , [Column97] [varchar](200) , [Column98] [varchar](200) , [Column99] [varchar](200) , [Column100] [varchar](200) ,  
 [Remarks1] [varchar](300) , [Remarks2] [varchar](300) , [DownloadFlag] [varchar](1)  
   )     
 EXEC sp_xml_removedocument @hDoc     
END
GO
IF EXISTS (SELECT * FROM Sysobjects Where Name='FN_CheckForGstEnabled' and XTYPE In ('TF','FN'))
DROP FUNCTION FN_CheckForGstEnabled
GO
CREATE FUNCTION FN_CheckForGstEnabled(@Date as DATETIME,@Type AS INT)
RETURNS INT
AS
/***********************************************
* FUNCTION: FN_CheckForGstEnabled
* PURPOSE: Return GstEnable Status
* NOTES:
* CREATED: Karthick 2017-04-24
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
*
************************************************/
BEGIN
DECLARE @Enabled AS INT
SET @Enabled=0
 IF @Type=1
 BEGIN
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK)
	WHERE  ModuleId='GSTCONFIG' AND Description='GST Configuration' AND ActivationStatus=1 AND ConsoleAckStatus=0
				AND AcknowledgeStatus=1)-- AND CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate)
		BEGIN
			 SET @Enabled=2
		END
  END
  IF @Type=2
 BEGIN
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK)
	WHERE  ModuleId='GSTCONFIG' AND Description='GST Configuration' AND ActivationStatus=1 
				AND AcknowledgeStatus=0)-- AND ConsoleAckStatus=0 AND CONVERT(DATETIME,CONVERT(VARCHAR(10),@Date,121),121)>=ActivationDate)
		BEGIN
			IF EXISTS(SELECT 'X' FROM GSSTMonthEndDetails(NOLOCK) WHERE GSTConFirmation=0)
			BEGIN	
				SET @Enabled=2
			END 
		END
  END 
 IF @Type=3
 BEGIN
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK)
	WHERE  ModuleId='GSTCONFIG' AND Description='GST Configuration' AND ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1) 
	--AND CONVERT(DATETIME,CONVERT(VARCHAR(10),@Date,121),121)>=ActivationDate)
	BEGIN
		SET @Enabled=1
	END
	
  END
  	
RETURN(@Enabled)	
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_ClosingStockTaxCalCulation_BeforeGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_ClosingStockTaxCalCulation_BeforeGST]
GO
/*  
  BEGIN TRANSACTION  
  EXEC Proc_ClosingStockTaxCalCulation_BeforeGST  
  SELECT * FROM ClosingStockProductTaxPercent (NOLOCK)  
  ROLLBACK TRANSACTION  
*/  
CREATE PROCEDURE [dbo].[Proc_ClosingStockTaxCalCulation_BeforeGST]  
AS  
BEGIN  
  --DECLARE @TaxSettingDet TABLE         
  CREATE TABLE #TaxSettingDet
  (        
   TaxSlab    INT,        
   ColNo      INT,        
   SlNo       INT,        
   BillSeqId  INT,        
   TaxSeqId   INT,        
   ColType    INT,         
   ColId      INT,        
   ColVal     NUMERIC(38,2),  
   PrdId      NUMERIC(18,0)        
  )   
  DECLARE @PurSeqId AS INT  
  DECLARE @BillSeqId AS INT  
  DECLARE @RtrTaxGrp AS INT     
  DECLARE @TaxSlab  INT    
  DECLARE @MRP INT      
  DECLARE @TaxableAmount  NUMERIC(28,10)        
  DECLARE @ParTaxableAmount NUMERIC(28,10)        
  DECLARE @TaxPer   NUMERIC(38,2)       
  DECLARE @TaxPercentage   NUMERIC(38,5)     
  DECLARE @TaxId   INT  
  --To Take the Batch TaxGroup Id        
  --SELECT @PrdBatTaxGrp = TaxGroupId FROM Product A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId  
  SELECT @BillSeqId = MAX(BillSeqId)  FROM BillSequenceMaster (NOLOCK)  
  SELECT @RtrTaxGrp = MAX(DISTINCT RtrId) FROM TaxSettingMaster A (NOLOCK)    
  INNER JOIN TaxGroupSetting B (NOLOCK) ON A.RtrId = B.TaxGroupId WHERE B.TaxGroup = 1   AND TAXTYPE='VAT'
  --INSERT INTO @TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,PrdId)        
  --SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal,C.PrdId        
  --FROM TaxSettingMaster A (NOLOCK) INNER JOIN TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId        
  --AND B.BillSeqId=@BillSeqId AND Coltype IN(1,3)   
  --INNER JOIN   
  --(SELECT DISTINCT A.PrdId,TaxGroupId FROM Product A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId) C   
  --ON A.PrdId = C.TaxGroupId  WHERE A.RtrId = @RtrTaxGrp       
  --AND A.TaxSeqId IN (SELECT ISNULL(MAX(TaxSeqId),0) FROM TaxSettingMaster   
  --WHERE RtrId = @RtrTaxGrp AND PrdId = C.TaxGroupId) 
--------------> Added by Lakshman M on 14/07/2017  <--------------------
  SELECT PrdId,ISNULL(MAX(TaxSeqId),0) as TaxSeqId INTO #tempTax1 fROM TaxSettingMaster where rtrid=@RtrTaxGrp
  GROUP BY PrdId
  SELECT DISTINCT A.PrdId,A.PrdTaxGroupId as   TaxGroupId INTO #TempClosing FROM ProductBatchVATTaxB4GST A (NOLOCK) INNER JOIN TempClosingStock B (NOLOCK) ON A.PrdId = B.PrdId
  
  INSERT INTO #TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,PrdId)        
  SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal,C.PrdId        
  FROM TaxSettingMaster A (NOLOCK) INNER JOIN TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId        
  AND B.BillSeqId=@BillSeqId AND Coltype IN(1,3)   
  INNER JOIN #TempClosing C   ON A.PrdId = C.TaxGroupId  
  INNER JOIN #tempTax1 D ON D.PrdID=C.TaxGroupId and A.TaxseqId=D.TaxSeqId
  WHERE A.RtrId = @RtrTaxGrp    
  ----------------->Till here <-----------------
  TRUNCATE TABLE ClosingStockProductTaxPercent     
  --To Get the Tax Percentage for the selected slab        
  SELECT PrdId,ColVal AS TaxPerc,TaxSlab INTO #TaxPercentage FROM #TaxSettingDet   
  WHERE ColType = 1 AND ColId = 0 AND ColVal > 0  
  --Addtional Tax  
  SELECT DISTINCT A.PrdId,A.TaxSlab,B.TaxPerc,CAST(1*(B.TaxPerc/100) AS NUMERIC(28,10)) AS TaxAmount  
  INTO #ClosingStockAddTax FROM #TaxSettingDet A INNER JOIN #TaxPercentage B ON A.TaxSlab = B.TaxSlab   
  AND A.PrdId = B.PrdId WHERE ColType = 3 AND ColVal > 0    
  SELECT DISTINCT A.PrdId,A.TaxSlab,B.TaxPerc,CAST(1*(B.TaxPerc/100) AS NUMERIC(28,10)) AS TaxAmount  
  INTO #ClosingStockTax FROM #TaxSettingDet A INNER JOIN #TaxPercentage B ON A.TaxSlab = B.TaxSlab AND A.PrdId = B.PrdId  
  WHERE ColVal > 0 AND NOT EXISTS (SELECT PrdId FROM #ClosingStockAddTax C WHERE A.PrdId = C.PrdId   
  AND A.TaxSlab = C.TaxSlab)  
  INSERT INTO #ClosingStockTax (PrdId,TaxSlab,TaxPerc,TaxAmount)  
  SELECT DISTINCT A.PrdId,A.TaxSlab,A.TaxPerc,CAST((B.TaxAmount * A.TaxAmount) AS NUMERIC(28,10)) AS TaxAmount  
  FROM #ClosingStockAddTax A INNER JOIN #ClosingStockTax B ON A.PrdId = B.PrdId  
  
  INSERT INTO ClosingStockProductTaxPercent(PrdId,TaxPercentage)  
  SELECT DISTINCT PrdId,ISNULL(SUM(TaxAmount)*100,0) FROM #ClosingStockTax (NOLOCK) GROUP BY PrdId    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_IOTaxSummary]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_IOTaxSummary]
GO
CREATE PROCEDURE [dbo].[Proc_IOTaxSummary]     
(      
 @Pi_UserId  INT      
)      
/************************************************************      
* VIEW : SP_RptIOTaxSummary      
* PURPOSE : To get the Tax Summary details      
* CREATED BY : Jisha Mathew      
* CREATED DATE : 03/08/2007      
* NOTE  :      
* MODIFIED      
* DATE      AUTHOR     DESCRIPTION      
------------------------------------------------      
* {date}        {developer}  {brief modification description}      
* 06/02/2008   Nanda        Added Return and Replacement details      
*************************************************************/      
AS      
BEGIN      
 Delete from TmpRptIOTaxSummary where UserId in (0,@Pi_UserId)    
 --Taxable Amount for IDT IN    
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
         PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
         IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 Select DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,    
  PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(TaxableAmount) as TaxableAmount,    
  'IDT IN' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId    
 From     
  IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId    
  AND PRP.PrdBatId = PT.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
  AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1 and StkMgmtTypeId = 1    
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By     
   TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
   S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId    
 Having Sum(TaxableAmount) >= 0    
 ------------------ For GST-----------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
         PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
         IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 Select DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,    
  PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Taxable Amount '+Cast(Left(sum(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,(TaxableAmount) as TaxableAmount,    
  'IDT IN' as IOTaxType,0 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(PT.TaxId) as Taxid,@Pi_UserId AS UserId    
 From     
  IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId    
  AND PRP.PrdBatId = PT.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
  AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1 and StkMgmtTypeId = 1 And TaxableAmount>0  
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By     
   PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
   S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,TaxableAmount   
 -------------------------------------------  
 --Tax Amount for IDT IN    
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
 PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 SELECT DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,    
  SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(PT.TaxAmount) as TaxableAmount,    
  'IDT IN' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId    
 From IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId    
  AND PT.PrdBatId = PRP.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1   and StkMgmtTypeId = 1     
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
  S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId    
 Having Sum(PT.TaxAmount) >= 0   
 -------- For GST-------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
 PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 SELECT DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,    
  SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Tax Amount '+Cast(Left(sum(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,(PT.TaxAmount) as TaxableAmount,    
  'IDT IN' as IOTaxType,1 as TaxFlag,sum(TaxPerc)as TaxPercent,max(PT.TaxId)as Taxid,@Pi_UserId AS UserId    
 From IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId    
  AND PT.PrdBatId = PRP.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1   and StkMgmtTypeId = 1 And PT.TaxAmount>0    
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
  S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxAmount   
 -----------------------------   
--Taxable Amount for IDT OUT    
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
 PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 Select DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,    
  PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  (-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,    
  (-1) * Sum(TaxableAmount) as TaxableAmount,    
  'IDT OUT' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId    
 From     
  IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId    
  AND PRP.PrdBatId = PT.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
  AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1  and StkMgmtTypeId = 2     
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By     
   TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
   S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId    
 Having Sum(TaxableAmount) >= 0    
 ---------- For GST -----------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
 PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 Select DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,    
  PRP.PrdBatId AS PrdBatId,SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  (-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Taxable Amount '+Cast(Left(sum(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,    
  (-1) * (TaxableAmount) as TaxableAmount,    
  'IDT OUT' as IOTaxType,0 as TaxFlag,sum(TaxPerc) as TaxPercent,max(PT.TaxId)as Taxid ,@Pi_UserId AS UserId    
 From     
  IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PRP.PrdId = PT.PrdId    
  AND PRP.PrdBatId = PT.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
  AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1  and StkMgmtTypeId = 2  and TaxableAmount>0   
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By     
   PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
   S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,TaxableAmount    
 ------------------------------------  
 --Tax Amount for IDT Out    
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
         PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
         IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 SELECT DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,    
  SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  (-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,(-1) * Sum(PT.TaxAmount) as TaxableAmount,    
  'IDT OUT' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId    
 From IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId    
  AND PT.PrdBatId = PRP.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
         AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1   and StkMgmtTypeId = 2     
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By TaxPerc,PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
  S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxId    
 Having Sum(PT.TaxAmount) >= 0   
 -------------- For GST ------------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,    
         PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,    
         IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)    
 SELECT DISTINCT     
  '' AS InvId,PR.IDTMngRefNo AS RefNo,'' AS CmpInvNo,PR.IDTMngDate as InvDate,    
  S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,    
  SUM(PRP.Qty) AS InvQty,PRP.PrdUnitRate as PrdLSP,    
  (-1) * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,    
  'Tax Amount '+Cast(Left(sum(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,(-1) * (PT.TaxAmount) as TaxableAmount,    
  'IDT OUT' as IOTaxType,1 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(PT.TaxId)as Taxid,@Pi_UserId AS UserId    
 From IDTManagement PR WITH (NOLOCK)    
  INNER JOIN IDTManagementProduct PRP WITH (NOLOCK) ON PR.IDTMngRefNo = PRP.IDTMngRefNo    
  INNER JOIN IDTManagementProductTax PT WITH (NOLOCK) ON PR.IDTMngRefNo = PT.IDTMngRefNo     
  AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.IDTMngRefNo = PT.IDTMngRefNo and PT.PrdId = PRP.PrdId    
  AND PT.PrdBatId = PRP.PrdBatId    
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId    
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId     
         AND PB.PrdId = P.PrdId    
  INNER jOIN IDTMaster S WITH (NOLOCK) ON PR.SpmId = S.SpmId    
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId     
 WHERE PR.Status = 1   and StkMgmtTypeId = 2 and PT.TaxAmount>0    
   --AND PR.IDTMngDate Between @Pi_FromDate and @Pi_ToDate    
 Group By PR.IDTMngDate,C.CmpId,P.PrdId,PR.IDTMngRefNo,    
  S.SpmId,PRP.PrdBatId,PRP.PrdUnitRate,PT.TaxAmount   
 -----------------------------------------     
 --Taxable Amount for Purchase      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,      
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(TaxableAmount) as TaxableAmount,      
 'Purchase' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId      
 From PurchaseReceipt PR WITH (NOLOCK)  --Select * from PurchaseReceipt    
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId      
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId    
 WHERE PR.Status = 1        
 Group By TaxPerc,PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.PrdLSP,PT.TaxId      
 Having Sum(TaxableAmount) >= 0    
 ----------- for GST -----------  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,      
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(SUM(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,(TaxableAmount) as TaxableAmount,      
 'Purchase' as IOTaxType,0 as TaxFlag,SUM(TaxPerc)as TaxPercent,MAX(PT.TaxId)As taxid,@Pi_UserId AS UserId      
 From PurchaseReceipt PR WITH (NOLOCK)  --Select * from PurchaseReceipt    
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId      
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1  and TaxableAmount>0      
 Group By PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.PrdLSP,TaxableAmount      
  
  ---------------  
 --Tax Amount for Purchase      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,      
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(TaxPerc,4) as Varchar(10))+'%' as TaxPerc ,Sum(PT.TaxAmount) as TaxableAmount,      
 'Purchase' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId      
 From PurchaseReceipt PR WITH (NOLOCK)      
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId      
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1  
 Group By TaxPerc,PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,      
  S.SpmId,PRP.PrdBatId,PRP.PrdLSP,PT.TaxId      
 Having Sum(PT.TaxAmount) >= 0   
 -------- For GST -------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRcptId AS InvId,PR.PurRcptRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.InvDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,SUM(PRP.InvBaseQty) AS InvQty,PRP.PrdLSP as PrdLSP,      
 Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(sum(TaxPerc),4) as Varchar(10))+'%' as TaxPerc ,(PT.TaxAmount) as TaxableAmount,      
 'Purchase' as IOTaxType,1 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(PT.TaxId) as Taxid,@Pi_UserId AS UserId      
 From PurchaseReceipt PR WITH (NOLOCK)      
 INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId = PRP.PurRcptId      
 INNER JOIN PurchaseReceiptProductTax PT WITH (NOLOCK) ON PR.PurRcptId = PT.PurRcptId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRcptId = PT.PurRcptId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1 AND PT.TaxAmount>0  
 Group By PR.InvDate,C.CmpId,P.PrdId,PR.PurRcptId,PR.PurRcptRefNo,PR.CmpInvNo,      
  S.SpmId,PRP.PrdBatId,PRP.PrdLSP,PT.TaxAmount  
 ------------------------------     
 --Taxable Amount for Purchase Return      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,      
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmount) as TaxableAmount,      
 'PurchaseReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId      
 From PurchaseReturn PR WITH (NOLOCK)     
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId      
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1      
 Group By TaxPerc,PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,PT.TaxId      
 Having Sum(TaxableAmount) >= 0   
 ---------- For GST ---------------------  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,      
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (TaxableAmount) as TaxableAmount,      
 'PurchaseReturn' as IOTaxType,0 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(PT.TaxId) as Taxid,@Pi_UserId AS UserId      
 From PurchaseReturn PR WITH (NOLOCK)     
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId      
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1 and TaxableAmount>0  
 Group By PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,TaxableAmount   
 ----------------------------    
 --Tax Amount for Purchase Return      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,      
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(PT.TaxAmount) as TaxableAmount,      
 'PurchaseReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,PT.TaxId,@Pi_UserId AS UserId      
 From PurchaseReturn PR WITH (NOLOCK)      
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId      
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1      
 Group By TaxPerc,PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,PT.TaxId      
 Having Sum(PT.TaxAmount) >= 0     
 ----------- For GST-------------  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct PR.PurRetId AS InvId,PR.PurRetRefNo AS RefNo,PR.CmpInvNo AS CmpInvNo,PR.PurRetDate as InvDate,      
 S.SpmId As SpmId,0 AS SmId,0 AS RmId,0 AS RtrId,P.PrdId as Prdid,PRP.PrdBatId AS PrdBatId,PRP.RetSalBaseQty AS InvQty,PRP.PrdLSP as PrdLSP,      
 -1 * Sum(PRP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (PT.TaxAmount) as TaxableAmount,      
 'PurchaseReturn' as IOTaxType,1 as TaxFlag,sum(TaxPerc) as TaxPercent,max(PT.TaxId)Taxid,@Pi_UserId AS UserId      
 From PurchaseReturn PR WITH (NOLOCK)      
 INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId = PRP.PurRetId      
 INNER JOIN PurchaseReturnProductTax PT WITH (NOLOCK) ON PR.PurRetId = PT.PurRetId AND PRP.PrdSlNo = PT.PrdSlNo AND PRP.PurRetId = PT.PurRetId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId      
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER jOIN Supplier S WITH (NOLOCK) ON PR.SpmId = S.SpmId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE PR.Status = 1 AND PT.TaxAmount>0  
 Group By PR.PurRetDate,C.CmpId,P.PrdId,PR.PurRetId,PR.PurRetRefNo,PR.CmpInvNo,      
 S.SpmId,PRP.PrdBatId,PRP.RetSalBaseQty,PRP.PrdLSP,PT.TaxAmount     
 --------------------------------   
 --Taxable Amount for Sales      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,      
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty      
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,Sum(TaxableAmount) as TaxableAmount,      
 'Sales' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,@Pi_UserId AS UserId      
 From SalesInvoice SI WITH (NOLOCK)      
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId      
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId       
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId       
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId        
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE SI.DlvSts in (4,5)    AND VatGST='VAT'  
 Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,      
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId,SPT.TaxId      
 Having Sum(TaxableAmount) >= 0   
 --For GST Bills  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,      
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty      
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+Cast(Left(SUM(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,(TaxableAmount) as TaxableAmount,      
 'Sales' as IOTaxType,0 as TaxFlag,SUM(TaxPerc) as TaxPercent,MAX(SPT.TaxId) AS TaxId,@Pi_UserId AS UserId      
 From SalesInvoice SI WITH (NOLOCK)      
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId      
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId       
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId       
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId        
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE SI.DlvSts in (4,5)    AND VatGST='GST' AND TaxableAmount>0  
 Group By SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,      
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId ,TaxableAmount   
  --   
 --Tax Amount for Sales      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,      
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty      
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,Sum(SPT.TaxAmount) as TaxableAmount,      
 'Sales' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,SPT.TaxId,@Pi_UserId AS UserId      
 From SalesInvoice SI WITH (NOLOCK)      
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId      
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId        
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId       
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId       
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE SI.DlvSts in (4,5)  AND VatGst='VAT'    
 Group By TaxPerc,SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,      
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId,SPT.TaxId      
 Having Sum(SPT.TaxAmount) >= 0   
 --For GST  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 Select distinct  SI.SalId AS InvId,SI.SalInvNo AS RefNo,'' AS CmpInvNo,SI.SalInvDate as InvDate,      
 0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,SIP.BaseQty AS InvQty      
 ,SIP.PrdUnitSelRate as PrdLSP,Sum(SIP.PrdGrossAmount) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+Cast(Left(SUM(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,Sum(SPT.TaxAmount) as TaxableAmount,      
 'Sales' as IOTaxType,1 as TaxFlag,SUM(TaxPerc) as TaxPercent,MAX(SPT.TaxId)AS TaxId ,@Pi_UserId AS UserId      
 From SalesInvoice SI WITH (NOLOCK)      
 INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId      
 INNER JOIN SalesInvoiceProductTax SPT WITH (NOLOCK) ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = SIP.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = SIP.PrdId AND PB.PrdBatId = SIP.PrdBatId AND PB.PrdId = P.PrdId      
 INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = SI.RtrId        
 INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = SI.SmId       
 INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = SI.RmId       
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE SI.DlvSts in (4,5)  AND VatGst='GST'  AND TaxableAmount>0  
 Group By SI.SalInvDate,C.CmpId,P.PrdId,SI.SalId,SI.SalInvNo,R.RtrId,PB.PrdBatId,      
 SIP.BaseQty,SIP.PrdUnitSelRate,SM.SmId,RM.RmId    
 --     
 --Taxable Amount for SalesReturn      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM (      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId      
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId        
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0       
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId      
  Having Sum(TaxableAmt) >= 0      
  UNION      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Taxable Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(TaxableAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId      
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId        
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.Status = 0       
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId      
  Having Sum(TaxableAmt) >= 0      
 ) A   
 ------------ For GST --------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM (      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Taxable Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (TaxableAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,0 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(RPT.TaxId) as Taxid,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId      
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId        
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0 AND TaxableAmt>0      
  Group By RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,TaxableAmt       
  UNION      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Taxable Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (TaxableAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,0 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(RPT.TaxId)as Taxid,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId      
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId        
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.Status = 0 And TaxableAmt>0   
  Group By RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,TaxableAmt        
 ) A  
 -----------------------------------  
 --Tax Amount for SalesReturn      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM  (      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(RPT.TaxAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId       
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId       
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0       
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId      
  Having Sum(RPT.TaxAmt) >= 0      
 UNION      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Tax Amount '+Cast(Left(TaxPerc,4) AS Varchar(10))+'%' as TaxPerc,-1 * Sum(RPT.TaxAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,1 as TaxFlag,TaxPerc as TaxPercent,RPT.TaxId,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId       
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId       
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0       
  Group By TaxPerc,RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxId      
  Having Sum(RPT.TaxAmt) >= 0      
 ) A     
 ------------- For GST ----------------  
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,      
 IOTaxType,TaxFlag,TaxPercent,TaxId,UserId FROM  (      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Tax Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (RPT.TaxAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,1 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(RPT.TaxId)as Taxid,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId       
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId       
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0 And RPT.TaxAmt>0     
  Group By RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxAmt         
 UNION      
  Select distinct RH.ReturnId AS InvId,RH.ReturnCode AS RefNo,'' AS CmpInvNo,Rh.ReturnDate as InvDate,      
  0 As SpmId,SM.SmId AS SmId,RM.RmId AS RmId,R.RtrId AS RtrId,P.PrdId as Prdid,PB.PrdBatId AS PrdBatId,RP.BaseQty AS InvQty,      
  RP.PrdUnitSelRte as PrdLSP,-1 * Sum(RP.PrdGrossAmt) AS GrossAmount,C.CmpId AS CmpId,      
  'Tax Amount '+Cast(Left(sum(TaxPerc),4) AS Varchar(10))+'%' as TaxPerc,-1 * (RPT.TaxAmt) as TaxableAmount,      
  'SalesReturn' as IOTaxType,1 as TaxFlag,sum(TaxPerc) as TaxPercent,Max(RPT.TaxId)Taxid,@Pi_UserId AS UserId      
  From ReturnHeader RH WITH (NOLOCK)      
  INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId AND RP.LineType=1      
  INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo      
  INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RP.PrdId        
  INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RP.PrdId AND PB.PrdBatId = RP.PrdBatId AND PB.PrdId = P.PrdId      
  INNER JOIN Retailer R WITH (NOLOCK) ON R.RtrId = RH.RtrId       
  INNER JOIN Salesman SM WITH (NOLOCK) ON SM.SmId = RH.SmId       
  INNER JOIN RouteMaster RM WITH (NOLOCK) ON RM.RmId = RH.RmId       
  LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
  WHERE RH.Status = 0 And RPT.TaxAmt>0     
  Group By RH.ReturnDate,C.CmpId,P.PrdId,RH.ReturnId,RH.ReturnCode,R.RtrId,PB.PrdBatId,      
  RP.BaseQty,RP.PrdUnitSelRte,SM.SmId,RM.RmId,RPT.TaxAmt     
 ) A  
 --------------------------------------   
 SELECT RepRefNo       
 INTO #NotDelivered      
 FROM ReplacementHd RH (NOLOCK),SalesInvoice SI (NOLOCK)      
 WHERE RH.SalId>0 AND RH.SalId=SI.SalId AND SI.DlvSts NOT IN (4,5)       
 --Taxable Amount for Return & Replacement (Return)      
 Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,      
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*SUM(TaxableAmount) AS TaxableAmount,      
 'SalesReturn' AS IOTaxType,0 AS TaxFlag,TaxPerc AS TaxPercent,RIT.TaxId,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0      
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)      
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxPerc,RIT.TaxId      
 HAVING SUM(RIT.TaxableAmount) >= 0   
 ------------ For GST ----------------  
  Insert INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,      
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+CAST(LEFT(sum(TaxPerc),4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*(TaxableAmount) AS TaxableAmount,      
 'SalesReturn' AS IOTaxType,0 AS TaxFlag,sum(TaxPerc) AS TaxPercent,Max(RIT.TaxId) as taxid,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0      
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered) And RIT.TaxableAmount>0    
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxableAmount      
 --------------------     
 --Tax Amount for Return & Replacement (Return)      
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,      
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*SUM(TaxAmount) AS TaxableAmount,      
 'SalesReturn' AS IOTaxType,1 AS TaxFlag,TaxPerc AS TaxPercent,RIT.TaxId,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0      
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)      
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxPerc,RIT.TaxId      
 HAVING SUM(RIT.TaxAmount) >= 0   
 -------------- For GST -----------------  
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty AS InvQty,      
 RI.SelRte AS PrdLSP,-1*SUM(RI.SelRte*RI.RtnQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+CAST(LEFT(sum(TaxPerc),4) AS NVARCHAR(10))+'%' AS TaxPerc,-1*(TaxAmount) AS TaxableAmount,      
 'SalesReturn' AS IOTaxType,1 AS TaxFlag,sum(TaxPerc) AS TaxPercent,Max(RIT.TaxId)as taxid,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementIn RI WITH (NOLOCK) ON RI.RepRefNo=RH.RepRefNo AND RH.SalId=0      
 INNER JOIN ReplacementInPrdTax RIT WITH (NOLOCK) ON RI.RowId=RIT.RowId AND RH.RepRefNo=RIT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RI.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RI.PrdId AND PB.PrdBatId = RI.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered) AND TaxAmount>0      
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RI.RtnQty,RI.SelRte,C.CmpId,RIT.TaxAmount      
 ----------------------------------------     
 --Taxable Amount for Return & Replacement (Replacement)      
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,      
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,SUM(TaxableAmount) AS TaxableAmount,      
 'Sales' AS IOTaxType,0 AS TaxFlag,TaxPerc AS TaxPercent,ROT.TaxId,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo      
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)      
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxPerc,ROT.TaxId      
 HAVING SUM(ROT.TaxableAmount) >= 0    
 --------------- For GST ------------------  
  INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,      
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Taxable Amount '+CAST(LEFT(sum(TaxPerc),4) AS NVARCHAR(10))+'%' AS TaxPerc,(TaxableAmount) AS TaxableAmount,      
 'Sales' AS IOTaxType,0 AS TaxFlag,sum(TaxPerc) AS TaxPercent,max(ROT.TaxId)As taxid,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo      
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId      
      ) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered) And ROT.TaxableAmount>0     
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxableAmount  
 ------------------------------------------   
 --Tax Amount for Return & Replacement (Replacement)      
 INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,      
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+CAST(LEFT(TaxPerc,4) AS NVARCHAR(10))+'%' AS TaxPerc,SUM(TaxAmount) AS TaxableAmount,      
 'Sales' AS IOTaxType,1 AS TaxFlag,TaxPerc AS TaxPercent,ROT.TaxId,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo      
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered)      
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxPerc,ROT.TaxId      
 HAVING SUM(ROT.TaxAmount) >= 0      
 -------- For GST ------------------  
  INSERT INTO TmpRptIOTaxSummary (InvId,RefNo,CmpInvNo,InvDate,SpmId,SmId,RmId,RtrId,      
 Prdid,PrdBatId,InvQty,PrdLSP,GrossAmount,CmpId,TaxPerc,TaxableAmount,IOTaxType,TaxFlag,TaxPercent,TaxId,UserId)      
 SELECT DISTINCT 0 AS InvId,RH.RepRefNo AS RefNo,'' AS CmpInvNo,RH.RepDate AS InvDate,      
 0 AS SpmId,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty AS InvQty,      
 RO.SelRte AS PrdLSP,SUM(RO.SelRte*RO.RepQty) AS GrossAmount,C.CmpId AS CmpId,      
 'Tax Amount '+CAST(LEFT(sum(TaxPerc),4) AS NVARCHAR(10))+'%' AS TaxPerc,(TaxAmount) AS TaxableAmount,      
 'Sales' AS IOTaxType,1 AS TaxFlag,sum(TaxPerc) AS TaxPercent,Max(ROT.TaxId)as Taxid,@Pi_UserId AS UserId      
 FROM ReplacementHd RH WITH (NOLOCK)      
 INNER JOIN ReplacementOut RO WITH (NOLOCK) ON RO.RepRefNo=RH.RepRefNo      
 INNER JOIN ReplacementOutPrdTax ROT WITH (NOLOCK) ON RO.RowId=ROT.RowId AND RH.RepRefNo=ROT.RepRefNo      
 INNER JOIN (SELECT MIN(A.SMId) AS SMId,MIN(A.RMId) AS RMId,A.RtrId      
   FROM Retailer B      
   INNER JOIN      
   (SELECT RH.RtrId,R.RMId,S.SMId      
   FROM ReplacementHd RH WITH (NOLOCK)      
   INNER JOIN RetailerMarket RM WITH (NOLOCK) ON RH.RtrId=RM.RtrId      
   INNER JOIN RouteMaster R WITH (NOLOCK) ON R.RMId=RM.RMId      
   INNER JOIN SalesmanMarket SM WITH (NOLOCK) ON SM.RMId=RM.RMId      
   INNER JOIN Salesman S WITH (NOLOCK) ON S.SMId=SM.SMId      
   ) AS A      
   ON A.RtrId=B.RtrId      
   GROUP BY A.RtrId) AS Rtr ON Rtr.RtrId=RH.RtrId      
 INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = RO.PrdId        
 INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = RO.PrdId AND PB.PrdBatId = RO.PrdBatId AND PB.PrdId = P.PrdId      
 LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId       
 WHERE RH.RepRefNo NOT IN (SELECT RepRefNo FROM #NotDelivered) And ROT.TaxAmount>0   
 GROUP BY RH.RepRefNo,RH.RepDate,Rtr.SMId,Rtr.RMId,RH.RtrId,P.PrdId,PB.PrdBatId,RO.RepQty,RO.SelRte,C.CmpId,ROT.TaxAmount        
 -----------------------------------  
--select * from TmpRptIOTaxSummary where InvDate='2008-02-05'      
END
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME='RptHSNOutputTaxGST' AND XTYPE='U')
DROP TABLE RptHSNOutputTaxGST
GO
CREATE TABLE RptHSNOutputTaxGST
(
SLNO BIGINT IDENTITY(1,1),
StateCode Varchar(20),
StateName Varchar(100),
GSTin Varchar(50),
RetailerType Varchar(25),
RtrCode Varchar(50),
Rtrname Varchar(100),	
HsnCode Varchar(50),
Refid BIGINT,
RefNo Varchar(50),
RefDate DateTime,
RtrId INT,
TaxableAmount Numeric(18,4),
NetAmount numeric(24,2),
Taxname Varchar(100),
DynamicAmt Numeric(24,4),
TaxType Varchar(50),
TaxFlag TinyInt	,
Taxper Numeric(10,2),
TaxId INT,
[Group Name] varchar(50),
[GroupType] Tinyint,
[UsrId] INT
)
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME='RptOutputSaleTaxGST' AND XTYPE='U')
DROP TABLE RptOutputSaleTaxGST
GO
CREATE TABLE [RptOutputSaleTaxGST](
	[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
	[StateCode] [varchar](20) NULL,
	[StateName] [varchar](100) NULL,
	[GSTin] [varchar](50) NULL,
	[RetailerType] [varchar](25) NULL,
	[RtrId] [int] NULL,
	[RtrCode] [varchar](50) NULL,
	[Rtrname] [varchar](100) NULL,
	[Refid] [bigint] NULL,
	[RefNo] [varchar](50) NULL,
	[RefDate] [datetime] NULL,
	[TaxType] [varchar](50) NULL,
	[SalesOrderType] [tinyint] NULL,
	[TaxableAmount] [numeric](34, 4) NULL,	
	[NetAmount] [numeric](36, 2) NULL,
	[Group Name] [varchar](100) NULL,
	[Grouptype] [tinyint] NULL,
	[UsrId] [int] NULL
)
GO
DELETE FROM RptGroup WHERE RptId=422
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSTTaxReports 400',422,'HSNOutPutTax','HSN Code wise output tax',1
GO
DELETE FROM RptHeader WHERE RptId=422
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'HSNOutPutTax','HSN Code wise output tax',422,'HSN Code wise output tax','Proc_RptHSNOutPutTaxGST','RptHSNOutputTaxGST','RptHSNOutputTaxGST.rpt',0
GO
DELETE FROM RptDetails WHERE RptId=422
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (422,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (422,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (422,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,'',4,1,0,'Press F4/Double Click to select Company',0)
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=422
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,422,'HSN Code Wise Output Tax',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',9,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',10,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
UNION ALL
SELECT 1,422,'HSN Code Wise Output Tax',11,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=404
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,404,'Output Tax Summary',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',9,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
UNION ALL
SELECT 1,404,'Output Tax Summary',10,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME='RptHSNInputTaxGST' AND XTYPE='U')
DROP TABLE RptHSNInputTaxGST
GO
CREATE TABLE RptHSNInputTaxGST
(
SLNO BIGINT IDENTITY(1,1),
StateCode Varchar(20),
StateName Varchar(100),
GSTin Varchar(50),
SpmCode Varchar(50),
Spmname Varchar(100),	
HsnCode Varchar(50),
Refid BIGINT,
RefNo Varchar(50),
CmpInvno Varchar(50),
PurchaseOrderNo Varchar(50),
InvoiceDate Datetime,
RefDate DateTime,
SpmId INT,
TaxableAmount Numeric(18,4),
NetAmount numeric(24,2),
Taxname Varchar(100),
DynamicAmt Numeric(24,4),
TaxType Varchar(50),
TaxFlag TinyInt	,
Taxper Numeric(10,2),
TaxId INT,
[Group Name] varchar(50),
[GroupType] Tinyint,
[UsrId] INT
)
GO
DELETE FROM RptGroup WHERE RptId=423
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSTTaxReports 400',423,'HSNInPutTax','HSN Code wise Input tax',1
GO
DELETE FROM RptHeader WHERE RptId=423
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'HSNInPutTax','HSN Code wise Input tax',423,'HSN Code wise Input tax','Proc_RptHSNInputTaxGST','RptHSNInputTaxGST','RptHSNInputTaxGST.rpt',0
GO
DELETE FROM RptDetails WHERE RptId=423
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (423,1,'FromDate',-1,'','','From Date*','',1,'',10,0,0,'Enter From Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (423,2,'ToDate',-1,'','','To Date*','',1,'',11,0,0,'Enter To Date',0)
INSERT INTO RptDetails(RptId,[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) VALUES (423,3,'Company',-1,'','CmpId,CmpCode,CmpName','Company...','',1,'',4,1,0,'Press F4/Double Click to select Company',0)
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=423
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,423,'HSN Code Wise Input Tax',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',5,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',6,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',8,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',9,'Invoice',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',10,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',11,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
UNION ALL
SELECT 1,423,'HSN Code Wise Input Tax',12,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME='RptInputtaxCreditGST' AND XTYPE='U')
DROP TABLE RptInputtaxCreditGST
GO
CREATE TABLE [RptInputtaxCreditGST](
	[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
	[StateCode] [varchar](20) NULL,
	[StateName] [varchar](100) NULL,
	[GSTin] [varchar](50) NULL,
	[SpmId] [int] NULL,
	[SpmCode] [varchar](50) NULL,
	[Spmname] [varchar](100) NULL,
	[Refid] [bigint] NULL,
	[RefNo] [varchar](50) NULL,
	[CmpInvno] [varchar](50) NULL,
	[PurchaseOrderNo] [varchar](50) NULL,
	[InvoiceDate] [datetime] NULL,
	[RefDate] [datetime] NULL,
	[TaxType] [varchar](50) NULL,
	[SalesOrderType] [tinyint] NULL,
	[TaxableAmount] [numeric](34, 4) NULL,
	[NetAmount] [numeric](36, 2) NULL,
	[Group Name] [varchar](100) NULL,
	[Grouptype] [tinyint] NULL,
	[UsrId] [int] NULL
)
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=405
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,405,'Input Tax Summary',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',5,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',6,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',8,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',9,'Invoice',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',10,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
UNION ALL
SELECT 1,405,'Input Tax Summary',11,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[RptOutputSaleTaxGST]') AND type in (N'U'))
DROP TABLE [dbo].[RptOutputSaleTaxGST]
GO
CREATE TABLE [dbo].[RptOutputSaleTaxGST](
[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
[StateCode] [varchar](500) NULL,
[StateName] [nvarchar](500) NULL,
[GSTin] [nvarchar](500) NULL,
[RetailerType] [nvarchar](500) NULL,
[RtrId] [int] NULL,
[RtrCode] [nvarchar](500) NULL,
[Rtrname] [nvarchar](500) NULL,
[Refid] [bigint] NULL,
[RefNo] [nvarchar](500) NULL,
[RefDate] [datetime] NULL,
[TaxType] [nvarchar](500) NULL,
[SalesOrderType] [tinyint] NULL,
[TaxableAmount] [numeric](38, 6) NULL,
[OutputCGST~TaxableAmount~9.00] [numeric](38, 6) NULL,
[OutputCGST~Taxamount~9.00] [numeric](38, 6) NULL,
[OutputCGST~TaxableAmount~14.00] [numeric](38, 6) NULL,
[OutputCGST~Taxamount~14.00] [numeric](38, 6) NULL,
[OutputSGST~TaxableAmount~9.00] [numeric](38, 6) NULL,
[OutputSGST~Taxamount~9.00] [numeric](38, 6) NULL,
[OutputSGST~TaxableAmount~14.00] [numeric](38, 6) NULL,
[OutputSGST~Taxamount~14.00] [numeric](38, 6) NULL,
[NetAmount] [numeric](38, 6) NULL,
[Group Name] [nvarchar](500) NULL,
[Grouptype] [tinyint] NULL,
[UsrId] [int] NULL
) ON [PRIMARY]
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='FN_ReturnRetailerUDCDetails' AND XTYPE='TF')
DROP FUNCTION FN_ReturnRetailerUDCDetails
GO
CREATE FUNCTION FN_ReturnRetailerUDCDetails()
RETURNS @RetailerUDC TABLE
(
	Rtrid			INT,
	RtrName			NVARCHAR(100),
	RtrCode			NVARCHAR(50),
	StateName		NVARCHAR(100),
	StateCode		VARCHAR(20),
	StateTinFirst2Digit NVARCHAR(10),
	RetailerType	INT,
	GSTIN			NVARCHAR(50),
	PanNumber		NVARCHAR(10),
	Composition		INT,
	RelatedParty	INT
)

AS
BEGIN
	INSERT INTO @RetailerUDC	
	SELECT Rtrid,RtrName,RtrCode,A.StateName,S.StateCode,S.TinFirst2Digit,RetailerType,GSTIN,PanNumber,Composition,RelatedParty
	FROM
	(
	SELECT Rtrid,RtrName,RtrCode,
	CASE ISNULL(A.ColumnValue,'') WHEN '' THEN '' ELSE A.ColumnValue END StateName,
	CASE ISNULL(F.ColumnValue,'') WHEN 'Registered' THEN 1 WHEN 'Unregistered' THEN 2 ELSE 0 END RetailerType,	
	CASE ISNULL(B.ColumnValue,'') WHEN '' THEN '' ELSE CASE WHEN LEN(B.ColumnValue)<10 THEN '' ELSE B.ColumnValue END END GSTIN,
	CASE ISNULL(C.ColumnValue,'') WHEN '' THEN '' ELSE C.ColumnValue END PanNumber,	 
	CASE ISNULL(D.ColumnValue,'') WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 ELSE 0 END Composition,	 
	CASE ISNULL(E.ColumnValue,'') WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 ELSE 0 END RelatedParty	 
	FROM Retailer R 
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='STATE NAME')A ON A.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND ColumnName='Retailer Type')F ON F.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='GSTIN')B ON B.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='PAN NUMBER')C ON C.MasterRecordId=R.RtrId	
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='COMPOSITION')D ON D.MasterRecordId=R.RtrId	
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='RELATED PARTY')E ON E.MasterRecordId=R.RtrId
	)A
	LEFT OUTER JOIN StateMaster S ON S.StateName=A.StateName				
RETURN
END
GO
IF EXISTS(SELECT *FROM SYSOBJECTS WHERE NAME='Proc_RptHSNOutPutTaxGST' AND XTYPE='P')
DROP PROCEDURE Proc_RptHSNOutPutTaxGST
GO
/*
BEGIN tran
EXEC Proc_RptHSNOutPutTaxGST 422,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [Proc_RptHSNOutPutTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptHSNOutPutTax
* PURPOSE	: To get the HSN Wise Tax Report
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON

	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		

	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)

		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))

	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptHSNOutputTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)

		

		SELECT DISTINCT P.Prdid,ColumnValue as HSNCODE 
		INTO #HSNCODE
		FROM UdcHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
		and C.UdcMasterId=B.UdcMasterId 
		INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
		WHERE A.MasterName='Product Master' and B.ColumnName='HSN CODE'
	
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			RetailerType Varchar(25),
			RtrCode Varchar(50),
			Rtrname Varchar(100),	
			HsnCode Varchar(50),
			Refid BIGINT,
			RefNo Varchar(50),
			RefDate DateTime,
			RtrId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)

		SELECT Salid,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #SalesTaxableAmount
		FROM(
		SELECT S.Salid,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
		WHERE  TaxableAmount>0 and DlvSts>3
		AND SI.SalInvDate  Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.Salid,PrdSlno 
		)X GROUP BY Salid,Prdslno
		
		SELECT ReturnID,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #RetunrTaxableAmount
		FROM(
		SELECT S.ReturnID,PrdSlno,SUM(DISTINCT TaxableAmt) as TaxableAmount
		FROM ReturnProductTax  S  (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnID=SI.ReturnID
		WHERE  TaxableAmt>0 AND SI.ReturnDate  Between @FromDate AND @ToDate and Status=0
		GROUP BY S.ReturnID,PrdSlno
		)X GROUP BY  ReturnID,Prdslno

		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0 and DlvSts>3
		GROUP BY HSNCODE,S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalinvNo,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(TaxAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and DlvSts>3
		GROUP BY HSNCODE,S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalInvNo,SPT.TaxId,RtrCode,Rtrname
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxableAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE ReturnDate	Between @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY HSNCODE,S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,ISNULL(HSNCODE,''),
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId
		WHERE ReturnDate between  @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY HSNCODE,S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname


	
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,HsnCode ,
		Refid,RefNo,RefDate,RtrId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','','', 0 as [InvId],'' as [RefNo],Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId

		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN,
		B.RetailerType=CASE A.RetailerType WHEN 1 THEN 'Registered'
		WHEN 2 THEN 'Unregistered' END
		FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId

		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END


		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''

		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	

		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		RetailerType Varchar(25),
		RtrId INT,
		RtrCode Varchar(50),
		Rtrname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		RefDate DateTime,
		HsnCode Varchar(50),	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),'

		SET @Columns1='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxType,SalesOrderType,TaxableAmount,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptHSNOutputTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptHSNOutputTaxGST'+
		' CREATE TABLE RptHSNOutputTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptHSNOutputTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)

		SELECT DISTINCT
		StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,HsnCode,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0

		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptHSNOutputTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,422,'HSN Code Wise Output Tax',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',9,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',10,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,422,'HSN Code Wise Output Tax',11,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')

				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptHSNOutputTaxGST)
			BEGIN
				SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptHSNOutputTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Proc_RptOutputSaleTaxGST' AND XTYPE = 'P')
DROP PROCEDURE Proc_RptOutputSaleTaxGST
GO
/*
BEGIN tran
EXEC Proc_RptOutputSaleTaxGST 404,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [Proc_RptOutputSaleTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptOutputSaleTaxGST
* PURPOSE	: To get the Output Tax
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON

	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		

	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)

		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))

	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptOutputSaleTaxGST
	
	
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)

		
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			RetailerType Varchar(25),
			RtrCode Varchar(50),
			Rtrname Varchar(100),	
			Refid BIGINT,
			RefNo Varchar(50),
			RefDate DateTime,
			RtrId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)

		SELECT Salid,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #SalesTaxableAmount
		FROM(
		SELECT S.Salid,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid
		WHERE  TaxableAmount>0 and DlvSts>3
		AND SI.SalInvDate  Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.Salid,PrdSlno 
		)X GROUP BY Salid,Prdslno
		
		SELECT ReturnID,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #RetunrTaxableAmount
		FROM(
		SELECT S.ReturnID,PrdSlno,SUM(DISTINCT TaxableAmt) as TaxableAmount
		FROM ReturnProductTax  S  (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnID=SI.ReturnID
		WHERE  TaxableAmt>0 AND SI.ReturnDate  Between @FromDate AND @ToDate and Status=0
		GROUP BY S.ReturnID,PrdSlno
		)X GROUP BY  ReturnID,Prdslno

		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0 and DlvSts>3
		GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalinvNo,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(TaxAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM SalesInvoice S (NOLOCK) 
		INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId
		INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE Salinvdate	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and DlvSts>3
		GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalInvNo,SPT.TaxId,RtrCode,Rtrname
		
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,
		RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxableAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId
		WHERE ReturnDate	Between @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname
		UNION ALL
		SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,
		S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,
		-1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,
		TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(TaxAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID
		INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo
		INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Retailer R ON R.RtrId=S.RtrId		
		WHERE ReturnDate between  @FromDate and @ToDate and Status=0
		and TaxableAmt>0
		GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname


	
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,
		Refid,RefNo,RefDate,RtrId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
		
		--select 'TTT',* from #TaxHSNSummary

		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN,
		B.RetailerType=CASE A.RetailerType WHEN 1 THEN 'Registered'
		WHEN 2 THEN 'Unregistered' END
		FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId


		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END


		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @SumCol AS VARCHAR(MAX)
		DECLARE @GroupByCol as VARCHAR(MAX)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		SET @SumCol=''
		SET @GroupByCol=''

		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
		

		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		--SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,SUM(TaxableAmount) as TaxableAmount,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		RetailerType Varchar(25),
		RtrId INT,
		RtrCode Varchar(50),
		Rtrname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		RefDate DateTime,	
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(32,2),
		'

		SET @Columns1='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptOutputSaleTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptOutputSaleTaxGST'+
		' CREATE TABLE RptOutputSaleTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptOutputSaleTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+@GroupByCol+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		
				
		
		--EXEC Proc_RptOutputSaleTaxGST 404,1,0,'GSTTAX',0,0,1
		SELECT DISTINCT
		StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,
		TaxableAmount,
		NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0

		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,
		Y.NetAmount=X.NetAmount
		FROM RptOutputSaleTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
	
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,404,'Output Tax Summary',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',9,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()
			UNION ALL
			SELECT 1,404,'Output Tax Summary',10,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')

			
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptOutputSaleTaxGST)
			BEGIN
				SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE name='FN_ReturnSupplierUDCDetails' AND XTYPE='TF')
DROP FUNCTION FN_ReturnSupplierUDCDetails
GO
CREATE FUNCTION FN_ReturnSupplierUDCDetails()
RETURNS @SupplierUDC TABLE
(
	SpmId			INT,
	SpmName			NVARCHAR(100),
	SpmCode			NVARCHAR(50),
	StateName		NVARCHAR(100),
	StateCode		VARCHAR(20),
	StateTinFirst2Digit NVARCHAR(10),
	GSTIN			NVARCHAR(50)	
	
)

AS
BEGIN
	INSERT INTO @SupplierUDC	
	SELECT SpmId,SpmName,SpmCode,A.StateName,ISNULL(S.StateCode,''),ISNULL(S.TinFirst2Digit,''),GSTIN
	FROM
	(
	SELECT SpmId,SpmName,SpmCode,
	CASE ISNULL(A.ColumnValue,'') WHEN '' THEN '' ELSE A.ColumnValue END StateName,		
	CASE ISNULL(B.ColumnValue,'') WHEN '' THEN '' ELSE CASE WHEN LEN(B.ColumnValue)<10 THEN '' ELSE B.ColumnValue END END GSTIN
	FROM Supplier R 
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=8 AND UPPER(ColumnName)='STATE NAME')A ON A.MasterRecordId=R.SpmId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=8 AND UPPER(ColumnName)='GSTIN')B ON B.MasterRecordId=R.SpmId

	)A
	LEFT OUTER JOIN StateMaster S ON S.StateName=A.StateName				
RETURN
END
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Fn_ReturnExcelReportDynamic' and xtype in ('TF','FN'))
DROP FUNCTION Fn_ReturnExcelReportDynamic
GO
--SELECT dbo.Fn_ReturnExcelReportDynamic(409)
CREATE FUNCTION Fn_ReturnExcelReportDynamic(@RptId	AS INT)
RETURNS INT
AS
/************************************************
* PROCEDURE  : Fn_ReturnExcelReportDynamic
* PURPOSE    : To Validate and Return Dynamic Reports
* CREATED BY : S.Moorthi
* CREATED ON : 09/08/2017
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
09/09/2017	Murugan.R	CR		CCRSTAN0150			Modified New ReportId added 425,426,427,428,429,430,431
*/
BEGIN

DECLARE @ReturnVal AS INT
SET @ReturnVal=0
	
	IF @RptId  in (401 ,402 ,403 ,404 ,405 ,406,407 ,409 ,411,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431)
	BEGIN
		SET @ReturnVal=1
	END

RETURN @ReturnVal
END
GO
----------- Added by Lakshman M on 31/08/2017------------------
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FN_ReturnRetailerUDCDetails]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
DROP FUNCTION [dbo].[FN_ReturnRetailerUDCDetails]
GO
CREATE FUNCTION [dbo].[FN_ReturnRetailerUDCDetails]()
RETURNS @RetailerUDC TABLE
(
	Rtrid			INT,
	RtrName			NVARCHAR(500),
	RtrCode			NVARCHAR(500),
	StateName		NVARCHAR(500),
	StateCode		VARCHAR(500),
	StateTinFirst2Digit NVARCHAR(500),
	RetailerType	INT,
	GSTIN			NVARCHAR(500),
	PanNumber		NVARCHAR(500),
	Composition		INT,
	RelatedParty	INT
)
AS
BEGIN
	INSERT INTO @RetailerUDC	
	SELECT Rtrid,RtrName,RtrCode,A.StateName,S.StateCode,S.TinFirst2Digit,RetailerType,GSTIN,PanNumber,Composition,RelatedParty
	FROM
	(
	SELECT Rtrid,RtrName,RtrCode,
	CASE ISNULL(A.ColumnValue,'') WHEN '' THEN '' ELSE A.ColumnValue END StateName,
	CASE ISNULL(F.ColumnValue,'') WHEN 'Registered' THEN 1 WHEN 'Unregistered' THEN 2 ELSE 0 END RetailerType,	
	CASE ISNULL(B.ColumnValue,'') WHEN '' THEN '' ELSE CASE WHEN LEN(B.ColumnValue)<10 THEN '' ELSE B.ColumnValue END END GSTIN,
	CASE ISNULL(C.ColumnValue,'') WHEN '' THEN '' ELSE C.ColumnValue END PanNumber,	 
	CASE ISNULL(D.ColumnValue,'') WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 ELSE 0 END Composition,	 
	CASE ISNULL(E.ColumnValue,'') WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 ELSE 0 END RelatedParty	 
	FROM Retailer R 
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='STATE NAME')A ON A.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND ColumnName='Retailer Type')F ON F.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='GSTIN')B ON B.MasterRecordId=R.RtrId
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='PAN NUMBER')C ON C.MasterRecordId=R.RtrId	
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='COMPOSITION')D ON D.MasterRecordId=R.RtrId	
	LEFT OUTER JOIN (SELECT MASTERRECORDID,ColumnValue FROM UDCDETAILS UD INNER JOIN UdcMaster U ON U.MasterId=UD.MasterId AND U.UdcMasterId=UD.UdcMasterId 
				AND U.MasterId=2 AND UPPER(ColumnName)='RELATED PARTY')E ON E.MasterRecordId=R.RtrId
	)A
	LEFT OUTER JOIN StateMaster S ON S.StateName=A.StateName				
RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptOutputSaleTaxGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptOutputSaleTaxGST]
GO
/*  
BEGIN tran  
EXEC Proc_RptOutputSaleTaxGST 404,2,0,'GSTTAX',0,0,1  
Select * from RptInputtaxCreditGST  
ROLLBACK tran   
*/  
CREATE PROCEDURE [dbo].[Proc_RptOutputSaleTaxGST]  
(  
 @Pi_RptId   INT,  
 @Pi_UsrId   INT,  
 @Pi_SnapId   INT,  
 @Pi_DbName   NVarchar(100),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
/*********************************  
* PROCEDURE : Proc_RptOutputSaleTaxGST  
* PURPOSE : To get the Output Tax  
* CREATED : Murugan.R  
* CREATED DATE : 25/08/2017  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*********************************/  
BEGIN  
SET NOCOUNT ON  
  
 --Filter Variable  
 DECLARE @FromDate  AS DATETIME  
 DECLARE @ToDate   AS DATETIME  
 DECLARE @CmpId         AS INT  
 DECLARE @ErrNo   AS INT  
    
  
 DECLARE @SQL as Varchar(MAX)  
 DECLARE @MaxId as INT  
 DECLARE @ReportId as INT  
 DECLARE @start INT, @end INT   
 DECLARE @Str AS NVarchar(500)  
 DECLARE @CreateTable AS VARCHAR(max)  
  
    
 SET @ErrNo=0  
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)  
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)  
 SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
  
 --SET @FromDate='2017-05-01'  
 --SET @ToDate='2017-07-30'  
 --select * from ReportFilterDt  
   
  TRUNCATE TABLE RptOutputSaleTaxGST  

  DECLARE @DynamicLineAmountFields as VARCHAR(300)  
  DECLARE @DynamicLineAmountFields1 as VARCHAR(300)  
  DECLARE @DynamicLineAmountFields2 as VARCHAR(300)  

  CREATE TABLE #TaxHSNSummary  
  (  
   StateCode NVarchar(500),  
   StateName NVarchar(500),  
   GSTin Varchar(1000),  
   RetailerType NVarchar(500),  
   RtrCode NVarchar(500),  
   Rtrname NVarchar(500),   
   Refid BIGINT,  
   RefNo NVarchar(500),  
   RefDate DateTime,  
   RtrId INT,  
   GrossAmount Numeric(18,4),  
   TaxableAmount Numeric(32,4),  
   NetAmount numeric(24,4),  
   Taxname NVarchar(500),  
   DynamicAmt Numeric(24,4),  
   TaxType NVarchar(500),  
   SalesOrderType TinyInt,  
   TaxFlag TinyInt ,  
   Taxper Numeric(10,2),  
   TaxId INT,  
   [Group Name] NVarchar(500),  
   [GroupType] Tinyint,  
   [UsrId] INT  
  )  

  SELECT Salid,Prdslno,SUM(TaxableAmount) as TaxableAmount  
  INTO #SalesTaxableAmount  
  FROM(  
  SELECT S.Salid,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount  
  FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid  
  WHERE  TaxableAmount>0 and DlvSts>3  
  AND SI.SalInvDate  Between @FromDate AND @ToDate and VatGST='GST'  
  GROUP BY S.Salid,PrdSlno   
  )X GROUP BY Salid,Prdslno  
    
  SELECT ReturnID,Prdslno,SUM(TaxableAmount) as TaxableAmount  
  INTO #RetunrTaxableAmount  
  FROM(  
  SELECT S.ReturnID,PrdSlno,SUM(DISTINCT TaxableAmt) as TaxableAmount  
  FROM ReturnProductTax  S  (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnID=SI.ReturnID  
  WHERE  TaxableAmt>0 AND SI.ReturnDate  Between @FromDate AND @ToDate and Status=0  
  GROUP BY S.ReturnID,PrdSlno  
  )X GROUP BY  ReturnID,Prdslno  
  
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,  
  RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,  
  S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,  
  SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(1000)) as TaxName,  
  SUM(SPT.TaxableAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,  
  0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM SalesInvoice S (NOLOCK)   
  INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId  
  INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo  
  INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Retailer R ON R.RtrId=S.RtrId  
  WHERE Salinvdate Between @FromDate and @ToDate and VatGST='GST'  
  and SPT.TaxableAmount>0 and DlvSts>3  
  GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalinvNo,SPT.TaxId,RtrCode,Rtrname  
  UNION ALL  
  SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,  
  S.Salid as RefId,SalinvNo as RefNo,Salinvdate as RefDate,R.RtrId,SUM(PrdGrossAmount) as PrdGrossAmount,  
  SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,  
  TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(1000)) as TaxName,  
  SUM(TaxAmount) as DynamicAmt,'Sales of Goods' as TaxType,1 as SalesOrderType,  
  1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM SalesInvoice S (NOLOCK)   
  INNER JOIN SalesInvoiceProduct SIP (NOLOCK) ON S.Salid=SIP.SalId  
  INNER JOIN SalesInvoiceProductTax SPT (NOLOCK) ON SPT.SalId=SIP.SalId and SPT.SalId=S.SalId and SIP.SlNo=SPT.PrdSlNo  
  INNER JOIN #SalesTaxableAmount ST ON ST.SalId=SPT.SalId  and S.Salid=St.Salid and ST.SalId=SIP.SalId and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Retailer R ON R.RtrId=S.RtrId  
  WHERE Salinvdate Between @FromDate and @ToDate and VatGST='GST'  
  and SPT.TaxableAmount>0  and DlvSts>3  
  GROUP BY S.Salid,Salinvdate,R.RtrId,TaxCode,TaxPerc,SalInvNo,SPT.TaxId,RtrCode,Rtrname
    
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,Refid,RefNo,  
  RefDate,RtrId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,  
  S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,  
  -1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(38,6)) as Varchar(1000)) as TaxName,  
  -1*SUM(TaxableAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,  
  0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM ReturnHeader S (NOLOCK)   
  INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID  
  INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo  
  INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Retailer R ON R.RtrId=S.RtrId  
  WHERE ReturnDate Between @FromDate and @ToDate and Status=0  
  and TaxableAmt>0  
  GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname  
  UNION ALL  
  SELECT  '' as StateCode,'' as StateName,'' as GSTin,'' as RetailerType,RtrCode,Rtrname,  
  S.ReturnID as RefId,ReturnCode as RefNo,ReturnDate as RefDate,R.RtrId,-1*SUM(PrdGrossAmt) as PrdGrossAmount,  
  -1*SUM(TaxableAmount),-1*SUM(PrdNetAmt) as NetAmount,  
  TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(1000)) as TaxName,  
  -1*SUM(TaxAmt) as DynamicAmt,'Return of Goods from Retailer' as TaxType,2 as SalesOrderType,  
  1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM ReturnHeader S (NOLOCK)   
  INNER JOIN ReturnProduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID  
  INNER JOIN ReturnProductTax SPT (NOLOCK) ON SPT.ReturnID=SIP.ReturnID and SPT.ReturnID=S.ReturnID and SIP.SlNo=SPT.PrdSlNo  
  INNER JOIN #RetunrTaxableAmount ST ON ST.ReturnID=SPT.ReturnID  and S.ReturnID=St.ReturnID and ST.ReturnID=SIP.ReturnID and SIP.SlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Retailer R ON R.RtrId=S.RtrId    
  WHERE ReturnDate between  @FromDate and @ToDate and Status=0  
  and TaxableAmt>0  
  GROUP BY S.ReturnID,ReturnDate,R.RtrId,TaxCode,TaxPerc,ReturnCode,SPT.TaxId,RtrCode,Rtrname  
  
  
   
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,RetailerType,RtrCode,Rtrname,  
  Refid,RefNo,RefDate,RtrId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])    
  SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],Null,0,0 as GrossAmount,0 as NetAmount,  
  Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,  
  Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM #TaxHSNSummary   
  GROUP BY Taxname,Taxper,TaxId  
    
  --select 'TTT',* from #TaxHSNSummary  
  
  
  UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,  
  B.Statename=A.StateName,  
  B.GSTIN=A.GSTIN,  
  B.RetailerType=CASE A.RetailerType WHEN 1 THEN 'Registered'  
  WHEN 2 THEN 'Unregistered' END  
  FROM DBO.FN_ReturnRetailerUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.Rtrid=B.RtrId  
    
  
  SET @DynamicLineAmountFields='0 as NetAmount,'  
  SET @DynamicLineAmountFields1='NetAmount Numeric (38,6),'  
  SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'  
    
  IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)  
  BEGIN  
   SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId  
   RETURN  
  END  
  
  DECLARE @ColSelect AS Varchar(MAX)  
  DECLARE @ColSelectDataType AS Varchar(1000)  
  DECLARE @TableCol AS Varchar(2000)  
  DECLARE @Columns1 AS Varchar(7000)  
  DECLARE @OrderBy AS VARCHAR(2000)  
  DECLARE @SumCol AS VARCHAR(MAX)  
  DECLARE @GroupByCol as VARCHAR(MAX)  
  DECLARE @PCSelect AS VARCHAR(1000)  
  SET @PCSelect=''  
  SET @ColSelect=''  
  SET @ColSelectDataType=''  
  SET @TableCol=''  
  SET @Columns1=''  
  SET @CreateTable=''  
  SET @OrderBy=''  
  SET @SumCol=''  
  SET @GroupByCol=''  
  
  CREATE TABLE #DynamicCol  
  (  
  Slno INT IDENTITY(1,1),  
  Taxname NVarchar(500),  
  TaxId INT,  
  TaxPer Numeric(12,2),  
  TaxFlag TinyInt    
  )  
  INSERT INTO #DynamicCol    
  SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname  
    
  
  SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno  
  SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno  
  SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)  
  SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(38,6),' FROM #DynamicCol ORDER BY Slno  
  SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno  
  --SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'  
  SET @ColSelect='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,isnull(SUM(TaxableAmount),0) as TaxableAmount,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'  
  SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'  
  SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+  
  'StateCode NVarchar(500),  
  StateName NVarchar(500),  
  GSTin NVarchar(500),  
  RetailerType NVarchar(500),  
  RtrId INT,  
  RtrCode NVarchar(500),  
  Rtrname NVarchar(500),    
  Refid BIGINT,  
  RefNo NVarchar(500),  
  RefDate DateTime,   
  TaxType NVarchar(500),   
  SalesOrderType TinyInt,  
  TaxableAmount Numeric(38,6),'  
  
  SET @Columns1='SELECT StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,TaxType,SalesOrderType,TaxableAmount,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'  
  SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'  
  SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptOutputSaleTaxGST'' and XTYPE=''U'')'+  
  ' DROP TABLE RptOutputSaleTaxGST'+  
  ' CREATE TABLE RptOutputSaleTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] NVarchar(500),Grouptype TINYINT,UsrId INT)'  
  PRINT @CreateTable  
  EXEC(@CreateTable)  
  SET @SQL=' INSERT INTO RptOutputSaleTaxGST '+ @ColSelect+ ' FROM'+  
  '('+@Columns1+  
  ') PS'+  
  ' PIVOT'+  
  '('+  
  ' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+  
  ')PVTTax '+@GroupByCol+ @OrderBy  
  PRINT @SQL  
  EXEC(@SQL)  
    
  --EXEC Proc_RptOutputSaleTaxGST 404,1,0,'GSTTAX',0,0,1  
  SELECT DISTINCT  
  StateCode,StateName,GSTin,RetailerType,RtrId,RtrCode,Rtrname,Refid,RefNo,RefDate,  
  TaxableAmount,  
  NetAmount  
  INTO #LineLevelGross  
  FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0  
  
  SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,  
  SUM(TaxableAmount) as TaxableAmount,  
  SUM(NetAmount) as NetAmount  
  INTO #GrandTotal  
  FROM #LineLevelGross   
  UPDATE Y SET    
  Y.TaxableAmount=X.TaxableAmount ,  
  Y.NetAmount=X.NetAmount  
  FROM RptOutputSaleTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]  
  AND X.GroupType=Y.GroupType   
    
  
   DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId  
   INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,  
   FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,  
   RoundOff,CreatedDate)  
   SELECT 1,404,'Output Tax Summary',1,'StateCode',20,1,0,1,1,'Retailer','State','Code',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',2,'StateName',50,1,0,1,1,'Retailer','State','Name',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',3,'GSTin',20,1,0,1,1,'Retailer','GST Tin','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',4,'RetailerType',20,1,0,1,1,'Retailer','Type','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',5,'RtrCode',50,1,0,1,1,'Retailer','Code','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',6,'Rtrname',50,1,0,1,1,'Retailer','Name','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',7,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',8,'RefDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',9,'TaxType',75,1,0,1,1,'Sales/','Return','',0,GETDATE()  
   UNION ALL  
   SELECT 1,404,'Output Tax Summary',10,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()  
   SET @Str=''  
   SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId  
   GROUP BY ReportId  
     
   DECLARE @Caption1 as Varchar(300)  
   DECLARE @Caption2 as Varchar(300)  
   DECLARE @Caption3 as Varchar(300)  
   SET @Caption1=''  
   SET @Caption2=''  
   SET @Caption3=''  
     
   SELECT @start = 1, @end = CHARINDEX(',', @PCSelect)   
   WHILE @start < LEN(@PCSelect) + 1 BEGIN   
    IF @end = 0    
    SET @end = LEN(@PCSelect) + 1  
    SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)  
    --SELECT @Str,'T'  
    SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)  
    SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)  
    SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')  

    INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,  
    FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,  
    CreatedDate)    
    SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),  
    18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)      
    ,@Caption2,@Caption3,2,Getdate()  
    FROM Report_Template_GST WHERE RptId=@Pi_RptId  
      
    SET @start = @end + 1   
    SET @end = CHARINDEX(',', @PCSelect, @start)  
    SET @MaxId=@MaxId+1  
   END   
     
   INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,  
   FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,  
   CreatedDate)    
   SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',  
   18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()  
   FROM Report_Template_GST WHERE RptId=@Pi_RptId
     
   UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),  
   HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),  
   HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),  
   HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')  
   WHERE RptId=@Pi_RptId   
     
     
   IF NOT EXISTS(SELECT 'X' FROM RptOutputSaleTaxGST)  
   BEGIN  
    SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId  
    RETURN  
   END  
     
   SELECT * FROM RptOutputSaleTaxGST WHERE UsrId=@Pi_UsrId  
END  
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptSchemeUtilizationWithOutPrimary]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptSchemeUtilizationWithOutPrimary]
GO
--EXEC Proc_RptSchemeUtilizationWithOutPrimary 152,1,0,'',0,0,1  
CREATE PROCEDURE [dbo].[Proc_RptSchemeUtilizationWithOutPrimary]  
(  
 @Pi_RptId  INT,  
 @Pi_UsrId  INT,  
 @Pi_SnapId  INT,  
 @Pi_DbName  nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
SET NOCOUNT ON  
/*********************************  
* PROCEDURE: Proc_RptSchemeUtilizationWithOutPrimary  
* PURPOSE: Procedure To Return the Scheme Utilization for the Selected Filters  
* NOTES:  
* CREATED: Boopathy 08-08-2008  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
*  
*********************************/  
BEGIN  
 DECLARE @NewSnapId  AS INT  
 DECLARE @DBNAME  AS  nvarchar(50)  
 DECLARE @TblName  AS nvarchar(500)  
 DECLARE @TblStruct  AS nVarchar(4000)  
 DECLARE @TblFields  AS nVarchar(4000)  
 DECLARE @sSql  AS  nVarChar(4000)  
 DECLARE @ErrNo   AS INT  
 DECLARE @PurDBName AS nVarChar(50)  
 --Filter Variable  
 DECLARE @FromDate       AS  DateTime  
 DECLARE @ToDate        AS DateTime  
 DECLARE @fSchId        AS Int  
 DECLARE @fSMId        AS Int  
 DECLARE @fRMId        AS  Int  
 DECLARE @CtgLevelId      AS    INT  
 DECLARE @CtgMainId  AS    INT  
 DECLARE @RtrClassId       AS    INT  
 DECLARE @fRtrId        AS INT  
 DECLARE @TempData TABLE  
 (   
  SchId Int,  
  RtrCnt Int,  
  BillCnt Int  
 )  
 --Till Here  
 --Assgin Value for the Filter Variable  
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)  
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)  
 SET @fSchId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))  
 SET @fSMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))  
 SET @fRMId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))  
 SET @fRtrId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))  
 --Till Here  
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)  
 Create TABLE #RptSchemeUtilization  
 (  
  SchId  Int,  
  SchCode  nVarChar(100),  
  SchDesc  nVarChar(100),  
  SlabId  nVarChar(10),  
  BaseQty  INT,  
  SchemeBudget Numeric(38,6),  
  BudgetUtilized Numeric(38,6),  
  NoOfRetailer Int,  
  NoOfBills Int,  
  UnselectedCnt Int,  
  FlatAmount Numeric(38,6),  
  DiscountPer Numeric(38,6),  
  Points  Int,  
  FreePrdName nVarchar(50),  
  FreeQty  Int,  
  FreeValue Numeric(38,6),  
  Total  Numeric(38,6),  
  Type  INT,
  GSTTax  Numeric(38,6)
 )  
 SET @TblName = 'RptSchemeUtilization'  
 SET @TblStruct = ' SchId  Int,  
    SchCode  nVarChar(100),  
    SchDesc  nVarChar(100),  
    SlabId  nVarChar(10),  
    BaseQty  INT,  
    SchemeBudget Numeric(38,6),  
    BudgetUtilized Numeric(38,6),  
    NoOfRetailer Int,  
    NoOfBills Int,  
    UnselectedCnt Int,  
    FlatAmount Numeric(38,6),  
    DiscountPer Numeric(38,6),  
    Points  Int,  
    FreePrdName nVarchar(50),  
    FreeQty  Int,  
    FreeValue Numeric(38,6),  
    Total  Numeric(38,6),  
    Type  INT,
    GSTTax  Numeric(38,6)'  
 SET @TblFields = 'SchId,SchCode,SchDesc,SlabId,BaseQty,SchemeBudget,BudgetUtilized,NoOfRetailer,  
  NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,Total,Type,GSTTax'  
 IF @Pi_GetFromSnap = 1  
 BEGIN  
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId  
  SET @DBNAME = @DBNAME  
 END  
 ELSE  
 BEGIN  
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3  
  SET @DBNAME = @PI_DBNAME + @DBNAME  
 END  
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data  
 BEGIN  
  EXEC Proc_SchemeUtilization @Pi_RptId,@Pi_UsrId  
  DELETE FROM RtpSchemeWithOutPrimary WHERE PrdId=0 AND Type<>4  
  UPDATE RtpSchemeWithOutPrimary SET selected=0,SlabId=0  
  INSERT INTO #RptSchemeUtilization(SchId,SchCode,SchDesc,SlabId,BaseQty,SchemeBudget,BudgetUtilized,NoOfRetailer,  
  NoOfBills,UnselectedCnt,FlatAmount,DiscountPer,Points,FreePrdName,FreeQty,FreeValue,Total,Type,GSTTax)  
  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.BaseQty,B.SchemeBudget,ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),Count(Distinct B.RtrId),  
  Count(Distinct B.ReferNo),1 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId) as DiscountPer, 
  ISNULL(SUM(Points),0) as Points,'' AS FreePrdName,0 AS FreeQty,0 AS FreeValue,  
  ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),B.Type,CS.GSTTax   
  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
  INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode  
  WHERE ReferDate Between @FromDate AND @ToDate  AND 
  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=1  
  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,B.BaseQty,B.Type,CS.GSTTax 
  UNION   
  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,0,B.SchemeBudget,0,0,  
  0,0 as UnSelectedCnt,0 as FlatAmount,0 as DiscountPer,  
  ISNULL(SUM(Points),0) as Points,  
  CASE ISNULL(SUM(FreeQty),0) WHEN 0 THEN '' ELSE FreePrdName END AS FreePrdName,  
  ISNULL(SUM(FreeQty),0) as FreeQty,ISNULL(SUM(FreeValue),0) as FreeValue,  
  ISNULL(SUM(FreeValue),0),B.Type,CS.GSTTax
  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId 
  INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode  
  WHERE ReferDate Between @FromDate AND @ToDate  AND  
  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=2  
  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,FreePrdName,B.Type,CS.GSTTax
  UNION  
  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,0,B.SchemeBudget,0,0,  
  0,0 as UnSelectedCnt,0 as FlatAmount,0 as DiscountPer,  
  0 as Points,CASE ISNULL(SUM(GiftValue),0) WHEN 0 THEN '' ELSE GiftPrdName END AS FreePrdName,  
  ISNULL(SUM(GiftQty),0) as FreeQty,ISNULL(SUM(GiftValue),0) as FreeValue,  
  ISNULL(SUM(GiftValue),0),B.Type,CS.GSTTax  
  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
  INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode 
  WHERE ReferDate Between @FromDate AND @ToDate  AND  
  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=3  
  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,GiftPrdName,B.Type,CS.GSTTax  
  --->Added By Nanda on 09/02/2011  
  UNION   
  SELECT A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.BaseQty,B.SchemeBudget,ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),Count(Distinct B.RtrId),  
  Count(Distinct B.ReferNo),1 as UnSelectedCnt,dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId) as FlatAmount,  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId) as DiscountPer,  
  ISNULL(SUM(Points),0) as Points,'' AS FreePrdName,0 AS FreeQty,0 AS FreeValue,  
  ISNULL(dbo.Fn_ConvertCurrency(ISNULL(SUM(FlatAmount),0),@Pi_CurrencyId)+  
  dbo.Fn_ConvertCurrency(ISNULL(SUM(DiscountPer),0),@Pi_CurrencyId),0),B.Type,CS.GSTTax  
  FROM SchemeMaster A INNER JOIN RtpSchemeWithOutPrimary B On A.SchId= B.SchId  
  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
  INNER JOIN ClaimSheetDetail CS ON A.SchCode=CS.RefCode 
  WHERE ReferDate Between @FromDate AND @ToDate  AND  
  (A.SchId = (CASE @fSchId WHEN 0 THEN A.SchId Else 0 END) OR  
  A.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND  
  B.LineType <> 3 AND B.Userid = @Pi_UsrId AND B.Type=4  
  GROUP BY A.SchId,A.SchCode,A.SchDsc,B.SlabId,B.SchemeBudget,B.BudgetUtilized,B.BaseQty,B.Type,CS.GSTTax
  --->Till Here  
  SELECT SchId, CASE LineType WHEN 1 THEN Count(Distinct B.RtrId)  
  ELSE Count(Distinct B.RtrId)*-1 END AS RtrCnt , CASE LineType WHEN 1 THEN Count(Distinct ReferNo)  
  ELSE Count(Distinct ReferNo)*-1 END AS BillCnt  
  INTO #TmpCnt FROM RtpSchemeWithOutPrimary B  
  WHERE ReferDate Between @FromDate AND @ToDate  AND B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId AND  
  (B.SchId = (CASE @fSchId WHEN 0 THEN B.SchId Else 0 END) OR  
  B.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId))) AND --B.LineType = 2 AND  
  B.Userid = @Pi_UsrId AND B.RptId=@Pi_RptId  
  GROUP BY B.SchId,LineType  
  DELETE FROM @TempData  
  INSERT INTO @TempData(SchId,RtrCnt,BillCnt)  
  SELECT SchId, SUM(RtrCnt),SUM(BillCnt) FROM #TmpCnt  
  WHERE (SchId = (CASE @fSchId WHEN 0 THEN SchId Else 0 END) OR  
  SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId)))   
  GROUP BY SchId  
  UPDATE #RptSchemeUtilization SET NoOfRetailer = NoOfRetailer - CASE  WHEN RtrCnt <0 THEN RtrCnt ELSE 0 END,  
  NoOfBills = BillCnt FROM @TempData B WHERE B.SchId = #RptSchemeUtilization.SchId  
  --->Added By Nanda on 09/02/2011  
  DECLARE @SchIId INT  
  CREATE TABLE #SchemeProducts1  
  (  
   SchID INT,  
   PrdID INT  
  )  
  DECLARE Cur_SchPrd CURSOR FOR  
  SELECT SchId FROM #RptSchemeUtilization  
  OPEN Cur_SchPrd    
  FETCH NEXT FROM Cur_SchPrd INTO @SchIId  
  WHILE @@FETCH_STATUS=0    
  BEGIN    
   INSERT INTO #SchemeProducts1    
   SELECT @SchIId,PrdId FROM Fn_ReturnSchemeProductBatch(@SchIId)  
   FETCH NEXT FROM Cur_SchPrd INTO @SchIId  
  END    
  CLOSE Cur_SchPrd    
  DEALLOCATE Cur_SchPrd    
  SELECT DISTINCT * INTO #SchemeProducts FROM #SchemeProducts1  
  --->Till Here  
  SELECT SchId,PrdId,SUM(BaseQty) AS BaseQty INTO #TmpFinal FROM  
  (SELECT C.SchId,A.PrdId, A.BaseQty-ReturnedQty AS BaseQty  FROM SalesInvoice D   
  INNER JOIN SalesInvoiceProduct A ON A.SalId=D.SalId  
  INNER JOIN SalesInvoiceSchemeHd C ON A.SalId=C.SalId  
  INNER JOIN #SchemeProducts E ON E.SchId =C.SchId AND A.PrdId=E.PrdId  
  WHERE D.Dlvsts >3 AND SalInvDate Between @FromDate AND @ToDate  AND  
  (C.SchId = (CASE @fSchId WHEN 0 THEN C.SchId Else 0 END) OR  
  C.SchId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,8,@Pi_UsrId)))   
  ) tmp  
  GROUP BY SchId,PrdId   
  SELECT SchId,SUM(BaseQty) As BaseQty INTO #TempFinal1 FROM #TmpFinal   
  GROUP BY #TmpFinal.SchId  
   UPDATE #RptSchemeUtilization SET BaseQty = A.BaseQty FROM #TempFinal1 A   
   WHERE A.SchId = #RptSchemeUtilization.SchId AND #RptSchemeUtilization.Type in (1,2)  
  UPDATE #RptSchemeUtilization SET NoOfRetailer=0 WHERE NoOfRetailer<0  
  IF LEN(@PurDBName) > 0  
  BEGIN  
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT  
     
   SET @SSQL = 'INSERT INTO #RptSchemeUtilization ' +  
    '(' + @TblFields + ')' +  
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName +  
    ' WHERE ReferDate Between ''' + @FromDate + ''' AND ''' + @ToDate + '''AND '+  
    ' (SchId = (CASE ' + CAST(@fSchId AS nVarchar(10)) + ' WHEN 0 THEN SchId Else 0 END) OR ' +  
    ' SchId in (SELECT iCountid from Fn_ReturnRptFilters(' +  
    CAST(@Pi_RptId AS nVarchar(10)) + ',8,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'  
   EXEC (@SSQL)  
   PRINT 'Retrived Data From Purged Table'  
  END  
  IF @Pi_SnapRequired = 1  
  BEGIN  
   SELECT @NewSnapId = @Pi_SnapId  
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
   IF @ErrNo = 0  
   BEGIN  
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +  
    '(SnapId,UserId,RptId,' + @TblFields + ')' +  
    ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
    ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptSchemeUtilization'  
    EXEC (@SSQL)  
    PRINT 'Saved Data Into SnapShot Table'  
   END  
  END  
 END  
 ELSE    --To Retrieve Data From Snap Data  
 BEGIN  
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,  
  @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT  
    
  IF @ErrNo = 0  
  BEGIN  
   SET @SSQL = 'INSERT INTO #RptSchemeUtilization ' +  
   '(' + @TblFields + ')' +  
   ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +  
   ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +  
   ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +  
   ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))  
   EXEC (@SSQL)  
  PRINT 'Retrived Data From Snap Shot Table'  
  END  
  ELSE  
  BEGIN  
   PRINT 'DataBase or Table not Found'
  END  
 END  
 --Check for Report Data  
 Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId  
 INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)  
 SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptSchemeUtilization  
 UPDATE RPT SET RPT.SchCode=S.CmpSchCode,SchemeBudget=TotalSpent,BudgetUtilized=CS.ClmAmount,DiscountPer=Discount,Total=TotalSpent FROM #RptSchemeUtilization RPT INNER JOIN SchemeMaster S ON RPT.SchId=S.SchId  
 INNER JOIN ClaimSheetDetail CS ON S.SchCode=CS.RefCode 

 --update A set SchemeBudget=SchemeBudget+ GSTtax from #RptSchemeUtilization A 

 DELETE FROM #RptSchemeUtilization WHERE BaseQty=0 AND SchemeBudget=0 AND BudgetUtilized=0 AND FlatAmount=0 AND DiscountPer=0 AND Points=0 AND FreeQty=0 AND FreeValue=0 AND Total=0  
 SELECT SchId,SchCode,SchDesc,SlabId,SUM(BaseQty) AS BaseQty,SchemeBudget,BudgetUtilized,NoOfRetailer,  
 NoOfBills,UnselectedCnt,SUM(FlatAmount) AS FlatAmount,SUM(DiscountPer)+GSTTax AS DiscountPer,Points,  
 FreePrdName,SUM(FreeQty) AS FreeQty,SUM(FreeValue) AS FreeValue,SUM(Total)+GSTTax  AS Total FROM #RptSchemeUtilization  
 GROUP BY SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,  
 NoOfBills,UnselectedCnt,Points,FreePrdName,GSTTax  
 --select 'A',* from #RptSchemeUtilization
 --return 
 IF EXISTS (SELECT Flag FROM RptExcelFlag WITH(NOLOCK) WHERE RptID=@Pi_RptID AND UsrId=@Pi_UsrId AND Flag=1)  
 BEGIN  
  IF EXISTS (SELECT * FROM dbo.sysobjects where id = object_id(N'[RptSchemeUtilizationWithOutPrimary_Excel]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  
  DROP TABLE RptSchemeUtilizationWithOutPrimary_Excel  
  SELECT SchId,SchCode,SchDesc,SlabId,SUM(BaseQty) AS BaseQty,SchemeBudget,NoOfBills,NoOfRetailer,BudgetUtilized,  
  UnselectedCnt,SUM(FlatAmount) AS FlatAmount,SUM(DiscountPer) AS DiscountPer,Points,  
  FreePrdName,SUM(FreeQty) AS FreeQty,SUM(FreeValue) AS FreeValue,SUM(Total) AS Total    
  INTO RptSchemeUtilizationWithOutPrimary_Excel FROM #RptSchemeUtilization   
  GROUP BY SchId,SchCode,SchDesc,SlabId,SchemeBudget,BudgetUtilized,NoOfRetailer,  
  NoOfBills,UnselectedCnt,Points,FreePrdName  
 END   
 RETURN  
END 
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_PurchaseReceipt]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_PurchaseReceipt]
GO
/*    
BEGIN TRANSACTION    
EXEC Proc_Cn2Cs_PurchaseReceipt 0 
select *from ETLTempPurchaseReceipt WHERE DownLoadStatus=0
select *from etltemppurchasereceiptproduct where cmpinvno in(SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=0)
ROLLBACK TRANSACTION    
*/    
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_PurchaseReceipt]  
(    
 @Po_ErrNo INT OUTPUT    
)    
AS    
/***********************************************************    
* PROCEDURE : Proc_Cn2Cs_PurchaseReceipt    
* PURPOSE : To Insert the records FROM Console into Temp Tables    
* SCREEN : Console Integration-PurchaseReceipt    
* CREATED BY: Nandakumar R.G On 03-05-2010    
* MODIFIED :    
* DATE      AUTHOR     DESCRIPTION    
14/08/2013 Murugan.R Logistic Material Management    
* {date} {developer}  {brief modIFication description}    
*************************************************************/    
SET NOCOUNT ON    
BEGIN    
 -- For Clearing the Prking/Temp Table -----     
 ----------------> Added by Lakshman M on 26/09/2017  <-------------------
 DECLARE @FROMDATE AS Datetime
 DECLARE @TodayDt AS datetime
 
 SELECT @FROMDATE = cast(DATEADD(DAY, -31, GETDATE()) AS DATETIME)
 SELECT @FROMDATE=CONVERT(VARCHAR(11), @FROMDATE, 121)

 SELECT @TodayDt= CAST(convert(varchar,getdate()) AS DATETIME)
 SELECT @TodayDt=CONVERT(VARCHAR(11), @TodayDt, 121)

 SELECT * INTO #ETLTempPurchaseReceipt_temp FROM ETLTempPurchaseReceipt WHERE InvDate between CONVERT(VARCHAR(11), @FROMDATE, 121) and CONVERT(VARCHAR(11), @TodayDt, 121)
 UPDATE A SET A.downloadstatus = 0 FROM ETLTempPurchaseReceipt A INNER JOIN #ETLTempPurchaseReceipt_temp B ON A.CmpInvNo =B.CmpInvNo 
 UPDATE A SET A.downloadstatus = 1 FROM ETLTempPurchaseReceipt A INNER JOIN purchasereceipt B ON A.CmpInvNo =B.CmpInvNo 
---------------->  Till Here  <----------------------
 DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptClaimScheme WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM ETLTempPurchaseReceiptPrdLineDt WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceiptProduct WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
    DELETE FROM ETLTempPurchaseReceiptOtherCharges WHERE CmpInvNo in    
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)     
 DELETE FROM Etl_LogisticMaterialStock WHERE InvoiceNumber IN     
 (SELECT CmpInvNo FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1)    
 DELETE FROM ETLTempPurchaseReceipt  WHERE DownLoadStatus=1    
 DELETE FROM ETLTempPurchaseReceiptCrDbAdjustments WHERE CmpInvNo     
 IN (SELECT CmpInvNo FROM PurchaseReceipt WHERE Status = 1) AND DownloadStatus = 1    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
 TRUNCATE TABLE ETL_Prk_PurchaseReceiptClaim    
 TRUNCATE TABLE ETL_Prk_PurchaseReceipt    
    TRUNCATE TABLE ETLTempPurchaseReceiptPrdLineDt    
    TRUNCATE TABLE ETL_Prk_PurchaseReceiptPrdDt    
    TRUNCATE TABLE ETL_Prk_PurchaseReceiptOtherCharges    
    TRUNCATE TABLE ETL_Prk_PurchaseReceiptCrDbAdjustments    
 --------------------------------------    
 DECLARE @ErrStatus   INT    
 DECLARE @BatchNo   NVARCHAR(200)    
 DECLARE @ProductCode  NVARCHAR(100)    
 DECLARE @ListPrice   NUMERIC(38,6)    
 DECLARE @FreeSchemeFlag  NVARCHAR(5)    
 DECLARE @CompInvNo   NVARCHAR(25)    
 DECLARE @UOMCode   NVARCHAR(25)    
 DECLARE @Qty    INT    
 DECLARE @PurchaseDiscount NUMERIC(38,6)    
 DECLARE @VATTaxValue  NUMERIC(38,6)    
 DECLARE @SchemeRefrNo  NVARCHAR(25)    
 DECLARE @SupplierCode  NVARCHAR(30)    
 DECLARE @TransporterCode NVARCHAR(30)    
 DECLARE @POUOM    INT    
 DECLARE @RowId    INT    
 DECLARE @LineLvlAmt   NUMERIC(38,6)    
 DECLARE @QtyInKg   NUMERIC(38,6)    
 DECLARE @ExistCompInvNo  NVARCHAR(25)    
 DECLARE @FreightCharges  NUMERIC(38,6)    
 SET @RowId=1    
 --->Added By Nanda on 17/09/2009    
 IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'InvToAvoid')    
 AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)    
 BEGIN    
  DROP TABLE InvToAvoid     
 END    
 CREATE TABLE InvToAvoid    
 (    
  CmpInvNo NVARCHAR(50)    
 )    
 IF EXISTS (SELECT DISTINCT CompInvNo,SupplierCode FROM Cn2Cs_Prk_BLPurchaseReceipt  
 WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST'))  
 BEGIN  
  INSERT INTO InvToAvoid (CmpInvNo)  
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
    
  INSERT INTO ErrorLog (SlNo,TableName,FieldName,ErrDesc)  
  SELECT DISTINCT 1,'Purchase Receipt','Tax Type','Purchase Tax Type should be VAT or GST '+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt  
  WHERE UPPER(ISNULL(TaxType,'VAT')) NOT IN ('VAT','GST')  
 END  
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already Available' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM PurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','CmpInvNo','Company Invoice No:'+CompInvNo+' already downloaded and ready for invoicing' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvNo IN (SELECT CmpInvNo FROM ETLTempPurchaseReceipt)    
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product','Product:'+ProductCode+' Not Available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product',ProductCode,'','N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode NOT IN (SELECT PrdCCode FROM Product)    
  --->Till Here        
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE ProductCode+'~'+BatchNo    
 NOT IN    
 (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId))    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Product Batch','Product Batch:'+BatchNo+'Not Available for Product:'+ProductCode+' in Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN    
  (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Added By Nanda on 05/05/2010    
  INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)    
  SELECT DISTINCT DistCode,'Purchase',CompInvNo,'Product Batch',ProductCode,BatchNo,'N' FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE ProductCode+'~'+BatchNo    
  NOT IN (SELECT P.PrdCCode+'~'+PB.PrdBatCode FROM Product P,ProductBatch PB WHERE P.PrdId=PB.PrdId)    
  --->Till Here    
 END    
 --Supplier Credit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
    SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'CreditNoteSupplier','PostedRefNo','Supplier Credit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM CreditNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Credit'      
 END    
 --Supplier Debit Note Validations     
 IF EXISTS(SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
 (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit')    
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
        SELECT DISTINCT [CompInvNo] FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN    
    (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'DebitNoteSupplier','PostedRefNo','Supplier Debit Note Not Available'+[CompInvNo]    
  FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WHERE [RefNo] NOT IN     
  (SELECT DISTINCT PostedRefNo FROM DebitNoteSupplier WITH (NOLOCK)) AND [AdjType] = 'Debit'      
 END    
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE CompInvDate>GETDATE())     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE CompInvDate>GETDATE()    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Date','Invoice Date:'+CAST(CompInvDate AS NVARCHAR(10))+' is greater than current date in Invoice:'+CompInvNo     
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE CompInvDate>GETDATE()    
 END    
 --Commented and Added By Mohana.S PMS NO: DCRSTKAL0012    
 --IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 --WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK)))     
 --BEGIN    
 -- INSERT INTO InvToAvoid(CmpInvNo)    
 -- SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 -- INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
 -- SELECT DISTINCT 1,'Purchase Receipt','Invoice UOM','UOM:'+UOMCode+' is not available for Invoice:'+CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 -- WHERE UOMCode NOT IN (SELECT UOMCode FROM UOMMaster WITH (NOLOCK))    
 --END    
 IF EXISTS (SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
 FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId))    
 BEGIN    
   INSERT INTO InvToAvoid(CmpInvNo)    
   SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
   INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
   SELECT DISTINCT 1,'Purchase Receipt',PRODUCTCODE+'Product UOM','UOMCode:'+UOMCode+' is not available for Invoice:'+CompInvNo     
   FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE PRODUCTCODE+'~'+UomCode  NOT IN (SELECT PrdCCode+'~'+UomCode      
   FROM UomGroup UG INNER JOIN UomMaster UM ON UG.UomId =UM.UomId INNER JOIN Product P ON P.UomGroupId = UG.UomGroupId)    
 END     
 IF EXISTS(SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
 WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK)))     
 BEGIN    
  INSERT INTO InvToAvoid(CmpInvNo)    
  SELECT DISTINCT CompInvNo FROM Cn2Cs_Prk_BLPurchaseReceipt    
  WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
  INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)    
  SELECT DISTINCT 1,'Purchase Receipt','Invoice Supplier','Supplier:'+SupplierCode+' is not available for Invoice:'+CompInvNo    
  FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK) WHERE SupplierCode NOT IN (SELECT SpmCode FROM Supplier WITH (NOLOCK))    
 END     
 --->Till Here    
 -- Eliminated Duplicate records insertion on 02/03/2015  
 SET @ExistCompInvNo=0    
 DECLARE Cur_Purchase CURSOR    
 FOR    
 SELECT DISTINCT ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,CompInvNo,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,0 AS BundleDeal,    
 ISNULL(FreightCharges,0) AS FreightCharges    
 FROM Cn2Cs_Prk_BLPurchaseReceipt WHERE [DownLoadFlag]='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)    
 ORDER BY CompInvNo,ProductCode,BatchNo,ListPriceNSP,    
 FreeSchemeFlag,UOMCode,PurQty,PurchaseDiscount,VATTaxValue,SchemeRefrNo,LineLevelAmount,CashDiscRs,FreightCharges    
 OPEN Cur_Purchase    
 FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
 @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
 @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges     
 WHILE @@FETCH_STATUS = 0    
 BEGIN    
--  IF @ExistCompInvNo<>@CompInvNo    
--  BEGIN    
--   SET @ExistCompInvNo=@CompInvNo    
--   SET @RowId=2    
--  END    
  --To insert into ETL_Prk_PurchaseReceiptPrdDt    
  IF(@FreeSchemeFlag='0')    
  BEGIN    
   INSERT INTO  ETL_Prk_PurchaseReceiptPrdDt([Company Invoice No],[RowId],[Product Code],[Batch Code],    
   [PO UOM],[PO Qty],[UOM],[Invoice Qty],[Purchase Rate],[Gross],[Discount In Amount],[Tax In Amount],[Net Amount],FreightCharges)    
   VALUES(@CompInvNo,@RowId,@ProductCode,@BatchNo,'',0,@UOMCode,@Qty,@ListPrice,@LineLvlAmt,    
   @PurchaseDiscount,@VATTaxValue,(@ListPrice-@PurchaseDiscount+@VATTaxValue)* @Qty,@FreightCharges)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'C',@PurchaseDiscount)    
   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
   VALUES(@CompInvNo,@RowId,'D',@VATTaxValue)    
--   INSERT INTO ETL_Prk_PurchaseReceiptPrdLineDt([Company Invoice No],[RowId],[Column Code],[Value In Amount])    
--   VALUES(@CompInvNo,@RowId,'E',@QtyInKg)    
  END    
  --To insert into ETL_Prk_PurchaseReceiptClaim    
  IF(@FreeSchemeFlag='1')    
  BEGIN    
   INSERT INTO ETL_Prk_PurchaseReceiptClaim([Company Invoice No],[Type],[Ref No],[Product Code],    
   [Batch Code],[Qty],[Stock Type],[Amount],FreightAmt)    
   VALUES(@CompInvNo,'Offer',@SchemeRefrNo,@ProductCode,@BatchNo,@Qty,'Offer',0,@FreightCharges)    
  END    
--  SET @RowId=@RowId+1    
  FETCH NEXT FROM Cur_Purchase INTO @ProductCode,@BatchNo,@ListPrice,    
  @FreeSchemeFlag,@CompInvNo,@UOMCode,@Qty,    
  @PurchaseDiscount,@VATTaxValue,@SchemeRefrNo,@LineLvlAmt,@QtyInKg,@RowId,@FreightCharges    
 END    
 CLOSE Cur_Purchase    
 DEALLOCATE Cur_Purchase    
 --To insert into ETL_Prk_PurchaseReceipt    
 SELECT @TransporterCode=TransporterCode FROM Transporter    
 WHERE TransporterId IN(SELECT MIN(TransporterId) FROM Transporter WITH(NOLOCK))    
 IF @TransporterCode=''    
 BEGIN    
  INSERT INTO Errorlog VALUES (1,'Purchase Download','Transporter','Transporter not available')    
 END    
 INSERT INTO ETL_Prk_PurchaseReceipt([Company Code],[Supplier Code],[Company Invoice No],[PO Number],  
 [Invoice Date],[Transporter Code],[NetPayable Amount],[TaxType])  
 SELECT DISTINCT C.CmpCode,SupplierCode,P.CompInvNo,'',P.CompInvDate,@TransporterCode,P.NetValue,  
 P.TaxType  
 FROM Company C,Cn2Cs_Prk_BLPurchaseReceipt P  
 WHERE  C.DefaultCompany=1 AND DownLoadFlag='D' AND CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid)  
 UPDATE A SET [TaxType]='VAT' FROM ETL_Prk_PurchaseReceipt A (NOLOCK)   
 INNER JOIN Cn2Cs_Prk_BLPurchaseReceipt B (NOLOCK) ON B.CompInvNo=A.[Company Invoice No]   
 AND A.[Supplier Code]=B.SupplierCode WHERE ISNULL(A.TaxType,'')=''  
   
 --Added By Sathishkumar Veeramani 2013/08/13    
 --INSERT INTO ETL_Prk_PurchaseReceiptOtherCharges ([Company Invoice No],[OC Description],Amount)    
 --SELECT DISTINCT CompInvNo,'Cash Discounts' AS [OC Description],CashDiscRs FROM Cn2Cs_Prk_BLPurchaseReceipt WITH (NOLOCK)    
 --WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 --Added by Sathishkumar Veeramani 2013/11/22    
 INSERT INTO ETL_Prk_PurchaseReceiptCrDbAdjustments([Company Invoice No],[Adjustment Type],[Ref No],[Amount])    
 SELECT DISTINCT CompInvNo,AdjType,RefNo,Amount FROM Cn2Cs_Prk_PurchaseReceiptAdjustments WITH (NOLOCK)    
 WHERE CompInvNo NOT IN(SELECT CmpInvNo FROM InvToAvoid) AND DownLoadFlag='D'    
 EXEC Proc_Validate_PurchaseReceipt @Po_ErrNo= @ErrStatus OUTPUT    
 IF @ErrStatus =0    
 BEGIN    
  EXEC Proc_Validate_PurchaseReceiptProduct @Po_ErrNo= @ErrStatus OUTPUT    
  IF @ErrStatus =0    
  BEGIN    
   EXEC Proc_Validate_PurchaseReceiptLineDt @Po_ErrNo= @ErrStatus OUTPUT    
   IF @ErrStatus =0    
   BEGIN    
    EXEC Proc_Validate_PurchaseReceiptClaimScheme @Po_ErrNo= @ErrStatus OUTPUT    
    IF @ErrStatus =0    
    BEGIN    
       EXEC Proc_Validate_PurchaseReceiptOtherCharges @Po_ErrNo= @ErrStatus OUTPUT    
       IF @ErrStatus =0    
       BEGIN    
           EXEC Proc_Validate_PurchaseReceiptCrDbAdjustments @Po_ErrNo= @ErrStatus OUTPUT    
           IF @ErrStatus =0    
           BEGIN    
            SET @ErrStatus=@ErrStatus    
        END        
       END        
    END    
   END    
  END    
 END    
 --Proc_Validate_PurchaseReceiptCrDbAdjustments    
 --->Added By Nanda on 17/09/2009    
 DELETE FROM ETLTempPurchaseReceipt WHERE CmpInvNo NOT IN    
 (SELECT DISTINCT CmpInvNo FROM ETLTempPurchaseReceiptProduct)    
 UPDATE Cn2Cs_Prk_BLPurchaseReceipt SET DownLoadFlag='Y'    
 WHERE CompInvNo IN (SELECT DISTINCT CmpInvNo FROM EtlTempPurchaseReceipt)    
 --->Till Here    
 SET @Po_ErrNo= @ErrStatus    
 RETURN    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptGSTR1Extract]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptGSTR1Extract]
GO
/*    
BEGIN tran    
EXEC Proc_RptGSTR1Extract 424,2,0,'GSTR1Report',0,0,1    
Select * from RptInputtaxCreditGST    
select *from Report_txt_PageHeader_GST  
ROLLBACK tran     
*/    
CREATE PROCEDURE [dbo].[Proc_RptGSTR1Extract]    
(    
 @Pi_RptId   INT,    
 @Pi_UsrId   INT,    
 @Pi_SnapId   INT,    
 @Pi_DbName   nvarchar(50),    
 @Pi_SnapRequired INT,    
 @Pi_GetFromSnap  INT,    
 @Pi_CurrencyId  INT    
)    
AS    
/*********************************    
* PROCEDURE : Proc_RptGSTR1Extract    
* PURPOSE : To get the Input Tax    
* CREATED : Murugan.R    
* CREATED DATE : 25/08/2017    
* MODIFIED    
* DATE      AUTHOR     DESCRIPTION    
------------------------------------------------    
* {date} {developer}  {brief modification description}    
*********************************/    
BEGIN    
SET NOCOUNT ON    
      
 DELETE FROM  ReportFilterDt WHERE RptId IN(414,415,416,417,418,419,420,421)    
 INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)    
 SELECT 414,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 415,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 416,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 417,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 418,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId     
 UNION ALL    
 SELECT 419,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 420,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT 421,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate    
 FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
     
 DELETE FROM Report_txt_PageHeader_GST WHERE RptId IN(414,415,416,417,418,419,420,421)    
 INSERT INTO Report_txt_PageHeader_GST(ColId,RptId,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId)    
 SELECT ColId,414,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,415,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,416,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,417,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,418,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,419,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,420,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
 UNION ALL    
 SELECT ColId,421,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId    
 FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId    
--------------------- Modified by Lakshman M on 03/10/2017-------------------------------
 EXEC Proc_RptGSTR1_B2CS 416 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId        
 EXEC Proc_RptGSTR1_HSNCODE 419 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId      
 EXEC Proc_RptGSTR1_B2B 414,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId  
 EXEC Proc_RptGSTR1_B2CL 415,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId    
 EXEC Proc_RptGSTRTRANS1_CDNR 417 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId    
 EXEC Proc_RptGSTRTRANS1_CDNUR 418 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId    
 EXEC Proc_RptGSTR1_Docs 420 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId    
 EXEC Proc_RptFORMGSTR1_Exempt 421 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId   
 -------------------- Till here  ------------------------
 
 SELECT * FROM RptGSTR1_B2B WHERE UsrId=@Pi_UsrId    
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2B2B' and RptId=425
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',425,'FORMGSTR2B2B','FORM GSTR2-B2B',1
GO
DELETE FROM RptHeader WHERE RptId=425
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2B2B','FORM GSTR2-B2B',425,'FORM GSTR2-B2B','Proc_RptGSTR2_B2B','RptGSTR2_B2B','RptGSTR2_B2B.rpt',0
GO
DELETE FROM RptDetails where RPTID=425
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (425,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (425,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=425
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 425,208,1,'January' UNION
SELECT 425,208,2,'February' UNION
SELECT 425,208,3,'March' UNION
SELECT 425,208,4,'April' UNION
SELECT 425,208,5,'May' UNION
SELECT 425,208,6,'June' UNION
SELECT 425,208,7,'July' UNION
SELECT 425,208,8,'August' UNION
SELECT 425,208,9,'September' UNION
SELECT 425,208,10,'October' UNION
SELECT 425,208,11,'November' UNION
SELECT 425,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=425
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,425,'FORM GSTR2-B2B',1,'Your GSTIN',50,1,0,1,1,'Your GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',2,'Return Period',50,1,0,1,1,'Return Period','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',3,'GSTIN of Supplier',50,1,0,1,1,'GSTIN OR UIN','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',4,'Invoice Num',20,1,0,1,1,'INVOICE NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',5,'Invoice Date',20,1,0,1,4,'INVOICE DATE','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',6,'Invoice Value',30,1,0,2,3,'INVOICE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',7,'Invoice type',20,1,0,1,1,'INVOICE TYPE','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',8,'Serial no',20,1,0,2,2,'SERIAL NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',9,'Tax Rate',20,1,0,2,3,'RATE','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',10,'Taxable value',20,1,0,2,3,'TAXABLE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',11,'IGST',20,1,0,2,3,'INTEGRATED TAX','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',12,'CGST',20,1,0,2,3,'CENTRAL TAX','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',13,'SGST',20,1,0,2,3,'STATE OR UT TAX','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',14,'CESS',20,1,0,2,3,'CESS','','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',15,'Place of supply',20,1,0,1,1,'PLACE OF SUPPLY','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',16,'Eligibility',20,1,0,1,1,'ELIGIBILITY','','',0,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',17,'ITC IGST Amt',20,1,0,2,3,'INTEGRATED ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',18,'ITC CGST Amt',20,1,0,2,3,'CENTRAL ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',19,'ITC SGST Amt',20,1,0,2,3,'STATE OR UT ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',20,'ITC Cess Amt',20,1,0,2,3,'CESS ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,425,'FORM GSTR2-B2B',21,'Reverse Charge',20,1,0,1,1,'REVERSE','CHARGE','',0,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_B2B')
BEGIN
CREATE TABLE RptGSTR2_B2B
(
[Slno]	INT IDENTITY (1,1),
[Your GSTIN]	Varchar(50),
[Return Period]	Varchar(20),
[GSTIN of Supplier]	Varchar(50),
[Invoice Num]	Varchar(50),
[Invoice Date]	DateTime,
[Invoice Value]	Numeric(32,6),
[Place of supply]	Varchar(50),
[Invoice type]	Varchar(10),
[Serial no]	INT,
[Tax Rate]	Numeric(10,2),
[Taxable value]	Numeric(32,6),
[IGST]	Numeric(32,6),
[CGST]	Numeric(32,6),
[SGST]	Numeric(32,6),
[CESS]	Numeric(32,6),
[ITC IGST Amt]	Numeric(32,6),
[ITC CGST Amt]	Numeric(32,6),
[ITC SGST Amt]	Numeric(32,6),
[ITC Cess Amt]	Numeric(32,6),
[Eligibility]	Varchar(10),
[Reverse Charge]	Varchar(10),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2B2BUR' and RptId=426
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',426,'FORMGSTR2B2BUR','FORM GSTR2-B2BUR',1
GO
DELETE FROM RptHeader WHERE RptId=426
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2B2BUR','FORM GSTR2-B2BUR',426,'FORM GSTR2-B2BUR','Proc_RptGSTR2_B2BUR','RptGSTR2_B2BUR','RptGSTR2_B2BUR.rpt',0
GO
DELETE FROM RptDetails where RPTID=426
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (426,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (426,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=426
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 426,208,1,'January' UNION
SELECT 426,208,2,'February' UNION
SELECT 426,208,3,'March' UNION
SELECT 426,208,4,'April' UNION
SELECT 426,208,5,'May' UNION
SELECT 426,208,6,'June' UNION
SELECT 426,208,7,'July' UNION
SELECT 426,208,8,'August' UNION
SELECT 426,208,9,'September' UNION
SELECT 426,208,10,'October' UNION
SELECT 426,208,11,'November' UNION
SELECT 426,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=426
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,426,'FORM GSTR2-B2B',1,'Your GSTIN',50,1,0,1,1,'Your GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',2,'Return Period',50,1,0,1,1,'Return Period','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',3,'GSTIN of Supplier',50,1,0,1,1,'GSTIN OR UIN','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',4,'Invoice Num',20,1,0,1,1,'INVOICE NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',5,'Invoice Date',20,1,0,1,4,'INVOICE DATE','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',6,'Invoice Value',30,1,0,2,3,'INVOICE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',7,'Serial no',20,1,0,2,2,'SERIAL NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',8,'Tax Rate',20,1,0,2,3,'RATE','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',9,'Taxable value',20,1,0,2,3,'TAXABLE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',10,'IGST',20,1,0,2,3,'INTEGRATED TAX','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',11,'CGST',20,1,0,2,3,'CENTRAL TAX','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',12,'SGST',20,1,0,2,3,'STATE OR UT TAX','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',13,'CESS',20,1,0,2,3,'CESS','','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',14,'Place of supply',20,1,0,1,1,'PLACE OF SUPPLY','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',15,'Eligibility',20,1,0,1,1,'ELIGIBILITY','','',0,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',16,'ITC IGST Amt',20,1,0,2,3,'INTEGRATED ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',17,'ITC CGST Amt',20,1,0,2,3,'CENTRAL ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',18,'ITC SGST Amt',20,1,0,2,3,'STATE OR UT ITC','AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,426,'FORM GSTR2-B2B',19,'ITC Cess Amt',20,1,0,2,3,'CESS ITC','AMOUNT','',2,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_B2BUR')
BEGIN
CREATE TABLE RptGSTR2_B2BUR
(
[Slno]	INT IDENTITY (1,1),
[Your GSTIN]	Varchar(50),
[Return Period]	Varchar(20),
[GSTIN of Supplier]	Varchar(50),
[Invoice Num]	Varchar(50),
[Invoice Date]	DateTime,
[Invoice Value]	Numeric(32,6),
[Place of supply]	Varchar(50),
[Serial no]	INT,
[Tax Rate]	Numeric(10,2),
[Taxable value]	Numeric(32,6),
[IGST]	Numeric(32,6),
[CGST]	Numeric(32,6),
[SGST]	Numeric(32,6),
[CESS]	Numeric(32,6),
[ITC IGST Amt]	Numeric(32,6),
[ITC CGST Amt]	Numeric(32,6),
[ITC SGST Amt]	Numeric(32,6),
[ITC Cess Amt]	Numeric(32,6),
[Eligibility]	Varchar(10),
[Reverse Charge]	Varchar(10),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2HSNSUM' and RptId=427
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',427,'FORMGSTR2HSNSUM','FORM GSTR2-HSNSUM',1
GO
DELETE FROM RptHeader WHERE RptId=427
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2HSNSUM','FORM GSTR2-HSNSUM',427,'FORM GSTR2-HSNSUM','Proc_RptGSTR2_HSNSUM','RptGSTR2_HSNSUM','RptGSTR2_HSNSUM.rpt',0
GO
DELETE FROM RptDetails where RPTID=427
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (427,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (427,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=427
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 427,208,1,'January' UNION
SELECT 427,208,2,'February' UNION
SELECT 427,208,3,'March' UNION
SELECT 427,208,4,'April' UNION
SELECT 427,208,5,'May' UNION
SELECT 427,208,6,'June' UNION
SELECT 427,208,7,'July' UNION
SELECT 427,208,8,'August' UNION
SELECT 427,208,9,'September' UNION
SELECT 427,208,10,'October' UNION
SELECT 427,208,11,'November' UNION
SELECT 427,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=427
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,427,'FORM GSTR2-HSNSUM',1,'Your GSTIN',50,1,0,1,1,'Your GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',2,'Return Period',50,1,0,1,1,'Return Period','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',3,'SERIAL NUMBER',20,1,0,2,2,'SERIAL NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',4,'HSN OR SAC CODE',20,1,0,1,1,'HSN OR SAC CODE','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',5,'DESCRIPTION',30,1,0,1,1,'DESCRIPTION','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',6,'UQC',20,1,0,2,2,'UQC','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',7,'TOTAL QUANTITY',20,1,0,2,2,'TOTAL QUANTITY','','',0,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',8,'TOTAL VALUE',20,1,0,2,3,'TOTAL VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',9,'TAXABLE VALUE',20,1,0,2,3,'TAXABLE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',10,'INTEGRATED TAX',20,1,0,2,3,'INTEGRATED TAX','','',2,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',11,'CENTRAL TAX',20,1,0,2,3,'CENTRAL TAX','','',2,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',12,'STATE OR UT TAX',20,1,0,2,3,'STATE OR UT TAX','','',2,GETDATE()
UNION ALL
SELECT 1,427,'FORM GSTR2-HSNSUM',13,'CESS',20,1,0,2,3,'CESS','','',2,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_HSNSUM')
BEGIN
CREATE TABLE RptGSTR2_HSNSUM
(
[Slno]	INT IDENTITY (1,1),
[Your GSTIN]	Varchar(50),
[Return Period]	Varchar(20),
[SERIAL NUMBER]	INT,
[HSN OR SAC CODE]	Varchar(50),
[DESCRIPTION]	Varchar(150),
[UQC]	Varchar(50),
[TOTAL QUANTITY]	BIGINT,
[TOTAL VALUE]	Numeric(32,6),
[TAXABLE VALUE]	Numeric(32,6),
[INTEGRATED TAX]	Numeric(32,6),
[CENTRAL TAX]	Numeric(32,6),
[STATE OR UT TAX]	Numeric(32,6),
[CESS]	Numeric(32,6),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2NILRATE' and RptId=428
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',428,'FORMGSTR2NILRATE','FORM GSTR2-NILRATE',1
GO
DELETE FROM RptHeader WHERE RptId=428
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2NILRATE','FORM GSTR2-NILRATE',428,'FORM GSTR2-NILRATE','Proc_RptGSTR2_NILRATE','RptGSTR2_NILRATE','RptGSTR2_NILRATE.rpt',0
GO
DELETE FROM RptDetails where RPTID=428
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (428,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (428,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=428
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 428,208,1,'January' UNION
SELECT 428,208,2,'February' UNION
SELECT 428,208,3,'March' UNION
SELECT 428,208,4,'April' UNION
SELECT 428,208,5,'May' UNION
SELECT 428,208,6,'June' UNION
SELECT 428,208,7,'July' UNION
SELECT 428,208,8,'August' UNION
SELECT 428,208,9,'September' UNION
SELECT 428,208,10,'October' UNION
SELECT 428,208,11,'November' UNION
SELECT 428,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=428
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,428,'FORM GSTR2-NILRATE',1,'Your GSTIN',50,1,0,1,1,'Your GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',2,'Return Period',50,1,0,1,1,'Return Period','','',0,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',3,'SUPPLY TYPE',20,1,0,2,2,'SUPPLY TYPE','','',0,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',4,'COMPOUNDING DEALER SUPPLIES',20,1,0,2,3,'COMPOUNDING DEALER SUPPLIES','','',2,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',5,'NIL RATED SUPPLIES',30,1,0,2,3,'NIL RATED SUPPLIES','','',2,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',6,'EXEMPTED SUPPLIES',20,1,0,2,3,'EXEMPTED SUPPLIES','','',2,GETDATE()
UNION ALL
SELECT 1,428,'FORM GSTR2-NILRATE',7,'NON-GST SUPPLIES',20,1,0,2,3,'NON-GST SUPPLIES','','',2,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_NILRATE')
BEGIN
CREATE TABLE RptGSTR2_NILRATE
(
[Slno]	INT IDENTITY (1,1),
[Your GSTIN]	Varchar(50),
[Return Period]	Varchar(20),
[SUPPLY TYPE]	varchar(50),
[COMPOUNDING DEALER SUPPLIES]	Numeric(36,6),
[NIL RATED SUPPLIES]	Numeric(36,6),
[EXEMPTED SUPPLIES]	Numeric(36,6),
[NON-GST SUPPLIES]	Numeric(36,6),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2CDN' and RptId=429
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',429,'FORMGSTR2CDN','FORM GSTR2-CDN',1
GO
DELETE FROM RptHeader WHERE RptId=429
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2CDN','FORM GSTR2-CDN',429,'FORM GSTR2-CDN','Proc_RptGSTR2_CDN','RptGSTR2_CDN','RptGSTR2_CDN.rpt',0
GO
DELETE FROM RptDetails where RPTID=429
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (429,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (429,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=429
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 429,208,1,'January' UNION
SELECT 429,208,2,'February' UNION
SELECT 429,208,3,'March' UNION
SELECT 429,208,4,'April' UNION
SELECT 429,208,5,'May' UNION
SELECT 429,208,6,'June' UNION
SELECT 429,208,7,'July' UNION
SELECT 429,208,8,'August' UNION
SELECT 429,208,9,'September' UNION
SELECT 429,208,10,'October' UNION
SELECT 429,208,11,'November' UNION
SELECT 429,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=429
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,429,'FORM GSTR2-CDN',1,'Your GSTIN',50,1,0,1,1,'Your GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',2,'Return Period',50,1,0,1,1,'Return Period','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',3,'GSTIN',20,1,0,1,1,'GSTIN','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',4,'INVOICE NUMBER',20,1,0,1,1,'INVOICE NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',5,'INVOICE DATE',30,1,0,1,4,'INVOICE DATE','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',6,'NOTE TYPE',20,1,0,1,1,'NOTE TYPE','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',7,'NOTE NUMBER',20,1,0,1,1,'NOTE NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',8,'NOTE DATE',50,1,0,1,4,'NOTE DATE','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',9,'NOTE VALUE',50,1,0,2,3,'NOTE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',10,'REASON',20,1,0,1,1,'REASON','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',11,'PRE GST REGIME',20,1,0,1,1,'PRE GST REGIME','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',12,'SERIAL NUMBER',30,1,0,2,2,'SERIAL NUMBER','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',13,'RATE',20,1,0,2,3,'RATE','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',14,'TAXABLE VALUE',20,1,0,2,3,'TAXABLE VALUE','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',15,'INTEGRATED TAX',50,1,0,2,3,'INTEGRATED TAX','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',16,'CENTRAL TAX',20,1,0,2,3,'CENTRAL TAX','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',17,'STATE OR UT TAX',20,1,0,2,3,'STATE OR UT TAX','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',18,'CESS',30,1,0,2,3,'CESS','','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',19,'ELIGIBILITY',20,1,0,1,1,'ELIGIBILITY','','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',20,'INTEGRATED ITC AMOUNT',20,1,0,2,3,'INTEGRATED','ITC AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',21,'CENTRAL ITC AMOUNT',20,1,0,2,3,'CENTRAL','ITC AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',22,'STATE OR UT ITC AMOUNT',20,1,0,2,3,'STATE OR UT','ITC AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',23,'CESS ITC AMOUNT',20,1,0,2,3,'CESS','ITC AMOUNT','',2,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',24,'TAXACT',20,1,0,1,1,'TAX PAYER','ACTION','',0,GETDATE()
UNION ALL
SELECT 1,429,'FORM GSTR2-CDN',25,'InvCheck',20,1,0,1,1,'INVOICE CHECK','SUM VALUE','',0,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_CDN')
BEGIN
CREATE TABLE RptGSTR2_CDN
(
[Slno]	INT IDENTITY (1,1),
[Your GSTIN]	Varchar(50),
[Return Period]	Varchar(20),
[GSTIN]	Varchar(50),
SpmID INT,
RefId BIGINT,
RefNo Varchar(30),
[INVOICE NUMBER]	Varchar(50),
[INVOICE DATE]	DateTime,
[NOTE TYPE]	Varchar(10),
[NOTE NUMBER]	Varchar(50),
[NOTE DATE]	DateTime,
[NOTE VALUE]	Numeric(36,6),
[REASON]	Varchar(150),
[PRE GST REGIME]	Varchar(5),
[SERIAL NUMBER]	INT,
[RATE]	Numeric(10,2),
[TAXABLE VALUE]	Numeric(36,6),
[INTEGRATED TAX]	Numeric(36,6),
[CENTRAL TAX]	Numeric(36,6),
[STATE OR UT TAX]	Numeric(36,6),
[CESS]	Numeric(36,6),
[ELIGIBILITY]	Varchar(10),
[INTEGRATED ITC AMOUNT]	Numeric(36,6),
[CENTRAL ITC AMOUNT]	Numeric(36,6),
[STATE OR UT ITC AMOUNT]	Numeric(36,6),
[CESS ITC AMOUNT]	Numeric(36,6),
TAXACT Varchar(5),
InvCheck Varchar(5),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2SUMMARY' and RptId=430
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',430,'FORMGSTR2SUMMARY','FORM GSTR2-SUMMARY',1
GO
DELETE FROM RptHeader WHERE RptId=430
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2SUMMARY','FORM GSTR2-SUMMARY',430,'FORM GSTR2-SUMMARY','Proc_RptGSTR2_Summary','RptGSTR2_Summary','RptGSTR2_Summary.rpt',0
GO
DELETE FROM RptDetails where RPTID=430
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (430,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (430,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=430
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 430,208,1,'January' UNION
SELECT 430,208,2,'February' UNION
SELECT 430,208,3,'March' UNION
SELECT 430,208,4,'April' UNION
SELECT 430,208,5,'May' UNION
SELECT 430,208,6,'June' UNION
SELECT 430,208,7,'July' UNION
SELECT 430,208,8,'August' UNION
SELECT 430,208,9,'September' UNION
SELECT 430,208,10,'October' UNION
SELECT 430,208,11,'November' UNION
SELECT 430,208,12,'December' 
GO
DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=430
INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
RoundOff,CreatedDate)
SELECT 1,430,'FORM GSTR2-SUMMARY',1,'SUMMARY FOR',20,1,0,2,3,'SUPPLY TYPE','','',0,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',2,'B2B',20,1,0,2,3,'B2B','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',3,'B2BUR',30,1,0,2,3,'B2BUR','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',4,'CDN',20,1,0,2,3,'CDN','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',5,'CDNUR',20,1,0,2,3,'CDNUR','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',6,'NIL',30,1,0,2,3,'NIL','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',7,'HSN',20,1,0,2,3,'HSN','','',2,GETDATE()
UNION ALL
SELECT 1,430,'FORM GSTR2-SUMMARY',8,'ITC_RVSL',20,1,0,2,3,'ITC_RVSL','','',2,GETDATE()
GO
IF NOT EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='U' and Name='RptGSTR2_Summary')
BEGIN
CREATE TABLE RptGSTR2_Summary
(
[Slno]	INT IDENTITY (1,1),
TransId TINYINT,
[SUMMARY FOR]	Varchar(150),
[B2B]	Varchar(30),
[B2BUR]	Varchar(30),
[CDN]	Varchar(30),
[CDNUR]	Varchar(30),
[NIL]	Varchar(30),
[HSN]	Varchar(30),
[ITC_RVSL]	Varchar(30),
UsrId				 INT,
[Group Name]		 VARCHAR(100),
GroupType			 TINYINT
)
END
GO
DELETE FROM RptGroup WHERE PID='GSRT 410' and GrpCode='FORMGSTR2EXTRACT' and RptId=431
INSERT INTO RptGroup(PId,RptId,GrpCode,GrpName,VISIBILITY)
SELECT 'GSRT 410',431,'FORMGSTR2EXTRACT','GSTR2-Extract',1
GO
DELETE FROM RptHeader WHERE RptId=431
INSERT INTO RptHeader(GrpCode,RptCaption,RptId,RpCaption,SPName,TblName,RptName,UserIds)
SELECT 'FORMGSTR2EXTRACT','GSTR2-Extract',431,'GSTR2-Extract','Proc_RptGSTR2Extract','RptGSTR2_B2B','RptGSTR2_B2B.rpt',0
GO
DELETE FROM RptDetails where RPTID=431
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (431,1,'JCMast',-1,'','JcmId,JcmYr,JcmYr','Year*...','',1,'',12,1,1,'Press F4/Double Click to select JC Year',0)
INSERT INTO RptDetails([RptId],[SlNo],[TblName],[PrntId],[PrntRefFld],[FldName],[FldCaption],[PrntTbl],[CtrlType],[CmnFld],[SelcId],[SingleMulti],[Mandatory],[PnlMsg],[CaptionChange]) 
VALUES (431,2,'RptFilter',-1,NULL,'FilterId,FilterId,FilterDesc','Month...*',NULL,1,NULL,208,1,1,'Press F4/Double Click to select Month',0)
GO
DELETE FROM RPTFILTER WHERE RptId=431
INSERT INTO RPTFILTER(RptId,SelcId,FilterId,FilterDesc) 
SELECT 431,208,1,'January' UNION
SELECT 431,208,2,'February' UNION
SELECT 431,208,3,'March' UNION
SELECT 431,208,4,'April' UNION
SELECT 431,208,5,'May' UNION
SELECT 431,208,6,'June' UNION
SELECT 431,208,7,'July' UNION
SELECT 431,208,8,'August' UNION
SELECT 431,208,9,'September' UNION
SELECT 431,208,10,'October' UNION
SELECT 431,208,11,'November' UNION
SELECT 431,208,12,'December' 
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_B2B')
DROP PROCEDURE Proc_RptGSTR2_B2B
GO
--EXEC Proc_RptGSTR2_B2B 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_B2B]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_B2B
* PURPOSE    : To Generate GSTR2 B2B Report
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
05/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-B2B
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_B2B
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=8
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
	
	
		CREATE TABLE #RptGSTR2_B2B
		(
		TRANSID	TINYINT	,
		SpmId	INT,
		[Your GSTIN]	Varchar(50),
		[Return Period]	Varchar(20),
		[GSTIN of Supplier]	Varchar(50),
		[Refid] BIGINT,		
		[Invoice Num]	Varchar(50),
		[Invoice Date]	DateTime,
		[Invoice Value]	Numeric(32,6),
		[Place of supply]	Varchar(50),
		[Invoice type]	Varchar(10),
		[Serial no]	INT,
		[Tax Rate]	Numeric(10,2),
		[Taxable value]	Numeric(32,6),
		[IGST]	Numeric(32,6),
		[CGST]	Numeric(32,6),
		[SGST]	Numeric(32,6),
		[CESS]	Numeric(32,6),
		[ITC IGST Amt]	Numeric(32,6),
		[ITC CGST Amt]	Numeric(32,6),
		[ITC SGST Amt]	Numeric(32,6),
		[ITC Cess Amt]	Numeric(32,6),
		[Eligibility]	Varchar(10),
		[Reverse Charge]	Varchar(10)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
		--Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		----IDT GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue
		INTO #IDTSupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'
		--Retailer GSTIN
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		--Retailer Registered
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerRegistered
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and UT.ColumnValue='Registered'
		
		--Retailer State
		SELECT DISTINCT  Rtrid as Rtrid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name' 
		
		--Supplier State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #SupplierState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name' 
		
		----IDT State
		SELECT DISTINCT  Spmid as Spmid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #IDTState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN IDTMaster R ON R.SpmId=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=8 and ColumnName='State Name' 
	
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
	
		SELECT SpmId,X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Pruchase
		FROM(
				SELECT SpmId,S.PurRcptId,CmpInvNo,InvDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM PurchaseReceipt S (NOLOCK) 
				INNER JOIN PurchaseReceiptProductTax ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
				and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.PurRcptId,CmpInvNo,InvDate,Prdslno,ST.TaxableAmount,TaxCode,SpmId
			)	X 
			GROUP BY X.PurRcptId,CmpInvNo,InvDate,X.Prdslno,TaxableAmount,SpmId
			ORDER BY X.Prdslno
			
			

			SELECT S.PurRcptId,SUM(PrdNetAmount) as PrdNetAmount
			INTO #PurchaseReceiptProduct
			FROM PurchaseReceipt S (NOLOCK) 
			INNER JOIN PurchaseReceiptProduct ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
			WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
			GROUP BY S.PurRcptId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #Pruchase A INNER JOIN #PurchaseReceiptProduct B
			ON A.PurRcptId=B.PurRcptId
			
			
			---Sales Return
		
			SELECT RtrId,X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #SalesReturn
			FROM(
				SELECT R.Rtrid,S.ReturnID,ReturnCode,ReturnDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmt) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount
				FROM ReturnHeader S (NOLOCK) 
				INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.RtrId
				INNER JOIN #Sales C ON C.SalId=S.SalId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
				and TaxCode IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','InputGSTCess')
				and ST.TaxableAmt>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode,R.Rtrid
			)	X 
			GROUP BY X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,RtrId
			ORDER BY X.Prdslno	
			
			
			SELECT S.ReturnID,SUM(PrdNetAmt) as PrdNetAmount
			INTO #SalesReturnProduct
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProduct ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.ReturnID
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #SalesReturn A INNER JOIN #SalesReturnProduct B
			ON A.ReturnID=B.ReturnID
			
			-----IDT IN
			
			SELECT FromSpmId,IDTMngRefNo,IDTMngDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #IDTIN
			FROM(
				SELECT FromSpmId,S.IDTMngRefNo,IDTMngDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM IDTManagement S (NOLOCK) 
				INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
				and StkMgmtTypeId=1
				and TaxCode IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','InputGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				GROUP BY S.IDTMngRefNo,IDTMngDate,Prdslno,TaxCode,FromSpmId
			)	X 
			GROUP BY IDTMngRefNo,IDTMngDate,X.Prdslno,FromSpmId
			ORDER BY X.Prdslno	
			
			
			SELECT S.IDTMngRefNo,SUM(PrdNetAmount) as PrdNetAmount
			INTO #IDTProduct
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProduct ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear --and VatGST='GST'
			GROUP BY S.IDTMngRefNo
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #IDTIN A INNER JOIN #IDTProduct B
			ON A.IDTMngRefNo=B.IDTMngRefNo
			
			---Service Invoice
			SELECT ServiceFromId,X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
			SUM(DISTINCT TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			INTO #ServiceRetailer
			FROM(
				SELECT ServiceFromId,S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM ServiceInvoiceHd S (NOLOCK) 
				INNER JOIN ServiceInvoiceTaxDetails ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
				INNER JOIN #RetailerRegistered R ON R.Rtrid=S.ServiceFromId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
				and ServiceInvFor=1
				and TaxCode IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
				'InputCGST','InputSGST','InputIGST','InputUTGST','InputGSTCess')
				and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
				--and ReverseCharges=0
				GROUP BY S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,TaxCode,ServiceFromId
			)	X 
			GROUP BY X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,ServiceFromId
			ORDER BY X.RowNo
			
			SELECT S.ServiceInvId,SUM(TotServiceAmount) as PrdNetAmount
			INTO #ServiceLineAmt
			FROM ServiceInvoiceHd S (NOLOCK) 
			INNER JOIN ServiceInvoiceDT ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
			WHERE Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
			--and ReverseCharges=0
			GROUP BY S.ServiceInvId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #ServiceRetailer A INNER JOIN #ServiceLineAmt B
			ON A.ServiceInvId=B.ServiceInvId
			
			
			----Purchase
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 1 AS TRANSID,SpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],X.PurRcptId,CmpInvNo,InvDate,
			PrdNetAmount as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by X.PurRcptId ORDER BY Taxperc,X.PurRcptId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(X.TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #Pruchase X 
			GROUP BY Taxperc,X.PurRcptId,CmpInvNo,InvDate,SpmId,PrdNetAmount
		---Sales Return
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 2 AS TRANSID,RtrId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ReturnID,ReturnCode,ReturnDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ReturnID ORDER BY Taxperc,ReturnID ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #SalesReturn
			GROUP BY Taxperc,ReturnID,ReturnCode,ReturnDate,RtrId,PrdNetAmount
		-----IDT IN	
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 3 AS TRANSID,FromSpmId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],0,IDTMngRefNo,IDTMngDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by IDTMngRefNo ORDER BY Taxperc,IDTMngRefNo ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #IDTIN
			GROUP BY Taxperc,IDTMngRefNo,IDTMngDate,FromSpmId,PrdNetAmount
			
		-----Service Invoice Retailer		
			INSERT INTO #RptGSTR2_B2B(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 4 AS TRANSID,ServiceFromId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ServiceInvId,ServiceInvRefNo,ServiceInvDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ServiceInvId ORDER BY Taxperc,ServiceInvId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #ServiceRetailer
			GROUP BY Taxperc,ServiceInvRefNo,ServiceInvDate,ServiceFromId,ServiceInvId,PrdNetAmount	
			
			--GSTIN
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTSupplierGSTIN B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
			--Place Of Supply
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #SupplierState B ON A.SpmId=B.SpmId 
			WHERE TransId=1
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #IDTState B ON A.SpmId=B.SpmId 
			WHERE TransId=3
			
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2B A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
		
		
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_B2B)
		BEGIN
			INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],0 as [IGST],0 as [CGST],0 as [SGST],0 as [CESS],0 as [ITC IGST Amt],0 as [ITC CGST Amt],0 as [ITC SGST Amt],
			0 as [ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
			
			SELECT * FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			
			DELETE FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT 	[Your GSTIN],@ReturnPeriod as [Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
			FROM #RptGSTR2_B2B
		
		SELECT 
			SUM(IGST) as [IGST],
			SUM([CGST]) as [CGST],
			SUM([SGST]) as [SGST],
			SUM([CESS]) as [CESS],		
			SUM([ITC IGST Amt]) as [ITC IGST Amt],
			SUM([ITC CGST Amt]) as [ITC CGST Amt],
			SUM([ITC SGST Amt]) as [ITC SGST Amt],
			SUM([ITC Cess Amt]) as [ITC Cess Amt]
		INTO #TaxTotal	
		FROM #RptGSTR2_B2B	
		
		SELECT 3 as GroupType,SUM([Invoice Value]) as [Invoice Value]
		INTO #InvoiceGT
		FROM(
		SELECT DISTINCT TransId,[Refid],[Invoice Num],[Invoice Value]
		FROM #RptGSTR2_B2B
		)X
		
			
		INSERT INTO RptGSTR2_B2B([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],
			0 as [Invoice Value],'' as [Place of supply],'' as [Invoice type],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #TaxTotal
		
		UPDATE A SET A.[Invoice Value]=B.[Invoice Value] FROM  RptGSTR2_B2B A 
		INNER JOIN #InvoiceGT B ON  A.GroupType=B.GroupType
		WHERE A.GroupType=3 and UsrId=@Pi_UsrId
		
		UPDATE RptGSTR2_B2B SET [Taxable value] =(SELECT SUM([Taxable value])
		FROM #RptGSTR2_B2B WHERE [CESS]=0) WHERE GroupType=3 and UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTR2_B2B (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_B2BUR')
DROP PROCEDURE Proc_RptGSTR2_B2BUR
GO
--EXEC Proc_RptGSTR2_B2B 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_B2BUR]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_B2BUR
* PURPOSE    : To Generate GSTR2 B2B Un Register Report
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
05/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-B2BUR
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_B2BUR
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=8
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
	
	
		CREATE TABLE #RptGSTR2_B2BUR
		(
		TRANSID	TINYINT	,
		SpmId	INT,
		[Your GSTIN]	Varchar(50),
		[Return Period]	Varchar(20),
		[GSTIN of Supplier]	Varchar(50),
		[Refid] BIGINT,		
		[Invoice Num]	Varchar(50),
		[Invoice Date]	DateTime,
		[Invoice Value]	Numeric(32,6),
		[Place of supply]	Varchar(50),
		[Invoice type]	Varchar(10),
		[Serial no]	INT,
		[Tax Rate]	Numeric(10,2),
		[Taxable value]	Numeric(32,6),
		[IGST]	Numeric(32,6),
		[CGST]	Numeric(32,6),
		[SGST]	Numeric(32,6),
		[CESS]	Numeric(32,6),
		[ITC IGST Amt]	Numeric(32,6),
		[ITC CGST Amt]	Numeric(32,6),
		[ITC SGST Amt]	Numeric(32,6),
		[ITC Cess Amt]	Numeric(32,6),
		[Eligibility]	Varchar(10),
		[Reverse Charge]	Varchar(10)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'

		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='GSTIN'
		
		--Retailer Registered
		SELECT DISTINCT  Rtrid as Rtrid ,UT.ColumnValue
		INTO #RetailerUnRegistered
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		WHERE U.MasterId=2 and ColumnName='Retailer Type' and UT.ColumnValue='UnRegistered'
		
		--Retailer State
		SELECT DISTINCT  Rtrid as Rtrid,StateId,StateCode,StateName,TinFirst2Digit,StateType
		INTO #RetailerState
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Retailer R ON R.Rtrid=UT.MasterRecordId
		INNER JOIN StateMaster S ON S.StateName=UT.ColumnValue
		WHERE U.MasterId=2 and ColumnName='State Name' 
		
	
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'

		
		---Sales Return	
		SELECT RtrId,X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #SalesReturn
		FROM(
			SELECT S.Rtrid,S.ReturnID,ReturnCode,ReturnDate,Prdslno,SUM(TaxPerc) as Taxperc,
			SUM(DISTINCT ST.TaxableAmt) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			INNER JOIN #RetailerUnRegistered R ON R.Rtrid=S.RtrId
			INNER JOIN #Sales C ON C.SalId=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
			and TaxCode IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
			'InputCGST','InputSGST','InputIGST','InputUTGST','InputGSTCess')
			and ST.TaxableAmt>0 
			GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode,S.Rtrid
		)	X 
		GROUP BY X.ReturnID,ReturnCode,ReturnDate,X.Prdslno,RtrId
		ORDER BY X.Prdslno	
		
		
		SELECT S.ReturnID,SUM(PrdNetAmt) as PrdNetAmount
		INTO #SalesReturnProduct
		FROM ReturnHeader S (NOLOCK) 
		INNER JOIN ReturnProduct ST (NOLOCK) ON S.ReturnID=ST.ReturnID
		WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear --and VatGST='GST'
		GROUP BY S.ReturnID
		
		UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #SalesReturn A INNER JOIN #SalesReturnProduct B
		ON A.ReturnID=B.ReturnID

			
		---Service Invoice
		SELECT ServiceFromId,X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,CAST( 0.00 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #ServiceRetailer
		FROM(
			SELECT ServiceFromId,S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,SUM(TaxPerc) as Taxperc,
			SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputIGST','IGST','InputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputCGST','CGST','InputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutputSGST','OutputUTGST','SGST','UTGST','InputSGST','InputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('OutPutGSTCess','InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
			FROM ServiceInvoiceHd S (NOLOCK) 
			INNER JOIN ServiceInvoiceTaxDetails ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			INNER JOIN #RetailerUnRegistered RU ON R.Rtrid=S.ServiceFromId
			WHERE  Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
			and ServiceInvFor=1
			and TaxCode IN ('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST',
			'InputCGST','InputSGST','InputIGST','InputUTGST','InputGSTCess')
			and ST.TaxableAmount>0 --and S.PurRcptId IN(913,914,915)
			GROUP BY S.ServiceInvId,S.ServiceInvRefNo,ServiceInvDate,RowNo,TaxCode,ServiceFromId
		)	X 
		GROUP BY X.ServiceInvId,X.ServiceInvRefNo,ServiceInvDate,X.RowNo,ServiceFromId
		ORDER BY X.RowNo
			
			SELECT S.ServiceInvId,SUM(TotServiceAmount) as PrdNetAmount
			INTO #ServiceLineAmt
			FROM ServiceInvoiceHd S (NOLOCK) 
			INNER JOIN ServiceInvoiceDT ST (NOLOCK) ON S.ServiceInvId=ST.ServiceInvId
			WHERE Month(ServiceInvDate)=@MonthStart and Year(ServiceInvDate)=@Jcmyear --and VatGST='GST'
			--and ReverseCharges=0
			GROUP BY S.ServiceInvId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #ServiceRetailer A INNER JOIN #ServiceLineAmt B
			ON A.ServiceInvId=B.ServiceInvId
	
		---Sales Return
			INSERT INTO #RptGSTR2_B2BUR(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 2 AS TRANSID,RtrId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ReturnID,ReturnCode,ReturnDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ReturnID ORDER BY Taxperc,ReturnID ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #SalesReturn
			GROUP BY Taxperc,ReturnID,ReturnCode,ReturnDate,RtrId,PrdNetAmount
			
		-----Service Invoice Retailer		
			INSERT INTO #RptGSTR2_B2BUR(TRANSID,SpmId,		
			[Your GSTIN],[Return Period],[GSTIN of Supplier],[Refid],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Invoice type],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge])	
			SELECT 4 AS TRANSID,ServiceFromId,@DistGSTIN as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],ServiceInvId,ServiceInvRefNo,ServiceInvDate,
			(PrdNetAmount) as [Invoice Value],'' as [Place of supply],'R' as [Invoice type],
			Row_Number() OVER(Partition by ServiceInvId ORDER BY Taxperc,ServiceInvId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'IP' as [Eligibility],'N' as [Reverse Charge]
			FROM #ServiceRetailer
			GROUP BY Taxperc,ServiceInvRefNo,ServiceInvDate,ServiceFromId,ServiceInvId	,PrdNetAmount
			
			--GSTIN			
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2BUR A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
					
			UPDATE A SET A.[GSTIN of Supplier] = B.ColumnValue 
			FROM #RptGSTR2_B2BUR A INNER JOIN #RetailerGSTIN B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
			--Place Of Supply
					
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2BUR A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=2
					
			UPDATE A SET A.[Place of supply] = B.TinFirst2Digit 
			FROM #RptGSTR2_B2BUR A INNER JOIN #RetailerState B ON A.SpmId=B.Rtrid 
			WHERE TransId=4
		
		
		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_B2BUR)
		BEGIN
			SELECT * FROM RptGSTR2_B2BUR WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_B2BUR([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
			SELECT 	[Your GSTIN],@ReturnPeriod as [Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
			FROM #RptGSTR2_B2BUR
		
		SELECT 
			SUM(IGST) as [IGST],
			SUM([CGST]) as [CGST],
			SUM([SGST]) as [SGST],
			SUM([CESS]) as [CESS],		
			SUM([ITC IGST Amt]) as [ITC IGST Amt],
			SUM([ITC CGST Amt]) as [ITC CGST Amt],
			SUM([ITC SGST Amt]) as [ITC SGST Amt],
			SUM([ITC Cess Amt]) as [ITC Cess Amt]
		INTO #TaxTotal	
		FROM #RptGSTR2_B2BUR	
		
		SELECT 3 as GroupType,SUM([Invoice Value]) as [Invoice Value]
		INTO #InvoiceGT
		FROM(
		SELECT DISTINCT TransId,[Refid],[Invoice Num],[Invoice Value]
		FROM #RptGSTR2_B2BUR
		)X
		
		INSERT INTO RptGSTR2_B2BUR([Your GSTIN],[Return Period],[GSTIN of Supplier],[Invoice Num],[Invoice Date],
			[Invoice Value],[Place of supply],[Serial no],[Tax Rate],[Taxable value],
			[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],[Eligibility],[Reverse Charge],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN of Supplier],'' as [Invoice Num],Null as [Invoice Date],
			0 as [Invoice Value],'' as [Place of supply],0 as [Serial no],0 as [Tax Rate],
			0 as [Taxable value],[IGST],[CGST],[SGST],[CESS],[ITC IGST Amt],[ITC CGST Amt],[ITC SGST Amt],
			[ITC Cess Amt],'' [Eligibility],'' as [Reverse Charge],@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #TaxTotal
		
		UPDATE A SET A.[Invoice Value]=B.[Invoice Value] FROM  RptGSTR2_B2BUR A 
		INNER JOIN #InvoiceGT B ON  A.GroupType=B.GroupType
		WHERE A.GroupType=3 and UsrId=@Pi_UsrId
		
		UPDATE RptGSTR2_B2BUR SET [Taxable value] =(SELECT SUM([Taxable value])
		FROM #RptGSTR2_B2BUR WHERE [CESS]=0) WHERE GroupType=3 and UsrId=@Pi_UsrId
		
		SELECT * FROM RptGSTR2_B2BUR (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_HSNSUM')
DROP PROCEDURE Proc_RptGSTR2_HSNSUM
GO
--EXEC Proc_RptGSTR2_HSNSUM 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_HSNSUM]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_HSNSUM
* PURPOSE    : To Generate GSTR2 HSN Summary
* CREATED BY : Murugan.R
* CREATED ON : 17/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
06/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-B2BUR
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT
		DECLARE @ReturnPeriod Varchar(20)
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_HSNSUM
		
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		--SET @MonthStart=7
		--SET @Jcmyear=2017
		
		IF LEN(@MonthStart)=1 
		BEGIN
		 SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END
		ELSE
		BEGIN
		 SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
		END 
--	GROUP BY PrdSlNo ORDER BY  SUM(TaxPerc)
	
	
		CREATE TABLE #RptGSTR2_HSNSUM
		(
		[SERIAL NUMBER]	INT IDENTITY(1,1),
		[HSN OR SAC CODE]	Varchar(50),
		[DESCRIPTION]	Varchar(150),
		[UQC]	Varchar(50),
		[TOTAL QUANTITY]	BIGINT,
		[TOTAL VALUE]	Numeric(32,6),
		[TAXABLE VALUE]	Numeric(32,6),
		[INTEGRATED TAX]	Numeric(32,6),
		[CENTRAL TAX]	Numeric(32,6),
		[STATE OR UT TAX]	Numeric(32,6),
		[CESS]	Numeric(32,6)
		)	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'

		SELECT Distinct Prdid,ColumnValue as HSNCode,Cast('' as Varchar(150)) as HSNDesc
		INTO #ProductHsnCode
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Code' 
		
		SELECT Distinct Prdid,ColumnValue as HSNDesc
		INTO #ProductHsnDesc
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Product R ON R.Prdid=UT.MasterRecordId
		WHERE U.MasterId=1 and ColumnName='HSN Description' 
		
		Update A Set A.HSNdesc=B.HSNDesc FROM #ProductHsnCode A INNER JOIN #ProductHsnDesc B ON A.Prdid=B.Prdid
	
		SELECT Salid INTO #Sales  FROM Salesinvoice (NOLOCK)		
		WHERE Dlvsts>3 and Salinvdate between '2017-01-01' and '2017-06-30' and VatGst='VAT'
		
		
		SELECT PurRcptId,PurRcptRefNo,InvDate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Pruchase	
		FROM
		(		
			SELECT S.PurRcptId,PurRcptRefNo,InvDate,Prdslno,
			CASE  WHEN TaxCode IN('InputIGST','IGST','InputCGST','CGST') THEN SUM(ST.TaxableAmount) ELSE 0  END as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount	FROM PurchaseReceipt S (NOLOCK) 
			INNER JOIN PurchaseReceiptProductTax ST (NOLOCK) ON S.PurRcptId=ST.PurRcptId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear and VatGST='GST'
			and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess')
			and ST.TaxableAmount>0
			GROUP BY S.PurRcptId,PurRcptRefNo,InvDate,Prdslno,TaxCode
		)X GROUP BY PurRcptId,PurRcptRefNo,InvDate,Prdslno
		
		
		SELECT IDTMngRefNo,IDTMngDate,Prdslno,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #IDT
		FROM
		(		
			SELECT S.IDTMngRefNo,IDTMngDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','InPutIGST','IDTIGST','OutputCGST','CGST','InPutCGST','IDTCGST') THEN SUM(TaxableAmount) END,0) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST','OutputIGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST','OutputCGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST','OutputSGST','OutputUTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputGSTCess','OutPutGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount	
			FROM IDTManagement S (NOLOCK) 
			INNER JOIN IDTManagementProductTax ST (NOLOCK) ON S.IDTMngRefNo=ST.IDTMngRefNo
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE  Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','IDTIGST','IDTCGST','IDTSGST','IDTUTGST')
			and ST.TaxableAmount>0 and StkMgmtTypeId=1
			GROUP BY S.IDTMngRefNo,IDTMngDate,Prdslno,TaxCode
		)X GROUP BY IDTMngRefNo,IDTMngDate,Prdslno
		
		
		SELECT ReturnID,ReturnCode,ReturnDate,PrdSlNo,SUM(TaxableAmount) as TaxableAmount,SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,SUM(SGSTUTGSTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #Return
		FROM
		(		
			SELECT S.ReturnID,ReturnCode,ReturnDate,PrdSlNo,
			ISNULL(CASE WHEN  TaxCode IN('OutputIGST','IGST','OutputCGST','CGST') THEN SUM(TaxableAmt) END,0) as TaxableAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST','OutputIGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS IGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST','OutputCGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST','OutputSGST','OutputUTGST') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
			ISNULL(CASE  WHEN TaxCode IN('InputGSTCess','OutPutGSTCess') THEN SUM(ST.TaxAmt) ELSE 0 END,0) AS CESSTaxAmount	
			FROM ReturnHeader S (NOLOCK) 
			INNER JOIN ReturnProductTax ST (NOLOCK) ON S.ReturnID=ST.ReturnID
			INNER JOIN #Sales SS ON SS.SalId=S.SalId
			INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
			WHERE  Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
			and TaxCode IN('OutputIGST','OutputCGST','OutputSGST','OutputUTGST','IGST','CGST','SGST','UTGST',
			'InPutIGST','InPutCGST','InPutSGST','InPutUTGST','IDTIGST','IDTCGST','IDTSGST','IDTUTGST')
			and ST.TaxableAmt>0 
			GROUP BY S.ReturnID,ReturnCode,ReturnDate,Prdslno,TaxCode
		)X GROUP BY ReturnID,ReturnCode,ReturnDate,Prdslno
		
		INSERT INTO #RptGSTR2_HSNSUM([HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS]	)
		SELECT HSNCode,HSNDesc,'NOS-Numbers' as [UQC],SUM(BaseQty) as BaseQty,SUM(SalesValue) as SalesValue,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
		SUM(CESSTaxAmount) as CessAmount	
		FROM
		(		
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(RcvdGoodBaseQty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #Pruchase S INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(Qty) as BaseQty,SUM(PrdNetAmount) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #IDT S INNER JOIN IDTManagementProduct SIP (NOLOCK) ON S.IDTMngRefNo=SIP.IDTMngRefNo and S.Prdslno=SIP.Prdslno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
			UNION ALL
			SELECT ISNULL(HSNCode,'') as HSNCode,ISNULL(HSNDesc,'') as HSNDesc,SUM(BaseQty) as BaseQty,SUM(PrdNetAmt) as SalesValue,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(IGSTTaxAmount) as IGSTTaxAmount,
			SUM(CGSTTaxAmount) as CGSTTaxAmount,
			SUM(SGSTUTTaxAmount) as SGSTUTTaxAmount,
			SUM(CESSTaxAmount) as CESSTaxAmount
			FROM #Return S INNER JOIN Returnproduct SIP (NOLOCK) ON S.ReturnID=SIP.ReturnID and S.Prdslno=SIP.Slno
			LEFT OUTER JOIN #ProductHsnCode P ON P.Prdid=SIP.Prdid
			GROUP BY 
			ISNULL(HSNCode,''),ISNULL(HSNDesc,'')
		) X GROUP BY HSNCode,HSNDesc

		IF NOT EXISTS(SELECT 'X' FROM #RptGSTR2_HSNSUM)
		BEGIN
			SELECT * FROM RptGSTR2_HSNSUM WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		INSERT INTO RptGSTR2_HSNSUM([Your GSTIN],[Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],UsrId,[Group Name],GroupType)	
		SELECT 	@DistGSTIN as [Your GSTIN],@ReturnPeriod as [Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		FROM #RptGSTR2_HSNSUM ORDER BY [SERIAL NUMBER]
		
		
			
		INSERT INTO RptGSTR2_HSNSUM([Your GSTIN],[Return Period],[SERIAL NUMBER],[HSN OR SAC CODE],[DESCRIPTION],[UQC],[TOTAL QUANTITY],[TOTAL VALUE],
		[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],[CESS],UsrId,[Group Name],GroupType)	
		SELECT '' as [Your GSTIN],'' as [Return Period],0 as [SERIAL NUMBER],'' as [HSN OR SAC CODE],
		'' as [DESCRIPTION],'' as [UQC],SUM([TOTAL QUANTITY]) as [TOTAL QUANTITY],SUM([TOTAL VALUE]),
		SUM([TAXABLE VALUE]),SUM([INTEGRATED TAX]),SUM([CENTRAL TAX]),SUM([STATE OR UT TAX]),SUM([CESS]),@Pi_UsrId as UsrId,'ZZZZZ' as [Group Name],3 as GroupType
		FROM #RptGSTR2_HSNSUM
		

		

		SELECT * FROM RptGSTR2_HSNSUM (NOLOCK) WHERE UsrId=@Pi_UsrId
		
		--DROP TABLE #Pruchase
		--DROP TABLE #RptGSTR2_B2B
		--DROP TABLE #Sales
		--DROP TABLE #SalesReturn
		--DROP TABLE #PurchaseReceiptProduct
		--DROP TABLE #SalesReturnProduct
		--DROP TABLE #IDTIN
		--DROP TABLE #IDTProduct
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_NILRATE')
DROP PROCEDURE Proc_RptGSTR2_NILRATE
GO
--EXEC Proc_RptGSTR2_NILRATE 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_NILRATE]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_NILRATE
* PURPOSE    : To Generate GSTR2 NIL Rate Summary
* CREATED BY : Murugan.R
* CREATED ON : 06/09/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
06/09/2017	Murugan.R	CR		CCRSTPAR0167		GSTR2-NILRATE
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT		
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		
		TRUNCATE TABLE RptGSTR2_NILRATE
		
		---Find Zero Tax Product
		DECLARE @PrdBatTaxGrp AS INT
		DECLARE @RtrTaxGrp1 AS INT
		DECLARE @PurSeqId AS INT
		DECLARE @BillSeqId AS INT
		DECLARE @RtrTaxGrp AS INT		 
		DECLARE @TaxSlab  INT  
		DECLARE @MRP INT    
		DECLARE @TaxableAmount  NUMERIC(28,10)      
		DECLARE @ParTaxableAmount NUMERIC(28,10)      
		DECLARE @TaxPer   NUMERIC(38,2)     
		DECLARE @TaxPercentage   NUMERIC(38,5)   
		DECLARE @TaxId   INT 
		DECLARE @MaxSlno   INT
		DECLARE @MinSlno   INT
		DECLARE @Prdid INT
		DECLARE @ReturnPeriod Varchar(20)
		SET @MinSlno=1
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017


		CREATE TABLE #ProductLst
		(
			Slno INT IDENTITY(1,1),	
			TaxSeqId INT,	
			Prdid INT,
			RtrId INT
		)	
		
		CREATE TABLE #ProductZeroTax(
		TaxGroupId [int] NULL,
		[TaxPercentage] [numeric](18, 5) NULL
		) 
		
			
		
		DECLARE @TaxSettingDet TABLE       
		(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,2)      
		) 
		CREATE TABLE #TempProductTax
		(
			Prdid INT,
			TaxId INT,
			TaxSlabId INT,
			TaxPercentage Numeric(5,2),
			TaxAmount Numeric (18,5)
		)
	   
		SELECT @RtrTaxGrp=TaxGroupId FROM TaxGroupSetting (NOLOCK) WHERE RtrGroup='RTRINTRA'
	   
		SELECT * INTO #RtrGroup FROM TaxSettingMaster WHERE      
		RtrId = @RtrTaxGrp 
		and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
		
		INSERT INTO #ProductLst (TaxSeqId,Prdid,RtrId)
		SELECT Max(A.TaxSeqId),A.Prdid,A.RtrId		
		FROM #RtrGroup A INNER JOIN TaxSettingMaster B ON A.RtrId=B.RtrId and A.Prdid=B.Prdid
		GROUP BY A.Prdid,A.RtrId

	    SELECT @MaxSlno=MAX(Slno) FROM #ProductLst
	    WHILE @MinSlno<=@MaxSlno
	    BEGIN
				
				DELETE FROM @TaxSettingDet	
				SELECT @PrdBatTaxGrp=Prdid, @RtrTaxGrp=RtrId FROM  #ProductLst WHERE Slno=@MinSlno
				--To Take the Batch TaxGroup Id      
								
				SELECT @BillSeqId = MAX(BillSeqId)  FROM BillSequenceMaster (NOLOCK)
				
						
				INSERT INTO @TaxSettingDet (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
				SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
				FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
				TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
				AND B.BillSeqId=@BillSeqId  and Coltype IN(1,3)    
				WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp     
				AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
				RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp
				and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
				)  
			
				SET @MRP=1
				TRUNCATE TABLE #TempProductTax
				DECLARE  CurTax CURSOR FOR      
					SELECT DISTINCT TaxSlab FROM @TaxSettingDet      
				OPEN CurTax        
				FETCH NEXT FROM CurTax INTO @TaxSlab      
				WHILE @@FETCH_STATUS = 0        
				BEGIN      
				SET @TaxableAmount = 0      
				--To Filter the Records Which Has Tax Percentage (>=0)      
				IF EXISTS (SELECT * FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId = 0 and ColVal >= 0)      
				BEGIN      
				--To Get the Tax Percentage for the selected slab      
				SELECT @TaxPer = ColVal FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId = 0      
				--To Get the TaxId for the selected slab      
				SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSettingDet WHERE TaxSlab = @TaxSlab AND ColType = 1      
				AND ColId > 0      
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP 
				--To Get the Parent Taxable Amount for the Tax Slab      
				SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM #TempProductTax A      
				INNER JOIN @TaxSettingDet B ON A.TaxId = B.ColVal and  
				B.ColType = 3 AND B.TaxSlab = @TaxSlab 
				If @ParTaxableAmount>0
				BEGIN
					Set @TaxableAmount=@ParTaxableAmount
				END 
				ELSE
				BEGIN
					Set @TaxableAmount = @TaxableAmount
				END    
				    
				INSERT INTO #TempProductTax (PrdId,TaxId,TaxSlabId,TaxPercentage,      
				TaxAmount)      
				SELECT @PrdBatTaxGrp,@TaxId,@TaxSlab,@TaxPer,      
				cast(@TaxableAmount*(@TaxPer / 100 ) AS NUMERIC(28,10))      
				 
				  
				END      
				FETCH NEXT FROM CurTax INTO @TaxSlab      
				END        
				CLOSE CurTax        
				DEALLOCATE CurTax      
				SELECT @TaxPercentage=Cast(ISNULL(SUM(TaxAmount)*100,0) as Numeric(18,5))
				FROM #TempProductTax WHERE Prdid=@PrdBatTaxGrp
									
				INSERT INTO #ProductZeroTax(TaxGroupId,TaxPercentage)
				SELECT @PrdBatTaxGrp,@TaxPercentage
				
				SET @MinSlno=@MinSlno+1	
	END	
	
	DELETE FROM #ProductZeroTax WHERE TaxPercentage>0
	
	SELECT DISTINCT B.PrdId INTO #ProductZeroTax1 
	FROM  #ProductZeroTax A INNER JOIN Product B ON A.TaxGroupId=B.TaxGroupId
	
	
		DECLARE @DistGSTIN VARCHAR(50)
		--Distributor GSTIN
		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'
	
	
	---EXEMPTED PRODUCT
	SELECT DISTINCT P.Prdid 
	INTO #ExemptProduct
	FROM UdcHD A (NOLOCK)
	INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
	INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId
	and C.UdcMasterId=B.UdcMasterId 
	INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId
	WHERE A.MasterName='Product Master' and B.ColumnName='Exempt Product'
	and ColumnValue='Yes'
	

	DELETE A FROM #ProductZeroTax1 A INNER JOIN #ExemptProduct B ON A.Prdid=B.PrdId
	
	
	SELECT Salid 
	INTO #Sales
	FROM SalesInvoice WHERE VatGst='VAT' and SalInvDate Between '2017-01-01' and '2017-06-30'
	and DlvSts>3
	
	IF LEN(@MonthStart)=1 
	BEGIN
		SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END
	ELSE
	BEGIN
		SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END 

	

	INSERT INTO RptGSTR2_NILRATE([Your GSTIN],[Return Period],[SUPPLY TYPE],[COMPOUNDING DEALER SUPPLIES],
	[NIL RATED SUPPLIES],[EXEMPTED SUPPLIES],[NON-GST SUPPLIES],
	UsrId,[Group Name],GroupType)
	SELECT @DistGSTIN,@ReturnPeriod,'INTER', 0 as [COMPOUNDING DEALER SUPPLIES],
	SUM([NilRated]) as [NilRated],SUM([Exempted]) as [Exempted],0.00 as NonGST,
	@Pi_UsrId,'',2
	FROM(
		SELECT 0 as [NilRated],SUM(TaxableAmount) as [Exempted] 
		FROM PurchaseReceipt S (NOLOCK)
		INNER JOIN PurchaseReceiptProduct SP (NOLOCK) ON S.PurRcptId=SP.PurRcptId
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId		
		INNER JOIN PurchaseReceiptProductTax SS (NOLOCK) ON SS.PurRcptId=SP.PurRcptId and S.PurRcptId=SS.PurRcptId and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear
		AND TaxCode IN('InputIGST','IGST') and SS.TaxAmount=0  and VatGsT='GST' and SS.TaxableAmount>0
		UNION ALL
		SELECT SUM(TaxableAmount) as [NilRated],0  as [Exempted] 
		FROM PurchaseReceipt S (NOLOCK)
		INNER JOIN PurchaseReceiptProduct SP (NOLOCK) ON S.PurRcptId=SP.PurRcptId
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN PurchaseReceiptProductTax SS (NOLOCK) ON SS.PurRcptId=SP.PurRcptId and S.PurRcptId=SS.PurRcptId and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE  Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear
		and SS.TaxAmount=0  and VatGsT='GST' and SS.TaxableAmount>0
		AND TaxCode IN('InputIGST','IGST')
		UNION ALL
		SELECT 0 as [NilRated],SUM(SS.TaxableAmt) as [Exempted] 
		FROM ReturnHeader S (NOLOCK)
		INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID=SP.ReturnID
		INNER JOIN #Sales SI ON SI.SalId=S.SalId
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId
		INNER JOIN ReturnProductTax SS (NOLOCK) ON SS.ReturnID=SP.ReturnID and S.ReturnID=SS.ReturnID and SP.Slno=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
		AND TaxCode IN('OutPutIGST','IGST') and SS.TaxAmt=0 and SS.TaxableAmt>0
		UNION ALL
		SELECT SUM(SS.TaxableAmt) as [NilRated],0  as [Exempted] 
		FROM ReturnHeader S (NOLOCK)
		INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID=SP.ReturnID
		INNER JOIN #Sales SI ON SI.SalId=S.SalId
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN ReturnProductTax SS (NOLOCK) ON SS.ReturnID=SP.ReturnID and S.ReturnID=SS.ReturnID and SP.Slno=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
		and SS.TaxAmt=0 and SS.TaxableAmt>0
		AND TaxCode IN('OutPutIGST','IGST')
		UNION ALL
		SELECT 0 as [NilRated],SUM(SS.TaxableAmount) as [Exempted] 
		FROM IDTManagement S (NOLOCK)
		INNER JOIN IDTManagementProduct SP (NOLOCK) ON S.IDTMngRefNo=SP.IDTMngRefNo
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId
		INNER JOIN IDTManagementProductTax SS (NOLOCK) ON SS.IDTMngRefNo=SP.IDTMngRefNo and S.IDTMngRefNo=SS.IDTMngRefNo and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		AND TaxCode IN('OutPutIGST','IGST','InputIGST','InputIDTIGST') and SS.TaxAmount=0 and SS.TaxableAmount>0
		and StkMgmtTypeId=1
		UNION ALL
		SELECT SUM(SS.TaxableAmount) as [NilRated],0  as [Exempted] 
		FROM IDTManagement S (NOLOCK)
		INNER JOIN IDTManagementProduct SP (NOLOCK) ON S.IDTMngRefNo=SP.IDTMngRefNo		
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN IDTManagementProductTax SS (NOLOCK) ON SS.IDTMngRefNo=SP.IDTMngRefNo and S.IDTMngRefNo=SS.IDTMngRefNo and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		and SS.TaxAmount=0 and SS.TaxableAmount>0
		AND TaxCode IN('OutPutIGST','IGST','InputIGST','InputIDTIGST') and StkMgmtTypeId=1
		
	)X
	INSERT INTO RptGSTR2_NILRATE([Your GSTIN],[Return Period],[SUPPLY TYPE],[COMPOUNDING DEALER SUPPLIES],
	[NIL RATED SUPPLIES],[EXEMPTED SUPPLIES],[NON-GST SUPPLIES],
	UsrId,[Group Name],GroupType)
	SELECT @DistGSTIN,@ReturnPeriod,'INTRA', 0 as [COMPOUNDING DEALER SUPPLIES], SUM([NilRated]) as [NilRated],SUM([Exempted]) as [Exempted],0.00 as NonGST
	,@Pi_UsrId,'',2
	FROM(
		SELECT 0 as [NilRated],SUM(TaxableAmount) as [Exempted] 
		FROM PurchaseReceipt S (NOLOCK)
		INNER JOIN PurchaseReceiptProduct SP (NOLOCK) ON S.PurRcptId=SP.PurRcptId
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId		
		INNER JOIN PurchaseReceiptProductTax SS (NOLOCK) ON SS.PurRcptId=SP.PurRcptId and S.PurRcptId=SS.PurRcptId and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear
		AND TaxCode IN('InPutCGST','CGST') and SS.TaxAmount=0  and VatGsT='GST' and SS.TaxableAmount>0
		UNION ALL
		SELECT SUM(TaxableAmount) as [NilRated],0  as [Exempted] 
		FROM PurchaseReceipt S (NOLOCK)
		INNER JOIN PurchaseReceiptProduct SP (NOLOCK) ON S.PurRcptId=SP.PurRcptId		
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN PurchaseReceiptProductTax SS (NOLOCK) ON SS.PurRcptId=SP.PurRcptId and S.PurRcptId=SS.PurRcptId and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(InvDate)=@MonthStart and Year(InvDate)=@Jcmyear
		and SS.TaxAmount=0  and VatGsT='GST' and SS.TaxableAmount>0
		AND TaxCode IN('InPutCGST','CGST')
		UNION ALL
		SELECT 0 as [NilRated],SUM(SS.TaxableAmt) as [Exempted] 
		FROM ReturnHeader S (NOLOCK)
		INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID=SP.ReturnID
		INNER JOIN #Sales SI ON SI.SalId=S.SalId
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId
		INNER JOIN ReturnProductTax SS (NOLOCK) ON SS.ReturnID=SP.ReturnID and S.ReturnID=SS.ReturnID and SP.Slno=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
		AND TaxCode IN('OutPutCGST','CGST') and SS.TaxAmt=0 and SS.TaxableAmt>0
		UNION ALL
		SELECT SUM(SS.TaxableAmt) as [NilRated],0  as [Exempted] 
		FROM ReturnHeader S (NOLOCK)
		INNER JOIN ReturnProduct SP (NOLOCK) ON S.ReturnID=SP.ReturnID
		INNER JOIN #Sales SI ON SI.SalId=S.SalId
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN ReturnProductTax SS (NOLOCK) ON SS.ReturnID=SP.ReturnID and S.ReturnID=SS.ReturnID and SP.Slno=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=0 and Month(ReturnDate)=@MonthStart and Year(ReturnDate)=@Jcmyear
		and SS.TaxAmt=0 and SS.TaxableAmt>0
		AND TaxCode IN('OutPutCGST','CGST')
		UNION ALL
		SELECT 0 as [NilRated],SUM(SS.TaxableAmount) as [Exempted] 
		FROM IDTManagement S (NOLOCK)
		INNER JOIN IDTManagementProduct SP (NOLOCK) ON S.IDTMngRefNo=SP.IDTMngRefNo
		INNER JOIN #ExemptProduct E ON E.PrdId=SP.PrdId
		INNER JOIN IDTManagementProductTax SS (NOLOCK) ON SS.IDTMngRefNo=SP.IDTMngRefNo and S.IDTMngRefNo=SS.IDTMngRefNo and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		AND TaxCode IN('OutPutCGST','CGST','InputCGST','InputIDTCGST') and SS.TaxAmount=0 and SS.TaxableAmount>0
		and StkMgmtTypeId=1
		UNION ALL
		SELECT SUM(SS.TaxableAmount) as [NilRated],0  as [Exempted] 
		FROM IDTManagement S (NOLOCK)
		INNER JOIN IDTManagementProduct SP (NOLOCK) ON S.IDTMngRefNo=SP.IDTMngRefNo		
		INNER JOIN #ProductZeroTax1 E ON E.PrdId=SP.PrdId
		INNER JOIN IDTManagementProductTax SS (NOLOCK) ON SS.IDTMngRefNo=SP.IDTMngRefNo and S.IDTMngRefNo=SS.IDTMngRefNo and SP.PrdSlNo=SS.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.Taxid=SS.Taxid
		WHERE Status=1 and Month(IDTMngDate)=@MonthStart and Year(IDTMngDate)=@Jcmyear
		and SS.TaxAmount=0 and SS.TaxableAmount>0
		AND TaxCode IN('OutPutCGST','CGST','InputCGST','InputIDTCGST') and StkMgmtTypeId=1
		
	)X

	
	IF NOT EXISTS(SELECT 'X' FROM RptGSTR2_NILRATE WHERE UsrId=@Pi_UsrId)
	BEGIN
		SELECT * FROM RptGSTR2_NILRATE WHERE UsrId=@Pi_UsrId
		RETURN
	END
	
	INSERT INTO RptGSTR2_NILRATE([Your GSTIN],[Return Period],[SUPPLY TYPE],[COMPOUNDING DEALER SUPPLIES],
	[NIL RATED SUPPLIES],[EXEMPTED SUPPLIES],[NON-GST SUPPLIES],
	UsrId,[Group Name],GroupType)
	SELECT'' as [[Your GSTIN],'' as [Return Period],'' as [SUPPLY TYPE],0 as [COMPOUNDING DEALER SUPPLIES],
	SUM([NIL RATED SUPPLIES]) as [NilRated],SUM([EXEMPTED SUPPLIES]) as [Exempted],0,@Pi_UsrId,'ZZZZZ',3
	FROM RptGSTR2_NILRATE WHERE UsrId=@Pi_UsrId
	
	SELECT * FROM RptGSTR2_NILRATE WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_CDN')
DROP PROCEDURE Proc_RptGSTR2_CDN
GO
--EXEC Proc_RptGSTR2_CDN 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_CDN]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_CDN
* PURPOSE    : To Generate GSTR2 CDN Details
* CREATED BY : Murugan.R
* CREATED ON : 06/09/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
06/09/2017	Murugan.R	CR		CCRSTAN0150			GSTR2 CDN
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT		
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		DECLARE @DistGSTIN AS VARCHAR(50)
		
		
		TRUNCATE TABLE RptGSTR2_CDN
		
		---Find Zero Tax Product

		DECLARE @ReturnPeriod Varchar(20)

		
	
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
		
		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=9
		--SET @Jcmyear=2017

	--Supplier GSTIN
		SELECT DISTINCT  SpmId as SpmID ,UT.ColumnValue as GSTIN
		INTO #SupplierGSTIN
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Supplier R ON R.SpmId=UT.MasterRecordId
		WHERE U.MasterId=8 and ColumnName='GSTIN'

		SELECT @DistGSTIN=UT.ColumnValue
		FROM UDCHD U 
		INNER JOIN UDCMASTER UD ON U.MasterId=UD.MasterId
		INNER JOIN UdcDetails UT ON UT.MasterId=UD.MasterId and UT.UdcMasterId=UD.UdcMasterId
		INNER JOIN Distributor R ON R.DistributorId=UT.MasterRecordId
		WHERE U.MasterId=16 and ColumnName='GSTIN'

	
	IF LEN(@MonthStart)=1 
	BEGIN
		SET @ReturnPeriod='0'+Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END
	ELSE
	BEGIN
		SET @ReturnPeriod=Cast(@MonthStart as Varchar(5))+CAST(@Jcmyear as varchar(5))
	END 

	SELECT PurRcptId INTO #Purchase  FROM PurchaseReceipt (NOLOCK)		
	WHERE Status=1 and InvDate between '2017-01-01' and '2017-06-30' and VatGst='VAT'

		

		SELECT SpmId,PurRetRefNo,X.PurRetId,CmpInvNo,PurRetDate,X.Prdslno,Cast(0.000000 as Numeric(36,6)) as PrdNetAmount, SUM(Taxperc) as Taxperc,
		SUM(DISTINCT TaxableAmount) as TaxableAmount,
		SUM(IGSTTaxAmount) as IGSTTaxAmount,
		SUM(CGSTTaxAmount) as CGSTTaxAmount,
		SUM(SGSTUTGSTTaxAmount) as SGSTUTGSTTaxAmount,
		SUM(CESSTaxAmount) as CESSTaxAmount
		INTO #PruchaseReturn
		FROM(
				SELECT PR.SpmId,PurRetRefNo,S.PurRetId,PR.CmpInvNo,PurRetDate,Prdslno,SUM(TaxPerc) as Taxperc,
				SUM(DISTINCT ST.TaxableAmount) as TaxableAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputIGST','IGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS IGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputCGST','CGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputSGST','InputUTGST','SGST','UTGST') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS SGSTUTGSTTaxAmount,
				ISNULL(CASE  WHEN TaxCode IN('InputGSTCess') THEN SUM(ST.TaxAmount) ELSE 0 END,0) AS CESSTaxAmount
				FROM PurchaseReturn S (NOLOCK) 
				INNER JOIN PurchaseReturnProductTax ST (NOLOCK) ON S.PurRetId=ST.PurRetId
				INNER JOIN PurchaseReceipt PR (NOLOCK) ON PR.PurRcptId=S.PurRcptId
				INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=ST.TaxId
				WHERE 
				S.Status=1 and 
				Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear 
				and TaxCode IN('InputIGST','InputCGST','InputSGST','InputUTGST','IGST','CGST','SGST','UTGST','InputGSTCess')
				and ST.TaxableAmount>0
				AND NOT EXISTS(SELECT A.PurRcptId FROM #Purchase A WHERE A.PurRcptId=PR.PurRcptId)
				GROUP BY S.PurRetId,PR.CmpInvNo,PurRetDate,Prdslno,ST.TaxableAmount,TaxCode,PR.SpmId,PurRetRefNo
			)	X 
			GROUP BY PurRetRefNo,X.PurRetId,CmpInvNo,PurRetDate,X.Prdslno,TaxableAmount,SpmId
			ORDER BY X.Prdslno
			
			

			SELECT S.PurRetId,SUM(PrdNetAmount) as PrdNetAmount
			INTO #PurchaseReturnProduct
			FROM PurchaseReturn S (NOLOCK) 
			INNER JOIN PurchaseReturnProduct ST (NOLOCK) ON S.PurRetId=ST.PurRetId
			WHERE Status=1 and Month(PurRetDate)=@MonthStart and Year(PurRetDate)=@Jcmyear and VatGST='GST'
			GROUP BY S.PurRetId
			
			UPDATE A Set A.PrdNetAmount =B.PrdNetAmount FROM #PruchaseReturn A INNER JOIN #PurchaseReturnProduct B
			ON A.PurRetId=B.PurRetId
			
			IF NOT EXISTS(SELECT 'X' FROM #PruchaseReturn)
			BEGIN
				SELECT * FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			
			INSERT INTO RptGSTR2_CDN([Your GSTIN],[Return Period],[GSTIN],SpmID,RefId,RefNo,[INVOICE NUMBER],[INVOICE DATE],
			[NOTE TYPE],[NOTE NUMBER],[NOTE DATE],[NOTE VALUE],[REASON],[PRE GST REGIME],
			[SERIAL NUMBER],[RATE],[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],
			[CESS],[ELIGIBILITY],[INTEGRATED ITC AMOUNT],[CENTRAL ITC AMOUNT],
			[STATE OR UT ITC AMOUNT],[CESS ITC AMOUNT],TAXACT,InvCheck,UsrId,[Group Name],GroupType)			
			SELECT @DistGSTIN,@ReturnPeriod,'' as [GSTIN],SpmId,X.PurRetId,PurRetRefNo,CmpInvNo,PurRetDate,'D','' as [NOTE NUMBER],Null as [NOTE DATE],
			PrdNetAmount as [NOTE VALUE],'07-Others' as [REASON],'N' as [PRE GST REGIME],
			Row_Number() OVER(Partition by X.PurRetId ORDER BY Taxperc,X.PurRetId ) as [Serial no] ,Taxperc as [Tax Rate],
			SUM(X.TaxableAmount) as [Taxable value],
			SUM(IGSTTaxAmount) as [IGST],
			SUM(CGSTTaxAmount) as [CGST],
			SUM(SGSTUTGSTTaxAmount) as [SGST],
			SUM(CESSTaxAmount) as [CESS],
			'IP' as [Eligibility],		
			SUM(IGSTTaxAmount) as [ITC IGST Amt],
			SUM(CGSTTaxAmount) as [ITC CGST Amt],
			SUM(SGSTUTGSTTaxAmount) as [ITC SGST Amt],
			SUM(CESSTaxAmount) as [ITC Cess Amt],
			'' as TAXACT,'' as InvCheck,
			@Pi_UsrId,'' as [Group Name],2 as GroupType		
			FROM #PruchaseReturn X 
			GROUP BY Taxperc,X.PurRetId,CmpInvNo,PurRetDate,SpmId,PrdNetAmount ,PurRetRefNo
			
			UPDATE B SET B.[GSTIN]=A.[GSTIN] FROM #SupplierGSTIN A INNER JOIN RptGSTR2_CDN B ON A.SpmID=B.SpmID
			WHERE UsrId=@Pi_UsrId
			
			UPDATE B SET B.[NOTE NUMBER]=DbNoteNumber,[NOTE DATE]=DbNoteDate 
			FROM DebitNoteSupplier A INNER JOIN RptGSTR2_CDN B ON A.SpmID=B.SpmID and PostedFrom=RefNo
			WHERE UsrId=@Pi_UsrId
			
			SELECT SUM(PrdNetAmount) as Netvalue INTO #NetValue FROM			
			(
			SELECT DISTINCT PurRetId,PurRetRefNo,CmpInvNo,PurRetDate,PrdNetAmount
			FROM #PruchaseReturn
			)X
			
			INSERT INTO RptGSTR2_CDN([Your GSTIN],[Return Period],[GSTIN],SpmID,RefId,RefNo,[INVOICE NUMBER],[INVOICE DATE],
			[NOTE TYPE],[NOTE NUMBER],[NOTE DATE],[NOTE VALUE],[REASON],[PRE GST REGIME],
			[SERIAL NUMBER],[RATE],[TAXABLE VALUE],[INTEGRATED TAX],[CENTRAL TAX],[STATE OR UT TAX],
			[CESS],[ELIGIBILITY],[INTEGRATED ITC AMOUNT],[CENTRAL ITC AMOUNT],
			[STATE OR UT ITC AMOUNT],[CESS ITC AMOUNT],TAXACT,InvCheck,UsrId,[Group Name],GroupType)
			
			SELECT '' as [Your GSTIN],'' as [Return Period],'' as [GSTIN],0 as SpmID,0 as RefId,'' as RefNo,
			'' as [INVOICE NUMBER],Null as [INVOICE DATE],
			'' as [NOTE TYPE],'' as [NOTE NUMBER],Null as [NOTE DATE],0 as [NOTE VALUE],'' as [REASON],''as [PRE GST REGIME],
			0 as [SERIAL NUMBER],0 as [RATE],SUM([TAXABLE VALUE]),SUM([INTEGRATED TAX]),SUM([CENTRAL TAX]),
			SUM([STATE OR UT TAX]),
			SUM([CESS]),'' as [ELIGIBILITY],SUM([INTEGRATED ITC AMOUNT]),SUM([CENTRAL ITC AMOUNT]),
			SUM([STATE OR UT ITC AMOUNT]),SUM([CESS ITC AMOUNT]),
			'' as TAXACT,'' as InvCheck,
			@Pi_UsrId as UsrId,'ZZZZZZ' as [Group Name],3 as GroupType
			FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId
			
			UPDATE RptGSTR2_CDN SET [NOTE VALUE]=(SELECT Netvalue FROM #NetValue) WHERE GroupType=3
			and  UsrId=@Pi_UsrId
			
			SELECT * FROM RptGSTR2_CDN WHERE UsrId=@Pi_UsrId

END
GO
IF EXISTS(SELECT 'X' FROM SYSOBJECTS WHERE XTYPE='P' and name='Proc_RptGSTR2_Summary')
DROP PROCEDURE Proc_RptGSTR2_Summary
GO
--EXEC Proc_RptGSTR2_Summary 225,2,0,'',0,0,1
CREATE PROCEDURE [Proc_RptGSTR2_Summary]
(
	@Pi_RptId		INT,
	@Pi_UsrId		INT,
	@Pi_SnapId		INT,
	@Pi_DbName		nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
	
)
AS
/************************************************
* PROCEDURE  : Proc_RptGSTR2_Summary
* PURPOSE    : To Generate GSTR2 Summary
* CREATED BY : Murugan.R
* CREATED ON : 06/09/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
07/09/2017	Murugan.R	CR		CCRSTAN0150			GSTR2 Summary Report
*/
BEGIN
SET NOCOUNT ON
		
		DECLARE @MonthStart INT		
		DECLARE @JcmJc AS INT
		DECLARE @Jcmyear AS INT
		DECLARE @JcmFromId AS INT
		DECLARE @CmpId AS INT
		DECLARE @ReturnPeriod Varchar(20)
		
		TRUNCATE TABLE RptGSTR2_Summary
		

	
		SET @JcmJc = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,12,@Pi_UsrId)) 
		SET @MonthStart = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,208,@Pi_UsrId))
		SET @CmpId= (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))

		SELECT @Jcmyear=JcmYr FROM JCMast MA WHERE MA.JcmId=@JcmJc
		
		--SET @MonthStart=7
		--SET @Jcmyear=2017
	
	
		INSERT INTO RptGSTR2_Summary(TransId,[SUMMARY FOR],[B2B],[B2BUR],
		[CDN],[CDNUR],[NIL],[HSN],[ITC_RVSL],UsrId,[Group Name],GroupType)
		SELECT 1,'VALUES' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 2,'TOTAL INVOICE VALUE/TOTAL VALUE' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 3,'TOTAl BILL OF ENTRY VALUE' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 4,'TOTAL NOTE VALUE' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 5,'TOTAL TAXABLE VALUE' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 6,'TOTAL GROSS ADVANCE PAID' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 7,'TOTAL GROSS ADVANCE ADJUSTED' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 8,'TOTAL NIL RATED SUPPLIES' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 9,'TOTAL EXEMPTED' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 10,'TOTAL NON-GST SUPPLIES' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 11,'TOTAL COMPOUNDING DEALER SUPPLIES' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 12,'TAX' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 13,'TOTAL INTEGRATED TAX' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 14,'TOTAL CENTRAL TAX' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 15,'TOTAL STATE OR UT TAX' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 16,'TOTAL CESS' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 17,'ITC' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 18,'TOTAL INTEGRATED ITC AMOUNT' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 19,'TOTAL CENTRAL ITC AMOUNT' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 20,'TOTAL STATE OR UT ITC AMOUNT' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 21,'TOTAL CESS ITC AMOUNT' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType
		UNION ALL
		SELECT 22,'' as [SUMMARY FOR],'' as [B2B],'' as [B2BUR],
		'' as [CDN],'' as [CDNUR],'' as [NIL],'' as [HSN],'' as [ITC_RVSL],
		@Pi_UsrId as UsrId,'' as [Group Name],2 as GroupType


		UPDATE RptGSTR2_Summary SET [NIL]=(SELECT CAST(ISNULL(SUM(CAST([NIL RATED SUPPLIES] as Numeric(36,2))),0.00) as Varchar(30))
											FROM RptGSTR2_NILRATE 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=8
		
		
		UPDATE RptGSTR2_Summary SET [NIL]=(SELECT CAST(ISNULL(SUM(CAST([EXEMPTED SUPPLIES] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_NILRATE 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=9
		---HSN		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([TOTAL VALUE] as Numeric(36,2))),0.00) as Varchar(30))
											FROM RptGSTR2_HSNSUM
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=2
		
		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([TAXABLE VALUE] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_HSNSUM 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=5
		
		
		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([INTEGRATED TAX] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_HSNSUM 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=13
		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([CENTRAL TAX] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_HSNSUM 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=14
		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([STATE OR UT TAX] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_HSNSUM 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=15
		
		
		
		UPDATE RptGSTR2_Summary SET [HSN]=(SELECT CAST(ISNULL(SUM(CAST([CESS] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_HSNSUM 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=16
		
			
		
		--B2B
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([Invoice Value] as Numeric(36,2))),0.00) as Varchar(30))
											FROM RptGSTR2_B2B
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=2
		
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([Taxable value] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_B2B 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=5
		
		
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([IGST] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_B2B 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=13
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([CGST] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=14
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([SGST] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=15
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([CESS] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=16
		
		---ITC
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([ITC IGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_B2B 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=18
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([ITC CGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=19
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([ITC SGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=20
		
		UPDATE RptGSTR2_Summary SET [B2B]=(SELECT CAST(ISNULL(SUM(CAST([ITC Cess Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2B 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=21
		
		
		
		

		---B2BUR
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([Invoice Value] as Numeric(36,2))),0.00) as Varchar(30))
											FROM RptGSTR2_B2BUR
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=2
		
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([Taxable value] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_B2BUR 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=5
		
		
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([IGST] as Numeric(36,2))) ,0.00) as Varchar(30)) 
											FROM RptGSTR2_B2BUR 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=13
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([CGST] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=14
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([SGST] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=15
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([CESS] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=16
		
		
		---ITC--B2BUR
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([ITC IGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_B2BUR 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=18
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([ITC CGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=19
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([ITC SGST Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=20
		
		UPDATE RptGSTR2_Summary SET [B2BUR]=(SELECT CAST(ISNULL(SUM(CAST([ITC Cess Amt] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_B2BUR 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=21
		
		
		
		---CDN
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([NOTE VALUE] as Numeric(36,2))),0.00) as Varchar(30))
											FROM RptGSTR2_CDN
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=2
		
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([TAXABLE VALUE] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_CDN 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
		WHERE 	TransId=5
		
		
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([INTEGRATED TAX] as Numeric(36,2))) ,0.00) as Varchar(30)) 
											FROM RptGSTR2_CDN 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=13
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([CENTRAL TAX] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=14
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([STATE OR UT TAX] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=15
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([CESS] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=16
		
		
		---ITC--B2BUR
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([INTEGRATED ITC AMOUNT] as Numeric(36,2))),0.00) as Varchar(30)) 
											FROM RptGSTR2_CDN 
											WHERE UsrId=@Pi_UsrId and GroupType=3)
									
		WHERE 	TransId=18
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([CENTRAL ITC AMOUNT] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=19
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([STATE OR UT ITC AMOUNT] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=20
		
		UPDATE RptGSTR2_Summary SET CDN=(SELECT CAST(ISNULL(SUM(CAST([CESS ITC AMOUNT] as Numeric(36,2))),0.00) as Varchar(30)) 
									FROM RptGSTR2_CDN 
									WHERE UsrId=@Pi_UsrId and GroupType=3)
							
		WHERE 	TransId=21
	
		SELECT * FROM RptGSTR2_Summary WHERE UsrId=@Pi_UsrId
	END 
GO
IF EXISTS (SELECT  * FROM SYS.OBJECTS WHERE TYPE='P' AND NAME='Proc_RptGSTR2Extract')
DROP  PROCEDURE Proc_RptGSTR2Extract
GO
/*
BEGIN tran
EXEC Proc_RptGSTR2Extract 424,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [Proc_RptGSTR2Extract]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptGSTR2Extract
* PURPOSE	: GSTR2 Extract
* CREATED	: Murugan.R
* CREATED DATE	: 06/09/2017
* MODIFIED
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
07/09/2017	Murugan.R	CR		CCRSTAN0150			GSTR2-EXTRACT
*/
BEGIN
SET NOCOUNT ON
		
	DELETE FROM  ReportFilterDt WHERE RptId IN(425,426,427,428,429,430) 
	INSERT INTO ReportFilterDt(RptId,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate)
	SELECT 425,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT 426,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT 427,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT 428,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT 429,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId	
	UNION ALL
	SELECT 430,SelId,SelValue,SelDate,UsrId,LikeOn,LikeText,FilterDate
	FROM ReportFilterDt WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId

	
	DELETE FROM Report_txt_PageHeader_GST WHERE RptId IN(425,426,427,428,429,430)
	INSERT INTO Report_txt_PageHeader_GST(ColId,RptId,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId)
	SELECT ColId,425,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT ColId,426,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT ColId,427,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT ColId,428,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT ColId,429,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	UNION ALL
	SELECT ColId,430,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
	FROM Report_txt_PageHeader_GST WHERE RptId=@Pi_RptId AND UsrId=@Pi_UsrId
	
	
	EXEC Proc_RptGSTR2_B2B 425 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId	
	EXEC Proc_RptGSTR2_B2BUR 426 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
	EXEC Proc_RptGSTR2_HSNSUM 427 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
	EXEC Proc_RptGSTR2_NILRATE 428 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
	EXEC Proc_RptGSTR2_CDN 429 ,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId	
	EXEC Proc_RptGSTR2_Summary 430,@Pi_UsrId,@Pi_SnapId,@Pi_DbName,@Pi_SnapRequired,@Pi_GetFromSnap,@Pi_CurrencyId
			
	
	SELECT * FROM RptGSTR2_B2B WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE name = 'Proc_RptExcelFilterCaption_GST' AND XTYPE = 'P')
DROP PROCEDURE Proc_RptExcelFilterCaption_GST
GO
--EXEC Proc_RptExcelFilterCaption_GST 424,2
--Select * from Report_txt_ExcelFilterCaption_GST
CREATE PROCEDURE [dbo].[Proc_RptExcelFilterCaption_GST]
(
	@RptId			AS INT,	
	@UsrId			AS INT
)
/************************************************
* PROCEDURE  : Proc_RptExcelFilterCaption_GST
* PURPOSE    : To Generate Excel Filter Caption
* CREATED BY : Murugan.R
* CREATED ON : 18/11/2014
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
07/09/2017	Murugan.R	CR		CCRSTAN0150			Modified to delete and insert value In Report_txt_PageHeader_GST
*/
AS
BEGIN	

		DELETE FROM Report_txt_PageHeader_GST WHERE RptId IN(414,415,416,417,418,419,420,421)
		INSERT INTO Report_txt_PageHeader_GST(ColId,RptId,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId)
		SELECT ColId,414,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,415,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,416,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,417,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,418,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,419,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,420,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		UNION ALL
		SELECT ColId,421,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=424 and UsrId=@UsrId
		
		
		DELETE FROM Report_txt_PageHeader_GST WHERE RptId IN(425,426,427,428,429,430)
		INSERT INTO Report_txt_PageHeader_GST(ColId,RptId,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId)
		SELECT ColId,425,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId
		UNION ALL
		SELECT ColId,426,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId
		UNION ALL
		SELECT ColId,427,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId
		UNION ALL
		SELECT ColId,428,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId
		UNION ALL
		SELECT ColId,429,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId
		UNION ALL
		SELECT ColId,430,Filters,FilterValues,Fieldcaption1,Fieldcaption2,UsrId
		FROM Report_txt_PageHeader_GST WHERE RptId=431 AND UsrId=@UsrId

		DELETE FROM Report_txt_ExcelFilterCaption_GST WHERE  Rptid=@RptId and UsrId=@UsrId
		DECLARE @NoOfColPerRow AS INT		
		SELECT @NoOfColPerRow=Ceiling(CAST(COUNT(Colid) AS NUMERIC(5,2))/CAST(2 AS NUMERIC(5,2)))
		FROM Report_txt_PageHeader_GST WHERE RptId=@RptId and UsrId=@UsrId
			
		SELECT Filters as Fieldcaption1,FilterValues,Colid   INTO #RptHeader FROM Report_txt_PageHeader_GST where ColId<=@NoOfColPerRow and Rptid=@RptId and UsrId=@UsrId
		SELECT Filters as Fieldcaption1,FilterValues,Colid-@NoOfColPerRow as  Colid  INTO #RptHeader1 FROM Report_txt_PageHeader_GST where ColId>@NoOfColPerRow  and Rptid=@RptId and UsrId=@UsrId
		INSERT INTO Report_txt_ExcelFilterCaption_GST(RptId,Fieldcaption1,FileterValue,Fieldcaption2,FileterValue1,UsrId)
		SELECT @RptId,S.Fieldcaption1,S.FilterValues,ISNULL(TS.Fieldcaption1,'') as Fieldcaption2,ISNULL(TS.FilterValues,''),@UsrId
		FROM  #RptHeader S
		LEFT OUTER JOIN #RptHeader1 TS ON S.ColId=TS.ColId  WHERE S.ColId<=@NoOfColPerRow 
END
GO
UPDATE RptGroup SET VISIBILITY=0 where RptId  IN(425,426,427,428,429,430)
GO
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='Fn_ReturnExcelReportDynamicMultiSheet' and xtype in ('TF','FN'))
DROP FUNCTION Fn_ReturnExcelReportDynamicMultiSheet
GO
--SELECT * FROM  dbo.Fn_ReturnExcelReportDynamicMultiSheet(424)
CREATE FUNCTION Fn_ReturnExcelReportDynamicMultiSheet(@RptId	AS INT)
RETURNS @MultiSheet TABLE
(
	RptId INT,
	Slno  INT,
	WorkSheetName Varchar(100),	
	RptName Varchar(100),
	RptHeaderName Varchar(100),
	RptTableName Varchar(100)
)
AS
/************************************************
* PROCEDURE  : Fn_ReturnExcelReportDynamicMultiSheet
* PURPOSE    : To Return Multiple Sheet Report Name and Table name
* CREATED BY : R.Murugan
* CREATED ON : 09/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
09/09/2017	Murugan.R	CR		CCRSTAN0150			Modified New ReportId added 431
*/
BEGIN
	If @RptId =424
	BEGIN
		INSERT INTO @MultiSheet(RptId,Slno,WorkSheetName,RptName,RptHeaderName,RptTableName)
		SELECT 420,1,'Docs','GSTR1 Extract','FORM GSTR1-DOCS','RptGSTR1_Docs'
		UNION ALL
		SELECT 421,2,'Exempt','GSTR1 Extract','FORM GSTR1-Exempt','RptFORMGSTR1_Exempt'
		UNION ALL
		SELECT 419,3,'HSN','GSTR1 Extract','FORM GSTR1-HSN','RptGSTR1_HSNCODE'
		UNION ALL
		SELECT 418,4,'CDNUR','GSTR1 Extract','FORM GSTR1-CDNUR','RptGSTRTRANS1_CDNUR'
		UNION ALL
		SELECT 417,5,'CDNR','GSTR1 Extract','FORM GSTR1-CNDR','RptGSTRTRANS1_CDNR'
		UNION ALL
		SELECT 416,6,'B2CS','GSTR1 Extract','FORM GSTR1-B2CS','RptGSTR1_B2CS'
		UNION ALL
		SELECT 415,7,'B2CL','GSTR1 Extract','FORM GSTR1-B2CL','RptGSTR1_B2CL'
		UNION ALL
		SELECT 414,8,'B2B','GSTR1 Extract','FORM GSTR1-B2B','RptGSTR1_B2B'		
	END
	If @RptId =431
	BEGIN
		INSERT INTO @MultiSheet(RptId,Slno,WorkSheetName,RptName,RptHeaderName,RptTableName)
		SELECT 430,1,'Summary','GSTR2 Extract','FORM GSTR2-Summary','RptGSTR2_Summary'
		UNION ALL
		SELECT 427,2,'HSN','GSTR2 Extract','FORM GSTR2-HSN','RptGSTR2_HSNSUM'
		UNION ALL
		SELECT 428,3,'NIL RATE','GSTR2 Extract','FORM GSTR2-NIL RATE','RptGSTR2_NILRATE'
		UNION ALL
		SELECT 429,4,'CDN','GSTR2 Extract','FORM GSTR2-CDN','RptGSTR2_CDN'
		UNION ALL
		SELECT 426,5,'B2BUR','GSTR2 Extract','FORM GSTR2-B2BUR','RptGSTR2_B2BUR'
		UNION ALL
		SELECT 425,6,'B2B','GSTR2 Extract','FORM GSTR2-B2B','RptGSTR2_B2B'
				
	END

RETURN
END
GO
IF EXISTS (SELECT '*' FROM SYSOBJECTS WHERE NAME = 'Fn_ReturnExcelReportFilter' AND XTYPE IN('TF','FN'))
DROP FUNCTION Fn_ReturnExcelReportFilter
GO
--SELECT dbo.Fn_ReturnExcelReportFilter(411) as status
CREATE FUNCTION Fn_ReturnExcelReportFilter(@RptId AS INT,@RefType AS INT)
RETURNS INT
/************************************************
* FUNCTION  : Fn_ReturnExcelReportFilter
* PURPOSE    : To Return Report id
* CREATED BY : R.Murugan
* CREATED ON : 09/08/2017
* MODIFICATION
*************************************************
* DATE       AUTHOR     CR/BZ	USER STORY ID		DESCRIPTION					
*************************************************
09/09/2017	Murugan.R	CR		CCRSTAN0150			Modified New ReportId added 425,426,427,428,429,430
*/
AS
BEGIN

DECLARE @ReturnVal AS INT
SET @ReturnVal=0
	
	IF @RefType=0
	BEGIN
		IF @RptId in (268 ,291 ,292,411,413,414,415,416,417,418,419,420,421,422,423,425,426,427,428,429,430)
		BEGIN
			SET @ReturnVal=1
		END
	END
	ELSE IF @RefType=1
	BEGIN
		IF @RptId in (411,413)
		BEGIN
			SET @ReturnVal=1
		END
		IF @RptId in (424,431)
		BEGIN
			SET @ReturnVal=2
		END				
	END	
RETURN @ReturnVal
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptPurchaseTaxGST' AND XTYPE='P')
DROP PROCEDURE Proc_RptPurchaseTaxGST
GO
CREATE PROCEDURE [Proc_RptPurchaseTaxGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptPurchaseTaxGST
* PURPOSE	: To get the GST Purchase Tax details
* CREATED	: Raja C
* CREATED DATE	: 20/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))	
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptPurchaseTaxGST')
	BEGIN
		DELETE FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(   
		    [GRN No] NVarchar(100),
            [GRN date] DateTime,
			[InvDate] DateTime,
			[InvId] [bigint] NULL,
			[RefNo] [varchar](100) NULL,
			[ODN Number] [varchar](100) NULL,
			[SupplierCode] Varchar(75),
			[SupplierName] Varchar(150),
			[SupplierAddress] Varchar(150),
			[Supplier GSTIN] Varchar(150),
			[Supplier State] Varchar(150),
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[SpmId] [int] NULL,
			[Prdid] [int] NULL,
			[InvQty] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,	
			[LineNetAmount] Numeric(36,6),
			[UPC] INT,
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		SELECT Prdid,Max(ConversionFactor) as UPC 
		INTO #UOM
		FROM Product P (NOLOCK) INNER JOIN Uomgroup UG (NOLOCK) ON P.UomGroupId=UG.UomGroupId
		GROUP BY Prdid
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId])
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,'Purchase' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId   
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId 
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		WHERE PR.InvDate  Between @FromDate and @ToDate and PR.Status=1
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount) >0  
			
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,GoodsRcvdDate,PR.InvDate AS InvDate,PR.PurRcptId AS InvId,CmpInvNo AS RefNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,SUM(PRP.RcvdGoodBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +'Value' as TaxPerc,
		SUM(TaxableAmount) as TaxableAmount,'Purchase' as IOTaxType,1 as TaxFlag,SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReceipt PR WITH (NOLOCK)  
		INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
		INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId    
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,GoodsRcvdDate,PR.PurRcptId,PR.InvDate,CmpInvNo,PR.PurOrderRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING  SUM(PRPT.TaxAmount+PRPT.TaxableAmount) > 0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Rate' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,'PurchaseReturn' as IOTaxType,0 as TaxFlag,TaxPerc as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId  
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))) 
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING SUM(TaxableAmount) >0 		
		
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT PurRcptRefNo,'' AS [GRN date],PurRetDate AS InvDate,PR.PurRetId AS InvId,PurRetRefNo AS RefNo,'',SpmCode,SpmName,SpmAdd1,'' as SupplierGSTIN,'' as SupplierState,
		PrdName,PrdCCode,'' as [HSN Code],S.SpmId AS SpmId,P.PrdId as Prdid,-1*SUM(PRP.RetInvBaseQty) AS InvQty,  
		C.CmpId AS CmpId,TC.TaxCode +' Value' as TaxPerc,
		-1*SUM(TaxableAmount) as TaxableAmount,'PurchaseReturn' as IOTaxType,1 as TaxFlag,-1*SUM(PRPT.TaxAmount) as TaxPercent,PRPT.TaxId,
		-1*SUM(PrdNetAmount) as [LineNetAmount],UPC,'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		PurchaseReturn  PR WITH (NOLOCK)  
		INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
		INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId
		INNER JOIN #UOM U ON U.Prdid=P.Prdid and U.PrdId=PRP.PrdId     
		INNER JOIN ProductBatch PB WITH (NOLOCK) ON PB.PrdId = PRP.PrdId AND PB.PrdBatId = PRP.PrdBatId AND PB.PrdId = P.PrdId  
		INNER JOIN Supplier S WITH (NOLOCK) ON S.SpmId = PR.SpmId
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRPT.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId 
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))  
		WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1
		Group By PurRcptRefNo,PurRetDate,PR.PurRetId,PurRetRefNo,SpmCode,SpmName,SpmAdd1,PrdName,PrdCCode,S.SpmId,P.PrdId,
		C.CmpId,TC.TaxCode,TaxPerc,PRPT.TaxId,[UPC]
		HAVING Sum(TaxableAmount+PRPT.TaxAmount) >0 
		
		INSERT INTO #TmpRptIOTaxSummary([GRN No],[GRN date],[InvDate],[InvId],[RefNo],[ODN Number],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],[TaxPerc],[TaxableAmount],[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],LineNetAmount,[UPC],[Group Name],[GroupType],[UsrId]) 
		SELECT  '' AS [GRN No],'' AS [GRN date],NULL, 0 [InvId],'' AS [RefNo],'' AS [ODN Number],'' AS [SupplierCode],'' AS [SupplierName],''AS [SupplierAddress],'' AS [Supplier GSTIN],
		'' AS [Supplier State],'' AS [Product Name] ,'' AS [Product Code],'' AS [HSN Code],0 [SpmId],0 as Prdid,0 as [InvQty],0 as[CmpId],  [TaxPerc] ,0 as [TaxableAmount],'' as [IOTaxType] ,
		100 as [TaxFlag],SUM([TaxPercent]) as [TaxPercent],0 as [TaxId],0 as  LineNetAmount,0 as [UPC],'ZZZZZZ' as [Group Name],3 as [GroupType],[UsrId]
		FROM #TmpRptIOTaxSummary WHERE TaxFlag=1		
		GROUP BY [UsrId],[TaxPerc]
		
		
		SELECT StateCode,StateName,TinFirst2Digit,MasterRecordId
		INTO #SupplierState 
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN UdcDefault D (NOLOCK) ON D.MasterId=C.MasterId and D.MasterId=B.MasterId
		and D.UdcMasterId=C.UdcMasterId and D.UdcMasterId=B.UdcMasterId
		INNER JOIN StateMaster E (NOLOCK) ON E.StateName=D.ColValue and E.StateName=C.ColumnValue
		WHERE MasterName='Supplier Master' and ColumnName='State Name'
		
					
		UPDATE A  SET A.[Supplier State]=B.StateName 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierState  B  ON A.Spmid=B.MasterRecordId
		
		SELECT MasterRecordId,ColumnName AS SupplierGSTIN
		INTO #SupplierGSTIN
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId	
		WHERE MasterName='Supplier Master' and ColumnName='GSTIN'
		
        UPDATE A  SET A.[Supplier GSTIN]=B.SupplierGSTIN 
		FROM #TmpRptIOTaxSummary A 
		INNER JOIN  #SupplierGSTIN  B  ON A.Spmid=B.MasterRecordId
		
		
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master' and ColumnName='HSN Code'
		
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptProductWiseSalesTaxGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		
		
--		--Remove Duplicate [TaxableAmount] and LinelevelNetAmount
        SELECT DISTINCT
		[GRN No],[GRN date],[InvDate],[InvId],[RefNo],[SupplierCode],[SupplierName],[SupplierAddress],
		[Supplier GSTIN],[Supplier State],[Product Name] ,[Product Code],[HSN Code],[SpmId],[Prdid],[InvQty],[CmpId],
		[TaxableAmount],[IOTaxType],[TaxFlag],LineNetAmount,[UsrId]
		INTO #LineLevelGross	
		FROM #TmpRptIOTaxSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50),
			TaxId INT
		)
		INSERT INTO #DynamicCol(Taxperc,TaxId)
		SELECT DISTINCT Taxperc,TaxId FROM #TmpRptIOTaxSummary WHERE TaxFlag IN(0,1) and GroupType=2
		ORDER BY TaxId	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxperc)+',0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'InvDate,[ODN Number],[Product Code],[Product Name],[HSN Code],[UPC],InvQty,TaxableAmount,'+@ColSelect+'LineNetAmount,[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'Slno BIGINT IDENTITY(1,1),[SupplierCode] Varchar(75),[SupplierName] Varchar(150),[SupplierAddress] Varchar(150),[Supplier GSTIN] Varchar(150),'+
        '[Supplier State] Varchar(150),[IOTaxType] [varchar](100) NULL,[GRN No] NVarchar(100),[GRN date] DateTime,[Invoice Number] NVarchar(100),[Invoice Date] Datetime,[ODN Number] Varchar(100),'+
        '[Product Code] Varchar(75),[Product Name] Varchar(150),[HSN Code] Varchar(50),UPC INT,[InvQty] [int] NULL,[TaxableAmount] [numeric](38, 6) NULL,'
		SET @Columns1='SELECT SupplierCode,SupplierName,SupplierAddress,[Supplier GSTIN],[Supplier State],IOTaxType,[GRN No],[GRN date],RefNo,'+
        'Invdate,[ODN Number],[Product Code],[Product Name],[HSN Code],UPC,[InvQty],[TaxableAmount],LineNetAmount,TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],IOTaxType,Invdate,SupplierName,[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptPurchaseTaxGST'' and XTYPE=''U'')'+
		' DROP TABLE RptPurchaseTaxGST'+
		' CREATE TABLE RptPurchaseTaxGST ('+@TableCol+@ColSelectDataType+' LineNetAmount Numeric(36,2),[Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		--PRINT @CreateTable
	    EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptPurchaseTaxGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		--PRINT @SQL
		EXEC(@SQL)
		----GRAND TOTAL UPDATE
		SELECT 'ZZZZZZ' as [Group Name], 3 as GroupType ,SUM([InvQty]) as [InvQty],SUM(LineNetAmount) as LineNetAmount,SUM(TaxableAmount) as TaxableAmount
		INTO #GrandTotal
		FROM #LineLevelGross WHERE TaxFlag=0 and [UsrId]=@Pi_UsrId
		UPDATE Y SET  
		Y.[InvQty]=X.[InvQty] ,Y.LineNetAmount=X.[LineNetAmount],Y.[TaxableAmount]=X.TaxableAmount 
		FROM RptPurchaseTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType WHERE Y.[UsrId]=@Pi_UsrId
		---TILL HERE
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,402,'Product Wise Input Tax',1,'Supplier State',20,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',2,'SupplierCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',3,'SupplierName',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',4,'SupplierAddress',75,1,0,1,1,'Supplier','Address','',0,GETDATE()			
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',5,'IOTaxType',75,1,0,1,1,'Purchase/','PurReturn','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',6,'GRN No',75,1,0,1,1,'GRN.','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',7,'GRN date',75,1,0,1,4,'GRN.','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',8,'Invoice Number',75,1,0,1,1,'Comp InvoiceNo/','ReturnRefNo','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',9,'Invoice Date',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',10,'[ODN Number]',75,1,0,1,1,'Purchase Order','Number','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',11,'Product Code',75,1,0,1,1,'Product Code','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',12,'Product Name',75,1,0,1,1,'Product Name','','',0,GETDATE()
			UNION ALL			
			SELECT 1,402,'Product Wise Input Tax',13,'HSN Code',75,1,0,1,1,'HSN Code','','',0,GETDATE()
			UNION ALL		
			SELECT 1,402,'Product Wise Input Tax',14,'UPC',20,1,0,2,2,'UPC','','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',15,'InvQty',75,1,0,2,2,'Total','Quantity','',0,GETDATE()
			UNION ALL
			SELECT 1,402,'Product Wise Input Tax',16,'TaxableAmount',20,1,0,2,3,'Taxable','Amount','',2,GETDATE()
		
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,SUBSTRING(@PCSelect, @start, @end - @start)				
				,'','',2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'LineNetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptProductWiseSalesTaxGST
			WHERE UsrId=@Pi_UsrId
			SELECT * FROM RptPurchaseTaxGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptInputtaxCreditGST' AND XTYPE='P')
DROP PROCEDURE Proc_RptInputtaxCreditGST
GO
/*
BEGIN tran
EXEC Proc_RptInputtaxCreditGST 405,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST
ROLLBACK tran 
*/
CREATE PROCEDURE [dbo].[Proc_RptInputtaxCreditGST]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputtaxCreditGST
* PURPOSE	: To get the Input Tax
* CREATED	: Murugan.R
* CREATED DATE	: 25/08/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	--SET @FromDate='2017-05-01'
	--SET @ToDate='2017-07-30'
	--select * from ReportFilterDt
	
		TRUNCATE TABLE RptInputtaxCreditGST
		DECLARE @DynamicLineAmountFields as VARCHAR(300)
		DECLARE @DynamicLineAmountFields1 as VARCHAR(300)
		DECLARE @DynamicLineAmountFields2 as VARCHAR(300)
		CREATE TABLE #TaxHSNSummary
		(
			StateCode Varchar(20),
			StateName Varchar(100),
			GSTin Varchar(50),
			SpmCode Varchar(50),
			Spmname Varchar(100),	
			Refid BIGINT,
			RefNo Varchar(50),
			CmpInvno Varchar(50),
			PurchaseOrderNo Varchar(50),
			InvoiceDate Datetime,
			RefDate DateTime,
			SpmId INT,
			GrossAmount Numeric(18,4),
			TaxableAmount Numeric(32,4),
			NetAmount numeric(24,4),
			Taxname Varchar(100),
			DynamicAmt Numeric(24,4),
			TaxType Varchar(50),
			SalesOrderType TinyInt,
			TaxFlag TinyInt	,
			Taxper Numeric(10,2),
			TaxId INT,
			[Group Name] varchar(50),
			[GroupType] Tinyint,
			[UsrId] INT
		)
		SELECT PurRcptId,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseTaxableAmount
		FROM(
		SELECT S.PurRcptId,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId
		WHERE  TaxableAmount>0 and Status=1
		AND SI.InvDate   Between @FromDate AND @ToDate and VatGST='GST'
		GROUP BY S.PurRcptId,PrdSlno 
		)X GROUP BY PurRcptId,Prdslno
		
		SELECT PurRetId,Prdslno,SUM(TaxableAmount) as TaxableAmount
		INTO #PurchaseRtnTaxableAmount
		FROM(
		SELECT S.PurRetId,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount
		FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId
		WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1
		GROUP BY S.PurRetId,PrdSlno
		)X GROUP BY  PurRetId,Prdslno
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId
		WHERE S.InvDate 	Between @FromDate and @ToDate and VatGST='GST'
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,
		SUM(ST.TaxableAmount),SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReceipt S (NOLOCK) 
		INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId
		INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE S.InvDate 	Between @FromDate and @ToDate
		and SPT.TaxableAmount>0  and Status=1
		GROUP BY S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,
		InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		0 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		UNION ALL
		SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,
		S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,
		-1*SUM(ST.TaxableAmount),-1*SUM(PrdNetAmount) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,
		-1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,
		1 as TaxFlag,TaxPerc,SPT.TaxId,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]
		FROM PurchaseReturn S (NOLOCK) 
		INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId
		INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo
		INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo
		INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId
		INNER JOIn Supplier R ON R.SpmId=S.SpmId		
		WHERE PurRetDate	Between @FromDate and @ToDate and Status=1
		and SPT.TaxableAmount>0
		GROUP BY S.PurRetId,PurRetDate,R.SpmId,TaxCode,TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
		
		INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,
		Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,
		Taxper,TaxId,[Group Name],[GroupType],[UsrId])		
		SELECT  '','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,NUll,Null,0,0 as GrossAmount,0 as NetAmount,
		Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,
		Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]
		FROM #TaxHSNSummary 
		GROUP BY Taxname,Taxper,TaxId
	
		UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,
		B.Statename=A.StateName,
		B.GSTIN=A.GSTIN
		FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId
		
		SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo
		INTO #Refcode
		FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId
		
		UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo 
		FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
		SET @DynamicLineAmountFields='0 as NetAmount,'
		SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'
		SET @DynamicLineAmountFields2='SUM(NetAmount) as NetAmount,'
		
		IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)
		BEGIN
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
			RETURN
		END
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		DECLARE @SumCol AS Varchar(Max)
		DECLARE @GroupByCol AS VARCHAR(Max)
		SET @GroupByCol=''
		SET @SumCol=''
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		CREATE TABLE #DynamicCol
		(
		Slno INT IDENTITY(1,1),
		Taxname	Varchar(50),
		TaxId INT,
		TaxPer Numeric(12,2),
		TaxFlag TinyInt		
		)
		INSERT INTO #DynamicCol		
		SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		--SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		
		SELECT @SumCol=@SumCol+'ISNULL(SUM('+QuoteName(Taxname)+'),0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,SUM(TaxableAmount) as TaxableAmount,'+@SumCol+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'
		SET @GroupByCol=' GROUP BY StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,[Group Name],[GroupType],[UsrId]'
	
		
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'StateCode Varchar(20),
		StateName Varchar(100),
		GSTin Varchar(50),
		SpmId INT,
		SpmCode Varchar(50),
		Spmname Varchar(100),		
		Refid BIGINT,
		RefNo Varchar(50),
		CmpInvno Varchar(50),
		PurchaseOrderNo Varchar(50),
		InvoiceDate Datetime,
		RefDate DateTime,
		TaxType Varchar(50),	
		SalesOrderType TinyInt,
		TaxableAmount Numeric(34,4),'
		SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,TaxType,SalesOrderType,TaxableAmount,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'
		SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptInputtaxCreditGST'' and XTYPE=''U'')'+
		' DROP TABLE RptInputtaxCreditGST'+
		' CREATE TABLE RptInputtaxCreditGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO RptInputtaxCreditGST '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
		' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+
		')PVTTax '+ @GroupByCol+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)
		SELECT DISTINCT
		StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,TaxableAmount,NetAmount
		INTO #LineLevelGross
		FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0
		SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount
		INTO #GrandTotal
		FROM #LineLevelGross 
		UPDATE Y SET  
		Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount
		FROM RptInputtaxCreditGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]
		AND X.GroupType=Y.GroupType 
		
		
			DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
			FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
			RoundOff,CreatedDate)
			SELECT 1,405,'Input Tax Summary',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',9,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',10,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',11,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()
			UNION ALL
			SELECT 1,405,'Input Tax Summary',12,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()
			SET @Str=''
			SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId
			GROUP BY ReportId
	
			
			DECLARE @Caption1 as Varchar(30)
			DECLARE @Caption2 as Varchar(30)
			DECLARE @Caption3 as Varchar(30)
			SET @Caption1=''
			SET @Caption2=''
			SET @Caption3=''
			
			SELECT @start = 1, @end = CHARINDEX(',', @PCSelect) 
			WHILE @start < LEN(@PCSelect) + 1 BEGIN 
				IF @end = 0  
				SET @end = LEN(@PCSelect) + 1
				SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)
				--SELECT @Str,'T'
				SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)
				SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)
				SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')
				--SELECT @Caption1,@Caption2,@Caption3
				
				INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
				FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
				CreatedDate)  
				SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),
				18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)				
				,@Caption2,@Caption3,2,Getdate()
				FROM Report_Template_GST WHERE RptId=@Pi_RptId
				
				SET @start = @end + 1 
				SET @end = CHARINDEX(',', @PCSelect, @start)
				SET @MaxId=@MaxId+1
			END 
			
			INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,
			FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,
			CreatedDate)  
			SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',
			18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()
			FROM Report_Template_GST WHERE RptId=@Pi_RptId	
			
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),
			HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),
			HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),
			HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			
			
			IF NOT EXISTS(SELECT 'X' FROM RptInputtaxCreditGST)
			BEGIN
				SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
				RETURN
			END
			
			SELECT * FROM RptInputtaxCreditGST WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptInputOutputProductWiseGSTTax' AND XTYPE='P')
DROP PROCEDURE Proc_RptInputOutputProductWiseGSTTax
GO
--Select * from Users
---EXEC Proc_RptInputOutputProductWiseGSTTax 407,1,0,'',0,0,1
--Select * from RptInputOutPutGSTTax where [Product Code]='40017593'
--Select * from Purchasereturn
--Select * from ReturnProductTax order by LastModDate Desc
CREATE PROCEDURE [dbo].[Proc_RptInputOutputProductWiseGSTTax]
(
	@Pi_RptId			INT,
	@Pi_UsrId			INT,
	@Pi_SnapId			INT,
	@Pi_DbName			nvarchar(50),
	@Pi_SnapRequired	INT,
	@Pi_GetFromSnap		INT,
	@Pi_CurrencyId		INT
)
AS
/*********************************
* PROCEDURE	: Proc_RptInputOutputProductWiseGSTTax
* PURPOSE	: To get the Tax details
* CREATED	: Murugan.R
* CREATED DATE	: 12/05/2017
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
BEGIN
SET NOCOUNT ON
	--Filter Variable
	DECLARE @FromDate		AS	DATETIME
	DECLARE @ToDate			AS	DATETIME
	DECLARE @CmpId	        AS	INT
	DECLARE @ErrNo	 	AS	INT
		
	DECLARE @SQL as Varchar(MAX)
	DECLARE @MaxId as INT
	DECLARE @ReportId as INT
	DECLARE @start INT, @end INT 
	DECLARE @Str AS VARCHAR(100)
	DECLARE @CreateTable AS VARCHAR(7000)
		
	SET @ErrNo=0
	SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)
	SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)
	SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))
	
	
	IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE XTYPE='U' AND NAME='RptInputOutPutGSTTax')
	BEGIN
		TRUNCATE TABLE RptInputOutPutGSTTax
	END
	
	IF EXISTS(SELECT NAME FROM Tempdb..SYSOBJECTS WHERE XTYPE='U' AND NAME='##RptInputOutPutGSTTax')
	BEGIN
		DROP TABLE ##RptInputOutPutGSTTax
	END
	
		CREATE TABLE #TmpRptIOTaxSummary
		(
			[Product Name] Varchar(150),			
			[Product Code] Varchar(75),
			[HSN Code] Varchar(75),
			[Prdid] [int] NULL,
			[CmpId] [int] NULL,
			[TaxPerc] [varchar](50) NULL,
			[TaxableAmount] [numeric](38, 6) NULL,
			InputQty INT,
			OutPutQty INT,
			[IOTaxType] [varchar](100) NULL,
			[TaxFlag] [int] NULL,
			[TaxPercent] [numeric](38, 6) NULL,
			[TaxId] [int] NULL,			
			[Group Name]  Varchar(200),
			[GroupType] INT,
			[UsrId] [int] NULL
		)
		
		CREATE TABLE #PurchaseVsSales
		(
			TransId TinyInt,
			PrdId INT,
			InOutPutQty INT,
			TaxableAmount Numeric(32,4),
			TaxAmount Numeric(25,4),
			TaxPerc Numeric(10,2),
			TaxId INT
		)
		
		
		CREATE TABLE ##RptInputOutPutGSTTax(
		[SLNO] [bigint] IDENTITY(1,1) NOT NULL,
		[Product Name] [varchar](150) NULL,
		[Product Code] [varchar](75) NULL,
		[HSN Code] [varchar](50) NULL,
		[InPutQty] [int] NULL,
		[OutPutQty] [int] NULL,
		[TaxableAmount] [numeric](38, 6) NULL,
		[InputCGST Rate] [numeric](36, 2) NULL,
		[InputCGST Value] [numeric](36, 2) NULL,
		[InputSGST Rate] [numeric](36, 2) NULL,
		[InputSGST Value] [numeric](36, 2) NULL,
		[InputIGST Rate] [numeric](36, 2) NULL,
		[InputIGST Value] [numeric](36, 2) NULL,
		[InputUTGST Rate] [numeric](36, 2) NULL,
		[InputUTGST Value] [numeric](36, 2) NULL,
		[OutputCGST Rate] [numeric](36, 2) NULL,
		[OutputCGST Value] [numeric](36, 2) NULL,
		[OutputSGST Rate] [numeric](36, 2) NULL,
		[OutputSGST Value] [numeric](36, 2) NULL,
		[OutputIGST Rate] [numeric](36, 2) NULL,
		[OutputIGST Value] [numeric](36, 2) NULL,
		[OutputUTGST Rate] [numeric](36, 2) NULL,
		[OutputUTGST Value] [numeric](36, 2) NULL,
		[Group Name] [varchar](100) NULL,
		[Grouptype] [tinyint] NULL,
		[UsrId] [int] NULL
		)
		CREATE TABLE #SalesInvoiceProductTax
		(
		[SalId] [bigint] NOT NULL,
		[PrdSlNo] [int] NOT NULL,
		[TaxId] [int] NOT NULL,
		[TaxPerc] [numeric](10, 6) NOT NULL,
		[TaxableAmount] [numeric](18, 6) NOT NULL,
		[TaxAmount] [numeric](18, 6) NOT NULL
		)
		INSERT INTO #PurchaseVsSales(TransId,PrdId,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)		
		SELECT 1 as TransId ,Prdid,SUM(InputQty) as InputQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM
		(
			SELECT PrdId ,SUM(PRP.RcvdGoodBaseQty) as InputQty,
			SUM(TaxableAmount) as TaxableAmount,
			SUM(PRPT.TaxAmount) as TaxAmount,TaxPerc ,PRPT.TaxId		
			FROM 
			PurchaseReceipt PR WITH (NOLOCK)  
			INNER JOIN PurchaseReceiptProduct PRP WITH (NOLOCK) ON PR.PurRcptId=PRP.PurRcptId 
			INNER JOIN PurchaseReceiptProductTax PRPT WITH (NOLOCK) ON PR.PurRcptId=PRPT.PurRcptId AND  PRP.PurRcptId=PRPT.PurRcptId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			WHERE PR.InvDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId
			HAVING Sum(TaxableAmount) >0  
			UNION ALL
			SELECT Prdid,-1*SUM(RetSalBaseQty+RetUnSalBaseQty) as InputQty,
					-1*SUM(PRPT.TaxableAmount) as TaxableAmount,
					-1*SUM(PRPT.TaxAmount) as TaxAmount, TaxPerc ,PRPT.TaxId
			
			FROM 
			PurchaseReturn  PR WITH (NOLOCK)  
			INNER JOIN PurchaseReturnProduct PRP WITH (NOLOCK) ON PR.PurRetId=PRP.PurRetId 
			INNER JOIN PurchaseReturnProductTax PRPT WITH (NOLOCK) ON PR.PurRetId=PRPT.PurRetId AND  PRP.PurRetId=PRPT.PurRetId  AND PRP.PrdSlNo=PRPT.PrdSlNo 
			WHERE PR.PurRetDate Between @FromDate and @ToDate and PR.Status=1 and VatGst='GST'
			GROUP BY PrdId,TaxPerc,PRPT.TaxId
			HAVING SUM(TaxableAmount) >0 		
		)X GROUP BY Prdid,TaxPerc,TaxId

		INSERT INTO #PurchaseVsSales(TransId,PrdId,InOutPutQty,TaxableAmount,TaxAmount,TaxPerc,TaxId)
		SELECT 2 as TransId ,Prdid,SUM(OutPutQty) as OutPutQty,
		SUM(TaxableAmount) as TaxableAmount,
		SUM(TaxAmount) as TaxAmount,TaxPerc,TaxId
		FROM(
				SELECT Prdid,SUM(BaseQty) as OutPutQty,
				SUM(TaxableAmount)	AS TaxableAmount,
				SUM(TaxAmount) as TaxAmount,TaxPerc,SPT.TaxId
				FROM 
				SalesInvoice SI WITH (NOLOCK)  
				INNER JOIN SalesInvoiceProduct SIP WITH (NOLOCK) ON SI.SalId = SIP.SalId  
				INNER JOIN SalesInvoiceProductTax SPT  ON SPT.SalId = SIP.SalId AND SPT.SalId = SI.SalId AND SIP.SlNo=SPT.PrdSlNo  
				WHERE SI.Salinvdate Between @FromDate and @ToDate 
				and SI.Dlvsts >3 and VatGst='GST' and SPT.TaxableAmount>0
				GROUP BY TaxPerc,PrdId,SPT.TaxId				
				UNION ALL
				Select Prdid,-1*SUM(BaseQty) as OutPutQty,	
				-1*SUM(TaxableAmt) AS TaxableAmount	,
				-1*SUM(RPT.TaxAmt),TaxPerc,RPT.TaxID
				FROM ReturnHeader RH WITH (NOLOCK)  
				INNER JOIN ReturnProduct RP WITH (NOLOCK) ON RH.ReturnId = RP.ReturnId ---AND RP.LineType=1  
				INNER JOIN ReturnProductTax RPT WITH (NOLOCK) ON RPT.ReturnId = RH.ReturnId AND RPT.ReturnId = RP.ReturnId AND RP.SlNo=RPT.PrdSlNo  
				WHERE RH.Status = 0  and RH.ReturnDate  Between @FromDate and @ToDate and VatGst='GST'
				and RPT.TaxableAmt>0
				GROUP BY TaxPerc,PrdId,RPT.TaxId
				 
		) X GROUP BY Prdid,TaxPerc,TaxId
			
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Rate'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Rate'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Rate'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Rate'
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty as InputQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST')
		and TransId=1
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('InputIGST','IGST') THEN 'InputIGST Value'
				WHEN TaxCode IN ('InputCGST','CGST') Then 'InputCGST Value'
				WHEN TaxCode IN ('InputSGST','SGST') Then 'InputSGST Value'
				WHEN TaxCode IN ('InputUTGST','UTGST') Then 'InputUTGST Value'
		END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		InOutPutQty,0 as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('InputCGST','InputSGST','InputIGST','InputUTGST','CGST','SGST','IGST','UTGST')
		and TransId=1
	
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Rate'
						WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Rate'
						WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Rate'
						WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Rate'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0 as InputQty,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxPerc as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST')
		and TransId=2
		
		
		INSERT INTO #TmpRptIOTaxSummary([Product Name] ,[Product Code],[HSN Code],[Prdid],[CmpId],[TaxPerc],[TaxableAmount],InputQty,OutPutQty,[IOTaxType] ,
		[TaxFlag],[TaxPercent],[TaxId],[Group Name],[GroupType],[UsrId])
		SELECT PrdName,PrdCCode,'' as [HSN Code],P.PrdId as Prdid,  
		C.CmpId AS CmpId,
		CASE	WHEN TaxCode IN('OutputIGST','IGST') THEN 'OutputIGST Value'
						WHEN TaxCode IN ('OutputCGST','CGST') Then 'OutputCGST Value'
						WHEN TaxCode IN ('OutputSGST','SGST') Then 'OutputSGST Value'
						WHEN TaxCode IN ('OutputUTGST','UTGST') Then 'OutputUTGST Value'
				END	 as TaxPerc,
		TaxableAmount as TaxableAmount,
		0,InOutPutQty as OutPutQty,'Purchase-Sales' as IOTaxType,1 as TaxFlag,PRP.TaxAmount as TaxPercent,PRP.TaxId,
		'' as [Group Name] ,2 as [GroupType],@Pi_UsrId AS UserId  
		FROM 
		#PurchaseVsSales PRP
		INNER JOIN Product P WITH (NOLOCK) ON P.PrdId = PRP.PrdId 
		INNER JOIN TaxConfiguration TC (NOLOCK) ON TC.TaxId =PRP.TaxId    
		LEFT OUTER JOIN Company C ON C.CmpId = P.CmpId   
		AND (C.CmpId = (CASE @CmpId WHEN 0 THEN C.CmpId ELSE 0 END) OR
		C.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))
		WHERE TaxCode IN('OutputCGST','OutputSGST','OutputIGST','OutputUTGST','CGST','SGST','IGST','UTGST')
		and TransId=2
		
				
		UPDATE TR SET  [HSN Code]=C.ColumnValue
		FROM UDCHD A (NOLOCK)
		INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId
		INNER JOIN UdcDetails C (NOLOCK) ON B.MasterId=C.MasterId
		and B.UdcMasterId=C.UdcMasterId
		INNER JOIN #TmpRptIOTaxSummary TR ON TR.Prdid=C.MasterRecordId
		WHERE MasterName='Product Master'  and ColumnName='HSN Code'
		
	
		
		IF NOT EXISTS(SELECT 'X' FROM #TmpRptIOTaxSummary)
		BEGIN		
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax	WHERE UsrId=@Pi_UsrId			
			RETURN
		END
				
		DECLARE @ColSelect AS Varchar(MAX)
		DECLARE @ColSelectDataType AS Varchar(5000)
		DECLARE @TableCol AS Varchar(2000)
		DECLARE @Columns1 AS Varchar(7000)
		DECLARE @OrderBy AS VARCHAR(2000)
		DECLARE @PCSelect AS VARCHAR(3000)
		SET @PCSelect=''
		SET @ColSelect=''
		SET @ColSelectDataType=''
		SET @TableCol=''
		SET @Columns1=''
		SET @CreateTable=''
		SET @OrderBy=''
		
		CREATE TABLE #DynamicCol
		(
			Slno INT IDENTITY(1,1),
			Taxperc	Varchar(50)		
		)
		
		INSERT INTO #DynamicCol
		SELECT 'OutputIGST Rate'
		UNION
		SELECT 'OutputCGST Rate'
		UNION
		SELECT 'OutputSGST Rate'
		UNION
		SELECT 'OutputUTGST Rate'
		UNION
		SELECT 'OutputIGST Value'
		UNION
		SELECT 'OutputCGST Value'
		UNION
		SELECT 'OutputSGST Value'
		UNION
		SELECT 'OutputUTGST Value'
		UNION
		SELECT 'InputIGST Rate'
		UNION
		SELECT 'InputCGST Rate'
		UNION
		SELECT 'InputSGST Rate'
		UNION
		SELECT 'InputUTGST Rate'
		UNION
		SELECT 'InputIGST Value'
		UNION
		SELECT 'InputCGST Value'
		UNION
		SELECT 'InputSGST Value'
		UNION
		SELECT 'InputUTGST Value'
	
	
		SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxperc)+',0) as '+QuoteName(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SELECT @PCSelect=@PCSelect+Quotename(Taxperc)+',' FROM #DynamicCol ORDER BY Slno
		SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)
		SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxperc)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno
		SET @ColSelect='SELECT [Product Name],[Product Code],[HSN Code],InPutQty,OutPutQty,[TaxableAmount],'+@ColSelect+'[Group Name],[GroupType],[UsrId]'
		SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+
		'[Product Name] Varchar(150),[Product Code] Varchar(75),[HSN Code] varchar(50),'+		
		'InPutQty INT,OutPutQty INT,[TaxableAmount] [numeric](38, 6) NULL,'
	
		SET @Columns1='SELECT [Product Name],[Product Code],[HSN Code],InPutQty,OutPutQty,[TaxableAmount],TaxPercent ,Taxperc,[Group Name],[GroupType],[UsrId] FROM #TmpRptIOTaxSummary'
		SET @OrderBy=' ORDER BY [Group Name],[GroupType],[Product Name]'
		SET @CreateTable=' IF EXISTS(SELECT * FROM Tempdb..SYSOBJECTS WHERE NAME=''##RptInputOutPutGSTTax'' and XTYPE=''U'')'+
		' DROP TABLE ##RptInputOutPutGSTTax'+
		' CREATE TABLE ##RptInputOutPutGSTTax ('+@TableCol+@ColSelectDataType+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'
		PRINT @CreateTable
		EXEC(@CreateTable)
		SET @SQL=' INSERT INTO ##RptInputOutPutGSTTax '+ @ColSelect+ ' FROM'+
		'('+@Columns1+
		') PS'+
		' PIVOT'+
		'('+
			' SUM(TaxPercent) FOR Taxperc IN('+@PCSelect+')'+
		')PVTTax '+ @OrderBy
		PRINT @SQL
		EXEC(@SQL)

		SELECT [Product Name],[Product Code],[HSN Code],SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		SUM([InputCGST Rate]) as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		SUM([InputSGST Rate]) as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		SUM([InputIGST Rate]) as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		SUM([InputUTGST Rate]) as  [InputUTGST Rate],SUM([InputUTGST Value]) as [InputUTGST Value],
		SUM([OutputCGST Rate]) as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		SUM([OutputSGST Rate]) as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		SUM([OutputIGST Rate]) as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		SUM([OutputUTGST Rate]) as [OutputUTGST Rate] ,SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		[Group Name],Grouptype,UsrId
		INTO #RptProductTaxGroup
		FROM ##RptInputOutPutGSTTax		
		GROUP BY [Product Name],[Product Code],[HSN Code],[Group Name],Grouptype,UsrId

		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[Group Name],[Grouptype],[UsrId]
)
		SELECT [Product Name],[Product Code],[HSN Code],SUM(ISNULL(InPutQty,0)) as InPutQty,SUM(ISNULL(OutPutQty,0)) as OutPutQty,
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		[InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		[InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		[InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		[InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		[OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		[OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		[OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		[OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		[Group Name],Grouptype,UsrId
		FROM #RptProductTaxGroup		
		GROUP BY [Product Name],[Product Code],[HSN Code],[Group Name],Grouptype,UsrId,
		[InputCGST Rate],[InputSGST Rate],[InputIGST Rate],[InputUTGST Rate],
		[OutputCGST Rate],[OutputSGST Rate],[OutputIGST Rate],[OutputUTGST Rate]
		ORDER BY [HSN Code], [Product Name]
		
		INSERT INTO RptInputOutPutGSTTax([Product Name],[Product Code],[HSN Code],[InPutQty],
		[OutPutQty],[TaxableAmount],[InputCGST Rate],[InputCGST Value],
		[InputSGST Rate],[InputSGST Value],[InputIGST Rate],[InputIGST Value],
		[InputUTGST Rate],[InputUTGST Value],[OutputCGST Rate],[OutputCGST Value],
		[OutputSGST Rate],[OutputSGST Value],[OutputIGST Rate],[OutputIGST Value],
		[OutputUTGST Rate],[OutputUTGST Value],[DiffCGST Value],[DiffSGST Value],
		[DiffIGST Value],[DiffUTGST Value],[Group Name],[Grouptype],[UsrId])
		
		SELECT '' as [Product Name],'' as [Product Code],'' as [HSN Code],SUM([InPutQty]) as [InPutQty],
		SUM([OutPutQty]) as [OutPutQty],
		SUM(ISNULL(TaxableAmount,0)) as TaxableAmount,
		0 as [InputCGST Rate],SUM([InputCGST Value]) as [InputCGST Value],
		0 as [InputSGST Rate],SUM([InputSGST Value]) as [InputSGST Value],
		0 as [InputIGST Rate],SUM([InputIGST Value]) as [InputIGST Value],
		0 as [InputUTGST Rate] ,SUM([InputUTGST Value]) as [InputUTGST Value],
		0 as [OutputCGST Rate],SUM([OutputCGST Value]) as [OutputCGST Value],
		0 as [OutputSGST Rate],SUM([OutputSGST Value]) as [OutputSGST Value],
		0 as [OutputIGST Rate],SUM([OutputIGST Value]) as [OutputIGST Value],
		0 as [OutputUTGST Rate],SUM([OutputUTGST Value]) as [OutputUTGST Value] ,
		ABS(SUM([InputCGST Value]-[OutputCGST Value])) as [DiffCGST Value],
		ABS(SUM([InputSGST Value]-[OutputSGST Value])) as [DiffSGST Value],
		ABS(SUM([InputIGST Value]-[OutputIGST Value])) as [DiffIGST Value],
		ABS(SUM([InputUTGST Value]-[OutputUTGST Value])) as [DiffUTGST Value],
		'ZZZZZZ' as [Group Name],3 as Grouptype,@Pi_UsrId as UsrId
		FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
		
		
		DELETE FROM RptInputOutPutGSTTax WHERE ([InPutQty]+[OutPutQty])=0
		AND UsrId=@Pi_UsrId
		
		DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId
		INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,
		FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,
		RoundOff,CreatedDate)
		SELECT 1,407,'Product Wise Input Output Tax',1,'Product Name',50,1,0,1,1,'Product Name','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',2,'Product Code',20,1,0,1,1,'Product Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',3,'HSN Code',20,1,0,1,1,'HSN Code','','',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',4,'InPutQty',50,1,0,2,2,'Input','Total','Quantity',0,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',5,'OutPutQty',50,1,0,2,2,'Output','Total','Quantity',0,GETDATE()
		--UNION ALL
		--SELECT 1,407,'Product Wise Input Output Tax',6,'TaxableAmount',16,1,0,2,3,'Taxable','Amount','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',6,'InputCGST Rate',16,1,0,2,3,'Input','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',7,'InputSGST Rate',16,1,0,2,3,'Input','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',8,'InputIGST Rate',16,1,0,2,3,'Input','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',9,'InputUTGST Rate',16,1,0,2,3,'Input','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',10,'InputCGST Value',16,1,0,2,3,'Input','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',11,'InputSGST Value',16,1,0,2,3,'Input','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',12,'InputIGST Value',16,1,0,2,3,'Input','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',13,'InputUTGST Value',16,1,0,2,3,'Input','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',14,'OutPutCGST Rate',16,1,0,2,3,'OutPut','CGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',15,'OutPutSGST Rate',16,1,0,2,3,'OutPut','SGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',16,'OutPutIGST Rate',16,1,0,2,3,'OutPut','IGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',17,'OutPutUTGST Rate',16,1,0,2,3,'OutPut','UTGST%','',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',18,'OutPutCGST Value',16,1,0,2,3,'OutPut','CGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',19,'OutPutSGST Value',16,1,0,2,3,'OutPut','SGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',20,'OutPutIGST Value',16,1,0,2,3,'OutPut','IGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',21,'OutPutUTGST Value',16,1,0,2,3,'OutPut','UTGST','Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',22,'DiffCGST Value',16,1,0,2,3,'Differential of','CGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',23,'DiffSGST Value',16,1,0,2,3,'Differential of','SGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',24,'DiffIGST Value',16,1,0,2,3,'Differential of','IGST','Input OutPut Tax Amount',2,GETDATE()
		UNION ALL
		SELECT 1,407,'Product Wise Input Output Tax',25,'DiffUTGST Value',16,1,0,2,3,'Differential of','UTGST','Input OutPut Tax Amount',2,GETDATE()
			
			UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[','')
			WHERE RptId=@Pi_RptId 
			DELETE FROM RptDataCount WHERE RptId = @Pi_RptId AND UserId = @Pi_UsrId
			INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)
			SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM RptInputOutPutGSTTax
			WHERE UsrId=@Pi_UsrId
			
			SELECT * FROM RptInputOutPutGSTTax WHERE UsrId=@Pi_UsrId
END
GO
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptHSNInputTaxGST]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptHSNInputTaxGST]
GO
/*  
BEGIN tran  
EXEC Proc_RptHSNInputTaxGST 423,1,0,'GSTTAX',0,0,1
Select * from RptInputtaxCreditGST  
ROLLBACK tran   
*/  
CREATE PROCEDURE [dbo].[Proc_RptHSNInputTaxGST]  
(  
 @Pi_RptId   INT,  
 @Pi_UsrId   INT,  
 @Pi_SnapId   INT,  
 @Pi_DbName   nvarchar(50),  
 @Pi_SnapRequired INT,  
 @Pi_GetFromSnap  INT,  
 @Pi_CurrencyId  INT  
)  
AS  
/*********************************  
* PROCEDURE : Proc_RptHSNOutPutTax  
* PURPOSE : To get the HSN Wise Tax Report  
* CREATED : Murugan.R  
* CREATED DATE : 25/08/2017  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*********************************/  
BEGIN  
SET NOCOUNT ON  
 --Filter Variable  
 DECLARE @FromDate  AS DATETIME  
 DECLARE @ToDate   AS DATETIME  
 DECLARE @CmpId         AS INT  
 DECLARE @ErrNo   AS INT  
    
 DECLARE @SQL as Varchar(MAX)  
 DECLARE @MaxId as INT  
 DECLARE @ReportId as INT  
 DECLARE @start INT, @end INT   
 DECLARE @Str AS VARCHAR(100)  
 DECLARE @CreateTable AS VARCHAR(7000)  
    
 SET @ErrNo=0  
 SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)  
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)  
 SET @CmpId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))  
 --SET @FromDate='2017-05-01'  
 --SET @ToDate='2017-07-30'  
 --select * from ReportFilterDt  
   
  TRUNCATE TABLE RptHSNInputTaxGST  
   
   
  DECLARE @DynamicLineAmountFields as VARCHAR(300)  
  DECLARE @DynamicLineAmountFields1 as VARCHAR(300)  
  DECLARE @DynamicLineAmountFields2 as VARCHAR(300)  
    
  SELECT DISTINCT P.Prdid,ColumnValue as HSNCODE   
  INTO #HSNCODE  
  FROM UdcHD A (NOLOCK)  
  INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId  
  INNER JOIN UdcDetails C (NOLOCK) ON C.MasterId=B.MasterId and C.MasterId=A.MasterId  
  and C.UdcMasterId=B.UdcMasterId   
  INNER JOIN Product P (NOLOCK) ON P.PrdId=C.MasterRecordId  
  WHERE A.MasterName='Product Master' and B.ColumnName='HSN CODE'  
   
  CREATE TABLE #TaxHSNSummary  
  (  
   StateCode Varchar(20),  
   StateName Varchar(100),  
   GSTin Varchar(50),  
   SpmCode Varchar(50),  
   Spmname Varchar(100),   
   HsnCode Varchar(50),  
   Refid BIGINT,  
   RefNo Varchar(50),  
   CmpInvno Varchar(50),  
   PurchaseOrderNo Varchar(50),  
   InvoiceDate Datetime,  
   RefDate DateTime,  
   SpmId INT,  
   GrossAmount Numeric(18,4),  
   TaxableAmount Numeric(32,4),  
   NetAmount numeric(24,4),  
   Taxname Varchar(100),  
   DynamicAmt Numeric(24,4),  
   TaxType Varchar(50),  
   SalesOrderType TinyInt,  
   TaxFlag TinyInt ,  
   Taxper Numeric(10,2),  
   TaxId INT,  
   [Group Name] varchar(50),  
   [GroupType] Tinyint,  
   [UsrId] INT  
  )  
  
  SELECT PurRcptId,Prdslno,SUM(TaxableAmount) as TaxableAmount,Taxamount,taxperc
  INTO #PurchaseTaxableAmount  
  FROM(  
  SELECT S.PurRcptId,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount,sum(S.TaxAmount) as Taxamount,taxperc  
  FROM PurchaseReceiptProductTax  S  (NOLOCK) INNER JOIN PurchaseReceipt SI (NOLOCK) ON S.PurRcptId=SI.PurRcptId  
  WHERE  TaxableAmount>0 and Status=1  
  AND SI.InvDate  Between @FromDate AND @ToDate and VatGST='GST'  
  GROUP BY S.PurRcptId,PrdSlno,taxperc     
  )X GROUP BY PurRcptId,Prdslno,Taxamount,taxperc  
    
  SELECT PurRetId,Prdslno,SUM(TaxableAmount) as TaxableAmount,Taxamount,taxperc  
  INTO #PurchaseRtnTaxableAmount  
  FROM(  
  SELECT S.PurRetId,PrdSlno,SUM(DISTINCT TaxableAmount) as TaxableAmount,sum(S.TaxAmount) as Taxamount,taxperc  
  FROM PurchaseReturnProductTax  S  (NOLOCK) INNER JOIN PurchaseReturn SI (NOLOCK) ON S.PurRetId=SI.PurRetId  
  WHERE  TaxableAmount>0 AND SI.PurRetDate  Between @FromDate AND @ToDate and Status=1  
  GROUP BY S.PurRetId,PrdSlno,taxperc   
  )X GROUP BY  PurRetId,Prdslno,Taxamount,taxperc  
  
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,  
  InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),  
  S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,  
  SUM(ST.TaxableAmount),(SUM(ST.TaxableAmount)+sum(ST.Taxamount)) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(ST.TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,  
  SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,  
  0 as TaxFlag,ST.TaxPerc,max(SPT.TaxId) as taxid,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]--,sum(ST.Taxamount) as taxamount 
  FROM PurchaseReceipt S (NOLOCK)   
  INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId  
  INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo  
  INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId  and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Supplier R ON R.SpmId=S.SpmId  
  LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId  
  WHERE S.InvDate  Between @FromDate AND @ToDate and VatGST='GST'  
  and SPT.TaxableAmount>0  and Status=1  
  GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,ST.TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SpmCode,SpmName
  UNION ALL  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),  
  S.PurRcptId as RefId,PurRcptRefNo as RefNo,CmpInvNo,PurOrderRefNo,InvDate,GoodsRcvdDate as RefDate,R.SpmId,SUM(PrdGrossAmount) as PrdGrossAmount,  
  SUM(ST.TaxableAmount),(SUM(ST.TaxableAmount)+sum(ST.Taxamount)) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(ST.TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,  
  SUM(SPT.TaxAmount) as DynamicAmt,'Purchase of Goods' as TaxType,1 as SalesOrderType,  
  1 as TaxFlag,ST.TaxPerc,max(SPT.TaxId) as taxid,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]--,sum(ST.Taxamount) as taxamount   
  FROM PurchaseReceipt S (NOLOCK)   
  INNER JOIN PurchaseReceiptProduct SIP (NOLOCK) ON S.PurRcptId=SIP.PurRcptId  
  INNER JOIN PurchaseReceiptProductTax SPT (NOLOCK) ON SPT.PurRcptId=SIP.PurRcptId and SPT.PurRcptId=S.PurRcptId and SIP.PrdSlNo=SPT.PrdSlNo  
  INNER JOIN #PurchaseTaxableAmount ST ON ST.PurRcptId=SPT.PurRcptId and S.PurRcptId=St.PurRcptId and ST.PurRcptId=SIP.PurRcptId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Supplier R ON R.SpmId=S.SpmId  
  LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId  
  WHERE S.InvDate  Between  @FromDate AND @ToDate  
  and SPT.TaxableAmount>0  and Status=1  
  GROUP BY HSNCODE,S.PurRcptId,InvDate,GoodsRcvdDate,R.SpmId,TaxCode,ST.TaxPerc,PurRcptRefNo,CmpInvNo,PurOrderRefNo,SPT.TaxId,SpmCode,SpmName  
  
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,Refid,RefNo,CmpInvno,PurchaseOrderNo,  
  InvoiceDate,RefDate,SpmId,GrossAmount,TaxableAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),  
  S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate ,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,  
  -1*SUM(ST.TaxableAmount),-1*(SUM(ST.TaxableAmount)+sum(ST.Taxamount)) as NetAmount,TaxCode +'~TaxableAmount~' +CAST(CAST(ST.TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,  
  -1*SUM(SPT.TaxableAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,  
  0 as TaxFlag,ST.TaxPerc,max(SPT.TaxId) as taxid,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]--,sum(ST.Taxamount) as taxamount  
  FROM PurchaseReturn S (NOLOCK)   
  INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId  
  INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo  
  INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Supplier R ON R.SpmId=S.SpmId  
  LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId  
  WHERE PurRetDate Between @FromDate AND @ToDate and Status=1  
  and SPT.TaxableAmount>0  
  GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,ST.TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName  
  UNION ALL  
  SELECT '' as StateCode,'' as StateName,'' as GSTin,SpmCode,SpmName,ISNULL(HSNCODE,''),  
  S.PurRetId as RefId,PurRetRefNo as RefNo,'' as CmpInvno,'' as PurchaseOrderNo,PurRetDate,PurRetDate as RefDate,R.SpmId,-1*SUM(PrdGrossAmount) as PrdGrossAmount,  
  -1*SUM(ST.TaxableAmount),-1*(SUM(ST.TaxableAmount)+sum(ST.Taxamount)) as NetAmount,TaxCode +'~Taxamount~' +CAST(CAST(ST.TaxPerc as Numeric(10,2)) as Varchar(20)) as TaxName,  
  -1*SUM(SPT.TaxAmount) as DynamicAmt,'Purchase Return of Goods' as TaxType,2 as SalesOrderType,  
  1 as TaxFlag,ST.TaxPerc,max(SPT.TaxId) as taxid,'' [Group Name],2 as [GroupType],@Pi_UsrId as [UsrId]--,sum(ST.Taxamount) as taxamount    
  FROM PurchaseReturn S (NOLOCK)   
  INNER JOIN PurchaseReturnProduct SIP (NOLOCK) ON S.PurRetId=SIP.PurRetId  
  INNER JOIN PurchaseReturnProductTax SPT (NOLOCK) ON SPT.PurRetId=SIP.PurRetId and SPT.PurRetId=S.PurRetId and SIP.PrdSlNo=SPT.PrdSlNo  
  INNER JOIN #PurchaseRtnTaxableAmount ST ON ST.PurRetId=SPT.PurRetId  and S.PurRetId=St.PurRetId and ST.PurRetId=SIP.PurRetId and SIP.PrdSlNo=ST.PrdSlNo and SPT.PrdSlNo=ST.PrdSlNo  
  INNER JOIN TaxConfiguration T (NOLOCK) ON T.TaxId=SPT.TaxId  
  INNER JOIn Supplier R ON R.SpmId=S.SpmId  
  LEFT OUTER JOIN #HSNCODE A ON SIP.PrdId=A.PrdId  
  WHERE PurRetDate Between @FromDate AND @ToDate and Status=1  
  and SPT.TaxableAmount>0  
  GROUP BY HSNCODE,S.PurRetId,PurRetDate,R.SpmId,TaxCode,ST.TaxPerc,PurRetRefNo,SPT.TaxId,SpmCode,SpmName
    
  INSERT INTO #TaxHSNSummary (StateCode,StateName,GSTin,SpmCode,Spmname,HsnCode ,  
  Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,SpmId,GrossAmount,NetAmount,Taxname,DynamicAmt,TaxType,SalesOrderType,taxFlag,  
  Taxper,TaxId,[Group Name],[GroupType],[UsrId])    
  SELECT  '','','','','','', 0 as [InvId],'' as [RefNo],'' as CmpInvno,'' as PurchaseOrderNo,NUll,Null,0,0 as GrossAmount,0 as NetAmount,  
  Taxname,SUM(DynamicAmt) as DynamicAmt,'' as TaxType,3 as SalesOrderType,100 as taxFlag,  
  Taxper,TaxId,'ZZZZZ' as [Group Name],3 as [GroupType],@Pi_UsrId as [UsrId]  
  FROM #TaxHSNSummary   
  GROUP BY Taxname,Taxper,TaxId  
   
  UPDATE B SET B.StateCode= A.StateTinFirst2Digit ,  
  B.Statename=A.StateName,  
  B.GSTIN=A.GSTIN  
  FROM DBO.FN_ReturnSupplierUDCDetails() A INNER JOIN #TaxHSNSummary B ON A.SpmId=B.SpmId  
    
  SELECT B.PurRetId,A.PurRcptRefNo,A.CmpInvNo,A.PurOrderRefNo  
  INTO #Refcode  
  FROM PurchaseReceipt A INNER JOIN PurchaseReturn B ON A.PurRcptId=B.PurRcptId  
    
  UPDATE A SET  A.CmpInvno=B.CmpInvNo,A.PurchaseOrderNo=B.PurOrderRefNo   
  FROM #TaxHSNSummary A INNER JOIN #Refcode B ON A.RefId=B.PurRetId WHERE SalesOrderType=2 
    
  SET @DynamicLineAmountFields='0 as NetAmount,'  
  SET @DynamicLineAmountFields1='NetAmount Numeric (36,2),'  
  SET @DynamicLineAmountFields2='NetAmount,'  
    
  IF NOT EXISTS(SELECT 'X' FROM #TaxHSNSummary)  
  BEGIN  
   SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId  
   RETURN  
  END  
  DECLARE @ColSelect AS Varchar(MAX)  
  DECLARE @ColSelectDataType AS Varchar(5000)  
  DECLARE @TableCol AS Varchar(2000)  
  DECLARE @Columns1 AS Varchar(7000)  
  DECLARE @OrderBy AS VARCHAR(2000)  
  DECLARE @PCSelect AS VARCHAR(3000)  
  SET @PCSelect=''  
  SET @ColSelect=''  
  SET @ColSelectDataType=''  
  SET @TableCol=''  
  SET @Columns1=''  
  SET @CreateTable=''  
  SET @OrderBy=''  
  CREATE TABLE #DynamicCol  
  (  
  Slno INT IDENTITY(1,1),  
  Taxname Varchar(50),  
  TaxId INT,  
  TaxPer Numeric(12,2),  
  TaxFlag TinyInt    
  )  
  INSERT INTO #DynamicCol    
  SELECT DISTINCT Taxname,TaxId,Taxper,TaxFlag FROM #TaxHSNSummary WHERE TaxFlag IN(1,0) ORDER BY TaxId,Taxper,TaxFlag,Taxname  
   
  SELECT @ColSelect=@ColSelect+'ISNULL('+QuoteName(Taxname)+',0) as '+QuoteName(Taxname)+',' FROM #DynamicCol ORDER BY Slno  
  SELECT @PCSelect=@PCSelect+Quotename(Taxname)+',' FROM #DynamicCol ORDER BY Slno  
  SET @PCSelect=LEFT(@PCSelect,LEN(@PCSelect)-1)  
  SELECT @ColSelectDataType=@ColSelectDataType+QuoteName(Taxname)+' Numeric(36,2),' FROM #DynamicCol ORDER BY Slno  
  SET @ColSelect='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,TaxableAmount,'+@ColSelect+@DynamicLineAmountFields2+'[Group Name],[GroupType],[UsrId]'  
  SET @TableCol= 'SLNO BIGINT IDENTITY(1,1),'+  
  'StateCode Varchar(20),  
  StateName Varchar(100),  
  GSTin Varchar(50),  
  SpmId INT,  
  SpmCode Varchar(50),  
  Spmname Varchar(100),    
  Refid BIGINT,  
  RefNo Varchar(50),  
  CmpInvno Varchar(50),  
  PurchaseOrderNo Varchar(50),  
  InvoiceDate Datetime,  
  RefDate DateTime,  
  HsnCode Varchar(50),   
  TaxType Varchar(50),   
  SalesOrderType TinyInt,  
  TaxableAmount Numeric(34,4),'  
  SET @Columns1='SELECT StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,CmpInvno,PurchaseOrderNo,InvoiceDate,RefDate,HsnCode,TaxType,SalesOrderType,TaxableAmount,NetAmount,DynamicAmt ,TaxName,[Group Name],[GroupType],[UsrId] FROM #TaxHSNSummary'  
  SET @OrderBy=' ORDER BY [Group Name],[GroupType],SalesOrderType,TaxType,Refdate,Refno'  
  SET @CreateTable=' IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME=''RptHSNInputTaxGST'' and XTYPE=''U'')'+  
  ' DROP TABLE RptHSNInputTaxGST'+  
  ' CREATE TABLE RptHSNInputTaxGST ('+@TableCol+@ColSelectDataType+@DynamicLineAmountFields1+' [Group Name] Varchar(100),Grouptype TINYINT,UsrId INT)'  
  PRINT @CreateTable  
  EXEC(@CreateTable)  
  SET @SQL=' INSERT INTO RptHSNInputTaxGST '+ @ColSelect+ ' FROM'+  
  '('+@Columns1+  
  ') PS'+  
  ' PIVOT'+  
  '('+  
  ' SUM(DynamicAmt) FOR TaxName IN('+@PCSelect+')'+  
  ')PVTTax '+ @OrderBy  
  PRINT @SQL  
  EXEC(@SQL)  
  SELECT DISTINCT  
  StateCode,StateName,GSTin,SpmId,SpmCode,Spmname,Refid,RefNo,RefDate,HsnCode,TaxableAmount,NetAmount  
  INTO #LineLevelGross  
  FROM #TaxHSNSummary WHERE UsrId=@Pi_UsrId and TaxFlag=0  
  SELECT 'ZZZZZ' as [Group Name], 3 as GroupType ,SUM(TaxableAmount) as TaxableAmount,SUM(NetAmount) as NetAmount  
  INTO #GrandTotal  
  FROM #LineLevelGross   
  UPDATE Y SET    
  Y.TaxableAmount=X.TaxableAmount ,Y.NetAmount=X.NetAmount  
  FROM RptHSNInputTaxGST Y INNER JOIN #GrandTotal X ON X.[Group Name]=Y.[Group Name]  
  AND X.GroupType=Y.GroupType   
    
    
   DELETE FROM Report_Template_GST WHERE ReportId=1 and RptId=@Pi_RptId  
   INSERT INTO Report_Template_GST(ReportId,RptId,RptName ,ColId,FieldName,FieldSize,FieldSelection,GroupField,  
   FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,  
   RoundOff,CreatedDate)  
   SELECT 1,423,'HSN Code Wise Input Tax',1,'StateCode',20,1,0,1,1,'Supplier','State','Code',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',2,'StateName',50,1,0,1,1,'Supplier','State','Name',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',3,'GSTin',20,1,0,1,1,'Supplier','GST Tin','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',4,'SpmCode',50,1,0,1,1,'Supplier','Code','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',5,'Spmname',50,1,0,1,1,'Supplier','Name','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',6,'RefNo',75,1,0,1,1,'Invoice','Number','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',7,'CmpInvno',75,1,0,1,1,'Company','Invoice','Number',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',8,'PurchaseOrderNo',75,1,0,1,1,'Purchase','Order','Number',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',9,'RefDate',75,1,0,1,4,'Goods','Received','Date',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',10,'InvoiceDate',75,1,0,1,4,'Invoice','Date','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',11,'HSNCode',75,1,0,1,1,'HSN Code','','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',12,'TaxType',75,1,0,1,1,'Purchase/','Purchase Return','',0,GETDATE()  
   UNION ALL  
   SELECT 1,423,'HSN Code Wise Input Tax',13,'TaxableAmount',75,1,0,2,3,'Total','Taxable','Value',2,GETDATE()  
   SET @Str=''  
   SELECT @MaxId=MAX(ColId)+1,@ReportId=ReportId FROM  Report_Template_GST (NOLOCK) WHERE RptId=@Pi_RptId  
   GROUP BY ReportId  
   DECLARE @Caption1 as Varchar(30)  
   DECLARE @Caption2 as Varchar(30)  
   DECLARE @Caption3 as Varchar(30)  
   SET @Caption1=''  
   SET @Caption2=''  
   SET @Caption3=''  
     
   SELECT @start = 1, @end = CHARINDEX(',', @PCSelect)   
   WHILE @start < LEN(@PCSelect) + 1 BEGIN   
    IF @end = 0    
    SET @end = LEN(@PCSelect) + 1  
    SET @Str=SUBSTRING(@PCSelect, @start, @end - @start)  
    --SELECT @Str,'T'  
    SET @Caption1=LEFT(@Str,CharIndex('~',@Str)-1)  
    SET @Caption2=LEFT(SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)),CHARINDEX('~',SUBSTRING(@Str,CharIndex('~',@Str)+1,LEN(@Str)))-1)  
    SET @Caption3= REPLACE(RIGHT(@Str,6),'~','')  
    --SELECT @Caption1,@Caption2,@Caption3  
      
    INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,  
    FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,  
    CreatedDate)    
    SELECT TOP 1 ReportId,RptId,RptName,@MaxId,SUBSTRING(@PCSelect, @start, @end - @start),  
    18,1,0,2,3,@Caption1--SUBSTRING(@PCSelect, @start, @end - @start)      
    ,@Caption2,@Caption3,2,Getdate()  
    FROM Report_Template_GST WHERE RptId=@Pi_RptId  
      
    SET @start = @end + 1   
    SET @end = CHARINDEX(',', @PCSelect, @start)  
    SET @MaxId=@MaxId+1  
   END   
     
   INSERT INTO Report_Template_GST(ReportId,RptId,RptName,ColId,FieldName,FieldSize,  
   FieldSelection,GroupField,FieldType,Alignment,HeaderCaption,HeaderCaption1,HeaderCaption2,RoundOff,  
   CreatedDate)    
   SELECT TOP 1 ReportId,RptId,RptName,@MaxId+1,'NetAmount',  
   18,1,0,2,3,'Product','Level','NetAmount',2,Getdate()  
   FROM Report_Template_GST WHERE RptId=@Pi_RptId   
     
     
   UPDATE Report_template_GST SET FieldName=REPLACE(REPLACE(FieldName,']',''),'[',''),  
   HeaderCaption=REPLACE(REPLACE(HeaderCaption,']',''),'[',''),  
   HeaderCaption1=REPLACE(REPLACE(HeaderCaption1,']',''),'[',''),  
   HeaderCaption2=REPLACE(REPLACE(HeaderCaption2,']',''),'[','')  
   WHERE RptId=@Pi_RptId   
     
     
   IF NOT EXISTS(SELECT 'X' FROM RptHSNInputTaxGST)  
   BEGIN  
    SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId  
    RETURN  
   END  
     
   SELECT * FROM RptHSNInputTaxGST WHERE UsrId=@Pi_UsrId  
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_RptRetailerMasterDetReport]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_RptRetailerMasterDetReport]
GO
---- EXEC Proc_RptRetailerMasterDetReport 206,1,0,'ParleRetcount090617',0,0,1    
CREATE PROCEDURE [dbo].[Proc_RptRetailerMasterDetReport]    
(     
 @Pi_RptId   INT,    
 @Pi_UsrId   INT,    
 @Pi_SnapId   INT,     
 @Pi_DbName   Nvarchar(50),    
 @Pi_SnapRequired INT,    
 @Pi_GetFromSnap  INT,    
 @Pi_CurrencyId  INT    
)    
AS    
/****************************************************************************************************************    
* PROCEDURE  : Proc_RptProductMasterDetReport    
* PURPOSE    : To Generate Retailer Master Details Report     
* CREATED BY : Panneerselvam.k    
* CREATED ON : 07/01/2010    
* MODIFICATION     
*****************************************************************************************************************       
* DATE       AUTHOR      DESCRIPTION       
*****************************************************************************************************************/     
BEGIN    
SET NOCOUNT ON    
 /* Get the Filter Values  */      
  DECLARE @CmpId      AS INT    
  DECLARE @SMId          AS INT    
  DECLARE @RMId     AS INT    
  DECLARE @RetCatLevelId       AS INT    
  DECLARE @RetCatLevelValId     AS INT    
  DECLARE @RetLevelClassId  AS INT    
  DECLARE @RetailerId        AS INT    
  DECLARE @RetStatusId      AS INT    
  DECLARE @RetOrderBy       AS INT    
      
  SET @CmpId    = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))    
  SET @SMId    = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,1,@Pi_UsrId))    
  SET @RMId    = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId))    
  SET @RetCatLevelId  = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId))    
  SET @RetCatLevelValId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId))    
  SET @RetLevelClassId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId))    
  SET @RetailerId   = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId))    
  SET @RetStatusId  = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId))    
  SET @RetOrderBy   = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,90,@Pi_UsrId))    
/*  CREATE TABLE STRUCTURE */    
 DECLARE @NewSnapId   AS INT    
 DECLARE @DBNAME   AS  nvarchar(50)    
 DECLARE @TblName   AS nvarchar(500)    
 DECLARE @TblStruct   AS nVarchar(4000)    
 DECLARE @TblFields   AS nVarchar(4000)    
 DECLARE @SSQL   AS  VarChar(8000)    
 DECLARE @ErrNo    AS INT    
 DECLARE @PurDBName  AS nVarChar(50)    
   /*  Till Here  */    
  SET @TblName = 'RptRetailerMasterDetReport'    
      
  SET @TblStruct =' RtrId INT,RtrCode Varchar(100),    
       RtrName Varchar(100),RtrAdd1 Varchar(100),    
       RtrAdd2 Varchar(100) ,RtrAdd3 Varchar(100),    
       RtrPinNo Varchar(100),RtrPhoneNo Varchar(100),    
       RtrEmailId Varchar(100) ,RtrKeyAcc Varchar(100),    
       RtrTINNo Varchar(100),RtrCovMode Varchar(100),           
       RtrStatus Varchar(100),RtrCrBills INT,RtrCrLimit Numeric(18,3),    
       RtrCrDays INT,GeoName Varchar(100),SalesRoute Varchar(100),    
       DelvRoute Varchar(100),MerRoute Varchar(100),    
       CategoryLevel Varchar(100),Category  Varchar(100),Class  Varchar(100),    
       UDCColumn Varchar(100),UDCValue  Varchar(100) '      
               
  SET @TblFields = 'RtrId,RtrCode,RtrName ,RtrAdd1,RtrAdd2,RtrAdd3,    
        RtrPinNo,RtrPhoneNo,RtrEmailId,RtrKeyAcc,    
        RtrTINNo ,RtrCovMode,RtrStatus,RtrCrBills ,RtrCrLimit,    
        RtrCrDays ,GeoName,SalesRoute,DelvRoute ,MerRoute ,    
        CategoryLevel ,Category ,Class '    
  CREATE TABLE #TmpRptRetailerMasterDetReport(RtrId INT,RtrCode Varchar(100),    
       RtrName Varchar(100),RtrAdd1 Varchar(100),    
       RtrAdd2 Varchar(100) ,RtrAdd3 Varchar(100),    
       RtrPinNo Varchar(100),RtrPhoneNo Varchar(100),    
       RtrEmailId Varchar(100) ,RtrKeyAcc Varchar(100),    
       RtrTINNo Varchar(100),RtrCovMode Varchar(100),           
       RtrStatus Varchar(100),RtrCrBills INT,RtrCrLimit Numeric(18,3),    
       RtrCrDays INT,GeoName Varchar(100),SalesRoute Varchar(100),    
       DelvRoute Varchar(100),MerRoute Varchar(100),    
       CategoryLevel Varchar(100),Category  Varchar(100),Class  Varchar(100),    
       UDCColumn Varchar(100),UDCValue  Varchar(100))    
   /*  Snap Shot Query    */    
  IF @Pi_GetFromSnap = 1    
  BEGIN    
   Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId    
   SET @DBNAME = @DBNAME    
  END    
  ELSE    
  BEGIN    
   Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3    
   SET @DBNAME = @PI_DBNAME + @DBNAME    
  END    
  IF @Pi_GetFromSnap = 0  --To Generate For New Report Data    
  BEGIN    
       
   INSERT INTO #TmpRptRetailerMasterDetReport    
   SELECT  Distinct    
    R.RtrId,R.RtrCode,R.RtrName,RtrAdd1,RtrAdd2,RtrAdd3,    
    RtrPinNo,RtrPhoneNo,RtrEmailId,    
    CASE RtrKeyAcc  WHEN 1 THEN 'Yes' ELSE 'No' END AS RtrKeyAcc,    
    RtrTINNo,    
    CASE RtrCovMode WHEN 1 THEN 'Order Booking'     
        WHEN 2 THEN 'Van Sales'    
        WHEN 3 THEN 'Counter Sales'  END AS RtrCovMode,    
    CASE RtrStatus  WHEN 1 THEN 'Active' ELSE 'InActive' END AS RtrStatus,    
    RtrCrBills,RtrCrLimit,RtrCrDays,    
    G.GeoName,RMName AS SalesRoute, '' AS DelvRoute,'' AS MerRoute,    
    RCL.CtgLevelName CategoryLevel, RC.CtgName AS Category, RVC.ValueClassName AS Class,    
    B.ColumnName  UDCColumn,C.ColumnValue UDCValue    
   -------------->  Added By Lakshman M on 11/10/2017 <------------------
   FROM Retailer R LEFT OUTER JOIN Retailermarket RM ON R.Rtrid =RM.Rtrid 
		LEFT OUTER JOIN SalesmanMarket SM ON SM.Rmid =RM.Rmid 
		LEFT OUTER JOIN SalesMan S ON S.SMId =SM.smid 
		INNER JOIN RouteMaster ROT ON ROT.Rmid =Rm.RMId
		LEFT OUTER JOIN UdcDetails C ON R.RtrId = C.MasterRecordId AND MAsterId = 2    
		LEFT OUTER JOIN UdcMaster B  ON C.MasterId = B.MasterId AND C.UdcMasterId = B.UdcMasterId 
		INNER JOIN RetailerValueClassMap RVCM ON RVCM.Rtrid =R.Rtrid
		INNER JOIN RetailerValueClass RVC ON RVC.RtrClassId = RVCM.RtrValueClassId
		INNER JOIN RetailerCategory RC ON RC.CtgMainId =RVC.Ctgmainid
		INNER JOIN RetailerCategoryLevel RCL ON RCL.Ctglevelid =Rc.CtgLevelId
		INNER JOIN Geography G ON R.GeoMainId = G.GeoMainId
	WHERE ROT.RMSRouteType in (1,2) --and R.RtrStatus =1 and B.ColumnName ='Longitude'
	--------------->  Till here <----------------  
    ----- Route     
     AND (ROT.RMId = (CASE @RMId WHEN 0 THEN ROT.RMId Else 0 END) OR    
            ROT.RMId IN (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,2,@Pi_UsrId)))    
    ----- Retailer Category Level     
     AND (RCL.CtgLevelId = (CASE @RetCatLevelId WHEN 0 THEN RCL.CtgLevelId ELSE 0 END) OR    
        RCL.CtgLevelId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,29,@Pi_UsrId)))    
    ----- Retailer Category      
     AND (RC.CtgMainId = (CASE @RetCatLevelValId WHEN 0 THEN RC.CtgMainId ELSE 0 END) OR    
       RC.CtgMainId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,30,@Pi_UsrId)))    
    ----- Retailer Value Class    
     AND (RVC.RtrClassId = (CASE @RetLevelClassId WHEN 0 THEN RVC.RtrClassId ELSE 0 END) OR    
        RVC.RtrClassId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,31,@Pi_UsrId)))        
    ----- Retailer    
    AND (R.RtrId = (CASE @RetailerId WHEN 0 THEN R.RtrId ELSE 0 END) OR    
        R.RtrId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,3,@Pi_UsrId)))    
    ------ Product Status    
    AND   (R.RtrStatus  =(CASE @RetStatusId WHEN 0 THEN R.RtrStatus  ELSE 0 END ) OR    
       R.RtrStatus  IN (SELECT iCountId FROM dbo.Fn_ReturnRptFilters(@Pi_RptId,24,@Pi_UsrId)))    
     /*   Sales Route Update */   

   SELECT DISTINCT R.RtrId,RtrCode,ROT.RMName  INTO #TmpSalRoute    
   FROM RouteMaster ROT,Retailer R     
   WHERE RMSRouteType = 2    
      AND R.RtrId IN ( SELECT DISTINCT  RtrId FROM #TmpRptRetailerMasterDetReport)    
      AND R.RMId = ROt.RMId    
   UPDATE #TmpRptRetailerMasterDetReport  SET DelvRoute = RMName    
   FROM #TmpRptRetailerMasterDetReport a,#TmpSalRoute B    
   WHERE A.RtrId = B.RtrId    
     /*   Merchandising Route Update */    
   SELECT DISTINCT R.RtrId,RtrCode,ROT.RMName INTO #TmpMerRoute    
   FROM RouteMaster ROT,Retailer R,RetailerMarket RM     
   WHERE RMSRouteType = 3    
      AND R.RtrId IN( SELECT DISTINCT  RtrId FROM #TmpRptRetailerMasterDetReport)    
      AND R.RtrId = RM.RtrId AND RM.RMId = ROt.RMId     
   UPDATE #TmpRptRetailerMasterDetReport  SET MerRoute = RMName    
     FROM #TmpRptRetailerMasterDetReport a,#TmpMerRoute B    
     WHERE A.RtrId = B.RtrId    
  DELETE FROM RptDataCount WHERE RptId= @Pi_RptId AND UserId=@Pi_UsrId    
  INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)    
  SELECT @Pi_RptId,Count(*),0,@Pi_UsrId FROM #TmpRptRetailerMasterDetReport    
  IF @RetOrderBy = 1    
  BEGIN    
   SELECT  RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,    
     RtrTinNo,RtrKeyAcc,RtrCovMode,RtrStatus,RtrCrBills,RtrCrLimit,RtrCrDays,    
     GeoName,SalesRoute,DelvRoute,MerRoute,CategoryLevel,Category,Class,UDCColumn,UDCValue     
   FROM  #TmpRptRetailerMasterDetReport ORDER BY RtrCode    
  END    
  IF @RetOrderBy = 2    
  BEGIN    
   SELECT  RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,    
     RtrTinNo,RtrKeyAcc,RtrCovMode,RtrStatus,RtrCrBills,RtrCrLimit,RtrCrDays,    
     GeoName,SalesRoute,DelvRoute,MerRoute,CategoryLevel,Category,Class,UDCColumn,UDCValue     
   FROM  #TmpRptRetailerMasterDetReport ORDER BY RtrName    
  END    
  IF @RetOrderBy = 3    
  BEGIN    
   SELECT  RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,    
     RtrTinNo,RtrKeyAcc,RtrCovMode,RtrStatus,RtrCrBills,RtrCrLimit,RtrCrDays,    
     GeoName,SalesRoute,DelvRoute,MerRoute,CategoryLevel,Category,Class,UDCColumn,UDCValue     
   FROM  #TmpRptRetailerMasterDetReport ORDER BY SalesRoute    
  END    
  IF @RetOrderBy = 4    
  BEGIN    
   SELECT  RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,    
     RtrTinNo,RtrKeyAcc,RtrCovMode,RtrStatus,RtrCrBills,RtrCrLimit,RtrCrDays,    
     GeoName,SalesRoute,DelvRoute,MerRoute,CategoryLevel,Category,Class,UDCColumn,UDCValue     
   FROM  #TmpRptRetailerMasterDetReport ORDER BY Category    
  END    
  IF @RetOrderBy = 5    
  BEGIN    
   SELECT  RtrCode,RtrName,RtrAdd1,RtrAdd2,RtrAdd3,RtrPinNo,RtrPhoneNo,RtrEmailId,    
     RtrTinNo,RtrKeyAcc,RtrCovMode,RtrStatus,RtrCrBills,RtrCrLimit,RtrCrDays,    
     GeoName,SalesRoute,DelvRoute,MerRoute,CategoryLevel,Category,Class,UDCColumn,UDCValue     
   FROM  #TmpRptRetailerMasterDetReport ORDER BY Class    
  END    
 END    
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_SupplierMaster]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_SupplierMaster]
GO
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_SupplierMaster]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*********************************
* PROCEDURE		: Proc_Cn2Cs_SupplierMaster
* PURPOSE		: To validate the downloaded Supplier details from Console
* CREATED		: Nandakumar R.G
* CREATED DATE	: 15/10/2010
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
------------------------------------------------
* {date} {developer}  {brief modification description}
*********************************/
SET NOCOUNT ON
BEGIN
	DECLARE @TabName		NVARCHAR(100)
	DECLARE @ErrDesc		NVARCHAR(1000)
	DECLARE @SpmCode 		NVARCHAR(50)
	DECLARE @SpmName  		NVARCHAR(100)
	DECLARE @SpmAdd1	  	NVARCHAR(100)
	DECLARE @SpmAdd2		NVARCHAR(100)
	DECLARE @SpmAdd3		NVARCHAR(100)
	DECLARE @TaxGrpCode  	NVARCHAR(100)
	DECLARE @PhoneNo  		NVARCHAR(100)
	DECLARE @FaxNo  		NVARCHAR(100)
	DECLARE @EmailId  		NVARCHAR(100)
	DECLARE @ContPerson  	NVARCHAR(100)
	DECLARE @SpmTinNo       NVARCHAR(100)
	DECLARE @DefaultSpm  	NVARCHAR(100)
	DECLARE @AcCode			NVARCHAR(100)
	DECLARE @GSTTIN AS VARCHAR(100)
	DECLARE @StateCode AS VARCHAR(100)
	DECLARE @StateName AS VARCHAR(100)
	DECLARE @SupplierStatus AS VARCHAR(100)
	
	DECLARE @SpmId  		INT
	DECLARE @CoaId  		INT
	DECLARE @CmpId  		INT
	DECLARE @TaxGrpId  		INT
	DECLARE @Exist		 	INT
	SET @TabName = 'Cn2Cs_Prk_SupplierMaster'
	SET @Po_ErrNo=0
	DECLARE @GSTEnabled AS TINYINT
	SET @GSTEnabled=0
	IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1)
	BEGIN
		SET @GSTEnabled=1
	END
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SpmToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SpmToAvoid	
	END
	
	CREATE TABLE SpmToAvoid
	(
		SpmCode NVARCHAR(50)
	)
	
	IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	WHERE LTRIM(RTRIM(ISNULL(SpmCode,'')))='' OR LTRIM(RTRIM(ISNULL(SpmName,'')))='')
	BEGIN
		INSERT INTO SpmToAvoid(SpmCode)
		SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
		WHERE LTRIM(RTRIM(ISNULL(SpmCode,'')))='' OR LTRIM(RTRIM(ISNULL(SpmName,'')))=''
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Supplier Master','SpmCode','Supplier Code/Name Should not be empty' FROM Cn2Cs_Prk_SupplierMaster
		WHERE LTRIM(RTRIM(ISNULL(SpmCode,'')))='' OR LTRIM(RTRIM(ISNULL(SpmName,'')))=''
	END
	
	--Added by Sathishkumar Veeramani 	--Supplier Code Exists
 --   IF EXISTS(SELECT DISTINCT A.SpmCode FROM Cn2Cs_Prk_SupplierMaster A WITH (NOLOCK),Supplier B WITH (NOLOCK)
	--WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(ISNULL(A.SpmCode,'')))<>'')
	--BEGIN
	--	INSERT INTO SpmToAvoid(SpmCode)
	--	SELECT DISTINCT A.SpmCode FROM Cn2Cs_Prk_SupplierMaster A WITH (NOLOCK),Supplier B WITH (NOLOCK)
	--    WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(ISNULL(A.SpmCode,'')))<>''
	--	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--	SELECT DISTINCT 1,'Supplier Master','SpmCode','Supplier Code Already Available-'+A.SpmCode FROM Cn2Cs_Prk_SupplierMaster A WITH (NOLOCK),
	--	Supplier B WITH (NOLOCK) WHERE A.SpmCode = B.SpmCode AND LTRIM(RTRIM(ISNULL(A.SpmCode,'')))<>''
	--END
	--Till Here		
	
	IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	WHERE LTRIM(RTRIM(ISNULL(SpmAdd1,'')))='')
	BEGIN
		INSERT INTO SpmToAvoid(SpmCode)
		SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
		WHERE LTRIM(RTRIM(ISNULL(SpmAdd1,'')))=''
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Supplier Master','SpmCode','Supplier Address1 Should not be empty' FROM Cn2Cs_Prk_SupplierMaster
		WHERE LTRIM(RTRIM(ISNULL(SpmAdd1,'')))=''
	END	
	
	--IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--WHERE LTRIM(RTRIM(ISNULL(PhoneNo,'')))='')
	--BEGIN
	--	INSERT INTO SpmToAvoid(SpmCode)
	--	SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(PhoneNo,'')))=''
	--	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--	SELECT DISTINCT 1,'Supplier Master','SpmCode','Supplier Phone No Should not be empty' FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(PhoneNo,'')))=''
	--END
	
	--IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--WHERE LTRIM(RTRIM(ISNULL(GSTTIN,'')))='')
	--BEGIN
	--	INSERT INTO SpmToAvoid(SpmCode)
	--	SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(GSTTIN,'')))=''
	--	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--	SELECT DISTINCT 1,'Supplier Master','GSTIN','Supplier GST TIN No Should not be empty' FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(GSTTIN,'')))=''
	--END
	
	--IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--WHERE LTRIM(RTRIM(ISNULL(SupplierStatus,''))) NOT IN('ACTIVE','INACTIVE','IN ACTIVE'))
	--BEGIN
	--	INSERT INTO SpmToAvoid(SpmCode)
	--	SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(SupplierStatus,''))) NOT IN('ACTIVE','INACTIVE','IN ACTIVE')
	--	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--	SELECT DISTINCT 1,'Supplier Master','SupplierStatus','Supplier Status Should be Active/InActive' FROM Cn2Cs_Prk_SupplierMaster
	--	WHERE LTRIM(RTRIM(ISNULL(SupplierStatus,''))) NOT IN('ACTIVE','INACTIVE','IN ACTIVE')
	--END
	
	--IF EXISTS(SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster A 
	--WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,'')))
	--BEGIN
	--	INSERT INTO SpmToAvoid(SpmCode)
	--	SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster A 
	--	WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	
	--	INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
	--	SELECT DISTINCT 1,'Supplier Master','StateCode','Supplier State Code Not available' FROM Cn2Cs_Prk_SupplierMaster A 
	--	WHERE NOT EXISTS(SELECT StateCode FROM StateMaster B WHERE A.StateCode=ISNULL(B.StateCode,''))
	--END
	
	IF EXISTS(SELECT '*' FROM Cn2Cs_Prk_SupplierMaster CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Supplier Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
				)
	BEGIN
		INSERT INTO SpmToAvoid(SpmCode)
		SELECT DISTINCT SpmCode FROM Cn2Cs_Prk_SupplierMaster CSM
		INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
		WHERE NOT EXISTS(
			SELECT UD.* FROM UdcHD A (NOLOCK)
			INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
			INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
			WHERE UPPER(A.MasterName)='Supplier Master' AND B.ColumnName='State Name' 
			AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Supplier Master','StateCode','Supplier State Code Not available'+SpmName FROM Cn2Cs_Prk_SupplierMaster CSM
			INNER JOIN StateMaster SM ON CSM.StateCode=SM.StateCode
			WHERE NOT EXISTS(
				SELECT UD.* FROM UdcHD A (NOLOCK)
				INNER JOIN UdcMaster B (NOLOCK) ON A.MasterId=B.MasterId 
				INNER JOIN UdcDefault UD (NOLOCK) ON B.MasterId=UD.MasterId and B.UdcMasterId=UD.UdcMasterId
				WHERE UPPER(A.MasterName)='Supplier Master' AND B.ColumnName='State Name' 
				AND UD.ColValue=SM.StateName and UD.SeqId=SM.StateId)
	END
	
	DELETE FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Supplier Master' 
	
	DECLARE Cur_SupplierMaster CURSOR
	FOR SELECT ISNULL(LTRIM(RTRIM([SpmCode])),''),ISNULL(LTRIM(RTRIM([SpmName])),''),ISNULL(LTRIM(RTRIM([SpmAdd1])),''),
	ISNULL(LTRIM(RTRIM([SpmAdd2])),''),ISNULL(LTRIM(RTRIM([SpmAdd3])),''),ISNULL(LTRIM(RTRIM([TaxGroupCode])),''),
	ISNULL(LTRIM(RTRIM([PhoneNo])),''),ISNULL(LTRIM(RTRIM([FaxNo])),''),ISNULL(LTRIM(RTRIM([EmailId])),''),
	ISNULL(LTRIM(RTRIM([ContPerson])),''),ISNULL(LTRIM(RTRIM(SpmTinNo)),'0'),ISNULL(LTRIM(RTRIM([DefaultSpm])),'No'),
	ISNULL(LTRIM(RTRIM(GSTTIN)),''),ISNULL(LTRIM(RTRIM(StateCode)),''),ISNULL(LTRIM(RTRIM(SupplierStatus)),'')
	FROM Cn2Cs_Prk_SupplierMaster WHERE [DownLoadFlag] ='D' AND
	SpmCode NOT IN (SELECT SpmCode FROM SpmToAvoid)
	OPEN Cur_SupplierMaster
	FETCH NEXT FROM Cur_SupplierMaster INTO @SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,
	@TaxGrpCode,@PhoneNo,@FaxNo,@EmailId,@ContPerson,@SpmTinNo,@DefaultSpm,@GSTTIN,@StateCode,@SupplierStatus
	WHILE @@FETCH_STATUS=0
	BEGIN
				
		SET @Po_ErrNo=0
		SET @Exist=0		
		IF NOT EXISTS(SELECT * FROM Company WHERE DefaultCompany=1)
		BEGIN
			INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
			SELECT DISTINCT 1,'Supplier Master','CmpCode','Default Company Not Foud'
			SET @Po_ErrNo =1
		END
		ELSE
		BEGIN
			SELECT @CmpId=CmpId FROM Company WHERE DefaultCompany=1
			--SELECT @CmpId=CmpId FROM COMPANY WHERE UPPER(LTRIM(RTRIM(CMPCODE)))='ALL'
		END
		IF NOT EXISTS(SELECT * FROM TaxGroupSetting WHERE RtrGroup=@TaxGrpCode AND TaxGroup=3)
		BEGIN
			--INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
			--SELECT DISTINCT 1,'Supplier Master','Tax Group Code','Tax Group Code Not Foud'
			--SET @Po_ErrNo =1
			SET @TaxGrpId=0
		END
		ELSE
		BEGIN
			SELECT @TaxGrpId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup=@TaxGrpCode AND TaxGroup=3
		END
		IF NOT EXISTS (SELECT * FROM Supplier WHERE SpmCode=@SpmCode)
		BEGIN			
			SET @SpmId = dbo.Fn_GetPrimaryKeyInteger('Supplier','SpmId',CAST(YEAR(GETDATE()) AS INT),MONTH(GETDATE()))
			SET @Exist=0			
			IF @SpmId<=(SELECT ISNULL(MAX(SpmId),0) AS SpmId FROM Supplier)
			BEGIN
				SET @ErrDesc = 'Reset the counters/Check the system date'
				INSERT INTO ErrorLog VALUES (67,@TabName,'SpmId',@ErrDesc)
				SET @Po_ErrNo =1
			END
		END
		ELSE
		BEGIN
			SELECT @SpmId=SpmId FROM Supplier WHERE SpmCode=@SpmCode			
			SET @Exist=1
		END
		
		IF ISNULL(@GSTTIN,'')<>''
		BEGIN
			IF (SELECT DBO.Fn_ISGSTINNumber(@GSTTIN))=1
			BEGIN
				INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
				SELECT DISTINCT 1,'Supplier Master','GSTIN','Invalid GST Tin Number'
				SET @Po_ErrNo =1
			END
		END
		
		SET @StateName=''
		SELECT @StateName=StateName FROM StateMaster WHERE StateCode=@StateCode
		
		IF @Po_ErrNo=0
		BEGIN
			DECLARE @VatTaxGroupId AS INT
			SET @VatTaxGroupId=0
			IF EXISTS(SELECT * FROM VATDefaultSupplier (NOLOCK))
			BEGIN
				SELECT @VatTaxGroupId=MAX(ISNULL(TaxGroupId,0)) FROM VATDefaultSupplier (NOLOCK)
			END
		
			IF @Exist=0
			BEGIN
				SET @CoaId = dbo.Fn_GetPrimaryKeyInteger('CoaMaster','CoaId',CAST(YEAR(GetDate()) AS INT),Month(GetDate()))
				SELECT @AcCode = CAST(CAST(AcCode as Numeric(18,0)) + 1 as nVarchar(50)) FROM COAMaster
				WHERE CoaId=(SELECT MAX(A.CoaId) FROM COAMaster A Where A.MainGroup=1
				and A.AcCode LIKE '133%')
				INSERT INTO CoaMaster(CoaId,AcCode,AcName,AcLevel,MainGroup,Status,Availability,LastModBy,
				LastModDate,AuthId,AuthDate)
				Values (@CoaId,@AcCode,@SpmName,4,1,2,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,
				CONVERT(VARCHAR(10),GETDATE(),121))
				
				INSERT INTO Supplier(SpmId,SpmCode,SpmName,SpmAdd1,SpmAdd2,SpmAdd3,SpmPhone,SpmFax,SpmEmail,
				SpmContact,SpmDefault,CoaId,CmpId,TaxGroupId,SpmOnAcc,Availability,LastModBy,LastModDate,AuthId,AuthDate,SpmTinNo,SpmSupplier,VATTaxGroupId)			
				VALUES(@SpmId,@SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,@PhoneNo,@FaxNo,@EmailId,
				@ContPerson,(CASE @DefaultSpm WHEN 'Yes' THEN 1 ELSE 0 END),@CoaId,@CmpId,
				CASE @GSTEnabled WHEN 1 THEN @TaxGrpId ELSE 0 END,0,1,1,GETDATE(),1,GETDATE(),@SpmTinNo,1,@VatTaxGroupId)								
				UPDATE Counters SET CurrValue=CurrValue+1 WHERE TabName='Supplier' AND FldName='SpmId'	  								
				UPDATE Counters SET CurrValue=CurrValue+1 WHERE TabName='CoaMaster' AND FldName='CoaId'
			END		
			ELSE
			BEGIN
				UPDATE Supplier SET SpmName=@SpmName,SpmAdd1=@SpmAdd1,SpmAdd2=@SpmAdd2,SpmAdd3=@SpmAdd3,
				SpmPhone=@PhoneNo,SpmFax=@FaxNo,SpmContact=@ContPerson,SpmTinNo=@SpmTinNo,SpmDefault=(CASE @DefaultSpm WHEN 'Yes' THEN 1 ELSE 0 END)				
				WHERE SpmId=@SpmId
				
				IF @GSTEnabled=1
				BEGIN
					UPDATE Supplier SET TaxGroupId=CASE @GSTEnabled WHEN 1 THEN @TaxGrpId ELSE 0 END 
					WHERE SpmId=@SpmId AND ISNULL(@TaxGrpId,0)<>0
				END	
				
			END
			
			DECLARE @DefspmId AS INT
			SET @DefspmId=0			
			IF EXISTS(SELECT '*' from Supplier (NOLOCK) Having Count(SpmId)>1)
			BEGIN
				SELECT @DefspmId=Max(SpmId) FROM Supplier (NOLOCK)
				
				UPDATE Supplier SET SpmDefault=0
				UPDATE Supplier SET SpmDefault=1 where SpmId=@DefspmId
			END
			ELSE
			BEGIN
				UPDATE Supplier SET SpmDefault=1
			END
			
			
			IF @GSTEnabled=0
			BEGIN
				DELETE FROM SupplierGSTTaxGroupUpdate WHERE SpmCode=@SpmCode
				INSERT INTO SupplierGSTTaxGroupUpdate(SpmCode,TaxGroup,UpdateDateTime,UpdateFlag)
				SELECT @SpmCode,@TaxGrpCode,GETDATE(),0
			END
			
			
			IF @SupplierStatus='INACTIVE'
			BEGIN
				SET @SupplierStatus='In Active'
			END
			
			INSERT INTO ETL_Prk_CN2CS_UdcDetails (MasterName,ColumnName,[Column Code],[ColumnValue],UpdateFlag)
			SELECT DISTINCT 'Supplier Master','State Name',@SpmCode,@StateName,0 UNION ALL
			SELECT DISTINCT 'Supplier Master','GSTIN',@SpmCode,@GSTTIN,0 UNION ALL
			SELECT DISTINCT 'Supplier Master','Status',@SpmCode,@SupplierStatus,0 
			
			IF EXISTS(SELECT * FROM ETL_Prk_CN2CS_UdcDetails WHERE MasterName='Supplier Master')
			BEGIN
				EXEC Proc_Validate_CN2CS_UdcDetails 0
			END
				
		END
		FETCH NEXT FROM Cur_SupplierMaster INTO @SpmCode,@SpmName,@SpmAdd1,@SpmAdd2,@SpmAdd3,
		@TaxGrpCode,@PhoneNo,@FaxNo,@EmailId,@ContPerson,@SpmTinNo,@DefaultSpm,@GSTTIN,@StateCode,@SupplierStatus
	END
	CLOSE Cur_SupplierMaster
	DEALLOCATE Cur_SupplierMaster
	
	UPDATE Cn2Cs_Prk_SupplierMaster SET DownLoadFlag='Y' WHERE
	DownLoadFlag ='D' AND SpmCode IN (SELECT SpmCode FROM Supplier)
	AND SpmCode NOT IN (SELECT SpmCode FROM SpmToAvoid)
	
	RETURN
END
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_TaxSetting]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_TaxSetting]
GO
/*
BEGIN TRANSACTION
EXEC Proc_CN2CS_TaxSetting 0
--SELECT * FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
--SELECT * FROM TaxSettingEffectiveDate
--SELECT * FROM ErrorLog
SELECT * FROM TaxSettingMaster
--SELECT * FROM TaxSettingDetail
--SElect * from Etl_Prk_TaxSetting
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_TaxSetting]
(
	@Po_ErrNo INT OUTPUT
)
AS
/*************************************************************************************************************
* PROCEDURE	: Proc_CN2CS_TaxSetting
* PURPOSE	: To Store TaxGroup Setting records  from xml file in the Table TaxGroupSetting
* CREATED	: Mahalakshmi.A
* CREATED DATE	: 20/08/2009
* MODIFIED
* DATE      AUTHOR     DESCRIPTION
--------------------------------------------------------------------------------------------------------------
* {date}		{developer}		{brief modification description}
* 07/09/2009    Nandakumar R.G  Change the validations for Tax on Tax and other basic validations
* 09.09.2009    Panneer			Update the Download Flag in Parking Table
* 19/08/2010    Nandakumar R.G  Discount Validation Changes
* 28/04/2011    Nandakumar R.G  Discount Validation Changes
* 25/04/2017    Murugan.R		GST Migration (Taxtype,EffectiveFrom,Status)
**************************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @TaxGroupCode	 AS NVARCHAR(200)
	DECLARE @Type			 AS NVARCHAR(200)
	DECLARE @PrdTaxGroupCode AS NVARCHAR(200)
	DECLARE @TaxCode		 AS NVARCHAR(200)
	DECLARE @Percentage	     AS NUMERIC(38,6)
	DECLARE @ApplyOn		 AS NVARCHAR(100)
	DECLARE @Discount		 AS NVARCHAR(100)
	DECLARE @Tabname		 AS NVARCHAR(100)
	DECLARE @ErrDesc		 AS NVARCHAR(1000)
	DECLARE @sSql			 AS NVARCHAR(4000)
	DECLARE @ErrStatus		 AS INT
	DECLARE @Taction		 AS INT
	DECLARE @TaxSeqId	 AS INT
	DECLARE @RtrId		 AS INT
	DECLARE @PrdId		 AS INT
	DECLARE @BillSeqId	 AS INT
	DECLARE @Slno		 AS INT
	DECLARE @ColNo		 AS INT
	DECLARE @iCntColNo	 AS INT
	DECLARE @iColType	 AS INT
	DECLARE @ColValue	 AS INT
	DECLARE @RowId		 AS INT
	DECLARE @TaxId		 AS INT
	DECLARE @iApplyOn	 AS INT
	DECLARE @iDiscount	 AS INT
	DECLARE @DColNo		 AS INT
	DECLARE @FieldDesc	 AS NVARCHAR(100)
	DECLARE @SColNo		 AS INT
	DECLARE @ColId		 AS INT
	DECLARE @SlNo1		 AS INT
	DECLARE @SlNo2		 AS INT
	DECLARE @BillSeqId_Temp	AS	INT
	DECLARE @EffetOnTax		AS	INT
	DECLARE @SchDiscount		 AS NVARCHAR(100)
	DECLARE @DBDiscount		 AS NVARCHAR(100)
	DECLARE @CDDiscount		 AS NVARCHAR(100)
	DECLARE @FreightCharge   AS NVARCHAR(100)
	DECLARE @TaxType	 AS NVARCHAR(20)
	DECLARE @EffectiveFrom			 AS DATETIME
	DECLARE @ActivationFlag			 AS TinyInt
	/*
		SET @iColType=1   For TaxPercentage Value Column
		SET @iColType=2	  For MRP,SellingRate,PurchaseRate , Bill Column Sequence Value and Purchase Column Sequence
		SET @iColType=3   For Tax Configuration TaxCode Column Value
		SET @ColValue=0	  For "NONE"
		SET @ColValue=1   For "ADD"
		SET @ColValue=2   For "REDUCE"		
	*/
	
	
	DECLARE @Prdid1 INT
	SELECT @Prdid1 = ISNULL(TaxGroupId,0)  FROM TaxGroupSetting WHERE   prdgroup='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0'
	UPDATE A SET EffectiveFrom ='2017-07-01'  FROM TaxSettingMaster A  WHERE PrdId = @Prdid


	Update A set EffectiveFrom ='2017-07-01' from Etl_Prk_TaxSetting A where PrdTaxGroupCode ='TG-OC9-OS9-OI18-OU0-OCE0-IC9-IS9-II18-IU0-ICE0' 

	
	SET @Tabname = 'Etl_Prk_TaxSetting'
	SET @Po_ErrNo=0
	SET @iCntColNo=0
	DECLARE @TblColNo TABLE
	(
		ColNo			INT IDENTITY(0,1) NOT NULL,
		SlNo1			INT,
		SlNo2			INT,
		FieldDesc		NVARCHAR(50)
	)
	DECLARE @T1 TABLE
	(
		SlNo			INT,
		FieldDesc		NVARCHAR(50)
	)
	DELETE FROM Etl_Prk_TaxSetting WHERE DownLoadFlag='Y'
	SET @ActivationFlag=0
	
	IF EXISTS(SELECT 'X' FROM GSTConfiguration (NOLOCK) WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1 
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)>=ActivationDate and ModuleId='GSTConfig')
	BEGIN
		SELECT @ActivationFlag=1
	END
	
	SELECT DISTINCT ISNULL(TaxGroupCode,'') as TaxGroupCode,ISNULL(Type,'') as Type,ISNULL(PrdTaxGroupCode,'') as PrdTaxGroupCode,
	ISNULL(TaxType,'VAT') as TaxType,
	MAX(ISNULL(EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))) as EffectiveFrom
	INTO #EtlTaxSettings
	FROM Etl_Prk_TaxSetting WHERE DownloadFlag='D'
	GROUP BY ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),ISNULL(TaxType,'VAT')
	
	
	DELETE A FROM Etl_Prk_TaxSetting A (NOLOCK)	
	INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))<>ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	
	
	SELECT DISTINCT DistCode,A.TaxGroupCode,A.Type,A.PrdTaxGroupCode,A.TaxCode,
	Percentage,ApplyOn,Discount,SchDiscount,DBDiscount,CDDiscount,ApplyTax,
	DownloadFlag,CreatedDate,A.TaxType,A.EffectiveFrom,FreightCharge
	INTO #Etl_Prk_Tax
	FROM Etl_Prk_TaxSetting A (NOLOCK) INNER JOIN #EtlTaxSettings B ON
	ISNULL(A.TaxGroupCode,'')=ISNULL(B.TaxGroupCode,'')
	AND ISNULL(A.PrdTaxGroupCode,'')=ISNULL(B.PrdTaxGroupCode,'')
	AND ISNULL(A.Type,'')=ISNULL(B.Type,'')
	AND ISNULL(A.TaxType,'VAT')=ISNULL(B.TaxType,'VAT')
	AND ISNULL(A.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))=ISNULL(B.EffectiveFrom,CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121))
	WHERE DownloadFlag='D'
	DECLARE Cur_TaxSettingMaster CURSOR		--TaxSettingMaster Cursor
	FOR SELECT DISTINCT ISNULL(TaxGroupCode,''),ISNULL(Type,''),ISNULL(PrdTaxGroupCode,''),TaxType,EffectiveFrom
	FROM #EtlTaxSettings
	-- WHERE DownloadFlag='D'
	OPEN Cur_TaxSettingMaster
	FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	WHILE @@FETCH_STATUS=0
	BEGIN
		--Check the Empty Values for TaxSetting Master
		SET @iCntColNo=6
		IF @TaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Tax Group Code: ' + @TaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Group code',@ErrDesc)
		END
		IF @Type=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Type ' + @Type + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		IF @PrdTaxGroupCode=''
		BEGIN
			SET @Po_ErrNo=1
			SET @Taction=0
			SET @ErrDesc = 'Product Tax Group Code ' + @PrdTaxGroupCode + ' should not be Empty'
			INSERT INTO Errorlog VALUES (1,@Tabname,'Type',@ErrDesc)
		END
		--Till Here
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE RtrGroup = @TaxGroupCode) --Get the Retailer/Supplier TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'TaxGroupCode ' + @TaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @RtrId=TaxGroupId FROM TaxGroupSetting WHERE RtrGroup= @TaxGroupCode
		END
		IF NOT EXISTS  (SELECT * FROM TaxgroupSetting WHERE PrdGroup = @PrdTaxGroupCode) --Get the Product TaxGroupId's
		BEGIN
			SET @Po_ErrNo=1
			SET @ErrDesc = 'Product TaxGroupCode ' + @PrdTaxGroupCode + ' is not available' 		
			INSERT INTO Errorlog VALUES (2,@Tabname,'Product Tax Group Code',@ErrDesc)
		END
		ELSE
		BEGIN
			SELECT @PrdId=TaxGroupId FROM TaxGroupSetting WHERE PrdGroup= @PrdTaxGroupCode
		END
		
		DELETE FROM @T1
		IF UPPER(@Type)='RETAILER'
		BEGIN
			SELECT DISTINCT @BillSeqId=BillSeqId FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			SELECT @iCntColNo=@iCntColNo+COUNT(BillSeqId) FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo < (SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)
			
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc
			FROM BillSequenceDetail (NOLOCK)
			WHERE SlNo >= 4 and SlNo <
			(SELECT Slno From BillSequenceDetail WHERE RefCode='H' and BillSeqId in
			(SELECT Max(BillSeqId) FROM BillSequenceMaster)) Order By SlNo
		END
		ELSE IF UPPER(@Type)='SUPPLIER'
		BEGIN
			SELECT DISTINCT @BillSeqId=PurSeqId FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			
			SELECT @iCntColNo=@iCntColNo+COUNT(PurSeqId) FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))  and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster)
			INSERT INTO @T1(SlNo,FieldDesc)
			SELECT Slno,FieldDesc FROM PurchaseSequenceDetail (NOLOCK)
			WHERE SlNo >= 3 and SlNo <
			(SELECT Slno From PurchaseSequenceDetail WHERE RefCode='D' and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster))
			and PurSeqId in
			(SELECT Max(PurSeqId) FROM PurchaseSequenceMaster) Order By SlNo
		END
		SELECT @iCntColNo=@iCntColNo+(COUNT(TaxId)) FROM TaxConfiguration
		SELECT @TaxSeqId= dbo.Fn_GetPrimaryKeyInteger('TaxSettingMaster','TaxSeqId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
		IF  @Po_ErrNo=0
		BEGIN	
			INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate,TaxType,EffectiveFrom,Status)
			VALUES(@TaxSeqId,@RtrId,@PrdID,CONVERT(NVARCHAR(11),GETDATE(),121),1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121),@TaxType,@EffectiveFrom,
			CASE @TaxType WHEN  'VAT' THEN 1 
									  ELSE 
										  CASE @ActivationFlag 
										  WHEN 1 THEN 1							
										  ELSE 0 
										  END  
									  END)
			SET @sSql= 'INSERT INTO TaxSettingMaster(TaxSeqId,RtrId,PrdId,SequenceDate,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@TaxSeqId AS NVARCHAR(100)) + ',' + CAST(@RtrId AS NVARCHAR(100)) +','+ CAST(@PrdId AS NVARCHAR(100))+ ','''
						+ CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,1,''' + CONVERT(NVARCHAR(11),GETDATE(),121)+''',1,'''+ CONVERT(NVARCHAR(11),GETDATE(),121)+ ''')'
						
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE	Tabname = 'TaxSettingMaster' AND Fldname = 'TaxSeqId'
			
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSettingMaster'' AND Fldname = ''TaxSeqId'''
			
			INSERT INTO Translog(strSql1) Values (@sSQL)
		END
		
		DECLARE @TaxSettingTable TABLE
		(
			TaxId			INT,
			TaxGrpCode		NVARCHAR(200),
			Type			NVARCHAR(200),
			TaxPrdGrpCode	NVARCHAR(200),
			TaxCode			NVARCHAR(200),
			Percentage		NUMERIC(38,6),
			Applyon			NVARCHAR(200),
			Discount		NVARCHAR(200),
			SchDiscount		NVARCHAR(200),
			DBDiscount		NVARCHAR(200),
			CDDiscount		NVARCHAR(200),
			FreightCharge   NVARCHAR(200)
		)
		DELETE FROM @TaxSettingTable
		INSERT INTO @TaxSettingTable (TaxId,TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,
		SchDiscount,DBDiscount,CDDiscount,FreightCharge)
		SELECT DISTINCT TC.TaxId, ISNULL(ETL1.TaxGroupCode,''),ISNULL(ETL1.Type,''),
		ISNULL(ETL1.PrdTaxGroupCode,''),ISNULL(TC.TaxCode,''),ISNULL(ETL1.Percentage,0),
		ISNULL(ETL1.ApplyOn,'None'),ISNULL(ETL1.Discount,'None'),ISNULL(ETL1.SchDiscount,'None'),
		ISNULL(ETL1.DBDiscount,'None'),ISNULL(ETL1.CDDiscount,'None'),ISNULL(ETL1.FreightCharge,'None') 
		FROM
		(SELECT ISNULL(ETL.TaxGroupCode,'') AS TaxGroupCode,ISNULL(ETL.Type,'') AS Type,ISNULL(ETL.TaxCode,'') AS TaxCode,
		ISNULL(ETL.PrdTaxGroupCode,'') AS PrdTaxGroupCode,ISNULL(ETL.Percentage,0) AS Percentage,ISNULL(ETL.ApplyOn,'') AS ApplyOn,
		ISNULL(ETL.Discount,'') AS Discount,ISNULL(ETL.SchDiscount,'') AS SchDiscount,ISNULL(ETL.DBDiscount,'') AS DBDiscount,
		ISNULL(ETL.CDDiscount,'') AS CDDiscount,ISNULL(ETL.FreightCharge,'') AS FreightCharge
		FROM Etl_Prk_TaxSetting ETL
		WHERE DownloadFlag='D' AND TaxGroupCode=@TaxGroupCode AND PrdTaxGroupCode=@PrdTaxGroupCode) ETL1
		RIGHT OUTER JOIN TaxConfiguration TC ON TC.TaxCode=ETL1.TaxCode
		SET @RowId=0
		DECLARE Cur_TaxSettingDetail CURSOR		--TaxSettingDetail Cursor
		FOR SELECT TaxGrpCode,Type,TaxPrdGrpCode,TaxCode,Percentage,Applyon,Discount,SchDiscount,DBDiscount,CDDiscount,FreightCharge
		FROM @TaxSettingTable Order By TaxId
		OPEN Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
		@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		WHILE @@FETCH_STATUS=0
		BEGIN
			SET @RowId=@RowId+1
			--Nanda
			--SELECT @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount
			
			IF @TaxCode=''	--Check Empty Values For TaxSetting Details
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Tax Code' + @TaxCode + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			
			IF @Percentage<0
			BEGIN
				SET @Po_ErrNo=1
				SET @Taction=0
				SET @ErrDesc = 'Percentage' + CAST(@Percentage AS NVARCHAR(20)) + ' should not be Empty'
				INSERT INTO Errorlog VALUES (1,@Tabname,'Percentage',@ErrDesc)
			END
			IF @Applyon=''
			BEGIN
				SET @iApplyOn=0
			END
			ELSE IF UPPER(@ApplyOn)='SELLINGRATE' OR UPPER(@ApplyOn)='MRP' OR UPPER(@ApplyOn)='PURCHASERATE'
			BEGIN
				SET @iApplyOn=1
			END
			ELSE
			BEGIN
				SET @iApplyOn=2
			END
			IF @Discount='ADD'
			BEGIN
				SET @iDiscount=1
			END
			ELSE IF UPPER(@Discount)='REDUCE'
			BEGIN
				SET @iDiscount=2
			END
			ELSE
			BEGIN
				SET @iDiscount=0
			END		
			--Till Here
			IF NOT EXISTS  (SELECT * FROM TaxConfiguration WHERE TaxCode = @TaxCode )
			BEGIN
				SET @Po_ErrNo=1
				SET @ErrDesc = 'Tax Code: ' + @TaxCode + ' is not available' 		
				INSERT INTO Errorlog VALUES (1,@Tabname,'Tax Code',@ErrDesc)
			END
			ELSE
			BEGIN
				SELECT @TaxId=TaxId FROM TaxConfiguration WHERE TaxCode=@TaxCode	
			END
			DELETE FROM @TblColNo
			INSERT INTO @TblColNo(SlNo1,SlNo2,FieldDesc)
			SELECT 1,1,'TaxID' AS FieldDesc
			UNION
			SELECT 2,1,'Tax Name' AS FieldDesc
			UNION
			SELECT 3,1,'Tax%' AS FieldDesc
			UNION
			SELECT 4,1,'MRP' AS FieldDesc
			UNION
			SELECT 5,1,'SELLING RATE' AS FieldDesc
			UNION
			SELECT 6,1,'PURCHASE RATE' AS FieldDesc
			UNION
			SELECT 7,Slno,FieldDesc FROM @T1
			UNION
			SELECT 8,TaxId,TaxName FROM TaxConfiguration
			
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,1,@SlNo,@BillSeqId,@TaxSeqId,1,@TaxId,@TaxId,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
			
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',1,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,' + CAST(@TaxId AS NVARCHAR(100)) + ',' +CAST(@TaxId AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
			INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
			ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
			VALUES(@RowId,3,@SlNo,@BillSeqId,@TaxSeqId,1,0,@Percentage,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
			SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
				+ CAST(@RowId AS NVARCHAR(100)) + ',3,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
				+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',1,0,' +CAST(@Percentage AS NVARCHAR(100)) + ',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
			INSERT INTO Translog(strSql1) VALUES (@sSql)
			
			UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
			SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
			INSERT INTO Translog(strSql1) Values (@sSQL)
			SET @sColNo=4
			
			--------TaxSetting1-->Price Settings---------------------
			DECLARE Cur_TaxSetting1 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,FieldDesc FROM @TblColNo WHERE SlNo1>3 AND SlNo1<7
			OPEN Cur_TaxSetting1
			FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			WHILE @@FETCH_STATUS=0
			BEGIN
				IF @sColNo=4 AND UPPER(@ApplyOn)='MRP'
				BEGIN
					--SET MRP as 1 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=5 AND UPPER(@ApplyOn)='SELLINGRATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Selling Rate Value as 1
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',5,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF @sColNo=6 AND UPPER(@ApplyOn)='PURCHASERATE'	
				BEGIN
					--SET MRP AS Value as 0
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',4,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
		
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Sellling Rate as 0 Value
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					INSERT INTO Translog(strSql1) Values (@sSQL)
					--SET Purchase Rate as 1						
					SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
					ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,1,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,1,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'											
					
					INSERT INTO Translog(strSql1) VALUES (@sSql)
					UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
					SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
					INSERT INTO Translog(strSql1) Values (@sSQL)
				END
				ELSE IF EXISTS(SELECT TaxCode FROM TaxConfiguration WHERE TaxCode=@ApplyOn) OR UPPER(@ApplyOn)='NONE'
				BEGIN					
					IF @sColNo=4
					BEGIN
						--SET MRP as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,4,@SlNo,@BillSeqId,@TaxSeqId,2,1,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,1,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
											
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
					END
					ELSE IF @sColNo=5
					BEGIN
						--SET Sellling Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,5,@SlNo,@BillSeqId,@TaxSeqId,2,2,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,2,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
						
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
					ELSE IF @sColNo=6
					BEGIN
						--SET Purchase Rate as 0 Value
						SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,6,@SlNo,@BillSeqId,@TaxSeqId,2,3,0,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
							+ CAST(@RowId AS NVARCHAR(100)) + ',6,' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
							+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,3,0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
												
						INSERT INTO Translog(strSql1) VALUES (@sSql)
						UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
						SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
						INSERT INTO Translog(strSql1) Values (@sSQL)
					END
				END	
--				--Nanda
--				SELECT * FROM TaxSettingDetail WHERE TaxSeqId=@TaxSeqId AND RowId=@RowId
				SET @sColNo=@sColNo+1
	
				FETCH NEXT FROM Cur_TaxSetting1 INTO @DColNo,@FieldDesc
			END
			CLOSE Cur_TaxSetting1
			DEALLOCATE Cur_TaxSetting1
			-----TaxSetting1--------------------------------
			----------------TaxSetting2-->Bill/Purchase Column Sequnce Settings---------------------
			SET @sColNo=7
			SET @ColId=4
			--Nanda
			--SELECT ColNo,SlNo1,FieldDesc FROM @TblColNo WHERE SlNo1=7
			DECLARE Cur_TaxSetting2 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR
				SELECT ColNo,SlNo1,FieldDesc,SlNo2  FROM @TblColNo WHERE SlNo1=7
			OPEN Cur_TaxSetting2
			FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				
				SET @EffetOnTax=0
				IF UPPER(@Type)='RETAILER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(BillSeqId) FROM dbo.BillSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.BillSequenceDetail WHERE BillSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					--->Added By Nanda on 28/04/2011										
					IF @FieldDesc='Spl. Disc' 
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='Sch Disc' 
					BEGIN
						IF UPPER(@SchDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@SchDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='DB Disc' 
					BEGIN
						IF UPPER(@DBDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@DBDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE IF @FieldDesc='CD Disc'
					BEGIN
						IF UPPER(@CDDiscount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@CDDiscount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					ELSE
					BEGIN
						IF UPPER(@Discount)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
					END	
					--->Till Here
				END
				ELSE IF UPPER(@Type)='SUPPLIER'
				BEGIN
					SELECT @BillSeqId_Temp=MAX(PurSeqId) FROM dbo.PurchaseSequenceMaster
					SELECT @EffetOnTax=EffectInNetAmount FROM dbo.PurchaseSequenceDetail WHERE PurSeqId=@BillSeqId_Temp 
					AND SlNo=@SlNo2
					
					IF UPPER(@FieldDesc)='FREIGHTCHARGES' 
					BEGIN
						IF UPPER(@FreightCharge)='ADD'
						BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@FreightCharge)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END					
				     END
				     ELSE IF UPPER(@FieldDesc) = 'DISC'
					 BEGIN
					    IF UPPER(@Discount)='ADD'
					    BEGIN
							SET @iDiscount=1
						END
						ELSE IF UPPER(@Discount)='REDUCE'
						BEGIN
							SET @iDiscount=2
						END
						ELSE
						BEGIN
							SET @iDiscount=0
						END
					 END
					 ELSE
					 BEGIN
					     SET @iDiscount=0
					 END
				END			        		 
									
				IF @iApplyOn=2
				BEGIN
					SET @EffetOnTax=0
				END				
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
				ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
				--VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@EffetOnTax,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,2,@ColId,@iDiscount,1,1,CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',2,'+ CAST(@ColId AS NVARCHAR(100))+ ',' +CAST(@EffetOnTax AS NVARCHAR(100))+',1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
		
				INSERT INTO Translog(strSql1) Values (@sSQL)					
				SET @sColNo=@sColNo+1
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting2 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting2
			DEALLOCATE Cur_TaxSetting2
			------TaxSetting2-----------------------
			-------TaxSetting3-->Tax On Tax Settings-----------------------
			SET @sColNo=@sColNo
			SET @ColId=1
			
			DECLARE Cur_TaxSetting3 CURSOR		--Column Wise Details Inserts row Wise Cursor
			FOR SELECT ColNo,SlNo1,FieldDesc,SlNo2 FROM @TblColNo WHERE SlNo1=8 AND SlNo2<>@TaxId
			OPEN Cur_TaxSetting3
			FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			WHILE @@FETCH_STATUS=0
			BEGIN
				SELECT @Slno= dbo.Fn_GetPrimaryKeyInteger('TaxSetting','SlNo',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))					
				IF @iApplyOn<>2
				BEGIN
					INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
					VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
					CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT * FROM TaxConfiguration WHERE TaxCode=@Applyon AND TaxId=@SlNo2)
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,@SlNo2,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
						SET @iApplyOn=1
					END
					ELSE
					BEGIN
						INSERT INTO TaxSettingDetail (RowId,ColNo,SlNo,BillSeqId,TaxSeqId,
						ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)
						VALUES(@RowId,@sColNo,@SlNo,@BillSeqId,@TaxSeqId,3,@TaxId,0,1,1,
						CONVERT(NVARCHAR(11),GETDATE(),121),1,CONVERT(NVARCHAR(11),GETDATE(),121))
					END
				END
				SET @sSql= 'INSERT INTO TaxSettingDetail(RowId,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal,Availability,LastModBy,LastModDate,AuthId,AuthDate)VALUES('
						+ CAST(@RowId AS NVARCHAR(100)) + ',' + CAST(@sColNo AS NVARCHAR(100)) + ',' + CAST(@SlNo AS NVARCHAR(100)) +','+ CAST(@BillSeqId AS NVARCHAR(100))
						+ ',' + CAST(@TaxSeqId AS NVARCHAR(100)) + ',3,'+ CAST(@TaxId AS NVARCHAR(100))+ ',0,1,1,'''+CONVERT(NVARCHAR(11),GETDATE(),121) + ''',1,''' + CONVERT(NVARCHAR(11),GETDATE(),121) + ''')'
										
				
				INSERT INTO Translog(strSql1) VALUES (@sSql)
				UPDATE Counters SET Currvalue = Currvalue + 1  WHERE Tabname = 'TaxSetting' AND Fldname = 'SlNo'
	
				SET @sSQL='UPDATE Counters SET Currvalue = Currvalue + 1 WHERE Tabname = ''TaxSetting'' AND Fldname = ''SlNo'''
	
				INSERT INTO Translog(strSql1) Values (@sSQL)
				SET @ColId=@ColId+1
				FETCH NEXT FROM Cur_TaxSetting3 INTO @DColNo,@SlNo1,@FieldDesc,@SlNo2
			END
			CLOSE Cur_TaxSetting3
			DEALLOCATE Cur_TaxSetting3
			UPDATE Etl_Prk_TaxSetting  SET DownloadFlag = 'Y'
			WHERE TaxGroupCode = @TaxGroupCode AND TaxCode = @TaxCode AND Percentage = @Percentage
			AND Type = @Type AND PrdTaxGroupCode = @PrdTaxGroupCode
			FETCH NEXT FROM Cur_TaxSettingDetail INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxCode,@Percentage,@ApplyOn,@Discount,
			@SchDiscount,@DBDiscount,@CDDiscount,@FreightCharge
		END
		CLOSE Cur_TaxSettingDetail
		DEALLOCATE Cur_TaxSettingDetail
		FETCH NEXT FROM Cur_TaxSettingMaster INTO @TaxGroupCode,@Type,@PrdTaxGroupCode,@TaxType,@EffectiveFrom
	END
	CLOSE Cur_TaxSettingMaster
	DEALLOCATE Cur_TaxSettingMaster	
	UPDATE TaxSettingDetail SET ColVal=0 WHERE ColId=1 AND ColType=2 AND CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10))
	NOT IN (SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId IN(SELECT TaxId FROM TaxConfiguration WHERE TaxCode='VAT'))
	AND  CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) IN (
	SELECT CAST(TaxSeqId AS NVARCHAR(10))+'~'+CAST(RowId AS NVARCHAR(10)) FROM TaxSettingDetail WHERE ColType=1 AND ColId=0 AND ColVal=0)
	
	----Retailer Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Retailer' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @RtrTaxGroupId AS NUMERIC(18,0)
	--	SET @RtrTaxGroupId = 0
	--	SELECT @RtrTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 1
	--	IF @RtrTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Retailer SET TaxGroupId = @RtrTaxGroupId
	--	END
	--END
	----Till Here
	----Supplier Latest Tax Group Updation
	--IF NOT EXISTS (SELECT DISTINCT [Type],COUNT(DISTINCT TaxGroupCode) FROM Etl_Prk_TaxSetting (NOLOCK) WHERE [Type] = 'Supplier' 
	--GROUP BY [Type] HAVING COUNT(DISTINCT TaxGroupCode)>1)
	--BEGIN
	--	DECLARE @SupTaxGroupId AS NUMERIC(18,0)
	--	SET @SupTaxGroupId = 0
	--	SELECT @SupTaxGroupId = B.TaxGroupId FROM Etl_Prk_TaxSetting A (NOLOCK) 
	--	INNER JOIN TaxGroupSetting B (NOLOCK) ON A.TaxGroupCode = B.RtrGroup WHERE B.TaxGroup = 3
	--	IF @SupTaxGroupId <> 0
	--	BEGIN 	
	--	   UPDATE Supplier SET TaxGroupId = @SupTaxGroupId
	--	END
	--END
	----Till Here
	
	RETURN
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ComputeTax' AND TYPE='P')
DROP PROCEDURE Proc_ComputeTax
GO
/*
BEGIN  TRANSACTION
EXEC Proc_ComputeTax 1,26,1
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE Proc_ComputeTax
(      
 @Pi_RowId  INT,      
 @Pi_CalledFrom  INT,        
 @Pi_UserId  INT,
 @Pi_RtrShipId  INT=0,
 @Pi_gServerDate DateTime='1990-01-01',
 @Pi_ApplyTax INT=1
)      
AS      
/*********************************      
* PROCEDURE : Proc_ComputeTax      
* PURPOSE : To Calculate the Line Level Tax      
* CREATED : Thrinath      
* CREATED DATE : 22/03/2007      
* MODIFIED
* DATE      AUTHOR     DESCRIPTION 
24/05/2009	MURUGAN	   OID CalCulation For Nestle	
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
15-09-2011  Boopathy	   Taxable amount from MRP to Gross amount only for J&J
17-11-2017  Mohana.S		 After  Based On Configuration Sales return tax will change.
------------------------------------------------      
* {date} {developer}  {brief modification description}            
@Pi_CalledFrom  2  For Sales      
@Pi_CalledFrom  3  For Sales Return       
@Pi_CalledFrom  5  For Purchase      
@Pi_CalledFrom  7  For Purchase Return      
@Pi_CalledFrom  20 For Replacement      
@Pi_CalledFrom  23  For Market Return       
@Pi_CalledFrom  24 For Return And Replacement      
@Pi_CalledFrom  25 For Sales Panel   
@Pi_CalledFrom  26 For Purchase Order
*********************************/       
SET NOCOUNT ON      
BEGIN      
	DECLARE @PrdBatTaxGrp   INT      
	DECLARE @RtrTaxGrp   INT      
	DECLARE @TaxSlab  INT      
	DECLARE @MRP   NUMERIC(28,10)      
	DECLARE @SellingRate  NUMERIC(28,10)      
	DECLARE @PurchaseRate  NUMERIC(28,10)      
	DECLARE @TaxableAmount  NUMERIC(28,10)    
	DECLARE @TotalDedAmt  NUMERIC(28,10)  
	DECLARE @ParTaxableAmount NUMERIC(28,10)      
	DECLARE @TaxPer   NUMERIC(38,6)      
	DECLARE @TaxId   INT      
	DECLARE	@ApplyOn INT
	DECLARE @TaxSetting TABLE       
	(      
		TaxSlab   INT,      
		ColNo   INT,      
		SlNo   INT,      
		BillSeqId  INT,      
		TaxSeqId  INT,      
		ColType   INT,       
		ColId   INT,      
		ColVal   NUMERIC(38,6)      
	)      
	IF ISNULL(@Pi_gServerDate,'1990-01-01')='1990-01-01'
	BEGIN
		SET @Pi_gServerDate=CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),121),121)
	END
	
	IF ISNULL(@Pi_RtrShipId,0)=0
	BEGIN
		SET @Pi_RtrShipId=0
	END
	--To Take the Batch TaxGroup Id      
	SELECT @PrdBatTaxGrp = TaxGroupId FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	--To Take the Batch MRP      
	SELECT @MRP = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
	BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
	AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
	INNER JOIN ProductBatchDetails C (NOLOCK)      
	ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
	INNER JOIN BatchCreation D (NOLOCK)      
	ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
	AND D.MRP = 1       
	--To Take the Batch Selling Rate      
	IF @Pi_CalledFrom = 2 OR @Pi_CalledFrom = 25 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 23      
	BEGIN      
		SELECT @SellingRate = ColValue FROM BilledPrddtForTax WHERE TransId = @Pi_CalledFrom       
		AND UsrId = @Pi_UserId AND RowId = @Pi_RowId AND ColId = -2      
	END      
	ELSE      
	BEGIN      
		IF @Pi_CalledFrom = 20
		BEGIN 
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId IN (SELECT max(PBD.priceid) FROM productbatchdetails PBD WHERE pbd.prdbatid=b.PrdBatId)    
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
		ELSE      
		BEGIN      
			SELECT @SellingRate = ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.SelRte = 1      
		END      
	END 
	--To Take the Batch List Price 
	--Added by Murugan For OID Calculation
	IF (@Pi_CalledFrom = 5 OR @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)
	BEGIN   
		IF  EXISTS(SELECT Status FROM Configuration WHERE ModuleId = 'PURCHASERECEIPT16' and Status=1)   
		BEGIN  
			SELECT  @PurchaseRate = Isnull(ColValue,0) FROM BilledPrdDtForTax B  
			WHERE  B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 
			and COLID=3	   
		END  
		ELSE  
		BEGIN 
			SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
			INNER JOIN ProductBatchDetails C (NOLOCK)      
			ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
			INNER JOIN BatchCreation D (NOLOCK)      
			ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
			AND D.ListPrice = 1     
		END  
		--->Added By Nanda on 2011/05/12
		IF @Pi_CalledFrom = 37
		BEGIN
			IF EXISTS(SELECT * FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			BEGIN
				SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
				BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
				AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
				INNER JOIN ProductBatchDetails C (NOLOCK)      
				ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
				INNER JOIN BatchCreation D (NOLOCK)      
				ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
				AND LTRIM(RTRIM(D.RefCode)) IN (SELECT LEFT(Condition,1) FROM CONFIGURATION WHERE MODULEID='RTNTOCOMPANY7' AND Status=1)
			END
		END
		--->Till Here
	END
	ELSE
	BEGIN
		SELECT @PurchaseRate =ISNULL((C.PrdBatDetailValue * BaseQty),0) FROM ProductBatch A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.PrdId = B.PrdId AND A.PrdBatID = B.PrdBatID      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom      
		INNER JOIN ProductBatchDetails C (NOLOCK)      
		ON A.PrdBatId = C.PrdBatID AND C.PriceId = B.PriceId      
		INNER JOIN BatchCreation D (NOLOCK)      
		ON D.BatchSeqId = A.BatchSeqId AND D.SlNo = C.SlNo      
		AND D.ListPrice = 1  
	END
	IF (@Pi_CalledFrom = 2 OR @Pi_CalledFrom = 3 OR @Pi_CalledFrom = 20 OR @Pi_CalledFrom = 23 OR       
	@Pi_CalledFrom = 24 OR @Pi_CalledFrom = 25)      
	BEGIN      
		--To Take the Retailer TaxGroup Id      
		IF EXISTS(SELECT 'X' FROM RetailerShipAdd C (NOLOCK)
		INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
		INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
		WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
		AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0)
		BEGIN
			SELECT @RtrTaxGrp=C.TaxGroupId FROM RetailerShipAdd C (NOLOCK)
			INNER JOIN Retailer A (NOLOCK) ON A.RtrId=C.RtrId
			INNER JOIN  BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId  and  B.RtrId = C.RtrId  
			WHERE C.RtrShipId=@Pi_RtrShipId AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom and C.TaxGroupId>0
		END
		ELSE
		BEGIN		 
			SELECT @RtrTaxGrp = TaxGroupId FROM Retailer A (NOLOCK) INNER JOIN      
			BilledPrdHdForTax B (NOLOCK) On A.RtrId = B.RtrId      
			AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId       
			AND B.TransId = @Pi_CalledFrom      
		END		 
	END      
	IF (@Pi_CalledFrom = 5 OR  @Pi_CalledFrom = 26 OR @Pi_CalledFrom = 7 OR @Pi_CalledFrom = 37)      
	BEGIN      
		--To Take the Supplier TaxGroup Id      
		SELECT @RtrTaxGrp = TaxGroupId FROM Supplier A (NOLOCK) INNER JOIN      
		BilledPrdHdForTax B (NOLOCK) On A.SpmId = B.RtrId      
		AND B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId      
		AND B.TransId = @Pi_CalledFrom      
	END      
	--Store the Tax Setting for the Corresponding Retailer and Batch      
	INSERT INTO @TaxSetting (TaxSlab,ColNo,SlNo,BillSeqId,TaxSeqId,ColType,ColId,ColVal)      
	SELECT B.RowId,B.ColNo,B.SlNo,B.BillSeqId,B.TaxSeqId,B.ColType,B.ColId,B.ColVal      
	FROM TaxSettingMaster A (NOLOCK) INNER JOIN      
	TaxSettingDetail B (NOLOCK) ON A.TaxSeqId = B.TaxSeqId      
	INNER JOIN BilledPrdHdForTax C (NOLOCK) ON C.BillSeqId = B.BillSeqId      
	WHERE A.RtrId = @RtrTaxGrp AND A.Prdid = @PrdBatTaxGrp AND C.UsrId = @Pi_UserId      
	AND C.RowId = @Pi_RowId AND C.TransId = @Pi_CalledFrom      
	AND A.TaxSeqId in (Select ISNULL(Max(TaxSeqId),0) FROM TaxSettingMaster WHERE      
	RtrId = @RtrTaxGrp AND Prdid = @PrdBatTaxGrp
	and CONVERT(DATETIME,CONVERT(VARCHAR(10),EffectiveFrom,121),121)<=CONVERT(DATETIME,CONVERT(VARCHAR(10),@Pi_gServerDate,121),121) --GST
	)
	--Delete the OLD Details From the BilledPrdDtCalculatedTax For the Row and User      
	DELETE FROM BilledPrdDtCalculatedTax WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId       
	AND TransId = @Pi_CalledFrom      
	--Cursor For Taking Each Slab and Calculate Tax      
	DECLARE  CurTax CURSOR FOR      
	SELECT DISTINCT TaxSlab FROM @TaxSetting      
	OPEN CurTax        
	FETCH NEXT FROM CurTax INTO @TaxSlab      
	WHILE @@FETCH_STATUS = 0        
	BEGIN      
		SET @TaxableAmount = 0      
		--To Filter the Records Which Has Tax Percentage (>=0)      
		IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
		AND ColId = 0 and ColVal >= 0)      
		BEGIN
			--To Get the Tax Percentage for the selected slab      
			SELECT @TaxPer = ColVal FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId = 0      
			IF @Pi_ApplyTax=0 
			BEGIN
				SET @TaxPer=0
				--SET @CalSurCharge=0
				--SET @AddtionTax=0
			END			
			--To Get the TaxId for the selected slab      
			SELECT @TaxId = Cast(ColVal as INT) FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 1      
			AND ColId > 0      
	         
			--To Get the Adjustable amount from Other Columns      
			SELECT @TaxableAmount = ISNULL(SUM(ColValue),0) FROM       
			(SELECT CASE B.ColVal WHEN 1 THEN A.ColValue WHEN 2 THEN -1 * A.ColValue END       
			AS ColValue FROM BilledPrdDtForTax A INNER JOIN @TaxSetting B      
			ON A.ColId = B.ColId AND A.RowId =  @Pi_RowId AND A.UsrId = @Pi_UserId       
			AND A.TransId = @Pi_CalledFrom      
			WHERE TaxSlab = @TaxSlab AND B.ColType = 2 and B.ColId>3      
			And B.ColVal >0) as C      
			SET @ApplyOn=0
			SET @TotalDedAmt=@TaxableAmount
			--To add MRP to Taxable Amount if MRP Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @MRP      
				SET @ApplyOn=1 
			END
			--To add Selling Rate to Taxable Amount if Selling Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 2 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @SellingRate      
	      
			--To add Purchase Rate to Taxable Amount if Purchase Rate Is Selected for the Slab      
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 3 and ColVal > 0)       
			SET @TaxableAmount = ISNULL(@TaxableAmount,0) + @PurchaseRate      
			--To Get the Parent Taxable Amount for the Tax Slab      
			SELECT @ParTaxableAmount =  ISNULL(SUM(TaxAmount),0) FROM BilledPrdDtCalculatedTax A      
			INNER JOIN @TaxSetting B ON A.TaxId = B.ColVal AND A.RowId = @Pi_RowId      
			AND A.UsrId = @Pi_UserId AND B.ColType = 3 AND B.TaxSlab = @TaxSlab      
			AND A.TransId = @Pi_CalledFrom     
			Set @TaxableAmount = @TaxableAmount + @ParTaxableAmount      
	      
			--Insert the New Tax Amounts        
			INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
			TaxableAmount,TaxAmount,Usrid,TransId)      
			SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@TaxId,@TaxSlab,@TaxPer,      
		    @TaxableAmount, CASE @ApplyOn 
			WHEN 0 THEN	cast(@TaxableAmount * (@TaxPer / 100 ) AS NUMERIC(38,6))
			WHEN 1 THEN cast(@TaxableAmount * (@TaxPer / (100 +@TaxPer)) AS NUMERIC(38,6)) END,      
			@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
			B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom     
			IF EXISTS (SELECT * FROM @TaxSetting WHERE TaxSlab = @TaxSlab AND ColType = 2      
			AND ColId = 1 and ColVal > 0)       
			BEGIN
				SET @TaxableAmount =  @TotalDedAmt+ @SellingRate
				UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=@TaxableAmount
				WHERE RowId = @Pi_RowId AND UsrId = @Pi_UserId AND TransId = @Pi_CalledFrom 							
			END 
			
		END      
		FETCH NEXT FROM CurTax INTO @TaxSlab      
	END        
	CLOSE CurTax        
	DEALLOCATE CurTax           
	-----Only for SalesReturn
IF EXISTS (SELECT * FROM ManualConfiguration WHERE ModuleId='Sal_Return_Tax' AND Status = 1)--Added By Mohana
BEGIN

	CREATE TABLE #SalesReturnTax
	(
		Slno INT IDENTITY(1,1),
		RowId  INT,
		SalRowId INT,
		Taxperc Numeric(18,6),
		TaxId INT,
		Prdid INT,
		PrdbatId INT
	)
	DECLARE @MaxSlno AS INT
	DECLARE @MinSlno AS INT
	DECLARE @RtnPrdid AS INT
	DECLARE @RtnPrdbatId AS INT
	DECLARE @RtnTaxId AS INT
	DECLARE @RtnTaxPerc AS Numeric(18,6)
	DECLARE @RtnTaxableAmount AS Numeric(18,6)
	SET @MinSlno=1
	
	IF @Pi_CalledFrom = 3
	BEGIN
		IF EXISTS(SELECT 'X' FROM GSTConfiguration WHERE ActivationStatus=1 and AcknowledgeStatus=1 and ConsoleAckStatus=1)
		BEGIN
				---Only With Reference
				INSERT INTO #SalesReturnTax(RowId,SalRowId,TaxPerc,TaxId,PrdId,PrdbatId)
				SELECT DISTINCT RowId,SalRowId,CASE @Pi_ApplyTax WHEN 0 THEN 0.00 ELSE  TaxPerc END,TaxId,PrdId,PrdbatId 	
				FROM BilledPrdHdForTax_GST A (NOLOCK) 
				INNER JOIN salesinvoiceproducttax B (NOLOCK) ON A.Salid=B.SalId and A.SalRowId=B.PrdSlNo				
				INNER JOIN SalesInvoice S (NOLOCK) ON S.Salid=A.Salid and S.Salid=B.Salid
				WHERE Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				and VatGst='GST' and TaxPerc <> 0
			
				IF EXISTS(SELECT 'X' FROM #SalesReturnTax)
				BEGIN
				
					DELETE A FROM BilledPrdDtCalculatedTax A WHERE NOT EXISTS(SELECT PrdId,PrdBatId,TaxId FROM 
					#SalesReturnTax B WHERE A.PrdId=B.Prdid and A.PrdbatId=B.PrdbatId and A.TaxId=B.TaxId and A.RowId=B.RowId)
					and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
				
					SELECT @MaxSlno=MAX(Slno) FROM #SalesReturnTax
					
					WHILE @MinSlno<=@MaxSlno
					BEGIN
						SELECT @RtnPrdid=Prdid,@RtnPrdbatId=PrdbatId ,@RtnTaxId=Taxid,@RtnTaxPerc=TaxPerc FROM #SalesReturnTax
						WHERE Slno=@MinSlno
						
						IF EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
						BEGIN
						
								IF NOT EXISTS(SELECT 'x' FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
										and TaxId=@RtnTaxId and Cast(TaxPercentage as Numeric(18,6))=@RtnTaxPerc
										and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
										and  TaxableAmount>0)
										BEGIN																																	
											UPDATE A SET A.TaxPercentage=@RtnTaxPerc,
											A.TaxAmount=cast(A.TaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6))
											FROM BilledPrdDtCalculatedTax A  
											WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
											and TaxId=@RtnTaxId	and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
											and  TaxableAmount>0							
										END
						END	
						ELSE
						BEGIN
						
								SELECT @RtnTaxableAmount=TaxableAmount 
								FROM BilledPrdDtCalculatedTax (NOLOCK) WHERE PrdId=@RtnPrdid and PrdBatId=@RtnPrdbatId
								and Usrid=@Pi_UserId and TransId=@Pi_CalledFrom and RowId=@Pi_RowId
								and  TaxableAmount>0
						
								INSERT INTO BilledPrdDtCalculatedTax (RowId,PrdId,PrdBatId,TaxId,TaxSlabId,TaxPercentage,      
								TaxableAmount,TaxAmount,Usrid,TransId)      
								SELECT @Pi_RowId,B.PrdId,B.PrdBatId,@RtnTaxId,@RtnTaxId,@RtnTaxPerc,      
								@RtnTaxableAmount, cast(@RtnTaxableAmount * (@RtnTaxPerc / 100 ) AS NUMERIC(38,6)),      
								@Pi_UserId,@Pi_CalledFrom FROM BilledPrdHdForTax B (NOLOCK) WHERE       
								B.RowId = @Pi_RowId AND B.UsrId = @Pi_UserId AND B.TransId = @Pi_CalledFrom 					  
							
						END			
						
						SET @MinSlno=@MinSlno+1
					END							
				END
		END
	END	
END
	-----Till here
		----Gopi at 02-06-2017 for GST
	UPDATE BilledPrdDtCalculatedTax SET TaxId=0 where TaxId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxSlabId=0 where TaxSlabId Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxableAmount=0 where TaxableAmount Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxPercentage=0 where TaxPercentage Is null
	UPDATE BilledPrdDtCalculatedTax SET TaxAmount=0 where TaxAmount Is null
	 ---Till Here ----        
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_ReturnSplDiscountClaim' AND TYPE='P')
DROP PROCEDURE Proc_ReturnSplDiscountClaim
GO
/*  
 EXEC Proc_ReturnSplDiscountClaim 0,'2017-02-03','2017-06-05',1,1  
 SELECT * FROM ReturnSplDiscountClaimAmt  
*/  
CREATE PROCEDURE Proc_ReturnSplDiscountClaim
(  
@Pi_ClmId INT,  
@Pi_FrmDate DateTime,  
@Pi_ToDate DateTime,  
@Pi_CmpId INT,  
@Pi_UsrID INT  
)  
AS  
BEGIN  
/*********************************  
* FUNCTION: Proc_ReturnSplDiscountClaim  
* PURPOSE: Returns the Special Discount Claim  
* NOTES:   
* CREATED: Thrinath Kola 12-12-2007  
* MODIFIED  
* DATE      AUTHOR     DESCRIPTION  
------------------------------------------------  
*********************************/  
 CREATE TABLE #SalesTax  
 (  
  Salid NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
   
 CREATE TABLE #ReturnSalesTax  
 (  
  ReturnId NUMERIC(36,0),  
  PrdSlno INT,  
  TaxPerc NUMERIC(36,4),  
  TaxValue NumeriC(32,4),  
  TaxableAmount NUMERIC(36,4)  
 )  
  
 DELETE A FROM ReturnSplDiscountClaimAmt A (NOLOCK) WHERE UsrId=@Pi_UsrID  
  
  
   
 INSERT INTO #SalesTax(Salid,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.Salid,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END ,TaxableAmount   
 FROM SalesInvoiceProductTax  S  (NOLOCK) INNER JOIN SalesInvoice SI (NOLOCK) ON S.SalId=SI.Salid  
 WHERE  TaxableAmount>0 and DlvSts in (4,5)  
 AND SI.SalInvDate  Between @Pi_FrmDate and @Pi_ToDate 
 --and SI.SalInvDate Between '2017-02-03' AND '2017-06-03'   
 GROUP BY S.Salid,PrdSlno,TaxableAmount,VatGst ORDER BY Prdslno  
   
 SELECT Salid,PrdSlno Into #TaxCess   
 FROM #SalesTax   
 GROUP BY Salid,PrdSlno  
 HAVING Count(PrdSlno)>1  
  
 SELECT TT.Salid,TT.PrdSlno, TaxPerc,TaxableAmount INTO #TaxCess1   
 FROM #SalesTax TT  
 INNER JOIN #TaxCess T ON T.SalId= TT.Salid and T.PrdSlNo=TT.PrdSlno  
   
 DELETE A FROM #SalesTax  A INNER JOIN #TaxCess B ON A.Salid=B.Salid and A.PrdSlno=B.PrdSlno  
   
   
 INSERT INTO #ReturnSalesTax(ReturnId,PrdSlno,TaxPerc,TaxValue,TaxableAmount)  
 SELECT S.ReturnId,PrdSlno,SUM(TaxPerc) as TaxPerc,CASE VatGst WHEN 'VAT' THEN 0 ELSE SUM(TaxPerc)/100 END,TaxableAmt   
 FROM ReturnProductTax S (NOLOCK) INNER JOIN ReturnHeader SI (NOLOCK) ON S.ReturnId=SI.ReturnId  
 WHERE  TaxableAmt>0 and SI.Status=0  
 AND SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate 
 GROUP BY S.ReturnId,PrdSlno,TaxableAmt,VatGst ORDER BY PrdSlno  
   
 SELECT ReturnId,PrdSlno Into #ReturnTaxCess FROM #ReturnSalesTax   
 GROUP BY ReturnId,PrdSlno  
 HAVING Count(PrdSlno)>1  
   
 SELECT TT.ReturnId,TT.PrdSlno, TaxPerc,TaxableAmount INTO #ReturnTaxCess1   
 FROM #ReturnSalesTax TT  
 INNER JOIN #ReturnTaxCess T ON T.ReturnId= TT.ReturnId and T.PrdSlNo=TT.PrdSlno  
   
 DELETE A FROM #ReturnSalesTax  A INNER JOIN #ReturnTaxCess B ON A.ReturnId=B.ReturnId and A.PrdSlno=B.PrdSlno  
   
  
  INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
  SELECT A.SalId,A.SalInvno,0 as Status,R.RtrName,  
  SUM(PrdSplDiscAmount) as SpentAmt,  
  ISNULL(SUM(PrdSplDiscAmount*TaxValue),0),   
  ISNULL(SUM(PrdSplDiscAmount)+SUM(PrdSplDiscAmount*TaxValue),0),  
  ISNULL(TaxPerc,0),0 as RecAmt,1,@Pi_UsrID  
  FROM SalesInvoice A (NOLOCK) INNER JOIN SalesInvoiceProduct B  (NOLOCK) 
  ON A.SalId = B.SalId INNER JOIN Retailer R ON A.RtrId = R.RtrId   
  INNER JOIN Product P(NOLOCK) ON B.PrdId = P.PrdId  
  LEFT OUTER JOIN #SalesTax PT ON PT.SalId=B.SalId and PT.SalId=A.SalId and PT.PrdSlNo=B.SlNo    
  where B.SPLDiscClaimId IN (0,0) AND P.CmpId = 1 AND   
  A.SalInvDate Between @Pi_FrmDate and @Pi_ToDate    
  --A.SalInvDate Between '2017-02-03' AND '2017-06-03'  
  AND A.Dlvsts in (4,5)  
  GROUP BY A.SalId,A.SalInvno,R.RtrName,TaxPerc  
  Having SUM(PrdSplDiscAmount) > 0  


  SELECT B.* INTO #ProductBatchDetails FROM  ProductBatch A (NOLOCK)    
  INNER JOIN ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
  INNER JOIN BatchCreation C (NOLOCK) ON  
  C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1   
  
	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT SI.SalId,SI.SalInvNo,0 as Status,RT.RtrName,  
	SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) as SpentAmt,  
	ISNULL(SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*TaxValue),0),  
	ISNULL(SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))+SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*TaxValue),0),  
	ISNULL(TaxPerc,0),  
	0.00 as RecAmt,1,@Pi_UsrID  
	from SalesInvoice SI INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN SalesInvoiceProduct SP ON SI.SalID = SP.SalID  
	LEFT OUTER JOIN #SalesTax PT ON PT.SalId=SI.SalId and PT.SalId=SP.SalId and PT.PrdSlNo=SP.SlNo   
	INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	INNER JOIN BatchCreation C (NOLOCK) ON  
	C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	AND B.PriceId=SP.SplPriceId    
	INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	AND D.PriceId=SP.PriceId 
	INNER JOIN BatchCreation E (NOLOCK) ON
	E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	--INNER JOIN Contractpricingmaster CM on CM.ContractId=Sp.splpriceid     
	WHERE   
	SI.SalInvDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.dlvsts in (4,5) AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	AND PR.CmpId= @Pi_CmpId		
	GROUP BY SI.SalId,SI.SalInvNo,RT.RtrName,TaxPerc  
	Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0  



	---Sales Return  

	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,TaxPercent,RecAmt,Type,UsrId)  
	SELECT A.ReturnId,A.ReturnCode,0 as Status,R.RtrName,-1 * SUM(PrdSplDisAmt) as SpentAmt,  
	-1 * ISNULL(SUM(PrdSplDisAmt*TaxValue),0),  ISNULL(-1*(SUM(PrdSplDisAmt)+SUM(PrdSplDisAmt*TaxValue)),0),ISNULL(TaxPerc,0),  
	0 as RecAmt,2,@Pi_UsrID  
	FROM ReturnHeader A   
	INNER JOIN ReturnProduct B  ON A.ReturnId = B.ReturnId   
	LEFT OUTER JOIN #ReturnSalesTax RS ON  A.ReturnId =RS.ReturnId and RS.ReturnId= B.ReturnId  and RS.PrdSlno=B.Slno  
	INNER JOIN Retailer R ON A.RtrId = R.RtrId    
	INNER JOIN Product P ON B.PrdId = P.PrdId   
	where B.SPLDiscClaimId IN (0,@Pi_ClmId) AND P.CmpId = @Pi_CmpId AND   
	A.ReturnDate Between @Pi_FrmDate AND @Pi_ToDate AND A.Status = 0  
	GROUP BY A.ReturnId,A.ReturnCode,R.RtrName,TaxPerc  
	Having SUM(PrdSplDisAmt) > 0  

	INSERT INTO ReturnSplDiscountClaimAmt (SalID,SalInvNo,Status,RtrName,SpentAmt,SpentTaxAmt,TotalSpentAmt,RecAmt,Type,UsrId)  
	SELECT SI.ReturnId,SI.ReturnCode,0 as Status,RT.RtrName,  
	-1 * SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) as SpentAmt,  
	ISNULL(-1 * SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*Taxvalue) ,0)  
	-1*(ISNULL(SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)),0) +ISNULL(SUM((Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue))*Taxvalue) ,0)),  
	ISNULL(TaxPerc,0),0.00 as RecAmt,2,@Pi_UsrID  
	from ReturnHeader SI   
	INNER JOIN Retailer RT ON SI.RtrId=RT.RtrId   
	INNER JOIN ReturnProduct SP ON SI.ReturnId = SP.ReturnId  
	LEFT OUTER JOIN #ReturnSalesTax RS ON  SI.ReturnId =RS.ReturnId and RS.ReturnId= SP.ReturnId  and RS.PrdSlno=SP.Slno  
	INNER JOIN Product PR WITH (NOLOCK) ON SP.PrdId = PR.PrdId   
	INNER JOIN ProductBatch A (NOLOCK) ON A.PrdId = PR.PrdId AND A.PrdBatId = SP.PrdBatID  
	INNER JOIN #ProductBatchDetails B (NOLOCK) ON A.PrdBatId = B.PrdBatID  
	INNER JOIN BatchCreation C (NOLOCK) ON  
	C.BatchSeqId = A.BatchSeqId And B.SlNo = C.SlNo And C.SelRte = 1  
	AND B.PriceId=SP.SplPriceId
	INNER JOIN #ProductBatchDetails D (NOLOCK) ON A.PrdBatId = D.PrdBatID
	AND D.PriceId=SP.PriceId 
	INNER JOIN BatchCreation E (NOLOCK) ON
	E.BatchSeqId = A.BatchSeqId And D.SlNo = E.SlNo And E.SelRte = 1 AND
	A.PrdId=SP.PrdId AND A.PrdBatId= SP.PrdBatId
	where SI.ReturnDate Between @Pi_FrmDate and @Pi_ToDate
	AND SI.Status = 0 AND SP.SplDiscClaimId IN (0,@Pi_ClmId)
	AND PR.CmpId= @Pi_CmpId 
	GROUP BY SI.ReturnId,SI.ReturnCode,RT.RtrName,RS.TaxPerc
	Having SUM(Sp.BaseQty * (B.PrdBatDetailValue-D.PrdBatDetailValue)) > 0
  
RETURN  
END
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='Proc_RptClosingStockReportParle' AND TYPE='P')
DROP PROCEDURE Proc_RptClosingStockReportParle
GO
--EXEC Proc_RptClosingStockReportParle 254,1,0,'',0,0,1      
CREATE PROCEDURE Proc_RptClosingStockReportParle   
(      
 @Pi_RptId  INT,      
 @Pi_UsrId  INT,      
 @Pi_SnapId  INT,      
 @Pi_DbName  nvarchar(50),      
 @Pi_SnapRequired INT,      
 @Pi_GetFromSnap  INT,      
 @Pi_CurrencyId  INT      
)      
AS      
/************************************************************      
* VIEW : Proc_RptClosingStockReport      
* PURPOSE : To get the Closing Stock Details      
* CREATED BY : Mahalakshmi.A      
* CREATED DATE : 17/09/2008      
* NOTE  :      
* MODIFIED      
* DATE      AUTHOR     DESCRIPTION      
------------------------------------------------      
* {date} {developer}  {brief modification description}      
*************************************************************/      
BEGIN      
SET NOCOUNT ON      
 DECLARE @NewSnapId  AS INT      
 DECLARE @DBNAME  AS  nvarchar(50)      
 DECLARE @TblName  AS nvarchar(500)      
 DECLARE @TblStruct  AS nVarchar(4000)      
 DECLARE @TblFields  AS nVarchar(4000)      
 DECLARE @sSql  AS  nVarChar(4000)      
 DECLARE @ErrNo   AS INT      
 DECLARE @PurDBName AS nVarChar(50)      
 --Filter Variables      
 DECLARE @FromDate AS DATETIME      
 DECLARE @ToDate   AS DATETIME      
 DECLARE @CmpId   AS INT      
 DECLARE @LcnId   AS INT      
 DECLARE @PrdCatId AS INT      
 DECLARE @PrdId  AS INT      
 DECLARE @DispValue AS INT      
 DECLARE @PrdStatus AS INT      
 DECLARE @BatchStatus AS INT      
 DECLARE @SupZeroStock   AS INT      
 DECLARE @PrdUnit AS INT      
 ----Till Here      
 --Assgin Value for the Filter Variable      
-- SELECT @FromDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,10,@Pi_UsrId)      
 SELECT @ToDate = dSelected FROM Fn_ReturnRptFilterDate(@Pi_RptId,11,@Pi_UsrId)      
 SET @CmpId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId))      
 SET @LcnId = (SELECT  TOP 1 iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId))      
 SET @DispValue = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,209,@Pi_UsrId))      
 SET @PrdStatus = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,210,@Pi_UsrId))      
 SET @BatchStatus = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,211,@Pi_UsrId))      
 SELECT @PurDBName = dbo.Fn_ReturnPurgeDBName(@FromDate,@ToDate)       
 EXEC Proc_ReturnRptProduct @Pi_RptId,@Pi_UsrId      
 SET @PrdCatId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId))      
 SET @PrdId = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId))      
 SET @SupZeroStock = (SElect  TOP 1 iCountid FRom Fn_ReturnRptFilters(@Pi_RptId,44,@Pi_UsrId))      
 --Product UOM Details      
    SELECT DISTINCT Prdid,U.ConversionFactor       
 Into #PrdUomBox      
 FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid      
 Inner Join UomMaster UM On U.UomId=Um.UomId      
 --Where Um.UomCode ='BX' --Commented and added by Rajesh ICRSTPAR3196      
 Where Um.UomCode IN('BX','BOX')      
 SELECT DISTINCT Prdid,U.ConversionFactor      
 Into #PrdUomPack      
 FROM Product P INNER JOIN UOMGROUP U ON P.UomgroupId =U.Uomgroupid      
 Inner Join UomMaster UM On U.UomId=Um.UomId      
 Where  P.PrdId Not In (Select PrdId From #PrdUomBox) And U.BaseUom='Y'      
 Create Table #PrdUomAll      
 (      
  PrdId Int,      
  ConversionFactor Int      
 )      
 Insert Into #PrdUomAll      
 Select Distinct PrdId,ConversionFactor From #PrdUomBox      
 Union All      
 Select Distinct PrdId,ConversionFactor From #PrdUomPack      
 SELECT Prdid,      
   Case PrdUnitId       
   When 2 Then (PrdWgt/1000)/1000      
   When 3 Then PrdWgt/1000 END AS PrdWgt      
   Into #PrdWeight  From Product      
 --Till Here         
 CREATE TABLE #RptClosingStock      
 (      
    PrdId  INT,      
    PrdDCode     NVARCHAR(200), 
    PrdName  NVARCHAR(200),      
    MRP      NUMERIC(38,6),      
    RATE        NUMERIC(38,6),      
    Qty      INT,      
    TaxPerc     NUMERIC(18,2),      
    StockValue NUMERIC(38,6),      
    TaxAmount   NUMERIC(38,6),      
    NetAmount   NUMERIC(38,6)          
 )      
 SET @TblName = 'RptClosingStock'      
 SET @TblStruct = 'PrdId  INT,      
      PrdDCode     NVARCHAR(200),      
    PrdName  NVARCHAR(100),      
    MRP      NUMERIC(38,6),      
    RATE        NUMERIC(38,6),      
    Qty      INT,      
    TaxPerc     NUMERIC(38,6),      
    StockValue NUMERIC(38,6),      
    TaxAmount   NUMERIC(38,6),      
    NetAmount   NUMERIC(38,6)'      
 SET @TblFields = 'PrdId,PrdDCode,PrdName,MRP,RATE,Qty,TaxPerc,StockValue,TaxAmount,NetAmount'      
 IF @Pi_GetFromSnap = 1      
 BEGIN      
  Select @DBNAME = DBName  FROM SnapShotHd WHERE SnapId = @Pi_SnapId      
  SET @DBNAME = @DBNAME      
 END      
 ELSE      
 BEGIN      
  Select @DBNAME = CounterDesc  FROM CounterConfiguration WHERE SlNo =3      
  SET @DBNAME = @PI_DBNAME + @DBNAME      
 END
  EXEC Proc_ClosingStock @Pi_RptID,@Pi_UsrId,@ToDate  
 --Added By Sathishkumar Veeramani 2014/11/17 Tax Settings Details        
  ---------------------> Added by Lakshman M on 07/08/2017 <------------------
 IF EXISTS(SELECT * FROM GSTConfiguration WHERE CONVERT(VARCHAR(10),DownloadAcknowdate,121)<=CONVERT(VARCHAR(10),@ToDate,121))      
	 BEGIN      
		EXEC Proc_ClosingStockTaxCalCulation      
	 END      
 ELSE      
	 BEGIN      
	 EXEC Proc_ClosingStockTaxCalCulation_BeforeGST      
	 END      
    ------------------------> Till Here 07/08/2017 <------------------
 --Till Here      
 IF @Pi_GetFromSnap = 0  --To Generate For New Report Data      
 BEGIN      
  INSERT INTO #RptClosingStock (PrdId,PrdDCode,PrdName,MRP,RATE,Qty,TaxPerc,StockValue,TaxAmount,NetAmount)      
  SELECT DISTINCT T.PrdId,P.PrdDCode,T.PrdName,MRP,CASE @DispValue WHEN 1 THEN T.Sellingrate ELSE ListPrice END,      
  SUM(BaseQty),TaxPercentage,SUM((CASE @DispValue WHEN 1 THEN (BaseQty * SellingRate) ELSE (BaseQty*ListPrice) END)) As StockValue,      
  SUM((CASE @DispValue WHEN 1 THEN ((BaseQty * SellingRate)*(TaxPercentage/100)) ELSE ((BaseQty*ListPrice)*(TaxPercentage/100)) END)) AS TaxAmount,      
  SUM((CASE @DispValue WHEN 1 THEN (BaseQty * SellingRate) + ((BaseQty * SellingRate)*(TaxPercentage/100))       
  ELSE (BaseQty*ListPrice)+((BaseQty*ListPrice)*(TaxPercentage/100)) END)) As NetAmount      
  FROM TempClosingStock T WITH (NOLOCK) INNER JOIN Product P WITH (NOLOCK) ON T.PrdId = P.PrdId      
  INNER JOIN ClosingStockProductTaxPercent TS WITH (NOLOCK) ON T.PrdId = TS.PrdId         
  WHERE (T.CmpId = (CASE @CmpId WHEN 0 THEN T.CmpId ELSE 0 END) OR      
  T.CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,4,@Pi_UsrId)))          
  AND (T.LcnId = (CASE @LcnId WHEN 0 THEN T.LcnId ELSE 0 END) OR      
   T.LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,22,@Pi_UsrId)))      
  AND  (T.PrdStatus = (CASE @PrdStatus WHEN 0 THEN T.PrdStatus ELSE -1 END) OR      
   T.PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(@Pi_RptId,210,@Pi_UsrId)))      
  AND  (T.BatStatus = (CASE @BatchStatus WHEN 0 THEN T.BatStatus ELSE -1 END) OR      
   T.BatStatus in (SELECT iCountid-1 FROM Fn_ReturnRptFilters(@Pi_RptId,211,@Pi_UsrId)))      
  AND  (T.PrdId = (CASE @PrdCatId WHEN 0 THEN T.PrdId Else 0 END) OR      
   T.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,26,@Pi_UsrId)))      
  AND  (T.PrdId = (CASE @PrdId WHEN 0 THEN T.PrdId Else 0 END) OR      
   T.PrdId in (SELECT iCountid from Fn_ReturnRptFilters(@Pi_RptId,5,@Pi_UsrId)))      
  AND T.UsrId=@Pi_UsrId       --Added By Mohana
  GROUP BY T.PrdId,T.PrdName,MRP,SellingRate,ListPrice,P.PrdDCode,TaxPercentage ORDER BY P.PrdDCode      
    IF LEN(@PurDBName) > 0      
  BEGIN      
   EXEC Proc_PurgedDB @PurDBName,@TblName,@Po_PurgeErrno = @ErrNo OUTPUT      
   SET @SSQL = 'INSERT INTO #RptClosingStock ' +      
    '(' + @TblFields + ')' +      
    ' SELECT ' + @TblFields + ' FROM ['  + @PurDBName + '].dbo.' + @TblName      
    + 'WHERE (CmpId = (CASE ' + CAST(@CmpId AS nVarchar(10)) + ' WHEN 0 THEN CmpId ELSE 0 END) OR '      
    + 'CmpId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',4,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '      
    + 'AND (LcnId = (CASE ' + CAST(@LcnId AS nVarchar(10)) + ' WHEN 0 THEN LcnId ELSE 0 END) OR '      
    + 'LcnId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',22,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'      
    + 'AND (PrdId = (CASE ' + CAST(@PrdCatId AS nVarchar(10)) + ' WHEN 0 THEN PrdId ELSE 0 END) OR '      
    + 'PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters(' +      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',26,' + CAST(@Pi_UsrId AS nVarchar(10)) + '))) '      
    + 'AND(PrdId=(CASE @PrdId WHEN 0 THEN PrdId ELSE 0 END) OR'      
    + 'PrdId in (SELECT iCountid FROM Fn_ReturnRptFilters('+      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',5,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'      
    + 'AND (PrdStatus = (CASE ' + CAST(@PrdStatus AS nVarchar(10)) + ' WHEN 0 THEN PrdStatus ELSE -1 END) OR '      
    + 'PrdStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(' +      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',210,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'      
    + 'AND (BatStatus = (CASE ' + CAST(@BatchStatus AS nVarchar(10)) + ' WHEN 0 THEN BatStatus ELSE -1 END) OR '      
    + 'BatStatus in (SELECT iCountid FROM Fn_ReturnRptFilters(' +      
    + CAST(@Pi_RptId AS nVarchar(10)) + ',211,' + CAST(@Pi_UsrId AS nVarchar(10)) + ')))'      
    --+ 'AND TransDate BETWEEN ''' + @FromDate + ''' AND ''' + @ToDate + ''''      
   EXEC (@SSQL)      
   PRINT 'Retrived Data From Purged Table'      
  END      
  IF @Pi_SnapRequired = 1      
  BEGIN      
   SELECT @NewSnapId = @Pi_SnapId      
   EXEC Proc_SnapShot_Report @NewSnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
   @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
   IF @ErrNo = 0      
   BEGIN      
    SET @sSql = 'INSERT INTO [' + @DBNAME + '].dbo.' + @TblName +      
     '(SnapId,UserId,RptId,' + @TblFields + ')' +      
     ' SELECT ' + CAST(@NewSnapId AS VARCHAR(10)) +      
     ' ,' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
     ' ,' + CAST(@Pi_RptId AS VARCHAR(10)) + ', * FROM #RptClosingStock'      
    EXEC (@SSQL)      
    PRINT 'Saved Data Into SnapShot Table'      
   END      
  END      
 END      
 ELSE    --To Retrieve Data From Snap Data      
 BEGIN      
  EXEC Proc_SnapShot_Report @Pi_SnapId,@Pi_UsrId,@Pi_RptId,@Pi_DbName,@TblName,@TblStruct,      
    @Pi_GetFromSnap,@Po_SnapErrno = @ErrNo OUTPUT      
  PRINT @ErrNo      
  IF @ErrNo = 0      
  BEGIN      
   SET @SSQL = 'INSERT INTO #RptClosingStock ' +      
    '(' + @TblFields + ')' +      
    ' SELECT ' + @TblFields + ' FROM ['  + @DBNAME + '].dbo.' + @TblName +      
    ' WHERE SNAPID = ' + CAST(@Pi_SnapId AS VARCHAR(10)) +      
    ' AND UserId = ' + CAST(@Pi_UsrId AS VARCHAR(10)) +      
    ' AND RptId = ' + CAST(@Pi_RptId AS VARCHAR(10))      
   EXEC (@SSQL)      
   PRINT 'Retrived Data From Snap Shot Table'      
  END      
  ELSE      
  BEGIN      
   PRINT 'DataBase or Table not Found'      
  END      
 END      
 IF @SupZeroStock=1       
 BEGIN      
  --Check for Report Data      
  Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId      
  INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
  SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptClosingStock WHERE Qty <> 0      
  -- Till Here      
  SELECT A.PrdId,PrdDCode,PrdName,MRP,MAX(RATE) AS RATE,      
  CASE WHEN SUM(Qty)<MAX(ConversionFactor) Then 0 Else SUM(Qty)/MAX(ConversionFactor) End  As BOXES,      
  CASE WHEN SUM(Qty)<MAX(ConversionFactor) Then SUM(Qty) Else SUM(Qty)%MAX(ConversionFactor) End  As PKTS,      
  TaxPerc,SUM(StockValue) AS StockValue,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NetAmount       
  FROM #RptClosingStock A,#PrdUomAll B WHERE A.PrdId = B.PrdId       
     GROUP BY A.PrdId,PrdName,MRP,PrdDCode,TaxPerc Having SUM(Qty) <> 0 Order By PrdDCode      
     IF EXISTS (SELECT * FROM Sysobjects Where XTYPE = 'U' And name = 'RptClosingStockReportParle_Excel')      
  DROP TABLE RptClosingStockReportParle_Excel      
  SELECT A.PrdId,PrdDCode,PrdName,MRP,MAX(RATE) AS RATE,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then 0 Else SUM(Qty)/MAX(ConversionFactor) End  As BOXES,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then SUM(Qty) Else SUM(Qty)%MAX(ConversionFactor) End  As PKTS,      
  TaxPerc,SUM(StockValue) AS StockValue,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NetAmount      
     INTO RptClosingStockReportParle_Excel FROM #RptClosingStock A,#PrdUomAll B WHERE A.PrdId = B.PrdId       
     Group By A.PrdId,PrdName,MRP,PrdDCode,TaxPerc Having SUM(Qty) <> 0 Order By PrdDCode      
 END      
 ELSE      
 BEGIN      
  --Check for Report Data      
  Delete From RptDataCount Where RptId = @Pi_RptId AND UserId = @Pi_UsrId      
  INSERT INTO RptDataCount (RptId,RecCount,ErrNo,UserId)      
  SELECT @Pi_RptId,Count(*) as RecCount,@ErrNo,@Pi_UsrId FROM #RptClosingStock      
  -- Till Here      
  SELECT A.PrdId,PrdDCode,PrdName,MRP,MAX(RATE) AS RATE,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then 0 Else SUM(Qty)/MAX(ConversionFactor) End  As BOXES,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then SUM(Qty) Else SUM(Qty)%MAX(ConversionFactor) End  As PKTS,      
  TaxPerc,SUM(StockValue) AS StockValue,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NetAmount      
  FROM #RptClosingStock A,#PrdUomAll B WHERE A.PrdId = B.PrdId       
     GROUP BY A.PrdId,PrdName,MRP,PrdDCode,TaxPerc ORDER BY PrdDCode      
     IF EXISTS (SELECT * FROM Sysobjects Where XTYPE = 'U' And name = 'RptClosingStockReportParle_Excel')      
  DROP TABLE RptClosingStockReportParle_Excel      
  SELECT A.PrdId,PrdDCode,PrdName,MRP,MAX(RATE) AS RATE,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then 0 Else SUM(Qty)/MAX(ConversionFactor) End  As BOXES,      
  Case When SUM(Qty)<MAX(ConversionFactor) Then SUM(Qty) Else SUM(Qty)%MAX(ConversionFactor) End  As PKTS,      
  TaxPerc,SUM(StockValue) AS StockValue,SUM(TaxAmount) AS TaxAmount,SUM(NetAmount) AS NetAmount      
     INTO RptClosingStockReportParle_Excel FROM #RptClosingStock A,#PrdUomAll B WHERE A.PrdId = B.PrdId       
     GROUP BY A.PrdId,PrdName,MRP,PrdDCode,TaxPerc Order By PrdDCode      
 END      
 RETURN      
END 
GO
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Proc_Cn2Cs_BLSchemeMaster]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[Proc_Cn2Cs_BLSchemeMaster]
GO
/*
BEGIN TRANSACTION
update schememaster set schstatus = 0 where cmpschcode = 'SCH00007'
EXEC Proc_Cn2Cs_BLSchemeMaster 0
select *from schememaster where cmpschcode = 'SCH00007'
ROLLBACK TRANSACTION
*/
CREATE PROCEDURE [dbo].[Proc_Cn2Cs_BLSchemeMaster]
(
	@Po_ErrNo INT OUTPUT
)
AS
/**************************************************************************************************
* PROCEDURE	: Proc_Cn2Cs_BLSchemeMaster
* PURPOSE	: To Insert and Update records Of Scheme Master
* CREATED	: Boopathy.P on 31/12/2008
* DATE         AUTHOR       DESCRIPTION
****************************************************************************************************
* 25.08.2009   Panneer		Added BudgetAllocationNo in SchemeMaster Table
* 20.10.2009   Thiru		Added SchBasedOn in SchemeMaster Table		
* 22/04/2010   Nanda 		Added FBM
* 28/12/2010   Nanda 		Added Settlement Type
------------------------------------------------  
* {date} {developer}  {brief modification description}  
*************************************************  
* [DATE]      [DEVELOPER]      [USER_STORY_ID]   [CR/BUG]  [DESCRIPTION]  
* 03
03-01-2018  Lakshman. M      ICRSTPAR7277        BUG      Scheme description amp;  (special character)Script validation added from CS.  
**************************************************************************************************/
SET NOCOUNT ON
BEGIN
	DECLARE @SchCode 		AS NVARCHAR(100)
	DECLARE @SchDesc 		AS NVARCHAR(200)
	DECLARE @CmpCode 		AS NVARCHAR(50)
	DECLARE @ClmAble 		AS NVARCHAR(50)
	DECLARE @ClmAmtOn 		AS NVARCHAR(50)
	DECLARE @ClmGrpCode		AS NVARCHAR(50)
	DECLARE @SelnOn			AS NVARCHAR(50)
	DECLARE @SelLvl			AS NVARCHAR(50)
	DECLARE @SchType		AS NVARCHAR(50)
	DECLARE @BatLvl			AS NVARCHAR(50)
	DECLARE @FlxSch			AS NVARCHAR(50)
	DECLARE @FlxCond		AS NVARCHAR(50)
	DECLARE @CombiSch		AS NVARCHAR(50)
	DECLARE @Range			AS NVARCHAR(50)
	DECLARE @ProRata		AS NVARCHAR(50)
	DECLARE @Qps			AS NVARCHAR(50)
	DECLARE @QpsReset		AS NVARCHAR(50)
	DECLARE @ApyQpsOn		AS NVARCHAR(50)
	DECLARE @ForEvery		AS NVARCHAR(50)
	DECLARE @SchStartDate	AS NVARCHAR(50)
	DECLARE @SchEndDate		AS NVARCHAR(50)
	DECLARE @SchBudget		AS NVARCHAR(50)
	DECLARE @EditSch		AS NVARCHAR(50)
	DECLARE @AdjDisSch		AS NVARCHAR(50)
	DECLARE @SetDisMode		AS NVARCHAR(50)
	DECLARE @SchStatus		AS NVARCHAR(50)
	DECLARE @SchBasedOn		AS NVARCHAR(50)
	DECLARE @StatusId		AS INT
	DECLARE @CmpId			AS INT
	DECLARE @ClmGrpId		AS INT
	DECLARE @CmpPrdCtgId	AS INT
	DECLARE @ClmableId		AS INT
	DECLARE @ClmAmtOnId		AS INT
	DECLARE @SelMode		AS INT
	DECLARE @SchTypeId		AS INT
	DECLARE @BatId			AS INT
	DECLARE @FlexiId		AS INT
	DECLARE @FlexiConId		AS INT
	DECLARE @CombiId		AS INT
	DECLARE @RangeId		AS INT
	DECLARE @ProRateId		AS INT
	DECLARE @QPSId			AS INT
	DECLARE @QPSResetId		AS INT
	DECLARE @AdjustSchId	AS INT
	DECLARE @ApplySchId		AS INT
	DECLARE @ForEveryId		AS INT
	DECLARE @SettleSchId	AS INT
	DECLARE @EditSchId		AS INT
	DECLARE @ChkCount		AS INT		
	DECLARE @ConFig			AS INT
	DECLARE @CmpCnt			AS INT
	DECLARE @EtlCnt			AS INT
	DECLARE @SLevel			AS INT
	DECLARE @SchBasedOnId	AS INT
	DECLARE @ErrDesc		AS NVARCHAR(1000)
	DECLARE @TabName		AS NVARCHAR(50)
	DECLARE @GetKey			AS INT
	DECLARE @GetKeyStr		AS NVARCHAR(200)
	DECLARE @Taction		AS INT
	DECLARE @sSQL			AS VARCHAR(4000)
	DECLARE @iCnt			AS INT
	DECLARE @BudgetAllocationNo	AS NVARCHAR(100)
	DECLARE @FBM				AS NVARCHAR(10)
	DECLARE @FBMId				AS INT
	DECLARE @SettlementType		AS NVARCHAR(10)
	DECLARE @SettlementTypeId	AS INT
	DECLARE @FBMDate			AS DATETIME
	DECLARE @AllowUnCheck		AS NVARCHAR(10)
	DECLARE @AllowUnCheckId		AS INT
	DECLARE @CombiType			AS NVARCHAR(50)
	DECLARE @CombiTypeId		AS INT
	DECLARE @SchApplyOn			AS VARCHAR(100)
	DECLARE @SchApplyOnId		AS INT
	SET @TabName = 'Etl_Prk_SchemeHD_Slabs_Rules'
	SET @Po_ErrNo =0
	SET @AdjustSchId=0
	SET @iCnt=0
	SELECT @ConFig=ISNULL(Status,0) FROM Configuration WHERE
	ModuleId='GENCONFIG16' AND ModuleName='General Configuration'
	DECLARE @DistCode AS  NVARCHAR(50)
	SELECT @DistCode=ISNULL(DistributorCode,'') FROM Distributor
	---------------------------------- added by Lakshman M on 03/01/2018 PMS ID: ICRSTPAR7277-----------
	Declare @Lvar Int  
	Declare @MaxId Int
	Declare @SqlStr Varchar(8000)  
	Declare @Process Varchar(100)  
	Declare @colcount Int  
	Declare @Col Varchar(5000)

 	Create Table #SPLTBL (Id Int Identity(1,1),CId int,CName Varchar(200),CType Varchar(100))
	Insert into #SPLTBL
	Select A.column_id as CId,A.Name,C.name As CType From Sys.columns A (Nolock),Sys.objects B (Nolock),Sys.types C (Nolock) 
	where A.object_id = B.object_id and B.name = 'Etl_Prk_SchemeHD_Slabs_Rules'
	And A.system_type_id = C.system_type_id And C.name='nvarchar' and A.column_id= 3
	Order by A.column_id 
	Declare @CName Varchar(100)
	Set @Lvar = 1
	Set @CName = ''
	Select @MaxId = IsNull(Count(CId),0) From #SPLTBL
	While @Lvar <= @MaxId
	Begin
		Select @CName = CName From #SPLTBL Where Id = @Lvar
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' amp;'',''&'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' lt;'',''<'')'
		exec (@SqlStr)
		Set @SqlStr = ''
		Set @SqlStr = @SqlStr + ' Update Etl_Prk_SchemeHD_Slabs_Rules  Set '+ @CName + ' = REPLACE(' + @CName + ','' gt;'',''>'')'
		exec (@SqlStr)
		Set @Lvar = @Lvar + 1
	End
 ---------------------------------- Till here -------------------
	--->Added By Nanda on 17/09/2009
	IF EXISTS (SELECT * FROM DBO.SysObjects WHERE ID = OBJECT_ID(N'SchToAvoid')
	AND OBJECTPROPERTY(ID, N'IsUserTable') = 1)
	BEGIN
		DROP TABLE SchToAvoid	
	END
	CREATE TABLE SchToAvoid
	(
		CmpSchCode NVARCHAR(50)
	)
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
	WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product'))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','CmpSchCode','Product :'+PrdCode+' not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
		INSERT INTO ReDownloadRequest(DistCode,Process,RefNo,Download,PrdCCode,PrdBatCode,UploadFlag)		
		SELECT @DistCode,'Scheme',CmpSchCode,'Product',PrdCode,'','N'
		FROM Etl_Prk_SchemeProducts_Combi
		WHERE PrdCode NOT IN (SELECT PrdCCode FROM Product) AND 
		CmpSchCode IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules WHERE SchLevel='Product')
		AND PrdCode<>'ALL'
	END
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Attributes','Attributes not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes)
	END
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Products','Scheme Products not Available for Scheme:'+CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeProducts_Combi)
	END
	IF EXISTS(SELECT DISTINCT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules))
	BEGIN
		INSERT INTO SchToAvoid(CmpSchCode)
		SELECT CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
		INSERT INTO ErrorLog(SlNo,TableName,FieldName,ErrDesc)
		SELECT DISTINCT 1,'Scheme Master','Header','Header not Available for Scheme:'+CmpSchCode FROM Etl_Prk_Scheme_OnAttributes
		WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM Etl_Prk_SchemeHD_Slabs_Rules)
	END
	--->Till Here
	DECLARE Cur_SchMaster CURSOR
	FOR SELECT DISTINCT
	ISNULL([CmpSchCode],'') AS [Company Scheme Code],
	ISNULL([SchDsc],'') AS [Scheme Description],
	ISNULL([CmpCode],'') AS [Company Code],
	ISNULL([Claimable],'') AS [Claimable],
	ISNULL([ClmAmton],'') AS [Claim Amount On],
	ISNULL([ClmGroupCode],'') AS [Claim Group Code],
	ISNULL([SchemeLevelMode],'') AS [Selection On],
	ISNULL([SchLevel],'') AS [Selection Level Value],
	ISNULL([SchType],'') AS [Scheme Type],
	ISNULL([BatchLevel],'') AS [Batch Level],
	ISNULL([FlexiSch],'') AS [Flexi Scheme],
	ISNULL([FlexiSchType],'') AS [Flexi Conditional],
	ISNULL([CombiSch],'') AS [Combi Scheme],
	ISNULL([Range],'') AS [Range],
	ISNULL([ProRata],'') AS [Pro - Rata],
	ISNULL([Qps],'NO') AS [Qps],
	ISNULL([QPSReset],'') AS [Qps Reset],
	ISNULL([ApyQPSSch],'') AS [Qps Based On],
	ISNULL([PurofEvery],'') AS [Allow For Every],
	ISNULL([SchValidFrom],'') AS [Scheme Start Date],
	ISNULL([SchValidTill],'') AS [Scheme End Date],
	ISNULL([Budget],'') AS [Scheme Budget],
	ISNULL([EditScheme],'') AS [Allow Editing Scheme],
	ISNULL([AdjWinDispOnlyOnce],'0') AS [Adjust Display Once],
	ISNULL([SetWindowDisp],'') AS [Settle Display Through],
	ISNULL(SchStatus,'') AS SchStatus,
	--ISNULL(BudgetAllocationNo,'') AS BudgetAllocationNo,
	ISNULL(CircularNo,'') AS BudgetAllocationNo,
	ISNULL(SchBasedOn,'') AS SchemeBasedOn,
	ISNULL(FBM,'No') AS FBM,
	ISNULL(SettlementType,'ALL') AS SettlementType,
	ISNULL([AllowUncheck],'NO') AS AllowUncheck,
	ISNULL([CombiType],'NORMAL') AS [CombiType],
	ISNULL(SchApplyOn,'SELLINGRATE') AS SchApplyOn
	FROM Etl_Prk_SchemeHD_Slabs_Rules (NOLOCK)
	WHERE CmpSchCode NOT IN (SELECT CmpSchCode FROM SchToAvoid) AND DownLoadFlag='D'			 
	ORDER BY [Company Scheme Code]
	OPEN Cur_SchMaster
	FETCH NEXT FROM Cur_SchMaster INTO @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
	, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
	, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
	@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn	
	WHILE @@FETCH_STATUS=0
	BEGIN
		SET @CombiTypeId=0	
		SET @SchBasedOn='RETAILER'
		SET @Po_ErrNo =0		
		SET @Taction = 2
		SET @iCnt=@iCnt+1
		IF LTRIM(RTRIM(@SchCode))= ''
		BEGIN
			SET @ErrDesc = 'Company Scheme Code should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (1,@TabName,'Company Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchDesc))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Description should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (2,@TabName,'Scheme Description',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CmpCode))= ''
		BEGIN
			SET @ErrDesc = 'Company should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (3,@TabName,'Company',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAble))= ''
		BEGIN
			SET @ErrDesc = 'Claimable should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (4,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ClmAmtOn))= ''
		BEGIN
			SET @ErrDesc = 'Claim Amount On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (5,@TabName,'Claim Amount On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (6,@TabName,'Scheme Level Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelLvl))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (7,@TabName,'Scheme Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchType))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (8,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@BatLvl))= ''
		BEGIN
			SET @ErrDesc = 'Batch Level should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (9,@TabName,'Batch Level',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxSch))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (10,@TabName,'Flexi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@FlxCond))= ''
		BEGIN
			SET @ErrDesc = 'Flexi Scheme Type should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (11,@TabName,'Flexi Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiSch))= ''
		BEGIN
			SET @ErrDesc = 'Combi Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (12,@TabName,'Combi Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Range))= ''
		BEGIN
			SET @ErrDesc = 'Range should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (13,@TabName,'Range Based Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ProRata))= ''
		BEGIN
			SET @ErrDesc = 'Pro-Rata should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (14,@TabName,'Pro-Rata',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@Qps))= ''
		BEGIN
			SET @ErrDesc = 'QPS Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (15,@TabName,'QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@QpsReset))= ''
		BEGIN
			SET @ErrDesc = 'QPS Reset should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (16,@TabName,'QPS Reset',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@ApyQpsOn))= ''
		BEGIN
			SET @ErrDesc = 'Apply QPS Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (17,@TabName,'Apply QPS Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStartDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Start Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (19,@TabName,'Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchStartDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme Start Date is not Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (20,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchStartDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme Start Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (21,@TabName,'Scheme Start Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchEndDate))= ''
		BEGIN
			SET @ErrDesc = 'Scheme End Date should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (23,@TabName,'End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LEN(LTRIM(RTRIM(@SchEndDate)))<10
		BEGIN
			SET @ErrDesc = 'Scheme End Date is not in Date Format for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (24,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF ISDATE(LTRIM(RTRIM(@SchEndDate))) = 0
		BEGIN
			SET @ErrDesc = 'Invalid Scheme End Date for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (25,@TabName,'Scheme End Date',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@EditSch))= ''
		BEGIN
			SET @ErrDesc = 'Allow Editing Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (28,@TabName,'Editing Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SetDisMode))= ''
		BEGIN
			SET @ErrDesc = 'Settle Window Display Scheme should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (30,@TabName,'Settle Window Display Scheme',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SelnOn))= ''
		BEGIN
			SET @ErrDesc = 'Selection On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (31,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchStatus))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Status should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (32,@TabName,'Scheme Status',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchBasedOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Based On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@CombiType))= ''
		BEGIN
			SET @ErrDesc = 'CombiType should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (70,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF LTRIM(RTRIM(@SchApplyOn))= ''
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should not be blank for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END 
		IF ((UPPER(LTRIM(RTRIM(@CombiType)))<> 'NORMAL') AND (UPPER(LTRIM(RTRIM(@CombiType)))<> 'FLUCTUATING'))
		BEGIN
			SET @ErrDesc = 'CombiType should be (NORMAL OR FLUCTUATING) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'SELLINGRATE') AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'MRP') 
		AND (UPPER(LTRIM(RTRIM(@SchApplyOn)))<> 'PURCHASERATE'))
		BEGIN
			SET @ErrDesc = 'Scheme Apply On should be (SELLINGRATE OR MRP OR PURCHASERATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (72,@TabName,'CombiType',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'RETAILER') AND (UPPER(LTRIM(RTRIM(@SchBasedOn)))<> 'KEY GROUP'))
		BEGIN
			SET @ErrDesc = 'Scheme Based On should be (RETAILER OR KEY GROUP) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (71,@TabName,'SchemeBasedOn',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SelnOn)))<> 'UDC') AND (UPPER(LTRIM(RTRIM(@SelnOn)))<> 'PRODUCT'))
		BEGIN
			SET @ErrDesc = 'Selection On should be (UDC OR PRODUCT) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (33,@TabName,'Selction On',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@ClmAble)))<> 'YES') AND (UPPER(LTRIM(RTRIM(@ClmAble)))<> 'NO'))
		BEGIN
			SET @ErrDesc = 'Claimable should be (YES OR NO) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (34,@TabName,'Claimable',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF ((UPPER(LTRIM(RTRIM(@SchStatus)))<> 'ACTIVE') AND (UPPER(LTRIM(RTRIM(@SchStatus)))<> 'INACTIVE'))
		BEGIN
			SET @ErrDesc = 'Scheme Stauts should be (ACTIVE OR INACTIVE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (35,@TabName,'Scheme Stauts',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES')
		BEGIN
			IF LTRIM(RTRIM(@ClmGrpCode))= ''
			BEGIN
				SET @ErrDesc = 'Claim Group Code should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (36,@TabName,'Claim Group Code',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF (UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'PURCHASE RATE' AND UPPER(LTRIM(RTRIM(@ClmAmtOn)))<> 'SELLING RATE')
		BEGIN
			SET @ErrDesc = 'Claimable Amount should be (PURCHASE RATE OR SELLING RATE) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (37,@TabName,'Claimable Amount',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF (UPPER(LTRIM(RTRIM(@SchType)))<>'WINDOW DISPLAY' AND UPPER(LTRIM(RTRIM(@SchType)))<>'AMOUNT'
		   AND UPPER(LTRIM(RTRIM(@SchType)))<>'WEIGHT' AND UPPER(LTRIM(RTRIM(@SchType)))<>'QUANTITY')
		BEGIN
			SET @ErrDesc = 'Scheme Type should be (WINDOW DISPLAY OR AMOUNT OR WEIGHT OR QUANTITY) for Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (38,@TabName,'Scheme Type',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY')
		BEGIN
			IF (UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' AND UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL')
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (39,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (40,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (41,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (42,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (NO) for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (43,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (44,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (NO) for WINDOW DISPLAY SCHEME for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (45,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (NO)for WINDOW DISPLAY SCHEME in Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (46,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF LTRIM(RTRIM(@AdjDisSch))= ''
			BEGIN
				SET @ErrDesc = 'Adjust Window Display Scheme Only Once should not be blank for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (47,@TabName,'Adjust Window Display Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH' AND UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CHEQUE')
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH OR CHEQUE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (48,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE')
			BEGIN
				SET @ErrDesc = 'Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (50,@TabName,'Apply QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		ELSE IF (UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT' AND UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
			AND UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY')
		BEGIN
			IF UPPER(LTRIM(RTRIM(@BatLvl)))<> 'YES' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))<> 'ALL'
			BEGIN
				SET @ErrDesc = 'Batch Level should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (51,@TabName,'Batch Level',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@FlxSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Flexi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxCond)))<> 'UNCONDITIONAL' AND UPPER(LTRIM(RTRIM(@FlxCond)))<> 'CONDITIONAL')
			BEGIN
				SET @ErrDesc = 'Flexi Scheme Type should be (UNCONDITIONAL OR CONDITIONAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (53,@TabName,'Flexi Scheme Type',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL')
				BEGIN
					SET @ErrDesc = 'Flexi Scheme Type should be UNCONDITIONAL When Flexi Scheme is YES for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (54,@TabName,'Flexi Scheme Type',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES' AND UPPER(LTRIM(RTRIM(@CombiSch)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Combi Scheme should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (55,@TabName,'Combi Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Range)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Range should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (56,@TabName,'Range',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'YES' AND UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO'
			   OR UPPER(LTRIM(RTRIM(@ProRata)))<> 'ACTUAL')
			BEGIN
				SET @ErrDesc = 'Pro-Rata should be (YES OR NO OR ACTUAL) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (57,@TabName,'Pro-Rata',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
	
			ELSE IF (UPPER(LTRIM(RTRIM(@CombiSch)))<> 'YES')
			BEGIN
				IF (UPPER(LTRIM(RTRIM(@Range)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then RANGE should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (58,@TabName,'Range',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF (UPPER(LTRIM(RTRIM(@ProRata)))<> 'NO')
				BEGIN
					SET @ErrDesc = 'IF COMBI SCHEME is YES, Then PRO-RATA should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (59,@TabName,'Pro-Rata',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@Qps)))<> 'YES' AND UPPER(LTRIM(RTRIM(@Qps)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (60,@TabName,'QPS Scheme',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@QpsReset)))<> 'YES' AND UPPER(LTRIM(RTRIM(@QpsReset)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'QPS Reset should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (61,@TabName,'QPS Reset',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO, Then QPS Reset should be (NO) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (62,@TabName,'QPS Reset',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE'
				BEGIN
					SET @ErrDesc = 'IF QPS SCHEME is NO,Apply QPS Scheme Should be (DATE) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (63,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'DATE' AND UPPER(LTRIM(RTRIM(@ApyQpsOn)))<> 'QUANTITY'
				BEGIN
					SET @ErrDesc = 'Apply QPS Scheme Should be (DATE OR QUANTITY) for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (64,@TabName,'Apply QPS Scheme',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))<> 'CASH'
			BEGIN
				SET @ErrDesc = 'Settle Window Display Should be (CASH) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (65,@TabName,'SETTLE WINDOW DISPLAY',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE IF (UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'YES' AND UPPER(LTRIM(RTRIM(@AllowUnCheck)))<> 'NO')
			BEGIN
				SET @ErrDesc = 'Allow uncheck claimable should be (YES OR NO) for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (52,@TabName,'Allow Uncheck',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF NOT EXISTS(SELECT CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode)))
			BEGIN
				SET @ErrDesc = 'Company Not Found for Scheme Code:'+@SchCode
				INSERT INTO Errorlog VALUES (66,@TabName,'Company',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
			ELSE
			BEGIN
				SELECT @CmpId=CmpId FROM Company WHERE CmpCode=LTRIM(RTRIM(@CmpCode))
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			SET @GetKey=0
			SET @GetKeyStr=''
			IF NOT EXISTS(SELECT SchId FROM SchemeMaster SM WHERE CMPID=@CmpId AND SM.CmpSchCode=LTRIM(RTRIM(@SchCode)))
			BEGIN
				SELECT @GetKey= dbo.Fn_GetPrimaryKeyInteger('SchemeMaster','SchId',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))
				SELECT @GetKeyStr = dbo.Fn_GetPrimaryKeyString('SchemeMaster','SchCode',CAST(YEAR(GetDate())AS INT),MONTH(GETDATE()))				
				SET @Taction = 2
			END
			ELSE
			BEGIN
				SELECT @GetKey=SchId,@GetKeyStr=SchCode FROM SchemeMaster WHERE CMPID=@CmpId AND CmpSchCode=LTRIM(RTRIM(@SchCode))
				SET @Taction = 1
			END
		END
		IF @GetKey=0	
		BEGIN
			SET @ErrDesc = 'Scheme Id should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Id',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF LEN(LTRIM(RTRIM(@GetKeyStr )))=''
		BEGIN
			SET @ErrDesc = 'Scheme Code should be greater than zero Scheme Code:'+@SchCode
			INSERT INTO Errorlog VALUES (67,@TabName,'Scheme Code',@ErrDesc)
			SET @Taction = 0
			SET @Po_ErrNo =1
		END
		IF @Taction = 2
		BEGIN 
			IF @GetKey<=(SELECT ISNULL(MAX(SchId),0) AS SchId FROM SchemeMaster)
			BEGIN
				SET @ErrDesc = 'Reset the counters/Check the system date'
				INSERT INTO Errorlog VALUES (67,@TabName,'SchId',@ErrDesc)
				SET @Taction = 0
				SET @Po_ErrNo =1
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'RETAILER'
				SET @SchBasedOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchBasedOn)))= 'KEY GROUP'
				SET @SchBasedOnId=2
		END 
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@ClmAble)))='YES'
			BEGIN
				IF NOT EXISTS(SELECT ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode)))
				BEGIN
					SET @ErrDesc = 'Claim Group Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (67,@TabName,'Claim Group',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @ClmGrpId=ClmGrpId FROM ClaimGroupMaster WHERE ClmGrpCode=LTRIM(RTRIM(@ClmGrpCode))
				END
			END
			ELSE
			BEGIN
				SET @ClmGrpId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SelnOn)))='PRODUCT' OR UPPER(LTRIM(RTRIM(@SelnOn)))='SKU' OR UPPER(LTRIM(RTRIM(@SelnOn)))='MATERIAL'
			BEGIN
				IF NOT EXISTS(SELECT CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=UPPER(LTRIM(RTRIM(@SelLvl))) AND LevelName <> 'Level1')
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (68,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=CmpPrdCtgId FROM ProductCategoryLevel WHERE CmpId=@CmpId
					AND CmpPrdCtgName=LTRIM(RTRIM(@SelLvl)) AND LevelName <> 'Level1'
				END
			END
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))='UDC'
			BEGIN
				IF NOT EXISTS(SELECT DISTINCT A.UdcMasterId FROM UdcMaster A
					INNER JOIN UdcHD B ON A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl)))
				BEGIN
					SET @ErrDesc = 'Product Category Level Not Found for Scheme Code:'+@SchCode
					INSERT INTO Errorlog VALUES (69,@TabName,'Product Category',@ErrDesc)
					SET @Taction = 0
					SET @Po_ErrNo =1
				END
				ELSE
				BEGIN
					SELECT @CmpPrdCtgId=A.UdcMasterId FROM UdcMaster A INNER JOIN UdcHD B ON
					A.MasterId=B.MasterId WHERE B.MasterId=1 AND A.COLUMNNAME=LTRIM(RTRIM(@SelLvl))
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'ACTIVE'
				SET @StatusId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchStatus)))= 'INACTIVE'
				SET @StatusId=0
			IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'YES'
				SET @ClmableId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAble)))= 'NO'
				SET @ClmableId=0
			
			IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'PURCHASE RATE'
				SET @ClmAmtOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ClmAmtOn)))= 'SELLING RATE'
				SET @ClmAmtOnId=2
			
			IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'UDC'
				SET @SelMode=1
			ELSE IF UPPER(LTRIM(RTRIM(@SelnOn)))= 'PRODUCT'
				SET @SelMode=0
			
			IF UPPER(LTRIM(RTRIM(@SchType)))='WINDOW DISPLAY'
				SET @SchTypeId=4
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='AMOUNT'
				SET @SchTypeId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='WEIGHT'
				SET @SchTypeId=3
			ELSE IF UPPER(LTRIM(RTRIM(@SchType)))='QUANTITY'
				SET @SchTypeId=1
			
			IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'YES'
				SET @BatId=1
			ELSE IF UPPER(LTRIM(RTRIM(@BatLvl)))= 'NO' OR UPPER(LTRIM(RTRIM(@BatLvl)))= 'ALL'
				SET @BatId=0
			
			
			IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'YES'
				SET @FlexiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@FlxSch)))= 'NO'
				SET @FlexiId=0
			
			IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'UNCONDITIONAL'
				SET @FlexiConId=2
			ELSE IF UPPER(LTRIM(RTRIM(@FlxCond)))= 'CONDITIONAL'
				SET @FlexiConId=1
			ELSE
				SET @FlexiConId=2
			
			IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'YES'				
				SET @CombiId=1
			ELSE IF UPPER(LTRIM(RTRIM(@CombiSch)))= 'NO'
				SET @CombiId=0
			IF UPPER(LTRIM(RTRIM(@CombiType)))= 'FLUCTUATING'
				SET @CombiTypeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NORMAL'
				SET @CombiTypeId=0
			
			IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'MRP'				
				SET @SchApplyOnId=1
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'SELLINGRATE'
				SET @SchApplyOnId=2
			ELSE IF UPPER(LTRIM(RTRIM(@SchApplyOn)))= 'PURCHASERATE'
				SET @SchApplyOnId=3
				
			
			IF UPPER(LTRIM(RTRIM(@Range)))= 'YES'
				SET @RangeId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Range)))= 'NO'
				SET @RangeId=0
			
			IF UPPER(LTRIM(RTRIM(@ProRata)))= 'YES'
				SET @ProRateId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'NO'
				SET @ProRateId=0
			ELSE IF UPPER(LTRIM(RTRIM(@ProRata)))= 'ACTUAL'
				SET @ProRateId=2
			
			IF UPPER(LTRIM(RTRIM(@Qps)))= 'YES'
				SET @QPSId=1
			ELSE IF UPPER(LTRIM(RTRIM(@Qps)))= 'NO'
				SET @QPSId=0
			
			IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'YES'
				SET @ForEveryId=1
			ELSE IF UPPER(LTRIM(RTRIM(@ForEvery)))= 'NO'
				SET @ForEveryId=0
			IF UPPER(LTRIM(RTRIM(@EditSch)))= 'YES'
				SET @EditSchId=0
			ELSE IF UPPER(LTRIM(RTRIM(@EditSch)))= 'NO'
				SET @EditSchId=0
			IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'YES'
				SET @QPSResetId=1
			ELSE IF UPPER(LTRIM(RTRIM(@QpsReset)))= 'NO'
				SET @QPSResetId=0
			IF LTRIM(RTRIM(@SchBudget))= ''
			BEGIN
				SET @SchBudget=0
			END
			IF @SchTypeId=4
			BEGIN
				IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
					SET @ApplySchId=1
				IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CASH'
					SET @SettleSchId=1
				ELSE IF UPPER(LTRIM(RTRIM(@SetDisMode)))= 'CHEQUE'
					SET @SettleSchId=2
				IF LTRIM(RTRIM(@AdjDisSch))= 'NO'
					SET @AdjustSchId=0
				ELSE IF LTRIM(RTRIM(@AdjDisSch))= 'YES'
					SET @AdjustSchId=1
			END
			ELSE
			BEGIN
				IF @QPSId=1
				BEGIN
					IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))= 'DATE'
						SET @ApplySchId=1
					ELSE IF UPPER(LTRIM(RTRIM(@ApyQpsOn)))='QUANTITY'
						SET @ApplySchId=2
					SET @SettleSchId=1
				END
				ELSE
				BEGIN
					SET @SettleSchId=1
					SET @ApplySchId=1
				END
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @FBM='Yes'
			BEGIN
				SET @FBMId=1
				SET @SchBudget=0
			END
			ELSE
			BEGIN
				SET @FBMId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @SettlementType='Value'
			BEGIN
				SET @SettlementTypeId=1				
			END
			ELSE IF @SettlementType='Product'
			BEGIN
				SET @SettlementTypeId=2
			END
			ELSE 
			BEGIN
				SET @SettlementTypeId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF UPPER(LTRIM(RTRIM(@AllowUnCheck)))= 'YES'
			BEGIN
				SET @AllowUnCheckId=1
			END
			ELSE
			BEGIN
				SET @AllowUnCheckId=0
			END
		END
		IF @Po_ErrNo = 0
		BEGIN
			IF @Taction=1
			BEGIN
				EXEC Proc_DependencyCheck 'SchemeMaster',@GetKey
				SELECT @ChkCount=COUNT(*) FROM TempDepCheck
				IF @ChkCount > 0
				BEGIN
					UPDATE SCHEMEMASTER SET SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					--Budget=@SchBudget,SchStatus=@StatusId WHERE SchId=@GetKey
					Budget=@SchBudget/*,SchStatus=@StatusId*/ WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
				END
				ELSE
				BEGIN
					DELETE FROM SchemeProducts WHERE SchId=@GetKey
					DELETE FROM SchemeRetAttr WHERE SchId=@GetKey
					DELETE FROM SchemeSlabCombiPrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabFrePrds WHERE SchId=@GetKey
					DELETE FROM SchemeSlabMultiFrePrds WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRtrLevelValidation WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeRuleSettings WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdDt WHERE SchId=@GetKey
					DELETE FROM dbo.SchemeAnotherPrdHd WHERE SchId=@GetKey
					DELETE FROM SchemeSlabs WHERE SchId=@GetKey
					
					UPDATE SCHEMEMASTER SET SchDsc=LTRIM(RTRIM(@SchDesc)),CmpId=@CmpId,
					Claimable=@ClmableId,ClmAmton=@ClmAmtOnId,ClmRefId=@ClmGrpId,
					SchLevelId=@CmpPrdCtgId,SchType=@SchTypeId,BatchLevel=@BatId,
					FlexiSch=@FlexiId,FlexiSchType=@FlexiConId,CombiSch=@CombiId,
					Range=@RangeId,ProRata=@ProRateId,QPS=@QPSId,QPSReset=@QPSResetId,
					SchValidFrom=LTRIM(RTRIM(@SchStartDate)),SchValidTill=LTRIM(RTRIM(@SchEndDate)),
					Budget=@SchBudget,ApyQPSSch=@ApplySchId,SetWindowDisp=@SettleSchId,
					--SchemeLvlMode=@SelMode,SchStatus=@StatusId WHERE SchId=@GetKey
					SchemeLvlMode=@SelMode/*,SchStatus=@StatusId*/ WHERE SchId=@GetKey --Modified by Muthuvel for DCONSPAR0470
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					and SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
				END
			END
			ELSE IF @Taction=2
			BEGIN
				IF @ConFig=1
				BEGIN
					SELECT @SLevel=MAX(CmpPrdCtgId) FROM ProductCategoryLevel WHERE CmpId=@CmpId
					IF @CmpPrdCtgId<@SLevel
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
	
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT b.PrdCtgValCode FROM ProductCategoryValue B) AND
						A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='NO'
						AND A.SlabId=0 AND A.SlabValue=0
					END
					ELSE
					BEGIN
						SELECT @EtlCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
						SELECT @CmpCnt=ISNULL(COUNT([PrdCode]),0) FROM Etl_Prk_SchemeProducts_Combi A
						WHERE A.[PrdCode] IN (SELECT PrdCCode FROM Product)
						AND  A.[CmpSchCode]=LTRIM(RTRIM(@SchCode)) --AND UPPER(A.[SchLevel])='YES'
						AND A.SlabId=0 AND A.SlabValue=0
					END
						IF @EtlCnt=@CmpCnt
						BEGIN
							SELECT @EtlCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
	
							SELECT @CmpCnt=COUNT([PrdCode]) FROM Etl_Prk_Scheme_Free_Multi_Products A (NOLOCK)
							INNER JOIN Product B ON A.[PrdCode]=b.PrdCCode
							WHERE A.[CmpSchCode]=LTRIM(RTRIM(@SchCode))
							IF @EtlCnt=@CmpCnt
							BEGIN	
								INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
								AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,
								BudgetAllocationNo,AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,SettlementType,ApplyClaim,CombiType)
								VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
								LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,1,1,CONVERT(VARCHAR(10),GETDATE(),121),1,
								CONVERT(VARCHAR(10),GETDATE(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,
								@BudgetAllocationNo,0,0,@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId)
				
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
								UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
								IF @FBMId=1
								BEGIN
									SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
									SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
									EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
								END
							END
							ELSE
							BEGIN
								DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
								
								INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
								CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
								ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
								PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download) VALUES
								(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
								@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
								@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
								@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1)
							END
						END
						ELSE
						BEGIN
							DELETE FROM Etl_Prk_SchemeRuleSettings_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeRtrLevelValidation_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdHd_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM Etl_Prk_SchemeAnotherPrdDt_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeAttribute_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeProduct_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabCombiPrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabMultiFrePrds_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeSlabs_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							DELETE FROM ETL_Prk_SchemeMaster_Temp WHERE CmpSchCode=LTRIM(RTRIM(@SchCode))
							
							INSERT INTO ETL_Prk_SchemeMaster_Temp(SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
							CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
							ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
							PurofEvery,ApyQPSSch,SetWindowDisp,EditScheme,SchemeLvlMode,UpLoadFlag,BudgetAllocationNo,SchBasedOn,Download) VALUES
							(LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
							@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
							@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
							@ApplySchId,@SettleSchId,@EditSchId,@SelMode,'N',@BudgetAllocationNo,@SchBasedOnId,1)
						END							
				END
				ELSE
				BEGIN
					INSERT INTO SchemeMaster(SchId,SchCode,SchDsc,CmpId,Claimable,ClmAmton,ClmRefId,
					CmpSchCode,SchLevelId,SchType,BatchLevel,FlexiSch,FlexiSchType,CombiSch,Range,
					ProRata,QPS,QPSReset,SchValidFrom,SchValidTill,SchStatus,Budget,AdjWinDispOnlyOnce,
					PurofEvery,ApyQPSSch,SetWindowDisp,Availability,LastModBy,LastModDate,AuthId,
					AuthDate,EditScheme,SchemeLvlMode,MasterType,ApplyOnMRPSelRte,ApplyOnTax,BudgetAllocationNo,
					AllowPrdSelc,ExcludeDM,SchBasedOn,Download,FBM,SettlementType,ApplyClaim,CombiType)
					VALUES (@GetKey,LTRIM(RTRIM(@GetKeyStr)),
					LTRIM(RTRIM(@SchDesc)),@CmpId,@ClmableId,@ClmAmtOnId,@ClmGrpId,LTRIM(RTRIM(@SchCode)),@CmpPrdCtgId,
					@SchTypeId,@BatId,@FlexiId,@FlexiConId,@CombiId,@RangeId,@ProRateId,@QPSId,
					@QPSResetId,LTRIM(RTRIM(@SchStartDate)),LTRIM(RTRIM(@SchEndDate)),@StatusId,@SchBudget,@AdjustSchId,@ForEveryId,
					@ApplySchId,@SettleSchId,1,1,convert(varchar(10),getdate(),121),1,
					convert(varchar(10),getdate(),121),@EditSchId,@SelMode,1,@SchApplyOnId,0,@BudgetAllocationNo,0,0,
					@SchBasedOnId,1,@FBMId,@SettlementTypeId,@AllowUnCheckId,@CombiTypeId)
	
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchId'
					UPDATE Counters SET CurrValue = CurrValue+1  WHERE TabName = 'SchemeMaster' AND FldName = 'SchCode'
					INSERT INTO SchemeRuleSettings(SchId,SchConfig,SchRules,NoofBills,FromDate,ToDate,MarketVisit,ApplySchBasedOn,
					EnableRtrLvl,AllowSaving,AllowSelection,Availability,LastModBy,LastModDate,AuthId,AuthDate,CalScheme,NoOfRtr,RtrCount)
					Select SchId,0,-1,-1,NULL,NULL,-1,-1,0,0,0,1,1,LastModDate,1,LastModDate,1,0,0 from schememaster (NOLOCK) where Claimable=1
					AND SchId Not In(Select SchId from SchemeRuleSettings (NOLOCK))
					IF @FBMId=1
					BEGIN
						SET @GetKeyStr=LTRIM(RTRIM(@GetKeyStr))
						SELECT @FBMDate=CONVERT(VARCHAR(10),GETDATE(),121)
						EXEC Proc_FBMTrack 45,@GetKeyStr,@GetKey,@FBMDate,1,0
					END
				END
			END
		END
		FETCH NEXT FROM Cur_SchMaster INTO  @SchCode, @SchDesc, @CmpCode, @ClmAble, @ClmAmtOn, @ClmGrpCode
		, @SelnOn, @SelLvl, @SchType, @BatLvl, @FlxSch, @FlxCond, @CombiSch, @Range, @ProRata, @Qps
		, @QpsReset, @ApyQpsOn, @ForEvery, @SchStartDate, @SchEndDate, @SchBudget, @EditSch, @AdjDisSch,
		@SetDisMode,@SchStatus,@BudgetAllocationNo,@SchBasedOn,@FBM,@SettlementType,@AllowUnCheck,@CombiType,@SchApplyOn
	END
	CLOSE Cur_SchMaster
	DEALLOCATE Cur_SchMaster
END
GO
--ScriptUpdater Till Now
Update A Set Condition = 'http://14.141.40.134/ParleIntegrationNew/POS2Console.asmx' from Configuration A where ModuleId ='DATATRANSFER44'
Update A Set Condition = 'http://14.141.40.134/ParleIntegrationNew/Console2POS.asmx' from Configuration A  Where ModuleId ='DATATRANSFER45'
GO
UPDATE UtilityProcess SET VersionId = '3.1.0.11' WHERE ProcId = 1 AND ProcessName = 'Core Stocky.Exe'
GO
DELETE FROM AppTitle
INSERT INTO AppTitle (TitleName,SynVersion)
SELECT 'Core Stocky 3.1.0.11',434
GO
IF NOT EXISTS (SELECT * FROM Hotfixlog WHERE fixid = 434)
INSERT INTO Hotfixlog(fixid,fixtype,releasedon,fixedon,fixedby,errorsfixed) 
VALUES(434,'D','2018-02-02',GETDATE(),1,'Core Stocky Service Pack 434')
GO